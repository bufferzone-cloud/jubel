<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jubel - Passenger</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-orange: #FF6B35;
            --primary-red: #E74C3C;
            --primary-gradient: linear-gradient(135deg, #FF6B35, #E74C3C);
            --secondary-orange: #E55A28;
            --secondary-red: #C0392B;
            --light-orange: #FFE8E0;
            --light-red: #FADBD8;
            --white: #FFFFFF;
            --light-gray: #F5F5F5;
            --dark-gray: #333333;
            --medium-gray: #777777;
            --success-green: #2ecc71;
            --warning-yellow: #f39c12;
            --info-blue: #3498db;
            --error-red: #e74c3c;
            --border-color: #E8E8E8;
            --shadow-light: 0 2px 12px rgba(255, 107, 53, 0.1);
            --shadow-medium: 0 4px 20px rgba(255, 107, 53, 0.15);
            --shadow-heavy: 0 8px 30px rgba(255, 107, 53, 0.2);
            --app-padding: 12px;
            --element-radius: 8px;
            --transition-speed: 0.3s;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--white);
            color: var(--dark-gray);
            max-width: 100%;
            overflow-x: hidden;
            height: 100vh;
            font-size: 14px;
        }
        
        /* Welcome Screen */
        .welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--white);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            transition: opacity 0.5s ease;
        }
        
        .welcome-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .jubel-logo {
            width: 200px;
            height: 200px;
            background: var(--primary-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
            box-shadow: var(--shadow-heavy);
        }
        
        .jubel-logo-text {
            color: var(--white);
            font-size: 2.5rem;
            font-weight: 800;
            letter-spacing: 1px;
        }
        
        .welcome-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--dark-gray);
            text-align: center;
        }
        
        .welcome-subtitle {
            font-size: 1rem;
            color: var(--medium-gray);
            margin-bottom: 40px;
            text-align: center;
            max-width: 300px;
        }
        
        .auth-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            max-width: 300px;
        }
        
        .auth-btn {
            padding: 15px;
            border: none;
            border-radius: var(--element-radius);
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-login {
            background: var(--primary-gradient);
            color: var(--white);
        }
        
        .btn-signup {
            background: var(--white);
            color: var(--primary-orange);
            border: 2px solid var(--primary-orange);
        }
        
        /* Auth Screens */
        .auth-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--white);
            z-index: 900;
            padding: 20px;
            overflow-y: auto;
            display: none;
        }
        
        .auth-screen.active {
            display: block;
        }
        
        .auth-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .back-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            font-size: 1rem;
            color: var(--dark-gray);
        }
        
        .auth-title {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .form-label {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .form-input {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 1rem;
            transition: all var(--transition-speed) ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary-orange);
        }
        
        .submit-btn {
            padding: 15px;
            border: none;
            border-radius: var(--element-radius);
            background: var(--primary-gradient);
            color: var(--white);
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            margin-top: 10px;
        }
        
        .auth-footer {
            margin-top: 20px;
            text-align: center;
            font-size: 0.9rem;
            color: var(--medium-gray);
        }
        
        .auth-link {
            color: var(--primary-orange);
            font-weight: 600;
            cursor: pointer;
        }
        
        /* Main App */
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        .floating-balance {
            position: fixed;
            top: 15px;
            left: 15px;
            background: var(--white);
            padding: 8px 12px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 700;
            color: var(--dark-gray);
            border: 2px solid var(--primary-orange);
            font-size: 0.8rem;
        }
        
        .balance-amount {
            color: var(--primary-orange);
            font-size: 0.9rem;
        }
        
        .passenger-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
            z-index: 100;
            padding: var(--app-padding);
            transform: translateY(0);
            transition: transform var(--transition-speed) ease;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .passenger-panel.collapsed {
            transform: translateY(calc(100% - 50px));
        }
        
        .panel-collapse-handle {
            width: 40px;
            height: 4px;
            background: var(--border-color);
            border-radius: 2px;
            margin: 0 auto 10px;
            cursor: pointer;
        }
        
        .nav-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            margin-bottom: 12px;
        }
        
        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            padding: 8px 4px;
            border-radius: var(--element-radius);
            background: var(--light-gray);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            border: none;
            font-size: 0.65rem;
            font-weight: 600;
        }
        
        .nav-btn.active {
            background: var(--primary-gradient);
            color: var(--white);
        }
        
        .nav-btn i {
            font-size: 0.9rem;
        }
        
        .ride-request-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .location-input {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--white);
        }
        
        .location-input i {
            color: var(--primary-orange);
        }
        
        .location-input input {
            border: none;
            outline: none;
            width: 100%;
            font-size: 0.9rem;
        }
        
        .vehicle-selection {
            display: flex;
            gap: 8px;
            margin: 10px 0;
        }
        
        .vehicle-option {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            padding: 10px 5px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .vehicle-option.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .vehicle-icon {
            font-size: 1.2rem;
            color: var(--medium-gray);
        }
        
        .vehicle-option.selected .vehicle-icon {
            color: var(--primary-orange);
        }
        
        .vehicle-name {
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .vehicle-price {
            font-size: 0.7rem;
            color: var(--medium-gray);
        }
        
        .request-ride-btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: var(--element-radius);
            background: var(--primary-gradient);
            color: var(--white);
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            margin-top: 10px;
        }
        
        .request-ride-btn:disabled {
            background: var(--medium-gray);
            cursor: not-allowed;
        }
        
        .ride-info-panel {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 12px;
            box-shadow: var(--shadow-medium);
            margin-bottom: 12px;
            border: 1px solid var(--border-color);
        }
        
        .driver-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .driver-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            color: var(--white);
            font-weight: 700;
        }
        
        .driver-details h2 {
            font-size: 0.95rem;
            margin-bottom: 3px;
        }
        
        .driver-details p {
            color: var(--medium-gray);
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.75rem;
        }
        
        .trip-details {
            margin-bottom: 12px;
        }
        
        .location-row {
            display: flex;
            align-items: flex-start;
            gap: 6px;
            margin-bottom: 10px;
        }
        
        .location-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            flex-shrink: 0;
        }
        
        .pickup-icon {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .destination-icon {
            background: var(--primary-red);
            color: var(--white);
        }
        
        .location-text {
            flex: 1;
        }
        
        .location-text h4 {
            font-size: 0.85rem;
            margin-bottom: 3px;
        }
        
        .location-text p {
            color: var(--medium-gray);
            font-size: 0.75rem;
        }
        
        .fare-details {
            background: var(--light-orange);
            padding: 10px;
            border-radius: var(--element-radius);
            margin-bottom: 12px;
        }
        
        .fare-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.75rem;
        }
        
        .fare-row.total {
            font-weight: 700;
            font-size: 0.9rem;
            border-top: 1px solid var(--border-color);
            padding-top: 6px;
            margin-top: 6px;
        }
        
        .ride-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .btn {
            padding: 10px;
            border: none;
            border-radius: var(--element-radius);
            font-size: 0.85rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .btn-cancel {
            background: var(--error-red);
            color: var(--white);
        }
        
        .btn-contact {
            background: var(--info-blue);
            color: var(--white);
        }
        
        .screen-content {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 70px;
            background: var(--white);
            z-index: 90;
            padding: var(--app-padding);
            overflow-y: auto;
            display: none;
        }
        
        .screen-content.active {
            display: block;
        }
        
        .screen-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .back-button {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            font-size: 1rem;
        }
        
        .screen-title {
            font-size: 1.1rem;
            font-weight: 700;
        }
        
        .account-section, .history-section, .payments-section {
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 0.9rem;
            margin-bottom: 10px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .input-group {
            margin-bottom: 10px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 0.8rem;
        }
        
        .input-field {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 0.8rem;
            transition: all var(--transition-speed) ease;
        }
        
        .input-field:focus {
            outline: none;
            border-color: var(--primary-orange);
        }
        
        .wallet-balance {
            background: var(--primary-gradient);
            color: var(--white);
            padding: 12px;
            border-radius: var(--element-radius);
            text-align: center;
            margin-bottom: 12px;
        }
        
        .balance-label {
            font-size: 0.75rem;
            margin-bottom: 3px;
        }
        
        .balance-amount-large {
            font-size: 1.8rem;
            font-weight: 800;
            margin-bottom: 6px;
        }
        
        .wallet-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .btn-wallet {
            background: var(--white);
            color: var(--primary-orange);
            border: 2px solid var(--primary-orange);
            padding: 8px;
            font-size: 0.75rem;
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .btn-wallet:hover {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .payment-methods {
            margin-top: 12px;
        }
        
        .payment-method {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            margin-bottom: 8px;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .payment-method.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .payment-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            color: var(--medium-gray);
        }
        
        .payment-details {
            flex: 1;
        }
        
        .payment-name {
            font-weight: 600;
            font-size: 0.8rem;
        }
        
        .payment-info {
            color: var(--medium-gray);
            font-size: 0.7rem;
        }
        
        .history-item {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            font-size: 0.75rem;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-item:hover {
            background: var(--light-orange);
        }
        
        .history-locations {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }
        
        .history-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: var(--medium-gray);
        }
        
        .status-badge {
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 0.65rem;
            font-weight: 700;
        }
        
        .status-completed {
            background: #e6f7e9;
            color: #2e7d32;
        }
        
        .status-cancelled {
            background: #ffebee;
            color: #c62828;
        }
        
        .status-requested {
            background: #fff3e0;
            color: #ef6c00;
        }
        
        .status-accepted {
            background: #e3f2fd;
            color: #1565c0;
        }
        
        .notification {
            position: fixed;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-gradient);
            color: var(--white);
            padding: 10px 16px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 300;
            display: none;
            font-weight: 600;
            text-align: center;
            font-size: 0.8rem;
            max-width: 80%;
        }
        
        .driver-marker {
            background: var(--primary-gradient);
            color: white;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .driver-marker-label {
            background: white;
            padding: 2px 5px;
            border-radius: 8px;
            margin-top: 4px;
            font-size: 9px;
            font-weight: bold;
            box-shadow: 0 1px 5px rgba(0,0,0,0.2);
        }
        
        .pickup-marker {
            background: var(--primary-orange);
            color: white;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .destination-marker {
            background: var(--primary-red);
            color: white;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .current-location-marker {
            background: var(--info-blue);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .quick-actions {
            position: fixed;
            bottom: 70px;
            right: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 100;
        }
        
        .quick-action-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--white);
            box-shadow: var(--shadow-heavy);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            color: var(--primary-orange);
            transition: all var(--transition-speed) ease;
        }
        
        .quick-action-btn:hover {
            transform: scale(1.1);
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .map-controls {
            position: fixed;
            top: 60px;
            left: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 100;
        }
        
        .map-control-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--white);
            box-shadow: var(--shadow-heavy);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: var(--primary-orange);
            transition: all var(--transition-speed) ease;
        }
        
        .map-control-btn:hover {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .dark-mode-toggle {
            position: fixed;
            bottom: 70px;
            left: 15px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--white);
            box-shadow: var(--shadow-heavy);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            color: var(--primary-orange);
            z-index: 100;
        }
        
        .ride-status {
            position: fixed;
            top: 15px;
            right: 15px;
            background: var(--white);
            padding: 8px 12px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 700;
            color: var(--dark-gray);
            border: 2px solid var(--border-color);
            font-size: 0.8rem;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--medium-gray);
        }
        
        .status-dot.searching {
            background: var(--warning-yellow);
            animation: pulse 2s infinite;
        }
        
        .status-dot.arriving {
            background: var(--info-blue);
            animation: pulse 1.5s infinite;
        }
        
        .status-dot.riding {
            background: var(--success-green);
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .estimated-time {
            position: fixed;
            top: 60px;
            right: 15px;
            background: var(--white);
            padding: 8px 12px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 700;
            color: var(--dark-gray);
            border: 2px solid var(--border-color);
            font-size: 0.8rem;
        }
        
        .promo-section {
            margin-top: 10px;
            padding: 10px;
            border: 1px dashed var(--border-color);
            border-radius: var(--element-radius);
        }
        
        .promo-input {
            display: flex;
            gap: 8px;
        }
        
        .promo-input input {
            flex: 1;
            padding: 8px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 0.8rem;
        }
        
        .btn-promo {
            background: var(--primary-orange);
            color: var(--white);
            border: none;
            border-radius: var(--element-radius);
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .saved-locations {
            display: flex;
            gap: 8px;
            margin: 10px 0;
        }
        
        .saved-location-btn {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
            cursor: pointer;
            font-size: 0.7rem;
            transition: all var(--transition-speed) ease;
        }
        
        .saved-location-btn:hover {
            background: var(--light-orange);
            border-color: var(--primary-orange);
        }
        
        .suggestion-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-medium);
            z-index: 200;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
        
        .suggestion-item {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .suggestion-item:hover {
            background: var(--light-orange);
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
        
        .suggestion-icon {
            font-size: 1rem;
            margin-right: 8px;
        }
        
        .suggestion-details {
            flex: 1;
        }
        
        .suggestion-name {
            font-weight: 600;
            font-size: 0.8rem;
        }
        
        .suggestion-address {
            color: var(--medium-gray);
            font-size: 0.7rem;
        }
        
        .suggestion-distance {
            color: var(--medium-gray);
            font-size: 0.6rem;
            margin-top: 2px;
        }
        
        .loading-text {
            text-align: center;
            padding: 20px;
            color: var(--medium-gray);
        }
        
        .no-places {
            text-align: center;
            padding: 20px;
            color: var(--medium-gray);
        }
        
        .filter-options {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .filter-options select, .filter-options input {
            flex: 1;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .stat-card {
            background: var(--light-gray);
            padding: 12px;
            border-radius: var(--element-radius);
            text-align: center;
        }
        
        .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        .stat-label {
            font-size: 0.7rem;
            color: var(--medium-gray);
        }
        
        .referral-section {
            background: var(--light-orange);
            padding: 15px;
            border-radius: var(--element-radius);
            margin-bottom: 15px;
        }
        
        .referral-code {
            background: var(--white);
            padding: 10px;
            border-radius: var(--element-radius);
            text-align: center;
            margin: 10px 0;
        }
        
        .code {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        .description {
            font-size: 0.7rem;
            color: var(--medium-gray);
            margin-top: 5px;
        }
        
        .contact-section {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .contact-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: var(--element-radius);
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .contact-btn.whatsapp {
            background: #25D366;
            color: white;
        }
        
        .contact-btn.phone {
            background: var(--info-blue);
            color: white;
        }
        
        .rating-stars {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }
        
        .star {
            font-size: 1.5rem;
            color: var(--light-gray);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .star.active {
            color: var(--warning-yellow);
        }
        
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .popup-overlay.hidden {
            display: none;
        }
        
        .popup-form {
            background: var(--white);
            border-radius: var(--element-radius);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-heavy);
        }
        
        .large-popup {
            max-width: 800px;
        }
        
        .popup-header {
            display: flex;
            align-items: center;
            justify-content: between;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .popup-title {
            font-size: 1.2rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .close-popup {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--medium-gray);
        }
        
        .popup-content {
            padding: 15px;
        }
        
        .popup-map-container {
            height: 200px;
            border-radius: var(--element-radius);
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        .popup-details {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .detail-row:last-child {
            border-bottom: none;
        }
        
        .detail-label {
            font-weight: 600;
            font-size: 0.8rem;
        }
        
        .detail-value {
            font-size: 0.8rem;
            color: var(--medium-gray);
        }
        
        .driver-details-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }
        
        .popup-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 15px;
        }
        
        @media (max-width: 480px) {
            .floating-balance, .ride-status {
                padding: 6px 8px;
                font-size: 0.7rem;
            }
            
            .passenger-panel {
                padding: 10px;
            }
            
            .nav-buttons {
                gap: 4px;
            }
            
            .nav-btn {
                padding: 6px 3px;
                font-size: 0.6rem;
            }
            
            .quick-actions {
                bottom: 65px;
                right: 10px;
            }
            
            .quick-action-btn {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }
            
            .dark-mode-toggle {
                bottom: 65px;
                left: 10px;
                width: 40px;
                height: 40px;
            }
        }
    </style>
</head>
<body>
    <!-- Welcome Screen -->
    <div class="welcome-screen" id="welcomeScreen">
        <div class="jubel-logo">
            <div class="jubel-logo-text">J</div>
        </div>
        <h1 class="welcome-title">Welcome to Jubel</h1>
        <p class="welcome-subtitle">Get where you need to go with safe, reliable rides</p>
        <div class="auth-buttons">
            <button class="auth-btn btn-login" id="loginBtn">
                <i class="fas fa-sign-in-alt"></i>
                Log In
            </button>
            <button class="auth-btn btn-signup" id="signupBtn">
                <i class="fas fa-user-plus"></i>
                Sign Up
            </button>
        </div>
    </div>
    
    <!-- Login Screen -->
    <div class="auth-screen" id="loginScreen">
        <div class="auth-header">
            <button class="back-button" id="backFromLogin">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h2 class="auth-title">Log In</h2>
        </div>
        
        <form class="auth-form" id="loginForm">
            <div class="form-group">
                <label for="loginEmail" class="form-label">Email Address</label>
                <input type="email" id="loginEmail" class="form-input" placeholder="your.email@example.com" required>
            </div>
            
            <div class="form-group">
                <label for="loginPassword" class="form-label">Password</label>
                <input type="password" id="loginPassword" class="form-input" placeholder="Enter your password" required>
            </div>
            
            <button type="submit" class="submit-btn">Log In</button>
        </form>
        
        <div class="auth-footer">
            <p>Don't have an account? <span class="auth-link" id="goToSignupFromLogin">Sign Up</span></p>
        </div>
    </div>
    
    <!-- Signup Screen -->
    <div class="auth-screen" id="signupScreen">
        <div class="auth-header">
            <button class="back-button" id="backFromSignup">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h2 class="auth-title">Sign Up</h2>
        </div>
        
        <form class="auth-form" id="signupForm">
            <div class="form-group">
                <label for="signupName" class="form-label">Full Name</label>
                <input type="text" id="signupName" class="form-input" placeholder="Your full name" required>
            </div>
            
            <div class="form-group">
                <label for="signupEmail" class="form-label">Email Address</label>
                <input type="email" id="signupEmail" class="form-input" placeholder="your.email@example.com" required>
            </div>
            
            <div class="form-group">
                <label for="signupPhone" class="form-label">Phone Number</label>
                <input type="tel" id="signupPhone" class="form-input" placeholder="Your phone number" required>
            </div>
            
            <div class="form-group">
                <label for="signupPassword" class="form-label">Password</label>
                <input type="password" id="signupPassword" class="form-input" placeholder="Create a password" required>
            </div>
            
            <div class="form-group">
                <label for="signupConfirmPassword" class="form-label">Confirm Password</label>
                <input type="password" id="signupConfirmPassword" class="form-input" placeholder="Confirm your password" required>
            </div>
            
            <button type="submit" class="submit-btn" id="signupSubmitBtn">Create Account</button>
        </form>
        
        <div class="auth-footer">
            <p>Already have an account? <span class="auth-link" id="goToLoginFromSignup">Log In</span></p>
        </div>
    </div>
    
    <!-- Main App (Hidden until authentication) -->
    <div id="mainApp" style="display: none;">
        <!-- Main Map -->
        <div id="map"></div>
        
        <!-- Floating Balance -->
        <div class="floating-balance">
            <i class="fas fa-wallet"></i>
            <span>Balance: <span class="balance-amount" id="walletBalance">K0.00</span></span>
        </div>
        
        <!-- Ride Status -->
        <div class="ride-status" id="rideStatus" style="display: none;">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Searching for driver</span>
        </div>
        
        <!-- Estimated Time -->
        <div class="estimated-time" id="estimatedTime" style="display: none;">
            <i class="fas fa-clock"></i>
            <span id="timeText">5 min</span>
        </div>
        
        <!-- Map Controls -->
        <div class="map-controls">
            <button class="map-control-btn" id="zoomInBtn" title="Zoom In">
                <i class="fas fa-plus"></i>
            </button>
            <button class="map-control-btn" id="zoomOutBtn" title="Zoom Out">
                <i class="fas fa-minus"></i>
            </button>
            <button class="map-control-btn" id="mapTypeBtn" title="Change Map Type">
                <i class="fas fa-layer-group"></i>
            </button>
        </div>
        
        <!-- Quick Actions -->
        <div class="quick-actions">
            <button class="quick-action-btn" id="centerMapBtn" title="Center Map">
                <i class="fas fa-crosshairs"></i>
            </button>
            <button class="quick-action-btn" id="refreshLocationBtn" title="Refresh Location">
                <i class="fas fa-sync-alt"></i>
            </button>
            <button class="quick-action-btn" id="toggleTrafficBtn" title="Toggle Traffic">
                <i class="fas fa-traffic-light"></i>
            </button>
        </div>
        
        <!-- Dark Mode Toggle -->
        <button class="dark-mode-toggle" id="darkModeToggle" title="Toggle Dark Mode">
            <i class="fas fa-moon"></i>
        </button>
        
        <!-- Passenger Panel -->
        <div class="passenger-panel" id="passengerPanel">
            <div class="panel-collapse-handle" id="panelCollapseHandle"></div>
            
            <div class="nav-buttons">
                <button class="nav-btn active" data-screen="home">
                    <i class="fas fa-home"></i>
                    <span>Home</span>
                </button>
                <button class="nav-btn" data-screen="account">
                    <i class="fas fa-user"></i>
                    <span>Account</span>
                </button>
                <button class="nav-btn" data-screen="history">
                    <i class="fas fa-history"></i>
                    <span>History</span>
                </button>
                <button class="nav-btn" data-screen="payments">
                    <i class="fas fa-credit-card"></i>
                    <span>Payments</span>
                </button>
            </div>
            
            <!-- Home Screen Content -->
            <div id="homeScreenContent">
                <!-- Ride Request Form -->
                <div class="ride-request-form" id="rideRequestForm">
                    <div class="promo-section">
                        <div class="promo-input">
                            <input type="text" id="promoCode" placeholder="Promo code">
                            <button class="btn-promo" id="applyPromoBtn">Apply</button>
                        </div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="pickupLocation" placeholder="Current location" readonly>
                    </div>
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="destinationLocation" placeholder="Where to?">
                        <div class="suggestion-list" id="destinationSuggestions"></div>
                    </div>
                    
                    <div class="saved-locations">
                        <button class="saved-location-btn" data-address="home">
                            <i class="fas fa-home"></i>
                            Home
                        </button>
                        <button class="saved-location-btn" data-address="work">
                            <i class="fas fa-briefcase"></i>
                            Work
                        </button>
                    </div>
                    
                    <div class="vehicle-selection">
                        <div class="vehicle-option selected" data-type="car">
                            <i class="fas fa-car vehicle-icon"></i>
                            <span class="vehicle-name">Car</span>
                            <span class="vehicle-price">K15.00</span>
                        </div>
                        <div class="vehicle-option" data-type="bike">
                            <i class="fas fa-motorcycle vehicle-icon"></i>
                            <span class="vehicle-name">Bike</span>
                            <span class="vehicle-price">K10.00</span>
                        </div>
                        <div class="vehicle-option" data-type="bicycle">
                            <i class="fas fa-bicycle vehicle-icon"></i>
                            <span class="vehicle-name">Bicycle</span>
                            <span class="vehicle-price">K5.00</span>
                        </div>
                    </div>
                    
                    <div class="fare-display">
                        <p>Estimated Fare</p>
                        <div class="fare-amount" id="estimatedFare">K0.00</div>
                        <p class="eta-display" id="etaDisplay">ETA: -- min</p>
                    </div>
                    
                    <button class="request-ride-btn" id="requestRideBtn">Request Ride</button>
                </div>
                
                <!-- Ride Info Panel (Hidden initially) -->
                <div class="ride-info-panel" id="rideInfoPanel" style="display: none;">
                    <div class="driver-info">
                        <div class="driver-avatar" id="driverAvatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="driver-details">
                            <h2 id="driverName">Driver Name</h2>
                            <p><i class="fas fa-phone"></i> <span id="driverPhone">000-000-0000</span></p>
                            <p><i class="fas fa-car"></i> <span id="vehicleDetails">Toyota Corolla - ABC123</span></p>
                            <p><i class="fas fa-star"></i> <span id="driverRating">4.5 â˜…</span></p>
                        </div>
                    </div>
                    
                    <div class="trip-details">
                        <div class="location-row">
                            <div class="location-icon pickup-icon">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="location-text">
                                <h4>Pickup Location</h4>
                                <p id="currentPickupLocation">123 Main Street, City</p>
                            </div>
                        </div>
                        <div class="location-row">
                            <div class="location-icon destination-icon">
                                <i class="fas fa-flag"></i>
                            </div>
                            <div class="location-text">
                                <h4>Destination</h4>
                                <p id="currentDestinationLocation">456 Oak Avenue, City</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="fare-details">
                        <div class="fare-row">
                            <span>Base Fare</span>
                            <span id="baseFare">K15.00</span>
                        </div>
                        <div class="fare-row">
                            <span>Distance</span>
                            <span id="distanceFare">K5.00</span>
                        </div>
                        <div class="fare-row">
                            <span>Discount</span>
                            <span id="discountFare">-K2.00</span>
                        </div>
                        <div class="fare-row total">
                            <span>Total Fare</span>
                            <span id="totalFare">K18.00</span>
                        </div>
                    </div>
                    
                    <div class="ride-actions">
                        <button class="btn btn-cancel" id="cancelRideBtn">
                            <i class="fas fa-times-circle"></i>
                            Cancel Ride
                        </button>
                        <button class="btn btn-contact" id="contactDriverBtn">
                            <i class="fas fa-phone"></i>
                            Contact Driver
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Screen Contents -->
        <div class="screen-content" id="homeScreen">
            <!-- Home screen is the map, so this is empty -->
        </div>
        
        <div class="screen-content" id="accountScreen">
            <div class="screen-header">
                <button class="back-button" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="screen-title">Account</h2>
            </div>
            
            <div class="account-section">
                <div class="account-header">
                    <div class="driver-avatar" id="accountAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="driver-details">
                        <h2 id="accountName">Passenger</h2>
                        <p><i class="fas fa-phone"></i> <span id="accountPhone">Not set</span></p>
                        <p><i class="fas fa-envelope"></i> <span id="accountEmail">Not set</span></p>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="ridesCompleted">0</div>
                        <div class="stat-label">Completed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="ridesCancelled">0</div>
                        <div class="stat-label">Cancelled</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="ridesPending">0</div>
                        <div class="stat-label">Pending</div>
                    </div>
                </div>
                
                <div class="referral-section">
                    <h3 class="section-title">
                        <i class="fas fa-share-alt"></i>
                        Refer & Earn
                    </h3>
                    <p>Share your code and get K50 when friends join</p>
                    <div class="referral-code">
                        <div class="code" id="referralCode">JUBEL-XXXX</div>
                        <div class="description">20% discount for new users</div>
                    </div>
                    <button class="btn btn-primary" id="shareReferralBtn">
                        <i class="fas fa-share"></i>
                        Share Referral Code
                    </button>
                </div>
                
                <div class="wallet-section">
                    <h3 class="section-title">
                        <i class="fas fa-wallet"></i>
                        Jubel Wallet
                    </h3>
                    <div class="wallet-balance">
                        <div class="balance-label">Current Balance</div>
                        <div class="balance-amount-large" id="accountBalance">K0.00</div>
                    </div>
                    <div class="wallet-actions">
                        <button class="btn-wallet" id="depositBtn">
                            <i class="fas fa-plus"></i>
                            Deposit
                        </button>
                        <button class="btn-wallet" id="withdrawBtn">
                            <i class="fas fa-minus"></i>
                            Withdraw
                        </button>
                    </div>
                </div>
                
                <div class="contact-section">
                    <button class="contact-btn whatsapp" id="whatsappBtn">
                        <i class="fab fa-whatsapp"></i>
                        WhatsApp
                    </button>
                    <button class="contact-btn phone" id="callBtn">
                        <i class="fas fa-phone"></i>
                        Call Us
                    </button>
                </div>
            </div>
        </div>
        
        <div class="screen-content" id="historyScreen">
            <div class="screen-header">
                <button class="back-button" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="screen-title">Ride History</h2>
            </div>
            
            <div class="filter-options">
                <select id="historyFilter" class="input-field">
                    <option value="all">All Rides</option>
                    <option value="requested">Awaiting Driver</option>
                    <option value="accepted">In Progress</option>
                    <option value="completed">Completed</option>
                    <option value="cancelled">Cancelled</option>
                </select>
                <input type="date" id="historyDate" class="input-field">
            </div>
            
            <div class="history-section">
                <div id="historyList">
                    <div class="loading-text">
                        <i class="fas fa-spinner fa-spin"></i>
                        Loading ride history...
                    </div>
                </div>
            </div>
        </div>
        
        <div class="screen-content" id="paymentsScreen">
            <div class="screen-header">
                <button class="back-button" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="screen-title">Payment Methods</h2>
            </div>
            
            <div class="payments-section">
                <h3 class="section-title">
                    <i class="fas fa-credit-card"></i>
                    Payment Methods
                </h3>
                
                <div class="payment-methods">
                    <div class="payment-method selected" data-method="airtel">
                        <div class="payment-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Airtel Money</div>
                            <div class="payment-info">Pay with Airtel Money</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-method="mtn">
                        <div class="payment-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">MTN Money</div>
                            <div class="payment-info">Pay with MTN Money</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-method="zamtel">
                        <div class="payment-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Zamtel Money</div>
                            <div class="payment-info">Pay with Zamtel Money</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-method="card">
                        <div class="payment-icon">
                            <i class="fas fa-credit-card"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Credit/Debit Card</div>
                            <div class="payment-info">Visa, Mastercard</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-method="cash">
                        <div class="payment-icon">
                            <i class="fas fa-money-bill"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Cash</div>
                            <div class="payment-info">Pay with cash</div>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-primary" id="addPaymentMethodBtn">
                    <i class="fas fa-plus"></i>
                    Add Payment Method
                </button>
            </div>
        </div>
    </div>
    
    <!-- Ride Details Popup -->
    <div id="rideDetailsPopup" class="popup-overlay hidden">
        <div class="popup-form large-popup">
            <div class="popup-header">
                <h2 class="popup-title">
                    <i class="fas fa-info-circle"></i>
                    Ride Details
                </h2>
                <button class="close-popup" id="closeRidePopupTop">&times;</button>
            </div>
            <div class="popup-content">
                <div class="popup-map-container" id="popupRideMap"></div>
                <div class="popup-details">
                    <div class="detail-row">
                        <span class="detail-label">Pickup:</span>
                        <span class="detail-value" id="popupRidePickup">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Destination:</span>
                        <span class="detail-value" id="popupRideDestination">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Fare:</span>
                        <span class="detail-value" id="popupRideFare">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Distance:</span>
                        <span class="detail-value" id="popupRideDistance">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Ride Type:</span>
                        <span class="detail-value" id="popupRideType">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Status:</span>
                        <span class="detail-value" id="popupRideStatus">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Date & Time:</span>
                        <span class="detail-value" id="popupRideDate">Loading...</span>
                    </div>
                    
                    <!-- Driver Details Section -->
                    <div id="popupDriverDetails" class="driver-details-section hidden">
                        <h3 class="section-title">Driver Information</h3>
                        <div class="detail-row">
                            <span class="detail-label">Driver Name:</span>
                            <span class="detail-value" id="popupDriverName">Loading...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Phone:</span>
                            <span class="detail-value" id="popupDriverPhone">Loading...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Vehicle:</span>
                            <span class="detail-value" id="popupDriverVehicle">Loading...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Rating:</span>
                            <span class="detail-value" id="popupDriverRating">Loading...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Progress:</span>
                            <span class="detail-value" id="popupDriverProgress">Loading...</span>
                        </div>
                    </div>
                    
                    <div class="popup-actions">
                        <button class="btn btn-primary" id="closeRidePopup">
                            <i class="fas fa-times"></i>
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification"></div>
    
    <!-- Firebase and Leaflet JS -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDEACX_P4c5q7djJAcA0I7Lk7leO2TlQ74",
            authDomain: "jubel-13e1a.firebaseapp.com",
            databaseURL: "https://jubel-13e1a-default-rtdb.firebaseio.com",
            projectId: "jubel-13e1a",
            storageBucket: "jubel-13e1a.firebasestorage.app",
            messagingSenderId: "882241095445",
            appId: "1:882241095445:web:ee9ca40fddd008ca910b1c",
            measurementId: "G-J5JPKL6B5F"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        
        // App state
        let currentUser = null;
        let currentRide = null;
        let passengerMap;
        let popupRideMap;
        let locationWatchId = null;
        let currentLocationMarker = null;
        let pickupMarker = null;
        let destinationMarker = null;
        let driverMarker = null;
        let routePolyline = null;
        let selectedVehicleType = 'car';
        let walletBalance = 0;
        let isDarkMode = false;
        let trafficLayer = null;
        let trafficEnabled = false;
        let mapType = 'standard';
        let userFullName = "Passenger";
        let driverAssignmentListener = null;
        let rideHistoryListener = null;
        let activeRideListener = null;
        let appliedPromoCode = null;
        let userStats = {
            completed: 0,
            cancelled: 0,
            pending: 0
        };
        let paymentMethod = 'airtel';
        let userRating = 0;
        let userLocation = null;
        let destinationSearchResults = [];
        let selectedDestination = null;
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            initializeAuth();
            setupAuthEventListeners();
        });
        
        // Authentication functions
        function initializeAuth() {
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    showMainApp();
                    initializeMap();
                    setupEventListeners();
                    loadPassengerData();
                } else {
                    // Show welcome screen
                    document.getElementById('welcomeScreen').classList.remove('hidden');
                }
            });
        }
        
        // Show main app after authentication
        function showMainApp() {
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('active');
            document.getElementById('signupScreen').classList.remove('active');
            document.getElementById('mainApp').style.display = 'block';
        }
        
        // Setup authentication event listeners
        function setupAuthEventListeners() {
            // Welcome screen buttons
            document.getElementById('loginBtn').addEventListener('click', () => {
                document.getElementById('welcomeScreen').classList.add('hidden');
                document.getElementById('loginScreen').classList.add('active');
            });
            
            document.getElementById('signupBtn').addEventListener('click', () => {
                document.getElementById('welcomeScreen').classList.add('hidden');
                document.getElementById('signupScreen').classList.add('active');
            });
            
            // Back buttons
            document.getElementById('backFromLogin').addEventListener('click', () => {
                document.getElementById('loginScreen').classList.remove('active');
                document.getElementById('welcomeScreen').classList.remove('hidden');
            });
            
            document.getElementById('backFromSignup').addEventListener('click', () => {
                document.getElementById('signupScreen').classList.remove('active');
                document.getElementById('welcomeScreen').classList.remove('hidden');
            });
            
            // Navigation between auth screens
            document.getElementById('goToSignupFromLogin').addEventListener('click', () => {
                document.getElementById('loginScreen').classList.remove('active');
                document.getElementById('signupScreen').classList.add('active');
            });
            
            document.getElementById('goToLoginFromSignup').addEventListener('click', () => {
                document.getElementById('signupScreen').classList.remove('active');
                document.getElementById('loginScreen').classList.add('active');
            });
            
            // Login form submission
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                
                auth.signInWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        // Signed in successfully
                        showNotification('Login successful!');
                    })
                    .catch((error) => {
                        console.error('Login error:', error);
                        showNotification('Login failed: ' + error.message);
                    });
            });
            
            // Signup form submission
            document.getElementById('signupForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Validate passwords match
                const password = document.getElementById('signupPassword').value;
                const confirmPassword = document.getElementById('signupConfirmPassword').value;
                
                if (password !== confirmPassword) {
                    showNotification('Passwords do not match');
                    return;
                }
                
                const email = document.getElementById('signupEmail').value;
                const name = document.getElementById('signupName').value;
                const phone = document.getElementById('signupPhone').value;
                
                // Create user with email and password
                auth.createUserWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        const user = userCredential.user;
                        
                        // Generate referral code
                        const referralCode = generateReferralCode(name);
                        
                        // Save user data to Firebase
                        return database.ref('passengers/' + user.uid).set({
                            name: name,
                            email: email,
                            phone: phone,
                            createdAt: firebase.database.ServerValue.TIMESTAMP,
                            walletBalance: 0,
                            referralCode: referralCode
                        });
                    })
                    .then(() => {
                        showNotification('Account created successfully!');
                    })
                    .catch((error) => {
                        console.error('Signup error:', error);
                        showNotification('Signup failed: ' + error.message);
                    });
            });
        }
        
        // Generate referral code
        function generateReferralCode(name) {
            const initials = name.split(' ').map(n => n[0]).join('').toUpperCase();
            const randomNum = Math.floor(1000 + Math.random() * 9000);
            return `JUBEL-${initials}${randomNum}`;
        }
        
        // Map initialization
        function initializeMap() {
            // Main passenger map
            passengerMap = L.map('map').setView([-15.4167, 28.2833], 13); // Default to Lusaka
            
            // Use a clean map style
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(passengerMap);
            
            // Popup ride details map
            popupRideMap = L.map('popupRideMap').setView([-15.4167, 28.2833], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(popupRideMap);
            
            // Get passenger's current location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    userLocation = { lat, lng };
                    
                    // Update map with current location
                    passengerMap.setView([lat, lng], 15);
                    popupRideMap.setView([lat, lng], 15);
                    
                    // Add marker for current location
                    currentLocationMarker = L.marker([lat, lng], {
                        icon: L.divIcon({
                            className: 'current-location-marker',
                            html: '<div class="current-location-marker"><i class="fas fa-user"></i></div>',
                            iconSize: [20, 20]
                        })
                    }).addTo(passengerMap)
                        .bindPopup('Your location')
                        .openPopup();
                        
                    // Set pickup location to current location
                    updatePickupLocation(lat, lng);
                    
                    // Start location tracking
                    startLocationTracking();
                }, error => {
                    console.error('Geolocation error:', error);
                    showNotification('Unable to get your location. Please enable location services.');
                });
            }
        }
        
        // Start continuous location tracking
        function startLocationTracking() {
            if (navigator.geolocation && currentUser) {
                navigator.geolocation.watchPosition(position => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    userLocation = { lat, lng };
                    
                    // Update user location in Firebase
                    database.ref('passengerLocations/' + currentUser.uid).set({
                        latitude: lat,
                        longitude: lng,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    });
                    
                    // Update marker if it exists
                    if (currentLocationMarker) {
                        currentLocationMarker.setLatLng([lat, lng]);
                    }
                    
                    // Update destination marker if it exists and we have a destination
                    if (destinationMarker) {
                        const destination = document.getElementById('destinationLocation').value;
                        if (destination) {
                            updateFareEstimate();
                        }
                    }
                }, error => {
                    console.error('Location tracking error:', error);
                }, {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 30000
                });
            }
        }
        
        // Update pickup location
        function updatePickupLocation(lat, lng) {
            // Update pickup marker
            if (pickupMarker) {
                passengerMap.removeLayer(pickupMarker);
            }
            
            pickupMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'pickup-marker',
                    html: '<div class="pickup-marker"><i class="fas fa-map-marker-alt"></i></div>',
                    iconSize: [25, 25]
                })
            }).addTo(passengerMap)
                .bindPopup('Pickup Location');
                
            // Update pickup location input
            reverseGeocode(lat, lng, 'pickupLocation');
        }
        
        // Reverse geocode coordinates to address
        function reverseGeocode(lat, lng, elementId) {
            // Using OpenStreetMap Nominatim API for reverse geocoding
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
                .then(response => response.json())
                .then(data => {
                    if (data && data.display_name) {
                        document.getElementById(elementId).value = data.display_name;
                    } else {
                        document.getElementById(elementId).value = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                    }
                })
                .catch(error => {
                    console.error('Reverse geocoding error:', error);
                    document.getElementById(elementId).value = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                });
        }
        
        // Event listeners setup
        function setupEventListeners() {
            // Navigation buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const screen = this.getAttribute('data-screen');
                    switchScreen(screen);
                });
            });
            
            // Back buttons
            document.querySelectorAll('.back-button').forEach(btn => {
                btn.addEventListener('click', function() {
                    const screen = this.getAttribute('data-screen');
                    switchScreen(screen);
                });
            });
            
            // Vehicle selection
            document.querySelectorAll('.vehicle-option').forEach(option => {
                option.addEventListener('click', function() {
                    // Remove selected class from all options
                    document.querySelectorAll('.vehicle-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    // Add selected class to clicked option
                    this.classList.add('selected');
                    
                    // Update selected vehicle type
                    selectedVehicleType = this.getAttribute('data-type');
                    updateFareEstimate();
                });
            });
            
            // Payment method selection
            document.querySelectorAll('.payment-method').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.payment-method').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    paymentMethod = this.getAttribute('data-method');
                });
            });
            
            // Request ride button
            document.getElementById('requestRideBtn').addEventListener('click', requestRide);
            
            // Cancel ride button
            document.getElementById('cancelRideBtn').addEventListener('click', cancelRide);
            
            // Contact driver button
            document.getElementById('contactDriverBtn').addEventListener('click', contactDriver);
            
            // Apply promo code
            document.getElementById('applyPromoBtn').addEventListener('click', applyPromoCode);
            
            // Account actions
            document.getElementById('shareReferralBtn').addEventListener('click', shareReferralCode);
            document.getElementById('depositBtn').addEventListener('click', depositToWallet);
            document.getElementById('withdrawBtn').addEventListener('click', withdrawFromWallet);
            document.getElementById('whatsappBtn').addEventListener('click', contactWhatsApp);
            document.getElementById('callBtn').addEventListener('click', contactPhone);
            
            // Add payment method
            document.getElementById('addPaymentMethodBtn').addEventListener('click', addPaymentMethod);
            
            // Quick actions
            document.getElementById('centerMapBtn').addEventListener('click', centerMap);
            document.getElementById('refreshLocationBtn').addEventListener('click', refreshPassengerPosition);
            document.getElementById('toggleTrafficBtn').addEventListener('click', toggleTraffic);
            
            // Map controls
            document.getElementById('zoomInBtn').addEventListener('click', () => passengerMap.zoomIn());
            document.getElementById('zoomOutBtn').addEventListener('click', () => passengerMap.zoomOut());
            document.getElementById('mapTypeBtn').addEventListener('click', toggleMapType);
            
            // Dark mode toggle
            document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);
            
            // Panel collapse
            document.getElementById('panelCollapseHandle').addEventListener('click', togglePanelCollapse);
            
            // Destination input
            document.getElementById('destinationLocation').addEventListener('input', function() {
                const query = this.value;
                updateFareEstimate();
                if (query.length >= 2) {
                    searchPlaces(query);
                } else {
                    hideDestinationSuggestions();
                }
            });
            
            // Focus event for destination input
            document.getElementById('destinationLocation').addEventListener('focus', function() {
                const query = this.value;
                if (query.length >= 2) {
                    searchPlaces(query);
                }
            });
            
            // Click outside to hide suggestions
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.location-input') && !e.target.closest('.suggestion-list')) {
                    hideDestinationSuggestions();
                }
            });
            
            // Saved location buttons
            document.querySelectorAll('.saved-location-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const addressType = this.getAttribute('data-address');
                    useSavedLocation(addressType);
                });
            });
            
            // History filter
            document.getElementById('historyFilter').addEventListener('change', loadRideHistory);
            document.getElementById('historyDate').addEventListener('change', loadRideHistory);
            
            // Ride history item click for popup
            document.addEventListener('click', function(e) {
                if (e.target.closest('.history-item')) {
                    const historyItem = e.target.closest('.history-item');
                    const rideId = historyItem.getAttribute('data-ride-id');
                    if (rideId) {
                        showRideDetailsPopup(rideId);
                    }
                }
            });
            
            // Close popup buttons
            document.getElementById('closeRidePopup').addEventListener('click', closeRideDetailsPopup);
            document.getElementById('closeRidePopupTop').addEventListener('click', closeRideDetailsPopup);
            
            // Star rating
            document.querySelectorAll('.star').forEach(star => {
                star.addEventListener('click', function() {
                    const rating = parseInt(this.getAttribute('data-rating'));
                    setRating(rating);
                });
            });
        }
        
        // Switch between screens
        function switchScreen(screenId) {
            // Hide all screens
            document.querySelectorAll('.screen-content').forEach(screen => {
                screen.classList.remove('active');
            });
            
            // Show selected screen
            document.getElementById(screenId + 'Screen').classList.add('active');
            
            // Update active nav button
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.nav-btn[data-screen="${screenId}"]`).classList.add('active');
            
            // Load data for specific screens
            if (screenId === 'history') {
                loadRideHistory();
            } else if (screenId === 'account') {
                loadAccountData();
            }
        }
        
        // Toggle panel collapse
        function togglePanelCollapse() {
            const panel = document.getElementById('passengerPanel');
            panel.classList.toggle('collapsed');
        }
        
        // Toggle map type
        function toggleMapType() {
            // Remove current tile layer
            passengerMap.eachLayer(layer => {
                if (layer instanceof L.TileLayer) {
                    passengerMap.removeLayer(layer);
                }
            });
            
            // Add new tile layer based on current map type
            if (mapType === 'standard') {
                // Switch to satellite
                L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenTopoMap contributors'
                }).addTo(passengerMap);
                mapType = 'satellite';
                showNotification('Switched to satellite view');
            } else {
                // Switch back to standard
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap contributors'
                }).addTo(passengerMap);
                mapType = 'standard';
                showNotification('Switched to standard view');
            }
        }
        
        // Toggle dark mode
        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            const body = document.body;
            const darkModeToggle = document.getElementById('darkModeToggle');
            
            if (isDarkMode) {
                body.style.backgroundColor = '#1a1a1a';
                body.style.color = '#ffffff';
                darkModeToggle.innerHTML = '<i class="fas fa-sun"></i>';
                darkModeToggle.style.background = '#333';
                darkModeToggle.style.color = '#ffcc00';
                showNotification('Dark mode enabled');
            } else {
                body.style.backgroundColor = '';
                body.style.color = '';
                darkModeToggle.innerHTML = '<i class="fas fa-moon"></i>';
                darkModeToggle.style.background = '';
                darkModeToggle.style.color = '';
                showNotification('Dark mode disabled');
            }
        }
        
        // Use saved location
        function useSavedLocation(addressType) {
            if (currentUser) {
                database.ref('passengers/' + currentUser.uid).once('value')
                    .then(snapshot => {
                        const userData = snapshot.val();
                        const address = userData ? userData[addressType + 'Address'] : null;
                        
                        if (address) {
                            document.getElementById('destinationLocation').value = address;
                            updateFareEstimate();
                            showNotification(`${addressType.charAt(0).toUpperCase() + addressType.slice(1)} address set as destination.`);
                            
                            // Try to geocode the saved address to show on map
                            forwardGeocode(address).then(results => {
                                if (results.length > 0) {
                                    updateDestinationMarker(
                                        parseFloat(results[0].lat),
                                        parseFloat(results[0].lon),
                                        address
                                    );
                                    
                                    // Draw route from user location to destination
                                    drawRoute(userLocation.lat, userLocation.lng, parseFloat(results[0].lat), parseFloat(results[0].lon));
                                    
                                    // Enable request ride button
                                    document.getElementById('requestRideBtn').disabled = false;
                                }
                            });
                        } else {
                            showNotification(`No ${addressType} address saved. Please add it in settings.`);
                        }
                    });
            }
        }
        
        // Search places based on user input
        function searchPlaces(query) {
            if (!userLocation) return;
            
            const suggestionsContainer = document.getElementById('destinationSuggestions');
            suggestionsContainer.innerHTML = '<div class="loading-text">Searching...</div>';
            suggestionsContainer.style.display = 'block';
            
            // Using Overpass API for place search
            const radius = 20000; // 20km in meters
            const overpassQuery = `
                [out:json][timeout:25];
                (
                  node["name"~"${query}",i](around:${radius},${userLocation.lat},${userLocation.lng});
                  way["name"~"${query}",i](around:${radius},${userLocation.lat},${userLocation.lng});
                  relation["name"~"${query}",i](around:${radius},${userLocation.lat},${userLocation.lng});
                );
                out center;
            `;
            
            fetch('https://overpass-api.de/api/interpreter', {
                method: 'POST',
                body: overpassQuery
            })
            .then(response => response.json())
            .then(data => {
                suggestionsContainer.innerHTML = '';
                destinationSearchResults = [];
                
                if (data.elements && data.elements.length > 0) {
                    // Process search results
                    const results = data.elements
                        .filter(element => element.tags && element.tags.name)
                        .map(element => {
                            // Calculate center coordinates for ways and relations
                            let lat, lon;
                            if (element.type === 'node') {
                                lat = element.lat;
                                lon = element.lon;
                            } else {
                                lat = element.center.lat;
                                lon = element.center.lon;
                            }
                            
                            // Calculate distance from user
                            const distance = calculateDistance(
                                userLocation.lat, userLocation.lng,
                                lat, lon
                            );
                            
                            return {
                                ...element,
                                displayLat: lat,
                                displayLon: lon,
                                distance
                            };
                        })
                        .sort((a, b) => a.distance - b.distance)
                        .slice(0, 10);
                    
                    if (results.length === 0) {
                        suggestionsContainer.innerHTML = '<div class="no-places">No places found matching your search</div>';
                        return;
                    }
                    
                    destinationSearchResults = results;
                    
                    results.forEach(result => {
                        const suggestionItem = document.createElement('div');
                        suggestionItem.className = 'suggestion-item';
                        
                        const placeType = result.tags.amenity || result.tags.shop || result.tags.tourism || result.tags.building || 'place';
                        
                        suggestionItem.innerHTML = `
                            <div class="suggestion-icon">${getPlaceIcon(placeType)}</div>
                            <div class="suggestion-details">
                                <div class="suggestion-name">${result.tags.name}</div>
                                <div class="suggestion-type">${formatPlaceType(placeType)}</div>
                                <div class="suggestion-address">${getPlaceAddress(result)}</div>
                                <div class="suggestion-distance">${(result.distance / 1000).toFixed(1)} km away</div>
                            </div>
                        `;
                        
                        suggestionItem.addEventListener('click', function() {
                            document.getElementById('destinationLocation').value = result.tags.name;
                            suggestionsContainer.style.display = 'none';
                            updateFareEstimate();
                            
                            // Update destination marker on map
                            updateDestinationMarker(
                                result.displayLat, 
                                result.displayLon, 
                                result.tags.name
                            );
                            
                            // Draw route from user location to destination
                            drawRoute(userLocation.lat, userLocation.lng, result.displayLat, result.displayLon);
                            
                            selectedDestination = result;
                            
                            // Enable request ride button
                            document.getElementById('requestRideBtn').disabled = false;
                        });
                        
                        suggestionsContainer.appendChild(suggestionItem);
                    });
                } else {
                    suggestionsContainer.innerHTML = '<div class="no-places">No places found matching your search</div>';
                }
            })
            .catch(error => {
                console.error('Error searching places:', error);
                suggestionsContainer.innerHTML = '<div class="no-places">Error searching places. Please try again.</div>';
            });
        }
        
        // Get icon for place type
        function getPlaceIcon(placeType) {
            const icons = {
                'restaurant': 'ðŸ½ï¸',
                'cafe': 'â˜•',
                'bar': 'ðŸº',
                'pub': 'ðŸ»',
                'fast_food': 'ðŸ”',
                'bank': 'ðŸ¦',
                'atm': 'ðŸ’³',
                'hospital': 'ðŸ¥',
                'pharmacy': 'ðŸ’Š',
                'school': 'ðŸ«',
                'university': 'ðŸŽ“',
                'library': 'ðŸ“š',
                'cinema': 'ðŸŽ¬',
                'theatre': 'ðŸŽ­',
                'museum': 'ðŸ›ï¸',
                'hotel': 'ðŸ¨',
                'supermarket': 'ðŸ›’',
                'mall': 'ðŸª',
                'clothes': 'ðŸ‘•',
                'fuel': 'â›½',
                'parking': 'ðŸ…¿ï¸',
                'bus_station': 'ðŸšŒ',
                'taxi': 'ðŸš•',
                'police': 'ðŸ‘®',
                'market': 'ðŸ›ï¸',
                'post_office': 'ðŸ“®',
                'place_of_worship': 'ðŸ›',
                'stadium': 'ðŸŸï¸',
                'park': 'ðŸžï¸',
                'monument': 'ðŸ—½',
                'castle': 'ðŸ°'
            };
            
            return icons[placeType] || 'ðŸ“';
        }
        
        // Format place type for display
        function formatPlaceType(type) {
            return type.split('_').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        }
        
        // Get place address from tags
        function getPlaceAddress(place) {
            if (place.tags['addr:street']) {
                return `${place.tags['addr:street']}${place.tags['addr:housenumber'] ? ' ' + place.tags['addr:housenumber'] : ''}`;
            }
            return 'Address not available';
        }
        
        // Hide destination suggestions
        function hideDestinationSuggestions() {
            const suggestionsContainer = document.getElementById('destinationSuggestions');
            suggestionsContainer.style.display = 'none';
        }
        
        // Forward geocoding function
        function forwardGeocode(query) {
            return new Promise(resolve => {
                if (!userLocation) {
                    resolve([]);
                    return;
                }
                
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=10`)
                    .then(response => response.json())
                    .then(data => {
                        // Filter results within 20km radius
                        const filteredResults = data.filter(result => {
                            const distance = calculateDistance(
                                userLocation.lat, userLocation.lng,
                                parseFloat(result.lat), parseFloat(result.lon)
                            );
                            return distance <= 20000; // 20km in meters
                        });
                        
                        resolve(filteredResults);
                    })
                    .catch(error => {
                        console.error('Forward geocoding error:', error);
                        resolve([]);
                    });
            });
        }
        
        // Calculate distance between two coordinates using Haversine formula
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth's radius in meters
            const Ï†1 = lat1 * Math.PI / 180;
            const Ï†2 = lat2 * Math.PI / 180;
            const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
            const Î”Î» = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                      Math.cos(Ï†1) * Math.cos(Ï†2) *
                      Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c; // Distance in meters
        }
        
        // Fare estimation based on distance (K11 minimum, then K1 per 90 meters)
        function updateFareEstimate() {
            const destination = document.getElementById('destinationLocation').value;
            
            if (destination.length > 3 && userLocation) {
                // Calculate distance using Haversine formula (simplified)
                forwardGeocode(destination).then(results => {
                    if (results.length > 0) {
                        const destLat = parseFloat(results[0].lat);
                        const destLng = parseFloat(results[0].lon);
                        
                        const distance = calculateDistance(
                            userLocation.lat, userLocation.lng,
                            destLat, destLng
                        );
                        
                        // K11 minimum fare for distances below 90 meters, then K1 per 90 meters
                        let baseFare;
                        if (distance < 90) {
                            baseFare = 11;
                        } else {
                            baseFare = Math.max(11, Math.ceil(distance / 90));
                        }
                        
                        // Apply ride type multiplier
                        switch(selectedVehicleType) {
                            case 'car':
                                baseFare = baseFare;
                                break;
                            case 'bike':
                                baseFare = baseFare * 0.7;
                                break;
                            case 'bicycle':
                                baseFare = baseFare * 0.5;
                                break;
                        }
                        
                        // Apply promo code discount if applicable
                        if (appliedPromoCode) {
                            baseFare = baseFare * 0.8; // 20% discount
                        }
                        
                        document.getElementById('estimatedFare').textContent = `K${baseFare.toFixed(2)}`;
                        
                        // Calculate ETA (assuming average speed of 30 km/h)
                        const etaMinutes = Math.ceil((distance / 1000) / 30 * 60);
                        document.getElementById('etaDisplay').textContent = `ETA: ${etaMinutes} min`;
                        
                        // Enable request ride button
                        document.getElementById('requestRideBtn').disabled = false;
                    }
                });
            } else {
                document.getElementById('estimatedFare').textContent = 'K0.00';
                document.getElementById('etaDisplay').textContent = 'ETA: -- min';
                document.getElementById('requestRideBtn').disabled = true;
            }
        }
        
        // Update destination marker on map
        function updateDestinationMarker(lat, lng, name) {
            // Remove existing destination marker
            if (destinationMarker) {
                passengerMap.removeLayer(destinationMarker);
            }
            
            // Add new destination marker
            destinationMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'destination-marker',
                    html: '<div class="destination-marker"><i class="fas fa-flag"></i></div>',
                    iconSize: [25, 25]
                })
            }).addTo(passengerMap)
                .bindPopup(`<strong>${name}</strong><br>Your destination`)
                .openPopup();
            
            // Fit map to show both user location and destination
            const bounds = L.latLngBounds(
                [userLocation.lat, userLocation.lng],
                [lat, lng]
            );
            passengerMap.fitBounds(bounds, { padding: [15, 15] });
        }
        
        // Draw route from user location to destination
        function drawRoute(startLat, startLng, endLat, endLng) {
            // Remove existing route if any
            if (routePolyline) {
                passengerMap.removeLayer(routePolyline);
            }
            
            // Use OSRM API to get route
            fetch(`https://router.project-osrm.org/route/v1/driving/${startLng},${startLat};${endLng},${endLat}?overview=full&geometries=geojson`)
                .then(response => response.json())
                .then(data => {
                    if (data.routes && data.routes.length > 0) {
                        const route = data.routes[0];
                        const routeCoordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                        
                        // Draw the route on the map
                        routePolyline = L.polyline(routeCoordinates, {
                            color: '#FF6B35',
                            weight: 4,
                            opacity: 0.7,
                            dashArray: '8, 8'
                        }).addTo(passengerMap);
                        
                        // Fit map to show the entire route
                        passengerMap.fitBounds(routePolyline.getBounds(), { padding: [15, 15] });
                    }
                })
                .catch(error => {
                    console.error('Error fetching route:', error);
                    // Fallback: draw a straight line
                    routePolyline = L.polyline([
                        [startLat, startLng],
                        [endLat, endLng]
                    ], {
                        color: '#FF6B35',
                        weight: 4,
                        opacity: 0.7,
                        dashArray: '8, 8'
                    }).addTo(passengerMap);
                });
        }
        
        // Request a ride
        function requestRide() {
            const pickupLocation = document.getElementById('pickupLocation').value;
            const destinationLocation = document.getElementById('destinationLocation').value;
            
            if (!destinationLocation) {
                showNotification('Please enter a destination');
                return;
            }
            
            if (!currentLocationMarker) {
                showNotification('Unable to determine your location. Please try again.');
                return;
            }
            
            const pickupLatLng = currentLocationMarker.getLatLng();
            
            // Calculate fare based on distance
            forwardGeocode(destinationLocation).then(results => {
                if (results.length === 0) {
                    showNotification('Invalid destination address. Please select a valid destination.');
                    return;
                }
                
                const destLat = parseFloat(results[0].lat);
                const destLng = parseFloat(results[0].lon);
                
                const distance = calculateDistance(
                    userLocation.lat, userLocation.lng,
                    destLat, destLng
                );
                
                // K11 minimum fare for distances below 90 meters, then K1 per 90 meters
                let fare;
                if (distance < 90) {
                    fare = 11;
                } else {
                    fare = Math.max(11, Math.ceil(distance / 90));
                }
                
                // Apply ride type multiplier
                switch(selectedVehicleType) {
                    case 'car':
                        fare = fare;
                        break;
                    case 'bike':
                        fare = fare * 0.7;
                        break;
                    case 'bicycle':
                        fare = fare * 0.5;
                        break;
                }
                
                // Apply promo code discount if applicable
                if (appliedPromoCode) {
                    fare = fare * 0.8; // 20% discount
                }
                
                // Generate a unique ride ID
                const rideId = database.ref().child('rides').push().key;
                
                // Create ride request
                const rideRequest = {
                    id: rideId,
                    passengerId: currentUser.uid,
                    passengerName: userFullName || 'Passenger',
                    passengerPhone: getUserPhone(),
                    pickupLocation: pickupLocation,
                    destination: destinationLocation,
                    pickupLat: pickupLatLng.lat,
                    pickupLng: pickupLatLng.lng,
                    destLat: destLat,
                    destLng: destLng,
                    rideType: selectedVehicleType,
                    fare: fare,
                    distance: (distance / 1000).toFixed(2) + ' km',
                    status: 'requested',
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    updatedAt: firebase.database.ServerValue.TIMESTAMP,
                    promoCode: appliedPromoCode
                };
                
                // Save ride request to Firebase
                database.ref('rides/' + rideId).set(rideRequest)
                    .then(() => {
                        currentRide = rideRequest;
                        
                        // Update UI for active ride
                        updateUIForActiveRide();
                        
                        // Show ride status
                        document.getElementById('rideStatus').style.display = 'flex';
                        document.getElementById('statusDot').className = 'status-dot searching';
                        document.getElementById('statusText').textContent = 'Searching for driver';
                        
                        showNotification('Ride requested. Searching for a driver...');
                        
                        // Listen for driver assignment
                        listenForDriverAssignment(rideId);
                    })
                    .catch(error => {
                        console.error('Error requesting ride:', error);
                        showNotification('Error requesting ride. Please try again.');
                    });
            }).catch(error => {
                console.error('Error geocoding destination:', error);
                showNotification('Error calculating route. Please try again.');
            });
        }
        
        // Get user phone number
        function getUserPhone() {
            if (currentUser) {
                return document.getElementById('passengerPhoneInput').value || 'Not provided';
            }
            return 'Not provided';
        }
        
        // Update UI for active ride
        function updateUIForActiveRide() {
            // Hide ride request form
            document.getElementById('rideRequestForm').style.display = 'none';
            
            // Show ride info panel
            document.getElementById('rideInfoPanel').style.display = 'block';
            
            // Update ride info
            document.getElementById('currentPickupLocation').textContent = currentRide.pickupLocation;
            document.getElementById('currentDestinationLocation').textContent = currentRide.destination;
            
            // Calculate and display fare
            const baseFare = currentRide.fare;
            const discount = appliedPromoCode ? baseFare * 0.2 : 0;
            const totalFare = baseFare - discount;
            
            document.getElementById('baseFare').textContent = `K${baseFare.toFixed(2)}`;
            document.getElementById('discountFare').textContent = `-K${discount.toFixed(2)}`;
            document.getElementById('totalFare').textContent = `K${totalFare.toFixed(2)}`;
        }
        
        // Listen for driver assignment
        function listenForDriverAssignment(rideId) {
            // Remove any existing listener
            if (driverAssignmentListener) {
                driverAssignmentListener();
            }
            
            // Listen for changes to the ride
            driverAssignmentListener = database.ref('rides/' + rideId).on('value', snapshot => {
                const ride = snapshot.val();
                if (!ride) {
                    showNotification('Ride not found. Please try again.');
                    return;
                }
                
                console.log('Ride status update:', ride.status, ride.driverId);
                
                if (ride.driverId && ride.status === 'accepted') {
                    // Driver assigned and ride accepted
                    handleDriverAssignment(ride);
                } else if (ride.status === 'completed') {
                    // Ride completed
                    showRideCompletion(ride);
                } else if (ride.status === 'cancelled') {
                    // Ride cancelled
                    handleRideCancellation(ride);
                } else if (ride.status === 'arrived') {
                    // Driver arrived
                    showNotification('Your driver has arrived at the pickup location.');
                } else if (ride.status === 'picked_up') {
                    // Passenger picked up
                    showNotification('You have been picked up. Enjoy your ride!');
                } else if (ride.status === 'started') {
                    // Trip started
                    showNotification('Your trip has started.');
                }
            }, error => {
                console.error('Error listening for driver assignment:', error);
                showNotification('Connection error. Please check your internet connection.');
            });
        }
        
        // Handle driver assignment
        function handleDriverAssignment(ride) {
            // Update ride status
            document.getElementById('statusDot').className = 'status-dot arriving';
            document.getElementById('statusText').textContent = 'Driver arriving';
            
            // Show estimated time
            document.getElementById('estimatedTime').style.display = 'flex';
            document.getElementById('timeText').textContent = '5 min';
            
            // Get driver details
            database.ref('users/' + ride.driverId).once('value')
                .then(driverSnapshot => {
                    const driver = driverSnapshot.val();
                    if (driver) {
                        // Update driver info
                        document.getElementById('driverName').textContent = driver.name || 'Driver';
                        document.getElementById('driverPhone').textContent = driver.phone || 'N/A';
                        document.getElementById('driverRating').textContent = driver.rating || '4.5';
                        
                        if (driver.vehicle) {
                            document.getElementById('vehicleDetails').textContent = 
                                `${driver.vehicle.type || 'Vehicle'} - ${driver.vehicle.licensePlate || 'ABC123'}`;
                        }
                        
                        // Update driver avatar
                        const driverAvatar = document.getElementById('driverAvatar');
                        if (driver.name) {
                            driverAvatar.innerHTML = driver.name.charAt(0).toUpperCase();
                        }
                        
                        // Add driver marker to map
                        addDriverMarker(ride.driverLat, ride.driverLng);
                        
                        // Draw route from driver to pickup
                        drawRoute(ride.driverLat, ride.driverLng, ride.pickupLat, ride.pickupLng);
                        
                        showNotification(`Driver ${driver.name} is on the way!`);
                    }
                });
            
            // Listen for ride status updates
            listenForRideStatusUpdates(ride.id);
        }
        
        // Listen for ride status updates
        function listenForRideStatusUpdates(rideId) {
            database.ref('rides/' + rideId).on('value', snapshot => {
                const ride = snapshot.val();
                if (ride) {
                    currentRide = ride;
                    
                    switch(ride.status) {
                        case 'accepted':
                            document.getElementById('statusText').textContent = 'Driver on the way';
                            break;
                        case 'arrived':
                            document.getElementById('statusText').textContent = 'Driver arrived';
                            document.getElementById('statusDot').className = 'status-dot riding';
                            showNotification('Your driver has arrived!');
                            break;
                        case 'started':
                            document.getElementById('statusText').textContent = 'Trip in progress';
                            // Update destination marker
                            addDestinationMarker(ride.destLat, ride.destLng);
                            // Draw route to destination
                            drawRoute(ride.pickupLat, ride.pickupLng, ride.destLat, ride.destLng);
                            break;
                        case 'completed':
                            document.getElementById('statusText').textContent = 'Trip completed';
                            document.getElementById('rideStatus').style.display = 'none';
                            document.getElementById('estimatedTime').style.display = 'none';
                            resetUIAfterRide();
                            showNotification('Trip completed. Thank you for using Jubel!');
                            break;
                        case 'cancelled':
                            document.getElementById('rideStatus').style.display = 'none';
                            document.getElementById('estimatedTime').style.display = 'none';
                            resetUIAfterRide();
                            showNotification('Ride cancelled');
                            break;
                    }
                }
            });
        }
        
        // Add driver marker to map
        function addDriverMarker(lat, lng) {
            if (driverMarker) {
                passengerMap.removeLayer(driverMarker);
            }
            
            driverMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'driver-marker',
                    html: '<div class="driver-marker">ðŸš—</div><div class="driver-marker-label">Driver</div>',
                    iconSize: [35, 50]
                })
            }).addTo(passengerMap)
                .bindPopup('Your driver');
        }
        
        // Add destination marker to map
        function addDestinationMarker(lat, lng) {
            if (destinationMarker) {
                passengerMap.removeLayer(destinationMarker);
            }
            
            destinationMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'destination-marker',
                    html: '<div class="destination-marker"><i class="fas fa-flag"></i></div>',
                    iconSize: [25, 25]
                })
            }).addTo(passengerMap)
                .bindPopup('Destination');
        }
        
        // Handle ride cancellation
        function handleRideCancellation(ride) {
            showNotification('Ride has been cancelled.');
            resetUIAfterRide();
            currentRide = null;
            
            // Clean up
            if (driverMarker) {
                passengerMap.removeLayer(driverMarker);
                driverMarker = null;
            }
            
            // Remove listener
            if (driverAssignmentListener) {
                driverAssignmentListener();
                driverAssignmentListener = null;
            }
        }
        
        // Cancel ride
        function cancelRide() {
            if (currentRide) {
                if (confirm('Are you sure you want to cancel this ride?')) {
                    database.ref('rides/' + currentRide.id).update({
                        status: 'cancelled',
                        cancelledAt: firebase.database.ServerValue.TIMESTAMP,
                        updatedAt: firebase.database.ServerValue.TIMESTAMP
                    })
                    .then(() => {
                        resetUIAfterRide();
                        showNotification('Ride cancelled');
                    })
                    .catch(error => {
                        console.error('Error cancelling ride:', error);
                        showNotification('Error cancelling ride. Please try again.');
                    });
                }
            }
        }
        
        // Contact driver
        function contactDriver() {
            if (currentRide && currentRide.driverId) {
                database.ref('users/' + currentRide.driverId).once('value')
                    .then(snapshot => {
                        const driver = snapshot.val();
                        if (driver && driver.phone) {
                            // In a real app, this would initiate a call
                            showNotification(`Calling driver: ${driver.phone}`);
                            // Simulate calling - in a real app, you would use tel: protocol
                            window.open(`tel:${driver.phone}`, '_self');
                        } else {
                            showNotification('Driver phone number not available.');
                        }
                    });
            }
        }
        
        // Apply promo code
        function applyPromoCode() {
            const promoCode = document.getElementById('promoCode').value.trim();
            
            if (!promoCode) {
                showNotification('Please enter a promo code.');
                return;
            }
            
            // Simulate promo code validation
            // In a real app, this would check against a database of valid promo codes
            if (promoCode.startsWith('JUBEL-')) {
                appliedPromoCode = promoCode;
                showNotification('Promo code applied! 20% discount will be applied to your ride.');
                updateFareEstimate();
                
                // Update UI to show applied promo
                document.getElementById('promoCode').style.borderColor = 'var(--success-green)';
                document.getElementById('applyPromoBtn').innerHTML = '<i class="fas fa-check"></i> Applied';
                document.getElementById('applyPromoBtn').classList.remove('btn-promo');
                document.getElementById('applyPromoBtn').classList.add('btn-success');
            } else {
                showNotification('Invalid promo code. Please check and try again.');
                document.getElementById('promoCode').style.borderColor = 'var(--error-red)';
            }
        }
        
        // Reset UI after ride completion or cancellation
        function resetUIAfterRide() {
            // Show ride request form
            document.getElementById('rideRequestForm').style.display = 'flex';
            
            // Hide ride info panel
            document.getElementById('rideInfoPanel').style.display = 'none';
            
            // Clear destination input
            document.getElementById('destinationLocation').value = '';
            
            // Clear promo code
            document.getElementById('promoCode').value = '';
            appliedPromoCode = null;
            document.getElementById('promoCode').style.borderColor = '';
            document.getElementById('applyPromoBtn').innerHTML = 'Apply';
            document.getElementById('applyPromoBtn').classList.remove('btn-success');
            document.getElementById('applyPromoBtn').classList.add('btn-promo');
            
            // Remove driver marker
            if (driverMarker) {
                passengerMap.removeLayer(driverMarker);
                driverMarker = null;
            }
            
            // Remove destination marker
            if (destinationMarker) {
                passengerMap.removeLayer(destinationMarker);
                destinationMarker = null;
            }
            
            // Remove route
            if (routePolyline) {
                passengerMap.removeLayer(routePolyline);
                routePolyline = null;
            }
            
            currentRide = null;
        }
        
        // Load passenger data
        function loadPassengerData() {
            if (currentUser) {
                database.ref('passengers/' + currentUser.uid).once('value')
                    .then(snapshot => {
                        const passengerData = snapshot.val();
                        if (passengerData) {
                            // Update form fields
                            document.getElementById('passengerNameInput').value = passengerData.name || '';
                            document.getElementById('passengerPhoneInput').value = passengerData.phone || '';
                            document.getElementById('passengerEmailInput').value = passengerData.email || '';
                            userFullName = passengerData.name || "Passenger";
                            
                            // Update wallet balance
                            walletBalance = passengerData.walletBalance || 0;
                            document.getElementById('walletBalance').textContent = `K${walletBalance.toFixed(2)}`;
                            document.getElementById('accountBalance').textContent = `K${walletBalance.toFixed(2)}`;
                            
                            // Update referral code
                            document.getElementById('referralCode').textContent = passengerData.referralCode || 'JUBEL-XXXX';
                        }
                    });
                
                // Load ride history
                loadRideHistory();
                
                // Update user stats
                updateUserStats();
            }
        }
        
        // Load account data
        function loadAccountData() {
            if (currentUser) {
                database.ref('passengers/' + currentUser.uid).once('value')
                    .then(snapshot => {
                        const userData = snapshot.val();
                        if (userData) {
                            // Update account information
                            document.getElementById('accountName').textContent = userData.name || 'Passenger';
                            document.getElementById('accountPhone').textContent = userData.phone || 'Not set';
                            document.getElementById('accountEmail').textContent = userData.email || 'Not set';
                            document.getElementById('referralCode').textContent = userData.referralCode || 'JUBEL-XXXX';
                            
                            // Update wallet balance
                            walletBalance = userData.walletBalance || 0;
                            document.getElementById('accountBalance').textContent = `K${walletBalance.toFixed(2)}`;
                            
                            // Update account avatar
                            const accountAvatar = document.getElementById('accountAvatar');
                            if (userData.name) {
                                accountAvatar.textContent = userData.name.charAt(0).toUpperCase();
                            } else {
                                accountAvatar.innerHTML = '<i class="fas fa-user"></i>';
                            }
                        }
                    });
                
                // Load user stats
                updateUserStats();
            }
        }
        
        // Update user statistics
        function updateUserStats() {
            if (!currentUser) return;
            
            database.ref('rides').orderByChild('passengerId').equalTo(currentUser.uid).once('value')
                .then(snapshot => {
                    const rides = snapshot.val();
                    if (rides) {
                        const ridesArray = Object.values(rides);
                        
                        userStats = {
                            completed: ridesArray.filter(ride => ride.status === 'completed' || ride.status === 'paid').length,
                            cancelled: ridesArray.filter(ride => ride.status === 'cancelled').length,
                            pending: ridesArray.filter(ride => ride.status === 'requested' || ride.status === 'accepted').length
                        };
                        
                        // Update UI
                        document.getElementById('ridesCompleted').textContent = userStats.completed;
                        document.getElementById('ridesCancelled').textContent = userStats.cancelled;
                        document.getElementById('ridesPending').textContent = userStats.pending;
                    }
                });
        }
        
        // Save passenger details
        function savePassengerDetails() {
            const name = document.getElementById('passengerNameInput').value;
            const phone = document.getElementById('passengerPhoneInput').value;
            const email = document.getElementById('passengerEmailInput').value;
            
            if (currentUser) {
                database.ref('passengers/' + currentUser.uid).update({
                    name: name,
                    phone: phone,
                    email: email
                })
                .then(() => {
                    userFullName = name;
                    showNotification('Personal details saved successfully.');
                })
                .catch(error => {
                    console.error('Error saving passenger details:', error);
                    showNotification('Error saving personal details. Please try again.');
                });
            }
        }
        
        // Share referral code
        function shareReferralCode() {
            const referralCode = document.getElementById('referralCode').textContent;
            const shareText = `Join me on Jubel! Use my referral code ${referralCode} for 20% off your first ride. Download the app now!`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Jubel Referral',
                    text: shareText,
                    url: window.location.href
                })
                .then(() => showNotification('Referral code shared successfully!'))
                .catch(error => console.error('Error sharing:', error));
            } else {
                navigator.clipboard.writeText(shareText)
                    .then(() => showNotification('Referral code copied to clipboard!'));
            }
        }
        
        // Deposit to wallet
        function depositToWallet() {
            const amount = prompt('Enter deposit amount (K):');
            if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
                const depositAmount = parseFloat(amount);
                const newBalance = walletBalance + depositAmount;
                
                database.ref('passengers/' + currentUser.uid).update({
                    walletBalance: newBalance
                })
                .then(() => {
                    walletBalance = newBalance;
                    document.getElementById('walletBalance').textContent = `K${walletBalance.toFixed(2)}`;
                    document.getElementById('accountBalance').textContent = `K${walletBalance.toFixed(2)}`;
                    showNotification(`Successfully deposited K${depositAmount.toFixed(2)} to your wallet.`);
                })
                .catch(error => {
                    console.error('Error depositing to wallet:', error);
                    showNotification('Error processing deposit. Please try again.');
                });
            } else if (amount) {
                showNotification('Please enter a valid amount.');
            }
        }
        
        // Withdraw from wallet
        function withdrawFromWallet() {
            if (walletBalance <= 0) {
                showNotification('Your wallet balance is zero.');
                return;
            }
            
            const amount = prompt(`Enter withdrawal amount (K). Available: K${walletBalance.toFixed(2)}:`);
            if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
                const withdrawalAmount = parseFloat(amount);
                
                if (withdrawalAmount > walletBalance) {
                    showNotification('Insufficient balance for this withdrawal.');
                    return;
                }
                
                const newBalance = walletBalance - withdrawalAmount;
                
                database.ref('passengers/' + currentUser.uid).update({
                    walletBalance: newBalance
                })
                .then(() => {
                    walletBalance = newBalance;
                    document.getElementById('walletBalance').textContent = `K${walletBalance.toFixed(2)}`;
                    document.getElementById('accountBalance').textContent = `K${walletBalance.toFixed(2)}`;
                    showNotification(`Successfully withdrew K${withdrawalAmount.toFixed(2)} from your wallet.`);
                })
                .catch(error => {
                    console.error('Error withdrawing from wallet:', error);
                    showNotification('Error processing withdrawal. Please try again.');
                });
            } else if (amount) {
                showNotification('Please enter a valid amount.');
            }
        }
        
        // Contact via WhatsApp
        function contactWhatsApp() {
            const phoneNumber = '0768658484';
            const message = 'Hello, I need assistance with Jubel rides.';
            const url = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
        }
        
        // Contact via phone call
        function contactPhone() {
            const phoneNumber = '0768658484';
            window.open(`tel:${phoneNumber}`, '_self');
        }
        
        // Add payment method
        function addPaymentMethod() {
            showNotification('Payment method feature coming soon!');
        }
        
        // Load ride history with all statuses including pending orders
        function loadRideHistory() {
            if (currentUser) {
                const filter = document.getElementById('historyFilter').value;
                const dateFilter = document.getElementById('historyDate').value;
                
                // Remove existing listener
                if (rideHistoryListener) {
                    rideHistoryListener();
                }
                
                // Set up real-time listener for ride history
                rideHistoryListener = database.ref('rides').orderByChild('passengerId').equalTo(currentUser.uid).on('value', snapshot => {
                    const historyList = document.getElementById('historyList');
                    historyList.innerHTML = '';
                    
                    const rides = snapshot.val();
                    if (rides) {
                        let ridesArray = Object.keys(rides).map(rideId => ({
                            id: rideId,
                            ...rides[rideId]
                        }));
                        
                        // Apply filters
                        if (filter !== 'all') {
                            ridesArray = ridesArray.filter(ride => ride.status === filter);
                        }
                        
                        if (dateFilter) {
                            const filterDate = new Date(dateFilter);
                            ridesArray = ridesArray.filter(ride => {
                                const rideDate = new Date(ride.timestamp);
                                return rideDate.toDateString() === filterDate.toDateString();
                            });
                        }
                        
                        // Sort by timestamp (newest first)
                        ridesArray.sort((a, b) => b.timestamp - a.timestamp);
                        
                        if (ridesArray.length === 0) {
                            historyList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--medium-gray);">No rides found matching your criteria.</p>';
                            return;
                        }
                        
                        ridesArray.forEach(ride => {
                            const historyItem = document.createElement('div');
                            historyItem.className = 'history-item';
                            historyItem.setAttribute('data-ride-id', ride.id);
                            
                            const date = new Date(ride.timestamp);
                            const formattedDate = date.toLocaleDateString();
                            const formattedTime = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                            
                            // Determine status badge class
                            let statusClass = 'status-requested';
                            let statusText = getStatusText(ride.status);
                            
                            if (ride.status === 'accepted') {
                                statusClass = 'status-accepted';
                            } else if (ride.status === 'completed' || ride.status === 'paid') {
                                statusClass = 'status-completed';
                            } else if (ride.status === 'cancelled') {
                                statusClass = 'status-cancelled';
                            } else if (ride.status === 'requested') {
                                statusClass = 'status-pending';
                                statusText = 'Pending';
                            }
                            
                            historyItem.innerHTML = `
                                <div class="history-locations">
                                    <div>
                                        <strong>From:</strong> ${ride.pickupLocation}
                                    </div>
                                    <div>
                                        <strong>To:</strong> ${ride.destination}
                                    </div>
                                </div>
                                <div class="history-info">
                                    <div>K${ride.fare ? ride.fare.toFixed(2) : '0.00'}</div>
                                    <div>${formattedDate} ${formattedTime}</div>
                                    <div class="status-badge ${statusClass}">
                                        ${statusText}
                                    </div>
                                </div>
                            `;
                            
                            historyList.appendChild(historyItem);
                        });
                    } else {
                        historyList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--medium-gray);">No ride history found.</p>';
                    }
                }, error => {
                    console.error('Error loading ride history:', error);
                    historyList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--error-red);">Error loading ride history.</p>';
                });
            }
        }
        
        // Get display text for ride status
        function getStatusText(status) {
            const statusMap = {
                'requested': 'Awaiting Driver',
                'accepted': 'In Progress',
                'completed': 'Completed',
                'paid': 'Completed',
                'cancelled': 'Cancelled',
                'arrived': 'Driver Arrived',
                'picked_up': 'Picked Up',
                'started': 'Trip Started'
            };
            
            return statusMap[status] || status;
        }
        
        // Show ride details popup
        function showRideDetailsPopup(rideId) {
            database.ref('rides/' + rideId).once('value')
                .then(snapshot => {
                    const ride = snapshot.val();
                    if (ride) {
                        // Update popup content
                        document.getElementById('popupRidePickup').textContent = ride.pickupLocation;
                        document.getElementById('popupRideDestination').textContent = ride.destination;
                        document.getElementById('popupRideFare').textContent = `K${ride.fare ? ride.fare.toFixed(2) : '0.00'}`;
                        document.getElementById('popupRideDistance').textContent = ride.distance || 'Calculating...';
                        document.getElementById('popupRideStatus').textContent = getStatusText(ride.status);
                        document.getElementById('popupRideType').textContent = ride.rideType ? ride.rideType.charAt(0).toUpperCase() + ride.rideType.slice(1) : 'Standard';
                        
                        // Format date
                        const date = new Date(ride.timestamp);
                        document.getElementById('popupRideDate').textContent = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        
                        // Update map in popup
                        updatePopupRideMap(ride);
                        
                        // Show driver details if available
                        if (ride.driverId) {
                            database.ref('users/' + ride.driverId).once('value')
                                .then(driverSnapshot => {
                                    const driver = driverSnapshot.val();
                                    if (driver) {
                                        document.getElementById('popupDriverName').textContent = driver.name || 'Driver';
                                        document.getElementById('popupDriverPhone').textContent = driver.phone || 'N/A';
                                        document.getElementById('popupDriverVehicle').textContent = `${driver.vehicleType || 'Car'} (${driver.licensePlate || 'N/A'})`;
                                        document.getElementById('popupDriverRating').textContent = driver.rating || '4.5';
                                        
                                        // Show driver progress based on ride status
                                        updateDriverProgress(ride.status);
                                        
                                        document.getElementById('popupDriverDetails').classList.remove('hidden');
                                    }
                                });
                        } else {
                            document.getElementById('popupDriverDetails').classList.add('hidden');
                        }
                        
                        // Show popup
                        document.getElementById('rideDetailsPopup').classList.remove('hidden');
                    }
                })
                .catch(error => {
                    console.error('Error loading ride details:', error);
                    showNotification('Error loading ride details.');
                });
        }
        
        // Update driver progress in popup
        function updateDriverProgress(status) {
            const progressElement = document.getElementById('popupDriverProgress');
            
            switch(status) {
                case 'requested':
                    progressElement.textContent = 'Waiting for driver to accept';
                    break;
                case 'accepted':
                    progressElement.textContent = 'Driver on the way to pickup';
                    break;
                case 'arrived':
                    progressElement.textContent = 'Driver arrived at pickup location';
                    break;
                case 'picked_up':
                    progressElement.textContent = 'Passenger picked up';
                    break;
                case 'started':
                    progressElement.textContent = 'Trip in progress';
                    break;
                case 'completed':
                    progressElement.textContent = 'Trip completed';
                    break;
                case 'paid':
                    progressElement.textContent = 'Payment completed';
                    break;
                default:
                    progressElement.textContent = 'Status: ' + status;
            }
        }
        
        // Update popup ride map
        function updatePopupRideMap(ride) {
            // Clear existing map
            popupRideMap.eachLayer(layer => {
                if (layer instanceof L.Marker || layer instanceof L.Polyline) {
                    popupRideMap.removeLayer(layer);
                }
            });
            
            // Add pickup marker
            L.marker([ride.pickupLat, ride.pickupLng], {
                icon: L.divIcon({
                    className: 'pickup-marker',
                    html: '<div class="pickup-marker"><i class="fas fa-map-marker-alt"></i></div>',
                    iconSize: [25, 25]
                })
            }).addTo(popupRideMap).bindPopup('Pickup Location');
            
            // Add destination marker
            L.marker([ride.destLat, ride.destLng], {
                icon: L.divIcon({
                    className: 'destination-marker',
                    html: '<div class="destination-marker"><i class="fas fa-flag"></i></div>',
                    iconSize: [25, 25]
                })
            }).addTo(popupRideMap).bindPopup('Destination');
            
            // Draw route
            drawRouteOnPopupMap(ride.pickupLat, ride.pickupLng, ride.destLat, ride.destLng);
            
            // Fit map to show both locations
            const bounds = L.latLngBounds(
                [ride.pickupLat, ride.pickupLng],
                [ride.destLat, ride.destLng]
            );
            popupRideMap.fitBounds(bounds, { padding: [15, 15] });
        }
        
        // Draw route on popup map
        function drawRouteOnPopupMap(startLat, startLng, endLat, endLng) {
            // Use OSRM API to get route
            fetch(`https://router.project-osrm.org/route/v1/driving/${startLng},${startLat};${endLng},${endLat}?overview=full&geometries=geojson`)
                .then(response => response.json())
                .then(data => {
                    if (data.routes && data.routes.length > 0) {
                        const route = data.routes[0];
                        const routeCoordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                        
                        // Draw the route on the map
                        L.polyline(routeCoordinates, {
                            color: '#FF6B35',
                            weight: 4,
                            opacity: 0.7
                        }).addTo(popupRideMap);
                    }
                })
                .catch(error => {
                    console.error('Error fetching route:', error);
                    // Fallback: draw a straight line
                    L.polyline([
                        [startLat, startLng],
                        [endLat, endLng]
                    ], {
                        color: '#FF6B35',
                        weight: 4,
                        opacity: 0.7
                    }).addTo(popupRideMap);
                });
        }
        
        // Close ride details popup
        function closeRideDetailsPopup() {
            document.getElementById('rideDetailsPopup').classList.add('hidden');
        }
        
        // Set rating stars
        function setRating(rating) {
            userRating = rating;
            document.querySelectorAll('.star').forEach(star => {
                const starRating = parseInt(star.getAttribute('data-rating'));
                if (starRating <= rating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }
        
        // Show ride completion
        function showRideCompletion(ride) {
            // Update final fare
            document.getElementById('finalFare').textContent = `K${ride.fare.toFixed(2)}`;
            
            // Switch to completion screen
            switchScreen('rideCompletionScreen');
            showNotification('Ride completed. Please complete payment and rating.');
            
            // Clean up
            if (driverMarker) {
                passengerMap.removeLayer(driverMarker);
                driverMarker = null;
            }
            
            // Remove listener
            if (driverAssignmentListener) {
                driverAssignmentListener();
                driverAssignmentListener = null;
            }
        }
        
        // Quick actions
        
        // Center map on passenger location
        function centerMap() {
            if (currentLocationMarker) {
                const passengerLatLng = currentLocationMarker.getLatLng();
                passengerMap.setView(passengerLatLng, 16);
                showNotification('Map centered on your location');
            }
        }
        
        // Refresh passenger position
        function refreshPassengerPosition() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    userLocation = { lat, lng };
                    
                    // Update map with current location
                    passengerMap.setView([lat, lng], 16);
                    
                    // Update passenger marker position
                    if (currentLocationMarker) {
                        currentLocationMarker.setLatLng([lat, lng]);
                    } else {
                        currentLocationMarker = L.marker([lat, lng], {
                            icon: L.divIcon({
                                className: 'current-location-marker',
                                html: '<div class="current-location-marker"><i class="fas fa-user"></i></div>',
                                iconSize: [20, 20]
                            })
                        }).addTo(passengerMap)
                            .bindPopup('Your location');
                    }
                    
                    // Update pickup location
                    updatePickupLocation(lat, lng);
                    
                    showNotification('Location refreshed');
                }, error => {
                    console.error('Geolocation error:', error);
                    showNotification('Unable to refresh location. Please enable location services.');
                });
            }
        }
        
        // Toggle traffic layer
        function toggleTraffic() {
            if (trafficEnabled) {
                // Remove traffic layer
                if (trafficLayer) {
                    passengerMap.removeLayer(trafficLayer);
                    trafficLayer = null;
                }
                trafficEnabled = false;
                showNotification('Traffic layer disabled');
            } else {
                // Add traffic layer (using OpenStreetMap traffic tiles as an example)
                trafficLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap contributors'
                }).addTo(passengerMap);
                trafficEnabled = true;
                showNotification('Traffic layer enabled');
            }
        }
        
        // Show notification
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 4000);
        }
        
        // Handle offline/online status
        window.addEventListener('online', function() {
            showNotification('Connection restored.');
        });

        window.addEventListener('offline', function() {
            showNotification('You are currently offline. Some features may not work.');
        });
    </script>
</body>
</html>
