<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jubel - Passenger</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
    --primary-orange: #FF6B35;
    --primary-red: #E74C3C;
    --primary-gradient: linear-gradient(135deg, #FF6B35, #E74C3C);
    --secondary-orange: #E55A28;
    --secondary-red: #C0392B;
    --light-orange: #FFF5F0;
    --light-red: #FCE8E6;
    --white: #FFFFFF;
    --off-white: #F9F9F9;
    --light-gray: #F5F5F5;
    --medium-gray: #E0E0E0;
    --dark-gray: #333333;
    --text-gray: #666666;
    --text-light: #888888;
    --success-green: #2ECC71;
    --warning-yellow: #F39C12;
    --info-blue: #3498DB;
    --error-red: #E74C3C;
    --border-color: #EEEEEE;
    --shadow-light: 0 1px 3px rgba(0, 0, 0, 0.08);
    --shadow-medium: 0 2px 8px rgba(0, 0, 0, 0.12);
    --shadow-heavy: 0 3px 10px rgba(0, 0, 0, 0.15);
    --app-padding: 10px;
    --element-radius: 14px;
    --button-radius: 24px;
    --card-radius: 18px;
    --transition-speed: 0.2s;
    --ambulance-blue: #2980B9;
    --fire-truck-red: #C0392B;
    --police-blue: #2C3E50;
    --premium-gold: #FFD700;
    --economy-green: #27AE60;
    --light-truck-brown: #8B4513;
    --delivery-purple: #8E44AD;
    --express-shop-green: #16A085;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
}

body {
    background-color: var(--off-white);
    color: var(--dark-gray);
    max-width: 100%;
    overflow-x: hidden;
    height: 100vh;
    font-size: 12px;
    line-height: 1.3;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

#map {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 50%;
    z-index: 1;
    background: #f8f9fa;
}

.top-bar {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    z-index: 200;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px var(--app-padding);
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border-color);
    height: 52px;
}

.logo-container {
    display: flex;
    align-items: center;
    gap: 8px;
}

.logo-icon {
    width: 28px;
    height: 28px;
    background: var(--primary-gradient);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--white);
    font-weight: 700;
    font-size: 12px;
    overflow: hidden;
}

.logo-icon img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.logo-text {
    font-size: 13px;
    font-weight: 700;
    color: var(--dark-gray);
    line-height: 1.2;
}

.user-actions {
    display: flex;
    align-items: center;
    gap: 8px;
}

.balance-badge {
    background: var(--white);
    padding: 5px 10px;
    border-radius: var(--button-radius);
    box-shadow: var(--shadow-light);
    display: flex;
    align-items: center;
    gap: 4px;
    font-weight: 600;
    color: var(--dark-gray);
    border: 1px solid var(--border-color);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    font-size: 11px;
}

.balance-badge:hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow-medium);
}

.balance-amount {
    color: var(--primary-orange);
    font-weight: 700;
    font-size: 11px;
}

.notification-bell {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--white);
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: var(--shadow-light);
    border: 1px solid var(--border-color);
    cursor: pointer;
    position: relative;
    transition: all var(--transition-speed) ease;
}

.notification-bell:hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow-medium);
}

.notification-badge {
    position: absolute;
    top: -2px;
    right: -2px;
    width: 14px;
    height: 14px;
    background: var(--error-red);
    color: var(--white);
    border-radius: 50%;
    font-size: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    border: 2px solid var(--white);
}

.ride-status-bar {
    position: absolute;
    top: 56px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 150;
    display: none;
    background: var(--white);
    padding: 6px 14px;
    border-radius: var(--button-radius);
    box-shadow: var(--shadow-heavy);
    border: 1px solid var(--border-color);
    align-items: center;
    gap: 8px;
    min-width: 250px;
    max-width: 85%;
    font-size: 11px;
}

.ride-status-bar.active {
    display: flex;
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from {
        transform: translateX(-50%) translateY(-20px);
        opacity: 0;
    }
    to {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
    }
}

.status-indicator {
    display: flex;
    align-items: center;
    gap: 5px;
}

.status-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--warning-yellow);
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(1.1); }
    100% { opacity: 1; transform: scale(1); }
}

.status-dot.searching { background: var(--warning-yellow); }
.status-dot.arriving { background: var(--info-blue); }
.status-dot.riding { background: var(--success-green); animation: none; }

.status-text {
    font-weight: 600;
    font-size: 11px;
    color: var(--dark-gray);
}

.status-eta {
    margin-left: auto;
    display: flex;
    align-items: center;
    gap: 3px;
    color: var(--text-gray);
    font-size: 10px;
    font-weight: 500;
}

.emergency-status {
    position: absolute;
    top: 56px;
    right: var(--app-padding);
    z-index: 150;
    background: linear-gradient(135deg, var(--error-red), #C0392B);
    color: var(--white);
    padding: 6px 12px;
    border-radius: var(--button-radius);
    box-shadow: var(--shadow-heavy);
    display: none;
    align-items: center;
    gap: 5px;
    font-weight: 700;
    font-size: 11px;
    animation: emergencyPulse 1s infinite;
}

@keyframes emergencyPulse {
    0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
    70% { transform: scale(1.02); box-shadow: 0 0 0 8px rgba(231, 76, 60, 0); }
    100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
}

.sos-button {
    position: absolute;
    bottom: 150px;
    right: var(--app-padding);
    z-index: 150;
    width: 52px;
    height: 52px;
    background: linear-gradient(135deg, var(--error-red), #C0392B);
    border-radius: 50%;
    display: none;
    align-items: center;
    justify-content: center;
    color: var(--white);
    font-size: 13px;
    font-weight: 700;
    box-shadow: var(--shadow-heavy);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    animation: sosPulse 2s infinite;
}

.sos-button:hover {
    transform: scale(1.1);
    box-shadow: 0 0 20px rgba(231, 76, 60, 0.4);
}

@keyframes sosPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.main-panel {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--white);
    border-radius: var(--card-radius) var(--card-radius) 0 0;
    box-shadow: 0 -3px 20px rgba(0, 0, 0, 0.1);
    z-index: 100;
    padding: var(--app-padding);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    max-height: 50vh;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: var(--primary-orange) var(--light-gray);
}

.main-panel::-webkit-scrollbar {
    width: 3px;
}

.main-panel::-webkit-scrollbar-track {
    background: var(--light-gray);
    border-radius: 2px;
}

.main-panel::-webkit-scrollbar-thumb {
    background: var(--primary-orange);
    border-radius: 2px;
}

.main-panel.collapsed {
    transform: translateY(calc(100% - 44px));
}

.panel-handle {
    width: 32px;
    height: 3px;
    background: var(--medium-gray);
    border-radius: 2px;
    margin: 0 auto 10px;
    cursor: pointer;
    transition: all var(--transition-speed) ease;
}

.panel-handle:hover {
    background: var(--primary-orange);
    width: 40px;
}

.nav-tabs {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 6px;
    margin-bottom: 12px;
    padding: 3px;
    background: var(--light-gray);
    border-radius: var(--button-radius);
}

.nav-tab {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 3px;
    padding: 8px 5px;
    border-radius: calc(var(--button-radius) - 4px);
    background: transparent;
    border: none;
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    color: var(--text-gray);
    font-size: 10px;
    font-weight: 600;
}

.nav-tab i {
    font-size: 14px;
    transition: all var(--transition-speed) ease;
}

.nav-tab.active {
    background: var(--white);
    color: var(--primary-orange);
    box-shadow: var(--shadow-light);
}

.nav-tab.active i {
    color: var(--primary-orange);
    transform: translateY(-1px);
}

.nav-tab:hover:not(.active) {
    background: rgba(255, 107, 53, 0.1);
    color: var(--primary-orange);
}

.quick-actions {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
    margin-bottom: 14px;
}

.quick-action-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px;
    background: var(--white);
    border: 1px solid var(--border-color);
    border-radius: var(--element-radius);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    text-align: left;
}

.quick-action-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
    border-color: var(--primary-orange);
}

.quick-action-icon {
    width: 32px;
    height: 32px;
    border-radius: 10px;
    background: var(--light-orange);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary-orange);
    font-size: 14px;
}

.quick-action-text {
    flex: 1;
}

.quick-action-title {
    font-weight: 600;
    font-size: 12px;
    color: var(--dark-gray);
    margin-bottom: 2px;
}

.quick-action-desc {
    font-size: 10px;
    color: var(--text-light);
}

.service-tabs {
    display: flex;
    gap: 6px;
    margin-bottom: 14px;
    overflow-x: auto;
    padding-bottom: 3px;
}

.service-tabs::-webkit-scrollbar {
    display: none;
}

.service-tab {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 3px;
    padding: 10px 12px;
    background: var(--white);
    border: 2px solid var(--border-color);
    border-radius: var(--element-radius);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    min-width: 90px;
    text-align: center;
    flex-shrink: 0;
}

.service-tab:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
}

.service-tab.active {
    border-color: var(--primary-orange);
    background: var(--light-orange);
    box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
}

.service-tab.car.active { border-color: var(--primary-orange); }
.service-tab.delivery.active { border-color: var(--delivery-purple); background: #F4E6FA; }
.service-tab.short-delivery.active { border-color: var(--express-shop-green); background: #E1F5FE; }

.service-icon {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: var(--light-gray);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    color: var(--text-gray);
    transition: all var(--transition-speed) ease;
}

.service-tab.active .service-icon {
    background: var(--primary-orange);
    color: var(--white);
}

.service-tab.delivery.active .service-icon {
    background: var(--delivery-purple);
}

.service-tab.short-delivery.active .service-icon {
    background: var(--express-shop-green);
}

.service-name {
    font-weight: 600;
    font-size: 11px;
    color: var(--dark-gray);
}

.service-desc {
    font-size: 9px;
    color: var(--text-light);
    margin-top: 1px;
}

.ride-request-form {
    background: var(--white);
    border-radius: var(--element-radius);
    padding: 14px;
    margin-bottom: 10px;
    box-shadow: var(--shadow-light);
    border: 1px solid var(--border-color);
}

.form-title {
    font-size: 13px;
    font-weight: 700;
    margin-bottom: 12px;
    color: var(--dark-gray);
    display: flex;
    align-items: center;
    gap: 6px;
}

.location-inputs {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 12px;
}

.location-input {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px;
    background: var(--off-white);
    border: 2px solid transparent;
    border-radius: var(--element-radius);
    transition: all var(--transition-speed) ease;
    position: relative;
}

.location-input.active {
    border-color: var(--primary-orange);
    background: var(--white);
    box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
}

.location-input i {
    color: var(--primary-orange);
    font-size: 13px;
    width: 16px;
    text-align: center;
}

.location-input input {
    flex: 1;
    border: none;
    background: transparent;
    outline: none;
    font-size: 12px;
    color: var(--dark-gray);
    font-weight: 500;
}

.location-input input::placeholder {
    color: var(--text-light);
}

.suggestion-list {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--white);
    border: 1px solid var(--border-color);
    border-radius: var(--element-radius);
    box-shadow: var(--shadow-heavy);
    z-index: 1000;
    max-height: 200px;
    overflow-y: auto;
    display: none;
    margin-top: 3px;
}

.suggestion-list.active {
    display: block;
    animation: fadeIn 0.2s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-8px); }
    to { opacity: 1; transform: translateY(0); }
}

.suggestion-item {
    padding: 10px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    display: flex;
    align-items: flex-start;
    gap: 8px;
}

.suggestion-item:hover {
    background: var(--light-orange);
}

.suggestion-item:last-child {
    border-bottom: none;
}

.suggestion-icon {
    color: var(--primary-orange);
    font-size: 11px;
    margin-top: 2px;
}

.suggestion-details {
    flex: 1;
}

.suggestion-name {
    font-weight: 600;
    font-size: 12px;
    color: var(--dark-gray);
    margin-bottom: 2px;
}

.suggestion-address {
    font-size: 10px;
    color: var(--text-gray);
    line-height: 1.2;
}

.suggestion-distance {
    font-size: 9px;
    color: var(--text-light);
    margin-top: 1px;
}

.ride-type-selection {
    margin: 14px 0;
    display: none;
}

.ride-type-selection.active {
    display: block;
    animation: fadeInUp 0.3s ease;
}

@keyframes fadeInUp {
    from { opacity: 0; transform: translateY(15px); }
    to { opacity: 1; transform: translateY(0); }
}

.ride-type-title {
    font-size: 12px;
    font-weight: 600;
    color: var(--dark-gray);
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.ride-type-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 6px;
}

.ride-type-card {
    background: var(--white);
    border: 2px solid var(--border-color);
    border-radius: var(--element-radius);
    padding: 12px 8px;
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    text-align: center;
    position: relative;
    overflow: hidden;
}

.ride-type-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
}

.ride-type-card.selected {
    border-color: var(--primary-orange);
    background: var(--light-orange);
    box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
}

.ride-type-card.economy.selected {
    border-color: var(--economy-green);
    background: #E8F6EF;
}

.ride-type-card.premium.selected {
    border-color: var(--premium-gold);
    background: #FFF9E6;
}

.ride-type-icon {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    background: var(--light-gray);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 6px;
    font-size: 16px;
    color: var(--text-gray);
    transition: all var(--transition-speed) ease;
}

.ride-type-card.selected .ride-type-icon {
    background: var(--primary-orange);
    color: var(--white);
}

.ride-type-card.economy.selected .ride-type-icon {
    background: var(--economy-green);
}

.ride-type-card.premium.selected .ride-type-icon {
    background: var(--premium-gold);
    color: var(--dark-gray);
}

.ride-type-name {
    font-weight: 600;
    font-size: 11px;
    color: var(--dark-gray);
    margin-bottom: 1px;
}

.ride-type-price {
    font-size: 12px;
    font-weight: 700;
    color: var(--primary-orange);
    margin-bottom: 1px;
}

.ride-type-card.economy .ride-type-price {
    color: var(--economy-green);
}

.ride-type-card.premium .ride-type-price {
    color: #B8860B;
}

.ride-type-eta {
    font-size: 9px;
    color: var(--text-light);
}

.fare-display {
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
    color: var(--white);
    padding: 14px;
    border-radius: var(--element-radius);
    margin: 14px 0;
    text-align: center;
    box-shadow: var(--shadow-medium);
    display: none;
}

.fare-display.active {
    display: block;
    animation: slideUp 0.3s ease;
}

@keyframes slideUp {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
}

.fare-label {
    font-size: 11px;
    opacity: 0.9;
    margin-bottom: 1px;
}

.fare-amount {
    font-size: 22px;
    font-weight: 800;
    margin: 4px 0;
}

.fare-details {
    display: flex;
    justify-content: space-between;
    margin-top: 8px;
    font-size: 10px;
    opacity: 0.9;
}

.action-buttons {
    display: grid;
    grid-template-columns: 1fr;
    gap: 8px;
    margin-top: 14px;
}

.btn {
    padding: 12px;
    border: none;
    border-radius: var(--button-radius);
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.btn-primary {
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
    color: var(--white);
    box-shadow: 0 2px 8px rgba(255, 107, 53, 0.3);
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 3px 12px rgba(255, 107, 53, 0.4);
}

.btn-secondary {
    background: var(--white);
    color: var(--primary-orange);
    border: 2px solid var(--primary-orange);
}

.btn-secondary:hover {
    background: var(--light-orange);
    transform: translateY(-2px);
}

.btn-danger {
    background: linear-gradient(135deg, var(--error-red), #C0392B);
    color: var(--white);
    box-shadow: 0 2px 8px rgba(231, 76, 60, 0.3);
}

.btn-danger:hover {
    transform: translateY(-2px);
    box-shadow: 0 3px 12px rgba(231, 76, 60, 0.4);
}

.ride-info-panel {
    background: var(--white);
    border-radius: var(--element-radius);
    padding: 14px;
    margin-bottom: 10px;
    box-shadow: var(--shadow-medium);
    border: 1px solid var(--border-color);
    display: none;
}

.ride-info-panel.active {
    display: block;
    animation: fadeInUp 0.3s ease;
}

.driver-info {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 14px;
    padding-bottom: 14px;
    border-bottom: 1px solid var(--border-color);
}

.driver-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    color: var(--white);
    font-weight: 700;
    overflow: hidden;
}

.driver-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.driver-details {
    flex: 1;
}

.driver-name {
    font-size: 13px;
    font-weight: 700;
    color: var(--dark-gray);
    margin-bottom: 2px;
}

.driver-rating {
    display: flex;
    align-items: center;
    gap: 3px;
    color: var(--warning-yellow);
    font-weight: 600;
    margin-bottom: 3px;
    font-size: 11px;
}

.driver-vehicle {
    font-size: 11px;
    color: var(--text-gray);
    display: flex;
    align-items: center;
    gap: 3px;
}

.vehicle-image {
    width: 56px;
    height: 56px;
    border-radius: 8px;
    overflow: hidden;
    background: var(--light-gray);
    display: flex;
    align-items: center;
    justify-content: center;
}

.vehicle-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.trip-details {
    margin-bottom: 14px;
}

.trip-locations {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.location-point {
    display: flex;
    align-items: flex-start;
    gap: 8px;
}

.location-marker {
    width: 26px;
    height: 26px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    color: var(--white);
    font-size: 10px;
}

.location-marker.pickup {
    background: var(--primary-orange);
}

.location-marker.destination {
    background: var(--primary-red);
}

.location-text {
    flex: 1;
}

.location-label {
    font-size: 10px;
    color: var(--text-light);
    margin-bottom: 1px;
    font-weight: 600;
}

.location-address {
    font-size: 12px;
    color: var(--dark-gray);
    font-weight: 500;
    line-height: 1.2;
}

.fare-breakdown {
    background: var(--off-white);
    border-radius: var(--element-radius);
    padding: 12px;
    margin-bottom: 14px;
}

.fare-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 5px 0;
    border-bottom: 1px solid var(--border-color);
}

.fare-row:last-child {
    border-bottom: none;
}

.fare-label {
    font-size: 12px;
    color: var(--text-gray);
}

.fare-value {
    font-size: 12px;
    font-weight: 600;
    color: var(--dark-gray);
}

.fare-row.total {
    margin-top: 5px;
    padding-top: 8px;
    border-top: 2px solid var(--border-color);
}

.fare-row.total .fare-label {
    font-size: 13px;
    font-weight: 700;
    color: var(--dark-gray);
}

.fare-row.total .fare-value {
    font-size: 16px;
    font-weight: 800;
    color: var(--primary-orange);
}

.chat-container {
    position: absolute;
    bottom: 180px;
    right: var(--app-padding);
    z-index: 300;
    width: 280px;
    max-width: calc(100vw - 40px);
    background: var(--white);
    border-radius: var(--card-radius);
    box-shadow: var(--shadow-heavy);
    display: none;
    flex-direction: column;
    overflow: hidden;
    border: 1px solid var(--border-color);
}

.chat-container.active {
    display: flex;
    animation: chatSlideUp 0.3s ease;
}

@keyframes chatSlideUp {
    from { transform: translateY(15px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.chat-header {
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
    color: var(--white);
    padding: 12px;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.chat-title {
    font-weight: 600;
    font-size: 12px;
}

.chat-close {
    background: none;
    border: none;
    color: var(--white);
    font-size: 14px;
    cursor: pointer;
    padding: 3px;
    border-radius: 4px;
    transition: all var(--transition-speed) ease;
}

.chat-close:hover {
    background: rgba(255, 255, 255, 0.2);
}

.chat-messages {
    flex: 1;
    padding: 12px;
    max-height: 200px;
    overflow-y: auto;
    background: var(--off-white);
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.message {
    max-width: 75%;
    padding: 6px 10px;
    border-radius: 14px;
    font-size: 12px;
    line-height: 1.2;
}

.message.sent {
    align-self: flex-end;
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
    color: var(--white);
    border-bottom-right-radius: 3px;
}

.message.received {
    align-self: flex-start;
    background: var(--white);
    color: var(--dark-gray);
    border: 1px solid var(--border-color);
    border-bottom-left-radius: 3px;
}

.message-time {
    font-size: 9px;
    color: var(--text-light);
    margin-top: 1px;
    text-align: right;
}

.message.received .message-time {
    color: var(--text-gray);
}

.chat-input-container {
    padding: 12px;
    background: var(--white);
    border-top: 1px solid var(--border-color);
    display: flex;
    gap: 6px;
}

.chat-input {
    flex: 1;
    padding: 8px 12px;
    border: 1px solid var(--border-color);
    border-radius: var(--button-radius);
    font-size: 12px;
    outline: none;
    transition: all var(--transition-speed) ease;
}

.chat-input:focus {
    border-color: var(--primary-orange);
    box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
}

.chat-send-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
    color: var(--white);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-speed) ease;
}

.chat-send-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 2px 8px rgba(255, 107, 53, 0.3);
}

.chat-notification {
    position: absolute;
    top: -5px;
    right: -5px;
    width: 16px;
    height: 16px;
    background: var(--error-red);
    color: var(--white);
    border-radius: 50%;
    font-size: 9px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    animation: bounce 1s infinite;
}

@keyframes bounce {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.2); }
}

.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 14px;
    backdrop-filter: blur(4px);
}

.modal-overlay.active {
    display: flex;
    animation: fadeIn 0.3s ease;
}

.modal {
    background: var(--white);
    border-radius: var(--card-radius);
    box-shadow: var(--shadow-heavy);
    max-width: 400px;
    width: 100%;
    max-height: 80vh;
    overflow-y: auto;
    animation: modalSlideUp 0.3s ease;
}

@keyframes modalSlideUp {
    from { transform: translateY(25px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.modal-header {
    padding: 16px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.modal-title {
    font-size: 14px;
    font-weight: 700;
    color: var(--dark-gray);
    display: flex;
    align-items: center;
    gap: 6px;
}

.modal-close {
    background: none;
    border: none;
    font-size: 18px;
    color: var(--text-light);
    cursor: pointer;
    padding: 3px;
    border-radius: 4px;
    transition: all var(--transition-speed) ease;
}

.modal-close:hover {
    color: var(--error-red);
    background: var(--light-red);
}

.modal-content {
    padding: 16px;
}

.history-screen {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--white);
    z-index: 200;
    display: none;
    flex-direction: column;
    padding-top: 52px;
}

.history-screen.active {
    display: flex;
    animation: slideInRight 0.3s ease;
}

@keyframes slideInRight {
    from { transform: translateX(100%); }
    to { transform: translateX(0); }
}

.screen-header {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    background: var(--white);
    padding: 12px var(--app-padding);
    border-bottom: 1px solid var(--border-color);
    z-index: 10;
    display: flex;
    align-items: center;
    gap: 12px;
}

.back-btn {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--light-gray);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--dark-gray);
    border: none;
    cursor: pointer;
    transition: all var(--transition-speed) ease;
}

.back-btn:hover {
    background: var(--medium-gray);
    transform: translateX(-2px);
}

.screen-title {
    font-size: 14px;
    font-weight: 700;
    color: var(--dark-gray);
}

.history-filters {
    padding: 12px var(--app-padding);
    background: var(--off-white);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    gap: 6px;
    overflow-x: auto;
    scrollbar-width: none;
}

.history-filters::-webkit-scrollbar {
    display: none;
}

.filter-btn {
    padding: 5px 12px;
    background: var(--white);
    border: 1px solid var(--border-color);
    border-radius: var(--button-radius);
    font-size: 11px;
    font-weight: 600;
    color: var(--text-gray);
    cursor: pointer;
    white-space: nowrap;
    transition: all var(--transition-speed) ease;
}

.filter-btn.active {
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
    color: var(--white);
    border-color: transparent;
}

.filter-btn:hover:not(.active) {
    border-color: var(--primary-orange);
    color: var(--primary-orange);
}

.history-list {
    flex: 1;
    overflow-y: auto;
    padding: 12px var(--app-padding);
}

.history-item {
    background: var(--white);
    border-radius: var(--element-radius);
    padding: 14px;
    margin-bottom: 8px;
    box-shadow: var(--shadow-light);
    border: 1px solid var(--border-color);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
}

.history-item:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
    border-color: var(--primary-orange);
}

.history-item.expanded {
    margin-bottom: 14px;
}

.history-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 8px;
}

.history-type {
    display: flex;
    align-items: center;
    gap: 5px;
}

.history-icon {
    width: 26px;
    height: 26px;
    border-radius: 6px;
    background: var(--light-orange);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary-orange);
}

.history-type-name {
    font-weight: 600;
    font-size: 12px;
    color: var(--dark-gray);
}

.history-date {
    font-size: 11px;
    color: var(--text-light);
}

.history-status {
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.status-completed {
    background: #E8F6EF;
    color: var(--economy-green);
}

.status-cancelled {
    background: var(--light-red);
    color: var(--error-red);
}

.status-ongoing {
    background: #E3F2FD;
    color: var(--info-blue);
}

.history-locations {
    margin-bottom: 8px;
}

.history-location {
    display: flex;
    align-items: flex-start;
    gap: 5px;
    margin-bottom: 5px;
}

.history-location i {
    color: var(--text-light);
    margin-top: 2px;
}

.history-location-text {
    font-size: 11px;
    color: var(--text-gray);
    line-height: 1.2;
}

.history-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid var(--border-color);
}

.history-price {
    font-size: 13px;
    font-weight: 700;
    color: var(--primary-orange);
}

.history-driver {
    font-size: 11px;
    color: var(--text-gray);
}

.history-details {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
}

.history-item.expanded .history-details {
    max-height: 350px;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid var(--border-color);
}

.detail-section {
    margin-bottom: 12px;
}

.detail-title {
    font-size: 12px;
    font-weight: 600;
    color: var(--dark-gray);
    margin-bottom: 5px;
    display: flex;
    align-items: center;
    gap: 5px;
}

.detail-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
}

.detail-item {
    display: flex;
    flex-direction: column;
    gap: 1px;
}

.detail-label {
    font-size: 10px;
    color: var(--text-light);
    font-weight: 500;
}

.detail-value {
    font-size: 12px;
    color: var(--dark-gray);
    font-weight: 500;
}

.account-screen {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--white);
    z-index: 200;
    display: none;
    flex-direction: column;
    padding-top: 52px;
}

.account-screen.active {
    display: flex;
}

.account-header {
    padding: 16px var(--app-padding);
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
    color: var(--white);
    text-align: center;
}

.account-avatar {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    margin: 0 auto 12px;
    border: 3px solid rgba(255, 255, 255, 0.3);
}

.account-name {
    font-size: 16px;
    font-weight: 700;
    margin-bottom: 2px;
}

.account-phone {
    font-size: 12px;
    opacity: 0.9;
}

.account-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    padding: 14px var(--app-padding);
    background: var(--white);
}

.stat-card {
    background: var(--off-white);
    border-radius: var(--element-radius);
    padding: 12px;
    text-align: center;
}

.stat-value {
    font-size: 18px;
    font-weight: 700;
    color: var(--primary-orange);
    margin-bottom: 2px;
}

.stat-label {
    font-size: 10px;
    color: var(--text-gray);
    font-weight: 500;
}

.account-section {
    padding: 14px var(--app-padding);
    border-bottom: 1px solid var(--border-color);
}

.section-title {
    font-size: 13px;
    font-weight: 700;
    color: var(--dark-gray);
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.wallet-balance {
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
    color: var(--white);
    padding: 16px;
    border-radius: var(--element-radius);
    text-align: center;
    margin-bottom: 14px;
}

.balance-label {
    font-size: 12px;
    opacity: 0.9;
    margin-bottom: 4px;
}

.balance-amount-large {
    font-size: 26px;
    font-weight: 800;
    margin-bottom: 2px;
}

.wallet-actions {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-top: 12px;
}

.btn-wallet {
    padding: 8px;
    border: 2px solid var(--primary-orange);
    background: var(--white);
    color: var(--primary-orange);
    border-radius: var(--button-radius);
    font-weight: 600;
    font-size: 12px;
    cursor: pointer;
    transition: all var(--transition-speed) ease;
}

.btn-wallet:hover {
    background: var(--primary-orange);
    color: var(--white);
    transform: translateY(-2px);
}

.referral-card {
    background: var(--light-orange);
    border-radius: var(--element-radius);
    padding: 14px;
    text-align: center;
    margin-top: 12px;
}

.referral-code {
    background: var(--white);
    padding: 12px;
    border-radius: var(--element-radius);
    margin: 12px 0;
    font-family: monospace;
    font-size: 16px;
    font-weight: 700;
    color: var(--primary-orange);
    letter-spacing: 1px;
}

.referral-note {
    font-size: 10px;
    color: var(--text-gray);
    margin-top: 5px;
}

.emergency-screen {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--white);
    z-index: 200;
    display: none;
    flex-direction: column;
    padding-top: 52px;
}

.emergency-screen.active {
    display: flex;
}

.emergency-services {
    padding: 14px var(--app-padding);
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
}

.emergency-service {
    background: var(--white);
    border: 2px solid var(--border-color);
    border-radius: var(--element-radius);
    padding: 14px;
    text-align: center;
    cursor: pointer;
    transition: all var(--transition-speed) ease;
}

.emergency-service:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-medium);
}

.emergency-service.police {
    border-color: var(--police-blue);
}

.emergency-service.police:hover {
    border-color: var(--police-blue);
    box-shadow: 0 4px 15px rgba(44, 62, 80, 0.2);
}

.emergency-service.fire {
    border-color: var(--fire-truck-red);
}

.emergency-service.fire:hover {
    border-color: var(--fire-truck-red);
    box-shadow: 0 4px 15px rgba(192, 57, 43, 0.2);
}

.emergency-service.medical {
    border-color: var(--ambulance-blue);
}

.emergency-service.medical:hover {
    border-color: var(--ambulance-blue);
    box-shadow: 0 4px 15px rgba(41, 128, 185, 0.2);
}

.emergency-icon {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    margin: 0 auto 8px;
    color: var(--white);
}

.emergency-service.police .emergency-icon {
    background: var(--police-blue);
}

.emergency-service.fire .emergency-icon {
    background: var(--fire-truck-red);
}

.emergency-service.medical .emergency-icon {
    background: var(--ambulance-blue);
}

.emergency-name {
    font-size: 13px;
    font-weight: 700;
    color: var(--dark-gray);
    margin-bottom: 4px;
}

.emergency-description {
    font-size: 11px;
    color: var(--text-gray);
    line-height: 1.2;
}

.emergency-note {
    padding: 14px var(--app-padding);
    background: var(--light-red);
    margin: 14px var(--app-padding);
    border-radius: var(--element-radius);
    border-left: 3px solid var(--error-red);
}

.emergency-note p {
    font-size: 11px;
    color: var(--dark-gray);
    line-height: 1.3;
}

.loading {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid var(--light-gray);
    border-radius: 50%;
    border-top-color: var(--primary-orange);
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.9);
    z-index: 10000;
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 14px;
}

.loading-overlay.active {
    display: flex;
}

.loading-spinner {
    width: 48px;
    height: 48px;
    border: 3px solid var(--light-gray);
    border-radius: 50%;
    border-top-color: var(--primary-orange);
    animation: spin 1s linear infinite;
}

.loading-text {
    font-size: 13px;
    font-weight: 600;
    color: var(--dark-gray);
}

.toast-container {
    position: fixed;
    top: 80px;
    right: var(--app-padding);
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: 6px;
    max-width: 300px;
}

.toast {
    background: var(--white);
    border-radius: var(--element-radius);
    padding: 12px;
    box-shadow: var(--shadow-heavy);
    border-left: 3px solid var(--primary-orange);
    display: flex;
    align-items: flex-start;
    gap: 8px;
    animation: slideInRight 0.3s ease;
    transform: translateX(0);
    transition: transform 0.3s ease;
}

.toast.hiding {
    transform: translateX(100%);
}

.toast-icon {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: var(--light-orange);
    color: var(--primary-orange);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.toast-content {
    flex: 1;
}

.toast-title {
    font-weight: 600;
    font-size: 12px;
    color: var(--dark-gray);
    margin-bottom: 1px;
}

.toast-message {
    font-size: 11px;
    color: var(--text-gray);
    line-height: 1.2;
}

.toast-close {
    background: none;
    border: none;
    color: var(--text-light);
    font-size: 14px;
    cursor: pointer;
    padding: 2px;
    border-radius: 4px;
    transition: all var(--transition-speed) ease;
}

.toast-close:hover {
    color: var(--error-red);
    background: var(--light-red);
}

.toast.success {
    border-left-color: var(--success-green);
}

.toast.success .toast-icon {
    background: #E8F6EF;
    color: var(--success-green);
}

.toast.error {
    border-left-color: var(--error-red);
}

.toast.error .toast-icon {
    background: var(--light-red);
    color: var(--error-red);
}

.toast.warning {
    border-left-color: var(--warning-yellow);
}

.toast.warning .toast-icon {
    background: #FFF3E0;
    color: var(--warning-yellow);
}

@media (max-width: 768px) {
    :root {
        --app-padding: 8px;
        --element-radius: 12px;
        --button-radius: 20px;
    }
    
    .quick-actions {
        grid-template-columns: 1fr;
    }
    
    .ride-type-grid {
        grid-template-columns: 1fr;
    }
    
    .emergency-services {
        grid-template-columns: 1fr;
    }
    
    .chat-container {
        width: calc(100vw - 20px);
        right: 8px;
    }
    
    .detail-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 480px) {
    .nav-tabs {
        gap: 3px;
    }
    
    .nav-tab {
        padding: 6px 3px;
        font-size: 9px;
    }
    
    .nav-tab i {
        font-size: 12px;
    }
    
    .balance-badge {
        padding: 4px 6px;
        font-size: 10px;
    }
    
    .service-tab {
        min-width: 80px;
        padding: 8px 10px;
    }
}

.current-location-marker {
    background: var(--info-blue);
    color: white;
    border-radius: 50%;
    width: 16px;
    height: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 8px;
    box-shadow: 0 1px 6px rgba(0,0,0,0.3);
    border: 2px solid white;
}

.pickup-marker {
    background: var(--primary-orange);
    color: white;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 9px;
    box-shadow: 0 1px 6px rgba(0,0,0,0.3);
    border: 2px solid white;
}

.destination-marker {
    background: var(--primary-red);
    color: white;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 9px;
    box-shadow: 0 1px 6px rgba(0,0,0,0.3);
    border: 2px solid white;
}

.driver-marker {
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
    color: white;
    border-radius: 50%;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    box-shadow: 0 1px 6px rgba(0,0,0,0.3);
    border: 2px solid white;
    animation: pulse 2s infinite;
}

.emergency-vehicle-marker {
    background: var(--error-red);
    color: white;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    box-shadow: 0 1px 6px rgba(0,0,0,0.3);
    border: 2px solid white;
    animation: emergencyPulse 1s infinite;
}

.form-group {
    margin-bottom: 12px;
}

.form-label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    font-size: 12px;
    color: var(--dark-gray);
}

.form-control {
    width: 100%;
    padding: 10px;
    border: 2px solid var(--border-color);
    border-radius: var(--element-radius);
    font-size: 12px;
    color: var(--dark-gray);
    background: var(--white);
    transition: all var(--transition-speed) ease;
}

.form-control:focus {
    outline: none;
    border-color: var(--primary-orange);
    box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
}

.form-textarea {
    min-height: 70px;
    resize: vertical;
}

.search-loading {
    display: none;
    position: absolute;
    top: 50%;
    right: 10px;
    transform: translateY(-50%);
    width: 12px;
    height: 12px;
    border: 2px solid var(--light-gray);
    border-radius: 50%;
    border-top-color: var(--primary-orange);
    animation: spin 0.6s linear infinite;
}

.location-input.searching .search-loading {
    display: block;
}

.no-results {
    padding: 25px 12px;
    text-align: center;
    color: var(--text-light);
    font-size: 12px;
}

.no-results i {
    font-size: 24px;
    margin-bottom: 8px;
    opacity: 0.5;
}

.price-calculation {
    background: var(--off-white);
    border-radius: var(--element-radius);
    padding: 12px;
    margin: 12px 0;
    font-size: 11px;
    color: var(--text-gray);
}

.calculation-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 4px;
}

.calculation-row:last-child {
    margin-bottom: 0;
    padding-top: 4px;
    border-top: 1px solid var(--border-color);
    font-weight: 600;
    color: var(--dark-gray);
}

.cancel-reasons {
    display: grid;
    grid-template-columns: 1fr;
    gap: 8px;
    margin-bottom: 14px;
}

.cancel-reason {
    padding: 12px;
    border: 2px solid var(--border-color);
    border-radius: var(--element-radius);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    display: flex;
    align-items: center;
    gap: 8px;
}

.cancel-reason:hover {
    border-color: var(--primary-orange);
    background: var(--light-orange);
}

.cancel-reason.selected {
    border-color: var(--primary-orange);
    background: var(--light-orange);
}

.reason-icon {
    width: 26px;
    height: 26px;
    border-radius: 6px;
    background: var(--light-gray);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-gray);
}

.cancel-reason.selected .reason-icon {
    background: var(--primary-orange);
    color: var(--white);
}

.reason-text {
    flex: 1;
    font-weight: 500;
    color: var(--dark-gray);
}

.schedule-form {
    display: none;
    background: var(--white);
    border-radius: var(--element-radius);
    padding: 14px;
    margin-bottom: 10px;
    box-shadow: var(--shadow-light);
    border: 1px solid var(--border-color);
}

.schedule-form.active {
    display: block;
}

.schedule-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-bottom: 12px;
}

.more-options {
    display: none;
    background: var(--white);
    border-radius: var(--element-radius);
    padding: 14px;
    margin-bottom: 10px;
    box-shadow: var(--shadow-light);
    border: 1px solid var(--border-color);
}

.more-options.active {
    display: block;
}

.options-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
}

.option-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
    padding: 12px;
    background: var(--off-white);
    border: 2px solid transparent;
    border-radius: var(--element-radius);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
}

.option-btn:hover {
    border-color: var(--primary-orange);
    background: var(--white);
    transform: translateY(-2px);
}

.option-icon {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    background: var(--light-orange);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary-orange);
    font-size: 14px;
}

.option-name {
    font-weight: 600;
    font-size: 11px;
    color: var(--dark-gray);
    text-align: center;
}

.empty-state {
    padding: 40px 12px;
    text-align: center;
    color: var(--text-light);
}

.empty-icon {
    font-size: 36px;
    margin-bottom: 12px;
    opacity: 0.3;
}

.empty-title {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 4px;
    color: var(--text-gray);
}

.empty-message {
    font-size: 12px;
    margin-bottom: 14px;
    line-height: 1.3;
}

.service-form {
    display: none;
    background: var(--white);
    border-radius: var(--element-radius);
    padding: 14px;
    margin-bottom: 10px;
    box-shadow: var(--shadow-light);
    border: 1px solid var(--border-color);
}

.service-form.active {
    display: block;
    animation: fadeIn 0.3s ease;
}

.truck-form {
    border-color: var(--light-truck-brown);
}

.truck-form .form-title {
    color: var(--light-truck-brown);
}

.delivery-form {
    border-color: var(--delivery-purple);
}

.delivery-form .form-title {
    color: var(--delivery-purple);
}

.express-form {
    border-color: var(--express-shop-green);
}

.express-form .form-title {
    color: var(--express-shop-green);
}

.someone-else-form {
    border-color: var(--info-blue);
}

.someone-else-form .form-title {
    color: var(--info-blue);
}

.share-ride-form {
    border-color: var(--warning-yellow);
}

.share-ride-form .form-title {
    color: var(--warning-yellow);
}

.payment-methods {
    display: grid;
    grid-template-columns: 1fr;
    gap: 8px;
    margin: 14px 0;
}

.payment-method {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px;
    border: 2px solid var(--border-color);
    border-radius: var(--element-radius);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
}

.payment-method:hover {
    border-color: var(--primary-orange);
    background: var(--light-orange);
}

.payment-method.selected {
    border-color: var(--primary-orange);
    background: var(--light-orange);
}

.payment-icon {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    background: var(--light-gray);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-gray);
}

.payment-method.selected .payment-icon {
    background: var(--primary-orange);
    color: var(--white);
}

.payment-details {
    flex: 1;
}

.payment-name {
    font-weight: 600;
    font-size: 12px;
    color: var(--dark-gray);
}

.payment-info {
    font-size: 10px;
    color: var(--text-gray);
    margin-top: 1px;
}

.transfer-form {
    display: none;
}

.transfer-form.active {
    display: block;
}

.timeline {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin: 14px 0;
    padding: 0 16px;
    position: relative;
}

.timeline::before {
    content: '';
    position: absolute;
    top: 10px;
    left: 10%;
    right: 10%;
    height: 2px;
    background: var(--border-color);
    z-index: 1;
}

.timeline-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    position: relative;
    z-index: 2;
    flex: 1;
}

.step-dot {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--light-gray);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-light);
    font-size: 9px;
    border: 2px solid var(--white);
    transition: all var(--transition-speed) ease;
}

.step-dot.active {
    background: var(--primary-orange);
    color: var(--white);
    transform: scale(1.1);
}

.step-dot.completed {
    background: var(--success-green);
    color: var(--white);
}

.step-label {
    font-size: 10px;
    color: var(--text-light);
    text-align: center;
}

.step-label.active {
    color: var(--primary-orange);
    font-weight: 600;
}

.parcel-details {
    background: var(--off-white);
    border-radius: var(--element-radius);
    padding: 12px;
    margin: 10px 0;
}

.parcel-value-input {
    display: flex;
    align-items: center;
    gap: 6px;
}

.parcel-value-input span {
    font-weight: 600;
    color: var(--text-gray);
}

.parcel-value-input input {
    flex: 1;
    padding: 8px;
    border: 1px solid var(--border-color);
    border-radius: var(--element-radius);
    font-size: 12px;
}

.truck-types {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
    margin: 10px 0;
}

.truck-type {
    padding: 10px;
    border: 2px solid var(--border-color);
    border-radius: var(--element-radius);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    text-align: center;
}

.truck-type:hover {
    border-color: var(--light-truck-brown);
    transform: translateY(-2px);
}

.truck-type.selected {
    border-color: var(--light-truck-brown);
    background: rgba(139, 69, 19, 0.05);
}

.truck-icon {
    font-size: 18px;
    color: var(--light-truck-brown);
    margin-bottom: 4px;
}

.truck-name {
    font-weight: 600;
    font-size: 11px;
    color: var(--dark-gray);
    margin-bottom: 1px;
}

.truck-capacity {
    font-size: 9px;
    color: var(--text-gray);
}

.item-list {
    margin: 10px 0;
}

.item-entry {
    display: flex;
    gap: 6px;
    margin-bottom: 6px;
}

.item-entry input {
    flex: 1;
    padding: 8px;
    border: 1px solid var(--border-color);
    border-radius: var(--element-radius);
    font-size: 12px;
}

.remove-item {
    width: 32px;
    height: 32px;
    border-radius: var(--element-radius);
    background: var(--light-red);
    border: none;
    color: var(--error-red);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

.add-item {
    width: 100%;
    padding: 8px;
    background: var(--light-orange);
    border: 2px dashed var(--primary-orange);
    border-radius: var(--element-radius);
    color: var(--primary-orange);
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    transition: all var(--transition-speed) ease;
}

.add-item:hover {
    background: var(--primary-orange);
    color: var(--white);
}

.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}

*:focus {
    outline: 2px solid var(--primary-orange);
    outline-offset: 2px;
}

*:focus:not(.focus-visible) {
    outline: none;
}

@media print {
    .main-panel,
    .top-bar,
    .chat-container,
    .modal-overlay,
    .sos-button,
    .ride-status-bar,
    .emergency-status {
        display: none !important;
    }
    
    #map {
        position: relative;
        height: 250px;
    }
}

.broadcast-section {
    background: var(--white);
    border-radius: var(--element-radius);
    padding: 14px;
    margin: 10px 0;
    box-shadow: var(--shadow-light);
    border: 1px solid var(--border-color);
}

.broadcast-form {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.broadcast-input-group {
    display: flex;
    gap: 6px;
}

.broadcast-input-group input {
    flex: 1;
    padding: 8px 12px;
    border: 1px solid var(--border-color);
    border-radius: var(--element-radius);
    font-size: 12px;
}

.broadcast-btn {
    padding: 8px 14px;
    background: var(--primary-orange);
    color: var(--white);
    border: none;
    border-radius: var(--element-radius);
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-speed) ease;
}

.broadcast-btn:hover {
    background: var(--secondary-orange);
    transform: translateY(-2px);
}

.broadcast-list {
    margin-top: 10px;
    max-height: 180px;
    overflow-y: auto;
}

.broadcast-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px;
    border-bottom: 1px solid var(--border-color);
}

.broadcast-item:last-child {
    border-bottom: none;
}

.broadcast-name {
    font-weight: 600;
    font-size: 12px;
}

.broadcast-status {
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 10px;
    background: var(--light-orange);
    color: var(--primary-orange);
}

.broadcast-status.pending {
    background: #FFF3E0;
    color: var(--warning-yellow);
}

.broadcast-status.accepted {
    background: #E8F6EF;
    color: var(--success-green);
}

.driver-media {
    display: flex;
    gap: 10px;
    margin-top: 8px;
}

.media-container {
    flex: 1;
    border-radius: var(--element-radius);
    overflow: hidden;
    background: var(--light-gray);
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 70px;
}

.media-container img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.media-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: var(--text-light);
    font-size: 11px;
}

.media-placeholder i {
    font-size: 20px;
    margin-bottom: 3px;
}

.emergency-reasons {
    display: grid;
    grid-template-columns: 1fr;
    gap: 8px;
    margin: 14px 0;
}

.emergency-reason {
    padding: 12px;
    border: 2px solid var(--border-color);
    border-radius: var(--element-radius);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    display: flex;
    align-items: center;
    gap: 8px;
}

.emergency-reason:hover {
    border-color: var(--error-red);
    background: var(--light-red);
}

.emergency-reason.selected {
    border-color: var(--error-red);
    background: var(--light-red);
}

.emergency-reason-icon {
    width: 26px;
    height: 26px;
    border-radius: 6px;
    background: var(--light-red);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--error-red);
}

.emergency-reason.selected .emergency-reason-icon {
    background: var(--error-red);
    color: var(--white);
}

.emergency-reason-text {
    flex: 1;
    font-weight: 500;
    color: var(--dark-gray);
}

.emergency-stations {
    margin: 14px 0;
    max-height: 180px;
    overflow-y: auto;
}

.emergency-station {
    padding: 10px;
    border: 2px solid var(--border-color);
    border-radius: var(--element-radius);
    margin-bottom: 6px;
    cursor: pointer;
    transition: all var(--transition-speed) ease;
}

.emergency-station:hover {
    border-color: var(--primary-orange);
    background: var(--light-orange);
}

.emergency-station.selected {
    border-color: var(--primary-orange);
    background: var(--light-orange);
}

.station-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 3px;
}

.station-name {
    font-weight: 600;
    font-size: 12px;
    color: var(--dark-gray);
}

.station-distance {
    font-size: 10px;
    color: var(--text-gray);
}

.station-address {
    font-size: 11px;
    color: var(--text-gray);
    line-height: 1.2;
}

.station-details {
    margin-top: 4px;
    font-size: 10px;
    color: var(--text-light);
    display: flex;
    gap: 8px;
}

.search-results-container {
    position: relative;
    z-index: 1001;
}

.search-result-item {
    padding: 10px 14px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    display: flex;
    align-items: flex-start;
    gap: 10px;
}

.search-result-item:hover {
    background: var(--light-orange);
}

.search-result-icon {
    color: var(--primary-orange);
    font-size: 14px;
    margin-top: 2px;
}

.search-result-content {
    flex: 1;
}

.search-result-title {
    font-weight: 600;
    font-size: 12px;
    color: var(--dark-gray);
    margin-bottom: 1px;
}

.search-result-subtitle {
    font-size: 11px;
    color: var(--text-gray);
    margin-bottom: 1px;
}

.search-result-details {
    display: flex;
    justify-content: space-between;
    font-size: 10px;
    color: var(--text-light);
}

.city-detection {
    position: absolute;
    top: 56px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 150;
    background: var(--white);
    padding: 6px 14px;
    border-radius: var(--button-radius);
    box-shadow: var(--shadow-heavy);
    border: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    font-weight: 500;
    color: var(--dark-gray);
}

.city-detection i {
    color: var(--primary-orange);
}

.notifications-panel {
    position: absolute;
    top: 52px;
    right: var(--app-padding);
    z-index: 250;
    width: 280px;
    max-width: calc(100vw - 40px);
    background: var(--white);
    border-radius: var(--card-radius);
    box-shadow: var(--shadow-heavy);
    display: none;
    flex-direction: column;
    overflow: hidden;
    border: 1px solid var(--border-color);
}

.notifications-panel.active {
    display: flex;
    animation: slideDown 0.3s ease;
}

.notifications-header {
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
    color: var(--white);
    padding: 12px;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.notifications-title {
    font-weight: 600;
    font-size: 12px;
}

.notifications-close {
    background: none;
    border: none;
    color: var(--white);
    font-size: 14px;
    cursor: pointer;
    padding: 3px;
    border-radius: 4px;
    transition: all var(--transition-speed) ease;
}

.notifications-close:hover {
    background: rgba(255, 255, 255, 0.2);
}

.notifications-list {
    flex: 1;
    max-height: 250px;
    overflow-y: auto;
    background: var(--off-white);
}

.notification-item {
    padding: 12px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
}

.notification-item:hover {
    background: var(--white);
}

.notification-item.unread {
    background: var(--light-orange);
}

.notification-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 4px;
}

.notification-title {
    font-weight: 600;
    font-size: 12px;
    color: var(--dark-gray);
    display: flex;
    align-items: center;
    gap: 5px;
}

.notification-time {
    font-size: 10px;
    color: var(--text-light);
}

.notification-message {
    font-size: 11px;
    color: var(--text-gray);
    line-height: 1.2;
}

.notification-actions {
    margin-top: 6px;
    display: flex;
    gap: 6px;
}

.notification-action-btn {
    padding: 3px 6px;
    font-size: 10px;
    border-radius: 10px;
    border: 1px solid var(--border-color);
    background: var(--white);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
}

.notification-action-btn:hover {
    background: var(--primary-orange);
    color: var(--white);
    border-color: var(--primary-orange);
}

.dropdown-menu {
    position: absolute;
    top: 56px;
    right: var(--app-padding);
    z-index: 250;
    width: 180px;
    background: var(--white);
    border-radius: var(--element-radius);
    box-shadow: var(--shadow-heavy);
    display: none;
    flex-direction: column;
    overflow: hidden;
    border: 1px solid var(--border-color);
}

.dropdown-menu.active {
    display: flex;
    animation: slideDown 0.3s ease;
}

.dropdown-item {
    padding: 10px 14px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    color: var(--dark-gray);
}

.dropdown-item:hover {
    background: var(--light-orange);
    color: var(--primary-orange);
}

.dropdown-item:last-child {
    border-bottom: none;
}

.dropdown-item i {
    width: 16px;
    text-align: center;
}

.more-options-menu {
    position: absolute;
    bottom: 180px;
    left: var(--app-padding);
    z-index: 250;
    width: 180px;
    background: var(--white);
    border-radius: var(--element-radius);
    box-shadow: var(--shadow-heavy);
    display: none;
    flex-direction: column;
    overflow: hidden;
    border: 1px solid var(--border-color);
}

.more-options-menu.active {
    display: flex;
    animation: slideUp 0.3s ease;
}

.emergency-modal-content {
    max-height: 65vh;
    overflow-y: auto;
}

.emergency-reason-input {
    margin-top: 8px;
}

.emergency-reason-input textarea {
    width: 100%;
    padding: 8px;
    border: 1px solid var(--border-color);
    border-radius: var(--element-radius);
    font-size: 12px;
    resize: vertical;
    min-height: 70px;
}

.real-time-indicator {
    position: fixed;
    bottom: 8px;
    right: 8px;
    z-index: 1000;
    background: var(--success-green);
    color: var(--white);
    padding: 4px 10px;
    border-radius: var(--button-radius);
    font-size: 10px;
    font-weight: 600;
    display: none;
    align-items: center;
    gap: 5px;
    box-shadow: var(--shadow-medium);
}

.real-time-indicator.active {
    display: flex;
    animation: fadeIn 0.3s ease;
}

.chat-typing-indicator {
    font-size: 10px;
    color: var(--text-light);
    font-style: italic;
    padding: 3px 10px;
    display: none;
}

.chat-typing-indicator.active {
    display: block;
}

.chat-attachment-btn {
    background: none;
    border: none;
    color: var(--text-light);
    font-size: 14px;
    cursor: pointer;
    padding: 3px;
    border-radius: 4px;
    transition: all var(--transition-speed) ease;
}

.chat-attachment-btn:hover {
    color: var(--primary-orange);
    background: var(--light-orange);
}

.search-bar-container {
    position: relative;
    margin-bottom: 10px;
}

.search-bar {
    width: 100%;
    padding: 10px 14px 10px 36px;
    border: 2px solid var(--border-color);
    border-radius: var(--button-radius);
    font-size: 12px;
    transition: all var(--transition-speed) ease;
}

.search-bar:focus {
    border-color: var(--primary-orange);
    box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
}

.search-bar-icon {
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-light);
}

.price-calculator-display {
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
    color: var(--white);
    padding: 14px;
    border-radius: var(--element-radius);
    margin: 14px 0;
    box-shadow: var(--shadow-medium);
}

.price-breakdown {
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
}

.price-breakdown-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 3px;
    font-size: 11px;
    opacity: 0.9;
}

.price-breakdown-row.total {
    margin-top: 6px;
    padding-top: 6px;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    font-weight: 700;
    font-size: 12px;
}

.map-controls {
    position: absolute;
    top: 90px;
    right: var(--app-padding);
    z-index: 100;
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.map-control-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: var(--white);
    border: 1px solid var(--border-color);
    box-shadow: var(--shadow-medium);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--dark-gray);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
}

.map-control-btn:hover {
    background: var(--primary-orange);
    color: var(--white);
    transform: scale(1.1);
}

.tracking-info {
    background: var(--white);
    border-radius: var(--element-radius);
    padding: 10px;
    margin: 10px 0;
    box-shadow: var(--shadow-light);
    border: 1px solid var(--border-color);
}

.tracking-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 6px;
}

.tracking-title {
    font-weight: 600;
    font-size: 12px;
    color: var(--dark-gray);
}

.tracking-distance {
    font-size: 11px;
    color: var(--primary-orange);
    font-weight: 600;
}

.tracking-progress {
    height: 4px;
    background: var(--light-gray);
    border-radius: 2px;
    overflow: hidden;
    margin-bottom: 6px;
}

.tracking-progress-bar {
    height: 100%;
    background: var(--primary-orange);
    border-radius: 2px;
    transition: width 0.3s ease;
}

.tracking-details {
    display: flex;
    justify-content: space-between;
    font-size: 10px;
    color: var(--text-gray);
}

.broadcast-feature {
    background: var(--white);
    border-radius: var(--element-radius);
    padding: 14px;
    margin: 14px 0;
    box-shadow: var(--shadow-medium);
    border: 1px solid var(--border-color);
}

.broadcast-feature-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 10px;
}

.broadcast-feature-title {
    font-size: 13px;
    font-weight: 700;
    color: var(--dark-gray);
    display: flex;
    align-items: center;
    gap: 6px;
}

.broadcast-status-indicator {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--success-green);
    animation: pulse 1.5s infinite;
}

.broadcast-status-indicator.inactive {
    background: var(--text-light);
    animation: none;
}

.broadcast-recipients {
    max-height: 130px;
    overflow-y: auto;
    margin-bottom: 10px;
}

.broadcast-recipient {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 6px;
    border-bottom: 1px solid var(--border-color);
}

.broadcast-recipient:last-child {
    border-bottom: none;
}

.recipient-info {
    display: flex;
    align-items: center;
    gap: 6px;
}

.recipient-avatar {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: var(--light-orange);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary-orange);
    font-weight: 600;
    font-size: 11px;
}

.recipient-name {
    font-weight: 600;
    font-size: 12px;
    color: var(--dark-gray);
}

.recipient-status {
    font-size: 10px;
    padding: 2px 5px;
    border-radius: 10px;
}

.status-joined {
    background: #E8F6EF;
    color: var(--success-green);
}

.status-pending {
    background: #FFF3E0;
    color: var(--warning-yellow);
}

.location-details {
    background: var(--off-white);
    border-radius: var(--element-radius);
    padding: 12px;
    margin: 10px 0;
}

.location-detail-item {
    display: flex;
    align-items: flex-start;
    gap: 8px;
    margin-bottom: 8px;
}

.location-detail-item:last-child {
    margin-bottom: 0;
}

.location-detail-icon {
    color: var(--primary-orange);
    font-size: 13px;
    margin-top: 2px;
}

.location-detail-content {
    flex: 1;
}

.location-detail-label {
    font-size: 10px;
    color: var(--text-light);
    margin-bottom: 1px;
}

.location-detail-value {
    font-size: 12px;
    color: var(--dark-gray);
    font-weight: 500;
    line-height: 1.2;
}

.emergency-contact-display {
    background: var(--light-red);
    border-radius: var(--element-radius);
    padding: 12px;
    margin: 10px 0;
    border-left: 3px solid var(--error-red);
}

.emergency-contact-header {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 6px;
}

.emergency-contact-title {
    font-weight: 600;
    font-size: 12px;
    color: var(--dark-gray);
}

.emergency-contact-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 0;
    border-bottom: 1px solid rgba(231, 76, 60, 0.1);
}

.emergency-contact-item:last-child {
    border-bottom: none;
}

.contact-info {
    display: flex;
    align-items: center;
    gap: 6px;
}

.contact-name {
    font-weight: 600;
    font-size: 12px;
    color: var(--dark-gray);
}

.contact-phone {
    font-size: 11px;
    color: var(--text-gray);
}

.contact-action-btn {
    padding: 3px 6px;
    font-size: 10px;
    border-radius: 10px;
    background: var(--white);
    border: 1px solid var(--error-red);
    color: var(--error-red);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
}

.contact-action-btn:hover {
    background: var(--error-red);
    color: var(--white);
}

.service-type-indicator {
    display: inline-flex;
    align-items: center;
    gap: 3px;
    padding: 3px 6px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
}

.indicator-car {
    background: var(--light-orange);
    color: var(--primary-orange);
}

.indicator-delivery {
    background: #F4E6FA;
    color: var(--delivery-purple);
}

.indicator-truck {
    background: rgba(139, 69, 19, 0.1);
    color: var(--light-truck-brown);
}

.indicator-emergency {
    background: var(--light-red);
    color: var(--error-red);
}

.indicator-shopping {
    background: #E1F5FE;
    color: var(--express-shop-green);
}

.price-update-animation {
    animation: priceUpdate 0.5s ease;
}

@keyframes priceUpdate {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.sync-indicator {
    position: fixed;
    bottom: 8px;
    left: 8px;
    z-index: 1000;
    background: var(--info-blue);
    color: var(--white);
    padding: 4px 10px;
    border-radius: var(--button-radius);
    font-size: 10px;
    font-weight: 600;
    display: none;
    align-items: center;
    gap: 5px;
    box-shadow: var(--shadow-medium);
}

.sync-indicator.active {
    display: flex;
    animation: fadeIn 0.3s ease;
}

.sync-indicator.syncing .sync-icon {
    animation: spin 1s linear infinite;
}

.distance-display {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    background: var(--light-orange);
    border-radius: var(--element-radius);
    font-size: 11px;
    color: var(--dark-gray);
}

.distance-value {
    font-weight: 700;
    color: var(--primary-orange);
}

.eta-display {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    background: var(--light-gray);
    border-radius: var(--element-radius);
    font-size: 11px;
    color: var(--dark-gray);
}

.eta-value {
    font-weight: 700;
    color: var(--info-blue);
}

.search-history {
    margin-top: 6px;
    max-height: 130px;
    overflow-y: auto;
}

.search-history-item {
    padding: 8px 10px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    display: flex;
    align-items: center;
    gap: 6px;
}

.search-history-item:hover {
    background: var(--light-orange);
}

.search-history-icon {
    color: var(--text-light);
    font-size: 11px;
}

.search-history-text {
    flex: 1;
    font-size: 12px;
    color: var(--dark-gray);
}

.search-history-time {
    font-size: 10px;
    color: var(--text-light);
}

.broadcast-notification {
    background: var(--info-blue);
    color: var(--white);
    padding: 10px;
    border-radius: var(--element-radius);
    margin: 10px 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.broadcast-notification-content {
    flex: 1;
}

.broadcast-notification-title {
    font-weight: 600;
    font-size: 12px;
    margin-bottom: 3px;
}

.broadcast-notification-message {
    font-size: 11px;
    opacity: 0.9;
}

.broadcast-notification-actions {
    display: flex;
    gap: 6px;
}

.map-loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.9);
    z-index: 2;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 10px;
}

.map-loading-text {
    font-size: 13px;
    font-weight: 600;
    color: var(--dark-gray);
}

.error-display {
    background: var(--light-red);
    border-radius: var(--element-radius);
    padding: 12px;
    margin: 10px 0;
    border-left: 3px solid var(--error-red);
}

.error-title {
    font-weight: 600;
    font-size: 12px;
    color: var(--error-red);
    margin-bottom: 4px;
    display: flex;
    align-items: center;
    gap: 5px;
}

.error-message {
    font-size: 11px;
    color: var(--dark-gray);
    line-height: 1.2;
}

.success-display {
    background: #E8F6EF;
    border-radius: var(--element-radius);
    padding: 12px;
    margin: 10px 0;
    border-left: 3px solid var(--success-green);
}

.success-title {
    font-weight: 600;
    font-size: 12px;
    color: var(--success-green);
    margin-bottom: 4px;
    display: flex;
    align-items: center;
    gap: 5px;
}

.success-message {
    font-size: 11px;
    color: var(--dark-gray);
    line-height: 1.2;
}

.warning-display {
    background: #FFF3E0;
    border-radius: var(--element-radius);
    padding: 12px;
    margin: 10px 0;
    border-left: 3px solid var(--warning-yellow);
}

.warning-title {
    font-weight: 600;
    font-size: 12px;
    color: var(--warning-yellow);
    margin-bottom: 4px;
    display: flex;
    align-items: center;
    gap: 5px;
}

.warning-message {
    font-size: 11px;
    color: var(--dark-gray);
    line-height: 1.2;
}

.route-instructions-panel {
    position: absolute;
    top: 110px;
    right: var(--app-padding);
    z-index: 150;
    background: var(--white);
    border-radius: var(--element-radius);
    padding: 10px;
    box-shadow: var(--shadow-heavy);
    border: 1px solid var(--border-color);
    max-width: 200px;
    display: none;
    animation: slideInRight 0.3s ease;
}

.route-instructions-panel.active {
    display: block;
}

.route-instruction {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px;
    border-bottom: 1px solid var(--border-color);
    font-size: 11px;
}

.route-instruction:last-child {
    border-bottom: none;
}

.route-instruction-icon {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: var(--light-orange);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary-orange);
    font-size: 10px;
}

.route-instruction-text {
    flex: 1;
    color: var(--dark-gray);
}

.route-instruction-distance {
    font-size: 10px;
    color: var(--text-gray);
    font-weight: 600;
}

/* ENHANCED SEARCH SUGGESTIONS STYLES */
.search-results-dropdown {
    position: absolute !important;
    top: 100% !important;
    left: 0 !important;
    right: 0 !important;
    background: var(--white) !important;
    border: 1px solid var(--border-color) !important;
    border-radius: var(--element-radius) !important;
    box-shadow: var(--shadow-heavy) !important;
    z-index: 1001 !important;
    max-height: 300px !important;
    overflow-y: auto !important;
    display: none !important;
    margin-top: 5px !important;
    animation: slideDown 0.2s ease !important;
}

.search-results-dropdown.active {
    display: block !important;
}

.search-result-item {
    padding: 12px 16px !important;
    border-bottom: 1px solid var(--border-color) !important;
    cursor: pointer !important;
    transition: all var(--transition-speed) ease !important;
    display: flex !important;
    align-items: flex-start !important;
    gap: 12px !important;
    background: var(--white) !important;
}

.search-result-item:hover {
    background: var(--light-orange) !important;
    transform: translateX(2px) !important;
}

.search-result-item:last-child {
    border-bottom: none !important;
}

.search-result-icon {
    width: 32px !important;
    height: 32px !important;
    border-radius: 8px !important;
    background: var(--light-orange) !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    color: var(--primary-orange) !important;
    font-size: 14px !important;
    flex-shrink: 0 !important;
    margin-top: 2px !important;
}

.search-result-icon.pickup {
    background: var(--light-orange) !important;
    color: var(--primary-orange) !important;
}

.search-result-icon.destination {
    background: var(--light-red) !important;
    color: var(--primary-red) !important;
}

.search-result-content {
    flex: 1 !important;
    min-width: 0 !important;
}

.search-result-title {
    font-weight: 600 !important;
    font-size: 13px !important;
    color: var(--dark-gray) !important;
    margin-bottom: 3px !important;
    line-height: 1.2 !important;
    display: flex !important;
    align-items: center !important;
    gap: 5px !important;
}

.search-result-verified {
    color: var(--success-green) !important;
    font-size: 10px !important;
}

.search-result-address {
    font-size: 11px !important;
    color: var(--text-gray) !important;
    line-height: 1.3 !important;
    margin-bottom: 4px !important;
    display: -webkit-box !important;
    -webkit-line-clamp: 2 !important;
    -webkit-box-orient: vertical !important;
    overflow: hidden !important;
}

.search-result-details {
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    font-size: 10px !important;
}

.search-result-distance {
    color: var(--primary-orange) !important;
    font-weight: 600 !important;
    background: rgba(255, 107, 53, 0.1) !important;
    padding: 2px 6px !important;
    border-radius: 8px !important;
}

.search-result-type {
    color: var(--text-light) !important;
    text-transform: capitalize !important;
}

.search-result-category {
    display: inline-flex !important;
    align-items: center !important;
    gap: 3px !important;
    padding: 2px 6px !important;
    border-radius: 8px !important;
    font-size: 9px !important;
    font-weight: 600 !important;
    text-transform: uppercase !important;
    letter-spacing: 0.3px !important;
}

.search-result-category.restaurant {
    background: #FFF3E0 !important;
    color: #E67E22 !important;
}

.search-result-category.hotel {
    background: #E3F2FD !important;
    color: #2980B9 !important;
}

.search-result-category.shopping {
    background: #F3E5F5 !important;
    color: #8E44AD !important;
}

.search-result-category.medical {
    background: #FFEBEE !important;
    color: #C0392B !important;
}

.search-result-category.education {
    background: #E8F5E9 !important;
    color: #27AE60 !important;
}

.search-result-category.government {
    background: #F5F5F5 !important;
    color: #2C3E50 !important;
}

/* Search Header */
.search-header {
    padding: 12px 16px !important;
    border-bottom: 1px solid var(--border-color) !important;
    background: var(--off-white) !important;
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    font-size: 11px !important;
    color: var(--text-gray) !important;
}

.search-count {
    font-weight: 600 !important;
    color: var(--primary-orange) !important;
}

.search-city {
    display: flex !important;
    align-items: center !important;
    gap: 4px !important;
}

/* No Results */
.search-no-results {
    padding: 30px 20px !important;
    text-align: center !important;
    color: var(--text-light) !important;
}

.search-no-results-icon {
    font-size: 32px !important;
    margin-bottom: 10px !important;
    color: var(--medium-gray) !important;
}

.search-no-results-title {
    font-weight: 600 !important;
    font-size: 13px !important;
    color: var(--text-gray) !important;
    margin-bottom: 5px !important;
}

.search-no-results-message {
    font-size: 11px !important;
    line-height: 1.4 !important;
}

/* Search Loading */
.search-loading-overlay {
    padding: 20px !important;
    text-align: center !important;
    color: var(--text-light) !important;
}

.search-loading-spinner {
    width: 20px !important;
    height: 20px !important;
    border: 2px solid var(--light-gray) !important;
    border-radius: 50% !important;
    border-top-color: var(--primary-orange) !important;
    animation: spin 0.8s linear infinite !important;
    margin: 0 auto 10px !important;
}

/* Recent Searches */
.recent-searches-section {
    padding: 12px 0 !important;
    border-bottom: 1px solid var(--border-color) !important;
}

.recent-searches-title {
    padding: 0 16px 8px !important;
    font-size: 11px !important;
    color: var(--text-light) !important;
    font-weight: 600 !important;
    text-transform: uppercase !important;
    letter-spacing: 0.5px !important;
}

.recent-search-item {
    padding: 10px 16px !important;
    display: flex !important;
    align-items: center !important;
    gap: 10px !important;
    cursor: pointer !important;
    transition: all var(--transition-speed) ease !important;
}

.recent-search-item:hover {
    background: var(--light-orange) !important;
}

.recent-search-icon {
    width: 28px !important;
    height: 28px !important;
    border-radius: 6px !important;
    background: var(--light-gray) !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    color: var(--text-gray) !important;
    font-size: 12px !important;
}

.recent-search-content {
    flex: 1 !important;
}

.recent-search-name {
    font-weight: 500 !important;
    font-size: 12px !important;
    color: var(--dark-gray) !important;
    margin-bottom: 2px !important;
}

.recent-search-address {
    font-size: 10px !important;
    color: var(--text-gray) !important;
    line-height: 1.2 !important;
    display: -webkit-box !important;
    -webkit-line-clamp: 1 !important;
    -webkit-box-orient: vertical !important;
    overflow: hidden !important;
}

.recent-search-time {
    font-size: 9px !important;
    color: var(--text-light) !important;
}

/* Search Input Enhancements */
.location-input.with-suggestions {
    position: relative !important;
}

.location-input.with-suggestions input {
    padding-right: 40px !important;
}

.location-clear-btn {
    position: absolute !important;
    right: 35px !important;
    top: 50% !important;
    transform: translateY(-50%) !important;
    background: none !important;
    border: none !important;
    color: var(--text-light) !important;
    font-size: 14px !important;
    cursor: pointer !important;
    padding: 4px !important;
    border-radius: 4px !important;
    display: none !important;
    transition: all var(--transition-speed) ease !important;
}

.location-input input:not(:placeholder-shown) ~ .location-clear-btn {
    display: block !important;
}

.location-clear-btn:hover {
    color: var(--error-red) !important;
    background: var(--light-red) !important;
}

/* Enhanced Map Controls */
.map-controls-enhanced {
    position: absolute !important;
    top: 100px !important;
    right: var(--app-padding) !important;
    z-index: 100 !important;
    display: flex !important;
    flex-direction: column !important;
    gap: 8px !important;
    background: var(--white) !important;
    padding: 8px !important;
    border-radius: var(--element-radius) !important;
    box-shadow: var(--shadow-heavy) !important;
    border: 1px solid var(--border-color) !important;
}

.map-control-btn-enhanced {
    width: 40px !important;
    height: 40px !important;
    border-radius: var(--element-radius) !important;
    background: var(--white) !important;
    border: 1px solid var(--border-color) !important;
    box-shadow: var(--shadow-light) !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    color: var(--dark-gray) !important;
    cursor: pointer !important;
    transition: all var(--transition-speed) ease !important;
    position: relative !important;
}

.map-control-btn-enhanced:hover {
    background: var(--primary-orange) !important;
    color: var(--white) !important;
    transform: translateY(-2px) !important;
    box-shadow: var(--shadow-medium) !important;
}

.map-control-btn-enhanced.active {
    background: var(--primary-orange) !important;
    color: var(--white) !important;
    border-color: var(--primary-orange) !important;
}

.map-control-tooltip {
    position: absolute !important;
    right: 120% !important;
    top: 50% !important;
    transform: translateY(-50%) !important;
    background: var(--dark-gray) !important;
    color: var(--white) !important;
    padding: 6px 10px !important;
    border-radius: var(--element-radius) !important;
    font-size: 11px !important;
    font-weight: 500 !important;
    white-space: nowrap !important;
    opacity: 0 !important;
    pointer-events: none !important;
    transition: opacity var(--transition-speed) ease !important;
}

.map-control-btn-enhanced:hover .map-control-tooltip {
    opacity: 1 !important;
}

/* Enhanced Toast Notifications */
.toast-container-enhanced {
    position: fixed !important;
    top: 80px !important;
    right: var(--app-padding) !important;
    z-index: 10000 !important;
    display: flex !important;
    flex-direction: column !important;
    gap: 8px !important;
    max-width: 320px !important;
}

.toast-enhanced {
    background: var(--white) !important;
    border-radius: var(--element-radius) !important;
    padding: 14px !important;
    box-shadow: var(--shadow-heavy) !important;
    border-left: 4px solid var(--primary-orange) !important;
    display: flex !important;
    align-items: flex-start !important;
    gap: 10px !important;
    animation: slideInRight 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55) !important;
    transform: translateX(0) !important;
    transition: transform 0.3s ease, opacity 0.3s ease !important;
    opacity: 1 !important;
}

.toast-enhanced.hiding {
    transform: translateX(120%) !important;
    opacity: 0 !important;
}

.toast-enhanced.success {
    border-left-color: var(--success-green) !important;
}

.toast-enhanced.error {
    border-left-color: var(--error-red) !important;
}

.toast-enhanced.warning {
    border-left-color: var(--warning-yellow) !important;
}

.toast-enhanced.info {
    border-left-color: var(--info-blue) !important;
}

.toast-icon-enhanced {
    width: 20px !important;
    height: 20px !important;
    border-radius: 50% !important;
    background: var(--light-orange) !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    color: var(--primary-orange) !important;
    font-size: 10px !important;
    flex-shrink: 0 !important;
}

.toast-enhanced.success .toast-icon-enhanced {
    background: #E8F6EF !important;
    color: var(--success-green) !important;
}

.toast-enhanced.error .toast-icon-enhanced {
    background: var(--light-red) !important;
    color: var(--error-red) !important;
}

.toast-enhanced.warning .toast-icon-enhanced {
    background: #FFF3E0 !important;
    color: var(--warning-yellow) !important;
}

.toast-enhanced.info .toast-icon-enhanced {
    background: #E3F2FD !important;
    color: var(--info-blue) !important;
}

.toast-content-enhanced {
    flex: 1 !important;
    min-width: 0 !important;
}

.toast-title-enhanced {
    font-weight: 700 !important;
    font-size: 12px !important;
    color: var(--dark-gray) !important;
    margin-bottom: 3px !important;
}

.toast-message-enhanced {
    font-size: 11px !important;
    color: var(--text-gray) !important;
    line-height: 1.3 !important;
}

.toast-close-enhanced {
    background: none !important;
    border: none !important;
    color: var(--text-light) !important;
    font-size: 14px !important;
    cursor: pointer !important;
    padding: 2px !important;
    border-radius: 4px !important;
    transition: all var(--transition-speed) ease !important;
    flex-shrink: 0 !important;
}

.toast-close-enhanced:hover {
    color: var(--error-red) !important;
    background: var(--light-red) !important;
}

.toast-progress-bar {
    position: absolute !important;
    bottom: 0 !important;
    left: 0 !important;
    right: 0 !important;
    height: 3px !important;
    background: var(--light-gray) !important;
    border-radius: 0 0 var(--element-radius) var(--element-radius) !important;
    overflow: hidden !important;
}

.toast-progress {
    height: 100% !important;
    background: var(--primary-orange) !important;
    width: 100% !important;
    animation: progressBar linear forwards !important;
}

.toast-enhanced.success .toast-progress {
    background: var(--success-green) !important;
}

.toast-enhanced.error .toast-progress {
    background: var(--error-red) !important;
}

.toast-enhanced.warning .toast-progress {
    background: var(--warning-yellow) !important;
}

.toast-enhanced.info .toast-progress {
    background: var(--info-blue) !important;
}

@keyframes progressBar {
    from { width: 100%; }
    to { width: 0%; }
}

/* Enhanced Loading States */
.loading-overlay-enhanced {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    background: rgba(255, 255, 255, 0.95) !important;
    z-index: 10000 !important;
    display: none !important;
    flex-direction: column !important;
    align-items: center !important;
    justify-content: center !important;
    gap: 16px !important;
    backdrop-filter: blur(5px) !important;
}

.loading-overlay-enhanced.active {
    display: flex !important;
    animation: fadeIn 0.3s ease !important;
}

.loading-spinner-enhanced {
    width: 56px !important;
    height: 56px !important;
    border: 3px solid var(--light-gray) !important;
    border-radius: 50% !important;
    border-top-color: var(--primary-orange) !important;
    animation: spin 1s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite !important;
}

.loading-text-enhanced {
    font-size: 14px !important;
    font-weight: 600 !important;
    color: var(--dark-gray) !important;
    text-align: center !important;
}

.loading-subtext {
    font-size: 12px !important;
    color: var(--text-gray) !important;
    text-align: center !important;
    max-width: 250px !important;
    line-height: 1.4 !important;
}

/* Enhanced Ride Request Animation */
.ride-request-pulsing {
    animation: rideRequestPulse 2s infinite !important;
}

@keyframes rideRequestPulse {
    0% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(255, 107, 53, 0.7);
    }
    70% {
        transform: scale(1.05);
        box-shadow: 0 0 0 15px rgba(255, 107, 53, 0);
    }
    100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(255, 107, 53, 0);
    }
}

.ride-type-card.pulsing {
    animation: cardPulse 1.5s infinite !important;
}

@keyframes cardPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.02); }
    100% { transform: scale(1); }
}

/* Enhanced Driver Tracking */
.driver-tracking-container {
    background: var(--white) !important;
    border-radius: var(--element-radius) !important;
    padding: 12px !important;
    margin-bottom: 12px !important;
    box-shadow: var(--shadow-medium) !important;
    border: 1px solid var(--border-color) !important;
}

.driver-tracking-header {
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    margin-bottom: 10px !important;
}

.driver-tracking-title {
    font-weight: 700 !important;
    font-size: 12px !important;
    color: var(--dark-gray) !important;
    display: flex !important;
    align-items: center !important;
    gap: 6px !important;
}

.driver-tracking-distance {
    font-size: 13px !important;
    font-weight: 800 !important;
    color: var(--primary-orange) !important;
}

.driver-tracking-progress-container {
    height: 6px !important;
    background: var(--light-gray) !important;
    border-radius: 3px !important;
    overflow: hidden !important;
    margin-bottom: 8px !important;
    position: relative !important;
}

.driver-tracking-progress {
    height: 100% !important;
    background: linear-gradient(90deg, var(--primary-orange), var(--primary-red)) !important;
    border-radius: 3px !important;
    transition: width 0.5s ease !important;
    position: relative !important;
    overflow: hidden !important;
}

.driver-tracking-progress::after {
    content: '' !important;
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    background: linear-gradient(90deg, 
        transparent, 
        rgba(255, 255, 255, 0.4), 
        transparent
    ) !important;
    animation: shimmer 2s infinite !important;
}

@keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

.driver-tracking-details {
    display: flex !important;
    justify-content: space-between !important;
    font-size: 11px !important;
    color: var(--text-gray) !important;
}

.driver-tracking-eta {
    font-weight: 600 !important;
    color: var(--info-blue) !important;
}

/* Enhanced Chat Interface */
.chat-messages-enhanced {
    flex: 1 !important;
    padding: 12px !important;
    max-height: 250px !important;
    overflow-y: auto !important;
    background: var(--off-white) !important;
    display: flex !important;
    flex-direction: column !important;
    gap: 10px !important;
    scroll-behavior: smooth !important;
}

.message-enhanced {
    max-width: 80% !important;
    padding: 10px 14px !important;
    border-radius: 18px !important;
    font-size: 13px !important;
    line-height: 1.4 !important;
    position: relative !important;
    word-wrap: break-word !important;
    animation: messageSlide 0.3s ease !important;
}

@keyframes messageSlide {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.message-enhanced.sent {
    align-self: flex-end !important;
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-red)) !important;
    color: var(--white) !important;
    border-bottom-right-radius: 5px !important;
}

.message-enhanced.received {
    align-self: flex-start !important;
    background: var(--white) !important;
    color: var(--dark-gray) !important;
    border: 1px solid var(--border-color) !important;
    border-bottom-left-radius: 5px !important;
}

.message-sender {
    font-weight: 600 !important;
    font-size: 11px !important;
    margin-bottom: 3px !important;
    opacity: 0.8 !important;
}

.message-time-enhanced {
    font-size: 10px !important;
    color: rgba(255, 255, 255, 0.8) !important;
    margin-top: 4px !important;
    text-align: right !important;
}

.message-enhanced.received .message-time-enhanced {
    color: var(--text-light) !important;
}

.message-status {
    position: absolute !important;
    bottom: -12px !important;
    right: 5px !important;
    font-size: 10px !important;
    color: var(--text-light) !important;
}

.message-enhanced.sent .message-status {
    color: var(--primary-orange) !important;
}

.typing-indicator-enhanced {
    display: flex !important;
    align-items: center !important;
    gap: 4px !important;
    padding: 8px 12px !important;
    background: var(--white) !important;
    border-radius: 18px !important;
    align-self: flex-start !important;
    border: 1px solid var(--border-color) !important;
    animation: typingPulse 1.5s infinite !important;
}

@keyframes typingPulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

.typing-dots {
    display: flex !important;
    gap: 3px !important;
}

.typing-dot {
    width: 6px !important;
    height: 6px !important;
    background: var(--text-light) !important;
    border-radius: 50% !important;
    animation: typingDot 1.4s infinite !important;
}

.typing-dot:nth-child(1) { animation-delay: 0s; }
.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }

@keyframes typingDot {
    0%, 60%, 100% { transform: translateY(0); }
    30% { transform: translateY(-4px); }
}

/* Enhanced Notifications */
.notification-item-enhanced {
    padding: 14px !important;
    border-bottom: 1px solid var(--border-color) !important;
    cursor: pointer !important;
    transition: all var(--transition-speed) ease !important;
    position: relative !important;
}

.notification-item-enhanced:hover {
    background: var(--light-orange) !important;
    transform: translateX(2px) !important;
}

.notification-item-enhanced.unread {
    background: rgba(255, 107, 53, 0.05) !important;
    border-left: 3px solid var(--primary-orange) !important;
}

.notification-header-enhanced {
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    margin-bottom: 6px !important;
}

.notification-title-enhanced {
    font-weight: 700 !important;
    font-size: 12px !important;
    color: var(--dark-gray) !important;
    display: flex !important;
    align-items: center !important;
    gap: 6px !important;
}

.notification-time-enhanced {
    font-size: 10px !important;
    color: var(--text-light) !important;
}

.notification-message-enhanced {
    font-size: 11px !important;
    color: var(--text-gray) !important;
    line-height: 1.4 !important;
    margin-bottom: 6px !important;
}

.notification-actions-enhanced {
    display: flex !important;
    gap: 6px !important;
    margin-top: 8px !important;
}

.notification-action-btn-enhanced {
    padding: 5px 10px !important;
    font-size: 10px !important;
    border-radius: 12px !important;
    border: 1px solid var(--border-color) !important;
    background: var(--white) !important;
    cursor: pointer !important;
    transition: all var(--transition-speed) ease !important;
    font-weight: 600 !important;
}

.notification-action-btn-enhanced:hover {
    background: var(--primary-orange) !important;
    color: var(--white) !important;
    border-color: var(--primary-orange) !important;
    transform: translateY(-1px) !important;
}

.notification-unread-dot {
    position: absolute !important;
    top: 14px !important;
    left: -8px !important;
    width: 8px !important;
    height: 8px !important;
    background: var(--primary-orange) !important;
    border-radius: 50% !important;
    animation: pulse 2s infinite !important;
}

/* Enhanced Price Calculator */
.price-calculator-enhanced {
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-red)) !important;
    color: var(--white) !important;
    padding: 16px !important;
    border-radius: var(--element-radius) !important;
    margin: 16px 0 !important;
    box-shadow: var(--shadow-heavy) !important;
    animation: slideUp 0.3s ease !important;
}

.price-header {
    text-align: center !important;
    margin-bottom: 12px !important;
}

.price-label {
    font-size: 12px !important;
    opacity: 0.9 !important;
    margin-bottom: 2px !important;
}

.price-amount-enhanced {
    font-size: 28px !important;
    font-weight: 900 !important;
    margin: 4px 0 !important;
    letter-spacing: 0.5px !important;
}

.price-breakdown-enhanced {
    margin-top: 12px !important;
    padding-top: 12px !important;
    border-top: 1px solid rgba(255, 255, 255, 0.2) !important;
}

.price-row-enhanced {
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    padding: 6px 0 !important;
    font-size: 12px !important;
    opacity: 0.9 !important;
}

.price-row-enhanced:last-child {
    border-bottom: none !important;
}

.price-row-total {
    margin-top: 8px !important;
    padding-top: 8px !important;
    border-top: 2px solid rgba(255, 255, 255, 0.3) !important;
    font-weight: 700 !important;
    font-size: 14px !important;
    opacity: 1 !important;
}

.price-update {
    animation: priceUpdate 0.5s ease !important;
}

@keyframes priceUpdate {
    0% { transform: scale(1); }
    50% { transform: scale(1.02); }
    100% { transform: scale(1); }
}

/* Enhanced Emergency Services */
.emergency-service-enhanced {
    background: var(--white) !important;
    border: 2px solid transparent !important;
    border-radius: var(--element-radius) !important;
    padding: 16px !important;
    text-align: center !important;
    cursor: pointer !important;
    transition: all var(--transition-speed) ease !important;
    position: relative !important;
    overflow: hidden !important;
}

.emergency-service-enhanced::before {
    content: '' !important;
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    background: linear-gradient(135deg, transparent, rgba(255, 255, 255, 0.1), transparent) !important;
    transform: translateX(-100%) !important;
    transition: transform 0.6s ease !important;
}

.emergency-service-enhanced:hover::before {
    transform: translateX(100%) !important;
}

.emergency-service-enhanced:hover {
    transform: translateY(-4px) !important;
    box-shadow: var(--shadow-heavy) !important;
}

.emergency-service-enhanced.police {
    border-color: var(--police-blue) !important;
}

.emergency-service-enhanced.police:hover {
    background: linear-gradient(135deg, rgba(44, 62, 80, 0.1), rgba(44, 62, 80, 0.05)) !important;
}

.emergency-service-enhanced.fire {
    border-color: var(--fire-truck-red) !important;
}

.emergency-service-enhanced.fire:hover {
    background: linear-gradient(135deg, rgba(192, 57, 43, 0.1), rgba(192, 57, 43, 0.05)) !important;
}

.emergency-service-enhanced.medical {
    border-color: var(--ambulance-blue) !important;
}

.emergency-service-enhanced.medical:hover {
    background: linear-gradient(135deg, rgba(41, 128, 185, 0.1), rgba(41, 128, 185, 0.05)) !important;
}

.emergency-service-enhanced.sos {
    border-color: var(--error-red) !important;
}

.emergency-service-enhanced.sos:hover {
    background: linear-gradient(135deg, rgba(231, 76, 60, 0.1), rgba(231, 76, 60, 0.05)) !important;
}

.emergency-icon-enhanced {
    width: 56px !important;
    height: 56px !important;
    border-radius: 50% !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    font-size: 20px !important;
    margin: 0 auto 10px !important;
    color: var(--white) !important;
    position: relative !important;
    z-index: 1 !important;
    box-shadow: var(--shadow-medium) !important;
}

.emergency-service-enhanced.police .emergency-icon-enhanced {
    background: linear-gradient(135deg, var(--police-blue), #1a2530) !important;
}

.emergency-service-enhanced.fire .emergency-icon-enhanced {
    background: linear-gradient(135deg, var(--fire-truck-red), #922B21) !important;
}

.emergency-service-enhanced.medical .emergency-icon-enhanced {
    background: linear-gradient(135deg, var(--ambulance-blue), #1B4F72) !important;
}

.emergency-service-enhanced.sos .emergency-icon-enhanced {
    background: linear-gradient(135deg, var(--error-red), #C0392B) !important;
}

.emergency-name-enhanced {
    font-size: 14px !important;
    font-weight: 800 !important;
    color: var(--dark-gray) !important;
    margin-bottom: 6px !important;
    position: relative !important;
    z-index: 1 !important;
}

.emergency-description-enhanced {
    font-size: 12px !important;
    color: var(--text-gray) !important;
    line-height: 1.3 !important;
    position: relative !important;
    z-index: 1 !important;
}

/* Enhanced SOS Button */
.sos-button-enhanced {
    position: absolute !important;
    bottom: 160px !important;
    right: var(--app-padding) !important;
    z-index: 200 !important;
    width: 60px !important;
    height: 60px !important;
    background: linear-gradient(135deg, var(--error-red), #C0392B) !important;
    border-radius: 50% !important;
    display: none !important;
    align-items: center !important;
    justify-content: center !important;
    color: var(--white) !important;
    font-size: 16px !important;
    font-weight: 800 !important;
    box-shadow: 0 4px 20px rgba(231, 76, 60, 0.4) !important;
    cursor: pointer !important;
    transition: all var(--transition-speed) ease !important;
    animation: sosPulseEnhanced 2s infinite !important;
    border: 3px solid var(--white) !important;
}

.sos-button-enhanced.active {
    display: flex !important;
    animation: sosEmergency 1s infinite !important;
}

.sos-button-enhanced:hover {
    transform: scale(1.1) !important;
    box-shadow: 0 6px 25px rgba(231, 76, 60, 0.6) !important;
}

@keyframes sosPulseEnhanced {
    0%, 100% { 
        transform: scale(1);
        box-shadow: 0 4px 20px rgba(231, 76, 60, 0.4);
    }
    50% { 
        transform: scale(1.08);
        box-shadow: 0 6px 25px rgba(231, 76, 60, 0.6);
    }
}

@keyframes sosEmergency {
    0%, 100% { 
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7);
    }
    50% { 
        transform: scale(1.1);
        box-shadow: 0 0 0 20px rgba(231, 76, 60, 0);
    }
}

/* Enhanced Broadcast Feature */
.broadcast-feature-enhanced {
    background: var(--white) !important;
    border-radius: var(--element-radius) !important;
    padding: 16px !important;
    margin: 16px 0 !important;
    box-shadow: var(--shadow-heavy) !important;
    border: 2px solid var(--info-blue) !important;
    animation: slideUp 0.3s ease !important;
}

.broadcast-header-enhanced {
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important;
    margin-bottom: 12px !important;
}

.broadcast-title-enhanced {
    font-size: 14px !important;
    font-weight: 800 !important;
    color: var(--dark-gray) !important;
    display: flex !important;
    align-items: center !important;
    gap: 8px !important;
}

.broadcast-status-indicator-enhanced {
    width: 8px !important;
    height: 8px !important;
    border-radius: 50% !important;
    background: var(--success-green) !important;
    animation: broadcastPulse 1.5s infinite !important;
}

.broadcast-status-indicator-enhanced.inactive {
    background: var(--text-light) !important;
    animation: none !important;
}

@keyframes broadcastPulse {
    0% { 
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7);
    }
    70% { 
        transform: scale(1.2);
        box-shadow: 0 0 0 8px rgba(46, 204, 113, 0);
    }
    100% { 
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(46, 204, 113, 0);
    }
}

.broadcast-recipients-enhanced {
    max-height: 150px !important;
    overflow-y: auto !important;
    margin-bottom: 12px !important;
    border: 1px solid var(--border-color) !important;
    border-radius: var(--element-radius) !important;
    padding: 8px !important;
}

.broadcast-recipient-enhanced {
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important;
    padding: 10px !important;
    border-radius: var(--element-radius) !important;
    margin-bottom: 6px !important;
    background: var(--off-white) !important;
    transition: all var(--transition-speed) ease !important;
}

.broadcast-recipient-enhanced:hover {
    background: var(--light-orange) !important;
    transform: translateX(2px) !important;
}

.broadcast-recipient-enhanced:last-child {
    margin-bottom: 0 !important;
}

.recipient-info-enhanced {
    display: flex !important;
    align-items: center !important;
    gap: 10px !important;
}

.recipient-avatar-enhanced {
    width: 36px !important;
    height: 36px !important;
    border-radius: 50% !important;
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-red)) !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    color: var(--white) !important;
    font-weight: 700 !important;
    font-size: 14px !important;
    box-shadow: var(--shadow-light) !important;
}

.recipient-name-enhanced {
    font-weight: 700 !important;
    font-size: 13px !important;
    color: var(--dark-gray) !important;
}

.recipient-status-enhanced {
    font-size: 11px !important;
    padding: 4px 8px !important;
    border-radius: 12px !important;
    font-weight: 600 !important;
    text-transform: uppercase !important;
    letter-spacing: 0.5px !important;
}

.status-joined-enhanced {
    background: #E8F6EF !important;
    color: var(--success-green) !important;
}

.status-pending-enhanced {
    background: #FFF3E0 !important;
    color: var(--warning-yellow) !important;
    animation: statusPulse 2s infinite !important;
}

@keyframes statusPulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

/* Enhanced Ride Timeline */
.ride-timeline-enhanced {
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important;
    margin: 20px 0 !important;
    padding: 0 20px !important;
    position: relative !important;
}

.ride-timeline-enhanced::before {
    content: '' !important;
    position: absolute !important;
    top: 15px !important;
    left: 10% !important;
    right: 10% !important;
    height: 3px !important;
    background: var(--border-color) !important;
    z-index: 1 !important;
    border-radius: 2px !important;
}

.timeline-step-enhanced {
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    gap: 6px !important;
    position: relative !important;
    z-index: 2 !important;
    flex: 1 !important;
}

.step-dot-enhanced {
    width: 28px !important;
    height: 28px !important;
    border-radius: 50% !important;
    background: var(--light-gray) !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    color: var(--text-light) !important;
    font-size: 11px !important;
    border: 3px solid var(--white) !important;
    transition: all var(--transition-speed) ease !important;
    position: relative !important;
    box-shadow: var(--shadow-light) !important;
}

.step-dot-enhanced.active {
    background: var(--primary-orange) !important;
    color: var(--white) !important;
    transform: scale(1.2) !important;
    box-shadow: 0 4px 12px rgba(255, 107, 53, 0.4) !important;
}

.step-dot-enhanced.completed {
    background: var(--success-green) !important;
    color: var(--white) !important;
    transform: scale(1.1) !important;
}

.step-dot-enhanced.active::after {
    content: '' !important;
    position: absolute !important;
    top: -4px !important;
    left: -4px !important;
    right: -4px !important;
    bottom: -4px !important;
    border: 2px solid var(--primary-orange) !important;
    border-radius: 50% !important;
    animation: ripple 1.5s infinite !important;
}

@keyframes ripple {
    0% {
        transform: scale(1);
        opacity: 1;
    }
    100% {
        transform: scale(1.5);
        opacity: 0;
    }
}

.step-label-enhanced {
    font-size: 11px !important;
    color: var(--text-light) !important;
    text-align: center !important;
    font-weight: 500 !important;
    max-width: 60px !important;
    line-height: 1.2 !important;
}

.step-label-enhanced.active {
    color: var(--primary-orange) !important;
    font-weight: 700 !important;
}

/* Enhanced Map Markers */
.marker-pulse {
    position: relative !important;
}

.marker-pulse::before {
    content: '' !important;
    position: absolute !important;
    width: 100% !important;
    height: 100% !important;
    border-radius: 50% !important;
    background: inherit !important;
    animation: markerPulse 2s infinite !important;
    z-index: -1 !important;
}

@keyframes markerPulse {
    0% {
        transform: scale(1);
        opacity: 0.8;
    }
    100% {
        transform: scale(2);
        opacity: 0;
    }
}

.driver-marker-enhanced {
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-red)) !important;
    color: white !important;
    border-radius: 50% !important;
    width: 36px !important;
    height: 36px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    font-size: 14px !important;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3) !important;
    border: 3px solid white !important;
    animation: driverMove 3s infinite alternate !important;
}

@keyframes driverMove {
    0% {
        transform: translateY(0) rotate(0deg);
    }
    100% {
        transform: translateY(-5px) rotate(5deg);
    }
}

/* Enhanced Button Styles */
.btn-pulsing {
    animation: btnPulse 2s infinite !important;
}

@keyframes btnPulse {
    0%, 100% {
        transform: scale(1);
        box-shadow: 0 2px 8px rgba(255, 107, 53, 0.3);
    }
    50% {
        transform: scale(1.02);
        box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4);
    }
}

.btn-shimmer {
    position: relative !important;
    overflow: hidden !important;
}

.btn-shimmer::after {
    content: '' !important;
    position: absolute !important;
    top: -50% !important;
    left: -60% !important;
    width: 20% !important;
    height: 200% !important;
    background: linear-gradient(
        to right,
        transparent,
        rgba(255, 255, 255, 0.4),
        transparent
    ) !important;
    transform: rotate(30deg) !important;
    transition: left 0.7s ease !important;
}

.btn-shimmer:hover::after {
    left: 140% !important;
}

/* Enhanced Scrollbars */
.enhanced-scrollbar {
    scrollbar-width: thin !important;
    scrollbar-color: var(--primary-orange) var(--light-gray) !important;
}

.enhanced-scrollbar::-webkit-scrollbar {
    width: 6px !important;
    height: 6px !important;
}

.enhanced-scrollbar::-webkit-scrollbar-track {
    background: var(--light-gray) !important;
    border-radius: 3px !important;
}

.enhanced-scrollbar::-webkit-scrollbar-thumb {
    background: var(--primary-orange) !important;
    border-radius: 3px !important;
}

.enhanced-scrollbar::-webkit-scrollbar-thumb:hover {
    background: var(--secondary-orange) !important;
}

/* Enhanced Form Elements */
.form-control-enhanced {
    border: 2px solid var(--border-color) !important;
    border-radius: var(--element-radius) !important;
    padding: 12px !important;
    font-size: 13px !important;
    color: var(--dark-gray) !important;
    background: var(--white) !important;
    transition: all var(--transition-speed) ease !important;
    width: 100% !important;
}

.form-control-enhanced:focus {
    outline: none !important;
    border-color: var(--primary-orange) !important;
    box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1) !important;
    transform: translateY(-1px) !important;
}

.form-control-enhanced.error {
    border-color: var(--error-red) !important;
    animation: shake 0.5s ease !important;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
}

/* Enhanced Card Hover Effects */
.card-hover {
    transition: all var(--transition-speed) ease !important;
}

.card-hover:hover {
    transform: translateY(-4px) !important;
    box-shadow: var(--shadow-heavy) !important;
}

.card-hover-lift {
    transition: transform var(--transition-speed) ease, box-shadow var(--transition-speed) ease !important;
}

.card-hover-lift:hover {
    transform: translateY(-6px) scale(1.01) !important;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15) !important;
}

/* Enhanced Selection States */
.selection-glow {
    transition: all var(--transition-speed) ease !important;
}

.selection-glow.selected {
    box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.3), var(--shadow-medium) !important;
    animation: selectionPulse 2s infinite !important;
}

@keyframes selectionPulse {
    0%, 100% {
        box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.3), var(--shadow-medium);
    }
    50% {
        box-shadow: 0 0 0 6px rgba(255, 107, 53, 0.1), var(--shadow-medium);
    }
}

/* Enhanced Background Patterns */
.bg-pattern-orange {
    background-image: 
        radial-gradient(circle at 25% 25%, rgba(255, 107, 53, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 75% 75%, rgba(231, 76, 60, 0.1) 0%, transparent 50%) !important;
}

.bg-pattern-grid {
    background-image: 
        linear-gradient(rgba(255, 107, 53, 0.1) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255, 107, 53, 0.1) 1px, transparent 1px) !important;
    background-size: 20px 20px !important;
}

/* Enhanced Text Effects */
.text-gradient-orange {
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-red)) !important;
    -webkit-background-clip: text !important;
    -webkit-text-fill-color: transparent !important;
    background-clip: text !important;
}

.text-shadow-light {
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1) !important;
}

/* Enhanced Responsive Design */
@media (max-width: 768px) {
    .search-results-dropdown {
        max-height: 250px !important;
    }
    
    .search-result-item {
        padding: 10px 12px !important;
    }
    
    .map-controls-enhanced {
        top: 120px !important;
        right: 8px !important;
    }
    
    .toast-container-enhanced {
        max-width: 280px !important;
        right: 8px !important;
    }
    
    .emergency-service-enhanced {
        padding: 14px !important;
    }
    
    .emergency-icon-enhanced {
        width: 48px !important;
        height: 48px !important;
        font-size: 18px !important;
    }
    
    .sos-button-enhanced {
        width: 56px !important;
        height: 56px !important;
        bottom: 140px !important;
        right: 8px !important;
    }
}

@media (max-width: 480px) {
    .search-results-dropdown {
        max-height: 200px !important;
    }
    
    .search-result-item {
        padding: 8px 10px !important;
        gap: 8px !important;
    }
    
    .search-result-icon {
        width: 28px !important;
        height: 28px !important;
        font-size: 12px !important;
    }
    
    .search-result-title {
        font-size: 12px !important;
    }
    
    .map-controls-enhanced {
        top: 140px !important;
    }
    
    .map-control-btn-enhanced {
        width: 36px !important;
        height: 36px !important;
    }
    
    .toast-container-enhanced {
        max-width: 240px !important;
    }
    
    .toast-enhanced {
        padding: 12px !important;
    }
}

/* Print Styles */
@media print {
    .search-results-dropdown,
    .map-controls-enhanced,
    .sos-button-enhanced,
    .toast-container-enhanced {
        display: none !important;
    }
}

/* High Contrast Mode Support */
@media (prefers-contrast: high) {
    .search-result-item:hover {
        outline: 2px solid var(--primary-orange) !important;
    }
    
    .map-control-btn-enhanced {
        border: 2px solid var(--dark-gray) !important;
    }
    
    .toast-enhanced {
        border: 2px solid currentColor !important;
    }
}

/* Reduced Motion Support */
@media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
    
    .search-results-dropdown {
        animation: none !important;
    }
    
    .toast-enhanced {
        animation: none !important;
    }
    
    .driver-tracking-progress::after {
        animation: none !important;
    }
    
    .sos-button-enhanced,
    .step-dot-enhanced.active::after,
    .broadcast-status-indicator-enhanced,
    .notification-unread-dot {
        animation: none !important;
    }
}

/* Dark Mode Support (Optional) */
@media (prefers-color-scheme: dark) {
    .search-results-dropdown {
        background: #2c3e50 !important;
        border-color: #34495e !important;
    }
    
    .search-result-item {
        background: #2c3e50 !important;
        border-color: #34495e !important;
    }
    
    .search-result-item:hover {
        background: #34495e !important;
    }
    
    .search-result-title {
        color: #ecf0f1 !important;
    }
    
    .search-result-address {
        color: #bdc3c7 !important;
    }
    /* Payment Modal Styles */
.payment-modal .modal-content {
    padding: 16px;
}

.payment-summary {
    background: var(--off-white);
    border-radius: var(--element-radius);
    padding: 14px;
    margin-bottom: 16px;
    text-align: center;
}

.payment-total {
    font-size: 24px;
    font-weight: 800;
    color: var(--primary-orange);
    margin: 8px 0;
}

.payment-method-options {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 16px;
}

.payment-method-option {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    border: 2px solid var(--border-color);
    border-radius: var(--element-radius);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    background: var(--white);
}

.payment-method-option:hover {
    border-color: var(--primary-orange);
    background: var(--light-orange);
    transform: translateY(-2px);
}

.payment-method-option.selected {
    border-color: var(--primary-orange);
    background: var(--light-orange);
    box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
}

.payment-method-icon {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    background: var(--light-orange);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary-orange);
    font-size: 16px;
}

.payment-method-details {
    flex: 1;
    text-align: left;
}

.payment-method-title {
    font-weight: 600;
    font-size: 13px;
    color: var(--dark-gray);
    margin-bottom: 2px;
}

.payment-method-description {
    font-size: 11px;
    color: var(--text-gray);
}

.payment-balance {
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
    color: var(--white);
    padding: 12px;
    border-radius: var(--element-radius);
    margin-bottom: 16px;
    text-align: center;
}

.payment-balance-label {
    font-size: 12px;
    opacity: 0.9;
    margin-bottom: 4px;
}

.payment-balance-amount {
    font-size: 20px;
    font-weight: 800;
}

.payment-actions {
    display: flex;
    gap: 8px;
    margin-top: 16px;
}

.payment-actions .btn {
    flex: 1;
}

.payment-promo-section {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid var(--border-color);
}

.promo-input-group {
    display: flex;
    gap: 8px;
    margin-top: 8px;
}

.promo-input {
    flex: 1;
    padding: 10px;
    border: 2px solid var(--border-color);
    border-radius: var(--element-radius);
    font-size: 12px;
    outline: none;
    transition: all var(--transition-speed) ease;
}

.promo-input:focus {
    border-color: var(--primary-orange);
}

.promo-btn {
    padding: 10px 16px;
    background: var(--primary-orange);
    color: var(--white);
    border: none;
    border-radius: var(--element-radius);
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-speed) ease;
}

.promo-btn:hover {
    background: var(--secondary-orange);
}

.promo-success {
    color: var(--success-green);
    font-size: 12px;
    margin-top: 6px;
    display: flex;
    align-items: center;
    gap: 5px;
}

.payment-error {
    background: var(--light-red);
    border-radius: var(--element-radius);
    padding: 12px;
    margin-top: 12px;
    border-left: 3px solid var(--error-red);
    display: none;
}

.payment-error.active {
    display: block;
    animation: fadeIn 0.3s ease;
}

.payment-processing {
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 30px 20px;
    text-align: center;
}

.payment-processing.active {
    display: flex;
}

.payment-processing-spinner {
    width: 50px;
    height: 50px;
    border: 3px solid var(--light-gray);
    border-radius: 50%;
    border-top-color: var(--primary-orange);
    animation: spin 1s linear infinite;
    margin-bottom: 16px;
}

.payment-processing-message {
    font-size: 14px;
    font-weight: 600;
    color: var(--dark-gray);
    margin-bottom: 8px;
}

.payment-processing-details {
    font-size: 12px;
    color: var(--text-gray);
}

/* Ensure payment modal displays over everything */
#paymentModal .modal-overlay {
    z-index: 10000 !important;
}

#paymentModal .modal {
    z-index: 10001 !important;
    position: fixed !important;
    top: 50% !important;
    left: 50% !important;
    transform: translate(-50%, -50%) !important;
    max-height: 90vh !important;
    overflow-y: auto !important;
}

/* Payment confirmation animation */
@keyframes paymentSuccess {
    0% { transform: scale(0.8); opacity: 0; }
    70% { transform: scale(1.05); opacity: 1; }
    100% { transform: scale(1); opacity: 1; }
}

.payment-success {
    animation: paymentSuccess 0.5s ease;
}

/* Responsive adjustments for payment modal */
@media (max-width: 768px) {
    .payment-actions {
        flex-direction: column;
    }
    
    .payment-method-option {
        padding: 10px;
    }
    
    .payment-total {
        font-size: 22px;
    }
}

@media (max-width: 480px) {
    .payment-modal .modal {
        width: 95vw;
        max-width: 95vw;
    }
    
    .promo-input-group {
        flex-direction: column;
    }
}
    </style>
</head>
<body>
    <!-- Map Container -->
    <div id="map">
        <div class="map-loading-overlay" id="mapLoadingOverlay">
            <div class="loading-spinner"></div>
            <div class="map-loading-text">Loading map...</div>
        </div>
    </div>
    
    <!-- Top Navigation Bar -->
    <div class="top-bar">
        <div class="logo-container">
            <div class="logo-icon">
                <img src="jubel.png" alt="Jubel Logo" id="jubelLogo">
            </div>
            <div class="logo-text" id="userFullName">Loading...</div>
        </div>
        
        <div class="user-actions">
            <div class="balance-badge" id="balanceBadge">
                <i class="fas fa-wallet"></i>
                <span>Balance: <span class="balance-amount" id="walletBalance">ZMW 0.00</span></span>
            </div>
            <div class="notification-bell" id="notificationBell">
                <i class="fas fa-bell"></i>
                <span class="notification-badge" id="notificationCount">0</span>
            </div>
        </div>
    </div>
    
    <!-- City Detection Indicator -->
    <div class="city-detection" id="cityDetection">
        <i class="fas fa-map-marker-alt"></i>
        <span id="currentCityDisplay">Detecting your city...</span>
    </div>
    
    <!-- Ride Status Bar -->
    <div class="ride-status-bar" id="rideStatusBar">
        <div class="status-indicator">
            <div class="status-dot searching" id="statusDot"></div>
            <span class="status-text" id="statusText">Searching for driver</span>
        </div>
        <div class="status-eta">
            <i class="fas fa-clock"></i>
            <span id="etaText">5 min</span>
        </div>
    </div>
    
    <!-- Emergency Status -->
    <div class="emergency-status" id="emergencyStatus">
        <i class="fas fa-exclamation-triangle"></i>
        <span>EMERGENCY RIDE IN PROGRESS</span>
    </div>
    
    <!-- SOS Button -->
    <div class="sos-button" id="sosButton">
        <i class="fas fa-exclamation-triangle"></i>
    </div>
    
    <!-- Map Controls -->
    <div class="map-controls">
        <button class="map-control-btn" id="locateMeBtn" title="Locate Me">
            <i class="fas fa-location-arrow"></i>
        </button>
        <button class="map-control-btn" id="zoomInBtn" title="Zoom In">
            <i class="fas fa-plus"></i>
        </button>
        <button class="map-control-btn" id="zoomOutBtn" title="Zoom Out">
            <i class="fas fa-minus"></i>
        </button>
        <button class="map-control-btn" id="clearRouteBtn" title="Clear Route">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <!-- Chat Container -->
    <div class="chat-container" id="chatContainer">
        <div class="chat-header">
            <div class="chat-title">Chat with Driver</div>
            <button class="chat-close" id="chatClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <!-- Messages will be inserted here -->
        </div>
        <div class="chat-typing-indicator" id="typingIndicator">
            Driver is typing...
        </div>
        <div class="chat-input-container">
            <button class="chat-attachment-btn" id="attachmentBtn">
                <i class="fas fa-paperclip"></i>
            </button>
            <input type="text" class="chat-input" id="chatInput" placeholder="Type your message...">
            <button class="chat-send-btn" id="chatSend">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
    
    <!-- Notifications Panel -->
    <div class="notifications-panel" id="notificationsPanel">
        <div class="notifications-header">
            <div class="notifications-title">Notifications</div>
            <button class="notifications-close" id="notificationsClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="notifications-list" id="notificationsList">
            <!-- Notifications will be inserted here -->
        </div>
    </div>
    
    <!-- Dropdown Menu -->
    <div class="dropdown-menu" id="dropdownMenu">
        <div class="dropdown-item" data-action="profile">
            <i class="fas fa-user"></i>
            <span>Profile</span>
        </div>
        <div class="dropdown-item" data-action="settings">
            <i class="fas fa-cog"></i>
            <span>Settings</span>
        </div>
        <div class="dropdown-item" data-action="help">
            <i class="fas fa-question-circle"></i>
            <span>Help & Support</span>
        </div>
        <div class="dropdown-item" data-action="logout">
            <i class="fas fa-sign-out-alt"></i>
            <span>Logout</span>
        </div>
    </div>
    
    <!-- More Options Menu -->
    <div class="more-options-menu" id="moreOptionsMenu">
        <div class="dropdown-item" data-option="schedule">
            <i class="fas fa-calendar-alt"></i>
            <span>Schedule Ride</span>
        </div>
        <div class="dropdown-item" data-option="orderForSomeone">
            <i class="fas fa-user-friends"></i>
            <span>Order for Someone</span>
        </div>
        <div class="dropdown-item" data-option="shareRide">
            <i class="fas fa-share-alt"></i>
            <span>Share Ride</span>
        </div>
        <div class="dropdown-item" data-option="broadcast">
            <i class="fas fa-broadcast-tower"></i>
            <span>Broadcast Ride</span>
        </div>
    </div>
    
    <!-- Main Panel -->
    <div class="main-panel" id="mainPanel">
        <div class="panel-handle" id="panelHandle"></div>
        
        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" data-screen="home">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </button>
            <button class="nav-tab" data-screen="history">
                <i class="fas fa-history"></i>
                <span>History</span>
            </button>
            <button class="nav-tab" data-screen="account">
                <i class="fas fa-user"></i>
                <span>Account</span>
            </button>
            <button class="nav-tab" data-screen="emergency">
                <i class="fas fa-ambulance"></i>
                <span>Emergency</span>
            </button>
        </div>
        
        <!-- Home Screen Content -->
        <div id="homeContent">
            <!-- Service Tabs -->
            <div class="service-tabs" id="serviceTabs">
                <div class="service-tab car active" data-service="car">
                    <div class="service-icon">
                        <i class="fas fa-car"></i>
                    </div>
                    <div class="service-name">Car</div>
                    <div class="service-desc">Ride anywhere</div>
                </div>
                
                <div class="service-tab delivery" data-service="delivery">
                    <div class="service-icon">
                        <i class="fas fa-shipping-fast"></i>
                    </div>
                    <div class="service-name">Delivery</div>
                    <div class="service-desc">Send packages</div>
                </div>
                
                <div class="service-tab short-delivery" data-service="short-delivery">
                    <div class="service-icon">
                        <i class="fas fa-bicycle"></i>
                    </div>
                    <div class="service-name">Short Delivery</div>
                    <div class="service-desc">Quick deliveries</div>
                </div>
                
                <div class="service-tab" data-service="express">
                    <div class="service-icon">
                        <i class="fas fa-shopping-bag"></i>
                    </div>
                    <div class="service-name">Express Shopping</div>
                    <div class="service-desc">Shop for you</div>
                </div>
                
                <div class="service-tab" data-service="truck">
                    <div class="service-icon">
                        <i class="fas fa-truck"></i>
                    </div>
                    <div class="service-name">Truck</div>
                    <div class="service-desc">Move items</div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="quick-actions">
                <button class="quick-action-btn" id="moreOptionsBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-ellipsis-h"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">More Options</div>
                        <div class="quick-action-desc">Schedule, share, broadcast</div>
                    </div>
                </button>
                <button class="quick-action-btn" id="broadcastRideBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-broadcast-tower"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">Broadcast Ride</div>
                        <div class="quick-action-desc">Share with friends</div>
                    </div>
                </button>
                <button class="quick-action-btn" id="sosSetupBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">SOS Setup</div>
                        <div class="quick-action-desc">Emergency contacts</div>
                    </div>
                </button>
                <button class="quick-action-btn" id="recentDestinationsBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-history"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">Recent Destinations</div>
                        <div class="quick-action-desc">Quick access</div>
                    </div>
                </button>
            </div>
            
            <!-- Car Service Form (Default) -->
            <div class="ride-request-form active" id="carForm">
                <div class="form-title">
                    <i class="fas fa-car"></i>
                    Book a Ride
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="pickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="pickupLocation" placeholder="Current location" readonly>
                        <div class="search-loading" id="searchLoading"></div>
                        <div class="suggestion-list" id="pickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="destinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="destinationLocation" placeholder="Where to?" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="destinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Stops Container -->
                <div id="stopsContainer" style="margin: 10px 0;"></div>
                <button type="button" class="btn btn-secondary" id="addStopBtn" style="width: 100%; margin-bottom: 15px;">
                    <i class="fas fa-plus"></i> Add Stop
                </button>
                
                <!-- Search History -->
                <div class="search-history" id="searchHistory" style="display: none;"></div>
                
                <!-- Ride Type Selection -->
                <div class="ride-type-selection" id="rideTypeSelection">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                        <span id="rideTypeInfo" style="font-size: 11px; color: var(--text-light); cursor: pointer;">
                            <i class="fas fa-info-circle"></i>
                        </span>
                    </div>
                    
                    <!-- Ride Type Cards will be inserted here by JavaScript -->
                    <div class="ride-type-cards" id="rideTypeCardsContainer"></div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="fareDisplay">
                    <div class="fare-label">Estimated Fare</div>
                    <div class="fare-amount" id="estimatedFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="distanceDetail">0 km</span>
                        <span id="timeDetail">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Price Calculator Display -->
                <div class="price-calculator-display" id="priceCalculator" style="display: none;">
                    <div class="fare-label">Fare Breakdown</div>
                    <div class="fare-amount" id="calculatedFare">ZMW 0.00</div>
                    <div class="price-breakdown" id="priceBreakdown">
                        <!-- Breakdown will be inserted here -->
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestRideBtn">
                        <i class="fas fa-search"></i>
                        Request Ride
                    </button>
                </div>
            </div>
            
            <!-- Delivery Service Form -->
            <div class="service-form delivery-form" id="deliveryForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-shipping-fast"></i>
                    Package Delivery
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="deliveryPickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="deliveryPickup" placeholder="Pickup location" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="deliveryPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="deliveryDestinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="deliveryDestination" placeholder="Delivery address" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="deliveryDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Delivery Details -->
                <div class="form-group">
                    <label class="form-label">Parcel Description</label>
                    <input type="text" class="form-control" id="parcelDescription" placeholder="What are you sending?">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Receiver's Details</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="receiverName" placeholder="Receiver name">
                        <input type="tel" class="form-control" id="receiverPhone" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Parcel Value (ZMW)</label>
                    <input type="number" class="form-control" id="parcelValue" placeholder="Value of parcel" min="0" step="0.01">
                </div>
                
                <!-- Delivery Options -->
                <div class="form-group">
                    <label class="form-label">Delivery Type</label>
                    <div style="display: flex; gap: 10px;">
                        <button class="filter-btn active" id="standardDelivery">Standard</button>
                        <button class="filter-btn" id="expressDelivery">Express</button>
                        <button class="filter-btn" id="sameDayDelivery">Same Day</button>
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="deliveryFareDisplay" style="display: none;">
                    <div class="fare-label">Delivery Fare</div>
                    <div class="fare-amount" id="deliveryFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="deliveryDistance">0 km</span>
                        <span id="deliveryTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestDeliveryBtn">
                        <i class="fas fa-shipping-fast"></i>
                        Request Delivery
                    </button>
                </div>
            </div>
            
            <!-- Short Delivery Form -->
            <div class="service-form delivery-form" id="shortDeliveryForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-bicycle"></i>
                    Short Delivery
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="shortDeliveryPickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="shortDeliveryPickup" placeholder="Pickup location" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shortDeliveryPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="shortDeliveryDestinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="shortDeliveryDestination" placeholder="Delivery address" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shortDeliveryDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Delivery Details -->
                <div class="form-group">
                    <label class="form-label">What are you sending?</label>
                    <input type="text" class="form-control" id="shortParcelDescription" placeholder="Food, documents, small items...">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Receiver's Phone</label>
                    <input type="tel" class="form-control" id="shortReceiverPhone" placeholder="Receiver phone number">
                </div>
                
                <!-- Quick Options -->
                <div class="form-group">
                    <label class="form-label">Quick Options</label>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <span class="filter-btn">Food</span>
                        <span class="filter-btn">Documents</span>
                        <span class="filter-btn">Medication</span>
                        <span class="filter-btn">Small Package</span>
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="shortDeliveryFareDisplay" style="display: none;">
                    <div class="fare-label">Delivery Fare</div>
                    <div class="fare-amount" id="shortDeliveryFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="shortDeliveryDistance">0 km</span>
                        <span id="shortDeliveryTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestShortDeliveryBtn">
                        <i class="fas fa-bolt"></i>
                        Quick Delivery
                    </button>
                </div>
            </div>
            
            <!-- Express Shopping Form -->
            <div class="service-form express-form" id="expressForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-shopping-bag"></i>
                    Express Shopping
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="shopNameInput">
                        <i class="fas fa-store"></i>
                        <input type="text" id="shopName" placeholder="Shop/Restaurant name" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shopSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="shopLocation" placeholder="Shop location" readonly>
                    </div>
                </div>
                
                <!-- Items List -->
                <div class="form-group">
                    <label class="form-label">Shopping List</label>
                    <div class="item-list" id="shoppingItems">
                        <div class="item-entry">
                            <input type="text" class="item-input" placeholder="Item name">
                            <button class="remove-item" type="button">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <button class="add-item" type="button" id="addItemBtn">
                        <i class="fas fa-plus"></i>
                        Add Item
                    </button>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Special Instructions</label>
                    <textarea class="form-control form-textarea" id="shoppingInstructions" placeholder="Any specific requests or instructions..."></textarea>
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="shoppingDestinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="shoppingDestination" placeholder="Delivery address" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shoppingDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Budget -->
                <div class="form-group">
                    <label class="form-label">Estimated Budget (ZMW)</label>
                    <input type="number" class="form-control" id="shoppingBudget" placeholder="Estimated cost of items">
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="shoppingFareDisplay" style="display: none;">
                    <div class="fare-label">Shopping Service Fare</div>
                    <div class="fare-amount" id="shoppingFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="shoppingDistance">0 km</span>
                        <span id="shoppingTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestShoppingBtn">
                        <i class="fas fa-shopping-cart"></i>
                        Request Shopping
                    </button>
                </div>
            </div>
            
            <!-- Truck Delivery Form -->
            <div class="service-form truck-form" id="truckForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-truck"></i>
                    Truck Delivery
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="truckPickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="truckPickup" placeholder="Pickup location (Current location)" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="truckPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="truckDestinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="truckDestination" placeholder="Destination" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="truckDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Truck Type Selection -->
                <div class="form-group">
                    <label class="form-label">Select Truck Type</label>
                    <div class="truck-types">
                        <div class="truck-type" data-type="pickup">
                            <div class="truck-icon">
                                <i class="fas fa-truck-pickup"></i>
                            </div>
                            <div class="truck-name">Pickup Truck</div>
                            <div class="truck-capacity">Up to 1.5 tons</div>
                        </div>
                        
                        <div class="truck-type selected" data-type="light">
                            <div class="truck-icon">
                                <i class="fas fa-truck-moving"></i>
                            </div>
                            <div class="truck-name">Light Truck</div>
                            <div class="truck-capacity">Up to 3 tons</div>
                        </div>
                        
                        <div class="truck-type" data-type="medium">
                            <div class="truck-icon">
                                <i class="fas fa-truck"></i>
                            </div>
                            <div class="truck-name">Medium Truck</div>
                            <div class="truck-capacity">Up to 7 tons</div>
                        </div>
                        
                        <div class="truck-type" data-type="heavy">
                            <div class="truck-icon">
                                <i class="fas fa-truck-loading"></i>
                            </div>
                            <div class="truck-name">Heavy Truck</div>
                            <div class="truck-capacity">Up to 15 tons</div>
                        </div>
                    </div>
                </div>
                
                <!-- Item Details -->
                <div class="form-group">
                    <label class="form-label">What are you moving?</label>
                    <input type="text" class="form-control" id="truckItemDescription" placeholder="Furniture, boxes, equipment...">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Estimated Weight (kg)</label>
                    <input type="number" class="form-control" id="estimatedWeight" placeholder="Approximate weight">
                </div>
                
                <!-- Additional Help -->
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="needHelpers">
                        <span style="margin-left: 8px;">Need loading/unloading helpers (+ZMW 50)</span>
                    </label>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="truckFareDisplay" style="display: none;">
                    <div class="fare-label">Truck Fare</div>
                    <div class="fare-amount" id="truckFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="truckDistance">0 km</span>
                        <span id="truckTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestTruckBtn">
                        <i class="fas fa-truck"></i>
                        Request Truck
                    </button>
                </div>
            </div>
            
            <!-- Ride Info Panel -->
            <div class="ride-info-panel" id="rideInfoPanel" style="display: none;">
                <div class="driver-info">
                    <div class="driver-avatar" id="driverAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="driver-details">
                        <div class="driver-name" id="driverName">Driver Name</div>
                        <div class="driver-rating">
                            <i class="fas fa-star"></i>
                            <span id="driverRating">4.8</span>
                        </div>
                        <div class="driver-vehicle">
                            <i class="fas fa-car"></i>
                            <span id="vehicleDetails">Toyota Corolla - ABC 123</span>
                        </div>
                    </div>
                </div>
                
                <!-- Driver Media Display -->
                <div class="driver-media" id="driverMedia">
                    <div class="media-container">
                        <div class="media-placeholder" id="driverImagePlaceholder">
                            <i class="fas fa-user"></i>
                            <span>Driver Image</span>
                        </div>
                        <img id="driverImage" style="display: none;">
                    </div>
                    <div class="media-container">
                        <div class="media-placeholder" id="vehicleImagePlaceholder">
                            <i class="fas fa-car"></i>
                            <span>Vehicle Image</span>
                        </div>
                        <img id="vehicleImage" style="display: none;">
                    </div>
                </div>
                
                <!-- Tracking Info -->
                <div class="tracking-info" id="trackingInfo">
                    <div class="tracking-header">
                        <div class="tracking-title">Driver Distance</div>
                        <div class="tracking-distance" id="driverDistance">0 km</div>
                    </div>
                    <div class="tracking-progress">
                        <div class="tracking-progress-bar" id="trackingProgress" style="width: 0%"></div>
                    </div>
                    <div class="tracking-details">
                        <span id="pickupDistance">0 km to pickup</span>
                        <span id="etaToPickup">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Timeline -->
                <div class="timeline" id="rideTimeline">
                    <div class="timeline-step">
                        <div class="step-dot active" id="stepRequested">
                            <i class="fas fa-search"></i>
                        </div>
                        <div class="step-label active">Requested</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepAccepted">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <div class="step-label">Accepted</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepArrived">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="step-label">Arrived</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepStarted">
                            <i class="fas fa-play"></i>
                        </div>
                        <div class="step-label">Started</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepCompleted">
                            <i class="fas fa-flag-checkered"></i>
                        </div>
                        <div class="step-label">Completed</div>
                    </div>
                </div>
                
                <!-- Ride Stops -->
                <div class="ride-stops" id="rideStopsContainer" style="display: none; margin-top: 15px;">
                    <div class="section-title" style="font-size: 14px; color: var(--text-gray); margin-bottom: 10px;">
                        <i class="fas fa-map-pin"></i> Stops
                    </div>
                    <div id="rideStopsList"></div>
                </div>
                
                <div class="trip-details">
                    <div class="trip-locations">
                        <div class="location-point">
                            <div class="location-marker pickup">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="location-text">
                                <div class="location-label">Pickup</div>
                                <div class="location-address" id="currentPickup">Loading...</div>
                            </div>
                        </div>
                        
                        <div class="location-point">
                            <div class="location-marker destination">
                                <i class="fas fa-flag"></i>
                            </div>
                            <div class="location-text">
                                <div class="location-label">Destination</div>
                                <div class="location-address" id="currentDestination">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Location Details -->
                <div class="location-details">
                    <div class="location-detail-item">
                        <div class="location-detail-icon">
                            <i class="fas fa-road"></i>
                        </div>
                        <div class="location-detail-content">
                            <div class="location-detail-label">Distance</div>
                            <div class="location-detail-value" id="rideDistance">0 km</div>
                        </div>
                    </div>
                    <div class="location-detail-item">
                        <div class="location-detail-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="location-detail-content">
                            <div class="location-detail-label">Estimated Time</div>
                            <div class="location-detail-value" id="rideTime">0 min</div>
                        </div>
                    </div>
                </div>
                
                <div class="fare-breakdown">
                    <div class="fare-row">
                        <span class="fare-label">Base Fare</span>
                        <span class="fare-value" id="baseFareValue">ZMW 15.00</span>
                    </div>
                    <div class="fare-row">
                        <span class="fare-label">Distance</span>
                        <span class="fare-value" id="distanceFareValue">ZMW 5.00</span>
                    </div>
                    <div class="fare-row">
                        <span class="fare-label">Ride Type</span>
                        <span class="fare-value" id="rideTypeValue">Standard</span>
                    </div>
                    <div class="fare-row total">
                        <span class="fare-label">Total Fare</span>
                        <span class="fare-value" id="totalFareValue">ZMW 20.00</span>
                    </div>
                </div>
                
                <!-- Emergency Contact Display -->
                <div class="emergency-contact-display" id="emergencyContactDisplay" style="display: none;">
                    <div class="emergency-contact-header">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div class="emergency-contact-title">Emergency Contacts</div>
                    </div>
                    <div class="emergency-contact-item">
                        <div class="contact-info">
                            <div class="contact-name" id="emergencyContact1Name">Contact 1</div>
                            <div class="contact-phone" id="emergencyContact1Phone">000-000-0000</div>
                        </div>
                        <button class="contact-action-btn" id="emergencyContact1Btn">
                            <i class="fas fa-phone"></i>
                        </button>
                    </div>
                    <div class="emergency-contact-item">
                        <div class="contact-info">
                            <div class="contact-name" id="emergencyContact2Name">Contact 2</div>
                            <div class="contact-phone" id="emergencyContact2Phone">000-000-0000</div>
                        </div>
                        <button class="contact-action-btn" id="emergencyContact2Btn">
                            <i class="fas fa-phone"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Broadcast Feature -->
                <div class="broadcast-feature" id="broadcastFeature" style="display: none;">
                    <div class="broadcast-feature-header">
                        <div class="broadcast-feature-title">
                            <i class="fas fa-broadcast-tower"></i>
                            <span>Broadcast Ride</span>
                        </div>
                        <div class="broadcast-status-indicator inactive" id="broadcastStatusIndicator"></div>
                    </div>
                    <div class="broadcast-form">
                        <div class="broadcast-input-group">
                            <input type="text" id="broadcastMemberInput" placeholder="Enter friend's referral code">
                            <button class="broadcast-btn" id="addBroadcastMemberBtn">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div class="broadcast-recipients" id="broadcastMembersContainer">
                            <!-- Recipients will be inserted here -->
                        </div>
                        <button class="btn btn-secondary" id="startBroadcastBtn">
                            <i class="fas fa-play"></i>
                            Start Broadcasting
                        </button>
                    </div>
                </div>

                <!-- Share Ride Status -->
                <div class="share-ride-status" id="shareRideStatus" style="display: none;"></div>
                
                <div class="action-buttons">
                    <button class="btn btn-danger" id="cancelRideBtn">
                        <i class="fas fa-times-circle"></i>
                        Cancel Ride
                    </button>
                    <button class="btn btn-secondary" id="contactDriverBtn">
                        <i class="fas fa-phone"></i>
                        Call Driver
                    </button>
                    <button class="btn btn-secondary" id="openChatBtn">
                        <i class="fas fa-comment"></i>
                        Chat
                    </button>
                </div>
            </div>
            
            <!-- Broadcast Ride Form -->
            <div class="service-form" id="broadcastForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-broadcast-tower"></i>
                    Broadcast Ride
                </div>
                
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="broadcastPickup" placeholder="Pickup location" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="broadcastPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="broadcastDestination" placeholder="Destination" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="broadcastDestinationSuggestions"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Passenger Phone Numbers (comma separated)</label>
                    <textarea class="form-control form-textarea" id="broadcastPassengers" placeholder="Enter phone numbers of passengers to share this ride with..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Ride Type</label>
                    <select class="form-control" id="broadcastRideType">
                        <option value="standard">Standard</option>
                        <option value="economy">Economy</option>
                        <option value="premium">Premium</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Split Fare</label>
                    <select class="form-control" id="broadcastSplitType">
                        <option value="equal">Equal Split</option>
                        <option value="you_pay_more">You Pay 70%</option>
                        <option value="you_pay_all">You Pay All</option>
                    </select>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="broadcastFareDisplay" style="display: none;">
                    <div class="fare-label">Broadcast Fare</div>
                    <div class="fare-amount" id="broadcastFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="broadcastDistance">0 km</span>
                        <span id="broadcastTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="startBroadcastRideBtn">
                        <i class="fas fa-broadcast-tower"></i>
                        Start Broadcast
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- History Screen -->
    <div class="history-screen" id="historyScreen" style="display: none;">
        <div class="screen-header">
            <button class="back-btn" data-screen="home">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="screen-title">Ride History</div>
        </div>
        
        <div class="history-filters">
            <button class="filter-btn active" data-filter="all">All</button>
            <button class="filter-btn" data-filter="completed">Completed</button>
            <button class="filter-btn" data-filter="cancelled">Cancelled</button>
            <button class="filter-btn" data-filter="scheduled">Scheduled</button>
            <button class="filter-btn" data-filter="emergency">Emergency</button>
            <button class="filter-btn" data-filter="delivery">Delivery</button>
            <button class="filter-btn" data-filter="truck">Truck</button>
            <button class="filter-btn" data-filter="broadcast">Broadcast</button>
        </div>
        
        <div class="history-list" id="historyList">
            <!-- History items will be inserted here -->
        </div>
    </div>
    
    <!-- Account Screen -->
    <div class="account-screen" id="accountScreen" style="display: none;">
        <div class="screen-header">
            <button class="back-btn" data-screen="home">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="screen-title">My Account</div>
        </div>
        
        <div class="account-header">
            <div class="account-avatar" id="accountAvatar">
                <i class="fas fa-user"></i>
            </div>
            <div class="account-name" id="accountName">Loading...</div>
            <div class="account-phone" id="accountPhone">Loading...</div>
        </div>
        
        <div class="account-stats">
            <div class="stat-card">
                <div class="stat-value" id="completedRides">0</div>
                <div class="stat-label">Completed Rides</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="cancelledRides">0</div>
                <div class="stat-label">Cancelled Rides</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalSpent">ZMW 0</div>
                <div class="stat-label">Total Spent</div>
            </div>
        </div>
        
        <div class="account-section">
            <div class="section-title">
                <i class="fas fa-wallet"></i>
                Wallet Balance
            </div>
            
            <div class="wallet-balance">
                <div class="balance-label">Available Balance</div>
                <div class="balance-amount-large" id="accountBalance">ZMW 0.00</div>
            </div>
            
            <div class="wallet-actions">
                <button class="btn-wallet" id="depositBtn">
                    <i class="fas fa-plus"></i>
                    Deposit
                </button>
                <button class="btn-wallet" id="withdrawBtn">
                    <i class="fas fa-minus"></i>
                    Withdraw
                </button>
                <button class="btn-wallet" id="transferBtn">
                    <i class="fas fa-exchange-alt"></i>
                    Transfer
                </button>
                <button class="btn-wallet" id="transactionsBtn">
                    <i class="fas fa-history"></i>
                    History
                </button>
            </div>
        </div>
        
        <div class="account-section">
            <div class="section-title">
                <i class="fas fa-gift"></i>
                Referral Program
            </div>
            
            <div class="referral-card">
                <div>Share your referral code and earn ZMW 25 for each friend's first ride</div>
                <div class="referral-code" id="referralCode">JUBEL-XXXX</div>
                <button class="btn btn-primary" id="shareReferralBtn">
                    <i class="fas fa-share"></i>
                    Share Code
                </button>
                <div class="referral-note">Your friend gets 50% off their first ride</div>
            </div>
        </div>
        
        <div class="account-section">
            <div class="section-title">
                <i class="fas fa-cog"></i>
                Settings
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-secondary" id="updateProfileBtn">
                    <i class="fas fa-user-edit"></i>
                    Update Profile
                </button>
                <button class="btn btn-secondary" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </button>
            </div>
        </div>
    </div>
    
    <!-- Emergency Screen -->
    <div class="emergency-screen" id="emergencyScreen" style="display: none;">
        <div class="screen-header">
            <button class="back-btn" data-screen="home">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="screen-title">Emergency Services</div>
        </div>
        
        <div class="emergency-services">
            <div class="emergency-service police" data-type="police">
                <div class="emergency-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <div class="emergency-name">Police Ride</div>
                <div class="emergency-description">Emergency transport with police escort</div>
            </div>
            
            <div class="emergency-service fire" data-type="fire">
                <div class="emergency-icon">
                    <i class="fas fa-fire-extinguisher"></i>
                </div>
                <div class="emergency-name">Fire Brigade</div>
                <div class="emergency-description">Fire emergency response team</div>
            </div>
            
            <div class="emergency-service medical" data-type="medical">
                <div class="emergency-icon">
                    <i class="fas fa-ambulance"></i>
                </div>
                <div class="emergency-name">Hospital Ride</div>
                <div class="emergency-description">Medical emergency transport</div>
            </div>
            
            <div class="emergency-service" data-type="sos">
                <div class="emergency-icon" style="background: var(--error-red);">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="emergency-name">SOS Emergency</div>
                <div class="emergency-description">Immediate emergency assistance</div>
            </div>
        </div>
        
        <div class="emergency-note">
            <p><strong>Important:</strong> Only use emergency services for genuine emergencies. Misuse may result in penalties. In case of immediate danger, call 911 first.</p>
        </div>
    </div>
    
    <!-- Modals -->
    
    <!-- Payment Modal -->
    <div class="modal-overlay" id="paymentModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-credit-card"></i>
                    Select Payment Method
                </div>
                <button class="modal-close" data-modal="payment">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <div class="form-label">Available Balance: <span id="paymentBalance">ZMW 0.00</span></div>
                    <div class="form-label">Total Amount: <span id="paymentAmount">ZMW 0.00</span></div>
                </div>
                
                <!-- Referral Discount Section -->
                <div class="referral-discount-section" id="referralDiscountSection" style="display: none;">
                    <div class="section-header">
                        <i class="fas fa-gift"></i>
                        <span>Referral Discount (50% off)</span>
                    </div>
                    <div class="referral-input-group">
                        <input type="text" id="referralCodeInput" placeholder="Enter referral code">
                        <button id="applyReferralBtn" class="btn btn-orange">
                            <i class="fas fa-check"></i> Apply
                        </button>
                    </div>
                    <div id="referrerInfo" style="display: none; font-size: 12px; color: var(--success-green); margin-top: 5px;"></div>
                    <div class="discount-breakdown" style="margin-top: 10px;">
                        <div class="price-row">
                            <span>Original Fare:</span>
                            <span id="originalFareAmount">ZMW 0.00</span>
                        </div>
                        <div class="price-row">
                            <span>Discount:</span>
                            <span id="discountAmount" style="color: var(--success-green);">-ZMW 0.00</span>
                        </div>
                        <div class="price-row total">
                            <span>Final Fare:</span>
                            <span id="finalFareAmount" style="font-weight: bold;">ZMW 0.00</span>
                        </div>
                    </div>
                </div>
                
                <div class="payment-methods">
                    <div class="payment-method" data-payment="wallet">
                        <div class="payment-icon">
                            <i class="fas fa-wallet"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Jubel Wallet</div>
                            <div class="payment-info">Pay with your wallet balance</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-payment="mobile">
                        <div class="payment-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Mobile Money</div>
                            <div class="payment-info">Pay via MTN/Zamtel/Airtel</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-payment="cash">
                        <div class="payment-icon">
                            <i class="fas fa-money-bill"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Cash</div>
                            <div class="payment-info">Pay driver directly</div>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmPaymentBtn">
                        <i class="fas fa-check"></i>
                        Confirm Payment
                    </button>
                    <button class="btn btn-secondary" data-modal="payment">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Cancel Ride Modal -->
    <div class="modal-overlay" id="cancelModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-times-circle"></i>
                    Cancel Ride
                </div>
                <button class="modal-close" data-modal="cancel">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <div class="form-label">Please select a reason for cancellation:</div>
                </div>
                
                <div class="cancel-reasons">
                    <div class="cancel-reason" data-reason="driver_late">
                        <div class="reason-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="reason-text">Driver is taking too long</div>
                    </div>
                    
                    <div class="cancel-reason" data-reason="change_plans">
                        <div class="reason-icon">
                            <i class="fas fa-calendar-times"></i>
                        </div>
                        <div class="reason-text">Change of plans</div>
                    </div>
                    
                    <div class="cancel-reason" data-reason="found_alternative">
                        <div class="reason-icon">
                            <i class="fas fa-car"></i>
                        </div>
                        <div class="reason-text">Found alternative transport</div>
                    </div>
                    
                    <div class="cancel-reason" data-reason="emergency">
                        <div class="reason-icon">
                            <i class="fas fa-exclamation"></i>
                        </div>
                        <div class="reason-text">Emergency situation</div>
                    </div>
                    
                    <div class="cancel-reason" data-reason="other">
                        <div class="reason-icon">
                            <i class="fas fa-ellipsis-h"></i>
                        </div>
                        <div class="reason-text">Other reason</div>
                    </div>
                </div>
                
                <div class="form-group" id="otherReasonGroup" style="display: none;">
                    <label class="form-label">Please specify:</label>
                    <textarea class="form-control form-textarea" id="otherReason" placeholder="Enter your reason here..."></textarea>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-danger" id="confirmCancelBtn">
                        <i class="fas fa-times"></i>
                        Cancel Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="cancel">
                        Go Back
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Emergency Ride Modal -->
    <div class="modal-overlay" id="emergencyModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-ambulance"></i>
                    Emergency Ride Details
                </div>
                <button class="modal-close" data-modal="emergency">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content emergency-modal-content">
                <div class="form-group">
                    <div class="form-label" id="emergencyServiceType">Police Ride</div>
                </div>
                
                <!-- Emergency Reasons -->
                <div class="form-group">
                    <label class="form-label">Select Emergency Reason</label>
                    <div class="emergency-reasons">
                        <div class="emergency-reason" data-reason="accident">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-car-crash"></i>
                            </div>
                            <div class="emergency-reason-text">Accident</div>
                        </div>
                        
                        <div class="emergency-reason" data-reason="medical">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-heartbeat"></i>
                            </div>
                            <div class="emergency-reason-text">Medical Emergency</div>
                        </div>
                        
                        <div class="emergency-reason" data-reason="crime">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="emergency-reason-text">Crime/Assault</div>
                        </div>
                        
                        <div class="emergency-reason" data-reason="fire">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-fire"></i>
                            </div>
                            <div class="emergency-reason-text">Fire Emergency</div>
                        </div>
                        
                        <div class="emergency-reason" data-reason="other">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="emergency-reason-text">Other Emergency</div>
                        </div>
                    </div>
                    
                    <div class="emergency-reason-input" id="emergencyReasonOther" style="display: none;">
                        <label class="form-label">Please describe the emergency:</label>
                        <textarea class="form-control form-textarea" id="emergencyOtherReason" placeholder="Describe the emergency situation..."></textarea>
                    </div>
                </div>
                
                <!-- Location Inputs -->
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="emergencyPickup" placeholder="Pickup location" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="emergencyPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="emergencyDestination" placeholder="Destination" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="emergencyDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Emergency Stations -->
                <div class="form-group">
                    <label class="form-label">Select Nearest Emergency Station</label>
                    <div class="emergency-stations" id="emergencyStations">
                        <!-- Stations will be inserted here -->
                    </div>
                </div>
                
                <!-- User Location Details -->
                <div class="location-details">
                    <div class="location-detail-item">
                        <div class="location-detail-icon">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="location-detail-content">
                            <div class="location-detail-label">Your Location</div>
                            <div class="location-detail-value" id="emergencyUserLocation">Detecting location...</div>
                        </div>
                    </div>
                </div>
                
                <!-- Price Calculation -->
                <div class="price-calculation">
                    <div class="calculation-row">
                        <span>Base Emergency Fare:</span>
                        <span id="emergencyBaseFare">ZMW 100.00</span>
                    </div>
                    <div class="calculation-row">
                        <span>Distance to Service:</span>
                        <span id="emergencyDistance">0 km</span>
                    </div>
                    <div class="calculation-row">
                        <span>Estimated Time:</span>
                        <span id="emergencyTime">5 min</span>
                    </div>
                    <div class="calculation-row total">
                        <span>Total Fare:</span>
                        <span id="emergencyTotalFare">ZMW 100.00</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-danger" id="confirmEmergencyBtn">
                        <i class="fas fa-exclamation-triangle"></i>
                        Request Emergency Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="emergency">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- SOS Setup Modal -->
    <div class="modal-overlay" id="sosModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    SOS Emergency Setup
                </div>
                <button class="modal-close" data-modal="sos">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <label class="form-label">Primary Emergency Contact</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="sosContact1Name" placeholder="Contact name">
                        <input type="tel" class="form-control" id="sosContact1Phone" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Secondary Emergency Contact (Optional)</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="sosContact2Name" placeholder="Contact name">
                        <input type="tel" class="form-control" id="sosContact2Phone" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Emergency Message</label>
                    <textarea class="form-control form-textarea" id="sosMessage">
I need help! My current location and ride details will be shared with you.
                    </textarea>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="saveSOSBtn">
                        <i class="fas fa-save"></i>
                        Save SOS Setup
                    </button>
                    <button class="btn btn-secondary" data-modal="sos">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Transfer Money Modal -->
    <div class="modal-overlay" id="transferModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-exchange-alt"></i>
                    Transfer Money
                </div>
                <button class="modal-close" data-modal="transfer">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <div class="form-label">Available Balance: <span id="transferBalance">ZMW 0.00</span></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Recipient's Referral Code</label>
                    <input type="text" class="form-control" id="recipientCode" placeholder="Enter recipient's Jubel referral code">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Amount (ZMW)</label>
                    <input type="number" class="form-control" id="transferAmount" placeholder="Enter amount" min="1" step="0.01">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Message (Optional)</label>
                    <input type="text" class="form-control" id="transferMessage" placeholder="Add a message">
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmTransferBtn">
                        <i class="fas fa-paper-plane"></i>
                        Send Money
                    </button>
                    <button class="btn btn-secondary" data-modal="transfer">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Wallet Transactions Modal -->
    <div class="modal-overlay" id="transactionsModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-history"></i>
                    Wallet Transactions
                </div>
                <button class="modal-close" data-modal="transactions">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div id="transactionsList">
                    <!-- Transactions will be inserted here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Schedule Ride Modal -->
    <div class="modal-overlay" id="scheduleModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-calendar-alt"></i>
                    Schedule a Ride
                </div>
                <button class="modal-close" data-modal="schedule">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="schedulePickup" placeholder="Pickup location">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="schedulePickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="scheduleDestination" placeholder="Destination">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="scheduleDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- For Someone Else -->
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="scheduleForSomeone">
                        <span style="margin-left: 8px;">Booking for someone else</span>
                    </label>
                </div>
                
                <div class="form-group" id="someoneElseDetails" style="display: none;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="recipientName" placeholder="Recipient name">
                        <input type="tel" class="form-control" id="recipientPhone" placeholder="Recipient phone">
                    </div>
                </div>
                
                <div class="schedule-grid">
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-control" id="scheduleDate" min="">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Time</label>
                        <input type="time" class="form-control" id="scheduleTime">
                    </div>
                </div>
                
                <!-- Ride Type Selection for Schedule -->
                <div class="ride-type-selection" style="margin: 0 0 16px 0;">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                    </div>
                    <div class="ride-type-grid" id="scheduleRideTypeGrid">
                        <div class="ride-type-card economy" data-type="economy">
                            <div class="ride-type-icon">
                                <i class="fas fa-car-side"></i>
                            </div>
                            <div class="ride-type-name">Economy</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card selected" data-type="standard">
                            <div class="ride-type-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="ride-type-name">Standard</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card premium" data-type="premium">
                            <div class="ride-type-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="ride-type-name">Premium</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="scheduleFareDisplay" style="display: none;">
                    <div class="fare-label">Scheduled Ride Fare</div>
                    <div class="fare-amount" id="scheduleFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="scheduleDistance">0 km</span>
                        <span id="scheduleTimeEstimate">ETA: 0 min</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmScheduleBtn">
                        <i class="fas fa-calendar-check"></i>
                        Schedule Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="schedule">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Order for Someone Modal -->
    <div class="modal-overlay" id="orderForSomeoneModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-user-friends"></i>
                    Order for Someone Else
                </div>
                <button class="modal-close" data-modal="orderForSomeone">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="someonePickup" placeholder="Pickup location">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="someonePickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="someoneDestination" placeholder="Destination">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="someoneDestinationSuggestions"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Recipient Details</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="someoneName" placeholder="Full name">
                        <input type="tel" class="form-control" id="someonePhone" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Special Instructions (Optional)</label>
                    <textarea class="form-control form-textarea" id="someoneInstructions" placeholder="Any instructions for the driver..."></textarea>
                </div>
                
                <!-- Ride Type Selection -->
                <div class="ride-type-selection" style="margin: 0 0 16px 0;">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                    </div>
                    <div class="ride-type-grid" id="someoneRideTypeGrid">
                        <div class="ride-type-card economy" data-type="economy">
                            <div class="ride-type-icon">
                                <i class="fas fa-car-side"></i>
                            </div>
                            <div class="ride-type-name">Economy</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card selected" data-type="standard">
                            <div class="ride-type-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="ride-type-name">Standard</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card premium" data-type="premium">
                            <div class="ride-type-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="ride-type-name">Premium</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="someoneFareDisplay" style="display: none;">
                    <div class="fare-label">Estimated Fare</div>
                    <div class="fare-amount" id="someoneFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="someoneDistance">0 km</span>
                        <span id="someoneTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmSomeoneRideBtn">
                        <i class="fas fa-car"></i>
                        Request Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="orderForSomeone">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Share Ride Modal -->
    <div class="modal-overlay" id="shareRideModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-share-alt"></i>
                    Share Ride
                </div>
                <button class="modal-close" data-modal="shareRide">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="sharePickup" placeholder="Pickup location">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="sharePickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="shareDestination" placeholder="Destination">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shareDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Share Members Input -->
                <div class="form-group">
                    <label class="form-label">Add Friends by Referral Code</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" class="form-control" id="shareMemberInput" placeholder="Enter friend's referral code">
                        <button class="btn btn-secondary" id="addShareMemberBtn">
                            <i class="fas fa-plus"></i> Add
                        </button>
                    </div>
                </div>
                
                <!-- Share Members List -->
                <div class="form-group">
                    <div id="shareFriendsList" class="share-friends-list">
                        <!-- Share members will be inserted here -->
                    </div>
                </div>
                
                <!-- Share Calculations -->
                <div class="form-group" id="shareCalculations" style="display: none;">
                    <!-- Calculations will be inserted here -->
                </div>
                
                <!-- Ride Type Selection -->
                <div class="ride-type-selection" style="margin: 0 0 16px 0;">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                    </div>
                    <div class="ride-type-grid" id="shareRideTypeGrid">
                        <div class="ride-type-card economy" data-type="economy">
                            <div class="ride-type-icon">
                                <i class="fas fa-car-side"></i>
                            </div>
                            <div class="ride-type-name">Economy</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card selected" data-type="standard">
                            <div class="ride-type-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="ride-type-name">Standard</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card premium" data-type="premium">
                            <div class="ride-type-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="ride-type-name">Premium</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Estimated Fare: <span id="shareFareEstimate">ZMW 0.00</span></label>
                    <div class="price-calculation">
                        <div class="calculation-row">
                            <span>Your Share:</span>
                            <span id="yourShare">ZMW 0.00</span>
                        </div>
                        <div class="calculation-row">
                            <span>Friend's Share:</span>
                            <span id="friendShare">ZMW 0.00</span>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmShareRideBtn">
                        <i class="fas fa-user-friends"></i>
                        Share Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="shareRide">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Share Ride Invitation Modal -->
    <div class="modal-overlay" id="shareRideInvitationModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-users"></i>
                    Share Ride Invitation
                </div>
                <button class="modal-close" data-modal="shareRideInvitation">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="invitation-details" id="invitationDetails">
                    <!-- Invitation details will be inserted here -->
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" id="acceptShareInvitationBtn">
                        <i class="fas fa-check"></i>
                        Accept Invitation
                    </button>
                    <button class="btn btn-secondary" id="rejectShareInvitationBtn">
                        <i class="fas fa-times"></i>
                        Decline
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Update Profile Modal -->
    <div class="modal-overlay" id="updateProfileModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-user-edit"></i>
                    Update Profile
                </div>
                <button class="modal-close" data-modal="updateProfile">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <input type="text" class="form-control" id="updateName" placeholder="Your full name">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Phone Number</label>
                    <input type="tel" class="form-control" id="updatePhone" placeholder="Your phone number">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" class="form-control" id="updateEmail" placeholder="Your email address" readonly>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Home Address (Optional)</label>
                    <input type="text" class="form-control" id="updateHomeAddress" placeholder="Your home address">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Work Address (Optional)</label>
                    <input type="text" class="form-control" id="updateWorkAddress" placeholder="Your work address">
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="saveProfileBtn">
                        <i class="fas fa-save"></i>
                        Save Changes
                    </button>
                    <button class="btn btn-secondary" data-modal="updateProfile">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Loading...</div>
    </div>
    
    <!-- Search Loading Overlay -->
    <div id="searchLoading" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); z-index: 10000;">
        <i class="fas fa-spinner fa-spin"></i> Searching...
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Real-time Indicator -->
    <div class="real-time-indicator" id="realTimeIndicator">
        <i class="fas fa-sync-alt"></i>
        <span>Real-time updates active</span>
    </div>
    
    <!-- Sync Indicator -->
    <div class="sync-indicator" id="syncIndicator">
        <i class="fas fa-sync-alt sync-icon"></i>
        <span>Syncing...</span>
    </div>
    
    <!-- Schedule Countdown -->
    <div id="scheduleCountdown" style="display: none;"></div>
    
    <!-- External JavaScript Libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>             
    <script>
// ============================================
// COMPREHENSIVE JUBEL PASSENGER APP
// ============================================
// This script enhances all features: destination search, price calculation,
// referral system, ride sharing, broadcasting, emergency services,
// real-time updates, and advanced wallet functionality.

// Firestore configuration (assuming you're using both Realtime Database and Firestore)
const firestoreConfig = {
    apiKey: "AIzaSyDEACX_P4c5q7djJAcA0I7Lk7leO2TlQ74",
    authDomain: "jubel-13e1a.firebaseapp.com",
    projectId: "jubel-13e1a",
    storageBucket: "jubel-13e1a.firebasestorage.app",
    messagingSenderId: "882241095445",
    appId: "1:882241095445:web:ee9ca40fddd008ca910b1c"
};

// Initialize Firestore if not already initialized
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}

const db = firebase.firestore();
const realtimeDb = firebase.database();
const auth = firebase.auth();
const storage = firebase.storage();

// ============================================
// ENHANCED GLOBAL STATE MANAGEMENT
// ============================================
const AppState = {
    // Core state
    currentUser: null,
    userData: null,
    currentRide: null,
    activeScreen: 'home',
    activeService: 'car',
    walletBalance: 0,
    userLocation: null,
    currentCity: null,
    detectedCity: null,
    selectedRideType: 'standard',
    selectedVehicle: null,
    destination: null,
    pickup: null,
    rideFare: 0,
    driverLocation: null,
    chatMessages: [],
    scheduledRides: [],
    emergencyMode: false,
    sosConfig: null,
    searchCache: new Map(),
    lastSearchTime: 0,
    notifications: [],
    unreadNotifications: 0,
    searchHistory: [],
    broadcastRecipients: [],
    
    // Ride stops
    rideStops: [],
    maxStops: 3,
    
    // Emergency stations
    emergencyStations: {
        police: [],
        fire: [],
        medical: []
    },
    
    // Real-time management
    realtimeListeners: [],
    
    // Price configurations
    rideTypes: {
        economy: { base: 15, perKm: 2.5, multiplier: 0.8, min: 10, icon: 'fa-car-side' },
        standard: { base: 20, perKm: 3.0, multiplier: 1.0, min: 15, icon: 'fa-car' },
        premium: { base: 30, perKm: 4.0, multiplier: 1.5, min: 25, icon: 'fa-crown' }
    },
    
    emergencyServices: {
        police: { base: 150, perKm: 5.0, multiplier: 2.0, min: 100 },
        fire: { base: 200, perKm: 6.0, multiplier: 2.5, min: 150 },
        medical: { base: 180, perKm: 5.5, multiplier: 2.2, min: 120 }
    },
    
    deliveryTypes: {
        standard: { base: 25, perKm: 2.0, multiplier: 1.0 },
        express: { base: 40, perKm: 3.0, multiplier: 1.5 },
        sameDay: { base: 60, perKm: 4.0, multiplier: 2.0 }
    },
    
    truckTypes: {
        pickup: { base: 80, perKm: 5.0, multiplier: 1.0, capacity: '1.5 tons' },
        light: { base: 120, perKm: 6.0, multiplier: 1.2, capacity: '3 tons' },
        medium: { base: 200, perKm: 8.0, multiplier: 1.5, capacity: '7 tons' },
        heavy: { base: 350, perKm: 12.0, multiplier: 2.0, capacity: '15 tons' }
    },
    
    // Shopping categories
    shoppingCategories: {
        restaurants: [
            { name: 'Pizza Hut', icon: 'fa-pizza-slice', type: 'restaurant' },
            { name: 'Nandos', icon: 'fa-drumstick-bite', type: 'restaurant' },
            { name: 'Hungry Lion', icon: 'fa-hamburger', type: 'restaurant' },
            { name: 'Steers', icon: 'fa-burger', type: 'restaurant' },
            { name: 'Debonairs Pizza', icon: 'fa-pizza-slice', type: 'restaurant' }
        ],
        pharmacy: [
            { name: 'Medi-Chem', icon: 'fa-prescription-bottle-medical', type: 'pharmacy' },
            { name: 'Dis-Chem', icon: 'fa-clinic-medical', type: 'pharmacy' },
            { name: 'Clicks Pharmacy', icon: 'fa-pills', type: 'pharmacy' },
            { name: 'Medsave', icon: 'fa-heartbeat', type: 'pharmacy' }
        ],
        supermarkets: [
            { name: 'Shoprite', icon: 'fa-shopping-cart', type: 'supermarket' },
            { name: 'Pick n Pay', icon: 'fa-store', type: 'supermarket' },
            { name: 'Spar', icon: 'fa-shopping-basket', type: 'supermarket' },
            { name: 'Choppies', icon: 'fa-carrot', type: 'supermarket' }
        ],
        malls: [
            { name: 'Manda Hill', icon: 'fa-store-alt', type: 'mall' },
            { name: 'East Park', icon: 'fa-building', type: 'mall' },
            { name: 'Levy Junction', icon: 'fa-shopping-bag', type: 'mall' },
            { name: 'Cosmopolitan', icon: 'fa-city', type: 'mall' }
        ]
    },
    
    // Additional state properties
    lastPriceUpdate: 0,
    cityDetectionAttempts: 0,
    maxCityDetectionAttempts: 5,
    isSyncing: false,
    syncInterval: null,
    emergencyReason: null,
    selectedEmergencyStation: null,
    activeBroadcast: null,
    typingTimeout: null,
    driverTyping: false,
    
    // Location management
    locationManagement: {
        isEditingPickup: false,
        currentPickupInputId: null,
        pickupSearchResults: [],
        cityBounds: null,
        cityPolygon: null,
        userDetectedAddress: null
    },
    
    // Ride sharing
    shareRideFriends: [],
    maxShareFriends: 4,
    shareRideStatus: 'pending', // pending, waiting, accepted, rejected
    shareRideResponses: new Map(),
    
    // Ride splitting
    rideSplitDetails: null,
    
    // Referral system
    referralDiscountApplied: false,
    referralCodeUsed: null,
    referralOwnerName: null,
    
    // Ride requests
    pendingRideData: null,
    activeRoute: null,
    
    // UI state
    activeFilter: 'all',
    lastSearchQuery: null,
    chatOpen: false,
    notificationsOpen: false,
    mapInitialized: false,
    
    // Scheduled rides
    activeScheduledTimer: null,
    
    // Ride request animation
    rideRequestPulsingIcons: {
        car: null,
        bike: null,
        truck: null
    },
    
    // Invitations
    shareRideInvitations: new Map(),
    broadcastInvitations: new Map(),
    
    // Payment management
    paymentPendingMembers: new Set()
};

// ============================================
// ADVANCED LOCATION DETECTION ENGINE
// ============================================
const AdvancedCityDetector = {
    async detectCityFromCoordinates(lat, lng) {
        try {
            console.log('Detecting city from coordinates:', lat, lng);
            
            // Try OpenStreetMap Nominatim first
            const response = await fetch(
                `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&addressdetails=1`
            );
            
            if (!response.ok) throw new Error('Reverse geocoding failed');
            
            const data = await response.json();
            
            if (data.address) {
                // Extract city/town from address
                const city = data.address.city || 
                            data.address.town || 
                            data.address.village || 
                            data.address.municipality ||
                            data.address.suburb ||
                            data.address.county;
                
                if (city) {
                    console.log('City detected via OSM:', city);
                    AppState.currentCity = city;
                    AppState.detectedCity = city;
                    
                    // Update UI
                    EnhancedUIUpdater.updateCityDisplay(city);
                    
                    // Show city boundary on map
                    EnhancedUIUpdater.showCityBoundaryOnMap(city);
                    
                    return city;
                }
            }
            
            // If OSM fails, try Google Maps Geocoding (requires API key)
            return await this.detectCityWithGoogle(lat, lng);
            
        } catch (error) {
            console.error('Error detecting city:', error);
            return await this.useFallbackCityDetection(lat, lng);
        }
    },
    
    async detectCityWithGoogle(lat, lng) {
        // Note: You'll need to add your Google Maps API key
        const apiKey = 'YOUR_GOOGLE_MAPS_API_KEY';
        if (!apiKey) return null;
        
        try {
            const response = await fetch(
                `https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lng}&key=${apiKey}`
            );
            
            const data = await response.json();
            
            if (data.results && data.results.length > 0) {
                const addressComponents = data.results[0].address_components;
                
                // Find city in address components
                const cityComponent = addressComponents.find(component => 
                    component.types.includes('locality') || 
                    component.types.includes('administrative_area_level_2')
                );
                
                if (cityComponent) {
                    AppState.currentCity = cityComponent.long_name;
                    AppState.detectedCity = cityComponent.long_name;
                    EnhancedUIUpdater.updateCityDisplay(cityComponent.long_name);
                    return cityComponent.long_name;
                }
            }
        } catch (error) {
            console.error('Google Geocoding error:', error);
        }
        
        return null;
    },
    
    async useFallbackCityDetection(lat, lng) {
        console.log('Using fallback city detection');
        
        // Zambian city coordinates (approximate)
        const zambianCities = [
            { name: 'Lusaka', lat: -15.4167, lng: 28.2833, radius: 50 },
            { name: 'Ndola', lat: -12.9647, lng: 28.6356, radius: 30 },
            { name: 'Kitwe', lat: -12.8200, lng: 28.2000, radius: 25 },
            { name: 'Kabwe', lat: -14.4400, lng: 28.4500, radius: 20 },
            { name: 'Livingstone', lat: -17.8500, lng: 25.8667, radius: 20 },
            { name: 'Chipata', lat: -13.6333, lng: 32.6500, radius: 15 },
            { name: 'Chingola', lat: -12.5333, lng: 27.8500, radius: 15 },
            { name: 'Mufulira', lat: -12.5500, lng: 28.2333, radius: 15 },
            { name: 'Luanshya', lat: -13.1333, lng: 28.4000, radius: 15 },
            { name: 'Kasama', lat: -10.2167, lng: 31.1333, radius: 15 },
            { name: 'Solwezi', lat: -12.1833, lng: 26.4000, radius: 15 },
            { name: 'Mazabuka', lat: -15.8500, lng: 27.7667, radius: 15 }
        ];
        
        // Calculate distance to each city
        for (const city of zambianCities) {
            const distance = this.calculateDistance(lat, lng, city.lat, city.lng);
            
            if (distance <= city.radius) {
                console.log('City detected via fallback:', city.name);
                AppState.currentCity = city.name;
                AppState.detectedCity = city.name;
                EnhancedUIUpdater.updateCityDisplay(city.name);
                return city.name;
            }
        }
        
        // Default to Lusaka if nothing else works
        console.log('Defaulting to Lusaka');
        AppState.currentCity = 'Lusaka';
        AppState.detectedCity = 'Lusaka';
        EnhancedUIUpdater.updateCityDisplay('Lusaka');
        return 'Lusaka';
    },
    
    calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // Earth's radius in km
        const dLat = this.toRad(lat2 - lat1);
        const dLon = this.toRad(lon2 - lon1);
        const a = 
            Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(this.toRad(lat1)) * Math.cos(this.toRad(lat2)) * 
            Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    },
    
    toRad(value) {
        return value * Math.PI / 180;
    },
    
    async getDetailedAddress(lat, lng) {
        try {
            const response = await fetch(
                `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&addressdetails=1`
            );
            
            if (!response.ok) throw new Error('Address lookup failed');
            
            const data = await response.json();
            
            if (data.display_name) {
                const address = data.display_name.split(',');
                const detailedAddress = {
                    fullDisplay: data.display_name,
                    address: `${address[0]}, ${address[1] || ''}`.trim(),
                    street: address[0] || '',
                    area: address[1] || '',
                    city: address[2] || '',
                    country: address[address.length - 1] || ''
                };
                
                AppState.locationManagement.userDetectedAddress = detailedAddress;
                return detailedAddress;
            }
        } catch (error) {
            console.error('Error getting detailed address:', error);
        }
        
        // Fallback address
        return {
            fullDisplay: `Location at ${lat.toFixed(4)}, ${lng.toFixed(4)}`,
            address: `Location at ${lat.toFixed(4)}, ${lng.toFixed(4)}`,
            street: '',
            area: '',
            city: AppState.currentCity || 'Unknown',
            country: 'Zambia'
        };
    }
};

// ============================================
// INTELLIGENT SEARCH ENGINE WITH CITY FILTERING
// ============================================
const IntelligentSearchEngine = {
    cache: new Map(),
    searchDebounce: null,
    activeSearches: new Set(),
    cityBoundsCache: new Map(),
    
    async search(query, type = 'destination', city = null, userLocation = null) {
        const searchId = `${Date.now()}-${Math.random()}`;
        this.activeSearches.add(searchId);
        
        try {
            const targetCity = city || AppState.currentCity;
            if (!targetCity) {
                console.warn('No city available for search');
                return [];
            }
            
            // Create cache key
            const cacheKey = `${query.toLowerCase()}_${type}_${targetCity}_${userLocation ? `${userLocation.lat.toFixed(3)},${userLocation.lng.toFixed(3)}` : 'no_loc'}`;
            
            // Check cache first
            if (this.cache.has(cacheKey)) {
                const cached = this.cache.get(cacheKey);
                if (Date.now() - cached.timestamp < 300000) { // 5 minutes
                    console.log('Returning cached search results');
                    return cached.results;
                }
            }
            
            console.log(`Searching for "${query}" in ${targetCity}, type: ${type}`);
            
            // Get city bounds for search filtering
            const cityBounds = await this.getCityBounds(targetCity);
            
            // Construct search URL with city constraints
            const searchUrl = this.constructSearchUrl(query, targetCity, cityBounds, userLocation);
            
            // Show loading indicator
            this.showSearchLoading(true);
            
            // Perform search
            const response = await fetch(searchUrl, {
                headers: {
                    'User-Agent': 'JubelRideApp/2.0',
                    'Accept': 'application/json'
                }
            });
            
            if (!response.ok) {
                throw new Error(`Search failed: ${response.status}`);
            }
            
            const data = await response.json();
            console.log(`Received ${data.length} raw results for "${query}"`);
            
            // Process and filter results
            const results = this.processSearchResults(data, targetCity, userLocation, type);
            
            // Cache results
            this.cache.set(cacheKey, {
                results: results,
                timestamp: Date.now(),
                query: query,
                city: targetCity
            });
            
            // Add to search history if it's a destination
            if (type === 'destination' && results.length > 0) {
                this.addToSearchHistory(query, results[0], type);
            }
            
            console.log(`Returning ${results.length} filtered results`);
            return results;
            
        } catch (error) {
            console.error('Search error:', error);
            
            // Try fallback search without city constraints
            return await this.fallbackSearch(query, type, city, userLocation);
            
        } finally {
            this.activeSearches.delete(searchId);
            this.showSearchLoading(false);
        }
    },
    
    constructSearchUrl(query, city, cityBounds, userLocation) {
        const baseUrl = 'https://nominatim.openstreetmap.org/search';
        const params = new URLSearchParams({
            q: `${query}, ${city}, Zambia`,
            format: 'json',
            limit: '20',
            countrycodes: 'zm',
            addressdetails: '1',
            'accept-language': 'en',
            namedetails: '0',
            polygon: '0'
        });
        
        // Add city bounds if available
        if (cityBounds) {
            params.append('viewbox', cityBounds.join(','));
            params.append('bounded', '1');
        }
        
        return `${baseUrl}?${params}`;
    },
    
    async getCityBounds(cityName) {
        // Check cache first
        if (this.cityBoundsCache.has(cityName)) {
            return this.cityBoundsCache.get(cityName);
        }
        
        // Zambian city bounds (approximate)
        const cityBounds = {
            'Lusaka': [27.8, -15.8, 28.8, -15.2],
            'Ndola': [28.5, -13.1, 28.8, -12.9],
            'Kitwe': [27.9, -13.1, 28.4, -12.7],
            'Kabwe': [28.3, -14.6, 28.6, -14.3],
            'Livingstone': [25.7, -18.0, 26.0, -17.7],
            'Chipata': [32.5, -13.8, 32.8, -13.6],
            'Chingola': [27.8, -12.8, 27.9, -12.4],
            'Mufulira': [28.1, -12.7, 28.3, -12.5],
            'Luanshya': [28.3, -13.2, 28.5, -13.0],
            'Kasama': [31.1, -10.3, 31.3, -10.1],
            'Solwezi': [26.3, -12.3, 26.5, -12.1],
            'Mazabuka': [27.7, -15.9, 27.9, -15.7]
        };
        
        const bounds = cityBounds[cityName];
        if (bounds) {
            this.cityBoundsCache.set(cityName, bounds);
            AppState.locationManagement.cityBounds = bounds;
            console.log(`City bounds for ${cityName}: ${bounds}`);
        }
        
        return bounds;
    },
    
    processSearchResults(data, targetCity, userLocation, type) {
        if (!data || data.length === 0) return [];
        
        const targetCityLower = targetCity.toLowerCase();
        const processedResults = [];
        
        for (const place of data) {
            try {
                const address = place.address || {};
                
                // Extract place city
                const placeCity = address.city || address.town || address.village || address.municipality;
                const placeCityLower = placeCity ? placeCity.toLowerCase() : '';
                
                // Filter by city
                if (targetCity && !this.isInCity(place, targetCityLower, placeCityLower)) {
                    continue;
                }
                
                // Calculate distance if user location provided
                let distance = 0;
                if (userLocation) {
                    distance = AdvancedCityDetector.calculateDistance(
                        userLocation.lat, userLocation.lng,
                        parseFloat(place.lat), parseFloat(place.lon)
                    );
                }
                
                // Format address for display
                const displayAddress = this.formatAddress(place, targetCity);
                
                // Create result object
                const result = {
                    id: place.place_id || `${place.lat}-${place.lon}`,
                    name: place.display_name.split(',')[0] || 'Location',
                    address: displayAddress,
                    fullAddress: place.display_name,
                    lat: parseFloat(place.lat),
                    lng: parseFloat(place.lon),
                    type: place.type || place.class || 'unknown',
                    category: this.categorizePlace(place),
                    distance: distance,
                    city: placeCity || targetCity,
                    importance: place.importance || 0,
                    relevance: this.calculateRelevance(place, userLocation, targetCity, type),
                    boundingbox: place.boundingbox,
                    isVerified: this.isVerifiedLocation(place)
                };
                
                processedResults.push(result);
            } catch (error) {
                console.error('Error processing search result:', error);
            }
        }
        
        // Sort results by relevance and distance
        return processedResults
            .sort((a, b) => {
                // Prioritize verified locations
                if (a.isVerified !== b.isVerified) {
                    return b.isVerified - a.isVerified;
                }
                
                // Sort by relevance
                if (a.relevance !== b.relevance) {
                    return b.relevance - a.relevance;
                }
                
                // Sort by distance if user location available
                if (userLocation && a.distance !== b.distance) {
                    return a.distance - b.distance;
                }
                
                // Fall back to importance
                return b.importance - a.importance;
            })
            .slice(0, 10); // Limit to top 10 results
    },
    
    isInCity(place, targetCity, placeCity) {
        if (!targetCity) return true;
        
        // Check if place city matches target city
        if (placeCity && placeCity.includes(targetCity)) {
            return true;
        }
        
        // Check address components
        const address = place.address || {};
        const addressComponents = [
            address.city,
            address.town,
            address.village,
            address.municipality,
            address.county,
            address.state_district,
            address.region
        ].filter(Boolean);
        
        // Check if any address component contains the target city
        return addressComponents.some(component => 
            component.toLowerCase().includes(targetCity)
        );
    },
    
    formatAddress(place, currentCity) {
        const address = place.address || {};
        const parts = [];
        
        // Add house number if available
        if (address.house_number || address.housenumber) {
            parts.push(address.house_number || address.housenumber);
        }
        
        // Add road
        if (address.road) {
            parts.push(address.road);
        }
        
        // Add suburb/neighbourhood
        if (address.suburb || address.neighbourhood) {
            parts.push(address.suburb || address.neighbourhood);
        }
        
        // Add city if different from current city
        if (address.city || address.town) {
            const cityName = address.city || address.town;
            if (cityName.toLowerCase() !== currentCity.toLowerCase()) {
                parts.push(cityName);
            }
        }
        
        // Fallback to first two parts of display name
        if (parts.length === 0) {
            return place.display_name.split(',').slice(0, 2).join(',').trim();
        }
        
        return parts.join(', ');
    },
    
    categorizePlace(place) {
        const type = (place.type || place.class || '').toLowerCase();
        
        if (type.includes('restaurant') || type.includes('cafe') || type.includes('fast_food')) {
            return 'restaurant';
        } else if (type.includes('hotel') || type.includes('motel') || type.includes('guest_house')) {
            return 'hotel';
        } else if (type.includes('mall') || type.includes('supermarket') || type.includes('shop')) {
            return 'shopping';
        } else if (type.includes('bank') || type.includes('atm')) {
            return 'bank';
        } else if (type.includes('hospital') || type.includes('clinic') || type.includes('pharmacy')) {
            return 'medical';
        } else if (type.includes('school') || type.includes('university') || type.includes('college')) {
            return 'education';
        } else if (type.includes('government') || type.includes('office')) {
            return 'government';
        } else {
            return 'other';
        }
    },
    
    isVerifiedLocation(place) {
        const verifiedTypes = [
            'restaurant', 'hotel', 'mall', 'supermarket', 'bank', 'hospital',
            'clinic', 'school', 'university', 'government', 'pharmacy'
        ];
        
        const type = (place.type || place.class || '').toLowerCase();
        return verifiedTypes.some(verifiedType => type.includes(verifiedType));
    },
    
    calculateRelevance(place, userLocation, city, type) {
        let score = place.importance || 0;
        
        // Boost if in target city
        if (city) {
            const address = place.address || {};
            const placeCity = address.city || address.town || address.village;
            if (placeCity && placeCity.toLowerCase().includes(city.toLowerCase())) {
                score += 0.4;
            }
        }
        
        // Boost if close to user
        if (userLocation) {
            const distance = AdvancedCityDetector.calculateDistance(
                userLocation.lat, userLocation.lng,
                parseFloat(place.lat), parseFloat(place.lon)
            );
            
            if (distance < 1) score += 0.3;
            else if (distance < 3) score += 0.2;
            else if (distance < 5) score += 0.1;
        }
        
        // Boost if matches recent search
        if (place.display_name.split(',')[0].toLowerCase() === 
            AppState.lastSearchQuery?.toLowerCase()) {
            score += 0.5;
        }
        
        // Boost destination-specific types
        if (type === 'destination') {
            if (place.type === 'restaurant' || place.type === 'hotel' || 
                place.type === 'mall' || place.type === 'supermarket') {
                score += 0.2;
            }
        }
        
        return Math.min(score, 1.0);
    },
    
    async fallbackSearch(query, type, city, userLocation) {
        console.log('Using fallback search');
        
        try {
            // Try broader search without city constraint
            const searchUrl = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}+Zambia&format=json&limit=10`;
            const response = await fetch(searchUrl);
            const data = await response.json();
            
            return data.map(place => ({
                id: place.place_id,
                name: place.display_name.split(',')[0],
                address: place.display_name.split(',').slice(0, 2).join(',').trim(),
                lat: parseFloat(place.lat),
                lng: parseFloat(place.lon),
                distance: userLocation ? 
                    AdvancedCityDetector.calculateDistance(
                        userLocation.lat, userLocation.lng,
                        parseFloat(place.lat), parseFloat(place.lon)
                    ) : 0
            }));
        } catch (error) {
            console.error('Fallback search error:', error);
            return [];
        }
    },
    
    showSearchLoading(show) {
        const loadingElement = document.getElementById('searchLoading');
        if (loadingElement) {
            loadingElement.style.display = show ? 'flex' : 'none';
        }
    },
    
    addToSearchHistory(query, location, type) {
        const historyItem = {
            query: query,
            location: location,
            type: type,
            timestamp: Date.now(),
            city: AppState.currentCity
        };
        
        // Load existing history
        let history = [];
        try {
            const saved = localStorage.getItem('jubel_search_history');
            if (saved) {
                history = JSON.parse(saved);
            }
        } catch (error) {
            console.error('Error loading search history:', error);
        }
        
        // Remove duplicates
        history = history.filter(item => 
            !(item.query === query && item.type === type && item.city === AppState.currentCity)
        );
        
        // Add new item
        history.unshift(historyItem);
        
        // Limit history size
        if (history.length > 15) {
            history = history.slice(0, 15);
        }
        
        // Save history
        try {
            localStorage.setItem('jubel_search_history', JSON.stringify(history));
        } catch (error) {
            console.error('Error saving search history:', error);
        }
        
        AppState.searchHistory = history;
    },
    
    getSearchHistory(type = null) {
        let history = AppState.searchHistory;
        
        if (type) {
            history = history.filter(item => item.type === type);
        }
        
        // Filter by current city
        if (AppState.currentCity) {
            history = history.filter(item => item.city === AppState.currentCity);
        }
        
        return history;
    },
    
    clearSearchCache() {
        this.cache.clear();
        this.cityBoundsCache.clear();
        console.log('Search cache cleared');
    }
};

// ============================================
// ADVANCED PRICE CALCULATOR WITH REAL-TIME UPDATES
// ============================================
const AdvancedPriceCalculator = {
    calculateRideFare(distanceKm, rideType = 'standard', surgeMultiplier = 1.0) {
        const config = AppState.rideTypes[rideType] || AppState.rideTypes.standard;
        
        // Calculate base fare
        let fare = config.base + (distanceKm * config.perKm);
        
        // Apply ride type multiplier
        fare *= config.multiplier;
        
        // Apply surge pricing
        fare *= surgeMultiplier;
        
        // Apply time-based pricing
        fare *= this.getTimeMultiplier();
        
        // Ensure minimum fare
        fare = Math.max(fare, config.min);
        
        // Round to 2 decimal places
        return Math.round(fare * 100) / 100;
    },
    
    getTimeMultiplier() {
        const hour = new Date().getHours();
        const day = new Date().getDay();
        
        // Night premium (10 PM - 5 AM)
        if (hour >= 22 || hour <= 5) {
            return 1.2;
        }
        
        // Rush hour premium (7-9 AM, 4-7 PM on weekdays)
        if (day >= 1 && day <= 5) {
            if ((hour >= 7 && hour <= 9) || (hour >= 16 && hour <= 19)) {
                return 1.3;
            }
        }
        
        // Weekend premium (Friday and Saturday evenings)
        if (day === 5 || day === 6) {
            if (hour >= 18 && hour <= 23) {
                return 1.4;
            }
        }
        
        return 1.0;
    },
    
    getSurgeMultiplier() {
        // Simulate surge pricing based on demand
        const hour = new Date().getHours();
        const randomFactor = 0.9 + Math.random() * 0.3; // 0.9 to 1.2
        
        // Base surge
        let surge = 1.0;
        
        // Peak hours
        if ((hour >= 7 && hour <= 9) || (hour >= 16 && hour <= 19)) {
            surge = 1.3;
        }
        
        // Weekend nights
        const day = new Date().getDay();
        if ((day === 5 || day === 6) && hour >= 20) {
            surge = 1.5;
        }
        
        return surge * randomFactor;
    },
    
    calculateDeliveryFare(distanceKm, deliveryType = 'standard', parcelValue = 0) {
        const config = AppState.deliveryTypes[deliveryType] || AppState.deliveryTypes.standard;
        
        let fare = config.base + (distanceKm * config.perKm);
        fare *= config.multiplier;
        
        // Add insurance for high-value parcels
        if (parcelValue > 500) {
            fare += parcelValue * 0.01; // 1% insurance
        }
        
        // Apply time multiplier
        fare *= this.getTimeMultiplier();
        
        return Math.round(fare * 100) / 100;
    },
    
    calculateTruckFare(distanceKm, truckType = 'light', helpers = false) {
        const config = AppState.truckTypes[truckType] || AppState.truckTypes.light;
        
        let fare = config.base + (distanceKm * config.perKm);
        fare *= config.multiplier;
        
        // Add helper cost
        if (helpers) {
            fare += 50;
        }
        
        // Apply time multiplier
        fare *= this.getTimeMultiplier();
        
        return Math.round(fare * 100) / 100;
    },
    
    calculateShoppingFare(distanceKm, itemsCount = 1, budget = 0) {
        let fare = 30 + (distanceKm * 2.5) + (itemsCount * 5);
        
        // Add shopping service fee (5% of budget)
        if (budget > 0) {
            fare += budget * 0.05;
        }
        
        // Apply time multiplier
        fare *= this.getTimeMultiplier();
        
        return Math.round(fare * 100) / 100;
    },
    
    calculateEmergencyFare(distanceKm, serviceType, surgeMultiplier = 1.0) {
        const config = AppState.emergencyServices[serviceType] || AppState.emergencyServices.police;
        
        let fare = config.base + (distanceKm * config.perKm);
        fare *= config.multiplier;
        fare *= surgeMultiplier;
        fare = Math.max(fare, config.min);
        
        return Math.round(fare * 100) / 100;
    },
    
    calculateShareRideFare(distanceKm, rideType = 'standard', numberOfPeople = 2, splitType = 'equal') {
        const totalFare = this.calculateRideFare(distanceKm, rideType);
        
        switch(splitType) {
            case 'equal':
                return {
                    total: totalFare,
                    perPerson: totalFare / numberOfPeople,
                    yourShare: totalFare / numberOfPeople,
                    othersShare: (totalFare * (numberOfPeople - 1)) / numberOfPeople
                };
                
            case 'you_pay_more':
                const yourShare = totalFare * 0.7;
                const othersShare = totalFare * 0.3;
                return {
                    total: totalFare,
                    perPerson: othersShare,
                    yourShare: yourShare,
                    othersShare: othersShare
                };
                
            case 'you_pay_all':
                return {
                    total: totalFare,
                    perPerson: 0,
                    yourShare: totalFare,
                    othersShare: 0
                };
                
            default:
                return this.calculateShareRideFare(distanceKm, rideType, numberOfPeople, 'equal');
        }
    },
    
    getFareBreakdown(distanceKm, rideType = 'standard') {
        const config = AppState.rideTypes[rideType];
        const surge = this.getSurgeMultiplier();
        const timeMultiplier = this.getTimeMultiplier();
        
        const baseFare = config.base;
        const distanceFare = distanceKm * config.perKm;
        const rideTypeMultiplier = config.multiplier;
        
        const subtotal = (baseFare + distanceFare) * rideTypeMultiplier;
        const surgeAmount = subtotal * (surge - 1);
        const timeAmount = subtotal * (timeMultiplier - 1);
        const total = subtotal * surge * timeMultiplier;
        
        return {
            baseFare: baseFare,
            distanceFare: distanceFare,
            rideTypeMultiplier: rideTypeMultiplier,
            surgeMultiplier: surge,
            timeMultiplier: timeMultiplier,
            surgeAmount: surgeAmount,
            timeAmount: timeAmount,
            subtotal: subtotal,
            total: Math.max(total, config.min)
        };
    },
    
    applyReferralDiscount(fare) {
        if (AppState.referralDiscountApplied) {
            const discount = fare * 0.5;
            return {
                originalFare: fare,
                discount: discount,
                finalFare: fare - discount,
                discountApplied: true
            };
        }
        return {
            originalFare: fare,
            discount: 0,
            finalFare: fare,
            discountApplied: false
        };
    },
    
    estimateTravelTime(distanceKm, rideType = 'standard') {
        const baseSpeed = rideType === 'premium' ? 45 : 35; // km/h
        const trafficFactor = this.getTrafficFactor();
        
        let baseTime = (distanceKm / baseSpeed) * 60; // Convert to minutes
        
        // Apply traffic factor
        baseTime *= trafficFactor;
        
        // Add buffer time
        if (rideType === 'premium') {
            baseTime += 2; // Premium gets priority
        } else {
            baseTime += 5; // Standard buffer
        }
        
        return Math.ceil(baseTime);
    },
    
    getTrafficFactor() {
        const hour = new Date().getHours();
        const day = new Date().getDay();
        
        // Weekday rush hours
        if (day >= 1 && day <= 5) {
            if ((hour >= 7 && hour <= 9) || (hour >= 16 && hour <= 19)) {
                return 1.5;
            }
        }
        
        // Weekend traffic
        if (day === 0 || day === 6) {
            if (hour >= 11 && hour <= 16) {
                return 1.3;
            }
        }
        
        return 1.0;
    }
};

// ============================================
// ENHANCED UI UPDATER WITH REAL-TIME FEATURES
// ============================================
const EnhancedUIUpdater = {
    // Update wallet balance display
    updateWalletBalance(balance) {
        const formatted = `ZMW ${balance.toFixed(2)}`;
        
        // Update all wallet balance displays
        const walletElements = [
            'walletBalance',
            'accountBalance',
            'paymentBalance',
            'transferBalance'
        ];
        
        walletElements.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = formatted;
            }
        });
        
        AppState.walletBalance = balance;
    },
    
    // Update user information
    updateUserInfo(userData) {
        if (userData.name) {
            const userFullName = document.getElementById('userFullName');
            const accountName = document.getElementById('accountName');
            if (userFullName) userFullName.textContent = userData.name;
            if (accountName) accountName.textContent = userData.name;
        }
        
        if (userData.phone) {
            const accountPhone = document.getElementById('accountPhone');
            if (accountPhone) accountPhone.textContent = userData.phone;
        }
        
        if (userData.email) {
            const updateEmail = document.getElementById('updateEmail');
            if (updateEmail) updateEmail.value = userData.email;
        }
        
        if (userData.referralCode) {
            const referralCode = document.getElementById('referralCode');
            if (referralCode) referralCode.textContent = userData.referralCode;
        }
    },
    
    // Show toast notifications
    showToast(message, type = 'info', duration = 5000) {
        const toastContainer = document.getElementById('toastContainer');
        if (!toastContainer) return;
        
        const toastId = 'toast-' + Date.now();
        const icons = {
            success: 'fa-check-circle',
            error: 'fa-exclamation-circle',
            warning: 'fa-exclamation-triangle',
            info: 'fa-info-circle'
        };
        
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.id = toastId;
        toast.innerHTML = `
            <div class="toast-icon">
                <i class="fas ${icons[type] || icons.info}"></i>
            </div>
            <div class="toast-content">
                <div class="toast-title">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
                <div class="toast-message">${message}</div>
            </div>
            <button class="toast-close" onclick="this.parentElement.remove()">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        toastContainer.appendChild(toast);
        
        // Auto-remove after duration
        setTimeout(() => {
            if (toast.parentNode) {
                toast.remove();
            }
        }, duration);
        
        return toastId;
    },
    
    // Show/hide loading overlay
    showLoading(message = 'Loading...') {
        const overlay = document.getElementById('loadingOverlay');
        const text = document.getElementById('loadingText');
        if (overlay && text) {
            text.textContent = message;
            overlay.style.display = 'flex';
        }
    },
    
    hideLoading() {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
            overlay.style.display = 'none';
        }
    },
    
    // Update city display
    updateCityDisplay(city) {
        const display = document.getElementById('currentCityDisplay');
        if (display && city) {
            display.textContent = `City: ${city}`;
            display.parentElement.style.display = 'flex';
            
            // Hide after 5 seconds
            setTimeout(() => {
                if (display.parentElement) {
                    display.parentElement.style.display = 'none';
                }
            }, 5000);
        }
    },
    
    // Update ride prices when destination is set
    updateRidePrices(distanceKm) {
        if (!AppState.pickup || !AppState.destination) return;
        
        // Update ride type cards
        const rideTypeContainer = document.getElementById('rideTypeCardsContainer');
        if (rideTypeContainer) {
            rideTypeContainer.innerHTML = '';
            
            Object.entries(AppState.rideTypes).forEach(([type, config]) => {
                const surge = AdvancedPriceCalculator.getSurgeMultiplier();
                const price = AdvancedPriceCalculator.calculateRideFare(distanceKm, type, surge);
                const time = AdvancedPriceCalculator.estimateTravelTime(distanceKm, type);
                
                const card = document.createElement('div');
                card.className = `ride-type-card ${type} ${AppState.selectedRideType === type ? 'selected' : ''}`;
                card.dataset.type = type;
                card.innerHTML = `
                    <div class="ride-type-icon">
                        <i class="fas ${config.icon}"></i>
                    </div>
                    <div class="ride-type-name">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
                    <div class="ride-type-price">ZMW ${price.toFixed(2)}</div>
                    <div class="ride-type-time">${time} min</div>
                `;
                
                card.addEventListener('click', () => {
                    this.selectRideType(type, distanceKm);
                });
                
                rideTypeContainer.appendChild(card);
            });
        }
        
        // Update estimated fare display
        this.updateEstimatedFare(distanceKm);
    },
    
    selectRideType(type, distanceKm) {
        AppState.selectedRideType = type;
        
        // Update UI
        document.querySelectorAll('.ride-type-card').forEach(card => {
            card.classList.remove('selected');
        });
        
        const selectedCard = document.querySelector(`.ride-type-card[data-type="${type}"]`);
        if (selectedCard) {
            selectedCard.classList.add('selected');
        }
        
        // Update fare display
        this.updateEstimatedFare(distanceKm);
    },
    
    updateEstimatedFare(distanceKm) {
        const surge = AdvancedPriceCalculator.getSurgeMultiplier();
        const price = AdvancedPriceCalculator.calculateRideFare(distanceKm, AppState.selectedRideType, surge);
        const time = AdvancedPriceCalculator.estimateTravelTime(distanceKm, AppState.selectedRideType);
        
        const estimatedFare = document.getElementById('estimatedFare');
        const distanceDetail = document.getElementById('distanceDetail');
        const timeDetail = document.getElementById('timeDetail');
        
        if (estimatedFare) estimatedFare.textContent = `ZMW ${price.toFixed(2)}`;
        if (distanceDetail) distanceDetail.textContent = `${distanceKm.toFixed(1)} km`;
        if (timeDetail) timeDetail.textContent = `ETA: ${time} min`;
        
        AppState.rideFare = price;
        
        // Show fare display
        const fareDisplay = document.getElementById('fareDisplay');
        if (fareDisplay) fareDisplay.classList.add('active');
    },
    
    // Show search suggestions
    showSearchSuggestions(inputId, results, type = 'destination') {
        const container = document.getElementById(`${inputId}Suggestions`);
        if (!container) {
            console.error(`Suggestions container not found for ${inputId}`);
            return;
        }
        
        container.innerHTML = '';
        
        if (results.length === 0) {
            container.innerHTML = `
                <div class="no-results">
                    <i class="fas fa-search"></i>
                    <div>No results found in ${AppState.currentCity}</div>
                    <div style="font-size: 11px; color: #666; margin-top: 5px;">
                        Try a different search term
                    </div>
                </div>
            `;
        } else {
            results.forEach(result => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.dataset.lat = result.lat;
                item.dataset.lng = result.lng;
                item.dataset.address = result.address;
                item.dataset.name = result.name;
                
                // Determine icon based on category
                let icon = 'fa-map-marker-alt';
                let iconColor = '#FF6B35';
                
                if (result.category === 'restaurant') {
                    icon = 'fa-utensils';
                    iconColor = '#FFC107';
                } else if (result.category === 'hotel') {
                    icon = 'fa-hotel';
                    iconColor = '#2196F3';
                } else if (result.category === 'shopping') {
                    icon = 'fa-shopping-cart';
                    iconColor = '#9C27B0';
                } else if (result.category === 'medical') {
                    icon = 'fa-hospital';
                    iconColor = '#F44336';
                } else if (result.isVerified) {
                    icon = 'fa-check-circle';
                    iconColor = '#4CAF50';
                }
                
                item.innerHTML = `
                    <div class="suggestion-icon" style="color: ${iconColor}">
                        <i class="fas ${icon}"></i>
                    </div>
                    <div class="suggestion-details">
                        <div class="suggestion-name">${result.name}</div>
                        <div class="suggestion-address">${result.address}</div>
                        ${result.distance ? `<div class="suggestion-distance">${result.distance.toFixed(1)} km away</div>` : ''}
                    </div>
                `;
                
                item.addEventListener('click', () => {
                    this.selectLocation(inputId, result, type);
                });
                
                container.appendChild(item);
            });
        }
        
        container.style.display = 'block';
        
        // Position suggestions below input
        const input = document.getElementById(inputId);
        if (input) {
            const rect = input.getBoundingClientRect();
            container.style.top = `${rect.bottom + window.scrollY + 5}px`;
            container.style.left = `${rect.left + window.scrollX}px`;
            container.style.width = `${rect.width}px`;
        }
    },
    
    selectLocation(inputId, location, type) {
        const input = document.getElementById(inputId);
        if (input) {
            input.value = location.address;
            
            // Store location data
            if (type === 'pickup') {
                AppState.pickup = location;
                this.updatePickupMarker(location);
            } else {
                AppState.destination = location;
                this.updateDestinationMarker(location);
            }
            
            // Hide suggestions
            const suggestions = document.getElementById(`${inputId}Suggestions`);
            if (suggestions) {
                suggestions.style.display = 'none';
            }
            
            // Draw route if both locations are set
            if (AppState.pickup && AppState.destination) {
                this.drawRoute();
                this.calculateAndUpdatePrices();
            }
        }
    },
    
    // Map functions
    updatePickupMarker(location) {
        if (!window.map) return;
        
        if (window.pickupMarker) {
            window.map.removeLayer(window.pickupMarker);
        }
        
        window.pickupMarker = L.marker([location.lat, location.lng], {
            icon: L.divIcon({
                className: 'pickup-marker',
                html: '<i class="fas fa-map-marker-alt"></i>',
                iconSize: [30, 30],
                iconAnchor: [15, 30]
            })
        }).addTo(window.map).bindPopup('Pickup Location');
    },
    
    updateDestinationMarker(location) {
        if (!window.map) return;
        
        if (window.destinationMarker) {
            window.map.removeLayer(window.destinationMarker);
        }
        
        window.destinationMarker = L.marker([location.lat, location.lng], {
            icon: L.divIcon({
                className: 'destination-marker',
                html: '<i class="fas fa-flag"></i>',
                iconSize: [30, 30],
                iconAnchor: [15, 30]
            })
        }).addTo(window.map).bindPopup('Destination');
    },
    
    async drawRoute() {
        if (!window.map || !AppState.pickup || !AppState.destination) return;
        
        // Clear existing route
        if (window.routeLayer) {
            window.map.removeLayer(window.routeLayer);
            window.routeLayer = null;
        }
        
        try {
            // Use OSRM routing
            const response = await fetch(
                `https://router.project-osrm.org/route/v1/driving/${AppState.pickup.lng},${AppState.pickup.lat};${AppState.destination.lng},${AppState.destination.lat}?overview=full&geometries=geojson`
            );
            
            if (response.ok) {
                const data = await response.json();
                
                if (data.routes && data.routes.length > 0) {
                    const route = data.routes[0];
                    const coordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                    
                    window.routeLayer = L.polyline(coordinates, {
                        color: '#FF6B35',
                        weight: 4,
                        opacity: 0.7,
                        lineJoin: 'round'
                    }).addTo(window.map);
                    
                    // Fit map to route bounds
                    const bounds = L.latLngBounds(coordinates);
                    window.map.fitBounds(bounds, { padding: [50, 50] });
                    
                    // Store route distance
                    const distance = route.distance / 1000; // Convert to km
                    AppState.activeRoute = {
                        distance: distance,
                        duration: route.duration / 60, // Convert to minutes
                        coordinates: coordinates
                    };
                    
                    return distance;
                }
            }
        } catch (error) {
            console.error('Routing error:', error);
            
            // Fallback: draw straight line
            window.routeLayer = L.polyline([
                [AppState.pickup.lat, AppState.pickup.lng],
                [AppState.destination.lat, AppState.destination.lng]
            ], {
                color: '#FF6B35',
                weight: 3,
                opacity: 0.5,
                dashArray: '10, 10'
            }).addTo(window.map);
            
            // Calculate straight-line distance
            const distance = AdvancedCityDetector.calculateDistance(
                AppState.pickup.lat, AppState.pickup.lng,
                AppState.destination.lat, AppState.destination.lng
            );
            
            AppState.activeRoute = {
                distance: distance,
                duration: AdvancedPriceCalculator.estimateTravelTime(distance),
                coordinates: []
            };
            
            return distance;
        }
    },
    
    calculateAndUpdatePrices() {
        if (!AppState.pickup || !AppState.destination) return;
        
        // Calculate distance
        const distance = AdvancedCityDetector.calculateDistance(
            AppState.pickup.lat, AppState.pickup.lng,
            AppState.destination.lat, AppState.destination.lng
        );
        
        // Update prices based on active service
        switch(AppState.activeService) {
            case 'car':
                this.updateRidePrices(distance);
                break;
            case 'delivery':
                this.updateDeliveryPrices(distance);
                break;
            case 'truck':
                this.updateTruckPrices(distance);
                break;
            case 'express':
                this.updateShoppingPrices(distance);
                break;
            case 'short-delivery':
                this.updateShortDeliveryPrices(distance);
                break;
        }
    },
    
    updateDeliveryPrices(distanceKm) {
        const deliveryType = document.querySelector('.filter-btn.active')?.id || 'standardDelivery';
        const parcelValue = parseFloat(document.getElementById('parcelValue')?.value) || 0;
        
        const fare = AdvancedPriceCalculator.calculateDeliveryFare(distanceKm, deliveryType, parcelValue);
        const time = AdvancedPriceCalculator.estimateTravelTime(distanceKm);
        
        this.updateServiceFareDisplay('delivery', fare, distanceKm, time);
    },
    
    updateTruckPrices(distanceKm) {
        const truckType = document.querySelector('.truck-type.selected')?.dataset.type || 'light';
        const helpers = document.getElementById('needHelpers')?.checked || false;
        
        const fare = AdvancedPriceCalculator.calculateTruckFare(distanceKm, truckType, helpers);
        const time = AdvancedPriceCalculator.estimateTravelTime(distanceKm);
        
        this.updateServiceFareDisplay('truck', fare, distanceKm, time);
    },
    
    updateShoppingPrices(distanceKm) {
        const itemsCount = document.querySelectorAll('.item-entry').length;
        const budget = parseFloat(document.getElementById('shoppingBudget')?.value) || 0;
        
        const fare = AdvancedPriceCalculator.calculateShoppingFare(distanceKm, itemsCount, budget);
        const time = AdvancedPriceCalculator.estimateTravelTime(distanceKm) + 30; // Add shopping time
        
        this.updateServiceFareDisplay('shopping', fare, distanceKm, time);
    },
    
    updateShortDeliveryPrices(distanceKm) {
        const fare = Math.max(15, distanceKm * 2.5);
        const time = AdvancedPriceCalculator.estimateTravelTime(distanceKm);
        
        this.updateServiceFareDisplay('shortDelivery', fare, distanceKm, time);
    },
    
    updateServiceFareDisplay(service, fare, distance, time) {
        const display = document.getElementById(`${service}FareDisplay`);
        const fareElement = document.getElementById(`${service}Fare`);
        const distanceElement = document.getElementById(`${service}Distance`);
        const timeElement = document.getElementById(`${service}Time`);
        
        if (display) display.style.display = 'block';
        if (fareElement) fareElement.textContent = `ZMW ${fare.toFixed(2)}`;
        if (distanceElement) distanceElement.textContent = `${distance.toFixed(1)} km`;
        if (timeElement) timeElement.textContent = `ETA: ${time} min`;
        
        AppState.rideFare = fare;
    },
    
    // Show ride info panel
    showRideInfo(ride) {
        // Hide all forms
        document.querySelectorAll('.ride-request-form, .service-form, #broadcastForm').forEach(form => {
            form.style.display = 'none';
        });
        
        // Show ride info panel
        const rideInfoPanel = document.getElementById('rideInfoPanel');
        if (rideInfoPanel) {
            rideInfoPanel.style.display = 'block';
            
            // Update ride info
            const currentPickup = document.getElementById('currentPickup');
            const currentDestination = document.getElementById('currentDestination');
            const rideDistance = document.getElementById('rideDistance');
            const rideTime = document.getElementById('rideTime');
            
            if (currentPickup) currentPickup.textContent = ride.pickupDisplay || ride.pickup || 'Loading...';
            if (currentDestination) currentDestination.textContent = ride.destinationDisplay || ride.destination || 'Loading...';
            if (rideDistance) rideDistance.textContent = ride.distance ? `${ride.distance.toFixed(1)} km` : '0 km';
            if (rideTime) rideTime.textContent = ride.estimatedTime ? `${ride.estimatedTime} min` : '0 min';
            
            // Update fare breakdown
            if (ride.fare) {
                const totalFareValue = document.getElementById('totalFareValue');
                if (totalFareValue) totalFareValue.textContent = `ZMW ${ride.fare.toFixed(2)}`;
            }
            
            // Update ride status
            this.updateRideStatus(ride.status);
        }
    },
    
    updateRideStatus(status) {
        const statusBar = document.getElementById('rideStatusBar');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const etaText = document.getElementById('etaText');
        
        if (!statusBar || !statusDot || !statusText || !etaText) return;
        
        statusBar.classList.add('active');
        
        switch(status) {
            case 'requested':
                statusDot.className = 'status-dot searching';
                statusText.textContent = 'Searching for driver';
                etaText.textContent = '5-10 min';
                
                // Show pulsing icon
                this.showPulsingIcon();
                break;
                
            case 'accepted':
                statusDot.className = 'status-dot arriving';
                statusText.textContent = 'Driver on the way';
                etaText.textContent = '5 min';
                break;
                
            case 'arrived':
                statusDot.className = 'status-dot riding';
                statusText.textContent = 'Driver arrived';
                etaText.textContent = '0 min';
                break;
                
            case 'started':
                statusDot.className = 'status-dot riding';
                statusText.textContent = 'Trip in progress';
                etaText.textContent = 'En route';
                break;
                
            case 'completed':
            case 'cancelled':
                statusBar.classList.remove('active');
                this.removePulsingIcon();
                break;
        }
    },
    
    showPulsingIcon() {
        this.removePulsingIcon();
        
        // Determine icon based on service type
        let iconClass = 'fa-car';
        if (AppState.activeService === 'truck') iconClass = 'fa-truck';
        else if (AppState.activeService === 'delivery' || AppState.activeService === 'short-delivery') 
            iconClass = 'fa-shipping-fast';
        else if (AppState.activeService === 'express') iconClass = 'fa-shopping-bag';
        
        // Create pulsing icon
        const pulsingIcon = document.createElement('div');
        pulsingIcon.id = 'pulsingRideIcon';
        pulsingIcon.className = 'pulsing-ride-icon';
        pulsingIcon.innerHTML = `<i class="fas ${iconClass}"></i>`;
        pulsingIcon.style.cssText = `
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 60px;
            color: #FF6B35;
            z-index: 1000;
            animation: pulse 1.5s infinite;
            pointer-events: none;
        `;
        
        const mapContainer = document.getElementById('map');
        if (mapContainer) {
            mapContainer.appendChild(pulsingIcon);
        }
        
        // Store reference
        AppState.rideRequestPulsingIcons[AppState.activeService] = pulsingIcon;
    },
    
    removePulsingIcon() {
        const pulsingIcon = document.getElementById('pulsingRideIcon');
        if (pulsingIcon) {
            pulsingIcon.remove();
        }
    },
    
    // Show payment modal with referral option
    showPaymentModal(rideData) {
        // Store ride data
        window.pendingRideData = rideData;
        
        // Update payment modal
        const paymentAmount = document.getElementById('paymentAmount');
        if (paymentAmount) {
            paymentAmount.textContent = `ZMW ${rideData.fare.toFixed(2)}`;
        }
        
        // Show referral discount section
        const referralSection = document.getElementById('referralDiscountSection');
        if (referralSection) {
            referralSection.style.display = 'block';
        }
        
        // Show modal
        const paymentModal = document.getElementById('paymentModal');
        if (paymentModal) {
            paymentModal.style.display = 'block';
        }
    },
    
    // Apply referral discount
    applyReferralDiscount() {
        const referralCodeInput = document.getElementById('referralCodeInput');
        if (!referralCodeInput) return;
        
        const referralCode = referralCodeInput.value.trim();
        if (!referralCode) {
            this.showToast('Please enter a referral code', 'warning');
            return;
        }
        
        // Validate referral code (simulated - implement actual Firebase check)
        EnhancedFirebaseManager.validateReferralCode(referralCode)
            .then(result => {
                if (result.valid) {
                    AppState.referralDiscountApplied = true;
                    AppState.referralCodeUsed = referralCode;
                    AppState.referralOwnerName = result.ownerName;
                    
                    // Calculate discount
                    const originalFare = AppState.rideFare;
                    const discount = originalFare * 0.5;
                    const finalFare = originalFare - discount;
                    
                    // Update UI
                    const originalFareAmount = document.getElementById('originalFareAmount');
                    const discountAmount = document.getElementById('discountAmount');
                    const finalFareAmount = document.getElementById('finalFareAmount');
                    const paymentAmount = document.getElementById('paymentAmount');
                    
                    if (originalFareAmount) originalFareAmount.textContent = `ZMW ${originalFare.toFixed(2)}`;
                    if (discountAmount) discountAmount.textContent = `-ZMW ${discount.toFixed(2)}`;
                    if (finalFareAmount) finalFareAmount.textContent = `ZMW ${finalFare.toFixed(2)}`;
                    if (paymentAmount) paymentAmount.textContent = `ZMW ${finalFare.toFixed(2)}`;
                    
                    // Update ride fare
                    AppState.rideFare = finalFare;
                    
                    // Show success message
                    this.showToast(`50% discount applied! Referral from ${result.ownerName}`, 'success');
                    
                    // Hide referral input, show applied section
                    const referralInputSection = document.getElementById('referralInputSection');
                    const referralAppliedSection = document.getElementById('referralAppliedSection');
                    
                    if (referralInputSection) referralInputSection.style.display = 'none';
                    if (referralAppliedSection) {
                        referralAppliedSection.style.display = 'block';
                        const referrerInfo = document.getElementById('referrerInfo');
                        if (referrerInfo) referrerInfo.textContent = result.ownerName;
                    }
                } else {
                    this.showToast('Invalid referral code', 'error');
                }
            })
            .catch(error => {
                console.error('Referral validation error:', error);
                this.showToast('Error validating referral code', 'error');
            });
    },
    
    // Remove referral discount
    removeReferralDiscount() {
        AppState.referralDiscountApplied = false;
        AppState.referralCodeUsed = null;
        AppState.referralOwnerName = null;
        
        // Restore original fare
        const originalFare = AppState.rideFare * 2; // Since it was 50% off
        AppState.rideFare = originalFare;
        
        // Update UI
        const paymentAmount = document.getElementById('paymentAmount');
        if (paymentAmount) paymentAmount.textContent = `ZMW ${originalFare.toFixed(2)}`;
        
        // Show referral input, hide applied section
        const referralInputSection = document.getElementById('referralInputSection');
        const referralAppliedSection = document.getElementById('referralAppliedSection');
        
        if (referralInputSection) {
            referralInputSection.style.display = 'block';
            const referralCodeInput = document.getElementById('referralCodeInput');
            if (referralCodeInput) referralCodeInput.value = '';
        }
        if (referralAppliedSection) referralAppliedSection.style.display = 'none';
        
        this.showToast('Referral discount removed', 'info');
    },
    
    // Show emergency stations
    showEmergencyStations(stations, type) {
        const container = document.getElementById('emergencyStations');
        if (!container) return;
        
        container.innerHTML = '';
        
        if (stations.length === 0) {
            container.innerHTML = '<div class="no-results">No stations found in your area</div>';
            return;
        }
        
        stations.forEach((station, index) => {
            const stationElement = document.createElement('div');
            stationElement.className = 'emergency-station';
            if (index === 0) stationElement.classList.add('selected');
            
            stationElement.dataset.stationId = station.id;
            stationElement.dataset.lat = station.lat;
            stationElement.dataset.lng = station.lng;
            
            stationElement.innerHTML = `
                <div class="station-header">
                    <div class="station-name">${station.name}</div>
                    <div class="station-distance">${station.distance.toFixed(1)} km</div>
                </div>
                <div class="station-address">${station.address}</div>
                <div class="station-price">ZMW ${station.price.toFixed(2)}</div>
            `;
            
            stationElement.addEventListener('click', () => {
                // Select station
                document.querySelectorAll('.emergency-station').forEach(s => {
                    s.classList.remove('selected');
                });
                stationElement.classList.add('selected');
                
                // Update selected station
                AppState.selectedEmergencyStation = station;
                
                // Update fare display
                this.updateEmergencyFare(station.distance, type);
            });
            
            container.appendChild(stationElement);
        });
        
        // Select first station by default
        if (stations.length > 0) {
            AppState.selectedEmergencyStation = stations[0];
            this.updateEmergencyFare(stations[0].distance, type);
        }
    },
    
    updateEmergencyFare(distanceKm, type) {
        const fare = AdvancedPriceCalculator.calculateEmergencyFare(distanceKm, type);
        const time = AdvancedPriceCalculator.estimateTravelTime(distanceKm);
        
        const emergencyDistance = document.getElementById('emergencyDistance');
        const emergencyTime = document.getElementById('emergencyTime');
        const emergencyTotalFare = document.getElementById('emergencyTotalFare');
        
        if (emergencyDistance) emergencyDistance.textContent = `${distanceKm.toFixed(1)} km`;
        if (emergencyTime) emergencyTime.textContent = `${time} min`;
        if (emergencyTotalFare) emergencyTotalFare.textContent = `ZMW ${fare.toFixed(2)}`;
    },
    
    // Show schedule countdown
    showScheduleCountdown(scheduledTime) {
        const now = Date.now();
        const timeLeft = scheduledTime - now;
        
        if (timeLeft <= 0) {
            // Time's up - request the ride
            this.requestScheduledRide();
            return;
        }
        
        // Create countdown display
        let countdownContainer = document.getElementById('scheduleCountdown');
        if (!countdownContainer) {
            countdownContainer = document.createElement('div');
            countdownContainer.id = 'scheduleCountdown';
            countdownContainer.className = 'schedule-countdown';
            
            const mainPanel = document.getElementById('mainPanel');
            if (mainPanel) {
                mainPanel.appendChild(countdownContainer);
            }
        }
        
        // Calculate time units
        const hours = Math.floor(timeLeft / (1000 * 60 * 60));
        const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
        
        countdownContainer.innerHTML = `
            <div class="countdown-header">
                <i class="fas fa-clock"></i>
                <span>Scheduled Ride Countdown</span>
            </div>
            <div class="countdown-timer">
                <div class="time-unit">
                    <div class="time-value">${hours.toString().padStart(2, '0')}</div>
                    <div class="time-label">Hours</div>
                </div>
                <div class="time-separator">:</div>
                <div class="time-unit">
                    <div class="time-value">${minutes.toString().padStart(2, '0')}</div>
                    <div class="time-label">Minutes</div>
                </div>
                <div class="time-separator">:</div>
                <div class="time-unit">
                    <div class="time-value">${seconds.toString().padStart(2, '0')}</div>
                    <div class="time-label">Seconds</div>
                </div>
            </div>
            <button id="cancelScheduleBtn" class="btn btn-danger">
                <i class="fas fa-times"></i> Cancel Schedule
            </button>
        `;
        
        // Set up cancel button
        const cancelBtn = document.getElementById('cancelScheduleBtn');
        if (cancelBtn) {
            cancelBtn.onclick = () => {
                this.cancelScheduledRide();
            };
        }
        
        // Update countdown every second
        if (AppState.activeScheduledTimer) {
            clearInterval(AppState.activeScheduledTimer);
        }
        
        AppState.activeScheduledTimer = setInterval(() => {
            const newTimeLeft = scheduledTime - Date.now();
            if (newTimeLeft <= 0) {
                clearInterval(AppState.activeScheduledTimer);
                this.requestScheduledRide();
            } else {
                this.updateCountdownTimer(newTimeLeft);
            }
        }, 1000);
    },
    
    updateCountdownTimer(timeLeft) {
        const hours = Math.floor(timeLeft / (1000 * 60 * 60));
        const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
        
        const hoursElement = document.getElementById('scheduleCountdown')?.querySelector('.time-unit:nth-child(1) .time-value');
        const minutesElement = document.getElementById('scheduleCountdown')?.querySelector('.time-unit:nth-child(3) .time-value');
        const secondsElement = document.getElementById('scheduleCountdown')?.querySelector('.time-unit:nth-child(5) .time-value');
        
        if (hoursElement) hoursElement.textContent = hours.toString().padStart(2, '0');
        if (minutesElement) minutesElement.textContent = minutes.toString().padStart(2, '0');
        if (secondsElement) secondsElement.textContent = seconds.toString().padStart(2, '0');
    },
    
    requestScheduledRide() {
        // Find the scheduled ride
        const scheduledRide = AppState.scheduledRides.find(ride => 
            ride.status === 'scheduled' && ride.scheduledTime <= Date.now()
        );
        
        if (scheduledRide) {
            this.showToast('Requesting your scheduled ride...', 'info');
            
            // Request the ride
            EnhancedFirebaseManager.requestScheduledRide(scheduledRide)
                .then(() => {
                    this.hideScheduleCountdown();
                })
                .catch(error => {
                    console.error('Error requesting scheduled ride:', error);
                    this.showToast('Error requesting scheduled ride', 'error');
                });
        }
    },
    
    cancelScheduledRide() {
        if (confirm('Are you sure you want to cancel this scheduled ride?')) {
            // Clear timer
            if (AppState.activeScheduledTimer) {
                clearInterval(AppState.activeScheduledTimer);
                AppState.activeScheduledTimer = null;
            }
            
            // Hide countdown
            this.hideScheduleCountdown();
            
            // Cancel in database
            EnhancedFirebaseManager.cancelScheduledRide()
                .then(() => {
                    this.showToast('Scheduled ride cancelled', 'success');
                })
                .catch(error => {
                    console.error('Error cancelling scheduled ride:', error);
                    this.showToast('Error cancelling scheduled ride', 'error');
                });
        }
    },
    
    hideScheduleCountdown() {
        const countdownContainer = document.getElementById('scheduleCountdown');
        if (countdownContainer) {
            countdownContainer.remove();
        }
    },
    
    // Show share ride invitation
    showShareRideInvitation(invitation) {
        const modal = document.getElementById('shareRideInvitationModal');
        if (!modal) return;
        
        // Update invitation details
        const invitationDetails = document.getElementById('invitationDetails');
        if (invitationDetails) {
            invitationDetails.innerHTML = `
                <div class="invitation-header">
                    <div class="invitation-host">
                        <i class="fas fa-user-friends"></i>
                        <span>${invitation.hostName} invited you to share a ride</span>
                    </div>
                </div>
                <div class="invitation-route">
                    <div class="route-point">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>${invitation.pickup}</span>
                    </div>
                    <div class="route-point">
                        <i class="fas fa-flag"></i>
                        <span>${invitation.destination}</span>
                    </div>
                </div>
                <div class="invitation-details">
                    <div class="detail-item">
                        <span>Distance:</span>
                        <span>${invitation.distance.toFixed(1)} km</span>
                    </div>
                    <div class="detail-item">
                        <span>Total Fare:</span>
                        <span>ZMW ${invitation.totalFare.toFixed(2)}</span>
                    </div>
                    <div class="detail-item">
                        <span>Your Share:</span>
                        <span class="highlight">ZMW ${invitation.yourShare.toFixed(2)}</span>
                    </div>
                    <div class="detail-item">
                        <span>Ride Type:</span>
                        <span>${invitation.rideType}</span>
                    </div>
                </div>
            `;
        }
        
        // Set up accept button
        const acceptBtn = document.getElementById('acceptShareInvitationBtn');
        if (acceptBtn) {
            acceptBtn.onclick = () => {
                EnhancedFirebaseManager.acceptShareRideInvitation(invitation.id)
                    .then(() => {
                        modal.style.display = 'none';
                        this.showToast('Ride invitation accepted', 'success');
                    })
                    .catch(error => {
                        console.error('Error accepting invitation:', error);
                        this.showToast('Error accepting invitation', 'error');
                    });
            };
        }
        
        // Set up reject button
        const rejectBtn = document.getElementById('rejectShareInvitationBtn');
        if (rejectBtn) {
            rejectBtn.onclick = () => {
                EnhancedFirebaseManager.rejectShareRideInvitation(invitation.id)
                    .then(() => {
                        modal.style.display = 'none';
                        this.showToast('Ride invitation declined', 'info');
                    })
                    .catch(error => {
                        console.error('Error rejecting invitation:', error);
                        this.showToast('Error rejecting invitation', 'error');
                    });
            };
        }
        
        // Show modal
        modal.style.display = 'block';
    },
    
    // Update share ride calculations
    updateShareRideCalculations() {
        if (!AppState.pickup || !AppState.destination) return;
        
        const distance = AdvancedCityDetector.calculateDistance(
            AppState.pickup.lat, AppState.pickup.lng,
            AppState.destination.lat, AppState.destination.lng
        );
        
        const numberOfPeople = AppState.shareRideFriends.length + 1;
        const calculation = AdvancedPriceCalculator.calculateShareRideFare(
            distance, 
            AppState.selectedRideType, 
            numberOfPeople,
            'equal'
        );
        
        // Update UI
        const shareFareEstimate = document.getElementById('shareFareEstimate');
        const yourShare = document.getElementById('yourShare');
        const friendShare = document.getElementById('friendShare');
        
        if (shareFareEstimate) shareFareEstimate.textContent = `ZMW ${calculation.total.toFixed(2)}`;
        if (yourShare) yourShare.textContent = `ZMW ${calculation.yourShare.toFixed(2)}`;
        if (friendShare) friendShare.textContent = `ZMW ${calculation.perPerson.toFixed(2)}`;
        
        // Update friend list with individual shares
        AppState.shareRideFriends.forEach((friend, index) => {
            const friendElement = document.querySelector(`[data-friend-id="${friend.userId}"]`);
            if (friendElement) {
                const shareElement = friendElement.querySelector('.friend-share');
                if (shareElement) {
                    shareElement.textContent = `ZMW ${calculation.perPerson.toFixed(2)}`;
                }
            }
        });
        
        // Store calculation
        AppState.rideSplitDetails = calculation;
    },
    
    // Show shopping categories
    showShoppingCategories() {
        const container = document.getElementById('shopCategories');
        if (!container) return;
        
        container.innerHTML = '';
        
        Object.entries(AppState.shoppingCategories).forEach(([category, items]) => {
            const categoryElement = document.createElement('div');
            categoryElement.className = 'shopping-category';
            categoryElement.dataset.category = category;
            
            categoryElement.innerHTML = `
                <div class="category-header">
                    <i class="fas fa-${this.getCategoryIcon(category)}"></i>
                    <span>${this.formatCategoryName(category)}</span>
                </div>
                <div class="category-items">
                    ${items.slice(0, 3).map(item => `
                        <div class="category-item" data-item="${item.name}">
                            <i class="fas ${item.icon}"></i>
                            <span>${item.name}</span>
                        </div>
                    `).join('')}
                </div>
            `;
            
            categoryElement.addEventListener('click', () => {
                this.showShoppingPlaces(category, items);
            });
            
            container.appendChild(categoryElement);
        });
    },
    
    getCategoryIcon(category) {
        switch(category) {
            case 'restaurants': return 'utensils';
            case 'pharmacy': return 'prescription-bottle-medical';
            case 'supermarkets': return 'shopping-cart';
            case 'malls': return 'store-alt';
            default: return 'store';
        }
    },
    
    formatCategoryName(category) {
        return category.charAt(0).toUpperCase() + category.slice(1);
    },
    
    async showShoppingPlaces(category, defaultItems) {
        if (!AppState.currentCity) {
            this.showToast('Please wait for city detection', 'warning');
            return;
        }
        
        // Search for places in this category within the city
        const searchPromises = defaultItems.map(item => 
            IntelligentSearchEngine.search(item.name, 'destination', AppState.currentCity, AppState.userLocation)
        );
        
        try {
            const results = await Promise.all(searchPromises);
            const allPlaces = results.flat().filter(place => place);
            
            // Show places in modal
            this.showPlacesModal(allPlaces, category);
        } catch (error) {
            console.error('Error searching shopping places:', error);
            this.showToast('Error loading places', 'error');
        }
    },
    
    showPlacesModal(places, category) {
        const modal = document.getElementById('shoppingPlacesModal');
        if (!modal) return;
        
        const modalContent = modal.querySelector('.modal-content');
        if (modalContent) {
            modalContent.innerHTML = `
                <div class="modal-header">
                    <div class="modal-title">
                        <i class="fas fa-${this.getCategoryIcon(category)}"></i>
                        ${this.formatCategoryName(category)} in ${AppState.currentCity}
                    </div>
                    <button class="modal-close" onclick="document.getElementById('shoppingPlacesModal').style.display='none'">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="places-list">
                    ${places.length > 0 ? places.map(place => `
                        <div class="place-item" data-place='${JSON.stringify(place)}'>
                            <div class="place-icon">
                                <i class="fas fa-${place.category === 'restaurant' ? 'utensils' : 
                                               place.category === 'shopping' ? 'shopping-cart' : 
                                               place.category === 'medical' ? 'hospital' : 
                                               'map-marker-alt'}"></i>
                            </div>
                            <div class="place-details">
                                <div class="place-name">${place.name}</div>
                                <div class="place-address">${place.address}</div>
                                ${place.distance ? `<div class="place-distance">${place.distance.toFixed(1)} km away</div>` : ''}
                            </div>
                        </div>
                    `).join('') : '<div class="no-results">No places found</div>'}
                </div>
            `;
            
            // Add click handlers
            modalContent.querySelectorAll('.place-item').forEach(item => {
                item.addEventListener('click', () => {
                    const place = JSON.parse(item.dataset.place);
                    this.selectShoppingPlace(place, category);
                    modal.style.display = 'none';
                });
            });
        }
        
        modal.style.display = 'block';
    },
    
    selectShoppingPlace(place, category) {
        // Update shop name and location
        const shopNameInput = document.getElementById('shopName');
        const shopLocationInput = document.getElementById('shopLocation');
        
        if (shopNameInput) shopNameInput.value = place.name;
        if (shopLocationInput) shopLocationInput.value = place.address;
        
        // Store place data
        AppState.shoppingPlace = place;
        
        this.showToast(`${place.name} selected`, 'success');
    },
    
    // Update notifications
    updateNotifications(notifications) {
        const container = document.getElementById('notificationsList');
        if (!container) return;
        
        container.innerHTML = '';
        
        if (notifications.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-bell-slash"></i>
                    </div>
                    <div class="empty-title">No notifications</div>
                    <div class="empty-message">You're all caught up!</div>
                </div>
            `;
            return;
        }
        
        notifications.forEach(notification => {
            const item = document.createElement('div');
            item.className = `notification-item ${notification.read ? '' : 'unread'}`;
            item.innerHTML = `
                <div class="notification-header">
                    <div class="notification-title">
                        <i class="fas ${this.getNotificationIcon(notification.type)}"></i>
                        ${notification.title}
                    </div>
                    <div class="notification-time">
                        ${new Date(notification.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                    </div>
                </div>
                <div class="notification-message">
                    ${notification.message}
                </div>
                ${notification.action ? `
                <div class="notification-actions">
                    <button class="notification-action-btn" data-action="${notification.action}">
                        ${notification.actionText || 'View'}
                    </button>
                </div>
                ` : ''}
            `;
            
            if (notification.action) {
                const actionBtn = item.querySelector('.notification-action-btn');
                if (actionBtn) {
                    actionBtn.addEventListener('click', () => {
                        this.handleNotificationAction(notification.action, notification.data);
                    });
                }
            }
            
            container.appendChild(item);
        });
    },
    
    getNotificationIcon(type) {
        switch(type) {
            case 'ride': return 'fa-car';
            case 'payment': return 'fa-credit-card';
            case 'referral': return 'fa-gift';
            case 'share': return 'fa-user-friends';
            case 'broadcast': return 'fa-broadcast-tower';
            case 'emergency': return 'fa-exclamation-triangle';
            default: return 'fa-info-circle';
        }
    },
    
    handleNotificationAction(action, data) {
        switch(action) {
            case 'view_ride':
                if (data.rideId) {
                    EnhancedFirebaseManager.loadRideDetails(data.rideId);
                }
                break;
            case 'accept_share':
                if (data.invitationId) {
                    EnhancedFirebaseManager.acceptShareRideInvitation(data.invitationId);
                }
                break;
            case 'view_payment':
                // Show payment details
                break;
        }
    },
    
    // Update notification badge
    updateNotificationBadge(count) {
        const badge = document.getElementById('notificationCount');
        if (badge) {
            badge.textContent = count;
            badge.style.display = count > 0 ? 'flex' : 'none';
        }
    },
    
    // Show city boundary on map
    showCityBoundaryOnMap(city) {
        if (!window.map) return;
        
        // Remove existing boundary
        if (window.cityBoundaryLayer) {
            window.map.removeLayer(window.cityBoundaryLayer);
            window.cityBoundaryLayer = null;
        }
        
        // Get city bounds
        const bounds = IntelligentSearchEngine.getCityBounds(city);
        if (bounds) {
            const [west, south, east, north] = bounds;
            
            // Create rectangle for city boundary
            window.cityBoundaryLayer = L.rectangle([
                [south, west],
                [north, east]
            ], {
                color: '#FF6B35',
                weight: 2,
                opacity: 0.3,
                fillOpacity: 0.1,
                fillColor: '#FF6B35',
                dashArray: '10, 10'
            }).addTo(window.map);
            
            window.cityBoundaryLayer.bindTooltip(`City: ${city}`, {
                permanent: false,
                direction: 'center'
            });
            
            console.log(`City boundary displayed for ${city}`);
        }
    }
};

// ============================================
// ADVANCED FIREBASE MANAGER WITH ALL FEATURES
// ============================================
const EnhancedFirebaseManager = {
    // Load user data
    async loadUserData(uid) {
        try {
            EnhancedUIUpdater.showLoading('Loading your profile...');
            
            // Load from Realtime Database
            const snapshot = await realtimeDb.ref(`users/${uid}`).once('value');
            AppState.userData = snapshot.val();
            
            if (AppState.userData) {
                console.log('User data loaded:', AppState.userData);
                
                // Update UI
                AppState.walletBalance = AppState.userData.walletBalance || 0;
                EnhancedUIUpdater.updateWalletBalance(AppState.walletBalance);
                EnhancedUIUpdater.updateUserInfo(AppState.userData);
                
                // Load additional data
                await this.loadSOSConfig(uid);
                await this.loadScheduledRides(uid);
                await this.checkActiveRide(uid);
                await this.loadRideHistory(uid);
                await this.loadNotifications(uid);
                
                // Start real-time sync
                this.startRealtimeSync(uid);
                
                EnhancedUIUpdater.hideLoading();
                return true;
            } else {
                console.warn('No user data found');
                EnhancedUIUpdater.hideLoading();
                return false;
            }
        } catch (error) {
            console.error('Error loading user data:', error);
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Error loading user data', 'error');
            return false;
        }
    },
    
    // Start real-time sync
    startRealtimeSync(uid) {
        console.log('Starting real-time sync for user:', uid);
        
        // User data sync
        const userRef = realtimeDb.ref(`users/${uid}`);
        AppState.realtimeListeners.push(
            userRef.on('value', (snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    AppState.userData = userData;
                    AppState.walletBalance = userData.walletBalance || 0;
                    EnhancedUIUpdater.updateWalletBalance(AppState.walletBalance);
                }
            })
        );
        
        // Active ride sync
        const activeRideRef = realtimeDb.ref('rides')
            .orderByChild('passengerId')
            .equalTo(uid)
            .orderByChild('status')
            .startAt('requested')
            .endAt('started');
        
        AppState.realtimeListeners.push(
            activeRideRef.on('value', (snapshot) => {
                const rides = snapshot.val();
                if (rides) {
                    const rideId = Object.keys(rides)[0];
                    const ride = { id: rideId, ...rides[rideId] };
                    
                    if (!AppState.currentRide || AppState.currentRide.id !== rideId) {
                        AppState.currentRide = ride;
                        EnhancedUIUpdater.showRideInfo(ride);
                        
                        // Load driver info
                        if (ride.driverId) {
                            this.loadDriverInfo(ride.driverId);
                            this.listenToDriverLocation(ride.driverId);
                        }
                        
                        // Listen to chat
                        this.listenToChatMessages(rideId);
                    } else {
                        // Update existing ride
                        AppState.currentRide = ride;
                        EnhancedUIUpdater.updateRideStatus(ride.status);
                        
                        if (ride.status === 'completed') {
                            this.handleRideCompletion(ride);
                        }
                    }
                } else if (AppState.currentRide) {
                    // Ride ended
                    this.resetActiveRide();
                }
            })
        );
        
        // Notifications sync
        const notificationsRef = realtimeDb.ref(`notifications/${uid}`)
            .orderByChild('timestamp')
            .limitToLast(20);
        
        AppState.realtimeListeners.push(
            notificationsRef.on('value', (snapshot) => {
                const notifications = snapshot.val();
                if (notifications) {
                    AppState.notifications = Object.values(notifications).reverse();
                    const unreadCount = AppState.notifications.filter(n => !n.read).length;
                    AppState.unreadNotifications = unreadCount;
                    EnhancedUIUpdater.updateNotificationBadge(unreadCount);
                    EnhancedUIUpdater.updateNotifications(AppState.notifications);
                }
            })
        );
        
        // Share ride invitations
        const shareInvitationsRef = realtimeDb.ref('shareRideInvitations')
            .orderByChild('recipientId')
            .equalTo(uid)
            .orderByChild('status')
            .equalTo('pending');
        
        AppState.realtimeListeners.push(
            shareInvitationsRef.on('value', (snapshot) => {
                const invitations = snapshot.val();
                if (invitations) {
                    Object.entries(invitations).forEach(([invitationId, invitation]) => {
                        if (!AppState.shareRideInvitations.has(invitationId)) {
                            AppState.shareRideInvitations.set(invitationId, invitation);
                            EnhancedUIUpdater.showShareRideInvitation({
                                id: invitationId,
                                ...invitation
                            });
                        }
                    });
                }
            })
        );
        
        console.log('Real-time sync started');
    },
    
    // Stop real-time sync
    stopRealtimeSync() {
        AppState.realtimeListeners.forEach(listener => {
            if (listener && typeof listener === 'function') {
                listener();
            }
        });
        AppState.realtimeListeners = [];
        console.log('Real-time sync stopped');
    },
    
    // Load SOS config
    async loadSOSConfig(uid) {
        try {
            const snapshot = await realtimeDb.ref(`sosConfig/${uid}`).once('value');
            AppState.sosConfig = snapshot.val();
            
            if (AppState.sosConfig) {
                // Update emergency contact display
                const contact1Name = document.getElementById('emergencyContact1Name');
                const contact1Phone = document.getElementById('emergencyContact1Phone');
                const contact2Name = document.getElementById('emergencyContact2Name');
                const contact2Phone = document.getElementById('emergencyContact2Phone');
                
                if (contact1Name) contact1Name.textContent = AppState.sosConfig.contact1Name || 'Contact 1';
                if (contact1Phone) contact1Phone.textContent = AppState.sosConfig.contact1Phone || '';
                if (contact2Name) contact2Name.textContent = AppState.sosConfig.contact2Name || 'Contact 2';
                if (contact2Phone) contact2Phone.textContent = AppState.sosConfig.contact2Phone || '';
            }
        } catch (error) {
            console.error('Error loading SOS config:', error);
        }
    },
    
    // Load scheduled rides
    async loadScheduledRides(uid) {
        try {
            const snapshot = await realtimeDb.ref('scheduledRides')
                .orderByChild('passengerId')
                .equalTo(uid)
                .orderByChild('status')
                .equalTo('scheduled')
                .once('value');
            
            const rides = snapshot.val();
            if (rides) {
                AppState.scheduledRides = Object.values(rides);
                
                // Check for upcoming rides
                const now = Date.now();
                AppState.scheduledRides.forEach(ride => {
                    if (ride.scheduledTime && ride.scheduledTime > now) {
                        const timeUntilRide = ride.scheduledTime - now;
                        if (timeUntilRide <= 3600000) { // Within 1 hour
                            EnhancedUIUpdater.showScheduleCountdown(ride.scheduledTime);
                        }
                    }
                });
            }
        } catch (error) {
            console.error('Error loading scheduled rides:', error);
        }
    },
    
    // Check for active ride
    async checkActiveRide(uid) {
        try {
            const snapshot = await realtimeDb.ref('rides')
                .orderByChild('passengerId')
                .equalTo(uid)
                .orderByChild('status')
                .startAt('requested')
                .endAt('started')
                .once('value');
            
            const rides = snapshot.val();
            if (rides) {
                const rideId = Object.keys(rides)[0];
                AppState.currentRide = { id: rideId, ...rides[rideId] };
                EnhancedUIUpdater.showRideInfo(AppState.currentRide);
                return true;
            }
            return false;
        } catch (error) {
            console.error('Error checking active ride:', error);
            return false;
        }
    },
    
    // Load ride history
    async loadRideHistory(uid) {
        try {
            EnhancedUIUpdater.showLoading('Loading ride history...');
            
            const snapshot = await realtimeDb.ref('rides')
                .orderByChild('passengerId')
                .equalTo(uid)
                .once('value');
            
            const rides = snapshot.val();
            if (rides) {
                const ridesArray = Object.keys(rides).map(id => ({
                    id,
                    ...rides[id]
                })).sort((a, b) => b.timestamp - a.timestamp);
                
                // Apply filter
                const filtered = this.filterRides(ridesArray, AppState.activeFilter);
                
                // Update UI
                EnhancedUIUpdater.updateHistoryList(filtered);
                
                // Update stats
                this.updateUserStats(ridesArray);
            }
            
            EnhancedUIUpdater.hideLoading();
        } catch (error) {
            console.error('Error loading ride history:', error);
            EnhancedUIUpdater.hideLoading();
        }
    },
    
    filterRides(rides, filter) {
        switch(filter) {
            case 'completed':
                return rides.filter(ride => ride.status === 'completed');
            case 'cancelled':
                return rides.filter(ride => ride.status === 'cancelled');
            case 'scheduled':
                return rides.filter(ride => ride.scheduled);
            case 'emergency':
                return rides.filter(ride => ride.emergency);
            case 'delivery':
                return rides.filter(ride => ride.serviceType === 'delivery');
            case 'truck':
                return rides.filter(ride => ride.serviceType === 'truck');
            case 'broadcast':
                return rides.filter(ride => ride.broadcast);
            case 'share':
                return rides.filter(ride => ride.shareRide);
            default:
                return rides;
        }
    },
    
    updateUserStats(rides) {
        const completed = rides.filter(ride => ride.status === 'completed').length;
        const cancelled = rides.filter(ride => ride.status === 'cancelled').length;
        const totalSpent = rides
            .filter(ride => ride.status === 'completed')
            .reduce((sum, ride) => sum + (ride.fare || 0), 0);
        
        const completedRides = document.getElementById('completedRides');
        const cancelledRides = document.getElementById('cancelledRides');
        const totalSpentElement = document.getElementById('totalSpent');
        
        if (completedRides) completedRides.textContent = completed;
        if (cancelledRides) cancelledRides.textContent = cancelled;
        if (totalSpentElement) totalSpentElement.textContent = `ZMW ${totalSpent.toFixed(2)}`;
    },
    
    // Load notifications
    async loadNotifications(uid) {
        try {
            const snapshot = await realtimeDb.ref(`notifications/${uid}`)
                .orderByChild('timestamp')
                .limitToLast(20)
                .once('value');
            
            const notifications = snapshot.val();
            if (notifications) {
                AppState.notifications = Object.values(notifications).reverse();
                const unreadCount = AppState.notifications.filter(n => !n.read).length;
                AppState.unreadNotifications = unreadCount;
                EnhancedUIUpdater.updateNotificationBadge(unreadCount);
                EnhancedUIUpdater.updateNotifications(AppState.notifications);
            }
        } catch (error) {
            console.error('Error loading notifications:', error);
        }
    },
    
    // Mark notification as read
    async markNotificationAsRead(notificationId) {
        try {
            await realtimeDb.ref(`notifications/${AppState.currentUser.uid}/${notificationId}/read`).set(true);
        } catch (error) {
            console.error('Error marking notification as read:', error);
        }
    },
    
    // Request a ride
    async requestRide(rideData) {
        try {
            EnhancedUIUpdater.showLoading('Requesting ride...');
            
            // Validate data
            if (!rideData.pickup || !rideData.destination) {
                throw new Error('Pickup and destination are required');
            }
            
            // Apply referral discount if applicable
            if (AppState.referralDiscountApplied && AppState.referralCodeUsed) {
                rideData.referredBy = AppState.referralCodeUsed;
                rideData.referralOwnerName = AppState.referralOwnerName;
                rideData.referralDiscount = rideData.fare * 0.5;
                rideData.fare = rideData.fare * 0.5;
            }
            
            // Generate ride ID
            const rideId = realtimeDb.ref().child('rides').push().key;
            
            // Create ride object
            const ride = {
                id: rideId,
                ...rideData,
                passengerId: AppState.currentUser.uid,
                passengerName: AppState.userData.name,
                passengerPhone: AppState.userData.phone,
                status: 'requested',
                timestamp: Date.now(),
                updatedAt: Date.now(),
                city: AppState.currentCity
            };
            
            // Save to database
            await realtimeDb.ref(`rides/${rideId}`).set(ride);
            
            // Update state
            AppState.currentRide = ride;
            
            // Update UI
            EnhancedUIUpdater.showRideInfo(ride);
            EnhancedUIUpdater.showPulsingIcon();
            
            // Send notification to available drivers
            await this.notifyAvailableDrivers(ride);
            
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Ride requested successfully', 'success');
            
            return rideId;
        } catch (error) {
            console.error('Error requesting ride:', error);
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast(error.message, 'error');
            throw error;
        }
    },
    
    // Request delivery
    async requestDelivery(deliveryData) {
        try {
            // Add delivery-specific fields
            const rideData = {
                ...deliveryData,
                serviceType: 'delivery',
                parcelDescription: document.getElementById('parcelDescription')?.value,
                receiverName: document.getElementById('receiverName')?.value,
                receiverPhone: document.getElementById('receiverPhone')?.value,
                parcelValue: parseFloat(document.getElementById('parcelValue')?.value) || 0,
                deliveryType: document.querySelector('.filter-btn.active')?.id.replace('Delivery', '') || 'standard'
            };
            
            return await this.requestRide(rideData);
        } catch (error) {
            throw error;
        }
    },
    
    // Request truck
    async requestTruck(truckData) {
        try {
            const truckType = document.querySelector('.truck-type.selected')?.dataset.type || 'light';
            const helpers = document.getElementById('needHelpers')?.checked || false;
            
            const rideData = {
                ...truckData,
                serviceType: 'truck',
                truckType: truckType,
                itemDescription: document.getElementById('truckItemDescription')?.value,
                estimatedWeight: parseFloat(document.getElementById('estimatedWeight')?.value) || 0,
                helpers: helpers
            };
            
            return await this.requestRide(rideData);
        } catch (error) {
            throw error;
        }
    },
    
    // Request shopping
    async requestShopping(shoppingData) {
        try {
            const items = Array.from(document.querySelectorAll('.item-input'))
                .map(input => input.value)
                .filter(value => value.trim() !== '');
            
            const instructions = document.getElementById('shoppingInstructions')?.value;
            const budget = parseFloat(document.getElementById('shoppingBudget')?.value) || 0;
            
            const rideData = {
                ...shoppingData,
                serviceType: 'shopping',
                items: items,
                itemsCount: items.length,
                instructions: instructions,
                budget: budget,
                shopName: document.getElementById('shopName')?.value,
                shopLocation: document.getElementById('shopLocation')?.value
            };
            
            return await this.requestRide(rideData);
        } catch (error) {
            throw error;
        }
    },
    
    // Request scheduled ride
    async requestScheduledRide(scheduledRide) {
        try {
            // Convert scheduled ride to regular ride
            const rideData = {
                pickup: scheduledRide.pickup,
                pickupDisplay: scheduledRide.pickupDisplay,
                destination: scheduledRide.destination,
                destinationDisplay: scheduledRide.destinationDisplay,
                pickupLat: scheduledRide.pickupLat,
                pickupLng: scheduledRide.pickupLng,
                destLat: scheduledRide.destLat,
                destLng: scheduledRide.destLng,
                rideType: scheduledRide.rideType,
                fare: scheduledRide.fare,
                distance: scheduledRide.distance,
                scheduled: true,
                scheduledTime: scheduledRide.scheduledTime,
                scheduledId: scheduledRide.id
            };
            
            // Request the ride
            const rideId = await this.requestRide(rideData);
            
            // Update scheduled ride status
            await realtimeDb.ref(`scheduledRides/${scheduledRide.id}/status`).set('requested');
            
            return rideId;
        } catch (error) {
            throw error;
        }
    },
    
    // Cancel scheduled ride
    async cancelScheduledRide(scheduledRideId = null) {
        try {
            const rideId = scheduledRideId || AppState.scheduledRides[0]?.id;
            if (!rideId) throw new Error('No scheduled ride found');
            
            await realtimeDb.ref(`scheduledRides/${rideId}/status`).set('cancelled');
            
            return true;
        } catch (error) {
            throw error;
        }
    },
    
    // Create share ride
    async createShareRide(rideData, friends) {
        try {
            EnhancedUIUpdater.showLoading('Creating shared ride...');
            
            // Calculate fare split
            const distance = AdvancedCityDetector.calculateDistance(
                rideData.pickupLat, rideData.pickupLng,
                rideData.destLat, rideData.destLng
            );
            
            const numberOfPeople = friends.length + 1;
            const split = AdvancedPriceCalculator.calculateShareRideFare(
                distance,
                rideData.rideType || 'standard',
                numberOfPeople,
                'equal'
            );
            
            // Create share ride invitation
            const shareRideId = realtimeDb.ref().child('shareRides').push().key;
            
            const shareRide = {
                id: shareRideId,
                hostId: AppState.currentUser.uid,
                hostName: AppState.userData.name,
                pickup: rideData.pickup,
                pickupDisplay: rideData.pickupDisplay,
                destination: rideData.destination,
                destinationDisplay: rideData.destinationDisplay,
                pickupLat: rideData.pickupLat,
                pickupLng: rideData.pickupLng,
                destLat: rideData.destLat,
                destLng: rideData.destLng,
                distance: distance,
                totalFare: split.total,
                rideType: rideData.rideType || 'standard',
                status: 'pending',
                timestamp: Date.now(),
                city: AppState.currentCity,
                members: [
                    {
                        userId: AppState.currentUser.uid,
                        name: AppState.userData.name,
                        phone: AppState.userData.phone,
                        status: 'accepted',
                        shareAmount: split.yourShare
                    }
                ]
            };
            
            // Add friends as members
            friends.forEach(friend => {
                shareRide.members.push({
                    userId: friend.userId,
                    name: friend.name,
                    phone: friend.phone,
                    status: 'pending',
                    shareAmount: split.perPerson
                });
            });
            
            // Save share ride
            await realtimeDb.ref(`shareRides/${shareRideId}`).set(shareRide);
            
            // Create invitations for each friend
            for (const friend of friends) {
                const invitationId = realtimeDb.ref().child('shareRideInvitations').push().key;
                
                const invitation = {
                    id: invitationId,
                    shareRideId: shareRideId,
                    hostId: AppState.currentUser.uid,
                    hostName: AppState.userData.name,
                    recipientId: friend.userId,
                    recipientName: friend.name,
                    pickup: rideData.pickup,
                    destination: rideData.destination,
                    distance: distance,
                    totalFare: split.total,
                    yourShare: split.perPerson,
                    rideType: rideData.rideType || 'standard',
                    status: 'pending',
                    timestamp: Date.now()
                };
                
                await realtimeDb.ref(`shareRideInvitations/${invitationId}`).set(invitation);
                
                // Send notification
                await this.sendNotification(
                    friend.userId,
                    'Share Ride Invitation',
                    `${AppState.userData.name} invited you to share a ride`,
                    'share',
                    { 
                        invitationId: invitationId,
                        action: 'accept_share'
                    }
                );
            }
            
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Share ride created. Waiting for friends to accept.', 'success');
            
            return shareRideId;
        } catch (error) {
            EnhancedUIUpdater.hideLoading();
            throw error;
        }
    },
    
    // Accept share ride invitation
    async acceptShareRideInvitation(invitationId) {
        try {
            // Get invitation
            const snapshot = await realtimeDb.ref(`shareRideInvitations/${invitationId}`).once('value');
            const invitation = snapshot.val();
            
            if (!invitation) throw new Error('Invitation not found');
            
            // Update invitation status
            await realtimeDb.ref(`shareRideInvitations/${invitationId}/status`).set('accepted');
            
            // Update share ride member status
            const shareRideRef = realtimeDb.ref(`shareRides/${invitation.shareRideId}/members`);
            const membersSnapshot = await shareRideRef.once('value');
            const members = membersSnapshot.val() || [];
            
            const updatedMembers = members.map(member => {
                if (member.userId === invitation.recipientId) {
                    return { ...member, status: 'accepted' };
                }
                return member;
            });
            
            await shareRideRef.set(updatedMembers);
            
            // Check if all members have accepted
            const allAccepted = updatedMembers.every(member => member.status === 'accepted');
            if (allAccepted) {
                await realtimeDb.ref(`shareRides/${invitation.shareRideId}/status`).set('ready');
            }
            
            // Send confirmation to host
            await this.sendNotification(
                invitation.hostId,
                'Share Ride Accepted',
                `${invitation.recipientName} accepted your share ride invitation`,
                'share'
            );
            
            return true;
        } catch (error) {
            throw error;
        }
    },
    
    // Reject share ride invitation
    async rejectShareRideInvitation(invitationId) {
        try {
            // Get invitation
            const snapshot = await realtimeDb.ref(`shareRideInvitations/${invitationId}`).once('value');
            const invitation = snapshot.val();
            
            if (!invitation) throw new Error('Invitation not found');
            
            // Update invitation status
            await realtimeDb.ref(`shareRideInvitations/${invitationId}/status`).set('rejected');
            
            // Update share ride member status
            const shareRideRef = realtimeDb.ref(`shareRides/${invitation.shareRideId}/members`);
            const membersSnapshot = await shareRideRef.once('value');
            const members = membersSnapshot.val() || [];
            
            const updatedMembers = members.map(member => {
                if (member.userId === invitation.recipientId) {
                    return { ...member, status: 'rejected' };
                }
                return member;
            }).filter(member => member.status !== 'rejected');
            
            await shareRideRef.set(updatedMembers);
            
            // Recalculate shares if someone rejected
            if (updatedMembers.length > 0) {
                await this.recalculateShareRideShares(invitation.shareRideId, updatedMembers.length);
            }
            
            // Send notification to host
            await this.sendNotification(
                invitation.hostId,
                'Share Ride Rejected',
                `${invitation.recipientName} declined your share ride invitation`,
                'share'
            );
            
            return true;
        } catch (error) {
            throw error;
        }
    },
    
    // Recalculate share ride shares
    async recalculateShareRideShares(shareRideId, numberOfPeople) {
        try {
            const shareRideSnapshot = await realtimeDb.ref(`shareRides/${shareRideId}`).once('value');
            const shareRide = shareRideSnapshot.val();
            
            if (!shareRide) throw new Error('Share ride not found');
            
            const split = AdvancedPriceCalculator.calculateShareRideFare(
                shareRide.distance,
                shareRide.rideType,
                numberOfPeople,
                'equal'
            );
            
            // Update total fare
            await realtimeDb.ref(`shareRides/${shareRideId}/totalFare`).set(split.total);
            
            // Update member shares
            const membersSnapshot = await realtimeDb.ref(`shareRides/${shareRideId}/members`).once('value');
            const members = membersSnapshot.val() || [];
            
            const updatedMembers = members.map((member, index) => {
                if (index === 0) {
                    // Host pays their share
                    return { ...member, shareAmount: split.yourShare };
                } else {
                    // Others pay equal share
                    return { ...member, shareAmount: split.perPerson };
                }
            });
            
            await realtimeDb.ref(`shareRides/${shareRideId}/members`).set(updatedMembers);
            
            return true;
        } catch (error) {
            throw error;
        }
    },
    
    // Create broadcast ride
    async createBroadcastRide(rideData, recipients) {
        try {
            EnhancedUIUpdater.showLoading('Creating broadcast ride...');
            
            const broadcastId = realtimeDb.ref().child('broadcastRides').push().key;
            
            const broadcastRide = {
                id: broadcastId,
                hostId: AppState.currentUser.uid,
                hostName: AppState.userData.name,
                pickup: rideData.pickup,
                pickupDisplay: rideData.pickupDisplay,
                destination: rideData.destination,
                destinationDisplay: rideData.destinationDisplay,
                pickupLat: rideData.pickupLat,
                pickupLng: rideData.pickupLng,
                destLat: rideData.destLat,
                destLng: rideData.destLng,
                rideType: rideData.rideType || 'standard',
                status: 'active',
                timestamp: Date.now(),
                city: AppState.currentCity,
                recipients: recipients.map(recipient => ({
                    userId: recipient.userId,
                    name: recipient.name,
                    status: 'invited'
                }))
            };
            
            // Save broadcast ride
            await realtimeDb.ref(`broadcastRides/${broadcastId}`).set(broadcastRide);
            
            // Create invitations for recipients
            for (const recipient of recipients) {
                const invitationId = realtimeDb.ref().child('broadcastInvitations').push().key;
                
                const invitation = {
                    id: invitationId,
                    broadcastId: broadcastId,
                    hostId: AppState.currentUser.uid,
                    hostName: AppState.userData.name,
                    recipientId: recipient.userId,
                    recipientName: recipient.name,
                    status: 'pending',
                    timestamp: Date.now()
                };
                
                await realtimeDb.ref(`broadcastInvitations/${invitationId}`).set(invitation);
                
                // Send notification
                await this.sendNotification(
                    recipient.userId,
                    'Broadcast Ride',
                    `${AppState.userData.name} is sharing their ride with you`,
                    'broadcast',
                    { 
                        broadcastId: broadcastId,
                        action: 'view_broadcast'
                    }
                );
            }
            
            // Request the actual ride
            const rideId = await this.requestRide({
                ...rideData,
                broadcast: true,
                broadcastId: broadcastId
            });
            
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Broadcast ride created. Friends can now track your ride.', 'success');
            
            return { broadcastId, rideId };
        } catch (error) {
            EnhancedUIUpdater.hideLoading();
            throw error;
        }
    },
    
    // Validate referral code
    async validateReferralCode(referralCode) {
        try {
            // Search for user with this referral code
            const snapshot = await realtimeDb.ref('users')
                .orderByChild('referralCode')
                .equalTo(referralCode)
                .once('value');
            
            const users = snapshot.val();
            if (users) {
                const userId = Object.keys(users)[0];
                const user = users[userId];
                
                return {
                    valid: true,
                    ownerId: userId,
                    ownerName: user.name,
                    ownerPhone: user.phone
                };
            }
            
            return { valid: false };
        } catch (error) {
            console.error('Error validating referral code:', error);
            return { valid: false };
        }
    },
    
    // Process referral reward
    async processReferralReward(rideId) {
        try {
            // Get ride details
            const snapshot = await realtimeDb.ref(`rides/${rideId}`).once('value');
            const ride = snapshot.val();
            
            if (!ride || !ride.referredBy) {
                return; // No referral
            }
            
            // Find referral owner
            const referralSnapshot = await realtimeDb.ref('users')
                .orderByChild('referralCode')
                .equalTo(ride.referredBy)
                .once('value');
            
            const users = referralSnapshot.val();
            if (users) {
                const referralOwnerId = Object.keys(users)[0];
                const referralOwner = users[referralOwnerId];
                
                // Award ZMW 25 to referral owner
                const newBalance = (referralOwner.walletBalance || 0) + 25;
                
                await realtimeDb.ref(`users/${referralOwnerId}/walletBalance`).set(newBalance);
                
                // Create transaction record
                const transactionId = realtimeDb.ref().child('transactions').push().key;
                
                const transaction = {
                    id: transactionId,
                    userId: referralOwnerId,
                    type: 'referral_reward',
                    amount: 25,
                    description: `Referral reward from ${ride.passengerName}`,
                    timestamp: Date.now(),
                    rideId: rideId
                };
                
                await realtimeDb.ref(`transactions/${transactionId}`).set(transaction);
                
                // Send notification to referral owner
                await this.sendNotification(
                    referralOwnerId,
                    'Referral Reward!',
                    `You earned ZMW 25 from ${ride.passengerName}'s ride`,
                    'referral',
                    { amount: 25, rideId: rideId }
                );
                
                console.log(`Referral reward processed: ZMW 25 to ${referralOwner.name}`);
            }
        } catch (error) {
            console.error('Error processing referral reward:', error);
        }
    },
    
    // Load driver info
    async loadDriverInfo(driverId) {
        try {
            const snapshot = await realtimeDb.ref(`users/${driverId}`).once('value');
            const driver = snapshot.val();
            
            if (driver) {
                AppState.selectedVehicle = driver;
                
                // Update UI
                const driverName = document.getElementById('driverName');
                const driverRating = document.getElementById('driverRating');
                const vehicleDetails = document.getElementById('vehicleDetails');
                
                if (driverName) driverName.textContent = driver.name || 'Driver';
                if (driverRating) driverRating.textContent = driver.rating?.toFixed(1) || '4.8';
                if (vehicleDetails) {
                    vehicleDetails.textContent = `${driver.vehicle?.model || 'Car'} - ${driver.vehicle?.plate || 'ABC 123'}`;
                }
            }
        } catch (error) {
            console.error('Error loading driver info:', error);
        }
    },
    
    // Listen to driver location
    listenToDriverLocation(driverId) {
        const locationRef = realtimeDb.ref(`driverLocations/${driverId}`);
        
        AppState.realtimeListeners.push(
            locationRef.on('value', (snapshot) => {
                const location = snapshot.val();
                if (location) {
                    AppState.driverLocation = {
                        lat: location.latitude,
                        lng: location.longitude
                    };
                    
                    // Update driver marker on map
                    if (window.driverMarker) {
                        window.driverMarker.setLatLng([location.latitude, location.longitude]);
                    } else {
                        window.driverMarker = L.marker([location.latitude, location.longitude], {
                            icon: L.divIcon({
                                className: 'driver-marker',
                                html: '<i class="fas fa-car"></i>',
                                iconSize: [32, 32],
                                iconAnchor: [16, 32]
                            })
                        }).addTo(window.map).bindPopup('Your Driver');
                    }
                    
                    // Update tracking info
                    if (AppState.currentRide && AppState.currentRide.pickupLat) {
                        const distance = AdvancedCityDetector.calculateDistance(
                            location.latitude, location.longitude,
                            AppState.currentRide.pickupLat, AppState.currentRide.pickupLng
                        );
                        
                        const trackingProgress = document.getElementById('trackingProgress');
                        const driverDistance = document.getElementById('driverDistance');
                        
                        if (trackingProgress) {
                            const progressPercent = Math.max(0, 100 - (distance / 10) * 100);
                            trackingProgress.style.width = `${Math.min(progressPercent, 100)}%`;
                        }
                        
                        if (driverDistance) {
                            driverDistance.textContent = `${distance.toFixed(1)} km`;
                        }
                    }
                }
            })
        );
    },
    
    // Listen to chat messages
    listenToChatMessages(rideId) {
        const chatRef = realtimeDb.ref(`chats/${rideId}/messages`).orderByChild('timestamp').limitToLast(50);
        
        AppState.realtimeListeners.push(
            chatRef.on('child_added', (snapshot) => {
                const message = snapshot.val();
                if (message) {
                    const isSender = message.senderId === AppState.currentUser.uid;
                    EnhancedUIUpdater.showChatMessage(message, isSender);
                }
            })
        );
    },
    
    // Send chat message
    async sendChatMessage(rideId, message, isDriver = false) {
        try {
            const messageId = realtimeDb.ref().child(`chats/${rideId}/messages`).push().key;
            
            const chatMessage = {
                id: messageId,
                senderId: AppState.currentUser.uid,
                senderName: AppState.userData.name,
                text: message,
                timestamp: Date.now(),
                isDriver: isDriver
            };
            
            await realtimeDb.ref(`chats/${rideId}/messages/${messageId}`).set(chatMessage);
            
            return messageId;
        } catch (error) {
            throw error;
        }
    },
    
    // Send notification
    async sendNotification(userId, title, message, type = 'info', data = null) {
        try {
            const notificationId = realtimeDb.ref().child(`notifications/${userId}`).push().key;
            
            const notification = {
                id: notificationId,
                title: title,
                message: message,
                type: type,
                data: data,
                read: false,
                timestamp: Date.now()
            };
            
            await realtimeDb.ref(`notifications/${userId}/${notificationId}`).set(notification);
            
            return notificationId;
        } catch (error) {
            throw error;
        }
    },
    
    // Handle ride completion
    async handleRideCompletion(ride) {
        try {
            // Process referral reward if applicable
            if (ride.status === 'completed' && ride.referredBy) {
                await this.processReferralReward(ride.id);
            }
            
            // Record wallet transaction if paid by wallet
            if (ride.paymentMethod === 'wallet') {
                await this.recordRidePaymentTransaction(ride);
            }
            
            // Send completion notification
            await this.sendNotification(
                AppState.currentUser.uid,
                'Ride Completed',
                `Your ride to ${ride.destinationDisplay || ride.destination} has been completed`,
                'ride',
                { rideId: ride.id }
            );
            
            console.log('Ride completion processed');
        } catch (error) {
            console.error('Error handling ride completion:', error);
        }
    },
    
    // Record ride payment transaction
    async recordRidePaymentTransaction(ride) {
        try {
            const transactionId = realtimeDb.ref().child('transactions').push().key;
            
            const transaction = {
                id: transactionId,
                userId: AppState.currentUser.uid,
                type: 'ride_payment',
                amount: -ride.fare, // Negative for payment
                description: `Ride to ${ride.destinationDisplay || ride.destination}`,
                timestamp: Date.now(),
                rideId: ride.id,
                paymentMethod: 'wallet',
                status: 'completed'
            };
            
            await realtimeDb.ref(`transactions/${transactionId}`).set(transaction);
            
            return transactionId;
        } catch (error) {
            throw error;
        }
    },
    
    // Reset active ride
    resetActiveRide() {
        AppState.currentRide = null;
        AppState.selectedVehicle = null;
        AppState.driverLocation = null;
        
        // Remove pulsing icon
        EnhancedUIUpdater.removePulsingIcon();
        
        // Reset UI
        const rideInfoPanel = document.getElementById('rideInfoPanel');
        if (rideInfoPanel) rideInfoPanel.style.display = 'none';
        
        const rideStatusBar = document.getElementById('rideStatusBar');
        if (rideStatusBar) rideStatusBar.classList.remove('active');
        
        console.log('Active ride reset');
    },
    
    // Deposit money
    async depositMoney(amount) {
        try {
            if (amount <= 0) throw new Error('Invalid amount');
            
            const newBalance = AppState.walletBalance + amount;
            
            // Update wallet balance
            await realtimeDb.ref(`users/${AppState.currentUser.uid}/walletBalance`).set(newBalance);
            
            // Record transaction
            const transactionId = realtimeDb.ref().child('transactions').push().key;
            
            const transaction = {
                id: transactionId,
                userId: AppState.currentUser.uid,
                type: 'deposit',
                amount: amount,
                description: 'Wallet deposit',
                timestamp: Date.now(),
                status: 'completed'
            };
            
            await realtimeDb.ref(`transactions/${transactionId}`).set(transaction);
            
            // Update local state
            AppState.walletBalance = newBalance;
            EnhancedUIUpdater.updateWalletBalance(newBalance);
            
            // Send notification
            await this.sendNotification(
                AppState.currentUser.uid,
                'Deposit Successful',
                `ZMW ${amount.toFixed(2)} deposited to your wallet`,
                'payment'
            );
            
            return { success: true, newBalance };
        } catch (error) {
            throw error;
        }
    },
    
    // Withdraw money
    async withdrawMoney(amount) {
        try {
            if (amount <= 0) throw new Error('Invalid amount');
            
            if (amount > AppState.walletBalance) {
                throw new Error('Insufficient balance');
            }
            
            const newBalance = AppState.walletBalance - amount;
            
            // Update wallet balance
            await realtimeDb.ref(`users/${AppState.currentUser.uid}/walletBalance`).set(newBalance);
            
            // Record transaction
            const transactionId = realtimeDb.ref().child('transactions').push().key;
            
            const transaction = {
                id: transactionId,
                userId: AppState.currentUser.uid,
                type: 'withdrawal',
                amount: -amount,
                description: 'Wallet withdrawal',
                timestamp: Date.now(),
                status: 'completed'
            };
            
            await realtimeDb.ref(`transactions/${transactionId}`).set(transaction);
            
            // Update local state
            AppState.walletBalance = newBalance;
            EnhancedUIUpdater.updateWalletBalance(newBalance);
            
            return { success: true, newBalance };
        } catch (error) {
            throw error;
        }
    },
    
    // Transfer money
    async transferMoney(recipientCode, amount, message = '') {
        try {
            if (amount <= 0) throw new Error('Invalid amount');
            
            if (amount > AppState.walletBalance) {
                throw new Error('Insufficient balance');
            }
            
            // Find recipient by referral code
            const recipientSnapshot = await realtimeDb.ref('users')
                .orderByChild('referralCode')
                .equalTo(recipientCode)
                .once('value');
            
            const recipients = recipientSnapshot.val();
            if (!recipients) {
                throw new Error('Recipient not found');
            }
            
            const recipientId = Object.keys(recipients)[0];
            const recipient = recipients[recipientId];
            
            // Update sender balance
            const senderNewBalance = AppState.walletBalance - amount;
            await realtimeDb.ref(`users/${AppState.currentUser.uid}/walletBalance`).set(senderNewBalance);
            
            // Update recipient balance
            const recipientNewBalance = (recipient.walletBalance || 0) + amount;
            await realtimeDb.ref(`users/${recipientId}/walletBalance`).set(recipientNewBalance);
            
            // Record sender transaction
            const senderTransactionId = realtimeDb.ref().child('transactions').push().key;
            const senderTransaction = {
                id: senderTransactionId,
                userId: AppState.currentUser.uid,
                type: 'transfer_sent',
                amount: -amount,
                description: `Transfer to ${recipient.name}`,
                message: message,
                timestamp: Date.now(),
                recipientId: recipientId,
                recipientName: recipient.name,
                status: 'completed'
            };
            await realtimeDb.ref(`transactions/${senderTransactionId}`).set(senderTransaction);
            
            // Record recipient transaction
            const recipientTransactionId = realtimeDb.ref().child('transactions').push().key;
            const recipientTransaction = {
                id: recipientTransactionId,
                userId: recipientId,
                type: 'transfer_received',
                amount: amount,
                description: `Transfer from ${AppState.userData.name}`,
                message: message,
                timestamp: Date.now(),
                senderId: AppState.currentUser.uid,
                senderName: AppState.userData.name,
                status: 'completed'
            };
            await realtimeDb.ref(`transactions/${recipientTransactionId}`).set(recipientTransaction);
            
            // Update local state
            AppState.walletBalance = senderNewBalance;
            EnhancedUIUpdater.updateWalletBalance(senderNewBalance);
            
            // Send notifications
            await this.sendNotification(
                AppState.currentUser.uid,
                'Transfer Sent',
                `ZMW ${amount.toFixed(2)} sent to ${recipient.name}`,
                'payment'
            );
            
            await this.sendNotification(
                recipientId,
                'Transfer Received',
                `ZMW ${amount.toFixed(2)} received from ${AppState.userData.name}`,
                'payment'
            );
            
            return { 
                success: true, 
                newBalance: senderNewBalance,
                recipientName: recipient.name 
            };
        } catch (error) {
            throw error;
        }
    },
    
    // Load transactions
    async loadTransactions() {
        try {
            const snapshot = await realtimeDb.ref('transactions')
                .orderByChild('userId')
                .equalTo(AppState.currentUser.uid)
                .once('value');
            
            const transactions = snapshot.val();
            if (transactions) {
                return Object.values(transactions).sort((a, b) => b.timestamp - a.timestamp);
            }
            
            return [];
        } catch (error) {
            console.error('Error loading transactions:', error);
            return [];
        }
    },
    
    // Load emergency stations
    async loadEmergencyStations(city, type) {
        try {
            // This would typically call an API to get emergency stations
            // For now, return mock data
            const stations = [
                {
                    id: '1',
                    name: `${type === 'police' ? 'Central Police Station' : 
                           type === 'fire' ? 'Fire Brigade Headquarters' : 
                           'General Hospital'}`,
                    address: `123 Main St, ${city}`,
                    lat: AppState.userLocation.lat + 0.01,
                    lng: AppState.userLocation.lng + 0.01,
                    distance: 2.5,
                    price: AdvancedPriceCalculator.calculateEmergencyFare(2.5, type)
                },
                {
                    id: '2',
                    name: `${type === 'police' ? 'District Police Station' : 
                           type === 'fire' ? 'Fire Station 2' : 
                           'City Clinic'}`,
                    address: `456 Second Ave, ${city}`,
                    lat: AppState.userLocation.lat + 0.02,
                    lng: AppState.userLocation.lng + 0.02,
                    distance: 4.1,
                    price: AdvancedPriceCalculator.calculateEmergencyFare(4.1, type)
                },
                {
                    id: '3',
                    name: `${type === 'police' ? 'Community Police Post' : 
                           type === 'fire' ? 'Fire Station 3' : 
                           'Medical Center'}`,
                    address: `789 Third Blvd, ${city}`,
                    lat: AppState.userLocation.lat + 0.03,
                    lng: AppState.userLocation.lng - 0.01,
                    distance: 5.7,
                    price: AdvancedPriceCalculator.calculateEmergencyFare(5.7, type)
                }
            ];
            
            AppState.emergencyStations[type] = stations;
            return stations;
        } catch (error) {
            console.error('Error loading emergency stations:', error);
            return [];
        }
    },
    
    // Notify available drivers
    async notifyAvailableDrivers(ride) {
        try {
            // Find available drivers near the pickup location
            const driversSnapshot = await realtimeDb.ref('drivers')
                .orderByChild('status')
                .equalTo('available')
                .once('value');
            
            const drivers = driversSnapshot.val();
            if (drivers) {
                Object.keys(drivers).forEach(async (driverId) => {
                    // Check if driver is in the same city
                    const driver = drivers[driverId];
                    if (driver.city === AppState.currentCity) {
                        // Send notification to driver
                        await this.sendNotification(
                            driverId,
                            'New Ride Request',
                            `Ride from ${ride.pickupDisplay} to ${ride.destinationDisplay}`,
                            'ride',
                            { rideId: ride.id, fare: ride.fare }
                        );
                    }
                });
            }
            
            console.log('Notified available drivers');
        } catch (error) {
            console.error('Error notifying drivers:', error);
        }
    },
    
    // Find user by referral code
    async findUserByReferralCode(referralCode) {
        try {
            const snapshot = await realtimeDb.ref('users')
                .orderByChild('referralCode')
                .equalTo(referralCode)
                .once('value');
            
            const users = snapshot.val();
            if (users) {
                const userId = Object.keys(users)[0];
                const user = users[userId];
                return { id: userId, ...user };
            }
            
            return null;
        } catch (error) {
            console.error('Error finding user by referral code:', error);
            return null;
        }
    },
    
    // Sync user data periodically
    async syncUserData() {
        if (AppState.isSyncing || !AppState.currentUser) return;
        
        AppState.isSyncing = true;
        EnhancedUIUpdater.showSyncIndicator(true);
        
        try {
            // Sync wallet balance
            const userSnapshot = await realtimeDb.ref(`users/${AppState.currentUser.uid}`).once('value');
            const userData = userSnapshot.val();
            
            if (userData) {
                AppState.userData = userData;
                AppState.walletBalance = userData.walletBalance || 0;
                EnhancedUIUpdater.updateWalletBalance(AppState.walletBalance);
            }
            
            // Sync notifications
            await this.loadNotifications(AppState.currentUser.uid);
            
            console.log('User data synced');
        } catch (error) {
            console.error('Error syncing user data:', error);
        } finally {
            AppState.isSyncing = false;
            EnhancedUIUpdater.showSyncIndicator(false);
        }
    }
};

// ============================================
// EVENT HANDLERS AND APP INITIALIZATION
// ============================================

// Initialize the application
async function initializeApp() {
    try {
        console.log('Initializing Jubel Passenger App...');
        EnhancedUIUpdater.showLoading('Initializing app...');
        
        // Initialize search engine
        IntelligentSearchEngine.init();
        
        // Check authentication
        const urlParams = new URLSearchParams(window.location.search);
        const email = urlParams.get('email');
        const uid = urlParams.get('uid');
        
        if (email && uid) {
            console.log('Authenticated via URL parameters');
            AppState.currentUser = { uid, email };
            await EnhancedFirebaseManager.loadUserData(uid);
        } else {
            // Check Firebase auth state
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    console.log('User authenticated:', user.uid);
                    AppState.currentUser = user;
                    await EnhancedFirebaseManager.loadUserData(user.uid);
                } else {
                    console.log('No user logged in, redirecting to signup');
                    window.location.href = 'signup.html';
                }
            });
        }
        
        // Initialize map
        initializeMap();
        
        // Get current location
        getCurrentLocation();
        
        // Setup event listeners
        setupEventListeners();
        
        // Initialize shopping categories
        EnhancedUIUpdater.showShoppingCategories();
        
        EnhancedUIUpdater.hideLoading();
        EnhancedUIUpdater.showToast('Jubel Passenger App Ready', 'success');
        
        console.log('App initialization completed');
        
    } catch (error) {
        console.error('Error initializing app:', error);
        EnhancedUIUpdater.hideLoading();
        EnhancedUIUpdater.showToast('Error initializing app', 'error');
    }
}

// Initialize map
function initializeMap() {
    const defaultLat = -15.4167;
    const defaultLng = 28.2833;
    
    window.map = L.map('map').setView([defaultLat, defaultLng], 13);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: ' OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(window.map);
    
    L.control.scale().addTo(window.map);
    
    // Hide map loading overlay
    const mapLoadingOverlay = document.getElementById('mapLoadingOverlay');
    if (mapLoadingOverlay) {
        mapLoadingOverlay.style.display = 'none';
    }
    
    console.log('Map initialized');
}

// Get current location
async function getCurrentLocation() {
    if (!navigator.geolocation) {
        console.warn('Geolocation not supported');
        EnhancedUIUpdater.showToast('Geolocation not supported by your browser', 'warning');
        return;
    }
    
    EnhancedUIUpdater.showLoading('Getting your location...');
    
    try {
        const position = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            });
        });
        
        const { latitude, longitude } = position.coords;
        AppState.userLocation = { lat: latitude, lng: longitude };
        
        // Update map view
        window.map.setView([latitude, longitude], 15);
        
        // Add current location marker
        window.currentLocationMarker = L.marker([latitude, longitude], {
            icon: L.divIcon({
                className: 'current-location-marker',
                html: '<i class="fas fa-user"></i>',
                iconSize: [20, 20],
                iconAnchor: [10, 20]
            })
        }).addTo(window.map).bindPopup('Your Location');
        
        // Detect city
        const city = await AdvancedCityDetector.detectCityFromCoordinates(latitude, longitude);
        console.log('City detected:', city);
        
        // Update pickup location
        const address = await AdvancedCityDetector.getDetailedAddress(latitude, longitude);
        
        // Set pickup location in all pickup inputs
        const pickupInputs = [
            'pickupLocation',
            'deliveryPickup',
            'shortDeliveryPickup',
            'truckPickup',
            'schedulePickup',
            'someonePickup',
            'sharePickup',
            'broadcastPickup',
            'emergencyPickup'
        ];
        
        pickupInputs.forEach(inputId => {
            const input = document.getElementById(inputId);
            if (input) {
                input.value = address.address;
                input.dataset.lat = latitude;
                input.dataset.lng = longitude;
            }
        });
        
        // Set emergency user location
        const emergencyUserLocation = document.getElementById('emergencyUserLocation');
        if (emergencyUserLocation) {
            emergencyUserLocation.textContent = address.fullDisplay;
        }
        
        // Store pickup location
        AppState.pickup = {
            lat: latitude,
            lng: longitude,
            address: address.address,
            name: 'Current Location',
            fullDisplay: address.fullDisplay
        };
        
        EnhancedUIUpdater.hideLoading();
        EnhancedUIUpdater.showToast('Location detected successfully', 'success');
        
    } catch (error) {
        console.error('Geolocation error:', error);
        EnhancedUIUpdater.hideLoading();
        EnhancedUIUpdater.showToast('Unable to get your location', 'warning');
    }
}

// Setup event listeners
function setupEventListeners() {
    console.log('Setting up event listeners...');
    
    // Destination input search
    const destinationInput = document.getElementById('destinationLocation');
    if (destinationInput) {
        let searchTimeout;
        
        destinationInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            
            const query = destinationInput.value.trim();
            if (query.length < 2) {
                const suggestions = document.getElementById('destinationSuggestions');
                if (suggestions) suggestions.style.display = 'none';
                return;
            }
            
            searchTimeout = setTimeout(async () => {
                if (!AppState.currentCity) {
                    EnhancedUIUpdater.showToast('Please wait for city detection', 'warning');
                    return;
                }
                
                const results = await IntelligentSearchEngine.search(
                    query,
                    'destination',
                    AppState.currentCity,
                    AppState.userLocation
                );
                
                EnhancedUIUpdater.showSearchSuggestions('destinationLocation', results, 'destination');
            }, 300);
        });
        
        destinationInput.addEventListener('blur', () => {
            setTimeout(() => {
                const suggestions = document.getElementById('destinationSuggestions');
                if (suggestions) suggestions.style.display = 'none';
            }, 200);
        });
    }
    
    // Pickup input search
    const pickupInput = document.getElementById('pickupLocation');
    if (pickupInput) {
        let searchTimeout;
        
        pickupInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            
            const query = pickupInput.value.trim();
            if (query.length < 2) {
                const suggestions = document.getElementById('pickupSuggestions');
                if (suggestions) suggestions.style.display = 'none';
                return;
            }
            
            searchTimeout = setTimeout(async () => {
                if (!AppState.currentCity) {
                    EnhancedUIUpdater.showToast('Please wait for city detection', 'warning');
                    return;
                }
                
                const results = await IntelligentSearchEngine.search(
                    query,
                    'pickup',
                    AppState.currentCity,
                    AppState.userLocation
                );
                
                EnhancedUIUpdater.showSearchSuggestions('pickupLocation', results, 'pickup');
            }, 300);
        });
        
        pickupInput.addEventListener('blur', () => {
            setTimeout(() => {
                const suggestions = document.getElementById('pickupSuggestions');
                if (suggestions) suggestions.style.display = 'none';
            }, 200);
        });
    }
    
    // Request ride button
    const requestRideBtn = document.getElementById('requestRideBtn');
    if (requestRideBtn) {
        requestRideBtn.addEventListener('click', async () => {
            if (!AppState.pickup || !AppState.destination) {
                EnhancedUIUpdater.showToast('Please select pickup and destination', 'warning');
                return;
            }
            
            const distance = AdvancedCityDetector.calculateDistance(
                AppState.pickup.lat, AppState.pickup.lng,
                AppState.destination.lat, AppState.destination.lng
            );
            
            if (distance < 0.5) {
                EnhancedUIUpdater.showToast('Minimum ride distance is 0.5 km', 'warning');
                return;
            }
            
            const rideData = {
                pickup: AppState.pickup.address,
                pickupDisplay: AppState.pickup.fullDisplay || AppState.pickup.name,
                destination: AppState.destination.address,
                destinationDisplay: AppState.destination.fullAddress || AppState.destination.name,
                pickupLat: AppState.pickup.lat,
                pickupLng: AppState.pickup.lng,
                destLat: AppState.destination.lat,
                destLng: AppState.destination.lng,
                rideType: AppState.selectedRideType,
                fare: AppState.rideFare,
                distance: distance
            };
            
            // Show payment modal
            EnhancedUIUpdater.showPaymentModal(rideData);
        });
    }
    
    // Request delivery button
    const requestDeliveryBtn = document.getElementById('requestDeliveryBtn');
    if (requestDeliveryBtn) {
        requestDeliveryBtn.addEventListener('click', async () => {
            if (!AppState.pickup || !AppState.destination) {
                EnhancedUIUpdater.showToast('Please select pickup and destination', 'warning');
                return;
            }
            
            const distance = AdvancedCityDetector.calculateDistance(
                AppState.pickup.lat, AppState.pickup.lng,
                AppState.destination.lat, AppState.destination.lng
            );
            
            const deliveryData = {
                pickup: AppState.pickup.address,
                pickupDisplay: AppState.pickup.fullDisplay || AppState.pickup.name,
                destination: AppState.destination.address,
                destinationDisplay: AppState.destination.fullAddress || AppState.destination.name,
                pickupLat: AppState.pickup.lat,
                pickupLng: AppState.pickup.lng,
                destLat: AppState.destination.lat,
                destLng: AppState.destination.lng,
                fare: AppState.rideFare,
                distance: distance
            };
            
            EnhancedUIUpdater.showPaymentModal(deliveryData);
        });
    }
    
    // Request truck button
    const requestTruckBtn = document.getElementById('requestTruckBtn');
    if (requestTruckBtn) {
        requestTruckBtn.addEventListener('click', async () => {
            if (!AppState.pickup || !AppState.destination) {
                EnhancedUIUpdater.showToast('Please select pickup and destination', 'warning');
                return;
            }
            
            const distance = AdvancedCityDetector.calculateDistance(
                AppState.pickup.lat, AppState.pickup.lng,
                AppState.destination.lat, AppState.destination.lng
            );
            
            const truckData = {
                pickup: AppState.pickup.address,
                pickupDisplay: AppState.pickup.fullDisplay || AppState.pickup.name,
                destination: AppState.destination.address,
                destinationDisplay: AppState.destination.fullAddress || AppState.destination.name,
                pickupLat: AppState.pickup.lat,
                pickupLng: AppState.pickup.lng,
                destLat: AppState.destination.lat,
                destLng: AppState.destination.lng,
                fare: AppState.rideFare,
                distance: distance
            };
            
            EnhancedUIUpdater.showPaymentModal(truckData);
        });
    }
    
    // Request shopping button
    const requestShoppingBtn = document.getElementById('requestShoppingBtn');
    if (requestShoppingBtn) {
        requestShoppingBtn.addEventListener('click', async () => {
            if (!AppState.pickup || !AppState.destination) {
                EnhancedUIUpdater.showToast('Please select pickup and destination', 'warning');
                return;
            }
            
            const distance = AdvancedCityDetector.calculateDistance(
                AppState.pickup.lat, AppState.pickup.lng,
                AppState.destination.lat, AppState.destination.lng
            );
            
            const shoppingData = {
                pickup: AppState.pickup.address,
                pickupDisplay: AppState.pickup.fullDisplay || AppState.pickup.name,
                destination: AppState.destination.address,
                destinationDisplay: AppState.destination.fullAddress || AppState.destination.name,
                pickupLat: AppState.pickup.lat,
                pickupLng: AppState.pickup.lng,
                destLat: AppState.destination.lat,
                destLng: AppState.destination.lng,
                fare: AppState.rideFare,
                distance: distance
            };
            
            EnhancedUIUpdater.showPaymentModal(shoppingData);
        });
    }
    
    // Apply referral button
    const applyReferralBtn = document.getElementById('applyReferralBtn');
    if (applyReferralBtn) {
        applyReferralBtn.addEventListener('click', () => {
            EnhancedUIUpdater.applyReferralDiscount();
        });
    }
    
    // Remove referral button
    const removeReferralBtn = document.getElementById('removeReferralBtn');
    if (removeReferralBtn) {
        removeReferralBtn.addEventListener('click', () => {
            EnhancedUIUpdater.removeReferralDiscount();
        });
    }
    
    // Confirm payment button
    const confirmPaymentBtn = document.getElementById('confirmPaymentBtn');
    if (confirmPaymentBtn) {
        confirmPaymentBtn.addEventListener('click', async () => {
            const selectedMethod = document.querySelector('.payment-method.selected');
            if (!selectedMethod) {
                EnhancedUIUpdater.showToast('Please select a payment method', 'warning');
                return;
            }
            
            const paymentMethod = selectedMethod.dataset.payment;
            const rideData = window.pendingRideData;
            
            if (!rideData) {
                EnhancedUIUpdater.showToast('No ride data found', 'error');
                return;
            }
            
            rideData.paymentMethod = paymentMethod;
            
            // Apply referral discount if applicable
            if (AppState.referralDiscountApplied) {
                rideData.referredBy = AppState.referralCodeUsed;
                rideData.referralOwnerName = AppState.referralOwnerName;
            }
            
            try {
                // Process payment
                if (paymentMethod === 'wallet') {
                    if (AppState.walletBalance < rideData.fare) {
                        EnhancedUIUpdater.showToast('Insufficient wallet balance', 'error');
                        return;
                    }
                    
                    await EnhancedFirebaseManager.withdrawMoney(rideData.fare);
                }
                
                // Request the ride based on service type
                let rideId;
                switch(AppState.activeService) {
                    case 'car':
                        rideId = await EnhancedFirebaseManager.requestRide(rideData);
                        break;
                    case 'delivery':
                        rideId = await EnhancedFirebaseManager.requestDelivery(rideData);
                        break;
                    case 'truck':
                        rideId = await EnhancedFirebaseManager.requestTruck(rideData);
                        break;
                    case 'express':
                        rideId = await EnhancedFirebaseManager.requestShopping(rideData);
                        break;
                    default:
                        rideId = await EnhancedFirebaseManager.requestRide(rideData);
                }
                
                // Hide payment modal
                const paymentModal = document.getElementById('paymentModal');
                if (paymentModal) paymentModal.style.display = 'none';
                
                // Clear pending data
                delete window.pendingRideData;
                AppState.referralDiscountApplied = false;
                AppState.referralCodeUsed = null;
                AppState.referralOwnerName = null;
                
                EnhancedUIUpdater.showToast('Ride requested successfully', 'success');
                console.log('Ride requested with ID:', rideId);
                
            } catch (error) {
                console.error('Error processing payment:', error);
                EnhancedUIUpdater.showToast('Error processing payment: ' + error.message, 'error');
                
                // Refund wallet payment if it failed
                if (paymentMethod === 'wallet') {
                    try {
                        await EnhancedFirebaseManager.depositMoney(rideData.fare);
                    } catch (refundError) {
                        console.error('Error refunding money:', refundError);
                    }
                }
            }
        });
    }
    
    // Schedule ride button
    const confirmScheduleBtn = document.getElementById('confirmScheduleBtn');
    if (confirmScheduleBtn) {
        confirmScheduleBtn.addEventListener('click', async () => {
            if (!AppState.pickup || !AppState.destination) {
                EnhancedUIUpdater.showToast('Please select pickup and destination', 'warning');
                return;
            }
            
            const scheduleDate = document.getElementById('scheduleDate')?.value;
            const scheduleTime = document.getElementById('scheduleTime')?.value;
            
            if (!scheduleDate || !scheduleTime) {
                EnhancedUIUpdater.showToast('Please select date and time', 'warning');
                return;
            }
            
            const scheduledDateTime = new Date(`${scheduleDate}T${scheduleTime}`);
            const scheduledTime = scheduledDateTime.getTime();
            
            if (scheduledTime <= Date.now()) {
                EnhancedUIUpdater.showToast('Please select a future time', 'warning');
                return;
            }
            
            const distance = AdvancedCityDetector.calculateDistance(
                AppState.pickup.lat, AppState.pickup.lng,
                AppState.destination.lat, AppState.destination.lng
            );
            
            const scheduledRide = {
                pickup: AppState.pickup.address,
                pickupDisplay: AppState.pickup.fullDisplay || AppState.pickup.name,
                destination: AppState.destination.address,
                destinationDisplay: AppState.destination.fullAddress || AppState.destination.name,
                pickupLat: AppState.pickup.lat,
                pickupLng: AppState.pickup.lng,
                destLat: AppState.destination.lat,
                destLng: AppState.destination.lng,
                rideType: AppState.selectedRideType,
                fare: AppState.rideFare,
                distance: distance,
                scheduledTime: scheduledTime,
                passengerId: AppState.currentUser.uid,
                passengerName: AppState.userData.name,
                status: 'scheduled',
                timestamp: Date.now()
            };
            
            try {
                const scheduledRideId = realtimeDb.ref().child('scheduledRides').push().key;
                await realtimeDb.ref(`scheduledRides/${scheduledRideId}`).set(scheduledRide);
                
                // Hide schedule modal
                const scheduleModal = document.getElementById('scheduleModal');
                if (scheduleModal) scheduleModal.style.display = 'none';
                
                // Show countdown if within 1 hour
                const timeUntilRide = scheduledTime - Date.now();
                if (timeUntilRide <= 3600000) {
                    EnhancedUIUpdater.showScheduleCountdown(scheduledTime);
                }
                
                EnhancedUIUpdater.showToast('Ride scheduled successfully', 'success');
                
            } catch (error) {
                console.error('Error scheduling ride:', error);
                EnhancedUIUpdater.showToast('Error scheduling ride', 'error');
            }
        });
    }
    
    // Share ride button
    const confirmShareRideBtn = document.getElementById('confirmShareRideBtn');
    if (confirmShareRideBtn) {
        confirmShareRideBtn.addEventListener('click', async () => {
            if (!AppState.pickup || !AppState.destination) {
                EnhancedUIUpdater.showToast('Please select pickup and destination', 'warning');
                return;
            }
            
            if (AppState.shareRideFriends.length === 0) {
                EnhancedUIUpdater.showToast('Please add friends to share the ride', 'warning');
                return;
            }
            
            const distance = AdvancedCityDetector.calculateDistance(
                AppState.pickup.lat, AppState.pickup.lng,
                AppState.destination.lat, AppState.destination.lng
            );
            
            const rideData = {
                pickup: AppState.pickup.address,
                pickupDisplay: AppState.pickup.fullDisplay || AppState.pickup.name,
                destination: AppState.destination.address,
                destinationDisplay: AppState.destination.fullAddress || AppState.destination.name,
                pickupLat: AppState.pickup.lat,
                pickupLng: AppState.pickup.lng,
                destLat: AppState.destination.lat,
                destLng: AppState.destination.lng,
                rideType: AppState.selectedRideType,
                fare: AppState.rideFare,
                distance: distance
            };
            
            try {
                // Create share ride
                const shareRideId = await EnhancedFirebaseManager.createShareRide(rideData, AppState.shareRideFriends);
                
                // Hide share ride modal
                const shareRideModal = document.getElementById('shareRideModal');
                if (shareRideModal) shareRideModal.style.display = 'none';
                
                // Show payment modal
                EnhancedUIUpdater.showPaymentModal(rideData);
                
            } catch (error) {
                console.error('Error creating share ride:', error);
                EnhancedUIUpdater.showToast('Error creating share ride', 'error');
            }
        });
    }
    
    // Add share friend button
    const addShareMemberBtn = document.getElementById('addShareMemberBtn');
    if (addShareMemberBtn) {
        addShareMemberBtn.addEventListener('click', async () => {
            const memberInput = document.getElementById('shareMemberInput');
            if (!memberInput) return;
            
            const referralCode = memberInput.value.trim();
            if (!referralCode) {
                EnhancedUIUpdater.showToast('Please enter a referral code', 'warning');
                return;
            }
            
            // Check if already added
            if (AppState.shareRideFriends.some(friend => friend.code === referralCode)) {
                EnhancedUIUpdater.showToast('Friend already added', 'warning');
                return;
            }
            
            // Check max friends
            if (AppState.shareRideFriends.length >= AppState.maxShareFriends) {
                EnhancedUIUpdater.showToast(`Maximum ${AppState.maxShareFriends} friends allowed`, 'warning');
                return;
            }
            
            // Find user by referral code
            const friendData = await EnhancedFirebaseManager.findUserByReferralCode(referralCode);
            if (!friendData) {
                EnhancedUIUpdater.showToast('Friend not found. Please check the referral code.', 'error');
                return;
            }
            
            // Add friend
            const friend = {
                userId: friendData.id,
                name: friendData.name,
                phone: friendData.phone,
                code: referralCode
            };
            
            AppState.shareRideFriends.push(friend);
            memberInput.value = '';
            
            // Update friend list
            updateShareFriendList();
            
            // Update share calculations
            EnhancedUIUpdater.updateShareRideCalculations();
            
            EnhancedUIUpdater.showToast(`${friend.name} added to ride`, 'success');
        });
    }
    
    // Broadcast ride button
    const startBroadcastRideBtn = document.getElementById('startBroadcastRideBtn');
    if (startBroadcastRideBtn) {
        startBroadcastRideBtn.addEventListener('click', async () => {
            if (!AppState.pickup || !AppState.destination) {
                EnhancedUIUpdater.showToast('Please select pickup and destination', 'warning');
                return;
            }
            
            if (AppState.broadcastRecipients.length === 0) {
                EnhancedUIUpdater.showToast('Please add friends to broadcast to', 'warning');
                return;
            }
            
            const distance = AdvancedCityDetector.calculateDistance(
                AppState.pickup.lat, AppState.pickup.lng,
                AppState.destination.lat, AppState.destination.lng
            );
            
            const rideData = {
                pickup: AppState.pickup.address,
                pickupDisplay: AppState.pickup.fullDisplay || AppState.pickup.name,
                destination: AppState.destination.address,
                destinationDisplay: AppState.destination.fullAddress || AppState.destination.name,
                pickupLat: AppState.pickup.lat,
                pickupLng: AppState.pickup.lng,
                destLat: AppState.destination.lat,
                destLng: AppState.destination.lng,
                rideType: AppState.selectedRideType,
                fare: AppState.rideFare,
                distance: distance
            };
            
            try {
                // Create broadcast ride
                const { broadcastId, rideId } = await EnhancedFirebaseManager.createBroadcastRide(
                    rideData, 
                    AppState.broadcastRecipients
                );
                
                // Hide broadcast modal
                const broadcastModal = document.getElementById('broadcastModal');
                if (broadcastModal) broadcastModal.style.display = 'none';
                
                // Show payment modal
                EnhancedUIUpdater.showPaymentModal(rideData);
                
            } catch (error) {
                console.error('Error creating broadcast ride:', error);
                EnhancedUIUpdater.showToast('Error creating broadcast ride', 'error');
            }
        });
    }
    
    // Add broadcast recipient button
    const addBroadcastMemberBtn = document.getElementById('addBroadcastMemberBtn');
    if (addBroadcastMemberBtn) {
        addBroadcastMemberBtn.addEventListener('click', async () => {
            const memberInput = document.getElementById('broadcastMemberInput');
            if (!memberInput) return;
            
            const referralCode = memberInput.value.trim();
            if (!referralCode) {
                EnhancedUIUpdater.showToast('Please enter a referral code', 'warning');
                return;
            }
            
            // Check if already added
            if (AppState.broadcastRecipients.some(recipient => recipient.code === referralCode)) {
                EnhancedUIUpdater.showToast('Recipient already added', 'warning');
                return;
            }
            
            // Find user by referral code
            const recipientData = await EnhancedFirebaseManager.findUserByReferralCode(referralCode);
            if (!recipientData) {
                EnhancedUIUpdater.showToast('User not found. Please check the referral code.', 'error');
                return;
            }
            
            // Add recipient
            const recipient = {
                userId: recipientData.id,
                name: recipientData.name,
                phone: recipientData.phone,
                code: referralCode
            };
            
            AppState.broadcastRecipients.push(recipient);
            memberInput.value = '';
            
            // Update recipient list
            updateBroadcastRecipientList();
            
            EnhancedUIUpdater.showToast(`${recipient.name} added to broadcast`, 'success');
        });
    }
    
    // Emergency services
    document.querySelectorAll('.emergency-service').forEach(service => {
        service.addEventListener('click', async () => {
            const type = service.dataset.type;
            
            if (type === 'sos') {
                // Show SOS modal
                const sosModal = document.getElementById('sosModal');
                if (sosModal) sosModal.style.display = 'block';
                return;
            }
            
            if (!AppState.currentCity) {
                EnhancedUIUpdater.showToast('Please wait for city detection', 'warning');
                return;
            }
            
            // Load emergency stations
            const stations = await EnhancedFirebaseManager.loadEmergencyStations(AppState.currentCity, type);
            
            // Update emergency service type
            const emergencyServiceType = document.getElementById('emergencyServiceType');
            if (emergencyServiceType) {
                emergencyServiceType.textContent = 
                    type.charAt(0).toUpperCase() + type.slice(1) + ' Ride';
                emergencyServiceType.dataset.type = type;
            }
            
            // Show stations
            EnhancedUIUpdater.showEmergencyStations(stations, type);
            
            // Show emergency modal
            const emergencyModal = document.getElementById('emergencyModal');
            if (emergencyModal) emergencyModal.style.display = 'block';
        });
    });
    
    // Emergency reasons
    document.querySelectorAll('.emergency-reason').forEach(reason => {
        reason.addEventListener('click', () => {
            document.querySelectorAll('.emergency-reason').forEach(r => {
                r.classList.remove('selected');
            });
            reason.classList.add('selected');
            
            const reasonType = reason.dataset.reason;
            const otherReasonGroup = document.getElementById('emergencyReasonOther');
            if (otherReasonGroup) {
                otherReasonGroup.style.display = 
                    reasonType === 'other' ? 'block' : 'none';
            }
        });
    });
    
    // Confirm emergency ride button
    const confirmEmergencyBtn = document.getElementById('confirmEmergencyBtn');
    if (confirmEmergencyBtn) {
        confirmEmergencyBtn.addEventListener('click', async () => {
            if (!AppState.selectedEmergencyStation) {
                EnhancedUIUpdater.showToast('Please select an emergency station', 'warning');
                return;
            }
            
            const selectedReason = document.querySelector('.emergency-reason.selected');
            if (!selectedReason) {
                EnhancedUIUpdater.showToast('Please select an emergency reason', 'warning');
                return;
            }
            
            let reason = selectedReason.dataset.reason;
            if (reason === 'other') {
                const otherReason = document.getElementById('emergencyOtherReason')?.value;
                if (!otherReason?.trim()) {
                    EnhancedUIUpdater.showToast('Please describe the emergency', 'warning');
                    return;
                }
                reason = otherReason;
            }
            
            const emergencyServiceType = document.getElementById('emergencyServiceType');
            const type = emergencyServiceType?.dataset.type || 'police';
            
            const station = AppState.selectedEmergencyStation;
            const fare = parseFloat(document.getElementById('emergencyTotalFare')?.textContent.replace('ZMW ', '') || '0');
            
            const emergencyData = {
                pickup: AppState.pickup?.address || 'Current Location',
                pickupDisplay: AppState.pickup?.fullDisplay || 'Current Location',
                destination: station.name,
                destinationDisplay: station.address,
                pickupLat: AppState.pickup?.lat || AppState.userLocation.lat,
                pickupLng: AppState.pickup?.lng || AppState.userLocation.lng,
                destLat: station.lat,
                destLng: station.lng,
                rideType: 'emergency',
                fare: fare,
                distance: station.distance,
                emergency: true,
                emergencyType: type,
                emergencyReason: reason,
                emergencyStation: station.name
            };
            
            // Show payment modal
            EnhancedUIUpdater.showPaymentModal(emergencyData);
            
            // Hide emergency modal
            const emergencyModal = document.getElementById('emergencyModal');
            if (emergencyModal) emergencyModal.style.display = 'none';
        });
    }
    
    // Add stop button
    const addStopBtn = document.getElementById('addStopBtn');
    if (addStopBtn) {
        addStopBtn.addEventListener('click', () => {
            addRideStop();
        });
    }
    
    // Deposit button
    const depositBtn = document.getElementById('depositBtn');
    if (depositBtn) {
        depositBtn.addEventListener('click', () => {
            const amount = prompt('Enter deposit amount (ZMW):');
            if (amount && !isNaN(parseFloat(amount)) && parseFloat(amount) > 0) {
                EnhancedFirebaseManager.depositMoney(parseFloat(amount))
                    .then(result => {
                        EnhancedUIUpdater.showToast(`Deposited ZMW ${amount} successfully`, 'success');
                    })
                    .catch(error => {
                        EnhancedUIUpdater.showToast('Error depositing money: ' + error.message, 'error');
                    });
            }
        });
    }
    
    // Withdraw button
    const withdrawBtn = document.getElementById('withdrawBtn');
    if (withdrawBtn) {
        withdrawBtn.addEventListener('click', () => {
            const amount = prompt('Enter withdrawal amount (ZMW):');
            if (amount && !isNaN(parseFloat(amount)) && parseFloat(amount) > 0) {
                EnhancedFirebaseManager.withdrawMoney(parseFloat(amount))
                    .then(result => {
                        EnhancedUIUpdater.showToast(`Withdrew ZMW ${amount} successfully`, 'success');
                    })
                    .catch(error => {
                        EnhancedUIUpdater.showToast('Error withdrawing money: ' + error.message, 'error');
                    });
            }
        });
    }
    
    // Transfer button
    const transferBtn = document.getElementById('transferBtn');
    if (transferBtn) {
        transferBtn.addEventListener('click', () => {
            const recipientCode = prompt("Enter recipient's referral code:");
            if (!recipientCode) return;
            
            const amount = prompt('Enter transfer amount (ZMW):');
            if (!amount || isNaN(parseFloat(amount)) || parseFloat(amount) <= 0) return;
            
            const message = prompt('Optional message:') || '';
            
            EnhancedFirebaseManager.transferMoney(recipientCode, parseFloat(amount), message)
                .then(result => {
                    EnhancedUIUpdater.showToast(
                        `Transferred ZMW ${amount} to ${result.recipientName}`, 
                        'success'
                    );
                })
                .catch(error => {
                    EnhancedUIUpdater.showToast('Error transferring money: ' + error.message, 'error');
                });
        });
    }
    
    // Transactions button
    const transactionsBtn = document.getElementById('transactionsBtn');
    if (transactionsBtn) {
        transactionsBtn.addEventListener('click', async () => {
            const transactions = await EnhancedFirebaseManager.loadTransactions();
            displayTransactions(transactions);
            
            const transactionsModal = document.getElementById('transactionsModal');
            if (transactionsModal) transactionsModal.style.display = 'block';
        });
    }
    
    // SOS button
    const sosButton = document.getElementById('sosButton');
    if (sosButton) {
        sosButton.addEventListener('click', () => {
            if (!AppState.sosConfig) {
                EnhancedUIUpdater.showToast('Please setup SOS contacts first', 'warning');
                return;
            }
            
            if (!AppState.currentRide) {
                EnhancedUIUpdater.showToast('No active ride to report SOS for', 'warning');
                return;
            }
            
            if (confirm('Send SOS alert to emergency contacts?')) {
                // This would trigger actual SOS functionality
                EnhancedUIUpdater.showToast('SOS alert sent to emergency contacts', 'success');
            }
        });
    }
    
    // Navigation tabs
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const screen = tab.dataset.screen;
            switchScreen(screen);
        });
    });
    
    // Service tabs
    document.querySelectorAll('.service-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const service = tab.dataset.service;
            switchService(service);
        });
    });
    
    // Close modals
    document.querySelectorAll('.modal-close').forEach(btn => {
        btn.addEventListener('click', () => {
            const modal = btn.closest('.modal-overlay');
            if (modal) modal.style.display = 'none';
        });
    });
    
    console.log('Event listeners setup completed');
}

// Switch screen
function switchScreen(screen) {
    // Hide all screens
    document.querySelectorAll('.history-screen, .account-screen, .emergency-screen').forEach(s => {
        s.style.display = 'none';
        s.classList.remove('active');
    });
    
    // Update nav tabs
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Show selected screen
    if (screen === 'home') {
        AppState.activeScreen = 'home';
        const homeTab = document.querySelector('.nav-tab[data-screen="home"]');
        if (homeTab) homeTab.classList.add('active');
    } else {
        const screenElement = document.getElementById(`${screen}Screen`);
        if (screenElement) {
            screenElement.style.display = 'block';
            screenElement.classList.add('active');
            
            const screenTab = document.querySelector(`.nav-tab[data-screen="${screen}"]`);
            if (screenTab) screenTab.classList.add('active');
            
            AppState.activeScreen = screen;
            
            // Load data for specific screens
            if (screen === 'history') {
                EnhancedFirebaseManager.loadRideHistory(AppState.currentUser.uid);
            }
        }
    }
}

// Switch service
function switchService(service) {
    // Hide all forms
    document.querySelectorAll('.ride-request-form, .service-form, #broadcastForm').forEach(form => {
        form.style.display = 'none';
        form.classList.remove('active');
    });
    
    // Update service tabs
    document.querySelectorAll('.service-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Show selected service form
    AppState.activeService = service;
    
    switch(service) {
        case 'car':
            document.querySelector('.service-tab.car')?.classList.add('active');
            document.getElementById('carForm').style.display = 'block';
            document.getElementById('carForm').classList.add('active');
            break;
        case 'delivery':
            document.querySelector('.service-tab.delivery')?.classList.add('active');
            document.getElementById('deliveryForm').style.display = 'block';
            document.getElementById('deliveryForm').classList.add('active');
            break;
        case 'short-delivery':
            document.querySelector('.service-tab.short-delivery')?.classList.add('active');
            document.getElementById('shortDeliveryForm').style.display = 'block';
            document.getElementById('shortDeliveryForm').classList.add('active');
            break;
        case 'express':
            document.querySelector('.service-tab[data-service="express"]')?.classList.add('active');
            document.getElementById('expressForm').style.display = 'block';
            document.getElementById('expressForm').classList.add('active');
            break;
        case 'truck':
            document.querySelector('.service-tab[data-service="truck"]')?.classList.add('active');
            document.getElementById('truckForm').style.display = 'block';
            document.getElementById('truckForm').classList.add('active');
            break;
        case 'broadcast':
            document.getElementById('broadcastForm').style.display = 'block';
            document.getElementById('broadcastForm').classList.add('active');
            break;
    }
}

// Add ride stop
function addRideStop() {
    if (AppState.rideStops.length >= AppState.maxStops) {
        EnhancedUIUpdater.showToast(`Maximum ${AppState.maxStops} stops allowed`, 'warning');
        return;
    }
    
    const stopNumber = AppState.rideStops.length + 1;
    const stopId = `stop-${Date.now()}`;
    
    const stopElement = document.createElement('div');
    stopElement.className = 'ride-stop';
    stopElement.id = stopId;
    stopElement.innerHTML = `
        <div class="stop-header">
            <i class="fas fa-map-pin"></i>
            <span>Stop ${stopNumber}</span>
            <button class="remove-stop-btn" onclick="removeRideStop('${stopId}')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="stop-input">
            <input type="text" class="stop-location-input" 
                   placeholder="Enter stop location" 
                   data-stop-id="${stopId}">
            <div class="suggestion-list" id="${stopId}Suggestions"></div>
        </div>
    `;
    
    const stopsContainer = document.getElementById('stopsContainer');
    if (stopsContainer) {
        stopsContainer.appendChild(stopElement);
        
        // Add event listener for stop input
        const stopInput = stopElement.querySelector('.stop-location-input');
        if (stopInput) {
            let searchTimeout;
            
            stopInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                
                const query = stopInput.value.trim();
                if (query.length < 2) {
                    const suggestions = document.getElementById(`${stopId}Suggestions`);
                    if (suggestions) suggestions.style.display = 'none';
                    return;
                }
                
                searchTimeout = setTimeout(async () => {
                    if (!AppState.currentCity) {
                        EnhancedUIUpdater.showToast('Please wait for city detection', 'warning');
                        return;
                    }
                    
                    const results = await IntelligentSearchEngine.search(
                        query,
                        'stop',
                        AppState.currentCity,
                        AppState.userLocation
                    );
                    
                    showStopSuggestions(stopId, results);
                }, 300);
            });
        }
    }
    
    AppState.rideStops.push({
        id: stopId,
        number: stopNumber
    });
}

// Remove ride stop
function removeRideStop(stopId) {
    const stopElement = document.getElementById(stopId);
    if (stopElement) {
        stopElement.remove();
    }
    
    AppState.rideStops = AppState.rideStops.filter(stop => stop.id !== stopId);
    
    // Renumber remaining stops
    AppState.rideStops.forEach((stop, index) => {
        stop.number = index + 1;
        const stopElement = document.getElementById(stop.id);
        if (stopElement) {
            const header = stopElement.querySelector('.stop-header span');
            if (header) header.textContent = `Stop ${stop.number}`;
        }
    });
}

// Show stop suggestions
function showStopSuggestions(stopId, results) {
    const container = document.getElementById(`${stopId}Suggestions`);
    if (!container) return;
    
    container.innerHTML = '';
    
    if (results.length === 0) {
        container.innerHTML = '<div class="no-results">No results found</div>';
    } else {
        results.forEach(result => {
            const item = document.createElement('div');
            item.className = 'suggestion-item';
            item.innerHTML = `
                <div class="suggestion-icon">
                    <i class="fas fa-map-marker-alt"></i>
                </div>
                <div class="suggestion-details">
                    <div class="suggestion-name">${result.name}</div>
                    <div class="suggestion-address">${result.address}</div>
                </div>
            `;
            
            item.addEventListener('click', () => {
                const stopInput = document.querySelector(`[data-stop-id="${stopId}"]`);
                if (stopInput) {
                    stopInput.value = result.address;
                    
                    // Add stop to AppState
                    const stop = AppState.rideStops.find(s => s.id === stopId);
                    if (stop) {
                        stop.location = result;
                        stop.address = result.address;
                        stop.lat = result.lat;
                        stop.lng = result.lng;
                    }
                }
                
                container.style.display = 'none';
            });
            
            container.appendChild(item);
        });
    }
    
    container.style.display = 'block';
    
    const stopInput = document.querySelector(`[data-stop-id="${stopId}"]`);
    if (stopInput) {
        const rect = stopInput.getBoundingClientRect();
        container.style.top = `${rect.bottom + window.scrollY + 5}px`;
        container.style.left = `${rect.left + window.scrollX}px`;
        container.style.width = `${rect.width}px`;
    }
}

// Update share friend list
function updateShareFriendList() {
    const container = document.getElementById('shareFriendsList');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (AppState.shareRideFriends.length === 0) {
        container.innerHTML = '<div class="empty-share">No friends added yet</div>';
        return;
    }
    
    AppState.shareRideFriends.forEach(friend => {
        const friendElement = document.createElement('div');
        friendElement.className = 'share-friend-item';
        friendElement.dataset.friendId = friend.userId;
        friendElement.innerHTML = `
            <div class="friend-avatar">
                <i class="fas fa-user"></i>
            </div>
            <div class="friend-info">
                <div class="friend-name">${friend.name}</div>
                <div class="friend-phone">${friend.phone}</div>
            </div>
            <div class="friend-share">
                ZMW 0.00
            </div>
            <button class="remove-friend-btn" onclick="removeShareFriend('${friend.code}')">
                <i class="fas fa-times"></i>
            </button>
        `;
        container.appendChild(friendElement);
    });
    
    // Update shares
    EnhancedUIUpdater.updateShareRideCalculations();
}

// Remove share friend
function removeShareFriend(friendCode) {
    AppState.shareRideFriends = AppState.shareRideFriends.filter(friend => friend.code !== friendCode);
    updateShareFriendList();
}

// Update broadcast recipient list
function updateBroadcastRecipientList() {
    const container = document.getElementById('broadcastMembersContainer');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (AppState.broadcastRecipients.length === 0) {
        container.innerHTML = '<div class="empty-broadcast">No recipients added yet</div>';
        return;
    }
    
    AppState.broadcastRecipients.forEach(recipient => {
        const recipientElement = document.createElement('div');
        recipientElement.className = 'broadcast-recipient-item';
        recipientElement.innerHTML = `
            <div class="recipient-avatar">
                <i class="fas fa-user"></i>
            </div>
            <div class="recipient-info">
                <div class="recipient-name">${recipient.name}</div>
                <div class="recipient-phone">${recipient.phone}</div>
            </div>
            <button class="remove-recipient-btn" onclick="removeBroadcastRecipient('${recipient.code}')">
                <i class="fas fa-times"></i>
            </button>
        `;
        container.appendChild(recipientElement);
    });
}

// Remove broadcast recipient
function removeBroadcastRecipient(recipientCode) {
    AppState.broadcastRecipients = AppState.broadcastRecipients.filter(
        recipient => recipient.code !== recipientCode
    );
    updateBroadcastRecipientList();
}

// Display transactions
function displayTransactions(transactions) {
    const container = document.getElementById('transactionsList');
    if (!container) return;
    
    if (transactions.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="fas fa-receipt"></i>
                </div>
                <div class="empty-title">No transactions</div>
                <div class="empty-message">Your transaction history will appear here</div>
            </div>
        `;
        return;
    }
    
    let html = '';
    transactions.forEach(transaction => {
        const date = new Date(transaction.timestamp);
        const isNegative = transaction.amount < 0;
        const amountClass = isNegative ? 'negative' : 'positive';
        const amountSign = isNegative ? '-' : '+';
        const amount = Math.abs(transaction.amount);
        
        let typeIcon = 'fa-exchange-alt';
        let typeText = transaction.type.replace(/_/g, ' ');
        
        switch(transaction.type) {
            case 'deposit':
                typeIcon = 'fa-plus-circle';
                typeText = 'Deposit';
                break;
            case 'withdrawal':
                typeIcon = 'fa-minus-circle';
                typeText = 'Withdrawal';
                break;
            case 'transfer_sent':
                typeIcon = 'fa-arrow-up';
                typeText = 'Transfer Sent';
                break;
            case 'transfer_received':
                typeIcon = 'fa-arrow-down';
                typeText = 'Transfer Received';
                break;
            case 'ride_payment':
                typeIcon = 'fa-car';
                typeText = 'Ride Payment';
                break;
            case 'referral_reward':
                typeIcon = 'fa-gift';
                typeText = 'Referral Reward';
                break;
        }
        
        html += `
            <div class="transaction-item">
                <div class="transaction-header">
                    <div class="transaction-type">
                        <i class="fas ${typeIcon}"></i>
                        <span>${typeText}</span>
                    </div>
                    <div class="transaction-date">
                        ${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                    </div>
                </div>
                <div class="transaction-details">
                    <div class="transaction-description">
                        ${transaction.description || ''}
                        ${transaction.message ? `<div class="transaction-message">${transaction.message}</div>` : ''}
                        ${transaction.rideId ? `<div class="transaction-ride">Ride ID: ${transaction.rideId.substring(0, 8)}...</div>` : ''}
                        ${transaction.recipientName ? `<div class="transaction-recipient">To: ${transaction.recipientName}</div>` : ''}
                        ${transaction.senderName ? `<div class="transaction-sender">From: ${transaction.senderName}</div>` : ''}
                    </div>
                    <div class="transaction-amount ${amountClass}">
                        ${amountSign}ZMW ${amount.toFixed(2)}
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// ============================================
// START THE APPLICATION
// ============================================

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', initializeApp);

// Export functions to global scope
window.removeRideStop = removeRideStop;
window.removeShareFriend = removeShareFriend;
window.removeBroadcastRecipient = removeBroadcastRecipient;
window.switchScreen = switchScreen;
window.switchService = switchService;
window.addRideStop = addRideStop;

console.log('Jubel Passenger App script loaded');
    </script>
</body>
</html>







