<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jubel - Passenger</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Enhanced CSS with advanced features - Total lines: ~1200 */
        :root {
            --primary-orange: #FF6B35;
            --primary-red: #E74C3C;
            --primary-gradient: linear-gradient(135deg, #FF6B35, #E74C3C);
            --secondary-orange: #E55A28;
            --secondary-red: #C0392B;
            --light-orange: #FFE8E0;
            --light-red: #FADBD8;
            --white: #FFFFFF;
            --light-gray: #F5F5F5;
            --dark-gray: #333333;
            --medium-gray: #777777;
            --success-green: #2ecc71;
            --warning-yellow: #f39c12;
            --info-blue: #3498db;
            --error-red: #e74c3c;
            --border-color: #E8E8E8;
            --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 4px 15px rgba(0, 0, 0, 0.15);
            --shadow-heavy: 0 6px 20px rgba(0, 0, 0, 0.2);
            --app-padding: 10px;
            --element-radius: 6px;
            --transition-speed: 0.3s;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--white);
            color: var(--dark-gray);
            max-width: 100%;
            overflow-x: hidden;
            height: 100vh;
            font-size: 13px;
        }
        
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        .floating-balance {
            position: fixed;
            top: 10px;
            right: 10px;
            background: var(--white);
            padding: 6px 10px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 700;
            color: var(--dark-gray);
            border: 2px solid var(--primary-orange);
            font-size: 0.75rem;
        }
        
        .balance-amount {
            color: var(--primary-orange);
            font-size: 0.8rem;
        }
        
        .passenger-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            border-radius: 15px 15px 0 0;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
            z-index: 100;
            padding: var(--app-padding);
            transform: translateY(0);
            transition: transform var(--transition-speed) ease;
            max-height: 45vh;
            overflow-y: auto;
        }
        
        .passenger-panel.collapsed {
            transform: translateY(calc(100% - 40px));
        }
        
        .panel-collapse-handle {
            width: 35px;
            height: 3px;
            background: var(--border-color);
            border-radius: 2px;
            margin: 0 auto 8px;
            cursor: pointer;
        }
        
        .nav-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            padding: 6px 3px;
            border-radius: var(--element-radius);
            background: var(--light-gray);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            border: none;
            font-size: 0.6rem;
            font-weight: 600;
        }
        
        .nav-btn.active {
            background: var(--primary-gradient);
            color: var(--white);
        }
        
        .nav-btn i {
            font-size: 0.8rem;
        }
        
        /* Schedule Ride Button - Matches More Options Button */
        .schedule-ride-btn {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--primary-orange);
            color: var(--white);
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .more-options-btn {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--white);
            color: var(--primary-orange);
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            border-color: var(--primary-orange);
        }
        
        .more-options-dropdown {
            display: none;
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            margin-top: 5px;
            overflow: hidden;
            box-shadow: var(--shadow-medium);
        }
        
        .more-options-dropdown.active {
            display: block;
        }
        
        .more-option-item {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all var(--transition-speed) ease;
        }
        
        .more-option-item:hover {
            background: var(--light-orange);
        }
        
        .more-option-item:last-child {
            border-bottom: none;
        }
        
        .more-option-icon {
            width: 20px;
            text-align: center;
            font-size: 0.9rem;
        }
        
        .more-option-text {
            flex: 1;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        /* Enhanced Location Input */
        .location-input {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--white);
            position: relative;
        }
        
        .location-input i {
            color: var(--primary-orange);
        }
        
        .location-input input {
            border: none;
            outline: none;
            width: 100%;
            font-size: 0.8rem;
        }
        
        .clear-pickup-btn {
            background: none;
            border: none;
            color: var(--error-red);
            font-size: 1rem;
            cursor: pointer;
            padding: 0 5px;
        }
        
        /* Enhanced Suggestion List */
        .suggestion-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-medium);
            z-index: 200;
            max-height: 180px;
            overflow-y: auto;
            display: none;
        }
        
        .suggestion-item {
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .suggestion-item:hover {
            background: var(--light-orange);
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
        
        .suggestion-item.first-result {
            background: var(--light-orange);
            border-left: 3px solid var(--primary-orange);
        }
        
        .suggestion-icon {
            font-size: 0.9rem;
            width: 18px;
            text-align: center;
        }
        
        .suggestion-details {
            flex: 1;
        }
        
        .suggestion-name {
            font-weight: 600;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 4px;
            flex-wrap: wrap;
        }
        
        .city-badge {
            background: var(--primary-orange);
            color: white;
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 0.6rem;
        }
        
        .current-city-indicator {
            color: var(--success-green);
            font-size: 0.6rem;
            font-weight: 600;
        }
        
        .suggestion-address {
            color: var(--medium-gray);
            font-size: 0.65rem;
            margin-top: 2px;
        }
        
        .suggestion-distance {
            color: var(--medium-gray);
            font-size: 0.55rem;
            margin-top: 2px;
        }
        
        /* City Detection Indicator */
        .city-indicator {
            position: fixed;
            top: 10px;
            left: 10px;
            background: var(--white);
            padding: 6px 10px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 100;
            font-weight: 700;
            color: var(--dark-gray);
            border: 2px solid var(--info-blue);
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .city-name {
            color: var(--info-blue);
            font-weight: 800;
        }
        
        /* Enhanced Forms */
        .order-for-someone-form,
        .express-delivery-form,
        .sos-setup-form {
            display: none;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
        }
        
        .order-for-someone-form.active,
        .express-delivery-form.active,
        .sos-setup-form.active {
            display: flex;
        }
        
        .delivery-fee-display {
            background: var(--primary-gradient);
            color: var(--white);
            padding: 10px;
            border-radius: var(--element-radius);
            text-align: center;
            margin: 8px 0;
        }
        
        .delivery-fee-amount {
            font-size: 1.2rem;
            font-weight: 800;
            margin: 4px 0;
        }
        
        .delivery-eta-display {
            font-size: 0.8rem;
            font-weight: 600;
            opacity: 0.9;
        }
        
        /* SOS Button */
        .sos-button {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--error-red);
            color: var(--white);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 700;
            box-shadow: var(--shadow-heavy);
            z-index: 150;
            cursor: pointer;
            animation: sos-pulse 2s infinite;
            display: none;
        }
        
        @keyframes sos-pulse {
            0% {
                transform: translateX(-50%) scale(1);
                box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7);
            }
            70% {
                transform: translateX(-50%) scale(1.05);
                box-shadow: 0 0 0 10px rgba(231, 76, 60, 0);
            }
            100% {
                transform: translateX(-50%) scale(1);
                box-shadow: 0 0 0 0 rgba(231, 76, 60, 0);
            }
        }
        
        /* Enhanced Ride Details Popup */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
        }
        
        .popup-overlay.hidden {
            display: none;
        }
        
        .popup-form {
            background: var(--white);
            border-radius: var(--element-radius);
            width: 100%;
            max-width: 450px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: var(--shadow-heavy);
        }
        
        .large-popup {
            max-width: 700px;
        }
        
        .popup-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .popup-title {
            font-size: 1.1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .close-popup {
            background: none;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            color: var(--medium-gray);
        }
        
        .popup-content {
            padding: 12px;
        }
        
        .popup-map-container {
            height: 180px;
            border-radius: var(--element-radius);
            overflow: hidden;
            margin-bottom: 12px;
        }
        
        .popup-details {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .detail-row:last-child {
            border-bottom: none;
        }
        
        .detail-label {
            font-weight: 600;
            font-size: 0.75rem;
        }
        
        .detail-value {
            font-size: 0.75rem;
            color: var(--medium-gray);
        }
        
        /* Enhanced Chat in Ride Details */
        .chat-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }
        
        .chat-messages-container {
            max-height: 200px;
            overflow-y: auto;
            background: var(--light-gray);
            border-radius: var(--element-radius);
            padding: 10px;
            margin-bottom: 10px;
        }
        
        .chat-message {
            margin-bottom: 8px;
            padding: 6px 10px;
            border-radius: 12px;
            max-width: 80%;
        }
        
        .chat-message.passenger {
            background: var(--light-orange);
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        
        .chat-message.driver {
            background: var(--white);
            border: 1px solid var(--border-color);
            border-bottom-left-radius: 4px;
        }
        
        .chat-message-time {
            font-size: 0.6rem;
            color: var(--medium-gray);
            margin-top: 2px;
            text-align: right;
        }
        
        /* Enhanced History Items */
        .history-item {
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            font-size: 0.7rem;
        }
        
        .history-item:hover {
            background: var(--light-orange);
        }
        
        .history-item-type {
            font-size: 0.65rem;
            font-weight: 600;
            padding: 2px 5px;
            border-radius: 8px;
            margin-bottom: 4px;
            display: inline-block;
        }
        
        .history-item-type.ride {
            background: var(--light-orange);
            color: var(--primary-orange);
        }
        
        .history-item-type.delivery {
            background: var(--light-red);
            color: var(--primary-red);
        }
        
        .history-locations {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-bottom: 5px;
        }
        
        .history-location {
            display: flex;
            align-items: flex-start;
            gap: 5px;
        }
        
        .history-location-icon {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.5rem;
            flex-shrink: 0;
            margin-top: 2px;
        }
        
        .history-location-icon.pickup {
            background: var(--primary-orange);
            color: white;
        }
        
        .history-location-icon.destination {
            background: var(--primary-red);
            color: white;
        }
        
        .history-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.65rem;
            color: var(--medium-gray);
        }
        
        .status-badge {
            padding: 2px 5px;
            border-radius: 10px;
            font-size: 0.6rem;
            font-weight: 700;
        }
        
        .status-completed {
            background: #e6f7e9;
            color: #2e7d32;
        }
        
        .status-cancelled {
            background: #ffebee;
            color: #c62828;
        }
        
        .status-pending {
            background: #fff3e0;
            color: #ef6c00;
        }
        
        .status-accepted {
            background: #e3f2fd;
            color: #1565c0;
        }
        
        .chat-indicator {
            font-size: 0.6rem;
            color: var(--info-blue);
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 2px;
        }
        
        /* Enhanced Driver Details in Ride History */
        .history-driver-info {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px dashed var(--border-color);
        }
        
        .history-driver-avatar {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            color: var(--white);
            font-weight: 700;
        }
        
        .history-driver-details {
            flex: 1;
        }
        
        .history-driver-name {
            font-size: 0.65rem;
            font-weight: 600;
        }
        
        .history-driver-rating {
            font-size: 0.55rem;
            color: var(--medium-gray);
            display: flex;
            align-items: center;
            gap: 2px;
        }
        
        .history-fare {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        /* Search Performance Indicators */
        .search-loading {
            padding: 8px;
            text-align: center;
            color: var(--medium-gray);
            font-size: 0.7rem;
        }
        
        .no-results {
            padding: 8px;
            text-align: center;
            color: var(--medium-gray);
            font-size: 0.7rem;
        }
        
        /* Schedule Ride Popup */
        .schedule-popup-content {
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .scheduling-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .scheduled-ride-item {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            margin-bottom: 8px;
            background: var(--light-gray);
        }
        
        .scheduled-ride-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .scheduled-ride-type {
            background: var(--primary-orange);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.6rem;
            font-weight: 600;
        }
        
        .scheduled-ride-fare {
            font-weight: 700;
            color: var(--primary-orange);
            font-size: 0.8rem;
        }
        
        .scheduled-countdown {
            font-size: 0.65rem;
            color: var(--info-blue);
            font-weight: 600;
            margin-top: 4px;
        }
        
        /* Real-time Search Indicator */
        .search-indicator {
            position: absolute;
            right: 30px;
            color: var(--primary-orange);
            font-size: 0.7rem;
            display: none;
        }
        
        .searching .search-indicator {
            display: block;
        }
        
        /* Enhanced Map Controls */
        .leaflet-control-custom {
            background: white;
            border-radius: 50%;
            box-shadow: var(--shadow-medium);
        }
        
        /* Responsive Design */
        @media (max-width: 480px) {
            .floating-balance, .city-indicator {
                padding: 5px 7px;
                font-size: 0.65rem;
            }
            
            .passenger-panel {
                padding: 8px;
            }
            
            .nav-buttons {
                gap: 3px;
            }
            
            .nav-btn {
                padding: 5px 2px;
                font-size: 0.55rem;
            }
            
            .schedule-ride-btn,
            .more-options-btn {
                font-size: 0.7rem;
                padding: 6px;
            }
        }
        
        @media (min-width: 768px) {
            .passenger-panel {
                max-width: 450px;
                margin: 0 auto;
                left: 50%;
                transform: translateX(-50%);
            }
            
            .passenger-panel.collapsed {
                transform: translate(-50%, calc(100% - 40px));
            }
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease;
        }
        
        .slide-up {
            animation: slideUp 0.3s ease;
        }
        
        /* Loading States */
        .loading {
            position: relative;
            pointer-events: none;
        }
        
        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid var(--primary-orange);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Status Indicators */
        .ride-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: var(--white);
            padding: 6px 10px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 700;
            color: var(--dark-gray);
            border: 2px solid var(--border-color);
            font-size: 0.75rem;
            display: none;
        }
        
        .status-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: var(--medium-gray);
        }
        
        .status-dot.searching {
            background: var(--warning-yellow);
            animation: pulse 2s infinite;
        }
        
        .status-dot.arriving {
            background: var(--info-blue);
            animation: pulse 1.5s infinite;
        }
        
        .status-dot.riding {
            background: var(--success-green);
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .estimated-time {
            position: fixed;
            top: 50px;
            right: 10px;
            background: var(--white);
            padding: 6px 10px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 700;
            color: var(--dark-gray);
            border: 2px solid var(--border-color);
            font-size: 0.75rem;
            display: none;
        }
        
        /* Driver Search Animation */
        .searching-animation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 200;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .searching-pulse {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(255, 107, 53, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse-ring 2s infinite;
            position: relative;
        }
        
        .searching-pulse-inner {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }
        
        .searching-text {
            margin-top: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 12px;
            border-radius: var(--element-radius);
            font-weight: 600;
            color: var(--primary-orange);
            box-shadow: var(--shadow-medium);
        }
        
        @keyframes pulse-ring {
            0% {
                transform: scale(0.8);
                opacity: 1;
            }
            80%, 100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-gradient);
            color: var(--white);
            padding: 8px 14px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 300;
            display: none;
            font-weight: 600;
            text-align: center;
            font-size: 0.75rem;
            max-width: 80%;
        }
        
        /* Map Markers */
        .driver-marker {
            background: var(--primary-gradient);
            color: white;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .driver-marker-label {
            background: white;
            padding: 2px 4px;
            border-radius: 6px;
            margin-top: 3px;
            font-size: 8px;
            font-weight: bold;
            box-shadow: 0 1px 5px rgba(0,0,0,0.2);
        }
        
        .pickup-marker {
            background: var(--primary-orange);
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .destination-marker {
            background: var(--primary-red);
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .current-location-marker {
            background: var(--info-blue);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        /* Screen Content */
        .screen-content {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 50px;
            background: var(--white);
            z-index: 90;
            padding: var(--app-padding);
            overflow-y: auto;
            display: none;
        }
        
        .screen-content.active {
            display: block;
        }
        
        .screen-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .back-button {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            font-size: 0.9rem;
        }
        
        .screen-title {
            font-size: 1rem;
            font-weight: 700;
        }
        
        /* Existing Ride Request Form */
        .ride-request-form {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .vehicle-selection {
            display: flex;
            gap: 6px;
            margin: 8px 0;
        }
        
        .vehicle-option {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 4px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .vehicle-option.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .vehicle-icon {
            font-size: 1rem;
            color: var(--medium-gray);
        }
        
        .vehicle-option.selected .vehicle-icon {
            color: var(--primary-orange);
        }
        
        .vehicle-name {
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .vehicle-price {
            font-size: 0.65rem;
            color: var(--medium-gray);
        }
        
        .promo-section {
            margin-top: 8px;
            padding: 8px;
            border: 1px dashed var(--border-color);
            border-radius: var(--element-radius);
            display: none;
        }
        
        .promo-section.active {
            display: block;
        }
        
        .promo-input {
            display: flex;
            gap: 6px;
        }
        
        .promo-input input {
            flex: 1;
            padding: 6px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 0.75rem;
        }
        
        .btn-promo {
            background: var(--primary-orange);
            color: var(--white);
            border: none;
            border-radius: var(--element-radius);
            padding: 6px 10px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .promo-toggle {
            width: 100%;
            padding: 6px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .fare-display {
            background: var(--primary-gradient);
            color: var(--white);
            padding: 10px;
            border-radius: var(--element-radius);
            text-align: center;
            margin: 8px 0;
            box-shadow: var(--shadow-medium);
        }
        
        .fare-amount {
            font-size: 1.5rem;
            font-weight: 800;
            margin: 4px 0;
        }
        
        .eta-display {
            font-size: 0.9rem;
            font-weight: 600;
            opacity: 0.9;
        }
        
        .request-ride-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: var(--element-radius);
            background: var(--primary-gradient);
            color: var(--white);
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            margin-top: 8px;
            box-shadow: var(--shadow-medium);
        }
        
        .request-ride-btn:disabled {
            background: var(--medium-gray);
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .ride-info-panel {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 10px;
            box-shadow: var(--shadow-medium);
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            display: none;
        }
        
        .driver-info {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .driver-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            color: var(--white);
            font-weight: 700;
        }
        
        .driver-details h2 {
            font-size: 0.85rem;
            margin-bottom: 2px;
        }
        
        .driver-details p {
            color: var(--medium-gray);
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 3px;
            font-size: 0.7rem;
        }
        
        .trip-details {
            margin-bottom: 10px;
        }
        
        .location-row {
            display: flex;
            align-items: flex-start;
            gap: 5px;
            margin-bottom: 8px;
        }
        
        .location-icon {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            flex-shrink: 0;
        }
        
        .pickup-icon {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .destination-icon {
            background: var(--primary-red);
            color: var(--white);
        }
        
        .location-text {
            flex: 1;
        }
        
        .location-text h4 {
            font-size: 0.8rem;
            margin-bottom: 2px;
        }
        
        .location-text p {
            color: var(--medium-gray);
            font-size: 0.7rem;
        }
        
        .fare-details {
            background: var(--light-orange);
            padding: 8px;
            border-radius: var(--element-radius);
            margin-bottom: 10px;
        }
        
        .fare-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 0.7rem;
        }
        
        .fare-row.total {
            font-weight: 700;
            font-size: 0.8rem;
            border-top: 1px solid var(--border-color);
            padding-top: 5px;
            margin-top: 5px;
        }
        
        .ride-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }
        
        .btn {
            padding: 8px;
            border: none;
            border-radius: var(--element-radius);
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .btn-cancel {
            background: var(--error-red);
            color: var(--white);
        }
        
        .btn-contact {
            background: var(--info-blue);
            color: var(--white);
        }
        
        .btn-primary {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .saved-locations {
            display: flex;
            gap: 6px;
            margin: 8px 0;
        }
        
        .saved-location-btn {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
            cursor: pointer;
            font-size: 0.65rem;
            transition: all var(--transition-speed) ease;
        }
        
        .saved-location-btn:hover {
            background: var(--light-orange);
            border-color: var(--primary-orange);
        }
        
        /* Account Screen Styles */
        .account-section, .history-section, .payments-section {
            margin-bottom: 15px;
        }
        
        .section-title {
            font-size: 0.85rem;
            margin-bottom: 8px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .input-group {
            margin-bottom: 8px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 600;
            font-size: 0.75rem;
        }
        
        .input-field {
            width: 100%;
            padding: 8px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 0.75rem;
            transition: all var(--transition-speed) ease;
        }
        
        .input-field:focus {
            outline: none;
            border-color: var(--primary-orange);
        }
        
        .wallet-balance {
            background: var(--primary-gradient);
            color: var(--white);
            padding: 10px;
            border-radius: var(--element-radius);
            text-align: center;
            margin-bottom: 10px;
        }
        
        .balance-label {
            font-size: 0.7rem;
            margin-bottom: 2px;
        }
        
        .balance-amount-large {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 5px;
        }
        
        .wallet-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin-bottom: 10px;
        }
        
        .btn-wallet {
            background: var(--white);
            color: var(--primary-orange);
            border: 2px solid var(--primary-orange);
            padding: 6px;
            font-size: 0.7rem;
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .btn-wallet:hover {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .payment-methods {
            margin-top: 10px;
        }
        
        .payment-method {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            margin-bottom: 6px;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .payment-method.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .payment-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: var(--medium-gray);
        }
        
        .payment-details {
            flex: 1;
        }
        
        .payment-name {
            font-weight: 600;
            font-size: 0.75rem;
        }
        
        .payment-info {
            color: var(--medium-gray);
            font-size: 0.65rem;
        }
        
        /* Filter Options */
        .filter-options {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .filter-options select, .filter-options input {
            flex: 1;
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .stat-card {
            background: var(--light-gray);
            padding: 10px;
            border-radius: var(--element-radius);
            text-align: center;
        }
        
        .stat-number {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        .stat-label {
            font-size: 0.65rem;
            color: var(--medium-gray);
        }
        
        /* Referral Section */
        .referral-section {
            background: var(--light-orange);
            padding: 12px;
            border-radius: var(--element-radius);
            margin-bottom: 12px;
        }
        
        .referral-code {
            background: var(--white);
            padding: 8px;
            border-radius: var(--element-radius);
            text-align: center;
            margin: 8px 0;
        }
        
        .code {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        .description {
            font-size: 0.65rem;
            color: var(--medium-gray);
            margin-top: 4px;
        }
        
        /* Contact Section */
        .contact-section {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .contact-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: var(--element-radius);
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .contact-btn.whatsapp {
            background: #25D366;
            color: white;
        }
        
        .contact-btn.phone {
            background: var(--info-blue);
            color: white;
        }
        
        /* Driver Details Card */
        .driver-details-card {
            background: var(--light-orange);
            padding: 10px;
            border-radius: var(--element-radius);
            margin-bottom: 10px;
            border: 1px solid var(--primary-orange);
            display: none;
        }
        
        .driver-details-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 6px;
        }
        
        .driver-details-header h3 {
            font-size: 0.85rem;
            color: var(--primary-orange);
        }
        
        .driver-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }
        
        .driver-detail-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .driver-detail-label {
            font-size: 0.65rem;
            color: var(--medium-gray);
            font-weight: 600;
        }
        
        .driver-detail-value {
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .driver-vehicle-details {
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px dashed var(--border-color);
        }
        
        .vehicle-detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
            font-size: 0.65rem;
        }
        
        .vehicle-detail-label {
            color: var(--medium-gray);
        }
        
        .vehicle-detail-value {
            font-weight: 600;
        }
        
        /* Package Delivery Form */
        .package-form {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
            display: none;
        }
        
        .package-form.active {
            display: block;
        }
        
        .form-row {
            display: flex;
            gap: 6px;
            margin-bottom: 6px;
        }
        
        .form-group {
            flex: 1;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 3px;
            font-weight: 600;
            font-size: 0.7rem;
        }
        
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 6px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 0.7rem;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 50px;
        }
        
        .package-toggle {
            width: 100%;
            padding: 6px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        /* Payment Selection Popup */
        .payment-selection-popup {
            max-width: 350px;
        }
        
        .payment-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            margin-bottom: 8px;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .payment-option.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .payment-option-icon {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            color: var(--medium-gray);
        }
        
        .payment-option.selected .payment-option-icon {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .payment-option-details {
            flex: 1;
        }
        
        .payment-option-name {
            font-weight: 600;
            font-size: 0.85rem;
        }
        
        .payment-option-description {
            color: var(--medium-gray);
            font-size: 0.7rem;
        }
        
        .payment-option-balance {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--primary-orange);
        }
        
        .confirm-payment-btn {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: var(--element-radius);
            background: var(--primary-gradient);
            color: var(--white);
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            margin-top: 12px;
        }
        
        .confirm-payment-btn:disabled {
            background: var(--medium-gray);
            cursor: not-allowed;
        }
        
        .insufficient-balance {
            color: var(--error-red);
            font-size: 0.75rem;
            margin-top: 4px;
            display: none;
        }
        
        /* Rating Popup */
        .rating-stars {
            display: flex;
            gap: 4px;
            margin-top: 4px;
        }
        
        .star {
            font-size: 1.3rem;
            color: var(--light-gray);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .star.active {
            color: var(--warning-yellow);
        }
    </style>
</head>
<body>
    <!-- Main App -->
    <div id="mainApp">
        <!-- Main Map -->
        <div id="map"></div>
        
        <!-- City Indicator -->
        <div class="city-indicator home-only" id="cityIndicator">
            <i class="fas fa-map-marker-alt"></i>
            <span>City: <span class="city-name" id="currentCityDisplay">Detecting...</span></span>
        </div>
        
        <!-- Floating Balance -->
        <div class="floating-balance home-only">
            <i class="fas fa-wallet"></i>
            <span>Balance: <span class="balance-amount" id="walletBalance">K0.00</span></span>
        </div>
        
        <!-- Ride Status -->
        <div class="ride-status home-only" id="rideStatus">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Searching for driver</span>
        </div>
        
        <!-- Estimated Time -->
        <div class="estimated-time home-only" id="estimatedTime">
            <i class="fas fa-clock"></i>
            <span id="timeText">5 min</span>
        </div>
        
        <!-- SOS Button -->
        <div class="sos-button" id="sosButton">
            SOS
        </div>
        
        <!-- Driver Search Animation -->
        <div class="searching-animation" id="searchingAnimation">
            <div class="searching-pulse">
                <div class="searching-pulse-inner">
                    <i class="fas fa-car"></i>
                </div>
            </div>
            <div class="searching-text">Searching for driver</div>
        </div>
        
        <!-- Passenger Panel -->
        <div class="passenger-panel" id="passengerPanel">
            <div class="panel-collapse-handle" id="panelCollapseHandle"></div>
            
            <div class="nav-buttons">
                <button class="nav-btn active" data-screen="home">
                    <i class="fas fa-home"></i>
                    <span>Home</span>
                </button>
                <button class="nav-btn" data-screen="account">
                    <i class="fas fa-user"></i>
                    <span>Account</span>
                </button>
                <button class="nav-btn" data-screen="history">
                    <i class="fas fa-history"></i>
                    <span>History</span>
                </button>
                <button class="nav-btn" data-screen="payments">
                    <i class="fas fa-credit-card"></i>
                    <span>Payments</span>
                </button>
            </div>
            
            <!-- Schedule Ride Button -->
            <button class="schedule-ride-btn" id="scheduleRideBtn">
                <i class="fas fa-clock"></i>
                Schedule Ride
            </button>
            
            <!-- More Options Button -->
            <button class="more-options-btn" id="moreOptionsBtn">
                <i class="fas fa-ellipsis-h"></i>
                More Options
            </button>
            
            <!-- More Options Dropdown -->
            <div class="more-options-dropdown" id="moreOptionsDropdown">
                <div class="more-option-item" data-option="order-for-someone">
                    <div class="more-option-icon">
                        <i class="fas fa-user-friends"></i>
                    </div>
                    <div class="more-option-text">Order for Someone Else</div>
                </div>
                <div class="more-option-item" data-option="express-delivery">
                    <div class="more-option-icon">
                        <i class="fas fa-shipping-fast"></i>
                    </div>
                    <div class="more-option-text">Express Delivery</div>
                </div>
                <div class="more-option-item" data-option="sos-setup">
                    <div class="more-option-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="more-option-text">SOS Setup</div>
                </div>
            </div>
            
            <!-- Home Screen Content -->
            <div id="homeScreenContent">
                <!-- Order for Someone Else Form -->
                <div class="order-for-someone-form" id="orderForSomeoneForm">
                    <h4 class="section-title">Order for Someone Else</h4>
                    
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="recipientPickupLocation" placeholder="Pickup location">
                        <div class="suggestion-list" id="recipientPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="recipientDestinationLocation" placeholder="Drop-off location">
                        <div class="suggestion-list" id="recipientDestinationSuggestions"></div>
                    </div>
                    
                    <div class="input-group">
                        <label for="recipientName">Recipient's Full Name</label>
                        <input type="text" id="recipientName" class="input-field" placeholder="Full name">
                    </div>
                    
                    <div class="input-group">
                        <label for="recipientEmail">Recipient's Email</label>
                        <input type="email" id="recipientEmail" class="input-field" placeholder="Email address">
                    </div>
                    
                    <div class="input-group">
                        <label for="recipientPhone">Recipient's Phone Number</label>
                        <input type="tel" id="recipientPhone" class="input-field" placeholder="Phone number">
                    </div>
                    
                    <div class="delivery-fee-display">
                        <p>Delivery Fee</p>
                        <div class="delivery-fee-amount" id="recipientDeliveryFee">K0.00</div>
                        <p class="delivery-eta-display" id="recipientEtaDisplay">ETA: -- min</p>
                    </div>
                    
                    <button class="request-ride-btn" id="orderForSomeoneBtn">Book Ride</button>
                    <button class="btn btn-cancel" id="cancelOrderForSomeoneBtn">Cancel</button>
                </div>
                
                <!-- Express Delivery Form -->
                <div class="express-delivery-form" id="expressDeliveryForm">
                    <h4 class="section-title">Express Delivery</h4>
                    
                    <div class="input-group">
                        <label for="shopName">Shop or Restaurant Name</label>
                        <input type="text" id="shopName" class="input-field" placeholder="Name of shop or restaurant">
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="shopLocation" placeholder="Shop location">
                        <div class="suggestion-list" id="shopLocationSuggestions"></div>
                    </div>
                    
                    <div class="input-group">
                        <label for="deliveryItems">Items to Purchase</label>
                        <textarea id="deliveryItems" class="input-field" placeholder="List of items to be purchased"></textarea>
                    </div>
                    
                    <div class="input-group">
                        <label for="deliveryAmount">Total Amount to Spend (K)</label>
                        <input type="number" id="deliveryAmount" class="input-field" placeholder="Total amount">
                    </div>
                    
                    <div class="input-group">
                        <label for="deliveryInstructions">Special Instructions</label>
                        <textarea id="deliveryInstructions" class="input-field" placeholder="Any special instructions"></textarea>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="deliveryDestination" placeholder="Delivery destination">
                        <div class="suggestion-list" id="deliveryDestinationSuggestions"></div>
                    </div>
                    
                    <div class="vehicle-selection">
                        <div class="vehicle-option" data-type="car">
                            <i class="fas fa-car vehicle-icon"></i>
                            <span class="vehicle-name">Car</span>
                            <span class="vehicle-price">Fast & Secure</span>
                        </div>
                        <div class="vehicle-option selected" data-type="bike">
                            <i class="fas fa-motorcycle vehicle-icon"></i>
                            <span class="vehicle-name">Bike</span>
                            <span class="vehicle-price">Quick Delivery</span>
                        </div>
                        <div class="vehicle-option" data-type="bicycle">
                            <i class="fas fa-bicycle vehicle-icon"></i>
                            <span class="vehicle-name">Bicycle</span>
                            <span class="vehicle-price">Eco Friendly</span>
                        </div>
                    </div>
                    
                    <div class="delivery-fee-display">
                        <p>Delivery Fee</p>
                        <div class="delivery-fee-amount" id="expressDeliveryFee">K0.00</div>
                        <p class="delivery-eta-display" id="expressDeliveryEtaDisplay">ETA: -- min</p>
                    </div>
                    
                    <button class="request-ride-btn" id="expressDeliveryBtn">Request Delivery</button>
                    <button class="btn btn-cancel" id="cancelExpressDeliveryBtn">Cancel</button>
                </div>
                
                <!-- SOS Setup Form -->
                <div class="sos-setup-form" id="sosSetupForm">
                    <h4 class="section-title">SOS Setup</h4>
                    
                    <div class="input-group">
                        <label for="emergencyContact1">Emergency Contact 1</label>
                        <input type="tel" id="emergencyContact1" class="input-field" placeholder="Phone number">
                    </div>
                    
                    <div class="input-group">
                        <label for="emergencyContact2">Emergency Contact 2</label>
                        <input type="tel" id="emergencyContact2" class="input-field" placeholder="Phone number">
                    </div>
                    
                    <div class="input-group">
                        <label for="sosMessage">Emergency Message</label>
                        <textarea id="sosMessage" class="input-field" placeholder="Pre-typed emergency message">I need help! My current location and ride details will be shared with you.</textarea>
                    </div>
                    
                    <button class="request-ride-btn" id="saveSosBtn">Save SOS Configuration</button>
                    <button class="btn btn-cancel" id="cancelSosSetupBtn">Cancel</button>
                </div>
                
                <!-- Original Ride Request Form -->
                <div class="ride-request-form" id="rideRequestForm">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="pickupLocation" placeholder="Current location" readonly>
                    </div>
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="destinationLocation" placeholder="Where to?">
                        <div class="suggestion-list" id="destinationSuggestions"></div>
                    </div>
                    
                    <div class="saved-locations">
                        <button class="saved-location-btn" data-address="home">
                            <i class="fas fa-home"></i>
                            Home
                        </button>
                        <button class="saved-location-btn" data-address="work">
                            <i class="fas fa-briefcase"></i>
                            Work
                        </button>
                    </div>
                    
                    <div class="vehicle-selection">
                        <div class="vehicle-option selected" data-type="car">
                            <i class="fas fa-car vehicle-icon"></i>
                            <span class="vehicle-name">Ride</span>
                            <span class="vehicle-price">Clean Cars</span>
                        </div>
                        <div class="vehicle-option" data-type="bike">
                            <i class="fas fa-motorcycle vehicle-icon"></i>
                            <span class="vehicle-name">Delivery</span>
                            <span class="vehicle-price">on time</span>
                        </div>
                        <div class="vehicle-option" data-type="bicycle">
                            <i class="fas fa-bicycle vehicle-icon"></i>
                            <span class="vehicle-name">Short Delivery</span>
                            <span class="vehicle-price">on time</span>
                        </div>
                    </div>
                    
                    <button class="package-toggle" id="packageToggle" style="display: none;">
                        <i class="fas fa-box"></i>
                        Add Package Details
                    </button>
                    
                    <div class="package-form" id="packageForm">
                        <h4 class="section-title">Package Delivery Details</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="receiverName">Receiver Name</label>
                                <input type="text" id="receiverName" placeholder="Full name of receiver">
                            </div>
                            <div class="form-group">
                                <label for="receiverPhone">Receiver Phone</label>
                                <input type="tel" id="receiverPhone" placeholder="Phone number">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="packageDescription">Package Description</label>
                            <input type="text" id="packageDescription" placeholder="What is being delivered?">
                        </div>
                        <div class="form-group">
                            <label for="specialInstructions">Special Instructions</label>
                            <textarea id="specialInstructions" placeholder="Any special handling instructions?"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="packageValue">Package Value (K)</label>
                            <input type="number" id="packageValue" placeholder="Estimated value for insurance">
                        </div>
                    </div>
                    
                    <button class="promo-toggle" id="promoToggle">
                        <i class="fas fa-tag"></i>
                        Apply Promo Coupon
                    </button>
                    
                    <div class="promo-section" id="promoSection">
                        <div class="promo-input">
                            <input type="text" id="promoCode" placeholder="Promo code">
                            <button class="btn-promo" id="applyPromoBtn">Apply</button>
                        </div>
                    </div>
                    
                    <div class="fare-display">
                        <p>Estimated Fare</p>
                        <div class="fare-amount" id="estimatedFare">K0.00</div>
                        <p class="eta-display" id="etaDisplay">ETA: -- min</p>
                    </div>
                    
                    <button class="request-ride-btn" id="requestRideBtn">Request Ride</button>
                </div>
                
                <!-- Ride Info Panel -->
                <div class="ride-info-panel" id="rideInfoPanel">
                    <div class="driver-details-card" id="driverDetailsCard">
                        <div class="driver-details-header">
                            <i class="fas fa-id-card"></i>
                            <h3>Driver Details</h3>
                        </div>
                        <div class="driver-details-grid">
                            <div class="driver-detail-item">
                                <span class="driver-detail-label">Driver Name</span>
                                <span class="driver-detail-value" id="driverFullName">John Doe</span>
                            </div>
                            <div class="driver-detail-item">
                                <span class="driver-detail-label">Phone</span>
                                <span class="driver-detail-value" id="driverContactPhone">+260 123 456 789</span>
                            </div>
                            <div class="driver-detail-item">
                                <span class="driver-detail-label">Rating</span>
                                <span class="driver-detail-value" id="driverRatingValue">4.8 </span>
                            </div>
                            <div class="driver-detail-item">
                                <span class="driver-detail-label">Experience</span>
                                <span class="driver-detail-value" id="driverExperience">2 years</span>
                            </div>
                        </div>
                        <div class="driver-vehicle-details">
                            <div class="vehicle-detail-row">
                                <span class="vehicle-detail-label">Vehicle Type</span>
                                <span class="vehicle-detail-value" id="vehicleType">Car</span>
                            </div>
                            <div class="vehicle-detail-row">
                                <span class="vehicle-detail-label">Vehicle Model</span>
                                <span class="vehicle-detail-value" id="vehicleModel">Toyota Corolla</span>
                            </div>
                            <div class="vehicle-detail-row">
                                <span class="vehicle-detail-label">License Plate</span>
                                <span class="vehicle-detail-value" id="vehicleLicense">ABC 123</span>
                            </div>
                            <div class="vehicle-detail-row">
                                <span class="vehicle-detail-label">Color</span>
                                <span class="vehicle-detail-value" id="vehicleColor">Blue</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="driver-info">
                        <div class="driver-avatar" id="driverAvatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="driver-details">
                            <h2 id="driverName">Driver Name</h2>
                            <p><i class="fas fa-phone"></i> <span id="driverPhone">000-000-0000</span></p>
                            <p><i class="fas fa-car"></i> <span id="vehicleDetails">Toyota Corolla - ABC123</span></p>
                            <p><i class="fas fa-star"></i> <span id="driverRating">4.5 </span></p>
                        </div>
                    </div>
                    
                    <div class="trip-details">
                        <div class="location-row">
                            <div class="location-icon pickup-icon">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="location-text">
                                <h4>Pickup Location</h4>
                                <p id="currentPickupLocation">123 Main Street, City</p>
                            </div>
                        </div>
                        <div class="location-row">
                            <div class="location-icon destination-icon">
                                <i class="fas fa-flag"></i>
                            </div>
                            <div class="location-text">
                                <h4>Destination</h4>
                                <p id="currentDestinationLocation">456 Oak Avenue, City</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="fare-details">
                        <div class="fare-row">
                            <span>Base Fare</span>
                            <span id="baseFare">K15.00</span>
                        </div>
                        <div class="fare-row">
                            <span>Distance</span>
                            <span id="distanceFare">K5.00</span>
                        </div>
                        <div class="fare-row">
                            <span>Discount</span>
                            <span id="discountFare">-K2.00</span>
                        </div>
                        <div class="fare-row total">
                            <span>Total Fare</span>
                            <span id="totalFare">K18.00</span>
                        </div>
                    </div>
                    
                    <div class="ride-actions">
                        <button class="btn btn-cancel" id="cancelRideBtn">
                            <i class="fas fa-times-circle"></i>
                            Cancel Ride
                        </button>
                        <button class="btn btn-contact" id="contactDriverBtn">
                            <i class="fas fa-phone"></i>
                            Contact Driver
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Screen Contents -->
        <div class="screen-content" id="homeScreen"></div>
        
        <div class="screen-content" id="accountScreen">
            <div class="screen-header">
                <button class="back-button" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="screen-title">Account</h2>
            </div>
            
            <div class="account-section">
                <div class="account-header">
                    <div class="driver-avatar" id="accountAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="driver-details">
                        <h2 id="accountName">Passenger</h2>
                        <p><i class="fas fa-phone"></i> <span id="accountPhone">Not set</span></p>
                        <p><i class="fas fa-envelope"></i> <span id="accountEmail">Not set</span></p>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="ridesCompleted">0</div>
                        <div class="stat-label">Completed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="ridesCancelled">0</div>
                        <div class="stat-label">Cancelled</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="ridesPending">0</div>
                        <div class="stat-label">Pending</div>
                    </div>
                </div>
                
                <div class="referral-section">
                    <h3 class="section-title">
                        <i class="fas fa-share-alt"></i>
                        Refer & Earn
                    </h3>
                    <p>Share your code and get K25 when friends join</p>
                    <div class="referral-code">
                        <div class="code" id="referralCode">JUBEL-XXXX</div>
                        <div class="description">50% discount for new users</div>
                    </div>
                    <button class="btn btn-primary" id="shareReferralBtn">
                        <i class="fas fa-share"></i>
                        Share Referral Code
                    </button>
                </div>
                
                <div class="wallet-section">
                    <h3 class="section-title">
                        <i class="fas fa-wallet"></i>
                        Jubel Wallet
                    </h3>
                    <div class="wallet-balance">
                        <div class="balance-label">Current Balance</div>
                        <div class="balance-amount-large" id="accountBalance">K0.00</div>
                    </div>
                    <div class="wallet-actions">
                        <button class="btn-wallet" id="depositBtn">
                            <i class="fas fa-plus"></i>
                            Deposit
                        </button>
                        <button class="btn-wallet" id="withdrawBtn">
                            <i class="fas fa-minus"></i>
                            Withdraw
                        </button>
                    </div>
                </div>
                
                <div class="contact-section">
                    <button class="contact-btn whatsapp" id="whatsappBtn">
                        <i class="fab fa-whatsapp"></i>
                        WhatsApp
                    </button>
                    <button class="contact-btn phone" id="callBtn">
                        <i class="fas fa-phone"></i>
                        Call Us
                    </button>
                </div>
            </div>
        </div>
        
        <div class="screen-content" id="historyScreen">
            <div class="screen-header">
                <button class="back-button" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="screen-title">Ride History</h2>
            </div>
            
            <div class="filter-options">
                <select id="historyFilter" class="input-field">
                    <option value="all">All Rides</option>
                    <option value="requested">Awaiting Driver</option>
                    <option value="accepted">In Progress</option>
                    <option value="completed">Completed</option>
                    <option value="cancelled">Cancelled</option>
                </select>
                <input type="date" id="historyDate" class="input-field">
            </div>
            
            <div class="history-section">
                <div id="historyList">
                    <div class="loading-text">
                        <i class="fas fa-spinner fa-spin"></i>
                        Loading ride history...
                    </div>
                </div>
            </div>
        </div>
        
        <div class="screen-content" id="paymentsScreen">
            <div class="screen-header">
                <button class="back-button" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="screen-title">Payment Methods</h2>
            </div>
            
            <div class="payments-section">
                <h3 class="section-title">
                    <i class="fas fa-credit-card"></i>
                    Payment Methods
                </h3>
                
                <div class="payment-methods">
                    <div class="payment-method selected" data-method="airtel">
                        <div class="payment-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Airtel Money</div>
                            <div class="payment-info">Pay with Airtel Money</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-method="mtn">
                        <div class="payment-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">MTN Money</div>
                            <div class="payment-info">Pay with MTN Money</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-method="zamtel">
                        <div class="payment-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Zamtel Money</div>
                            <div class="payment-info">Pay with Zamtel Money</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-method="card">
                        <div class="payment-icon">
                            <i class="fas fa-credit-card"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Credit/Debit Card</div>
                            <div class="payment-info">Visa, Mastercard</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-method="cash">
                        <div class="payment-icon">
                            <i class="fas fa-money-bill"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Cash</div>
                            <div class="payment-info">Pay with cash</div>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-primary" id="addPaymentMethodBtn">
                    <i class="fas fa-plus"></i>
                    Add Payment Method
                </button>
            </div>
        </div>
    </div>
    
    <!-- Payment Selection Popup -->
    <div id="paymentSelectionPopup" class="popup-overlay hidden">
        <div class="popup-form payment-selection-popup">
            <div class="popup-header">
                <h2 class="popup-title">
                    <i class="fas fa-credit-card"></i>
                    Select Payment Method
                </h2>
                <button class="close-popup" id="closePaymentPopup">&times;</button>
            </div>
            <div class="popup-content">
                <div class="payment-options">
                    <div class="payment-option selected" data-payment-type="wallet">
                        <div class="payment-option-icon">
                            <i class="fas fa-wallet"></i>
                        </div>
                        <div class="payment-option-details">
                            <div class="payment-option-name">Jubel Wallet</div>
                            <div class="payment-option-description">Pay with your Jubel wallet balance</div>
                            <div class="payment-option-balance" id="paymentWalletBalance">Balance: K0.00</div>
                        </div>
                    </div>
                    
                    <div class="payment-option" data-payment-type="mobile">
                        <div class="payment-option-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="payment-option-details">
                            <div class="payment-option-name">Mobile Money</div>
                            <div class="payment-option-description">Pay with Airtel, MTN or Zamtel Money</div>
                        </div>
                    </div>
                    
                    <div class="payment-option" data-payment-type="cash">
                        <div class="payment-option-icon">
                            <i class="fas fa-money-bill"></i>
                        </div>
                        <div class="payment-option-details">
                            <div class="payment-option-name">Cash on Delivery</div>
                            <div class="payment-option-description">Pay with cash when you arrive</div>
                        </div>
                    </div>
                </div>
                
                <div class="insufficient-balance" id="insufficientBalance">
                    <i class="fas fa-exclamation-circle"></i>
                    Insufficient balance in your Jubel wallet
                </div>
                
                <button class="confirm-payment-btn" id="confirmPaymentBtn">
                    Confirm Payment & Request Ride
                </button>
            </div>
        </div>
    </div>
    
    <!-- Enhanced Ride Details Popup -->
    <div id="rideDetailsPopup" class="popup-overlay hidden">
        <div class="popup-form large-popup">
            <div class="popup-header">
                <h2 class="popup-title">
                    <i class="fas fa-info-circle"></i>
                    Ride Details
                </h2>
                <button class="close-popup" id="closeRidePopupTop">&times;</button>
            </div>
            <div class="popup-content">
                <div class="popup-map-container" id="popupRideMap"></div>
                <div class="popup-details">
                    <div class="detail-row">
                        <span class="detail-label">Pickup:</span>
                        <span class="detail-value" id="popupRidePickup">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Destination:</span>
                        <span class="detail-value" id="popupRideDestination">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Fare:</span>
                        <span class="detail-value" id="popupRideFare">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Distance:</span>
                        <span class="detail-value" id="popupRideDistance">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Ride Type:</span>
                        <span class="detail-value" id="popupRideType">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Status:</span>
                        <span class="detail-value" id="popupRideStatus">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Date & Time:</span>
                        <span class="detail-value" id="popupRideDate">Loading...</span>
                    </div>
                    
                    <!-- Driver Details Section -->
                    <div id="popupDriverDetails" class="driver-details-section hidden">
                        <h3 class="section-title">Driver Information</h3>
                        <div class="detail-row">
                            <span class="detail-label">Driver Name:</span>
                            <span class="detail-value" id="popupDriverName">Loading...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Phone:</span>
                            <span class="detail-value" id="popupDriverPhone">Loading...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Vehicle:</span>
                            <span class="detail-value" id="popupDriverVehicle">Loading...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Rating:</span>
                            <span class="detail-value" id="popupDriverRating">Loading...</span>
                        </div>
                    </div>
                    
                    <!-- Chat History Section -->
                    <div id="popupChatSection" class="chat-section hidden">
                        <h3 class="section-title">
                            <i class="fas fa-comments"></i>
                            Chat History
                        </h3>
                        <div class="chat-messages-container" id="popupChatMessages">
                            <div class="loading-text">Loading chat history...</div>
                        </div>
                    </div>
                    
                    <div class="popup-actions">
                        <button class="btn btn-primary" id="viewChatBtn" style="display: none;">
                            <i class="fas fa-comments"></i>
                            View Chat
                        </button>
                        <button class="btn btn-cancel" id="closeRidePopup">
                            <i class="fas fa-times"></i>
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Schedule Ride Popup -->
    <div id="scheduleRidePopup" class="popup-overlay hidden">
        <div class="popup-form" style="max-width: 500px;">
            <div class="popup-header">
                <h2 class="popup-title">
                    <i class="fas fa-clock"></i>
                    Schedule a Ride
                </h2>
                <button class="close-popup" id="closeSchedulePopup">&times;</button>
            </div>
            <div class="popup-content schedule-popup-content">
                <div class="popup-tabs" style="display: flex; gap: 5px; margin-bottom: 15px;">
                    <button class="tab-btn active" data-tab="standard">Standard Ride</button>
                    <button class="tab-btn" data-tab="delivery">Delivery</button>
                    <button class="tab-btn" data-tab="someone-else">For Someone Else</button>
                </div>
                
                <div id="scheduleStandardForm" class="schedule-form active">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="schedulePickupLocation" placeholder="Pickup location" value="">
                        <div class="suggestion-list" id="schedulePickupSuggestions"></div>
                    </div>
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="scheduleDestination" placeholder="Destination">
                        <div class="suggestion-list" id="scheduleDestinationSuggestions"></div>
                    </div>
                    
                    <div class="vehicle-selection">
                        <div class="vehicle-option selected" data-type="car">
                            <i class="fas fa-car vehicle-icon"></i>
                            <span class="vehicle-name">Car</span>
                        </div>
                        <div class="vehicle-option" data-type="bike">
                            <i class="fas fa-motorcycle vehicle-icon"></i>
                            <span class="vehicle-name">Bike</span>
                        </div>
                        <div class="vehicle-option" data-type="bicycle">
                            <i class="fas fa-bicycle vehicle-icon"></i>
                            <span class="vehicle-name">Bicycle</span>
                        </div>
                    </div>
                    
                    <div class="package-toggle" id="schedulePackageToggle" style="display: none;">
                        <i class="fas fa-box"></i>
                        Add Package Details
                    </div>
                    
                    <div class="package-form" id="schedulePackageForm" style="display: none;">
                        <h4 class="section-title">Package Details</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="scheduleReceiverName">Receiver Name</label>
                                <input type="text" id="scheduleReceiverName" placeholder="Full name">
                            </div>
                            <div class="form-group">
                                <label for="scheduleReceiverPhone">Receiver Phone</label>
                                <input type="tel" id="scheduleReceiverPhone" placeholder="Phone number">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="schedulePackageDescription">Package Description</label>
                            <input type="text" id="schedulePackageDescription" placeholder="What is being delivered?">
                        </div>
                        <div class="form-group">
                            <label for="scheduleSpecialInstructions">Special Instructions</label>
                            <textarea id="scheduleSpecialInstructions" placeholder="Any special handling instructions?"></textarea>
                        </div>
                    </div>
                </div>
                
                <div id="scheduleDeliveryForm" class="schedule-form" style="display: none;">
                    <div class="input-group">
                        <label for="scheduleShopName">Shop or Restaurant Name</label>
                        <input type="text" id="scheduleShopName" class="input-field" placeholder="Name of shop or restaurant">
                    </div>
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="scheduleShopLocation" placeholder="Shop location">
                        <div class="suggestion-list" id="scheduleShopSuggestions"></div>
                    </div>
                    <div class="input-group">
                        <label for="scheduleDeliveryItems">Items to Purchase</label>
                        <textarea id="scheduleDeliveryItems" class="input-field" placeholder="List of items to be purchased"></textarea>
                    </div>
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="scheduleDeliveryDestination" placeholder="Delivery destination">
                        <div class="suggestion-list" id="scheduleDeliveryDestSuggestions"></div>
                    </div>
                </div>
                
                <div id="scheduleSomeoneElseForm" class="schedule-form" style="display: none;">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="scheduleRecipientPickup" placeholder="Recipient pickup location">
                        <div class="suggestion-list" id="scheduleRecipientPickupSuggestions"></div>
                    </div>
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="scheduleRecipientDestination" placeholder="Recipient destination">
                        <div class="suggestion-list" id="scheduleRecipientDestSuggestions"></div>
                    </div>
                    <div class="input-group">
                        <label for="scheduleRecipientName">Recipient Name</label>
                        <input type="text" id="scheduleRecipientName" class="input-field" placeholder="Full name">
                    </div>
                    <div class="input-group">
                        <label for="scheduleRecipientPhone">Recipient Phone</label>
                        <input type="tel" id="scheduleRecipientPhone" class="input-field" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="scheduling-options">
                    <div class="input-group">
                        <label for="scheduleDate">Date</label>
                        <input type="date" id="scheduleDate" class="input-field" value="" min="">
                    </div>
                    <div class="input-group">
                        <label for="scheduleTime">Time</label>
                        <input type="time" id="scheduleTime" class="input-field" value="">
                    </div>
                    <div class="input-group">
                        <label for="schedulePaymentMethod">Payment Method</label>
                        <select id="schedulePaymentMethod" class="input-field">
                            <option value="wallet">Jubel Wallet</option>
                            <option value="cash">Cash</option>
                            <option value="mobile">Mobile Money</option>
                        </select>
                    </div>
                </div>
                
                <div class="fare-display" style="margin: 20px 0;">
                    <p>Estimated Fare</p>
                    <div class="fare-amount" id="scheduleEstimatedFare">K0.00</div>
                    <p class="eta-display" id="scheduleEtaDisplay">ETA: -- min</p>
                </div>
                
                <button id="confirmScheduleRideBtn" class="request-ride-btn">
                    <i class="fas fa-calendar-check"></i> Schedule Ride
                </button>
                <button id="cancelScheduleBtn" class="btn btn-cancel" style="margin-top: 10px;">
                    Cancel
                </button>
            </div>
        </div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification"></div>
    
    <!-- Firebase and Leaflet JS -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <script>
// Enhanced JavaScript with advanced features - Total lines: ~8500

// Firebase configuration
const firebaseConfig = {
    apiKey: "AIzaSyDEACX_P4c5q7djJAcA0I7Lk7leO2TlQ74",
    authDomain: "jubel-13e1a.firebaseapp.com",
    databaseURL: "https://jubel-13e1a-default-rtdb.firebaseio.com",
    projectId: "jubel-13e1a",
    storageBucket: "jubel-13e1a.firebasestorage.app",
    messagingSenderId: "882241095445",
    appId: "1:882241095445:web:ee9ca40fddd008ca910b1c",
    measurementId: "G-J5JPKL6B5F"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const auth = firebase.auth();

// Enhanced App State
let currentUser = null;
let currentRide = null;
let passengerMap;
let popupRideMap;
let locationWatchId = null;
let currentLocationMarker = null;
let pickupMarker = null;
let destinationMarker = null;
let driverMarker = null;
let routePolyline = null;
let selectedVehicleType = 'car';
let walletBalance = 0;
let userFullName = "Passenger";
let driverAssignmentListener = null;
let rideHistoryListener = null;
let activeRideListener = null;
let appliedPromoCode = null;
let userStats = { completed: 0, cancelled: 0, pending: 0 };
let paymentMethod = 'airtel';
let userRating = 0;
let userLocation = null;
let destinationSearchResults = [];
let selectedDestination = null;
let driverLocationListener = null;
let userData = null;
let selectedPaymentType = 'wallet';
let rideFare = 0;
let currentCity = null;
let packageDetails = null;
let walletBalanceListener = null;
let currentScreen = 'home';
let homeScreenRefreshRequired = false;

// Enhanced state variables
let sosConfig = null;
let activeMoreOption = null;
let recipientPickupMarker = null;
let recipientDestinationMarker = null;
let shopLocationMarker = null;
let deliveryDestinationMarker = null;
let chatListener = null;
let currentChatRideId = null;
let unreadMessages = {};
let chatPopupClosedByUser = false;
let driverMessageListener = null;
let pickupSearchResults = [];
let recipientPickupSearchResults = [];
let shopLocationSearchResults = [];
let deliveryDestinationSearchResults = [];
let activeSearchField = null;
let currentRideRequestType = 'standard';
let currentRideRequestData = null;
let driverProfileImage = null;
let driverVehicleImage = null;
let activeRideRestored = false;

// Schedule ride variables
let scheduledRides = [];
let scheduledRideTimers = {};
let scheduledRideCheckInterval = null;

// Live tracking variables
let liveTrackingListeners = {};
let sharedRideLinks = {};

// Enhanced Zambian cities with detailed boundaries
const zambianCities = [
    'Lusaka', 'Kitwe', 'Ndola', 'Kabwe', 'Chipata', 'Chingola', 
    'Mufulira', 'Luanshya', 'Livingstone', 'Kasama', 'Solwezi', 
    'Kapiri Mposhi', 'Chililabombwe'
];

const cityAliases = {
    'lusaka': 'Lusaka', 'lsk': 'Lusaka', 'lsk city': 'Lusaka',
    'kitwe': 'Kitwe', 'ndola': 'Ndola', 'kabwe': 'Kabwe',
    'chipata': 'Chipata', 'chingola': 'Chingola',
    'mufulira': 'Mufulira', 'luanshya': 'Luanshya',
    'livingstone': 'Livingstone', 'kasama': 'Kasama',
    'solwezi': 'Solwezi', 'kapiri': 'Kapiri Mposhi',
    'kapiri mposhi': 'Kapiri Mposhi', 'chililabombwe': 'Chililabombwe'
};

// Enhanced city boundaries with more accurate radii
const cityBoundaries = {
    'Lusaka': { lat: -15.4167, lng: 28.2833, radius: 30000 },
    'Kitwe': { lat: -12.8139, lng: 28.2136, radius: 25000 },
    'Ndola': { lat: -12.9667, lng: 28.6333, radius: 25000 },
    'Kabwe': { lat: -14.4333, lng: 28.4500, radius: 20000 },
    'Chipata': { lat: -13.6333, lng: 32.6500, radius: 20000 },
    'Chingola': { lat: -12.5333, lng: 27.8500, radius: 20000 },
    'Mufulira': { lat: -12.5500, lng: 28.2333, radius: 20000 },
    'Luanshya': { lat: -13.1333, lng: 28.4000, radius: 20000 },
    'Livingstone': { lat: -17.8500, lng: 25.8667, radius: 20000 },
    'Kasama': { lat: -10.2000, lng: 31.2000, radius: 20000 },
    'Solwezi': { lat: -12.1833, lng: 26.4000, radius: 20000 },
    'Kapiri Mposhi': { lat: -13.9667, lng: 28.6833, radius: 15000 },
    'Chililabombwe': { lat: -12.3667, lng: 27.8333, radius: 15000 }
};

// Enhanced search cache for instant results
let searchCache = new Map();
let lastSearchTime = 0;
const SEARCH_DEBOUNCE_TIME = 50; // 50ms for instant results
const CACHE_DURATION = 300000; // 5 minutes cache duration

// Zambian common places database for instant suggestions
const zambianCommonPlaces = {
    'Lusaka': [
        'Manda Hill Shopping Mall', 'East Park Mall', 'Arcades Shopping Mall', 'Levy Mall',
        'Kamwala Market', 'Soweto Market', 'City Market', 'Lusaka City Council',
        'University of Zambia', 'Lusaka Apex Medical University', 'Levy Mwanawasa Hospital',
        'University Teaching Hospital', 'Kenneth Kaunda Airport', 'Lusaka National Museum',
        'State House', 'National Assembly', 'Mulungushi Conference Centre',
        'Zambia National Broadcasting Corporation', 'Taj Pamodzi Hotel', 'Protea Hotel',
        'Radisson Blu Hotel', 'Cresta Golfview Hotel', 'Lusaka Playhouse', 'Nakatindi Hall'
    ],
    'Kitwe': [
        'Mukuba Mall', 'Kitwe City Mall', 'Nkana Mall', 'Chimwemwe Shopping Centre',
        'Kitwe Main Market', 'Wusakile Market', 'Kitwe Teaching Hospital', 'Nkana Mine',
        'Mopani Copper Mines', 'Copperbelt University', 'David Kaunda Stadium',
        'Arthur Davies Stadium', 'Kitwe Golf Club', 'Nkana Golf Club', 'Kitwe Museum',
        'Nkana Mine Club', 'Savoy Hotel', 'Mukuba Hotel', 'Protea Hotel Kitwe'
    ],
    'Ndola': [
        'Mukuba Mall Ndola', 'Northrise Mall', 'Shoprite Ndola', 'Masala Market',
        'Ndola Main Market', 'Itawa Market', 'Ndola Teaching Hospital', 'Lewanika Hospital',
        'Simon Mwansa Kapwepwe Airport', 'Indeni Oil Refinery', 'Ndola Golf Club',
        'Dag Hammarskjld Crash Site Memorial', 'Masala Stadium', 'Levy Mwanawasa Stadium',
        'Savoy Hotel Ndola', 'Mikomfwa Hotel', 'Protea Hotel Ndola'
    ],
    'Kabwe': [
        'Mukobeko Mall', 'Kabwe Main Market', 'Kabwe Central Hospital', 'Broken Hill Mine',
        'Big Tree National Monument', 'Kabwe Golf Club', 'Kabwe Stadium',
        'Kabwe Museum', 'Mulungushi University', 'Nkrumah University', 'Railways Football Club'
    ],
    'Livingstone': [
        'Victoria Falls', 'Mosi-oa-Tunya National Park', 'Livingstone Museum',
        'Maramba Market', 'Dambwa Market', 'Livingstone Central Hospital',
        'Harry Mwanga Nkumbula Airport', 'Zambezi Sun Hotel', 'Royal Livingstone Hotel',
        'Avani Victoria Falls Resort', 'David Livingstone Safari Lodge', 'Toka Leya Camp'
    ]
};

// Initialize the app
document.addEventListener('DOMContentLoaded', function() {
    initializeAuth();
});

// Authentication functions
function initializeAuth() {
    const urlParams = new URLSearchParams(window.location.search);
    const email = urlParams.get('email');
    const uid = urlParams.get('uid');
    
    if (email && uid) {
        loadUserData(uid);
    } else {
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                loadUserData(user.uid);
            } else {
                window.location.href = 'signup.html';
            }
        });
    }
}

function loadUserData(uid) {
    database.ref('users/' + uid).once('value')
        .then(snapshot => {
            userData = snapshot.val();
            if (userData) {
                currentUser = {
                    uid: uid,
                    email: userData.email,
                    displayName: userData.name
                };
                
                initializeMap();
                setupEventListeners();
                loadPassengerData();
                
                document.getElementById('accountName').textContent = userData.name || 'Passenger';
                document.getElementById('accountEmail').textContent = userData.email || 'Not set';
                document.getElementById('accountPhone').textContent = userData.phone || 'Not set';
                document.getElementById('referralCode').textContent = userData.referralCode || 'JUBEL-XXXX';
                
                walletBalance = userData.walletBalance || 0;
                updateWalletBalanceUI();
                
                setupWalletBalanceListener(uid);
                loadSOSConfig(uid);
                checkActiveRide(uid);
                loadScheduledRides(uid);
                
                showNotification('Welcome back to Jubel!');
                initializeApp();
            } else {
                showNotification('User data not found. Please sign up again.');
                setTimeout(() => {
                    window.location.href = 'signup.html';
                }, 2000);
            }
        })
        .catch(error => {
            console.error('Error loading user data:', error);
            showNotification('Error loading user data. Please try again.');
        });
}

function loadScheduledRides(uid) {
    database.ref('scheduledRides').orderByChild('passengerId').equalTo(uid).once('value')
        .then(snapshot => {
            const rides = snapshot.val();
            if (rides) {
                scheduledRides = Object.values(rides).filter(ride => 
                    ride.status === 'scheduled' && ride.scheduledTime > Date.now()
                );
                
                scheduledRides.forEach(ride => {
                    scheduleRideTimer(ride);
                });
                
                startScheduledRideChecker();
                
                // Update UI if on schedule screen
                if (currentScreen === 'home') {
                    updateScheduledRidesUI();
                }
            }
        })
        .catch(error => {
            console.error('Error loading scheduled rides:', error);
        });
}

function scheduleRideTimer(ride) {
    const timeUntilRide = ride.scheduledTime - Date.now();
    
    if (timeUntilRide <= 0) {
        return;
    }
    
    const timerId = setTimeout(() => {
        autoRequestScheduledRide(ride);
    }, timeUntilRide);
    
    scheduledRideTimers[ride.id] = timerId;
    
    updateScheduledRideCountdown(ride);
}

function autoRequestScheduledRide(ride) {
    const rideId = database.ref().child('rides').push().key;
    
    const rideRequest = {
        id: rideId,
        passengerId: ride.passengerId,
        passengerName: ride.passengerName,
        passengerPhone: ride.passengerPhone,
        pickupLocation: ride.pickupLocation,
        pickupDisplayLocation: ride.pickupDisplayLocation,
        destination: ride.destination,
        pickupLat: ride.pickupLat,
        pickupLng: ride.pickupLng,
        destLat: ride.destLat,
        destLng: ride.destLng,
        rideType: ride.rideType,
        fare: ride.fare,
        distance: ride.distance,
        status: 'requested',
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        updatedAt: firebase.database.ServerValue.TIMESTAMP,
        paymentMethod: ride.paymentMethod,
        packageDetails: ride.packageDetails,
        orderForSomeone: ride.orderForSomeone,
        expressDelivery: ride.expressDelivery,
        isScheduled: true,
        scheduledRideId: ride.id,
        currentCity: ride.currentCity
    };
    
    database.ref('scheduledRides/' + ride.id).update({
        status: 'auto-requested',
        autoRequestedAt: firebase.database.ServerValue.TIMESTAMP
    })
    .then(() => {
        currentRideRequestData = rideRequest;
        selectedPaymentType = ride.paymentMethod;
        submitRideRequest();
        
        showNotification(`Scheduled ride to ${ride.destination} has been automatically requested.`);
        
        // Remove from scheduled rides list
        scheduledRides = scheduledRides.filter(r => r.id !== ride.id);
        updateScheduledRidesUI();
    })
    .catch(error => {
        console.error('Error auto-requesting scheduled ride:', error);
        showNotification('Error auto-requesting scheduled ride. Please request manually.');
    });
}

function startScheduledRideChecker() {
    if (scheduledRideCheckInterval) {
        clearInterval(scheduledRideCheckInterval);
    }
    
    scheduledRideCheckInterval = setInterval(() => {
        scheduledRides.forEach(ride => {
            updateScheduledRideCountdown(ride);
        });
    }, 60000);
}

function updateScheduledRideCountdown(ride) {
    const timeLeft = ride.scheduledTime - Date.now();
    
    if (timeLeft <= 0) {
        return;
    }
    
    const hours = Math.floor(timeLeft / (1000 * 60 * 60));
    const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
    
    // Update UI if needed
    const rideElement = document.querySelector(`[data-scheduled-ride-id="${ride.id}"]`);
    if (rideElement) {
        const countdownElement = rideElement.querySelector('.scheduled-countdown');
        if (countdownElement) {
            if (hours > 0) {
                countdownElement.textContent = `Auto-requests in ${hours}h ${minutes}m`;
            } else {
                countdownElement.textContent = `Auto-requests in ${minutes}m`;
            }
        }
    }
}

function updateScheduledRidesUI() {
    if (currentScreen !== 'home') return;
    
    const scheduledSection = document.getElementById('scheduledRidesSection');
    if (!scheduledSection) {
        // Create scheduled rides section if it doesn't exist
        const homeScreen = document.getElementById('homeScreenContent');
        const scheduledHTML = `
            <div id="scheduledRidesSection" style="margin-top: 15px; display: ${scheduledRides.length > 0 ? 'block' : 'none'}">
                <h4 class="section-title" style="font-size: 0.9rem; margin-bottom: 10px;">
                    <i class="fas fa-clock"></i> Upcoming Scheduled Rides
                </h4>
                <div id="scheduledRidesList"></div>
            </div>
        `;
        
        const rideRequestForm = document.getElementById('rideRequestForm');
        if (rideRequestForm) {
            rideRequestForm.insertAdjacentHTML('beforebegin', scheduledHTML);
        }
    }
    
    const scheduledRidesList = document.getElementById('scheduledRidesList');
    if (scheduledRidesList) {
        if (scheduledRides.length === 0) {
            document.getElementById('scheduledRidesSection').style.display = 'none';
            return;
        }
        
        document.getElementById('scheduledRidesSection').style.display = 'block';
        scheduledRidesList.innerHTML = '';
        
        scheduledRides.forEach(ride => {
            const scheduledTime = new Date(ride.scheduledTime);
            const timeLeft = ride.scheduledTime - Date.now();
            const hoursLeft = Math.floor(timeLeft / (1000 * 60 * 60));
            const minutesLeft = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            
            const rideElement = document.createElement('div');
            rideElement.className = 'scheduled-ride-item';
            rideElement.setAttribute('data-scheduled-ride-id', ride.id);
            rideElement.innerHTML = `
                <div class="scheduled-ride-header">
                    <div class="scheduled-ride-type">
                        ${ride.scheduleType === 'delivery' ? 'Delivery' : 
                          ride.scheduleType === 'someone-else' ? 'For Someone' : 'Ride'}
                    </div>
                    <div class="scheduled-ride-fare">K${ride.fare ? ride.fare.toFixed(2) : '0.00'}</div>
                </div>
                <div class="history-locations" style="margin: 8px 0;">
                    <div class="history-location">
                        <div class="history-location-icon pickup">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div style="font-size: 0.75rem;">
                            ${ride.pickupDisplayLocation || ride.pickupLocation}
                        </div>
                    </div>
                    <div class="history-location">
                        <div class="history-location-icon destination">
                            <i class="fas fa-flag"></i>
                        </div>
                        <div style="font-size: 0.75rem;">
                            ${ride.destination}
                        </div>
                    </div>
                </div>
                <div class="scheduled-countdown">
                    <i class="fas fa-calendar-alt"></i> 
                    ${scheduledTime.toLocaleDateString()} at ${scheduledTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                    <br>
                    <span style="color: var(--primary-orange); font-weight: 700;">
                        ${hoursLeft > 0 ? `${hoursLeft}h ${minutesLeft}m` : `${minutesLeft}m`} until auto-request
                    </span>
                </div>
                <div style="display: flex; gap: 8px; margin-top: 10px;">
                    <button class="btn-cancel-schedule" data-ride-id="${ride.id}" 
                            style="flex: 1; padding: 6px; background: var(--light-gray); border: 1px solid var(--border-color); border-radius: var(--element-radius); cursor: pointer; font-size: 0.7rem;">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button class="btn-edit-schedule" data-ride-id="${ride.id}"
                            style="flex: 1; padding: 6px; background: var(--primary-orange); color: white; border: none; border-radius: var(--element-radius); cursor: pointer; font-size: 0.7rem;">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                </div>
            `;
            
            scheduledRidesList.appendChild(rideElement);
        });
        
        // Add event listeners for cancel buttons
        document.querySelectorAll('.btn-cancel-schedule').forEach(btn => {
            btn.addEventListener('click', function() {
                const rideId = this.getAttribute('data-ride-id');
                cancelScheduledRide(rideId);
            });
        });
        
        // Add event listeners for edit buttons
        document.querySelectorAll('.btn-edit-schedule').forEach(btn => {
            btn.addEventListener('click', function() {
                const rideId = this.getAttribute('data-ride-id');
                editScheduledRide(rideId);
            });
        });
    }
}

function cancelScheduledRide(rideId) {
    if (confirm('Are you sure you want to cancel this scheduled ride?')) {
        database.ref('scheduledRides/' + rideId).update({
            status: 'cancelled',
            cancelledAt: firebase.database.ServerValue.TIMESTAMP
        })
        .then(() => {
            // Clear timer
            if (scheduledRideTimers[rideId]) {
                clearTimeout(scheduledRideTimers[rideId]);
                delete scheduledRideTimers[rideId];
            }
            
            // Remove from local array
            scheduledRides = scheduledRides.filter(ride => ride.id !== rideId);
            
            // Update UI
            updateScheduledRidesUI();
            
            showNotification('Scheduled ride cancelled.');
        })
        .catch(error => {
            console.error('Error cancelling scheduled ride:', error);
            showNotification('Error cancelling scheduled ride.');
        });
    }
}

function editScheduledRide(rideId) {
    const ride = scheduledRides.find(r => r.id === rideId);
    if (!ride) {
        showNotification('Scheduled ride not found.');
        return;
    }
    
    openScheduleRidePopup();
    
    // Pre-fill the form with ride data
    setTimeout(() => {
        const activeTab = ride.scheduleType || 'standard';
        document.querySelectorAll('.tab-btn').forEach(tab => {
            tab.classList.remove('active');
            if (tab.getAttribute('data-tab') === activeTab) {
                tab.classList.add('active');
            }
        });
        
        document.querySelectorAll('.schedule-form').forEach(form => {
            form.style.display = 'none';
        });
        
        const activeForm = document.getElementById(`schedule${activeTab.charAt(0).toUpperCase() + activeTab.slice(1)}Form`);
        if (activeForm) {
            activeForm.style.display = 'block';
        }
        
        // Fill form fields based on schedule type
        if (activeTab === 'standard') {
            document.getElementById('schedulePickupLocation').value = ride.pickupDisplayLocation || '';
            document.getElementById('scheduleDestination').value = ride.destination || '';
            
            // Set vehicle type
            document.querySelectorAll('#scheduleStandardForm .vehicle-option').forEach(option => {
                option.classList.remove('selected');
                if (option.getAttribute('data-type') === ride.rideType) {
                    option.classList.add('selected');
                }
            });
            
            // Set package details if any
            if (ride.packageDetails) {
                document.getElementById('schedulePackageToggle').style.display = 'flex';
                document.getElementById('schedulePackageForm').style.display = 'block';
                document.getElementById('scheduleReceiverName').value = ride.packageDetails.receiverName || '';
                document.getElementById('scheduleReceiverPhone').value = ride.packageDetails.receiverPhone || '';
                document.getElementById('schedulePackageDescription').value = ride.packageDetails.packageDescription || '';
                document.getElementById('scheduleSpecialInstructions').value = ride.packageDetails.specialInstructions || '';
            }
        } else if (activeTab === 'delivery') {
            document.getElementById('scheduleShopName').value = ride.expressDelivery?.shopName || '';
            document.getElementById('scheduleShopLocation').value = ride.pickupDisplayLocation || '';
            document.getElementById('scheduleDeliveryItems').value = ride.expressDelivery?.items || '';
            document.getElementById('scheduleDeliveryDestination').value = ride.destination || '';
        } else if (activeTab === 'someone-else') {
            document.getElementById('scheduleRecipientPickup').value = ride.pickupDisplayLocation || '';
            document.getElementById('scheduleRecipientDestination').value = ride.destination || '';
            document.getElementById('scheduleRecipientName').value = ride.orderForSomeone?.recipientName || '';
            document.getElementById('scheduleRecipientPhone').value = ride.orderForSomeone?.recipientPhone || '';
        }
        
        // Set date and time
        const scheduledDate = new Date(ride.scheduledTime);
        document.getElementById('scheduleDate').value = scheduledDate.toISOString().split('T')[0];
        document.getElementById('scheduleTime').value = 
            `${scheduledDate.getHours().toString().padStart(2, '0')}:${scheduledDate.getMinutes().toString().padStart(2, '0')}`;
        
        // Set payment method
        document.getElementById('schedulePaymentMethod').value = ride.paymentMethod || 'wallet';
        
        // Calculate fare
        calculateScheduleFare();
        
        // Update confirm button to say "Update"
        const confirmBtn = document.getElementById('confirmScheduleRideBtn');
        confirmBtn.innerHTML = '<i class="fas fa-save"></i> Update Scheduled Ride';
        confirmBtn.setAttribute('data-edit-ride-id', rideId);
        
        showNotification('Editing scheduled ride. Make your changes and click Update.');
    }, 100);
}

function checkActiveRide(uid) {
    database.ref('rides').orderByChild('passengerId').equalTo(uid).once('value')
        .then(snapshot => {
            const rides = snapshot.val();
            if (rides) {
                for (const rideId in rides) {
                    const ride = rides[rideId];
                    if (ride.status !== 'completed' && ride.status !== 'cancelled' && ride.status !== 'requested') {
                        restoreActiveRide(rideId, ride);
                        break;
                    }
                }
            }
        })
        .catch(error => {
            console.error('Error checking active ride:', error);
        });
}

function restoreActiveRide(rideId, ride) {
    currentRide = {
        id: rideId,
        ...ride
    };
    
    updateUIForActiveRide();
    
    if (ride.status === 'requested') {
        document.getElementById('searchingAnimation').style.display = 'flex';
        document.getElementById('rideStatus').style.display = 'flex';
        document.getElementById('statusDot').className = 'status-dot searching';
        document.getElementById('statusText').textContent = 'Searching for driver';
        
        listenForDriverAssignment(rideId);
    } else if (ride.driverId && (ride.status === 'accepted' || ride.status === 'arrived' || ride.status === 'started' || ride.status === 'picked_up')) {
        handleDriverAssignment(ride);
        updateRideStatusDisplay(ride.status);
        
        if (ride.driverId) {
            trackDriverLocation(ride.driverId);
        }
        
        startDriverMessageListener(rideId);
        
        if (sosConfig && sosConfig.contact1) {
            document.getElementById('sosButton').style.display = 'flex';
        }
        
        if (ride.orderForSomeone || ride.expressDelivery) {
            startLiveTracking(rideId, ride.driverId);
        }
    }
    
    activeRideRestored = true;
    showNotification('Active ride restored');
}

function updateRideStatusDisplay(status) {
    const statusText = document.getElementById('statusText');
    const statusDot = document.getElementById('statusDot');
    const estimatedTime = document.getElementById('estimatedTime');
    
    switch(status) {
        case 'accepted':
            statusText.textContent = 'Driver on the way';
            statusDot.className = 'status-dot arriving';
            estimatedTime.style.display = 'flex';
            break;
        case 'arrived':
            statusText.textContent = 'Driver arrived';
            statusDot.className = 'status-dot riding';
            break;
        case 'started':
            statusText.textContent = 'Trip in progress';
            statusDot.className = 'status-dot riding';
            break;
        case 'picked_up':
            statusText.textContent = 'Trip in progress';
            statusDot.className = 'status-dot riding';
            break;
    }
}

function loadSOSConfig(uid) {
    database.ref('sosConfig/' + uid).once('value')
        .then(snapshot => {
            sosConfig = snapshot.val();
            if (sosConfig) {
                document.getElementById('emergencyContact1').value = sosConfig.contact1 || '';
                document.getElementById('emergencyContact2').value = sosConfig.contact2 || '';
                document.getElementById('sosMessage').value = sosConfig.message || 'I need help! My current location and ride details will be shared with you.';
            }
        })
        .catch(error => {
            console.error('Error loading SOS config:', error);
        });
}

function setupWalletBalanceListener(uid) {
    if (walletBalanceListener) {
        walletBalanceListener();
    }
    
    walletBalanceListener = database.ref('users/' + uid + '/walletBalance').on('value', snapshot => {
        const newBalance = snapshot.val() || 0;
        if (newBalance !== walletBalance) {
            walletBalance = newBalance;
            updateWalletBalanceUI();
        }
    }, error => {
        console.error('Error listening to wallet balance:', error);
    });
}

function updateWalletBalanceUI() {
    document.getElementById('walletBalance').textContent = `K${walletBalance.toFixed(2)}`;
    document.getElementById('accountBalance').textContent = `K${walletBalance.toFixed(2)}`;
    document.getElementById('paymentWalletBalance').textContent = `Balance: K${walletBalance.toFixed(2)}`;
}

// Enhanced Map initialization with city detection
function initializeMap() {
    passengerMap = L.map('map').setView([-15.4167, 28.2833], 13);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: ' OpenStreetMap contributors'
    }).addTo(passengerMap);
    
    popupRideMap = L.map('popupRideMap').setView([-15.4167, 28.2833], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: ' OpenStreetMap contributors'
    }).addTo(popupRideMap);
    
    // Add enhanced controls
    addEnhancedMapControls();
    
    refreshPassengerPosition();
}

function addEnhancedMapControls() {
    // Schedule ride control
    const scheduleControl = L.control({position: 'topleft'});
    scheduleControl.onAdd = function(map) {
        const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
        div.innerHTML = '<button style="background: var(--primary-orange); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 1.2rem;" title="Schedule a Ride"><i class="fas fa-clock"></i></button>';
        div.onclick = openScheduleRidePopup;
        return div;
    };
    scheduleControl.addTo(passengerMap);
    
    // Current location control
    const locationControl = L.control({position: 'topright'});
    locationControl.onAdd = function(map) {
        const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
        div.innerHTML = '<button style="background: var(--info-blue); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 1.2rem;" title="Center on My Location"><i class="fas fa-crosshairs"></i></button>';
        div.onclick = centerMap;
        return div;
    };
    locationControl.addTo(passengerMap);
}

// ULTRA-FAST CITY DETECTION
function determineCurrentCity(lat, lng) {
    return new Promise((resolve, reject) => {
        // First check if we're within city boundaries
        const boundaryCity = checkCityBoundaries(lat, lng);
        if (boundaryCity) {
            currentCity = boundaryCity;
            updateCityDisplay(currentCity);
            resolve(currentCity);
            return;
        }
        
        // If not in boundaries, use reverse geocoding
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1&accept-language=en`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data && data.address) {
                    const detectedCity = extractCityFromAddress(data.address);
                    
                    if (detectedCity && detectedCity !== "Unknown Location") {
                        currentCity = detectedCity;
                        updateCityDisplay(currentCity);
                        resolve(currentCity);
                    } else {
                        const fallbackCity = extractCityFromDisplayName(data.display_name);
                        currentCity = fallbackCity;
                        updateCityDisplay(currentCity);
                        resolve(currentCity);
                    }
                } else {
                    currentCity = null;
                    updateCityDisplay("Unknown");
                    resolve(null);
                }
            })
            .catch(error => {
                console.error('Error in city detection:', error);
                currentCity = null;
                updateCityDisplay("Unknown");
                resolve(null);
            });
    });
}

function checkCityBoundaries(lat, lng) {
    for (const [city, boundary] of Object.entries(cityBoundaries)) {
        const distance = calculateDistance(lat, lng, boundary.lat, boundary.lng);
        if (distance <= boundary.radius) {
            return city;
        }
    }
    return null;
}

function extractCityFromAddress(address) {
    const priorityFields = [
        'city', 'town', 'village', 'municipality', 
        'suburb', 'county', 'state_district', 'state'
    ];
    
    for (const field of priorityFields) {
        if (address[field]) {
            const detectedName = address[field].toString().trim();
            const normalized = normalizeCityName(detectedName);
            if (zambianCities.includes(normalized)) {
                return normalized;
            }
        }
    }
    
    return null;
}

function extractCityFromDisplayName(displayName) {
    if (!displayName) return "Unknown Location";
    
    const nameLower = displayName.toLowerCase();
    
    for (const city of zambianCities) {
        if (nameLower.includes(city.toLowerCase())) {
            return city;
        }
    }
    
    for (const [alias, actualCity] of Object.entries(cityAliases)) {
        if (nameLower.includes(alias)) {
            return actualCity;
        }
    }
    
    return "Unknown Location";
}

function normalizeCityName(cityName) {
    if (!cityName) return "";
    
    const normalized = cityName.toString().trim();
    
    const variations = {
        'lusaka city': 'Lusaka', 'lska': 'Lusaka',
        'kitwe town': 'Kitwe', 'ndola city': 'Ndola',
        'kabwe town': 'Kabwe', 'chipata town': 'Chipata',
        'chingola town': 'Chingola', 'mufulira town': 'Mufulira',
        'luanshya town': 'Luanshya', 'livingstone town': 'Livingstone',
        'kasama town': 'Kasama', 'solwezi town': 'Solwezi',
        'kapiri mposhi town': 'Kapiri Mposhi', 'chililabombwe town': 'Chililabombwe'
    };
    
    return variations[normalized.toLowerCase()] || 
           zambianCities.find(city => city.toLowerCase() === normalized.toLowerCase()) || 
           normalized;
}

function updateCityDisplay(cityName) {
    const cityDisplay = document.getElementById('currentCityDisplay');
    if (cityDisplay) {
        cityDisplay.textContent = cityName;
        if (cityName !== "Detecting..." && cityName !== "Unknown") {
            cityDisplay.style.color = "var(--success-green)";
            cityDisplay.style.fontWeight = "900";
            
            // Show notification for city detection
            if (currentScreen === 'home') {
                showNotification(` You're in ${cityName}. Search results will be limited to this city for accuracy.`);
            }
        }
    }
}

function refreshPassengerPosition() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            userLocation = { lat, lng };
            
            passengerMap.setView([lat, lng], 16);
            
            if (currentLocationMarker) {
                currentLocationMarker.setLatLng([lat, lng]);
            } else {
                currentLocationMarker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        className: 'current-location-marker',
                        html: '<div class="current-location-marker"><i class="fas fa-user"></i></div>',
                        iconSize: [18, 18]
                    })
                }).addTo(passengerMap)
                    .bindPopup('Your location');
            }
            
            updatePickupLocation(lat, lng);
            
            determineCurrentCity(lat, lng).then(city => {
                console.log("Final detected city:", city);
                
                // Pre-fill pickup location with city-based address
                if (city && city !== "Unknown") {
                    getAddressForDisplay(lat, lng).then(address => {
                        if (address) {
                            document.getElementById('pickupLocation').value = address;
                        }
                    });
                }
                
                // Clear search cache for new city
                clearSearchCacheForNewCity(city);
            }).catch(error => {
                console.error('City detection failed:', error);
                currentCity = null;
            });
            
            if (!locationWatchId) {
                startLocationTracking();
            }
            
        }, error => {
            console.error('Geolocation error:', error);
            handleGeolocationError(error);
        }, {
            enableHighAccuracy: true,
            timeout: 15000,
            maximumAge: 30000
        });
    } else {
        showNotification('Geolocation is not supported by this browser.');
        currentCity = null;
    }
}

function clearSearchCacheForNewCity(newCity) {
    if (!newCity) return;
    
    // Clear cache entries that don't match current city
    const newCache = new Map();
    for (const [key, value] of searchCache.entries()) {
        if (key.includes(newCity)) {
            newCache.set(key, value);
        }
    }
    searchCache = newCache;
}

function getAddressForDisplay(lat, lng) {
    return new Promise((resolve, reject) => {
        // First try to get a quick address from city data
        if (currentCity) {
            // Return a simple address based on city
            const simpleAddress = `Near ${currentCity}, Zambia`;
            resolve(simpleAddress);
            return;
        }
        
        // Fallback to detailed geocoding
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=16&addressdetails=1&accept-language=en`)
            .then(response => response.json())
            .then(data => {
                if (data && data.display_name) {
                    resolve(data.display_name);
                } else {
                    resolve(`${lat.toFixed(6)}, ${lng.toFixed(6)}`);
                }
            })
            .catch(error => {
                console.error('Full address geocoding error:', error);
                resolve(`${lat.toFixed(6)}, ${lng.toFixed(6)}`);
            });
    });
}

function handleGeolocationError(error) {
    let errorMessage = 'Unable to refresh location. ';
    
    switch(error.code) {
        case error.PERMISSION_DENIED:
            errorMessage += 'Please enable location services in your browser settings.';
            break;
        case error.POSITION_UNAVAILABLE:
            errorMessage += 'Location information is unavailable.';
            break;
        case error.TIMEOUT:
            errorMessage += 'Location request timed out. Please try again.';
            break;
        default:
            errorMessage += 'Please enable location services.';
    }
    
    if (currentScreen === 'home') {
        showNotification(errorMessage);
    }
    
    currentCity = null;
}

function updatePickupLocation(lat, lng) {
    if (pickupMarker) {
        passengerMap.removeLayer(pickupMarker);
    }
    
    pickupMarker = L.marker([lat, lng], {
        icon: L.divIcon({
            className: 'pickup-marker',
            html: '<div class="pickup-marker"><i class="fas fa-map-marker-alt"></i></div>',
            iconSize: [22, 22]
        })
    }).addTo(passengerMap)
        .bindPopup('Pickup Location');
        
    getAddressForDisplay(lat, lng).then(address => {
        document.getElementById('pickupLocation').value = address;
    });
    
    // Make pickup location editable
    document.getElementById('pickupLocation').removeAttribute('readonly');
    
    addPickupLocationClearButton();
}

function addPickupLocationClearButton() {
    const pickupInput = document.getElementById('pickupLocation');
    const parent = pickupInput.parentElement;
    
    const existingClear = parent.querySelector('.clear-pickup-btn');
    if (existingClear) {
        existingClear.remove();
    }
    
    const clearBtn = document.createElement('button');
    clearBtn.className = 'clear-pickup-btn';
    clearBtn.innerHTML = '<i class="fas fa-times"></i>';
    clearBtn.style.cssText = `
        background: none;
        border: none;
        color: var(--error-red);
        font-size: 1rem;
        cursor: pointer;
        padding: 0 5px;
    `;
    clearBtn.title = 'Clear pickup location';
    
    clearBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        document.getElementById('pickupLocation').value = '';
        
        if (pickupMarker) {
            passengerMap.removeLayer(pickupMarker);
            pickupMarker = null;
        }
        
        if (userLocation) {
            updatePickupLocation(userLocation.lat, userLocation.lng);
        }
    });
    
    parent.appendChild(clearBtn);
}

// ADVANCED CITY-LOCKED SEARCH FUNCTIONALITY
function searchPlacesEnhanced(query, searchType = 'destination') {
    if (!query || query.length < 2) {
        hideSearchSuggestions(searchType);
        return;
    }
    
    const suggestionsContainer = document.getElementById(`${searchType}Suggestions`);
    
    // Show loading immediately
    suggestionsContainer.innerHTML = '<div class="search-loading"><i class="fas fa-spinner fa-spin"></i> Searching...</div>';
    suggestionsContainer.style.display = 'block';
    
    // Debounce search
    const now = Date.now();
    if (now - lastSearchTime < SEARCH_DEBOUNCE_TIME) {
        setTimeout(() => searchPlacesEnhanced(query, searchType), SEARCH_DEBOUNCE_TIME);
        return;
    }
    lastSearchTime = now;
    
    // Check cache first
    const cacheKey = `${currentCity}_${query}_${searchType}`;
    if (searchCache.has(cacheKey)) {
        const cachedResult = searchCache.get(cacheKey);
        if (Date.now() - cachedResult.timestamp < CACHE_DURATION) {
            displaySearchResults(cachedResult.results, searchType);
            return;
        }
    }
    
    // Check for common places first (instant results)
    const commonPlaces = getCommonPlacesSuggestions(query);
    if (commonPlaces.length > 0) {
        displaySearchResults(commonPlaces, searchType);
        // Also cache these results
        searchCache.set(cacheKey, {
            results: commonPlaces,
            timestamp: Date.now()
        });
        return;
    }
    
    // Perform city-locked search
    performCityLockedSearch(query, searchType)
        .then(results => {
            if (results.length > 0) {
                // Cache results
                searchCache.set(cacheKey, {
                    results: results,
                    timestamp: Date.now()
                });
                
                displaySearchResults(results, searchType);
                
                // Auto-select first result if it's highly relevant
                if (results[0].relevanceScore > 8 && results.length === 1) {
                    const inputField = getSearchInputField(searchType);
                    if (inputField && inputField.value === query) {
                        setTimeout(() => {
                            handleSearchResultSelection(results[0], searchType);
                        }, 100);
                    }
                }
            } else {
                showNoResultsMessage(query, searchType);
            }
        })
        .catch(error => {
            console.error('Search error:', error);
            showNoResultsMessage(query, searchType);
        });
}

function getCommonPlacesSuggestions(query) {
    if (!currentCity || !zambianCommonPlaces[currentCity]) {
        return [];
    }
    
    const queryLower = query.toLowerCase();
    const places = zambianCommonPlaces[currentCity];
    
    // Exact matches first
    const exactMatches = places.filter(place => 
        place.toLowerCase().includes(queryLower)
    );
    
    // Partial matches
    const partialMatches = places.filter(place => {
        const placeLower = place.toLowerCase();
        const queryWords = queryLower.split(' ');
        return queryWords.some(word => 
            word.length > 2 && placeLower.includes(word)
        );
    });
    
    // Combine and deduplicate
    const allMatches = [...new Set([...exactMatches, ...partialMatches])];
    
    // Convert to search result format
    return allMatches.map(place => {
        const result = {
            display_name: place,
            name: place,
            type: 'common_place',
            class: 'amenity',
            relevanceScore: 10,
            city: currentCity,
            isCurrentCity: true,
            displayLat: cityBoundaries[currentCity]?.lat || -15.4167,
            displayLon: cityBoundaries[currentCity]?.lng || 28.2833,
            distance: 0
        };
        
        // Add distance calculation if we have user location
        if (userLocation) {
            result.distance = calculateDistance(
                userLocation.lat, userLocation.lng,
                result.displayLat, result.displayLon
            );
        }
        
        return result;
    }).slice(0, 5); // Limit to 5 results
}

function getSearchInputField(searchType) {
    switch(searchType) {
        case 'destination': return document.getElementById('destinationLocation');
        case 'pickup': return document.getElementById('pickupLocation');
        case 'recipientPickup': return document.getElementById('recipientPickupLocation');
        case 'recipientDestination': return document.getElementById('recipientDestinationLocation');
        case 'shopLocation': return document.getElementById('shopLocation');
        case 'deliveryDestination': return document.getElementById('deliveryDestination');
        case 'schedulePickup': return document.getElementById('schedulePickupLocation');
        case 'scheduleDestination': return document.getElementById('scheduleDestination');
        case 'scheduleShop': return document.getElementById('scheduleShopLocation');
        case 'scheduleDeliveryDest': return document.getElementById('scheduleDeliveryDestination');
        case 'scheduleRecipientPickup': return document.getElementById('scheduleRecipientPickup');
        case 'scheduleRecipientDest': return document.getElementById('scheduleRecipientDestination');
        default: return null;
    }
}

function performCityLockedSearch(query, searchType) {
    return new Promise((resolve, reject) => {
        // If no city detected, perform country-wide search
        if (!currentCity || currentCity === "Unknown") {
            performUnifiedSearch(query)
                .then(resolve)
                .catch(reject);
            return;
        }
        
        // Build search query with city lock
        const cityBoundary = cityBoundaries[currentCity];
        let searchQuery = `${query}, ${currentCity}, Zambia`;
        
        // Use bounded search for better accuracy
        const bbox = calculateCityBoundingBox(cityBoundary);
        const bboxStr = `${bbox.minLng},${bbox.minLat},${bbox.maxLng},${bbox.maxLat}`;
        
        // Show searching indicator
        const inputField = getSearchInputField(searchType);
        if (inputField) {
            inputField.parentElement.classList.add('searching');
        }
        
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&limit=15&dedupe=1&countrycodes=zm&bounded=1&viewbox=${bboxStr}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Search API error: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (inputField) {
                    inputField.parentElement.classList.remove('searching');
                }
                
                if (data && data.length > 0) {
                    const enhancedResults = data
                        .filter(place => {
                            // Strict city boundary filtering
                            const distance = calculateDistance(
                                parseFloat(place.lat), parseFloat(place.lon),
                                cityBoundary.lat, cityBoundary.lng
                            );
                            return distance <= cityBoundary.radius * 1.5;
                        })
                        .map(place => {
                            const distance = userLocation ? calculateDistance(
                                userLocation.lat, userLocation.lng,
                                parseFloat(place.lat), parseFloat(place.lon)
                            ) : 0;
                            
                            const placeCity = extractCityFromPlace(place) || currentCity;
                            
                            return {
                                ...place,
                                displayLat: parseFloat(place.lat),
                                displayLon: parseFloat(place.lon),
                                distance,
                                city: placeCity,
                                isCurrentCity: placeCity === currentCity,
                                relevanceScore: calculateRelevanceScore(place, query, placeCity),
                                displayName: formatDisplayName(place.display_name, placeCity)
                            };
                        })
                        .sort((a, b) => {
                            if (b.relevanceScore !== a.relevanceScore) {
                                return b.relevanceScore - a.relevanceScore;
                            }
                            return a.distance - b.distance;
                        });
                    
                    resolve(enhancedResults);
                } else {
                    // Fallback to regular search
                    performUnifiedSearch(query)
                        .then(resolve)
                        .catch(reject);
                }
            })
            .catch(error => {
                if (inputField) {
                    inputField.parentElement.classList.remove('searching');
                }
                console.error('City-locked search error:', error);
                performUnifiedSearch(query)
                    .then(resolve)
                    .catch(reject);
            });
    });
}

function calculateCityBoundingBox(cityBoundary) {
    const radiusKm = cityBoundary.radius / 1000;
    const latDelta = (radiusKm / 111.32);
    const lngDelta = (radiusKm / (111.32 * Math.cos(cityBoundary.lat * Math.PI / 180)));
    
    return {
        minLat: cityBoundary.lat - latDelta,
        maxLat: cityBoundary.lat + latDelta,
        minLng: cityBoundary.lng - lngDelta,
        maxLng: cityBoundary.lng + lngDelta
    };
}

function performUnifiedSearch(query) {
    return new Promise((resolve, reject) => {
        let searchQuery = query;
        if (currentCity && currentCity !== "Unknown") {
            searchQuery = `${query}, ${currentCity}, Zambia`;
        } else {
            searchQuery = `${query}, Zambia`;
        }
        
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&limit=10&dedupe=1&countrycodes=zm`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Search API error: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data && data.length > 0) {
                    const enhancedResults = data
                        .filter(place => place.display_name && place.lat && place.lon)
                        .map(place => {
                            const distance = userLocation ? calculateDistance(
                                userLocation.lat, userLocation.lng,
                                parseFloat(place.lat), parseFloat(place.lon)
                            ) : 0;
                            
                            const placeCity = extractCityFromPlace(place) || currentCity || "Unknown";
                            
                            return {
                                ...place,
                                displayLat: parseFloat(place.lat),
                                displayLon: parseFloat(place.lon),
                                distance,
                                city: placeCity,
                                isCurrentCity: placeCity === currentCity,
                                relevanceScore: calculateRelevanceScore(place, query, placeCity),
                                displayName: formatDisplayName(place.display_name, placeCity)
                            };
                        })
                        .sort((a, b) => {
                            if (b.relevanceScore !== a.relevanceScore) {
                                return b.relevanceScore - a.relevanceScore;
                            }
                            return a.distance - b.distance;
                        });
                    
                    resolve(enhancedResults);
                } else {
                    resolve([]);
                }
            })
            .catch(error => {
                console.error('Unified search error:', error);
                reject(error);
            });
    });
}

function displaySearchResults(results, searchType) {
    const suggestionsContainer = document.getElementById(`${searchType}Suggestions`);
    
    suggestionsContainer.innerHTML = '';
    
    updateSearchResultsCache(results, searchType);
    
    if (results.length === 0) {
        showNoResultsMessage('', searchType);
        return;
    }
    
    const uniqueResults = removeDuplicatePlaces(results).slice(0, 8);
    
    uniqueResults.forEach((result, index) => {
        const suggestionItem = document.createElement('div');
        suggestionItem.className = 'suggestion-item';
        if (index === 0) suggestionItem.classList.add('first-result');
        
        const placeType = getPlaceType(result);
        const placeIcon = getPlaceIcon(placeType);
        
        const cityBadge = result.isCurrentCity ? '' : 
            `<span class="city-badge">${result.city}</span>`;
        
        const distanceText = userLocation && result.distance > 0 ? 
            `${(result.distance / 1000).toFixed(1)} km away` : '';
        
        const displayName = result.displayName || result.display_name;
        
        suggestionItem.innerHTML = `
            <div class="suggestion-icon">${placeIcon}</div>
            <div class="suggestion-details">
                <div class="suggestion-name">
                    ${displayName}
                    ${cityBadge}
                </div>
                <div class="suggestion-address">${getShortAddress(result.display_name)}</div>
                <div class="suggestion-distance">${distanceText}</div>
            </div>
            ${result.isCurrentCity ? '<div class="current-city-indicator"> Current City</div>' : ''}
        `;
        
        suggestionItem.addEventListener('click', function() {
            handleSearchResultSelection(result, searchType);
        });
        
        suggestionsContainer.appendChild(suggestionItem);
    });
    
    suggestionsContainer.style.display = 'block';
}

function handleSearchResultSelection(result, searchType) {
    const inputField = getSearchInputField(searchType);
    
    if (inputField) {
        inputField.value = result.display_name;
    }
    
    hideSearchSuggestions(searchType);
    
    switch(searchType) {
        case 'destination':
            updateFareEstimate();
            updateDestinationMarker(
                result.displayLat, 
                result.displayLon, 
                result.display_name
            );
            
            if (userLocation) {
                drawRoute(userLocation.lat, userLocation.lng, result.displayLat, result.displayLon);
            }
            
            selectedDestination = result;
            document.getElementById('requestRideBtn').disabled = false;
            
            showNotification(`Destination set to ${result.displayName}`);
            break;
            
        case 'pickup':
            updateManualPickupLocation(result.displayLat, result.displayLon, result.display_name);
            showNotification(`Pickup location set to ${result.displayName}`);
            break;
            
        case 'recipientPickup':
            calculateRecipientDeliveryFee();
            updateRecipientPickupMarker(result.displayLat, result.displayLon, result.display_name);
            showNotification(`Recipient pickup set to ${result.displayName}`);
            break;
            
        case 'recipientDestination':
            calculateRecipientDeliveryFee();
            updateRecipientDestinationMarker(result.displayLat, result.displayLon, result.display_name);
            showNotification(`Recipient destination set to ${result.displayName}`);
            break;
            
        case 'shopLocation':
            calculateExpressDeliveryFee();
            updateShopLocationMarker(result.displayLat, result.displayLon, result.display_name);
            showNotification(`Shop location set to ${result.displayName}`);
            break;
            
        case 'deliveryDestination':
            calculateExpressDeliveryFee();
            updateDeliveryDestinationMarker(result.displayLat, result.displayLon, result.display_name);
            showNotification(`Delivery destination set to ${result.displayName}`);
            break;
            
        case 'schedulePickup':
            calculateScheduleFare();
            break;
            
        case 'scheduleDestination':
            calculateScheduleFare();
            break;
            
        case 'scheduleShop':
            calculateScheduleFare();
            break;
            
        case 'scheduleDeliveryDest':
            calculateScheduleFare();
            break;
            
        case 'scheduleRecipientPickup':
            calculateScheduleFare();
            break;
            
        case 'scheduleRecipientDest':
            calculateScheduleFare();
            break;
    }
}

function updateManualPickupLocation(lat, lng, name) {
    if (currentLocationMarker) {
        passengerMap.removeLayer(currentLocationMarker);
        currentLocationMarker = null;
    }
    
    if (pickupMarker) {
        passengerMap.removeLayer(pickupMarker);
    }
    
    pickupMarker = L.marker([lat, lng], {
        icon: L.divIcon({
            className: 'pickup-marker',
            html: '<div class="pickup-marker"><i class="fas fa-map-marker-alt"></i></div>',
            iconSize: [22, 22]
        })
    }).addTo(passengerMap)
        .bindPopup(`<strong>${name}</strong><br>Pickup Location`)
        .openPopup();
    
    userLocation = { lat, lng };
    
    const destination = document.getElementById('destinationLocation').value;
    if (destination) {
        updateFareEstimate();
        
        forwardGeocode(destination).then(results => {
            if (results.length > 0) {
                const destLat = parseFloat(results[0].lat);
                const destLng = parseFloat(results[0].lon);
                drawRoute(lat, lng, destLat, destLng);
            }
        });
    }
    
    passengerMap.setView([lat, lng], 16);
}

function updateSearchResultsCache(results, searchType) {
    switch(searchType) {
        case 'destination': 
            destinationSearchResults = results;
            break;
        case 'pickup':
            pickupSearchResults = results;
            break;
        case 'recipientPickup':
            recipientPickupSearchResults = results;
            break;
        case 'recipientDestination':
            destinationSearchResults = results;
            break;
        case 'shopLocation':
            shopLocationSearchResults = results;
            break;
        case 'deliveryDestination':
            deliveryDestinationSearchResults = results;
            break;
    }
}

function setupSearchInputListeners() {
    const searchConfigs = [
        { type: 'destination', input: 'destinationLocation', suggestions: 'destinationSuggestions' },
        { type: 'pickup', input: 'pickupLocation', suggestions: 'pickupSuggestions' },
        { type: 'recipientPickup', input: 'recipientPickupLocation', suggestions: 'recipientPickupSuggestions' },
        { type: 'recipientDestination', input: 'recipientDestinationLocation', suggestions: 'recipientDestinationSuggestions' },
        { type: 'shopLocation', input: 'shopLocation', suggestions: 'shopLocationSuggestions' },
        { type: 'deliveryDestination', input: 'deliveryDestination', suggestions: 'deliveryDestinationSuggestions' },
        { type: 'schedulePickup', input: 'schedulePickupLocation', suggestions: 'schedulePickupSuggestions' },
        { type: 'scheduleDestination', input: 'scheduleDestination', suggestions: 'scheduleDestinationSuggestions' },
        { type: 'scheduleShop', input: 'scheduleShopLocation', suggestions: 'scheduleShopSuggestions' },
        { type: 'scheduleDeliveryDest', input: 'scheduleDeliveryDestination', suggestions: 'scheduleDeliveryDestSuggestions' },
        { type: 'scheduleRecipientPickup', input: 'scheduleRecipientPickup', suggestions: 'scheduleRecipientPickupSuggestions' },
        { type: 'scheduleRecipientDest', input: 'scheduleRecipientDestination', suggestions: 'scheduleRecipientDestSuggestions' }
    ];
    
    searchConfigs.forEach(config => {
        const inputField = document.getElementById(config.input);
        if (inputField) {
            setupSearchInputListener(config.type, config.input, config.suggestions);
        }
    });
}

function setupSearchInputListener(searchType, inputId, suggestionsId) {
    let lastQuery = '';
    const inputField = document.getElementById(inputId);
    
    inputField.addEventListener('input', function() {
        const query = this.value.trim();
        
        if (window.searchTimeout) {
            clearTimeout(window.searchTimeout);
        }
        
        if (query.length >= 2 && query !== lastQuery) {
            // Add searching indicator
            this.parentElement.classList.add('searching');
            
            window.searchTimeout = setTimeout(() => {
                lastQuery = query;
                
                // For all searches, enforce city lock if city is detected
                if (currentCity) {
                    searchPlacesEnhanced(query, searchType);
                } else {
                    searchPlacesEnhanced(query, searchType);
                }
                
                this.parentElement.classList.remove('searching');
            }, 300);
        } else if (query.length < 2) {
            hideSearchSuggestions(searchType);
            lastQuery = '';
            inputField.parentElement.classList.remove('searching');
        }
    });
    
    inputField.addEventListener('focus', function() {
        const query = this.value.trim();
        const cachedResults = getCachedSearchResults(searchType);
        
        if (query.length >= 2 && cachedResults.length > 0) {
            displaySearchResults(cachedResults, searchType);
        } else if (query.length >= 2) {
            searchPlacesEnhanced(query, searchType);
        }
    });
    
    inputField.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            hideSearchSuggestions(searchType);
        } else if (e.key === 'Enter') {
            hideSearchSuggestions(searchType);
            const cachedResults = getCachedSearchResults(searchType);
            if (cachedResults.length > 0) {
                handleSearchResultSelection(cachedResults[0], searchType);
            }
        }
    });
    
    // Handle click outside to close suggestions
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.location-input') && !e.target.closest('.suggestion-list')) {
            hideSearchSuggestions(searchType);
        }
    });
}

function hideSearchSuggestions(searchType) {
    const suggestionsContainer = document.getElementById(`${searchType}Suggestions`);
    if (suggestionsContainer) {
        suggestionsContainer.style.display = 'none';
    }
    
    if (window.searchTimeout) {
        clearTimeout(window.searchTimeout);
        window.searchTimeout = null;
    }
}

function showNoResultsMessage(query = '', searchType = 'destination') {
    const suggestionsContainer = document.getElementById(`${searchType}Suggestions`);
    
    if (suggestionsContainer) {
        let message = 'No places found';
        if (currentCity && searchType === 'pickup') {
            message += ` in ${currentCity}`;
        } else if (currentCity) {
            message += ` in ${currentCity}`;
        }
        
        if (query) {
            message += ` for "${query}"`;
        }
        
        suggestionsContainer.innerHTML = `<div class="no-results">${message}</div>`;
    }
}

function calculateRelevanceScore(place, query, city) {
    let score = 0;
    const placeName = place.display_name.toLowerCase();
    const queryLower = query.toLowerCase();
    const cityLower = city.toLowerCase();
    
    if (placeName.includes(queryLower)) {
        score += 10;
    }
    
    const queryWords = queryLower.split(' ');
    queryWords.forEach(word => {
        if (word.length > 2 && placeName.includes(word)) {
            score += 5;
        }
    });
    
    if (city === currentCity) {
        score += 8;
    }
    
    if (place.type === 'administrative' || place.class === 'boundary') {
        score -= 2;
    }
    
    if (place.importance) {
        score += place.importance * 5;
    }
    
    if (userLocation) {
        const distance = calculateDistance(
            userLocation.lat, userLocation.lng,
            parseFloat(place.lat), parseFloat(place.lon)
        );
        if (distance > 50000) {
            score -= 3;
        } else if (distance < 1000) {
            score += 2;
        }
    }
    
    // Bonus for common places
    if (place.type === 'common_place') {
        score += 3;
    }
    
    return Math.max(0, score);
}

function extractCityFromPlace(place) {
    if (place.address) {
        return extractCityFromAddress(place.address);
    }
    
    return extractCityFromDisplayName(place.display_name);
}

function formatDisplayName(fullName, city) {
    if (!fullName) return 'Unknown Location';
    
    // For common places, return the name as is
    if (fullName.type === 'common_place') {
        return fullName.name || fullName;
    }
    
    const parts = fullName.split(',');
    const relevantParts = [];
    
    for (let i = 0; i < parts.length; i++) {
        const part = parts[i].trim();
        const partLower = part.toLowerCase();
        
        if (zambianCities.some(c => c.toLowerCase() === partLower) ||
            partLower === 'zambia' ||
            partLower.includes('province')) {
            break;
        }
        
        relevantParts.push(part);
    }
    
    return relevantParts.join(', ') || fullName;
}

function getShortAddress(fullAddress) {
    if (!fullAddress) return '';
    
    // For common places, return empty
    if (fullAddress.type === 'common_place') {
        return '';
    }
    
    const parts = fullAddress.split(',');
    return parts.slice(0, Math.min(3, parts.length)).join(', ');
}

function removeDuplicatePlaces(places) {
    const seen = new Set();
    return places.filter(place => {
        const coordKey = `${place.lat}-${place.lon}`;
        const nameKey = place.display_name ? place.display_name.substring(0, 50).toLowerCase() : place.name?.substring(0, 50).toLowerCase() || '';
        const uniqueKey = `${coordKey}-${nameKey}`;
        
        if (seen.has(uniqueKey)) {
            return false;
        }
        seen.add(uniqueKey);
        return true;
    });
}

function getCachedSearchResults(searchType) {
    switch(searchType) {
        case 'destination': return destinationSearchResults;
        case 'pickup': return pickupSearchResults;
        case 'recipientPickup': return recipientPickupSearchResults;
        case 'recipientDestination': return destinationSearchResults;
        case 'shopLocation': return shopLocationSearchResults;
        case 'deliveryDestination': return deliveryDestinationSearchResults;
        default: return [];
    }
}

function getPlaceType(place) {
    if (place.type === 'common_place') {
        return 'place';
    }
    
    if (place.type === 'restaurant' || place.class === 'amenity' && place.type === 'restaurant') {
        return 'restaurant';
    } else if (place.type === 'cafe' || place.class === 'amenity' && place.type === 'cafe') {
        return 'cafe';
    } else if (place.type === 'bar' || place.class === 'amenity' && place.type === 'bar') {
        return 'bar';
    } else if (place.type === 'pub' || place.class === 'amenity' && place.type === 'pub') {
        return 'pub';
    } else if (place.type === 'fast_food' || place.class === 'amenity' && place.type === 'fast_food') {
        return 'fast_food';
    } else if (place.type === 'bank' || place.class === 'amenity' && place.type === 'bank') {
        return 'bank';
    } else if (place.type === 'atm' || place.class === 'amenity' && place.type === 'atm') {
        return 'atm';
    } else if (place.type === 'hospital' || place.class === 'amenity' && place.type === 'hospital') {
        return 'hospital';
    } else if (place.type === 'pharmacy' || place.class === 'amenity' && place.type === 'pharmacy') {
        return 'pharmacy';
    } else if (place.type === 'school' || place.class === 'amenity' && place.type === 'school') {
        return 'school';
    } else if (place.type === 'university' || place.class === 'amenity' && place.type === 'university') {
        return 'university';
    } else if (place.type === 'library' || place.class === 'amenity' && place.type === 'library') {
        return 'library';
    } else if (place.type === 'cinema' || place.class === 'amenity' && place.type === 'cinema') {
        return 'cinema';
    } else if (place.type === 'theatre' || place.class === 'amenity' && place.type === 'theatre') {
        return 'theatre';
    } else if (place.type === 'museum' || place.class === 'amenity' && place.type === 'museum') {
        return 'museum';
    } else if (place.type === 'hotel' || place.class === 'tourism' && place.type === 'hotel') {
        return 'hotel';
    } else if (place.type === 'supermarket' || place.class === 'shop' && place.type === 'supermarket') {
        return 'supermarket';
    } else if (place.type === 'mall' || place.class === 'shop' && place.type === 'mall') {
        return 'mall';
    } else if (place.type === 'clothes' || place.class === 'shop' && place.type === 'clothes') {
        return 'clothes';
    } else if (place.type === 'fuel' || place.class === 'amenity' && place.type === 'fuel') {
        return 'fuel';
    } else if (place.type === 'parking' || place.class === 'amenity' && place.type === 'parking') {
        return 'parking';
    } else if (place.type === 'bus_station' || place.class === 'amenity' && place.type === 'bus_station') {
        return 'bus_station';
    } else if (place.type === 'taxi' || place.class === 'amenity' && place.type === 'taxi') {
        return 'taxi';
    } else if (place.type === 'police' || place.class === 'amenity' && place.type === 'police') {
        return 'police';
    } else if (place.type === 'market' || place.class === 'amenity' && place.type === 'marketplace') {
        return 'market';
    } else if (place.type === 'post_office' || place.class === 'amenity' && place.type === 'post_office') {
        return 'post_office';
    } else if (place.type === 'place_of_worship' || place.class === 'amenity' && place.type === 'place_of_worship') {
        return 'place_of_worship';
    } else if (place.type === 'stadium' || place.class === 'leisure' && place.type === 'stadium') {
        return 'stadium';
    } else if (place.type === 'park' || place.class === 'leisure' && place.type === 'park') {
        return 'park';
    } else if (place.type === 'monument' || place.class === 'historic' && place.type === 'monument') {
        return 'monument';
    } else if (place.type === 'castle' || place.class === 'historic' && place.type === 'castle') {
        return 'castle';
    } else {
        return 'place';
    }
}

function getPlaceIcon(placeType) {
    const icons = {
        'restaurant': '',
        'cafe': '',
        'bar': '',
        'pub': '',
        'fast_food': '',
        'bank': '',
        'atm': '',
        'hospital': '',
        'pharmacy': '',
        'school': '',
        'university': '',
        'library': '',
        'cinema': '',
        'theatre': '',
        'museum': '',
        'hotel': '',
        'supermarket': '',
        'mall': '',
        'clothes': '',
        'fuel': '',
        'parking': '',
        'bus_station': '',
        'taxi': '',
        'police': '',
        'market': '',
        'post_office': '',
        'place_of_worship': '',
        'stadium': '',
        'park': '',
        'monument': '',
        'castle': ''
    };
    
    return icons[placeType] || '';
}

function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371e3;
    const 1 = lat1 * Math.PI / 180;
    const 2 = lat2 * Math.PI / 180;
    const  = (lat2 - lat1) * Math.PI / 180;
    const  = (lon2 - lon1) * Math.PI / 180;

    const a = Math.sin(/2) * Math.sin(/2) +
              Math.cos(1) * Math.cos(2) *
              Math.sin(/2) * Math.sin(/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

    return R * c;
}

function forwardGeocode(query) {
    return new Promise(resolve => {
        if (!userLocation) {
            resolve([]);
            return;
        }
        
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=10&countrycodes=zm`)
            .then(response => response.json())
            .then(data => {
                const filteredResults = data.filter(result => {
                    const distance = calculateDistance(
                        userLocation.lat, userLocation.lng,
                        parseFloat(result.lat), parseFloat(result.lon)
                    );
                    return distance <= 50000;
                });
                
                resolve(filteredResults);
            })
            .catch(error => {
                console.error('Forward geocoding error:', error);
                resolve([]);
            });
    });
}

function updateFareEstimate() {
    const destination = document.getElementById('destinationLocation').value;
    
    if (destination.length > 3 && userLocation) {
        forwardGeocode(destination).then(results => {
            if (results.length > 0) {
                const destLat = parseFloat(results[0].lat);
                const destLng = parseFloat(results[0].lon);
                
                const distance = calculateDistance(
                    userLocation.lat, userLocation.lng,
                    destLat, destLng
                );
                
                let baseFare = 23;
                
                if (distance > 0) {
                    baseFare += Math.ceil(distance / 90);
                }
                
                switch(selectedVehicleType) {
                    case 'car':
                        baseFare = baseFare;
                        break;
                    case 'bike':
                        baseFare = baseFare * 0.7;
                        break;
                    case 'bicycle':
                        baseFare = baseFare * 0.5;
                        break;
                }
                
                if (appliedPromoCode) {
                    baseFare = baseFare * 0.8;
                }
                
                document.getElementById('estimatedFare').textContent = `K${baseFare.toFixed(2)}`;
                
                const etaMinutes = Math.ceil((distance / 1000) / 30 * 60);
                document.getElementById('etaDisplay').textContent = `ETA: ${etaMinutes} min`;
                
                document.getElementById('requestRideBtn').disabled = false;
                
                rideFare = baseFare;
            }
        });
    } else {
        document.getElementById('estimatedFare').textContent = 'K0.00';
        document.getElementById('etaDisplay').textContent = 'ETA: -- min';
        document.getElementById('requestRideBtn').disabled = true;
    }
}

function updateDestinationMarker(lat, lng, name) {
    if (destinationMarker) {
        passengerMap.removeLayer(destinationMarker);
    }
    
    destinationMarker = L.marker([lat, lng], {
        icon: L.divIcon({
            className: 'destination-marker',
            html: '<div class="destination-marker"><i class="fas fa-flag"></i></div>',
            iconSize: [22, 22]
        })
    }).addTo(passengerMap)
        .bindPopup(`<strong>${name}</strong><br>Your destination`)
        .openPopup();
    
    if (userLocation) {
        const bounds = L.latLngBounds(
            [userLocation.lat, userLocation.lng],
            [lat, lng]
        );
        passengerMap.fitBounds(bounds, { padding: [12, 12] });
    }
}

function drawRoute(startLat, startLng, endLat, endLng) {
    if (routePolyline) {
        passengerMap.removeLayer(routePolyline);
    }
    
    fetch(`https://router.project-osrm.org/route/v1/driving/${startLng},${startLat};${endLng},${endLat}?overview=full&geometries=geojson`)
        .then(response => response.json())
        .then(data => {
            if (data.routes && data.routes.length > 0) {
                const route = data.routes[0];
                const routeCoordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                
                routePolyline = L.polyline(routeCoordinates, {
                    color: '#FF6B35',
                    weight: 4,
                    opacity: 0.7,
                    dashArray: '8, 8'
                }).addTo(passengerMap);
                
                passengerMap.fitBounds(routePolyline.getBounds(), { padding: [12, 12] });
            }
        })
        .catch(error => {
            console.error('Error fetching route:', error);
            routePolyline = L.polyline([
                [startLat, startLng],
                [endLat, endLng]
            ], {
                color: '#FF6B35',
                weight: 4,
                opacity: 0.7,
                dashArray: '8, 8'
            }).addTo(passengerMap);
        });
}

// ENHANCED SCHEDULE RIDE FUNCTIONALITY
function openScheduleRidePopup() {
    if (!document.getElementById('scheduleRidePopup')) {
        createScheduleRidePopup();
    }
    
    // Reset edit mode
    const confirmBtn = document.getElementById('confirmScheduleRideBtn');
    confirmBtn.innerHTML = '<i class="fas fa-calendar-check"></i> Schedule Ride';
    confirmBtn.removeAttribute('data-edit-ride-id');
    
    // Set current date and time
    const now = new Date();
    const tomorrow = new Date(now);
    tomorrow.setDate(tomorrow.getDate() + 1);
    
    document.getElementById('scheduleDate').value = tomorrow.toISOString().split('T')[0];
    document.getElementById('scheduleDate').min = tomorrow.toISOString().split('T')[0];
    
    const timeString = `${(now.getHours() + 1).toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
    document.getElementById('scheduleTime').value = timeString;
    
    // Set pickup location from current pickup
    document.getElementById('schedulePickupLocation').value = document.getElementById('pickupLocation').value;
    
    // Reset all forms
    document.querySelectorAll('.schedule-form').forEach(form => {
        form.style.display = 'none';
    });
    document.getElementById('scheduleStandardForm').style.display = 'block';
    
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector('.tab-btn[data-tab="standard"]').classList.add('active');
    
    // Reset vehicle selection
    document.querySelectorAll('#scheduleStandardForm .vehicle-option').forEach(option => {
        option.classList.remove('selected');
        if (option.getAttribute('data-type') === 'car') {
            option.classList.add('selected');
        }
    });
    
    // Reset package form
    document.getElementById('schedulePackageForm').style.display = 'none';
    document.getElementById('schedulePackageToggle').style.display = 'none';
    
    // Reset other form fields
    document.getElementById('scheduleDestination').value = '';
    document.getElementById('scheduleShopName').value = '';
    document.getElementById('scheduleShopLocation').value = '';
    document.getElementById('scheduleDeliveryItems').value = '';
    document.getElementById('scheduleDeliveryDestination').value = '';
    document.getElementById('scheduleRecipientPickup').value = '';
    document.getElementById('scheduleRecipientDestination').value = '';
    document.getElementById('scheduleRecipientName').value = '';
    document.getElementById('scheduleRecipientPhone').value = '';
    document.getElementById('scheduleReceiverName').value = '';
    document.getElementById('scheduleReceiverPhone').value = '';
    document.getElementById('schedulePackageDescription').value = '';
    document.getElementById('scheduleSpecialInstructions').value = '';
    
    // Set payment method
    document.getElementById('schedulePaymentMethod').value = 'wallet';
    
    // Reset fare display
    document.getElementById('scheduleEstimatedFare').textContent = 'K0.00';
    document.getElementById('scheduleEtaDisplay').textContent = 'ETA: -- min';
    
    document.getElementById('scheduleRidePopup').classList.remove('hidden');
}

function createScheduleRidePopup() {
    const schedulePopup = document.createElement('div');
    schedulePopup.id = 'scheduleRidePopup';
    schedulePopup.className = 'popup-overlay hidden';
    schedulePopup.innerHTML = `
        <div class="popup-form" style="max-width: 500px;">
            <div class="popup-header">
                <h2 class="popup-title">
                    <i class="fas fa-clock"></i>
                    Schedule a Ride
                </h2>
                <button class="close-popup" id="closeSchedulePopup">&times;</button>
            </div>
            <div class="popup-content schedule-popup-content">
                <div class="popup-tabs" style="display: flex; gap: 5px; margin-bottom: 15px;">
                    <button class="tab-btn active" data-tab="standard">Standard Ride</button>
                    <button class="tab-btn" data-tab="delivery">Delivery</button>
                    <button class="tab-btn" data-tab="someone-else">For Someone Else</button>
                </div>
                
                <div id="scheduleStandardForm" class="schedule-form active">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="schedulePickupLocation" placeholder="Pickup location" value="">
                        <div class="suggestion-list" id="schedulePickupSuggestions"></div>
                    </div>
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="scheduleDestination" placeholder="Destination">
                        <div class="suggestion-list" id="scheduleDestinationSuggestions"></div>
                    </div>
                    
                    <div class="vehicle-selection">
                        <div class="vehicle-option selected" data-type="car">
                            <i class="fas fa-car vehicle-icon"></i>
                            <span class="vehicle-name">Car</span>
                        </div>
                        <div class="vehicle-option" data-type="bike">
                            <i class="fas fa-motorcycle vehicle-icon"></i>
                            <span class="vehicle-name">Bike</span>
                        </div>
                        <div class="vehicle-option" data-type="bicycle">
                            <i class="fas fa-bicycle vehicle-icon"></i>
                            <span class="vehicle-name">Bicycle</span>
                        </div>
                    </div>
                    
                    <div class="package-toggle" id="schedulePackageToggle" style="display: none; margin-top: 10px;">
                        <i class="fas fa-box"></i>
                        Add Package Details
                    </div>
                    
                    <div class="package-form" id="schedulePackageForm" style="display: none; margin-top: 10px;">
                        <h4 class="section-title" style="font-size: 0.9rem;">Package Details</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="scheduleReceiverName">Receiver Name</label>
                                <input type="text" id="scheduleReceiverName" placeholder="Full name">
                            </div>
                            <div class="form-group">
                                <label for="scheduleReceiverPhone">Receiver Phone</label>
                                <input type="tel" id="scheduleReceiverPhone" placeholder="Phone number">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="schedulePackageDescription">Package Description</label>
                            <input type="text" id="schedulePackageDescription" placeholder="What is being delivered?">
                        </div>
                        <div class="form-group">
                            <label for="scheduleSpecialInstructions">Special Instructions</label>
                            <textarea id="scheduleSpecialInstructions" placeholder="Any special handling instructions?"></textarea>
                        </div>
                    </div>
                </div>
                
                <div id="scheduleDeliveryForm" class="schedule-form" style="display: none;">
                    <div class="input-group">
                        <label for="scheduleShopName">Shop or Restaurant Name</label>
                        <input type="text" id="scheduleShopName" class="input-field" placeholder="Name of shop or restaurant">
                    </div>
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="scheduleShopLocation" placeholder="Shop location">
                        <div class="suggestion-list" id="scheduleShopSuggestions"></div>
                    </div>
                    <div class="input-group">
                        <label for="scheduleDeliveryItems">Items to Purchase</label>
                        <textarea id="scheduleDeliveryItems" class="input-field" placeholder="List of items to be purchased"></textarea>
                    </div>
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="scheduleDeliveryDestination" placeholder="Delivery destination">
                        <div class="suggestion-list" id="scheduleDeliveryDestSuggestions"></div>
                    </div>
                </div>
                
                <div id="scheduleSomeoneElseForm" class="schedule-form" style="display: none;">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="scheduleRecipientPickup" placeholder="Recipient pickup location">
                        <div class="suggestion-list" id="scheduleRecipientPickupSuggestions"></div>
                    </div>
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="scheduleRecipientDestination" placeholder="Recipient destination">
                        <div class="suggestion-list" id="scheduleRecipientDestSuggestions"></div>
                    </div>
                    <div class="input-group">
                        <label for="scheduleRecipientName">Recipient Name</label>
                        <input type="text" id="scheduleRecipientName" class="input-field" placeholder="Full name">
                    </div>
                    <div class="input-group">
                        <label for="scheduleRecipientPhone">Recipient Phone</label>
                        <input type="tel" id="scheduleRecipientPhone" class="input-field" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="scheduling-options">
                    <div class="input-group">
                        <label for="scheduleDate">Date</label>
                        <input type="date" id="scheduleDate" class="input-field" value="" min="">
                    </div>
                    <div class="input-group">
                        <label for="scheduleTime">Time</label>
                        <input type="time" id="scheduleTime" class="input-field" value="">
                    </div>
                    <div class="input-group">
                        <label for="schedulePaymentMethod">Payment Method</label>
                        <select id="schedulePaymentMethod" class="input-field">
                            <option value="wallet">Jubel Wallet</option>
                            <option value="cash">Cash</option>
                            <option value="mobile">Mobile Money</option>
                        </select>
                    </div>
                </div>
                
                <div class="fare-display" style="margin: 20px 0;">
                    <p>Estimated Fare</p>
                    <div class="fare-amount" id="scheduleEstimatedFare">K0.00</div>
                    <p class="eta-display" id="scheduleEtaDisplay">ETA: -- min</p>
                </div>
                
                <button id="confirmScheduleRideBtn" class="request-ride-btn">
                    <i class="fas fa-calendar-check"></i> Schedule Ride
                </button>
                <button id="cancelScheduleBtn" class="btn btn-cancel" style="margin-top: 10px;">
                    Cancel
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(schedulePopup);
    
    // Add event listeners
    document.getElementById('closeSchedulePopup').addEventListener('click', closeSchedulePopup);
    document.getElementById('cancelScheduleBtn').addEventListener('click', closeSchedulePopup);
    document.getElementById('confirmScheduleRideBtn').addEventListener('click', confirmScheduleRide);
    
    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(tab => {
        tab.addEventListener('click', function() {
            document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.schedule-form').forEach(f => f.style.display = 'none');
            
            this.classList.add('active');
            const tabName = this.getAttribute('data-tab');
            document.getElementById(`schedule${tabName.charAt(0).toUpperCase() + tabName.slice(1)}Form`).style.display = 'block';
            calculateScheduleFare();
        });
    });
    
    // Vehicle selection
    document.querySelectorAll('#scheduleStandardForm .vehicle-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('#scheduleStandardForm .vehicle-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            this.classList.add('selected');
            
            const type = this.getAttribute('data-type');
            document.getElementById('schedulePackageToggle').style.display = 
                (type === 'bike' || type === 'bicycle') ? 'flex' : 'none';
                
            calculateScheduleFare();
        });
    });
    
    // Package toggle
    document.getElementById('schedulePackageToggle').addEventListener('click', function() {
        const packageForm = document.getElementById('schedulePackageForm');
        packageForm.style.display = packageForm.style.display === 'none' ? 'block' : 'none';
    });
    
    // Search input listeners
    const searchFields = [
        { id: 'schedulePickupLocation', type: 'schedulePickup' },
        { id: 'scheduleDestination', type: 'scheduleDestination' },
        { id: 'scheduleShopLocation', type: 'scheduleShop' },
        { id: 'scheduleDeliveryDestination', type: 'scheduleDeliveryDest' },
        { id: 'scheduleRecipientPickup', type: 'scheduleRecipientPickup' },
        { id: 'scheduleRecipientDestination', type: 'scheduleRecipientDest' }
    ];
    
    searchFields.forEach(field => {
        const input = document.getElementById(field.id);
        if (input) {
            input.addEventListener('input', function() {
                if (this.value.length >= 2) {
                    searchPlacesEnhanced(this.value, field.type);
                }
                calculateScheduleFare();
            });
            
            input.addEventListener('focus', function() {
                if (this.value.length >= 2) {
                    searchPlacesEnhanced(this.value, field.type);
                }
            });
        }
    });
    
    // Date and time change listeners
    document.getElementById('scheduleDate').addEventListener('change', calculateScheduleFare);
    document.getElementById('scheduleTime').addEventListener('change', calculateScheduleFare);
    document.getElementById('schedulePaymentMethod').addEventListener('change', calculateScheduleFare);
    
    // Additional form field listeners for fare calculation
    document.getElementById('scheduleShopName').addEventListener('input', calculateScheduleFare);
    document.getElementById('scheduleDeliveryItems').addEventListener('input', calculateScheduleFare);
    document.getElementById('scheduleRecipientName').addEventListener('input', calculateScheduleFare);
    document.getElementById('scheduleRecipientPhone').addEventListener('input', calculateScheduleFare);
    document.getElementById('scheduleReceiverName').addEventListener('input', calculateScheduleFare);
    document.getElementById('scheduleReceiverPhone').addEventListener('input', calculateScheduleFare);
    document.getElementById('schedulePackageDescription').addEventListener('input', calculateScheduleFare);
    document.getElementById('scheduleSpecialInstructions').addEventListener('input', calculateScheduleFare);
}

function calculateScheduleFare() {
    const activeTab = document.querySelector('.tab-btn.active').getAttribute('data-tab');
    let pickupLocation = '', destination = '';
    
    switch(activeTab) {
        case 'standard':
            pickupLocation = document.getElementById('schedulePickupLocation').value;
            destination = document.getElementById('scheduleDestination').value;
            break;
        case 'delivery':
            pickupLocation = document.getElementById('scheduleShopLocation').value;
            destination = document.getElementById('scheduleDeliveryDestination').value;
            break;
        case 'someone-else':
            pickupLocation = document.getElementById('scheduleRecipientPickup').value;
            destination = document.getElementById('scheduleRecipientDestination').value;
            break;
    }
    
    if (pickupLocation && destination) {
        Promise.all([
            forwardGeocode(pickupLocation),
            forwardGeocode(destination)
        ]).then(([pickupResults, destResults]) => {
            if (pickupResults.length > 0 && destResults.length > 0) {
                const pickupLat = parseFloat(pickupResults[0].lat);
                const pickupLng = parseFloat(pickupResults[0].lon);
                const destLat = parseFloat(destResults[0].lat);
                const destLng = parseFloat(destResults[0].lon);
                
                const distance = calculateDistance(pickupLat, pickupLng, destLat, destLng);
                
                let baseFare = 23;
                if (distance > 0) {
                    baseFare += Math.ceil(distance / 90);
                }
                
                if (activeTab === 'standard') {
                    const vehicleType = document.querySelector('#scheduleStandardForm .vehicle-option.selected').getAttribute('data-type');
                    switch(vehicleType) {
                        case 'bike': baseFare *= 0.7; break;
                        case 'bicycle': baseFare *= 0.5; break;
                    }
                } else if (activeTab === 'delivery') {
                    // Delivery typically uses bikes
                    baseFare *= 0.7;
                }
                
                // Apply premium for scheduled rides (10% extra for convenience)
                baseFare *= 1.1;
                
                document.getElementById('scheduleEstimatedFare').textContent = `K${baseFare.toFixed(2)}`;
                
                const etaMinutes = Math.ceil((distance / 1000) / 30 * 60);
                document.getElementById('scheduleEtaDisplay').textContent = `ETA: ${etaMinutes} min`;
                
                return { baseFare, distance, pickupResults, destResults };
            }
        }).then(result => {
            if (result) {
                // Update map if needed
                updateScheduleMapPreview(result.pickupResults[0], result.destResults[0]);
            }
        });
    } else {
        document.getElementById('scheduleEstimatedFare').textContent = 'K0.00';
        document.getElementById('scheduleEtaDisplay').textContent = 'ETA: -- min';
    }
}

function updateScheduleMapPreview(pickupResult, destResult) {
    // This function could update a small map preview in the schedule popup
    // For now, we'll just log the coordinates
    console.log('Schedule preview:', {
        pickup: { lat: pickupResult.lat, lng: pickupResult.lon, name: pickupResult.display_name },
        destination: { lat: destResult.lat, lng: destResult.lon, name: destResult.display_name }
    });
}

function confirmScheduleRide() {
    const activeTab = document.querySelector('.tab-btn.active').getAttribute('data-tab');
    const date = document.getElementById('scheduleDate').value;
    const time = document.getElementById('scheduleTime').value;
    const paymentMethod = document.getElementById('schedulePaymentMethod').value;
    const confirmBtn = document.getElementById('confirmScheduleRideBtn');
    const isEditMode = confirmBtn.hasAttribute('data-edit-ride-id');
    const editRideId = isEditMode ? confirmBtn.getAttribute('data-edit-ride-id') : null;
    
    if (!date || !time) {
        showNotification('Please select date and time for scheduling.');
        return;
    }
    
    const scheduledDateTime = new Date(`${date}T${time}`);
    if (scheduledDateTime <= new Date()) {
        showNotification('Please select a future date and time.');
        return;
    }
    
    // Validate minimum time (at least 30 minutes from now)
    const minTime = new Date(Date.now() + 30 * 60 * 1000);
    if (scheduledDateTime < minTime) {
        showNotification('Please schedule at least 30 minutes in advance.');
        return;
    }
    
    let rideData = {
        passengerId: currentUser.uid,
        passengerName: userData.name || 'Passenger',
        passengerPhone: userData.phone || 'Not provided',
        scheduledTime: scheduledDateTime.getTime(),
        paymentMethod: paymentMethod,
        status: 'scheduled',
        createdAt: firebase.database.ServerValue.TIMESTAMP,
        currentCity: currentCity,
        updatedAt: firebase.database.ServerValue.TIMESTAMP
    };
    
    Promise.resolve().then(() => {
        switch(activeTab) {
            case 'standard':
                return getStandardScheduleData(rideData);
            case 'delivery':
                return getDeliveryScheduleData(rideData);
            case 'someone-else':
                return getSomeoneElseScheduleData(rideData);
        }
    }).then(completeRideData => {
        if (isEditMode && editRideId) {
            // Update existing scheduled ride
            completeRideData.id = editRideId;
            
            database.ref('scheduledRides/' + editRideId).update(completeRideData)
                .then(() => {
                    showNotification('Scheduled ride updated successfully!');
                    closeSchedulePopup();
                    
                    // Update local array
                    const index = scheduledRides.findIndex(r => r.id === editRideId);
                    if (index !== -1) {
                        scheduledRides[index] = completeRideData;
                    }
                    
                    // Reschedule timer
                    if (scheduledRideTimers[editRideId]) {
                        clearTimeout(scheduledRideTimers[editRideId]);
                        delete scheduledRideTimers[editRideId];
                    }
                    scheduleRideTimer(completeRideData);
                    
                    updateScheduledRidesUI();
                })
                .catch(error => {
                    console.error('Error updating scheduled ride:', error);
                    showNotification('Error updating scheduled ride. Please try again.');
                });
        } else {
            // Create new scheduled ride
            const scheduleId = database.ref().child('scheduledRides').push().key;
            completeRideData.id = scheduleId;
            
            database.ref('scheduledRides/' + scheduleId).set(completeRideData)
                .then(() => {
                    showNotification('Ride scheduled successfully!');
                    closeSchedulePopup();
                    
                    scheduledRides.push(completeRideData);
                    
                    scheduleRideTimer(completeRideData);
                    
                    updateScheduledRidesUI();
                })
                .catch(error => {
                    console.error('Error scheduling ride:', error);
                    showNotification('Error scheduling ride. Please try again.');
                });
        }
    }).catch(error => {
        console.error('Error in schedule process:', error);
        showNotification('Error processing schedule. Please check locations and try again.');
    });
}

async function getStandardScheduleData(baseData) {
    const pickupLocation = document.getElementById('schedulePickupLocation').value;
    const destination = document.getElementById('scheduleDestination').value;
    const vehicleType = document.querySelector('#scheduleStandardForm .vehicle-option.selected').getAttribute('data-type');
    
    if (!pickupLocation || !destination) {
        throw new Error('Pickup and destination locations are required');
    }
    
    const [pickupResults, destResults] = await Promise.all([
        forwardGeocode(pickupLocation),
        forwardGeocode(destination)
    ]);
    
    if (pickupResults.length === 0 || destResults.length === 0) {
        throw new Error('Invalid locations. Please select valid pickup and destination addresses.');
    }
    
    const pickupLat = parseFloat(pickupResults[0].lat);
    const pickupLng = parseFloat(pickupResults[0].lon);
    const destLat = parseFloat(destResults[0].lat);
    const destLng = parseFloat(destResults[0].lon);
    
    const distance = calculateDistance(pickupLat, pickupLng, destLat, destLng);
    let fare = 23 + Math.ceil(distance / 90);
    
    switch(vehicleType) {
        case 'bike': fare *= 0.7; break;
        case 'bicycle': fare *= 0.5; break;
    }
    
    // Apply scheduled ride premium
    fare *= 1.1;
    
    const rideData = {
        ...baseData,
        pickupLocation: pickupResults[0].display_name,
        pickupDisplayLocation: pickupLocation,
        destination: destResults[0].display_name,
        pickupLat: pickupLat,
        pickupLng: pickupLng,
        destLat: destLat,
        destLng: destLng,
        rideType: vehicleType,
        fare: fare,
        distance: (distance / 1000).toFixed(2) + ' km',
        scheduleType: 'standard'
    };
    
    const packageForm = document.getElementById('schedulePackageForm');
    if (packageForm.style.display !== 'none' && (vehicleType === 'bike' || vehicleType === 'bicycle')) {
        rideData.packageDetails = {
            receiverName: document.getElementById('scheduleReceiverName').value,
            receiverPhone: document.getElementById('scheduleReceiverPhone').value,
            packageDescription: document.getElementById('schedulePackageDescription').value,
            specialInstructions: document.getElementById('scheduleSpecialInstructions').value
        };
    }
    
    return rideData;
}

async function getDeliveryScheduleData(baseData) {
    const shopName = document.getElementById('scheduleShopName').value;
    const shopLocation = document.getElementById('scheduleShopLocation').value;
    const deliveryItems = document.getElementById('scheduleDeliveryItems').value;
    const destination = document.getElementById('scheduleDeliveryDestination').value;
    
    if (!shopLocation || !destination) {
        throw new Error('Shop location and delivery destination are required');
    }
    
    const [shopResults, destResults] = await Promise.all([
        forwardGeocode(shopLocation),
        forwardGeocode(destination)
    ]);
    
    if (shopResults.length === 0 || destResults.length === 0) {
        throw new Error('Invalid locations. Please select valid shop and destination addresses.');
    }
    
    const shopLat = parseFloat(shopResults[0].lat);
    const shopLng = parseFloat(shopResults[0].lon);
    const destLat = parseFloat(destResults[0].lat);
    const destLng = parseFloat(destResults[0].lon);
    
    const distance = calculateDistance(shopLat, shopLng, destLat, destLng);
    let fare = 23 + Math.ceil(distance / 90);
    
    // Delivery typically uses bikes and has premium
    fare = fare * 0.7 * 1.1;
    
    return {
        ...baseData,
        pickupLocation: shopResults[0].display_name,
        pickupDisplayLocation: shopLocation,
        destination: destResults[0].display_name,
        pickupLat: shopLat,
        pickupLng: shopLng,
        destLat: destLat,
        destLng: destLng,
        rideType: 'bike',
        fare: fare,
        distance: (distance / 1000).toFixed(2) + ' km',
        scheduleType: 'delivery',
        expressDelivery: {
            shopName: shopName,
            items: deliveryItems
        }
    };
}

async function getSomeoneElseScheduleData(baseData) {
    const recipientPickup = document.getElementById('scheduleRecipientPickup').value;
    const recipientDestination = document.getElementById('scheduleRecipientDestination').value;
    const recipientName = document.getElementById('scheduleRecipientName').value;
    const recipientPhone = document.getElementById('scheduleRecipientPhone').value;
    
    if (!recipientPickup || !recipientDestination || !recipientName) {
        throw new Error('Recipient pickup, destination, and name are required');
    }
    
    const [pickupResults, destResults] = await Promise.all([
        forwardGeocode(recipientPickup),
        forwardGeocode(recipientDestination)
    ]);
    
    if (pickupResults.length === 0 || destResults.length === 0) {
        throw new Error('Invalid locations. Please select valid pickup and destination addresses.');
    }
    
    const pickupLat = parseFloat(pickupResults[0].lat);
    const pickupLng = parseFloat(pickupResults[0].lon);
    const destLat = parseFloat(destResults[0].lat);
    const destLng = parseFloat(destResults[0].lon);
    
    const distance = calculateDistance(pickupLat, pickupLng, destLat, destLng);
    let fare = 23 + Math.ceil(distance / 90);
    
    // Apply scheduled ride premium
    fare *= 1.1;
    
    return {
        ...baseData,
        pickupLocation: pickupResults[0].display_name,
        pickupDisplayLocation: recipientPickup,
        destination: destResults[0].display_name,
        pickupLat: pickupLat,
        pickupLng: pickupLng,
        destLat: destLat,
        destLng: destLng,
        rideType: 'car',
        fare: fare,
        distance: (distance / 1000).toFixed(2) + ' km',
        scheduleType: 'someone-else',
        orderForSomeone: {
            recipientName: recipientName,
            recipientPhone: recipientPhone,
            orderedBy: userData.name || 'Passenger'
        }
    };
}

function closeSchedulePopup() {
    document.getElementById('scheduleRidePopup').classList.add('hidden');
}

// Request Ride Functionality
function requestRide() {
    const pickupLocation = document.getElementById('pickupLocation').value;
    const destinationLocation = document.getElementById('destinationLocation').value;
    
    if (!destinationLocation) {
        showNotification('Please enter a destination');
        return;
    }
    
    if (!currentLocationMarker && !pickupMarker) {
        showNotification('Unable to determine your location. Please try again.');
        return;
    }
    
    const pickupLatLng = pickupMarker ? pickupMarker.getLatLng() : currentLocationMarker.getLatLng();
    
    if (document.getElementById('packageForm').classList.contains('active')) {
        packageDetails = {
            receiverName: document.getElementById('receiverName').value,
            receiverPhone: document.getElementById('receiverPhone').value,
            packageDescription: document.getElementById('packageDescription').value,
            specialInstructions: document.getElementById('specialInstructions').value,
            packageValue: document.getElementById('packageValue').value
        };
    } else {
        packageDetails = null;
    }
    
    Promise.all([
        getFullAddress(pickupLatLng.lat, pickupLatLng.lng),
        forwardGeocode(destinationLocation)
    ]).then(([fullPickupAddress, destinationResults]) => {
        if (destinationResults.length === 0) {
            showNotification('Invalid destination address. Please select a valid destination.');
            return;
        }
        
        const destLat = parseFloat(destinationResults[0].lat);
        const destLng = parseFloat(destinationResults[0].lon);
        
        const distance = calculateDistance(
            pickupLatLng.lat, pickupLatLng.lng,
            destLat, destLng
        );
        
        let baseFare = 23;
        
        if (distance > 0) {
            baseFare += Math.ceil(distance / 90);
        }
        
        switch(selectedVehicleType) {
            case 'car':
                baseFare = baseFare;
                break;
            case 'bike':
                baseFare = baseFare * 0.7;
                break;
            case 'bicycle':
                baseFare = baseFare * 0.5;
                break;
        }
        
        if (appliedPromoCode) {
            baseFare = baseFare * 0.8;
        }
        
        const rideId = database.ref().child('rides').push().key;
        
        const rideRequest = {
            id: rideId,
            passengerId: currentUser.uid,
            passengerName: userData.name || 'Passenger',
            passengerPhone: userData.phone || 'Not provided',
            pickupLocation: fullPickupAddress,
            pickupDisplayLocation: pickupLocation,
            destination: destinationLocation,
            pickupLat: pickupLatLng.lat,
            pickupLng: pickupLatLng.lng,
            destLat: destLat,
            destLng: destLng,
            rideType: selectedVehicleType,
            fare: baseFare,
            distance: (distance / 1000).toFixed(2) + ' km',
            status: 'requested',
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            updatedAt: firebase.database.ServerValue.TIMESTAMP,
            promoCode: appliedPromoCode,
            paymentMethod: selectedPaymentType,
            packageDetails: packageDetails,
            currentCity: currentCity
        };
    
        currentRideRequestData = rideRequest;
        currentRideRequestType = 'standard';
        
        showPaymentSelection(baseFare);
    }).catch(error => {
        console.error('Error in ride request process:', error);
        showNotification('Error calculating route. Please try again.');
    });
}

function getFullAddress(lat, lng) {
    return new Promise((resolve, reject) => {
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=16&addressdetails=1&accept-language=en`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Full address geocoding error: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data && data.display_name) {
                    resolve(data.display_name);
                } else {
                    resolve(`${lat.toFixed(6)}, ${lng.toFixed(6)}`);
                }
            })
            .catch(error => {
                console.error('Full address geocoding error:', error);
                resolve(`${lat.toFixed(6)}, ${lng.toFixed(6)}`);
            });
    });
}

function showPaymentSelection(fare = null) {
    const calculatedFare = fare || rideFare;
    
    document.getElementById('paymentWalletBalance').textContent = `Balance: K${walletBalance.toFixed(2)}`;
    
    if (selectedPaymentType === 'wallet' && walletBalance < calculatedFare) {
        document.getElementById('insufficientBalance').style.display = 'block';
        document.getElementById('confirmPaymentBtn').disabled = true;
    } else {
        document.getElementById('insufficientBalance').style.display = 'none';
        document.getElementById('confirmPaymentBtn').disabled = false;
    }
    
    document.getElementById('paymentSelectionPopup').classList.remove('hidden');
}

function closePaymentSelection() {
    document.getElementById('paymentSelectionPopup').classList.add('hidden');
}

function submitRideRequest() {
    if (!currentRideRequestData) {
        showNotification('No ride request data found. Please try again.');
        return;
    }
    
    const rideRequest = currentRideRequestData;
    
    if (selectedPaymentType === 'wallet') {
        const newBalance = walletBalance - rideRequest.fare;
        
        database.ref('users/' + currentUser.uid).update({
            walletBalance: newBalance
        })
        .then(() => {
            walletBalance = newBalance;
            updateWalletBalanceUI();
            
            return database.ref('rides/' + rideRequest.id).set(rideRequest);
        })
        .then(() => {
            currentRide = rideRequest;
            
            closePaymentSelection();
            
            updateUIForActiveRide();
            
            document.getElementById('searchingAnimation').style.display = 'flex';
            
            document.getElementById('rideStatus').style.display = 'flex';
            document.getElementById('statusDot').className = 'status-dot searching';
            document.getElementById('statusText').textContent = 'Searching for driver';
            
            if (sosConfig && sosConfig.contact1) {
                document.getElementById('sosButton').style.display = 'flex';
            }
            
            showNotification('Ride requested. Searching for a driver...');
            
            listenForDriverAssignment(rideRequest.id);
            
            if (rideRequest.orderForSomeone || rideRequest.expressDelivery) {
                setupLiveTracking(rideRequest.id);
            }
        })
        .catch(error => {
            console.error('Error requesting ride:', error);
            showNotification('Error requesting ride. Please try again.');
        });
    } else {
        database.ref('rides/' + rideRequest.id).set(rideRequest)
            .then(() => {
                currentRide = rideRequest;
                
                closePaymentSelection();
                
                updateUIForActiveRide();
                
                document.getElementById('searchingAnimation').style.display = 'flex';
                
                document.getElementById('rideStatus').style.display = 'flex';
                document.getElementById('statusDot').className = 'status-dot searching';
                document.getElementById('statusText').textContent = 'Searching for driver';
                
                if (sosConfig && sosConfig.contact1) {
                    document.getElementById('sosButton').style.display = 'flex';
                }
                
                showNotification('Ride requested. Searching for a driver...');
                
                listenForDriverAssignment(rideRequest.id);
                
                if (rideRequest.orderForSomeone || rideRequest.expressDelivery) {
                    setupLiveTracking(rideRequest.id);
                }
            })
            .catch(error => {
                console.error('Error requesting ride:', error);
                showNotification('Error requesting ride. Please try again.');
            });
    }
    
    currentRideRequestData = null;
}

function updateUIForActiveRide() {
    document.getElementById('rideRequestForm').style.display = 'none';
    
    document.getElementById('rideInfoPanel').style.display = 'block';
    
    document.getElementById('currentPickupLocation').textContent = currentRide.pickupDisplayLocation || currentRide.pickupLocation;
    document.getElementById('currentDestinationLocation').textContent = currentRide.destination;
    
    const baseFare = currentRide.fare;
    const discount = appliedPromoCode ? baseFare * 0.2 : 0;
    const totalFare = baseFare - discount;
    
    document.getElementById('baseFare').textContent = `K${baseFare.toFixed(2)}`;
    document.getElementById('discountFare').textContent = `-K${discount.toFixed(2)}`;
    document.getElementById('totalFare').textContent = `K${totalFare.toFixed(2)}`;
    
    addShareAndTrackingButtons();
}

function addShareAndTrackingButtons() {
    const rideActions = document.querySelector('.ride-actions');
    
    const existingShareBtn = document.getElementById('shareRideBtn');
    const existingTrackingBtn = document.getElementById('shareTrackingBtn');
    if (existingShareBtn) existingShareBtn.remove();
    if (existingTrackingBtn) existingTrackingBtn.remove();
    
    const shareBtn = document.createElement('button');
    shareBtn.id = 'shareRideBtn';
    shareBtn.className = 'btn btn-contact';
    shareBtn.innerHTML = '<i class="fas fa-share-alt"></i> Share Ride';
    shareBtn.addEventListener('click', shareRideDetails);
    rideActions.insertBefore(shareBtn, rideActions.firstChild);
    
    if (currentRide.orderForSomeone || currentRide.expressDelivery || currentRide.packageDetails) {
        const trackingBtn = document.createElement('button');
        trackingBtn.id = 'shareTrackingBtn';
        trackingBtn.className = 'btn btn-primary';
        trackingBtn.innerHTML = '<i class="fas fa-map-marker-alt"></i> Share Tracking';
        trackingBtn.addEventListener('click', shareLiveTracking);
        rideActions.insertBefore(trackingBtn, rideActions.firstChild);
    }
}

function shareRideDetails() {
    if (!currentRide) {
        showNotification('No active ride to share.');
        return;
    }
    
    const rideDetails = {
        pickup: currentRide.pickupDisplayLocation || currentRide.pickupLocation,
        destination: currentRide.destination,
        fare: `K${currentRide.fare.toFixed(2)}`,
        distance: currentRide.distance,
        rideType: currentRide.rideType,
        status: currentRide.status
    };
    
    const shareText = `My Jubel Ride Details:
 From: ${rideDetails.pickup}
 To: ${rideDetails.destination}
 Fare: ${rideDetails.fare}
 Distance: ${rideDetails.distance}
 Type: ${rideDetails.rideType}
 Status: ${getStatusText(rideDetails.status)}`;
    
    if (navigator.share) {
        navigator.share({
            title: 'My Jubel Ride',
            text: shareText,
            url: window.location.href
        })
        .then(() => showNotification('Ride details shared!'))
        .catch(error => console.error('Error sharing:', error));
    } else {
        navigator.clipboard.writeText(shareText)
            .then(() => showNotification('Ride details copied to clipboard!'))
            .catch(() => {
                const textArea = document.createElement('textarea');
                textArea.value = shareText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showNotification('Ride details copied to clipboard!');
            });
    }
}

function setupLiveTracking(rideId) {
    const trackingId = generateTrackingId();
    
    const trackingData = {
        rideId: rideId,
        passengerId: currentUser.uid,
        createdAt: firebase.database.ServerValue.TIMESTAMP,
        isActive: true,
        sharedWith: []
    };
    
    database.ref('liveTracking/' + trackingId).set(trackingData)
        .then(() => {
            sharedRideLinks[rideId] = {
                trackingId: trackingId,
                shareUrl: `${window.location.origin}/tracking.html?id=${trackingId}`
            };
            
            showNotification('Live tracking is now active for this ride.');
        })
        .catch(error => {
            console.error('Error setting up live tracking:', error);
        });
}

function shareLiveTracking() {
    if (!currentRide) {
        showNotification('No active ride to track.');
        return;
    }
    
    const trackingInfo = sharedRideLinks[currentRide.id];
    if (!trackingInfo) {
        showNotification('Live tracking not available for this ride.');
        return;
    }
    
    const shareText = `Track my Jubel ride in real-time: ${trackingInfo.shareUrl}`;
    
    if (navigator.share) {
        navigator.share({
            title: 'Track My Jubel Ride',
            text: 'You can track my ride in real-time using this link:',
            url: trackingInfo.shareUrl
        })
        .then(() => showNotification('Tracking link shared!'))
        .catch(error => console.error('Error sharing:', error));
    } else {
        navigator.clipboard.writeText(shareText)
            .then(() => showNotification('Tracking link copied to clipboard!'))
            .catch(() => {
                const textArea = document.createElement('textarea');
                textArea.value = shareText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showNotification('Tracking link copied to clipboard!');
            });
    }
}

function startLiveTracking(rideId, driverId) {
    if (!sharedRideLinks[rideId]) {
        return;
    }
    
    const trackingId = sharedRideLinks[rideId].trackingId;
    
    liveTrackingListeners[rideId] = database.ref('driverLocations/' + driverId).on('value', snapshot => {
        const location = snapshot.val();
        if (location) {
            database.ref('liveTracking/' + trackingId + '/driverLocation').set({
                lat: location.latitude,
                lng: location.longitude,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
        }
    });
    
    database.ref('rides/' + rideId).on('value', snapshot => {
        const ride = snapshot.val();
        if (ride) {
            database.ref('liveTracking/' + trackingId + '/rideStatus').set({
                status: ride.status,
                updatedAt: firebase.database.ServerValue.TIMESTAMP
            });
        }
    });
}

function generateTrackingId() {
    return 'track_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now().toString(36);
}

function listenForDriverAssignment(rideId) {
    if (driverAssignmentListener) {
        driverAssignmentListener();
    }
    
    driverAssignmentListener = database.ref('rides/' + rideId).on('value', snapshot => {
        const ride = snapshot.val();
        if (!ride) {
            showNotification('Ride not found. Please try again.');
            return;
        }
        
        console.log('Ride status update:', ride.status, ride.driverId);
        
        if (ride.driverId && ride.status === 'accepted') {
            handleDriverAssignment(ride);
        } else if (ride.status === 'completed') {
            showRideCompletion(ride);
        } else if (ride.status === 'cancelled') {
            handleRideCancellation(ride);
        } else if (ride.status === 'arrived') {
            showNotification('Your driver has arrived at the pickup location.');
        } else if (ride.status === 'picked_up') {
            showNotification('You have been picked up. Enjoy your ride!');
        } else if (ride.status === 'started') {
            showNotification('Your trip has started.');
        }
    }, error => {
        console.error('Error listening for driver assignment:', error);
        showNotification('Connection error. Please check your internet connection.');
    });
}

function handleDriverAssignment(ride) {
    document.getElementById('searchingAnimation').style.display = 'none';
    
    document.getElementById('statusDot').className = 'status-dot arriving';
    document.getElementById('statusText').textContent = 'Driver arriving';
    
    document.getElementById('estimatedTime').style.display = 'flex';
    document.getElementById('timeText').textContent = '5 min';
    
    database.ref('users/' + ride.driverId).once('value')
        .then(driverSnapshot => {
            const driver = driverSnapshot.val();
            if (driver) {
                document.getElementById('driverName').textContent = driver.name || 'Driver';
                document.getElementById('driverPhone').textContent = driver.phone || 'N/A';
                document.getElementById('driverRating').textContent = driver.rating || '4.5';
                
                if (driver.vehicle) {
                    document.getElementById('vehicleDetails').textContent = 
                        `${driver.vehicle.type || 'Vehicle'} - ${driver.vehicle.licensePlate || 'ABC123'}`;
                }
                
                updateDriverAvatarWithImage(driver, ride);
                updateDriverVehicleDisplay(driver, ride);
                updateDriverDetailsCard(driver);
                addChatWithDriverButton(ride.id, driver);
                addDriverMarker(ride.driverLat, ride.driverLng);
                drawRoute(ride.driverLat, ride.driverLng, ride.pickupLat, ride.pickupLng);
                trackDriverLocation(ride.driverId);
                
                showNotification(`Driver ${driver.name} is on the way!`);
                
                startDriverMessageListener(ride.id);
                
                if (ride.orderForSomeone || ride.expressDelivery) {
                    startLiveTracking(ride.id, ride.driverId);
                }
            }
        });
    
    listenForRideStatusUpdates(ride.id);
}

function updateDriverAvatarWithImage(driver, ride) {
    const driverAvatar = document.getElementById('driverAvatar');
    
    if (ride.driverProfileImage) {
        driverProfileImage = ride.driverProfileImage;
        driverAvatar.innerHTML = `<img src="${driverProfileImage}" class="driver-profile-image" alt="Driver" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
    } else if (driver.images && driver.images.profilePhoto) {
        driverProfileImage = driver.images.profilePhoto;
        driverAvatar.innerHTML = `<img src="${driverProfileImage}" class="driver-profile-image" alt="Driver" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
    } else if (driver.name) {
        driverAvatar.innerHTML = driver.name.charAt(0).toUpperCase();
    } else {
        driverAvatar.innerHTML = '<i class="fas fa-user"></i>';
    }
}

function updateDriverVehicleDisplay(driver, ride) {
    const vehicleImageSection = document.getElementById('vehicleImageSection');
    
    if (!vehicleImageSection) {
        const driverDetailsCard = document.getElementById('driverDetailsCard');
        const vehicleSection = document.createElement('div');
        vehicleSection.id = 'vehicleImageSection';
        vehicleSection.className = 'vehicle-image-section';
        vehicleSection.style.cssText = `
            margin-top: 10px;
            padding: 10px;
            background: var(--light-gray);
            border-radius: var(--element-radius);
            border: 1px solid var(--border-color);
        `;
        vehicleSection.innerHTML = `
            <h4 class="section-title" style="font-size: 0.8rem; margin-bottom: 8px;">
                <i class="fas fa-car"></i> Driver's Vehicle
            </h4>
            <div id="vehicleImageContainer"></div>
        `;
        driverDetailsCard.appendChild(vehicleSection);
    }
    
    const vehicleImageContainer = document.getElementById('vehicleImageContainer');
    
    if (ride.vehicleImage) {
        driverVehicleImage = ride.vehicleImage;
        vehicleImageContainer.innerHTML = `
            <img id="vehicleFrontImage" class="vehicle-image" src="${driverVehicleImage}" alt="Vehicle" style="width: 100%; height: 150px; object-fit: cover; border-radius: 8px; margin-bottom: 8px;">
            <div class="vehicle-details-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.7rem;">
                <div class="vehicle-detail">
                    <strong>Type:</strong> ${driver.vehicle?.type || 'N/A'}
                </div>
                <div class="vehicle-detail">
                    <strong>Model:</strong> ${driver.vehicle?.model || 'N/A'}
                </div>
                <div class="vehicle-detail">
                    <strong>Color:</strong> ${driver.vehicle?.color || 'N/A'}
                </div>
                <div class="vehicle-detail">
                    <strong>Plate:</strong> ${driver.vehicle?.licensePlate || 'N/A'}
                </div>
            </div>
        `;
    } else if (driver.images && driver.images.vehicleFront) {
        driverVehicleImage = driver.images.vehicleFront;
        vehicleImageContainer.innerHTML = `
            <img id="vehicleFrontImage" class="vehicle-image" src="${driverVehicleImage}" alt="Vehicle" style="width: 100%; height: 150px; object-fit: cover; border-radius: 8px; margin-bottom: 8px;">
            <div class="vehicle-details-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.7rem;">
                <div class="vehicle-detail">
                    <strong>Type:</strong> ${driver.vehicle?.type || 'N/A'}
                </div>
                <div class="vehicle-detail">
                    <strong>Model:</strong> ${driver.vehicle?.model || 'N/A'}
                </div>
                <div class="vehicle-detail">
                    <strong>Color:</strong> ${driver.vehicle?.color || 'N/A'}
                </div>
                <div class="vehicle-detail">
                    <strong>Plate:</strong> ${driver.vehicle?.licensePlate || 'N/A'}
                </div>
            </div>
        `;
    } else {
        vehicleImageContainer.innerHTML = `
            <div class="no-vehicle-image" style="text-align: center; padding: 20px; color: var(--medium-gray); font-size: 0.8rem;">
                <i class="fas fa-car" style="font-size: 2rem; margin-bottom: 8px; display: block;"></i>
                Vehicle image not available
            </div>
            <div class="vehicle-details-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.7rem; margin-top: 8px;">
                <div class="vehicle-detail">
                    <strong>Type:</strong> ${driver.vehicle?.type || 'N/A'}
                </div>
                <div class="vehicle-detail">
                    <strong>Model:</strong> ${driver.vehicle?.model || 'N/A'}
                </div>
                <div class="vehicle-detail">
                    <strong>Color:</strong> ${driver.vehicle?.color || 'N/A'}
                </div>
                <div class="vehicle-detail">
                    <strong>Plate:</strong> ${driver.vehicle?.licensePlate || 'N/A'}
                </div>
            </div>
        `;
    }
}

function addChatWithDriverButton(rideId, driver) {
    const rideActions = document.querySelector('.ride-actions');
    
    if (!document.getElementById('chatWithDriverBtn')) {
        const chatButton = document.createElement('button');
        chatButton.id = 'chatWithDriverBtn';
        chatButton.className = 'btn btn-contact';
        chatButton.innerHTML = '<i class="fas fa-comments"></i> Chat with Driver';
        chatButton.addEventListener('click', function() {
            openChatWithDriver(rideId, driver);
        });
        
        const contactBtn = document.getElementById('contactDriverBtn');
        rideActions.insertBefore(chatButton, contactBtn);
    }
}

function startDriverMessageListener(rideId) {
    if (driverMessageListener) {
        driverMessageListener();
    }
    
    driverMessageListener = database.ref('chats/' + rideId).orderByChild('timestamp').on('child_added', snapshot => {
        const message = snapshot.val();
        
        if (message.senderId !== currentUser.uid) {
            if (chatPopupClosedByUser && !isChatPopupOpen()) {
                openChatWithDriver(rideId, { name: 'Driver' });
                showNotification('New message from driver');
            }
            
            if (isChatPopupOpen() && currentChatRideId === rideId) {
                displayChatMessage(message);
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }
    });
}

function isChatPopupOpen() {
    const chatPopup = document.getElementById('chatPopup');
    return chatPopup && !chatPopup.classList.contains('hidden');
}

function openChatWithDriver(rideId, driver) {
    if (!document.getElementById('chatPopup')) {
        createChatPopup();
    }
    
    currentChatRideId = rideId;
    chatPopupClosedByUser = false;
    
    document.getElementById('chatDriverName').textContent = driver.name || 'Driver';
    document.getElementById('chatDriverRating').textContent = driver.rating ? `${driver.rating} ` : '4.5 ';
    
    const chatDriverAvatar = document.getElementById('chatDriverAvatar');
    if (driverProfileImage) {
        chatDriverAvatar.innerHTML = `<img src="${driverProfileImage}" class="driver-profile-image" alt="Driver" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
    } else if (driver.name) {
        chatDriverAvatar.innerHTML = driver.name.charAt(0).toUpperCase();
    } else {
        chatDriverAvatar.innerHTML = '<i class="fas fa-user"></i>';
    }
    
    document.getElementById('chatPopup').classList.remove('hidden');
    loadChatMessages(rideId);
    startChatListener(rideId);
}

function createChatPopup() {
    const chatPopup = document.createElement('div');
    chatPopup.id = 'chatPopup';
    chatPopup.className = 'popup-overlay hidden';
    chatPopup.innerHTML = `
        <div class="popup-form" style="max-width: 400px; height: 500px; display: flex; flex-direction: column;">
            <div class="popup-header">
                <h2 class="popup-title">
                    <i class="fas fa-comments"></i>
                    Chat with Driver
                </h2>
                <button class="close-popup" id="closeChatPopup">&times;</button>
            </div>
            <div class="chat-driver-info" style="padding: 10px; border-bottom: 1px solid var(--border-color); background: var(--light-orange);">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div class="driver-avatar" id="chatDriverAvatar" style="width: 30px; height: 30px; font-size: 0.8rem; background: var(--primary-orange); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white;"></div>
                    <div>
                        <div style="font-weight: 600; font-size: 0.9rem;" id="chatDriverName">Driver</div>
                        <div style="font-size: 0.7rem; color: var(--medium-gray);" id="chatDriverRating">4.5 </div>
                    </div>
                </div>
            </div>
            <div class="chat-messages" id="chatMessages" style="flex: 1; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; background: var(--light-gray);"></div>
            <div class="chat-input-container" style="padding: 10px; border-top: 1px solid var(--border-color); background: var(--white);">
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="chatMessageInput" placeholder="Type your message..." style="flex: 1; padding: 8px; border: 1px solid var(--border-color); border-radius: var(--element-radius);">
                    <button id="sendChatMessageBtn" style="padding: 8px 15px; background: var(--primary-orange); color: white; border: none; border-radius: var(--element-radius); cursor: pointer;">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(chatPopup);
    
    document.getElementById('closeChatPopup').addEventListener('click', function() {
        chatPopupClosedByUser = true;
        closeChatPopup();
    });
    
    document.getElementById('sendChatMessageBtn').addEventListener('click', sendChatMessage);
    document.getElementById('chatMessageInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendChatMessage();
        }
    });
}

function loadChatMessages(rideId) {
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.innerHTML = '<div class="loading-text">Loading messages...</div>';
    
    database.ref('chats/' + rideId).orderByChild('timestamp').once('value')
        .then(snapshot => {
            const messages = snapshot.val();
            chatMessages.innerHTML = '';
            
            if (messages) {
                const messagesArray = Object.values(messages);
                messagesArray.forEach(message => {
                    displayChatMessage(message);
                });
                
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } else {
                chatMessages.innerHTML = '<div class="no-places" style="text-align: center; padding: 20px; color: var(--medium-gray);">No messages yet. Start the conversation!</div>';
            }
        })
        .catch(error => {
            console.error('Error loading chat messages:', error);
            chatMessages.innerHTML = '<div class="no-places" style="text-align: center; padding: 20px; color: var(--error-red);">Error loading messages.</div>';
        });
}

function startChatListener(rideId) {
    if (chatListener) {
        chatListener();
    }
    
    chatListener = database.ref('chats/' + rideId).orderByChild('timestamp').on('child_added', snapshot => {
        const message = snapshot.val();
        displayChatMessage(message);
        
        const chatMessages = document.getElementById('chatMessages');
        chatMessages.scrollTop = chatMessages.scrollHeight;
    });
}

function displayChatMessage(message) {
    const chatMessages = document.getElementById('chatMessages');
    
    if (chatMessages.querySelector('.loading-text') || chatMessages.querySelector('.no-places')) {
        chatMessages.innerHTML = '';
    }
    
    const messageElement = document.createElement('div');
    messageElement.className = `chat-message ${message.senderId === currentUser.uid ? 'own-message' : 'other-message'}`;
    messageElement.style.cssText = `
        max-width: 80%;
        padding: 8px 12px;
        border-radius: 15px;
        margin-bottom: 5px;
        word-wrap: break-word;
        align-self: ${message.senderId === currentUser.uid ? 'flex-end' : 'flex-start'};
        background: ${message.senderId === currentUser.uid ? 'var(--primary-orange)' : 'var(--white)'};
        color: ${message.senderId === currentUser.uid ? 'white' : 'var(--dark-gray)'};
        border: ${message.senderId === currentUser.uid ? 'none' : '1px solid var(--border-color)'};
        box-shadow: ${message.senderId === currentUser.uid ? 'var(--shadow-light)' : 'none'};
    `;
    
    const timestamp = new Date(message.timestamp);
    const timeString = timestamp.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    messageElement.innerHTML = `
        <div style="font-size: 0.8rem;">${message.message}</div>
        <div style="font-size: 0.6rem; opacity: 0.7; text-align: ${message.senderId === currentUser.uid ? 'right' : 'left'}; margin-top: 4px;">${timeString}</div>
    `;
    
    chatMessages.appendChild(messageElement);
}

function sendChatMessage() {
    const messageInput = document.getElementById('chatMessageInput');
    const message = messageInput.value.trim();
    
    if (!message || !currentChatRideId) {
        return;
    }
    
    const messageData = {
        message: message,
        senderId: currentUser.uid,
        senderName: userData.name || 'Passenger',
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        rideId: currentChatRideId
    };
    
    database.ref('chats/' + currentChatRideId).push(messageData)
        .then(() => {
            messageInput.value = '';
        })
        .catch(error => {
            console.error('Error sending message:', error);
            showNotification('Error sending message. Please try again.');
        });
}

function closeChatPopup() {
    document.getElementById('chatPopup').classList.add('hidden');
    
    if (chatListener) {
        chatListener();
        chatListener = null;
    }
    
    currentChatRideId = null;
}

function updateDriverDetailsCard(driver) {
    const driverDetailsCard = document.getElementById('driverDetailsCard');
    driverDetailsCard.style.display = 'block';
    
    document.getElementById('driverFullName').textContent = driver.name || 'Driver';
    document.getElementById('driverContactPhone').textContent = driver.phone || 'Not available';
    document.getElementById('driverRatingValue').textContent = driver.rating ? `${driver.rating} ` : '4.5 ';
    document.getElementById('driverExperience').textContent = driver.experience || '2 years';
    
    if (driver.vehicle) {
        document.getElementById('vehicleType').textContent = driver.vehicle.type || 'Car';
        document.getElementById('vehicleModel').textContent = driver.vehicle.model || 'Not specified';
        document.getElementById('vehicleLicense').textContent = driver.vehicle.licensePlate || 'Not available';
        document.getElementById('vehicleColor').textContent = driver.vehicle.color || 'Not specified';
    }
}

function trackDriverLocation(driverId) {
    if (driverLocationListener) {
        driverLocationListener();
    }
    
    driverLocationListener = database.ref('driverLocations/' + driverId).on('value', snapshot => {
        const location = snapshot.val();
        if (location && driverMarker) {
            driverMarker.setLatLng([location.latitude, location.longitude]);
            
            updateDriverETA(location.latitude, location.longitude);
        }
    });
}

function updateDriverETA(driverLat, driverLng) {
    if (userLocation) {
        const distance = calculateDistance(
            driverLat, driverLng,
            userLocation.lat, userLocation.lng
        );
        
        const etaMinutes = Math.ceil((distance / 1000) / 30 * 60);
        document.getElementById('timeText').textContent = `${etaMinutes} min`;
    }
}

function addDriverMarker(lat, lng) {
    if (driverMarker) {
        passengerMap.removeLayer(driverMarker);
    }
    
    driverMarker = L.marker([lat, lng], {
        icon: L.divIcon({
            className: 'driver-marker',
            html: '<div class="driver-marker"></div><div class="driver-marker-label">Driver</div>',
            iconSize: [32, 45]
        })
    }).addTo(passengerMap)
        .bindPopup('Your driver');
}

function addDestinationMarker(lat, lng) {
    if (destinationMarker) {
        passengerMap.removeLayer(destinationMarker);
    }
    
    destinationMarker = L.marker([lat, lng], {
        icon: L.divIcon({
            className: 'destination-marker',
            html: '<div class="destination-marker"><i class="fas fa-flag"></i></div>',
            iconSize: [22, 22]
        })
    }).addTo(passengerMap)
        .bindPopup('Destination');
}

function listenForRideStatusUpdates(rideId) {
    database.ref('rides/' + rideId).on('value', snapshot => {
        const ride = snapshot.val();
        if (ride) {
            currentRide = ride;
            
            switch(ride.status) {
                case 'accepted':
                    document.getElementById('statusText').textContent = 'Driver on the way';
                    break;
                case 'arrived':
                    document.getElementById('statusText').textContent = 'Driver arrived';
                    document.getElementById('statusDot').className = 'status-dot riding';
                    showNotification('Your driver has arrived!');
                    break;
                case 'started':
                    document.getElementById('statusText').textContent = 'Trip in progress';
                    addDestinationMarker(ride.destLat, ride.destLng);
                    drawRoute(ride.pickupLat, ride.pickupLng, ride.destLat, ride.destLng);
                    break;
                case 'completed':
                    document.getElementById('statusText').textContent = 'Trip completed';
                    document.getElementById('rideStatus').style.display = 'none';
                    document.getElementById('estimatedTime').style.display = 'none';
                    document.getElementById('sosButton').style.display = 'none';
                    resetUIAfterRide();
                    
                    stopLiveTracking(rideId);
                    
                    showNotification('Trip completed. Thank you for using Jubel!');
                    break;
                case 'cancelled':
                    document.getElementById('rideStatus').style.display = 'none';
                    document.getElementById('estimatedTime').style.display = 'none';
                    document.getElementById('sosButton').style.display = 'none';
                    resetUIAfterRide();
                    
                    stopLiveTracking(rideId);
                    
                    showNotification('Ride cancelled');
                    break;
            }
        }
    });
}

function stopLiveTracking(rideId) {
    if (liveTrackingListeners[rideId]) {
        liveTrackingListeners[rideId]();
        delete liveTrackingListeners[rideId];
    }
    
    if (sharedRideLinks[rideId]) {
        const trackingId = sharedRideLinks[rideId].trackingId;
        database.ref('liveTracking/' + trackingId).update({
            isActive: false,
            endedAt: firebase.database.ServerValue.TIMESTAMP
        });
        
        delete sharedRideLinks[rideId];
    }
}

function handleRideCancellation(ride) {
    document.getElementById('searchingAnimation').style.display = 'none';
    
    showNotification('Ride has been cancelled.');
    resetUIAfterRide();
    currentRide = null;
    
    if (driverMarker) {
        passengerMap.removeLayer(driverMarker);
        driverMarker = null;
    }
    
    if (driverAssignmentListener) {
        driverAssignmentListener();
        driverAssignmentListener = null;
    }
    
    if (driverLocationListener) {
        driverLocationListener();
        driverLocationListener = null;
    }
    
    if (driverMessageListener) {
        driverMessageListener();
        driverMessageListener = null;
    }
    
    stopLiveTracking(ride.id);
}

function cancelRide() {
    if (currentRide) {
        if (confirm('Are you sure you want to cancel this ride?')) {
            database.ref('rides/' + currentRide.id).update({
                status: 'cancelled',
                cancelledAt: firebase.database.ServerValue.TIMESTAMP,
                updatedAt: firebase.database.ServerValue.TIMESTAMP
            })
            .then(() => {
                resetUIAfterRide();
                showNotification('Ride cancelled');
            })
            .catch(error => {
                console.error('Error cancelling ride:', error);
                showNotification('Error cancelling ride. Please try again.');
            });
        }
    }
}

function contactDriver() {
    if (currentRide && currentRide.driverId) {
        database.ref('users/' + currentRide.driverId).once('value')
            .then(snapshot => {
                const driver = snapshot.val();
                if (driver && driver.phone) {
                    showNotification(`Calling driver: ${driver.phone}`);
                    window.open(`tel:${driver.phone}`, '_self');
                } else {
                    showNotification('Driver phone number not available.');
                }
            });
    }
}

function applyPromoCode() {
    const promoCode = document.getElementById('promoCode').value.trim();
    
    if (!promoCode) {
        showNotification('Please enter a promo code.');
        return;
    }
    
    if (promoCode.startsWith('JUBEL')) {
        applyReferralCode(promoCode);
    } else {
        if (promoCode.startsWith('JUBEL-')) {
            appliedPromoCode = promoCode;
            showNotification('Promo code applied! 20% discount will be applied to your ride.');
            updateFareEstimate();
            
            document.getElementById('promoCode').style.borderColor = 'var(--success-green)';
            document.getElementById('applyPromoBtn').innerHTML = '<i class="fas fa-check"></i> Applied';
            document.getElementById('applyPromoBtn').classList.remove('btn-promo');
            document.getElementById('applyPromoBtn').classList.add('btn-success');
        } else {
            showNotification('Invalid promo code. Please check and try again.');
            document.getElementById('promoCode').style.borderColor = 'var(--error-red)';
        }
    }
}

function applyReferralCode(referralCode) {
    database.ref('users').orderByChild('referralCode').equalTo(referralCode).once('value')
        .then(snapshot => {
            if (snapshot.exists()) {
                const referrerData = snapshot.val();
                const referrerId = Object.keys(referrerData)[0];
                const referrer = referrerData[referrerId];
                
                appliedPromoCode = referralCode;
                showNotification('Referral code applied! 50% discount will be applied to your ride.');
                updateFareEstimate();
                
                document.getElementById('promoCode').style.borderColor = 'var(--success-green)';
                document.getElementById('applyPromoBtn').innerHTML = '<i class="fas fa-check"></i> Applied';
                document.getElementById('applyPromoBtn').classList.remove('btn-promo');
                document.getElementById('applyPromoBtn').classList.add('btn-success');
                
                const newBalance = (referrer.walletBalance || 0) + 25;
                database.ref('users/' + referrerId).update({
                    walletBalance: newBalance
                })
                .then(() => {
                    console.log(`Rewarded ${referrer.name} with K25 for referral`);
                });
                
                database.ref('referrals').push().set({
                    referrerId: referrerId,
                    referredUserId: currentUser.uid,
                    referralCode: referralCode,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    rewardAmount: 25
                });
            } else {
                showNotification('Invalid referral code. Please check and try again.');
                document.getElementById('promoCode').style.borderColor = 'var(--error-red)';
            }
        })
        .catch(error => {
            console.error('Error applying referral code:', error);
            showNotification('Error applying referral code. Please try again.');
        });
}

function resetUIAfterRide() {
    document.getElementById('rideRequestForm').style.display = 'flex';
    
    document.getElementById('rideInfoPanel').style.display = 'none';
    
    document.getElementById('driverDetailsCard').style.display = 'none';
    
    document.getElementById('destinationLocation').value = '';
    
    document.getElementById('packageForm').classList.remove('active');
    document.getElementById('receiverName').value = '';
    document.getElementById('receiverPhone').value = '';
    document.getElementById('packageDescription').value = '';
    document.getElementById('specialInstructions').value = '';
    document.getElementById('packageValue').value = '';
    
    document.getElementById('promoCode').value = '';
    appliedPromoCode = null;
    document.getElementById('promoCode').style.borderColor = '';
    document.getElementById('applyPromoBtn').innerHTML = 'Apply';
    document.getElementById('applyPromoBtn').classList.remove('btn-success');
    document.getElementById('applyPromoBtn').classList.add('btn-promo');
    document.getElementById('promoSection').classList.remove('active');
    
    const chatButton = document.getElementById('chatWithDriverBtn');
    if (chatButton) {
        chatButton.remove();
    }
    
    const shareBtn = document.getElementById('shareRideBtn');
    if (shareBtn) shareBtn.remove();
    
    const trackingBtn = document.getElementById('shareTrackingBtn');
    if (trackingBtn) trackingBtn.remove();
    
    if (document.getElementById('chatPopup') && !document.getElementById('chatPopup').classList.contains('hidden')) {
        closeChatPopup();
    }
    
    if (driverMessageListener) {
        driverMessageListener();
        driverMessageListener = null;
    }
    
    driverProfileImage = null;
    driverVehicleImage = null;
    
    if (driverMarker) {
        passengerMap.removeLayer(driverMarker);
        driverMarker = null;
    }
    
    if (destinationMarker) {
        passengerMap.removeLayer(destinationMarker);
        destinationMarker = null;
    }
    
    if (routePolyline) {
        passengerMap.removeLayer(routePolyline);
        routePolyline = null;
    }
    
    if (driverLocationListener) {
        driverLocationListener();
        driverLocationListener = null;
    }
    
    currentRide = null;
}

function loadPassengerData() {
    if (currentUser) {
        updateUserStats();
    }
}

function loadAccountData() {
    if (currentUser && userData) {
        document.getElementById('accountName').textContent = userData.name || 'Passenger';
        document.getElementById('accountPhone').textContent = userData.phone || 'Not set';
        document.getElementById('accountEmail').textContent = userData.email || 'Not set';
        document.getElementById('referralCode').textContent = userData.referralCode || 'JUBEL-XXXX';
        
        walletBalance = userData.walletBalance || 0;
        document.getElementById('accountBalance').textContent = `K${walletBalance.toFixed(2)}`;
        
        const accountAvatar = document.getElementById('accountAvatar');
        if (userData.name) {
            accountAvatar.textContent = userData.name.charAt(0).toUpperCase();
        } else {
            accountAvatar.innerHTML = '<i class="fas fa-user"></i>';
        }
        
        updateUserStats();
    }
}

function updateUserStats() {
    if (!currentUser) return;
    
    database.ref('rides').orderByChild('passengerId').equalTo(currentUser.uid).once('value')
        .then(snapshot => {
            const rides = snapshot.val();
            if (rides) {
                const ridesArray = Object.values(rides);
                
                userStats = {
                    completed: ridesArray.filter(ride => ride.status === 'completed' || ride.status === 'paid').length,
                    cancelled: ridesArray.filter(ride => ride.status === 'cancelled').length,
                    pending: ridesArray.filter(ride => ride.status === 'requested' || ride.status === 'accepted').length
                };
                
                document.getElementById('ridesCompleted').textContent = userStats.completed;
                document.getElementById('ridesCancelled').textContent = userStats.cancelled;
                document.getElementById('ridesPending').textContent = userStats.pending;
            }
        });
}

function shareReferralCode() {
    const referralCode = document.getElementById('referralCode').textContent;
    const shareText = `Join me on Jubel! Use my referral code ${referralCode} for 50% off your first ride. Download the app now!`;
    
    if (navigator.share) {
        navigator.share({
            title: 'Jubel Referral',
            text: shareText,
            url: window.location.href
        })
        .then(() => showNotification('Referral code shared successfully!'))
        .catch(error => console.error('Error sharing:', error));
    } else {
        navigator.clipboard.writeText(shareText)
            .then(() => showNotification('Referral code copied to clipboard!'));
    }
}

function depositToWallet() {
    const amount = prompt('Enter deposit amount (K):');
    if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
        const depositAmount = parseFloat(amount);
        const newBalance = walletBalance + depositAmount;
        
        database.ref('users/' + currentUser.uid).update({
            walletBalance: newBalance
        })
        .then(() => {
            walletBalance = newBalance;
            updateWalletBalanceUI();
            showNotification(`Successfully deposited K${depositAmount.toFixed(2)} to your wallet.`);
        })
        .catch(error => {
            console.error('Error depositing to wallet:', error);
            showNotification('Error processing deposit. Please try again.');
        });
    } else if (amount) {
        showNotification('Please enter a valid amount.');
    }
}

function withdrawFromWallet() {
    if (walletBalance <= 0) {
        showNotification('Your wallet balance is zero.');
        return;
    }
    
    const amount = prompt(`Enter withdrawal amount (K). Available: K${walletBalance.toFixed(2)}:`);
    if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
        const withdrawalAmount = parseFloat(amount);
        
        if (withdrawalAmount > walletBalance) {
            showNotification('Insufficient balance for this withdrawal.');
            return;
        }
        
        const newBalance = walletBalance - withdrawalAmount;
        
        database.ref('users/' + currentUser.uid).update({
            walletBalance: newBalance
        })
        .then(() => {
            walletBalance = newBalance;
            updateWalletBalanceUI();
            showNotification(`Successfully withdrew K${withdrawalAmount.toFixed(2)} from your wallet.`);
        })
        .catch(error => {
            console.error('Error withdrawing from wallet:', error);
            showNotification('Error processing withdrawal. Please try again.');
        });
    } else if (amount) {
        showNotification('Please enter a valid amount.');
    }
}

function contactWhatsApp() {
    const phoneNumber = '0768658484';
    const message = 'Hello, I need assistance with Jubel rides.';
    const url = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
    window.open(url, '_blank');
}

function contactPhone() {
    const phoneNumber = '0768658484';
    window.open(`tel:${phoneNumber}`, '_self');
}

function addPaymentMethod() {
    showNotification('Payment method feature coming soon!');
}

function loadRideHistory() {
    if (currentUser) {
        const filter = document.getElementById('historyFilter').value;
        const dateFilter = document.getElementById('historyDate').value;
        
        if (rideHistoryListener) {
            rideHistoryListener();
        }
        
        rideHistoryListener = database.ref('rides').orderByChild('passengerId').equalTo(currentUser.uid).on('value', snapshot => {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';
            
            const rides = snapshot.val();
            if (rides) {
                let ridesArray = Object.keys(rides).map(rideId => ({
                    id: rideId,
                    ...rides[rideId]
                }));
                
                if (filter !== 'all') {
                    ridesArray = ridesArray.filter(ride => ride.status === filter);
                }
                
                if (dateFilter) {
                    const filterDate = new Date(dateFilter);
                    ridesArray = ridesArray.filter(ride => {
                        const rideDate = new Date(ride.timestamp);
                        return rideDate.toDateString() === filterDate.toDateString();
                    });
                }
                
                ridesArray.sort((a, b) => b.timestamp - a.timestamp);
                
                if (ridesArray.length === 0) {
                    historyList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--medium-gray);">No rides found matching your criteria.</p>';
                    return;
                }
                
                ridesArray.forEach(ride => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item';
                    historyItem.setAttribute('data-ride-id', ride.id);
                    
                    const date = new Date(ride.timestamp);
                    const formattedDate = date.toLocaleDateString();
                    const formattedTime = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    const isDelivery = ride.rideType === 'bike' || ride.rideType === 'bicycle';
                    const typeClass = isDelivery ? 'delivery' : 'ride';
                    const typeText = isDelivery ? 'Delivery' : 'Ride';
                    
                    let statusClass = 'status-requested';
                    let statusText = getStatusText(ride.status);
                    
                    if (ride.status === 'accepted') {
                        statusClass = 'status-accepted';
                    } else if (ride.status === 'completed' || ride.status === 'paid') {
                        statusClass = 'status-completed';
                    } else if (ride.status === 'cancelled') {
                        statusClass = 'status-cancelled';
                    } else if (ride.status === 'requested') {
                        statusClass = 'status-pending';
                        statusText = 'Pending';
                    }
                    
                    let historyContent = '';
                    
                    const hasChat = ride.hasChat || false;
                    
                    historyContent = `
                        <div class="history-item-type ${typeClass}">${typeText}</div>
                        <div class="history-locations">
                            <div class="history-location">
                                <div class="history-location-icon pickup">
                                    <i class="fas fa-map-marker-alt"></i>
                                </div>
                                <div>
                                    <strong>From:</strong> ${ride.pickupDisplayLocation || ride.pickupLocation}
                                </div>
                            </div>
                            <div class="history-location">
                                <div class="history-location-icon destination">
                                    <i class="fas fa-flag"></i>
                                </div>
                                <div>
                                    <strong>To:</strong> ${ride.destination}
                                </div>
                            </div>
                        </div>
                        <div class="history-info">
                            <div class="history-fare">K${ride.fare ? ride.fare.toFixed(2) : '0.00'}</div>
                            <div>${formattedDate} ${formattedTime}</div>
                            <div class="status-badge ${statusClass}">
                                ${statusText}
                            </div>
                            ${hasChat ? '<div class="chat-indicator"><i class="fas fa-comments"></i> Chat available</div>' : ''}
                        </div>
                    `;
                    
                    if (ride.driverId) {
                        database.ref('users/' + ride.driverId).once('value')
                            .then(driverSnapshot => {
                                const driver = driverSnapshot.val();
                                if (driver) {
                                    const driverInfo = document.createElement('div');
                                    driverInfo.className = 'history-driver-info';
                                    driverInfo.innerHTML = `
                                        <div class="history-driver-avatar">
                                            ${driver.name ? driver.name.charAt(0).toUpperCase() : 'D'}
                                        </div>
                                        <div class="history-driver-details">
                                            <div class="history-driver-name">${driver.name || 'Driver'}</div>
                                            <div class="history-driver-rating">${driver.rating || '4.5'} </div>
                                        </div>
                                    `;
                                    historyItem.appendChild(driverInfo);
                                }
                            });
                    }
                    
                    historyItem.innerHTML = historyContent;
                    historyList.appendChild(historyItem);
                });
            } else {
                historyList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--medium-gray);">No ride history found.</p>';
            }
        }, error => {
            console.error('Error loading ride history:', error);
            historyList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--error-red);">Error loading ride history.</p>';
        });
    }
}

function getStatusText(status) {
    const statusMap = {
        'requested': 'Awaiting Driver',
        'accepted': 'In Progress',
        'completed': 'Completed',
        'paid': 'Completed',
        'cancelled': 'Cancelled',
        'arrived': 'Driver Arrived',
        'picked_up': 'Picked Up',
        'started': 'Trip Started'
    };
    
    return statusMap[status] || status;
}

// Enhanced Ride Details Popup with chat history
function showRideDetailsPopup(rideId) {
    database.ref('rides/' + rideId).once('value')
        .then(snapshot => {
            const ride = snapshot.val();
            if (ride) {
                document.getElementById('popupRidePickup').textContent = ride.pickupDisplayLocation || ride.pickupLocation;
                document.getElementById('popupRideDestination').textContent = ride.destination;
                document.getElementById('popupRideFare').textContent = `K${ride.fare ? ride.fare.toFixed(2) : '0.00'}`;
                document.getElementById('popupRideDistance').textContent = ride.distance || 'Calculating...';
                document.getElementById('popupRideStatus').textContent = getStatusText(ride.status);
                document.getElementById('popupRideType').textContent = ride.rideType ? ride.rideType.charAt(0).toUpperCase() + ride.rideType.slice(1) : 'Standard';
                
                const date = new Date(ride.timestamp);
                document.getElementById('popupRideDate').textContent = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                updatePopupRideMap(ride);
                
                const viewChatBtn = document.getElementById('viewChatBtn');
                if (ride.driverId) {
                    viewChatBtn.style.display = 'inline-block';
                    viewChatBtn.onclick = function() {
                        viewRideChat(rideId, ride);
                    };
                } else {
                    viewChatBtn.style.display = 'none';
                }
                
                if (ride.driverId) {
                    database.ref('users/' + ride.driverId).once('value')
                        .then(driverSnapshot => {
                            const driver = driverSnapshot.val();
                            if (driver) {
                                document.getElementById('popupDriverName').textContent = driver.name || 'Driver';
                                document.getElementById('popupDriverPhone').textContent = driver.phone || 'N/A';
                                document.getElementById('popupDriverVehicle').textContent = `${driver.vehicleType || 'Car'} (${driver.licensePlate || 'N/A'})`;
                                document.getElementById('popupDriverRating').textContent = driver.rating || '4.5';
                                
                                document.getElementById('popupDriverDetails').classList.remove('hidden');
                            }
                        });
                } else {
                    document.getElementById('popupDriverDetails').classList.add('hidden');
                }
                
                // Load chat history
                loadPopupChatHistory(rideId);
                
                document.getElementById('rideDetailsPopup').classList.remove('hidden');
            }
        })
        .catch(error => {
            console.error('Error loading ride details:', error);
            showNotification('Error loading ride details.');
        });
}

function updatePopupRideMap(ride) {
    if (popupRideMap) {
        popupRideMap.remove();
    }
    
    popupRideMap = L.map('popupRideMap').setView([ride.pickupLat, ride.pickupLng], 13);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: ' OpenStreetMap contributors'
    }).addTo(popupRideMap);
    
    // Add pickup marker
    L.marker([ride.pickupLat, ride.pickupLng], {
        icon: L.divIcon({
            className: 'pickup-marker',
            html: '<div class="pickup-marker"><i class="fas fa-map-marker-alt"></i></div>',
            iconSize: [22, 22]
        })
    }).addTo(popupRideMap)
        .bindPopup(`<strong>Pickup:</strong> ${ride.pickupDisplayLocation || ride.pickupLocation}`);
    
    // Add destination marker
    L.marker([ride.destLat, ride.destLng], {
        icon: L.divIcon({
            className: 'destination-marker',
            html: '<div class="destination-marker"><i class="fas fa-flag"></i></div>',
            iconSize: [22, 22]
        })
    }).addTo(popupRideMap)
        .bindPopup(`<strong>Destination:</strong> ${ride.destination}`);
    
    // Draw route
    fetch(`https://router.project-osrm.org/route/v1/driving/${ride.pickupLng},${ride.pickupLat};${ride.destLng},${ride.destLat}?overview=full&geometries=geojson`)
        .then(response => response.json())
        .then(data => {
            if (data.routes && data.routes.length > 0) {
                const route = data.routes[0];
                const routeCoordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                
                L.polyline(routeCoordinates, {
                    color: '#FF6B35',
                    weight: 4,
                    opacity: 0.7,
                    dashArray: '8, 8'
                }).addTo(popupRideMap);
                
                const bounds = L.latLngBounds(
                    [ride.pickupLat, ride.pickupLng],
                    [ride.destLat, ride.destLng]
                );
                popupRideMap.fitBounds(bounds, { padding: [20, 20] });
            }
        })
        .catch(error => {
            console.error('Error fetching route for popup:', error);
        });
}

function loadPopupChatHistory(rideId) {
    const chatMessagesContainer = document.getElementById('popupChatMessages');
    chatMessagesContainer.innerHTML = '<div class="loading-text">Loading chat history...</div>';
    
    database.ref('chats/' + rideId).orderByChild('timestamp').once('value')
        .then(snapshot => {
            const messages = snapshot.val();
            chatMessagesContainer.innerHTML = '';
            
            if (messages) {
                const messagesArray = Object.values(messages);
                messagesArray.sort((a, b) => a.timestamp - b.timestamp);
                
                if (messagesArray.length > 0) {
                    document.getElementById('popupChatSection').classList.remove('hidden');
                    
                    messagesArray.forEach(message => {
                        const messageElement = document.createElement('div');
                        messageElement.className = `chat-message ${message.senderId === currentUser.uid ? 'passenger' : 'driver'}`;
                        
                        const timestamp = new Date(message.timestamp);
                        const timeString = timestamp.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        
                        messageElement.innerHTML = `
                            <div>${message.message}</div>
                            <div class="chat-message-time">${timeString}  ${message.senderId === currentUser.uid ? 'You' : 'Driver'}</div>
                        `;
                        
                        chatMessagesContainer.appendChild(messageElement);
                    });
                    
                    chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
                } else {
                    document.getElementById('popupChatSection').classList.add('hidden');
                }
            } else {
                document.getElementById('popupChatSection').classList.add('hidden');
            }
        })
        .catch(error => {
            console.error('Error loading chat history:', error);
            chatMessagesContainer.innerHTML = '<div class="no-results">Error loading chat history</div>';
        });
}

function viewRideChat(rideId, ride) {
    if (ride.driverId) {
        database.ref('users/' + ride.driverId).once('value')
            .then(driverSnapshot => {
                const driver = driverSnapshot.val();
                if (driver) {
                    openChatWithDriver(rideId, driver);
                    closeRideDetailsPopup();
                }
            });
    } else {
        showNotification('No driver information available for this ride.');
    }
}

function closeRideDetailsPopup() {
    document.getElementById('rideDetailsPopup').classList.add('hidden');
    if (popupRideMap) {
        popupRideMap.remove();
        popupRideMap = null;
    }
}

function showRideCompletion(ride) {
    document.getElementById('finalFare').textContent = `K${ride.fare.toFixed(2)}`;
    
    showNotification('Ride completed. Please complete payment and rating.');
    
    if (driverMarker) {
        passengerMap.removeLayer(driverMarker);
        driverMarker = null;
    }
    
    if (driverAssignmentListener) {
        driverAssignmentListener();
        driverAssignmentListener = null;
    }
    
    if (driverLocationListener) {
        driverLocationListener();
        driverLocationListener = null;
    }
}

function centerMap() {
    if (currentLocationMarker) {
        const passengerLatLng = currentLocationMarker.getLatLng();
        passengerMap.setView(passengerLatLng, 16);
        showNotification('Map centered on your location');
    }
}

function togglePanelCollapse() {
    const panel = document.getElementById('passengerPanel');
    panel.classList.toggle('collapsed');
}

function useSavedLocation(addressType) {
    if (userData) {
        const address = userData[addressType + 'Address'];
        
        if (address) {
            document.getElementById('destinationLocation').value = address;
            updateFareEstimate();
            showNotification(`${addressType.charAt(0).toUpperCase() + addressType.slice(1)} address set as destination.`);
            
            forwardGeocode(address).then(results => {
                if (results.length > 0) {
                    updateDestinationMarker(
                        parseFloat(results[0].lat),
                        parseFloat(results[0].lon),
                        address
                    );
                    
                    drawRoute(userLocation.lat, userLocation.lng, parseFloat(results[0].lat), parseFloat(results[0].lon));
                    
                    document.getElementById('requestRideBtn').disabled = false;
                }
            });
        } else {
            showNotification(`No ${addressType} address saved. Please add it in settings.`);
        }
    }
}

function startLocationTracking() {
    if (navigator.geolocation && currentUser) {
        navigator.geolocation.watchPosition(position => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            userLocation = { lat, lng };
            
            database.ref('passengerLocations/' + currentUser.uid).set({
                latitude: lat,
                longitude: lng,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            
            if (currentLocationMarker) {
                currentLocationMarker.setLatLng([lat, lng]);
            }
            
            if (destinationMarker) {
                const destination = document.getElementById('destinationLocation').value;
                if (destination) {
                    updateFareEstimate();
                }
            }
        }, error => {
            console.error('Location tracking error:', error);
        }, {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 30000
        });
    }
}

function showNotification(message) {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.style.display = 'block';
    notification.style.animation = 'none';
    notification.offsetHeight; // Trigger reflow
    notification.style.animation = 'slideUp 0.3s ease, fadeOut 0.3s ease 3.7s';
    
    setTimeout(() => {
        notification.style.display = 'none';
    }, 4000);
}

function switchScreen(screenId) {
    const previousScreen = currentScreen;
    currentScreen = screenId;
    
    document.querySelectorAll('.screen-content').forEach(screen => {
        screen.classList.remove('active');
    });
    
    document.getElementById(screenId + 'Screen').classList.add('active');
    
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`.nav-btn[data-screen="${screenId}"]`).classList.add('active');
    
    if (screenId === 'home') {
        document.querySelectorAll('.home-only').forEach(el => {
            el.style.display = 'flex';
        });
        
        if (previousScreen !== 'home' && homeScreenRefreshRequired) {
            refreshHomeScreen();
        }
    } else {
        document.querySelectorAll('.home-only').forEach(el => {
            el.style.display = 'none';
        });
        
        homeScreenRefreshRequired = true;
    }
    
    if (screenId === 'history') {
        loadRideHistory();
    } else if (screenId === 'account') {
        loadAccountData();
    }
}

function refreshHomeScreen() {
    console.log("Refreshing home screen...");
    
    refreshPassengerPosition();
    
    document.getElementById('destinationLocation').value = '';
    
    if (destinationMarker) {
        passengerMap.removeLayer(destinationMarker);
        destinationMarker = null;
    }
    
    if (routePolyline) {
        passengerMap.removeLayer(routePolyline);
        routePolyline = null;
    }
    
    document.getElementById('estimatedFare').textContent = 'K0.00';
    document.getElementById('etaDisplay').textContent = 'ETA: -- min';
    document.getElementById('requestRideBtn').disabled = true;
    
    document.getElementById('promoSection').classList.remove('active');
    document.getElementById('promoCode').value = '';
    appliedPromoCode = null;
    
    document.getElementById('packageForm').classList.remove('active');
    document.getElementById('packageToggle').style.display = 'none';
    
    document.getElementById('rideRequestForm').style.display = 'flex';
    document.getElementById('rideInfoPanel').style.display = 'none';
    
    // Update scheduled rides UI
    updateScheduledRidesUI();
    
    homeScreenRefreshRequired = false;
    
    showNotification('Home screen refreshed');
}

// More Options Functions
function toggleMoreOptions() {
    const dropdown = document.getElementById('moreOptionsDropdown');
    dropdown.classList.toggle('active');
}

function handleMoreOptionSelection(option) {
    document.getElementById('orderForSomeoneForm').classList.remove('active');
    document.getElementById('expressDeliveryForm').classList.remove('active');
    document.getElementById('sosSetupForm').classList.remove('active');
    document.getElementById('rideRequestForm').style.display = 'none';
    
    switch(option) {
        case 'order-for-someone':
            document.getElementById('orderForSomeoneForm').classList.add('active');
            activeMoreOption = 'order-for-someone';
            break;
        case 'express-delivery':
            document.getElementById('expressDeliveryForm').classList.add('active');
            activeMoreOption = 'express-delivery';
            break;
        case 'sos-setup':
            document.getElementById('sosSetupForm').classList.add('active');
            activeMoreOption = 'sos-setup';
            break;
    }
    
    document.getElementById('moreOptionsDropdown').classList.remove('active');
}

function cancelMoreOptionForm() {
    document.getElementById('orderForSomeoneForm').classList.remove('active');
    document.getElementById('expressDeliveryForm').classList.remove('active');
    document.getElementById('sosSetupForm').classList.remove('active');
    
    document.getElementById('rideRequestForm').style.display = 'flex';
    
    if (recipientPickupMarker) {
        passengerMap.removeLayer(recipientPickupMarker);
        recipientPickupMarker = null;
    }
    if (recipientDestinationMarker) {
        passengerMap.removeLayer(recipientDestinationMarker);
        recipientDestinationMarker = null;
    }
    if (shopLocationMarker) {
        passengerMap.removeLayer(shopLocationMarker);
        shopLocationMarker = null;
    }
    if (deliveryDestinationMarker) {
        passengerMap.removeLayer(deliveryDestinationMarker);
        deliveryDestinationMarker = null;
    }
    
    activeMoreOption = null;
}

// Order for Someone Else Functions
function updateRecipientPickupMarker(lat, lng, name) {
    if (recipientPickupMarker) {
        passengerMap.removeLayer(recipientPickupMarker);
    }
    
    recipientPickupMarker = L.marker([lat, lng], {
        icon: L.divIcon({
            className: 'pickup-marker',
            html: '<div class="pickup-marker"><i class="fas fa-map-marker-alt"></i></div>',
            iconSize: [22, 22]
        })
    }).addTo(passengerMap)
        .bindPopup(`<strong>${name}</strong><br>Recipient Pickup Location`)
        .openPopup();
}

function updateRecipientDestinationMarker(lat, lng, name) {
    if (recipientDestinationMarker) {
        passengerMap.removeLayer(recipientDestinationMarker);
    }
    
    recipientDestinationMarker = L.marker([lat, lng], {
        icon: L.divIcon({
            className: 'destination-marker',
            html: '<div class="destination-marker"><i class="fas fa-flag"></i></div>',
            iconSize: [22, 22]
        })
    }).addTo(passengerMap)
        .bindPopup(`<strong>${name}</strong><br>Recipient Destination`)
        .openPopup();
}

function calculateRecipientDeliveryFee() {
    const pickupLocation = document.getElementById('recipientPickupLocation').value;
    const destinationLocation = document.getElementById('recipientDestinationLocation').value;
    
    if (pickupLocation.length > 3 && destinationLocation.length > 3) {
        Promise.all([
            forwardGeocode(pickupLocation),
            forwardGeocode(destinationLocation)
        ]).then(([pickupResults, destinationResults]) => {
            if (pickupResults.length > 0 && destinationResults.length > 0) {
                const pickupLat = parseFloat(pickupResults[0].lat);
                const pickupLng = parseFloat(pickupResults[0].lon);
                const destLat = parseFloat(destinationResults[0].lat);
                const destLng = parseFloat(destinationResults[0].lon);
                
                const distance = calculateDistance(pickupLat, pickupLng, destLat, destLng);
                
                let baseFare = 23;
                
                if (distance > 0) {
                    baseFare += Math.ceil(distance / 90);
                }
                
                document.getElementById('recipientDeliveryFee').textContent = `K${baseFare.toFixed(2)}`;
                
                const etaMinutes = Math.ceil((distance / 1000) / 30 * 60);
                document.getElementById('recipientEtaDisplay').textContent = `ETA: ${etaMinutes} min`;
                
                document.getElementById('orderForSomeoneBtn').disabled = false;
                
                updateRecipientPickupMarker(pickupLat, pickupLng, pickupResults[0].display_name);
                updateRecipientDestinationMarker(destLat, destLng, destinationResults[0].display_name);
                
                drawRoute(pickupLat, pickupLng, destLat, destLng);
            }
        });
    } else {
        document.getElementById('recipientDeliveryFee').textContent = 'K0.00';
        document.getElementById('recipientEtaDisplay').textContent = 'ETA: -- min';
        document.getElementById('orderForSomeoneBtn').disabled = true;
    }
}

function submitOrderForSomeone() {
    const pickupLocation = document.getElementById('recipientPickupLocation').value;
    const destinationLocation = document.getElementById('recipientDestinationLocation').value;
    const recipientName = document.getElementById('recipientName').value;
    const recipientEmail = document.getElementById('recipientEmail').value;
    const recipientPhone = document.getElementById('recipientPhone').value;
    
    if (!pickupLocation || !destinationLocation || !recipientName) {
        showNotification('Please fill in all required fields.');
        return;
    }
    
    Promise.all([
        forwardGeocode(pickupLocation),
        forwardGeocode(destinationLocation)
    ]).then(([pickupResults, destinationResults]) => {
        if (pickupResults.length === 0 || destinationResults.length === 0) {
            showNotification('Invalid pickup or destination address. Please select valid locations.');
            return;
        }
        
        const pickupLat = parseFloat(pickupResults[0].lat);
        const pickupLng = parseFloat(pickupResults[0].lon);
        const destLat = parseFloat(destinationResults[0].lat);
        const destLng = parseFloat(destinationResults[0].lon);
        
        const distance = calculateDistance(pickupLat, pickupLng, destLat, destLng);
        
        let baseFare = 23;
        
        if (distance > 0) {
            baseFare += Math.ceil(distance / 90);
        }
        
        const rideId = database.ref().child('rides').push().key;
        
        const rideRequest = {
            id: rideId,
            passengerId: currentUser.uid,
            passengerName: userData.name || 'Passenger',
            passengerPhone: userData.phone || 'Not provided',
            pickupLocation: pickupResults[0].display_name,
            destination: destinationResults[0].display_name,
            pickupLat: pickupLat,
            pickupLng: pickupLng,
            destLat: destLat,
            destLng: destLng,
            rideType: 'car',
            fare: baseFare,
            distance: (distance / 1000).toFixed(2) + ' km',
            status: 'requested',
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            updatedAt: firebase.database.ServerValue.TIMESTAMP,
            paymentMethod: selectedPaymentType,
            orderForSomeone: {
                recipientName: recipientName,
                recipientEmail: recipientEmail,
                recipientPhone: recipientPhone,
                orderedBy: userData.name || 'Passenger'
            },
            currentCity: currentCity
        };
        
        currentRideRequestData = rideRequest;
        currentRideRequestType = 'order-for-someone';
        
        showPaymentSelection(baseFare);
    }).catch(error => {
        console.error('Error in order for someone process:', error);
        showNotification('Error calculating route. Please try again.');
    });
}

// Express Delivery Functions
function updateShopLocationMarker(lat, lng, name) {
    if (shopLocationMarker) {
        passengerMap.removeLayer(shopLocationMarker);
    }
    
    shopLocationMarker = L.marker([lat, lng], {
        icon: L.divIcon({
            className: 'pickup-marker',
            html: '<div class="pickup-marker"><i class="fas fa-shopping-bag"></i></div>',
            iconSize: [22, 22]
        })
    }).addTo(passengerMap)
        .bindPopup(`<strong>${name}</strong><br>Shop Location`)
        .openPopup();
}

function updateDeliveryDestinationMarker(lat, lng, name) {
    if (deliveryDestinationMarker) {
        passengerMap.removeLayer(deliveryDestinationMarker);
    }
    
    deliveryDestinationMarker = L.marker([lat, lng], {
        icon: L.divIcon({
            className: 'destination-marker',
            html: '<div class="destination-marker"><i class="fas fa-flag"></i></div>',
            iconSize: [22, 22]
        })
    }).addTo(passengerMap)
        .bindPopup(`<strong>${name}</strong><br>Delivery Destination`)
        .openPopup();
}

function calculateExpressDeliveryFee() {
    const shopLocation = document.getElementById('shopLocation').value;
    const deliveryDestination = document.getElementById('deliveryDestination').value;
    
    if (shopLocation.length > 3 && deliveryDestination.length > 3) {
        Promise.all([
            forwardGeocode(shopLocation),
            forwardGeocode(deliveryDestination)
        ]).then(([shopResults, destinationResults]) => {
            if (shopResults.length > 0 && destinationResults.length > 0) {
                const shopLat = parseFloat(shopResults[0].lat);
                const shopLng = parseFloat(shopResults[0].lon);
                const destLat = parseFloat(destinationResults[0].lat);
                const destLng = parseFloat(destinationResults[0].lon);
                
                const distance = calculateDistance(shopLat, shopLng, destLat, destLng);
                
                let baseFare = 23;
                
                if (distance > 0) {
                    baseFare += Math.ceil(distance / 90);
                }
                
                const vehicleType = document.querySelector('.express-delivery-form .vehicle-option.selected').getAttribute('data-type');
                switch(vehicleType) {
                    case 'car':
                        baseFare = baseFare;
                        break;
                    case 'bike':
                        baseFare = baseFare * 0.7;
                        break;
                    case 'bicycle':
                        baseFare = baseFare * 0.5;
                        break;
                }
                
                document.getElementById('expressDeliveryFee').textContent = `K${baseFare.toFixed(2)}`;
                
                const etaMinutes = Math.ceil((distance / 1000) / 30 * 60);
                document.getElementById('expressDeliveryEtaDisplay').textContent = `ETA: ${etaMinutes} min`;
                
                document.getElementById('expressDeliveryBtn').disabled = false;
                
                updateShopLocationMarker(shopLat, shopLng, shopResults[0].display_name);
                updateDeliveryDestinationMarker(destLat, destLng, destinationResults[0].display_name);
                
                drawRoute(shopLat, shopLng, destLat, destLng);
            }
        });
    } else {
        document.getElementById('expressDeliveryFee').textContent = 'K0.00';
        document.getElementById('expressDeliveryEtaDisplay').textContent = 'ETA: -- min';
        document.getElementById('expressDeliveryBtn').disabled = true;
    }
}

function submitExpressDelivery() {
    const shopName = document.getElementById('shopName').value;
    const shopLocation = document.getElementById('shopLocation').value;
    const deliveryItems = document.getElementById('deliveryItems').value;
    const deliveryAmount = document.getElementById('deliveryAmount').value;
    const deliveryInstructions = document.getElementById('deliveryInstructions').value;
    const deliveryDestination = document.getElementById('deliveryDestination').value;
    const vehicleType = document.querySelector('.express-delivery-form .vehicle-option.selected').getAttribute('data-type');
    
    if (!shopName || !shopLocation || !deliveryDestination) {
        showNotification('Please fill in all required fields.');
        return;
    }
    
    Promise.all([
        forwardGeocode(shopLocation),
        forwardGeocode(deliveryDestination)
    ]).then(([shopResults, destinationResults]) => {
        if (shopResults.length === 0 || destinationResults.length === 0) {
            showNotification('Invalid shop or destination address. Please select valid locations.');
            return;
        }
        
        const shopLat = parseFloat(shopResults[0].lat);
        const shopLng = parseFloat(shopResults[0].lon);
        const destLat = parseFloat(destinationResults[0].lat);
        const destLng = parseFloat(destinationResults[0].lon);
        
        const distance = calculateDistance(shopLat, shopLng, destLat, destLng);
        
        let baseFare = 23;
        
        if (distance > 0) {
            baseFare += Math.ceil(distance / 90);
        }
        
        switch(vehicleType) {
            case 'car':
                baseFare = baseFare;
                break;
            case 'bike':
                baseFare = baseFare * 0.7;
                break;
            case 'bicycle':
                baseFare = baseFare * 0.5;
                break;
        }
        
        const rideId = database.ref().child('rides').push().key;
        
        const rideRequest = {
            id: rideId,
            passengerId: currentUser.uid,
            passengerName: userData.name || 'Passenger',
            passengerPhone: userData.phone || 'Not provided',
            pickupLocation: shopResults[0].display_name,
            destination: destinationResults[0].display_name,
            pickupLat: shopLat,
            pickupLng: shopLng,
            destLat: destLat,
            destLng: destLng,
            rideType: vehicleType,
            fare: baseFare,
            distance: (distance / 1000).toFixed(2) + ' km',
            status: 'requested',
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            updatedAt: firebase.database.ServerValue.TIMESTAMP,
            paymentMethod: selectedPaymentType,
            expressDelivery: {
                shopName: shopName,
                items: deliveryItems,
                amount: deliveryAmount,
                instructions: deliveryInstructions
            },
            currentCity: currentCity
        };
        
        currentRideRequestData = rideRequest;
        currentRideRequestType = 'express-delivery';
        
        showPaymentSelection(baseFare);
    }).catch(error => {
        console.error('Error in express delivery process:', error);
        showNotification('Error calculating route. Please try again.');
    });
}

// SOS Functions
function saveSOSConfig() {
    const contact1 = document.getElementById('emergencyContact1').value;
    const contact2 = document.getElementById('emergencyContact2').value;
    const message = document.getElementById('sosMessage').value;
    
    if (!contact1) {
        showNotification('Please provide at least one emergency contact.');
        return;
    }
    
    sosConfig = {
        contact1: contact1,
        contact2: contact2,
        message: message
    };
    
    database.ref('sosConfig/' + currentUser.uid).set(sosConfig)
        .then(() => {
            showNotification('SOS configuration saved successfully.');
            
            document.getElementById('sosSetupForm').classList.remove('active');
            
            document.getElementById('rideRequestForm').style.display = 'flex';
        })
        .catch(error => {
            console.error('Error saving SOS config:', error);
            showNotification('Error saving SOS configuration. Please try again.');
        });
}

function triggerSOS() {
    if (!sosConfig || !sosConfig.contact1) {
        showNotification('SOS not configured. Please set up emergency contacts first.');
        return;
    }
    
    if (!currentRide) {
        showNotification('No active ride to report SOS for.');
        return;
    }
    
    const sosAlert = {
        passengerId: currentUser.uid,
        passengerName: userData.name || 'Passenger',
        passengerPhone: userData.phone || 'Not provided',
        emergencyContact1: sosConfig.contact1,
        emergencyContact2: sosConfig.contact2,
        message: sosConfig.message,
        rideDetails: currentRide,
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        location: userLocation
    };
    
    if (currentRide.driverId) {
        database.ref('users/' + currentRide.driverId).once('value')
            .then(driverSnapshot => {
                const driver = driverSnapshot.val();
                if (driver) {
                    sosAlert.driverDetails = {
                        name: driver.name,
                        phone: driver.phone,
                        vehicle: driver.vehicle
                    };
                }
                
                return database.ref('sosAlerts').push().set(sosAlert);
            })
            .then(() => {
                showNotification('SOS alert sent to emergency contacts!');
                
                console.log('SOS Alert:', sosAlert);
            })
            .catch(error => {
                console.error('Error sending SOS alert:', error);
                showNotification('Error sending SOS alert. Please try again or call emergency services directly.');
            });
    } else {
        database.ref('sosAlerts').push().set(sosAlert)
            .then(() => {
                showNotification('SOS alert sent to emergency contacts!');
                
                console.log('SOS Alert:', sosAlert);
            })
            .catch(error => {
                console.error('Error sending SOS alert:', error);
                showNotification('Error sending SOS alert. Please try again or call emergency services directly.');
            });
    }
}

// Event listeners setup
function setupEventListeners() {
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const screen = this.getAttribute('data-screen');
            switchScreen(screen);
        });
    });
    
    document.querySelectorAll('.back-button').forEach(btn => {
        btn.addEventListener('click', function() {
            const screen = this.getAttribute('data-screen');
            switchScreen(screen);
        });
    });
    
    document.querySelectorAll('.vehicle-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.vehicle-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            this.classList.add('selected');
            
            selectedVehicleType = this.getAttribute('data-type');
            
            if (selectedVehicleType === 'bike' || selectedVehicleType === 'bicycle') {
                document.getElementById('packageToggle').style.display = 'flex';
            } else {
                document.getElementById('packageToggle').style.display = 'none';
                document.getElementById('packageForm').classList.remove('active');
            }
            
            updateFareEstimate();
        });
    });
    
    document.getElementById('packageToggle').addEventListener('click', function() {
        document.getElementById('packageForm').classList.toggle('active');
    });
    
    document.querySelectorAll('.payment-method').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.payment-method').forEach(opt => {
                opt.classList.remove('selected');
            });
            this.classList.add('selected');
            paymentMethod = this.getAttribute('data-method');
        });
    });
    
    document.querySelectorAll('.payment-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.payment-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            this.classList.add('selected');
            selectedPaymentType = this.getAttribute('data-payment-type');
            
            if (selectedPaymentType === 'wallet') {
                if (walletBalance < rideFare) {
                    document.getElementById('insufficientBalance').style.display = 'block';
                    document.getElementById('confirmPaymentBtn').disabled = true;
                } else {
                    document.getElementById('insufficientBalance').style.display = 'none';
                    document.getElementById('confirmPaymentBtn').disabled = false;
                }
            } else {
                document.getElementById('insufficientBalance').style.display = 'none';
                document.getElementById('confirmPaymentBtn').disabled = false;
            }
        });
    });
    
    document.getElementById('requestRideBtn').addEventListener('click', requestRide);
    
    document.getElementById('confirmPaymentBtn').addEventListener('click', submitRideRequest);
    
    document.getElementById('closePaymentPopup').addEventListener('click', closePaymentSelection);
    
    document.getElementById('cancelRideBtn').addEventListener('click', cancelRide);
    
    document.getElementById('contactDriverBtn').addEventListener('click', contactDriver);
    
    document.getElementById('promoToggle').addEventListener('click', function() {
        document.getElementById('promoSection').classList.toggle('active');
    });
    
    document.getElementById('applyPromoBtn').addEventListener('click', applyPromoCode);
    
    document.getElementById('shareReferralBtn').addEventListener('click', shareReferralCode);
    document.getElementById('depositBtn').addEventListener('click', depositToWallet);
    document.getElementById('withdrawBtn').addEventListener('click', withdrawFromWallet);
    document.getElementById('whatsappBtn').addEventListener('click', contactWhatsApp);
    document.getElementById('callBtn').addEventListener('click', contactPhone);
    
    document.getElementById('addPaymentMethodBtn').addEventListener('click', addPaymentMethod);
    
    document.getElementById('panelCollapseHandle').addEventListener('click', togglePanelCollapse);
    
    setupSearchInputListeners();
    
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.location-input') && 
            !e.target.closest('.suggestion-list')) {
            hideAllSearchSuggestions();
        }
        
        // Close more options dropdown when clicking outside
        if (!e.target.closest('.more-options-btn') && !e.target.closest('.more-options-dropdown')) {
            document.getElementById('moreOptionsDropdown').classList.remove('active');
        }
    });
    
    document.querySelectorAll('.saved-location-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const addressType = this.getAttribute('data-address');
            useSavedLocation(addressType);
        });
    });
    
    document.getElementById('historyFilter').addEventListener('change', loadRideHistory);
    document.getElementById('historyDate').addEventListener('change', loadRideHistory);
    
    document.addEventListener('click', function(e) {
        if (e.target.closest('.history-item')) {
            const historyItem = e.target.closest('.history-item');
            const rideId = historyItem.getAttribute('data-ride-id');
            if (rideId) {
                showRideDetailsPopup(rideId);
            }
        }
    });
    
    document.getElementById('closeRidePopup').addEventListener('click', closeRideDetailsPopup);
    document.getElementById('closeRidePopupTop').addEventListener('click', closeRideDetailsPopup);
    
    document.getElementById('moreOptionsBtn').addEventListener('click', toggleMoreOptions);
    
    document.querySelectorAll('.more-option-item').forEach(item => {
        item.addEventListener('click', function() {
            const option = this.getAttribute('data-option');
            handleMoreOptionSelection(option);
        });
    });
    
    document.getElementById('orderForSomeoneBtn').addEventListener('click', submitOrderForSomeone);
    document.getElementById('cancelOrderForSomeoneBtn').addEventListener('click', cancelMoreOptionForm);
    
    document.querySelectorAll('.express-delivery-form .vehicle-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.express-delivery-form .vehicle-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            this.classList.add('selected');
            calculateExpressDeliveryFee();
        });
    });
    
    document.getElementById('expressDeliveryBtn').addEventListener('click', submitExpressDelivery);
    document.getElementById('cancelExpressDeliveryBtn').addEventListener('click', cancelMoreOptionForm);
    
    document.getElementById('saveSosBtn').addEventListener('click', saveSOSConfig);
    document.getElementById('cancelSosSetupBtn').addEventListener('click', cancelMoreOptionForm);
    
    document.getElementById('sosButton').addEventListener('click', triggerSOS);
    
    document.getElementById('scheduleRideBtn').addEventListener('click', openScheduleRidePopup);
    
    // Add CSS for notification animations
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
    `;
    document.head.appendChild(style);
}

function hideAllSearchSuggestions() {
    const searchTypes = [
        'destination', 'pickup', 'recipientPickup', 
        'recipientDestination', 'shopLocation', 'deliveryDestination',
        'schedulePickup', 'scheduleDestination', 'scheduleShop',
        'scheduleDeliveryDest', 'scheduleRecipientPickup', 'scheduleRecipientDest'
    ];
    
    searchTypes.forEach(type => {
        hideSearchSuggestions(type);
    });
}

// Initialize enhanced app features
function initializeApp() {
    console.log("Jubel Passenger App Initialized with Enhanced Features");
    
    // Add CSS for enhanced animations
    const enhancedStyles = `
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .schedule-ride-btn {
            animation: pulse 2s infinite;
        }
        
        .schedule-ride-btn:hover {
            animation: none;
            transform: scale(1.05);
        }
        
        .scheduled-ride-item {
            transition: all 0.3s ease;
        }
        
        .scheduled-ride-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }
        
        .searching .search-indicator {
            animation: pulse 1s infinite;
        }
    `;
    
    const styleSheet = document.createElement("style");
    styleSheet.type = "text/css";
    styleSheet.innerText = enhancedStyles;
    document.head.appendChild(styleSheet);
    
    // Periodic city detection updates
    setInterval(() => {
        if (userLocation && currentScreen === 'home') {
            determineCurrentCity(userLocation.lat, userLocation.lng)
                .then(city => {
                    console.log("Periodic city update:", city);
                })
                .catch(error => {
                    console.error("Periodic city detection failed:", error);
                });
        }
    }, 60000);
    
    // Handle app visibility changes
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden && currentScreen === 'home') {
            setTimeout(refreshHomeScreen, 1000);
        }
    });
    
    // Handle page load completion
    window.addEventListener('load', function() {
        console.log("Jubel Passenger App fully loaded with enhanced city detection and search");
        showNotification(' Jubel Passenger App Ready! City-locked search enabled for accurate results.');
    });
    
    // Handle offline/online status
    window.addEventListener('online', function() {
        showNotification('Connection restored.');
        if (currentScreen === 'home') {
            setTimeout(refreshPassengerPosition, 1000);
        }
    });
    
    window.addEventListener('offline', function() {
        showNotification('You are currently offline. Some features may not work.');
    });
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl/Cmd + S to schedule ride
        if ((e.ctrlKey || e.metaKey) && e.key === 's') {
            e.preventDefault();
            openScheduleRidePopup();
        }
        
        // Escape to close popups
        if (e.key === 'Escape') {
            if (!document.getElementById('paymentSelectionPopup').classList.contains('hidden')) {
                closePaymentSelection();
            }
            if (!document.getElementById('rideDetailsPopup').classList.contains('hidden')) {
                closeRideDetailsPopup();
            }
            if (!document.getElementById('scheduleRidePopup').classList.contains('hidden')) {
                closeSchedulePopup();
            }
            if (!document.getElementById('chatPopup').classList.contains('hidden')) {
                closeChatPopup();
            }
        }
    });
    
    // Initialize tooltips
    initializeTooltips();
}

function initializeTooltips() {
    // Add tooltips to important elements
    const tooltipElements = [
        { selector: '#scheduleRideBtn', text: 'Schedule rides for later' },
        { selector: '#moreOptionsBtn', text: 'More ride options' },
        { selector: '.floating-balance', text: 'Your wallet balance' },
        { selector: '.city-indicator', text: 'Current city for search' }
    ];
    
    tooltipElements.forEach(item => {
        const element = document.querySelector(item.selector);
        if (element) {
            element.setAttribute('title', item.text);
        }
    });
}

// Initialize everything
setupEventListeners();
    </script>
</body>
</html>

