<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jubel - Passenger</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap">
    <style>
        /* ADVANCED CSS - Compact, App-like, White & Orange Theme */
        :root {
            --primary-orange: #FF6B35;
            --primary-dark: #E55A28;
            --primary-light: #FFF5F0;
            --primary-gradient: linear-gradient(135deg, #FF6B35, #E55A28);
            --secondary-gradient: linear-gradient(135deg, #FF9E7A, #FF6B35);
            --white: #FFFFFF;
            --off-white: #F8F9FA;
            --light-gray: #F0F2F5;
            --medium-gray: #D1D5DB;
            --dark-gray: #374151;
            --text-dark: #111827;
            --text-medium: #6B7280;
            --text-light: #9CA3AF;
            --success: #10B981;
            --warning: #F59E0B;
            --error: #EF4444;
            --info: #3B82F6;
            --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 14px;
            --radius-xl: 20px;
            --radius-full: 9999px;
            --transition-fast: 150ms;
            --transition-normal: 250ms;
            --transition-slow: 350ms;
            --app-max-width: 480px;
            --header-height: 56px;
            --bottom-nav-height: 64px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        html {
            font-size: 14px;
            height: 100%;
            overflow: hidden;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--off-white);
            color: var(--text-dark);
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
            position: fixed;
            width: 100%;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        #mainApp {
            height: 100%;
            display: flex;
            flex-direction: column;
            background: var(--white);
            max-width: var(--app-max-width);
            margin: 0 auto;
            position: relative;
            box-shadow: var(--shadow-xl);
            overflow: hidden;
        }
        
        /* HEADER STYLES */
        .app-header {
            height: var(--header-height);
            background: var(--white);
            border-bottom: 1px solid var(--light-gray);
            display: flex;
            align-items: center;
            padding: 0 16px;
            position: relative;
            z-index: 50;
            flex-shrink: 0;
        }
        
        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .header-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .header-title .logo-icon {
            color: var(--primary-orange);
            font-size: 1.4rem;
        }
        
        .city-indicator {
            background: var(--primary-light);
            color: var(--primary-orange);
            padding: 4px 10px;
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
            border: 1.5px solid rgba(255, 107, 53, 0.2);
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .wallet-display {
            background: var(--white);
            border: 1.5px solid var(--primary-orange);
            color: var(--primary-orange);
            padding: 6px 10px;
            border-radius: var(--radius-full);
            font-size: 0.8rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all var(--transition-fast);
        }
        
        .wallet-display:hover {
            background: var(--primary-light);
            transform: translateY(-1px);
        }
        
        .header-icon-btn {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-full);
            background: var(--light-gray);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-medium);
            cursor: pointer;
            transition: all var(--transition-fast);
            position: relative;
        }
        
        .header-icon-btn:hover {
            background: var(--medium-gray);
            color: var(--text-dark);
        }
        
        .header-icon-btn.primary {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .header-icon-btn.primary:hover {
            background: var(--primary-dark);
        }
        
        .notification-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            width: 18px;
            height: 18px;
            background: var(--error);
            color: var(--white);
            border-radius: var(--radius-full);
            font-size: 0.6rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--white);
        }
        
        /* MAP CONTAINER - Takes half the screen */
        .map-container {
            flex: 1;
            height: calc(50vh - var(--header-height));
            min-height: 240px;
            position: relative;
            background: var(--light-gray);
            overflow: hidden;
        }
        
        #map {
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        .map-controls {
            position: absolute;
            bottom: 16px;
            right: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 2;
        }
        
        .map-control-btn {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-lg);
            background: var(--white);
            border: 1px solid var(--medium-gray);
            box-shadow: var(--shadow-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-dark);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .map-control-btn:hover {
            background: var(--light-gray);
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }
        
        .map-control-btn.primary {
            background: var(--primary-orange);
            border-color: var(--primary-orange);
            color: var(--white);
        }
        
        .map-control-btn.primary:hover {
            background: var(--primary-dark);
        }
        
        /* CONTENT PANEL - Takes half the screen */
        .content-panel {
            flex: 1;
            overflow-y: auto;
            background: var(--white);
            position: relative;
            display: flex;
            flex-direction: column;
            height: 50vh;
        }
        
        .panel-tabs {
            display: flex;
            border-bottom: 1px solid var(--light-gray);
            background: var(--white);
            padding: 0 16px;
            flex-shrink: 0;
        }
        
        .tab-btn {
            flex: 1;
            padding: 14px 0;
            background: none;
            border: none;
            color: var(--text-medium);
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            position: relative;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .tab-btn:hover {
            color: var(--primary-orange);
        }
        
        .tab-btn.active {
            color: var(--primary-orange);
        }
        
        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary-orange);
            border-radius: var(--radius-full);
        }
        
        .tab-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* HOME SCREEN CONTENT */
        .ride-request-card {
            background: var(--white);
            border-radius: var(--radius-lg);
            border: 1px solid var(--light-gray);
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-sm);
        }
        
        .input-group {
            margin-bottom: 16px;
        }
        
        .input-label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            color: var(--text-dark);
            font-weight: 600;
            font-size: 0.85rem;
        }
        
        .input-label .icon {
            color: var(--primary-orange);
            width: 16px;
        }
        
        .location-input {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: var(--off-white);
            border: 1.5px solid var(--light-gray);
            border-radius: var(--radius-md);
            transition: all var(--transition-fast);
        }
        
        .location-input:focus-within {
            border-color: var(--primary-orange);
            background: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }
        
        .location-input .icon {
            color: var(--primary-orange);
            font-size: 1rem;
        }
        
        .location-input input {
            flex: 1;
            border: none;
            background: none;
            outline: none;
            color: var(--text-dark);
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .location-input input::placeholder {
            color: var(--text-light);
        }
        
        .saved-locations {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .saved-location-btn {
            flex: 1;
            padding: 10px 12px;
            background: var(--light-gray);
            border: 1.5px solid var(--light-gray);
            border-radius: var(--radius-md);
            color: var(--text-dark);
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .saved-location-btn:hover {
            background: var(--primary-light);
            border-color: var(--primary-orange);
            color: var(--primary-orange);
        }
        
        .vehicle-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin: 20px 0;
        }
        
        .vehicle-option {
            padding: 12px 8px;
            background: var(--off-white);
            border: 2px solid var(--light-gray);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }
        
        .vehicle-option:hover {
            border-color: var(--primary-orange);
            background: var(--primary-light);
            transform: translateY(-2px);
        }
        
        .vehicle-option.selected {
            border-color: var(--primary-orange);
            background: var(--primary-light);
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.15);
        }
        
        .vehicle-icon {
            font-size: 1.2rem;
            color: var(--text-medium);
        }
        
        .vehicle-option.selected .vehicle-icon {
            color: var(--primary-orange);
        }
        
        .vehicle-name {
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--text-dark);
        }
        
        .vehicle-price {
            font-size: 0.7rem;
            color: var(--text-medium);
        }
        
        .promo-section {
            background: var(--primary-light);
            border: 1.5px dashed var(--primary-orange);
            border-radius: var(--radius-md);
            padding: 16px;
            margin: 20px 0;
            display: none;
        }
        
        .promo-section.active {
            display: block;
            animation: slideDown var(--transition-normal) ease;
        }
        
        .promo-input {
            display: flex;
            gap: 8px;
        }
        
        .promo-input input {
            flex: 1;
            padding: 10px 14px;
            border: 1.5px solid var(--medium-gray);
            border-radius: var(--radius-md);
            font-size: 0.85rem;
            transition: all var(--transition-fast);
        }
        
        .promo-input input:focus {
            outline: none;
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }
        
        .btn-promo {
            padding: 10px 20px;
            background: var(--primary-orange);
            color: var(--white);
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .btn-promo:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        .fare-display {
            background: var(--primary-gradient);
            color: var(--white);
            border-radius: var(--radius-lg);
            padding: 20px;
            text-align: center;
            margin: 20px 0;
            box-shadow: var(--shadow-md);
        }
        
        .fare-label {
            font-size: 0.85rem;
            opacity: 0.9;
            margin-bottom: 4px;
        }
        
        .fare-amount {
            font-size: 2rem;
            font-weight: 800;
            margin: 8px 0;
        }
        
        .eta-display {
            font-size: 0.85rem;
            opacity: 0.9;
            font-weight: 600;
        }
        
        .btn-primary {
            width: 100%;
            padding: 16px;
            background: var(--primary-gradient);
            color: var(--white);
            border: none;
            border-radius: var(--radius-lg);
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-fast);
            box-shadow: var(--shadow-md);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* ACTIVE RIDE CARD */
        .active-ride-card {
            background: var(--white);
            border-radius: var(--radius-lg);
            border: 1px solid var(--light-gray);
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-md);
            display: none;
        }
        
        .active-ride-card.active {
            display: block;
            animation: slideUp var(--transition-normal) ease;
        }
        
        .ride-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--light-gray);
        }
        
        .ride-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: var(--radius-full);
            background: var(--warning);
        }
        
        .status-dot.searching {
            background: var(--warning);
            animation: pulse 1.5s infinite;
        }
        
        .status-dot.arriving {
            background: var(--info);
            animation: pulse 1s infinite;
        }
        
        .status-dot.riding {
            background: var(--success);
        }
        
        .status-text {
            font-weight: 600;
            color: var(--text-dark);
        }
        
        .driver-info {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding: 16px;
            background: var(--off-white);
            border-radius: var(--radius-md);
        }
        
        .driver-avatar {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-full);
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-weight: 700;
            font-size: 1.1rem;
            flex-shrink: 0;
        }
        
        .driver-details {
            flex: 1;
        }
        
        .driver-name {
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 4px;
        }
        
        .driver-rating {
            color: var(--warning);
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 2px;
        }
        
        .driver-vehicle {
            color: var(--text-medium);
            font-size: 0.8rem;
            margin-top: 2px;
        }
        
        .trip-details {
            background: var(--off-white);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 20px;
        }
        
        .location-row {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .location-row:last-child {
            margin-bottom: 0;
        }
        
        .location-icon {
            width: 20px;
            height: 20px;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-top: 2px;
        }
        
        .location-icon.pickup {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .location-icon.destination {
            background: var(--dark-gray);
            color: var(--white);
        }
        
        .location-text h4 {
            font-size: 0.85rem;
            color: var(--text-medium);
            margin-bottom: 2px;
        }
        
        .location-text p {
            font-size: 0.9rem;
            color: var(--text-dark);
            font-weight: 500;
        }
        
        .ride-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .btn-secondary {
            padding: 12px 16px;
            background: var(--white);
            border: 1.5px solid var(--medium-gray);
            border-radius: var(--radius-md);
            color: var(--text-dark);
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .btn-secondary:hover {
            background: var(--light-gray);
            border-color: var(--primary-orange);
            color: var(--primary-orange);
        }
        
        .btn-secondary.danger {
            border-color: var(--error);
            color: var(--error);
        }
        
        .btn-secondary.danger:hover {
            background: rgba(239, 68, 68, 0.1);
        }
        
        /* ACCOUNT SCREEN */
        .account-header {
            text-align: center;
            margin-bottom: 24px;
        }
        
        .account-avatar {
            width: 80px;
            height: 80px;
            border-radius: var(--radius-full);
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 2rem;
            font-weight: 700;
            margin: 0 auto 12px;
        }
        
        .account-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 4px;
        }
        
        .account-email {
            color: var(--text-medium);
            font-size: 0.9rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background: var(--off-white);
            border-radius: var(--radius-md);
            padding: 16px;
            text-align: center;
            border: 1px solid var(--light-gray);
        }
        
        .stat-number {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary-orange);
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: var(--text-medium);
            font-weight: 600;
        }
        
        .wallet-card {
            background: var(--primary-gradient);
            color: var(--white);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-md);
        }
        
        .wallet-label {
            font-size: 0.85rem;
            opacity: 0.9;
            margin-bottom: 4px;
        }
        
        .wallet-amount {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 16px;
        }
        
        .wallet-actions {
            display: flex;
            gap: 12px;
        }
        
        .btn-wallet {
            flex: 1;
            padding: 10px;
            background: rgba(255, 255, 255, 0.2);
            border: 1.5px solid rgba(255, 255, 255, 0.3);
            border-radius: var(--radius-md);
            color: var(--white);
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .btn-wallet:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .referral-card {
            background: var(--primary-light);
            border: 1.5px solid var(--primary-orange);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .referral-code {
            background: var(--white);
            border-radius: var(--radius-md);
            padding: 16px;
            text-align: center;
            margin: 16px 0;
            border: 1.5px dashed var(--primary-orange);
        }
        
        .code {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary-orange);
            letter-spacing: 1px;
        }
        
        .section-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* HISTORY SCREEN */
        .history-filters {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .filter-select {
            flex: 1;
            padding: 10px 14px;
            background: var(--white);
            border: 1.5px solid var(--light-gray);
            border-radius: var(--radius-md);
            color: var(--text-dark);
            font-size: 0.85rem;
            cursor: pointer;
        }
        
        .history-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .history-item {
            background: var(--white);
            border: 1px solid var(--light-gray);
            border-radius: var(--radius-md);
            padding: 16px;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .history-item:hover {
            border-color: var(--primary-orange);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .history-type {
            padding: 4px 10px;
            background: var(--primary-light);
            color: var(--primary-orange);
            border-radius: var(--radius-full);
            font-size: 0.7rem;
            font-weight: 700;
        }
        
        .history-fare {
            font-weight: 700;
            color: var(--primary-orange);
            font-size: 1rem;
        }
        
        .history-date {
            color: var(--text-medium);
            font-size: 0.8rem;
            margin-bottom: 12px;
        }
        
        .history-status {
            display: inline-block;
            padding: 4px 10px;
            background: var(--light-gray);
            color: var(--text-dark);
            border-radius: var(--radius-full);
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .history-status.completed {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }
        
        .history-status.cancelled {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
        }
        
        /* PAYMENTS SCREEN */
        .payment-methods {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 24px;
        }
        
        .payment-method {
            background: var(--white);
            border: 1.5px solid var(--light-gray);
            border-radius: var(--radius-md);
            padding: 16px;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .payment-method:hover {
            border-color: var(--primary-orange);
        }
        
        .payment-method.selected {
            border-color: var(--primary-orange);
            background: var(--primary-light);
        }
        
        .payment-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            background: var(--off-white);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-dark);
            font-size: 1.1rem;
        }
        
        .payment-method.selected .payment-icon {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .payment-details {
            flex: 1;
        }
        
        .payment-name {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 2px;
        }
        
        .payment-info {
            color: var(--text-medium);
            font-size: 0.8rem;
        }
        
        /* BOTTOM NAVIGATION */
        .bottom-nav {
            height: var(--bottom-nav-height);
            background: var(--white);
            border-top: 1px solid var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: space-around;
            padding: 8px 0;
            flex-shrink: 0;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            padding: 8px 16px;
            border-radius: var(--radius-md);
            transition: all var(--transition-fast);
            position: relative;
            min-width: 70px;
        }
        
        .nav-item:hover {
            background: var(--light-gray);
        }
        
        .nav-item.active {
            color: var(--primary-orange);
        }
        
        .nav-icon {
            font-size: 1.2rem;
        }
        
        .nav-label {
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .nav-item.active .nav-icon {
            color: var(--primary-orange);
        }
        
        .nav-item.active .nav-label {
            color: var(--primary-orange);
        }
        
        /* MODALS & POPUPS */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            animation: fadeIn var(--transition-normal) ease;
        }
        
        .modal {
            background: var(--white);
            border-radius: var(--radius-xl);
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: var(--shadow-xl);
            animation: slideUpModal var(--transition-normal) ease;
        }
        
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            border-bottom: 1px solid var(--light-gray);
        }
        
        .modal-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .close-btn {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-full);
            background: var(--light-gray);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-dark);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .close-btn:hover {
            background: var(--medium-gray);
        }
        
        .modal-content {
            padding: 20px;
            overflow-y: auto;
            max-height: 60vh;
        }
        
        /* ANIMATIONS */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes slideDown {
            from { transform: translateY(-10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes slideUpModal {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* UTILITY CLASSES */
        .hidden {
            display: none !important;
        }
        
        .loading {
            position: relative;
            pointer-events: none;
        }
        
        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid var(--primary-orange);
            border-top-color: transparent;
            border-radius: var(--radius-full);
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* RESPONSIVE DESIGN */
        @media (max-width: 480px) {
            html {
                font-size: 13px;
            }
            
            #mainApp {
                max-width: 100%;
            }
            
            .map-container {
                height: calc(45vh - var(--header-height));
            }
            
            .content-panel {
                height: 55vh;
            }
        }
        
        @media (min-width: 768px) {
            #mainApp {
                border-radius: 20px;
                overflow: hidden;
                margin: 20px auto;
                height: calc(100vh - 40px);
                height: calc(100dvh - 40px);
            }
        }
        
        /* CUSTOM SCROLLBAR */
        ::-webkit-scrollbar {
            width: 4px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--light-gray);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--medium-gray);
            border-radius: var(--radius-full);
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-light);
        }
    </style>
</head>
<body>
    <div id="mainApp">
        <!-- HEADER -->
        <header class="app-header">
            <div class="header-content">
                <div class="header-left">
                    <div class="header-title">
                        <i class="fas fa-car logo-icon"></i>
                        <span>Jubel</span>
                    </div>
                    <div class="city-indicator" id="cityIndicator">
                        <i class="fas fa-map-marker-alt"></i>
                        <span id="currentCityDisplay">Detecting...</span>
                    </div>
                </div>
                <div class="header-right">
                    <div class="wallet-display" id="walletDisplay">
                        <i class="fas fa-wallet"></i>
                        <span id="walletBalance">K0.00</span>
                    </div>
                    <button class="header-icon-btn" id="notificationsBtn" title="Notifications">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge hidden" id="notificationBadge">3</span>
                    </button>
                    <button class="header-icon-btn" id="sosBtn" title="SOS Emergency">
                        <i class="fas fa-exclamation-triangle"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- MAIN CONTENT AREA -->
        <main class="app-main">
            <!-- MAP CONTAINER (50% of screen) -->
            <div class="map-container">
                <div id="map"></div>
                <div class="map-controls">
                    <button class="map-control-btn" id="centerMapBtn" title="Center on my location">
                        <i class="fas fa-location-crosshairs"></i>
                    </button>
                    <button class="map-control-btn primary" id="scheduleRideBtn" title="Schedule a ride">
                        <i class="fas fa-clock"></i>
                    </button>
                </div>
            </div>

            <!-- CONTENT PANEL (50% of screen) -->
            <div class="content-panel">
                <!-- TABS -->
                <div class="panel-tabs">
                    <button class="tab-btn active" data-tab="home">
                        <i class="fas fa-home"></i>
                        <span>Ride</span>
                    </button>
                    <button class="tab-btn" data-tab="account">
                        <i class="fas fa-user"></i>
                        <span>Account</span>
                    </button>
                    <button class="tab-btn" data-tab="history">
                        <i class="fas fa-history"></i>
                        <span>History</span>
                    </button>
                    <button class="tab-btn" data-tab="payments">
                        <i class="fas fa-credit-card"></i>
                        <span>Payments</span>
                    </button>
                </div>

                <!-- TAB CONTENT -->
                <div class="tab-content active" id="homeTab">
                    <!-- Active Ride Card -->
                    <div class="active-ride-card hidden" id="activeRideCard">
                        <div class="ride-header">
                            <div class="ride-status">
                                <div class="status-dot" id="statusDot"></div>
                                <span class="status-text" id="statusText">Searching for driver</span>
                            </div>
                            <div class="eta-display" id="rideEta">5 min</div>
                        </div>
                        
                        <div class="driver-info" id="driverInfo">
                            <div class="driver-avatar" id="driverAvatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="driver-details">
                                <div class="driver-name" id="driverName">Driver Name</div>
                                <div class="driver-rating" id="driverRating">
                                    <i class="fas fa-star"></i>
                                    <span>4.5</span>
                                </div>
                                <div class="driver-vehicle" id="driverVehicle">Toyota Corolla â€¢ ABC123</div>
                            </div>
                        </div>
                        
                        <div class="trip-details">
                            <div class="location-row">
                                <div class="location-icon pickup">
                                    <i class="fas fa-map-marker-alt"></i>
                                </div>
                                <div class="location-text">
                                    <h4>Pickup</h4>
                                    <p id="pickupLocationText">123 Main Street</p>
                                </div>
                            </div>
                            <div class="location-row">
                                <div class="location-icon destination">
                                    <i class="fas fa-flag"></i>
                                </div>
                                <div class="location-text">
                                    <h4>Destination</h4>
                                    <p id="destinationLocationText">456 Oak Avenue</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="ride-actions">
                            <button class="btn-secondary" id="cancelRideBtn">
                                <i class="fas fa-times"></i>
                                Cancel Ride
                            </button>
                            <button class="btn-secondary" id="contactDriverBtn">
                                <i class="fas fa-phone"></i>
                                Contact Driver
                            </button>
                        </div>
                    </div>

                    <!-- Ride Request Card -->
                    <div class="ride-request-card" id="rideRequestCard">
                        <div class="input-group">
                            <div class="input-label">
                                <i class="fas fa-map-marker-alt icon"></i>
                                <span>Pickup Location</span>
                            </div>
                            <div class="location-input">
                                <i class="fas fa-map-marker-alt"></i>
                                <input type="text" id="pickupInput" placeholder="Your current location" readonly>
                            </div>
                        </div>
                        
                        <div class="input-group">
                            <div class="input-label">
                                <i class="fas fa-flag icon"></i>
                                <span>Destination</span>
                            </div>
                            <div class="location-input">
                                <i class="fas fa-flag"></i>
                                <input type="text" id="destinationInput" placeholder="Where to?">
                            </div>
                        </div>
                        
                        <div class="saved-locations">
                            <button class="saved-location-btn" data-location="home">
                                <i class="fas fa-home"></i>
                                Home
                            </button>
                            <button class="saved-location-btn" data-location="work">
                                <i class="fas fa-briefcase"></i>
                                Work
                            </button>
                            <button class="saved-location-btn" data-location="favorites">
                                <i class="fas fa-star"></i>
                                Favorites
                            </button>
                        </div>
                        
                        <div class="vehicle-selector">
                            <div class="vehicle-option selected" data-type="car">
                                <i class="fas fa-car vehicle-icon"></i>
                                <span class="vehicle-name">Ride</span>
                                <span class="vehicle-price">Comfort</span>
                            </div>
                            <div class="vehicle-option" data-type="bike">
                                <i class="fas fa-motorcycle vehicle-icon"></i>
                                <span class="vehicle-name">Delivery</span>
                                <span class="vehicle-price">Fast</span>
                            </div>
                            <div class="vehicle-option" data-type="bicycle">
                                <i class="fas fa-bicycle vehicle-icon"></i>
                                <span class="vehicle-name">Bike</span>
                                <span class="vehicle-price">Eco</span>
                            </div>
                        </div>
                        
                        <div class="promo-section" id="promoSection">
                            <div class="promo-input">
                                <input type="text" id="promoCode" placeholder="Enter promo code">
                                <button class="btn-promo" id="applyPromoBtn">Apply</button>
                            </div>
                        </div>
                        
                        <button class="btn-secondary" id="promoToggle">
                            <i class="fas fa-tag"></i>
                            Add Promo Code
                        </button>
                        
                        <div class="fare-display">
                            <div class="fare-label">Estimated Fare</div>
                            <div class="fare-amount" id="estimatedFare">K0.00</div>
                            <div class="eta-display" id="etaDisplay">ETA: -- min</div>
                        </div>
                        
                        <button class="btn-primary" id="requestRideBtn" disabled>
                            <i class="fas fa-car"></i>
                            Request Ride
                        </button>
                    </div>
                </div>

                <!-- ACCOUNT TAB -->
                <div class="tab-content" id="accountTab">
                    <div class="account-header">
                        <div class="account-avatar" id="accountAvatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <h2 class="account-name" id="accountName">Passenger</h2>
                        <p class="account-email" id="accountEmail">user@example.com</p>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="ridesCompleted">0</div>
                            <div class="stat-label">Completed</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="ridesCancelled">0</div>
                            <div class="stat-label">Cancelled</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="ridesPending">0</div>
                            <div class="stat-label">Pending</div>
                        </div>
                    </div>
                    
                    <div class="wallet-card">
                        <div class="wallet-label">Wallet Balance</div>
                        <div class="wallet-amount" id="accountBalance">K0.00</div>
                        <div class="wallet-actions">
                            <button class="btn-wallet" id="depositBtn">
                                <i class="fas fa-plus"></i>
                                Deposit
                            </button>
                            <button class="btn-wallet" id="withdrawBtn">
                                <i class="fas fa-minus"></i>
                                Withdraw
                            </button>
                        </div>
                    </div>
                    
                    <div class="referral-card">
                        <h3 class="section-title">
                            <i class="fas fa-share-alt"></i>
                            Refer & Earn
                        </h3>
                        <p style="color: var(--text-medium); font-size: 0.9rem; margin-bottom: 12px;">
                            Share your code and get K25 when friends join
                        </p>
                        <div class="referral-code">
                            <div class="code" id="referralCode">JUBEL-XXXX</div>
                            <div style="color: var(--text-medium); font-size: 0.8rem; margin-top: 4px;">
                                50% discount for new users
                            </div>
                        </div>
                        <button class="btn-secondary" id="shareReferralBtn" style="width: 100%;">
                            <i class="fas fa-share"></i>
                            Share Referral Code
                        </button>
                    </div>
                </div>

                <!-- HISTORY TAB -->
                <div class="tab-content" id="historyTab">
                    <div class="history-filters">
                        <select class="filter-select" id="historyFilter">
                            <option value="all">All Rides</option>
                            <option value="completed">Completed</option>
                            <option value="cancelled">Cancelled</option>
                            <option value="pending">Pending</option>
                        </select>
                        <select class="filter-select" id="historySort">
                            <option value="newest">Newest First</option>
                            <option value="oldest">Oldest First</option>
                            <option value="fare_high">Highest Fare</option>
                            <option value="fare_low">Lowest Fare</option>
                        </select>
                    </div>
                    
                    <div class="history-list" id="historyList">
                        <!-- History items will be dynamically inserted here -->
                        <div style="text-align: center; padding: 40px 20px; color: var(--text-light);">
                            <i class="fas fa-history" style="font-size: 2rem; margin-bottom: 12px; opacity: 0.5;"></i>
                            <p>No ride history yet</p>
                        </div>
                    </div>
                </div>

                <!-- PAYMENTS TAB -->
                <div class="tab-content" id="paymentsTab">
                    <h3 class="section-title" style="margin-top: 0;">
                        <i class="fas fa-credit-card"></i>
                        Payment Methods
                    </h3>
                    
                    <div class="payment-methods">
                        <div class="payment-method selected" data-method="wallet">
                            <div class="payment-icon">
                                <i class="fas fa-wallet"></i>
                            </div>
                            <div class="payment-details">
                                <div class="payment-name">Jubel Wallet</div>
                                <div class="payment-info">Pay with wallet balance</div>
                            </div>
                        </div>
                        
                        <div class="payment-method" data-method="airtel">
                            <div class="payment-icon">
                                <i class="fas fa-mobile-alt"></i>
                            </div>
                            <div class="payment-details">
                                <div class="payment-name">Airtel Money</div>
                                <div class="payment-info">Pay with Airtel Money</div>
                            </div>
                        </div>
                        
                        <div class="payment-method" data-method="mtn">
                            <div class="payment-icon">
                                <i class="fas fa-mobile-alt"></i>
                            </div>
                            <div class="payment-details">
                                <div class="payment-name">MTN Money</div>
                                <div class="payment-info">Pay with MTN Money</div>
                            </div>
                        </div>
                        
                        <div class="payment-method" data-method="cash">
                            <div class="payment-icon">
                                <i class="fas fa-money-bill"></i>
                            </div>
                            <div class="payment-details">
                                <div class="payment-name">Cash</div>
                                <div class="payment-info">Pay with cash</div>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn-primary" id="addPaymentBtn">
                        <i class="fas fa-plus"></i>
                        Add Payment Method
                    </button>
                </div>
            </div>
        </main>

        <!-- BOTTOM NAVIGATION -->
        <nav class="bottom-nav">
            <div class="nav-item active" data-tab="home">
                <i class="fas fa-car nav-icon"></i>
                <span class="nav-label">Ride</span>
            </div>
            <div class="nav-item" data-tab="account">
                <i class="fas fa-user nav-icon"></i>
                <span class="nav-label">Account</span>
            </div>
            <div class="nav-item" id="scheduleNavBtn" style="position: relative; top: -10px;">
                <div style="width: 50px; height: 50px; background: var(--primary-gradient); border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.3rem; box-shadow: var(--shadow-lg);">
                    <i class="fas fa-plus"></i>
                </div>
            </div>
            <div class="nav-item" data-tab="history">
                <i class="fas fa-history nav-icon"></i>
                <span class="nav-label">History</span>
            </div>
            <div class="nav-item" data-tab="payments">
                <i class="fas fa-credit-card nav-icon"></i>
                <span class="nav-label">Payments</span>
            </div>
        </nav>

        <!-- MODALS -->
        <!-- Payment Selection Modal -->
        <div class="modal-overlay hidden" id="paymentModal">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">
                        <i class="fas fa-credit-card"></i>
                        Select Payment
                    </h3>
                    <button class="close-btn" id="closePaymentModal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-content">
                    <div class="payment-methods">
                        <div class="payment-method selected" data-payment="wallet">
                            <div class="payment-icon">
                                <i class="fas fa-wallet"></i>
                            </div>
                            <div class="payment-details">
                                <div class="payment-name">Jubel Wallet</div>
                                <div class="payment-info">Balance: <span id="modalWalletBalance">K0.00</span></div>
                            </div>
                        </div>
                        <!-- Other payment options will be dynamically added -->
                    </div>
                    <button class="btn-primary" id="confirmPaymentBtn" style="margin-top: 20px;">
                        Confirm & Request Ride
                    </button>
                </div>
            </div>
        </div>

        <!-- Schedule Ride Modal -->
        <div class="modal-overlay hidden" id="scheduleModal">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">
                        <i class="fas fa-clock"></i>
                        Schedule Ride
                    </h3>
                    <button class="close-btn" id="closeScheduleModal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-content">
                    <!-- Schedule form will be dynamically added -->
                </div>
            </div>
        </div>

        <!-- SOS Modal -->
        <div class="modal-overlay hidden" id="sosModal">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title" style="color: var(--error);">
                        <i class="fas fa-exclamation-triangle"></i>
                        Emergency SOS
                    </h3>
                    <button class="close-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-content">
                    <div style="text-align: center; padding: 20px;">
                        <div style="width: 80px; height: 80px; background: rgba(239, 68, 68, 0.1); border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; font-size: 2rem; color: var(--error);">
                            <i class="fas fa-exclamation"></i>
                        </div>
                        <h3 style="margin-bottom: 12px; color: var(--text-dark);">Emergency Alert</h3>
                        <p style="color: var(--text-medium); margin-bottom: 24px;">
                            Your current location and ride details will be sent to emergency contacts.
                        </p>
                        <button class="btn-primary" style="background: var(--error);" id="confirmSosBtn">
                            Send SOS Alert
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- External Libraries -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script>
// Firebase configuration
const firebaseConfig = {
    apiKey: "AIzaSyDEACX_P4c5q7djJAcA0I7Lk7leO2TlQ74",
    authDomain: "jubel-13e1a.firebaseapp.com",
    databaseURL: "https://jubel-13e1a-default-rtdb.firebaseio.com",
    projectId: "jubel-13e1a",
    storageBucket: "jubel-13e1a.firebasestorage.app",
    messagingSenderId: "882241095445",
    appId: "1:882241095445:web:ee9ca40fddd008ca910b1c",
    measurementId: "G-J5JPKL6B5F"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const auth = firebase.auth();

// Enhanced App State
let currentUser = null;
let currentRide = null;
let passengerMap;
let popupRideMap;
let locationWatchId = null;
let currentLocationMarker = null;
let pickupMarker = null;
let destinationMarker = null;
let driverMarker = null;
let routePolyline = null;
let selectedVehicleType = 'car';
let walletBalance = 0;
let userFullName = "Passenger";
let driverAssignmentListener = null;
let rideHistoryListener = null;
let activeRideListener = null;
let appliedPromoCode = null;
let userStats = { completed: 0, cancelled: 0, pending: 0 };
let paymentMethod = 'airtel';
let userRating = 0;
let userLocation = null;
let destinationSearchResults = [];
let selectedDestination = null;
let driverLocationListener = null;
let userData = null;
let selectedPaymentType = 'wallet';
let rideFare = 0;
let currentCity = null;
let packageDetails = null;
let walletBalanceListener = null;
let currentScreen = 'home';
let homeScreenRefreshRequired = false;

// Enhanced state variables
let sosConfig = null;
let activeMoreOption = null;
let recipientPickupMarker = null;
let recipientDestinationMarker = null;
let shopLocationMarker = null;
let deliveryDestinationMarker = null;
let chatListener = null;
let currentChatRideId = null;
let unreadMessages = {};
let chatPopupClosedByUser = false;
let driverMessageListener = null;
let pickupSearchResults = [];
let recipientPickupSearchResults = [];
let shopLocationSearchResults = [];
let deliveryDestinationSearchResults = [];
let activeSearchField = null;
let currentRideRequestType = 'standard';
let currentRideRequestData = null;
let driverProfileImage = null;
let driverVehicleImage = null;
let activeRideRestored = false;
let driverMessagesQueue = [];

// Schedule ride variables
let scheduledRides = [];
let scheduledRideTimers = {};
let scheduledRideCheckInterval = null;

// Live tracking variables
let liveTrackingListeners = {};
let sharedRideLinks = {};

// Enhanced Zambian cities with detailed boundaries
const zambianCities = [
    'Lusaka', 'Kitwe', 'Ndola', 'Kabwe', 'Chipata', 'Chingola', 
    'Mufulira', 'Luanshya', 'Livingstone', 'Kasama', 'Solwezi', 
    'Kapiri Mposhi', 'Chililabombwe'
];

const cityAliases = {
    'lusaka': 'Lusaka', 'lsk': 'Lusaka', 'lsk city': 'Lusaka',
    'kitwe': 'Kitwe', 'ndola': 'Ndola', 'kabwe': 'Kabwe',
    'chipata': 'Chipata', 'chingola': 'Chingola',
    'mufulira': 'Mufulira', 'luanshya': 'Luanshya',
    'livingstone': 'Livingstone', 'kasama': 'Kasama',
    'solwezi': 'Solwezi', 'kapiri': 'Kapiri Mposhi',
    'kapiri mposhi': 'Kapiri Mposhi', 'chililabombwe': 'Chililabombwe'
};

// Enhanced city boundaries with more accurate radii
const cityBoundaries = {
    'Lusaka': { lat: -15.4167, lng: 28.2833, radius: 30000 },
    'Kitwe': { lat: -12.8139, lng: 28.2136, radius: 25000 },
    'Ndola': { lat: -12.9667, lng: 28.6333, radius: 25000 },
    'Kabwe': { lat: -14.4333, lng: 28.4500, radius: 20000 },
    'Chipata': { lat: -13.6333, lng: 32.6500, radius: 20000 },
    'Chingola': { lat: -12.5333, lng: 27.8500, radius: 20000 },
    'Mufulira': { lat: -12.5500, lng: 28.2333, radius: 20000 },
    'Luanshya': { lat: -13.1333, lng: 28.4000, radius: 20000 },
    'Livingstone': { lat: -17.8500, lng: 25.8667, radius: 20000 },
    'Kasama': { lat: -10.2000, lng: 31.2000, radius: 20000 },
    'Solwezi': { lat: -12.1833, lng: 26.4000, radius: 20000 },
    'Kapiri Mposhi': { lat: -13.9667, lng: 28.6833, radius: 15000 },
    'Chililabombwe': { lat: -12.3667, lng: 27.8333, radius: 15000 }
};

// Enhanced search cache for instant results
let searchCache = new Map();
let lastSearchTime = 0;
const SEARCH_DEBOUNCE_TIME = 50;
const CACHE_DURATION = 300000;

// Zambian common places database for instant suggestions
const zambianCommonPlaces = {
    'Lusaka': [
        'Manda Hill Shopping Mall', 'East Park Mall', 'Arcades Shopping Mall', 'Levy Mall',
        'Kamwala Market', 'Soweto Market', 'City Market', 'Lusaka City Council',
        'University of Zambia', 'Lusaka Apex Medical University', 'Levy Mwanawasa Hospital',
        'University Teaching Hospital', 'Kenneth Kaunda Airport', 'Lusaka National Museum',
        'State House', 'National Assembly', 'Mulungushi Conference Centre',
        'Zambia National Broadcasting Corporation', 'Taj Pamodzi Hotel', 'Protea Hotel',
        'Radisson Blu Hotel', 'Cresta Golfview Hotel', 'Lusaka Playhouse', 'Nakatindi Hall'
    ],
    'Kitwe': [
        'Mukuba Mall', 'Kitwe City Mall', 'Nkana Mall', 'Chimwemwe Shopping Centre',
        'Kitwe Main Market', 'Wusakile Market', 'Kitwe Teaching Hospital', 'Nkana Mine',
        'Mopani Copper Mines', 'Copperbelt University', 'David Kaunda Stadium',
        'Arthur Davies Stadium', 'Kitwe Golf Club', 'Nkana Golf Club', 'Kitwe Museum',
        'Nkana Mine Club', 'Savoy Hotel', 'Mukuba Hotel', 'Protea Hotel Kitwe'
    ],
    'Ndola': [
        'Mukuba Mall Ndola', 'Northrise Mall', 'Shoprite Ndola', 'Masala Market',
        'Ndola Main Market', 'Itawa Market', 'Ndola Teaching Hospital', 'Lewanika Hospital',
        'Simon Mwansa Kapwepwe Airport', 'Indeni Oil Refinery', 'Ndola Golf Club',
        'Dag HammarskjÃ¶ld Crash Site Memorial', 'Masala Stadium', 'Levy Mwanawasa Stadium',
        'Savoy Hotel Ndola', 'Mikomfwa Hotel', 'Protea Hotel Ndola'
    ],
    'Kabwe': [
        'Mukobeko Mall', 'Kabwe Main Market', 'Kabwe Central Hospital', 'Broken Hill Mine',
        'Big Tree National Monument', 'Kabwe Golf Club', 'Kabwe Stadium',
        'Kabwe Museum', 'Mulungushi University', 'Nkrumah University', 'Railways Football Club'
    ],
    'Livingstone': [
        'Victoria Falls', 'Mosi-oa-Tunya National Park', 'Livingstone Museum',
        'Maramba Market', 'Dambwa Market', 'Livingstone Central Hospital',
        'Harry Mwanga Nkumbula Airport', 'Zambezi Sun Hotel', 'Royal Livingstone Hotel',
        'Avani Victoria Falls Resort', 'David Livingstone Safari Lodge', 'Toka Leya Camp'
    ]
};

// Initialize the app
document.addEventListener('DOMContentLoaded', function() {
    initializeAuth();
});

// Authentication functions
function initializeAuth() {
    const urlParams = new URLSearchParams(window.location.search);
    const email = urlParams.get('email');
    const uid = urlParams.get('uid');
    
    if (email && uid) {
        loadUserData(uid);
    } else {
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                loadUserData(user.uid);
            } else {
                window.location.href = 'signup.html';
            }
        });
    }
}

function loadUserData(uid) {
    database.ref('users/' + uid).once('value')
        .then(snapshot => {
            userData = snapshot.val();
            if (userData) {
                currentUser = {
                    uid: uid,
                    email: userData.email,
                    displayName: userData.name
                };
                
                initializeMap();
                setupEventListeners();
                loadPassengerData();
                
                document.getElementById('accountName').textContent = userData.name || 'Passenger';
                document.getElementById('accountEmail').textContent = userData.email || 'Not set';
                document.getElementById('accountPhone').textContent = userData.phone || 'Not set';
                document.getElementById('referralCode').textContent = userData.referralCode || 'JUBEL-XXXX';
                
                walletBalance = userData.walletBalance || 0;
                updateWalletBalanceUI();
                
                setupWalletBalanceListener(uid);
                loadSOSConfig(uid);
                checkActiveRide(uid);
                loadScheduledRides(uid);
                
                showNotification('Welcome back to Jubel!');
                initializeApp();
            } else {
                showNotification('User data not found. Please sign up again.');
                setTimeout(() => {
                    window.location.href = 'signup.html';
                }, 2000);
            }
        })
        .catch(error => {
            console.error('Error loading user data:', error);
            showNotification('Error loading user data. Please try again.');
        });
}

function loadScheduledRides(uid) {
    database.ref('scheduledRides').orderByChild('passengerId').equalTo(uid).once('value')
        .then(snapshot => {
            const rides = snapshot.val();
            if (rides) {
                scheduledRides = Object.values(rides).filter(ride => 
                    ride.status === 'scheduled' && ride.scheduledTime > Date.now()
                );
                
                scheduledRides.forEach(ride => {
                    scheduleRideTimer(ride);
                });
                
                startScheduledRideChecker();
                
                if (currentScreen === 'home') {
                    updateScheduledRidesUI();
                }
            }
        })
        .catch(error => {
            console.error('Error loading scheduled rides:', error);
        });
}

function scheduleRideTimer(ride) {
    const timeUntilRide = ride.scheduledTime - Date.now();
    
    if (timeUntilRide <= 0) {
        return;
    }
    
    const timerId = setTimeout(() => {
        autoRequestScheduledRide(ride);
    }, timeUntilRide);
    
    scheduledRideTimers[ride.id] = timerId;
    
    updateScheduledRideCountdown(ride);
}

function autoRequestScheduledRide(ride) {
    const rideId = database.ref().child('rides').push().key;
    
    const rideRequest = {
        id: rideId,
        passengerId: ride.passengerId,
        passengerName: ride.passengerName,
        passengerPhone: ride.passengerPhone,
        pickupLocation: ride.pickupLocation,
        pickupDisplayLocation: ride.pickupDisplayLocation,
        destination: ride.destination,
        pickupLat: ride.pickupLat,
        pickupLng: ride.pickupLng,
        destLat: ride.destLat,
        destLng: ride.destLng,
        rideType: ride.rideType,
        fare: ride.fare,
        distance: ride.distance,
        status: 'requested',
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        updatedAt: firebase.database.ServerValue.TIMESTAMP,
        paymentMethod: ride.paymentMethod,
        packageDetails: ride.packageDetails,
        orderForSomeone: ride.orderForSomeone,
        expressDelivery: ride.expressDelivery,
        isScheduled: true,
        scheduledRideId: ride.id,
        currentCity: ride.currentCity
    };
    
    database.ref('scheduledRides/' + ride.id).update({
        status: 'auto-requested',
        autoRequestedAt: firebase.database.ServerValue.TIMESTAMP
    })
    .then(() => {
        currentRideRequestData = rideRequest;
        selectedPaymentType = ride.paymentMethod;
        submitRideRequest();
        
        showNotification(`Scheduled ride to ${ride.destination} has been automatically requested.`);
        
        scheduledRides = scheduledRides.filter(r => r.id !== ride.id);
        updateScheduledRidesUI();
    })
    .catch(error => {
        console.error('Error auto-requesting scheduled ride:', error);
        showNotification('Error auto-requesting scheduled ride. Please request manually.');
    });
}

function startScheduledRideChecker() {
    if (scheduledRideCheckInterval) {
        clearInterval(scheduledRideCheckInterval);
    }
    
    scheduledRideCheckInterval = setInterval(() => {
        scheduledRides.forEach(ride => {
            updateScheduledRideCountdown(ride);
        });
    }, 60000);
}

function updateScheduledRideCountdown(ride) {
    const timeLeft = ride.scheduledTime - Date.now();
    
    if (timeLeft <= 0) {
        return;
    }
    
    const hours = Math.floor(timeLeft / (1000 * 60 * 60));
    const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
    
    const rideElement = document.querySelector(`[data-scheduled-ride-id="${ride.id}"]`);
    if (rideElement) {
        const countdownElement = rideElement.querySelector('.scheduled-countdown');
        if (countdownElement) {
            if (hours > 0) {
                countdownElement.textContent = `Auto-requests in ${hours}h ${minutes}m`;
            } else {
                countdownElement.textContent = `Auto-requests in ${minutes}m`;
            }
        }
    }
}

function updateScheduledRidesUI() {
    if (currentScreen !== 'home') return;
    
    const scheduledSection = document.getElementById('scheduledRidesSection');
    if (!scheduledSection) {
        const homeScreen = document.getElementById('homeScreenContent');
        const scheduledHTML = `
            <div id="scheduledRidesSection" style="margin-top: 15px; display: ${scheduledRides.length > 0 ? 'block' : 'none'}">
                <h4 class="section-title" style="font-size: 0.9rem; margin-bottom: 10px;">
                    <i class="fas fa-clock"></i> Upcoming Scheduled Rides
                </h4>
                <div id="scheduledRidesList"></div>
            </div>
        `;
        
        const rideRequestForm = document.getElementById('rideRequestForm');
        if (rideRequestForm) {
            rideRequestForm.insertAdjacentHTML('beforebegin', scheduledHTML);
        }
    }
    
    const scheduledRidesList = document.getElementById('scheduledRidesList');
    if (scheduledRidesList) {
        if (scheduledRides.length === 0) {
            document.getElementById('scheduledRidesSection').style.display = 'none';
            return;
        }
        
        document.getElementById('scheduledRidesSection').style.display = 'block';
        scheduledRidesList.innerHTML = '';
        
        scheduledRides.forEach(ride => {
            const scheduledTime = new Date(ride.scheduledTime);
            const timeLeft = ride.scheduledTime - Date.now();
            const hoursLeft = Math.floor(timeLeft / (1000 * 60 * 60));
            const minutesLeft = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            
            const rideElement = document.createElement('div');
            rideElement.className = 'scheduled-ride-item';
            rideElement.setAttribute('data-scheduled-ride-id', ride.id);
            rideElement.innerHTML = `
                <div class="scheduled-ride-header">
                    <div class="scheduled-ride-type">
                        ${ride.scheduleType === 'delivery' ? 'Delivery' : 
                          ride.scheduleType === 'someone-else' ? 'For Someone' : 'Ride'}
                    </div>
                    <div class="scheduled-ride-fare">K${ride.fare ? ride.fare.toFixed(2) : '0.00'}</div>
                </div>
                <div class="history-locations" style="margin: 8px 0;">
                    <div class="history-location">
                        <div class="history-location-icon pickup">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div style="font-size: 0.75rem;">
                            ${ride.pickupDisplayLocation || ride.pickupLocation}
                        </div>
                    </div>
                    <div class="history-location">
                        <div class="history-location-icon destination">
                            <i class="fas fa-flag"></i>
                        </div>
                        <div style="font-size: 0.75rem;">
                            ${ride.destination}
                        </div>
                    </div>
                </div>
                <div class="scheduled-countdown">
                    <i class="fas fa-calendar-alt"></i> 
                    ${scheduledTime.toLocaleDateString()} at ${scheduledTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                    <br>
                    <span style="color: var(--primary-orange); font-weight: 700;">
                        ${hoursLeft > 0 ? `${hoursLeft}h ${minutesLeft}m` : `${minutesLeft}m`} until auto-request
                    </span>
                </div>
                <div style="display: flex; gap: 8px; margin-top: 10px;">
                    <button class="btn-cancel-schedule" data-ride-id="${ride.id}" 
                            style="flex: 1; padding: 6px; background: var(--light-gray); border: 1px solid var(--border-color); border-radius: var(--element-radius); cursor: pointer; font-size: 0.7rem;">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button class="btn-edit-schedule" data-ride-id="${ride.id}"
                            style="flex: 1; padding: 6px; background: var(--primary-orange); color: white; border: none; border-radius: var(--element-radius); cursor: pointer; font-size: 0.7rem;">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                </div>
            `;
            
            scheduledRidesList.appendChild(rideElement);
        });
        
        document.querySelectorAll('.btn-cancel-schedule').forEach(btn => {
            btn.addEventListener('click', function() {
                const rideId = this.getAttribute('data-ride-id');
                cancelScheduledRide(rideId);
            });
        });
        
        document.querySelectorAll('.btn-edit-schedule').forEach(btn => {
            btn.addEventListener('click', function() {
                const rideId = this.getAttribute('data-ride-id');
                editScheduledRide(rideId);
            });
        });
    }
}

function cancelScheduledRide(rideId) {
    if (confirm('Are you sure you want to cancel this scheduled ride?')) {
        database.ref('scheduledRides/' + rideId).update({
            status: 'cancelled',
            cancelledAt: firebase.database.ServerValue.TIMESTAMP
        })
        .then(() => {
            if (scheduledRideTimers[rideId]) {
                clearTimeout(scheduledRideTimers[rideId]);
                delete scheduledRideTimers[rideId];
            }
            
            scheduledRides = scheduledRides.filter(ride => ride.id !== rideId);
            
            updateScheduledRidesUI();
            
            showNotification('Scheduled ride cancelled.');
        })
        .catch(error => {
            console.error('Error cancelling scheduled ride:', error);
            showNotification('Error cancelling scheduled ride.');
        });
    }
}

function editScheduledRide(rideId) {
    const ride = scheduledRides.find(r => r.id === rideId);
    if (!ride) {
        showNotification('Scheduled ride not found.');
        return;
    }
    
    openScheduleRidePopup();
    
    setTimeout(() => {
        const activeTab = ride.scheduleType || 'standard';
        document.querySelectorAll('.tab-btn').forEach(tab => {
            tab.classList.remove('active');
            if (tab.getAttribute('data-tab') === activeTab) {
                tab.classList.add('active');
            }
        });
        
        document.querySelectorAll('.schedule-form').forEach(form => {
            form.style.display = 'none';
        });
        
        const activeForm = document.getElementById(`schedule${activeTab.charAt(0).toUpperCase() + activeTab.slice(1)}Form`);
        if (activeForm) {
            activeForm.style.display = 'block';
        }
        
        if (activeTab === 'standard') {
            document.getElementById('schedulePickupLocation').value = ride.pickupDisplayLocation || '';
            document.getElementById('scheduleDestination').value = ride.destination || '';
            
            document.querySelectorAll('#scheduleStandardForm .vehicle-option').forEach(option => {
                option.classList.remove('selected');
                if (option.getAttribute('data-type') === ride.rideType) {
                    option.classList.add('selected');
                }
            });
            
            if (ride.packageDetails) {
                document.getElementById('schedulePackageToggle').style.display = 'flex';
                document.getElementById('schedulePackageForm').style.display = 'block';
                document.getElementById('scheduleReceiverName').value = ride.packageDetails.receiverName || '';
                document.getElementById('scheduleReceiverPhone').value = ride.packageDetails.receiverPhone || '';
                document.getElementById('schedulePackageDescription').value = ride.packageDetails.packageDescription || '';
                document.getElementById('scheduleSpecialInstructions').value = ride.packageDetails.specialInstructions || '';
            }
        } else if (activeTab === 'delivery') {
            document.getElementById('scheduleShopName').value = ride.expressDelivery?.shopName || '';
            document.getElementById('scheduleShopLocation').value = ride.pickupDisplayLocation || '';
            document.getElementById('scheduleDeliveryItems').value = ride.expressDelivery?.items || '';
            document.getElementById('scheduleDeliveryDestination').value = ride.destination || '';
        } else if (activeTab === 'someone-else') {
            document.getElementById('scheduleRecipientPickup').value = ride.pickupDisplayLocation || '';
            document.getElementById('scheduleRecipientDestination').value = ride.destination || '';
            document.getElementById('scheduleRecipientName').value = ride.orderForSomeone?.recipientName || '';
            document.getElementById('scheduleRecipientPhone').value = ride.orderForSomeone?.recipientPhone || '';
        }
        
        const scheduledDate = new Date(ride.scheduledTime);
        document.getElementById('scheduleDate').value = scheduledDate.toISOString().split('T')[0];
        document.getElementById('scheduleTime').value = 
            `${scheduledDate.getHours().toString().padStart(2, '0')}:${scheduledDate.getMinutes().toString().padStart(2, '0')}`;
        
        document.getElementById('schedulePaymentMethod').value = ride.paymentMethod || 'wallet';
        
        calculateScheduleFare();
        
        const confirmBtn = document.getElementById('confirmScheduleRideBtn');
        confirmBtn.innerHTML = '<i class="fas fa-save"></i> Update Scheduled Ride';
        confirmBtn.setAttribute('data-edit-ride-id', rideId);
        
        showNotification('Editing scheduled ride. Make your changes and click Update.');
    }, 100);
}

function checkActiveRide(uid) {
    database.ref('rides').orderByChild('passengerId').equalTo(uid).once('value')
        .then(snapshot => {
            const rides = snapshot.val();
            if (rides) {
                for (const rideId in rides) {
                    const ride = rides[rideId];
                    if (ride.status !== 'completed' && ride.status !== 'cancelled') {
                        restoreActiveRide(rideId, ride);
                        break;
                    }
                }
            }
        })
        .catch(error => {
            console.error('Error checking active ride:', error);
        });
}

function restoreActiveRide(rideId, ride) {
    currentRide = {
        id: rideId,
        ...ride
    };
    
    updateUIForActiveRide();
    
    if (ride.status === 'requested') {
        document.getElementById('searchingAnimation').style.display = 'flex';
        document.getElementById('rideStatus').style.display = 'flex';
        document.getElementById('statusDot').className = 'status-dot searching';
        document.getElementById('statusText').textContent = 'Searching for driver';
        
        listenForDriverAssignment(rideId);
    } else if (ride.driverId && (ride.status === 'accepted' || ride.status === 'arrived' || ride.status === 'started' || ride.status === 'picked_up')) {
        handleDriverAssignment(ride);
        updateRideStatusDisplay(ride.status);
        
        if (ride.driverId) {
            trackDriverLocation(ride.driverId);
        }
        
        startDriverMessageListener(rideId);
        
        if (sosConfig && sosConfig.contact1) {
            document.getElementById('sosButton').style.display = 'flex';
        }
        
        if (ride.orderForSomeone || ride.expressDelivery) {
            startLiveTracking(rideId, ride.driverId);
        }
    }
    
    activeRideRestored = true;
    showNotification('Active ride restored');
}

function updateRideStatusDisplay(status) {
    const statusText = document.getElementById('statusText');
    const statusDot = document.getElementById('statusDot');
    const estimatedTime = document.getElementById('estimatedTime');
    
    switch(status) {
        case 'accepted':
            statusText.textContent = 'Driver on the way';
            statusDot.className = 'status-dot arriving';
            estimatedTime.style.display = 'flex';
            break;
        case 'arrived':
            statusText.textContent = 'Driver arrived';
            statusDot.className = 'status-dot riding';
            break;
        case 'started':
            statusText.textContent = 'Trip in progress';
            statusDot.className = 'status-dot riding';
            break;
        case 'picked_up':
            statusText.textContent = 'Trip in progress';
            statusDot.className = 'status-dot riding';
            break;
    }
}

function loadSOSConfig(uid) {
    database.ref('sosConfig/' + uid).once('value')
        .then(snapshot => {
            sosConfig = snapshot.val();
            if (sosConfig) {
                document.getElementById('emergencyContact1').value = sosConfig.contact1 || '';
                document.getElementById('emergencyContact2').value = sosConfig.contact2 || '';
                document.getElementById('sosMessage').value = sosConfig.message || 'I need help! My current location and ride details will be shared with you.';
            }
        })
        .catch(error => {
            console.error('Error loading SOS config:', error);
        });
}

function setupWalletBalanceListener(uid) {
    if (walletBalanceListener) {
        walletBalanceListener();
    }
    
    walletBalanceListener = database.ref('users/' + uid + '/walletBalance').on('value', snapshot => {
        const newBalance = snapshot.val() || 0;
        if (newBalance !== walletBalance) {
            walletBalance = newBalance;
            updateWalletBalanceUI();
        }
    }, error => {
        console.error('Error listening to wallet balance:', error);
    });
}

function updateWalletBalanceUI() {
    document.getElementById('walletBalance').textContent = `K${walletBalance.toFixed(2)}`;
    document.getElementById('accountBalance').textContent = `K${walletBalance.toFixed(2)}`;
    document.getElementById('paymentWalletBalance').textContent = `Balance: K${walletBalance.toFixed(2)}`;
}

// Enhanced Map initialization with city detection
function initializeMap() {
    passengerMap = L.map('map').setView([-15.4167, 28.2833], 13);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(passengerMap);
    
    popupRideMap = L.map('popupRideMap').setView([-15.4167, 28.2833], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(popupRideMap);
    
    addEnhancedMapControls();
    
    refreshPassengerPosition();
}

function addEnhancedMapControls() {
    const scheduleControl = L.control({position: 'topleft'});
    scheduleControl.onAdd = function(map) {
        const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
        div.innerHTML = '<button style="background: var(--primary-orange); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 1.2rem;" title="Schedule a Ride"><i class="fas fa-clock"></i></button>';
        div.onclick = openScheduleRidePopup;
        return div;
    };
    scheduleControl.addTo(passengerMap);
    
    const locationControl = L.control({position: 'topright'});
    locationControl.onAdd = function(map) {
        const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
        div.innerHTML = '<button style="background: var(--info-blue); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 1.2rem;" title="Center on My Location"><i class="fas fa-crosshairs"></i></button>';
        div.onclick = centerMap;
        return div;
    };
    locationControl.addTo(passengerMap);
}

// ULTRA-FAST CITY DETECTION
function determineCurrentCity(lat, lng) {
    return new Promise((resolve, reject) => {
        const boundaryCity = checkCityBoundaries(lat, lng);
        if (boundaryCity) {
            currentCity = boundaryCity;
            updateCityDisplay(currentCity);
            resolve(currentCity);
            return;
        }
        
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1&accept-language=en`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data && data.address) {
                    const detectedCity = extractCityFromAddress(data.address);
                    
                    if (detectedCity && detectedCity !== "Unknown Location") {
                        currentCity = detectedCity;
                        updateCityDisplay(currentCity);
                        resolve(currentCity);
                    } else {
                        const fallbackCity = extractCityFromDisplayName(data.display_name);
                        currentCity = fallbackCity;
                        updateCityDisplay(currentCity);
                        resolve(currentCity);
                    }
                } else {
                    currentCity = null;
                    updateCityDisplay("Unknown");
                    resolve(null);
                }
            })
            .catch(error => {
                console.error('Error in city detection:', error);
                currentCity = null;
                updateCityDisplay("Unknown");
                resolve(null);
            });
    });
}

function checkCityBoundaries(lat, lng) {
    for (const [city, boundary] of Object.entries(cityBoundaries)) {
        const distance = calculateDistance(lat, lng, boundary.lat, boundary.lng);
        if (distance <= boundary.radius) {
            return city;
        }
    }
    return null;
}

function extractCityFromAddress(address) {
    const priorityFields = [
        'city', 'town', 'village', 'municipality', 
        'suburb', 'county', 'state_district', 'state'
    ];
    
    for (const field of priorityFields) {
        if (address[field]) {
            const detectedName = address[field].toString().trim();
            const normalized = normalizeCityName(detectedName);
            if (zambianCities.includes(normalized)) {
                return normalized;
            }
        }
    }
    
    return null;
}

function extractCityFromDisplayName(displayName) {
    if (!displayName) return "Unknown Location";
    
    const nameLower = displayName.toLowerCase();
    
    for (const city of zambianCities) {
        if (nameLower.includes(city.toLowerCase())) {
            return city;
        }
    }
    
    for (const [alias, actualCity] of Object.entries(cityAliases)) {
        if (nameLower.includes(alias)) {
            return actualCity;
        }
    }
    
    return "Unknown Location";
}

function normalizeCityName(cityName) {
    if (!cityName) return "";
    
    const normalized = cityName.toString().trim();
    
    const variations = {
        'lusaka city': 'Lusaka', 'lska': 'Lusaka',
        'kitwe town': 'Kitwe', 'ndola city': 'Ndola',
        'kabwe town': 'Kabwe', 'chipata town': 'Chipata',
        'chingola town': 'Chingola', 'mufulira town': 'Mufulira',
        'luanshya town': 'Luanshya', 'livingstone town': 'Livingstone',
        'kasama town': 'Kasama', 'solwezi town': 'Solwezi',
        'kapiri mposhi town': 'Kapiri Mposhi', 'chililabombwe town': 'Chililabombwe'
    };
    
    return variations[normalized.toLowerCase()] || 
           zambianCities.find(city => city.toLowerCase() === normalized.toLowerCase()) || 
           normalized;
}

function updateCityDisplay(cityName) {
    const cityDisplay = document.getElementById('currentCityDisplay');
    if (cityDisplay) {
        cityDisplay.textContent = cityName;
        if (cityName !== "Detecting..." && cityName !== "Unknown") {
            cityDisplay.style.color = "var(--success-green)";
            cityDisplay.style.fontWeight = "900";
            
            if (currentScreen === 'home') {
                showNotification(`ðŸ“ You're in ${cityName}. Search results will be limited to this city for accuracy.`);
            }
        }
    }
}

function refreshPassengerPosition() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            userLocation = { lat, lng };
            
            passengerMap.setView([lat, lng], 16);
            
            if (currentLocationMarker) {
                currentLocationMarker.setLatLng([lat, lng]);
            } else {
                currentLocationMarker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        className: 'current-location-marker',
                        html: '<div class="current-location-marker"><i class="fas fa-user"></i></div>',
                        iconSize: [18, 18]
                    })
                }).addTo(passengerMap)
                    .bindPopup('Your location');
            }
            
            updatePickupLocation(lat, lng);
            
            determineCurrentCity(lat, lng).then(city => {
                console.log("Final detected city:", city);
                
                if (city && city !== "Unknown") {
                    getAddressForDisplay(lat, lng).then(address => {
                        if (address) {
                            document.getElementById('pickupLocation').value = address;
                        }
                    });
                }
                
                clearSearchCacheForNewCity(city);
            }).catch(error => {
                console.error('City detection failed:', error);
                currentCity = null;
            });
            
            if (!locationWatchId) {
                startLocationTracking();
            }
            
        }, error => {
            console.error('Geolocation error:', error);
            handleGeolocationError(error);
        }, {
            enableHighAccuracy: true,
            timeout: 15000,
            maximumAge: 30000
        });
    } else {
        showNotification('Geolocation is not supported by this browser.');
        currentCity = null;
    }
}

function clearSearchCacheForNewCity(newCity) {
    if (!newCity) return;
    
    const newCache = new Map();
    for (const [key, value] of searchCache.entries()) {
        if (key.includes(newCity)) {
            newCache.set(key, value);
        }
    }
    searchCache = newCache;
}

function getAddressForDisplay(lat, lng) {
    return new Promise((resolve, reject) => {
        if (currentCity) {
            const simpleAddress = `Near ${currentCity}, Zambia`;
            resolve(simpleAddress);
            return;
        }
        
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=16&addressdetails=1&accept-language=en`)
            .then(response => response.json())
            .then(data => {
                if (data && data.display_name) {
                    const formattedAddress = formatAddressForPickup(data.display_name);
                    resolve(formattedAddress);
                } else {
                    resolve(`${lat.toFixed(6)}, ${lng.toFixed(6)}`);
                }
            })
            .catch(error => {
                console.error('Full address geocoding error:', error);
                resolve(`${lat.toFixed(6)}, ${lng.toFixed(6)}`);
            });
    });
}

function formatAddressForPickup(fullAddress) {
    if (!fullAddress) return '';
    
    const parts = fullAddress.split(',');
    
    if (parts.length >= 4) {
        const houseNumberOrInfrastructure = parts[0].trim();
        const road = parts[1] ? parts[1].trim() : '';
        const area = parts[2] ? parts[2].trim() : '';
        const city = parts[3] ? parts[3].trim() : '';
        
        const addressParts = [];
        if (houseNumberOrInfrastructure) addressParts.push(houseNumberOrInfrastructure);
        if (road) addressParts.push(road);
        if (area) addressParts.push(area);
        if (city) addressParts.push(city);
        
        return addressParts.join(', ');
    }
    
    return fullAddress;
}

function handleGeolocationError(error) {
    let errorMessage = 'Unable to refresh location. ';
    
    switch(error.code) {
        case error.PERMISSION_DENIED:
            errorMessage += 'Please enable location services in your browser settings.';
            break;
        case error.POSITION_UNAVAILABLE:
            errorMessage += 'Location information is unavailable.';
            break;
        case error.TIMEOUT:
            errorMessage += 'Location request timed out. Please try again.';
            break;
        default:
            errorMessage += 'Please enable location services.';
    }
    
    if (currentScreen === 'home') {
        showNotification(errorMessage);
    }
    
    currentCity = null;
}

function updatePickupLocation(lat, lng) {
    if (pickupMarker) {
        passengerMap.removeLayer(pickupMarker);
    }
    
    pickupMarker = L.marker([lat, lng], {
        icon: L.divIcon({
            className: 'pickup-marker',
            html: '<div class="pickup-marker"><i class="fas fa-map-marker-alt"></i></div>',
            iconSize: [22, 22]
        })
    }).addTo(passengerMap)
        .bindPopup('Pickup Location');
        
    getAddressForDisplay(lat, lng).then(address => {
        document.getElementById('pickupLocation').value = address;
    });
    
    document.getElementById('pickupLocation').removeAttribute('readonly');
    
    addPickupLocationClearButton();
}

function addPickupLocationClearButton() {
    const pickupInput = document.getElementById('pickupLocation');
    const parent = pickupInput.parentElement;
    
    const existingClear = parent.querySelector('.clear-pickup-btn');
    if (existingClear) {
        existingClear.remove();
    }
    
    const clearBtn = document.createElement('button');
    clearBtn.className = 'clear-pickup-btn';
    clearBtn.innerHTML = '<i class="fas fa-times"></i>';
    clearBtn.style.cssText = `
        background: none;
        border: none;
        color: var(--error-red);
        font-size: 1rem;
        cursor: pointer;
        padding: 0 5px;
    `;
    clearBtn.title = 'Clear pickup location';
    
    clearBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        document.getElementById('pickupLocation').value = '';
        
        if (pickupMarker) {
            passengerMap.removeLayer(pickupMarker);
            pickupMarker = null;
        }
        
        if (userLocation) {
            updatePickupLocation(userLocation.lat, userLocation.lng);
        }
    });
    
    parent.appendChild(clearBtn);
}

// ADVANCED CITY-LOCKED SEARCH FUNCTIONALITY
function searchPlacesEnhanced(query, searchType = 'destination') {
    if (!query || query.length < 2) {
        hideSearchSuggestions(searchType);
        return;
    }
    
    const suggestionsContainer = document.getElementById(`${searchType}Suggestions`);
    
    suggestionsContainer.innerHTML = '<div class="search-loading"><i class="fas fa-spinner fa-spin"></i> Searching...</div>';
    suggestionsContainer.style.display = 'block';
    
    const now = Date.now();
    if (now - lastSearchTime < SEARCH_DEBOUNCE_TIME) {
        setTimeout(() => searchPlacesEnhanced(query, searchType), SEARCH_DEBOUNCE_TIME);
        return;
    }
    lastSearchTime = now;
    
    const cacheKey = `${currentCity}_${query}_${searchType}`;
    if (searchCache.has(cacheKey)) {
        const cachedResult = searchCache.get(cacheKey);
        if (Date.now() - cachedResult.timestamp < CACHE_DURATION) {
            displaySearchResults(cachedResult.results, searchType);
            return;
        }
    }
    
    const commonPlaces = getCommonPlacesSuggestions(query);
    if (commonPlaces.length > 0) {
        displaySearchResults(commonPlaces, searchType);
        searchCache.set(cacheKey, {
            results: commonPlaces,
            timestamp: Date.now()
        });
        return;
    }
    
    performCityLockedSearch(query, searchType)
        .then(results => {
            if (results.length > 0) {
                searchCache.set(cacheKey, {
                    results: results,
                    timestamp: Date.now()
                });
                
                displaySearchResults(results, searchType);
                
                if (results[0].relevanceScore > 8 && results.length === 1) {
                    const inputField = getSearchInputField(searchType);
                    if (inputField && inputField.value === query) {
                        setTimeout(() => {
                            handleSearchResultSelection(results[0], searchType);
                        }, 100);
                    }
                }
            } else {
                showNoResultsMessage(query, searchType);
            }
        })
        .catch(error => {
            console.error('Search error:', error);
            showNoResultsMessage(query, searchType);
        });
}

function getCommonPlacesSuggestions(query) {
    if (!currentCity || !zambianCommonPlaces[currentCity]) {
        return [];
    }
    
    const queryLower = query.toLowerCase();
    const places = zambianCommonPlaces[currentCity];
    
    const exactMatches = places.filter(place => 
        place.toLowerCase().includes(queryLower)
    );
    
    const partialMatches = places.filter(place => {
        const placeLower = place.toLowerCase();
        const queryWords = queryLower.split(' ');
        return queryWords.some(word => 
            word.length > 2 && placeLower.includes(word)
        );
    });
    
    const allMatches = [...new Set([...exactMatches, ...partialMatches])];
    
    return allMatches.map(place => {
        const result = {
            display_name: place,
            name: place,
            type: 'common_place',
            class: 'amenity',
            relevanceScore: 10,
            city: currentCity,
            isCurrentCity: true,
            displayLat: cityBoundaries[currentCity]?.lat || -15.4167,
            displayLon: cityBoundaries[currentCity]?.lng || 28.2833,
            distance: 0
        };
        
        if (userLocation) {
            result.distance = calculateDistance(
                userLocation.lat, userLocation.lng,
                result.displayLat, result.displayLon
            );
        }
        
        return result;
    }).slice(0, 5);
}

function getSearchInputField(searchType) {
    switch(searchType) {
        case 'destination': return document.getElementById('destinationLocation');
        case 'pickup': return document.getElementById('pickupLocation');
        case 'recipientPickup': return document.getElementById('recipientPickupLocation');
        case 'recipientDestination': return document.getElementById('recipientDestinationLocation');
        case 'shopLocation': return document.getElementById('shopLocation');
        case 'deliveryDestination': return document.getElementById('deliveryDestination');
        case 'schedulePickup': return document.getElementById('schedulePickupLocation');
        case 'scheduleDestination': return document.getElementById('scheduleDestination');
        case 'scheduleShop': return document.getElementById('scheduleShopLocation');
        case 'scheduleDeliveryDest': return document.getElementById('scheduleDeliveryDestination');
        case 'scheduleRecipientPickup': return document.getElementById('scheduleRecipientPickup');
        case 'scheduleRecipientDest': return document.getElementById('scheduleRecipientDestination');
        default: return null;
    }
}

function performCityLockedSearch(query, searchType) {
    return new Promise((resolve, reject) => {
        if (!currentCity || currentCity === "Unknown") {
            performUnifiedSearch(query)
                .then(resolve)
                .catch(reject);
            return;
        }
        
        const cityBoundary = cityBoundaries[currentCity];
        let searchQuery = `${query}, ${currentCity}, Zambia`;
        
        const bbox = calculateCityBoundingBox(cityBoundary);
        const bboxStr = `${bbox.minLng},${bbox.minLat},${bbox.maxLng},${bbox.maxLat}`;
        
        const inputField = getSearchInputField(searchType);
        if (inputField) {
            inputField.parentElement.classList.add('searching');
        }
        
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&limit=15&dedupe=1&countrycodes=zm&bounded=1&viewbox=${bboxStr}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Search API error: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (inputField) {
                    inputField.parentElement.classList.remove('searching');
                }
                
                if (data && data.length > 0) {
                    const enhancedResults = data
                        .filter(place => {
                            const distance = calculateDistance(
                                parseFloat(place.lat), parseFloat(place.lon),
                                cityBoundary.lat, cityBoundary.lng
                            );
                            return distance <= cityBoundary.radius * 1.5;
                        })
                        .map(place => {
                            const distance = userLocation ? calculateDistance(
                                userLocation.lat, userLocation.lng,
                                parseFloat(place.lat), parseFloat(place.lon)
                            ) : 0;
                            
                            const placeCity = extractCityFromPlace(place) || currentCity;
                            
                            return {
                                ...place,
                                displayLat: parseFloat(place.lat),
                                displayLon: parseFloat(place.lon),
                                distance,
                                city: placeCity,
                                isCurrentCity: placeCity === currentCity,
                                relevanceScore: calculateRelevanceScore(place, query, placeCity),
                                displayName: formatDisplayName(place.display_name, placeCity)
                            };
                        })
                        .sort((a, b) => {
                            if (b.relevanceScore !== a.relevanceScore) {
                                return b.relevanceScore - a.relevanceScore;
                            }
                            return a.distance - b.distance;
                        });
                    
                    resolve(enhancedResults);
                } else {
                    performUnifiedSearch(query)
                        .then(resolve)
                        .catch(reject);
                }
            })
            .catch(error => {
                if (inputField) {
                    inputField.parentElement.classList.remove('searching');
                }
                console.error('City-locked search error:', error);
                performUnifiedSearch(query)
                    .then(resolve)
                    .catch(reject);
            });
    });
}

function calculateCityBoundingBox(cityBoundary) {
    const radiusKm = cityBoundary.radius / 1000;
    const latDelta = (radiusKm / 111.32);
    const lngDelta = (radiusKm / (111.32 * Math.cos(cityBoundary.lat * Math.PI / 180)));
    
    return {
        minLat: cityBoundary.lat - latDelta,
        maxLat: cityBoundary.lat + latDelta,
        minLng: cityBoundary.lng - lngDelta,
        maxLng: cityBoundary.lng + lngDelta
    };
}

function performUnifiedSearch(query) {
    return new Promise((resolve, reject) => {
        let searchQuery = query;
        if (currentCity && currentCity !== "Unknown") {
            searchQuery = `${query}, ${currentCity}, Zambia`;
        } else {
            searchQuery = `${query}, Zambia`;
        }
        
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&limit=10&dedupe=1&countrycodes=zm`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Search API error: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data && data.length > 0) {
                    const enhancedResults = data
                        .filter(place => place.display_name && place.lat && place.lon)
                        .map(place => {
                            const distance = userLocation ? calculateDistance(
                                userLocation.lat, userLocation.lng,
                                parseFloat(place.lat), parseFloat(place.lon)
                            ) : 0;
                            
                            const placeCity = extractCityFromPlace(place) || currentCity || "Unknown";
                            
                            return {
                                ...place,
                                displayLat: parseFloat(place.lat),
                                displayLon: parseFloat(place.lon),
                                distance,
                                city: placeCity,
                                isCurrentCity: placeCity === currentCity,
                                relevanceScore: calculateRelevanceScore(place, query, placeCity),
                                displayName: formatDisplayName(place.display_name, placeCity)
                            };
                        })
                        .sort((a, b) => {
                            if (b.relevanceScore !== a.relevanceScore) {
                                return b.relevanceScore - a.relevanceScore;
                            }
                            return a.distance - b.distance;
                        });
                    
                    resolve(enhancedResults);
                } else {
                    resolve([]);
                }
            })
            .catch(error => {
                console.error('Unified search error:', error);
                reject(error);
            });
    });
}

function displaySearchResults(results, searchType) {
    const suggestionsContainer = document.getElementById(`${searchType}Suggestions`);
    
    suggestionsContainer.innerHTML = '';
    
    updateSearchResultsCache(results, searchType);
    
    if (results.length === 0) {
        showNoResultsMessage('', searchType);
        return;
    }
    
    const uniqueResults = removeDuplicatePlaces(results).slice(0, 8);
    
    uniqueResults.forEach((result, index) => {
        const suggestionItem = document.createElement('div');
        suggestionItem.className = 'suggestion-item';
        if (index === 0) suggestionItem.classList.add('first-result');
        
        const placeType = getPlaceType(result);
        const placeIcon = getPlaceIcon(placeType);
        
        const cityBadge = result.isCurrentCity ? '' : 
            `<span class="city-badge">${result.city}</span>`;
        
        const distanceText = userLocation && result.distance > 0 ? 
            `${(result.distance / 1000).toFixed(1)} km away` : '';
        
        const displayName = result.displayName || result.display_name;
        
        suggestionItem.innerHTML = `
            <div class="suggestion-icon">${placeIcon}</div>
            <div class="suggestion-details">
                <div class="suggestion-name">
                    ${displayName}
                    ${cityBadge}
                </div>
                <div class="suggestion-address">${getShortAddress(result.display_name)}</div>
                <div class="suggestion-distance">${distanceText}</div>
            </div>
            ${result.isCurrentCity ? '<div class="current-city-indicator">ðŸ“ Current City</div>' : ''}
        `;
        
        suggestionItem.addEventListener('click', function() {
            handleSearchResultSelection(result, searchType);
        });
        
        suggestionsContainer.appendChild(suggestionItem);
    });
    
    suggestionsContainer.style.display = 'block';
}

function handleSearchResultSelection(result, searchType) {
    const inputField = getSearchInputField(searchType);
    
    if (inputField) {
        inputField.value = result.display_name;
    }
    
    hideSearchSuggestions(searchType);
    
    switch(searchType) {
        case 'destination':
            updateFareEstimate();
            updateDestinationMarker(
                result.displayLat, 
                result.displayLon, 
                result.display_name
            );
            
            if (userLocation) {
                drawRoute(userLocation.lat, userLocation.lng, result.displayLat, result.displayLon);
            }
            
            selectedDestination = result;
            document.getElementById('requestRideBtn').disabled = false;
            
            showNotification(`Destination set to ${result.displayName}`);
            break;
            
        case 'pickup':
            updateManualPickupLocation(result.displayLat, result.displayLon, result.display_name);
            showNotification(`Pickup location set to ${result.displayName}`);
            break;
            
        case 'recipientPickup':
            calculateRecipientDeliveryFee();
            updateRecipientPickupMarker(result.displayLat, result.displayLon, result.display_name);
            showNotification(`Recipient pickup set to ${result.displayName}`);
            break;
            
        case 'recipientDestination':
            calculateRecipientDeliveryFee();
            updateRecipientDestinationMarker(result.displayLat, result.displayLon, result.display_name);
            showNotification(`Recipient destination set to ${result.displayName}`);
            break;
            
        case 'shopLocation':
            calculateExpressDeliveryFee();
            updateShopLocationMarker(result.displayLat, result.displayLon, result.display_name);
            showNotification(`Shop location set to ${result.displayName}`);
            break;
            
        case 'deliveryDestination':
            calculateExpressDeliveryFee();
            updateDeliveryDestinationMarker(result.displayLat, result.displayLon, result.display_name);
            showNotification(`Delivery destination set to ${result.displayName}`);
            break;
            
        case 'schedulePickup':
            calculateScheduleFare();
            break;
            
        case 'scheduleDestination':
            calculateScheduleFare();
            break;
            
        case 'scheduleShop':
            calculateScheduleFare();
            break;
            
        case 'scheduleDeliveryDest':
            calculateScheduleFare();
            break;
            
        case 'scheduleRecipientPickup':
            calculateScheduleFare();
            break;
            
        case 'scheduleRecipientDest':
            calculateScheduleFare();
            break;
    }
}

function updateManualPickupLocation(lat, lng, name) {
    if (currentLocationMarker) {
        passengerMap.removeLayer(currentLocationMarker);
        currentLocationMarker = null;
    }
    
    if (pickupMarker) {
        passengerMap.removeLayer(pickupMarker);
    }
    
    pickupMarker = L.marker([lat, lng], {
        icon: L.divIcon({
            className: 'pickup-marker',
            html: '<div class="pickup-marker"><i class="fas fa-map-marker-alt"></i></div>',
            iconSize: [22, 22]
        })
    }).addTo(passengerMap)
        .bindPopup(`<strong>${name}</strong><br>Pickup Location`)
        .openPopup();
    
    userLocation = { lat, lng };
    
    const destination = document.getElementById('destinationLocation').value;
    if (destination) {
        updateFareEstimate();
        
        forwardGeocode(destination).then(results => {
            if (results.length > 0) {
                const destLat = parseFloat(results[0].lat);
                const destLng = parseFloat(results[0].lon);
                drawRoute(lat, lng, destLat, destLng);
            }
        });
    }
    
    passengerMap.setView([lat, lng], 16);
}

function updateSearchResultsCache(results, searchType) {
    switch(searchType) {
        case 'destination': 
            destinationSearchResults = results;
            break;
        case 'pickup':
            pickupSearchResults = results;
            break;
        case 'recipientPickup':
            recipientPickupSearchResults = results;
            break;
        case 'recipientDestination':
            destinationSearchResults = results;
            break;
        case 'shopLocation':
            shopLocationSearchResults = results;
            break;
        case 'deliveryDestination':
            deliveryDestinationSearchResults = results;
            break;
    }
}

function setupSearchInputListeners() {
    const searchConfigs = [
        { type: 'destination', input: 'destinationLocation', suggestions: 'destinationSuggestions' },
        { type: 'pickup', input: 'pickupLocation', suggestions: 'pickupSuggestions' },
        { type: 'recipientPickup', input: 'recipientPickupLocation', suggestions: 'recipientPickupSuggestions' },
        { type: 'recipientDestination', input: 'recipientDestinationLocation', suggestions: 'recipientDestinationSuggestions' },
        { type: 'shopLocation', input: 'shopLocation', suggestions: 'shopLocationSuggestions' },
        { type: 'deliveryDestination', input: 'deliveryDestination', suggestions: 'deliveryDestinationSuggestions' },
        { type: 'schedulePickup', input: 'schedulePickupLocation', suggestions: 'schedulePickupSuggestions' },
        { type: 'scheduleDestination', input: 'scheduleDestination', suggestions: 'scheduleDestinationSuggestions' },
        { type: 'scheduleShop', input: 'scheduleShopLocation', suggestions: 'scheduleShopSuggestions' },
        { type: 'scheduleDeliveryDest', input: 'scheduleDeliveryDestination', suggestions: 'scheduleDeliveryDestSuggestions' },
        { type: 'scheduleRecipientPickup', input: 'scheduleRecipientPickup', suggestions: 'scheduleRecipientPickupSuggestions' },
        { type: 'scheduleRecipientDest', input: 'scheduleRecipientDestination', suggestions: 'scheduleRecipientDestSuggestions' }
    ];
    
    searchConfigs.forEach(config => {
        const inputField = document.getElementById(config.input);
        if (inputField) {
            setupSearchInputListener(config.type, config.input, config.suggestions);
        }
    });
}

function setupSearchInputListener(searchType, inputId, suggestionsId) {
    let lastQuery = '';
    const inputField = document.getElementById(inputId);
    
    inputField.addEventListener('input', function() {
        const query = this.value.trim();
        
        if (window.searchTimeout) {
            clearTimeout(window.searchTimeout);
        }
        
        if (query.length >= 2 && query !== lastQuery) {
            this.parentElement.classList.add('searching');
            
            window.searchTimeout = setTimeout(() => {
                lastQuery = query;
                
                if (currentCity) {
                    searchPlacesEnhanced(query, searchType);
                } else {
                    searchPlacesEnhanced(query, searchType);
                }
                
                this.parentElement.classList.remove('searching');
            }, 300);
        } else if (query.length < 2) {
            hideSearchSuggestions(searchType);
            lastQuery = '';
            inputField.parentElement.classList.remove('searching');
        }
    });
    
    inputField.addEventListener('focus', function() {
        const query = this.value.trim();
        const cachedResults = getCachedSearchResults(searchType);
        
        if (query.length >= 2 && cachedResults.length > 0) {
            displaySearchResults(cachedResults, searchType);
        } else if (query.length >= 2) {
            searchPlacesEnhanced(query, searchType);
        }
    });
    
    inputField.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            hideSearchSuggestions(searchType);
        } else if (e.key === 'Enter') {
            hideSearchSuggestions(searchType);
            const cachedResults = getCachedSearchResults(searchType);
            if (cachedResults.length > 0) {
                handleSearchResultSelection(cachedResults[0], searchType);
            }
        }
    });
    
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.location-input') && !e.target.closest('.suggestion-list')) {
            hideSearchSuggestions(searchType);
        }
    });
}

function hideSearchSuggestions(searchType) {
    const suggestionsContainer = document.getElementById(`${searchType}Suggestions`);
    if (suggestionsContainer) {
        suggestionsContainer.style.display = 'none';
    }
    
    if (window.searchTimeout) {
        clearTimeout(window.searchTimeout);
        window.searchTimeout = null;
    }
}

function showNoResultsMessage(query = '', searchType = 'destination') {
    const suggestionsContainer = document.getElementById(`${searchType}Suggestions`);
    
    if (suggestionsContainer) {
        let message = 'No places found';
        if (currentCity && searchType === 'pickup') {
            message += ` in ${currentCity}`;
        } else if (currentCity) {
            message += ` in ${currentCity}`;
        }
        
        if (query) {
            message += ` for "${query}"`;
        }
        
        suggestionsContainer.innerHTML = `<div class="no-results">${message}</div>`;
    }
}

function calculateRelevanceScore(place, query, city) {
    let score = 0;
    const placeName = place.display_name.toLowerCase();
    const queryLower = query.toLowerCase();
    const cityLower = city.toLowerCase();
    
    if (placeName.includes(queryLower)) {
        score += 10;
    }
    
    const queryWords = queryLower.split(' ');
    queryWords.forEach(word => {
        if (word.length > 2 && placeName.includes(word)) {
            score += 5;
        }
    });
    
    if (city === currentCity) {
        score += 8;
    }
    
    if (place.type === 'administrative' || place.class === 'boundary') {
        score -= 2;
    }
    
    if (place.importance) {
        score += place.importance * 5;
    }
    
    if (userLocation) {
        const distance = calculateDistance(
            userLocation.lat, userLocation.lng,
            parseFloat(place.lat), parseFloat(place.lon)
        );
        if (distance > 50000) {
            score -= 3;
        } else if (distance < 1000) {
            score += 2;
        }
    }
    
    if (place.type === 'common_place') {
        score += 3;
    }
    
    return Math.max(0, score);
}

function extractCityFromPlace(place) {
    if (place.address) {
        return extractCityFromAddress(place.address);
    }
    
    return extractCityFromDisplayName(place.display_name);
}

function formatDisplayName(fullName, city) {
    if (!fullName) return 'Unknown Location';
    
    if (fullName.type === 'common_place') {
        return fullName.name || fullName;
    }
    
    const parts = fullName.split(',');
    const relevantParts = [];
    
    for (let i = 0; i < parts.length; i++) {
        const part = parts[i].trim();
        const partLower = part.toLowerCase();
        
        if (zambianCities.some(c => c.toLowerCase() === partLower) ||
            partLower === 'zambia' ||
            partLower.includes('province')) {
            break;
        }
        
        relevantParts.push(part);
    }
    
    return relevantParts.join(', ') || fullName;
}

function getShortAddress(fullAddress) {
    if (!fullAddress) return '';
    
    if (fullAddress.type === 'common_place') {
        return '';
    }
    
    const parts = fullAddress.split(',');
    return parts.slice(0, Math.min(3, parts.length)).join(', ');
}

function removeDuplicatePlaces(places) {
    const seen = new Set();
    return places.filter(place => {
        const coordKey = `${place.lat}-${place.lon}`;
        const nameKey = place.display_name ? place.display_name.substring(0, 50).toLowerCase() : place.name?.substring(0, 50).toLowerCase() || '';
        const uniqueKey = `${coordKey}-${nameKey}`;
        
        if (seen.has(uniqueKey)) {
            return false;
        }
        seen.add(uniqueKey);
        return true;
    });
}

function getCachedSearchResults(searchType) {
    switch(searchType) {
        case 'destination': return destinationSearchResults;
        case 'pickup': return pickupSearchResults;
        case 'recipientPickup': return recipientPickupSearchResults;
        case 'recipientDestination': return destinationSearchResults;
        case 'shopLocation': return shopLocationSearchResults;
        case 'deliveryDestination': return deliveryDestinationSearchResults;
        default: return [];
    }
}

function getPlaceType(place) {
    if (place.type === 'common_place') {
        return 'place';
    }
    
    if (place.type === 'restaurant' || place.class === 'amenity' && place.type === 'restaurant') {
        return 'restaurant';
    } else if (place.type === 'cafe' || place.class === 'amenity' && place.type === 'cafe') {
        return 'cafe';
    } else if (place.type === 'bar' || place.class === 'amenity' && place.type === 'bar') {
        return 'bar';
    } else if (place.type === 'pub' || place.class === 'amenity' && place.type === 'pub') {
        return 'pub';
    } else if (place.type === 'fast_food' || place.class === 'amenity' && place.type === 'fast_food') {
        return 'fast_food';
    } else if (place.type === 'bank' || place.class === 'amenity' && place.type === 'bank') {
        return 'bank';
    } else if (place.type === 'atm' || place.class === 'amenity' && place.type === 'atm') {
        return 'atm';
    } else if (place.type === 'hospital' || place.class === 'amenity' && place.type === 'hospital') {
        return 'hospital';
    } else if (place.type === 'pharmacy' || place.class === 'amenity' && place.type === 'pharmacy') {
        return 'pharmacy';
    } else if (place.type === 'school' || place.class === 'amenity' && place.type === 'school') {
        return 'school';
    } else if (place.type === 'university' || place.class === 'amenity' && place.type === 'university') {
        return 'university';
    } else if (place.type === 'library' || place.class === 'amenity' && place.type === 'library') {
        return 'library';
    } else if (place.type === 'cinema' || place.class === 'amenity' && place.type === 'cinema') {
        return 'cinema';
    } else if (place.type === 'theatre' || place.class === 'amenity' && place.type === 'theatre') {
        return 'theatre';
    } else if (place.type === 'museum' || place.class === 'amenity' && place.type === 'museum') {
        return 'museum';
    } else if (place.type === 'hotel' || place.class === 'tourism' && place.type === 'hotel') {
        return 'hotel';
    } else if (place.type === 'supermarket' || place.class === 'shop' && place.type === 'supermarket') {
        return 'supermarket';
    } else if (place.type === 'mall' || place.class === 'shop' && place.type === 'mall') {
        return 'mall';
    } else if (place.type === 'clothes' || place.class === 'shop' && place.type === 'clothes') {
        return 'clothes';
    } else if (place.type === 'fuel' || place.class === 'amenity' && place.type === 'fuel') {
        return 'fuel';
    } else if (place.type === 'parking' || place.class === 'amenity' && place.type === 'parking') {
        return 'parking';
    } else if (place.type === 'bus_station' || place.class === 'amenity' && place.type === 'bus_station') {
        return 'bus_station';
    } else if (place.type === 'taxi' || place.class === 'amenity' && place.type === 'taxi') {
        return 'taxi';
    } else if (place.type === 'police' || place.class === 'amenity' && place.type === 'police') {
        return 'police';
    } else if (place.type === 'market' || place.class === 'amenity' && place.type === 'marketplace') {
        return 'market';
    } else if (place.type === 'post_office' || place.class === 'amenity' && place.type === 'post_office') {
        return 'post_office';
    } else if (place.type === 'place_of_worship' || place.class === 'amenity' && place.type === 'place_of_worship') {
        return 'place_of_worship';
    } else if (place.type === 'stadium' || place.class === 'leisure' && place.type === 'stadium') {
        return 'stadium';
    } else if (place.type === 'park' || place.class === 'leisure' && place.type === 'park') {
        return 'park';
    } else if (place.type === 'monument' || place.class === 'historic' && place.type === 'monument') {
        return 'monument';
    } else if (place.type === 'castle' || place.class === 'historic' && place.type === 'castle') {
        return 'castle';
    } else {
        return 'place';
    }
}

function getPlaceIcon(placeType) {
    const icons = {
        'restaurant': 'ðŸ½ï¸',
        'cafe': 'â˜•',
        'bar': 'ðŸº',
        'pub': 'ðŸ»',
        'fast_food': 'ðŸ”',
        'bank': 'ðŸ¦',
        'atm': 'ðŸ’³',
        'hospital': 'ðŸ¥',
        'pharmacy': 'ðŸ’Š',
        'school': 'ðŸ«',
        'university': 'ðŸŽ“',
        'library': 'ðŸ“š',
        'cinema': 'ðŸŽ¬',
        'theatre': 'ðŸŽ­',
        'museum': 'ðŸ›ï¸',
        'hotel': 'ðŸ¨',
        'supermarket': 'ðŸ›’',
        'mall': 'ðŸª',
        'clothes': 'ðŸ‘•',
        'fuel': 'â›½',
        'parking': 'ðŸ…¿ï¸',
        'bus_station': 'ðŸšŒ',
        'taxi': 'ðŸš•',
        'police': 'ðŸ‘®',
        'market': 'ðŸ›ï¸',
        'post_office': 'ðŸ“®',
        'place_of_worship': 'ðŸ›',
        'stadium': 'ðŸŸï¸',
        'park': 'ðŸžï¸',
        'monument': 'ðŸ—½',
        'castle': 'ðŸ°'
    };
    
    return icons[placeType] || 'ðŸ“';
}

function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371e3;
    const Ï†1 = lat1 * Math.PI / 180;
    const Ï†2 = lat2 * Math.PI / 180;
    const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
    const Î”Î» = (lon2 - lon1) * Math.PI / 180;

    const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
              Math.cos(Ï†1) * Math.cos(Ï†2) *
              Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

    return R * c;
}

function forwardGeocode(query) {
    return new Promise(resolve => {
        if (!userLocation) {
            resolve([]);
            return;
        }
        
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=10&countrycodes=zm`)
            .then(response => response.json())
            .then(data => {
                const filteredResults = data.filter(result => {
                    const distance = calculateDistance(
                        userLocation.lat, userLocation.lng,
                        parseFloat(result.lat), parseFloat(result.lon)
                    );
                    return distance <= 50000;
                });
                
                resolve(filteredResults);
            })
            .catch(error => {
                console.error('Forward geocoding error:', error);
                resolve([]);
            });
    });
}

function updateFareEstimate() {
    const destination = document.getElementById('destinationLocation').value;
    
    if (destination.length > 3 && userLocation) {
        forwardGeocode(destination).then(results => {
            if (results.length > 0) {
                const destLat = parseFloat(results[0].lat);
                const destLng = parseFloat(results[0].lon);
                
                const distance = calculateDistance(
                    userLocation.lat, userLocation.lng,
                    destLat, destLng
                );
                
                let baseFare = 23;
                
                if (distance > 0) {
                    baseFare += Math.ceil(distance / 90);
                }
                
                switch(selectedVehicleType) {
                    case 'car':
                        baseFare = baseFare;
                        break;
                    case 'bike':
                        baseFare = baseFare * 0.7;
                        break;
                    case 'bicycle':
                        baseFare = baseFare * 0.5;
                        break;
                }
                
                if (appliedPromoCode) {
                    baseFare = baseFare * 0.8;
                }
                
                document.getElementById('estimatedFare').textContent = `K${baseFare.toFixed(2)}`;
                
                const etaMinutes = Math.ceil((distance / 1000) / 30 * 60);
                document.getElementById('etaDisplay').textContent = `ETA: ${etaMinutes} min`;
                
                document.getElementById('requestRideBtn').disabled = false;
                
                rideFare = baseFare;
            }
        });
    } else {
        document.getElementById('estimatedFare').textContent = 'K0.00';
        document.getElementById('etaDisplay').textContent = 'ETA: -- min';
        document.getElementById('requestRideBtn').disabled = true;
    }
}

function updateDestinationMarker(lat, lng, name) {
    if (destinationMarker) {
        passengerMap.removeLayer(destinationMarker);
    }
    
    destinationMarker = L.marker([lat, lng], {
        icon: L.divIcon({
            className: 'destination-marker',
            html: '<div class="destination-marker"><i class="fas fa-flag"></i></div>',
            iconSize: [22, 22]
        })
    }).addTo(passengerMap)
        .bindPopup(`<strong>${name}</strong><br>Your destination`)
        .openPopup();
    
    if (userLocation) {
        const bounds = L.latLngBounds(
            [userLocation.lat, userLocation.lng],
            [lat, lng]
        );
        passengerMap.fitBounds(bounds, { padding: [12, 12] });
    }
}

function drawRoute(startLat, startLng, endLat, endLng) {
    if (routePolyline) {
        passengerMap.removeLayer(routePolyline);
    }
    
    fetch(`https://router.project-osrm.org/route/v1/driving/${startLng},${startLat};${endLng},${endLat}?overview=full&geometries=geojson`)
        .then(response => response.json())
        .then(data => {
            if (data.routes && data.routes.length > 0) {
                const route = data.routes[0];
                const routeCoordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                
                routePolyline = L.polyline(routeCoordinates, {
                    color: '#FF6B35',
                    weight: 4,
                    opacity: 0.7,
                    dashArray: '8, 8'
                }).addTo(passengerMap);
                
                passengerMap.fitBounds(routePolyline.getBounds(), { padding: [12, 12] });
            }
        })
        .catch(error => {
            console.error('Error fetching route:', error);
            routePolyline = L.polyline([
                [startLat, startLng],
                [endLat, endLng]
            ], {
                color: '#FF6B35',
                weight: 4,
                opacity: 0.7,
                dashArray: '8, 8'
            }).addTo(passengerMap);
        });
}

// ENHANCED SCHEDULE RIDE FUNCTIONALITY
function openScheduleRidePopup() {
    if (!document.getElementById('scheduleRidePopup')) {
        createScheduleRidePopup();
    }
    
    const confirmBtn = document.getElementById('confirmScheduleRideBtn');
    confirmBtn.innerHTML = '<i class="fas fa-calendar-check"></i> Schedule Ride';
    confirmBtn.removeAttribute('data-edit-ride-id');
    
    const now = new Date();
    const tomorrow = new Date(now);
    tomorrow.setDate(tomorrow.getDate() + 1);
    
    document.getElementById('scheduleDate').value = tomorrow.toISOString().split('T')[0];
    document.getElementById('scheduleDate').min = tomorrow.toISOString().split('T')[0];
    
    const timeString = `${(now.getHours() + 1).toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
    document.getElementById('scheduleTime').value = timeString;
    
    document.getElementById('schedulePickupLocation').value = document.getElementById('pickupLocation').value;
    
    document.querySelectorAll('.schedule-form').forEach(form => {
        form.style.display = 'none';
    });
    document.getElementById('scheduleStandardForm').style.display = 'block';
    
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector('.tab-btn[data-tab="standard"]').classList.add('active');
    
    document.querySelectorAll('#scheduleStandardForm .vehicle-option').forEach(option => {
        option.classList.remove('selected');
        if (option.getAttribute('data-type') === 'car') {
            option.classList.add('selected');
        }
    });
    
    document.getElementById('schedulePackageForm').style.display = 'none';
    document.getElementById('schedulePackageToggle').style.display = 'none';
    
    document.getElementById('scheduleDestination').value = '';
    document.getElementById('scheduleShopName').value = '';
    document.getElementById('scheduleShopLocation').value = '';
    document.getElementById('scheduleDeliveryItems').value = '';
    document.getElementById('scheduleDeliveryDestination').value = '';
    document.getElementById('scheduleRecipientPickup').value = '';
    document.getElementById('scheduleRecipientDestination').value = '';
    document.getElementById('scheduleRecipientName').value = '';
    document.getElementById('scheduleRecipientPhone').value = '';
    document.getElementById('scheduleReceiverName').value = '';
    document.getElementById('scheduleReceiverPhone').value = '';
    document.getElementById('schedulePackageDescription').value = '';
    document.getElementById('scheduleSpecialInstructions').value = '';
    
    document.getElementById('schedulePaymentMethod').value = 'wallet';
    
    document.getElementById('scheduleEstimatedFare').textContent = 'K0.00';
    document.getElementById('scheduleEtaDisplay').textContent = 'ETA: -- min';
    
    document.getElementById('scheduleRidePopup').classList.remove('hidden');
}

function createScheduleRidePopup() {
    const schedulePopup = document.createElement('div');
    schedulePopup.id = 'scheduleRidePopup';
    schedulePopup.className = 'popup-overlay hidden';
    schedulePopup.innerHTML = `
        <div class="popup-form" style="max-width: 500px;">
            <div class="popup-header">
                <h2 class="popup-title">
                    <i class="fas fa-clock"></i>
                    Schedule a Ride
                </h2>
                <button class="close-popup" id="closeSchedulePopup">&times;</button>
            </div>
            <div class="popup-content schedule-popup-content">
                <div class="popup-tabs" style="display: flex; gap: 5px; margin-bottom: 15px;">
                    <button class="tab-btn active" data-tab="standard">Standard Ride</button>
                    <button class="tab-btn" data-tab="delivery">Delivery</button>
                    <button class="tab-btn" data-tab="someone-else">For Someone Else</button>
                </div>
                
                <div id="scheduleStandardForm" class="schedule-form active">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="schedulePickupLocation" placeholder="Pickup location" value="">
                        <div class="suggestion-list" id="schedulePickupSuggestions"></div>
                    </div>
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="scheduleDestination" placeholder="Destination">
                        <div class="suggestion-list" id="scheduleDestinationSuggestions"></div>
                    </div>
                    
                    <div class="vehicle-selection">
                        <div class="vehicle-option selected" data-type="car">
                            <i class="fas fa-car vehicle-icon"></i>
                            <span class="vehicle-name">Car</span>
                        </div>
                        <div class="vehicle-option" data-type="bike">
                            <i class="fas fa-motorcycle vehicle-icon"></i>
                            <span class="vehicle-name">Bike</span>
                        </div>
                        <div class="vehicle-option" data-type="bicycle">
                            <i class="fas fa-bicycle vehicle-icon"></i>
                            <span class="vehicle-name">Bicycle</span>
                        </div>
                    </div>
                    
                    <div class="package-toggle" id="schedulePackageToggle" style="display: none; margin-top: 10px;">
                        <i class="fas fa-box"></i>
                        Add Package Details
                    </div>
                    
                    <div class="package-form" id="schedulePackageForm" style="display: none; margin-top: 10px;">
                        <h4 class="section-title" style="font-size: 0.9rem;">Package Details</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="scheduleReceiverName">Receiver Name</label>
                                <input type="text" id="scheduleReceiverName" placeholder="Full name">
                            </div>
                            <div class="form-group">
                                <label for="scheduleReceiverPhone">Receiver Phone</label>
                                <input type="tel" id="scheduleReceiverPhone" placeholder="Phone number">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="schedulePackageDescription">Package Description</label>
                            <input type="text" id="schedulePackageDescription" placeholder="What is being delivered?">
                        </div>
                        <div class="form-group">
                            <label for="scheduleSpecialInstructions">Special Instructions</label>
                            <textarea id="scheduleSpecialInstructions" placeholder="Any special handling instructions?"></textarea>
                        </div>
                    </div>
                </div>
                
                <div id="scheduleDeliveryForm" class="schedule-form" style="display: none;">
                    <div class="input-group">
                        <label for="scheduleShopName">Shop or Restaurant Name</label>
                        <input type="text" id="scheduleShopName" class="input-field" placeholder="Name of shop or restaurant">
                    </div>
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="scheduleShopLocation" placeholder="Shop location">
                        <div class="suggestion-list" id="scheduleShopSuggestions"></div>
                    </div>
                    <div class="input-group">
                        <label for="scheduleDeliveryItems">Items to Purchase</label>
                        <textarea id="scheduleDeliveryItems" class="input-field" placeholder="List of items to be purchased"></textarea>
                    </div>
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="scheduleDeliveryDestination" placeholder="Delivery destination">
                        <div class="suggestion-list" id="scheduleDeliveryDestSuggestions"></div>
                    </div>
                </div>
                
                <div id="scheduleSomeoneElseForm" class="schedule-form" style="display: none;">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="scheduleRecipientPickup" placeholder="Recipient pickup location">
                        <div class="suggestion-list" id="scheduleRecipientPickupSuggestions"></div>
                    </div>
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="scheduleRecipientDestination" placeholder="Recipient destination">
                        <div class="suggestion-list" id="scheduleRecipientDestSuggestions"></div>
                    </div>
                    <div class="input-group">
                        <label for="scheduleRecipientName">Recipient Name</label>
                        <input type="text" id="scheduleRecipientName" class="input-field" placeholder="Full name">
                    </div>
                    <div class="input-group">
                        <label for="scheduleRecipientPhone">Recipient Phone</label>
                        <input type="tel" id="scheduleRecipientPhone" class="input-field" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="scheduling-options">
                    <div class="input-group">
                        <label for="scheduleDate">Date</label>
                        <input type="date" id="scheduleDate" class="input-field" value="" min="">
                    </div>
                    <div class="input-group">
                        <label for="scheduleTime">Time</label>
                        <input type="time" id="scheduleTime" class="input-field" value="">
                    </div>
                    <div class="input-group">
                        <label for="schedulePaymentMethod">Payment Method</label>
                        <select id="schedulePaymentMethod" class="input-field">
                            <option value="wallet">Jubel Wallet</option>
                            <option value="cash">Cash</option>
                            <option value="mobile">Mobile Money</option>
                        </select>
                    </div>
                </div>
                
                <div class="fare-display" style="margin: 20px 0;">
                    <p>Estimated Fare</p>
                    <div class="fare-amount" id="scheduleEstimatedFare">K0.00</div>
                    <p class="eta-display" id="scheduleEtaDisplay">ETA: -- min</p>
                </div>
                
                <button id="confirmScheduleRideBtn" class="request-ride-btn">
                    <i class="fas fa-calendar-check"></i> Schedule Ride
                </button>
                <button id="cancelScheduleBtn" class="btn btn-cancel" style="margin-top: 10px;">
                    Cancel
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(schedulePopup);
    
    document.getElementById('closeSchedulePopup').addEventListener('click', closeSchedulePopup);
    document.getElementById('cancelScheduleBtn').addEventListener('click', closeSchedulePopup);
    document.getElementById('confirmScheduleRideBtn').addEventListener('click', confirmScheduleRide);
    
    document.querySelectorAll('.tab-btn').forEach(tab => {
        tab.addEventListener('click', function() {
            document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.schedule-form').forEach(f => f.style.display = 'none');
            
            this.classList.add('active');
            const tabName = this.getAttribute('data-tab');
            document.getElementById(`schedule${tabName.charAt(0).toUpperCase() + tabName.slice(1)}Form`).style.display = 'block';
            calculateScheduleFare();
        });
    });
    
    document.querySelectorAll('#scheduleStandardForm .vehicle-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('#scheduleStandardForm .vehicle-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            this.classList.add('selected');
            
            const type = this.getAttribute('data-type');
            document.getElementById('schedulePackageToggle').style.display = 
                (type === 'bike' || type === 'bicycle') ? 'flex' : 'none';
                
            calculateScheduleFare();
        });
    });
    
    document.getElementById('schedulePackageToggle').addEventListener('click', function() {
        const packageForm = document.getElementById('schedulePackageForm');
        packageForm.style.display = packageForm.style.display === 'none' ? 'block' : 'none';
    });
    
    const searchFields = [
        { id: 'schedulePickupLocation', type: 'schedulePickup' },
        { id: 'scheduleDestination', type: 'scheduleDestination' },
        { id: 'scheduleShopLocation', type: 'scheduleShop' },
        { id: 'scheduleDeliveryDestination', type: 'scheduleDeliveryDest' },
        { id: 'scheduleRecipientPickup', type: 'scheduleRecipientPickup' },
        { id: 'scheduleRecipientDestination', type: 'scheduleRecipientDest' }
    ];
    
    searchFields.forEach(field => {
        const input = document.getElementById(field.id);
        if (input) {
            input.addEventListener('input', function() {
                if (this.value.length >= 2) {
                    searchPlacesEnhanced(this.value, field.type);
                }
                calculateScheduleFare();
            });
            
            input.addEventListener('focus', function() {
                if (this.value.length >= 2) {
                    searchPlacesEnhanced(this.value, field.type);
                }
            });
        }
    });
    
    document.getElementById('scheduleDate').addEventListener('change', calculateScheduleFare);
    document.getElementById('scheduleTime').addEventListener('change', calculateScheduleFare);
    document.getElementById('schedulePaymentMethod').addEventListener('change', calculateScheduleFare);
    
    document.getElementById('scheduleShopName').addEventListener('input', calculateScheduleFare);
    document.getElementById('scheduleDeliveryItems').addEventListener('input', calculateScheduleFare);
    document.getElementById('scheduleRecipientName').addEventListener('input', calculateScheduleFare);
    document.getElementById('scheduleRecipientPhone').addEventListener('input', calculateScheduleFare);
    document.getElementById('scheduleReceiverName').addEventListener('input', calculateScheduleFare);
    document.getElementById('scheduleReceiverPhone').addEventListener('input', calculateScheduleFare);
    document.getElementById('schedulePackageDescription').addEventListener('input', calculateScheduleFare);
    document.getElementById('scheduleSpecialInstructions').addEventListener('input', calculateScheduleFare);
}

function calculateScheduleFare() {
    const activeTab = document.querySelector('.tab-btn.active').getAttribute('data-tab');
    let pickupLocation = '', destination = '';
    
    switch(activeTab) {
        case 'standard':
            pickupLocation = document.getElementById('schedulePickupLocation').value;
            destination = document.getElementById('scheduleDestination').value;
            break;
        case 'delivery':
            pickupLocation = document.getElementById('scheduleShopLocation').value;
            destination = document.getElementById('scheduleDeliveryDestination').value;
            break;
        case 'someone-else':
            pickupLocation = document.getElementById('scheduleRecipientPickup').value;
            destination = document.getElementById('scheduleRecipientDestination').value;
            break;
    }
    
    if (pickupLocation && destination) {
        Promise.all([
            forwardGeocode(pickupLocation),
            forwardGeocode(destination)
        ]).then(([pickupResults, destResults]) => {
            if (pickupResults.length > 0 && destResults.length > 0) {
                const pickupLat = parseFloat(pickupResults[0].lat);
                const pickupLng = parseFloat(pickupResults[0].lon);
                const destLat = parseFloat(destResults[0].lat);
                const destLng = parseFloat(destResults[0].lon);
                
                const distance = calculateDistance(pickupLat, pickupLng, destLat, destLng);
                
                let baseFare = 23;
                if (distance > 0) {
                    baseFare += Math.ceil(distance / 90);
                }
                
                if (activeTab === 'standard') {
                    const vehicleType = document.querySelector('#scheduleStandardForm .vehicle-option.selected').getAttribute('data-type');
                    switch(vehicleType) {
                        case 'bike': baseFare *= 0.7; break;
                        case 'bicycle': baseFare *= 0.5; break;
                    }
                } else if (activeTab === 'delivery') {
                    baseFare *= 0.7;
                }
                
                baseFare *= 1.1;
                
                document.getElementById('scheduleEstimatedFare').textContent = `K${baseFare.toFixed(2)}`;
                
                const etaMinutes = Math.ceil((distance / 1000) / 30 * 60);
                document.getElementById('scheduleEtaDisplay').textContent = `ETA: ${etaMinutes} min`;
                
                return { baseFare, distance, pickupResults, destResults };
            }
        }).then(result => {
            if (result) {
                updateScheduleMapPreview(result.pickupResults[0], result.destResults[0]);
            }
        });
    } else {
        document.getElementById('scheduleEstimatedFare').textContent = 'K0.00';
        document.getElementById('scheduleEtaDisplay').textContent = 'ETA: -- min';
    }
}

function updateScheduleMapPreview(pickupResult, destResult) {
    console.log('Schedule preview:', {
        pickup: { lat: pickupResult.lat, lng: pickupResult.lon, name: pickupResult.display_name },
        destination: { lat: destResult.lat, lng: destResult.lon, name: destResult.display_name }
    });
}

function confirmScheduleRide() {
    const activeTab = document.querySelector('.tab-btn.active').getAttribute('data-tab');
    const date = document.getElementById('scheduleDate').value;
    const time = document.getElementById('scheduleTime').value;
    const paymentMethod = document.getElementById('schedulePaymentMethod').value;
    const confirmBtn = document.getElementById('confirmScheduleRideBtn');
    const isEditMode = confirmBtn.hasAttribute('data-edit-ride-id');
    const editRideId = isEditMode ? confirmBtn.getAttribute('data-edit-ride-id') : null;
    
    if (!date || !time) {
        showNotification('Please select date and time for scheduling.');
        return;
    }
    
    const scheduledDateTime = new Date(`${date}T${time}`);
    if (scheduledDateTime <= new Date()) {
        showNotification('Please select a future date and time.');
        return;
    }
    
    const minTime = new Date(Date.now() + 30 * 60 * 1000);
    if (scheduledDateTime < minTime) {
        showNotification('Please schedule at least 30 minutes in advance.');
        return;
    }
    
    let rideData = {
        passengerId: currentUser.uid,
        passengerName: userData.name || 'Passenger',
        passengerPhone: userData.phone || 'Not provided',
        scheduledTime: scheduledDateTime.getTime(),
        paymentMethod: paymentMethod,
        status: 'scheduled',
        createdAt: firebase.database.ServerValue.TIMESTAMP,
        currentCity: currentCity,
        updatedAt: firebase.database.ServerValue.TIMESTAMP
    };
    
    Promise.resolve().then(() => {
        switch(activeTab) {
            case 'standard':
                return getStandardScheduleData(rideData);
            case 'delivery':
                return getDeliveryScheduleData(rideData);
            case 'someone-else':
                return getSomeoneElseScheduleData(rideData);
        }
    }).then(completeRideData => {
        if (isEditMode && editRideId) {
            completeRideData.id = editRideId;
            
            database.ref('scheduledRides/' + editRideId).update(completeRideData)
                .then(() => {
                    showNotification('Scheduled ride updated successfully!');
                    closeSchedulePopup();
                    
                    const index = scheduledRides.findIndex(r => r.id === editRideId);
                    if (index !== -1) {
                        scheduledRides[index] = completeRideData;
                    }
                    
                    if (scheduledRideTimers[editRideId]) {
                        clearTimeout(scheduledRideTimers[editRideId]);
                        delete scheduledRideTimers[editRideId];
                    }
                    scheduleRideTimer(completeRideData);
                    
                    updateScheduledRidesUI();
                })
                .catch(error => {
                    console.error('Error updating scheduled ride:', error);
                    showNotification('Error updating scheduled ride. Please try again.');
                });
        } else {
            const scheduleId = database.ref().child('scheduledRides').push().key;
            completeRideData.id = scheduleId;
            
            database.ref('scheduledRides/' + scheduleId).set(completeRideData)
                .then(() => {
                    showNotification('Ride scheduled successfully!');
                    closeSchedulePopup();
                    
                    scheduledRides.push(completeRideData);
                    
                    scheduleRideTimer(completeRideData);
                    
                    updateScheduledRidesUI();
                })
                .catch(error => {
                    console.error('Error scheduling ride:', error);
                    showNotification('Error scheduling ride. Please check locations and try again.');
                });
        }
    }).catch(error => {
        console.error('Error in schedule process:', error);
        showNotification('Error processing schedule. Please check locations and try again.');
    });
}

async function getStandardScheduleData(baseData) {
    const pickupLocation = document.getElementById('schedulePickupLocation').value;
    const destination = document.getElementById('scheduleDestination').value;
    const vehicleType = document.querySelector('#scheduleStandardForm .vehicle-option.selected').getAttribute('data-type');
    
    if (!pickupLocation || !destination) {
        throw new Error('Pickup and destination locations are required');
    }
    
    const [pickupResults, destResults] = await Promise.all([
        forwardGeocode(pickupLocation),
        forwardGeocode(destination)
    ]);
    
    if (pickupResults.length === 0 || destResults.length === 0) {
        throw new Error('Invalid locations. Please select valid pickup and destination addresses.');
    }
    
    const pickupLat = parseFloat(pickupResults[0].lat);
    const pickupLng = parseFloat(pickupResults[0].lon);
    const destLat = parseFloat(destResults[0].lat);
    const destLng = parseFloat(destResults[0].lon);
    
    const distance = calculateDistance(pickupLat, pickupLng, destLat, destLng);
    let fare = 23 + Math.ceil(distance / 90);
    
    switch(vehicleType) {
        case 'bike': fare *= 0.7; break;
        case 'bicycle': fare *= 0.5; break;
    }
    
    fare *= 1.1;
    
    const rideData = {
        ...baseData,
        pickupLocation: pickupResults[0].display_name,
        pickupDisplayLocation: pickupLocation,
        destination: destResults[0].display_name,
        pickupLat: pickupLat,
        pickupLng: pickupLng,
        destLat: destLat,
        destLng: destLng,
        rideType: vehicleType,
        fare: fare,
        distance: (distance / 1000).toFixed(2) + ' km',
        scheduleType: 'standard'
    };
    
    const packageForm = document.getElementById('schedulePackageForm');
    if (packageForm.style.display !== 'none' && (vehicleType === 'bike' || vehicleType === 'bicycle')) {
        rideData.packageDetails = {
            receiverName: document.getElementById('scheduleReceiverName').value,
            receiverPhone: document.getElementById('scheduleReceiverPhone').value,
            packageDescription: document.getElementById('schedulePackageDescription').value,
            specialInstructions: document.getElementById('scheduleSpecialInstructions').value
        };
    }
    
    return rideData;
}

async function getDeliveryScheduleData(baseData) {
    const shopName = document.getElementById('scheduleShopName').value;
    const shopLocation = document.getElementById('scheduleShopLocation').value;
    const deliveryItems = document.getElementById('scheduleDeliveryItems').value;
    const destination = document.getElementById('scheduleDeliveryDestination').value;
    
    if (!shopLocation || !destination) {
        throw new Error('Shop location and delivery destination are required');
    }
    
    const [shopResults, destResults] = await Promise.all([
        forwardGeocode(shopLocation),
        forwardGeocode(destination)
    ]);
    
    if (shopResults.length === 0 || destResults.length === 0) {
        throw new Error('Invalid locations. Please select valid shop and destination addresses.');
    }
    
    const shopLat = parseFloat(shopResults[0].lat);
    const shopLng = parseFloat(shopResults[0].lon);
    const destLat = parseFloat(destResults[0].lat);
    const destLng = parseFloat(destResults[0].lon);
    
    const distance = calculateDistance(shopLat, shopLng, destLat, destLng);
    let fare = 23 + Math.ceil(distance / 90);
    
    fare = fare * 0.7 * 1.1;
    
    return {
        ...baseData,
        pickupLocation: shopResults[0].display_name,
        pickupDisplayLocation: shopLocation,
        destination: destResults[0].display_name,
        pickupLat: shopLat,
        pickupLng: shopLng,
        destLat: destLat,
        destLng: destLng,
        rideType: 'bike',
        fare: fare,
        distance: (distance / 1000).toFixed(2) + ' km',
        scheduleType: 'delivery',
        expressDelivery: {
            shopName: shopName,
            items: deliveryItems
        }
    };
}

async function getSomeoneElseScheduleData(baseData) {
    const recipientPickup = document.getElementById('scheduleRecipientPickup').value;
    const recipientDestination = document.getElementById('scheduleRecipientDestination').value;
    const recipientName = document.getElementById('scheduleRecipientName').value;
    const recipientPhone = document.getElementById('scheduleRecipientPhone').value;
    
    if (!recipientPickup || !recipientDestination || !recipientName) {
        throw new Error('Recipient pickup, destination, and name are required');
    }
    
    const [pickupResults, destResults] = await Promise.all([
        forwardGeocode(recipientPickup),
        forwardGeocode(recipientDestination)
    ]);
    
    if (pickupResults.length === 0 || destResults.length === 0) {
        throw new Error('Invalid locations. Please select valid pickup and destination addresses.');
    }
    
    const pickupLat = parseFloat(pickupResults[0].lat);
    const pickupLng = parseFloat(pickupResults[0].lon);
    const destLat = parseFloat(destResults[0].lat);
    const destLng = parseFloat(destResults[0].lon);
    
    const distance = calculateDistance(pickupLat, pickupLng, destLat, destLng);
    let fare = 23 + Math.ceil(distance / 90);
    
    fare *= 1.1;
    
    return {
        ...baseData,
        pickupLocation: pickupResults[0].display_name,
        pickupDisplayLocation: recipientPickup,
        destination: destResults[0].display_name,
        pickupLat: pickupLat,
        pickupLng: pickupLng,
        destLat: destLat,
        destLng: destLng,
        rideType: 'car',
        fare: fare,
        distance: (distance / 1000).toFixed(2) + ' km',
        scheduleType: 'someone-else',
        orderForSomeone: {
            recipientName: recipientName,
            recipientPhone: recipientPhone,
            orderedBy: userData.name || 'Passenger'
        }
    };
}

function closeSchedulePopup() {
    document.getElementById('scheduleRidePopup').classList.add('hidden');
}

// Request Ride Functionality
function requestRide() {
    const pickupLocation = document.getElementById('pickupLocation').value;
    const destinationLocation = document.getElementById('destinationLocation').value;
    
    if (!destinationLocation) {
        showNotification('Please enter a destination');
        return;
    }
    
    if (!currentLocationMarker && !pickupMarker) {
        showNotification('Unable to determine your location. Please try again.');
        return;
    }
    
    const pickupLatLng = pickupMarker ? pickupMarker.getLatLng() : currentLocationMarker.getLatLng();
    
    if (document.getElementById('packageForm').classList.contains('active')) {
        packageDetails = {
            receiverName: document.getElementById('receiverName').value,
            receiverPhone: document.getElementById('receiverPhone').value,
            packageDescription: document.getElementById('packageDescription').value,
            specialInstructions: document.getElementById('specialInstructions').value,
            packageValue: document.getElementById('packageValue').value
        };
    } else {
        packageDetails = null;
    }
    
    Promise.all([
        getFullAddress(pickupLatLng.lat, pickupLatLng.lng),
        forwardGeocode(destinationLocation)
    ]).then(([fullPickupAddress, destinationResults]) => {
        if (destinationResults.length === 0) {
            showNotification('Invalid destination address. Please select a valid destination.');
            return;
        }
        
        const destLat = parseFloat(destinationResults[0].lat);
        const destLng = parseFloat(destinationResults[0].lon);
        
        const distance = calculateDistance(
            pickupLatLng.lat, pickupLatLng.lng,
            destLat, destLng
        );
        
        let baseFare = 23;
        
        if (distance > 0) {
            baseFare += Math.ceil(distance / 90);
        }
        
        switch(selectedVehicleType) {
            case 'car':
                baseFare = baseFare;
                break;
            case 'bike':
                baseFare = baseFare * 0.7;
                break;
            case 'bicycle':
                baseFare = baseFare * 0.5;
                break;
        }
        
        if (appliedPromoCode) {
            baseFare = baseFare * 0.8;
        }
        
        const rideId = database.ref().child('rides').push().key;
        
        const rideRequest = {
            id: rideId,
            passengerId: currentUser.uid,
            passengerName: userData.name || 'Passenger',
            passengerPhone: userData.phone || 'Not provided',
            pickupLocation: fullPickupAddress,
            pickupDisplayLocation: pickupLocation,
            destination: destinationLocation,
            pickupLat: pickupLatLng.lat,
            pickupLng: pickupLatLng.lng,
            destLat: destLat,
            destLng: destLng,
            rideType: selectedVehicleType,
            fare: baseFare,
            distance: (distance / 1000).toFixed(2) + ' km',
            status: 'requested',
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            updatedAt: firebase.database.ServerValue.TIMESTAMP,
            promoCode: appliedPromoCode,
            paymentMethod: selectedPaymentType,
            packageDetails: packageDetails,
            currentCity: currentCity
        };
    
        currentRideRequestData = rideRequest;
        currentRideRequestType = 'standard';
        
        showPaymentSelection(baseFare);
    }).catch(error => {
        console.error('Error in ride request process:', error);
        showNotification('Error calculating route. Please try again.');
    });
}

function getFullAddress(lat, lng) {
    return new Promise((resolve, reject) => {
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=16&addressdetails=1&accept-language=en`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Full address geocoding error: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data && data.display_name) {
                    const formattedAddress = formatAddressForPickup(data.display_name);
                    resolve(formattedAddress);
                } else {
                    resolve(`${lat.toFixed(6)}, ${lng.toFixed(6)}`);
                }
            })
            .catch(error => {
                console.error('Full address geocoding error:', error);
                resolve(`${lat.toFixed(6)}, ${lng.toFixed(6)}`);
            });
    });
}

function showPaymentSelection(fare = null) {
    const calculatedFare = fare || rideFare;
    
    document.getElementById('paymentWalletBalance').textContent = `Balance: K${walletBalance.toFixed(2)}`;
    
    if (selectedPaymentType === 'wallet' && walletBalance < calculatedFare) {
        document.getElementById('insufficientBalance').style.display = 'block';
        document.getElementById('confirmPaymentBtn').disabled = true;
    } else {
        document.getElementById('insufficientBalance').style.display = 'none';
        document.getElementById('confirmPaymentBtn').disabled = false;
    }
    
    document.getElementById('paymentSelectionPopup').classList.remove('hidden');
}

function closePaymentSelection() {
    document.getElementById('paymentSelectionPopup').classList.add('hidden');
}

function submitRideRequest() {
    if (!currentRideRequestData) {
        showNotification('No ride request data found. Please try again.');
        return;
    }
    
    const rideRequest = currentRideRequestData;
    
    if (selectedPaymentType === 'wallet') {
        const newBalance = walletBalance - rideRequest.fare;
        
        database.ref('users/' + currentUser.uid).update({
            walletBalance: newBalance
        })
        .then(() => {
            walletBalance = newBalance;
            updateWalletBalanceUI();
            
            return database.ref('rides/' + rideRequest.id).set(rideRequest);
        })
        .then(() => {
            currentRide = rideRequest;
            
            closePaymentSelection();
            
            updateUIForActiveRide();
            
            document.getElementById('searchingAnimation').style.display = 'flex';
            
            document.getElementById('rideStatus').style.display = 'flex';
            document.getElementById('statusDot').className = 'status-dot searching';
            document.getElementById('statusText').textContent = 'Searching for driver';
            
            if (sosConfig && sosConfig.contact1) {
                document.getElementById('sosButton').style.display = 'flex';
            }
            
            showNotification('Ride requested. Searching for a driver...');
            
            listenForDriverAssignment(rideRequest.id);
            
            if (rideRequest.orderForSomeone || rideRequest.expressDelivery) {
                setupLiveTracking(rideRequest.id);
            }
        })
        .catch(error => {
            console.error('Error requesting ride:', error);
            showNotification('Error requesting ride. Please try again.');
        });
    } else {
        database.ref('rides/' + rideRequest.id).set(rideRequest)
            .then(() => {
                currentRide = rideRequest;
                
                closePaymentSelection();
                
                updateUIForActiveRide();
                
                document.getElementById('searchingAnimation').style.display = 'flex';
                
                document.getElementById('rideStatus').style.display = 'flex';
                document.getElementById('statusDot').className = 'status-dot searching';
                document.getElementById('statusText').textContent = 'Searching for driver';
                
                if (sosConfig && sosConfig.contact1) {
                    document.getElementById('sosButton').style.display = 'flex';
                }
                
                showNotification('Ride requested. Searching for a driver...');
                
                listenForDriverAssignment(rideRequest.id);
                
                if (rideRequest.orderForSomeone || rideRequest.expressDelivery) {
                    setupLiveTracking(rideRequest.id);
                }
            })
            .catch(error => {
                console.error('Error requesting ride:', error);
                showNotification('Error requesting ride. Please try again.');
            });
    }
    
    currentRideRequestData = null;
}

function updateUIForActiveRide() {
    document.getElementById('rideRequestForm').style.display = 'none';
    
    document.getElementById('rideInfoPanel').style.display = 'block';
    
    document.getElementById('currentPickupLocation').textContent = currentRide.pickupDisplayLocation || currentRide.pickupLocation;
    document.getElementById('currentDestinationLocation').textContent = currentRide.destination;
    
    const baseFare = currentRide.fare;
    const discount = appliedPromoCode ? baseFare * 0.2 : 0;
    const totalFare = baseFare - discount;
    
    document.getElementById('baseFare').textContent = `K${baseFare.toFixed(2)}`;
    document.getElementById('discountFare').textContent = `-K${discount.toFixed(2)}`;
    document.getElementById('totalFare').textContent = `K${totalFare.toFixed(2)}`;
    
    addShareAndTrackingButtons();
}

function addShareAndTrackingButtons() {
    const rideActions = document.querySelector('.ride-actions');
    
    const existingShareBtn = document.getElementById('shareRideBtn');
    const existingTrackingBtn = document.getElementById('shareTrackingBtn');
    if (existingShareBtn) existingShareBtn.remove();
    if (existingTrackingBtn) existingTrackingBtn.remove();
    
    const shareBtn = document.createElement('button');
    shareBtn.id = 'shareRideBtn';
    shareBtn.className = 'btn btn-contact';
    shareBtn.innerHTML = '<i class="fas fa-share-alt"></i> Share Ride';
    shareBtn.addEventListener('click', shareRideDetails);
    rideActions.insertBefore(shareBtn, rideActions.firstChild);
    
    if (currentRide.orderForSomeone || currentRide.expressDelivery || currentRide.packageDetails) {
        const trackingBtn = document.createElement('button');
        trackingBtn.id = 'shareTrackingBtn';
        trackingBtn.className = 'btn btn-primary';
        trackingBtn.innerHTML = '<i class="fas fa-map-marker-alt"></i> Share Tracking';
        trackingBtn.addEventListener('click', shareLiveTracking);
        rideActions.insertBefore(trackingBtn, rideActions.firstChild);
    }
}

function shareRideDetails() {
    if (!currentRide) {
        showNotification('No active ride to share.');
        return;
    }
    
    const rideDetails = {
        pickup: currentRide.pickupDisplayLocation || currentRide.pickupLocation,
        destination: currentRide.destination,
        fare: `K${currentRide.fare.toFixed(2)}`,
        distance: currentRide.distance,
        rideType: currentRide.rideType,
        status: currentRide.status
    };
    
    const shareText = `My Jubel Ride Details:
ðŸš— From: ${rideDetails.pickup}
ðŸ“ To: ${rideDetails.destination}
ðŸ’° Fare: ${rideDetails.fare}
ðŸ“ Distance: ${rideDetails.distance}
ðŸš˜ Type: ${rideDetails.rideType}
ðŸ“± Status: ${getStatusText(rideDetails.status)}`;
    
    if (navigator.share) {
        navigator.share({
            title: 'My Jubel Ride',
            text: shareText,
            url: window.location.href
        })
        .then(() => showNotification('Ride details shared!'))
        .catch(error => console.error('Error sharing:', error));
    } else {
        navigator.clipboard.writeText(shareText)
            .then(() => showNotification('Ride details copied to clipboard!'))
            .catch(() => {
                const textArea = document.createElement('textarea');
                textArea.value = shareText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showNotification('Ride details copied to clipboard!');
            });
    }
}

function setupLiveTracking(rideId) {
    const trackingId = generateTrackingId();
    
    const trackingData = {
        rideId: rideId,
        passengerId: currentUser.uid,
        createdAt: firebase.database.ServerValue.TIMESTAMP,
        isActive: true,
        sharedWith: []
    };
    
    database.ref('liveTracking/' + trackingId).set(trackingData)
        .then(() => {
            sharedRideLinks[rideId] = {
                trackingId: trackingId,
                shareUrl: `${window.location.origin}/tracking.html?id=${trackingId}`
            };
            
            showNotification('Live tracking is now active for this ride.');
        })
        .catch(error => {
            console.error('Error setting up live tracking:', error);
        });
}

function shareLiveTracking() {
    if (!currentRide) {
        showNotification('No active ride to track.');
        return;
    }
    
    const trackingInfo = sharedRideLinks[currentRide.id];
    if (!trackingInfo) {
        showNotification('Live tracking not available for this ride.');
        return;
    }
    
    const shareText = `Track my Jubel ride in real-time: ${trackingInfo.shareUrl}`;
    
    if (navigator.share) {
        navigator.share({
            title: 'Track My Jubel Ride',
            text: 'You can track my ride in real-time using this link:',
            url: trackingInfo.shareUrl
        })
        .then(() => showNotification('Tracking link shared!'))
        .catch(error => console.error('Error sharing:', error));
    } else {
        navigator.clipboard.writeText(shareText)
            .then(() => showNotification('Tracking link copied to clipboard!'))
            .catch(() => {
                const textArea = document.createElement('textarea');
                textArea.value = shareText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showNotification('Tracking link copied to clipboard!');
            });
    }
}

function startLiveTracking(rideId, driverId) {
    if (!sharedRideLinks[rideId]) {
        return;
    }
    
    const trackingId = sharedRideLinks[rideId].trackingId;
    
    liveTrackingListeners[rideId] = database.ref('driverLocations/' + driverId).on('value', snapshot => {
        const location = snapshot.val();
        if (location) {
            database.ref('liveTracking/' + trackingId + '/driverLocation').set({
                lat: location.latitude,
                lng: location.longitude,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
        }
    });
    
    database.ref('rides/' + rideId).on('value', snapshot => {
        const ride = snapshot.val();
        if (ride) {
            database.ref('liveTracking/' + trackingId + '/rideStatus').set({
                status: ride.status,
                updatedAt: firebase.database.ServerValue.TIMESTAMP
            });
        }
    });
}

function generateTrackingId() {
    return 'track_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now().toString(36);
}

function listenForDriverAssignment(rideId) {
    if (driverAssignmentListener) {
        driverAssignmentListener();
    }
    
    driverAssignmentListener = database.ref('rides/' + rideId).on('value', snapshot => {
        const ride = snapshot.val();
        if (!ride) {
            showNotification('Ride not found. Please try again.');
            return;
        }
        
        console.log('Ride status update:', ride.status, ride.driverId);
        
        if (ride.driverId && ride.status === 'accepted') {
            handleDriverAssignment(ride);
        } else if (ride.status === 'completed') {
            showRideCompletion(ride);
        } else if (ride.status === 'cancelled') {
            handleRideCancellation(ride);
        } else if (ride.status === 'arrived') {
            showNotification('Your driver has arrived at the pickup location.');
        } else if (ride.status === 'picked_up') {
            showNotification('You have been picked up. Enjoy your ride!');
        } else if (ride.status === 'started') {
            showNotification('Your trip has started.');
        }
    }, error => {
        console.error('Error listening for driver assignment:', error);
        showNotification('Connection error. Please check your internet connection.');
    });
}

function handleDriverAssignment(ride) {
    document.getElementById('searchingAnimation').style.display = 'none';
    
    document.getElementById('statusDot').className = 'status-dot arriving';
    document.getElementById('statusText').textContent = 'Driver arriving';
    
    document.getElementById('estimatedTime').style.display = 'flex';
    document.getElementById('timeText').textContent = '5 min';
    
    database.ref('users/' + ride.driverId).once('value')
        .then(driverSnapshot => {
            const driver = driverSnapshot.val();
            if (driver) {
                document.getElementById('driverName').textContent = driver.name || 'Driver';
                document.getElementById('driverPhone').textContent = driver.phone || 'N/A';
                document.getElementById('driverRating').textContent = driver.rating || '4.5';
                
                if (driver.vehicle) {
                    document.getElementById('vehicleDetails').textContent = 
                        `${driver.vehicle.type || 'Vehicle'} - ${driver.vehicle.licensePlate || 'ABC123'}`;
                }
                
                updateDriverAvatarWithImage(driver, ride);
                updateDriverVehicleDisplay(driver, ride);
                updateDriverDetailsCard(driver);
                addChatWithDriverButton(ride.id, driver);
                addDriverMarker(ride.driverLat, ride.driverLng);
                drawRoute(ride.driverLat, ride.driverLng, ride.pickupLat, ride.pickupLng);
                trackDriverLocation(ride.driverId);
                
                showNotification(`Driver ${driver.name} is on the way!`);
                
                startDriverMessageListener(ride.id);
                
                if (ride.orderForSomeone || ride.expressDelivery) {
                    startLiveTracking(ride.id, ride.driverId);
                }
            }
        });
    
    listenForRideStatusUpdates(ride.id);
}

function updateDriverAvatarWithImage(driver, ride) {
    const driverAvatar = document.getElementById('driverAvatar');
    
    if (ride.driverProfileImage) {
        driverProfileImage = ride.driverProfileImage;
        driverAvatar.innerHTML = `<img src="${driverProfileImage}" class="driver-profile-image" alt="Driver" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
        driverAvatar.style.width = '50px';
        driverAvatar.style.height = '50px';
        driverAvatar.style.fontSize = '1.2rem';
    } else if (driver.images && driver.images.profilePhoto) {
        driverProfileImage = driver.images.profilePhoto;
        driverAvatar.innerHTML = `<img src="${driverProfileImage}" class="driver-profile-image" alt="Driver" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
        driverAvatar.style.width = '50px';
        driverAvatar.style.height = '50px';
        driverAvatar.style.fontSize = '1.2rem';
    } else if (driver.name) {
        driverAvatar.innerHTML = driver.name.charAt(0).toUpperCase();
        driverAvatar.style.width = '50px';
        driverAvatar.style.height = '50px';
        driverAvatar.style.fontSize = '1.5rem';
    } else {
        driverAvatar.innerHTML = '<i class="fas fa-user"></i>';
        driverAvatar.style.width = '50px';
        driverAvatar.style.height = '50px';
        driverAvatar.style.fontSize = '1.2rem';
    }
}

function updateDriverVehicleDisplay(driver, ride) {
    const vehicleImageSection = document.getElementById('vehicleImageSection');
    
    if (!vehicleImageSection) {
        const driverDetailsCard = document.getElementById('driverDetailsCard');
        const vehicleSection = document.createElement('div');
        vehicleSection.id = 'vehicleImageSection';
        vehicleSection.className = 'vehicle-image-section';
        vehicleSection.style.cssText = `
            margin-top: 10px;
            padding: 10px;
            background: var(--light-gray);
            border-radius: var(--element-radius);
            border: 1px solid var(--border-color);
        `;
        vehicleSection.innerHTML = `
            <h4 class="section-title" style="font-size: 0.8rem; margin-bottom: 8px;">
                <i class="fas fa-car"></i> Driver's Vehicle
            </h4>
            <div id="vehicleImageContainer"></div>
        `;
        driverDetailsCard.appendChild(vehicleSection);
    }
    
    const vehicleImageContainer = document.getElementById('vehicleImageContainer');
    
    if (ride.vehicleImage) {
        driverVehicleImage = ride.vehicleImage;
        vehicleImageContainer.innerHTML = `
            <img id="vehicleFrontImage" class="vehicle-image" src="${driverVehicleImage}" alt="Vehicle" style="width: 100%; height: 150px; object-fit: cover; border-radius: 8px; margin-bottom: 8px;">
            <div class="vehicle-details-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.7rem;">
                <div class="vehicle-detail">
                    <strong>Type:</strong> ${driver.vehicle?.type || 'N/A'}
                </div>
                <div class="vehicle-detail">
                    <strong>Model:</strong> ${driver.vehicle?.model || 'N/A'}
                </div>
                <div class="vehicle-detail">
                    <strong>Color:</strong> ${driver.vehicle?.color || 'N/A'}
                </div>
                <div class="vehicle-detail">
                    <strong>Plate:</strong> ${driver.vehicle?.licensePlate || 'N/A'}
                </div>
            </div>
        `;
    } else if (driver.images && driver.images.vehicleFront) {
        driverVehicleImage = driver.images.vehicleFront;
        vehicleImageContainer.innerHTML = `
            <img id="vehicleFrontImage" class="vehicle-image" src="${driverVehicleImage}" alt="Vehicle" style="width: 100%; height: 150px; object-fit: cover; border-radius: 8px; margin-bottom: 8px;">
            <div class="vehicle-details-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.7rem;">
                <div class="vehicle-detail">
                    <strong>Type:</strong> ${driver.vehicle?.type || 'N/A'}
                </div>
                <div class="vehicle-detail">
                    <strong>Model:</strong> ${driver.vehicle?.model || 'N/A'}
                </div>
                <div class="vehicle-detail">
                    <strong>Color:</strong> ${driver.vehicle?.color || 'N/A'}
                </div>
                <div class="vehicle-detail">
                    <strong>Plate:</strong> ${driver.vehicle?.licensePlate || 'N/A'}
                </div>
            </div>
        `;
    } else {
        vehicleImageContainer.innerHTML = `
            <div class="no-vehicle-image" style="text-align: center; padding: 20px; color: var(--medium-gray); font-size: 0.8rem;">
                <i class="fas fa-car" style="font-size: 2rem; margin-bottom: 8px; display: block;"></i>
                Vehicle image not available
            </div>
            <div class="vehicle-details-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.7rem; margin-top: 8px;">
                <div class="vehicle-detail">
                    <strong>Type:</strong> ${driver.vehicle?.type || 'N/A'}
                </div>
                <div class="vehicle-detail">
                    <strong>Model:</strong> ${driver.vehicle?.model || 'N/A'}
                </div>
                <div class="vehicle-detail">
                    <strong>Color:</strong> ${driver.vehicle?.color || 'N/A'}
                </div>
                <div class="vehicle-detail">
                    <strong>Plate:</strong> ${driver.vehicle?.licensePlate || 'N/A'}
                </div>
            </div>
        `;
    }
}

function addChatWithDriverButton(rideId, driver) {
    const rideActions = document.querySelector('.ride-actions');
    
    if (!document.getElementById('chatWithDriverBtn')) {
        const chatButton = document.createElement('button');
        chatButton.id = 'chatWithDriverBtn';
        chatButton.className = 'btn btn-contact';
        chatButton.innerHTML = '<i class="fas fa-comments"></i> Chat with Driver';
        chatButton.addEventListener('click', function() {
            openChatWithDriver(rideId, driver);
        });
        
        const contactBtn = document.getElementById('contactDriverBtn');
        rideActions.insertBefore(chatButton, contactBtn);
    }
}

function startDriverMessageListener(rideId) {
    if (driverMessageListener) {
        driverMessageListener();
    }
    
    driverMessageListener = database.ref('chats/' + rideId).orderByChild('timestamp').on('child_added', snapshot => {
        const message = snapshot.val();
        
        if (message.senderId !== currentUser.uid) {
            driverMessagesQueue.push({
                rideId: rideId,
                message: message,
                timestamp: message.timestamp
            });
            
            if (!isChatPopupOpen()) {
                showDriverMessageNotification(message);
            }
            
            if (isChatPopupOpen() && currentChatRideId === rideId) {
                displayChatMessage(message);
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }
    });
}

function showDriverMessageNotification(message) {
    const notification = document.createElement('div');
    notification.className = 'notification driver-message-notification';
    notification.style.cssText = `
        position: fixed;
        top: 60px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--primary-gradient);
        color: var(--white);
        padding: 12px 16px;
        border-radius: var(--element-radius);
        box-shadow: var(--shadow-heavy);
        z-index: 1000;
        max-width: 80%;
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        animation: slideIn 0.3s ease;
    `;
    
    notification.innerHTML = `
        <div style="font-size: 1.2rem;">
            <i class="fas fa-comment-alt"></i>
        </div>
        <div>
            <div style="font-weight: 700; font-size: 0.8rem;">New message from driver</div>
            <div style="font-size: 0.75rem; opacity: 0.9;">${message.message.substring(0, 50)}${message.message.length > 50 ? '...' : ''}</div>
        </div>
        <div style="margin-left: auto; font-size: 1.2rem;">
            <i class="fas fa-times"></i>
        </div>
    `;
    
    notification.querySelector('.fa-times').addEventListener('click', function(e) {
        e.stopPropagation();
        notification.remove();
    });
    
    notification.addEventListener('click', function() {
        if (currentRide) {
            database.ref('users/' + currentRide.driverId).once('value')
                .then(driverSnapshot => {
                    const driver = driverSnapshot.val();
                    if (driver) {
                        openChatWithDriver(rideId, driver);
                        notification.remove();
                    }
                });
        }
    });
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentElement) {
            notification.remove();
        }
    }, 5000);
}

function isChatPopupOpen() {
    const chatPopup = document.getElementById('chatPopup');
    return chatPopup && !chatPopup.classList.contains('hidden');
}

function openChatWithDriver(rideId, driver) {
    if (!document.getElementById('chatPopup')) {
        createChatPopup();
    }
    
    currentChatRideId = rideId;
    chatPopupClosedByUser = false;
    
    document.getElementById('chatDriverName').textContent = driver.name || 'Driver';
    document.getElementById('chatDriverRating').textContent = driver.rating ? `${driver.rating} â˜…` : '4.5 â˜…';
    
    const chatDriverAvatar = document.getElementById('chatDriverAvatar');
    if (driverProfileImage) {
        chatDriverAvatar.innerHTML = `<img src="${driverProfileImage}" class="driver-profile-image" alt="Driver" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
    } else if (driver.name) {
        chatDriverAvatar.innerHTML = driver.name.charAt(0).toUpperCase();
    } else {
        chatDriverAvatar.innerHTML = '<i class="fas fa-user"></i>';
    }
    
    document.getElementById('chatPopup').classList.remove('hidden');
    loadChatMessages(rideId);
    startChatListener(rideId);
}

function createChatPopup() {
    const chatPopup = document.createElement('div');
    chatPopup.id = 'chatPopup';
    chatPopup.className = 'popup-overlay hidden';
    chatPopup.innerHTML = `
        <div class="popup-form" style="max-width: 400px; height: 500px; display: flex; flex-direction: column;">
            <div class="popup-header">
                <h2 class="popup-title">
                    <i class="fas fa-comments"></i>
                    Chat with Driver
                </h2>
                <button class="close-popup" id="closeChatPopup">&times;</button>
            </div>
            <div class="chat-driver-info" style="padding: 10px; border-bottom: 1px solid var(--border-color); background: var(--light-orange);">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div class="driver-avatar" id="chatDriverAvatar" style="width: 40px; height: 40px; font-size: 1.2rem; background: var(--primary-orange); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white;"></div>
                    <div>
                        <div style="font-weight: 600; font-size: 0.9rem;" id="chatDriverName">Driver</div>
                        <div style="font-size: 0.7rem; color: var(--medium-gray);" id="chatDriverRating">4.5 â˜…</div>
                    </div>
                </div>
            </div>
            <div class="chat-messages" id="chatMessages" style="flex: 1; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; background: var(--light-gray);"></div>
            <div class="chat-input-container" style="padding: 10px; border-top: 1px solid var(--border-color); background: var(--white);">
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="chatMessageInput" placeholder="Type your message..." style="flex: 1; padding: 8px; border: 1px solid var(--border-color); border-radius: var(--element-radius);">
                    <button id="sendChatMessageBtn" style="padding: 8px 15px; background: var(--primary-orange); color: white; border: none; border-radius: var(--element-radius); cursor: pointer;">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(chatPopup);
    
    document.getElementById('closeChatPopup').addEventListener('click', function() {
        chatPopupClosedByUser = true;
        closeChatPopup();
    });
    
    document.getElementById('sendChatMessageBtn').addEventListener('click', sendChatMessage);
    document.getElementById('chatMessageInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendChatMessage();
        }
    });
}

function loadChatMessages(rideId) {
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.innerHTML = '<div class="loading-text">Loading messages...</div>';
    
    database.ref('chats/' + rideId).orderByChild('timestamp').once('value')
        .then(snapshot => {
            const messages = snapshot.val();
            chatMessages.innerHTML = '';
            
            if (messages) {
                const messagesArray = Object.values(messages);
                messagesArray.forEach(message => {
                    displayChatMessage(message);
                });
                
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } else {
                chatMessages.innerHTML = '<div class="no-places" style="text-align: center; padding: 20px; color: var(--medium-gray);">No messages yet. Start the conversation!</div>';
            }
        })
        .catch(error => {
            console.error('Error loading chat messages:', error);
            chatMessages.innerHTML = '<div class="no-places" style="text-align: center; padding: 20px; color: var(--error-red);">Error loading messages.</div>';
        });
}

function startChatListener(rideId) {
    if (chatListener) {
        chatListener();
    }
    
    chatListener = database.ref('chats/' + rideId).orderByChild('timestamp').on('child_added', snapshot => {
        const message = snapshot.val();
        displayChatMessage(message);
        
        const chatMessages = document.getElementById('chatMessages');
        chatMessages.scrollTop = chatMessages.scrollHeight;
    });
}

function displayChatMessage(message) {
    const chatMessages = document.getElementById('chatMessages');
    
    if (chatMessages.querySelector('.loading-text') || chatMessages.querySelector('.no-places')) {
        chatMessages.innerHTML = '';
    }
    
    const messageElement = document.createElement('div');
    messageElement.className = `chat-message ${message.senderId === currentUser.uid ? 'own-message' : 'other-message'}`;
    messageElement.style.cssText = `
        max-width: 80%;
        padding: 8px 12px;
        border-radius: 15px;
        margin-bottom: 5px;
        word-wrap: break-word;
        align-self: ${message.senderId === currentUser.uid ? 'flex-end' : 'flex-start'};
        background: ${message.senderId === currentUser.uid ? 'var(--primary-orange)' : 'var(--white)'};
        color: ${message.senderId === currentUser.uid ? 'white' : 'var(--dark-gray)'};
        border: ${message.senderId === currentUser.uid ? 'none' : '1px solid var(--border-color)'};
        box-shadow: ${message.senderId === currentUser.uid ? 'var(--shadow-light)' : 'none'};
    `;
    
    const timestamp = new Date(message.timestamp);
    const timeString = timestamp.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    messageElement.innerHTML = `
        <div style="font-size: 0.8rem;">${message.message}</div>
        <div style="font-size: 0.6rem; opacity: 0.7; text-align: ${message.senderId === currentUser.uid ? 'right' : 'left'}; margin-top: 4px;">${timeString}</div>
    `;
    
    chatMessages.appendChild(messageElement);
}

function sendChatMessage() {
    const messageInput = document.getElementById('chatMessageInput');
    const message = messageInput.value.trim();
    
    if (!message || !currentChatRideId) {
        return;
    }
    
    const messageData = {
        message: message,
        senderId: currentUser.uid,
        senderName: userData.name || 'Passenger',
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        rideId: currentChatRideId
    };
    
    database.ref('chats/' + currentChatRideId).push(messageData)
        .then(() => {
            messageInput.value = '';
        })
        .catch(error => {
            console.error('Error sending message:', error);
            showNotification('Error sending message. Please try again.');
        });
}

function closeChatPopup() {
    document.getElementById('chatPopup').classList.add('hidden');
    
    if (chatListener) {
        chatListener();
        chatListener = null;
    }
    
    currentChatRideId = null;
}

function updateDriverDetailsCard(driver) {
    const driverDetailsCard = document.getElementById('driverDetailsCard');
    driverDetailsCard.style.display = 'block';
    
    document.getElementById('driverFullName').textContent = driver.name || 'Driver';
    document.getElementById('driverContactPhone').textContent = driver.phone || 'Not available';
    document.getElementById('driverRatingValue').textContent = driver.rating ? `${driver.rating} â˜…` : '4.5 â˜…';
    document.getElementById('driverExperience').textContent = driver.experience || '2 years';
    
    if (driver.vehicle) {
        document.getElementById('vehicleType').textContent = driver.vehicle.type || 'Car';
        document.getElementById('vehicleModel').textContent = driver.vehicle.model || 'Not specified';
        document.getElementById('vehicleLicense').textContent = driver.vehicle.licensePlate || 'Not available';
        document.getElementById('vehicleColor').textContent = driver.vehicle.color || 'Not specified';
    }
}

function trackDriverLocation(driverId) {
    if (driverLocationListener) {
        driverLocationListener();
    }
    
    driverLocationListener = database.ref('driverLocations/' + driverId).on('value', snapshot => {
        const location = snapshot.val();
        if (location && driverMarker) {
            driverMarker.setLatLng([location.latitude, location.longitude]);
            
            updateDriverETA(location.latitude, location.longitude);
        }
    });
}

function updateDriverETA(driverLat, driverLng) {
    if (userLocation) {
        const distance = calculateDistance(
            driverLat, driverLng,
            userLocation.lat, userLocation.lng
        );
        
        const etaMinutes = Math.ceil((distance / 1000) / 30 * 60);
        document.getElementById('timeText').textContent = `${etaMinutes} min`;
    }
}

function addDriverMarker(lat, lng) {
    if (driverMarker) {
        passengerMap.removeLayer(driverMarker);
    }
    
    driverMarker = L.marker([lat, lng], {
        icon: L.divIcon({
            className: 'driver-marker',
            html: '<div class="driver-marker">ðŸš—</div><div class="driver-marker-label">Driver</div>',
            iconSize: [32, 45]
        })
    }).addTo(passengerMap)
        .bindPopup('Your driver');
}

function addDestinationMarker(lat, lng) {
    if (destinationMarker) {
        passengerMap.removeLayer(destinationMarker);
    }
    
    destinationMarker = L.marker([lat, lng], {
        icon: L.divIcon({
            className: 'destination-marker',
            html: '<div class="destination-marker"><i class="fas fa-flag"></i></div>',
            iconSize: [22, 22]
        })
    }).addTo(passengerMap)
        .bindPopup('Destination');
}

function listenForRideStatusUpdates(rideId) {
    database.ref('rides/' + rideId).on('value', snapshot => {
        const ride = snapshot.val();
        if (ride) {
            currentRide = ride;
            
            switch(ride.status) {
                case 'accepted':
                    document.getElementById('statusText').textContent = 'Driver on the way';
                    break;
                case 'arrived':
                    document.getElementById('statusText').textContent = 'Driver arrived';
                    document.getElementById('statusDot').className = 'status-dot riding';
                    showNotification('Your driver has arrived!');
                    break;
                case 'started':
                    document.getElementById('statusText').textContent = 'Trip in progress';
                    addDestinationMarker(ride.destLat, ride.destLng);
                    drawRoute(ride.pickupLat, ride.pickupLng, ride.destLat, ride.destLng);
                    break;
                case 'completed':
                    document.getElementById('statusText').textContent = 'Trip completed';
                    document.getElementById('rideStatus').style.display = 'none';
                    document.getElementById('estimatedTime').style.display = 'none';
                    document.getElementById('sosButton').style.display = 'none';
                    resetUIAfterRide();
                    
                    stopLiveTracking(rideId);
                    
                    showNotification('Trip completed. Thank you for using Jubel!');
                    break;
                case 'cancelled':
                    document.getElementById('rideStatus').style.display = 'none';
                    document.getElementById('estimatedTime').style.display = 'none';
                    document.getElementById('sosButton').style.display = 'none';
                    resetUIAfterRide();
                    
                    stopLiveTracking(rideId);
                    
                    showNotification('Ride cancelled');
                    break;
            }
        }
    });
}

function stopLiveTracking(rideId) {
    if (liveTrackingListeners[rideId]) {
        liveTrackingListeners[rideId]();
        delete liveTrackingListeners[rideId];
    }
    
    if (sharedRideLinks[rideId]) {
        const trackingId = sharedRideLinks[rideId].trackingId;
        database.ref('liveTracking/' + trackingId).update({
            isActive: false,
            endedAt: firebase.database.ServerValue.TIMESTAMP
        });
        
        delete sharedRideLinks[rideId];
    }
}

function handleRideCancellation(ride) {
    document.getElementById('searchingAnimation').style.display = 'none';
    
    showNotification('Ride has been cancelled.');
    resetUIAfterRide();
    currentRide = null;
    
    if (driverMarker) {
        passengerMap.removeLayer(driverMarker);
        driverMarker = null;
    }
    
    if (driverAssignmentListener) {
        driverAssignmentListener();
        driverAssignmentListener = null;
    }
    
    if (driverLocationListener) {
        driverLocationListener();
        driverLocationListener = null;
    }
    
    if (driverMessageListener) {
        driverMessageListener();
        driverMessageListener = null;
    }
    
    stopLiveTracking(ride.id);
}

function cancelRide() {
    if (currentRide) {
        if (confirm('Are you sure you want to cancel this ride?')) {
            database.ref('rides/' + currentRide.id).update({
                status: 'cancelled',
                cancelledAt: firebase.database.ServerValue.TIMESTAMP,
                updatedAt: firebase.database.ServerValue.TIMESTAMP
            })
            .then(() => {
                resetUIAfterRide();
                showNotification('Ride cancelled');
            })
            .catch(error => {
                console.error('Error cancelling ride:', error);
                showNotification('Error cancelling ride. Please try again.');
            });
        }
    }
}

function contactDriver() {
    if (currentRide && currentRide.driverId) {
        database.ref('users/' + currentRide.driverId).once('value')
            .then(snapshot => {
                const driver = snapshot.val();
                if (driver && driver.phone) {
                    showNotification(`Calling driver: ${driver.phone}`);
                    window.open(`tel:${driver.phone}`, '_self');
                } else {
                    showNotification('Driver phone number not available.');
                }
            });
    }
}

function applyPromoCode() {
    const promoCode = document.getElementById('promoCode').value.trim();
    
    if (!promoCode) {
        showNotification('Please enter a promo code.');
        return;
    }
    
    if (promoCode.startsWith('JUBEL')) {
        applyReferralCode(promoCode);
    } else {
        if (promoCode.startsWith('JUBEL-')) {
            appliedPromoCode = promoCode;
            showNotification('Promo code applied! 20% discount will be applied to your ride.');
            updateFareEstimate();
            
            document.getElementById('promoCode').style.borderColor = 'var(--success-green)';
            document.getElementById('applyPromoBtn').innerHTML = '<i class="fas fa-check"></i> Applied';
            document.getElementById('applyPromoBtn').classList.remove('btn-promo');
            document.getElementById('applyPromoBtn').classList.add('btn-success');
        } else {
            showNotification('Invalid promo code. Please check and try again.');
            document.getElementById('promoCode').style.borderColor = 'var(--error-red)';
        }
    }
}

function applyReferralCode(referralCode) {
    database.ref('users').orderByChild('referralCode').equalTo(referralCode).once('value')
        .then(snapshot => {
            if (snapshot.exists()) {
                const referrerData = snapshot.val();
                const referrerId = Object.keys(referrerData)[0];
                const referrer = referrerData[referrerId];
                
                appliedPromoCode = referralCode;
                showNotification('Referral code applied! 50% discount will be applied to your ride.');
                updateFareEstimate();
                
                document.getElementById('promoCode').style.borderColor = 'var(--success-green)';
                document.getElementById('applyPromoBtn').innerHTML = '<i class="fas fa-check"></i> Applied';
                document.getElementById('applyPromoBtn').classList.remove('btn-promo');
                document.getElementById('applyPromoBtn').classList.add('btn-success');
                
                const newBalance = (referrer.walletBalance || 0) + 25;
                database.ref('users/' + referrerId).update({
                    walletBalance: newBalance
                })
                .then(() => {
                    console.log(`Rewarded ${referrer.name} with K25 for referral`);
                });
                
                database.ref('referrals').push().set({
                    referrerId: referrerId,
                    referredUserId: currentUser.uid,
                    referralCode: referralCode,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    rewardAmount: 25
                });
            } else {
                showNotification('Invalid referral code. Please check and try again.');
                document.getElementById('promoCode').style.borderColor = 'var(--error-red)';
            }
        })
        .catch(error => {
            console.error('Error applying referral code:', error);
            showNotification('Error applying referral code. Please try again.');
        });
}

function resetUIAfterRide() {
    document.getElementById('rideRequestForm').style.display = 'flex';
    
    document.getElementById('rideInfoPanel').style.display = 'none';
    
    document.getElementById('driverDetailsCard').style.display = 'none';
    
    document.getElementById('destinationLocation').value = '';
    
    document.getElementById('packageForm').classList.remove('active');
    document.getElementById('receiverName').value = '';
    document.getElementById('receiverPhone').value = '';
    document.getElementById('packageDescription').value = '';
    document.getElementById('specialInstructions').value = '';
    document.getElementById('packageValue').value = '';
    
    document.getElementById('promoCode').value = '';
    appliedPromoCode = null;
    document.getElementById('promoCode').style.borderColor = '';
    document.getElementById('applyPromoBtn').innerHTML = 'Apply';
    document.getElementById('applyPromoBtn').classList.remove('btn-success');
    document.getElementById('applyPromoBtn').classList.add('btn-promo');
    document.getElementById('promoSection').classList.remove('active');
    
    const chatButton = document.getElementById('chatWithDriverBtn');
    if (chatButton) {
        chatButton.remove();
    }
    
    const shareBtn = document.getElementById('shareRideBtn');
    if (shareBtn) shareBtn.remove();
    
    const trackingBtn = document.getElementById('shareTrackingBtn');
    if (trackingBtn) trackingBtn.remove();
    
    if (document.getElementById('chatPopup') && !document.getElementById('chatPopup').classList.contains('hidden')) {
        closeChatPopup();
    }
    
    if (driverMessageListener) {
        driverMessageListener();
        driverMessageListener = null;
    }
    
    driverProfileImage = null;
    driverVehicleImage = null;
    
    if (driverMarker) {
        passengerMap.removeLayer(driverMarker);
        driverMarker = null;
    }
    
    if (destinationMarker) {
        passengerMap.removeLayer(destinationMarker);
        destinationMarker = null;
    }
    
    if (routePolyline) {
        passengerMap.removeLayer(routePolyline);
        routePolyline = null;
    }
    
    if (driverLocationListener) {
        driverLocationListener();
        driverLocationListener = null;
    }
    
    currentRide = null;
}

function loadPassengerData() {
    if (currentUser) {
        updateUserStats();
    }
}

function loadAccountData() {
    if (currentUser && userData) {
        document.getElementById('accountName').textContent = userData.name || 'Passenger';
        document.getElementById('accountPhone').textContent = userData.phone || 'Not set';
        document.getElementById('accountEmail').textContent = userData.email || 'Not set';
        document.getElementById('referralCode').textContent = userData.referralCode || 'JUBEL-XXXX';
        
        walletBalance = userData.walletBalance || 0;
        document.getElementById('accountBalance').textContent = `K${walletBalance.toFixed(2)}`;
        
        const accountAvatar = document.getElementById('accountAvatar');
        if (userData.name) {
            accountAvatar.textContent = userData.name.charAt(0).toUpperCase();
        } else {
            accountAvatar.innerHTML = '<i class="fas fa-user"></i>';
        }
        
        updateUserStats();
    }
}

function updateUserStats() {
    if (!currentUser) return;
    
    database.ref('rides').orderByChild('passengerId').equalTo(currentUser.uid).once('value')
        .then(snapshot => {
            const rides = snapshot.val();
            if (rides) {
                const ridesArray = Object.values(rides);
                
                userStats = {
                    completed: ridesArray.filter(ride => ride.status === 'completed' || ride.status === 'paid').length,
                    cancelled: ridesArray.filter(ride => ride.status === 'cancelled').length,
                    pending: ridesArray.filter(ride => ride.status === 'requested' || ride.status === 'accepted').length
                };
                
                document.getElementById('ridesCompleted').textContent = userStats.completed;
                document.getElementById('ridesCancelled').textContent = userStats.cancelled;
                document.getElementById('ridesPending').textContent = userStats.pending;
            }
        });
}

function shareReferralCode() {
    const referralCode = document.getElementById('referralCode').textContent;
    const shareText = `Join me on Jubel! Use my referral code ${referralCode} for 50% off your first ride. Download the app now!`;
    
    if (navigator.share) {
        navigator.share({
            title: 'Jubel Referral',
            text: shareText,
            url: window.location.href
        })
        .then(() => showNotification('Referral code shared successfully!'))
        .catch(error => console.error('Error sharing:', error));
    } else {
        navigator.clipboard.writeText(shareText)
            .then(() => showNotification('Referral code copied to clipboard!'));
    }
}

function depositToWallet() {
    const amount = prompt('Enter deposit amount (K):');
    if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
        const depositAmount = parseFloat(amount);
        const newBalance = walletBalance + depositAmount;
        
        database.ref('users/' + currentUser.uid).update({
            walletBalance: newBalance
        })
        .then(() => {
            walletBalance = newBalance;
            updateWalletBalanceUI();
            showNotification(`Successfully deposited K${depositAmount.toFixed(2)} to your wallet.`);
        })
        .catch(error => {
            console.error('Error depositing to wallet:', error);
            showNotification('Error processing deposit. Please try again.');
        });
    } else if (amount) {
        showNotification('Please enter a valid amount.');
    }
}

function withdrawFromWallet() {
    if (walletBalance <= 0) {
        showNotification('Your wallet balance is zero.');
        return;
    }
    
    const amount = prompt(`Enter withdrawal amount (K). Available: K${walletBalance.toFixed(2)}:`);
    if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
        const withdrawalAmount = parseFloat(amount);
        
        if (withdrawalAmount > walletBalance) {
            showNotification('Insufficient balance for this withdrawal.');
            return;
        }
        
        const newBalance = walletBalance - withdrawalAmount;
        
        database.ref('users/' + currentUser.uid).update({
            walletBalance: newBalance
        })
        .then(() => {
            walletBalance = newBalance;
            updateWalletBalanceUI();
            showNotification(`Successfully withdrew K${withdrawalAmount.toFixed(2)} from your wallet.`);
        })
        .catch(error => {
            console.error('Error withdrawing from wallet:', error);
            showNotification('Error processing withdrawal. Please try again.');
        });
    } else if (amount) {
        showNotification('Please enter a valid amount.');
    }
}

function contactWhatsApp() {
    const phoneNumber = '0768658484';
    const message = 'Hello, I need assistance with Jubel rides.';
    const url = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
    window.open(url, '_blank');
}

function contactPhone() {
    const phoneNumber = '0768658484';
    window.open(`tel:${phoneNumber}`, '_self');
}

function addPaymentMethod() {
    showNotification('Payment method feature coming soon!');
}

function loadRideHistory() {
    if (currentUser) {
        const filter = document.getElementById('historyFilter').value;
        const dateFilter = document.getElementById('historyDate').value;
        
        if (rideHistoryListener) {
            rideHistoryListener();
        }
        
        rideHistoryListener = database.ref('rides').orderByChild('passengerId').equalTo(currentUser.uid).on('value', snapshot => {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';
            
            const rides = snapshot.val();
            if (rides) {
                let ridesArray = Object.keys(rides).map(rideId => ({
                    id: rideId,
                    ...rides[rideId]
                }));
                
                if (filter !== 'all') {
                    ridesArray = ridesArray.filter(ride => ride.status === filter);
                }
                
                if (dateFilter) {
                    const filterDate = new Date(dateFilter);
                    ridesArray = ridesArray.filter(ride => {
                        const rideDate = new Date(ride.timestamp);
                        return rideDate.toDateString() === filterDate.toDateString();
                    });
                }
                
                ridesArray.sort((a, b) => b.timestamp - a.timestamp);
                
                if (ridesArray.length === 0) {
                    historyList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--medium-gray);">No rides found matching your criteria.</p>';
                    return;
                }
                
                ridesArray.forEach(ride => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item';
                    historyItem.setAttribute('data-ride-id', ride.id);
                    
                    const date = new Date(ride.timestamp);
                    const formattedDate = date.toLocaleDateString();
                    const formattedTime = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    const isDelivery = ride.rideType === 'bike' || ride.rideType === 'bicycle';
                    const typeClass = isDelivery ? 'delivery' : 'ride';
                    const typeText = isDelivery ? 'Delivery' : 'Ride';
                    
                    let statusClass = 'status-requested';
                    let statusText = getStatusText(ride.status);
                    
                    if (ride.status === 'accepted') {
                        statusClass = 'status-accepted';
                    } else if (ride.status === 'completed' || ride.status === 'paid') {
                        statusClass = 'status-completed';
                    } else if (ride.status === 'cancelled') {
                        statusClass = 'status-cancelled';
                    } else if (ride.status === 'requested') {
                        statusClass = 'status-pending';
                        statusText = 'Pending';
                    }
                    
                    let historyContent = '';
                    
                    const hasChat = ride.hasChat || false;
                    
                    historyContent = `
                        <div class="history-item-type ${typeClass}">${typeText}</div>
                        <div class="history-locations">
                            <div class="history-location">
                                <div class="history-location-icon pickup">
                                    <i class="fas fa-map-marker-alt"></i>
                                </div>
                                <div>
                                    <strong>From:</strong> ${ride.pickupDisplayLocation || ride.pickupLocation}
                                </div>
                            </div>
                            <div class="history-location">
                                <div class="history-location-icon destination">
                                    <i class="fas fa-flag"></i>
                                </div>
                                <div>
                                    <strong>To:</strong> ${ride.destination}
                                </div>
                            </div>
                        </div>
                        <div class="history-info">
                            <div class="history-fare">K${ride.fare ? ride.fare.toFixed(2) : '0.00'}</div>
                            <div>${formattedDate} ${formattedTime}</div>
                            <div class="status-badge ${statusClass}">
                                ${statusText}
                            </div>
                            ${hasChat ? '<div class="chat-indicator"><i class="fas fa-comments"></i> Chat available</div>' : ''}
                        </div>
                    `;
                    
                    if (ride.driverId) {
                        database.ref('users/' + ride.driverId).once('value')
                            .then(driverSnapshot => {
                                const driver = driverSnapshot.val();
                                if (driver) {
                                    const driverInfo = document.createElement('div');
                                    driverInfo.className = 'history-driver-info';
                                    driverInfo.innerHTML = `
                                        <div class="history-driver-avatar">
                                            ${driver.name ? driver.name.charAt(0).toUpperCase() : 'D'}
                                        </div>
                                        <div class="history-driver-details">
                                            <div class="history-driver-name">${driver.name || 'Driver'}</div>
                                            <div class="history-driver-rating">${driver.rating || '4.5'} â˜…</div>
                                        </div>
                                    `;
                                    historyItem.appendChild(driverInfo);
                                }
                            });
                    }
                    
                    historyItem.innerHTML = historyContent;
                    historyList.appendChild(historyItem);
                });
            } else {
                historyList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--medium-gray);">No ride history found.</p>';
            }
        }, error => {
            console.error('Error loading ride history:', error);
            historyList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--error-red);">Error loading ride history.</p>';
        });
    }
}

function getStatusText(status) {
    const statusMap = {
        'requested': 'Awaiting Driver',
        'accepted': 'In Progress',
        'completed': 'Completed',
        'paid': 'Completed',
        'cancelled': 'Cancelled',
        'arrived': 'Driver Arrived',
        'picked_up': 'Picked Up',
        'started': 'Trip Started'
    };
    
    return statusMap[status] || status;
}

// Enhanced Ride Details Popup with chat history
function showRideDetailsPopup(rideId) {
    database.ref('rides/' + rideId).once('value')
        .then(snapshot => {
            const ride = snapshot.val();
            if (ride) {
                document.getElementById('popupRidePickup').textContent = ride.pickupDisplayLocation || ride.pickupLocation;
                document.getElementById('popupRideDestination').textContent = ride.destination;
                document.getElementById('popupRideFare').textContent = `K${ride.fare ? ride.fare.toFixed(2) : '0.00'}`;
                document.getElementById('popupRideDistance').textContent = ride.distance || 'Calculating...';
                document.getElementById('popupRideStatus').textContent = getStatusText(ride.status);
                document.getElementById('popupRideType').textContent = ride.rideType ? ride.rideType.charAt(0).toUpperCase() + ride.rideType.slice(1) : 'Standard';
                
                const date = new Date(ride.timestamp);
                document.getElementById('popupRideDate').textContent = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                updatePopupRideMap(ride);
                
                const viewChatBtn = document.getElementById('viewChatBtn');
                if (ride.driverId) {
                    viewChatBtn.style.display = 'inline-block';
                    viewChatBtn.onclick = function() {
                        viewRideChat(rideId, ride);
                    };
                } else {
                    viewChatBtn.style.display = 'none';
                }
                
                if (ride.driverId) {
                    database.ref('users/' + ride.driverId).once('value')
                        .then(driverSnapshot => {
                            const driver = driverSnapshot.val();
                            if (driver) {
                                document.getElementById('popupDriverName').textContent = driver.name || 'Driver';
                                document.getElementById('popupDriverPhone').textContent = driver.phone || 'N/A';
                                document.getElementById('popupDriverVehicle').textContent = `${driver.vehicleType || 'Car'} (${driver.licensePlate || 'N/A'})`;
                                document.getElementById('popupDriverRating').textContent = driver.rating || '4.5';
                                
                                document.getElementById('popupDriverDetails').classList.remove('hidden');
                            }
                        });
                } else {
                    document.getElementById('popupDriverDetails').classList.add('hidden');
                }
                
                loadPopupChatHistory(rideId);
                
                document.getElementById('rideDetailsPopup').classList.remove('hidden');
            }
        })
        .catch(error => {
            console.error('Error loading ride details:', error);
            showNotification('Error loading ride details.');
        });
}

function updatePopupRideMap(ride) {
    if (popupRideMap) {
        popupRideMap.remove();
    }
    
    popupRideMap = L.map('popupRideMap').setView([ride.pickupLat, ride.pickupLng], 13);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(popupRideMap);
    
    L.marker([ride.pickupLat, ride.pickupLng], {
        icon: L.divIcon({
            className: 'pickup-marker',
            html: '<div class="pickup-marker"><i class="fas fa-map-marker-alt"></i></div>',
            iconSize: [22, 22]
        })
    }).addTo(popupRideMap)
        .bindPopup(`<strong>Pickup:</strong> ${ride.pickupDisplayLocation || ride.pickupLocation}`);
    
    L.marker([ride.destLat, ride.destLng], {
        icon: L.divIcon({
            className: 'destination-marker',
            html: '<div class="destination-marker"><i class="fas fa-flag"></i></div>',
            iconSize: [22, 22]
        })
    }).addTo(popupRideMap)
        .bindPopup(`<strong>Destination:</strong> ${ride.destination}`);
    
    fetch(`https://router.project-osrm.org/route/v1/driving/${ride.pickupLng},${ride.pickupLat};${ride.destLng},${ride.destLat}?overview=full&geometries=geojson`)
        .then(response => response.json())
        .then(data => {
            if (data.routes && data.routes.length > 0) {
                const route = data.routes[0];
                const routeCoordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                
                L.polyline(routeCoordinates, {
                    color: '#FF6B35',
                    weight: 4,
                    opacity: 0.7,
                    dashArray: '8, 8'
                }).addTo(popupRideMap);
                
                const bounds = L.latLngBounds(
                    [ride.pickupLat, ride.pickupLng],
                    [ride.destLat, ride.destLng]
                );
                popupRideMap.fitBounds(bounds, { padding: [20, 20] });
            }
        })
        .catch(error => {
            console.error('Error fetching route for popup:', error);
        });
}

function loadPopupChatHistory(rideId) {
    const chatMessagesContainer = document.getElementById('popupChatMessages');
    chatMessagesContainer.innerHTML = '<div class="loading-text">Loading chat history...</div>';
    
    database.ref('chats/' + rideId).orderByChild('timestamp').once('value')
        .then(snapshot => {
            const messages = snapshot.val();
            chatMessagesContainer.innerHTML = '';
            
            if (messages) {
                const messagesArray = Object.values(messages);
                messagesArray.sort((a, b) => a.timestamp - b.timestamp);
                
                if (messagesArray.length > 0) {
                    document.getElementById('popupChatSection').classList.remove('hidden');
                    
                    messagesArray.forEach(message => {
                        const messageElement = document.createElement('div');
                        messageElement.className = `chat-message ${message.senderId === currentUser.uid ? 'passenger' : 'driver'}`;
                        
                        const timestamp = new Date(message.timestamp);
                        const timeString = timestamp.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        
                        messageElement.innerHTML = `
                            <div>${message.message}</div>
                            <div class="chat-message-time">${timeString} â€¢ ${message.senderId === currentUser.uid ? 'You' : 'Driver'}</div>
                        `;
                        
                        chatMessagesContainer.appendChild(messageElement);
                    });
                    
                    chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
                } else {
                    document.getElementById('popupChatSection').classList.add('hidden');
                }
            } else {
                document.getElementById('popupChatSection').classList.add('hidden');
            }
        })
        .catch(error => {
            console.error('Error loading chat history:', error);
            chatMessagesContainer.innerHTML = '<div class="no-results">Error loading chat history</div>';
        });
}

function viewRideChat(rideId, ride) {
    if (ride.driverId) {
        database.ref('users/' + ride.driverId).once('value')
            .then(driverSnapshot => {
                const driver = driverSnapshot.val();
                if (driver) {
                    openChatWithDriver(rideId, driver);
                    closeRideDetailsPopup();
                }
            });
    } else {
        showNotification('No driver information available for this ride.');
    }
}

function closeRideDetailsPopup() {
    document.getElementById('rideDetailsPopup').classList.add('hidden');
    if (popupRideMap) {
        popupRideMap.remove();
        popupRideMap = null;
    }
}

function showRideCompletion(ride) {
    document.getElementById('finalFare').textContent = `K${ride.fare.toFixed(2)}`;
    
    showNotification('Ride completed. Please complete payment and rating.');
    
    if (driverMarker) {
        passengerMap.removeLayer(driverMarker);
        driverMarker = null;
    }
    
    if (driverAssignmentListener) {
        driverAssignmentListener();
        driverAssignmentListener = null;
    }
    
    if (driverLocationListener) {
        driverLocationListener();
        driverLocationListener = null;
    }
}

function centerMap() {
    if (currentLocationMarker) {
        const passengerLatLng = currentLocationMarker.getLatLng();
        passengerMap.setView(passengerLatLng, 16);
        showNotification('Map centered on your location');
    }
}

function togglePanelCollapse() {
    const panel = document.getElementById('passengerPanel');
    panel.classList.toggle('collapsed');
}

function useSavedLocation(addressType) {
    if (userData) {
        const address = userData[addressType + 'Address'];
        
        if (address) {
            document.getElementById('destinationLocation').value = address;
            updateFareEstimate();
            showNotification(`${addressType.charAt(0).toUpperCase() + addressType.slice(1)} address set as destination.`);
            
            forwardGeocode(address).then(results => {
                if (results.length > 0) {
                    updateDestinationMarker(
                        parseFloat(results[0].lat),
                        parseFloat(results[0].lon),
                        address
                    );
                    
                    drawRoute(userLocation.lat, userLocation.lng, parseFloat(results[0].lat), parseFloat(results[0].lon));
                    
                    document.getElementById('requestRideBtn').disabled = false;
                }
            });
        } else {
            showNotification(`No ${addressType} address saved. Please add it in settings.`);
        }
    }
}

function startLocationTracking() {
    if (navigator.geolocation && currentUser) {
        navigator.geolocation.watchPosition(position => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            userLocation = { lat, lng };
            
            database.ref('passengerLocations/' + currentUser.uid).set({
                latitude: lat,
                longitude: lng,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            
            if (currentLocationMarker) {
                currentLocationMarker.setLatLng([lat, lng]);
            }
            
            if (destinationMarker) {
                const destination = document.getElementById('destinationLocation').value;
                if (destination) {
                    updateFareEstimate();
                }
            }
        }, error => {
            console.error('Location tracking error:', error);
        }, {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 30000
        });
    }
}

function showNotification(message) {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.style.display = 'block';
    notification.style.animation = 'none';
    notification.offsetHeight;
    notification.style.animation = 'slideUp 0.3s ease, fadeOut 0.3s ease 3.7s';
    
    setTimeout(() => {
        notification.style.display = 'none';
    }, 4000);
}

function switchScreen(screenId) {
    const previousScreen = currentScreen;
    currentScreen = screenId;
    
    document.querySelectorAll('.screen-content').forEach(screen => {
        screen.classList.remove('active');
    });
    
    document.getElementById(screenId + 'Screen').classList.add('active');
    
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`.nav-btn[data-screen="${screenId}"]`).classList.add('active');
    
    if (screenId === 'home') {
        document.querySelectorAll('.home-only').forEach(el => {
            el.style.display = 'flex';
        });
        
        if (previousScreen !== 'home' && homeScreenRefreshRequired) {
            refreshHomeScreen();
        }
    } else {
        document.querySelectorAll('.home-only').forEach(el => {
            el.style.display = 'none';
        });
        
        homeScreenRefreshRequired = true;
    }
    
    if (screenId === 'history') {
        loadRideHistory();
    } else if (screenId === 'account') {
        loadAccountData();
    }
}

function refreshHomeScreen() {
    console.log("Refreshing home screen...");
    
    refreshPassengerPosition();
    
    document.getElementById('destinationLocation').value = '';
    
    if (destinationMarker) {
        passengerMap.removeLayer(destinationMarker);
        destinationMarker = null;
    }
    
    if (routePolyline) {
        passengerMap.removeLayer(routePolyline);
        routePolyline = null;
    }
    
    document.getElementById('estimatedFare').textContent = 'K0.00';
    document.getElementById('etaDisplay').textContent = 'ETA: -- min';
    document.getElementById('requestRideBtn').disabled = true;
    
    document.getElementById('promoSection').classList.remove('active');
    document.getElementById('promoCode').value = '';
    appliedPromoCode = null;
    
    document.getElementById('packageForm').classList.remove('active');
    document.getElementById('packageToggle').style.display = 'none';
    
    document.getElementById('rideRequestForm').style.display = 'flex';
    document.getElementById('rideInfoPanel').style.display = 'none';
    
    updateScheduledRidesUI();
    
    homeScreenRefreshRequired = false;
    
    showNotification('Home screen refreshed');
}

// More Options Functions
function toggleMoreOptions() {
    const dropdown = document.getElementById('moreOptionsDropdown');
    dropdown.classList.toggle('active');
}

function handleMoreOptionSelection(option) {
    document.getElementById('orderForSomeoneForm').classList.remove('active');
    document.getElementById('expressDeliveryForm').classList.remove('active');
    document.getElementById('sosSetupForm').classList.remove('active');
    document.getElementById('rideRequestForm').style.display = 'none';
    
    switch(option) {
        case 'order-for-someone':
            document.getElementById('orderForSomeoneForm').classList.add('active');
            activeMoreOption = 'order-for-someone';
            break;
        case 'express-delivery':
            document.getElementById('expressDeliveryForm').classList.add('active');
            activeMoreOption = 'express-delivery';
            break;
        case 'sos-setup':
            document.getElementById('sosSetupForm').classList.add('active');
            activeMoreOption = 'sos-setup';
            break;
    }
    
    document.getElementById('moreOptionsDropdown').classList.remove('active');
}

function cancelMoreOptionForm() {
    document.getElementById('orderForSomeoneForm').classList.remove('active');
    document.getElementById('expressDeliveryForm').classList.remove('active');
    document.getElementById('sosSetupForm').classList.remove('active');
    
    document.getElementById('rideRequestForm').style.display = 'flex';
    
    if (recipientPickupMarker) {
        passengerMap.removeLayer(recipientPickupMarker);
        recipientPickupMarker = null;
    }
    if (recipientDestinationMarker) {
        passengerMap.removeLayer(recipientDestinationMarker);
        recipientDestinationMarker = null;
    }
    if (shopLocationMarker) {
        passengerMap.removeLayer(shopLocationMarker);
        shopLocationMarker = null;
    }
    if (deliveryDestinationMarker) {
        passengerMap.removeLayer(deliveryDestinationMarker);
        deliveryDestinationMarker = null;
    }
    
    activeMoreOption = null;
}

// Order for Someone Else Functions
function updateRecipientPickupMarker(lat, lng, name) {
    if (recipientPickupMarker) {
        passengerMap.removeLayer(recipientPickupMarker);
    }
    
    recipientPickupMarker = L.marker([lat, lng], {
        icon: L.divIcon({
            className: 'pickup-marker',
            html: '<div class="pickup-marker"><i class="fas fa-map-marker-alt"></i></div>',
            iconSize: [22, 22]
        })
    }).addTo(passengerMap)
        .bindPopup(`<strong>${name}</strong><br>Recipient Pickup Location`)
        .openPopup();
}

function updateRecipientDestinationMarker(lat, lng, name) {
    if (recipientDestinationMarker) {
        passengerMap.removeLayer(recipientDestinationMarker);
    }
    
    recipientDestinationMarker = L.marker([lat, lng], {
        icon: L.divIcon({
            className: 'destination-marker',
            html: '<div class="destination-marker"><i class="fas fa-flag"></i></div>',
            iconSize: [22, 22]
        })
    }).addTo(passengerMap)
        .bindPopup(`<strong>${name}</strong><br>Recipient Destination`)
        .openPopup();
}

function calculateRecipientDeliveryFee() {
    const pickupLocation = document.getElementById('recipientPickupLocation').value;
    const destinationLocation = document.getElementById('recipientDestinationLocation').value;
    
    if (pickupLocation.length > 3 && destinationLocation.length > 3) {
        Promise.all([
            forwardGeocode(pickupLocation),
            forwardGeocode(destinationLocation)
        ]).then(([pickupResults, destinationResults]) => {
            if (pickupResults.length > 0 && destinationResults.length > 0) {
                const pickupLat = parseFloat(pickupResults[0].lat);
                const pickupLng = parseFloat(pickupResults[0].lon);
                const destLat = parseFloat(destinationResults[0].lat);
                const destLng = parseFloat(destinationResults[0].lon);
                
                const distance = calculateDistance(pickupLat, pickupLng, destLat, destLng);
                
                let baseFare = 23;
                
                if (distance > 0) {
                    baseFare += Math.ceil(distance / 90);
                }
                
                document.getElementById('recipientDeliveryFee').textContent = `K${baseFare.toFixed(2)}`;
                
                const etaMinutes = Math.ceil((distance / 1000) / 30 * 60);
                document.getElementById('recipientEtaDisplay').textContent = `ETA: ${etaMinutes} min`;
                
                document.getElementById('orderForSomeoneBtn').disabled = false;
                
                updateRecipientPickupMarker(pickupLat, pickupLng, pickupResults[0].display_name);
                updateRecipientDestinationMarker(destLat, destLng, destinationResults[0].display_name);
                
                drawRoute(pickupLat, pickupLng, destLat, destLng);
            }
        });
    } else {
        document.getElementById('recipientDeliveryFee').textContent = 'K0.00';
        document.getElementById('recipientEtaDisplay').textContent = 'ETA: -- min';
        document.getElementById('orderForSomeoneBtn').disabled = true;
    }
}

function submitOrderForSomeone() {
    const pickupLocation = document.getElementById('recipientPickupLocation').value;
    const destinationLocation = document.getElementById('recipientDestinationLocation').value;
    const recipientName = document.getElementById('recipientName').value;
    const recipientEmail = document.getElementById('recipientEmail').value;
    const recipientPhone = document.getElementById('recipientPhone').value;
    
    if (!pickupLocation || !destinationLocation || !recipientName) {
        showNotification('Please fill in all required fields.');
        return;
    }
    
    Promise.all([
        forwardGeocode(pickupLocation),
        forwardGeocode(destinationLocation)
    ]).then(([pickupResults, destinationResults]) => {
        if (pickupResults.length === 0 || destinationResults.length === 0) {
            showNotification('Invalid pickup or destination address. Please select valid locations.');
            return;
        }
        
        const pickupLat = parseFloat(pickupResults[0].lat);
        const pickupLng = parseFloat(pickupResults[0].lon);
        const destLat = parseFloat(destinationResults[0].lat);
        const destLng = parseFloat(destinationResults[0].lon);
        
        const distance = calculateDistance(pickupLat, pickupLng, destLat, destLng);
        
        let baseFare = 23;
        
        if (distance > 0) {
            baseFare += Math.ceil(distance / 90);
        }
        
        const rideId = database.ref().child('rides').push().key;
        
        const rideRequest = {
            id: rideId,
            passengerId: currentUser.uid,
            passengerName: userData.name || 'Passenger',
            passengerPhone: userData.phone || 'Not provided',
            pickupLocation: pickupResults[0].display_name,
            destination: destinationResults[0].display_name,
            pickupLat: pickupLat,
            pickupLng: pickupLng,
            destLat: destLat,
            destLng: destLng,
            rideType: 'car',
            fare: baseFare,
            distance: (distance / 1000).toFixed(2) + ' km',
            status: 'requested',
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            updatedAt: firebase.database.ServerValue.TIMESTAMP,
            paymentMethod: selectedPaymentType,
            orderForSomeone: {
                recipientName: recipientName,
                recipientEmail: recipientEmail,
                recipientPhone: recipientPhone,
                orderedBy: userData.name || 'Passenger'
            },
            currentCity: currentCity
        };
        
        currentRideRequestData = rideRequest;
        currentRideRequestType = 'order-for-someone';
        
        showPaymentSelection(baseFare);
    }).catch(error => {
        console.error('Error in order for someone process:', error);
        showNotification('Error calculating route. Please try again.');
    });
}

// Express Delivery Functions
function updateShopLocationMarker(lat, lng, name) {
    if (shopLocationMarker) {
        passengerMap.removeLayer(shopLocationMarker);
    }
    
    shopLocationMarker = L.marker([lat, lng], {
        icon: L.divIcon({
            className: 'pickup-marker',
            html: '<div class="pickup-marker"><i class="fas fa-shopping-bag"></i></div>',
            iconSize: [22, 22]
        })
    }).addTo(passengerMap)
        .bindPopup(`<strong>${name}</strong><br>Shop Location`)
        .openPopup();
}

function updateDeliveryDestinationMarker(lat, lng, name) {
    if (deliveryDestinationMarker) {
        passengerMap.removeLayer(deliveryDestinationMarker);
    }
    
    deliveryDestinationMarker = L.marker([lat, lng], {
        icon: L.divIcon({
            className: 'destination-marker',
            html: '<div class="destination-marker"><i class="fas fa-flag"></i></div>',
            iconSize: [22, 22]
        })
    }).addTo(passengerMap)
        .bindPopup(`<strong>${name}</strong><br>Delivery Destination`)
        .openPopup();
}

function calculateExpressDeliveryFee() {
    const shopLocation = document.getElementById('shopLocation').value;
    const deliveryDestination = document.getElementById('deliveryDestination').value;
    
    if (shopLocation.length > 3 && deliveryDestination.length > 3) {
        Promise.all([
            forwardGeocode(shopLocation),
            forwardGeocode(deliveryDestination)
        ]).then(([shopResults, destinationResults]) => {
            if (shopResults.length > 0 && destinationResults.length > 0) {
                const shopLat = parseFloat(shopResults[0].lat);
                const shopLng = parseFloat(shopResults[0].lon);
                const destLat = parseFloat(destinationResults[0].lat);
                const destLng = parseFloat(destinationResults[0].lon);
                
                const distance = calculateDistance(shopLat, shopLng, destLat, destLng);
                
                let baseFare = 23;
                
                if (distance > 0) {
                    baseFare += Math.ceil(distance / 90);
                }
                
                const vehicleType = document.querySelector('.express-delivery-form .vehicle-option.selected').getAttribute('data-type');
                switch(vehicleType) {
                    case 'car':
                        baseFare = baseFare;
                        break;
                    case 'bike':
                        baseFare = baseFare * 0.7;
                        break;
                    case 'bicycle':
                        baseFare = baseFare * 0.5;
                        break;
                }
                
                document.getElementById('expressDeliveryFee').textContent = `K${baseFare.toFixed(2)}`;
                
                const etaMinutes = Math.ceil((distance / 1000) / 30 * 60);
                document.getElementById('expressDeliveryEtaDisplay').textContent = `ETA: ${etaMinutes} min`;
                
                document.getElementById('expressDeliveryBtn').disabled = false;
                
                updateShopLocationMarker(shopLat, shopLng, shopResults[0].display_name);
                updateDeliveryDestinationMarker(destLat, destLng, destinationResults[0].display_name);
                
                drawRoute(shopLat, shopLng, destLat, destLng);
            }
        });
    } else {
        document.getElementById('expressDeliveryFee').textContent = 'K0.00';
        document.getElementById('expressDeliveryEtaDisplay').textContent = 'ETA: -- min';
        document.getElementById('expressDeliveryBtn').disabled = true;
    }
}

function submitExpressDelivery() {
    const shopName = document.getElementById('shopName').value;
    const shopLocation = document.getElementById('shopLocation').value;
    const deliveryItems = document.getElementById('deliveryItems').value;
    const deliveryAmount = document.getElementById('deliveryAmount').value;
    const deliveryInstructions = document.getElementById('deliveryInstructions').value;
    const deliveryDestination = document.getElementById('deliveryDestination').value;
    const vehicleType = document.querySelector('.express-delivery-form .vehicle-option.selected').getAttribute('data-type');
    
    if (!shopName || !shopLocation || !deliveryDestination) {
        showNotification('Please fill in all required fields.');
        return;
    }
    
    Promise.all([
        forwardGeocode(shopLocation),
        forwardGeocode(deliveryDestination)
    ]).then(([shopResults, destinationResults]) => {
        if (shopResults.length === 0 || destinationResults.length === 0) {
            showNotification('Invalid shop or destination address. Please select valid locations.');
            return;
        }
        
        const shopLat = parseFloat(shopResults[0].lat);
        const shopLng = parseFloat(shopResults[0].lon);
        const destLat = parseFloat(destinationResults[0].lat);
        const destLng = parseFloat(destinationResults[0].lon);
        
        const distance = calculateDistance(shopLat, shopLng, destLat, destLng);
        
        let baseFare = 23;
        
        if (distance > 0) {
            baseFare += Math.ceil(distance / 90);
        }
        
        switch(vehicleType) {
            case 'car':
                baseFare = baseFare;
                break;
            case 'bike':
                baseFare = baseFare * 0.7;
                break;
            case 'bicycle':
                baseFare = baseFare * 0.5;
                break;
        }
        
        const rideId = database.ref().child('rides').push().key;
        
        const rideRequest = {
            id: rideId,
            passengerId: currentUser.uid,
            passengerName: userData.name || 'Passenger',
            passengerPhone: userData.phone || 'Not provided',
            pickupLocation: shopResults[0].display_name,
            destination: destinationResults[0].display_name,
            pickupLat: shopLat,
            pickupLng: shopLng,
            destLat: destLat,
            destLng: destLng,
            rideType: vehicleType,
            fare: baseFare,
            distance: (distance / 1000).toFixed(2) + ' km',
            status: 'requested',
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            updatedAt: firebase.database.ServerValue.TIMESTAMP,
            paymentMethod: selectedPaymentType,
            expressDelivery: {
                shopName: shopName,
                items: deliveryItems,
                amount: deliveryAmount,
                instructions: deliveryInstructions
            },
            currentCity: currentCity
        };
        
        currentRideRequestData = rideRequest;
        currentRideRequestType = 'express-delivery';
        
        showPaymentSelection(baseFare);
    }).catch(error => {
        console.error('Error in express delivery process:', error);
        showNotification('Error calculating route. Please try again.');
    });
}

// SOS Functions
function saveSOSConfig() {
    const contact1 = document.getElementById('emergencyContact1').value;
    const contact2 = document.getElementById('emergencyContact2').value;
    const message = document.getElementById('sosMessage').value;
    
    if (!contact1) {
        showNotification('Please provide at least one emergency contact.');
        return;
    }
    
    sosConfig = {
        contact1: contact1,
        contact2: contact2,
        message: message
    };
    
    database.ref('sosConfig/' + currentUser.uid).set(sosConfig)
        .then(() => {
            showNotification('SOS configuration saved successfully.');
            
            document.getElementById('sosSetupForm').classList.remove('active');
            
            document.getElementById('rideRequestForm').style.display = 'flex';
        })
        .catch(error => {
            console.error('Error saving SOS config:', error);
            showNotification('Error saving SOS configuration. Please try again.');
        });
}

function triggerSOS() {
    if (!sosConfig || !sosConfig.contact1) {
        showNotification('SOS not configured. Please set up emergency contacts first.');
        return;
    }
    
    if (!currentRide) {
        showNotification('No active ride to report SOS for.');
        return;
    }
    
    const sosAlert = {
        passengerId: currentUser.uid,
        passengerName: userData.name || 'Passenger',
        passengerPhone: userData.phone || 'Not provided',
        emergencyContact1: sosConfig.contact1,
        emergencyContact2: sosConfig.contact2,
        message: sosConfig.message,
        rideDetails: currentRide,
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        location: userLocation
    };
    
    if (currentRide.driverId) {
        database.ref('users/' + currentRide.driverId).once('value')
            .then(driverSnapshot => {
                const driver = driverSnapshot.val();
                if (driver) {
                    sosAlert.driverDetails = {
                        name: driver.name,
                        phone: driver.phone,
                        vehicle: driver.vehicle
                    };
                }
                
                return database.ref('sosAlerts').push().set(sosAlert);
            })
            .then(() => {
                showNotification('SOS alert sent to emergency contacts!');
                
                console.log('SOS Alert:', sosAlert);
            })
            .catch(error => {
                console.error('Error sending SOS alert:', error);
                showNotification('Error sending SOS alert. Please try again or call emergency services directly.');
            });
    } else {
        database.ref('sosAlerts').push().set(sosAlert)
            .then(() => {
                showNotification('SOS alert sent to emergency contacts!');
                
                console.log('SOS Alert:', sosAlert);
            })
            .catch(error => {
                console.error('Error sending SOS alert:', error);
                showNotification('Error sending SOS alert. Please try again or call emergency services directly.');
            });
    }
}

// Event listeners setup
function setupEventListeners() {
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const screen = this.getAttribute('data-screen');
            switchScreen(screen);
        });
    });
    
    document.querySelectorAll('.back-button').forEach(btn => {
        btn.addEventListener('click', function() {
            const screen = this.getAttribute('data-screen');
            switchScreen(screen);
        });
    });
    
    document.querySelectorAll('.vehicle-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.vehicle-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            this.classList.add('selected');
            
            selectedVehicleType = this.getAttribute('data-type');
            
            if (selectedVehicleType === 'bike' || selectedVehicleType === 'bicycle') {
                document.getElementById('packageToggle').style.display = 'flex';
            } else {
                document.getElementById('packageToggle').style.display = 'none';
                document.getElementById('packageForm').classList.remove('active');
            }
            
            updateFareEstimate();
        });
    });
    
    document.getElementById('packageToggle').addEventListener('click', function() {
        document.getElementById('packageForm').classList.toggle('active');
    });
    
    document.querySelectorAll('.payment-method').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.payment-method').forEach(opt => {
                opt.classList.remove('selected');
            });
            this.classList.add('selected');
            paymentMethod = this.getAttribute('data-method');
        });
    });
    
    document.querySelectorAll('.payment-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.payment-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            this.classList.add('selected');
            selectedPaymentType = this.getAttribute('data-payment-type');
            
            if (selectedPaymentType === 'wallet') {
                if (walletBalance < rideFare) {
                    document.getElementById('insufficientBalance').style.display = 'block';
                    document.getElementById('confirmPaymentBtn').disabled = true;
                } else {
                    document.getElementById('insufficientBalance').style.display = 'none';
                    document.getElementById('confirmPaymentBtn').disabled = false;
                }
            } else {
                document.getElementById('insufficientBalance').style.display = 'none';
                document.getElementById('confirmPaymentBtn').disabled = false;
            }
        });
    });
    
    document.getElementById('requestRideBtn').addEventListener('click', requestRide);
    
    document.getElementById('confirmPaymentBtn').addEventListener('click', submitRideRequest);
    
    document.getElementById('closePaymentPopup').addEventListener('click', closePaymentSelection);
    
    document.getElementById('cancelRideBtn').addEventListener('click', cancelRide);
    
    document.getElementById('contactDriverBtn').addEventListener('click', contactDriver);
    
    document.getElementById('promoToggle').addEventListener('click', function() {
        document.getElementById('promoSection').classList.toggle('active');
    });
    
    document.getElementById('applyPromoBtn').addEventListener('click', applyPromoCode);
    
    document.getElementById('shareReferralBtn').addEventListener('click', shareReferralCode);
    document.getElementById('depositBtn').addEventListener('click', depositToWallet);
    document.getElementById('withdrawBtn').addEventListener('click', withdrawFromWallet);
    document.getElementById('whatsappBtn').addEventListener('click', contactWhatsApp);
    document.getElementById('callBtn').addEventListener('click', contactPhone);
    
    document.getElementById('addPaymentMethodBtn').addEventListener('click', addPaymentMethod);
    
    document.getElementById('panelCollapseHandle').addEventListener('click', togglePanelCollapse);
    
    setupSearchInputListeners();
    
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.location-input') && 
            !e.target.closest('.suggestion-list')) {
            hideAllSearchSuggestions();
        }
        
        if (!e.target.closest('.more-options-btn') && !e.target.closest('.more-options-dropdown')) {
            document.getElementById('moreOptionsDropdown').classList.remove('active');
        }
    });
    
    document.querySelectorAll('.saved-location-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const addressType = this.getAttribute('data-address');
            useSavedLocation(addressType);
        });
    });
    
    document.getElementById('historyFilter').addEventListener('change', loadRideHistory);
    document.getElementById('historyDate').addEventListener('change', loadRideHistory);
    
    document.addEventListener('click', function(e) {
        if (e.target.closest('.history-item')) {
            const historyItem = e.target.closest('.history-item');
            const rideId = historyItem.getAttribute('data-ride-id');
            if (rideId) {
                showRideDetailsPopup(rideId);
            }
        }
    });
    
    document.getElementById('closeRidePopup').addEventListener('click', closeRideDetailsPopup);
    document.getElementById('closeRidePopupTop').addEventListener('click', closeRideDetailsPopup);
    
    document.getElementById('moreOptionsBtn').addEventListener('click', toggleMoreOptions);
    
    document.querySelectorAll('.more-option-item').forEach(item => {
        item.addEventListener('click', function() {
            const option = this.getAttribute('data-option');
            handleMoreOptionSelection(option);
        });
    });
    
    document.getElementById('orderForSomeoneBtn').addEventListener('click', submitOrderForSomeone);
    document.getElementById('cancelOrderForSomeoneBtn').addEventListener('click', cancelMoreOptionForm);
    
    document.querySelectorAll('.express-delivery-form .vehicle-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.express-delivery-form .vehicle-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            this.classList.add('selected');
            calculateExpressDeliveryFee();
        });
    });
    
    document.getElementById('expressDeliveryBtn').addEventListener('click', submitExpressDelivery);
    document.getElementById('cancelExpressDeliveryBtn').addEventListener('click', cancelMoreOptionForm);
    
    document.getElementById('saveSosBtn').addEventListener('click', saveSOSConfig);
    document.getElementById('cancelSosSetupBtn').addEventListener('click', cancelMoreOptionForm);
    
    document.getElementById('sosButton').addEventListener('click', triggerSOS);
    
    document.getElementById('scheduleRideBtn').addEventListener('click', openScheduleRidePopup);
    
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        @keyframes slideIn {
            from { transform: translate(-50%, -20px); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }
        .driver-avatar {
            width: 50px !important;
            height: 50px !important;
            font-size: 1.2rem !important;
        }
    `;
    document.head.appendChild(style);
}

function hideAllSearchSuggestions() {
    const searchTypes = [
        'destination', 'pickup', 'recipientPickup', 
        'recipientDestination', 'shopLocation', 'deliveryDestination',
        'schedulePickup', 'scheduleDestination', 'scheduleShop',
        'scheduleDeliveryDest', 'scheduleRecipientPickup', 'scheduleRecipientDest'
    ];
    
    searchTypes.forEach(type => {
        hideSearchSuggestions(type);
    });
}

// Initialize enhanced app features
function initializeApp() {
    console.log("Jubel Passenger App Initialized with Enhanced Features");
    
    const enhancedStyles = `
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .schedule-ride-btn {
            animation: pulse 2s infinite;
        }
        
        .schedule-ride-btn:hover {
            animation: none;
            transform: scale(1.05);
        }
        
        .scheduled-ride-item {
            transition: all 0.3s ease;
        }
        
        .scheduled-ride-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }
        
        .searching .search-indicator {
            animation: pulse 1s infinite;
        }
        
        .driver-avatar {
            width: 50px !important;
            height: 50px !important;
            font-size: 1.2rem !important;
        }
        
        .driver-profile-image {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
    `;
    
    const styleSheet = document.createElement("style");
    styleSheet.type = "text/css";
    styleSheet.innerText = enhancedStyles;
    document.head.appendChild(styleSheet);
    
    setInterval(() => {
        if (userLocation && currentScreen === 'home') {
            determineCurrentCity(userLocation.lat, userLocation.lng)
                .then(city => {
                    console.log("Periodic city update:", city);
                })
                .catch(error => {
                    console.error("Periodic city detection failed:", error);
                });
        }
    }, 60000);
    
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden && currentScreen === 'home') {
            setTimeout(refreshHomeScreen, 1000);
        }
    });
    
    window.addEventListener('load', function() {
        console.log("Jubel Passenger App fully loaded with enhanced city detection and search");
        showNotification('ðŸš— Jubel Passenger App Ready! City-locked search enabled for accurate results.');
    });
    
    window.addEventListener('online', function() {
        showNotification('Connection restored.');
        if (currentScreen === 'home') {
            setTimeout(refreshPassengerPosition, 1000);
        }
    });
    
    window.addEventListener('offline', function() {
        showNotification('You are currently offline. Some features may not work.');
    });
    
    document.addEventListener('keydown', function(e) {
        if ((e.ctrlKey || e.metaKey) && e.key === 's') {
            e.preventDefault();
            openScheduleRidePopup();
        }
        
        if (e.key === 'Escape') {
            if (!document.getElementById('paymentSelectionPopup').classList.contains('hidden')) {
                closePaymentSelection();
            }
            if (!document.getElementById('rideDetailsPopup').classList.contains('hidden')) {
                closeRideDetailsPopup();
            }
            if (!document.getElementById('scheduleRidePopup').classList.contains('hidden')) {
                closeSchedulePopup();
            }
            if (!document.getElementById('chatPopup').classList.contains('hidden')) {
                closeChatPopup();
            }
        }
    });
    
    initializeTooltips();
}

function initializeTooltips() {
    const tooltipElements = [
        { selector: '#scheduleRideBtn', text: 'Schedule rides for later' },
        { selector: '#moreOptionsBtn', text: 'More ride options' },
        { selector: '.floating-balance', text: 'Your wallet balance' },
        { selector: '.city-indicator', text: 'Current city for search' }
    ];
    
    tooltipElements.forEach(item => {
        const element = document.querySelector(item.selector);
        if (element) {
            element.setAttribute('title', item.text);
        }
    });
}

// Initialize everything
setupEventListeners();
    </script>
</body>
</html>




