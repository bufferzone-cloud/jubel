<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jubel - Passenger</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Enhanced CSS with better organization and optimization */
        :root {
            /* Primary Colors */
            --primary-orange: #FF6B35;
            --primary-red: #E74C3C;
            --primary-gradient: linear-gradient(135deg, #FF6B35, #E74C3C);
            --primary-gradient-light: linear-gradient(135deg, rgba(255, 107, 53, 0.9), rgba(231, 76, 60, 0.9));
            
            /* Secondary Colors */
            --secondary-orange: #E55A28;
            --secondary-red: #C0392B;
            --light-orange: #FFE8E0;
            --light-red: #FADBD8;
            --orange-50: #FFF7F2;
            --orange-100: #FFE8E0;
            --orange-200: #FFD1BD;
            --orange-300: #FFB395;
            --orange-400: #FF9468;
            --orange-500: #FF6B35;
            --orange-600: #E55A28;
            --orange-700: #CC491B;
            --orange-800: #B3380E;
            --orange-900: #992700;
            
            /* Neutral Colors */
            --white: #FFFFFF;
            --light-gray: #F5F5F5;
            --gray-100: #F8F9FA;
            --gray-200: #E9ECEF;
            --gray-300: #DEE2E6;
            --gray-400: #CED4DA;
            --gray-500: #ADB5BD;
            --gray-600: #6C757D;
            --gray-700: #495057;
            --gray-800: #343A40;
            --gray-900: #212529;
            --dark-gray: #333333;
            --medium-gray: #777777;
            
            /* Status Colors */
            --success-green: #2ecc71;
            --success-green-light: #D5F4E6;
            --warning-yellow: #f39c12;
            --warning-yellow-light: #FEF5E7;
            --info-blue: #3498db;
            --info-blue-light: #E8F4FC;
            --error-red: #e74c3c;
            --error-red-light: #FDEDED;
            
            /* UI Elements */
            --border-color: #E8E8E8;
            --border-color-light: #F0F0F0;
            --border-radius-sm: 4px;
            --border-radius-md: 6px;
            --border-radius-lg: 8px;
            --border-radius-xl: 12px;
            --border-radius-2xl: 16px;
            --border-radius-circle: 50%;
            
            /* Shadows */
            --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.15);
            --shadow-2xl: 0 25px 50px rgba(0, 0, 0, 0.2);
            --shadow-inner: inset 0 2px 4px rgba(0, 0, 0, 0.06);
            
            /* Spacing */
            --spacing-1: 0.25rem;
            --spacing-2: 0.5rem;
            --spacing-3: 0.75rem;
            --spacing-4: 1rem;
            --spacing-5: 1.25rem;
            --spacing-6: 1.5rem;
            --spacing-8: 2rem;
            --spacing-10: 2.5rem;
            --spacing-12: 3rem;
            --spacing-16: 4rem;
            
            /* Typography */
            --font-size-xs: 0.65rem;
            --font-size-sm: 0.75rem;
            --font-size-base: 0.85rem;
            --font-size-lg: 1rem;
            --font-size-xl: 1.25rem;
            --font-size-2xl: 1.5rem;
            --font-size-3xl: 1.875rem;
            --font-size-4xl: 2.25rem;
            
            /* Font Weights */
            --font-weight-light: 300;
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 600;
            --font-weight-bold: 700;
            --font-weight-extrabold: 800;
            
            /* Transitions */
            --transition-fast: 150ms;
            --transition-normal: 300ms;
            --transition-slow: 500ms;
            --transition-slower: 700ms;
            --transition-ease: ease;
            --transition-ease-in: ease-in;
            --transition-ease-out: ease-out;
            --transition-ease-in-out: ease-in-out;
            --transition-cubic: cubic-bezier(0.4, 0, 0.2, 1);
            
            /* Z-index layers */
            --z-index-negative: -1;
            --z-index-0: 0;
            --z-index-10: 10;
            --z-index-20: 20;
            --z-index-30: 30;
            --z-index-40: 40;
            --z-index-50: 50;
            --z-index-auto: auto;
            
            /* App Specific */
            --app-padding: var(--spacing-4);
            --element-radius: var(--border-radius-md);
            --transition-speed: var(--transition-normal);
            --panel-max-height: 45vh;
            --panel-collapsed-height: 40px;
            --map-z-index: 1;
            --panel-z-index: 100;
            --overlay-z-index: 1000;
            --notification-z-index: 2000;
            --sos-z-index: 150;
            --search-suggestions-z-index: 200;
        }
        
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        *:focus {
            outline: none;
        }
        
        *:focus-visible {
            outline: 2px solid var(--primary-orange);
            outline-offset: 2px;
        }
        
        html {
            font-size: 14px;
            height: 100%;
            scroll-behavior: smooth;
        }
        
        body {
            background-color: var(--white);
            color: var(--dark-gray);
            max-width: 100%;
            overflow-x: hidden;
            height: 100vh;
            font-size: var(--font-size-base);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            line-height: 1.5;
            -webkit-text-size-adjust: 100%;
            text-rendering: optimizeLegibility;
        }
        
        /* Typography Scale */
        h1, h2, h3, h4, h5, h6 {
            font-weight: var(--font-weight-bold);
            line-height: 1.2;
            margin-bottom: var(--spacing-2);
        }
        
        h1 { font-size: var(--font-size-3xl); }
        h2 { font-size: var(--font-size-2xl); }
        h3 { font-size: var(--font-size-xl); }
        h4 { font-size: var(--font-size-lg); }
        h5 { font-size: var(--font-size-base); }
        h6 { font-size: var(--font-size-sm); }
        
        p {
            margin-bottom: var(--spacing-3);
        }
        
        a {
            color: var(--primary-orange);
            text-decoration: none;
            transition: color var(--transition-fast) var(--transition-ease);
        }
        
        a:hover {
            color: var(--secondary-orange);
        }
        
        strong, b {
            font-weight: var(--font-weight-semibold);
        }
        
        small {
            font-size: var(--font-size-sm);
            color: var(--medium-gray);
        }
        
        /* Utility Classes */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        .hidden {
            display: none !important;
        }
        
        .invisible {
            visibility: hidden;
        }
        
        .relative {
            position: relative;
        }
        
        .absolute {
            position: absolute;
        }
        
        .fixed {
            position: fixed;
        }
        
        .sticky {
            position: sticky;
        }
        
        .block {
            display: block;
        }
        
        .inline-block {
            display: inline-block;
        }
        
        .inline {
            display: inline;
        }
        
        .flex {
            display: flex;
        }
        
        .inline-flex {
            display: inline-flex;
        }
        
        .grid {
            display: grid;
        }
        
        .inline-grid {
            display: inline-grid;
        }
        
        .contents {
            display: contents;
        }
        
        .flex-col {
            flex-direction: column;
        }
        
        .flex-row {
            flex-direction: row;
        }
        
        .flex-wrap {
            flex-wrap: wrap;
        }
        
        .flex-nowrap {
            flex-wrap: nowrap;
        }
        
        .flex-1 {
            flex: 1 1 0%;
        }
        
        .flex-auto {
            flex: 1 1 auto;
        }
        
        .flex-initial {
            flex: 0 1 auto;
        }
        
        .flex-none {
            flex: none;
        }
        
        .items-start {
            align-items: flex-start;
        }
        
        .items-end {
            align-items: flex-end;
        }
        
        .items-center {
            align-items: center;
        }
        
        .items-baseline {
            align-items: baseline;
        }
        
        .items-stretch {
            align-items: stretch;
        }
        
        .justify-start {
            justify-content: flex-start;
        }
        
        .justify-end {
            justify-content: flex-end;
        }
        
        .justify-center {
            justify-content: center;
        }
        
        .justify-between {
            justify-content: space-between;
        }
        
        .justify-around {
            justify-content: space-around;
        }
        
        .justify-evenly {
            justify-content: space-evenly;
        }
        
        .gap-1 { gap: var(--spacing-1); }
        .gap-2 { gap: var(--spacing-2); }
        .gap-3 { gap: var(--spacing-3); }
        .gap-4 { gap: var(--spacing-4); }
        .gap-5 { gap: var(--spacing-5); }
        .gap-6 { gap: var(--spacing-6); }
        .gap-8 { gap: var(--spacing-8); }
        
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .w-screen { width: 100vw; }
        .h-screen { height: 100vh; }
        
        .m-0 { margin: 0; }
        .m-1 { margin: var(--spacing-1); }
        .m-2 { margin: var(--spacing-2); }
        .m-3 { margin: var(--spacing-3); }
        .m-4 { margin: var(--spacing-4); }
        
        .p-0 { padding: 0; }
        .p-1 { padding: var(--spacing-1); }
        .p-2 { padding: var(--spacing-2); }
        .p-3 { padding: var(--spacing-3); }
        .p-4 { padding: var(--spacing-4); }
        .p-5 { padding: var(--spacing-5); }
        .p-6 { padding: var(--spacing-6); }
        
        .text-left { text-align: left; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-justify { text-align: justify; }
        
        .text-xs { font-size: var(--font-size-xs); }
        .text-sm { font-size: var(--font-size-sm); }
        .text-base { font-size: var(--font-size-base); }
        .text-lg { font-size: var(--font-size-lg); }
        .text-xl { font-size: var(--font-size-xl); }
        .text-2xl { font-size: var(--font-size-2xl); }
        
        .font-light { font-weight: var(--font-weight-light); }
        .font-normal { font-weight: var(--font-weight-normal); }
        .font-medium { font-weight: var(--font-weight-medium); }
        .font-semibold { font-weight: var(--font-weight-semibold); }
        .font-bold { font-weight: var(--font-weight-bold); }
        .font-extrabold { font-weight: var(--font-weight-extrabold); }
        
        .text-white { color: var(--white); }
        .text-black { color: var(--dark-gray); }
        .text-gray-500 { color: var(--gray-500); }
        .text-gray-600 { color: var(--gray-600); }
        .text-gray-700 { color: var(--gray-700); }
        .text-gray-800 { color: var(--gray-800); }
        .text-orange-500 { color: var(--orange-500); }
        .text-orange-600 { color: var(--orange-600); }
        .text-orange-700 { color: var(--orange-700); }
        
        .bg-white { background-color: var(--white); }
        .bg-black { background-color: var(--dark-gray); }
        .bg-gray-100 { background-color: var(--gray-100); }
        .bg-gray-200 { background-color: var(--gray-200); }
        .bg-gray-300 { background-color: var(--gray-300); }
        .bg-orange-50 { background-color: var(--orange-50); }
        .bg-orange-100 { background-color: var(--orange-100); }
        .bg-orange-500 { background-color: var(--orange-500); }
        .bg-gradient-primary { background: var(--primary-gradient); }
        
        .rounded-sm { border-radius: var(--border-radius-sm); }
        .rounded-md { border-radius: var(--border-radius-md); }
        .rounded-lg { border-radius: var(--border-radius-lg); }
        .rounded-xl { border-radius: var(--border-radius-xl); }
        .rounded-2xl { border-radius: var(--border-radius-2xl); }
        .rounded-full { border-radius: var(--border-radius-circle); }
        
        .shadow-sm { box-shadow: var(--shadow-sm); }
        .shadow-md { box-shadow: var(--shadow-md); }
        .shadow-lg { box-shadow: var(--shadow-lg); }
        .shadow-xl { box-shadow: var(--shadow-xl); }
        
        .border { border: 1px solid var(--border-color); }
        .border-2 { border: 2px solid var(--border-color); }
        .border-0 { border: 0; }
        
        .border-gray-200 { border-color: var(--gray-200); }
        .border-gray-300 { border-color: var(--gray-300); }
        .border-orange-500 { border-color: var(--orange-500); }
        .border-orange-600 { border-color: var(--orange-600); }
        
        .transition { transition: all var(--transition-normal) var(--transition-ease); }
        .transition-fast { transition: all var(--transition-fast) var(--transition-ease); }
        .transition-slow { transition: all var(--transition-slow) var(--transition-ease); }
        
        .opacity-0 { opacity: 0; }
        .opacity-25 { opacity: 0.25; }
        .opacity-50 { opacity: 0.5; }
        .opacity-75 { opacity: 0.75; }
        .opacity-100 { opacity: 1; }
        
        .cursor-pointer { cursor: pointer; }
        .cursor-default { cursor: default; }
        .cursor-not-allowed { cursor: not-allowed; }
        
        .pointer-events-none { pointer-events: none; }
        .pointer-events-auto { pointer-events: auto; }
        
        .select-none { user-select: none; }
        .select-text { user-select: text; }
        
        .overflow-hidden { overflow: hidden; }
        .overflow-auto { overflow: auto; }
        .overflow-x-auto { overflow-x: auto; }
        .overflow-y-auto { overflow-y: auto; }
        
        .whitespace-nowrap { white-space: nowrap; }
        .whitespace-pre { white-space: pre; }
        .whitespace-pre-line { white-space: pre-line; }
        
        .break-words { overflow-wrap: break-word; }
        .break-all { word-break: break-all; }
        
        .truncate {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .line-clamp-1 {
            overflow: hidden;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 1;
        }
        
        .line-clamp-2 {
            overflow: hidden;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 2;
        }
        
        .line-clamp-3 {
            overflow: hidden;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 3;
        }
        
        .z-0 { z-index: var(--z-index-0); }
        .z-10 { z-index: var(--z-index-10); }
        .z-20 { z-index: var(--z-index-20); }
        .z-30 { z-index: var(--z-index-30); }
        .z-40 { z-index: var(--z-index-40); }
        .z-50 { z-index: var(--z-index-50); }
        
        /* Animation Keyframes */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        @keyframes slideInUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutDown {
            from {
                transform: translateY(0);
                opacity: 1;
            }
            to {
                transform: translateY(100%);
                opacity: 0;
            }
        }
        
        @keyframes slideInDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutUp {
            from {
                transform: translateY(0);
                opacity: 1;
            }
            to {
                transform: translateY(-100%);
                opacity: 0;
            }
        }
        
        @keyframes scaleIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        @keyframes scaleOut {
            from {
                transform: scale(1);
                opacity: 1;
            }
            to {
                transform: scale(0.9);
                opacity: 0;
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        
        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }
        
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
        
        @keyframes ping {
            75%, 100% {
                transform: scale(2);
                opacity: 0;
            }
        }
        
        @keyframes sosPulse {
            0% {
                transform: translateX(-50%) scale(1);
                box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7);
            }
            70% {
                transform: translateX(-50%) scale(1.05);
                box-shadow: 0 0 0 10px rgba(231, 76, 60, 0);
            }
            100% {
                transform: translateX(-50%) scale(1);
                box-shadow: 0 0 0 0 rgba(231, 76, 60, 0);
            }
        }
        
        @keyframes pulseRing {
            0% {
                transform: scale(0.8);
                opacity: 1;
            }
            80%, 100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }
        
        /* Animation Classes */
        .animate-fadeIn {
            animation: fadeIn var(--transition-normal) var(--transition-ease);
        }
        
        .animate-fadeOut {
            animation: fadeOut var(--transition-normal) var(--transition-ease);
        }
        
        .animate-slideInUp {
            animation: slideInUp var(--transition-normal) var(--transition-ease);
        }
        
        .animate-slideOutDown {
            animation: slideOutDown var(--transition-normal) var(--transition-ease);
        }
        
        .animate-slideInDown {
            animation: slideInDown var(--transition-normal) var(--transition-ease);
        }
        
        .animate-slideOutUp {
            animation: slideOutUp var(--transition-normal) var(--transition-ease);
        }
        
        .animate-scaleIn {
            animation: scaleIn var(--transition-normal) var(--transition-ease);
        }
        
        .animate-scaleOut {
            animation: scaleOut var(--transition-normal) var(--transition-ease);
        }
        
        .animate-pulse {
            animation: pulse 2s var(--transition-cubic) infinite;
        }
        
        .animate-bounce {
            animation: bounce 1s var(--transition-cubic) infinite;
        }
        
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        
        .animate-ping {
            animation: ping 1s var(--transition-cubic) infinite;
        }
        
        /* Main App Layout */
        #mainApp {
            position: relative;
            width: 100%;
            height: 100vh;
            overflow: hidden;
        }
        
        /* Enhanced Map Styles */
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: var(--map-z-index);
            background-color: #e5e5e5;
        }
        
        .leaflet-container {
            font-family: inherit;
            font-size: inherit;
        }
        
        /* Enhanced Map Controls */
        .leaflet-control-zoom a {
            background-color: var(--white);
            color: var(--dark-gray);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            transition: all var(--transition-fast) var(--transition-ease);
        }
        
        .leaflet-control-zoom a:hover {
            background-color: var(--orange-100);
            border-color: var(--orange-500);
            color: var(--orange-600);
        }
        
        .leaflet-control-attribution {
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: var(--border-radius-sm);
            padding: 2px 5px;
            font-size: var(--font-size-xs);
        }
        
        /* Enhanced Floating Elements */
        .floating-balance {
            position: fixed;
            top: var(--spacing-4);
            right: var(--spacing-4);
            background: var(--white);
            padding: var(--spacing-2) var(--spacing-3);
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-xl);
            z-index: var(--panel-z-index);
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
            font-weight: var(--font-weight-bold);
            color: var(--dark-gray);
            border: 2px solid var(--primary-orange);
            font-size: var(--font-size-sm);
            transition: all var(--transition-speed) var(--transition-ease);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            animation: slideInDown var(--transition-normal) var(--transition-ease);
        }
        
        .floating-balance:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-2xl);
        }
        
        .floating-balance.home-only {
            display: flex;
        }
        
        .balance-amount {
            color: var(--primary-orange);
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-extrabold);
        }
        
        /* Enhanced Ride Status */
        .ride-status {
            position: fixed;
            top: var(--spacing-4);
            right: calc(var(--spacing-4) + 120px);
            background: var(--white);
            padding: var(--spacing-2) var(--spacing-3);
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-xl);
            z-index: var(--panel-z-index);
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
            font-weight: var(--font-weight-bold);
            color: var(--dark-gray);
            border: 2px solid var(--border-color);
            font-size: var(--font-size-sm);
            transition: all var(--transition-speed) var(--transition-ease);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            animation: slideInDown var(--transition-normal) var(--transition-ease);
        }
        
        .ride-status.home-only {
            display: flex;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: var(--border-radius-circle);
            background: var(--medium-gray);
            transition: all var(--transition-fast) var(--transition-ease);
        }
        
        .status-dot.searching {
            background: var(--warning-yellow);
            animation: pulse 2s infinite;
        }
        
        .status-dot.arriving {
            background: var(--info-blue);
            animation: pulse 1.5s infinite;
        }
        
        .status-dot.riding {
            background: var(--success-green);
        }
        
        /* Enhanced Estimated Time */
        .estimated-time {
            position: fixed;
            top: calc(var(--spacing-4) + 50px);
            right: var(--spacing-4);
            background: var(--white);
            padding: var(--spacing-2) var(--spacing-3);
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-xl);
            z-index: var(--panel-z-index);
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
            font-weight: var(--font-weight-bold);
            color: var(--dark-gray);
            border: 2px solid var(--border-color);
            font-size: var(--font-size-sm);
            transition: all var(--transition-speed) var(--transition-ease);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            animation: slideInDown var(--transition-normal) var(--transition-ease);
        }
        
        .estimated-time.home-only {
            display: flex;
        }
        
        /* Enhanced SOS Button */
        .sos-button {
            position: fixed;
            top: var(--spacing-4);
            left: 50%;
            transform: translateX(-50%);
            background: var(--error-red);
            color: var(--white);
            width: 60px;
            height: 60px;
            border-radius: var(--border-radius-circle);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-extrabold);
            box-shadow: var(--shadow-2xl);
            z-index: var(--sos-z-index);
            cursor: pointer;
            animation: sosPulse 2s infinite;
            transition: all var(--transition-fast) var(--transition-ease);
            user-select: none;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .sos-button:hover {
            transform: translateX(-50%) scale(1.1);
            box-shadow: 0 0 20px rgba(231, 76, 60, 0.6);
        }
        
        .sos-button:active {
            transform: translateX(-50%) scale(0.95);
        }
        
        .sos-button:disabled {
            background: var(--gray-500);
            cursor: not-allowed;
            animation: none;
        }
        
        /* Enhanced Searching Animation */
        .searching-animation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: calc(var(--panel-z-index) + 10);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }
        
        .searching-pulse {
            width: 100px;
            height: 100px;
            border-radius: var(--border-radius-circle);
            background: rgba(255, 107, 53, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulseRing 2s infinite;
            position: relative;
        }
        
        .searching-pulse-inner {
            width: 70px;
            height: 70px;
            border-radius: var(--border-radius-circle);
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: var(--font-size-2xl);
            animation: pulse 1.5s infinite;
        }
        
        .searching-text {
            margin-top: var(--spacing-4);
            background: rgba(255, 255, 255, 0.95);
            padding: var(--spacing-3) var(--spacing-4);
            border-radius: var(--border-radius-lg);
            font-weight: var(--font-weight-semibold);
            color: var(--primary-orange);
            box-shadow: var(--shadow-xl);
            text-align: center;
            min-width: 200px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        /* Enhanced Passenger Panel */
        .passenger-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            border-radius: var(--border-radius-2xl) var(--border-radius-2xl) 0 0;
            box-shadow: 0 -4px 30px rgba(0, 0, 0, 0.2);
            z-index: var(--panel-z-index);
            padding: var(--app-padding);
            transform: translateY(0);
            transition: transform var(--transition-speed) var(--transition-cubic);
            max-height: var(--panel-max-height);
            overflow-y: auto;
            animation: slideInUp var(--transition-normal) var(--transition-ease);
            overscroll-behavior: contain;
            touch-action: pan-y;
        }
        
        .passenger-panel.collapsed {
            transform: translateY(calc(100% - var(--panel-collapsed-height)));
        }
        
        .passenger-panel::-webkit-scrollbar {
            width: 6px;
        }
        
        .passenger-panel::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .passenger-panel::-webkit-scrollbar-thumb {
            background: var(--gray-300);
            border-radius: var(--border-radius-sm);
        }
        
        .passenger-panel::-webkit-scrollbar-thumb:hover {
            background: var(--gray-400);
        }
        
        /* Panel Collapse Handle */
        .panel-collapse-handle {
            width: 40px;
            height: 4px;
            background: var(--border-color);
            border-radius: 2px;
            margin: 0 auto var(--spacing-3);
            cursor: pointer;
            transition: all var(--transition-fast) var(--transition-ease);
        }
        
        .panel-collapse-handle:hover {
            background: var(--gray-400);
            transform: scaleX(1.2);
        }
        
        /* Enhanced Navigation Buttons */
        .nav-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--spacing-2);
            margin-bottom: var(--spacing-4);
        }
        
        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-1);
            padding: var(--spacing-3) var(--spacing-2);
            border-radius: var(--element-radius);
            background: var(--light-gray);
            cursor: pointer;
            transition: all var(--transition-speed) var(--transition-ease);
            border: none;
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-semibold);
            color: var(--dark-gray);
            min-height: 70px;
            position: relative;
            overflow: hidden;
        }
        
        .nav-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--primary-gradient);
            opacity: 0;
            transition: opacity var(--transition-speed) var(--transition-ease);
            z-index: 1;
        }
        
        .nav-btn:hover:not(.active) {
            background: var(--orange-100);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .nav-btn.active {
            background: var(--primary-gradient);
            color: var(--white);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }
        
        .nav-btn.active::before {
            opacity: 1;
        }
        
        .nav-btn i {
            font-size: var(--font-size-lg);
            z-index: 2;
            position: relative;
            transition: all var(--transition-speed) var(--transition-ease);
        }
        
        .nav-btn.active i {
            transform: scale(1.1);
        }
        
        .nav-btn span {
            z-index: 2;
            position: relative;
        }
        
        /* Enhanced More Options Button */
        .more-options-btn {
            width: 100%;
            padding: var(--spacing-3);
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--primary-orange);
            color: var(--white);
            cursor: pointer;
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            margin-top: var(--spacing-3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-2);
            transition: all var(--transition-speed) var(--transition-ease);
            position: relative;
            overflow: hidden;
        }
        
        .more-options-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left var(--transition-slow) var(--transition-ease);
        }
        
        .more-options-btn:hover::before {
            left: 100%;
        }
        
        .more-options-btn:hover {
            background: var(--secondary-orange);
            border-color: var(--secondary-orange);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .more-options-btn:active {
            transform: translateY(0);
        }
        
        /* Enhanced More Options Dropdown */
        .more-options-dropdown {
            display: none;
            background: var(--white);
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            margin-top: var(--spacing-2);
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            animation: fadeIn var(--transition-fast) var(--transition-ease);
            position: relative;
            z-index: calc(var(--panel-z-index) + 1);
        }
        
        .more-options-dropdown.active {
            display: block;
        }
        
        .more-option-item {
            padding: var(--spacing-4);
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
            transition: all var(--transition-speed) var(--transition-ease);
            position: relative;
            overflow: hidden;
        }
        
        .more-option-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: var(--light-orange);
            transition: left var(--transition-normal) var(--transition-ease);
            z-index: 0;
        }
        
        .more-option-item:hover::before {
            left: 0;
        }
        
        .more-option-item:hover {
            padding-left: calc(var(--spacing-4) + var(--spacing-2));
        }
        
        .more-option-item:last-child {
            border-bottom: none;
        }
        
        .more-option-icon {
            width: 24px;
            text-align: center;
            font-size: var(--font-size-lg);
            color: var(--primary-orange);
            z-index: 1;
        }
        
        .more-option-item:hover .more-option-icon {
            color: var(--secondary-orange);
        }
        
        .more-option-text {
            flex: 1;
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            color: var(--dark-gray);
            z-index: 1;
        }
        
        /* Enhanced Order for Someone Else Form */
        .order-for-someone-form,
        .express-delivery-form,
        .sos-setup-form {
            display: none;
            flex-direction: column;
            gap: var(--spacing-4);
            margin-top: var(--spacing-4);
            padding: var(--spacing-4);
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
            animation: fadeIn var(--transition-normal) var(--transition-ease);
            position: relative;
        }
        
        .order-for-someone-form.active,
        .express-delivery-form.active,
        .sos-setup-form.active {
            display: flex;
        }
        
        /* Enhanced Delivery Fee Display */
        .delivery-fee-display {
            background: var(--primary-gradient);
            color: var(--white);
            padding: var(--spacing-4);
            border-radius: var(--element-radius);
            text-align: center;
            margin: var(--spacing-3) 0;
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }
        
        .delivery-fee-display::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .delivery-fee-amount {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-extrabold);
            margin: var(--spacing-2) 0;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
        }
        
        .delivery-eta-display {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            opacity: 0.9;
            text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.2);
        }
        
        /* Enhanced Ride Request Form */
        .ride-request-form {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-4);
            animation: fadeIn var(--transition-normal) var(--transition-ease);
        }
        
        /* Enhanced Location Input */
        .location-input {
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
            padding: var(--spacing-3);
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--white);
            position: relative;
            transition: all var(--transition-fast) var(--transition-ease);
            cursor: text;
        }
        
        .location-input:focus-within {
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
            transform: translateY(-1px);
        }
        
        .location-input i {
            color: var(--primary-orange);
            font-size: var(--font-size-base);
            flex-shrink: 0;
        }
        
        .location-input input {
            border: none;
            outline: none;
            width: 100%;
            font-size: var(--font-size-sm);
            background: transparent;
            color: var(--dark-gray);
            font-weight: var(--font-weight-medium);
        }
        
        .location-input input::placeholder {
            color: var(--gray-500);
            font-weight: var(--font-weight-normal);
        }
        
        /* Enhanced Saved Locations */
        .saved-locations {
            display: flex;
            gap: var(--spacing-3);
            margin: var(--spacing-3) 0;
        }
        
        .saved-location-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-2);
            padding: var(--spacing-3);
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
            cursor: pointer;
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-semibold);
            transition: all var(--transition-speed) var(--transition-ease);
            min-height: 44px;
        }
        
        .saved-location-btn:hover {
            background: var(--orange-100);
            border-color: var(--orange-500);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }
        
        .saved-location-btn:active {
            transform: translateY(0);
        }
        
        .saved-location-btn i {
            color: var(--primary-orange);
            font-size: var(--font-size-base);
        }
        
        /* Enhanced Vehicle Selection */
        .vehicle-selection {
            display: flex;
            gap: var(--spacing-3);
            margin: var(--spacing-4) 0;
        }
        
        .vehicle-option {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-2);
            padding: var(--spacing-3) var(--spacing-2);
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) var(--transition-ease);
            min-height: 80px;
            position: relative;
            overflow: hidden;
        }
        
        .vehicle-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--light-orange);
            opacity: 0;
            transition: opacity var(--transition-speed) var(--transition-ease);
            z-index: 0;
        }
        
        .vehicle-option:hover::before {
            opacity: 1;
        }
        
        .vehicle-option.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
            box-shadow: var(--shadow-sm);
            transform: translateY(-2px);
        }
        
        .vehicle-option.selected::before {
            opacity: 1;
        }
        
        .vehicle-icon {
            font-size: var(--font-size-xl);
            color: var(--medium-gray);
            z-index: 1;
            transition: all var(--transition-speed) var(--transition-ease);
        }
        
        .vehicle-option:hover .vehicle-icon {
            color: var(--primary-orange);
            transform: scale(1.1);
        }
        
        .vehicle-option.selected .vehicle-icon {
            color: var(--primary-orange);
            transform: scale(1.1);
        }
        
        .vehicle-name {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            color: var(--dark-gray);
            z-index: 1;
        }
        
        .vehicle-price {
            font-size: var(--font-size-xs);
            color: var(--medium-gray);
            z-index: 1;
        }
        
        .vehicle-option.selected .vehicle-name,
        .vehicle-option.selected .vehicle-price {
            color: var(--dark-gray);
        }
        
        /* Enhanced Package Toggle */
        .package-toggle,
        .promo-toggle {
            width: 100%;
            padding: var(--spacing-3);
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
            cursor: pointer;
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            margin-top: var(--spacing-3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-2);
            transition: all var(--transition-speed) var(--transition-ease);
        }
        
        .package-toggle:hover,
        .promo-toggle:hover {
            background: var(--orange-100);
            border-color: var(--orange-500);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }
        
        .package-toggle:active,
        .promo-toggle:active {
            transform: translateY(0);
        }
        
        .package-toggle i,
        .promo-toggle i {
            color: var(--primary-orange);
            font-size: var(--font-size-base);
        }
        
        /* Enhanced Package Form */
        .package-form,
        .promo-section {
            display: none;
            margin-top: var(--spacing-4);
            padding: var(--spacing-4);
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
            animation: fadeIn var(--transition-normal) var(--transition-ease);
        }
        
        .package-form.active,
        .promo-section.active {
            display: block;
        }
        
        /* Enhanced Form Elements */
        .form-row {
            display: flex;
            gap: var(--spacing-3);
            margin-bottom: var(--spacing-3);
        }
        
        .form-group {
            flex: 1;
        }
        
        .form-group label {
            display: block;
            margin-bottom: var(--spacing-1);
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-sm);
            color: var(--dark-gray);
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: var(--spacing-3);
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: var(--font-size-sm);
            background: var(--white);
            color: var(--dark-gray);
            transition: all var(--transition-fast) var(--transition-ease);
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }
        
        /* Enhanced Promo Input */
        .promo-input {
            display: flex;
            gap: var(--spacing-3);
        }
        
        .promo-input input {
            flex: 1;
            padding: var(--spacing-3);
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: var(--font-size-sm);
            transition: all var(--transition-fast) var(--transition-ease);
        }
        
        .promo-input input:focus {
            outline: none;
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }
        
        .btn-promo {
            background: var(--primary-orange);
            color: var(--white);
            border: none;
            border-radius: var(--element-radius);
            padding: var(--spacing-3) var(--spacing-4);
            cursor: pointer;
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            transition: all var(--transition-speed) var(--transition-ease);
            min-width: 80px;
        }
        
        .btn-promo:hover {
            background: var(--secondary-orange);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }
        
        .btn-promo:active {
            transform: translateY(0);
        }
        
        .btn-promo:disabled {
            background: var(--gray-400);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* Enhanced Fare Display */
        .fare-display {
            background: var(--primary-gradient);
            color: var(--white);
            padding: var(--spacing-4);
            border-radius: var(--element-radius);
            text-align: center;
            margin: var(--spacing-4) 0;
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }
        
        .fare-display::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
            animation: shimmer 2s infinite;
        }
        
        .fare-amount {
            font-size: var(--font-size-3xl);
            font-weight: var(--font-weight-extrabold);
            margin: var(--spacing-2) 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .eta-display {
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-semibold);
            opacity: 0.9;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
        }
        
        /* Enhanced Request Ride Button */
        .request-ride-btn {
            width: 100%;
            padding: var(--spacing-4);
            border: none;
            border-radius: var(--element-radius);
            background: var(--primary-gradient);
            color: var(--white);
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-bold);
            cursor: pointer;
            transition: all var(--transition-speed) var(--transition-ease);
            margin-top: var(--spacing-4);
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }
        
        .request-ride-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left var(--transition-slow) var(--transition-ease);
        }
        
        .request-ride-btn:hover::before {
            left: 100%;
        }
        
        .request-ride-btn:hover {
            background: var(--secondary-orange);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .request-ride-btn:active {
            transform: translateY(0);
            box-shadow: var(--shadow-md);
        }
        
        .request-ride-btn:disabled {
            background: var(--gray-500);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .request-ride-btn:disabled::before {
            display: none;
        }
        
        /* Enhanced Ride Info Panel */
        .ride-info-panel {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: var(--spacing-4);
            box-shadow: var(--shadow-md);
            margin-bottom: var(--spacing-4);
            border: 2px solid var(--border-color);
            display: none;
            animation: fadeIn var(--transition-normal) var(--transition-ease);
        }
        
        /* Enhanced Driver Info */
        .driver-info {
            display: flex;
            align-items: center;
            gap: var(--spacing-4);
            margin-bottom: var(--spacing-4);
            padding-bottom: var(--spacing-4);
            border-bottom: 1px solid var(--border-color);
        }
        
        .driver-avatar {
            width: 60px;
            height: 60px;
            border-radius: var(--border-radius-circle);
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-xl);
            color: var(--white);
            font-weight: var(--font-weight-bold);
            flex-shrink: 0;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-md);
        }
        
        .driver-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: var(--border-radius-circle);
        }
        
        .driver-details {
            flex: 1;
        }
        
        .driver-details h2 {
            font-size: var(--font-size-lg);
            margin-bottom: var(--spacing-1);
            color: var(--dark-gray);
        }
        
        .driver-details p {
            color: var(--medium-gray);
            margin-bottom: var(--spacing-1);
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
            font-size: var(--font-size-sm);
        }
        
        .driver-details p i {
            color: var(--primary-orange);
            width: 16px;
            text-align: center;
        }
        
        /* Enhanced Trip Details */
        .trip-details {
            margin-bottom: var(--spacing-4);
        }
        
        .location-row {
            display: flex;
            align-items: flex-start;
            gap: var(--spacing-3);
            margin-bottom: var(--spacing-3);
        }
        
        .location-icon {
            width: 24px;
            height: 24px;
            border-radius: var(--border-radius-circle);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-xs);
            flex-shrink: 0;
            color: var(--white);
        }
        
        .pickup-icon {
            background: var(--primary-orange);
        }
        
        .destination-icon {
            background: var(--primary-red);
        }
        
        .location-text {
            flex: 1;
        }
        
        .location-text h4 {
            font-size: var(--font-size-sm);
            margin-bottom: var(--spacing-1);
            color: var(--dark-gray);
            font-weight: var(--font-weight-semibold);
        }
        
        .location-text p {
            color: var(--medium-gray);
            font-size: var(--font-size-sm);
            line-height: 1.4;
        }
        
        /* Enhanced Fare Details */
        .fare-details {
            background: var(--orange-50);
            padding: var(--spacing-4);
            border-radius: var(--element-radius);
            margin-bottom: var(--spacing-4);
            border: 1px solid var(--orange-200);
        }
        
        .fare-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-2);
            font-size: var(--font-size-sm);
        }
        
        .fare-row:last-child {
            margin-bottom: 0;
        }
        
        .fare-row.total {
            font-weight: var(--font-weight-bold);
            font-size: var(--font-size-base);
            border-top: 2px solid var(--border-color);
            padding-top: var(--spacing-3);
            margin-top: var(--spacing-3);
        }
        
        /* Enhanced Ride Actions */
        .ride-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-3);
        }
        
        .btn {
            padding: var(--spacing-3) var(--spacing-4);
            border: none;
            border-radius: var(--element-radius);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            cursor: pointer;
            transition: all var(--transition-speed) var(--transition-ease);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-2);
            min-height: 44px;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left var(--transition-normal) var(--transition-ease);
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-cancel {
            background: var(--error-red);
            color: var(--white);
        }
        
        .btn-cancel:hover {
            background: #d62c1a;
        }
        
        .btn-contact {
            background: var(--info-blue);
            color: var(--white);
        }
        
        .btn-contact:hover {
            background: #2980b9;
        }
        
        /* Enhanced Screen Content */
        .screen-content {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--white);
            z-index: calc(var(--panel-z-index) + 10);
            padding: var(--app-padding);
            overflow-y: auto;
            display: none;
            animation: slideInUp var(--transition-normal) var(--transition-ease);
        }
        
        .screen-content.active {
            display: block;
        }
        
        /* Enhanced Screen Header */
        .screen-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-4);
            margin-bottom: var(--spacing-6);
            padding-bottom: var(--spacing-4);
            border-bottom: 2px solid var(--border-color);
            position: sticky;
            top: 0;
            background: var(--white);
            z-index: 1;
            padding-top: var(--spacing-2);
        }
        
        .back-button {
            width: 44px;
            height: 44px;
            border-radius: var(--border-radius-circle);
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            font-size: var(--font-size-lg);
            color: var(--dark-gray);
            transition: all var(--transition-speed) var(--transition-ease);
        }
        
        .back-button:hover {
            background: var(--orange-100);
            color: var(--primary-orange);
            transform: translateX(-2px);
        }
        
        .back-button:active {
            transform: translateX(0);
        }
        
        .screen-title {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            color: var(--dark-gray);
            flex: 1;
        }
        
        /* Enhanced Account Section */
        .account-section,
        .history-section,
        .payments-section {
            margin-bottom: var(--spacing-6);
        }
        
        .account-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-4);
            margin-bottom: var(--spacing-6);
            padding: var(--spacing-4);
            background: var(--light-gray);
            border-radius: var(--element-radius);
        }
        
        .section-title {
            font-size: var(--font-size-lg);
            margin-bottom: var(--spacing-4);
            font-weight: var(--font-weight-bold);
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
            color: var(--dark-gray);
        }
        
        .section-title i {
            color: var(--primary-orange);
        }
        
        /* Enhanced Input Group */
        .input-group {
            margin-bottom: var(--spacing-4);
        }
        
        .input-group label {
            display: block;
            margin-bottom: var(--spacing-2);
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-sm);
            color: var(--dark-gray);
        }
        
        .input-field {
            width: 100%;
            padding: var(--spacing-3);
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: var(--font-size-sm);
            transition: all var(--transition-fast) var(--transition-ease);
            background: var(--white);
            color: var(--dark-gray);
        }
        
        .input-field:focus {
            outline: none;
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }
        
        /* Enhanced Wallet Balance */
        .wallet-balance {
            background: var(--primary-gradient);
            color: var(--white);
            padding: var(--spacing-6);
            border-radius: var(--element-radius);
            text-align: center;
            margin-bottom: var(--spacing-4);
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }
        
        .balance-label {
            font-size: var(--font-size-sm);
            margin-bottom: var(--spacing-2);
            opacity: 0.9;
        }
        
        .balance-amount-large {
            font-size: var(--font-size-4xl);
            font-weight: var(--font-weight-extrabold);
            margin-bottom: var(--spacing-3);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        /* Enhanced Wallet Actions */
        .wallet-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-3);
            margin-bottom: var(--spacing-4);
        }
        
        .btn-wallet {
            background: var(--white);
            color: var(--primary-orange);
            border: 2px solid var(--primary-orange);
            padding: var(--spacing-3);
            font-size: var(--font-size-sm);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) var(--transition-ease);
            font-weight: var(--font-weight-semibold);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-2);
        }
        
        .btn-wallet:hover {
            background: var(--primary-orange);
            color: var(--white);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }
        
        .btn-wallet:active {
            transform: translateY(0);
        }
        
        /* Enhanced Payment Methods */
        .payment-methods {
            margin-top: var(--spacing-4);
        }
        
        .payment-method {
            display: flex;
            align-items: center;
            gap: var(--spacing-4);
            padding: var(--spacing-4);
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            margin-bottom: var(--spacing-3);
            cursor: pointer;
            transition: all var(--transition-speed) var(--transition-ease);
            background: var(--white);
        }
        
        .payment-method:hover {
            border-color: var(--orange-500);
            transform: translateX(4px);
            box-shadow: var(--shadow-sm);
        }
        
        .payment-method.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
            transform: translateX(4px);
        }
        
        .payment-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--border-radius-circle);
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-lg);
            color: var(--medium-gray);
            flex-shrink: 0;
            transition: all var(--transition-speed) var(--transition-ease);
        }
        
        .payment-method:hover .payment-icon {
            background: var(--orange-100);
            color: var(--primary-orange);
        }
        
        .payment-method.selected .payment-icon {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .payment-details {
            flex: 1;
        }
        
        .payment-name {
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-base);
            margin-bottom: var(--spacing-1);
            color: var(--dark-gray);
        }
        
        .payment-info {
            color: var(--medium-gray);
            font-size: var(--font-size-sm);
        }
        
        /* Enhanced History Item */
        .history-item {
            padding: var(--spacing-4);
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) var(--transition-ease);
            font-size: var(--font-size-sm);
            background: var(--white);
            margin-bottom: var(--spacing-3);
        }
        
        .history-item:hover {
            border-color: var(--primary-orange);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .history-item:last-child {
            margin-bottom: 0;
        }
        
        .history-locations {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-2);
            margin-bottom: var(--spacing-3);
        }
        
        .history-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: var(--font-size-sm);
            color: var(--medium-gray);
        }
        
        .history-fare {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-bold);
            color: var(--primary-orange);
        }
        
        .status-badge {
            padding: var(--spacing-1) var(--spacing-3);
            border-radius: 20px;
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-bold);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-completed {
            background: var(--success-green-light);
            color: #2e7d32;
        }
        
        .status-cancelled {
            background: var(--error-red-light);
            color: #c62828;
        }
        
        .status-requested {
            background: var(--warning-yellow-light);
            color: #ef6c00;
        }
        
        .status-accepted {
            background: var(--info-blue-light);
            color: #1565c0;
        }
        
        /* Enhanced History Item Type */
        .history-item-type {
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-bold);
            padding: var(--spacing-1) var(--spacing-3);
            border-radius: var(--border-radius-sm);
            margin-bottom: var(--spacing-2);
            display: inline-block;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .history-item-type.ride {
            background: var(--light-orange);
            color: var(--primary-orange);
        }
        
        .history-item-type.delivery {
            background: var(--light-red);
            color: var(--primary-red);
        }
        
        /* Enhanced History Package Details */
        .history-package-details {
            background: var(--light-gray);
            padding: var(--spacing-3);
            border-radius: var(--element-radius);
            margin: var(--spacing-3) 0;
            font-size: var(--font-size-sm);
        }
        
        .package-detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--spacing-1);
        }
        
        .package-detail-label {
            font-weight: var(--font-weight-semibold);
            color: var(--medium-gray);
        }
        
        .package-detail-value {
            color: var(--dark-gray);
        }
        
        /* Enhanced History Driver Info */
        .history-driver-info {
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
            margin-top: var(--spacing-3);
            padding-top: var(--spacing-3);
            border-top: 2px dashed var(--border-color);
        }
        
        .history-driver-avatar {
            width: 36px;
            height: 36px;
            border-radius: var(--border-radius-circle);
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-sm);
            color: var(--white);
            font-weight: var(--font-weight-bold);
            flex-shrink: 0;
        }
        
        .history-driver-details {
            flex: 1;
        }
        
        .history-driver-name {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            color: var(--dark-gray);
        }
        
        .history-driver-rating {
            font-size: var(--font-size-xs);
            color: var(--medium-gray);
        }
        
        /* Enhanced Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-3);
            margin-bottom: var(--spacing-6);
        }
        
        .stat-card {
            background: var(--light-gray);
            padding: var(--spacing-4);
            border-radius: var(--element-radius);
            text-align: center;
            border: 2px solid var(--border-color);
            transition: all var(--transition-speed) var(--transition-ease);
        }
        
        .stat-card:hover {
            border-color: var(--primary-orange);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }
        
        .stat-number {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-extrabold);
            color: var(--primary-orange);
            margin-bottom: var(--spacing-1);
        }
        
        .stat-label {
            font-size: var(--font-size-xs);
            color: var(--medium-gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Enhanced Referral Section */
        .referral-section {
            background: var(--light-orange);
            padding: var(--spacing-4);
            border-radius: var(--element-radius);
            margin-bottom: var(--spacing-6);
            border: 2px solid var(--orange-200);
        }
        
        .referral-code {
            background: var(--white);
            padding: var(--spacing-4);
            border-radius: var(--element-radius);
            text-align: center;
            margin: var(--spacing-4) 0;
            box-shadow: var(--shadow-sm);
        }
        
        .code {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-extrabold);
            color: var(--primary-orange);
            letter-spacing: 1px;
        }
        
        .description {
            font-size: var(--font-size-sm);
            color: var(--medium-gray);
            margin-top: var(--spacing-2);
        }
        
        /* Enhanced Contact Section */
        .contact-section {
            display: flex;
            gap: var(--spacing-3);
            margin-top: var(--spacing-6);
        }
        
        .contact-btn {
            flex: 1;
            padding: var(--spacing-3);
            border: none;
            border-radius: var(--element-radius);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-2);
            transition: all var(--transition-speed) var(--transition-ease);
        }
        
        .contact-btn.whatsapp {
            background: #25D366;
            color: white;
        }
        
        .contact-btn.whatsapp:hover {
            background: #128C7E;
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }
        
        .contact-btn.phone {
            background: var(--info-blue);
            color: white;
        }
        
        .contact-btn.phone:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }
        
        /* Enhanced Filter Options */
        .filter-options {
            display: flex;
            gap: var(--spacing-3);
            margin-bottom: var(--spacing-6);
        }
        
        .filter-options select,
        .filter-options input {
            flex: 1;
        }
        
        /* Enhanced Loading Text */
        .loading-text {
            text-align: center;
            padding: var(--spacing-8);
            color: var(--medium-gray);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-3);
        }
        
        .loading-text i {
            font-size: var(--font-size-2xl);
            color: var(--primary-orange);
        }
        
        .no-places {
            text-align: center;
            padding: var(--spacing-8);
            color: var(--medium-gray);
        }
        
        /* Enhanced Suggestion List */
        .suggestion-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--white);
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-xl);
            z-index: var(--search-suggestions-z-index);
            max-height: 280px;
            overflow-y: auto;
            display: none;
            animation: fadeIn var(--transition-fast) var(--transition-ease);
            margin-top: var(--spacing-1);
        }
        
        .suggestion-list::-webkit-scrollbar {
            width: 6px;
        }
        
        .suggestion-list::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .suggestion-list::-webkit-scrollbar-thumb {
            background: var(--gray-300);
            border-radius: var(--border-radius-sm);
        }
        
        .suggestion-list::-webkit-scrollbar-thumb:hover {
            background: var(--gray-400);
        }
        
        .suggestion-item {
            padding: var(--spacing-3);
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-fast) var(--transition-ease);
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
        
        .suggestion-item:hover {
            background: var(--orange-50);
        }
        
        .suggestion-item.selected {
            background: var(--orange-100);
        }
        
        .suggestion-icon {
            font-size: var(--font-size-lg);
            width: 24px;
            text-align: center;
            color: var(--primary-orange);
        }
        
        .suggestion-details {
            flex: 1;
        }
        
        .suggestion-name {
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-sm);
            margin-bottom: var(--spacing-1);
            color: var(--dark-gray);
        }
        
        .suggestion-address {
            color: var(--medium-gray);
            font-size: var(--font-size-xs);
        }
        
        .suggestion-distance {
            color: var(--primary-orange);
            font-size: var(--font-size-xs);
            margin-top: var(--spacing-1);
            font-weight: var(--font-weight-semibold);
        }
        
        .category-header {
            padding: var(--spacing-2) var(--spacing-3);
            background: var(--light-gray);
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-xs);
            color: var(--medium-gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border-color);
        }
        
        /* Enhanced Search Loading */
        .search-loading {
            padding: var(--spacing-4);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-3);
        }
        
        .search-spinner {
            width: 30px;
            height: 30px;
            border: 3px solid var(--orange-100);
            border-top-color: var(--primary-orange);
            border-radius: var(--border-radius-circle);
            animation: spin 1s linear infinite;
        }
        
        .search-loading-text {
            font-size: var(--font-size-sm);
            color: var(--medium-gray);
        }
        
        /* Enhanced Search Results */
        .no-results-container,
        .search-error-container {
            padding: var(--spacing-6);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-3);
        }
        
        .no-results-icon,
        .search-error-icon {
            font-size: var(--font-size-2xl);
            color: var(--gray-400);
        }
        
        .no-results-title,
        .search-error-title {
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-base);
            color: var(--dark-gray);
        }
        
        .no-results-subtitle,
        .search-error-subtitle {
            font-size: var(--font-size-sm);
            color: var(--medium-gray);
        }
        
        .retry-search-btn {
            margin-top: var(--spacing-3);
            padding: var(--spacing-2) var(--spacing-4);
            background: var(--primary-orange);
            color: var(--white);
            border: none;
            border-radius: var(--border-radius-sm);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            cursor: pointer;
            transition: all var(--transition-speed) var(--transition-ease);
        }
        
        .retry-search-btn:hover {
            background: var(--secondary-orange);
            transform: translateY(-2px);
        }
        
        /* Enhanced Recent Searches */
        .recent-searches-header {
            padding: var(--spacing-3);
            background: var(--light-gray);
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-sm);
            color: var(--dark-gray);
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
            border-bottom: 1px solid var(--border-color);
        }
        
        .recent-search-item {
            padding: var(--spacing-3);
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-fast) var(--transition-ease);
        }
        
        .recent-search-item:hover {
            background: var(--orange-50);
        }
        
        .recent-search-query {
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-sm);
            color: var(--dark-gray);
        }
        
        .recent-search-query i {
            color: var(--primary-orange);
        }
        
        .recent-search-results {
            margin-top: var(--spacing-2);
        }
        
        .recent-search-result {
            font-size: var(--font-size-xs);
            color: var(--medium-gray);
            margin-bottom: var(--spacing-1);
            padding-left: var(--spacing-4);
        }
        
        /* Enhanced Search Source Indicator */
        .search-source-indicator {
            padding: var(--spacing-2) var(--spacing-3);
            text-align: center;
            font-size: var(--font-size-xs);
            color: var(--gray-500);
            border-top: 1px solid var(--border-color);
            background: var(--light-gray);
        }
        
        /* Enhanced Typing Indicator */
        .typing-indicator {
            padding: var(--spacing-4);
            display: flex;
            justify-content: center;
            gap: var(--spacing-1);
        }
        
        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--primary-orange);
            border-radius: var(--border-radius-circle);
            animation: pulse 1.5s var(--transition-cubic) infinite;
        }
        
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        /* Enhanced Clear Pickup Button */
        .clear-pickup-btn {
            position: absolute;
            right: var(--spacing-3);
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: var(--gray-500);
            cursor: pointer;
            font-size: var(--font-size-base);
            transition: all var(--transition-fast) var(--transition-ease);
            display: none;
        }
        
        .clear-pickup-btn:hover {
            color: var(--error-red);
        }
        
        .location-input:focus-within .clear-pickup-btn {
            display: block;
        }
        
        /* Enhanced City Warning */
        .city-warning {
            position: absolute;
            right: var(--spacing-8);
            top: 50%;
            transform: translateY(-50%);
            color: var(--warning-yellow);
            font-size: var(--font-size-base);
        }
        
        /* Enhanced Popup Overlay */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: var(--overlay-z-index);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-4);
            animation: fadeIn var(--transition-normal) var(--transition-ease);
        }
        
        .popup-overlay.hidden {
            display: none;
        }
        
        .popup-form {
            background: var(--white);
            border-radius: var(--element-radius);
            width: 100%;
            max-width: 450px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: var(--shadow-2xl);
            animation: scaleIn var(--transition-normal) var(--transition-ease);
        }
        
        .large-popup {
            max-width: 700px;
        }
        
        /* Enhanced Popup Header */
        .popup-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-4);
            border-bottom: 2px solid var(--border-color);
            position: sticky;
            top: 0;
            background: var(--white);
            z-index: 1;
        }
        
        .popup-title {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
            color: var(--dark-gray);
        }
        
        .popup-title i {
            color: var(--primary-orange);
        }
        
        .close-popup {
            background: none;
            border: none;
            font-size: var(--font-size-2xl);
            cursor: pointer;
            color: var(--medium-gray);
            transition: all var(--transition-fast) var(--transition-ease);
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--border-radius-circle);
        }
        
        .close-popup:hover {
            background: var(--light-gray);
            color: var(--dark-gray);
        }
        
        /* Enhanced Popup Content */
        .popup-content {
            padding: var(--spacing-4);
        }
        
        .popup-map-container {
            height: 200px;
            border-radius: var(--element-radius);
            overflow: hidden;
            margin-bottom: var(--spacing-4);
            border: 2px solid var(--border-color);
        }
        
        .popup-details {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-3);
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: var(--spacing-3) 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .detail-row:last-child {
            border-bottom: none;
        }
        
        .detail-label {
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-sm);
            color: var(--dark-gray);
        }
        
        .detail-value {
            font-size: var(--font-size-sm);
            color: var(--medium-gray);
            text-align: right;
        }
        
        /* Enhanced Payment Selection Popup */
        .payment-selection-popup {
            max-width: 400px;
        }
        
        .payment-options {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-3);
            margin-bottom: var(--spacing-4);
        }
        
        .payment-option {
            display: flex;
            align-items: center;
            gap: var(--spacing-4);
            padding: var(--spacing-4);
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            margin-bottom: var(--spacing-2);
            cursor: pointer;
            transition: all var(--transition-speed) var(--transition-ease);
            background: var(--white);
        }
        
        .payment-option:hover {
            border-color: var(--orange-500);
            transform: translateX(4px);
            box-shadow: var(--shadow-sm);
        }
        
        .payment-option.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
            transform: translateX(4px);
        }
        
        .payment-option-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--border-radius-circle);
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-xl);
            color: var(--medium-gray);
            flex-shrink: 0;
            transition: all var(--transition-speed) var(--transition-ease);
        }
        
        .payment-option:hover .payment-option-icon {
            background: var(--orange-100);
            color: var(--primary-orange);
        }
        
        .payment-option.selected .payment-option-icon {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .payment-option-details {
            flex: 1;
        }
        
        .payment-option-name {
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-base);
            margin-bottom: var(--spacing-1);
            color: var(--dark-gray);
        }
        
        .payment-option-description {
            color: var(--medium-gray);
            font-size: var(--font-size-sm);
        }
        
        .payment-option-balance {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-bold);
            color: var(--primary-orange);
            margin-top: var(--spacing-1);
        }
        
        .confirm-payment-btn {
            width: 100%;
            padding: var(--spacing-4);
            border: none;
            border-radius: var(--element-radius);
            background: var(--primary-gradient);
            color: var(--white);
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-bold);
            cursor: pointer;
            transition: all var(--transition-speed) var(--transition-ease);
            margin-top: var(--spacing-4);
            box-shadow: var(--shadow-md);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .confirm-payment-btn:hover:not(:disabled) {
            background: var(--secondary-orange);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .confirm-payment-btn:active:not(:disabled) {
            transform: translateY(0);
        }
        
        .confirm-payment-btn:disabled {
            background: var(--gray-500);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .insufficient-balance {
            color: var(--error-red);
            font-size: var(--font-size-sm);
            margin-top: var(--spacing-2);
            display: none;
            align-items: center;
            gap: var(--spacing-2);
            padding: var(--spacing-2);
            background: var(--error-red-light);
            border-radius: var(--border-radius-sm);
        }
        
        /* Enhanced Popup Actions */
        .popup-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: var(--spacing-4);
            gap: var(--spacing-3);
        }
        
        /* Enhanced Driver Details Section */
        .driver-details-section {
            margin-top: var(--spacing-4);
            padding-top: var(--spacing-4);
            border-top: 2px solid var(--border-color);
        }
        
        /* Enhanced Driver Details Card */
        .driver-details-card {
            background: var(--light-orange);
            padding: var(--spacing-4);
            border-radius: var(--element-radius);
            margin-bottom: var(--spacing-4);
            border: 2px solid var(--orange-200);
            display: none;
            animation: fadeIn var(--transition-normal) var(--transition-ease);
        }
        
        .driver-details-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
            margin-bottom: var(--spacing-4);
        }
        
        .driver-details-header h3 {
            font-size: var(--font-size-lg);
            color: var(--primary-orange);
            font-weight: var(--font-weight-bold);
        }
        
        .driver-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-4);
            margin-bottom: var(--spacing-4);
        }
        
        .driver-detail-item {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-1);
        }
        
        .driver-detail-label {
            font-size: var(--font-size-xs);
            color: var(--medium-gray);
            font-weight: var(--font-weight-semibold);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .driver-detail-value {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            color: var(--dark-gray);
        }
        
        .driver-vehicle-details {
            margin-top: var(--spacing-4);
            padding-top: var(--spacing-4);
            border-top: 2px dashed var(--border-color);
        }
        
        .vehicle-detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--spacing-2);
            font-size: var(--font-size-sm);
        }
        
        .vehicle-detail-label {
            color: var(--medium-gray);
        }
        
        .vehicle-detail-value {
            font-weight: var(--font-weight-semibold);
            color: var(--dark-gray);
        }
        
        /* Enhanced Vehicle Image Section */
        .vehicle-image-section {
            margin-top: var(--spacing-4);
            padding: var(--spacing-4);
            background: var(--light-gray);
            border-radius: var(--element-radius);
            border: 2px solid var(--border-color);
        }
        
        .vehicle-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: var(--border-radius-md);
            margin-bottom: var(--spacing-3);
            border: 2px solid var(--border-color);
        }
        
        .vehicle-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-3);
            font-size: var(--font-size-sm);
        }
        
        .vehicle-detail {
            display: flex;
            flex-direction: column;
        }
        
        .vehicle-detail strong {
            color: var(--medium-gray);
            font-size: var(--font-size-xs);
            margin-bottom: var(--spacing-1);
        }
        
        /* Enhanced Chat Popup */
        .chat-driver-info {
            padding: var(--spacing-4);
            border-bottom: 2px solid var(--border-color);
            background: var(--light-orange);
        }
        
        .chat-messages {
            flex: 1;
            padding: var(--spacing-4);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-3);
            background: var(--light-gray);
        }
        
        .chat-message {
            max-width: 80%;
            padding: var(--spacing-3) var(--spacing-4);
            border-radius: 20px;
            margin-bottom: var(--spacing-2);
            word-wrap: break-word;
        }
        
        .own-message {
            align-self: flex-end;
            background: var(--primary-orange);
            color: var(--white);
            border-bottom-right-radius: 4px;
        }
        
        .other-message {
            align-self: flex-start;
            background: var(--white);
            color: var(--dark-gray);
            border: 2px solid var(--border-color);
            border-bottom-left-radius: 4px;
        }
        
        .chat-input-container {
            padding: var(--spacing-4);
            border-top: 2px solid var(--border-color);
            background: var(--white);
        }
        
        /* Enhanced Map Context Menu */
        .map-context-menu {
            min-width: 180px;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-2);
        }
        
        .context-menu-btn {
            padding: var(--spacing-3);
            background: var(--white);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
            transition: all var(--transition-fast) var(--transition-ease);
            color: var(--dark-gray);
        }
        
        .context-menu-btn:hover {
            background: var(--orange-100);
            border-color: var(--orange-500);
            transform: translateY(-2px);
        }
        
        /* Enhanced Nearby Results Popup */
        .nearby-results-popup {
            min-width: 250px;
        }
        
        .nearby-results-popup h4 {
            margin-bottom: var(--spacing-3);
            color: var(--dark-gray);
        }
        
        .nearby-results-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: var(--spacing-3);
        }
        
        .nearby-result-item {
            padding: var(--spacing-3);
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-fast) var(--transition-ease);
        }
        
        .nearby-result-item:hover {
            background: var(--orange-50);
        }
        
        .nearby-result-name {
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-sm);
            color: var(--dark-gray);
            margin-bottom: var(--spacing-1);
        }
        
        .nearby-result-distance {
            font-size: var(--font-size-xs);
            color: var(--medium-gray);
        }
        
        /* Enhanced Rating Stars */
        .rating-stars {
            display: flex;
            gap: var(--spacing-2);
            margin-top: var(--spacing-2);
        }
        
        .star {
            font-size: var(--font-size-2xl);
            color: var(--light-gray);
            cursor: pointer;
            transition: all var(--transition-fast) var(--transition-ease);
        }
        
        .star:hover,
        .star.active {
            color: var(--warning-yellow);
            transform: scale(1.2);
        }
        
        /* Enhanced Notification */
        .notification {
            position: fixed;
            top: var(--spacing-4);
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-gradient);
            color: var(--white);
            padding: var(--spacing-3) var(--spacing-5);
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-2xl);
            z-index: var(--notification-z-index);
            display: none;
            font-weight: var(--font-weight-semibold);
            text-align: center;
            font-size: var(--font-size-sm);
            max-width: 90%;
            animation: slideInDown var(--transition-fast) var(--transition-ease);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .notification.info {
            background: var(--primary-gradient);
        }
        
        .notification.success {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }
        
        .notification.warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }
        
        .notification.error {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        
        /* Enhanced Map Markers */
        .driver-marker {
            background: var(--primary-gradient);
            color: white;
            border-radius: var(--border-radius-circle);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-lg);
            box-shadow: var(--shadow-lg);
            border: 3px solid var(--white);
            animation: pulse 2s infinite;
        }
        
        .driver-marker-label {
            background: var(--white);
            padding: var(--spacing-1) var(--spacing-2);
            border-radius: var(--border-radius-sm);
            margin-top: var(--spacing-1);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-bold);
            box-shadow: var(--shadow-sm);
            text-align: center;
            min-width: 60px;
        }
        
        .pickup-marker {
            background: var(--primary-orange);
            color: white;
            border-radius: var(--border-radius-circle);
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-sm);
            box-shadow: var(--shadow-lg);
            border: 3px solid var(--white);
        }
        
        .destination-marker {
            background: var(--primary-red);
            color: white;
            border-radius: var(--border-radius-circle);
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-sm);
            box-shadow: var(--shadow-lg);
            border: 3px solid var(--white);
        }
        
        .current-location-marker {
            background: var(--info-blue);
            color: white;
            border-radius: var(--border-radius-circle);
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-xs);
            box-shadow: var(--shadow-lg);
            border: 3px solid var(--white);
        }
        
        .temp-pickup-marker {
            background: var(--warning-yellow);
            color: white;
            border-radius: var(--border-radius-circle);
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-sm);
            box-shadow: var(--shadow-lg);
            border: 3px solid var(--white);
            animation: bounce 1s infinite;
        }
        
        /* Enhanced Route Polyline */
        .leaflet-pane .leaflet-shadow-pane {
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
        }
        
        /* Enhanced Responsive Design */
        @media (max-width: 480px) {
            :root {
                --app-padding: var(--spacing-3);
                --panel-max-height: 50vh;
            }
            
            .floating-balance,
            .ride-status,
            .estimated-time {
                padding: var(--spacing-2) var(--spacing-3);
                font-size: var(--font-size-xs);
                top: var(--spacing-2);
                right: var(--spacing-2);
            }
            
            .ride-status {
                right: calc(var(--spacing-2) + 100px);
            }
            
            .estimated-time {
                top: calc(var(--spacing-2) + 40px);
                right: var(--spacing-2);
            }
            
            .sos-button {
                width: 50px;
                height: 50px;
                font-size: var(--font-size-base);
                top: var(--spacing-2);
            }
            
            .passenger-panel {
                padding: var(--spacing-3);
            }
            
            .nav-buttons {
                gap: var(--spacing-1);
            }
            
            .nav-btn {
                padding: var(--spacing-2) var(--spacing-1);
                font-size: 0.6rem;
                min-height: 60px;
            }
            
            .nav-btn i {
                font-size: var(--font-size-base);
            }
            
            .vehicle-selection {
                flex-direction: column;
                gap: var(--spacing-2);
            }
            
            .vehicle-option {
                flex-direction: row;
                justify-content: flex-start;
                min-height: 60px;
                padding: var(--spacing-3);
            }
            
            .vehicle-icon {
                font-size: var(--font-size-lg);
            }
            
            .saved-locations {
                flex-direction: column;
            }
            
            .fare-amount {
                font-size: var(--font-size-2xl);
            }
            
            .delivery-fee-amount {
                font-size: var(--font-size-xl);
            }
            
            .balance-amount-large {
                font-size: var(--font-size-3xl);
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: var(--spacing-2);
            }
            
            .driver-details-grid {
                grid-template-columns: 1fr;
                gap: var(--spacing-3);
            }
            
            .payment-option {
                padding: var(--spacing-3);
            }
            
            .payment-option-icon {
                width: 40px;
                height: 40px;
                font-size: var(--font-size-lg);
            }
            
            .contact-section {
                flex-direction: column;
            }
            
            .filter-options {
                flex-direction: column;
            }
            
            .popup-form {
                max-width: 100%;
                max-height: 90vh;
            }
            
            .popup-header {
                padding: var(--spacing-3);
            }
            
            .popup-content {
                padding: var(--spacing-3);
            }
            
            .popup-map-container {
                height: 150px;
            }
        }
        
        @media (min-width: 481px) and (max-width: 768px) {
            :root {
                --app-padding: var(--spacing-4);
                --panel-max-height: 50vh;
            }
            
            .floating-balance,
            .ride-status,
            .estimated-time {
                padding: var(--spacing-2) var(--spacing-3);
                font-size: var(--font-size-sm);
            }
            
            .nav-buttons {
                gap: var(--spacing-2);
            }
            
            .nav-btn {
                padding: var(--spacing-2) var(--spacing-2);
                font-size: var(--font-size-xs);
                min-height: 70px;
            }
            
            .vehicle-selection {
                gap: var(--spacing-2);
            }
            
            .vehicle-option {
                min-height: 80px;
            }
            
            .fare-amount {
                font-size: var(--font-size-2xl);
            }
            
            .balance-amount-large {
                font-size: var(--font-size-3xl);
            }
            
            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: var(--spacing-2);
            }
            
            .driver-details-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: var(--spacing-3);
            }
            
            .popup-form {
                max-width: 90%;
            }
        }
        
        @media (min-width: 769px) and (max-width: 1024px) {
            .passenger-panel {
                max-width: 500px;
                margin: 0 auto;
                left: 50%;
                transform: translateX(-50%);
                border-radius: var(--border-radius-lg);
            }
            
            .passenger-panel.collapsed {
                transform: translate(-50%, calc(100% - var(--panel-collapsed-height)));
            }
            
            .floating-balance,
            .ride-status,
            .estimated-time {
                max-width: 300px;
                margin: 0 auto;
                left: 50%;
                transform: translateX(-50%);
                right: auto;
            }
            
            .floating-balance {
                top: var(--spacing-4);
                left: calc(50% - 160px);
            }
            
            .ride-status {
                top: var(--spacing-4);
                left: 50%;
            }
            
            .estimated-time {
                top: var(--spacing-4);
                left: calc(50% + 160px);
            }
        }
        
        @media (min-width: 1025px) {
            .passenger-panel {
                max-width: 600px;
                margin: 0 auto;
                left: 50%;
                transform: translateX(-50%);
                border-radius: var(--border-radius-lg);
            }
            
            .passenger-panel.collapsed {
                transform: translate(-50%, calc(100% - var(--panel-collapsed-height)));
            }
            
            .floating-balance,
            .ride-status,
            .estimated-time {
                max-width: 300px;
            }
        }
        
        /* Print Styles */
        @media print {
            .passenger-panel,
            .floating-balance,
            .ride-status,
            .estimated-time,
            .sos-button,
            .searching-animation,
            .notification {
                display: none !important;
            }
            
            #map {
                height: 500px;
                position: relative;
            }
            
            body {
                height: auto;
                overflow: visible;
            }
        }
        
        /* Reduced Motion */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
            
            .sos-button,
            .searching-pulse,
            .searching-pulse-inner,
            .status-dot.searching,
            .status-dot.arriving {
                animation: none;
            }
            
            .fare-display::before,
            .delivery-fee-display::before,
            .request-ride-btn::before,
            .more-options-btn::before,
            .btn::before,
            .more-option-item::before {
                animation: none;
                display: none;
            }
        }
        
        /* Dark Mode Support */
        @media (prefers-color-scheme: dark) {
            :root {
                --white: #1a1a1a;
                --light-gray: #2d2d2d;
                --gray-100: #2d2d2d;
                --gray-200: #3d3d3d;
                --gray-300: #4d4d4d;
                --gray-400: #5d5d5d;
                --gray-500: #7d7d7d;
                --gray-600: #9d9d9d;
                --gray-700: #adadad;
                --gray-800: #cdcdcd;
                --gray-900: #ededed;
                --dark-gray: #ffffff;
                --medium-gray: #9d9d9d;
                --border-color: #3d3d3d;
                --border-color-light: #2d2d2d;
                --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.3);
                --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.3);
                --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.3);
                --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.3);
                --shadow-2xl: 0 25px 50px rgba(0, 0, 0, 0.4);
            }
            
            body {
                background-color: var(--white);
                color: var(--dark-gray);
            }
            
            .location-input,
            .vehicle-option,
            .payment-method,
            .payment-option,
            .history-item,
            .popup-form,
            .popup-overlay {
                background: var(--light-gray);
                border-color: var(--border-color);
            }
            
            .location-input input,
            .form-group input,
            .form-group textarea,
            .form-group select,
            .promo-input input {
                background: var(--light-gray);
                color: var(--dark-gray);
                border-color: var(--border-color);
            }
            
            .suggestion-list {
                background: var(--light-gray);
                border-color: var(--border-color);
            }
            
            .suggestion-item {
                border-color: var(--border-color);
            }
            
            .leaflet-container {
                filter: brightness(0.8) contrast(1.2);
            }
            
            .leaflet-control-zoom a {
                background-color: var(--light-gray);
                color: var(--dark-gray);
                border-color: var(--border-color);
            }
            
            .leaflet-control-attribution {
                background-color: rgba(45, 45, 45, 0.9);
                color: var(--gray-700);
            }
        }
        
        /* High Contrast Mode */
        @media (prefers-contrast: high) {
            :root {
                --primary-orange: #ff5500;
                --primary-red: #ff0000;
                --white: #ffffff;
                --dark-gray: #000000;
                --border-color: #000000;
                --shadow-sm: 0 0 0 1px #000000;
                --shadow-md: 0 0 0 2px #000000;
                --shadow-lg: 0 0 0 3px #000000;
            }
            
            .location-input:focus-within,
            .form-group input:focus,
            .form-group textarea:focus,
            .form-group select:focus,
            .promo-input input:focus {
                outline: 3px solid var(--primary-orange);
                outline-offset: 2px;
            }
            
            .btn:focus,
            .nav-btn:focus,
            .request-ride-btn:focus,
            .confirm-payment-btn:focus {
                outline: 3px solid var(--primary-orange);
                outline-offset: 2px;
            }
        }
    </style>
</head>
<body>
    <!-- Main App Container -->
    <div id="mainApp">
        <!-- Main Map -->
        <div id="map"></div>
        
        <!-- Floating Balance -->
        <div class="floating-balance home-only" role="status" aria-live="polite">
            <i class="fas fa-wallet" aria-hidden="true"></i>
            <span>Balance: <span class="balance-amount" id="walletBalance">K0.00</span></span>
        </div>
        
        <!-- Ride Status -->
        <div class="ride-status home-only" id="rideStatus" role="status" aria-live="polite">
            <div class="status-dot" id="statusDot" aria-hidden="true"></div>
            <span id="statusText">Searching for driver</span>
        </div>
        
        <!-- Estimated Time -->
        <div class="estimated-time home-only" id="estimatedTime" role="status" aria-live="polite">
            <i class="fas fa-clock" aria-hidden="true"></i>
            <span id="timeText">5 min</span>
        </div>
        
        <!-- SOS Button -->
        <button class="sos-button" id="sosButton" aria-label="Emergency SOS button">
            SOS
        </button>
        
        <!-- Driver Search Animation -->
        <div class="searching-animation" id="searchingAnimation" role="status" aria-live="polite">
            <div class="searching-pulse" aria-hidden="true">
                <div class="searching-pulse-inner">
                    <i class="fas fa-car" aria-hidden="true"></i>
                </div>
            </div>
            <div class="searching-text">Searching for driver</div>
        </div>
        
        <!-- Passenger Panel -->
        <section class="passenger-panel" id="passengerPanel" role="region" aria-label="Passenger controls">
            <div class="panel-collapse-handle" id="panelCollapseHandle" role="button" aria-label="Toggle panel" tabindex="0" aria-expanded="true"></div>
            
            <!-- Navigation Buttons -->
            <nav class="nav-buttons" role="tablist" aria-label="Main navigation">
                <button class="nav-btn active" data-screen="home" role="tab" aria-selected="true" aria-controls="homeScreen">
                    <i class="fas fa-home" aria-hidden="true"></i>
                    <span>Home</span>
                </button>
                <button class="nav-btn" data-screen="account" role="tab" aria-selected="false" aria-controls="accountScreen">
                    <i class="fas fa-user" aria-hidden="true"></i>
                    <span>Account</span>
                </button>
                <button class="nav-btn" data-screen="history" role="tab" aria-selected="false" aria-controls="historyScreen">
                    <i class="fas fa-history" aria-hidden="true"></i>
                    <span>History</span>
                </button>
                <button class="nav-btn" data-screen="payments" role="tab" aria-selected="false" aria-controls="paymentsScreen">
                    <i class="fas fa-credit-card" aria-hidden="true"></i>
                    <span>Payments</span>
                </button>
            </nav>
            
            <!-- More Options Button -->
            <button class="more-options-btn" id="moreOptionsBtn" aria-expanded="false" aria-controls="moreOptionsDropdown">
                <i class="fas fa-ellipsis-h" aria-hidden="true"></i>
                More Options
            </button>
            
            <!-- More Options Dropdown -->
            <div class="more-options-dropdown" id="moreOptionsDropdown" role="menu" aria-hidden="true">
                <div class="more-option-item" data-option="order-for-someone" role="menuitem" tabindex="-1">
                    <div class="more-option-icon">
                        <i class="fas fa-user-friends" aria-hidden="true"></i>
                    </div>
                    <div class="more-option-text">Order for Someone Else</div>
                </div>
                <div class="more-option-item" data-option="express-delivery" role="menuitem" tabindex="-1">
                    <div class="more-option-icon">
                        <i class="fas fa-shipping-fast" aria-hidden="true"></i>
                    </div>
                    <div class="more-option-text">Express Delivery</div>
                </div>
                <div class="more-option-item" data-option="sos-setup" role="menuitem" tabindex="-1">
                    <div class="more-option-icon">
                        <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
                    </div>
                    <div class="more-option-text">SOS Setup</div>
                </div>
            </div>
            
            <!-- Home Screen Content -->
            <div id="homeScreenContent" role="tabpanel" aria-labelledby="homeTab">
                <!-- Order for Someone Else Form -->
                <form class="order-for-someone-form" id="orderForSomeoneForm" aria-hidden="true">
                    <h4 class="section-title">Order for Someone Else</h4>
                    
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt" aria-hidden="true"></i>
                        <input type="text" id="recipientPickupLocation" placeholder="Pickup location" aria-label="Recipient pickup location">
                        <div class="suggestion-list" id="recipientPickupSuggestions" role="listbox" aria-hidden="true"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag" aria-hidden="true"></i>
                        <input type="text" id="recipientDestinationLocation" placeholder="Drop-off location" aria-label="Recipient drop-off location">
                        <div class="suggestion-list" id="recipientDestinationSuggestions" role="listbox" aria-hidden="true"></div>
                    </div>
                    
                    <div class="input-group">
                        <label for="recipientName">Recipient's Full Name</label>
                        <input type="text" id="recipientName" class="input-field" placeholder="Full name" required>
                    </div>
                    
                    <div class="input-group">
                        <label for="recipientEmail">Recipient's Email</label>
                        <input type="email" id="recipientEmail" class="input-field" placeholder="Email address">
                    </div>
                    
                    <div class="input-group">
                        <label for="recipientPhone">Recipient's Phone Number</label>
                        <input type="tel" id="recipientPhone" class="input-field" placeholder="Phone number" required>
                    </div>
                    
                    <div class="delivery-fee-display">
                        <p>Delivery Fee</p>
                        <div class="delivery-fee-amount" id="recipientDeliveryFee">K0.00</div>
                        <p class="delivery-eta-display" id="recipientEtaDisplay">ETA: -- min</p>
                    </div>
                    
                    <div class="form-row">
                        <button type="button" class="btn btn-cancel" id="cancelOrderForSomeoneBtn">
                            <i class="fas fa-times-circle" aria-hidden="true"></i>
                            Cancel
                        </button>
                        <button type="button" class="request-ride-btn" id="orderForSomeoneBtn">
                            <i class="fas fa-car" aria-hidden="true"></i>
                            Book Ride
                        </button>
                    </div>
                </form>
                
                <!-- Express Delivery Form -->
                <form class="express-delivery-form" id="expressDeliveryForm" aria-hidden="true">
                    <h4 class="section-title">Express Delivery</h4>
                    
                    <div class="input-group">
                        <label for="shopName">Shop or Restaurant Name</label>
                        <input type="text" id="shopName" class="input-field" placeholder="Name of shop or restaurant" required>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt" aria-hidden="true"></i>
                        <input type="text" id="shopLocation" placeholder="Shop location" aria-label="Shop location" required>
                        <div class="suggestion-list" id="shopLocationSuggestions" role="listbox" aria-hidden="true"></div>
                    </div>
                    
                    <div class="input-group">
                        <label for="deliveryItems">Items to Purchase</label>
                        <textarea id="deliveryItems" class="input-field" placeholder="List of items to be purchased" required></textarea>
                    </div>
                    
                    <div class="input-group">
                        <label for="deliveryAmount">Total Amount to Spend (K)</label>
                        <input type="number" id="deliveryAmount" class="input-field" placeholder="Total amount" min="0" step="0.01" required>
                    </div>
                    
                    <div class="input-group">
                        <label for="deliveryInstructions">Special Instructions</label>
                        <textarea id="deliveryInstructions" class="input-field" placeholder="Any special instructions"></textarea>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag" aria-hidden="true"></i>
                        <input type="text" id="deliveryDestination" placeholder="Delivery destination" aria-label="Delivery destination" required>
                        <div class="suggestion-list" id="deliveryDestinationSuggestions" role="listbox" aria-hidden="true"></div>
                    </div>
                    
                    <div class="vehicle-selection">
                        <div class="vehicle-option" data-type="car" role="radio" aria-checked="false" tabindex="0">
                            <i class="fas fa-car vehicle-icon" aria-hidden="true"></i>
                            <span class="vehicle-name">Car</span>
                            <span class="vehicle-price">Fast & Secure</span>
                        </div>
                        <div class="vehicle-option selected" data-type="bike" role="radio" aria-checked="true" tabindex="0">
                            <i class="fas fa-motorcycle vehicle-icon" aria-hidden="true"></i>
                            <span class="vehicle-name">Bike</span>
                            <span class="vehicle-price">Quick Delivery</span>
                        </div>
                        <div class="vehicle-option" data-type="bicycle" role="radio" aria-checked="false" tabindex="0">
                            <i class="fas fa-bicycle vehicle-icon" aria-hidden="true"></i>
                            <span class="vehicle-name">Bicycle</span>
                            <span class="vehicle-price">Eco Friendly</span>
                        </div>
                    </div>
                    
                    <div class="delivery-fee-display">
                        <p>Delivery Fee</p>
                        <div class="delivery-fee-amount" id="expressDeliveryFee">K0.00</div>
                        <p class="delivery-eta-display" id="expressDeliveryEtaDisplay">ETA: -- min</p>
                    </div>
                    
                    <div class="form-row">
                        <button type="button" class="btn btn-cancel" id="cancelExpressDeliveryBtn">
                            <i class="fas fa-times-circle" aria-hidden="true"></i>
                            Cancel
                        </button>
                        <button type="button" class="request-ride-btn" id="expressDeliveryBtn">
                            <i class="fas fa-shipping-fast" aria-hidden="true"></i>
                            Request Delivery
                        </button>
                    </div>
                </form>
                
                <!-- SOS Setup Form -->
                <form class="sos-setup-form" id="sosSetupForm" aria-hidden="true">
                    <h4 class="section-title">SOS Setup</h4>
                    
                    <div class="input-group">
                        <label for="emergencyContact1">Emergency Contact 1</label>
                        <input type="tel" id="emergencyContact1" class="input-field" placeholder="Phone number" required>
                    </div>
                    
                    <div class="input-group">
                        <label for="emergencyContact2">Emergency Contact 2</label>
                        <input type="tel" id="emergencyContact2" class="input-field" placeholder="Phone number">
                    </div>
                    
                    <div class="input-group">
                        <label for="sosMessage">Emergency Message</label>
                        <textarea id="sosMessage" class="input-field" placeholder="Pre-typed emergency message" required>I need help! My current location and ride details will be shared with you.</textarea>
                    </div>
                    
                    <div class="form-row">
                        <button type="button" class="btn btn-cancel" id="cancelSosSetupBtn">
                            <i class="fas fa-times-circle" aria-hidden="true"></i>
                            Cancel
                        </button>
                        <button type="button" class="request-ride-btn" id="saveSosBtn">
                            <i class="fas fa-save" aria-hidden="true"></i>
                            Save SOS Configuration
                        </button>
                    </div>
                </form>
                
                <!-- Original Ride Request Form -->
                <form class="ride-request-form" id="rideRequestForm">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt" aria-hidden="true"></i>
                        <input type="text" id="pickupLocation" placeholder="Current location" readonly aria-label="Pickup location">
                    </div>
                    <div class="location-input">
                        <i class="fas fa-flag" aria-hidden="true"></i>
                        <input type="text" id="destinationLocation" placeholder="Where to?" aria-label="Destination">
                        <div class="suggestion-list" id="destinationSuggestions" role="listbox" aria-hidden="true"></div>
                    </div>
                    
                    <div class="saved-locations">
                        <button type="button" class="saved-location-btn" data-address="home" aria-label="Use home address">
                            <i class="fas fa-home" aria-hidden="true"></i>
                            Home
                        </button>
                        <button type="button" class="saved-location-btn" data-address="work" aria-label="Use work address">
                            <i class="fas fa-briefcase" aria-hidden="true"></i>
                            Work
                        </button>
                    </div>
                    
                    <div class="vehicle-selection" role="radiogroup" aria-label="Select vehicle type">
                        <div class="vehicle-option selected" data-type="car" role="radio" aria-checked="true" tabindex="0">
                            <i class="fas fa-car vehicle-icon" aria-hidden="true"></i>
                            <span class="vehicle-name">Ride</span>
                            <span class="vehicle-price">Clean Cars</span>
                        </div>
                        <div class="vehicle-option" data-type="bike" role="radio" aria-checked="false" tabindex="0">
                            <i class="fas fa-motorcycle vehicle-icon" aria-hidden="true"></i>
                            <span class="vehicle-name">Delivery</span>
                            <span class="vehicle-price">on time</span>
                        </div>
                        <div class="vehicle-option" data-type="bicycle" role="radio" aria-checked="false" tabindex="0">
                            <i class="fas fa-bicycle vehicle-icon" aria-hidden="true"></i>
                            <span class="vehicle-name">Short Delivery</span>
                            <span class="vehicle-price">on time</span>
                        </div>
                    </div>
                    
                    <!-- Package Delivery Form -->
                    <button type="button" class="package-toggle" id="packageToggle" aria-expanded="false" style="display: none;">
                        <i class="fas fa-box" aria-hidden="true"></i>
                        Add Package Details
                    </button>
                    
                    <div class="package-form" id="packageForm" aria-hidden="true">
                        <h4 class="section-title">Package Delivery Details</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="receiverName">Receiver Name</label>
                                <input type="text" id="receiverName" placeholder="Full name of receiver">
                            </div>
                            <div class="form-group">
                                <label for="receiverPhone">Receiver Phone</label>
                                <input type="tel" id="receiverPhone" placeholder="Phone number">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="packageDescription">Package Description</label>
                            <input type="text" id="packageDescription" placeholder="What is being delivered?">
                        </div>
                        <div class="form-group">
                            <label for="specialInstructions">Special Instructions</label>
                            <textarea id="specialInstructions" placeholder="Any special handling instructions?"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="packageValue">Package Value (K)</label>
                            <input type="number" id="packageValue" placeholder="Estimated value for insurance" min="0" step="0.01">
                        </div>
                    </div>
                    
                    <button type="button" class="promo-toggle" id="promoToggle" aria-expanded="false">
                        <i class="fas fa-tag" aria-hidden="true"></i>
                        Apply Promo Coupon
                    </button>
                    
                    <div class="promo-section" id="promoSection" aria-hidden="true">
                        <div class="promo-input">
                            <input type="text" id="promoCode" placeholder="Promo code" aria-label="Promo code">
                            <button type="button" class="btn-promo" id="applyPromoBtn">Apply</button>
                        </div>
                    </div>
                    
                    <div class="fare-display" role="status" aria-live="polite">
                        <p>Estimated Fare</p>
                        <div class="fare-amount" id="estimatedFare">K0.00</div>
                        <p class="eta-display" id="etaDisplay">ETA: -- min</p>
                    </div>
                    
                    <button type="button" class="request-ride-btn" id="requestRideBtn">
                        <i class="fas fa-car" aria-hidden="true"></i>
                        Request Ride
                    </button>
                </form>
                
                <!-- Ride Info Panel -->
                <div class="ride-info-panel" id="rideInfoPanel" aria-hidden="true" role="region" aria-label="Active ride information">
                    <!-- Driver Details Card -->
                    <div class="driver-details-card" id="driverDetailsCard">
                        <div class="driver-details-header">
                            <i class="fas fa-id-card" aria-hidden="true"></i>
                            <h3>Driver Details</h3>
                        </div>
                        <div class="driver-details-grid">
                            <div class="driver-detail-item">
                                <span class="driver-detail-label">Driver Name</span>
                                <span class="driver-detail-value" id="driverFullName">John Doe</span>
                            </div>
                            <div class="driver-detail-item">
                                <span class="driver-detail-label">Phone</span>
                                <span class="driver-detail-value" id="driverContactPhone">+260 123 456 789</span>
                            </div>
                            <div class="driver-detail-item">
                                <span class="driver-detail-label">Rating</span>
                                <span class="driver-detail-value" id="driverRatingValue">4.8 </span>
                            </div>
                            <div class="driver-detail-item">
                                <span class="driver-detail-label">Experience</span>
                                <span class="driver-detail-value" id="driverExperience">2 years</span>
                            </div>
                        </div>
                        <div class="driver-vehicle-details">
                            <div class="vehicle-detail-row">
                                <span class="vehicle-detail-label">Vehicle Type</span>
                                <span class="vehicle-detail-value" id="vehicleType">Car</span>
                            </div>
                            <div class="vehicle-detail-row">
                                <span class="vehicle-detail-label">Vehicle Model</span>
                                <span class="vehicle-detail-value" id="vehicleModel">Toyota Corolla</span>
                            </div>
                            <div class="vehicle-detail-row">
                                <span class="vehicle-detail-label">License Plate</span>
                                <span class="vehicle-detail-value" id="vehicleLicense">ABC 123</span>
                            </div>
                            <div class="vehicle-detail-row">
                                <span class="vehicle-detail-label">Color</span>
                                <span class="vehicle-detail-value" id="vehicleColor">Blue</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="driver-info">
                        <div class="driver-avatar" id="driverAvatar" role="img" aria-label="Driver profile picture">
                            <i class="fas fa-user" aria-hidden="true"></i>
                        </div>
                        <div class="driver-details">
                            <h2 id="driverName">Driver Name</h2>
                            <p><i class="fas fa-phone" aria-hidden="true"></i> <span id="driverPhone">000-000-0000</span></p>
                            <p><i class="fas fa-car" aria-hidden="true"></i> <span id="vehicleDetails">Toyota Corolla - ABC123</span></p>
                            <p><i class="fas fa-star" aria-hidden="true"></i> <span id="driverRating">4.5 </span></p>
                        </div>
                    </div>
                    
                    <div class="trip-details">
                        <div class="location-row">
                            <div class="location-icon pickup-icon">
                                <i class="fas fa-map-marker-alt" aria-hidden="true"></i>
                            </div>
                            <div class="location-text">
                                <h4>Pickup Location</h4>
                                <p id="currentPickupLocation">123 Main Street, City</p>
                            </div>
                        </div>
                        <div class="location-row">
                            <div class="location-icon destination-icon">
                                <i class="fas fa-flag" aria-hidden="true"></i>
                            </div>
                            <div class="location-text">
                                <h4>Destination</h4>
                                <p id="currentDestinationLocation">456 Oak Avenue, City</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="fare-details">
                        <div class="fare-row">
                            <span>Base Fare</span>
                            <span id="baseFare">K15.00</span>
                        </div>
                        <div class="fare-row">
                            <span>Distance</span>
                            <span id="distanceFare">K5.00</span>
                        </div>
                        <div class="fare-row">
                            <span>Discount</span>
                            <span id="discountFare">-K2.00</span>
                        </div>
                        <div class="fare-row total">
                            <span>Total Fare</span>
                            <span id="totalFare">K18.00</span>
                        </div>
                    </div>
                    
                    <div class="ride-actions">
                        <button class="btn btn-cancel" id="cancelRideBtn" aria-label="Cancel ride">
                            <i class="fas fa-times-circle" aria-hidden="true"></i>
                            Cancel Ride
                        </button>
                        <button class="btn btn-contact" id="contactDriverBtn" aria-label="Contact driver">
                            <i class="fas fa-phone" aria-hidden="true"></i>
                            Contact Driver
                        </button>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Screen Contents -->
        <div class="screen-content" id="homeScreen" role="tabpanel" aria-labelledby="homeTab">
            <!-- Home screen is the map -->
        </div>
        
        <div class="screen-content" id="accountScreen" role="tabpanel" aria-labelledby="accountTab" aria-hidden="true">
            <div class="screen-header">
                <button class="back-button" data-screen="home" aria-label="Go back">
                    <i class="fas fa-arrow-left" aria-hidden="true"></i>
                </button>
                <h2 class="screen-title">Account</h2>
            </div>
            
            <div class="account-section">
                <div class="account-header">
                    <div class="driver-avatar" id="accountAvatar" role="img" aria-label="Your profile picture">
                        <i class="fas fa-user" aria-hidden="true"></i>
                    </div>
                    <div class="driver-details">
                        <h2 id="accountName">Passenger</h2>
                        <p><i class="fas fa-phone" aria-hidden="true"></i> <span id="accountPhone">Not set</span></p>
                        <p><i class="fas fa-envelope" aria-hidden="true"></i> <span id="accountEmail">Not set</span></p>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="ridesCompleted">0</div>
                        <div class="stat-label">Completed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="ridesCancelled">0</div>
                        <div class="stat-label">Cancelled</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="ridesPending">0</div>
                        <div class="stat-label">Pending</div>
                    </div>
                </div>
                
                <div class="referral-section">
                    <h3 class="section-title">
                        <i class="fas fa-share-alt" aria-hidden="true"></i>
                        Refer & Earn
                    </h3>
                    <p>Share your code and get K25 when friends join</p>
                    <div class="referral-code">
                        <div class="code" id="referralCode">JUBEL-XXXX</div>
                        <div class="description">50% discount for new users</div>
                    </div>
                    <button class="btn btn-primary" id="shareReferralBtn" style="width: 100%; margin-top: var(--spacing-3); padding: var(--spacing-3); background: var(--primary-orange); color: white; border: none; border-radius: var(--element-radius);">
                        <i class="fas fa-share" aria-hidden="true"></i>
                        Share Referral Code
                    </button>
                </div>
                
                <div class="wallet-section">
                    <h3 class="section-title">
                        <i class="fas fa-wallet" aria-hidden="true"></i>
                        Jubel Wallet
                    </h3>
                    <div class="wallet-balance">
                        <div class="balance-label">Current Balance</div>
                        <div class="balance-amount-large" id="accountBalance">K0.00</div>
                    </div>
                    <div class="wallet-actions">
                        <button class="btn-wallet" id="depositBtn">
                            <i class="fas fa-plus" aria-hidden="true"></i>
                            Deposit
                        </button>
                        <button class="btn-wallet" id="withdrawBtn">
                            <i class="fas fa-minus" aria-hidden="true"></i>
                            Withdraw
                        </button>
                    </div>
                </div>
                
                <div class="contact-section">
                    <button class="contact-btn whatsapp" id="whatsappBtn">
                        <i class="fab fa-whatsapp" aria-hidden="true"></i>
                        WhatsApp
                    </button>
                    <button class="contact-btn phone" id="callBtn">
                        <i class="fas fa-phone" aria-hidden="true"></i>
                        Call Us
                    </button>
                </div>
            </div>
        </div>
        
        <div class="screen-content" id="historyScreen" role="tabpanel" aria-labelledby="historyTab" aria-hidden="true">
            <div class="screen-header">
                <button class="back-button" data-screen="home" aria-label="Go back">
                    <i class="fas fa-arrow-left" aria-hidden="true"></i>
                </button>
                <h2 class="screen-title">Ride History</h2>
            </div>
            
            <div class="filter-options">
                <select id="historyFilter" class="input-field" aria-label="Filter rides by status">
                    <option value="all">All Rides</option>
                    <option value="requested">Awaiting Driver</option>
                    <option value="accepted">In Progress</option>
                    <option value="completed">Completed</option>
                    <option value="cancelled">Cancelled</option>
                </select>
                <input type="date" id="historyDate" class="input-field" aria-label="Filter rides by date">
            </div>
            
            <div class="history-section">
                <div id="historyList" role="list">
                    <div class="loading-text">
                        <i class="fas fa-spinner fa-spin" aria-hidden="true"></i>
                        Loading ride history...
                    </div>
                </div>
            </div>
        </div>
        
        <div class="screen-content" id="paymentsScreen" role="tabpanel" aria-labelledby="paymentsTab" aria-hidden="true">
            <div class="screen-header">
                <button class="back-button" data-screen="home" aria-label="Go back">
                    <i class="fas fa-arrow-left" aria-hidden="true"></i>
                </button>
                <h2 class="screen-title">Payment Methods</h2>
            </div>
            
            <div class="payments-section">
                <h3 class="section-title">
                    <i class="fas fa-credit-card" aria-hidden="true"></i>
                    Payment Methods
                </h3>
                
                <div class="payment-methods" role="radiogroup" aria-label="Select payment method">
                    <div class="payment-method selected" data-method="airtel" role="radio" aria-checked="true" tabindex="0">
                        <div class="payment-icon">
                            <i class="fas fa-mobile-alt" aria-hidden="true"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Airtel Money</div>
                            <div class="payment-info">Pay with Airtel Money</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-method="mtn" role="radio" aria-checked="false" tabindex="0">
                        <div class="payment-icon">
                            <i class="fas fa-mobile-alt" aria-hidden="true"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">MTN Money</div>
                            <div class="payment-info">Pay with MTN Money</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-method="zamtel" role="radio" aria-checked="false" tabindex="0">
                        <div class="payment-icon">
                            <i class="fas fa-mobile-alt" aria-hidden="true"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Zamtel Money</div>
                            <div class="payment-info">Pay with Zamtel Money</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-method="card" role="radio" aria-checked="false" tabindex="0">
                        <div class="payment-icon">
                            <i class="fas fa-credit-card" aria-hidden="true"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Credit/Debit Card</div>
                            <div class="payment-info">Visa, Mastercard</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-method="cash" role="radio" aria-checked="false" tabindex="0">
                        <div class="payment-icon">
                            <i class="fas fa-money-bill" aria-hidden="true"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Cash</div>
                            <div class="payment-info">Pay with cash</div>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-primary" id="addPaymentMethodBtn" style="width: 100%; margin-top: var(--spacing-4); padding: var(--spacing-3); background: var(--primary-orange); color: white; border: none; border-radius: var(--element-radius);">
                    <i class="fas fa-plus" aria-hidden="true"></i>
                    Add Payment Method
                </button>
            </div>
        </div>
    </div>
    
    <!-- Payment Selection Popup -->
    <div id="paymentSelectionPopup" class="popup-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="paymentPopupTitle">
        <div class="popup-form payment-selection-popup">
            <div class="popup-header">
                <h2 class="popup-title" id="paymentPopupTitle">
                    <i class="fas fa-credit-card" aria-hidden="true"></i>
                    Select Payment Method
                </h2>
                <button class="close-popup" id="closePaymentPopup" aria-label="Close">&times;</button>
            </div>
            <div class="popup-content">
                <div class="payment-options" role="radiogroup" aria-label="Select payment type">
                    <div class="payment-option selected" data-payment-type="wallet" role="radio" aria-checked="true" tabindex="0">
                        <div class="payment-option-icon">
                            <i class="fas fa-wallet" aria-hidden="true"></i>
                        </div>
                        <div class="payment-option-details">
                            <div class="payment-option-name">Jubel Wallet</div>
                            <div class="payment-option-description">Pay with your Jubel wallet balance</div>
                            <div class="payment-option-balance" id="paymentWalletBalance">Balance: K0.00</div>
                        </div>
                    </div>
                    
                    <div class="payment-option" data-payment-type="mobile" role="radio" aria-checked="false" tabindex="0">
                        <div class="payment-option-icon">
                            <i class="fas fa-mobile-alt" aria-hidden="true"></i>
                        </div>
                        <div class="payment-option-details">
                            <div class="payment-option-name">Mobile Money</div>
                            <div class="payment-option-description">Pay with Airtel, MTN or Zamtel Money</div>
                        </div>
                    </div>
                    
                    <div class="payment-option" data-payment-type="cash" role="radio" aria-checked="false" tabindex="0">
                        <div class="payment-option-icon">
                            <i class="fas fa-money-bill" aria-hidden="true"></i>
                        </div>
                        <div class="payment-option-details">
                            <div class="payment-option-name">Cash on Delivery</div>
                            <div class="payment-option-description">Pay with cash when you arrive</div>
                        </div>
                    </div>
                </div>
                
                <div class="insufficient-balance" id="insufficientBalance" role="alert">
                    <i class="fas fa-exclamation-circle" aria-hidden="true"></i>
                    Insufficient balance in your Jubel wallet
                </div>
                
                <button class="confirm-payment-btn" id="confirmPaymentBtn">
                    Confirm Payment & Request Ride
                </button>
            </div>
        </div>
    </div>
    
    <!-- Ride Details Popup -->
    <div id="rideDetailsPopup" class="popup-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="ridePopupTitle">
        <div class="popup-form large-popup">
            <div class="popup-header">
                <h2 class="popup-title" id="ridePopupTitle">
                    <i class="fas fa-info-circle" aria-hidden="true"></i>
                    Ride Details
                </h2>
                <button class="close-popup" id="closeRidePopupTop" aria-label="Close">&times;</button>
            </div>
            <div class="popup-content">
                <div class="popup-map-container" id="popupRideMap"></div>
                <div class="popup-details">
                    <div class="detail-row">
                        <span class="detail-label">Pickup:</span>
                        <span class="detail-value" id="popupRidePickup">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Destination:</span>
                        <span class="detail-value" id="popupRideDestination">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Fare:</span>
                        <span class="detail-value" id="popupRideFare">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Distance:</span>
                        <span class="detail-value" id="popupRideDistance">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Ride Type:</span>
                        <span class="detail-value" id="popupRideType">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Status:</span>
                        <span class="detail-value" id="popupRideStatus">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Date & Time:</span>
                        <span class="detail-value" id="popupRideDate">Loading...</span>
                    </div>
                    
                    <!-- Driver Details Section -->
                    <div id="popupDriverDetails" class="driver-details-section hidden">
                        <h3 class="section-title">Driver Information</h3>
                        <div class="detail-row">
                            <span class="detail-label">Driver Name:</span>
                            <span class="detail-value" id="popupDriverName">Loading...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Phone:</span>
                            <span class="detail-value" id="popupDriverPhone">Loading...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Vehicle:</span>
                            <span class="detail-value" id="popupDriverVehicle">Loading...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Rating:</span>
                            <span class="detail-value" id="popupDriverRating">Loading...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Progress:</span>
                            <span class="detail-value" id="popupDriverProgress">Loading...</span>
                        </div>
                    </div>
                    
                    <div class="popup-actions">
                        <button class="btn btn-primary" id="closeRidePopup" style="padding: var(--spacing-3) var(--spacing-4); background: var(--primary-orange); color: white; border: none; border-radius: var(--element-radius);">
                            <i class="fas fa-times" aria-hidden="true"></i>
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification" role="alert" aria-live="assertive" aria-atomic="true"></div>
    
    <!-- Firebase and Leaflet JS -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <script>
// Enhanced Jubel Passenger Application
// ===================================
// Advanced features with improved performance, better organization,
// enhanced accessibility, and optimized code structure.

// File size: Over 7900 lines of optimized code

// Firebase configuration
const firebaseConfig = {
    apiKey: "AIzaSyDEACX_P4c5q7djJAcA0I7Lk7leO2TlQ74",
    authDomain: "jubel-13e1a.firebaseapp.com",
    databaseURL: "https://jubel-13e1a-default-rtdb.firebaseio.com",
    projectId: "jubel-13e1a",
    storageBucket: "jubel-13e1a.firebasestorage.app",
    messagingSenderId: "882241095445",
    appId: "1:882241095445:web:ee9ca40fddd008ca910b1c",
    measurementId: "G-J5JPKL6B5F"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const auth = firebase.auth();

// Advanced App State Management
let currentUser = null;
let currentRide = null;
let passengerMap = null;
let popupRideMap = null;
let locationWatchId = null;
let currentLocationMarker = null;
let pickupMarker = null;
let destinationMarker = null;
let driverMarker = null;
let routePolyline = null;
let selectedVehicleType = 'car';
let walletBalance = 0;
let userFullName = "Passenger";
let driverAssignmentListener = null;
let rideHistoryListener = null;
let activeRideListener = null;
let appliedPromoCode = null;
let userStats = {
    completed: 0,
    cancelled: 0,
    pending: 0
};
let paymentMethod = 'airtel';
let userRating = 0;
let userLocation = null;
let destinationSearchResults = [];
let selectedDestination = null;
let driverLocationListener = null;
let userData = null;
let selectedPaymentType = 'wallet';
let rideFare = 0;
let currentCity = null;
let packageDetails = null;
let walletBalanceListener = null;
let currentScreen = 'home';
let homeScreenRefreshRequired = false;

// Advanced Search State Management
let sosConfig = null;
let activeMoreOption = null;
let recipientPickupMarker = null;
let recipientDestinationMarker = null;
let shopLocationMarker = null;
let deliveryDestinationMarker = null;
let chatListener = null;
let currentChatRideId = null;
let unreadMessages = {};
let chatPopupClosedByUser = false;
let driverMessageListener = null;

// Advanced Search Engine State
let pickupSearchResults = [];
let recipientPickupSearchResults = [];
let shopLocationSearchResults = [];
let deliveryDestinationSearchResults = [];
let activeSearchField = null;
let currentRideRequestType = 'standard';
let currentRideRequestData = null;
let driverProfileImage = null;
let driverVehicleImage = null;
let activeRideRestored = false;

// Performance Monitoring
let performanceMetrics = {
    appStartTime: Date.now(),
    mapLoadTime: 0,
    geolocationTime: 0,
    firebaseConnectTime: 0,
    searchResponseTimes: [],
    rideRequestTimes: [],
    notificationQueue: []
};

// Error Tracking
let errorLog = [];

// Advanced Zambian City Database
const zambianCities = [
    'Lusaka', 'Kitwe', 'Ndola', 'Kabwe', 'Chipata', 'Chingola', 
    'Mufulira', 'Luanshya', 'Livingstone', 'Kasama', 'Solwezi', 
    'Kapiri Mposhi', 'Chililabombwe', 'Mazabuka', 'Mongu', 'Kafue',
    'Choma', 'Mansa', 'Mpika', 'Nchelenge', 'Samfya', 'Sesheke',
    'Siavonga', 'Sinazongwe', 'Kalulushi', 'Lufwanyama', 'Mumbwa'
];

// Enhanced City Aliases Database
const cityAliases = {
    'lusaka': 'Lusaka', 'lsk': 'Lusaka', 'lsk city': 'Lusaka', 'capital': 'Lusaka',
    'kitwe': 'Kitwe', 'kw': 'Kitwe',
    'ndola': 'Ndola', 'nd': 'Ndola',
    'kabwe': 'Kabwe', 'broken hill': 'Kabwe',
    'chipata': 'Chipata', 'east capital': 'Chipata',
    'chingola': 'Chingola', 'ching': 'Chingola',
    'mufulira': 'Mufulira', 'muf': 'Mufulira',
    'luanshya': 'Luanshya', 'l/s': 'Luanshya',
    'livingstone': 'Livingstone', 'liv': 'Livingstone', 'tourist capital': 'Livingstone',
    'kasama': 'Kasama', 'north capital': 'Kasama',
    'solwezi': 'Solwezi', 'sol': 'Solwezi',
    'kapiri mposhi': 'Kapiri Mposhi', 'kapiri': 'Kapiri Mposhi', 'km': 'Kapiri Mposhi',
    'chililabombwe': 'Chililabombwe', 'chili': 'Chililabombwe', 'cb': 'Chililabombwe',
    'mazabuka': 'Mazabuka', 'maz': 'Mazabuka',
    'mongu': 'Mongu', 'west capital': 'Mongu',
    'kafue': 'Kafue', 'kf': 'Kafue',
    'choma': 'Choma', 'ch': 'Choma',
    'mansa': 'Mansa', 'luapula capital': 'Mansa',
    'mpika': 'Mpika', 'mp': 'Mpika',
    'nchelenge': 'Nchelenge', 'nch': 'Nchelenge',
    'samfya': 'Samfya', 'sf': 'Samfya',
    'sesheke': 'Sesheke', 'ss': 'Sesheke',
    'siavonga': 'Siavonga', 'sv': 'Siavonga',
    'sinazongwe': 'Sinazongwe', 'sz': 'Sinazongwe',
    'kalulushi': 'Kalulushi', 'kl': 'Kalulushi',
    'lufwanyama': 'Lufwanyama', 'lf': 'Lufwanyama',
    'mumbwa': 'Mumbwa', 'mw': 'Mumbwa'
};

// Enhanced City Boundaries with Multi-Zone Detection
const cityBoundaries = {
    'Lusaka': {
        center: { lat: -15.4167, lng: 28.2833 },
        radius: 25000,
        zones: {
            'CBD': { center: { lat: -15.4167, lng: 28.2833 }, radius: 5000 },
            'Woodlands': { center: { lat: -15.3922, lng: 28.3158 }, radius: 3000 },
            'Kabulonga': { center: { lat: -15.4050, lng: 28.2983 }, radius: 2500 },
            'Roma': { center: { lat: -15.3950, lng: 28.2783 }, radius: 3000 },
            'Northmead': { center: { lat: -15.4100, lng: 28.2733 }, radius: 2000 },
            'Matero': { center: { lat: -15.4300, lng: 28.2300 }, radius: 4000 },
            'Chilenje': { center: { lat: -15.4283, lng: 28.2933 }, radius: 3500 },
            'Chelstone': { center: { lat: -15.3783, lng: 28.3283 }, radius: 3000 },
            'Chainda': { center: { lat: -15.4383, lng: 28.3183 }, radius: 3000 },
            'Kalingalinga': { center: { lat: -15.4250, lng: 28.2750 }, radius: 2500 }
        }
    },
    'Kitwe': {
        center: { lat: -12.8139, lng: 28.2136 },
        radius: 20000,
        zones: {
            'CBD': { center: { lat: -12.8139, lng: 28.2136 }, radius: 4000 },
            'Parklands': { center: { lat: -12.8183, lng: 28.1950 }, radius: 3000 },
            'Nkana East': { center: { lat: -12.8300, lng: 28.2283 }, radius: 3500 },
            'Nkana West': { center: { lat: -12.8383, lng: 28.2050 }, radius: 3000 },
            'Riverside': { center: { lat: -12.7950, lng: 28.1950 }, radius: 2500 },
            'Chimwemwe': { center: { lat: -12.8500, lng: 28.1850 }, radius: 3000 }
        }
    },
    'Ndola': {
        center: { lat: -12.9667, lng: 28.6333 },
        radius: 20000,
        zones: {
            'CBD': { center: { lat: -12.9667, lng: 28.6333 }, radius: 4000 },
            'Northrise': { center: { lat: -12.9533, lng: 28.6150 }, radius: 3500 },
            'Nkwazi': { center: { lat: -12.9550, lng: 28.6483 }, radius: 3000 },
            'Itawa': { center: { lat: -12.9900, lng: 28.6150 }, radius: 3000 },
            'Masala': { center: { lat: -12.9883, lng: 28.6533 }, radius: 3500 }
        }
    },
    'Livingstone': {
        center: { lat: -17.8416, lng: 25.8543 },
        radius: 15000,
        zones: {
            'CBD': { center: { lat: -17.8416, lng: 25.8543 }, radius: 3000 },
            'Maramba': { center: { lat: -17.8600, lng: 25.8300 }, radius: 2500 },
            'Dambwa': { center: { lat: -17.8800, lng: 25.8400 }, radius: 2000 }
        }
    },
    'Kabwe': {
        center: { lat: -14.4431, lng: 28.4517 },
        radius: 15000,
        zones: {
            'CBD': { center: { lat: -14.4431, lng: 28.4517 }, radius: 3000 },
            'Riverside': { center: { lat: -14.4300, lng: 28.4700 }, radius: 2000 },
            'Nkrumah': { center: { lat: -14.4500, lng: 28.4300 }, radius: 2500 }
        }
    }
};

// Advanced Zambian Address Database
const zambianAddressPatterns = {
    houseNumbers: {
        regex: /(?:house|hse|plot|stand|lot|no|number)[\s\.]*#?[\s\.]*(\d+[a-zA-Z]?|\d+\/\d+)/i,
        formats: [
            'House No. {number}',
            'Plot {number}',
            'Stand {number}',
            'House {number}',
            'No. {number}',
            'Plot {number}',
            'Stand {number}'
        ]
    },
    roads: {
        common: ['Great East', 'Great North', 'Cairo', 'Lumumba', 'Freedom', 'Independence', 'Church', 'Kabelenga', 'Mumbwa', 'Chingola'],
        types: ['Road', 'Street', 'Avenue', 'Drive', 'Way', 'Boulevard', 'Close', 'Crescent']
    },
    compounds: [
        'Matero', 'Kanyama', 'Chawama', 'George', 'Mandevu', 'Chilenje', 'Kabwata',
        'Chipata', 'Kalingalinga', 'Ng\'ombe', 'Chaisa', 'Mtendere', 'Kabulonga',
        'Roma', 'Woodlands', 'Northmead', 'Kabulonga', 'Chelstone', 'Kalikiliki'
    ],
    shoppingCenters: [
        'Manda Hill', 'East Park', 'Levy Junction', 'Cosmopolitan', 'Arcades',
        'Findeco', 'Kamwala', 'Soweto', 'Chachacha', 'Chilenge', 'Town Centre'
    ],
    institutions: {
        universities: ['UNZA', 'CBU', 'ZCAS', 'Evelyn Hone', 'Rusangu', 'Mulungushi'],
        hospitals: ['UTH', 'Levy Mwanawasa', 'Chipata Central', 'Kitwe Central', 'Ndola Central'],
        schools: ['Munali', 'Roma Girls', 'St Mary\'s', 'Chengelo', 'Mpelembe', 'Lechwe']
    }
};

// Advanced Search Engine Configuration
const searchConfig = {
    maxResults: 15,
    debounceTime: 300,
    minQueryLength: 2,
    priority: {
        exactMatch: 100,
        partialMatch: 50,
        cityMatch: 30,
        zoneMatch: 20,
        distanceMatch: 10
    },
    filters: {
        withinCity: true,
        prioritizeInfrastructure: true,
        includeHouseNumbers: true,
        includeCompounds: true
    }
};

// Enhanced User Session Management
class UserSession {
    constructor() {
        this.sessionId = this.generateSessionId();
        this.searchHistory = [];
        this.preferences = {
            favoriteLocations: [],
            searchFilters: {
                includeCompounds: true,
                includeShoppingCenters: true,
                includeInstitutions: true
            }
        };
        this.cache = {
            recentSearches: [],
            locationCache: new Map(),
            cityCache: null
        };
        this.metrics = {
            searchesPerformed: 0,
            averageSearchTime: 0,
            cacheHits: 0,
            cacheMisses: 0
        };
    }

    generateSessionId() {
        return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    addSearchToHistory(query, results, city) {
        const searchEntry = {
            query,
            timestamp: Date.now(),
            resultsCount: results.length,
            city,
            location: userLocation ? { lat: userLocation.lat, lng: userLocation.lng } : null
        };
        
        this.searchHistory.unshift(searchEntry);
        if (this.searchHistory.length > 50) {
            this.searchHistory.pop();
        }
        
        this.cache.recentSearches.unshift({
            query,
            results: results.slice(0, 5),
            timestamp: Date.now()
        });
        
        if (this.cache.recentSearches.length > 20) {
            this.cache.recentSearches.pop();
        }
        
        this.metrics.searchesPerformed++;
    }

    getCachedResults(query, searchType) {
        const cached = this.cache.recentSearches.find(s => 
            s.query.toLowerCase() === query.toLowerCase() && 
            Date.now() - s.timestamp < 300000 // 5 minutes
        );
        
        if (cached) {
            this.metrics.cacheHits++;
            return cached.results;
        }
        
        this.metrics.cacheMisses++;
        return [];
    }

    cacheLocation(key, data) {
        this.cache.locationCache.set(key, {
            data,
            timestamp: Date.now()
        });
        
        // Limit cache size
        if (this.cache.locationCache.size > 100) {
            const oldestKey = Array.from(this.cache.locationCache.keys())[0];
            this.cache.locationCache.delete(oldestKey);
        }
    }

    getCachedLocation(key) {
        const cached = this.cache.locationCache.get(key);
        if (cached && Date.now() - cached.timestamp < 600000) { // 10 minutes
            return cached.data;
        }
        return null;
    }
    
    updateSearchMetrics(responseTime) {
        this.metrics.averageSearchTime = 
            (this.metrics.averageSearchTime * (this.metrics.searchesPerformed - 1) + responseTime) / 
            this.metrics.searchesPerformed;
    }
}

// Advanced Geospatial Indexing System
class SpatialIndex {
    constructor() {
        this.points = [];
        this.kdTree = null;
        this.indexed = false;
    }

    addPoint(point) {
        this.points.push({
            id: point.id,
            lat: point.lat,
            lng: point.lng,
            data: point.data
        });
        this.indexed = false;
    }

    buildIndex() {
        if (this.points.length === 0) return;
        
        // Simple spatial partitioning for fast searches
        this.points.sort((a, b) => a.lat - b.lat);
        this.indexed = true;
    }

    searchNearby(lat, lng, radius = 5000, maxResults = 20) {
        if (!this.indexed) this.buildIndex();
        
        const results = [];
        const earthRadius = 6371000; // meters
        
        for (const point of this.points) {
            const distance = this.calculateDistance(lat, lng, point.lat, point.lng);
            
            if (distance <= radius) {
                results.push({
                    ...point,
                    distance
                });
                
                if (results.length >= maxResults) break;
            }
        }
        
        return results.sort((a, b) => a.distance - b.distance);
    }

    calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371000;
        const 1 = lat1 * Math.PI / 180;
        const 2 = lat2 * Math.PI / 180;
        const  = (lat2 - lat1) * Math.PI / 180;
        const  = (lon2 - lon1) * Math.PI / 180;

        const a = Math.sin(/2) * Math.sin(/2) +
                Math.cos(1) * Math.cos(2) *
                Math.sin(/2) * Math.sin(/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

        return R * c;
    }
}

// Performance Monitoring System
class PerformanceMonitor {
    constructor() {
        this.metrics = {
            appStartTime: Date.now(),
            componentLoadTimes: {},
            apiResponseTimes: [],
            renderTimes: [],
            memoryUsage: [],
            errors: []
        };
        
        this.startTimes = {};
        this.performanceObservers = [];
    }

    startTimer(name) {
        this.startTimes[name] = Date.now();
    }

    endTimer(name) {
        if (this.startTimes[name]) {
            const duration = Date.now() - this.startTimes[name];
            if (!this.metrics.componentLoadTimes[name]) {
                this.metrics.componentLoadTimes[name] = [];
            }
            this.metrics.componentLoadTimes[name].push(duration);
            delete this.startTimes[name];
            return duration;
        }
        return 0;
    }

    logApiCall(endpoint, duration, success = true) {
        this.metrics.apiResponseTimes.push({
            endpoint,
            duration,
            timestamp: Date.now(),
            success
        });
        
        // Keep only last 100 API calls
        if (this.metrics.apiResponseTimes.length > 100) {
            this.metrics.apiResponseTimes.shift();
        }
    }

    logRenderTime(component, duration) {
        this.metrics.renderTimes.push({
            component,
            duration,
            timestamp: Date.now()
        });
        
        // Keep only last 50 render times
        if (this.metrics.renderTimes.length > 50) {
            this.metrics.renderTimes.shift();
        }
    }

    logError(error, context) {
        const errorEntry = {
            error: error instanceof Error ? error.message : String(error),
            stack: error instanceof Error ? error.stack : null,
            context,
            timestamp: Date.now(),
            userAgent: navigator.userAgent
        };
        
        this.metrics.errors.push(errorEntry);
        
        // Keep only last 50 errors
        if (this.metrics.errors.length > 50) {
            this.metrics.errors.shift();
        }
        
        console.error(`[PerformanceMonitor] Error in ${context}:`, error);
    }

    getPerformanceReport() {
        const now = Date.now();
        const appUptime = now - this.metrics.appStartTime;
        
        const report = {
            appUptime,
            componentLoadTimes: {},
            averageApiResponseTime: 0,
            averageRenderTime: 0,
            totalErrors: this.metrics.errors.length,
            memoryUsage: performance.memory ? {
                usedJSHeapSize: performance.memory.usedJSHeapSize,
                totalJSHeapSize: performance.memory.totalJSHeapSize,
                jsHeapSizeLimit: performance.memory.jsHeapSizeLimit
            } : null
        };
        
        // Calculate average component load times
        Object.keys(this.metrics.componentLoadTimes).forEach(component => {
            const times = this.metrics.componentLoadTimes[component];
            report.componentLoadTimes[component] = {
                average: times.reduce((a, b) => a + b, 0) / times.length,
                count: times.length,
                latest: times[times.length - 1]
            };
        });
        
        // Calculate average API response time
        if (this.metrics.apiResponseTimes.length > 0) {
            report.averageApiResponseTime = 
                this.metrics.apiResponseTimes.reduce((sum, entry) => sum + entry.duration, 0) / 
                this.metrics.apiResponseTimes.length;
        }
        
        // Calculate average render time
        if (this.metrics.renderTimes.length > 0) {
            report.averageRenderTime = 
                this.metrics.renderTimes.reduce((sum, entry) => sum + entry.duration, 0) / 
                this.metrics.renderTimes.length;
        }
        
        return report;
    }

    setupPerformanceObservers() {
        // Observe long tasks
        if ('PerformanceObserver' in window) {
            try {
                const longTaskObserver = new PerformanceObserver((list) => {
                    for (const entry of list.getEntries()) {
                        if (entry.duration > 50) { // 50ms threshold for long tasks
                            console.warn(`[PerformanceMonitor] Long task detected: ${entry.duration}ms`);
                        }
                    }
                });
                
                longTaskObserver.observe({ entryTypes: ['longtask'] });
                this.performanceObservers.push(longTaskObserver);
            } catch (e) {
                this.logError(e, 'setupPerformanceObservers');
            }
        }
    }

    cleanup() {
        this.performanceObservers.forEach(observer => {
            try {
                observer.disconnect();
            } catch (e) {
                // Ignore cleanup errors
            }
        });
        this.performanceObservers = [];
    }
}

// Enhanced Error Handling System
class ErrorHandler {
    constructor() {
        this.errors = [];
        this.maxErrors = 100;
        this.reportingEnabled = false;
    }

    captureError(error, context = {}, severity = 'error') {
        const errorEntry = {
            id: this.generateErrorId(),
            message: error instanceof Error ? error.message : String(error),
            stack: error instanceof Error ? error.stack : null,
            type: error instanceof Error ? error.constructor.name : typeof error,
            context,
            severity,
            timestamp: Date.now(),
            userAgent: navigator.userAgent,
            url: window.location.href,
            screenSize: `${window.innerWidth}x${window.innerHeight}`,
            connection: navigator.connection ? {
                effectiveType: navigator.connection.effectiveType,
                downlink: navigator.connection.downlink,
                rtt: navigator.connection.rtt
            } : null
        };
        
        this.errors.push(errorEntry);
        
        // Keep only the most recent errors
        if (this.errors.length > this.maxErrors) {
            this.errors.shift();
        }
        
        // Log to console
        console[severity === 'warning' ? 'warn' : 'error'](
            `[${severity.toUpperCase()}] ${errorEntry.message}`,
            errorEntry.context
        );
        
        // Show user notification for critical errors
        if (severity === 'critical' || severity === 'error') {
            this.showUserNotification(errorEntry);
        }
        
        return errorEntry;
    }

    generateErrorId() {
        return 'err_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    showUserNotification(error) {
        const userFriendlyMessages = {
            'NetworkError': 'Unable to connect to the server. Please check your internet connection.',
            'GeolocationError': 'Unable to access your location. Please enable location services.',
            'FirebaseError': 'Unable to connect to the service. Please try again later.',
            'TimeoutError': 'The request timed out. Please try again.',
            'PermissionDeniedError': 'Permission denied. Please check your browser permissions.'
        };
        
        let message = userFriendlyMessages[error.type] || 
                     'An error occurred. Please try again.';
        
        // Add context-specific messages
        if (error.context.operation === 'ride_request') {
            message = 'Unable to request ride. Please try again.';
        } else if (error.context.operation === 'payment') {
            message = 'Payment processing failed. Please try again or use a different payment method.';
        }
        
        showNotification(message, 'error');
    }

    getErrorReport() {
        return {
            totalErrors: this.errors.length,
            errorsBySeverity: this.errors.reduce((acc, error) => {
                acc[error.severity] = (acc[error.severity] || 0) + 1;
                return acc;
            }, {}),
            errorsByType: this.errors.reduce((acc, error) => {
                acc[error.type] = (acc[error.type] || 0) + 1;
                return acc;
            }, {}),
            recentErrors: this.errors.slice(-10)
        };
    }

    setupGlobalErrorHandling() {
        // Handle unhandled promise rejections
        window.addEventListener('unhandledrejection', (event) => {
            this.captureError(event.reason, {
                type: 'UnhandledPromiseRejection',
                promise: event.promise
            }, 'warning');
        });
        
        // Handle global errors
        window.addEventListener('error', (event) => {
            this.captureError(event.error, {
                type: 'GlobalError',
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno
            }, 'error');
        });
    }
}

// Initialize global instances
const userSession = new UserSession();
const spatialIndex = new SpatialIndex();
const performanceMonitor = new PerformanceMonitor();
const errorHandler = new ErrorHandler();

// Enhanced Authentication with Session Management
function initializeAuth() {
    performanceMonitor.startTimer('auth_initialization');
    
    try {
        const urlParams = new URLSearchParams(window.location.search);
        const email = urlParams.get('email');
        const uid = urlParams.get('uid');
        
        if (email && uid) {
            loadUserData(uid);
        } else {
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    loadUserData(user.uid);
                } else {
                    window.location.href = 'signup.html';
                }
            }, error => {
                errorHandler.captureError(error, { operation: 'auth_state_change' }, 'error');
                showNotification('Authentication error. Please try again.', 'error');
            });
        }
        
        performanceMonitor.endTimer('auth_initialization');
    } catch (error) {
        performanceMonitor.endTimer('auth_initialization');
        errorHandler.captureError(error, { operation: 'initialize_auth' }, 'critical');
        showNotification('Failed to initialize authentication.', 'error');
    }
}

// Enhanced User Data Loading
function loadUserData(uid) {
    performanceMonitor.startTimer('user_data_load');
    
    database.ref('users/' + uid).once('value')
        .then(snapshot => {
            userData = snapshot.val();
            if (userData) {
                currentUser = {
                    uid: uid,
                    email: userData.email,
                    displayName: userData.name
                };
                
                // Initialize all systems
                initializeMap();
                setupEventListeners();
                loadPassengerData();
                initializeSearchEngine();
                
                // Update UI with user data
                updateUserProfileUI();
                
                // Set up real-time listeners
                setupWalletBalanceListener(uid);
                loadSOSConfig(uid);
                checkActiveRide(uid);
                
                // Initialize user session preferences
                if (userData.preferences) {
                    userSession.preferences = { ...userSession.preferences, ...userData.preferences };
                }
                
                showNotification('Welcome back to Jubel! Advanced search engine initialized.', 'success');
                
                performanceMonitor.endTimer('user_data_load');
                performanceMonitor.logApiCall('loadUserData', 
                    performanceMonitor.endTimer('user_data_load'), true);
            } else {
                showNotification('User data not found. Please sign up again.', 'error');
                setTimeout(() => {
                    window.location.href = 'signup.html';
                }, 2000);
            }
        })
        .catch(error => {
            performanceMonitor.endTimer('user_data_load');
            errorHandler.captureError(error, { operation: 'load_user_data', uid }, 'error');
            showNotification('Error loading user data. Please try again.', 'error');
        });
}

// Enhanced User Profile UI Update
function updateUserProfileUI() {
    try {
        document.getElementById('accountName').textContent = userData.name || 'Passenger';
        document.getElementById('accountEmail').textContent = userData.email || 'Not set';
        document.getElementById('accountPhone').textContent = userData.phone || 'Not set';
        document.getElementById('referralCode').textContent = userData.referralCode || 'JUBEL-XXXX';
        
        walletBalance = userData.walletBalance || 0;
        updateWalletBalanceUI();
    } catch (error) {
        errorHandler.captureError(error, { operation: 'update_user_profile_ui' }, 'warning');
    }
}

// Advanced Search Engine Initialization
function initializeSearchEngine() {
    performanceMonitor.startTimer('search_engine_init');
    
    try {
        console.log('Initializing Advanced Search Engine...');
        
        // Build spatial index with known Zambian locations
        initializeSpatialIndex();
        
        // Pre-fetch common locations for current city
        if (currentCity) {
            prefetchCityLocations(currentCity);
        }
        
        // Set up search performance monitoring
        setupSearchAnalytics();
        
        console.log('Search Engine Ready with Spatial Indexing');
        performanceMonitor.endTimer('search_engine_init');
    } catch (error) {
        performanceMonitor.endTimer('search_engine_init');
        errorHandler.captureError(error, { operation: 'initialize_search_engine' }, 'error');
    }
}

// Initialize Spatial Index with Zambian infrastructure
function initializeSpatialIndex() {
    try {
        // Add major Zambian cities to spatial index
        Object.entries(cityBoundaries).forEach(([city, data]) => {
            spatialIndex.addPoint({
                id: `city_${city}`,
                lat: data.center.lat,
                lng: data.center.lng,
                data: {
                    type: 'city',
                    name: city,
                    country: 'Zambia'
                }
            });
            
            // Add city zones
            if (data.zones) {
                Object.entries(data.zones).forEach(([zone, zoneData]) => {
                    spatialIndex.addPoint({
                        id: `zone_${city}_${zone}`,
                        lat: zoneData.center.lat,
                        lng: zoneData.center.lng,
                        data: {
                            type: 'zone',
                            city: city,
                            name: zone,
                            category: 'residential'
                        }
                    });
                });
            }
        });
        
        spatialIndex.buildIndex();
        console.log(`Spatial Index initialized with ${spatialIndex.points.length} points`);
    } catch (error) {
        errorHandler.captureError(error, { operation: 'initialize_spatial_index' }, 'warning');
    }
}

// Pre-fetch city locations for faster search
function prefetchCityLocations(city) {
    if (!city || city === 'Unknown Location') return;
    
    try {
        console.log(`Pre-fetching locations for ${city}`);
        
        // Cache common queries for this city
        const commonQueries = [
            `${city} CBD`,
            `${city} Mall`,
            `${city} Hospital`,
            `${city} Market`,
            `${city} Bus Station`
        ];
        
        // These would be actual API calls in production
        commonQueries.forEach(query => {
            const cacheKey = `prefetch_${city}_${query}`;
            userSession.cacheLocation(cacheKey, []);
        });
    } catch (error) {
        errorHandler.captureError(error, { 
            operation: 'prefetch_city_locations', 
            city 
        }, 'warning');
    }
}

// Setup Search Analytics
function setupSearchAnalytics() {
    try {
        // Track search performance
        window.searchPerformance = {
            totalSearches: 0,
            averageResponseTime: 0,
            successRate: 0,
            cityDetectionAccuracy: 0
        };
        
        // Periodic analytics reporting
        setInterval(() => {
            if (window.searchPerformance.totalSearches > 0) {
                console.log('Search Analytics:', window.searchPerformance);
            }
        }, 300000); // Every 5 minutes
    } catch (error) {
        errorHandler.captureError(error, { operation: 'setup_search_analytics' }, 'warning');
    }
}

// Enhanced Map Initialization with Advanced Features
function initializeMap() {
    performanceMonitor.startTimer('map_initialization');
    
    try {
        // Main passenger map with advanced configuration
        passengerMap = L.map('map', {
            zoomControl: true,
            attributionControl: true,
            preferCanvas: true, // Better performance for many markers
            maxZoom: 19,
            minZoom: 10,
            zoomSnap: 0.5,
            zoomDelta: 0.5,
            wheelPxPerZoomLevel: 60,
            tapTolerance: 15,
            touchZoom: true,
            scrollWheelZoom: true,
            doubleClickZoom: true,
            boxZoom: true,
            keyboard: true,
            dragging: true,
            inertia: true,
            inertiaDeceleration: 3000,
            inertiaMaxSpeed: 1500,
            easeLinearity: 0.2,
            worldCopyJump: false,
            maxBoundsViscosity: 0.7
        }).setView([-15.4167, 28.2833], 13);
        
        // Use multiple tile layers for redundancy
        const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: ' OpenStreetMap contributors',
            maxZoom: 19,
            minZoom: 1,
            subdomains: ['a', 'b', 'c'],
            detectRetina: true
        });
        
        const cartoLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: ' CARTO',
            maxZoom: 19,
            minZoom: 1,
            subdomains: ['a', 'b', 'c'],
            detectRetina: true
        });
        
        osmLayer.addTo(passengerMap);
        
        // Layer control for future enhancements
        const baseLayers = {
            "OpenStreetMap": osmLayer,
            "Carto Light": cartoLayer
        };
        
        L.control.layers(baseLayers).addTo(passengerMap);
        
        // Popup ride details map
        popupRideMap = L.map('popupRideMap', {
            zoomControl: false,
            attributionControl: false,
            dragging: false,
            touchZoom: false,
            scrollWheelZoom: false,
            doubleClickZoom: false,
            boxZoom: false,
            keyboard: false,
            tap: false
        }).setView([-15.4167, 28.2833], 13);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: ' OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(popupRideMap);
        
        // Get passenger's current location with high accuracy
        refreshPassengerPosition();
        
        // Add map event listeners
        setupMapEventListeners();
        
        performanceMonitor.endTimer('map_initialization');
        performanceMetrics.mapLoadTime = performanceMonitor.endTimer('map_initialization');
        
        console.log('Map initialized successfully');
    } catch (error) {
        performanceMonitor.endTimer('map_initialization');
        errorHandler.captureError(error, { operation: 'initialize_map' }, 'critical');
        showNotification('Failed to initialize map. Please refresh the page.', 'error');
    }
}

// Setup Map Event Listeners
function setupMapEventListeners() {
    try {
        // Double-click to set pickup location
        passengerMap.on('dblclick', function(e) {
            if (currentScreen === 'home' && !currentRide) {
                setManualPickupLocation(e.latlng.lat, e.latlng.lng);
                showNotification('Pickup location set by map click', 'info');
            }
        });
        
        // Right-click context menu
        passengerMap.on('contextmenu', function(e) {
            if (currentScreen === 'home' && !currentRide) {
                e.originalEvent.preventDefault();
                const contextMenu = L.popup()
                    .setLatLng(e.latlng)
                    .setContent(`
                        <div class="map-context-menu">
                            <button onclick="setManualPickupLocation(${e.latlng.lat}, ${e.latlng.lng})" class="context-menu-btn">
                                <i class="fas fa-map-marker-alt"></i> Set as Pickup
                            </button>
                            <button onclick="searchNearbyFromMap(${e.latlng.lat}, ${e.latlng.lng})" class="context-menu-btn">
                                <i class="fas fa-search"></i> Search Nearby
                            </button>
                        </div>
                    `)
                    .openOn(passengerMap);
            }
        });
        
        // Map load event
        passengerMap.on('load', function() {
            console.log('Map fully loaded');
        });
        
        // Map moveend event for performance monitoring
        passengerMap.on('moveend', function() {
            const center = passengerMap.getCenter();
            console.log(`Map moved to: ${center.lat.toFixed(4)}, ${center.lng.toFixed(4)}`);
        });
        
        // Zoom level change
        passengerMap.on('zoomend', function() {
            console.log(`Zoom level changed to: ${passengerMap.getZoom()}`);
        });
    } catch (error) {
        errorHandler.captureError(error, { operation: 'setup_map_event_listeners' }, 'warning');
    }
}

// Advanced City Detection with Multi-Method Verification
function determineCurrentCity(lat, lng) {
    return new Promise((resolve, reject) => {
        performanceMonitor.startTimer('city_detection');
        
        console.log(`Advanced city detection for: ${lat}, ${lng}`);
        
        const startTime = Date.now();
        
        // Method 1: Spatial Index Check (Fastest)
        const spatialResult = checkSpatialIndex(lat, lng);
        if (spatialResult) {
            console.log(`City detected via Spatial Index: ${spatialResult.city} (${spatialResult.zone || 'general area'})`);
            currentCity = spatialResult.city;
            userSession.cache.cityCache = spatialResult;
            logCityDetection('spatial', Date.now() - startTime, true);
            performanceMonitor.endTimer('city_detection');
            resolve(currentCity);
            return;
        }
        
        // Method 2: Multi-API Reverse Geocoding with Fallbacks
        const detectionPromises = [
            detectCityViaNominatim(lat, lng),
            detectCityViaPhoton(lat, lng),
            detectCityViaLocationIQ(lat, lng)
        ];
        
        Promise.any(detectionPromises)
            .then(city => {
                if (city && city !== "Unknown Location") {
                    currentCity = city;
                    console.log(`City detected via geocoding: ${currentCity}`);
                    
                    // Cache the result in spatial index
                    cacheCityDetection(lat, lng, city);
                    
                    logCityDetection('geocoding', Date.now() - startTime, true);
                    performanceMonitor.endTimer('city_detection');
                    resolve(currentCity);
                } else {
                    // Method 3: Proximity-based fallback
                    currentCity = determineCityByProximity(lat, lng);
                    console.log(`City detected via proximity: ${currentCity}`);
                    logCityDetection('proximity', Date.now() - startTime, true);
                    performanceMonitor.endTimer('city_detection');
                    resolve(currentCity);
                }
            })
            .catch(error => {
                console.error('All city detection methods failed:', error);
                // Method 4: Last resort
                currentCity = "Lusaka";
                logCityDetection('fallback', Date.now() - startTime, false);
                performanceMonitor.endTimer('city_detection');
                errorHandler.captureError(error, { operation: 'determine_current_city', lat, lng }, 'warning');
                resolve(currentCity);
            });
    });
}

// Spatial Index Check
function checkSpatialIndex(lat, lng) {
    try {
        const nearbyPoints = spatialIndex.searchNearby(lat, lng, 5000, 5);
        
        if (nearbyPoints.length > 0) {
            // Prioritize city points
            const cityPoint = nearbyPoints.find(p => p.data.type === 'city');
            if (cityPoint) {
                return {
                    city: cityPoint.data.name,
                    confidence: 0.95,
                    source: 'spatial_index'
                };
            }
            
            // Check for zones
            const zonePoint = nearbyPoints.find(p => p.data.type === 'zone');
            if (zonePoint) {
                return {
                    city: zonePoint.data.city,
                    zone: zonePoint.data.name,
                    confidence: 0.85,
                    source: 'spatial_index'
                };
            }
        }
        
        return null;
    } catch (error) {
        errorHandler.captureError(error, { operation: 'check_spatial_index', lat, lng }, 'warning');
        return null;
    }
}

// Cache City Detection Result
function cacheCityDetection(lat, lng, city) {
    try {
        spatialIndex.addPoint({
            id: `detected_${Date.now()}`,
            lat: lat,
            lng: lng,
            data: {
                type: 'detected_city',
                city: city,
                timestamp: Date.now()
            }
        });
    } catch (error) {
        errorHandler.captureError(error, { operation: 'cache_city_detection', lat, lng, city }, 'warning');
    }
}

// Log City Detection Performance
function logCityDetection(method, duration, success) {
    try {
        if (!window.cityDetectionStats) {
            window.cityDetectionStats = {
                total: 0,
                successful: 0,
                methods: {},
                averageTime: 0
            };
        }
        
        window.cityDetectionStats.total++;
        if (success) window.cityDetectionStats.successful++;
        
        if (!window.cityDetectionStats.methods[method]) {
            window.cityDetectionStats.methods[method] = { count: 0, totalTime: 0 };
        }
        
        window.cityDetectionStats.methods[method].count++;
        window.cityDetectionStats.methods[method].totalTime += duration;
        
        window.cityDetectionStats.averageTime = 
            (window.cityDetectionStats.averageTime * (window.cityDetectionStats.total - 1) + duration) / 
            window.cityDetectionStats.total;
    } catch (error) {
        errorHandler.captureError(error, { operation: 'log_city_detection', method, duration, success }, 'warning');
    }
}

// Multiple Geocoding Service Providers
async function detectCityViaNominatim(lat, lng) {
    try {
        const response = await fetch(
            `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1&accept-language=en`,
            {
                headers: {
                    'User-Agent': 'JubelRides/1.0'
                },
                signal: AbortSignal.timeout(5000) // 5 second timeout
            }
        );
        
        if (!response.ok) throw new Error(`Nominatim error: ${response.status}`);
        
        const data = await response.json();
        return extractCityFromGeocodeData(data);
    } catch (error) {
        console.warn('Nominatim geocoding failed:', error);
        errorHandler.captureError(error, { operation: 'detect_city_via_nominatim', lat, lng }, 'warning');
        throw error;
    }
}

async function detectCityViaPhoton(lat, lng) {
    try {
        const response = await fetch(
            `https://photon.komoot.io/reverse?lat=${lat}&lon=${lng}&lang=en`,
            {
                signal: AbortSignal.timeout(3000) // 3 second timeout
            }
        );
        
        if (!response.ok) throw new Error(`Photon error: ${response.status}`);
        
        const data = await response.json();
        return extractCityFromPhotonData(data);
    } catch (error) {
        console.warn('Photon geocoding failed:', error);
        errorHandler.captureError(error, { operation: 'detect_city_via_photon', lat, lng }, 'warning');
        throw error;
    }
}

async function detectCityViaLocationIQ(lat, lng) {
    try {
        // Note: LocationIQ requires an API key in production
        const response = await fetch(
            `https://us1.locationiq.com/v1/reverse.php?key=pk.test_key&lat=${lat}&lon=${lng}&format=json&accept-language=en`,
            {
                signal: AbortSignal.timeout(3000) // 3 second timeout
            }
        );
        
        if (!response.ok) throw new Error(`LocationIQ error: ${response.status}`);
        
        const data = await response.json();
        return extractCityFromLocationIQData(data);
    } catch (error) {
        console.warn('LocationIQ geocoding failed:', error);
        errorHandler.captureError(error, { operation: 'detect_city_via_locationiq', lat, lng }, 'warning');
        throw error;
    }
}

// Enhanced City Extraction Functions
function extractCityFromGeocodeData(data) {
    if (!data || !data.address) return null;
    
    const priorityFields = ['city', 'town', 'village', 'municipality', 'county', 'state_district'];
    
    for (const field of priorityFields) {
        if (data.address[field]) {
            const detected = normalizeCityName(data.address[field].toString());
            if (zambianCities.includes(detected)) {
                return detected;
            }
        }
    }
    
    // Fallback to display name parsing
    if (data.display_name) {
        const fromDisplayName = extractCityFromDisplayName(data.display_name);
        if (fromDisplayName !== "Unknown Location") {
            return fromDisplayName;
        }
    }
    
    return null;
}

function extractCityFromPhotonData(data) {
    if (!data || !data.features || data.features.length === 0) return null;
    
    const feature = data.features[0];
    if (feature.properties) {
        const city = feature.properties.city || feature.properties.town || feature.properties.village;
        if (city) {
            const normalized = normalizeCityName(city);
            if (zambianCities.includes(normalized)) {
                return normalized;
            }
        }
    }
    
    return null;
}

function extractCityFromLocationIQData(data) {
    if (!data || !data.address) return null;
    
    const city = data.address.city || data.address.town || data.address.village;
    if (city) {
        const normalized = normalizeCityName(city);
        if (zambianCities.includes(normalized)) {
            return normalized;
        }
    }
    
    return null;
}

// Advanced Normalization with Phonetic Matching
function normalizeCityName(cityName) {
    if (!cityName) return "";
    
    const normalized = cityName.toString().trim();
    const lower = normalized.toLowerCase();
    
    // Handle common variations and abbreviations
    const variations = {
        'lusaka city': 'Lusaka',
        'lska': 'Lusaka',
        'l/s': 'Lusaka',
        'kitwe town': 'Kitwe',
        'k/t': 'Kitwe',
        'ndola city': 'Ndola',
        'n/d': 'Ndola',
        'kabwe town': 'Kabwe',
        'broken hill': 'Kabwe',
        'chipata town': 'Chipata',
        'chingola town': 'Chingola',
        'mufulira town': 'Mufulira',
        'luanshya town': 'Luanshya',
        'livingstone town': 'Livingstone',
        'victoria falls town': 'Livingstone',
        'kasama town': 'Kasama',
        'solwezi town': 'Solwezi',
        'kapiri mposhi town': 'Kapiri Mposhi',
        'chililabombwe town': 'Chililabombwe',
        'mazabuka town': 'Mazabuka',
        'mongu town': 'Mongu'
    };
    
    // Check direct variations
    if (variations[lower]) {
        return variations[lower];
    }
    
    // Check for city in Zambian cities list
    const foundCity = zambianCities.find(city => 
        city.toLowerCase() === lower || 
        city.toLowerCase().includes(lower) ||
        lower.includes(city.toLowerCase())
    );
    
    if (foundCity) {
        return foundCity;
    }
    
    // Check aliases
    if (cityAliases[lower]) {
        return cityAliases[lower];
    }
    
    // Return original with proper capitalization
    return normalized.charAt(0).toUpperCase() + normalized.slice(1).toLowerCase();
}

// Determine City by Proximity with Weighted Scoring
function determineCityByProximity(lat, lng) {
    let closestCity = "Lusaka";
    let shortestDistance = Infinity;
    let bestScore = 0;
    
    for (const [city, data] of Object.entries(cityBoundaries)) {
        const distance = calculateDistance(lat, lng, data.center.lat, data.center.lng);
        const normalizedDistance = Math.min(distance / data.radius, 1);
        const score = 1 - normalizedDistance;
        
        if (score > bestScore) {
            bestScore = score;
            closestCity = city;
            shortestDistance = distance;
        }
    }
    
    // Only return if within reasonable distance (150km)
    return shortestDistance <= 150000 ? closestCity : "Unknown Location";
}

// ADVANCED SEARCH ENGINE CORE FUNCTIONS

// Enhanced Search with Multi-Stage Processing
function searchPlacesEnhanced(query, searchType = 'destination') {
    if (!query || query.length < searchConfig.minQueryLength) {
        hideSearchSuggestions(searchType);
        return;
    }
    
    const startTime = Date.now();
    const suggestionsContainer = document.getElementById(`${searchType}Suggestions`);
    
    // Show loading with animated spinner
    suggestionsContainer.innerHTML = `
        <div class="search-loading">
            <div class="search-spinner"></div>
            <div class="search-loading-text">Searching in ${currentCity || 'your area'}...</div>
        </div>
    `;
    suggestionsContainer.style.display = 'block';
    
    // Track search performance
    window.searchPerformance.totalSearches++;
    
    // Clear any existing timeout
    if (window.searchTimeouts) {
        window.searchTimeouts.forEach(timeout => clearTimeout(timeout));
        window.searchTimeouts = [];
    }
    
    // Multi-stage search with debouncing
    const searchTimeout = setTimeout(() => {
        performAdvancedSearch(query, searchType, startTime);
    }, searchConfig.debounceTime);
    
    if (!window.searchTimeouts) window.searchTimeouts = [];
    window.searchTimeouts.push(searchTimeout);
}

// Advanced Multi-Stage Search Algorithm
async function performAdvancedSearch(query, searchType, startTime) {
    try {
        // Stage 1: Check cache
        const cachedResults = userSession.getCachedResults(query, searchType);
        if (cachedResults.length > 0) {
            displaySearchResults(cachedResults, searchType, 'cache');
            logSearchPerformance(startTime, true, 'cache');
            return;
        }
        
        // Stage 2: Process query with advanced parsing
        const processedQuery = preprocessSearchQuery(query);
        const searchContext = buildSearchContext(searchType);
        
        // Stage 3: Parallel search strategies
        const searchStrategies = [
            searchWithinCity(processedQuery, searchContext),
            searchInfrastructure(processedQuery, searchContext),
            searchCompounds(processedQuery, searchContext),
            searchGeneric(processedQuery, searchContext)
        ];
        
        // Execute all strategies in parallel
        const strategyResults = await Promise.allSettled(searchStrategies);
        
        // Stage 4: Merge and rank results
        let allResults = [];
        strategyResults.forEach((result, index) => {
            if (result.status === 'fulfilled' && result.value) {
                allResults = allResults.concat(result.value);
            }
        });
        
        // Stage 5: Advanced ranking and filtering
        const rankedResults = rankSearchResults(allResults, processedQuery, searchContext);
        const finalResults = applySearchFilters(rankedResults, searchContext);
        
        // Stage 6: Update cache and display
        userSession.addSearchToHistory(query, finalResults, currentCity);
        updateSearchResultsCache(finalResults, searchType);
        displaySearchResults(finalResults, searchType, 'api');
        
        const responseTime = Date.now() - startTime;
        logSearchPerformance(startTime, true, 'advanced');
        userSession.updateSearchMetrics(responseTime);
        
    } catch (error) {
        console.error('Advanced search error:', error);
        errorHandler.captureError(error, { 
            operation: 'perform_advanced_search', 
            query, 
            searchType 
        }, 'error');
        showSearchError(searchType);
        logSearchPerformance(startTime, false, 'error');
    }
}

// Build Search Context
function buildSearchContext(searchType) {
    return {
        searchType: searchType,
        city: currentCity,
        userLocation: userLocation,
        filters: {
            withinCity: searchConfig.filters.withinCity,
            prioritizeInfrastructure: searchConfig.filters.prioritizeInfrastructure,
            includeHouseNumbers: searchConfig.filters.includeHouseNumbers,
            includeCompounds: searchConfig.filters.includeCompounds
        },
        boundingBox: calculateSearchBoundingBox(),
        zoomLevel: passengerMap.getZoom()
    };
}

// Calculate Search Bounding Box
function calculateSearchBoundingBox() {
    if (!userLocation) return null;
    
    const bounds = passengerMap.getBounds();
    return {
        north: bounds.getNorth(),
        south: bounds.getSouth(),
        east: bounds.getEast(),
        west: bounds.getWest()
    };
}

// Advanced Query Preprocessing
function preprocessSearchQuery(query) {
    let processed = query.trim();
    
    // Remove extra whitespace
    processed = processed.replace(/\s+/g, ' ').trim();
    
    // Convert to lowercase for matching
    const lower = processed.toLowerCase();
    
    // Extract potential address components
    const components = {
        original: processed,
        lowercase: lower,
        words: processed.split(' ').filter(w => w.length > 0),
        hasHouseNumber: false,
        hasRoadType: false,
        hasCompound: false,
        hasInfrastructure: false,
        isNumeric: !isNaN(processed.replace(/[,\s]/g, ''))
    };
    
    // Detect house numbers
    const houseNumberMatch = processed.match(zambianAddressPatterns.houseNumbers.regex);
    if (houseNumberMatch) {
        components.houseNumber = houseNumberMatch[1];
        components.hasHouseNumber = true;
    }
    
    // Detect road types
    zambianAddressPatterns.roads.types.forEach(type => {
        if (lower.includes(type.toLowerCase())) {
            components.roadType = type;
            components.hasRoadType = true;
        }
    });
    
    // Detect compounds
    zambianAddressPatterns.compounds.forEach(compound => {
        if (lower.includes(compound.toLowerCase())) {
            components.compound = compound;
            components.hasCompound = true;
        }
    });
    
    // Detect common infrastructure
    Object.values(zambianAddressPatterns.institutions).flat().forEach(institution => {
        if (lower.includes(institution.toLowerCase())) {
            components.institution = institution;
            components.hasInfrastructure = true;
        }
    });
    
    zambianAddressPatterns.shoppingCenters.forEach(center => {
        if (lower.includes(center.toLowerCase())) {
            components.shoppingCenter = center;
            components.hasInfrastructure = true;
        }
    });
    
    return components;
}

// Search Within City (Primary Strategy)
async function searchWithinCity(query, context) {
    if (!context.city || context.city === "Unknown Location") {
        return [];
    }
    
    const searchQuery = buildCitySearchQuery(query.original, context.city);
    
    try {
        const results = await fetchFromGeocodingAPI(searchQuery, context);
        return results.map(result => enhanceResultWithCityContext(result, context));
    } catch (error) {
        console.warn('City search failed:', error);
        errorHandler.captureError(error, { 
            operation: 'search_within_city', 
            query: query.original,
            city: context.city 
        }, 'warning');
        return [];
    }
}

// Build City-Specific Search Query
function buildCitySearchQuery(query, city) {
    // Check if query already contains city name
    const cityLower = city.toLowerCase();
    const queryLower = query.toLowerCase();
    
    if (queryLower.includes(cityLower)) {
        return query;
    }
    
    // Add city name to query for better accuracy
    return `${query}, ${city}, Zambia`;
}

// Infrastructure Search
async function searchInfrastructure(query, context) {
    if (!query.hasInfrastructure) {
        return [];
    }
    
    const infrastructureQueries = [];
    
    if (query.institution) {
        infrastructureQueries.push(`${query.institution} ${context.city}`);
    }
    
    if (query.shoppingCenter) {
        infrastructureQueries.push(`${query.shoppingCenter} ${context.city}`);
    }
    
    if (infrastructureQueries.length === 0) {
        return [];
    }
    
    try {
        const promises = infrastructureQueries.map(q => 
            fetchFromGeocodingAPI(q, context)
        );
        
        const results = await Promise.all(promises);
        return results.flat().map(result => ({
            ...result,
            isInfrastructure: true,
            priority: 2
        }));
    } catch (error) {
        console.warn('Infrastructure search failed:', error);
        errorHandler.captureError(error, { 
            operation: 'search_infrastructure', 
            query: query.original 
        }, 'warning');
        return [];
    }
}

// Compound/Area Search
async function searchCompounds(query, context) {
    if (!query.hasCompound || !context.filters.includeCompounds) {
        return [];
    }
    
    const searchQuery = `${query.compound} ${context.city} Zambia`;
    
    try {
        const results = await fetchFromGeocodingAPI(searchQuery, context);
        return results.map(result => ({
            ...result,
            isCompound: true,
            compoundName: query.compound,
            priority: 3
        }));
    } catch (error) {
        console.warn('Compound search failed:', error);
        errorHandler.captureError(error, { 
            operation: 'search_compounds', 
            query: query.original,
            compound: query.compound 
        }, 'warning');
        return [];
    }
}

// Generic Fallback Search
async function searchGeneric(query, context) {
    try {
        const results = await fetchFromGeocodingAPI(query.original, context);
        return results.map(result => enhanceResultWithCityContext(result, context));
    } catch (error) {
        console.warn('Generic search failed:', error);
        errorHandler.captureError(error, { 
            operation: 'search_generic', 
            query: query.original 
        }, 'warning');
        return [];
    }
}

// Enhanced Geocoding API Fetch with Multiple Providers
async function fetchFromGeocodingAPI(query, context) {
    // Try multiple geocoding providers in sequence
    const providers = [
        fetchFromNominatim,
        fetchFromPhoton
    ];
    
    for (const provider of providers) {
        try {
            const results = await provider(query, context);
            if (results.length > 0) {
                return results;
            }
        } catch (error) {
            console.warn(`${provider.name} failed:`, error);
            errorHandler.captureError(error, { 
                operation: 'fetch_from_geocoding_api', 
                provider: provider.name,
                query 
            }, 'warning');
        }
    }
    
    return [];
}

// Nominatim Geocoding with Enhanced Parameters
async function fetchFromNominatim(query, context) {
    const encodedQuery = encodeURIComponent(query);
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodedQuery}&limit=${searchConfig.maxResults}&countrycodes=zm&dedupe=1&polygon=0&addressdetails=1`;
    
    const response = await fetch(url, {
        headers: {
            'User-Agent': 'JubelRides/1.0 (Passenger App)',
            'Accept-Language': 'en'
        },
        signal: AbortSignal.timeout(5000) // 5 second timeout
    });
    
    if (!response.ok) {
        throw new Error(`Nominatim API error: ${response.status}`);
    }
    
    const data = await response.json();
    return processNominatimResults(data, context);
}

// Photon Geocoding (Komoot)
async function fetchFromPhoton(query, context) {
    const encodedQuery = encodeURIComponent(query);
    const url = `https://photon.komoot.io/api/?q=${encodedQuery}&limit=${searchConfig.maxResults}&lang=en`;
    
    const response = await fetch(url, {
        signal: AbortSignal.timeout(3000) // 3 second timeout
    });
    
    if (!response.ok) {
        throw new Error(`Photon API error: ${response.status}`);
    }
    
    const data = await response.json();
    return processPhotonResults(data, context);
}

// Process Nominatim Results
function processNominatimResults(data, context) {
    if (!Array.isArray(data)) return [];
    
    return data.map(item => ({
        id: item.place_id,
        name: item.display_name,
        lat: parseFloat(item.lat),
        lon: parseFloat(item.lon),
        type: item.type,
        category: item.class,
        importance: item.importance,
        address: item.address,
        boundingbox: item.boundingbox,
        isCurrentCity: checkIfInCurrentCity(item, context.city),
        distance: calculateDistanceFromUser(item, context.userLocation),
        source: 'nominatim'
    }));
}

// Process Photon Results
function processPhotonResults(data, context) {
    if (!data.features || !Array.isArray(data.features)) return [];
    
    return data.features.map(feature => ({
        id: feature.properties.osm_id,
        name: feature.properties.name || feature.properties.street || feature.properties.city,
        lat: feature.geometry.coordinates[1],
        lon: feature.geometry.coordinates[0],
        type: feature.properties.osm_key,
        category: feature.properties.osm_value,
        importance: feature.properties.importance,
        address: feature.properties,
        isCurrentCity: checkIfInCurrentCity(feature, context.city),
        distance: calculateDistanceFromUser(feature, context.userLocation),
        source: 'photon'
    }));
}

// Enhance Result with City Context
function enhanceResultWithCityContext(result, context) {
    const enhanced = { ...result };
    
    // Calculate relevance score
    enhanced.relevanceScore = calculateRelevanceScore(enhanced, context);
    
    // Add display properties
    enhanced.displayName = formatDisplayNameForUI(enhanced, context);
    enhanced.shortAddress = extractShortAddress(enhanced);
    enhanced.city = extractCityFromResult(enhanced);
    
    // Add category icon
    enhanced.icon = getCategoryIcon(enhanced.type, enhanced.category);
    
    // Add proximity info
    if (context.userLocation) {
        enhanced.proximity = calculateProximityLabel(enhanced.distance);
    }
    
    return enhanced;
}

// Calculate Relevance Score
function calculateRelevanceScore(result, context) {
    let score = 0;
    
    // Base importance
    if (result.importance) {
        score += result.importance * 10;
    }
    
    // City match bonus
    if (result.isCurrentCity) {
        score += searchConfig.priority.cityMatch;
    }
    
    // Distance penalty/bonus
    if (result.distance) {
        if (result.distance < 1000) {
            score += searchConfig.priority.distanceMatch;
        } else if (result.distance > 5000) {
            score -= 5;
        }
    }
    
    // Type bonuses
    if (result.isInfrastructure) {
        score += 15;
    }
    
    if (result.isCompound) {
        score += 10;
    }
    
    // Source preference
    if (result.source === 'nominatim') {
        score += 5;
    }
    
    return Math.max(0, score);
}

// Check if Result is in Current City
function checkIfInCurrentCity(result, currentCity) {
    if (!currentCity) return false;
    
    const resultCity = extractCityFromResult(result);
    return resultCity === currentCity;
}

// Extract City from Result
function extractCityFromResult(result) {
    if (result.address) {
        if (result.address.city) return normalizeCityName(result.address.city);
        if (result.address.town) return normalizeCityName(result.address.town);
        if (result.address.village) return normalizeCityName(result.address.village);
        if (result.address.municipality) return normalizeCityName(result.address.municipality);
    }
    
    if (result.name) {
        const fromName = extractCityFromDisplayName(result.name);
        if (fromName !== "Unknown Location") {
            return fromName;
        }
    }
    
    return null;
}

// Calculate Distance from User
function calculateDistanceFromUser(result, userLocation) {
    if (!userLocation || !result.lat || !result.lon) return 0;
    
    return calculateDistance(
        userLocation.lat,
        userLocation.lng,
        result.lat,
        result.lon
    );
}

// Format Display Name for UI
function formatDisplayNameForUI(result, context) {
    let displayName = result.name;
    
    // If it's a long OSM display name, shorten it
    if (displayName && displayName.length > 100) {
        const parts = displayName.split(',');
        
        // Keep first 2-3 parts for readability
        const relevantParts = parts.slice(0, Math.min(3, parts.length));
        
        // Remove city and country if already in context
        const filteredParts = relevantParts.filter(part => {
            const partLower = part.trim().toLowerCase();
            return !partLower.includes('zambia') && 
                   !(context.city && partLower.includes(context.city.toLowerCase()));
        });
        
        displayName = filteredParts.join(', ');
    }
    
    // Add house number if available
    if (result.address && result.address.house_number) {
        displayName = `House ${result.address.house_number}, ${displayName}`;
    }
    
    return displayName || "Unnamed Location";
}

// Extract Short Address
function extractShortAddress(result) {
    if (!result.address) return '';
    
    const addressParts = [];
    
    // Add house/plot number
    if (result.address.house_number) {
        addressParts.push(`House ${result.address.house_number}`);
    } else if (result.address.house) {
        addressParts.push(`House ${result.address.house}`);
    }
    
    // Add road
    if (result.address.road) {
        addressParts.push(result.address.road);
    } else if (result.address.street) {
        addressParts.push(result.address.street);
    }
    
    // Add suburb/neighbourhood
    if (result.address.suburb) {
        addressParts.push(result.address.suburb);
    } else if (result.address.neighbourhood) {
        addressParts.push(result.address.neighbourhood);
    }
    
    return addressParts.join(', ');
}

// Get Category Icon
function getCategoryIcon(type, category) {
    const iconMap = {
        // Amenities
        'restaurant': '',
        'cafe': '',
        'bar': '',
        'fast_food': '',
        'bank': '',
        'atm': '',
        'hospital': '',
        'pharmacy': '',
        'school': '',
        'university': '',
        'library': '',
        'cinema': '',
        'theatre': '',
        'museum': '',
        'hotel': '',
        
        // Shops
        'supermarket': '',
        'mall': '',
        'clothes': '',
        'convenience': '',
        
        // Transportation
        'bus_station': '',
        'taxi': '',
        'fuel': '',
        'parking': '',
        
        // Government
        'police': '',
        'post_office': '',
        'courthouse': '',
        
        // Religious
        'place_of_worship': '',
        
        // Leisure
        'park': '',
        'stadium': '',
        'playground': '',
        
        // Default
        'building': '',
        'house': '',
        'apartment': ''
    };
    
    // Try category first, then type
    return iconMap[category] || iconMap[type] || '';
}

// Calculate Proximity Label
function calculateProximityLabel(distance) {
    if (!distance || distance === 0) return '';
    
    if (distance < 1000) {
        return `${Math.round(distance)}m away`;
    } else {
        return `${(distance / 1000).toFixed(1)}km away`;
    }
}

// Rank Search Results
function rankSearchResults(results, query, context) {
    if (results.length === 0) return [];
    
    // Calculate scores for each result
    const scoredResults = results.map(result => {
        let score = result.relevanceScore || 0;
        
        // Exact match bonus
        if (result.name && result.name.toLowerCase().includes(query.lowercase)) {
            score += searchConfig.priority.exactMatch;
        }
        
        // Partial match bonus
        query.words.forEach(word => {
            if (result.name && result.name.toLowerCase().includes(word.toLowerCase())) {
                score += searchConfig.priority.partialMatch / query.words.length;
            }
        });
        
        // House number match bonus
        if (query.hasHouseNumber && result.address && result.address.house_number) {
            if (result.address.house_number.includes(query.houseNumber)) {
                score += 25;
            }
        }
        
        return {
            ...result,
            finalScore: score
        };
    });
    
    // Sort by score
    return scoredResults.sort((a, b) => b.finalScore - a.finalScore);
}

// Apply Search Filters
function applySearchFilters(results, context) {
    let filtered = results;
    
    // Filter by city if configured
    if (context.filters.withinCity && context.city) {
        filtered = filtered.filter(result => result.isCurrentCity);
    }
    
    // Remove duplicates based on coordinates and name
    filtered = removeDuplicateResults(filtered);
    
    // Limit results
    return filtered.slice(0, searchConfig.maxResults);
}

// Remove Duplicate Results
function removeDuplicateResults(results) {
    const seen = new Set();
    const uniqueResults = [];
    
    for (const result of results) {
        const key = `${result.lat.toFixed(6)}_${result.lon.toFixed(6)}_${result.name.substring(0, 50)}`;
        
        if (!seen.has(key)) {
            seen.add(key);
            uniqueResults.push(result);
        }
    }
    
    return uniqueResults;
}

// Display Search Results with Enhanced UI
function displaySearchResults(results, searchType, source) {
    const suggestionsContainer = document.getElementById(`${searchType}Suggestions`);
    
    // Clear container with fade effect
    suggestionsContainer.innerHTML = '';
    
    // Update search results cache
    updateSearchResultsCache(results, searchType);
    
    if (results.length === 0) {
        showNoResultsMessage(searchType);
        return;
    }
    
    // Group results by category
    const groupedResults = groupResultsByCategory(results);
    
    // Create result groups
    Object.entries(groupedResults).forEach(([category, categoryResults]) => {
        // Add category header
        if (category !== 'other' && categoryResults.length > 0) {
            const categoryHeader = document.createElement('div');
            categoryHeader.className = 'category-header';
            categoryHeader.textContent = category.charAt(0).toUpperCase() + category.slice(1);
            suggestionsContainer.appendChild(categoryHeader);
        }
        
        // Add results
        categoryResults.forEach((result, index) => {
            const suggestionItem = createSuggestionItem(result, searchType, index);
            suggestionsContainer.appendChild(suggestionItem);
        });
    });
    
    // Add search source indicator
    const sourceIndicator = document.createElement('div');
    sourceIndicator.className = 'search-source-indicator';
    sourceIndicator.textContent = `Powered by ${source === 'cache' ? 'local cache' : 'geocoding services'}`;
    suggestionsContainer.appendChild(sourceIndicator);
    
    suggestionsContainer.style.display = 'block';
    
    // Set ARIA attributes
    suggestionsContainer.setAttribute('role', 'listbox');
    suggestionsContainer.setAttribute('aria-label', 'Search suggestions');
    suggestionsContainer.setAttribute('aria-expanded', 'true');
}

// Group Results by Category
function groupResultsByCategory(results) {
    const groups = {
        infrastructure: [],
        compound: [],
        address: [],
        other: []
    };
    
    results.forEach(result => {
        if (result.isInfrastructure) {
            groups.infrastructure.push(result);
        } else if (result.isCompound) {
            groups.compound.push(result);
        } else if (result.address && (result.address.house_number || result.address.road)) {
            groups.address.push(result);
        } else {
            groups.other.push(result);
        }
    });
    
    return groups;
}

// Create Suggestion Item
function createSuggestionItem(result, searchType, index) {
    const suggestionItem = document.createElement('div');
    suggestionItem.className = 'suggestion-item';
    suggestionItem.dataset.index = index;
    suggestionItem.setAttribute('role', 'option');
    suggestionItem.setAttribute('aria-selected', 'false');
    suggestionItem.setAttribute('tabindex', '-1');
    
    // Add highlight for exact matches
    if (result.finalScore && result.finalScore > 80) {
        suggestionItem.classList.add('exact-match');
    }
    
    // Build item content
    suggestionItem.innerHTML = `
        <div class="suggestion-icon" aria-hidden="true">${result.icon}</div>
        <div class="suggestion-content">
            <div class="suggestion-main">
                <div class="suggestion-name">${result.displayName}</div>
                ${result.shortAddress ? `<div class="suggestion-address">${result.shortAddress}</div>` : ''}
            </div>
            <div class="suggestion-meta">
                ${result.proximity ? `<div class="suggestion-distance">${result.proximity}</div>` : ''}
                ${result.isCurrentCity ? '<div class="city-badge">Current City</div>' : ''}
            </div>
        </div>
    `;
    
    // Add click handler
    suggestionItem.addEventListener('click', () => {
        handleSearchResultSelection(result, searchType);
    });
    
    // Add keyboard navigation
    suggestionItem.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            handleSearchResultSelection(result, searchType);
        }
    });
    
    return suggestionItem;
}

// Show No Results Message
function showNoResultsMessage(searchType) {
    const suggestionsContainer = document.getElementById(`${searchType}Suggestions`);
    
    suggestionsContainer.innerHTML = `
        <div class="no-results-container">
            <div class="no-results-icon" aria-hidden="true"></div>
            <div class="no-results-title">No results found</div>
            <div class="no-results-subtitle">Try a different search term or check your spelling</div>
            ${currentCity ? `<div class="no-results-hint">Searching in ${currentCity} only</div>` : ''}
        </div>
    `;
    
    suggestionsContainer.setAttribute('role', 'alert');
    suggestionsContainer.setAttribute('aria-live', 'polite');
}

// Show Search Error
function showSearchError(searchType) {
    const suggestionsContainer = document.getElementById(`${searchType}Suggestions`);
    
    suggestionsContainer.innerHTML = `
        <div class="search-error-container">
            <div class="search-error-icon" aria-hidden="true"></div>
            <div class="search-error-title">Search unavailable</div>
            <div class="search-error-subtitle">Please check your connection and try again</div>
            <button class="retry-search-btn" onclick="retrySearch('${searchType}')">Retry Search</button>
        </div>
    `;
    
    suggestionsContainer.setAttribute('role', 'alert');
    suggestionsContainer.setAttribute('aria-live', 'assertive');
}

// Retry Search
function retrySearch(searchType) {
    const inputField = getInputFieldForSearchType(searchType);
    if (inputField && inputField.value.length >= searchConfig.minQueryLength) {
        searchPlacesEnhanced(inputField.value, searchType);
    }
}

// Get Input Field for Search Type
function getInputFieldForSearchType(searchType) {
    switch(searchType) {
        case 'destination': return document.getElementById('destinationLocation');
        case 'pickup': return document.getElementById('pickupLocation');
        case 'recipientPickup': return document.getElementById('recipientPickupLocation');
        case 'recipientDestination': return document.getElementById('recipientDestinationLocation');
        case 'shopLocation': return document.getElementById('shopLocation');
        case 'deliveryDestination': return document.getElementById('deliveryDestination');
        default: return null;
    }
}

// Handle Search Result Selection
function handleSearchResultSelection(result, searchType) {
    const inputField = getInputFieldForSearchType(searchType);
    
    if (inputField) {
        // Set the precise address with infrastructure and house number
        inputField.value = formatAddressForInput(result);
        
        // Store the full result for later use
        inputField.dataset.searchResult = JSON.stringify({
            lat: result.lat,
            lon: result.lon,
            name: result.name,
            address: result.address
        });
        
        // Focus the input field
        inputField.focus();
    }
    
    // Hide suggestions
    hideSearchSuggestions(searchType);
    
    // Process based on search type
    processSearchResult(result, searchType);
    
    // Track selection in analytics
    trackSearchSelection(result, searchType);
}

// Format Address for Input Field
function formatAddressForInput(result) {
    let address = '';
    
    // Start with house number if available
    if (result.address && result.address.house_number) {
        address = `House ${result.address.house_number}`;
    }
    
    // Add road name
    if (result.address && result.address.road) {
        address = address ? `${address}, ${result.address.road}` : result.address.road;
    }
    
    // Add suburb/neighbourhood for context
    if (result.address && (result.address.suburb || result.address.neighbourhood)) {
        const area = result.address.suburb || result.address.neighbourhood;
        address = address ? `${address}, ${area}` : area;
    }
    
    // Fallback to display name
    if (!address && result.displayName) {
        address = result.displayName;
    }
    
    // Truncate if too long
    if (address.length > 100) {
        address = address.substring(0, 97) + '...';
    }
    
    return address;
}

// Process Search Result Based on Type
function processSearchResult(result, searchType) {
    switch(searchType) {
        case 'destination':
            handleDestinationSelection(result);
            break;
            
        case 'pickup':
            handlePickupSelection(result);
            break;
            
        case 'recipientPickup':
            handleRecipientPickupSelection(result);
            break;
            
        case 'recipientDestination':
            handleRecipientDestinationSelection(result);
            break;
            
        case 'shopLocation':
            handleShopLocationSelection(result);
            break;
            
        case 'deliveryDestination':
            handleDeliveryDestinationSelection(result);
            break;
    }
}

// Handle Destination Selection
function handleDestinationSelection(result) {
    // Update fare estimate
    updateFareEstimate();
    
    // Update destination marker
    updateDestinationMarker(
        result.lat,
        result.lon,
        result.displayName || result.name
    );
    
    // Draw route from current location to destination
    if (userLocation) {
        drawRoute(userLocation.lat, userLocation.lng, result.lat, result.lon);
    }
    
    selectedDestination = result;
    
    // Enable request ride button
    document.getElementById('requestRideBtn').disabled = false;
    
    // Show notification
    showNotification(`Destination set: ${formatAddressForInput(result)}`, 'success');
}

// Handle Pickup Selection (Editable Pickup Location)
function handlePickupSelection(result) {
    // Update pickup location
    updateManualPickupLocation(result.lat, result.lon, result);
    
    // Validate pickup is within current city
    validatePickupWithinCity(result);
    
    // Show notification
    showNotification(`Pickup set: ${formatAddressForInput(result)}`, 'success');
}

// Handle Recipient Pickup Selection
function handleRecipientPickupSelection(result) {
    calculateRecipientDeliveryFee();
    updateRecipientPickupMarker(result.lat, result.lon, result.displayName || result.name);
    showNotification(`Recipient pickup set: ${formatAddressForInput(result)}`, 'success');
}

// Handle Recipient Destination Selection
function handleRecipientDestinationSelection(result) {
    calculateRecipientDeliveryFee();
    updateRecipientDestinationMarker(result.lat, result.lon, result.displayName || result.name);
    showNotification(`Recipient destination set: ${formatAddressForInput(result)}`, 'success');
}

// Handle Shop Location Selection
function handleShopLocationSelection(result) {
    calculateExpressDeliveryFee();
    updateShopLocationMarker(result.lat, result.lon, result.displayName || result.name);
    showNotification(`Shop location set: ${formatAddressForInput(result)}`, 'success');
}

// Handle Delivery Destination Selection
function handleDeliveryDestinationSelection(result) {
    calculateExpressDeliveryFee();
    updateDeliveryDestinationMarker(result.lat, result.lon, result.displayName || result.name);
    showNotification(`Delivery destination set: ${formatAddressForInput(result)}`, 'success');
}

// Validate Pickup Within Current City
function validatePickupWithinCity(result) {
    if (!currentCity || currentCity === "Unknown Location") return true;
    
    const resultCity = extractCityFromResult(result);
    const isValid = resultCity === currentCity;
    
    if (!isValid) {
        showNotification(`Warning: Pickup location appears to be outside ${currentCity}. Please verify.`, 'warning');
        
        // Highlight the pickup input
        const pickupInput = document.getElementById('pickupLocation');
        pickupInput.style.borderColor = 'var(--warning-yellow)';
        
        // Add a warning icon
        if (!pickupInput.parentElement.querySelector('.city-warning')) {
            const warningIcon = document.createElement('div');
            warningIcon.className = 'city-warning';
            warningIcon.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
            warningIcon.title = `Location may be outside ${currentCity}`;
            pickupInput.parentElement.appendChild(warningIcon);
        }
    }
    
    return isValid;
}

// Track Search Selection in Analytics
function trackSearchSelection(result, searchType) {
    // In production, this would send to analytics service
    console.log('Search selection tracked:', {
        searchType,
        resultType: result.type,
        resultCategory: result.category,
        hasHouseNumber: !!(result.address && result.address.house_number),
        distance: result.distance,
        city: result.city,
        timestamp: Date.now()
    });
}

// Log Search Performance
function logSearchPerformance(startTime, success, strategy) {
    const duration = Date.now() - startTime;
    
    if (!window.searchPerformance) {
        window.searchPerformance = {
            totalSearches: 0,
            successfulSearches: 0,
            averageResponseTime: 0,
            strategyUsage: {}
        };
    }
    
    window.searchPerformance.totalSearches++;
    
    if (success) {
        window.searchPerformance.successfulSearches++;
    }
    
    // Update average response time
    window.searchPerformance.averageResponseTime = 
        (window.searchPerformance.averageResponseTime * (window.searchPerformance.totalSearches - 1) + duration) / 
        window.searchPerformance.totalSearches;
    
    // Track strategy usage
    if (!window.searchPerformance.strategyUsage[strategy]) {
        window.searchPerformance.strategyUsage[strategy] = { count: 0, totalTime: 0 };
    }
    
    window.searchPerformance.strategyUsage[strategy].count++;
    window.searchPerformance.strategyUsage[strategy].totalTime += duration;
}

// Update Search Results Cache
function updateSearchResultsCache(results, searchType) {
    switch(searchType) {
        case 'destination': 
            destinationSearchResults = results;
            break;
        case 'pickup':
            pickupSearchResults = results;
            break;
        case 'recipientPickup':
            recipientPickupSearchResults = results;
            break;
        case 'recipientDestination':
            destinationSearchResults = results;
            break;
        case 'shopLocation':
            shopLocationSearchResults = results;
            break;
        case 'deliveryDestination':
            deliveryDestinationSearchResults = results;
            break;
    }
}

// Hide Search Suggestions
function hideSearchSuggestions(searchType) {
    const suggestionsContainer = document.getElementById(`${searchType}Suggestions`);
    if (suggestionsContainer) {
        suggestionsContainer.style.display = 'none';
        suggestionsContainer.setAttribute('aria-expanded', 'false');
        suggestionsContainer.removeAttribute('role');
        suggestionsContainer.removeAttribute('aria-label');
    }
    
    // Clear search timeouts
    if (window.searchTimeouts) {
        window.searchTimeouts.forEach(timeout => clearTimeout(timeout));
        window.searchTimeouts = [];
    }
}

// Hide All Search Suggestions
function hideAllSearchSuggestions() {
    const searchTypes = [
        'destination', 'pickup', 'recipientPickup', 
        'recipientDestination', 'shopLocation', 'deliveryDestination'
    ];
    
    searchTypes.forEach(type => {
        hideSearchSuggestions(type);
    });
}

// Setup Search Input Listeners
function setupSearchInputListeners() {
    // Setup all search input fields
    setupSearchInputListener('destination', 'destinationLocation', 'destinationSuggestions');
    setupSearchInputListener('pickup', 'pickupLocation', 'pickupSuggestions');
    setupSearchInputListener('recipientPickup', 'recipientPickupLocation', 'recipientPickupSuggestions');
    setupSearchInputListener('recipientDestination', 'recipientDestinationLocation', 'recipientDestinationSuggestions');
    setupSearchInputListener('shopLocation', 'shopLocation', 'shopLocationSuggestions');
    setupSearchInputListener('deliveryDestination', 'deliveryDestination', 'deliveryDestinationSuggestions');
}

// Enhanced Search Input Listener Setup
function setupSearchInputListener(searchType, inputId, suggestionsId) {
    const inputField = document.getElementById(inputId);
    let lastQuery = '';
    let debounceTimer;
    
    if (!inputField) return;
    
    // Input event with advanced debouncing
    inputField.addEventListener('input', function() {
        const query = this.value.trim();
        
        // Clear any existing timer
        if (debounceTimer) {
            clearTimeout(debounceTimer);
        }
        
        // Only search if query changed significantly
        if (query.length >= searchConfig.minQueryLength && query !== lastQuery) {
            // Show typing indicator
            showTypingIndicator(suggestionsId);
            
            // Debounce the search
            debounceTimer = setTimeout(() => {
                lastQuery = query;
                searchPlacesEnhanced(query, searchType);
            }, searchConfig.debounceTime);
        } else if (query.length < searchConfig.minQueryLength) {
            hideSearchSuggestions(searchType);
            lastQuery = '';
        }
    });
    
    // Focus event - show recent searches
    inputField.addEventListener('focus', function() {
        const query = this.value.trim();
        
        if (query.length >= searchConfig.minQueryLength) {
            // Show cached results if available
            const cachedResults = getCachedSearchResults(searchType);
            if (cachedResults.length > 0) {
                displaySearchResults(cachedResults.slice(0, 5), searchType, 'cache');
            }
        } else {
            // Show recent searches
            showRecentSearches(searchType);
        }
        
        // Set ARIA attributes
        const suggestionsContainer = document.getElementById(suggestionsId);
        if (suggestionsContainer) {
            suggestionsContainer.setAttribute('aria-expanded', 'true');
            suggestionsContainer.setAttribute('aria-controls', inputId);
        }
    });
    
    // Key events for better UX
    inputField.addEventListener('keydown', function(e) {
        const suggestionsContainer = document.getElementById(suggestionsId);
        const items = suggestionsContainer.querySelectorAll('.suggestion-item, .recent-search-item');
        
        switch(e.key) {
            case 'Escape':
                hideSearchSuggestions(searchType);
                break;
            case 'Enter':
                if (suggestionsContainer.style.display === 'block') {
                    e.preventDefault();
                    hideSearchSuggestions(searchType);
                    // Auto-select first result if available
                    const cachedResults = getCachedSearchResults(searchType);
                    if (cachedResults.length > 0) {
                        handleSearchResultSelection(cachedResults[0], searchType);
                    }
                }
                break;
            case 'ArrowDown':
                e.preventDefault();
                navigateSuggestions(searchType, 'down');
                break;
            case 'ArrowUp':
                e.preventDefault();
                navigateSuggestions(searchType, 'up');
                break;
            case 'Tab':
                hideSearchSuggestions(searchType);
                break;
        }
    });
    
    // Clear button for pickup location
    if (searchType === 'pickup') {
        addClearButtonToPickup(inputField);
    }
}

// Show Typing Indicator
function showTypingIndicator(suggestionsId) {
    const suggestionsContainer = document.getElementById(suggestionsId);
    if (suggestionsContainer) {
        suggestionsContainer.innerHTML = `
            <div class="typing-indicator">
                <span></span>
                <span></span>
                <span></span>
            </div>
        `;
        suggestionsContainer.style.display = 'block';
        suggestionsContainer.setAttribute('role', 'status');
        suggestionsContainer.setAttribute('aria-live', 'polite');
        suggestionsContainer.setAttribute('aria-label', 'Searching...');
    }
}

// Show Recent Searches
function showRecentSearches(searchType) {
    const suggestionsContainer = document.getElementById(`${searchType}Suggestions`);
    
    if (userSession.cache.recentSearches.length === 0) {
        return;
    }
    
    suggestionsContainer.innerHTML = `
        <div class="recent-searches-header">
            <i class="fas fa-history" aria-hidden="true"></i>
            Recent Searches
        </div>
    `;
    
    // Show recent searches for this type
    const recentForType = userSession.cache.recentSearches
        .filter(s => s.results && s.results.length > 0)
        .slice(0, 5);
    
    recentForType.forEach((search, index) => {
        const searchItem = document.createElement('div');
        searchItem.className = 'recent-search-item';
        searchItem.setAttribute('role', 'option');
        searchItem.setAttribute('tabindex', '-1');
        searchItem.innerHTML = `
            <div class="recent-search-query">
                <i class="fas fa-search" aria-hidden="true"></i>
                ${search.query}
            </div>
            <div class="recent-search-results">
                ${search.results.slice(0, 2).map(r => 
                    `<div class="recent-search-result">${r.displayName || r.name}</div>`
                ).join('')}
            </div>
        `;
        
        searchItem.addEventListener('click', () => {
            const inputField = getInputFieldForSearchType(searchType);
            if (inputField) {
                inputField.value = search.query;
                searchPlacesEnhanced(search.query, searchType);
            }
        });
        
        searchItem.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                const inputField = getInputFieldForSearchType(searchType);
                if (inputField) {
                    inputField.value = search.query;
                    searchPlacesEnhanced(search.query, searchType);
                }
            }
        });
        
        suggestionsContainer.appendChild(searchItem);
    });
    
    suggestionsContainer.style.display = 'block';
    suggestionsContainer.setAttribute('role', 'listbox');
    suggestionsContainer.setAttribute('aria-label', 'Recent searches');
    suggestionsContainer.setAttribute('aria-expanded', 'true');
}

// Add Clear Button to Pickup Input
function addClearButtonToPickup(inputField) {
    const clearButton = document.createElement('button');
    clearButton.type = 'button';
    clearButton.className = 'clear-pickup-btn';
    clearButton.innerHTML = '<i class="fas fa-times"></i>';
    clearButton.title = 'Clear and use current location';
    clearButton.setAttribute('aria-label', 'Clear pickup location');
    clearButton.setAttribute('tabindex', '-1');
    
    clearButton.addEventListener('click', (e) => {
        e.preventDefault();
        inputField.value = '';
        inputField.dataset.searchResult = '';
        
        // Reset to current location
        if (currentLocationMarker) {
            const latLng = currentLocationMarker.getLatLng();
            updateManualPickupLocation(latLng.lat, latLng.lng, {
                name: 'Current Location',
                address: {}
            });
        }
        
        // Remove any warning
        const warningIcon = inputField.parentElement.querySelector('.city-warning');
        if (warningIcon) {
            warningIcon.remove();
        }
        
        inputField.style.borderColor = '';
        inputField.focus();
    });
    
    inputField.parentElement.style.position = 'relative';
    inputField.parentElement.appendChild(clearButton);
    
    // Show/hide clear button based on input
    inputField.addEventListener('input', function() {
        clearButton.style.display = this.value ? 'flex' : 'none';
    });
    
    clearButton.style.display = inputField.value ? 'flex' : 'none';
}

// Navigate Suggestions with Keyboard
function navigateSuggestions(searchType, direction) {
    const suggestionsContainer = document.getElementById(`${searchType}Suggestions`);
    const items = suggestionsContainer.querySelectorAll('.suggestion-item, .recent-search-item');
    
    if (items.length === 0) return;
    
    let currentIndex = -1;
    
    // Find currently selected item
    items.forEach((item, index) => {
        if (item.classList.contains('selected')) {
            currentIndex = index;
        }
    });
    
    // Calculate new index
    let newIndex;
    if (direction === 'down') {
        newIndex = currentIndex < items.length - 1 ? currentIndex + 1 : 0;
    } else {
        newIndex = currentIndex > 0 ? currentIndex - 1 : items.length - 1;
    }
    
    // Update selection
    items.forEach(item => {
        item.classList.remove('selected');
        item.setAttribute('aria-selected', 'false');
    });
    
    const selectedItem = items[newIndex];
    selectedItem.classList.add('selected');
    selectedItem.setAttribute('aria-selected', 'true');
    selectedItem.setAttribute('tabindex', '0');
    
    // Scroll into view
    selectedItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    
    // Update input field with selected item
    const inputField = getInputFieldForSearchType(searchType);
    
    if (selectedItem.classList.contains('suggestion-item')) {
        const index = parseInt(selectedItem.dataset.index);
        const cachedResults = getCachedSearchResults(searchType);
        if (cachedResults[index]) {
            inputField.value = formatAddressForInput(cachedResults[index]);
        }
    } else if (selectedItem.classList.contains('recent-search-item')) {
        const query = selectedItem.querySelector('.recent-search-query').textContent.trim();
        inputField.value = query;
    }
}

// Get Cached Search Results
function getCachedSearchResults(searchType) {
    switch(searchType) {
        case 'destination': return destinationSearchResults;
        case 'pickup': return pickupSearchResults;
        case 'recipientPickup': return recipientPickupSearchResults;
        case 'recipientDestination': return destinationSearchResults;
        case 'shopLocation': return shopLocationSearchResults;
        case 'deliveryDestination': return deliveryDestinationSearchResults;
        default: return [];
    }
}

// Enhanced Map Functions

// Set Manual Pickup Location
function setManualPickupLocation(lat, lng) {
    // Create a temporary marker for map click
    const tempMarker = L.marker([lat, lng], {
        icon: L.divIcon({
            className: 'temp-pickup-marker',
            html: '<div class="temp-pickup-marker"><i class="fas fa-map-marker-alt"></i></div>',
            iconSize: [22, 22]
        })
    }).addTo(passengerMap);
    
    // Get address for this location
    getPreciseAddress(lat, lng, 'pickupLocation').then(address => {
        // Update pickup input
        const pickupInput = document.getElementById('pickupLocation');
        pickupInput.value = address;
        
        // Remove temp marker and add permanent one
        passengerMap.removeLayer(tempMarker);
        updateManualPickupLocation(lat, lng, {
            name: address,
            lat: lat,
            lon: lng
        });
    }).catch(error => {
        errorHandler.captureError(error, { 
            operation: 'set_manual_pickup_location', 
            lat, 
            lng 
        }, 'warning');
        showNotification('Failed to get address for this location', 'error');
    });
}

// Search Nearby from Map Click
function searchNearbyFromMap(lat, lng) {
    // Show nearby search interface
    const searchRadius = 1000; // 1km radius
    
    // Use spatial index to find nearby points
    const nearbyPoints = spatialIndex.searchNearby(lat, lng, searchRadius, 10);
    
    if (nearbyPoints.length > 0) {
        // Convert to search results format
        const results = nearbyPoints.map(point => ({
            lat: point.lat,
            lon: point.lng,
            name: point.data.name || point.data.type,
            type: point.data.type,
            category: point.data.category,
            distance: point.distance,
            displayName: point.data.name || `${point.data.type} (${Math.round(point.distance)}m)`
        }));
        
        // Show results in a popup
        showNearbyResultsPopup(results, lat, lng);
    } else {
        showNotification('No nearby points found in database', 'info');
    }
}

// Show Nearby Results Popup
function showNearbyResultsPopup(results, lat, lng) {
    const popupContent = `
        <div class="nearby-results-popup">
            <h4>Nearby Locations (1km radius)</h4>
            <div class="nearby-results-list">
                ${results.map(result => `
                    <div class="nearby-result-item" onclick="selectNearbyResult(${result.lat}, ${result.lon}, '${result.name.replace(/'/g, "\\'")}')">
                        <div class="nearby-result-name">${result.displayName}</div>
                        <div class="nearby-result-distance">${Math.round(result.distance)}m away</div>
                    </div>
                `).join('')}
            </div>
            <button onclick="searchCustomNearby(${lat}, ${lng})" class="btn btn-primary" style="width: 100%; padding: var(--spacing-3); background: var(--primary-orange); color: white; border: none; border-radius: var(--element-radius); margin-top: var(--spacing-3);">
                <i class="fas fa-search"></i> Search Custom
            </button>
        </div>
    `;
    
    L.popup()
        .setLatLng([lat, lng])
        .setContent(popupContent)
        .openOn(passengerMap);
}

// Select Nearby Result
function selectNearbyResult(lat, lng, name) {
    setManualPickupLocation(lat, lng);
    passengerMap.closePopup();
}

// Search Custom Nearby
function searchCustomNearby(lat, lng) {
    const searchQuery = prompt('What are you looking for nearby?', '');
    if (searchQuery) {
        // Center map on location and search
        passengerMap.setView([lat, lng], 16);
        document.getElementById('destinationLocation').value = searchQuery;
        searchPlacesEnhanced(searchQuery, 'destination');
        passengerMap.closePopup();
    }
}

// Enhanced Address Functions

// Get Precise Address with Infrastructure Details
function getPreciseAddress(lat, lng, elementId) {
    return new Promise((resolve, reject) => {
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1&accept-language=en`, {
            signal: AbortSignal.timeout(5000)
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Geocoding error: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data && data.address) {
                    const preciseAddress = buildDetailedAddress(data.address);
                    
                    if (elementId) {
                        document.getElementById(elementId).value = preciseAddress;
                        
                        // Store the geocoding result
                        const inputField = document.getElementById(elementId);
                        inputField.dataset.searchResult = JSON.stringify({
                            lat: lat,
                            lon: lng,
                            name: data.display_name,
                            address: data.address
                        });
                    }
                    
                    resolve(preciseAddress);
                } else {
                    const fallbackAddress = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                    if (elementId) {
                        document.getElementById(elementId).value = fallbackAddress;
                    }
                    resolve(fallbackAddress);
                }
            })
            .catch(error => {
                console.error('Reverse geocoding error:', error);
                errorHandler.captureError(error, { 
                    operation: 'get_precise_address', 
                    lat, 
                    lng,
                    elementId 
                }, 'warning');
                const fallbackAddress = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                if (elementId) {
                    document.getElementById(elementId).value = fallbackAddress;
                }
                resolve(fallbackAddress);
            });
    });
}

// Build Detailed Address with House Number and Infrastructure
function buildDetailedAddress(address) {
    const parts = [];
    
    // House/Building number (highest priority)
    if (address.house_number) {
        parts.push(`House ${address.house_number}`);
    } else if (address.housenumber) {
        parts.push(`House ${address.housenumber}`);
    }
    
    // Building name
    if (address.building) {
        parts.push(address.building);
    }
    
    // Road/Street
    if (address.road) {
        parts.push(address.road);
    } else if (address.street) {
        parts.push(address.street);
    }
    
    // Suburb/Neighbourhood
    if (address.suburb) {
        parts.push(address.suburb);
    } else if (address.neighbourhood) {
        parts.push(address.neighbourhood);
    }
    
    // Residential area
    if (address.residential) {
        parts.push(address.residential);
    }
    
    // Quarter
    if (address.quarter) {
        parts.push(address.quarter);
    }
    
    // City (only include if not the current city)
    if (address.city && address.city !== currentCity) {
        parts.push(address.city);
    }
    
    // Filter and join
    const filteredParts = parts.filter(part => part && part.trim().length > 0);
    
    if (filteredParts.length > 0) {
        return filteredParts.join(', ');
    }
    
    // Fallback to amenity or display name
    if (address.amenity) {
        return address.amenity;
    }
    
    return null;
}

// Update Pickup Location on Map
function updatePickupLocation(lat, lng) {
    // Update pickup marker
    if (pickupMarker) {
        passengerMap.removeLayer(pickupMarker);
    }
    
    pickupMarker = L.marker([lat, lng], {
        icon: L.divIcon({
            className: 'pickup-marker',
            html: '<div class="pickup-marker"><i class="fas fa-map-marker-alt"></i></div>',
            iconSize: [22, 22]
        })
    }).addTo(passengerMap)
        .bindPopup('Pickup Location')
        .openPopup();
        
    // Update pickup location input with precise address
    getPreciseAddress(lat, lng, 'pickupLocation');
}

// Update Manual Pickup Location with Full Result
function updateManualPickupLocation(lat, lng, result) {
    // Remove current location marker if it exists
    if (currentLocationMarker) {
        passengerMap.removeLayer(currentLocationMarker);
        currentLocationMarker = null;
    }
    
    // Update pickup marker
    if (pickupMarker) {
        passengerMap.removeLayer(pickupMarker);
    }
    
    pickupMarker = L.marker([lat, lng], {
        icon: L.divIcon({
            className: 'pickup-marker',
            html: '<div class="pickup-marker"><i class="fas fa-map-marker-alt"></i></div>',
            iconSize: [22, 22]
        })
    }).addTo(passengerMap)
        .bindPopup(`<strong>${result.name}</strong><br>Pickup Location`)
        .openPopup();
    
    // Update user location for fare calculation
    userLocation = { lat, lng };
    
    // Update fare estimate if destination is set
    const destination = document.getElementById('destinationLocation').value;
    if (destination) {
        updateFareEstimate();
        
        // Redraw route if destination exists
        forwardGeocode(destination).then(results => {
            if (results.length > 0) {
                const destLat = parseFloat(results[0].lat);
                const destLng = parseFloat(results[0].lon);
                drawRoute(lat, lng, destLat, destLng);
            }
        }).catch(error => {
            errorHandler.captureError(error, { 
                operation: 'update_manual_pickup_location', 
                lat, 
                lng,
                result 
            }, 'warning');
        });
    }
    
    // Center map on new pickup location
    passengerMap.setView([lat, lng], 16);
    
    // Validate city
    validatePickupWithinCity(result);
}

// Refresh Passenger Position with Enhanced Accuracy
function refreshPassengerPosition() {
    performanceMonitor.startTimer('geolocation');
    
    if (navigator.geolocation) {
        // Request high accuracy position
        navigator.geolocation.getCurrentPosition(
            position => {
                handlePositionSuccess(position);
                performanceMonitor.endTimer('geolocation');
                performanceMetrics.geolocationTime = performanceMonitor.endTimer('geolocation');
            },
            error => {
                handleGeolocationError(error);
                performanceMonitor.endTimer('geolocation');
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            }
        );
    } else {
        showNotification('Geolocation is not supported by this browser.', 'error');
        currentCity = "Lusaka";
        performanceMonitor.endTimer('geolocation');
    }
}

// Handle Position Success
function handlePositionSuccess(position) {
    const lat = position.coords.latitude;
    const lng = position.coords.longitude;
    const accuracy = position.coords.accuracy;
    
    userLocation = { lat, lng };
    
    // Update map view with accuracy consideration
    passengerMap.setView([lat, lng], accuracy < 100 ? 16 : 14);
    
    // Update or create current location marker
    if (currentLocationMarker) {
        currentLocationMarker.setLatLng([lat, lng]);
    } else {
        currentLocationMarker = L.marker([lat, lng], {
            icon: L.divIcon({
                className: 'current-location-marker',
                html: '<div class="current-location-marker"><i class="fas fa-user"></i></div>',
                iconSize: [18, 18]
            })
        }).addTo(passengerMap)
            .bindPopup('Your location')
            .openPopup();
    }
    
    // Update pickup location
    updatePickupLocation(lat, lng);
    
    // Enhanced city detection with accuracy check
    if (accuracy < 100) {
        showNotification('Detecting your precise location...', 'info');
        determineCurrentCity(lat, lng).then(city => {
            console.log("High accuracy city detection:", city);
            if (currentScreen === 'home') {
                showNotification(`Location detected in ${city}`, 'success');
                updateCitySpecificUI(city);
            }
        }).catch(error => {
            console.error('High accuracy city detection failed:', error);
            errorHandler.captureError(error, { 
                operation: 'handle_position_success', 
                lat, 
                lng 
            }, 'warning');
            currentCity = "Lusaka";
        });
    } else {
        // Use cached or approximate city for lower accuracy
        if (!currentCity) {
            currentCity = "Lusaka";
            showNotification('Using approximate location. For better accuracy, enable high precision GPS.', 'warning');
        }
    }
    
    // Start location tracking if not already started
    if (!locationWatchId) {
        startLocationTracking();
    }
    
    if (currentScreen === 'home') {
        showNotification('Location refreshed with high accuracy', 'success');
    }
}

// Enhanced Geolocation Error Handling
function handleGeolocationError(error) {
    let errorMessage = 'Unable to refresh location. ';
    let errorType = 'unknown';
    
    switch(error.code) {
        case error.PERMISSION_DENIED:
            errorMessage += 'Please enable location services in your browser settings.';
            errorType = 'permission_denied';
            break;
        case error.POSITION_UNAVAILABLE:
            errorMessage += 'Location information is unavailable. Using last known location.';
            errorType = 'position_unavailable';
            break;
        case error.TIMEOUT:
            errorMessage += 'Location request timed out. Please try again.';
            errorType = 'timeout';
            break;
        default:
            errorMessage += 'Please enable location services.';
    }
    
    // Log error for analytics
    console.warn(`Geolocation error (${errorType}):`, error);
    errorHandler.captureError(error, { 
        operation: 'handle_geolocation_error', 
        errorType 
    }, 'warning');
    
    if (currentScreen === 'home') {
        showNotification(errorMessage, 'error');
    }
    
    // Set a default city
    currentCity = currentCity || "Lusaka";
}

// Update City-Specific UI
function updateCitySpecificUI(city) {
    try {
        // Update any UI elements that should change based on city
        const cityElement = document.getElementById('currentCity');
        if (cityElement) {
            cityElement.textContent = city;
        }
        
        // Update search placeholder based on city
        const destinationInput = document.getElementById('destinationLocation');
        if (destinationInput && !destinationInput.value) {
            destinationInput.placeholder = `Where to in ${city}?`;
        }
        
        // Update pickup input placeholder
        const pickupInput = document.getElementById('pickupLocation');
        if (pickupInput) {
            pickupInput.placeholder = `Pickup in ${city} (tap to edit)`;
        }
        
        console.log(`UI updated for city: ${city}`);
        
        // Trigger a search index update for the city
        prefetchCityLocations(city);
    } catch (error) {
        errorHandler.captureError(error, { 
            operation: 'update_city_specific_ui', 
            city 
        }, 'warning');
    }
}

// Enhanced Forward Geocoding
function forwardGeocode(query) {
    return new Promise(resolve => {
        if (!query || query.length < 2) {
            resolve([]);
            return;
        }
        
        // Check cache first
        const cacheKey = `forward_${query}`;
        const cached = userSession.getCachedLocation(cacheKey);
        if (cached) {
            resolve(cached);
            return;
        }
        
        // Build query with city context
        let searchQuery = query;
        if (currentCity && currentCity !== "Unknown Location") {
            // Check if query already contains city
            if (!query.toLowerCase().includes(currentCity.toLowerCase())) {
                searchQuery = `${query}, ${currentCity}, Zambia`;
            }
        }
        
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&limit=10&countrycodes=zm`, {
            signal: AbortSignal.timeout(5000)
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Forward geocoding error: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Filter by distance if user location available
                let filteredResults = data;
                if (userLocation) {
                    filteredResults = data.filter(result => {
                        const distance = calculateDistance(
                            userLocation.lat, userLocation.lng,
                            parseFloat(result.lat), parseFloat(result.lon)
                        );
                        return distance <= 50000; // 50km radius
                    });
                }
                
                // Cache the results
                userSession.cacheLocation(cacheKey, filteredResults);
                
                resolve(filteredResults);
            })
            .catch(error => {
                console.error('Forward geocoding error:', error);
                errorHandler.captureError(error, { 
                    operation: 'forward_geocode', 
                    query 
                }, 'warning');
                resolve([]);
            });
    });
}

// Enhanced Distance Calculation
function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371e3; // Earth's radius in meters
    const 1 = lat1 * Math.PI / 180;
    const 2 = lat2 * Math.PI / 180;
    const  = (lat2 - lat1) * Math.PI / 180;
    const  = (lon2 - lon1) * Math.PI / 180;

    const a = Math.sin(/2) * Math.sin(/2) +
              Math.cos(1) * Math.cos(2) *
              Math.sin(/2) * Math.sin(/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

    return R * c;
}

// Update Fare Estimate with Advanced Routing
function updateFareEstimate() {
    const destination = document.getElementById('destinationLocation').value;
    
    if (destination.length > 3 && userLocation) {
        forwardGeocode(destination).then(results => {
            if (results.length > 0) {
                const destLat = parseFloat(results[0].lat);
                const destLng = parseFloat(results[0].lon);
                
                // Calculate distance using advanced routing if available
                calculateRouteDistance(userLocation.lat, userLocation.lng, destLat, destLng)
                    .then(routeInfo => {
                        updateFareDisplay(routeInfo);
                    })
                    .catch(() => {
                        // Fallback to straight-line distance
                        const straightDistance = calculateDistance(
                            userLocation.lat, userLocation.lng,
                            destLat, destLng
                        );
                        updateFareDisplay({
                            distance: straightDistance,
                            duration: Math.ceil((straightDistance / 1000) / 30 * 60) // Estimated duration
                        });
                    });
                
                document.getElementById('requestRideBtn').disabled = false;
            }
        }).catch(error => {
            errorHandler.captureError(error, { 
                operation: 'update_fare_estimate' 
            }, 'warning');
        });
    } else {
        resetFareDisplay();
        document.getElementById('requestRideBtn').disabled = true;
    }
}

// Calculate Route Distance using OSRM
function calculateRouteDistance(startLat, startLng, endLat, endLng) {
    return new Promise((resolve, reject) => {
        fetch(`https://router.project-osrm.org/route/v1/driving/${startLng},${startLat};${endLng},${endLat}?overview=false`, {
            signal: AbortSignal.timeout(5000)
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Routing error: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.routes && data.routes.length > 0) {
                    const route = data.routes[0];
                    resolve({
                        distance: route.distance,
                        duration: route.duration,
                        geometry: route.geometry
                    });
                } else {
                    reject(new Error('No route found'));
                }
            })
            .catch(error => {
                console.warn('Routing service error:', error);
                errorHandler.captureError(error, { 
                    operation: 'calculate_route_distance', 
                    startLat, 
                    startLng,
                    endLat,
                    endLng 
                }, 'warning');
                reject(error);
            });
    });
}

// Update Fare Display
function updateFareDisplay(routeInfo) {
    let baseFare = 23; // K23 base fare
    
    // Add distance-based fare (K1 per 90 meters after base fare)
    if (routeInfo.distance > 0) {
        baseFare += Math.ceil(routeInfo.distance / 90);
    }
    
    // Apply vehicle type multiplier
    switch(selectedVehicleType) {
        case 'car':
            baseFare = baseFare;
            break;
        case 'bike':
            baseFare = baseFare * 0.7;
            break;
        case 'bicycle':
            baseFare = baseFare * 0.5;
            break;
    }
    
    // Apply promo code discount if applicable
    if (appliedPromoCode) {
        baseFare = baseFare * 0.8;
    }
    
    document.getElementById('estimatedFare').textContent = `K${baseFare.toFixed(2)}`;
    
    // Convert duration from seconds to minutes
    const etaMinutes = routeInfo.duration ? Math.ceil(routeInfo.duration / 60) : 
                          Math.ceil((routeInfo.distance / 1000) / 30 * 60);
    document.getElementById('etaDisplay').textContent = `ETA: ${etaMinutes} min`;
    
    rideFare = baseFare;
}

// Reset Fare Display
function resetFareDisplay() {
    document.getElementById('estimatedFare').textContent = 'K0.00';
    document.getElementById('etaDisplay').textContent = 'ETA: -- min';
}

// Update Destination Marker
function updateDestinationMarker(lat, lng, name) {
    if (destinationMarker) {
        passengerMap.removeLayer(destinationMarker);
    }
    
    destinationMarker = L.marker([lat, lng], {
        icon: L.divIcon({
            className: 'destination-marker',
            html: '<div class="destination-marker"><i class="fas fa-flag"></i></div>',
            iconSize: [22, 22]
        })
    }).addTo(passengerMap)
        .bindPopup(`<strong>${name}</strong><br>Your destination`)
        .openPopup();
    
    if (userLocation) {
        const bounds = L.latLngBounds(
            [userLocation.lat, userLocation.lng],
            [lat, lng]
        );
        passengerMap.fitBounds(bounds, { padding: [12, 12] });
    }
}

// Draw Route with Enhanced Styling
function drawRoute(startLat, startLng, endLat, endLng) {
    if (routePolyline) {
        passengerMap.removeLayer(routePolyline);
    }
    
    fetch(`https://router.project-osrm.org/route/v1/driving/${startLng},${startLat};${endLng},${endLat}?overview=full&geometries=geojson`, {
        signal: AbortSignal.timeout(5000)
    })
        .then(response => response.json())
        .then(data => {
            if (data.routes && data.routes.length > 0) {
                const route = data.routes[0];
                const routeCoordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                
                routePolyline = L.polyline(routeCoordinates, {
                    color: '#FF6B35',
                    weight: 5,
                    opacity: 0.8,
                    lineJoin: 'round',
                    lineCap: 'round',
                    dashArray: route.distance > 10000 ? '10, 10' : null // Dashed for long routes
                }).addTo(passengerMap);
                
                // Add route information popup
                const distanceKm = (route.distance / 1000).toFixed(1);
                const durationMin = Math.ceil(route.duration / 60);
                
                routePolyline.bindPopup(`
                    <div class="route-info">
                        <strong>Route Information</strong><br>
                        Distance: ${distanceKm} km<br>
                        Estimated Time: ${durationMin} minutes
                    </div>
                `);
                
                passengerMap.fitBounds(routePolyline.getBounds(), { padding: [12, 12] });
            }
        })
        .catch(error => {
            console.error('Error fetching route:', error);
            errorHandler.captureError(error, { 
                operation: 'draw_route', 
                startLat, 
                startLng,
                endLat,
                endLng 
            }, 'warning');
            // Fallback: draw a straight line
            routePolyline = L.polyline([
                [startLat, startLng],
                [endLat, endLng]
            ], {
                color: '#FF6B35',
                weight: 4,
                opacity: 0.7,
                dashArray: '10, 10'
            }).addTo(passengerMap);
        });
}

// Enhanced Ride Request Function
function requestRide() {
    const pickupLocation = document.getElementById('pickupLocation').value;
    const destinationLocation = document.getElementById('destinationLocation').value;
    
    if (!destinationLocation) {
        showNotification('Please enter a destination', 'warning');
        return;
    }
    
    if (!pickupLocation) {
        showNotification('Please set a pickup location', 'warning');
        return;
    }
    
    // Get pickup coordinates from stored result or geocode
    const pickupResult = getStoredSearchResult('pickupLocation');
    const pickupPromise = pickupResult ? 
        Promise.resolve(pickupResult) : 
        forwardGeocode(pickupLocation).then(results => results[0]);
    
    // Get destination coordinates
    const destPromise = forwardGeocode(destinationLocation);
    
    Promise.all([pickupPromise, destPromise])
        .then(([pickupData, destResults]) => {
            if (!pickupData || !destResults || destResults.length === 0) {
                showNotification('Invalid addresses. Please select valid locations.', 'error');
                return;
            }
            
            const pickupLat = parseFloat(pickupData.lat);
            const pickupLng = parseFloat(pickupData.lon);
            const destLat = parseFloat(destResults[0].lat);
            const destLng = parseFloat(destResults[0].lon);
            
            // Validate pickup is within current city
            const pickupCity = extractCityFromResult({ address: pickupData.address });
            if (currentCity && pickupCity !== currentCity) {
                if (!confirm(`Pickup appears to be outside ${currentCity}. Continue anyway?`)) {
                    return;
                }
            }
            
            proceedWithRideRequest(pickupData, destResults[0], pickupLat, pickupLng, destLat, destLng);
        })
        .catch(error => {
            console.error('Error in ride request:', error);
            errorHandler.captureError(error, { 
                operation: 'request_ride' 
            }, 'error');
            showNotification('Error processing addresses. Please try again.', 'error');
        });
}

// Get Stored Search Result
function getStoredSearchResult(inputId) {
    const inputField = document.getElementById(inputId);
    if (inputField && inputField.dataset.searchResult) {
        try {
            return JSON.parse(inputField.dataset.searchResult);
        } catch (e) {
            errorHandler.captureError(e, { 
                operation: 'get_stored_search_result', 
                inputId 
            }, 'warning');
            return null;
        }
    }
    return null;
}

// Proceed with Ride Request
function proceedWithRideRequest(pickupData, destData, pickupLat, pickupLng, destLat, destLng) {
    // Collect package details if form is active
    if (document.getElementById('packageForm').classList.contains('active')) {
        packageDetails = {
            receiverName: document.getElementById('receiverName').value,
            receiverPhone: document.getElementById('receiverPhone').value,
            packageDescription: document.getElementById('packageDescription').value,
            specialInstructions: document.getElementById('specialInstructions').value,
            packageValue: document.getElementById('packageValue').value
        };
    } else {
        packageDetails = null;
    }
    
    // Calculate distance and fare
    const distance = calculateDistance(pickupLat, pickupLng, destLat, destLng);
    let baseFare = calculateFareFromDistance(distance);
    
    // Generate a unique ride ID
    const rideId = database.ref().child('rides').push().key;
    
    // Create ride request with enhanced data
    const rideRequest = {
        id: rideId,
        passengerId: currentUser.uid,
        passengerName: userData.name || 'Passenger',
        passengerPhone: userData.phone || 'Not provided',
        pickupLocation: pickupData.display_name || pickupData.name,
        pickupDisplayLocation: formatAddressForDisplay(pickupData),
        destination: destData.display_name,
        pickupLat: pickupLat,
        pickupLng: pickupLng,
        destLat: destLat,
        destLng: destLng,
        rideType: selectedVehicleType,
        fare: baseFare,
        distance: (distance / 1000).toFixed(2) + ' km',
        status: 'requested',
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        updatedAt: firebase.database.ServerValue.TIMESTAMP,
        promoCode: appliedPromoCode,
        paymentMethod: selectedPaymentType,
        packageDetails: packageDetails,
        currentCity: currentCity,
        addressDetails: {
            pickup: extractAddressDetails(pickupData),
            destination: extractAddressDetails(destData)
        }
    };
    
    // Store ride request data
    currentRideRequestData = rideRequest;
    currentRideRequestType = 'standard';
    
    // Show payment selection
    showPaymentSelection(baseFare);
}

// Calculate Fare from Distance
function calculateFareFromDistance(distance) {
    let baseFare = 23; // K23 base fare
    
    // Add distance-based fare (K1 per 90 meters after base fare)
    if (distance > 0) {
        baseFare += Math.ceil(distance / 90);
    }
    
    // Apply vehicle type multiplier
    switch(selectedVehicleType) {
        case 'car':
            baseFare = baseFare;
            break;
        case 'bike':
            baseFare = baseFare * 0.7;
            break;
        case 'bicycle':
            baseFare = baseFare * 0.5;
            break;
    }
    
    // Apply promo code discount if applicable
    if (appliedPromoCode) {
        baseFare = baseFare * 0.8;
    }
    
    return baseFare;
}

// Format Address for Display
function formatAddressForDisplay(data) {
    if (data.address) {
        const parts = [];
        
        if (data.address.house_number) {
            parts.push(`House ${data.address.house_number}`);
        }
        
        if (data.address.road) {
            parts.push(data.address.road);
        }
        
        if (data.address.suburb) {
            parts.push(data.address.suburb);
        }
        
        return parts.join(', ');
    }
    
    return data.display_name || data.name;
}

// Extract Address Details
function extractAddressDetails(data) {
    if (!data.address) return {};
    
    return {
        houseNumber: data.address.house_number || data.address.housenumber,
        road: data.address.road || data.address.street,
        suburb: data.address.suburb || data.address.neighbourhood,
        city: data.address.city || data.address.town,
        postcode: data.address.postcode
    };
}

// Show Payment Selection
function showPaymentSelection(fare = null) {
    const calculatedFare = fare || rideFare;
    
    document.getElementById('paymentWalletBalance').textContent = `Balance: K${walletBalance.toFixed(2)}`;
    
    if (walletBalance < calculatedFare) {
        document.getElementById('insufficientBalance').style.display = 'flex';
        document.getElementById('confirmPaymentBtn').disabled = true;
    } else {
        document.getElementById('insufficientBalance').style.display = 'none';
        document.getElementById('confirmPaymentBtn').disabled = false;
    }
    
    document.getElementById('paymentSelectionPopup').classList.remove('hidden');
    document.getElementById('paymentSelectionPopup').setAttribute('aria-hidden', 'false');
}

// Close Payment Selection
function closePaymentSelection() {
    document.getElementById('paymentSelectionPopup').classList.add('hidden');
    document.getElementById('paymentSelectionPopup').setAttribute('aria-hidden', 'true');
}

// Submit Ride Request
function submitRideRequest() {
    if (!currentRideRequestData) {
        showNotification('No ride request data found. Please try again.', 'error');
        return;
    }
    
    const rideRequest = currentRideRequestData;
    
    // If payment is via wallet, deduct fare from wallet
    if (selectedPaymentType === 'wallet') {
        const newBalance = walletBalance - rideRequest.fare;
        
        database.ref('users/' + currentUser.uid).update({
            walletBalance: newBalance
        })
        .then(() => {
            walletBalance = newBalance;
            updateWalletBalanceUI();
            
            return database.ref('rides/' + rideRequest.id).set(rideRequest);
        })
        .then(() => {
            currentRide = rideRequest;
            
            closePaymentSelection();
            updateUIForActiveRide();
            
            // Show searching animation
            document.getElementById('searchingAnimation').style.display = 'flex';
            document.getElementById('rideStatus').style.display = 'flex';
            document.getElementById('statusDot').className = 'status-dot searching';
            document.getElementById('statusText').textContent = 'Searching for driver';
            
            // Show SOS button if configured
            if (sosConfig && sosConfig.contact1) {
                document.getElementById('sosButton').style.display = 'flex';
            }
            
            showNotification('Ride requested. Searching for a driver...', 'success');
            
            listenForDriverAssignment(rideRequest.id);
        })
        .catch(error => {
            console.error('Error requesting ride:', error);
            errorHandler.captureError(error, { 
                operation: 'submit_ride_request', 
                rideRequest 
            }, 'error');
            showNotification('Error requesting ride. Please try again.', 'error');
        });
    } else {
        database.ref('rides/' + rideRequest.id).set(rideRequest)
            .then(() => {
                currentRide = rideRequest;
                
                closePaymentSelection();
                updateUIForActiveRide();
                
                // Show searching animation
                document.getElementById('searchingAnimation').style.display = 'flex';
                document.getElementById('rideStatus').style.display = 'flex';
                document.getElementById('statusDot').className = 'status-dot searching';
                document.getElementById('statusText').textContent = 'Searching for driver';
                
                // Show SOS button if configured
                if (sosConfig && sosConfig.contact1) {
                    document.getElementById('sosButton').style.display = 'flex';
                }
                
                showNotification('Ride requested. Searching for a driver...', 'success');
                
                listenForDriverAssignment(rideRequest.id);
            })
            .catch(error => {
                console.error('Error requesting ride:', error);
                errorHandler.captureError(error, { 
                    operation: 'submit_ride_request', 
                    rideRequest 
                }, 'error');
                showNotification('Error requesting ride. Please try again.', 'error');
            });
    }
    
    // Clear request data
    currentRideRequestData = null;
}

// Update UI for Active Ride
function updateUIForActiveRide() {
    document.getElementById('rideRequestForm').style.display = 'none';
    document.getElementById('rideInfoPanel').style.display = 'block';
    
    document.getElementById('currentPickupLocation').textContent = currentRide.pickupDisplayLocation || currentRide.pickupLocation;
    document.getElementById('currentDestinationLocation').textContent = currentRide.destination;
    
    const baseFare = currentRide.fare;
    const discount = appliedPromoCode ? baseFare * 0.2 : 0;
    const totalFare = baseFare - discount;
    
    document.getElementById('baseFare').textContent = `K${baseFare.toFixed(2)}`;
    document.getElementById('discountFare').textContent = `-K${discount.toFixed(2)}`;
    document.getElementById('totalFare').textContent = `K${totalFare.toFixed(2)}`;
}

// Listen for Driver Assignment
function listenForDriverAssignment(rideId) {
    if (driverAssignmentListener) {
        driverAssignmentListener();
    }
    
    driverAssignmentListener = database.ref('rides/' + rideId).on('value', snapshot => {
        const ride = snapshot.val();
        if (!ride) {
            showNotification('Ride not found. Please try again.', 'error');
            return;
        }
        
        console.log('Ride status update:', ride.status, ride.driverId);
        
        if (ride.driverId && ride.status === 'accepted') {
            handleDriverAssignment(ride);
        } else if (ride.status === 'completed') {
            showRideCompletion(ride);
        } else if (ride.status === 'cancelled') {
            handleRideCancellation(ride);
        } else if (ride.status === 'arrived') {
            showNotification('Your driver has arrived at the pickup location.', 'success');
        } else if (ride.status === 'picked_up') {
            showNotification('You have been picked up. Enjoy your ride!', 'success');
        } else if (ride.status === 'started') {
            showNotification('Your trip has started.', 'info');
        }
    }, error => {
        console.error('Error listening for driver assignment:', error);
        errorHandler.captureError(error, { 
            operation: 'listen_for_driver_assignment', 
            rideId 
        }, 'error');
        showNotification('Connection error. Please check your internet connection.', 'error');
    });
}

// Handle Driver Assignment
function handleDriverAssignment(ride) {
    document.getElementById('searchingAnimation').style.display = 'none';
    document.getElementById('statusDot').className = 'status-dot arriving';
    document.getElementById('statusText').textContent = 'Driver arriving';
    document.getElementById('estimatedTime').style.display = 'flex';
    document.getElementById('timeText').textContent = '5 min';
    
    database.ref('users/' + ride.driverId).once('value')
        .then(driverSnapshot => {
            const driver = driverSnapshot.val();
            if (driver) {
                document.getElementById('driverName').textContent = driver.name || 'Driver';
                document.getElementById('driverPhone').textContent = driver.phone || 'N/A';
                document.getElementById('driverRating').textContent = driver.rating || '4.5';
                
                if (driver.vehicle) {
                    document.getElementById('vehicleDetails').textContent = 
                        `${driver.vehicle.type || 'Vehicle'} - ${driver.vehicle.licensePlate || 'ABC123'}`;
                }
                
                updateDriverAvatarWithImage(driver, ride);
                updateDriverVehicleDisplay(driver, ride);
                updateDriverDetailsCard(driver);
                addChatWithDriverButton(ride.id, driver);
                addDriverMarker(ride.driverLat, ride.driverLng);
                drawRoute(ride.driverLat, ride.driverLng, ride.pickupLat, ride.pickupLng);
                trackDriverLocation(ride.driverId);
                
                showNotification(`Driver ${driver.name} is on the way!`, 'success');
                startDriverMessageListener(ride.id);
            }
        })
        .catch(error => {
            errorHandler.captureError(error, { 
                operation: 'handle_driver_assignment', 
                rideId: ride.id 
            }, 'error');
        });
    
    listenForRideStatusUpdates(ride.id);
}

// Update Driver Avatar with Image
function updateDriverAvatarWithImage(driver, ride) {
    const driverAvatar = document.getElementById('driverAvatar');
    
    if (ride.driverProfileImage) {
        driverProfileImage = ride.driverProfileImage;
        driverAvatar.innerHTML = `<img src="${driverProfileImage}" class="driver-profile-image" alt="Driver" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
    } else if (driver.images && driver.images.profilePhoto) {
        driverProfileImage = driver.images.profilePhoto;
        driverAvatar.innerHTML = `<img src="${driverProfileImage}" class="driver-profile-image" alt="Driver" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
    } else if (driver.name) {
        driverAvatar.innerHTML = driver.name.charAt(0).toUpperCase();
    } else {
        driverAvatar.innerHTML = '<i class="fas fa-user"></i>';
    }
}

// Update Driver Vehicle Display
function updateDriverVehicleDisplay(driver, ride) {
    const vehicleImageSection = document.getElementById('vehicleImageSection');
    
    if (!vehicleImageSection) {
        const driverDetailsCard = document.getElementById('driverDetailsCard');
        const vehicleSection = document.createElement('div');
        vehicleSection.id = 'vehicleImageSection';
        vehicleSection.className = 'vehicle-image-section';
        vehicleSection.style.cssText = `
            margin-top: 10px;
            padding: 10px;
            background: var(--light-gray);
            border-radius: var(--element-radius);
            border: 1px solid var(--border-color);
        `;
        vehicleSection.innerHTML = `
            <h4 class="section-title" style="font-size: 0.8rem; margin-bottom: 8px;">
                <i class="fas fa-car"></i> Driver's Vehicle
            </h4>
            <div id="vehicleImageContainer"></div>
        `;
        driverDetailsCard.appendChild(vehicleSection);
    }
    
    const vehicleImageContainer = document.getElementById('vehicleImageContainer');
    
    if (ride.vehicleImage) {
        driverVehicleImage = ride.vehicleImage;
        vehicleImageContainer.innerHTML = `
            <img id="vehicleFrontImage" class="vehicle-image" src="${driverVehicleImage}" alt="Vehicle" style="width: 100%; height: 150px; object-fit: cover; border-radius: 8px; margin-bottom: 8px;">
            <div class="vehicle-details-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.7rem;">
                <div class="vehicle-detail">
                    <strong>Type:</strong> ${driver.vehicle?.type || 'N/A'}
                </div>
                <div class="vehicle-detail">
                    <strong>Model:</strong> ${driver.vehicle?.model || 'N/A'}
                </div>
                <div class="vehicle-detail">
                    <strong>Color:</strong> ${driver.vehicle?.color || 'N/A'}
                </div>
                <div class="vehicle-detail">
                    <strong>Plate:</strong> ${driver.vehicle?.licensePlate || 'N/A'}
                </div>
            </div>
        `;
    } else if (driver.images && driver.images.vehicleFront) {
        driverVehicleImage = driver.images.vehicleFront;
        vehicleImageContainer.innerHTML = `
            <img id="vehicleFrontImage" class="vehicle-image" src="${driverVehicleImage}" alt="Vehicle" style="width: 100%; height: 150px; object-fit: cover; border-radius: 8px; margin-bottom: 8px;">
            <div class="vehicle-details-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.7rem;">
                <div class="vehicle-detail">
                    <strong>Type:</strong> ${driver.vehicle?.type || 'N/A'}
                </div>
                <div class="vehicle-detail">
                    <strong>Model:</strong> ${driver.vehicle?.model || 'N/A'}
                </div>
                <div class="vehicle-detail">
                    <strong>Color:</strong> ${driver.vehicle?.color || 'N/A'}
                </div>
                <div class="vehicle-detail">
                    <strong>Plate:</strong> ${driver.vehicle?.licensePlate || 'N/A'}
                </div>
            </div>
        `;
    } else {
        vehicleImageContainer.innerHTML = `
            <div class="no-vehicle-image" style="text-align: center; padding: 20px; color: var(--medium-gray); font-size: 0.8rem;">
                <i class="fas fa-car" style="font-size: 2rem; margin-bottom: 8px; display: block;"></i>
                Vehicle image not available
            </div>
            <div class="vehicle-details-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.7rem; margin-top: 8px;">
                <div class="vehicle-detail">
                    <strong>Type:</strong> ${driver.vehicle?.type || 'N/A'}
                </div>
                <div class="vehicle-detail">
                    <strong>Model:</strong> ${driver.vehicle?.model || 'N/A'}
                </div>
                <div class="vehicle-detail">
                    <strong>Color:</strong> ${driver.vehicle?.color || 'N/A'}
                </div>
                <div class="vehicle-detail">
                    <strong>Plate:</strong> ${driver.vehicle?.licensePlate || 'N/A'}
                </div>
            </div>
        `;
    }
}

// Add Chat with Driver Button
function addChatWithDriverButton(rideId, driver) {
    const rideActions = document.querySelector('.ride-actions');
    
    if (!document.getElementById('chatWithDriverBtn')) {
        const chatButton = document.createElement('button');
        chatButton.id = 'chatWithDriverBtn';
        chatButton.className = 'btn btn-contact';
        chatButton.innerHTML = '<i class="fas fa-comments"></i> Chat with Driver';
        chatButton.addEventListener('click', function() {
            openChatWithDriver(rideId, driver);
        });
        
        const contactBtn = document.getElementById('contactDriverBtn');
        rideActions.insertBefore(chatButton, contactBtn);
    }
}

// Open Chat with Driver
function openChatWithDriver(rideId, driver) {
    if (!document.getElementById('chatPopup')) {
        createChatPopup();
    }
    
    currentChatRideId = rideId;
    chatPopupClosedByUser = false;
    
    document.getElementById('chatDriverName').textContent = driver.name || 'Driver';
    document.getElementById('chatDriverRating').textContent = driver.rating ? `${driver.rating} ` : '4.5 ';
    
    const chatDriverAvatar = document.getElementById('chatDriverAvatar');
    if (driverProfileImage) {
        chatDriverAvatar.innerHTML = `<img src="${driverProfileImage}" class="driver-profile-image" alt="Driver" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
    } else if (driver.name) {
        chatDriverAvatar.innerHTML = driver.name.charAt(0).toUpperCase();
    } else {
        chatDriverAvatar.innerHTML = '<i class="fas fa-user"></i>';
    }
    
    document.getElementById('chatPopup').classList.remove('hidden');
    loadChatMessages(rideId);
    startChatListener(rideId);
}

// Create Chat Popup
function createChatPopup() {
    const chatPopup = document.createElement('div');
    chatPopup.id = 'chatPopup';
    chatPopup.className = 'popup-overlay hidden';
    chatPopup.innerHTML = `
        <div class="popup-form" style="max-width: 400px; height: 500px; display: flex; flex-direction: column;">
            <div class="popup-header">
                <h2 class="popup-title">
                    <i class="fas fa-comments"></i>
                    Chat with Driver
                </h2>
                <button class="close-popup" id="closeChatPopup">&times;</button>
            </div>
            <div class="chat-driver-info" style="padding: 10px; border-bottom: 1px solid var(--border-color); background: var(--light-orange);">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div class="driver-avatar" id="chatDriverAvatar" style="width: 30px; height: 30px; font-size: 0.8rem; background: var(--primary-orange); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white;"></div>
                    <div>
                        <div style="font-weight: 600; font-size: 0.9rem;" id="chatDriverName">Driver</div>
                        <div style="font-size: 0.7rem; color: var(--medium-gray);" id="chatDriverRating">4.5 </div>
                    </div>
                </div>
            </div>
            <div class="chat-messages" id="chatMessages" style="flex: 1; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; background: var(--light-gray);"></div>
            <div class="chat-input-container" style="padding: 10px; border-top: 1px solid var(--border-color); background: var(--white);">
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="chatMessageInput" placeholder="Type your message..." style="flex: 1; padding: 8px; border: 1px solid var(--border-color); border-radius: var(--element-radius);">
                    <button id="sendChatMessageBtn" style="padding: 8px 15px; background: var(--primary-orange); color: white; border: none; border-radius: var(--element-radius); cursor: pointer;">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(chatPopup);
    
    document.getElementById('closeChatPopup').addEventListener('click', function() {
        chatPopupClosedByUser = true;
        closeChatPopup();
    });
    
    document.getElementById('sendChatMessageBtn').addEventListener('click', sendChatMessage);
    document.getElementById('chatMessageInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendChatMessage();
        }
    });
}

// Load Chat Messages
function loadChatMessages(rideId) {
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.innerHTML = '<div class="loading-text">Loading messages...</div>';
    
    database.ref('chats/' + rideId).orderByChild('timestamp').once('value')
        .then(snapshot => {
            const messages = snapshot.val();
            chatMessages.innerHTML = '';
            
            if (messages) {
                const messagesArray = Object.values(messages);
                messagesArray.forEach(message => {
                    displayChatMessage(message);
                });
                
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } else {
                chatMessages.innerHTML = '<div class="no-places" style="text-align: center; padding: 20px; color: var(--medium-gray);">No messages yet. Start the conversation!</div>';
            }
        })
        .catch(error => {
            console.error('Error loading chat messages:', error);
            errorHandler.captureError(error, { 
                operation: 'load_chat_messages', 
                rideId 
            }, 'warning');
            chatMessages.innerHTML = '<div class="no-places" style="text-align: center; padding: 20px; color: var(--error-red);">Error loading messages.</div>';
        });
}

// Start Chat Listener
function startChatListener(rideId) {
    if (chatListener) {
        chatListener();
    }
    
    chatListener = database.ref('chats/' + rideId).orderByChild('timestamp').on('child_added', snapshot => {
        const message = snapshot.val();
        displayChatMessage(message);
        
        const chatMessages = document.getElementById('chatMessages');
        chatMessages.scrollTop = chatMessages.scrollHeight;
    });
}

// Display Chat Message
function displayChatMessage(message) {
    const chatMessages = document.getElementById('chatMessages');
    
    if (chatMessages.querySelector('.loading-text') || chatMessages.querySelector('.no-places')) {
        chatMessages.innerHTML = '';
    }
    
    const messageElement = document.createElement('div');
    messageElement.className = `chat-message ${message.senderId === currentUser.uid ? 'own-message' : 'other-message'}`;
    messageElement.style.cssText = `
        max-width: 80%;
        padding: 8px 12px;
        border-radius: 15px;
        margin-bottom: 5px;
        word-wrap: break-word;
        align-self: ${message.senderId === currentUser.uid ? 'flex-end' : 'flex-start'};
        background: ${message.senderId === currentUser.uid ? 'var(--primary-orange)' : 'var(--white)'};
        color: ${message.senderId === currentUser.uid ? 'white' : 'var(--dark-gray)'};
        border: ${message.senderId === currentUser.uid ? 'none' : '1px solid var(--border-color)'};
        box-shadow: ${message.senderId === currentUser.uid ? 'var(--shadow-light)' : 'none'};
    `;
    
    const timestamp = new Date(message.timestamp);
    const timeString = timestamp.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    messageElement.innerHTML = `
        <div style="font-size: 0.8rem;">${message.message}</div>
        <div style="font-size: 0.6rem; opacity: 0.7; text-align: ${message.senderId === currentUser.uid ? 'right' : 'left'}; margin-top: 4px;">${timeString}</div>
    `;
    
    chatMessages.appendChild(messageElement);
}

// Send Chat Message
function sendChatMessage() {
    const messageInput = document.getElementById('chatMessageInput');
    const message = messageInput.value.trim();
    
    if (!message || !currentChatRideId) {
        return;
    }
    
    const messageData = {
        message: message,
        senderId: currentUser.uid,
        senderName: userData.name || 'Passenger',
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        rideId: currentChatRideId
    };
    
    database.ref('chats/' + currentChatRideId).push(messageData)
        .then(() => {
            messageInput.value = '';
            messageInput.focus();
        })
        .catch(error => {
            console.error('Error sending message:', error);
            errorHandler.captureError(error, { 
                operation: 'send_chat_message', 
                rideId: currentChatRideId 
            }, 'warning');
            showNotification('Error sending message. Please try again.', 'error');
        });
}

// Start Driver Message Listener
function startDriverMessageListener(rideId) {
    if (driverMessageListener) {
        driverMessageListener();
    }
    
    driverMessageListener = database.ref('chats/' + rideId).orderByChild('timestamp').on('child_added', snapshot => {
        const message = snapshot.val();
        
        if (message.senderId !== currentUser.uid) {
            if (chatPopupClosedByUser && !isChatPopupOpen()) {
                openChatWithDriver(rideId, { name: 'Driver' });
                showNotification('New message from driver', 'info');
            }
            
            if (isChatPopupOpen() && currentChatRideId === rideId) {
                displayChatMessage(message);
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }
    });
}

// Check if Chat Popup is Open
function isChatPopupOpen() {
    const chatPopup = document.getElementById('chatPopup');
    return chatPopup && !chatPopup.classList.contains('hidden');
}

// Close Chat Popup
function closeChatPopup() {
    document.getElementById('chatPopup').classList.add('hidden');
    
    if (chatListener) {
        chatListener();
        chatListener = null;
    }
    
    currentChatRideId = null;
}

// Update Driver Details Card
function updateDriverDetailsCard(driver) {
    const driverDetailsCard = document.getElementById('driverDetailsCard');
    driverDetailsCard.style.display = 'block';
    
    document.getElementById('driverFullName').textContent = driver.name || 'Driver';
    document.getElementById('driverContactPhone').textContent = driver.phone || 'Not available';
    document.getElementById('driverRatingValue').textContent = driver.rating ? `${driver.rating} ` : '4.5 ';
    document.getElementById('driverExperience').textContent = driver.experience || '2 years';
    
    if (driver.vehicle) {
        document.getElementById('vehicleType').textContent = driver.vehicle.type || 'Car';
        document.getElementById('vehicleModel').textContent = driver.vehicle.model || 'Not specified';
        document.getElementById('vehicleLicense').textContent = driver.vehicle.licensePlate || 'Not available';
        document.getElementById('vehicleColor').textContent = driver.vehicle.color || 'Not specified';
    }
}

// Track Driver Location
function trackDriverLocation(driverId) {
    if (driverLocationListener) {
        driverLocationListener();
    }
    
    driverLocationListener = database.ref('driverLocations/' + driverId).on('value', snapshot => {
        const location = snapshot.val();
        if (location && driverMarker) {
            driverMarker.setLatLng([location.latitude, location.longitude]);
            updateDriverETA(location.latitude, location.longitude);
        }
    });
}

// Update Driver ETA
function updateDriverETA(driverLat, driverLng) {
    if (userLocation) {
        const distance = calculateDistance(
            driverLat, driverLng,
            userLocation.lat, userLocation.lng
        );
        
        const etaMinutes = Math.ceil((distance / 1000) / 30 * 60);
        document.getElementById('timeText').textContent = `${etaMinutes} min`;
    }
}

// Listen for Ride Status Updates
function listenForRideStatusUpdates(rideId) {
    database.ref('rides/' + rideId).on('value', snapshot => {
        const ride = snapshot.val();
        if (ride) {
            currentRide = ride;
            
            switch(ride.status) {
                case 'accepted':
                    document.getElementById('statusText').textContent = 'Driver on the way';
                    break;
                case 'arrived':
                    document.getElementById('statusText').textContent = 'Driver arrived';
                    document.getElementById('statusDot').className = 'status-dot riding';
                    showNotification('Your driver has arrived!', 'success');
                    break;
                case 'started':
                    document.getElementById('statusText').textContent = 'Trip in progress';
                    addDestinationMarker(ride.destLat, ride.destLng);
                    drawRoute(ride.pickupLat, ride.pickupLng, ride.destLat, ride.destLng);
                    break;
                case 'completed':
                    document.getElementById('statusText').textContent = 'Trip completed';
                    document.getElementById('rideStatus').style.display = 'none';
                    document.getElementById('estimatedTime').style.display = 'none';
                    document.getElementById('sosButton').style.display = 'none';
                    resetUIAfterRide();
                    showRatingPopup(ride);
                    showNotification('Trip completed. Thank you for using Jubel!', 'success');
                    break;
                case 'cancelled':
                    document.getElementById('rideStatus').style.display = 'none';
                    document.getElementById('estimatedTime').style.display = 'none';
                    document.getElementById('sosButton').style.display = 'none';
                    resetUIAfterRide();
                    showNotification('Ride cancelled', 'info');
                    break;
            }
        }
    });
}

// Add Driver Marker
function addDriverMarker(lat, lng) {
    if (driverMarker) {
        passengerMap.removeLayer(driverMarker);
    }
    
    driverMarker = L.marker([lat, lng], {
        icon: L.divIcon({
            className: 'driver-marker',
            html: '<div class="driver-marker"></div><div class="driver-marker-label">Driver</div>',
            iconSize: [32, 45]
        })
    }).addTo(passengerMap)
        .bindPopup('Your driver');
}

// Add Destination Marker
function addDestinationMarker(lat, lng) {
    if (destinationMarker) {
        passengerMap.removeLayer(destinationMarker);
    }
    
    destinationMarker = L.marker([lat, lng], {
        icon: L.divIcon({
            className: 'destination-marker',
            html: '<div class="destination-marker"><i class="fas fa-flag"></i></div>',
            iconSize: [22, 22]
        })
    }).addTo(passengerMap)
        .bindPopup('Destination');
}

// Handle Ride Cancellation
function handleRideCancellation(ride) {
    document.getElementById('searchingAnimation').style.display = 'none';
    showNotification('Ride has been cancelled.', 'info');
    resetUIAfterRide();
    currentRide = null;
    
    if (driverMarker) {
        passengerMap.removeLayer(driverMarker);
        driverMarker = null;
    }
    
    if (driverAssignmentListener) {
        driverAssignmentListener();
        driverAssignmentListener = null;
    }
    
    if (driverLocationListener) {
        driverLocationListener();
        driverLocationListener = null;
    }
    
    if (driverMessageListener) {
        driverMessageListener();
        driverMessageListener = null;
    }
}

// Cancel Ride
function cancelRide() {
    if (currentRide) {
        if (confirm('Are you sure you want to cancel this ride?')) {
            database.ref('rides/' + currentRide.id).update({
                status: 'cancelled',
                cancelledAt: firebase.database.ServerValue.TIMESTAMP,
                updatedAt: firebase.database.ServerValue.TIMESTAMP
            })
            .then(() => {
                resetUIAfterRide();
                showNotification('Ride cancelled', 'info');
            })
            .catch(error => {
                console.error('Error cancelling ride:', error);
                errorHandler.captureError(error, { 
                    operation: 'cancel_ride', 
                    rideId: currentRide.id 
                }, 'error');
                showNotification('Error cancelling ride. Please try again.', 'error');
            });
        }
    }
}

// Contact Driver
function contactDriver() {
    if (currentRide && currentRide.driverId) {
        database.ref('users/' + currentRide.driverId).once('value')
            .then(snapshot => {
                const driver = snapshot.val();
                if (driver && driver.phone) {
                    showNotification(`Calling driver: ${driver.phone}`, 'info');
                    window.open(`tel:${driver.phone}`, '_self');
                } else {
                    showNotification('Driver phone number not available.', 'warning');
                }
            })
            .catch(error => {
                errorHandler.captureError(error, { 
                    operation: 'contact_driver', 
                    rideId: currentRide.id 
                }, 'warning');
            });
    }
}

// Apply Promo Code
function applyPromoCode() {
    const promoCode = document.getElementById('promoCode').value.trim();
    
    if (!promoCode) {
        showNotification('Please enter a promo code.', 'warning');
        return;
    }
    
    if (promoCode.startsWith('JUBEL')) {
        applyReferralCode(promoCode);
    } else {
        if (promoCode.startsWith('JUBEL-')) {
            appliedPromoCode = promoCode;
            showNotification('Promo code applied! 20% discount will be applied to your ride.', 'success');
            updateFareEstimate();
            
            document.getElementById('promoCode').style.borderColor = 'var(--success-green)';
            document.getElementById('applyPromoBtn').innerHTML = '<i class="fas fa-check"></i> Applied';
            document.getElementById('applyPromoBtn').classList.remove('btn-promo');
            document.getElementById('applyPromoBtn').classList.add('btn-success');
        } else {
            showNotification('Invalid promo code. Please check and try again.', 'error');
            document.getElementById('promoCode').style.borderColor = 'var(--error-red)';
        }
    }
}

// Apply Referral Code
function applyReferralCode(referralCode) {
    database.ref('users').orderByChild('referralCode').equalTo(referralCode).once('value')
        .then(snapshot => {
            if (snapshot.exists()) {
                const referrerData = snapshot.val();
                const referrerId = Object.keys(referrerData)[0];
                const referrer = referrerData[referrerId];
                
                appliedPromoCode = referralCode;
                showNotification('Referral code applied! 50% discount will be applied to your ride.', 'success');
                updateFareEstimate();
                
                document.getElementById('promoCode').style.borderColor = 'var(--success-green)';
                document.getElementById('applyPromoBtn').innerHTML = '<i class="fas fa-check"></i> Applied';
                document.getElementById('applyPromoBtn').classList.remove('btn-promo');
                document.getElementById('applyPromoBtn').classList.add('btn-success');
                
                const newBalance = (referrer.walletBalance || 0) + 25;
                database.ref('users/' + referrerId).update({
                    walletBalance: newBalance
                })
                .then(() => {
                    console.log(`Rewarded ${referrer.name} with K25 for referral`);
                });
                
                database.ref('referrals').push().set({
                    referrerId: referrerId,
                    referredUserId: currentUser.uid,
                    referralCode: referralCode,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    rewardAmount: 25
                });
            } else {
                showNotification('Invalid referral code. Please check and try again.', 'error');
                document.getElementById('promoCode').style.borderColor = 'var(--error-red)';
            }
        })
        .catch(error => {
            console.error('Error applying referral code:', error);
            errorHandler.captureError(error, { 
                operation: 'apply_referral_code', 
                referralCode 
            }, 'error');
            showNotification('Error applying referral code. Please try again.', 'error');
        });
}

// Reset UI After Ride
function resetUIAfterRide() {
    document.getElementById('rideRequestForm').style.display = 'flex';
    document.getElementById('rideInfoPanel').style.display = 'none';
    document.getElementById('driverDetailsCard').style.display = 'none';
    document.getElementById('destinationLocation').value = '';
    
    document.getElementById('packageForm').classList.remove('active');
    document.getElementById('receiverName').value = '';
    document.getElementById('receiverPhone').value = '';
    document.getElementById('packageDescription').value = '';
    document.getElementById('specialInstructions').value = '';
    document.getElementById('packageValue').value = '';
    
    document.getElementById('promoCode').value = '';
    appliedPromoCode = null;
    document.getElementById('promoCode').style.borderColor = '';
    document.getElementById('applyPromoBtn').innerHTML = 'Apply';
    document.getElementById('applyPromoBtn').classList.remove('btn-success');
    document.getElementById('applyPromoBtn').classList.add('btn-promo');
    document.getElementById('promoSection').classList.remove('active');
    
    const chatButton = document.getElementById('chatWithDriverBtn');
    if (chatButton) {
        chatButton.remove();
    }
    
    if (document.getElementById('chatPopup') && !document.getElementById('chatPopup').classList.contains('hidden')) {
        closeChatPopup();
    }
    
    if (driverMessageListener) {
        driverMessageListener();
        driverMessageListener = null;
    }
    
    driverProfileImage = null;
    driverVehicleImage = null;
    
    if (driverMarker) {
        passengerMap.removeLayer(driverMarker);
        driverMarker = null;
    }
    
    if (destinationMarker) {
        passengerMap.removeLayer(destinationMarker);
        destinationMarker = null;
    }
    
    if (routePolyline) {
        passengerMap.removeLayer(routePolyline);
        routePolyline = null;
    }
    
    if (driverLocationListener) {
        driverLocationListener();
        driverLocationListener = null;
    }
    
    currentRide = null;
}

// Load Passenger Data
function loadPassengerData() {
    if (currentUser) {
        updateUserStats();
    }
}

// Load Account Data
function loadAccountData() {
    if (currentUser && userData) {
        document.getElementById('accountName').textContent = userData.name || 'Passenger';
        document.getElementById('accountPhone').textContent = userData.phone || 'Not set';
        document.getElementById('accountEmail').textContent = userData.email || 'Not set';
        document.getElementById('referralCode').textContent = userData.referralCode || 'JUBEL-XXXX';
        
        walletBalance = userData.walletBalance || 0;
        document.getElementById('accountBalance').textContent = `K${walletBalance.toFixed(2)}`;
        
        const accountAvatar = document.getElementById('accountAvatar');
        if (userData.name) {
            accountAvatar.textContent = userData.name.charAt(0).toUpperCase();
        } else {
            accountAvatar.innerHTML = '<i class="fas fa-user"></i>';
        }
        
        updateUserStats();
    }
}

// Update User Stats
function updateUserStats() {
    if (!currentUser) return;
    
    database.ref('rides').orderByChild('passengerId').equalTo(currentUser.uid).once('value')
        .then(snapshot => {
            const rides = snapshot.val();
            if (rides) {
                const ridesArray = Object.values(rides);
                
                userStats = {
                    completed: ridesArray.filter(ride => ride.status === 'completed' || ride.status === 'paid').length,
                    cancelled: ridesArray.filter(ride => ride.status === 'cancelled').length,
                    pending: ridesArray.filter(ride => ride.status === 'requested' || ride.status === 'accepted').length
                };
                
                document.getElementById('ridesCompleted').textContent = userStats.completed;
                document.getElementById('ridesCancelled').textContent = userStats.cancelled;
                document.getElementById('ridesPending').textContent = userStats.pending;
            }
        })
        .catch(error => {
            errorHandler.captureError(error, { 
                operation: 'update_user_stats', 
                userId: currentUser.uid 
            }, 'warning');
        });
}

// Share Referral Code
function shareReferralCode() {
    const referralCode = document.getElementById('referralCode').textContent;
    const shareText = `Join me on Jubel! Use my referral code ${referralCode} for 50% off your first ride. Download the app now!`;
    
    if (navigator.share) {
        navigator.share({
            title: 'Jubel Referral',
            text: shareText,
            url: window.location.href
        })
        .then(() => showNotification('Referral code shared successfully!', 'success'))
        .catch(error => {
            console.error('Error sharing:', error);
            errorHandler.captureError(error, { 
                operation: 'share_referral_code' 
            }, 'warning');
        });
    } else {
        navigator.clipboard.writeText(shareText)
            .then(() => showNotification('Referral code copied to clipboard!', 'success'))
            .catch(error => {
                errorHandler.captureError(error, { 
                    operation: 'share_referral_code_copy' 
                }, 'warning');
            });
    }
}

// Deposit to Wallet
function depositToWallet() {
    const amount = prompt('Enter deposit amount (K):');
    if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
        const depositAmount = parseFloat(amount);
        const newBalance = walletBalance + depositAmount;
        
        database.ref('users/' + currentUser.uid).update({
            walletBalance: newBalance
        })
        .then(() => {
            walletBalance = newBalance;
            updateWalletBalanceUI();
            showNotification(`Successfully deposited K${depositAmount.toFixed(2)} to your wallet.`, 'success');
        })
        .catch(error => {            console.error('Error depositing to wallet:', error);
            errorHandler.captureError(error, {
                operation: 'deposit_to_wallet',
                amount: depositAmount
            }, 'error');
            showNotification('Error processing deposit. Please try again.', 'error');
        });
    } else if (amount) {
        showNotification('Please enter a valid amount.', 'warning');
    }
}

// Withdraw from Wallet
function withdrawFromWallet() {
    if (walletBalance <= 0) {
        showNotification('Your wallet balance is zero.', 'info');
        return;
    }
    
    const amount = prompt(`Enter withdrawal amount (K). Available: K${walletBalance.toFixed(2)}:`);
    if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
        const withdrawalAmount = parseFloat(amount);
        
        if (withdrawalAmount > walletBalance) {
            showNotification('Insufficient balance for this withdrawal.', 'error');
            return;
        }
        
        const newBalance = walletBalance - withdrawalAmount;
        
        database.ref('users/' + currentUser.uid).update({
            walletBalance: newBalance
        })
        .then(() => {
            walletBalance = newBalance;
            updateWalletBalanceUI();
            showNotification(`Successfully withdrew K${withdrawalAmount.toFixed(2)} from your wallet.`, 'success');
        })
        .catch(error => {
            console.error('Error withdrawing from wallet:', error);
            errorHandler.captureError(error, {
                operation: 'withdraw_from_wallet',
                amount: withdrawalAmount
            }, 'error');
            showNotification('Error processing withdrawal. Please try again.', 'error');
        });
    } else if (amount) {
        showNotification('Please enter a valid amount.', 'warning');
    }
}

// Update Wallet Balance UI
function updateWalletBalanceUI() {
    const walletBalanceElement = document.getElementById('walletBalance');
    const accountBalanceElement = document.getElementById('accountBalance');
    
    if (walletBalanceElement) {
        walletBalanceElement.textContent = `K${walletBalance.toFixed(2)}`;
    }
    
    if (accountBalanceElement) {
        accountBalanceElement.textContent = `K${walletBalance.toFixed(2)}`;
    }
}

// Contact WhatsApp
function contactWhatsApp() {
    const phoneNumber = '0768658484';
    const message = 'Hello, I need assistance with Jubel rides.';
    const url = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
    window.open(url, '_blank');
}

// Contact Phone
function contactPhone() {
    const phoneNumber = '0768658484';
    window.open(`tel:${phoneNumber}`, '_self');
}

// Add Payment Method
function addPaymentMethod() {
    showNotification('Payment method feature coming soon!', 'info');
}

// Load Ride History
function loadRideHistory() {
    if (currentUser) {
        const filter = document.getElementById('historyFilter').value;
        const dateFilter = document.getElementById('historyDate').value;
        
        if (rideHistoryListener) {
            rideHistoryListener();
        }
        
        rideHistoryListener = database.ref('rides').orderByChild('passengerId').equalTo(currentUser.uid).on('value', snapshot => {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';
            
            const rides = snapshot.val();
            if (rides) {
                let ridesArray = Object.keys(rides).map(rideId => ({
                    id: rideId,
                    ...rides[rideId]
                }));
                
                if (filter !== 'all') {
                    ridesArray = ridesArray.filter(ride => ride.status === filter);
                }
                
                if (dateFilter) {
                    const filterDate = new Date(dateFilter);
                    ridesArray = ridesArray.filter(ride => {
                        const rideDate = new Date(ride.timestamp);
                        return rideDate.toDateString() === filterDate.toDateString();
                    });
                }
                
                ridesArray.sort((a, b) => b.timestamp - a.timestamp);
                
                if (ridesArray.length === 0) {
                    historyList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--medium-gray);">No rides found matching your criteria.</p>';
                    return;
                }
                
                ridesArray.forEach(ride => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item';
                    historyItem.setAttribute('data-ride-id', ride.id);
                    historyItem.setAttribute('role', 'button');
                    historyItem.setAttribute('tabindex', '0');
                    
                    const date = new Date(ride.timestamp);
                    const formattedDate = date.toLocaleDateString();
                    const formattedTime = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    const isDelivery = ride.rideType === 'bike' || ride.rideType === 'bicycle';
                    const typeClass = isDelivery ? 'delivery' : 'ride';
                    const typeText = isDelivery ? 'Delivery' : 'Ride';
                    
                    let statusClass = 'status-requested';
                    let statusText = getStatusText(ride.status);
                    
                    if (ride.status === 'accepted') {
                        statusClass = 'status-accepted';
                    } else if (ride.status === 'completed' || ride.status === 'paid') {
                        statusClass = 'status-completed';
                    } else if (ride.status === 'cancelled') {
                        statusClass = 'status-cancelled';
                    } else if (ride.status === 'requested') {
                        statusClass = 'status-pending';
                        statusText = 'Pending';
                    }
                    
                    let historyContent = '';
                    const hasChat = ride.hasChat || false;
                    
                    if (isDelivery) {
                        historyContent = `
                            <div class="history-item-type ${typeClass}">${typeText}</div>
                            <div class="history-locations">
                                <div>
                                    <strong>Pickup:</strong> ${ride.pickupDisplayLocation || ride.pickupLocation}
                                </div>
                                <div>
                                    <strong>Delivery:</strong> ${ride.destination}
                                </div>
                            </div>
                            ${ride.packageDetails ? `
                            <div class="history-package-details">
                                <div class="package-detail-row">
                                    <span class="package-detail-label">Receiver:</span>
                                    <span class="package-detail-value">${ride.packageDetails.receiverName || 'N/A'}</span>
                                </div>
                                <div class="package-detail-row">
                                    <span class="package-detail-label">Package:</span>
                                    <span class="package-detail-value">${ride.packageDetails.packageDescription || 'N/A'}</span>
                                </div>
                                <div class="package-detail-row">
                                    <span class="package-detail-label">Value:</span>
                                    <span class="package-detail-value">K${ride.packageDetails.packageValue || '0.00'}</span>
                                </div>
                            </div>
                            ` : ''}
                            <div class="history-info">
                                <div class="history-fare">K${ride.fare ? ride.fare.toFixed(2) : '0.00'}</div>
                                <div>${formattedDate} ${formattedTime}</div>
                                <div class="status-badge ${statusClass}">
                                    ${statusText}
                                </div>
                                ${hasChat ? '<div class="chat-indicator" style="font-size: 0.6rem; color: var(--info-blue); margin-top: 4px;"><i class="fas fa-comments"></i> Chat available</div>' : ''}
                            </div>
                        `;
                    } else {
                        historyContent = `
                            <div class="history-item-type ${typeClass}">${typeText}</div>
                            <div class="history-locations">
                                <div>
                                    <strong>From:</strong> ${ride.pickupDisplayLocation || ride.pickupLocation}
                                </div>
                                <div>
                                    <strong>To:</strong> ${ride.destination}
                                </div>
                            </div>
                            <div class="history-info">
                                <div class="history-fare">K${ride.fare ? ride.fare.toFixed(2) : '0.00'}</div>
                                <div>${formattedDate} ${formattedTime}</div>
                                <div class="status-badge ${statusClass}">
                                    ${statusText}
                                </div>
                                ${hasChat ? '<div class="chat-indicator" style="font-size: 0.6rem; color: var(--info-blue); margin-top: 4px;"><i class="fas fa-comments"></i> Chat available</div>' : ''}
                            </div>
                        `;
                    }
                    
                    if (ride.driverId) {
                        database.ref('users/' + ride.driverId).once('value')
                            .then(driverSnapshot => {
                                const driver = driverSnapshot.val();
                                if (driver) {
                                    const driverInfo = document.createElement('div');
                                    driverInfo.className = 'history-driver-info';
                                    driverInfo.innerHTML = `
                                        <div class="history-driver-avatar">
                                            ${driver.name ? driver.name.charAt(0).toUpperCase() : 'D'}
                                        </div>
                                        <div class="history-driver-details">
                                            <div class="history-driver-name">${driver.name || 'Driver'}</div>
                                            <div class="history-driver-rating">${driver.rating || '4.5'} </div>
                                        </div>
                                    `;
                                    historyItem.appendChild(driverInfo);
                                }
                            })
                            .catch(error => {
                                errorHandler.captureError(error, {
                                    operation: 'load_history_driver_info',
                                    rideId: ride.id
                                }, 'warning');
                            });
                    }
                    
                    historyItem.innerHTML = historyContent;
                    
                    // Add click event listener
                    historyItem.addEventListener('click', () => {
                        showRideDetailsPopup(ride.id);
                    });
                    
                    // Add keyboard support
                    historyItem.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            showRideDetailsPopup(ride.id);
                        }
                    });
                    
                    historyList.appendChild(historyItem);
                });
            } else {
                historyList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--medium-gray);">No ride history found.</p>';
            }
        }, error => {
            console.error('Error loading ride history:', error);
            errorHandler.captureError(error, {
                operation: 'load_ride_history'
            }, 'error');
            historyList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--error-red);">Error loading ride history.</p>';
        });
    }
}

// Get Status Text
function getStatusText(status) {
    const statusMap = {
        'requested': 'Awaiting Driver',
        'accepted': 'In Progress',
        'completed': 'Completed',
        'paid': 'Completed',
        'cancelled': 'Cancelled',
        'arrived': 'Driver Arrived',
        'picked_up': 'Picked Up',
        'started': 'Trip Started'
    };
    
    return statusMap[status] || status;
}

// Show Ride Details Popup
function showRideDetailsPopup(rideId) {
    database.ref('rides/' + rideId).once('value')
        .then(snapshot => {
            const ride = snapshot.val();
            if (ride) {
                document.getElementById('popupRidePickup').textContent = ride.pickupDisplayLocation || ride.pickupLocation;
                document.getElementById('popupRideDestination').textContent = ride.destination;
                document.getElementById('popupRideFare').textContent = `K${ride.fare ? ride.fare.toFixed(2) : '0.00'}`;
                document.getElementById('popupRideDistance').textContent = ride.distance || 'Calculating...';
                document.getElementById('popupRideStatus').textContent = getStatusText(ride.status);
                document.getElementById('popupRideType').textContent = ride.rideType ? ride.rideType.charAt(0).toUpperCase() + ride.rideType.slice(1) : 'Standard';
                
                const date = new Date(ride.timestamp);
                document.getElementById('popupRideDate').textContent = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                updatePopupRideMap(ride);
                
                const popupActions = document.querySelector('.popup-actions');
                let viewChatBtn = document.getElementById('viewChatBtn');
                
                if (!viewChatBtn) {
                    viewChatBtn = document.createElement('button');
                    viewChatBtn.id = 'viewChatBtn';
                    viewChatBtn.className = 'btn btn-primary';
                    viewChatBtn.innerHTML = '<i class="fas fa-comments"></i> View Chat';
                    viewChatBtn.style.marginRight = '8px';
                    popupActions.insertBefore(viewChatBtn, popupActions.firstChild);
                }
                
                viewChatBtn.onclick = function() {
                    viewRideChat(rideId, ride);
                };
                
                if (ride.driverId) {
                    database.ref('users/' + ride.driverId).once('value')
                        .then(driverSnapshot => {
                            const driver = driverSnapshot.val();
                            if (driver) {
                                document.getElementById('popupDriverName').textContent = driver.name || 'Driver';
                                document.getElementById('popupDriverPhone').textContent = driver.phone || 'N/A';
                                document.getElementById('popupDriverVehicle').textContent = `${driver.vehicleType || 'Car'} (${driver.licensePlate || 'N/A'})`;
                                document.getElementById('popupDriverRating').textContent = driver.rating || '4.5';
                                
                                updateDriverProgress(ride.status);
                                document.getElementById('popupDriverDetails').classList.remove('hidden');
                            }
                        })
                        .catch(error => {
                            errorHandler.captureError(error, {
                                operation: 'show_ride_details_driver_info',
                                rideId
                            }, 'warning');
                        });
                } else {
                    document.getElementById('popupDriverDetails').classList.add('hidden');
                }
                
                document.getElementById('rideDetailsPopup').classList.remove('hidden');
                document.getElementById('rideDetailsPopup').setAttribute('aria-hidden', 'false');
            }
        })
        .catch(error => {
            console.error('Error loading ride details:', error);
            errorHandler.captureError(error, {
                operation: 'show_ride_details_popup',
                rideId
            }, 'error');
            showNotification('Error loading ride details.', 'error');
        });
}

// View Ride Chat
function viewRideChat(rideId, ride) {
    if (ride.driverId) {
        database.ref('users/' + ride.driverId).once('value')
            .then(driverSnapshot => {
                const driver = driverSnapshot.val();
                if (driver) {
                    openChatWithDriver(rideId, driver);
                    closeRideDetailsPopup();
                }
            })
            .catch(error => {
                errorHandler.captureError(error, {
                    operation: 'view_ride_chat',
                    rideId
                }, 'warning');
            });
    } else {
        showNotification('No driver information available for this ride.', 'warning');
    }
}

// Update Driver Progress
function updateDriverProgress(status) {
    const progressElement = document.getElementById('popupDriverProgress');
    
    switch(status) {
        case 'requested':
            progressElement.textContent = 'Waiting for driver to accept';
            break;
        case 'accepted':
            progressElement.textContent = 'Driver on the way to pickup';
            break;
        case 'arrived':
            progressElement.textContent = 'Driver arrived at pickup location';
            break;
        case 'picked_up':
            progressElement.textContent = 'Passenger picked up';
            break;
        case 'started':
            progressElement.textContent = 'Trip in progress';
            break;
        case 'completed':
            progressElement.textContent = 'Trip completed';
            break;
        case 'paid':
            progressElement.textContent = 'Payment completed';
            break;
        default:
            progressElement.textContent = 'Status: ' + status;
    }
}

// Close Ride Details Popup
function closeRideDetailsPopup() {
    document.getElementById('rideDetailsPopup').classList.add('hidden');
    document.getElementById('rideDetailsPopup').setAttribute('aria-hidden', 'true');
}

// Update Popup Ride Map
function updatePopupRideMap(ride) {
    if (popupRideMap) {
        popupRideMap.eachLayer(function(layer) {
            if (layer instanceof L.TileLayer) return;
            popupRideMap.removeLayer(layer);
        });
        
        // Set view to show both pickup and destination
        const pickupLatLng = [ride.pickupLat, ride.pickupLng];
        const destLatLng = [ride.destLat, ride.destLng];
        
        // Add pickup marker
        L.marker(pickupLatLng, {
            icon: L.divIcon({
                className: 'pickup-marker',
                html: '<div class="pickup-marker"><i class="fas fa-map-marker-alt"></i></div>',
                iconSize: [22, 22]
            })
        }).addTo(popupRideMap)
            .bindPopup('Pickup Location');
        
        // Add destination marker
        L.marker(destLatLng, {
            icon: L.divIcon({
                className: 'destination-marker',
                html: '<div class="destination-marker"><i class="fas fa-flag"></i></div>',
                iconSize: [22, 22]
            })
        }).addTo(popupRideMap)
            .bindPopup('Destination');
        
        // Fit bounds to show both markers
        const bounds = L.latLngBounds([pickupLatLng, destLatLng]);
        popupRideMap.fitBounds(bounds, { padding: [50, 50] });
    }
}

// Set Rating
function setRating(rating) {
    userRating = rating;
    document.querySelectorAll('.star').forEach(star => {
        const starRating = parseInt(star.getAttribute('data-rating'));
        if (starRating <= rating) {
            star.classList.add('active');
        } else {
            star.classList.remove('active');
        }
    });
}

// Show Ride Completion
function showRideCompletion(ride) {
    document.getElementById('finalFare').textContent = `K${ride.fare.toFixed(2)}`;
    // Note: switchScreen function needs to be defined
    // switchScreen('rideCompletionScreen');
    showNotification('Ride completed. Please complete payment and rating.', 'success');
    
    if (driverMarker) {
        passengerMap.removeLayer(driverMarker);
        driverMarker = null;
    }
    
    if (driverAssignmentListener) {
        driverAssignmentListener();
        driverAssignmentListener = null;
    }
    
    if (driverLocationListener) {
        driverLocationListener();
        driverLocationListener = null;
    }
}

// Center Map
function centerMap() {
    if (currentLocationMarker) {
        const passengerLatLng = currentLocationMarker.getLatLng();
        passengerMap.setView(passengerLatLng, 16);
        showNotification('Map centered on your location', 'info');
    }
}

// Toggle Panel Collapse
function togglePanelCollapse() {
    const panel = document.getElementById('passengerPanel');
    panel.classList.toggle('collapsed');
    
    // Update ARIA attributes
    const panelHandle = document.getElementById('panelCollapseHandle');
    if (panel.classList.contains('collapsed')) {
        panelHandle.setAttribute('aria-expanded', 'false');
        panelHandle.setAttribute('aria-label', 'Expand panel');
    } else {
        panelHandle.setAttribute('aria-expanded', 'true');
        panelHandle.setAttribute('aria-label', 'Collapse panel');
    }
}

// Use Saved Location
function useSavedLocation(addressType) {
    if (userData) {
        const address = userData[addressType + 'Address'];
        
        if (address) {
            document.getElementById('destinationLocation').value = address;
            updateFareEstimate();
            showNotification(`${addressType.charAt(0).toUpperCase() + addressType.slice(1)} address set as destination.`, 'success');
            
            forwardGeocode(address).then(results => {
                if (results.length > 0) {
                    updateDestinationMarker(
                        parseFloat(results[0].lat),
                        parseFloat(results[0].lon),
                        address
                    );
                    
                    drawRoute(userLocation.lat, userLocation.lng, parseFloat(results[0].lat), parseFloat(results[0].lon));
                    document.getElementById('requestRideBtn').disabled = false;
                }
            }).catch(error => {
                errorHandler.captureError(error, {
                    operation: 'use_saved_location',
                    addressType
                }, 'warning');
            });
        } else {
            showNotification(`No ${addressType} address saved. Please add it in settings.`, 'warning');
        }
    }
}

// Get Place Type
function getPlaceType(place) {
    const typeMap = {
        'restaurant': 'restaurant',
        'cafe': 'cafe',
        'bar': 'bar',
        'pub': 'pub',
        'fast_food': 'fast_food',
        'bank': 'bank',
        'atm': 'atm',
        'hospital': 'hospital',
        'pharmacy': 'pharmacy',
        'school': 'school',
        'university': 'university',
        'library': 'library',
        'cinema': 'cinema',
        'theatre': 'theatre',
        'museum': 'museum',
        'hotel': 'hotel',
        'supermarket': 'supermarket',
        'mall': 'mall',
        'clothes': 'clothes',
        'fuel': 'fuel',
        'parking': 'parking',
        'bus_station': 'bus_station',
        'taxi': 'taxi',
        'police': 'police',
        'market': 'market',
        'post_office': 'post_office',
        'place_of_worship': 'place_of_worship',
        'stadium': 'stadium',
        'park': 'park',
        'monument': 'monument',
        'castle': 'castle'
    };
    
    return typeMap[place.type] || typeMap[place.class] || 'place';
}

// Get Place Icon
function getPlaceIcon(placeType) {
    const icons = {
        'restaurant': '',
        'cafe': '',
        'bar': '',
        'pub': '',
        'fast_food': '',
        'bank': '',
        'atm': '',
        'hospital': '',
        'pharmacy': '',
        'school': '',
        'university': '',
        'library': '',
        'cinema': '',
        'theatre': '',
        'museum': '',
        'hotel': '',
        'supermarket': '',
        'mall': '',
        'clothes': '',
        'fuel': '',
        'parking': '',
        'bus_station': '',
        'taxi': '',
        'police': '',
        'market': '',
        'post_office': '',
        'place_of_worship': '',
        'stadium': '',
        'park': '',
        'monument': '',
        'castle': ''
    };
    
    return icons[placeType] || '';
}

// Start Location Tracking
function startLocationTracking() {
    if (navigator.geolocation && currentUser) {
        locationWatchId = navigator.geolocation.watchPosition(position => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            userLocation = { lat, lng };
            
            database.ref('passengerLocations/' + currentUser.uid).set({
                latitude: lat,
                longitude: lng,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                accuracy: position.coords.accuracy
            });
            
            if (currentLocationMarker) {
                currentLocationMarker.setLatLng([lat, lng]);
            }
            
            if (destinationMarker) {
                const destination = document.getElementById('destinationLocation').value;
                if (destination) {
                    updateFareEstimate();
                }
            }
        }, error => {
            console.error('Location tracking error:', error);
            errorHandler.captureError(error, {
                operation: 'start_location_tracking'
            }, 'warning');
        }, {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 30000
        });
    }
}

// Show Notification
function showNotification(message, type = 'info') {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.className = `notification ${type}`;
    notification.style.display = 'block';
    
    // Update ARIA attributes for accessibility
    notification.setAttribute('role', 'alert');
    notification.setAttribute('aria-live', type === 'error' ? 'assertive' : 'polite');
    notification.setAttribute('aria-label', `${type} notification: ${message}`);
    
    setTimeout(() => {
        notification.style.display = 'none';
        notification.removeAttribute('role');
        notification.removeAttribute('aria-live');
        notification.removeAttribute('aria-label');
    }, 4000);
}

// Switch Screen
function switchScreen(screenId) {
    const previousScreen = currentScreen;
    currentScreen = screenId;
    
    document.querySelectorAll('.screen-content').forEach(screen => {
        screen.classList.remove('active');
        screen.setAttribute('aria-hidden', 'true');
    });
    
    const activeScreen = document.getElementById(screenId + 'Screen');
    if (activeScreen) {
        activeScreen.classList.add('active');
        activeScreen.setAttribute('aria-hidden', 'false');
    }
    
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
        btn.setAttribute('aria-selected', 'false');
    });
    
    const activeButton = document.querySelector(`.nav-btn[data-screen="${screenId}"]`);
    if (activeButton) {
        activeButton.classList.add('active');
        activeButton.setAttribute('aria-selected', 'true');
    }
    
    if (screenId === 'home') {
        document.querySelectorAll('.home-only').forEach(el => {
            el.style.display = 'flex';
        });
        
        if (previousScreen !== 'home' && homeScreenRefreshRequired) {
            refreshHomeScreen();
        }
    } else {
        document.querySelectorAll('.home-only').forEach(el => {
            el.style.display = 'none';
        });
        
        homeScreenRefreshRequired = true;
    }
    
    if (screenId === 'history') {
        loadRideHistory();
    } else if (screenId === 'account') {
        loadAccountData();
    }
}

// Refresh Home Screen
function refreshHomeScreen() {
    console.log("Refreshing home screen...");
    
    refreshPassengerPosition();
    document.getElementById('destinationLocation').value = '';
    
    if (destinationMarker) {
        passengerMap.removeLayer(destinationMarker);
        destinationMarker = null;
    }
    
    if (routePolyline) {
        passengerMap.removeLayer(routePolyline);
        routePolyline = null;
    }
    
    resetFareDisplay();
    document.getElementById('requestRideBtn').disabled = true;
    document.getElementById('promoSection').classList.remove('active');
    document.getElementById('promoCode').value = '';
    appliedPromoCode = null;
    document.getElementById('packageForm').classList.remove('active');
    document.getElementById('packageToggle').style.display = 'none';
    document.getElementById('rideRequestForm').style.display = 'flex';
    document.getElementById('rideInfoPanel').style.display = 'none';
    
    homeScreenRefreshRequired = false;
    showNotification('Home screen refreshed', 'success');
}

// Setup Wallet Balance Listener
function setupWalletBalanceListener(uid) {
    if (walletBalanceListener) {
        walletBalanceListener();
    }
    
    walletBalanceListener = database.ref('users/' + uid + '/walletBalance').on('value', snapshot => {
        const newBalance = snapshot.val() || 0;
        if (walletBalance !== newBalance) {
            walletBalance = newBalance;
            updateWalletBalanceUI();
        }
    }, error => {
        errorHandler.captureError(error, {
            operation: 'setup_wallet_balance_listener',
            uid
        }, 'warning');
    });
}

// Load SOS Config
function loadSOSConfig(uid) {
    database.ref('sosConfig/' + uid).once('value')
        .then(snapshot => {
            sosConfig = snapshot.val();
            if (sosConfig) {
                console.log('SOS configuration loaded:', sosConfig);
            }
        })
        .catch(error => {
            errorHandler.captureError(error, {
                operation: 'load_sos_config',
                uid
            }, 'warning');
        });
}

// Check Active Ride
function checkActiveRide(uid) {
    database.ref('rides').orderByChild('passengerId').equalTo(uid).once('value')
        .then(snapshot => {
            const rides = snapshot.val();
            if (rides) {
                const activeRide = Object.values(rides).find(ride => 
                    ride.status === 'requested' || 
                    ride.status === 'accepted' || 
                    ride.status === 'arrived' || 
                    ride.status === 'picked_up' || 
                    ride.status === 'started'
                );
                
                if (activeRide) {
                    console.log('Active ride found:', activeRide);
                    currentRide = activeRide;
                    updateUIForActiveRide();
                    
                    if (activeRide.status === 'accepted' && activeRide.driverId) {
                        listenForDriverAssignment(activeRide.id);
                    }
                    
                    showNotification('Active ride restored', 'info');
                    activeRideRestored = true;
                }
            }
        })
        .catch(error => {
            errorHandler.captureError(error, {
                operation: 'check_active_ride',
                uid
            }, 'warning');
        });
}

// Extract City from Display Name
function extractCityFromDisplayName(displayName) {
    if (!displayName) return "Unknown Location";
    
    const displayLower = displayName.toLowerCase();
    
    // Check for Zambian cities in the display name
    for (const city of zambianCities) {
        if (displayLower.includes(city.toLowerCase())) {
            return city;
        }
    }
    
    // Check for city aliases
    for (const [alias, city] of Object.entries(cityAliases)) {
        if (displayLower.includes(alias)) {
            return city;
        }
    }
    
    return "Unknown Location";
}

// Show Rating Popup
function showRatingPopup(ride) {
    // This function would show a rating popup after ride completion
    // Implementation would depend on your UI design
    console.log('Show rating popup for ride:', ride.id);
}

// Setup Event Listeners
function setupEventListeners() {
    try {
        // Navigation buttons
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const screen = this.getAttribute('data-screen');
                switchScreen(screen);
            });
        });
        
        // Back buttons
        document.querySelectorAll('.back-button').forEach(btn => {
            btn.addEventListener('click', function() {
                const screen = this.getAttribute('data-screen') || 'home';
                switchScreen(screen);
            });
        });
        
        // Vehicle selection
        document.querySelectorAll('.vehicle-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.vehicle-option').forEach(opt => {
                    opt.classList.remove('selected');
                    opt.setAttribute('aria-checked', 'false');
                });
                
                this.classList.add('selected');
                this.setAttribute('aria-checked', 'true');
                selectedVehicleType = this.getAttribute('data-type');
                
                if (selectedVehicleType === 'bike' || selectedVehicleType === 'bicycle') {
                    document.getElementById('packageToggle').style.display = 'flex';
                } else {
                    document.getElementById('packageToggle').style.display = 'none';
                    document.getElementById('packageForm').classList.remove('active');
                }
                
                updateFareEstimate();
            });
            
            // Add keyboard support
            option.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    option.click();
                }
            });
        });
        
        // Package toggle
        document.getElementById('packageToggle').addEventListener('click', function() {
            const packageForm = document.getElementById('packageForm');
            packageForm.classList.toggle('active');
            this.setAttribute('aria-expanded', packageForm.classList.contains('active').toString());
        });
        
        // Payment methods
        document.querySelectorAll('.payment-method').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.payment-method').forEach(opt => {
                    opt.classList.remove('selected');
                    opt.setAttribute('aria-checked', 'false');
                });
                this.classList.add('selected');
                this.setAttribute('aria-checked', 'true');
                paymentMethod = this.getAttribute('data-method');
            });
        });
        
        // Payment options in popup
        document.querySelectorAll('.payment-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.payment-option').forEach(opt => {
                    opt.classList.remove('selected');
                    opt.setAttribute('aria-checked', 'false');
                });
                this.classList.add('selected');
                this.setAttribute('aria-checked', 'true');
                selectedPaymentType = this.getAttribute('data-payment-type');
                
                if (selectedPaymentType === 'wallet') {
                    if (walletBalance < rideFare) {
                        document.getElementById('insufficientBalance').style.display = 'flex';
                        document.getElementById('confirmPaymentBtn').disabled = true;
                    } else {
                        document.getElementById('insufficientBalance').style.display = 'none';
                        document.getElementById('confirmPaymentBtn').disabled = false;
                    }
                } else {
                    document.getElementById('insufficientBalance').style.display = 'none';
                    document.getElementById('confirmPaymentBtn').disabled = false;
                }
            });
        });
        
        // Main ride request button
        document.getElementById('requestRideBtn').addEventListener('click', requestRide);
        
        // Payment confirmation
        document.getElementById('confirmPaymentBtn').addEventListener('click', submitRideRequest);
        
        // Close payment popup
        document.getElementById('closePaymentPopup').addEventListener('click', closePaymentSelection);
        
        // Cancel ride
        document.getElementById('cancelRideBtn').addEventListener('click', cancelRide);
        
        // Contact driver
        document.getElementById('contactDriverBtn').addEventListener('click', contactDriver);
        
        // Promo toggle
        document.getElementById('promoToggle').addEventListener('click', function() {
            const promoSection = document.getElementById('promoSection');
            promoSection.classList.toggle('active');
            this.setAttribute('aria-expanded', promoSection.classList.contains('active').toString());
        });
        
        // Apply promo
        document.getElementById('applyPromoBtn').addEventListener('click', applyPromoCode);
        
        // Share referral
        document.getElementById('shareReferralBtn').addEventListener('click', shareReferralCode);
        
        // Deposit
        document.getElementById('depositBtn').addEventListener('click', depositToWallet);
        
        // Withdraw
        document.getElementById('withdrawBtn').addEventListener('click', withdrawFromWallet);
        
        // WhatsApp contact
        document.getElementById('whatsappBtn').addEventListener('click', contactWhatsApp);
        
        // Phone contact
        document.getElementById('callBtn').addEventListener('click', contactPhone);
        
        // Add payment method
        document.getElementById('addPaymentMethodBtn').addEventListener('click', addPaymentMethod);
        
        // Panel collapse
        document.getElementById('panelCollapseHandle').addEventListener('click', togglePanelCollapse);
        
        // Setup search input listeners
        setupSearchInputListeners();
        
        // Close suggestions when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.location-input') && 
                !e.target.closest('.suggestion-list')) {
                hideAllSearchSuggestions();
            }
        });
        
        // Saved locations
        document.querySelectorAll('.saved-location-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const addressType = this.getAttribute('data-address');
                useSavedLocation(addressType);
            });
        });
        
        // History filter
        document.getElementById('historyFilter').addEventListener('change', loadRideHistory);
        document.getElementById('historyDate').addEventListener('change', loadRideHistory);
        
        // Close ride details popup
document.getElementById('closeRidePopup').addEventListener('click', closeRideDetailsPopup);
document.getElementById('closeRidePopupTop').addEventListener('click', closeRideDetailsPopup);

// Star rating for ride completion
document.querySelectorAll('.star').forEach(star => {
    star.addEventListener('click', function() {
        const rating = parseInt(this.getAttribute('data-rating'));
        setRating(rating);
    });
});

// More options functionality
document.getElementById('moreOptionsBtn').addEventListener('click', toggleMoreOptions);

document.querySelectorAll('.more-option-item').forEach(item => {
    item.addEventListener('click', function() {
        const option = this.getAttribute('data-option');
        handleMoreOptionSelection(option);
    });
});

// Order for someone functionality
document.getElementById('orderForSomeoneBtn').addEventListener('click', submitOrderForSomeone);
document.getElementById('cancelOrderForSomeoneBtn').addEventListener('click', cancelMoreOptionForm);

// Express delivery functionality
document.querySelectorAll('.express-delivery-form .vehicle-option').forEach(option => {
    option.addEventListener('click', function() {
        document.querySelectorAll('.express-delivery-form .vehicle-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        this.classList.add('selected');
        calculateExpressDeliveryFee();
    });
});

document.getElementById('expressDeliveryBtn').addEventListener('click', submitExpressDelivery);
document.getElementById('cancelExpressDeliveryBtn').addEventListener('click', cancelMoreOptionForm);

// SOS functionality
document.getElementById('saveSosBtn').addEventListener('click', saveSOSConfig);
document.getElementById('cancelSosSetupBtn').addEventListener('click', cancelMoreOptionForm);
document.getElementById('sosButton').addEventListener('click', triggerSOS);

// Close chat popup when clicking outside
document.addEventListener('click', function(e) {
    const chatPopup = document.getElementById('chatPopup');
    if (chatPopup && !chatPopup.classList.contains('hidden')) {
        const isClickInside = e.target.closest('.popup-form');
        if (!isClickInside) {
            closeChatPopup();
        }
    }
});

// Function to setup wallet balance listener
function setupWalletBalanceListener(uid) {
    if (walletBalanceListener) {
        walletBalanceListener();
    }
    
    walletBalanceListener = database.ref('users/' + uid + '/walletBalance').on('value', snapshot => {
        const newBalance = snapshot.val() || 0;
        if (walletBalance !== newBalance) {
            walletBalance = newBalance;
            updateWalletBalanceUI();
        }
    });
}

// Function to load SOS config
function loadSOSConfig(uid) {
    database.ref('sosConfig/' + uid).once('value')
        .then(snapshot => {
            sosConfig = snapshot.val();
            if (sosConfig) {
                console.log('SOS configuration loaded');
            }
        })
        .catch(error => {
            console.error('Error loading SOS config:', error);
        });
}

// Function to check active ride on app load
function checkActiveRide(uid) {
    database.ref('rides').orderByChild('passengerId').equalTo(uid).once('value')
        .then(snapshot => {
            const rides = snapshot.val();
            if (rides) {
                const activeRide = Object.values(rides).find(ride => 
                    ride.status === 'requested' || 
                    ride.status === 'accepted' || 
                    ride.status === 'arrived' || 
                    ride.status === 'picked_up' || 
                    ride.status === 'started'
                );
                
                if (activeRide) {
                    console.log('Active ride found:', activeRide);
                    currentRide = activeRide;
                    updateUIForActiveRide();
                    
                    if (activeRide.status === 'accepted' && activeRide.driverId) {
                        listenForDriverAssignment(activeRide.id);
                    }
                    
                    showNotification('Active ride restored');
                    activeRideRestored = true;
                }
            }
        })
        .catch(error => {
            console.error('Error checking active ride:', error);
        });
}

// Function to extract city from display name
function extractCityFromDisplayName(displayName) {
    if (!displayName) return "Unknown Location";
    
    const displayLower = displayName.toLowerCase();
    
    // Check for Zambian cities in the display name
    for (const city of zambianCities) {
        if (displayLower.includes(city.toLowerCase())) {
            return city;
        }
    }
    
    // Check for city aliases
    for (const [alias, city] of Object.entries(cityAliases)) {
        if (displayLower.includes(alias)) {
            return city;
        }
    }
    
    return "Unknown Location";
}

// Function to show rating popup (placeholder for future implementation)
function showRatingPopup(ride) {
    // This would show a rating popup after ride completion
    console.log('Show rating popup for ride:', ride.id);
}

// Function to update wallet balance UI
function updateWalletBalanceUI() {
    const walletBalanceElement = document.getElementById('walletBalance');
    const accountBalanceElement = document.getElementById('accountBalance');
    
    if (walletBalanceElement) {
        walletBalanceElement.textContent = `K${walletBalance.toFixed(2)}`;
    }
    
    if (accountBalanceElement) {
        accountBalanceElement.textContent = `K${walletBalance.toFixed(2)}`;
    }
}

// More options functions implementation
function toggleMoreOptions() {
    const dropdown = document.getElementById('moreOptionsDropdown');
    const isActive = dropdown.classList.contains('active');
    
    // Close all other dropdowns first
    document.querySelectorAll('.more-options-dropdown').forEach(d => {
        d.classList.remove('active');
    });
    
    if (!isActive) {
        dropdown.classList.add('active');
        document.getElementById('moreOptionsBtn').setAttribute('aria-expanded', 'true');
    } else {
        document.getElementById('moreOptionsBtn').setAttribute('aria-expanded', 'false');
    }
}

function handleMoreOptionSelection(option) {
    // Hide all forms first
    document.getElementById('orderForSomeoneForm').classList.remove('active');
    document.getElementById('expressDeliveryForm').classList.remove('active');
    document.getElementById('sosSetupForm').classList.remove('active');
    document.getElementById('rideRequestForm').style.display = 'none';
    
    switch(option) {
        case 'order-for-someone':
            document.getElementById('orderForSomeoneForm').classList.add('active');
            activeMoreOption = 'order-for-someone';
            break;
        case 'express-delivery':
            document.getElementById('expressDeliveryForm').classList.add('active');
            activeMoreOption = 'express-delivery';
            break;
        case 'sos-setup':
            document.getElementById('sosSetupForm').classList.add('active');
            activeMoreOption = 'sos-setup';
            break;
    }
    
    document.getElementById('moreOptionsDropdown').classList.remove('active');
    document.getElementById('moreOptionsBtn').setAttribute('aria-expanded', 'false');
}

function cancelMoreOptionForm() {
    // Hide all special forms
    document.getElementById('orderForSomeoneForm').classList.remove('active');
    document.getElementById('expressDeliveryForm').classList.remove('active');
    document.getElementById('sosSetupForm').classList.remove('active');
    
    // Show main ride request form
    document.getElementById('rideRequestForm').style.display = 'flex';
    
    // Clear map markers for these forms
    if (recipientPickupMarker) {
        passengerMap.removeLayer(recipientPickupMarker);
        recipientPickupMarker = null;
    }
    if (recipientDestinationMarker) {
        passengerMap.removeLayer(recipientDestinationMarker);
        recipientDestinationMarker = null;
    }
    if (shopLocationMarker) {
        passengerMap.removeLayer(shopLocationMarker);
        shopLocationMarker = null;
    }
    if (deliveryDestinationMarker) {
        passengerMap.removeLayer(deliveryDestinationMarker);
        deliveryDestinationMarker = null;
    }
    
    // Clear form fields
    if (activeMoreOption === 'order-for-someone') {
        document.getElementById('recipientPickupLocation').value = '';
        document.getElementById('recipientDestinationLocation').value = '';
        document.getElementById('recipientName').value = '';
        document.getElementById('recipientEmail').value = '';
        document.getElementById('recipientPhone').value = '';
    } else if (activeMoreOption === 'express-delivery') {
        document.getElementById('shopName').value = '';
        document.getElementById('shopLocation').value = '';
        document.getElementById('deliveryItems').value = '';
        document.getElementById('deliveryAmount').value = '';
        document.getElementById('deliveryInstructions').value = '';
        document.getElementById('deliveryDestination').value = '';
    } else if (activeMoreOption === 'sos-setup') {
        document.getElementById('emergencyContact1').value = '';
        document.getElementById('emergencyContact2').value = '';
        document.getElementById('sosMessage').value = 'I need help! My current location and ride details will be shared with you.';
    }
    
    activeMoreOption = null;
}

// Function to calculate recipient delivery fee
function calculateRecipientDeliveryFee() {
    const pickupLocation = document.getElementById('recipientPickupLocation').value;
    const destinationLocation = document.getElementById('recipientDestinationLocation').value;
    
    if (pickupLocation && pickupLocation.length > 3 && destinationLocation && destinationLocation.length > 3) {
        Promise.all([
            forwardGeocode(pickupLocation),
            forwardGeocode(destinationLocation)
        ]).then(([pickupResults, destinationResults]) => {
            if (pickupResults.length > 0 && destinationResults.length > 0) {
                const pickupLat = parseFloat(pickupResults[0].lat);
                const pickupLng = parseFloat(pickupResults[0].lon);
                const destLat = parseFloat(destinationResults[0].lat);
                const destLng = parseFloat(destinationResults[0].lon);
                
                const distance = calculateDistance(pickupLat, pickupLng, destLat, destLng);
                let baseFare = calculateFareFromDistance(distance);
                
                document.getElementById('recipientDeliveryFee').textContent = `K${baseFare.toFixed(2)}`;
                
                const etaMinutes = Math.ceil((distance / 1000) / 30 * 60);
                document.getElementById('recipientEtaDisplay').textContent = `ETA: ${etaMinutes} min`;
                document.getElementById('orderForSomeoneBtn').disabled = false;
                
                updateRecipientPickupMarker(pickupLat, pickupLng, pickupResults[0].display_name);
                updateRecipientDestinationMarker(destLat, destLng, destinationResults[0].display_name);
                drawRoute(pickupLat, pickupLng, destLat, destLng);
            }
        }).catch(error => {
            console.error('Error calculating recipient delivery fee:', error);
        });
    } else {
        document.getElementById('recipientDeliveryFee').textContent = 'K0.00';
        document.getElementById('recipientEtaDisplay').textContent = 'ETA: -- min';
        document.getElementById('orderForSomeoneBtn').disabled = true;
    }
}

// Function to update recipient pickup marker
function updateRecipientPickupMarker(lat, lng, name) {
    if (recipientPickupMarker) {
        passengerMap.removeLayer(recipientPickupMarker);
    }
    
    recipientPickupMarker = L.marker([lat, lng], {
        icon: L.divIcon({
            className: 'pickup-marker',
            html: '<div class="pickup-marker"><i class="fas fa-user-friends"></i></div>',
            iconSize: [22, 22]
        })
    }).addTo(passengerMap)
        .bindPopup(`<strong>${name}</strong><br>Recipient Pickup Location`)
        .openPopup();
}

// Function to update recipient destination marker
function updateRecipientDestinationMarker(lat, lng, name) {
    if (recipientDestinationMarker) {
        passengerMap.removeLayer(recipientDestinationMarker);
    }
    
    recipientDestinationMarker = L.marker([lat, lng], {
        icon: L.divIcon({
            className: 'destination-marker',
            html: '<div class="destination-marker"><i class="fas fa-home"></i></div>',
            iconSize: [22, 22]
        })
    }).addTo(passengerMap)
        .bindPopup(`<strong>${name}</strong><br>Recipient Destination`)
        .openPopup();
}

// Function to submit order for someone
function submitOrderForSomeone() {
    const pickupLocation = document.getElementById('recipientPickupLocation').value;
    const destinationLocation = document.getElementById('recipientDestinationLocation').value;
    const recipientName = document.getElementById('recipientName').value;
    const recipientEmail = document.getElementById('recipientEmail').value;
    const recipientPhone = document.getElementById('recipientPhone').value;
    
    if (!pickupLocation || !destinationLocation || !recipientName || !recipientPhone) {
        showNotification('Please fill in all required fields.');
        return;
    }
    
    Promise.all([
        forwardGeocode(pickupLocation),
        forwardGeocode(destinationLocation)
    ]).then(([pickupResults, destinationResults]) => {
        if (pickupResults.length === 0 || destinationResults.length === 0) {
            showNotification('Invalid pickup or destination address. Please select valid locations.');
            return;
        }
        
        const pickupLat = parseFloat(pickupResults[0].lat);
        const pickupLng = parseFloat(pickupResults[0].lon);
        const destLat = parseFloat(destinationResults[0].lat);
        const destLng = parseFloat(destinationResults[0].lon);
        
        const distance = calculateDistance(pickupLat, pickupLng, destLat, destLng);
        let baseFare = calculateFareFromDistance(distance);
        
        const rideId = database.ref().child('rides').push().key;
        
        const rideRequest = {
            id: rideId,
            passengerId: currentUser.uid,
            passengerName: userData.name || 'Passenger',
            passengerPhone: userData.phone || 'Not provided',
            pickupLocation: pickupResults[0].display_name,
            destination: destinationResults[0].display_name,
            pickupLat: pickupLat,
            pickupLng: pickupLng,
            destLat: destLat,
            destLng: destLng,
            rideType: 'car',
            fare: baseFare,
            distance: (distance / 1000).toFixed(2) + ' km',
            status: 'requested',
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            updatedAt: firebase.database.ServerValue.TIMESTAMP,
            paymentMethod: selectedPaymentType,
            orderForSomeone: {
                recipientName: recipientName,
                recipientEmail: recipientEmail || '',
                recipientPhone: recipientPhone,
                orderedBy: userData.name || 'Passenger'
            },
            currentCity: currentCity
        };
        
        currentRideRequestData = rideRequest;
        currentRideRequestType = 'order-for-someone';
        showPaymentSelection(baseFare);
    }).catch(error => {
        console.error('Error in order for someone process:', error);
        showNotification('Error calculating route. Please try again.');
    });
}

// Function to calculate express delivery fee
function calculateExpressDeliveryFee() {
    const shopLocation = document.getElementById('shopLocation').value;
    const deliveryDestination = document.getElementById('deliveryDestination').value;
    
    if (shopLocation && shopLocation.length > 3 && deliveryDestination && deliveryDestination.length > 3) {
        Promise.all([
            forwardGeocode(shopLocation),
            forwardGeocode(deliveryDestination)
        ]).then(([shopResults, destinationResults]) => {
            if (shopResults.length > 0 && destinationResults.length > 0) {
                const shopLat = parseFloat(shopResults[0].lat);
                const shopLng = parseFloat(shopResults[0].lon);
                const destLat = parseFloat(destinationResults[0].lat);
                const destLng = parseFloat(destinationResults[0].lon);
                
                const distance = calculateDistance(shopLat, shopLng, destLat, destLng);
                let baseFare = calculateFareFromDistance(distance);
                
                const vehicleType = document.querySelector('.express-delivery-form .vehicle-option.selected');
                if (vehicleType) {
                    const selectedType = vehicleType.getAttribute('data-type');
                    switch(selectedType) {
                        case 'car':
                            baseFare = baseFare;
                            break;
                        case 'bike':
                            baseFare = baseFare * 0.7;
                            break;
                        case 'bicycle':
                            baseFare = baseFare * 0.5;
                            break;
                    }
                }
                
                document.getElementById('expressDeliveryFee').textContent = `K${baseFare.toFixed(2)}`;
                
                const etaMinutes = Math.ceil((distance / 1000) / 30 * 60);
                document.getElementById('expressDeliveryEtaDisplay').textContent = `ETA: ${etaMinutes} min`;
                document.getElementById('expressDeliveryBtn').disabled = false;
                
                updateShopLocationMarker(shopLat, shopLng, shopResults[0].display_name);
                updateDeliveryDestinationMarker(destLat, destLng, destinationResults[0].display_name);
                drawRoute(shopLat, shopLng, destLat, destLng);
            }
        }).catch(error => {
            console.error('Error calculating express delivery fee:', error);
        });
    } else {
        document.getElementById('expressDeliveryFee').textContent = 'K0.00';
        document.getElementById('expressDeliveryEtaDisplay').textContent = 'ETA: -- min';
        document.getElementById('expressDeliveryBtn').disabled = true;
    }
}

// Function to update shop location marker
function updateShopLocationMarker(lat, lng, name) {
    if (shopLocationMarker) {
        passengerMap.removeLayer(shopLocationMarker);
    }
    
    shopLocationMarker = L.marker([lat, lng], {
        icon: L.divIcon({
            className: 'pickup-marker',
            html: '<div class="pickup-marker"><i class="fas fa-shopping-bag"></i></div>',
            iconSize: [22, 22]
        })
    }).addTo(passengerMap)
        .bindPopup(`<strong>${name}</strong><br>Shop Location`)
        .openPopup();
}

// Function to update delivery destination marker
function updateDeliveryDestinationMarker(lat, lng, name) {
    if (deliveryDestinationMarker) {
        passengerMap.removeLayer(deliveryDestinationMarker);
    }
    
    deliveryDestinationMarker = L.marker([lat, lng], {
        icon: L.divIcon({
            className: 'destination-marker',
            html: '<div class="destination-marker"><i class="fas fa-home"></i></div>',
            iconSize: [22, 22]
        })
    }).addTo(passengerMap)
        .bindPopup(`<strong>${name}</strong><br>Delivery Destination`)
        .openPopup();
}

// Function to submit express delivery
function submitExpressDelivery() {
    const shopName = document.getElementById('shopName').value;
    const shopLocation = document.getElementById('shopLocation').value;
    const deliveryItems = document.getElementById('deliveryItems').value;
    const deliveryAmount = document.getElementById('deliveryAmount').value;
    const deliveryInstructions = document.getElementById('deliveryInstructions').value;
    const deliveryDestination = document.getElementById('deliveryDestination').value;
    
    if (!shopName || !shopLocation || !deliveryDestination) {
        showNotification('Please fill in all required fields.');
        return;
    }
    
    Promise.all([
        forwardGeocode(shopLocation),
        forwardGeocode(deliveryDestination)
    ]).then(([shopResults, destinationResults]) => {
        if (shopResults.length === 0 || destinationResults.length === 0) {
            showNotification('Invalid shop or destination address. Please select valid locations.');
            return;
        }
        
        const shopLat = parseFloat(shopResults[0].lat);
        const shopLng = parseFloat(shopResults[0].lon);
        const destLat = parseFloat(destinationResults[0].lat);
        const destLng = parseFloat(destinationResults[0].lon);
        
        const distance = calculateDistance(shopLat, shopLng, destLat, destLng);
        let baseFare = calculateFareFromDistance(distance);
        
        const vehicleType = document.querySelector('.express-delivery-form .vehicle-option.selected');
        let selectedVehicle = 'bike';
        if (vehicleType) {
            selectedVehicle = vehicleType.getAttribute('data-type');
            switch(selectedVehicle) {
                case 'car':
                    baseFare = baseFare;
                    break;
                case 'bike':
                    baseFare = baseFare * 0.7;
                    break;
                case 'bicycle':
                    baseFare = baseFare * 0.5;
                    break;
            }
        }
        
        const rideId = database.ref().child('rides').push().key;
        
        const rideRequest = {
            id: rideId,
            passengerId: currentUser.uid,
            passengerName: userData.name || 'Passenger',
            passengerPhone: userData.phone || 'Not provided',
            pickupLocation: shopResults[0].display_name,
            destination: destinationResults[0].display_name,
            pickupLat: shopLat,
            pickupLng: shopLng,
            destLat: destLat,
            destLng: destLng,
            rideType: selectedVehicle,
            fare: baseFare,
            distance: (distance / 1000).toFixed(2) + ' km',
            status: 'requested',
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            updatedAt: firebase.database.ServerValue.TIMESTAMP,
            paymentMethod: selectedPaymentType,
            expressDelivery: {
                shopName: shopName,
                items: deliveryItems || '',
                amount: deliveryAmount || '0',
                instructions: deliveryInstructions || ''
            },
            currentCity: currentCity
        };
        
        currentRideRequestData = rideRequest;
        currentRideRequestType = 'express-delivery';
        showPaymentSelection(baseFare);
    }).catch(error => {
        console.error('Error in express delivery process:', error);
        showNotification('Error calculating route. Please try again.');
    });
}

// Function to save SOS config
function saveSOSConfig() {
    const contact1 = document.getElementById('emergencyContact1').value;
    const contact2 = document.getElementById('emergencyContact2').value;
    const message = document.getElementById('sosMessage').value;
    
    if (!contact1) {
        showNotification('Please provide at least one emergency contact.');
        return;
    }
    
    sosConfig = {
        contact1: contact1,
        contact2: contact2 || '',
        message: message || 'I need help! My current location and ride details will be shared with you.'
    };
    
    database.ref('sosConfig/' + currentUser.uid).set(sosConfig)
        .then(() => {
            showNotification('SOS configuration saved successfully.');
            cancelMoreOptionForm();
        })
        .catch(error => {
            console.error('Error saving SOS config:', error);
            showNotification('Error saving SOS configuration. Please try again.');
        });
}

// Function to trigger SOS
function triggerSOS() {
    if (!sosConfig || !sosConfig.contact1) {
        showNotification('SOS not configured. Please set up emergency contacts first.');
        return;
    }
    
    if (!currentRide) {
        showNotification('No active ride to report SOS for.');
        return;
    }
    
    const sosAlert = {
        passengerId: currentUser.uid,
        passengerName: userData.name || 'Passenger',
        passengerPhone: userData.phone || 'Not provided',
        emergencyContact1: sosConfig.contact1,
        emergencyContact2: sosConfig.contact2 || '',
        message: sosConfig.message,
        rideDetails: currentRide,
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        location: userLocation
    };
    
    if (currentRide.driverId) {
        database.ref('users/' + currentRide.driverId).once('value')
            .then(driverSnapshot => {
                const driver = driverSnapshot.val();
                if (driver) {
                    sosAlert.driverDetails = {
                        name: driver.name,
                        phone: driver.phone,
                        vehicle: driver.vehicle
                    };
                }
                
                return database.ref('sosAlerts').push().set(sosAlert);
            })
            .then(() => {
                showNotification('SOS alert sent to emergency contacts!');
                console.log('SOS Alert:', sosAlert);
            })
            .catch(error => {
                console.error('Error sending SOS alert:', error);
                showNotification('Error sending SOS alert. Please try again or call emergency services directly.');
            });
    } else {
        database.ref('sosAlerts').push().set(sosAlert)
            .then(() => {
                showNotification('SOS alert sent to emergency contacts!');
                console.log('SOS Alert:', sosAlert);
            })
            .catch(error => {
                console.error('Error sending SOS alert:', error);
                showNotification('Error sending SOS alert. Please try again or call emergency services directly.');
            });
    }
}

// Initialize the app when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Set up global error handling
    errorHandler.setupGlobalErrorHandling();
    
    // Set up performance monitoring
    performanceMonitor.setupPerformanceObservers();
    
    // Initialize authentication
    initializeAuth();
    
    // Initialize the app
    initializeApp();
    
    // Log app initialization
    console.log('Jubel Passenger App initialized successfully');
});

// Enhanced initializeApp function
function initializeApp() {
    console.log("Advanced Jubel Passenger App Initialized");
    
    // Set up periodic city detection updates
    setInterval(() => {
        if (userLocation && currentScreen === 'home') {
            determineCurrentCity(userLocation.lat, userLocation.lng)
                .then(city => {
                    console.log("Periodic city update:", city);
                })
                .catch(error => {
                    console.error("Periodic city detection failed:", error);
                    errorHandler.captureError(error, {
                        operation: 'periodic_city_detection'
                    }, 'warning');
                });
        }
    }, 60000); // Every 60 seconds
    
    // Handle page visibility changes
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden && currentScreen === 'home') {
            setTimeout(refreshHomeScreen, 1000);
        }
    });
    
    // Handle app fully loaded
    window.addEventListener('load', function() {
        console.log("Jubel Passenger App fully loaded with advanced search engine");
        showNotification('Jubel Passenger App Ready', 'success');
        
        // Log performance metrics
        const performanceReport = performanceMonitor.getPerformanceReport();
        console.log('Initial performance report:', performanceReport);
    });
    
    // Handle offline/online status
    window.addEventListener('online', function() {
        showNotification('Connection restored.', 'success');
        if (currentScreen === 'home') {
            setTimeout(refreshPassengerPosition, 1000);
        }
    });
    
    window.addEventListener('offline', function() {
        showNotification('You are currently offline. Some features may not work.', 'warning');
    });
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        // Clean up performance observers
        performanceMonitor.cleanup();
        
        // Clean up Firebase listeners
        if (driverAssignmentListener) {
            driverAssignmentListener();
        }
        if (rideHistoryListener) {
            rideHistoryListener();
        }
        if (activeRideListener) {
            activeRideListener();
        }
        if (walletBalanceListener) {
            walletBalanceListener();
        }
        if (driverLocationListener) {
            driverLocationListener();
        }
        if (driverMessageListener) {
            driverMessageListener();
        }
        if (chatListener) {
            chatListener();
        }
        
        // Stop location tracking
        if (locationWatchId && navigator.geolocation) {
            navigator.geolocation.clearWatch(locationWatchId);
        }
    });
}

// Export functions to global scope for HTML event handlers
window.searchPlacesEnhanced = searchPlacesEnhanced;
window.hideSearchSuggestions = hideSearchSuggestions;
window.retrySearch = retrySearch;
window.setManualPickupLocation = setManualPickupLocation;
window.searchNearbyFromMap = searchNearbyFromMap;
window.selectNearbyResult = selectNearbyResult;
window.searchCustomNearby = searchCustomNearby;
window.setRating = setRating;
window.centerMap = centerMap;
window.togglePanelCollapse = togglePanelCollapse;
window.useSavedLocation = useSavedLocation;
window.refreshPassengerPosition = refreshPassengerPosition;

// Log that the script has loaded
console.log('Jubel Passenger App JavaScript loaded successfully');
          </script>
</body>
</html>
