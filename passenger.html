<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jubel - Passenger</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* All existing CSS styles remain unchanged */
        :root {
            --primary-orange: #FF6B35;
            --primary-red: #E74C3C;
            --primary-gradient: linear-gradient(135deg, #FF6B35, #E74C3C);
            --secondary-orange: #E55A28;
            --secondary-red: #C0392B;
            --light-orange: #FFE8E0;
            --light-red: #FADBD8;
            --white: #FFFFFF;
            --light-gray: #F5F5F5;
            --dark-gray: #333333;
            --medium-gray: #777777;
            --success-green: #2ecc71;
            --warning-yellow: #f39c12;
            --info-blue: #3498db;
            --error-red: #e74c3c;
            --border-color: #E8E8E8;
            --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 4px 15px rgba(0, 0, 0, 0.15);
            --shadow-heavy: 0 6px 20px rgba(0, 0, 0, 0.2);
            --app-padding: 10px;
            --element-radius: 6px;
            --transition-speed: 0.3s;
            --ambulance-blue: #0066cc;
            --fire-truck-red: #cc0000;
            --premium-gold: #FFD700;
            --economy-green: #27ae60;
            --light-truck-brown: #8B4513;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--white);
            color: var(--dark-gray);
            max-width: 100%;
            overflow-x: hidden;
            height: 100vh;
            font-size: 13px;
        }
        
        /* Main App */
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        .floating-balance {
            position: fixed;
            top: 10px;
            right: 10px;
            background: var(--white);
            padding: 6px 10px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 700;
            color: var(--dark-gray);
            border: 2px solid var(--primary-orange);
            font-size: 0.75rem;
        }
        
        .balance-amount {
            color: var(--primary-orange);
            font-size: 0.8rem;
        }
        
        .passenger-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            border-radius: 15px 15px 0 0;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
            z-index: 100;
            padding: var(--app-padding);
            transform: translateY(0);
            transition: transform var(--transition-speed) ease;
            max-height: 45vh;
            overflow-y: auto;
        }
        
        .passenger-panel.collapsed {
            transform: translateY(calc(100% - 40px));
        }
        
        .panel-collapse-handle {
            width: 35px;
            height: 3px;
            background: var(--border-color);
            border-radius: 2px;
            margin: 0 auto 8px;
            cursor: pointer;
        }
        
        .nav-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            padding: 6px 3px;
            border-radius: var(--element-radius);
            background: var(--light-gray);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            border: none;
            font-size: 0.6rem;
            font-weight: 600;
        }
        
        .nav-btn.active {
            background: var(--primary-gradient);
            color: var(--white);
        }
        
        .nav-btn i {
            font-size: 0.8rem;
        }
        
        /* NEW: More Options Button */
        .more-options-btn {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--primary-orange);
            color: var(--white);
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .more-options-dropdown {
            display: none;
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            margin-top: 5px;
            overflow: hidden;
            box-shadow: var(--shadow-medium);
        }
        
        .more-options-dropdown.active {
            display: block;
        }
        
        .more-option-item {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all var(--transition-speed) ease;
        }
        
        .more-option-item:hover {
            background: var(--light-orange);
        }
        
        .more-option-item:last-child {
            border-bottom: none;
        }
        
        .more-option-icon {
            width: 20px;
            text-align: center;
            font-size: 0.9rem;
        }
        
        .more-option-text {
            flex: 1;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        /* NEW: Order for Someone Else Form */
        .order-for-someone-form {
            display: none;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
        }
        
        .order-for-someone-form.active {
            display: flex;
        }
        
        /* NEW: Express Delivery Form */
        .express-delivery-form {
            display: none;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
        }
        
        .express-delivery-form.active {
            display: flex;
        }
        
        /* NEW: SOS Setup Form */
        .sos-setup-form {
            display: none;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
        }
        
        .sos-setup-form.active {
            display: flex;
        }
        
        /* NEW: Schedule Ride Form */
        .schedule-ride-form {
            display: none;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
        }
        
        .schedule-ride-form.active {
            display: flex;
        }
        
        /* NEW: Schedule Delivery Form */
        .schedule-delivery-form {
            display: none;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
        }
        
        .schedule-delivery-form.active {
            display: flex;
        }
        
        /* NEW: Emergency Services Form */
        .emergency-services-form {
            display: none;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
        }
        
        .emergency-services-form.active {
            display: flex;
        }
        
        /* NEW: Emergency Questionnaire */
        .emergency-questionnaire {
            display: none;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-red);
        }
        
        .emergency-questionnaire.active {
            display: flex;
        }
        
        /* NEW: Ride Type Selection Modal */
        .ride-type-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--white);
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 1000;
            width: 90%;
            max-width: 400px;
            padding: 15px;
        }
        
        .ride-type-modal.active {
            display: block;
        }
        
        .ride-type-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 15px 0;
        }
        
        .ride-type-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .ride-type-option:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .ride-type-option.premium {
            border-color: var(--premium-gold);
            background: linear-gradient(135deg, #FFF9E6, #FFE680);
        }
        
        .ride-type-option.standard {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .ride-type-option.economy {
            border-color: var(--economy-green);
            background: #E8F6EF;
        }
        
        .ride-type-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        
        .ride-type-option.premium .ride-type-icon {
            background: var(--premium-gold);
            color: var(--dark-gray);
        }
        
        .ride-type-option.standard .ride-type-icon {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .ride-type-option.economy .ride-type-icon {
            background: var(--economy-green);
            color: var(--white);
        }
        
        .ride-type-details {
            flex: 1;
        }
        
        .ride-type-name {
            font-weight: 700;
            font-size: 0.9rem;
        }
        
        .ride-type-description {
            font-size: 0.75rem;
            color: var(--medium-gray);
            margin-top: 2px;
        }
        
        .ride-type-price {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        /* NEW: Emergency Vehicle Options */
        .emergency-vehicle-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        
        .emergency-vehicle-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            text-align: center;
        }
        
        .emergency-vehicle-option:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .emergency-vehicle-option.ambulance {
            border-color: var(--ambulance-blue);
            background: #E6F2FF;
        }
        
        .emergency-vehicle-option.fire-truck {
            border-color: var(--fire-truck-red);
            background: #FFE6E6;
        }
        
        .emergency-vehicle-option.emergency-ride {
            border-color: var(--warning-yellow);
            background: #FFF3E0;
        }
        
        .emergency-vehicle-option.emergency-delivery {
            border-color: var(--light-truck-brown);
            background: #F5E6D3;
        }
        
        .emergency-vehicle-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        .emergency-vehicle-option.ambulance .emergency-vehicle-icon {
            background: var(--ambulance-blue);
            color: white;
        }
        
        .emergency-vehicle-option.fire-truck .emergency-vehicle-icon {
            background: var(--fire-truck-red);
            color: white;
        }
        
        .emergency-vehicle-option.emergency-ride .emergency-vehicle-icon {
            background: var(--warning-yellow);
            color: var(--dark-gray);
        }
        
        .emergency-vehicle-option.emergedy-delivery .emergency-vehicle-icon {
            background: var(--light-truck-brown);
            color: white;
        }
        
        .emergency-vehicle-name {
            font-weight: 700;
            font-size: 0.85rem;
        }
        
        .emergency-vehicle-description {
            font-size: 0.7rem;
            color: var(--medium-gray);
        }
        
        /* NEW: Countdown Timer */
        .countdown-timer {
            position: fixed;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-gradient);
            color: var(--white);
            padding: 8px 15px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 150;
            display: none;
            font-weight: 700;
            font-size: 0.8rem;
            text-align: center;
        }
        
        .countdown-timer.active {
            display: block;
        }
        
        .countdown-text {
            font-size: 0.7rem;
            opacity: 0.9;
        }
        
        .countdown-time {
            font-size: 1rem;
            font-weight: 800;
            margin: 2px 0;
        }
        
        /* NEW: Receipt Modal */
        .receipt-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--white);
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 1000;
            width: 90%;
            max-width: 400px;
            padding: 15px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .receipt-modal.active {
            display: block;
        }
        
        .receipt-header {
            text-align: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .receipt-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        .receipt-details {
            margin-bottom: 15px;
        }
        
        .receipt-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .receipt-row:last-child {
            border-bottom: none;
        }
        
        .receipt-label {
            font-weight: 600;
            font-size: 0.8rem;
        }
        
        .receipt-value {
            font-size: 0.8rem;
            color: var(--medium-gray);
        }
        
        .receipt-total {
            background: var(--light-orange);
            padding: 10px;
            border-radius: var(--element-radius);
            margin: 15px 0;
        }
        
        .receipt-total .receipt-row {
            border-bottom: none;
        }
        
        .receipt-total .receipt-label {
            font-size: 0.9rem;
        }
        
        .receipt-total .receipt-value {
            font-size: 1rem;
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        .receipt-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        /* NEW: Light Truck Delivery Form */
        .light-truck-delivery-form {
            display: none;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
        }
        
        .light-truck-delivery-form.active {
            display: flex;
        }
        
        /* NEW: Delivery Mode Selection */
        .delivery-mode-selection {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            margin: 8px 0;
        }
        
        .delivery-mode-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 4px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .delivery-mode-option.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .delivery-mode-option.light-truck {
            border-color: var(--light-truck-brown);
            background: #F5E6D3;
        }
        
        .delivery-mode-option.light-truck.selected {
            border-color: var(--light-truck-brown);
            background: #E8D0B3;
        }
        
        .delivery-mode-icon {
            font-size: 1rem;
            color: var(--medium-gray);
        }
        
        .delivery-mode-option.selected .delivery-mode-icon {
            color: var(--primary-orange);
        }
        
        .delivery-mode-option.light-truck.selected .delivery-mode-icon {
            color: var(--light-truck-brown);
        }
        
        .delivery-mode-name {
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .delivery-mode-price {
            font-size: 0.65rem;
            color: var(--medium-gray);
        }
        
        /* NEW: SOS Button */
        .sos-button {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--error-red);
            color: var(--white);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 700;
            box-shadow: var(--shadow-heavy);
            z-index: 150;
            cursor: pointer;
            animation: sos-pulse 2s infinite;
            display: none;
        }
        
        @keyframes sos-pulse {
            0% {
                transform: translateX(-50%) scale(1);
                box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7);
            }
            70% {
                transform: translateX(-50%) scale(1.05);
                box-shadow: 0 0 0 10px rgba(231, 76, 60, 0);
            }
            100% {
                transform: translateX(-50%) scale(1);
                box-shadow: 0 0 0 0 rgba(231, 76, 60, 0);
            }
        }
        
        /* NEW: Delivery Fee Display - Hidden by default */
        .delivery-fee-display {
            background: var(--primary-gradient);
            color: var(--white);
            padding: 10px;
            border-radius: var(--element-radius);
            text-align: center;
            margin: 8px 0;
            display: none;
        }
        
        .delivery-fee-display.active {
            display: block;
        }
        
        .delivery-fee-amount {
            font-size: 1.2rem;
            font-weight: 800;
            margin: 4px 0;
        }
        
        .delivery-eta-display {
            font-size: 0.8rem;
            font-weight: 600;
            opacity: 0.9;
        }
        
        /* All other existing CSS styles remain unchanged */
        .ride-request-form {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .location-input {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--white);
            position: relative;
        }
        
        .location-input i {
            color: var(--primary-orange);
        }
        
        .location-input input {
            border: none;
            outline: none;
            width: 100%;
            font-size: 0.8rem;
        }
        
        /* Updated: Vehicle Selection - Hidden by default */
        .vehicle-selection {
            display: none;
            gap: 6px;
            margin: 8px 0;
        }
        
        .vehicle-selection.active {
            display: flex;
        }
        
        .vehicle-option {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 4px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .vehicle-option.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .vehicle-icon {
            font-size: 1rem;
            color: var(--medium-gray);
        }
        
        .vehicle-option.selected .vehicle-icon {
            color: var(--primary-orange);
        }
        
        .vehicle-name {
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .vehicle-price {
            font-size: 0.65rem;
            color: var(--medium-gray);
        }
        
        /* Updated: Fare Display - Hidden by default */
        .fare-display {
            background: var(--primary-gradient);
            color: var(--white);
            padding: 10px;
            border-radius: var(--element-radius);
            text-align: center;
            margin: 8px 0;
            box-shadow: var(--shadow-medium);
            display: none;
        }
        
        .fare-display.active {
            display: block;
        }
        
        .fare-amount {
            font-size: 1.5rem;
            font-weight: 800;
            margin: 4px 0;
        }
        
        .eta-display {
            font-size: 0.9rem;
            font-weight: 600;
            opacity: 0.9;
        }
        
        .promo-section {
            margin-top: 8px;
            padding: 8px;
            border: 1px dashed var(--border-color);
            border-radius: var(--element-radius);
            display: none;
        }
        
        .promo-section.active {
            display: block;
        }
        
        .promo-input {
            display: flex;
            gap: 6px;
        }
        
        .promo-input input {
            flex: 1;
            padding: 6px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 0.75rem;
        }
        
        .btn-promo {
            background: var(--primary-orange);
            color: var(--white);
            border: none;
            border-radius: var(--element-radius);
            padding: 6px 10px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .promo-toggle {
            width: 100%;
            padding: 6px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .request-ride-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: var(--element-radius);
            background: var(--primary-gradient);
            color: var(--white);
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            margin-top: 8px;
            box-shadow: var(--shadow-medium);
            display: none;
        }
        
        .request-ride-btn.active {
            display: block;
        }
        
        .request-ride-btn:disabled {
            background: var(--medium-gray);
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .ride-info-panel {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 10px;
            box-shadow: var(--shadow-medium);
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            display: none;
        }
        
        .driver-info {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .driver-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            color: var(--white);
            font-weight: 700;
        }
        
        .driver-details h2 {
            font-size: 0.85rem;
            margin-bottom: 2px;
        }
        
        .driver-details p {
            color: var(--medium-gray);
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 3px;
            font-size: 0.7rem;
        }
        
        .trip-details {
            margin-bottom: 10px;
        }
        
        .location-row {
            display: flex;
            align-items: flex-start;
            gap: 5px;
            margin-bottom: 8px;
        }
        
        .location-icon {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            flex-shrink: 0;
        }
        
        .pickup-icon {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .destination-icon {
            background: var(--primary-red);
            color: var(--white);
        }
        
        .location-text {
            flex: 1;
        }
        
        .location-text h4 {
            font-size: 0.8rem;
            margin-bottom: 2px;
        }
        
        .location-text p {
            color: var(--medium-gray);
            font-size: 0.7rem;
        }
        
        .fare-details {
            background: var(--light-orange);
            padding: 8px;
            border-radius: var(--element-radius);
            margin-bottom: 10px;
        }
        
        .fare-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 0.7rem;
        }
        
        .fare-row.total {
            font-weight: 700;
            font-size: 0.8rem;
            border-top: 1px solid var(--border-color);
            padding-top: 5px;
            margin-top: 5px;
        }
        
        .ride-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }
        
        .btn {
            padding: 8px;
            border: none;
            border-radius: var(--element-radius);
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .btn-cancel {
            background: var(--error-red);
            color: var(--white);
        }
        
        .btn-contact {
            background: var(--info-blue);
            color: var(--white);
        }
        
        .screen-content {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 50px;
            background: var(--white);
            z-index: 90;
            padding: var(--app-padding);
            overflow-y: auto;
            display: none;
        }
        
        .screen-content.active {
            display: block;
        }
        
        .screen-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .back-button {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            font-size: 0.9rem;
        }
        
        .screen-title {
            font-size: 1rem;
            font-weight: 700;
        }
        
        .account-section, .history-section, .payments-section {
            margin-bottom: 15px;
        }
        
        .section-title {
            font-size: 0.85rem;
            margin-bottom: 8px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .input-group {
            margin-bottom: 8px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 600;
            font-size: 0.75rem;
        }
        
        .input-field {
            width: 100%;
            padding: 8px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 0.75rem;
            transition: all var(--transition-speed) ease;
        }
        
        .input-field:focus {
            outline: none;
            border-color: var(--primary-orange);
        }
        
        .wallet-balance {
            background: var(--primary-gradient);
            color: var(--white);
            padding: 10px;
            border-radius: var(--element-radius);
            text-align: center;
            margin-bottom: 10px;
        }
        
        .balance-label {
            font-size: 0.7rem;
            margin-bottom: 2px;
        }
        
        .balance-amount-large {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 5px;
        }
        
        .wallet-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin-bottom: 10px;
        }
        
        .btn-wallet {
            background: var(--white);
            color: var(--primary-orange);
            border: 2px solid var(--primary-orange);
            padding: 6px;
            font-size: 0.7rem;
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .btn-wallet:hover {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        /* UPDATED: Replaced Payment Methods with Emergency Services */
        .emergency-services-section {
            margin-top: 10px;
        }
        
        .emergency-service {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            margin-bottom: 8px;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .emergency-service:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .emergency-service.ambulance {
            border-color: var(--ambulance-blue);
            background: #E6F2FF;
        }
        
        .emergency-service.fire-truck {
            border-color: var(--fire-truck-red);
            background: #FFE6E6;
        }
        
        .emergency-service.emergency-ride {
            border-color: var(--warning-yellow);
            background: #FFF3E0;
        }
        
        .emergency-service.emergency-delivery {
            border-color: var(--light-truck-brown);
            background: #F5E6D3;
        }
        
        .emergency-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: var(--medium-gray);
        }
        
        .emergency-service.ambulance .emergency-icon {
            background: var(--ambulance-blue);
            color: white;
        }
        
        .emergency-service.fire-truck .emergency-icon {
            background: var(--fire-truck-red);
            color: white;
        }
        
        .emergency-service.emergency-ride .emergency-icon {
            background: var(--warning-yellow);
            color: var(--dark-gray);
        }
        
        .emergency-service.emergency-delivery .emergency-icon {
            background: var(--light-truck-brown);
            color: white;
        }
        
        .emergency-details {
            flex: 1;
        }
        
        .emergency-name {
            font-weight: 600;
            font-size: 0.85rem;
        }
        
        .emergency-info {
            color: var(--medium-gray);
            font-size: 0.75rem;
        }
        
        .history-item {
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            font-size: 0.7rem;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-item:hover {
            background: var(--light-orange);
        }
        
        .history-locations {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .history-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.65rem;
            color: var(--medium-gray);
        }
        
        .status-badge {
            padding: 2px 5px;
            border-radius: 10px;
            font-size: 0.6rem;
            font-weight: 700;
        }
        
        .status-completed {
            background: #e6f7e9;
            color: #2e7d32;
        }
        
        .status-cancelled {
            background: #ffebee;
            color: #c62828;
        }
        
        .status-requested {
            background: #fff3e0;
            color: #ef6c00;
        }
        
        .status-accepted {
            background: #e3f2fd;
            color: #1565c0;
        }
        
        .notification {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-gradient);
            color: var(--white);
            padding: 8px 14px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 300;
            display: none;
            font-weight: 600;
            text-align: center;
            font-size: 0.75rem;
            max-width: 80%;
        }
        
        .driver-marker {
            background: var(--primary-gradient);
            color: white;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .driver-marker-label {
            background: white;
            padding: 2px 4px;
            border-radius: 6px;
            margin-top: 3px;
            font-size: 8px;
            font-weight: bold;
            box-shadow: 0 1px 5px rgba(0,0,0,0.2);
        }
        
        /* NEW: Emergency Vehicle Markers */
        .ambulance-marker {
            background: var(--ambulance-blue);
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .fire-truck-marker {
            background: var(--fire-truck-red);
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .pickup-marker {
            background: var(--primary-orange);
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .destination-marker {
            background: var(--primary-red);
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .current-location-marker {
            background: var(--info-blue);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .ride-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: var(--white);
            padding: 6px 10px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 700;
            color: var(--dark-gray);
            border: 2px solid var(--border-color);
            font-size: 0.75rem;
            display: none;
        }
        
        .status-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: var(--medium-gray);
        }
        
        .status-dot.searching {
            background: var(--warning-yellow);
            animation: pulse 2s infinite;
        }
        
        .status-dot.arriving {
            background: var(--info-blue);
            animation: pulse 1.5s infinite;
        }
        
        .status-dot.riding {
            background: var(--success-green);
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .estimated-time {
            position: fixed;
            top: 50px;
            right: 10px;
            background: var(--white);
            padding: 6px 10px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 700;
            color: var(--dark-gray);
            border: 2px solid var(--border-color);
            font-size: 0.75rem;
            display: none;
        }
        
        .saved-locations {
            display: flex;
            gap: 6px;
            margin: 8px 0;
        }
        
        .saved-location-btn {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
            cursor: pointer;
            font-size: 0.65rem;
            transition: all var(--transition-speed) ease;
        }
        
        .saved-location-btn:hover {
            background: var(--light-orange);
            border-color: var(--primary-orange);
        }
        
        .suggestion-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-medium);
            z-index: 200;
            max-height: 180px;
            overflow-y: auto;
            display: none;
        }
        
        .suggestion-item {
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .suggestion-item:hover {
            background: var(--light-orange);
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
        
        .suggestion-icon {
            font-size: 0.9rem;
            width: 18px;
            text-align: center;
        }
        
        .suggestion-details {
            flex: 1;
        }
        
        .suggestion-name {
            font-weight: 600;
            font-size: 0.75rem;
        }
        
        .suggestion-address {
            color: var(--medium-gray);
            font-size: 0.65rem;
        }
        
        .suggestion-distance {
            color: var(--medium-gray);
            font-size: 0.55rem;
            margin-top: 2px;
        }
        
        .loading-text {
            text-align: center;
            padding: 15px;
            color: var(--medium-gray);
        }
        
        .no-places {
            text-align: center;
            padding: 15px;
            color: var(--medium-gray);
        }
        
        .filter-options {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .filter-options select, .filter-options input {
            flex: 1;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .stat-card {
            background: var(--light-gray);
            padding: 10px;
            border-radius: var(--element-radius);
            text-align: center;
        }
        
        .stat-number {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        .stat-label {
            font-size: 0.65rem;
            color: var(--medium-gray);
        }
        
        .referral-section {
            background: var(--light-orange);
            padding: 12px;
            border-radius: var(--element-radius);
            margin-bottom: 12px;
        }
        
        .referral-code {
            background: var(--white);
            padding: 8px;
            border-radius: var(--element-radius);
            text-align: center;
            margin: 8px 0;
        }
        
        .code {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        .description {
            font-size: 0.65rem;
            color: var(--medium-gray);
            margin-top: 4px;
        }
        
        .contact-section {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .contact-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: var(--element-radius);
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .contact-btn.whatsapp {
            background: #25D366;
            color: white;
        }
        
        .contact-btn.phone {
            background: var(--info-blue);
            color: white;
        }
        
        .rating-stars {
            display: flex;
            gap: 4px;
            margin-top: 4px;
        }
        
        .star {
            font-size: 1.3rem;
            color: var(--light-gray);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .star.active {
            color: var(--warning-yellow);
        }
        
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
        }
        
        .popup-overlay.hidden {
            display: none;
        }
        
        .popup-form {
            background: var(--white);
            border-radius: var(--element-radius);
            width: 100%;
            max-width: 450px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: var(--shadow-heavy);
        }
        
        .large-popup {
            max-width: 700px;
        }
        
        .popup-header {
            display: flex;
            align-items: center;
            justify-content: between;
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .popup-title {
            font-size: 1.1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .close-popup {
            background: none;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            color: var(--medium-gray);
        }
        
        .popup-content {
            padding: 12px;
        }
        
        .popup-map-container {
            height: 180px;
            border-radius: var(--element-radius);
            overflow: hidden;
            margin-bottom: 12px;
        }
        
        .popup-details {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .detail-row:last-child {
            border-bottom: none;
        }
        
        .detail-label {
            font-weight: 600;
            font-size: 0.75rem;
        }
        
        .detail-value {
            font-size: 0.75rem;
            color: var(--medium-gray);
        }
        
        .driver-details-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }
        
        .popup-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 12px;
        }
        
        /* Payment Selection Popup Styles */
        .payment-selection-popup {
            max-width: 350px;
        }
        
        .payment-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            margin-bottom: 8px;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .payment-option.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .payment-option-icon {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            color: var(--medium-gray);
        }
        
        .payment-option.selected .payment-option-icon {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .payment-option-details {
            flex: 1;
        }
        
        .payment-option-name {
            font-weight: 600;
            font-size: 0.85rem;
        }
        
        .payment-option-description {
            color: var(--medium-gray);
            font-size: 0.7rem;
        }
        
        .payment-option-balance {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--primary-orange);
        }
        
        .confirm-payment-btn {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: var(--element-radius);
            background: var(--primary-gradient);
            color: var(--white);
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            margin-top: 12px;
        }
        
        .confirm-payment-btn:disabled {
            background: var(--medium-gray);
            cursor: not-allowed;
        }
        
        .insufficient-balance {
            color: var(--error-red);
            font-size: 0.75rem;
            margin-top: 4px;
            display: none;
        }
        
        /* Package Delivery Form Styles */
        .package-form {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
            display: none;
        }
        
        .package-form.active {
            display: block;
        }
        
        .form-row {
            display: flex;
            gap: 6px;
            margin-bottom: 6px;
        }
        
        .form-group {
            flex: 1;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 3px;
            font-weight: 600;
            font-size: 0.7rem;
        }
        
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 6px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 0.7rem;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 50px;
        }
        
        .package-toggle {
            width: 100%;
            padding: 6px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .driver-details-card {
            background: var(--light-orange);
            padding: 10px;
            border-radius: var(--element-radius);
            margin-bottom: 10px;
            border: 1px solid var(--primary-orange);
        }
        
        .driver-details-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 6px;
        }
        
        .driver-details-header h3 {
            font-size: 0.85rem;
            color: var(--primary-orange);
        }
        
        .driver-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }
        
        .driver-detail-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .driver-detail-label {
            font-size: 0.65rem;
            color: var(--medium-gray);
            font-weight: 600;
        }
        
        .driver-detail-value {
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .driver-vehicle-details {
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px dashed var(--border-color);
        }
        
        .vehicle-detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
            font-size: 0.65rem;
        }
        
        .vehicle-detail-label {
            color: var(--medium-gray);
        }
        
        .vehicle-detail-value {
            font-weight: 600;
        }
        
        /* Enhanced History Item Styles */
        .history-item-type {
            font-size: 0.65rem;
            font-weight: 600;
            padding: 2px 5px;
            border-radius: 8px;
            margin-bottom: 4px;
            display: inline-block;
        }
        
        .history-item-type.ride {
            background: var(--light-orange);
            color: var(--primary-orange);
        }
        
        .history-item-type.delivery {
            background: var(--light-red);
            color: var(--primary-red);
        }
        
        .history-item-type.emergency {
            background: #FFE6E6;
            color: #c62828;
        }
        
        .history-package-details {
            background: var(--light-gray);
            padding: 6px;
            border-radius: var(--element-radius);
            margin: 6px 0;
            font-size: 0.65rem;
        }
        
        .package-detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
        }
        
        .package-detail-label {
            font-weight: 600;
            color: var(--medium-gray);
        }
        
        .package-detail-value {
            color: var(--dark-gray);
        }
        
        .history-driver-info {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px dashed var(--border-color);
        }
        
        .history-driver-avatar {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            color: var(--white);
            font-weight: 700;
        }
        
        .history-driver-details {
            flex: 1;
        }
        
        .history-driver-name {
            font-size: 0.65rem;
            font-weight: 600;
        }
        
        .history-driver-rating {
            font-size: 0.55rem;
            color: var(--medium-gray);
        }
        
        .history-fare {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        /* Driver Search Animation */
        .searching-animation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 200;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .searching-pulse {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(255, 107, 53, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse-ring 2s infinite;
            position: relative;
        }
        
        .searching-pulse-inner {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }
        
        .searching-text {
            margin-top: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 12px;
            border-radius: var(--element-radius);
            font-weight: 600;
            color: var(--primary-orange);
            box-shadow: var(--shadow-medium);
        }
        
        @keyframes pulse-ring {
            0% {
                transform: scale(0.8);
                opacity: 1;
            }
            80%, 100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }
        
        /* NEW: Receipt Download Button */
        .download-receipt-btn {
            background: var(--success-green);
            color: var(--white);
            border: none;
            border-radius: var(--element-radius);
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all var(--transition-speed) ease;
        }
        
        .download-receipt-btn:hover {
            background: #27ae60;
        }
        
        /* NEW: Emergency Ride Status */
        .emergency-ride-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: var(--error-red);
            color: var(--white);
            padding: 8px 12px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 100;
            display: none;
            font-weight: 700;
            font-size: 0.8rem;
            animation: emergency-pulse 1s infinite;
        }
        
        @keyframes emergency-pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        /* NEW: Light Truck Icon */
        .fa-truck-pickup:before {
            content: "\f63b";
        }
        
        .fa-ambulance:before {
            content: "\f0f9";
        }
        
        .fa-fire-truck:before {
            content: "\f692";
        }
        
        .fa-truck-medical:before {
            content: "\f0f9";
        }
        
        @media (max-width: 480px) {
            .floating-balance, .ride-status {
                padding: 5px 7px;
                font-size: 0.65rem;
            }
            
            .passenger-panel {
                padding: 8px;
            }
            
            .nav-buttons {
                gap: 3px;
            }
            
            .nav-btn {
                padding: 5px 2px;
                font-size: 0.55rem;
            }
            
            .emergency-vehicle-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Main App -->
    <div id="mainApp">
        <!-- Main Map -->
        <div id="map"></div>
        
        <!-- Floating Balance (Only on Home Screen) -->
        <div class="floating-balance home-only">
            <i class="fas fa-wallet"></i>
            <span>Balance: <span class="balance-amount" id="walletBalance">K0.00</span></span>
        </div>
        
        <!-- Ride Status (Only on Home Screen) -->
        <div class="ride-status home-only" id="rideStatus">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Searching for driver</span>
        </div>
        
        <!-- Emergency Ride Status -->
        <div class="emergency-ride-status" id="emergencyRideStatus">
            <i class="fas fa-exclamation-triangle"></i>
            <span>EMERGENCY RIDE IN PROGRESS</span>
        </div>
        
        <!-- Estimated Time (Only on Home Screen) -->
        <div class="estimated-time home-only" id="estimatedTime">
            <i class="fas fa-clock"></i>
            <span id="timeText">5 min</span>
        </div>
        
        <!-- NEW: Countdown Timer -->
        <div class="countdown-timer" id="countdownTimer">
            <div class="countdown-text">Scheduled Ride In:</div>
            <div class="countdown-time" id="countdownTime">00:00:00</div>
        </div>
        
        <!-- NEW: SOS Button -->
        <div class="sos-button" id="sosButton">
            SOS
        </div>
        
        <!-- NEW: Ride Type Selection Modal -->
        <div class="ride-type-modal" id="rideTypeModal">
            <div class="popup-header">
                <h2 class="popup-title">
                    <i class="fas fa-car"></i>
                    Select Ride Type
                </h2>
                <button class="close-popup" id="closeRideTypeModal">&times;</button>
            </div>
            <div class="popup-content">
                <div class="ride-type-options">
                    <div class="ride-type-option premium" data-type="premium">
                        <div class="ride-type-icon">
                            <i class="fas fa-crown"></i>
                        </div>
                        <div class="ride-type-details">
                            <div class="ride-type-name">Premium Ride</div>
                            <div class="ride-type-description">Luxury vehicles with premium service</div>
                        </div>
                        <div class="ride-type-price">+50%</div>
                    </div>
                    
                    <div class="ride-type-option standard" data-type="standard">
                        <div class="ride-type-icon">
                            <i class="fas fa-car"></i>
                        </div>
                        <div class="ride-type-details">
                            <div class="ride-type-name">Standard Ride</div>
                            <div class="ride-type-description">Comfortable and reliable service</div>
                        </div>
                        <div class="ride-type-price">Base Price</div>
                    </div>
                    
                    <div class="ride-type-option economy" data-type="economy">
                        <div class="ride-type-icon">
                            <i class="fas fa-car-side"></i>
                        </div>
                        <div class="ride-type-details">
                            <div class="ride-type-name">Economy Ride</div>
                            <div class="ride-type-description">Budget-friendly option</div>
                        </div>
                        <div class="ride-type-price">-30%</div>
                    </div>
                </div>
                <button class="confirm-payment-btn" id="selectRideTypeBtn">
                    Select Ride Type
                </button>
            </div>
        </div>
        
        <!-- NEW: Receipt Modal -->
        <div class="receipt-modal" id="receiptModal">
            <div class="receipt-header">
                <h2 class="receipt-title">JUBEL RIDE RECEIPT</h2>
                <div style="font-size: 0.7rem; color: var(--medium-gray);" id="receiptDate"></div>
            </div>
            <div class="receipt-details">
                <div class="receipt-row">
                    <span class="receipt-label">Receipt No:</span>
                    <span class="receipt-value" id="receiptNumber"></span>
                </div>
                <div class="receipt-row">
                    <span class="receipt-label">Passenger:</span>
                    <span class="receipt-value" id="receiptPassenger"></span>
                </div>
                <div class="receipt-row">
                    <span class="receipt-label">Driver:</span>
                    <span class="receipt-value" id="receiptDriver"></span>
                </div>
                <div class="receipt-row">
                    <span class="receipt-label">Vehicle:</span>
                    <span class="receipt-value" id="receiptVehicle"></span>
                </div>
                <div class="receipt-row">
                    <span class="receipt-label">Pickup:</span>
                    <span class="receipt-value" id="receiptPickup"></span>
                </div>
                <div class="receipt-row">
                    <span class="receipt-label">Destination:</span>
                    <span class="receipt-value" id="receiptDestination"></span>
                </div>
                <div class="receipt-row">
                    <span class="receipt-label">Distance:</span>
                    <span class="receipt-value" id="receiptDistance"></span>
                </div>
                <div class="receipt-row">
                    <span class="receipt-label">Ride Type:</span>
                    <span class="receipt-value" id="receiptRideType"></span>
                </div>
                <div class="receipt-row">
                    <span class="receipt-label">Ride Time:</span>
                    <span class="receipt-value" id="receiptRideTime"></span>
                </div>
                <div class="receipt-row">
                    <span class="receipt-label">Payment Method:</span>
                    <span class="receipt-value" id="receiptPaymentMethod"></span>
                </div>
            </div>
            <div class="receipt-total">
                <div class="receipt-row">
                    <span class="receipt-label">Base Fare:</span>
                    <span class="receipt-value" id="receiptBaseFare"></span>
                </div>
                <div class="receipt-row">
                    <span class="receipt-label">Distance Fare:</span>
                    <span class="receipt-value" id="receiptDistanceFare"></span>
                </div>
                <div class="receipt-row">
                    <span class="receipt-label">Discount:</span>
                    <span class="receipt-value" id="receiptDiscount"></span>
                </div>
                <div class="receipt-row">
                    <span class="receipt-label">TOTAL:</span>
                    <span class="receipt-value" id="receiptTotal"></span>
                </div>
            </div>
            <div class="receipt-actions">
                <button class="download-receipt-btn" id="downloadReceiptBtn">
                    <i class="fas fa-download"></i>
                    Download Receipt
                </button>
                <button class="btn btn-primary" id="closeReceiptBtn">
                    <i class="fas fa-times"></i>
                    Close
                </button>
            </div>
        </div>
        
        <!-- Driver Search Animation -->
        <div class="searching-animation" id="searchingAnimation">
            <div class="searching-pulse">
                <div class="searching-pulse-inner">
                    <i class="fas fa-car"></i>
                </div>
            </div>
            <div class="searching-text">Searching for driver</div>
        </div>
        
        <!-- Passenger Panel -->
        <div class="passenger-panel" id="passengerPanel">
            <div class="panel-collapse-handle" id="panelCollapseHandle"></div>
            
            <div class="nav-buttons">
                <button class="nav-btn active" data-screen="home">
                    <i class="fas fa-home"></i>
                    <span>Home</span>
                </button>
                <button class="nav-btn" data-screen="account">
                    <i class="fas fa-user"></i>
                    <span>Account</span>
                </button>
                <button class="nav-btn" data-screen="history">
                    <i class="fas fa-history"></i>
                    <span>History</span>
                </button>
                <button class="nav-btn" data-screen="emergency">
                    <i class="fas fa-ambulance"></i>
                    <span>Emergency</span>
                </button>
            </div>
            
            <!-- NEW: More Options Button -->
            <button class="more-options-btn" id="moreOptionsBtn">
                <i class="fas fa-ellipsis-h"></i>
                More Options
            </button>
            
            <!-- NEW: More Options Dropdown -->
            <div class="more-options-dropdown" id="moreOptionsDropdown">
                <div class="more-option-item" data-option="order-for-someone">
                    <div class="more-option-icon">
                        <i class="fas fa-user-friends"></i>
                    </div>
                    <div class="more-option-text">Order for Someone Else</div>
                </div>
                <div class="more-option-item" data-option="express-delivery">
                    <div class="more-option-icon">
                        <i class="fas fa-shipping-fast"></i>
                    </div>
                    <div class="more-option-text">Express Delivery</div>
                </div>
                <div class="more-option-item" data-option="light-truck-delivery">
                    <div class="more-option-icon">
                        <i class="fas fa-truck-pickup"></i>
                    </div>
                    <div class="more-option-text">Light Truck Delivery</div>
                </div>
                <div class="more-option-item" data-option="schedule-ride">
                    <div class="more-option-icon">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <div class="more-option-text">Schedule Ride</div>
                </div>
                <div class="more-option-item" data-option="schedule-delivery">
                    <div class="more-option-icon">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div class="more-option-text">Schedule Delivery</div>
                </div>
                <div class="more-option-item" data-option="sos-setup">
                    <div class="more-option-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="more-option-text">SOS Setup</div>
                </div>
            </div>
            
            <!-- Home Screen Content -->
            <div id="homeScreenContent">
                <!-- NEW: Order for Someone Else Form -->
                <div class="order-for-someone-form" id="orderForSomeoneForm">
                    <h4 class="section-title">Order for Someone Else</h4>
                    
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="recipientPickupLocation" placeholder="Pickup location">
                        <div class="suggestion-list" id="recipientPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="recipientDestinationLocation" placeholder="Drop-off location">
                        <div class="suggestion-list" id="recipientDestinationSuggestions"></div>
                    </div>
                    
                    <div class="input-group">
                        <label for="recipientName">Recipient's Full Name</label>
                        <input type="text" id="recipientName" class="input-field" placeholder="Full name">
                    </div>
                    
                    <div class="input-group">
                        <label for="recipientEmail">Recipient's Email</label>
                        <input type="email" id="recipientEmail" class="input-field" placeholder="Email address">
                    </div>
                    
                    <div class="input-group">
                        <label for="recipientPhone">Recipient's Phone Number</label>
                        <input type="tel" id="recipientPhone" class="input-field" placeholder="Phone number">
                    </div>
                    
                    <div class="delivery-fee-display" id="recipientDeliveryFeeDisplay">
                        <p>Delivery Fee</p>
                        <div class="delivery-fee-amount" id="recipientDeliveryFee">K0.00</div>
                        <p class="delivery-eta-display" id="recipientEtaDisplay">ETA: -- min</p>
                    </div>
                    
                    <button class="request-ride-btn" id="orderForSomeoneBtn">Book Ride</button>
                    <button class="btn btn-cancel" id="cancelOrderForSomeoneBtn">Cancel</button>
                </div>
                
                <!-- NEW: Express Delivery Form -->
                <div class="express-delivery-form" id="expressDeliveryForm">
                    <h4 class="section-title">Express Delivery</h4>
                    
                    <div class="input-group">
                        <label for="shopName">Shop or Restaurant Name</label>
                        <input type="text" id="shopName" class="input-field" placeholder="Name of shop or restaurant">
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="shopLocation" placeholder="Shop location">
                        <div class="suggestion-list" id="shopLocationSuggestions"></div>
                    </div>
                    
                    <div class="input-group">
                        <label for="deliveryItems">Items to Purchase</label>
                        <textarea id="deliveryItems" class="input-field" placeholder="List of items to be purchased"></textarea>
                    </div>
                    
                    <div class="input-group">
                        <label for="deliveryAmount">Total Amount to Spend (K)</label>
                        <input type="number" id="deliveryAmount" class="input-field" placeholder="Total amount">
                    </div>
                    
                    <div class="input-group">
                        <label for="deliveryInstructions">Special Instructions</label>
                        <textarea id="deliveryInstructions" class="input-field" placeholder="Any special instructions"></textarea>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="deliveryDestination" placeholder="Delivery destination">
                        <div class="suggestion-list" id="deliveryDestinationSuggestions"></div>
                    </div>
                    
                    <div class="delivery-mode-selection">
                        <div class="delivery-mode-option" data-type="car">
                            <i class="fas fa-car delivery-mode-icon"></i>
                            <span class="delivery-mode-name">Car</span>
                            <span class="delivery-mode-price">Fast & Secure</span>
                        </div>
                        <div class="delivery-mode-option selected" data-type="bike">
                            <i class="fas fa-motorcycle delivery-mode-icon"></i>
                            <span class="delivery-mode-name">Bike</span>
                            <span class="delivery-mode-price">Quick Delivery</span>
                        </div>
                        <div class="delivery-mode-option" data-type="bicycle">
                            <i class="fas fa-bicycle delivery-mode-icon"></i>
                            <span class="delivery-mode-name">Bicycle</span>
                            <span class="delivery-mode-price">Eco Friendly</span>
                        </div>
                    </div>
                    
                    <div class="delivery-fee-display" id="expressDeliveryFeeDisplay">
                        <p>Delivery Fee</p>
                        <div class="delivery-fee-amount" id="expressDeliveryFee">K0.00</div>
                        <p class="delivery-eta-display" id="expressDeliveryEtaDisplay">ETA: -- min</p>
                    </div>
                    
                    <button class="request-ride-btn" id="expressDeliveryBtn">Request Delivery</button>
                    <button class="btn btn-cancel" id="cancelExpressDeliveryBtn">Cancel</button>
                </div>
                
                <!-- NEW: Light Truck Delivery Form -->
                <div class="light-truck-delivery-form" id="lightTruckDeliveryForm">
                    <h4 class="section-title">Light Truck Delivery</h4>
                    
                    <div class="input-group">
                        <label for="truckPickupLocation">Pickup Location</label>
                        <input type="text" id="truckPickupLocation" class="input-field" placeholder="Where to pick up items">
                    </div>
                    
                    <div class="input-group">
                        <label for="truckDestination">Delivery Destination</label>
                        <input type="text" id="truckDestination" class="input-field" placeholder="Where to deliver items">
                    </div>
                    
                    <div class="input-group">
                        <label for="truckItemDescription">Items Description</label>
                        <textarea id="truckItemDescription" class="input-field" placeholder="Describe items to be transported"></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="truckItemWeight">Approx. Weight (kg)</label>
                            <input type="number" id="truckItemWeight" class="input-field" placeholder="Weight">
                        </div>
                        <div class="form-group">
                            <label for="truckItemDimensions">Dimensions (LxWxH)</label>
                            <input type="text" id="truckItemDimensions" class="input-field" placeholder="e.g., 2x1x1">
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label for="truckSpecialRequirements">Special Requirements</label>
                        <textarea id="truckSpecialRequirements" class="input-field" placeholder="Any special handling requirements"></textarea>
                    </div>
                    
                    <div class="delivery-fee-display" id="lightTruckDeliveryFeeDisplay">
                        <p>Delivery Fee</p>
                        <div class="delivery-fee-amount" id="lightTruckDeliveryFee">K0.00</div>
                        <p class="delivery-eta-display" id="lightTruckEtaDisplay">ETA: -- min</p>
                    </div>
                    
                    <button class="request-ride-btn" id="lightTruckDeliveryBtn">Request Light Truck</button>
                    <button class="btn btn-cancel" id="cancelLightTruckDeliveryBtn">Cancel</button>
                </div>
                
                <!-- NEW: SOS Setup Form -->
                <div class="sos-setup-form" id="sosSetupForm">
                    <h4 class="section-title">SOS Setup</h4>
                    
                    <div class="input-group">
                        <label for="emergencyContact1">Emergency Contact 1</label>
                        <input type="tel" id="emergencyContact1" class="input-field" placeholder="Phone number">
                    </div>
                    
                    <div class="input-group">
                        <label for="emergencyContact2">Emergency Contact 2</label>
                        <input type="tel" id="emergencyContact2" class="input-field" placeholder="Phone number">
                    </div>
                    
                    <div class="input-group">
                        <label for="sosMessage">Emergency Message</label>
                        <textarea id="sosMessage" class="input-field" placeholder="Pre-typed emergency message">I need help! My current location and ride details will be shared with you.</textarea>
                    </div>
                    
                    <button class="request-ride-btn" id="saveSosBtn">Save SOS Configuration</button>
                    <button class="btn btn-cancel" id="cancelSosSetupBtn">Cancel</button>
                </div>
                
                <!-- NEW: Schedule Ride Form -->
                <div class="schedule-ride-form" id="scheduleRideForm">
                    <h4 class="section-title">Schedule a Ride</h4>
                    
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="schedulePickupLocation" placeholder="Pickup location">
                        <div class="suggestion-list" id="schedulePickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="scheduleDestinationLocation" placeholder="Destination">
                        <div class="suggestion-list" id="scheduleDestinationSuggestions"></div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="scheduleDate">Date</label>
                            <input type="date" id="scheduleDate" class="input-field" min="<?php echo date('Y-m-d'); ?>">
                        </div>
                        <div class="form-group">
                            <label for="scheduleTime">Time</label>
                            <input type="time" id="scheduleTime" class="input-field">
                        </div>
                    </div>
                    
                    <div class="fare-display" id="scheduleRideFareDisplay">
                        <p>Estimated Fare</p>
                        <div class="fare-amount" id="scheduleRideFare">K0.00</div>
                        <p class="eta-display" id="scheduleRideEtaDisplay">ETA: -- min</p>
                    </div>
                    
                    <button class="request-ride-btn" id="scheduleRideBtn">Schedule Ride</button>
                    <button class="btn btn-cancel" id="cancelScheduleRideBtn">Cancel</button>
                </div>
                
                <!-- NEW: Schedule Delivery Form -->
                <div class="schedule-delivery-form" id="scheduleDeliveryForm">
                    <h4 class="section-title">Schedule a Delivery</h4>
                    
                    <div class="input-group">
                        <label for="scheduleDeliveryItems">Items to Deliver</label>
                        <textarea id="scheduleDeliveryItems" class="input-field" placeholder="Describe items to be delivered"></textarea>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="scheduleDeliveryPickup" placeholder="Pickup location">
                        <div class="suggestion-list" id="scheduleDeliveryPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="scheduleDeliveryDestination" placeholder="Delivery destination">
                        <div class="suggestion-list" id="scheduleDeliveryDestinationSuggestions"></div>
                    </div>
                    
                    <div class="delivery-mode-selection">
                        <div class="delivery-mode-option" data-type="car">
                            <i class="fas fa-car delivery-mode-icon"></i>
                            <span class="delivery-mode-name">Car</span>
                            <span class="delivery-mode-price">Standard</span>
                        </div>
                        <div class="delivery-mode-option selected" data-type="bike">
                            <i class="fas fa-motorcycle delivery-mode-icon"></i>
                            <span class="delivery-mode-name">Bike</span>
                            <span class="delivery-mode-price">Fast</span>
                        </div>
                        <div class="delivery-mode-option" data-type="light-truck">
                            <i class="fas fa-truck-pickup delivery-mode-icon"></i>
                            <span class="delivery-mode-name">Light Truck</span>
                            <span class="delivery-mode-price">Large Items</span>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="scheduleDeliveryDate">Date</label>
                            <input type="date" id="scheduleDeliveryDate" class="input-field" min="<?php echo date('Y-m-d'); ?>">
                        </div>
                        <div class="form-group">
                            <label for="scheduleDeliveryTime">Time</label>
                            <input type="time" id="scheduleDeliveryTime" class="input-field">
                        </div>
                    </div>
                    
                    <div class="delivery-fee-display" id="scheduleDeliveryFeeDisplay">
                        <p>Delivery Fee</p>
                        <div class="delivery-fee-amount" id="scheduleDeliveryFee">K0.00</div>
                        <p class="delivery-eta-display" id="scheduleDeliveryEtaDisplay">ETA: -- min</p>
                    </div>
                    
                    <button class="request-ride-btn" id="scheduleDeliveryBtn">Schedule Delivery</button>
                    <button class="btn btn-cancel" id="cancelScheduleDeliveryBtn">Cancel</button>
                </div>
                
                <!-- NEW: Emergency Services Form -->
                <div class="emergency-services-form" id="emergencyServicesForm">
                    <h4 class="section-title">Emergency Services</h4>
                    
                    <div class="emergency-vehicle-options">
                        <div class="emergency-vehicle-option ambulance" data-type="ambulance">
                            <div class="emergency-vehicle-icon">
                                <i class="fas fa-ambulance"></i>
                            </div>
                            <div class="emergency-vehicle-name">Ambulance</div>
                            <div class="emergency-vehicle-description">Medical emergency transport</div>
                        </div>
                        
                        <div class="emergency-vehicle-option fire-truck" data-type="fire-truck">
                            <div class="emergency-vehicle-icon">
                                <i class="fas fa-fire-truck"></i>
                            </div>
                            <div class="emergency-vehicle-name">Fire Truck</div>
                            <div class="emergency-vehicle-description">Fire emergency response</div>
                        </div>
                        
                        <div class="emergency-vehicle-option emergency-ride" data-type="emergency-ride">
                            <div class="emergency-vehicle-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="emergency-vehicle-name">Emergency Ride</div>
                            <div class="emergency-vehicle-description">Urgent transportation</div>
                        </div>
                        
                        <div class="emergency-vehicle-option emergency-delivery" data-type="emergency-delivery">
                            <div class="emergency-vehicle-icon">
                                <i class="fas fa-shipping-fast"></i>
                            </div>
                            <div class="emergency-vehicle-name">Emergency Delivery</div>
                            <div class="emergency-vehicle-description">Urgent item delivery</div>
                        </div>
                    </div>
                    
                    <button class="btn btn-cancel" id="cancelEmergencyServicesBtn">Cancel</button>
                </div>
                
                <!-- NEW: Emergency Questionnaire -->
                <div class="emergency-questionnaire" id="emergencyQuestionnaire">
                    <h4 class="section-title">Emergency Details</h4>
                    
                    <div class="input-group">
                        <label for="emergencyType">Type of Emergency *</label>
                        <select id="emergencyType" class="input-field" required>
                            <option value="">Select emergency type</option>
                            <option value="medical">Medical Emergency</option>
                            <option value="fire">Fire Emergency</option>
                            <option value="accident">Accident</option>
                            <option value="security">Security Threat</option>
                            <option value="other">Other Emergency</option>
                        </select>
                    </div>
                    
                    <div class="input-group">
                        <label for="emergencySeverity">Severity Level *</label>
                        <select id="emergencySeverity" class="input-field" required>
                            <option value="">Select severity</option>
                            <option value="low">Low - Urgent but not life-threatening</option>
                            <option value="medium">Medium - Serious but stable</option>
                            <option value="high">High - Life-threatening</option>
                            <option value="critical">Critical - Immediate danger</option>
                        </select>
                    </div>
                    
                    <div class="input-group">
                        <label for="emergencyDescription">Description of Emergency *</label>
                        <textarea id="emergencyDescription" class="input-field" placeholder="Describe the emergency situation" required></textarea>
                    </div>
                    
                    <div class="input-group">
                        <label for="emergencyInjuries">Injuries (if any)</label>
                        <textarea id="emergencyInjuries" class="input-field" placeholder="Describe any injuries"></textarea>
                    </div>
                    
                    <div class="input-group">
                        <label for="emergencyPeople">Number of People Involved</label>
                        <input type="number" id="emergencyPeople" class="input-field" placeholder="Number of people" min="1">
                    </div>
                    
                    <div class="delivery-fee-display" id="emergencyFeeDisplay">
                        <p>Emergency Service Fee</p>
                        <div class="delivery-fee-amount" id="emergencyFee">K0.00</div>
                        <p class="delivery-eta-display" id="emergencyEtaDisplay">ETA: -- min</p>
                    </div>
                    
                    <button class="request-ride-btn" id="submitEmergencyBtn">Request Emergency Service</button>
                    <button class="btn btn-cancel" id="cancelEmergencyQuestionnaireBtn">Cancel</button>
                </div>
                
                <!-- Original Ride Request Form -->
                <div class="ride-request-form" id="rideRequestForm">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="pickupLocation" placeholder="Current location" readonly>
                    </div>
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="destinationLocation" placeholder="Where to?">
                        <div class="suggestion-list" id="destinationSuggestions"></div>
                    </div>
                    
                    <div class="saved-locations">
                        <button class="saved-location-btn" data-address="home">
                            <i class="fas fa-home"></i>
                            Home
                        </button>
                        <button class="saved-location-btn" data-address="work">
                            <i class="fas fa-briefcase"></i>
                            Work
                        </button>
                    </div>
                    
                    <!-- Vehicle Selection (Hidden by default) -->
                    <div class="vehicle-selection" id="vehicleSelection">
                        <div class="vehicle-option selected" data-type="car">
                            <i class="fas fa-car vehicle-icon"></i>
                            <span class="vehicle-name">Ride</span>
                            <span class="vehicle-price">Clean Cars</span>
                        </div>
                        <div class="vehicle-option" data-type="bike">
                            <i class="fas fa-motorcycle vehicle-icon"></i>
                            <span class="vehicle-name">Delivery</span>
                            <span class="vehicle-price">on time</span>
                        </div>
                        <div class="vehicle-option" data-type="bicycle">
                            <i class="fas fa-bicycle vehicle-icon"></i>
                            <span class="vehicle-name">Short Delivery</span>
                            <span class="vehicle-price">on time</span>
                        </div>
                    </div>
                    
                    <!-- Package Delivery Form -->
                    <button class="package-toggle" id="packageToggle" style="display: none;">
                        <i class="fas fa-box"></i>
                        Add Package Details
                    </button>
                    
                    <div class="package-form" id="packageForm">
                        <h4 class="section-title">Package Delivery Details</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="receiverName">Receiver Name</label>
                                <input type="text" id="receiverName" placeholder="Full name of receiver">
                            </div>
                            <div class="form-group">
                                <label for="receiverPhone">Receiver Phone</label>
                                <input type="tel" id="receiverPhone" placeholder="Phone number">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="packageDescription">Package Description</label>
                            <input type="text" id="packageDescription" placeholder="What is being delivered?">
                        </div>
                        <div class="form-group">
                            <label for="specialInstructions">Special Instructions</label>
                            <textarea id="specialInstructions" placeholder="Any special handling instructions?"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="packageValue">Package Value (K)</label>
                            <input type="number" id="packageValue" placeholder="Estimated value for insurance">
                        </div>
                    </div>
                    
                    <!-- Fare Display (Hidden by default) -->
                    <div class="fare-display" id="fareDisplay">
                        <p>Estimated Fare</p>
                        <div class="fare-amount" id="estimatedFare">K0.00</div>
                        <p class="eta-display" id="etaDisplay">ETA: -- min</p>
                    </div>
                    
                    <button class="promo-toggle" id="promoToggle">
                        <i class="fas fa-tag"></i>
                        Apply Promo Coupon
                    </button>
                    
                    <div class="promo-section" id="promoSection">
                        <div class="promo-input">
                            <input type="text" id="promoCode" placeholder="Promo code">
                            <button class="btn-promo" id="applyPromoBtn">Apply</button>
                        </div>
                    </div>
                    
                    <!-- Request Ride Button (Hidden by default) -->
                    <button class="request-ride-btn" id="requestRideBtn">Request Ride</button>
                </div>
                
                <!-- Ride Info Panel (Hidden initially) -->
                <div class="ride-info-panel" id="rideInfoPanel">
                    <!-- Driver Details Card -->
                    <div class="driver-details-card" id="driverDetailsCard" style="display: none;">
                        <div class="driver-details-header">
                            <i class="fas fa-id-card"></i>
                            <h3>Driver Details</h3>
                        </div>
                        <div class="driver-details-grid">
                            <div class="driver-detail-item">
                                <span class="driver-detail-label">Driver Name</span>
                                <span class="driver-detail-value" id="driverFullName">John Doe</span>
                            </div>
                            <div class="driver-detail-item">
                                <span class="driver-detail-label">Phone</span>
                                <span class="driver-detail-value" id="driverContactPhone">+260 123 456 789</span>
                            </div>
                            <div class="driver-detail-item">
                                <span class="driver-detail-label">Rating</span>
                                <span class="driver-detail-value" id="driverRatingValue">4.8 </span>
                            </div>
                            <div class="driver-detail-item">
                                <span class="driver-detail-label">Experience</span>
                                <span class="driver-detail-value" id="driverExperience">2 years</span>
                            </div>
                        </div>
                        <div class="driver-vehicle-details">
                            <div class="vehicle-detail-row">
                                <span class="vehicle-detail-label">Vehicle Type</span>
                                <span class="vehicle-detail-value" id="vehicleType">Car</span>
                            </div>
                            <div class="vehicle-detail-row">
                                <span class="vehicle-detail-label">Vehicle Model</span>
                                <span class="vehicle-detail-value" id="vehicleModel">Toyota Corolla</span>
                            </div>
                            <div class="vehicle-detail-row">
                                <span class="vehicle-detail-label">License Plate</span>
                                <span class="vehicle-detail-value" id="vehicleLicense">ABC 123</span>
                            </div>
                            <div class="vehicle-detail-row">
                                <span class="vehicle-detail-label">Color</span>
                                <span class="vehicle-detail-value" id="vehicleColor">Blue</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="driver-info">
                        <div class="driver-avatar" id="driverAvatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="driver-details">
                            <h2 id="driverName">Driver Name</h2>
                            <p><i class="fas fa-phone"></i> <span id="driverPhone">000-000-0000</span></p>
                            <p><i class="fas fa-car"></i> <span id="vehicleDetails">Toyota Corolla - ABC123</span></p>
                            <p><i class="fas fa-star"></i> <span id="driverRating">4.5 </span></p>
                        </div>
                    </div>
                    
                    <div class="trip-details">
                        <div class="location-row">
                            <div class="location-icon pickup-icon">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="location-text">
                                <h4>Pickup Location</h4>
                                <p id="currentPickupLocation">123 Main Street, City</p>
                            </div>
                        </div>
                        <div class="location-row">
                            <div class="location-icon destination-icon">
                                <i class="fas fa-flag"></i>
                            </div>
                            <div class="location-text">
                                <h4>Destination</h4>
                                <p id="currentDestinationLocation">456 Oak Avenue, City</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="fare-details">
                        <div class="fare-row">
                            <span>Base Fare</span>
                            <span id="baseFare">K15.00</span>
                        </div>
                        <div class="fare-row">
                            <span>Distance</span>
                            <span id="distanceFare">K5.00</span>
                        </div>
                        <div class="fare-row">
                            <span>Discount</span>
                            <span id="discountFare">-K2.00</span>
                        </div>
                        <div class="fare-row total">
                            <span>Total Fare</span>
                            <span id="totalFare">K18.00</span>
                        </div>
                    </div>
                    
                    <div class="ride-actions">
                        <button class="btn btn-cancel" id="cancelRideBtn">
                            <i class="fas fa-times-circle"></i>
                            Cancel Ride
                        </button>
                        <button class="btn btn-contact" id="contactDriverBtn">
                            <i class="fas fa-phone"></i>
                            Contact Driver
                        </button>
                        <button class="btn btn-primary" id="viewReceiptBtn" style="display: none;">
                            <i class="fas fa-receipt"></i>
                            View Receipt
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Screen Contents -->
        <div class="screen-content" id="homeScreen">
            <!-- Home screen is the map, so this is empty -->
        </div>
        
        <div class="screen-content" id="accountScreen">
            <div class="screen-header">
                <button class="back-button" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="screen-title">Account</h2>
            </div>
            
            <div class="account-section">
                <div class="account-header">
                    <div class="driver-avatar" id="accountAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="driver-details">
                        <h2 id="accountName">Passenger</h2>
                        <p><i class="fas fa-phone"></i> <span id="accountPhone">Not set</span></p>
                        <p><i class="fas fa-envelope"></i> <span id="accountEmail">Not set</span></p>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="ridesCompleted">0</div>
                        <div class="stat-label">Completed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="ridesCancelled">0</div>
                        <div class="stat-label">Cancelled</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="ridesPending">0</div>
                        <div class="stat-label">Pending</div>
                    </div>
                </div>
                
                <div class="referral-section">
                    <h3 class="section-title">
                        <i class="fas fa-share-alt"></i>
                        Refer & Earn
                    </h3>
                    <p>Share your code and get K25 when friends complete their first ride</p>
                    <div class="referral-code">
                        <div class="code" id="referralCode">JUBEL-XXXX</div>
                        <div class="description">50% discount for new users</div>
                    </div>
                    <button class="btn btn-primary" id="shareReferralBtn">
                        <i class="fas fa-share"></i>
                        Share Referral Code
                    </button>
                </div>
                
                <div class="wallet-section">
                    <h3 class="section-title">
                        <i class="fas fa-wallet"></i>
                        Jubel Wallet
                    </h3>
                    <div class="wallet-balance">
                        <div class="balance-label">Current Balance</div>
                        <div class="balance-amount-large" id="accountBalance">K0.00</div>
                    </div>
                    <div class="wallet-actions">
                        <button class="btn-wallet" id="depositBtn">
                            <i class="fas fa-plus"></i>
                            Deposit
                        </button>
                        <button class="btn-wallet" id="withdrawBtn">
                            <i class="fas fa-minus"></i>
                            Withdraw
                        </button>
                    </div>
                </div>
                
                <div class="contact-section">
                    <button class="contact-btn whatsapp" id="whatsappBtn">
                        <i class="fab fa-whatsapp"></i>
                        WhatsApp
                    </button>
                    <button class="contact-btn phone" id="callBtn">
                        <i class="fas fa-phone"></i>
                        Call Us
                    </button>
                </div>
            </div>
        </div>
        
        <div class="screen-content" id="historyScreen">
            <div class="screen-header">
                <button class="back-button" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="screen-title">Ride History</h2>
            </div>
            
            <div class="filter-options">
                <select id="historyFilter" class="input-field">
                    <option value="all">All Rides</option>
                    <option value="ride">Rides Only</option>
                    <option value="delivery">Deliveries Only</option>
                    <option value="emergency">Emergency Services</option>
                    <option value="completed">Completed</option>
                    <option value="cancelled">Cancelled</option>
                </select>
                <input type="date" id="historyDate" class="input-field">
            </div>
            
            <div class="history-section">
                <div id="historyList">
                    <div class="loading-text">
                        <i class="fas fa-spinner fa-spin"></i>
                        Loading ride history...
                    </div>
                </div>
            </div>
        </div>
        
        <!-- UPDATED: Emergency Services Screen (Replaced Payments) -->
        <div class="screen-content" id="emergencyScreen">
            <div class="screen-header">
                <button class="back-button" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="screen-title">Emergency Services</h2>
            </div>
            
            <div class="emergency-services-section">
                <h3 class="section-title">
                    <i class="fas fa-ambulance"></i>
                    Emergency Vehicles
                </h3>
                
                <div class="emergency-service ambulance" data-type="ambulance">
                    <div class="emergency-icon">
                        <i class="fas fa-ambulance"></i>
                    </div>
                    <div class="emergency-details">
                        <div class="emergency-name">Ambulance Service</div>
                        <div class="emergency-info">Medical emergency transport with trained personnel</div>
                    </div>
                </div>
                
                <div class="emergency-service fire-truck" data-type="fire-truck">
                    <div class="emergency-icon">
                        <i class="fas fa-fire-truck"></i>
                    </div>
                    <div class="emergency-details">
                        <div class="emergency-name">Fire Truck</div>
                        <div class="emergency-info">Fire emergency response with firefighters</div>
                    </div>
                </div>
                
                <div class="emergency-service emergency-ride" data-type="emergency-ride">
                    <div class="emergency-icon">
                        <i class="fas fa-car"></i>
                    </div>
                    <div class="emergency-details">
                        <div class="emergency-name">Emergency Ride</div>
                        <div class="emergency-info">Urgent transportation for emergencies</div>
                    </div>
                </div>
                
                <div class="emergency-service emergency-delivery" data-type="emergency-delivery">
                    <div class="emergency-icon">
                        <i class="fas fa-shipping-fast"></i>
                    </div>
                    <div class="emergency-details">
                        <div class="emergency-name">Emergency Delivery</div>
                        <div class="emergency-info">Urgent delivery of essential items</div>
                    </div>
                </div>
                
                <div class="emergency-service" data-type="sos">
                    <div class="emergency-icon" style="background: var(--error-red);">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="emergency-details">
                        <div class="emergency-name">SOS Emergency</div>
                        <div class="emergency-info">Immediate assistance for critical situations</div>
                    </div>
                </div>
            </div>
            
            <div class="emergency-instructions" style="margin-top: 20px; padding: 15px; background: var(--light-red); border-radius: var(--element-radius);">
                <h3 class="section-title">
                    <i class="fas fa-info-circle"></i>
                    Emergency Instructions
                </h3>
                <p style="font-size: 0.75rem; color: var(--dark-gray); margin-top: 5px;">
                    <strong>Important:</strong> Only use emergency services for genuine emergencies. 
                    Misuse may result in penalties. In case of immediate danger, call 911 first.
                </p>
            </div>
        </div>
    </div>
    
    <!-- Payment Selection Popup -->
    <div id="paymentSelectionPopup" class="popup-overlay hidden">
        <div class="popup-form payment-selection-popup">
            <div class="popup-header">
                <h2 class="popup-title">
                    <i class="fas fa-credit-card"></i>
                    Select Payment Method
                </h2>
                <button class="close-popup" id="closePaymentPopup">&times;</button>
            </div>
            <div class="popup-content">
                <div class="payment-options">
                    <div class="payment-option selected" data-payment-type="wallet">
                        <div class="payment-option-icon">
                            <i class="fas fa-wallet"></i>
                        </div>
                        <div class="payment-option-details">
                            <div class="payment-option-name">Jubel Wallet</div>
                            <div class="payment-option-description">Pay with your Jubel wallet balance</div>
                            <div class="payment-option-balance" id="paymentWalletBalance">Balance: K0.00</div>
                        </div>
                    </div>
                    
                    <div class="payment-option" data-payment-type="mobile">
                        <div class="payment-option-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="payment-option-details">
                            <div class="payment-option-name">Mobile Money</div>
                            <div class="payment-option-description">Pay with Airtel, MTN or Zamtel Money</div>
                        </div>
                    </div>
                    
                    <div class="payment-option" data-payment-type="cash">
                        <div class="payment-option-icon">
                            <i class="fas fa-money-bill"></i>
                        </div>
                        <div class="payment-option-details">
                            <div class="payment-option-name">Cash on Delivery</div>
                            <div class="payment-option-description">Pay with cash when you arrive</div>
                        </div>
                    </div>
                </div>
                
                <div class="insufficient-balance" id="insufficientBalance">
                    <i class="fas fa-exclamation-circle"></i>
                    Insufficient balance in your Jubel wallet
                </div>
                
                <button class="confirm-payment-btn" id="confirmPaymentBtn">
                    Confirm Payment & Request Ride
                </button>
            </div>
        </div>
    </div>
    
    <!-- Ride Details Popup -->
    <div id="rideDetailsPopup" class="popup-overlay hidden">
        <div class="popup-form large-popup">
            <div class="popup-header">
                <h2 class="popup-title">
                    <i class="fas fa-info-circle"></i>
                    Ride Details
                </h2>
                <button class="close-popup" id="closeRidePopupTop">&times;</button>
            </div>
            <div class="popup-content">
                <div class="popup-map-container" id="popupRideMap"></div>
                <div class="popup-details">
                    <div class="detail-row">
                        <span class="detail-label">Pickup:</span>
                        <span class="detail-value" id="popupRidePickup">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Destination:</span>
                        <span class="detail-value" id="popupRideDestination">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Fare:</span>
                        <span class="detail-value" id="popupRideFare">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Distance:</span>
                        <span class="detail-value" id="popupRideDistance">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Ride Type:</span>
                        <span class="detail-value" id="popupRideType">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Status:</span>
                        <span class="detail-value" id="popupRideStatus">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Date & Time:</span>
                        <span class="detail-value" id="popupRideDate">Loading...</span>
                    </div>
                    
                    <!-- Driver Details Section -->
                    <div id="popupDriverDetails" class="driver-details-section hidden">
                        <h3 class="section-title">Driver Information</h3>
                        <div class="detail-row">
                            <span class="detail-label">Driver Name:</span>
                            <span class="detail-value" id="popupDriverName">Loading...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Phone:</span>
                            <span class="detail-value" id="popupDriverPhone">Loading...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Vehicle:</span>
                            <span class="detail-value" id="popupDriverVehicle">Loading...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Rating:</span>
                            <span class="detail-value" id="popupDriverRating">Loading...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Progress:</span>
                            <span class="detail-value" id="popupDriverProgress">Loading...</span>
                        </div>
                    </div>
                    
                    <div class="popup-actions">
                        <button class="btn btn-primary" id="closeRidePopup">
                            <i class="fas fa-times"></i>
                            Close
                        </button>
                        <button class="btn btn-primary" id="viewRideReceiptBtn" style="margin-right: 8px;">
                            <i class="fas fa-receipt"></i>
                            View Receipt
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification"></div>
    
    <!-- Firebase and Leaflet JS -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script>
     <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jubel - Passenger</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Enhanced CSS with white and orange theme */
        :root {
            --primary-orange: #FF6B35;
            --primary-orange-light: #FF9B6B;
            --primary-orange-dark: #E55A28;
            --primary-red: #E74C3C;
            --primary-gradient: linear-gradient(135deg, #FF6B35, #FF9B6B);
            --secondary-orange: #E55A28;
            --secondary-red: #C0392B;
            --light-orange: #FFF5F2;
            --light-red: #FEF2F2;
            --white: #FFFFFF;
            --light-gray: #F9FAFB;
            --medium-gray: #F1F3F4;
            --dark-gray: #333333;
            --text-gray: #666666;
            --success-green: #10B981;
            --warning-yellow: #F59E0B;
            --info-blue: #3B82F6;
            --error-red: #EF4444;
            --border-color: #E5E7EB;
            --shadow-light: 0 2px 10px rgba(0, 0, 0, 0.08);
            --shadow-medium: 0 4px 20px rgba(0, 0, 0, 0.12);
            --shadow-heavy: 0 8px 30px rgba(0, 0, 0, 0.15);
            --app-padding: 16px;
            --element-radius: 16px;
            --button-radius: 12px;
            --input-radius: 12px;
            --card-radius: 20px;
            --transition-speed: 0.25s;
            --ambulance-blue: #0066CC;
            --fire-truck-red: #DC2626;
            --premium-gold: #FBBF24;
            --economy-green: #10B981;
            --light-truck-brown: #92400E;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }
        
        body {
            background-color: var(--white);
            color: var(--dark-gray);
            max-width: 100%;
            overflow-x: hidden;
            height: 100vh;
            font-size: 15px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Main App */
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            filter: saturate(1.1) brightness(1.05);
        }
        
        /* Floating Elements */
        .floating-balance {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--white);
            padding: 12px 18px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            color: var(--dark-gray);
            border: 2px solid var(--light-orange);
            font-size: 14px;
            backdrop-filter: blur(10px);
            transition: all var(--transition-speed) ease;
        }
        
        .floating-balance:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-heavy);
        }
        
        .balance-amount {
            color: var(--primary-orange);
            font-size: 15px;
            font-weight: 700;
        }
        
        /* Enhanced Passenger Panel */
        .passenger-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            border-radius: 30px 30px 0 0;
            box-shadow: 0 -15px 40px rgba(0, 0, 0, 0.15);
            z-index: 100;
            padding: var(--app-padding);
            transform: translateY(0);
            transition: transform var(--transition-speed) cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 50vh;
            overflow-y: auto;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .passenger-panel.collapsed {
            transform: translateY(calc(100% - 50px));
        }
        
        .panel-collapse-handle {
            width: 40px;
            height: 4px;
            background: var(--border-color);
            border-radius: 2px;
            margin: 0 auto 15px;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .panel-collapse-handle:hover {
            background: var(--primary-orange);
            width: 50px;
        }
        
        /* Enhanced Navigation */
        .nav-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 20px;
            padding: 10px;
            background: var(--light-gray);
            border-radius: var(--card-radius);
        }
        
        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 12px 8px;
            border-radius: var(--button-radius);
            background: var(--white);
            cursor: pointer;
            transition: all var(--transition-speed) cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-gray);
            box-shadow: var(--shadow-light);
        }
        
        .nav-btn:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-medium);
        }
        
        .nav-btn.active {
            background: var(--primary-gradient);
            color: var(--white);
            box-shadow: 0 6px 20px rgba(255, 107, 53, 0.3);
        }
        
        .nav-btn i {
            font-size: 18px;
        }
        
        /* Enhanced More Options */
        .more-options-btn {
            width: 100%;
            padding: 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--button-radius);
            background: var(--white);
            color: var(--primary-orange);
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            margin-top: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all var(--transition-speed) ease;
            box-shadow: var(--shadow-light);
        }
        
        .more-options-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
            border-color: var(--primary-orange);
        }
        
        .more-options-dropdown {
            display: none;
            background: var(--white);
            border: 2px solid var(--border-color);
            border-radius: var(--button-radius);
            margin-top: 10px;
            overflow: hidden;
            box-shadow: var(--shadow-medium);
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .more-options-dropdown.active {
            display: block;
        }
        
        .more-option-item {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all var(--transition-speed) ease;
        }
        
        .more-option-item:hover {
            background: var(--light-orange);
            transform: translateX(5px);
        }
        
        .more-option-icon {
            width: 24px;
            text-align: center;
            font-size: 18px;
            color: var(--primary-orange);
        }
        
        .more-option-text {
            flex: 1;
            font-size: 14px;
            font-weight: 600;
            color: var(--dark-gray);
        }
        
        /* Enhanced Forms */
        .form-container {
            display: none;
            flex-direction: column;
            gap: 12px;
            margin-top: 20px;
            padding: 20px;
            border: 2px solid var(--border-color);
            border-radius: var(--card-radius);
            background: var(--white);
            box-shadow: var(--shadow-light);
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .form-container.active {
            display: flex;
        }
        
        /* Enhanced Inputs */
        .location-input {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--input-radius);
            background: var(--white);
            position: relative;
            transition: all var(--transition-speed) ease;
        }
        
        .location-input:focus-within {
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }
        
        .location-input i {
            color: var(--primary-orange);
            font-size: 16px;
        }
        
        .location-input input {
            border: none;
            outline: none;
            width: 100%;
            font-size: 15px;
            background: transparent;
            color: var(--dark-gray);
        }
        
        .location-input input::placeholder {
            color: var(--text-gray);
        }
        
        /* Enhanced Suggestions - Instant Results */
        .suggestion-list {
            position: absolute;
            top: calc(100% + 5px);
            left: 0;
            right: 0;
            background: var(--white);
            border: 2px solid var(--border-color);
            border-radius: var(--input-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            animation: fadeIn 0.2s ease;
        }
        
        .suggestion-list.visible {
            display: block;
        }
        
        .suggestion-item {
            padding: 14px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .suggestion-item:hover {
            background: var(--light-orange);
            transform: translateX(3px);
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
        
        .suggestion-item.selected {
            background: var(--light-orange);
            border-left: 4px solid var(--primary-orange);
        }
        
        .suggestion-icon {
            font-size: 16px;
            width: 24px;
            text-align: center;
            color: var(--primary-orange);
        }
        
        .suggestion-details {
            flex: 1;
        }
        
        .suggestion-name {
            font-weight: 600;
            font-size: 14px;
            color: var(--dark-gray);
            margin-bottom: 4px;
        }
        
        .suggestion-address {
            color: var(--text-gray);
            font-size: 12px;
            line-height: 1.4;
        }
        
        .suggestion-distance {
            color: var(--primary-orange);
            font-size: 11px;
            font-weight: 600;
            margin-top: 4px;
        }
        
        /* Enhanced Vehicle Selection */
        .vehicle-selection {
            display: none;
            gap: 10px;
            margin: 15px 0;
        }
        
        .vehicle-selection.active {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
        }
        
        .vehicle-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 16px 10px;
            border: 2px solid var(--border-color);
            border-radius: var(--button-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            background: var(--white);
        }
        
        .vehicle-option:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-medium);
        }
        
        .vehicle-option.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.15);
        }
        
        .vehicle-icon {
            font-size: 24px;
            color: var(--text-gray);
            transition: all var(--transition-speed) ease;
        }
        
        .vehicle-option.selected .vehicle-icon {
            color: var(--primary-orange);
        }
        
        .vehicle-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--dark-gray);
        }
        
        .vehicle-price {
            font-size: 11px;
            color: var(--text-gray);
        }
        
        /* Enhanced Fare Display */
        .fare-display {
            background: var(--primary-gradient);
            color: var(--white);
            padding: 20px;
            border-radius: var(--card-radius);
            text-align: center;
            margin: 20px 0;
            box-shadow: var(--shadow-medium);
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .fare-display.active {
            display: block;
        }
        
        .fare-amount {
            font-size: 32px;
            font-weight: 800;
            margin: 10px 0;
            letter-spacing: -0.5px;
        }
        
        .eta-display {
            font-size: 14px;
            font-weight: 600;
            opacity: 0.95;
        }
        
        /* Enhanced Buttons */
        .btn {
            padding: 16px;
            border: none;
            border-radius: var(--button-radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-speed) cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-primary {
            background: var(--primary-gradient);
            color: var(--white);
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.25);
        }
        
        .btn-primary:hover {
            box-shadow: 0 6px 25px rgba(255, 107, 53, 0.35);
        }
        
        .btn-secondary {
            background: var(--white);
            color: var(--primary-orange);
            border: 2px solid var(--primary-orange);
        }
        
        .btn-success {
            background: var(--success-green);
            color: var(--white);
        }
        
        .btn-error {
            background: var(--error-red);
            color: var(--white);
        }
        
        .btn-warning {
            background: var(--warning-yellow);
            color: var(--white);
        }
        
        /* Enhanced Request Ride Button */
        .request-ride-btn {
            width: 100%;
            padding: 20px;
            border: none;
            border-radius: var(--button-radius);
            background: var(--primary-gradient);
            color: var(--white);
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-speed) cubic-bezier(0.4, 0, 0.2, 1);
            margin-top: 20px;
            box-shadow: 0 6px 25px rgba(255, 107, 53, 0.3);
            display: none;
        }
        
        .request-ride-btn.active {
            display: block;
        }
        
        .request-ride-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 35px rgba(255, 107, 53, 0.4);
        }
        
        .request-ride-btn:disabled {
            background: var(--text-gray);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* Enhanced Ride Info Panel */
        .ride-info-panel {
            background: var(--white);
            border-radius: var(--card-radius);
            padding: 20px;
            box-shadow: var(--shadow-medium);
            margin-bottom: 20px;
            border: 2px solid var(--border-color);
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .ride-info-panel.active {
            display: block;
        }
        
        .driver-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--light-orange);
            border-radius: var(--button-radius);
        }
        
        .driver-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: var(--white);
            font-weight: 700;
            box-shadow: var(--shadow-medium);
            flex-shrink: 0;
        }
        
        .driver-details h2 {
            font-size: 18px;
            margin-bottom: 5px;
            color: var(--dark-gray);
        }
        
        .driver-details p {
            color: var(--text-gray);
            margin-bottom: 3px;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
        }
        
        /* Enhanced Trip Details */
        .trip-details {
            margin-bottom: 20px;
            padding: 15px;
            background: var(--light-gray);
            border-radius: var(--button-radius);
        }
        
        .location-row {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .location-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            flex-shrink: 0;
        }
        
        .pickup-icon {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .destination-icon {
            background: var(--primary-red);
            color: var(--white);
        }
        
        .location-text {
            flex: 1;
        }
        
        .location-text h4 {
            font-size: 14px;
            margin-bottom: 5px;
            color: var(--dark-gray);
            font-weight: 600;
        }
        
        .location-text p {
            color: var(--text-gray);
            font-size: 13px;
            line-height: 1.5;
        }
        
        /* Enhanced Fare Details */
        .fare-details {
            background: var(--light-orange);
            padding: 20px;
            border-radius: var(--button-radius);
            margin-bottom: 20px;
        }
        
        .fare-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .fare-row.total {
            font-weight: 700;
            font-size: 18px;
            border-top: 2px solid var(--border-color);
            padding-top: 15px;
            margin-top: 15px;
            color: var(--primary-orange);
        }
        
        /* Enhanced Ride Actions */
        .ride-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        /* Enhanced Screens */
        .screen-content {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 50px;
            background: var(--white);
            z-index: 90;
            padding: var(--app-padding);
            overflow-y: auto;
            display: none;
            animation: slideInRight 0.3s ease;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .screen-content.active {
            display: block;
        }
        
        .screen-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            padding: 20px;
            background: var(--white);
            border-radius: var(--card-radius);
            box-shadow: var(--shadow-light);
        }
        
        .back-button {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--light-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            font-size: 18px;
            color: var(--primary-orange);
            transition: all var(--transition-speed) ease;
        }
        
        .back-button:hover {
            transform: translateX(-3px);
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .screen-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--dark-gray);
        }
        
        /* Enhanced Account Section */
        .account-section {
            margin-bottom: 25px;
        }
        
        .section-title {
            font-size: 18px;
            margin-bottom: 15px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--dark-gray);
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
            color: var(--dark-gray);
        }
        
        .input-field {
            width: 100%;
            padding: 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--input-radius);
            font-size: 15px;
            transition: all var(--transition-speed) ease;
            background: var(--white);
            color: var(--dark-gray);
        }
        
        .input-field:focus {
            outline: none;
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }
        
        /* Enhanced Wallet */
        .wallet-balance {
            background: var(--primary-gradient);
            color: var(--white);
            padding: 25px;
            border-radius: var(--card-radius);
            text-align: center;
            margin-bottom: 20px;
            box-shadow: var(--shadow-medium);
        }
        
        .balance-label {
            font-size: 14px;
            margin-bottom: 10px;
            opacity: 0.9;
        }
        
        .balance-amount-large {
            font-size: 42px;
            font-weight: 800;
            margin-bottom: 15px;
            letter-spacing: -1px;
        }
        
        .wallet-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .btn-wallet {
            background: var(--white);
            color: var(--primary-orange);
            border: 2px solid var(--primary-orange);
            padding: 15px;
            font-size: 14px;
            border-radius: var(--button-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .btn-wallet:hover {
            background: var(--primary-orange);
            color: var(--white);
            transform: translateY(-2px);
        }
        
        /* Enhanced History Items with Expandable Details */
        .history-item {
            padding: 20px;
            border: 2px solid var(--border-color);
            border-radius: var(--button-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            margin-bottom: 15px;
            background: var(--white);
            position: relative;
            overflow: hidden;
        }
        
        .history-item:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-medium);
            border-color: var(--primary-orange);
        }
        
        .history-item.expanded {
            border-color: var(--primary-orange);
            box-shadow: var(--shadow-medium);
        }
        
        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .history-item-type {
            font-size: 12px;
            font-weight: 700;
            padding: 6px 12px;
            border-radius: 20px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .history-item-type.ride {
            background: var(--light-orange);
            color: var(--primary-orange);
        }
        
        .history-item-type.delivery {
            background: #E8F5E9;
            color: var(--success-green);
        }
        
        .history-item-type.emergency {
            background: #FFEBEE;
            color: var(--error-red);
        }
        
        .history-locations {
            margin-bottom: 15px;
        }
        
        .history-location {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .history-location i {
            color: var(--primary-orange);
            margin-top: 2px;
        }
        
        .history-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            color: var(--text-gray);
        }
        
        .history-fare {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
        }
        
        .status-completed {
            background: #D1FAE5;
            color: var(--success-green);
        }
        
        .status-cancelled {
            background: #FEE2E2;
            color: var(--error-red);
        }
        
        /* Expanded History Details */
        .history-details {
            display: none;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid var(--border-color);
            animation: slideDown 0.3s ease;
        }
        
        .history-details.expanded {
            display: block;
        }
        
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .detail-item {
            padding: 15px;
            background: var(--light-gray);
            border-radius: var(--input-radius);
        }
        
        .detail-label {
            font-size: 12px;
            color: var(--text-gray);
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .detail-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--dark-gray);
        }
        
        .history-driver-info {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
            background: var(--light-orange);
            border-radius: var(--button-radius);
            margin-bottom: 20px;
        }
        
        .history-driver-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: var(--white);
            font-weight: 700;
            flex-shrink: 0;
        }
        
        .history-driver-details {
            flex: 1;
        }
        
        .history-driver-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .history-driver-rating {
            font-size: 14px;
            color: var(--text-gray);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* Enhanced Emergency Services */
        .emergency-services-section {
            margin-top: 20px;
        }
        
        .emergency-service {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
            border: 2px solid var(--border-color);
            border-radius: var(--button-radius);
            margin-bottom: 15px;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            background: var(--white);
        }
        
        .emergency-service:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-medium);
        }
        
        .emergency-service.ambulance {
            border-color: var(--ambulance-blue);
            background: #EFF6FF;
        }
        
        .emergency-service.fire-truck {
            border-color: var(--fire-truck-red);
            background: #FEF2F2;
        }
        
        .emergency-service.emergency-ride {
            border-color: var(--warning-yellow);
            background: #FFFBEB;
        }
        
        .emergency-service.emergency-delivery {
            border-color: var(--light-truck-brown);
            background: #FEF3C7;
        }
        
        .emergency-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: var(--white);
            flex-shrink: 0;
        }
        
        .emergency-service.ambulance .emergency-icon {
            background: var(--ambulance-blue);
        }
        
        .emergency-service.fire-truck .emergency-icon {
            background: var(--fire-truck-red);
        }
        
        .emergency-service.emergency-ride .emergency-icon {
            background: var(--warning-yellow);
        }
        
        .emergency-service.emergency-delivery .emergency-icon {
            background: var(--light-truck-brown);
        }
        
        .emergency-details {
            flex: 1;
        }
        
        .emergency-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 5px;
            color: var(--dark-gray);
        }
        
        .emergency-info {
            color: var(--text-gray);
            font-size: 14px;
        }
        
        /* Enhanced Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--white);
            border-radius: var(--card-radius);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-heavy);
            animation: scaleIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 25px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--dark-gray);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .close-modal {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            font-size: 20px;
            color: var(--text-gray);
            transition: all var(--transition-speed) ease;
        }
        
        .close-modal:hover {
            background: var(--primary-orange);
            color: var(--white);
            transform: rotate(90deg);
        }
        
        .modal-body {
            padding: 25px;
        }
        
        /* Enhanced Ride Type Selection */
        .ride-type-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 20px 0;
        }
        
        .ride-type-option {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
            border: 2px solid var(--border-color);
            border-radius: var(--button-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            background: var(--white);
        }
        
        .ride-type-option:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-medium);
        }
        
        .ride-type-option.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.15);
        }
        
        .ride-type-option.premium {
            border-color: var(--premium-gold);
            background: linear-gradient(135deg, #FFFBEB, #FEF3C7);
        }
        
        .ride-type-option.economy {
            border-color: var(--economy-green);
            background: linear-gradient(135deg, #ECFDF5, #D1FAE5);
        }
        
        .ride-type-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }
        
        .ride-type-option.premium .ride-type-icon {
            background: var(--premium-gold);
            color: var(--dark-gray);
        }
        
        .ride-type-option.standard .ride-type-icon {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .ride-type-option.economy .ride-type-icon {
            background: var(--economy-green);
            color: var(--white);
        }
        
        .ride-type-details {
            flex: 1;
        }
        
        .ride-type-name {
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 5px;
            color: var(--dark-gray);
        }
        
        .ride-type-description {
            font-size: 14px;
            color: var(--text-gray);
        }
        
        .ride-type-price {
            font-size: 16px;
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        /* Enhanced Countdown Timer */
        .countdown-timer {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-gradient);
            color: var(--white);
            padding: 15px 30px;
            border-radius: var(--button-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 150;
            display: none;
            font-weight: 700;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .countdown-timer.active {
            display: block;
            animation: bounceIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes bounceIn {
            0% { transform: translateX(-50%) scale(0.3); opacity: 0; }
            50% { transform: translateX(-50%) scale(1.05); }
            70% { transform: translateX(-50%) scale(0.9); }
            100% { transform: translateX(-50%) scale(1); opacity: 1; }
        }
        
        .countdown-text {
            font-size: 12px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .countdown-time {
            font-size: 28px;
            font-weight: 800;
            margin: 5px 0;
            font-family: 'Courier New', monospace;
        }
        
        /* Enhanced SOS Button */
        .sos-button {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--error-red);
            color: var(--white);
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 800;
            box-shadow: 0 8px 30px rgba(239, 68, 68, 0.4);
            z-index: 150;
            cursor: pointer;
            animation: sosPulse 2s infinite;
            display: none;
            border: 3px solid rgba(255, 255, 255, 0.3);
        }
        
        @keyframes sosPulse {
            0% { transform: translateX(-50%) scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: translateX(-50%) scale(1.1); box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
            100% { transform: translateX(-50%) scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        
        .sos-button:hover {
            transform: translateX(-50%) scale(1.05);
        }
        
        /* Enhanced Status Indicators */
        .ride-status {
            position: fixed;
            top: 20px;
            left: 20px;
            background: var(--white);
            padding: 12px 20px;
            border-radius: var(--button-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            color: var(--dark-gray);
            border: 2px solid var(--border-color);
            font-size: 14px;
            backdrop-filter: blur(10px);
            display: none;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--medium-gray);
        }
        
        .status-dot.searching {
            background: var(--warning-yellow);
            animation: pulse 1.5s infinite;
        }
        
        .status-dot.arriving {
            background: var(--info-blue);
            animation: pulse 1s infinite;
        }
        
        .status-dot.riding {
            background: var(--success-green);
        }
        
        /* Enhanced Estimated Time */
        .estimated-time {
            position: fixed;
            top: 80px;
            left: 20px;
            background: var(--white);
            padding: 12px 20px;
            border-radius: var(--button-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            color: var(--dark-gray);
            border: 2px solid var(--border-color);
            font-size: 14px;
            backdrop-filter: blur(10px);
            display: none;
        }
        
        /* Enhanced Emergency Ride Status */
        .emergency-ride-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--error-red);
            color: var(--white);
            padding: 12px 20px;
            border-radius: var(--button-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 100;
            display: none;
            font-weight: 700;
            font-size: 14px;
            animation: emergencyPulse 1s infinite;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        @keyframes emergencyPulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        /* Enhanced Payment Selection */
        .payment-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 20px 0;
        }
        
        .payment-option {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
            border: 2px solid var(--border-color);
            border-radius: var(--button-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            background: var(--white);
        }
        
        .payment-option:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-medium);
        }
        
        .payment-option.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.15);
        }
        
        .payment-option-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: var(--text-gray);
            flex-shrink: 0;
        }
        
        .payment-option.selected .payment-option-icon {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .payment-option-details {
            flex: 1;
        }
        
        .payment-option-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 5px;
            color: var(--dark-gray);
        }
        
        .payment-option-description {
            color: var(--text-gray);
            font-size: 14px;
        }
        
        .payment-option-balance {
            font-size: 15px;
            font-weight: 700;
            color: var(--primary-orange);
            margin-top: 5px;
        }
        
        /* Enhanced Loading Animation */
        .searching-animation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 200;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .searching-pulse {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: rgba(255, 107, 53, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulseRing 2s infinite;
            position: relative;
        }
        
        .searching-pulse-inner {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: var(--primary-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 28px;
        }
        
        .searching-text {
            margin-top: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 25px;
            border-radius: var(--button-radius);
            font-weight: 600;
            color: var(--primary-orange);
            box-shadow: var(--shadow-medium);
            font-size: 16px;
        }
        
        /* Enhanced Delivery Fee Display */
        .delivery-fee-display {
            background: var(--primary-gradient);
            color: var(--white);
            padding: 20px;
            border-radius: var(--card-radius);
            text-align: center;
            margin: 20px 0;
            display: none;
            box-shadow: var(--shadow-medium);
        }
        
        .delivery-fee-display.active {
            display: block;
        }
        
        .delivery-fee-amount {
            font-size: 36px;
            font-weight: 800;
            margin: 10px 0;
        }
        
        .delivery-eta-display {
            font-size: 16px;
            font-weight: 600;
            opacity: 0.95;
        }
        
        /* Enhanced Form Groups */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-group {
            flex: 1;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
            color: var(--dark-gray);
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--input-radius);
            font-size: 15px;
            transition: all var(--transition-speed) ease;
            background: var(--white);
            color: var(--dark-gray);
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }
        
        /* Enhanced Promo Section */
        .promo-section {
            margin-top: 20px;
            padding: 20px;
            border: 2px dashed var(--border-color);
            border-radius: var(--card-radius);
            display: none;
        }
        
        .promo-section.active {
            display: block;
        }
        
        .promo-input {
            display: flex;
            gap: 12px;
        }
        
        .promo-input input {
            flex: 1;
            padding: 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--input-radius);
            font-size: 15px;
        }
        
        .btn-promo {
            background: var(--primary-orange);
            color: var(--white);
            border: none;
            border-radius: var(--button-radius);
            padding: 16px 24px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all var(--transition-speed) ease;
        }
        
        .btn-promo:hover {
            background: var(--primary-orange-dark);
            transform: translateY(-2px);
        }
        
        /* Enhanced Saved Locations */
        .saved-locations {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 20px 0;
        }
        
        .saved-location-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--button-radius);
            background: var(--white);
            cursor: pointer;
            font-size: 14px;
            transition: all var(--transition-speed) ease;
            color: var(--dark-gray);
        }
        
        .saved-location-btn:hover {
            border-color: var(--primary-orange);
            transform: translateY(-2px);
            box-shadow: var(--shadow-light);
        }
        
        .saved-location-btn i {
            color: var(--primary-orange);
        }
        
        /* Enhanced Filter Options */
        .filter-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        /* Enhanced Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: var(--white);
            padding: 20px;
            border-radius: var(--button-radius);
            text-align: center;
            box-shadow: var(--shadow-light);
            transition: all var(--transition-speed) ease;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-medium);
        }
        
        .stat-number {
            font-size: 28px;
            font-weight: 800;
            color: var(--primary-orange);
            margin-bottom: 8px;
        }
        
        .stat-label {
            font-size: 12px;
            color: var(--text-gray);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* Enhanced Referral Section */
        .referral-section {
            background: var(--light-orange);
            padding: 25px;
            border-radius: var(--card-radius);
            margin-bottom: 25px;
            box-shadow: var(--shadow-light);
        }
        
        .referral-code {
            background: var(--white);
            padding: 20px;
            border-radius: var(--button-radius);
            text-align: center;
            margin: 20px 0;
            box-shadow: var(--shadow-light);
        }
        
        .code {
            font-size: 28px;
            font-weight: 800;
            color: var(--primary-orange);
            letter-spacing: 2px;
        }
        
        .description {
            font-size: 14px;
            color: var(--text-gray);
            margin-top: 10px;
        }
        
        /* Enhanced Contact Section */
        .contact-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 25px;
        }
        
        .contact-btn {
            padding: 18px;
            border: none;
            border-radius: var(--button-radius);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .contact-btn.whatsapp {
            background: #25D366;
            color: white;
        }
        
        .contact-btn.phone {
            background: var(--info-blue);
            color: white;
        }
        
        .contact-btn:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-medium);
        }
        
        /* Enhanced Notification */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-gradient);
            color: var(--white);
            padding: 15px 30px;
            border-radius: var(--button-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 300;
            display: none;
            font-weight: 600;
            text-align: center;
            font-size: 15px;
            max-width: 90%;
            backdrop-filter: blur(10px);
            animation: slideDown 0.3s ease;
        }
        
        /* Enhanced Map Markers */
        .driver-marker {
            background: var(--primary-gradient);
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            border: 3px solid white;
        }
        
        .ambulance-marker {
            background: var(--ambulance-blue);
            color: white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            box-shadow: 0 4px 20px rgba(0, 102, 204, 0.4);
            border: 3px solid white;
        }
        
        .fire-truck-marker {
            background: var(--fire-truck-red);
            color: white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            box-shadow: 0 4px 20px rgba(220, 38, 38, 0.4);
            border: 3px solid white;
        }
        
        .pickup-marker {
            background: var(--primary-orange);
            color: white;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            border: 2px solid white;
        }
        
        .destination-marker {
            background: var(--primary-red);
            color: white;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            border: 2px solid white;
        }
        
        .current-location-marker {
            background: var(--info-blue);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            border: 2px solid white;
        }
        
        /* Enhanced Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--light-gray);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary-orange);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-orange-dark);
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            :root {
                --app-padding: 12px;
                --element-radius: 14px;
                --button-radius: 10px;
                --input-radius: 10px;
                --card-radius: 16px;
            }
            
            .fare-amount {
                font-size: 28px;
            }
            
            .balance-amount-large {
                font-size: 36px;
            }
            
            .code {
                font-size: 24px;
            }
            
            .vehicle-selection.active {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .detail-grid {
                grid-template-columns: 1fr;
            }
            
            .filter-options {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 480px) {
            .nav-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .ride-actions {
                grid-template-columns: 1fr;
            }
            
            .wallet-actions {
                grid-template-columns: 1fr;
            }
            
            .contact-section {
                grid-template-columns: 1fr;
            }
            
            .promo-input {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Main App -->
    <div id="mainApp">
        <!-- Main Map -->
        <div id="map"></div>
        
        <!-- Floating Elements -->
        <div class="floating-balance home-only">
            <i class="fas fa-wallet"></i>
            <span>Balance: <span class="balance-amount" id="walletBalance">K0.00</span></span>
        </div>
        
        <div class="ride-status home-only" id="rideStatus">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Searching for driver</span>
        </div>
        
        <div class="emergency-ride-status" id="emergencyRideStatus">
            <i class="fas fa-exclamation-triangle"></i>
            <span>EMERGENCY RIDE IN PROGRESS</span>
        </div>
        
        <div class="estimated-time home-only" id="estimatedTime">
            <i class="fas fa-clock"></i>
            <span id="timeText">5 min</span>
        </div>
        
        <div class="countdown-timer" id="countdownTimer">
            <div class="countdown-text">Scheduled Ride In:</div>
            <div class="countdown-time" id="countdownTime">00:00:00</div>
        </div>
        
        <div class="sos-button" id="sosButton">
            SOS
        </div>
        
        <!-- Modals -->
        <div class="modal" id="rideTypeModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">
                        <i class="fas fa-car"></i>
                        Select Ride Type
                    </h2>
                    <button class="close-modal" id="closeRideTypeModal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="ride-type-options">
                        <div class="ride-type-option premium" data-type="premium">
                            <div class="ride-type-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="ride-type-details">
                                <div class="ride-type-name">Premium Ride</div>
                                <div class="ride-type-description">Luxury vehicles with premium service</div>
                            </div>
                            <div class="ride-type-price">+50%</div>
                        </div>
                        
                        <div class="ride-type-option standard selected" data-type="standard">
                            <div class="ride-type-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="ride-type-details">
                                <div class="ride-type-name">Standard Ride</div>
                                <div class="ride-type-description">Comfortable and reliable service</div>
                            </div>
                            <div class="ride-type-price">Base Price</div>
                        </div>
                        
                        <div class="ride-type-option economy" data-type="economy">
                            <div class="ride-type-icon">
                                <i class="fas fa-car-side"></i>
                            </div>
                            <div class="ride-type-details">
                                <div class="ride-type-name">Economy Ride</div>
                                <div class="ride-type-description">Budget-friendly option</div>
                            </div>
                            <div class="ride-type-price">-30%</div>
                        </div>
                    </div>
                    <button class="btn btn-primary" id="selectRideTypeBtn" style="width: 100%; margin-top: 20px;">
                        Select Ride Type
                    </button>
                </div>
            </div>
        </div>
        
        <div class="modal" id="receiptModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">
                        <i class="fas fa-receipt"></i>
                        Ride Receipt
                    </h2>
                    <button class="close-modal" id="closeReceiptBtn">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="receipt-content" id="receiptContent">
                        <!-- Receipt content will be generated here -->
                    </div>
                    <button class="btn btn-success" id="downloadReceiptBtn" style="width: 100%; margin-top: 20px;">
                        <i class="fas fa-download"></i>
                        Download Receipt
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Loading Animation -->
        <div class="searching-animation" id="searchingAnimation">
            <div class="searching-pulse">
                <div class="searching-pulse-inner">
                    <i class="fas fa-car"></i>
                </div>
            </div>
            <div class="searching-text">Searching for driver</div>
        </div>
        
        <!-- Passenger Panel -->
        <div class="passenger-panel" id="passengerPanel">
            <div class="panel-collapse-handle" id="panelCollapseHandle"></div>
            
            <div class="nav-buttons">
                <button class="nav-btn active" data-screen="home">
                    <i class="fas fa-home"></i>
                    <span>Home</span>
                </button>
                <button class="nav-btn" data-screen="account">
                    <i class="fas fa-user"></i>
                    <span>Account</span>
                </button>
                <button class="nav-btn" data-screen="history">
                    <i class="fas fa-history"></i>
                    <span>History</span>
                </button>
                <button class="nav-btn" data-screen="emergency">
                    <i class="fas fa-ambulance"></i>
                    <span>Emergency</span>
                </button>
            </div>
            
            <button class="more-options-btn" id="moreOptionsBtn">
                <i class="fas fa-ellipsis-h"></i>
                More Options
            </button>
            
            <div class="more-options-dropdown" id="moreOptionsDropdown">
                <div class="more-option-item" data-option="order-for-someone">
                    <div class="more-option-icon">
                        <i class="fas fa-user-friends"></i>
                    </div>
                    <div class="more-option-text">Order for Someone Else</div>
                </div>
                <div class="more-option-item" data-option="express-delivery">
                    <div class="more-option-icon">
                        <i class="fas fa-shipping-fast"></i>
                    </div>
                    <div class="more-option-text">Express Delivery</div>
                </div>
                <div class="more-option-item" data-option="light-truck-delivery">
                    <div class="more-option-icon">
                        <i class="fas fa-truck-pickup"></i>
                    </div>
                    <div class="more-option-text">Light Truck Delivery</div>
                </div>
                <div class="more-option-item" data-option="schedule-ride">
                    <div class="more-option-icon">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <div class="more-option-text">Schedule Ride</div>
                </div>
                <div class="more-option-item" data-option="schedule-delivery">
                    <div class="more-option-icon">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div class="more-option-text">Schedule Delivery</div>
                </div>
                <div class="more-option-item" data-option="sos-setup">
                    <div class="more-option-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="more-option-text">SOS Setup</div>
                </div>
            </div>
            
            <!-- Home Screen Content -->
            <div id="homeScreenContent">
                <!-- Original Ride Request Form -->
                <div class="form-container active" id="rideRequestForm">
                    <h3 class="section-title">
                        <i class="fas fa-car"></i>
                        Book a Ride
                    </h3>
                    
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="pickupLocation" placeholder="Current location" readonly>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="destinationLocation" placeholder="Where to?" autocomplete="off">
                        <div class="suggestion-list" id="destinationSuggestions"></div>
                    </div>
                    
                    <div class="saved-locations">
                        <button class="saved-location-btn" data-address="home">
                            <i class="fas fa-home"></i>
                            Home
                        </button>
                        <button class="saved-location-btn" data-address="work">
                            <i class="fas fa-briefcase"></i>
                            Work
                        </button>
                    </div>
                    
                    <div class="vehicle-selection" id="vehicleSelection">
                        <div class="vehicle-option selected" data-type="car">
                            <i class="fas fa-car vehicle-icon"></i>
                            <span class="vehicle-name">Car</span>
                            <span class="vehicle-price">Standard</span>
                        </div>
                        <div class="vehicle-option" data-type="bike">
                            <i class="fas fa-motorcycle vehicle-icon"></i>
                            <span class="vehicle-name">Bike</span>
                            <span class="vehicle-price">Fast</span>
                        </div>
                        <div class="vehicle-option" data-type="bicycle">
                            <i class="fas fa-bicycle vehicle-icon"></i>
                            <span class="vehicle-name">Bicycle</span>
                            <span class="vehicle-price">Eco</span>
                        </div>
                    </div>
                    
                    <div class="fare-display" id="fareDisplay">
                        <p>Estimated Fare</p>
                        <div class="fare-amount" id="estimatedFare">K0.00</div>
                        <p class="eta-display" id="etaDisplay">ETA: -- min</p>
                    </div>
                    
                    <button class="more-options-btn" id="promoToggle">
                        <i class="fas fa-tag"></i>
                        Apply Promo Code
                    </button>
                    
                    <div class="promo-section" id="promoSection">
                        <div class="promo-input">
                            <input type="text" id="promoCode" placeholder="Enter promo code">
                            <button class="btn-promo" id="applyPromoBtn">Apply</button>
                        </div>
                    </div>
                    
                    <button class="request-ride-btn" id="requestRideBtn">
                        <i class="fas fa-car"></i>
                        Request Ride
                    </button>
                </div>
                
                <!-- Additional forms (order for someone, delivery, etc.) -->
                <div class="form-container" id="orderForSomeoneForm">
                    <!-- Form content -->
                </div>
                
                <div class="form-container" id="expressDeliveryForm">
                    <!-- Form content -->
                </div>
                
                <!-- Ride Info Panel -->
                <div class="ride-info-panel" id="rideInfoPanel">
                    <!-- Ride info content -->
                </div>
            </div>
        </div>
        
        <!-- Screen Contents -->
        <div class="screen-content" id="accountScreen">
            <div class="screen-header">
                <button class="back-button" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="screen-title">Account</h2>
            </div>
            
            <div class="account-section">
                <!-- Account content -->
            </div>
        </div>
        
        <div class="screen-content" id="historyScreen">
            <div class="screen-header">
                <button class="back-button" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="screen-title">Ride History</h2>
            </div>
            
            <div class="filter-options">
                <select id="historyFilter" class="input-field">
                    <option value="all">All Rides</option>
                    <option value="ride">Rides Only</option>
                    <option value="delivery">Deliveries Only</option>
                    <option value="emergency">Emergency Services</option>
                    <option value="completed">Completed</option>
                    <option value="cancelled">Cancelled</option>
                </select>
                <input type="date" id="historyDate" class="input-field">
            </div>
            
            <div class="history-section">
                <div id="historyList">
                    <!-- History items will be loaded here -->
                </div>
            </div>
        </div>
        
        <div class="screen-content" id="emergencyScreen">
            <div class="screen-header">
                <button class="back-button" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="screen-title">Emergency Services</h2>
            </div>
            
            <div class="emergency-services-section">
                <!-- Emergency services content -->
            </div>
        </div>
    </div>
    
    <!-- Payment Selection Modal -->
    <div class="modal" id="paymentSelectionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-credit-card"></i>
                    Select Payment Method
                </h2>
                <button class="close-modal" id="closePaymentModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="payment-options">
                    <div class="payment-option selected" data-payment-type="wallet">
                        <div class="payment-option-icon">
                            <i class="fas fa-wallet"></i>
                        </div>
                        <div class="payment-option-details">
                            <div class="payment-option-name">Jubel Wallet</div>
                            <div class="payment-option-description">Pay with your Jubel wallet balance</div>
                            <div class="payment-option-balance" id="paymentWalletBalance">Balance: K0.00</div>
                        </div>
                    </div>
                    
                    <div class="payment-option" data-payment-type="mobile">
                        <div class="payment-option-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="payment-option-details">
                            <div class="payment-option-name">Mobile Money</div>
                            <div class="payment-option-description">Pay with Airtel, MTN or Zamtel Money</div>
                        </div>
                    </div>
                    
                    <div class="payment-option" data-payment-type="cash">
                        <div class="payment-option-icon">
                            <i class="fas fa-money-bill"></i>
                        </div>
                        <div class="payment-option-details">
                            <div class="payment-option-name">Cash on Delivery</div>
                            <div class="payment-option-description">Pay with cash when you arrive</div>
                        </div>
                    </div>
                </div>
                
                <div id="insufficientBalance" class="notification" style="display: none; margin: 15px 0; background: var(--error-red);">
                    <i class="fas fa-exclamation-circle"></i>
                    Insufficient balance in your Jubel wallet
                </div>
                
                <button class="btn btn-primary" id="confirmPaymentBtn" style="width: 100%; margin-top: 20px;">
                    Confirm Payment & Request Ride
                </button>
            </div>
        </div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification"></div>
    
    <!-- Firebase and Leaflet JS -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script>
        // Enhanced Firebase configuration with better performance
        const firebaseConfig = {
            apiKey: "AIzaSyDEACX_P4c5q7djJAcA0I7Lk7leO2TlQ74",
            authDomain: "jubel-13e1a.firebaseapp.com",
            databaseURL: "https://jubel-13e1a-default-rtdb.firebaseio.com",
            projectId: "jubel-13e1a",
            storageBucket: "jubel-13e1a.firebasestorage.app",
            messagingSenderId: "882241095445",
            appId: "1:882241095445:web:ee9ca40fddd008ca910b1c",
            measurementId: "G-J5JPKL6B5F"
        };

        // Initialize Firebase with performance monitoring
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        // Enhanced app state management
        const AppState = {
            currentUser: null,
            currentRide: null,
            passengerMap: null,
            userLocation: null,
            currentCity: "Lusaka",
            walletBalance: 0,
            userData: null,
            selectedVehicleType: 'car',
            selectedRideType: 'standard',
            selectedPaymentType: 'wallet',
            appliedPromoCode: null,
            rideFare: 0,
            currentScreen: 'home',
            activeMoreOption: null,
            sosConfig: null,
            emergencyMode: false,
            scheduledRides: [],
            countdownInterval: null,
            currentScheduledRide: null,
            activeRideRestored: false,
            
            // Enhanced search state
            searchCache: new Map(),
            instantSearchEnabled: true,
            searchDebounceTimers: new Map(),
            
            // Enhanced location state
            locationWatchId: null,
            locationUpdateInterval: null,
            
            // Enhanced UI state
            markers: {
                currentLocation: null,
                pickup: null,
                destination: null,
                driver: null,
                emergencyVehicle: null,
                routePolyline: null
            },
            
            // Enhanced listeners
            listeners: {
                driverAssignment: null,
                rideStatus: null,
                driverLocation: null,
                walletBalance: null,
                rideHistory: null,
                scheduledRides: null
            },
            
            // Enhanced ride request
            currentRideRequestData: null,
            currentRideRequestType: 'standard',
            
            // Enhanced pricing configuration
            pricing: {
                baseFare: 23,
                perMeterRate: 0.011, // K1 per 90 meters
                rideTypeMultipliers: {
                    premium: 1.5,
                    standard: 1.0,
                    economy: 0.7
                },
                vehicleTypeMultipliers: {
                    car: 1.0,
                    bike: 0.7,
                    bicycle: 0.5,
                    'light-truck': 1.8
                },
                emergencyBaseFares: {
                    ambulance: 500,
                    'fire-truck': 1000,
                    'emergency-ride': 200,
                    'emergency-delivery': 300,
                    sos: 1000
                }
            }
        };

        // Zambian cities with enhanced data for instant search
        const ZambianCities = {
            cities: [
                'Lusaka', 'Kitwe', 'Ndola', 'Kabwe', 'Chipata', 'Chingola',
                'Mufulira', 'Luanshya', 'Livingstone', 'Kasama', 'Solwezi',
                'Kapiri Mposhi', 'Chililabombwe', 'Mongu', 'Mazabuka', 'Kafue'
            ],
            
            aliases: {
                'lsk': 'Lusaka',
                'kit': 'Kitwe',
                'ndo': 'Ndola',
                'kab': 'Kabwe',
                'chi': 'Chipata',
                'muf': 'Mufulira',
                'lua': 'Luanshya',
                'liv': 'Livingstone',
                'kas': 'Kasama',
                'sol': 'Solwezi',
                'kap': 'Kapiri Mposhi',
                'chili': 'Chililabombwe'
            },
            
            boundaries: {
                'Lusaka': { lat: -15.4167, lng: 28.2833, radius: 25000 },
                'Kitwe': { lat: -12.8139, lng: 28.2136, radius: 20000 },
                'Ndola': { lat: -12.9667, lng: 28.6333, radius: 20000 },
                'Kabwe': { lat: -14.4333, lng: 28.4500, radius: 15000 },
                'Chipata': { lat: -13.6333, lng: 32.6500, radius: 15000 },
                'Livingstone': { lat: -17.8500, lng: 25.8667, radius: 15000 }
            }
        };

        // Enhanced search index for instant results
        class InstantSearchIndex {
            constructor() {
                this.index = new Map();
                this.cache = new Map();
                this.maxCacheSize = 1000;
                this.initializeIndex();
            }
            
            initializeIndex() {
                // Initialize with Zambian cities
                ZambianCities.cities.forEach(city => {
                    this.addToIndex(city, {
                        type: 'city',
                        name: city,
                        display_name: `${city}, Zambia`,
                        lat: ZambianCities.boundaries[city]?.lat || -15.4167,
                        lon: ZambianCities.boundaries[city]?.lng || 28.2833
                    });
                });
            }
            
            addToIndex(key, value) {
                const normalizedKey = this.normalizeKey(key);
                if (!this.index.has(normalizedKey)) {
                    this.index.set(normalizedKey, []);
                }
                this.index.get(normalizedKey).push(value);
            }
            
            normalizeKey(key) {
                return key.toLowerCase().trim().replace(/[^a-z0-9\s]/g, '');
            }
            
            search(query, limit = 10) {
                const normalizedQuery = this.normalizeKey(query);
                
                // Check cache first
                if (this.cache.has(normalizedQuery)) {
                    return Promise.resolve(this.cache.get(normalizedQuery).slice(0, limit));
                }
                
                // Check index for exact matches
                let results = [];
                if (this.index.has(normalizedQuery)) {
                    results = this.index.get(normalizedQuery);
                }
                
                // Check for partial matches
                if (results.length < limit) {
                    for (const [key, values] of this.index) {
                        if (key.includes(normalizedQuery) && normalizedQuery.length >= 2) {
                            results.push(...values.filter(v => !results.includes(v)));
                        }
                        if (results.length >= limit) break;
                    }
                }
                
                // If we have instant results, return them and fetch more in background
                if (results.length > 0) {
                    // Cache the results
                    this.cache.set(normalizedQuery, results);
                    
                    // Clean cache if needed
                    if (this.cache.size > this.maxCacheSize) {
                        const firstKey = this.cache.keys().next().value;
                        this.cache.delete(firstKey);
                    }
                    
                    // Fetch additional results in background
                    this.fetchExternalResults(query).then(externalResults => {
                        if (externalResults.length > 0) {
                            // Add to index for future searches
                            externalResults.forEach(result => {
                                this.addToIndex(result.display_name, result);
                            });
                            
                            // Update cache
                            const cached = this.cache.get(normalizedQuery) || [];
                            this.cache.set(normalizedQuery, [...cached, ...externalResults]);
                        }
                    });
                    
                    return Promise.resolve(results.slice(0, limit));
                }
                
                // No instant results, fetch from external source
                return this.fetchExternalResults(query, limit);
            }
            
            async fetchExternalResults(query, limit = 10) {
                try {
                    const searchQuery = query + (AppState.currentCity ? `, ${AppState.currentCity}, Zambia` : ', Zambia');
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&limit=${limit}&countrycodes=zm&dedupe=1`);
                    
                    if (!response.ok) {
                        throw new Error(`Search API error: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    return data.map(place => ({
                        ...place,
                        displayLat: parseFloat(place.lat),
                        displayLon: parseFloat(place.lon),
                        city: this.extractCity(place),
                        isCurrentCity: this.extractCity(place) === AppState.currentCity
                    }));
                } catch (error) {
                    console.error('External search error:', error);
                    return [];
                }
            }
            
            extractCity(place) {
                if (place.address) {
                    return place.address.city || place.address.town || place.address.village || AppState.currentCity;
                }
                return AppState.currentCity;
            }
        }

        // Initialize the search index
        const searchIndex = new InstantSearchIndex();

        // Enhanced price calculator
        class PriceCalculator {
            static calculateFare(distanceMeters, options = {}) {
                const config = AppState.pricing;
                let fare = config.baseFare;
                
                // Add distance-based fare
                if (distanceMeters > 0) {
                    fare += Math.ceil(distanceMeters * config.perMeterRate);
                }
                
                // Apply ride type multiplier
                const rideType = options.rideType || AppState.selectedRideType;
                fare *= config.rideTypeMultipliers[rideType] || 1;
                
                // Apply vehicle type multiplier
                const vehicleType = options.vehicleType || AppState.selectedVehicleType;
                fare *= config.vehicleTypeMultipliers[vehicleType] || 1;
                
                // Apply promo discount
                if (AppState.appliedPromoCode && AppState.appliedPromoCode.startsWith('JUBEL-')) {
                    fare *= 0.8; // 20% discount
                }
                
                // Round to 2 decimal places
                return Math.round(fare * 100) / 100;
            }
            
            static calculateETA(distanceMeters, vehicleType = 'car') {
                const speeds = {
                    car: 40, // km/h
                    bike: 35,
                    bicycle: 15,
                    'light-truck': 30
                };
                
                const speed = speeds[vehicleType] || 30;
                const hours = (distanceMeters / 1000) / speed;
                const minutes = Math.ceil(hours * 60);
                return Math.max(5, minutes); // Minimum 5 minutes
            }
            
            static calculateEmergencyFare(vehicleType, distanceMeters = 0) {
                const config = AppState.pricing;
                let fare = config.emergencyBaseFares[vehicleType] || 200;
                
                if (distanceMeters > 0) {
                    fare += Math.ceil(distanceMeters * 0.02); // Higher rate for emergencies
                }
                
                return fare;
            }
        }

        // Enhanced map manager
        class MapManager {
            constructor() {
                this.map = null;
                this.markers = new Map();
                this.routes = new Map();
                this.initializeMap();
            }
            
            initializeMap() {
                this.map = L.map('map').setView([-15.4167, 28.2833], 13);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: ' OpenStreetMap contributors',
                    maxZoom: 19,
                    minZoom: 3
                }).addTo(this.map);
                
                // Add scale control
                L.control.scale().addTo(this.map);
            }
            
            addMarker(id, latlng, options = {}) {
                if (this.markers.has(id)) {
                    this.markers.get(id).setLatLng(latlng);
                    return this.markers.get(id);
                }
                
                const icon = this.createIcon(options.type || 'default', options);
                const marker = L.marker(latlng, { icon }).addTo(this.map);
                
                if (options.popup) {
                    marker.bindPopup(options.popup);
                }
                
                this.markers.set(id, marker);
                return marker;
            }
            
            createIcon(type, options = {}) {
                const icons = {
                    'current-location': {
                        className: 'current-location-marker',
                        html: '<div class="current-location-marker"><i class="fas fa-user"></i></div>',
                        iconSize: [24, 24]
                    },
                    'pickup': {
                        className: 'pickup-marker',
                        html: '<div class="pickup-marker"><i class="fas fa-map-marker-alt"></i></div>',
                        iconSize: [28, 28]
                    },
                    'destination': {
                        className: 'destination-marker',
                        html: '<div class="destination-marker"><i class="fas fa-flag"></i></div>',
                        iconSize: [28, 28]
                    },
                    'driver': {
                        className: 'driver-marker',
                        html: '<div class="driver-marker"></div>',
                        iconSize: [40, 40]
                    },
                    'ambulance': {
                        className: 'ambulance-marker',
                        html: '<div class="ambulance-marker"><i class="fas fa-ambulance"></i></div>',
                        iconSize: [50, 50]
                    },
                    'fire-truck': {
                        className: 'fire-truck-marker',
                        html: '<div class="fire-truck-marker"><i class="fas fa-fire-truck"></i></div>',
                        iconSize: [50, 50]
                    },
                    'default': {
                        className: 'default-marker',
                        html: '<div class="default-marker"><i class="fas fa-map-pin"></i></div>',
                        iconSize: [30, 30]
                    }
                };
                
                const iconConfig = icons[type] || icons.default;
                return L.divIcon({
                    className: iconConfig.className,
                    html: iconConfig.html,
                    iconSize: iconConfig.iconSize,
                    iconAnchor: [iconConfig.iconSize[0] / 2, iconConfig.iconSize[1] / 2],
                    popupAnchor: [0, -iconConfig.iconSize[1] / 2]
                });
            }
            
            removeMarker(id) {
                if (this.markers.has(id)) {
                    this.map.removeLayer(this.markers.get(id));
                    this.markers.delete(id);
                }
            }
            
            clearMarkers() {
                this.markers.forEach(marker => this.map.removeLayer(marker));
                this.markers.clear();
            }
            
            drawRoute(startLatlng, endLatlng, options = {}) {
                const routeId = `${startLatlng.lat},${startLatlng.lng}-${endLatlng.lat},${endLatlng.lng}`;
                
                if (this.routes.has(routeId)) {
                    return this.routes.get(routeId);
                }
                
                const polyline = L.polyline([startLatlng, endLatlng], {
                    color: options.color || '#FF6B35',
                    weight: options.weight || 4,
                    opacity: options.opacity || 0.7,
                    dashArray: options.dashArray || '8, 8'
                }).addTo(this.map);
                
                this.routes.set(routeId, polyline);
                
                // Fit bounds to show both points
                this.map.fitBounds([startLatlng, endLatlng], {
                    padding: [50, 50],
                    maxZoom: 16
                });
                
                return polyline;
            }
            
            removeRoute(routeId) {
                if (this.routes.has(routeId)) {
                    this.map.removeLayer(this.routes.get(routeId));
                    this.routes.delete(routeId);
                }
            }
            
            clearRoutes() {
                this.routes.forEach(route => this.map.removeLayer(route));
                this.routes.clear();
            }
            
            setView(latlng, zoom = 16) {
                this.map.setView(latlng, zoom, {
                    animate: true,
                    duration: 0.5
                });
            }
            
            getBounds() {
                return this.map.getBounds();
            }
        }

        // Enhanced UI manager
        class UIManager {
            static showNotification(message, type = 'info') {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                
                // Set color based on type
                const colors = {
                    info: 'var(--primary-orange)',
                    success: 'var(--success-green)',
                    warning: 'var(--warning-yellow)',
                    error: 'var(--error-red)'
                };
                
                notification.style.background = colors[type] || colors.info;
                notification.style.display = 'block';
                
                // Auto-hide after 4 seconds
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 4000);
            }
            
            static showModal(modalId) {
                document.getElementById(modalId).classList.add('active');
            }
            
            static hideModal(modalId) {
                document.getElementById(modalId).classList.remove('active');
            }
            
            static togglePanel() {
                const panel = document.getElementById('passengerPanel');
                panel.classList.toggle('collapsed');
            }
            
            static switchScreen(screenId) {
                // Hide all screens
                document.querySelectorAll('.screen-content').forEach(screen => {
                    screen.classList.remove('active');
                });
                
                // Show selected screen
                document.getElementById(screenId + 'Screen').classList.add('active');
                
                // Update navigation buttons
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`.nav-btn[data-screen="${screenId}"]`).classList.add('active');
                
                // Update home-only elements
                const homeOnlyElements = document.querySelectorAll('.home-only');
                homeOnlyElements.forEach(el => {
                    el.style.display = screenId === 'home' ? 'flex' : 'none';
                });
                
                AppState.currentScreen = screenId;
                
                // Load screen-specific data
                switch(screenId) {
                    case 'history':
                        HistoryManager.loadHistory();
                        break;
                    case 'account':
                        AccountManager.loadAccountData();
                        break;
                }
            }
            
            static updateFareDisplay(distanceMeters, options = {}) {
                const fare = PriceCalculator.calculateFare(distanceMeters, options);
                const eta = PriceCalculator.calculateETA(distanceMeters, options.vehicleType);
                
                document.getElementById('estimatedFare').textContent = `K${fare.toFixed(2)}`;
                document.getElementById('etaDisplay').textContent = `ETA: ${eta} min`;
                
                AppState.rideFare = fare;
                
                // Show fare display if not already visible
                document.getElementById('fareDisplay').classList.add('active');
                document.getElementById('vehicleSelection').classList.add('active');
                document.getElementById('requestRideBtn').classList.add('active');
            }
            
            static showSearchSuggestions(suggestions, containerId) {
                const container = document.getElementById(containerId);
                if (!container) return;
                
                container.innerHTML = '';
                
                if (suggestions.length === 0) {
                    container.innerHTML = '<div class="suggestion-item">No results found</div>';
                } else {
                    suggestions.forEach((suggestion, index) => {
                        const item = document.createElement('div');
                        item.className = 'suggestion-item';
                        if (index === 0) item.classList.add('selected');
                        
                        item.innerHTML = `
                            <div class="suggestion-icon">
                                ${UIManager.getPlaceIcon(suggestion)}
                            </div>
                            <div class="suggestion-details">
                                <div class="suggestion-name">${suggestion.display_name}</div>
                                <div class="suggestion-address">${UIManager.getShortAddress(suggestion)}</div>
                                ${suggestion.distance ? `<div class="suggestion-distance">${(suggestion.distance / 1000).toFixed(1)} km away</div>` : ''}
                            </div>
                        `;
                        
                        item.addEventListener('click', () => {
                            UIManager.handleSearchSelection(suggestion, containerId);
                        });
                        
                        container.appendChild(item);
                    });
                }
                
                container.classList.add('visible');
            }
            
            static getPlaceIcon(place) {
                const types = {
                    'amenity': {
                        'restaurant': '',
                        'cafe': '',
                        'bank': '',
                        'hospital': '',
                        'pharmacy': '',
                        'school': '',
                        'police': ''
                    },
                    'shop': {
                        'supermarket': '',
                        'mall': ''
                    },
                    'tourism': {
                        'hotel': ''
                    }
                };
                
                if (place.type && types[place.type]) {
                    return types[place.type][place.category] || '';
                }
                return '';
            }
            
            static getShortAddress(place) {
                if (!place.display_name) return '';
                const parts = place.display_name.split(',');
                return parts.slice(0, Math.min(3, parts.length)).join(', ');
            }
            
            static handleSearchSelection(place, containerId) {
                // Hide suggestions
                document.getElementById(containerId).classList.remove('visible');
                
                // Update input field
                const inputId = containerId.replace('Suggestions', '');
                const input = document.getElementById(inputId);
                if (input) {
                    input.value = place.display_name;
                    input.focus();
                }
                
                // Update map
                const latlng = L.latLng(place.displayLat, place.displayLon);
                mapManager.addMarker('destination', latlng, {
                    type: 'destination',
                    popup: `<strong>${place.display_name}</strong>`
                });
                
                // Calculate fare if we have user location
                if (AppState.userLocation) {
                    const distance = UIManager.calculateDistance(
                        AppState.userLocation.lat,
                        AppState.userLocation.lng,
                        place.displayLat,
                        place.displayLon
                    );
                    
                    UIManager.updateFareDisplay(distance);
                    
                    // Show ride type selection
                    UIManager.showModal('rideTypeModal');
                }
                
                // Draw route
                if (AppState.userLocation) {
                    const startLatlng = L.latLng(AppState.userLocation.lat, AppState.userLocation.lng);
                    mapManager.drawRoute(startLatlng, latlng);
                }
            }
            
            static calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 6371e3;
                const 1 = lat1 * Math.PI / 180;
                const 2 = lat2 * Math.PI / 180;
                const  = (lat2 - lat1) * Math.PI / 180;
                const  = (lon2 - lon1) * Math.PI / 180;

                const a = Math.sin(/2) * Math.sin(/2) +
                          Math.cos(1) * Math.cos(2) *
                          Math.sin(/2) * Math.sin(/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

                return R * c;
            }
            
            static updateRideStatus(status, driver = null) {
                const statusElement = document.getElementById('rideStatus');
                const statusDot = document.getElementById('statusDot');
                const statusText = document.getElementById('statusText');
                
                statusElement.style.display = 'flex';
                
                switch(status) {
                    case 'searching':
                        statusDot.className = 'status-dot searching';
                        statusText.textContent = 'Searching for driver';
                        break;
                    case 'arriving':
                        statusDot.className = 'status-dot arriving';
                        statusText.textContent = 'Driver arriving';
                        break;
                    case 'riding':
                        statusDot.className = 'status-dot riding';
                        statusText.textContent = 'Trip in progress';
                        break;
                    case 'completed':
                        statusElement.style.display = 'none';
                        break;
                }
                
                // Update driver info if available
                if (driver) {
                    document.getElementById('driverName').textContent = driver.name || 'Driver';
                    document.getElementById('driverPhone').textContent = driver.phone || 'N/A';
                    document.getElementById('driverRating').textContent = driver.rating || '4.5';
                }
            }
            
            static showRideInfo(ride) {
                document.getElementById('rideRequestForm').classList.remove('active');
                document.getElementById('rideInfoPanel').classList.add('active');
                
                // Update ride info
                document.getElementById('currentPickupLocation').textContent = ride.pickupLocation;
                document.getElementById('currentDestinationLocation').textContent = ride.destination;
                
                const fare = ride.fare || 0;
                const discount = AppState.appliedPromoCode ? fare * 0.2 : 0;
                
                document.getElementById('baseFare').textContent = `K${fare.toFixed(2)}`;
                document.getElementById('discountFare').textContent = `-K${discount.toFixed(2)}`;
                document.getElementById('totalFare').textContent = `K${(fare - discount).toFixed(2)}`;
            }
            
            static hideRideInfo() {
                document.getElementById('rideRequestForm').classList.add('active');
                document.getElementById('rideInfoPanel').classList.remove('active');
            }
        }

        // Enhanced history manager with expandable details
        class HistoryManager {
            static async loadHistory() {
                if (!AppState.currentUser) return;
                
                try {
                    const snapshot = await database.ref('rides')
                        .orderByChild('passengerId')
                        .equalTo(AppState.currentUser.uid)
                        .once('value');
                    
                    const rides = snapshot.val();
                    const historyList = document.getElementById('historyList');
                    historyList.innerHTML = '';
                    
                    if (!rides) {
                        historyList.innerHTML = '<p style="text-align: center; padding: 40px; color: var(--text-gray);">No ride history found.</p>';
                        return;
                    }
                    
                    const ridesArray = Object.entries(rides).map(([id, ride]) => ({ id, ...ride }));
                    ridesArray.sort((a, b) => b.timestamp - a.timestamp);
                    
                    // Apply filters
                    const filter = document.getElementById('historyFilter').value;
                    const dateFilter = document.getElementById('historyDate').value;
                    
                    let filteredRides = ridesArray;
                    
                    if (filter !== 'all') {
                        filteredRides = filteredRides.filter(ride => {
                            if (filter === 'ride') return !ride.emergencyDetails && !ride.expressDelivery;
                            if (filter === 'delivery') return ride.expressDelivery || ride.truckDelivery;
                            if (filter === 'emergency') return ride.emergencyDetails;
                            return ride.status === filter;
                        });
                    }
                    
                    if (dateFilter) {
                        const filterDate = new Date(dateFilter);
                        filteredRides = filteredRides.filter(ride => {
                            const rideDate = new Date(ride.timestamp);
                            return rideDate.toDateString() === filterDate.toDateString();
                        });
                    }
                    
                    if (filteredRides.length === 0) {
                        historyList.innerHTML = '<p style="text-align: center; padding: 40px; color: var(--text-gray);">No rides match your criteria.</p>';
                        return;
                    }
                    
                    filteredRides.forEach(ride => {
                        HistoryManager.createHistoryItem(ride, historyList);
                    });
                    
                } catch (error) {
                    console.error('Error loading history:', error);
                    UIManager.showNotification('Error loading ride history', 'error');
                }
            }
            
            static createHistoryItem(ride, container) {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.dataset.rideId = ride.id;
                
                const date = new Date(ride.timestamp);
                const formattedDate = date.toLocaleDateString();
                const formattedTime = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                // Determine ride type
                let typeClass, typeText;
                if (ride.emergencyDetails) {
                    typeClass = 'emergency';
                    typeText = 'EMERGENCY';
                } else if (ride.expressDelivery || ride.truckDelivery) {
                    typeClass = 'delivery';
                    typeText = 'DELIVERY';
                } else {
                    typeClass = 'ride';
                    typeText = 'RIDE';
                }
                
                // Determine status
                let statusClass, statusText;
                switch(ride.status) {
                    case 'completed':
                    case 'paid':
                        statusClass = 'status-completed';
                        statusText = 'COMPLETED';
                        break;
                    case 'cancelled':
                        statusClass = 'status-cancelled';
                        statusText = 'CANCELLED';
                        break;
                    default:
                        statusClass = 'status-requested';
                        statusText = 'PENDING';
                }
                
                item.innerHTML = `
                    <div class="history-item-header">
                        <div class="history-item-type ${typeClass}">${typeText}</div>
                        <div class="status-badge ${statusClass}">${statusText}</div>
                    </div>
                    
                    <div class="history-locations">
                        <div class="history-location">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>${ride.pickupLocation || 'Pickup location'}</span>
                        </div>
                        <div class="history-location">
                            <i class="fas fa-flag"></i>
                            <span>${ride.destination || 'Destination'}</span>
                        </div>
                    </div>
                    
                    <div class="history-info">
                        <div class="history-fare">K${ride.fare ? ride.fare.toFixed(2) : '0.00'}</div>
                        <div>${formattedDate} ${formattedTime}</div>
                    </div>
                    
                    <div class="history-details">
                        <!-- Expanded details will be loaded here -->
                    </div>
                `;
                
                // Add click handler for expansion
                item.addEventListener('click', (e) => {
                    if (!e.target.closest('.history-details')) {
                        HistoryManager.toggleHistoryDetails(ride, item);
                    }
                });
                
                container.appendChild(item);
            }
            
            static async toggleHistoryDetails(ride, item) {
                const detailsElement = item.querySelector('.history-details');
                
                if (detailsElement.classList.contains('expanded')) {
                    detailsElement.classList.remove('expanded');
                    item.classList.remove('expanded');
                    return;
                }
                
                item.classList.add('expanded');
                
                // Load additional details
                const driverInfo = ride.driverId ? await HistoryManager.getDriverInfo(ride.driverId) : null;
                
                detailsElement.innerHTML = HistoryManager.createExpandedDetails(ride, driverInfo);
                detailsElement.classList.add('expanded');
            }
            
            static async getDriverInfo(driverId) {
                try {
                    const snapshot = await database.ref('users/' + driverId).once('value');
                    return snapshot.val();
                } catch (error) {
                    console.error('Error loading driver info:', error);
                    return null;
                }
            }
            
            static createExpandedDetails(ride, driverInfo) {
                const date = new Date(ride.timestamp);
                
                let details = `
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Ride ID</div>
                            <div class="detail-value">${ride.id.substring(0, 8).toUpperCase()}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Date & Time</div>
                            <div class="detail-value">${date.toLocaleString()}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Distance</div>
                            <div class="detail-value">${ride.distance || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Ride Type</div>
                            <div class="detail-value">${ride.rideClass ? ride.rideClass.toUpperCase() : 'STANDARD'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Payment Method</div>
                            <div class="detail-value">${ride.paymentMethod ? ride.paymentMethod.toUpperCase() : 'WALLET'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Status</div>
                            <div class="detail-value">${ride.status ? ride.status.toUpperCase() : 'UNKNOWN'}</div>
                        </div>
                    </div>
                `;
                
                if (driverInfo) {
                    details += `
                        <div class="history-driver-info">
                            <div class="history-driver-avatar">
                                ${driverInfo.name ? driverInfo.name.charAt(0).toUpperCase() : 'D'}
                            </div>
                            <div class="history-driver-details">
                                <div class="history-driver-name">${driverInfo.name || 'Driver'}</div>
                                <div class="history-driver-rating">
                                    <i class="fas fa-star"></i>
                                    ${driverInfo.rating || '4.5'} 
                                </div>
                                <div style="font-size: 12px; color: var(--text-gray); margin-top: 5px;">
                                    ${driverInfo.phone || 'Phone not available'}
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // Add receipt button
                details += `
                    <button class="btn btn-secondary" onclick="HistoryManager.showReceipt('${ride.id}')" style="width: 100%; margin-top: 15px;">
                        <i class="fas fa-receipt"></i>
                        View Receipt
                    </button>
                `;
                
                return details;
            }
            
            static async showReceipt(rideId) {
                try {
                    const snapshot = await database.ref('rides/' + rideId).once('value');
                    const ride = snapshot.val();
                    
                    if (!ride) {
                        UIManager.showNotification('Ride not found', 'error');
                        return;
                    }
                    
                    const receiptContent = document.getElementById('receiptContent');
                    receiptContent.innerHTML = HistoryManager.createReceiptHTML(ride);
                    
                    UIManager.showModal('receiptModal');
                } catch (error) {
                    console.error('Error loading receipt:', error);
                    UIManager.showNotification('Error loading receipt', 'error');
                }
            }
            
            static createReceiptHTML(ride) {
                const date = new Date(ride.timestamp);
                
                return `
                    <div style="text-align: center; margin-bottom: 20px;">
                        <h3 style="color: var(--primary-orange); margin-bottom: 10px;">JUBEL RIDE RECEIPT</h3>
                        <div style="color: var(--text-gray); font-size: 14px;">${date.toLocaleDateString()} ${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="color: var(--text-gray);">Receipt No:</span>
                            <span style="font-weight: 600;">${ride.id.substring(0, 8).toUpperCase()}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="color: var(--text-gray);">Passenger:</span>
                            <span style="font-weight: 600;">${ride.passengerName || 'Passenger'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="color: var(--text-gray);">Pickup:</span>
                            <span style="font-weight: 600; text-align: right;">${ride.pickupLocation}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="color: var(--text-gray);">Destination:</span>
                            <span style="font-weight: 600; text-align: right;">${ride.destination}</span>
                        </div>
                    </div>
                    
                    <div style="background: var(--light-orange); padding: 15px; border-radius: var(--input-radius); margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>Base Fare:</span>
                            <span>K23.00</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>Distance Fare:</span>
                            <span>K${(ride.fare - 23).toFixed(2)}</span>
                        </div>
                        ${ride.promoCode ? `
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span>Discount (${ride.promoCode}):</span>
                                <span style="color: var(--success-green);">-K${(ride.fare * 0.2).toFixed(2)}</span>
                            </div>
                        ` : ''}
                        <div style="display: flex; justify-content: space-between; font-size: 18px; font-weight: 700; padding-top: 10px; border-top: 2px solid var(--border-color);">
                            <span>TOTAL:</span>
                            <span style="color: var(--primary-orange);">K${ride.fare.toFixed(2)}</span>
                        </div>
                    </div>
                    
                    <div style="text-align: center; color: var(--text-gray); font-size: 12px; margin-top: 20px;">
                        Thank you for choosing Jubel!
                    </div>
                `;
            }
        }

        // Enhanced account manager
        class AccountManager {
            static async loadAccountData() {
                if (!AppState.currentUser || !AppState.userData) return;
                
                const user = AppState.userData;
                
                document.getElementById('accountName').textContent = user.name || 'Passenger';
                document.getElementById('accountPhone').textContent = user.phone || 'Not set';
                document.getElementById('accountEmail').textContent = user.email || 'Not set';
                document.getElementById('referralCode').textContent = user.referralCode || 'JUBEL-XXXX';
                
                // Update wallet balance
                document.getElementById('accountBalance').textContent = `K${AppState.walletBalance.toFixed(2)}`;
                
                // Update avatar
                const accountAvatar = document.getElementById('accountAvatar');
                if (user.name) {
                    accountAvatar.textContent = user.name.charAt(0).toUpperCase();
                }
                
                // Load stats
                await AccountManager.loadUserStats();
            }
            
            static async loadUserStats() {
                if (!AppState.currentUser) return;
                
                try {
                    const snapshot = await database.ref('rides')
                        .orderByChild('passengerId')
                        .equalTo(AppState.currentUser.uid)
                        .once('value');
                    
                    const rides = snapshot.val();
                    if (!rides) return;
                    
                    const ridesArray = Object.values(rides);
                    
                    const stats = {
                        completed: ridesArray.filter(r => r.status === 'completed' || r.status === 'paid').length,
                        cancelled: ridesArray.filter(r => r.status === 'cancelled').length,
                        pending: ridesArray.filter(r => ['requested', 'accepted', 'arrived', 'picked_up', 'started'].includes(r.status)).length
                    };
                    
                    document.getElementById('ridesCompleted').textContent = stats.completed;
                    document.getElementById('ridesCancelled').textContent = stats.cancelled;
                    document.getElementById('ridesPending').textContent = stats.pending;
                } catch (error) {
                    console.error('Error loading user stats:', error);
                }
            }
            
            static async deposit() {
                const amount = prompt('Enter deposit amount (K):');
                if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
                    UIManager.showNotification('Please enter a valid amount', 'error');
                    return;
                }
                
                const depositAmount = parseFloat(amount);
                const newBalance = AppState.walletBalance + depositAmount;
                
                try {
                    await database.ref('users/' + AppState.currentUser.uid).update({
                        walletBalance: newBalance
                    });
                    
                    AppState.walletBalance = newBalance;
                    UIManager.updateWalletBalance();
                    UIManager.showNotification(`Successfully deposited K${depositAmount.toFixed(2)}`, 'success');
                } catch (error) {
                    console.error('Error processing deposit:', error);
                    UIManager.showNotification('Error processing deposit', 'error');
                }
            }
            
            static async withdraw() {
                if (AppState.walletBalance <= 0) {
                    UIManager.showNotification('Your wallet balance is zero', 'warning');
                    return;
                }
                
                const amount = prompt(`Enter withdrawal amount (K). Available: K${AppState.walletBalance.toFixed(2)}:`);
                if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
                    UIManager.showNotification('Please enter a valid amount', 'error');
                    return;
                }
                
                const withdrawalAmount = parseFloat(amount);
                
                if (withdrawalAmount > AppState.walletBalance) {
                    UIManager.showNotification('Insufficient balance', 'error');
                    return;
                }
                
                const newBalance = AppState.walletBalance - withdrawalAmount;
                
                try {
                    await database.ref('users/' + AppState.currentUser.uid).update({
                        walletBalance: newBalance
                    });
                    
                    AppState.walletBalance = newBalance;
                    UIManager.updateWalletBalance();
                    UIManager.showNotification(`Successfully withdrew K${withdrawalAmount.toFixed(2)}`, 'success');
                } catch (error) {
                    console.error('Error processing withdrawal:', error);
                    UIManager.showNotification('Error processing withdrawal', 'error');
                }
            }
            
            static shareReferralCode() {
                const referralCode = AppState.userData?.referralCode || 'JUBEL-XXXX';
                const shareText = `Join me on Jubel! Use my referral code ${referralCode} for 50% off your first ride.`;
                
                if (navigator.share) {
                    navigator.share({
                        title: 'Jubel Referral',
                        text: shareText,
                        url: window.location.href
                    }).catch(console.error);
                } else {
                    navigator.clipboard.writeText(shareText)
                        .then(() => UIManager.showNotification('Referral code copied to clipboard', 'success'))
                        .catch(() => UIManager.showNotification('Error copying to clipboard', 'error'));
                }
            }
        }

        // Enhanced ride manager
        class RideManager {
            static async requestRide(rideData) {
                if (!AppState.currentUser) {
                    UIManager.showNotification('Please login first', 'error');
                    return;
                }
                
                try {
                    // Create ride ID
                    const rideId = database.ref().child('rides').push().key;
                    
                    // Prepare ride request
                    const rideRequest = {
                        id: rideId,
                        passengerId: AppState.currentUser.uid,
                        passengerName: AppState.userData?.name || 'Passenger',
                        passengerPhone: AppState.userData?.phone || 'Not provided',
                        ...rideData,
                        status: 'requested',
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        updatedAt: firebase.database.ServerValue.TIMESTAMP
                    };
                    
                    // Save to database
                    await database.ref('rides/' + rideId).set(rideRequest);
                    
                    // Update app state
                    AppState.currentRide = rideRequest;
                    AppState.currentRideRequestData = null;
                    
                    // Update UI
                    UIManager.showRideInfo(rideRequest);
                    UIManager.updateRideStatus('searching');
                    
                    // Show searching animation
                    document.getElementById('searchingAnimation').style.display = 'flex';
                    
                    // Listen for driver assignment
                    RideManager.listenForDriverAssignment(rideId);
                    
                    UIManager.showNotification('Ride requested. Searching for driver...', 'success');
                    
                } catch (error) {
                    console.error('Error requesting ride:', error);
                    UIManager.showNotification('Error requesting ride', 'error');
                }
            }
            
            static listenForDriverAssignment(rideId) {
                // Remove existing listener
                if (AppState.listeners.driverAssignment) {
                    database.ref('rides/' + rideId).off('value', AppState.listeners.driverAssignment);
                }
                
                AppState.listeners.driverAssignment = database.ref('rides/' + rideId).on('value', snapshot => {
                    const ride = snapshot.val();
                    if (!ride) return;
                    
                    switch(ride.status) {
                        case 'accepted':
                            RideManager.handleDriverAssignment(ride);
                            break;
                        case 'completed':
                            RideManager.handleRideCompletion(ride);
                            break;
                        case 'cancelled':
                            RideManager.handleRideCancellation(ride);
                            break;
                    }
                });
            }
            
            static async handleDriverAssignment(ride) {
                if (!ride.driverId) return;
                
                try {
                    // Get driver info
                    const driverSnapshot = await database.ref('users/' + ride.driverId).once('value');
                    const driver = driverSnapshot.val();
                    
                    if (!driver) return;
                    
                    // Update UI
                    document.getElementById('searchingAnimation').style.display = 'none';
                    UIManager.updateRideStatus('arriving', driver);
                    
                    // Show estimated time
                    document.getElementById('estimatedTime').style.display = 'flex';
                    
                    // Add driver marker
                    if (ride.driverLat && ride.driverLng) {
                        mapManager.addMarker('driver', L.latLng(ride.driverLat, ride.driverLng), {
                            type: 'driver',
                            popup: `<strong>${driver.name || 'Driver'}</strong><br>${driver.vehicle?.licensePlate || ''}`
                        });
                    }
                    
                    // Listen for driver location updates
                    RideManager.listenForDriverLocation(ride.driverId);
                    
                    UIManager.showNotification(`Driver ${driver.name} is on the way!`, 'success');
                    
                } catch (error) {
                    console.error('Error handling driver assignment:', error);
                }
            }
            
            static listenForDriverLocation(driverId) {
                // Remove existing listener
                if (AppState.listeners.driverLocation) {
                    database.ref('driverLocations/' + driverId).off('value', AppState.listeners.driverLocation);
                }
                
                AppState.listeners.driverLocation = database.ref('driverLocations/' + driverId).on('value', snapshot => {
                    const location = snapshot.val();
                    if (location && mapManager.markers.has('driver')) {
                        const marker = mapManager.markers.get('driver');
                        marker.setLatLng([location.latitude, location.longitude]);
                        
                        // Update ETA
                        if (AppState.userLocation) {
                            const distance = UIManager.calculateDistance(
                                AppState.userLocation.lat,
                                AppState.userLocation.lng,
                                location.latitude,
                                location.longitude
                            );
                            
                            const eta = PriceCalculator.calculateETA(distance);
                            document.getElementById('timeText').textContent = `${eta} min`;
                        }
                    }
                });
            }
            
            static handleRideCompletion(ride) {
                UIManager.updateRideStatus('completed');
                UIManager.hideRideInfo();
                UIManager.showNotification('Ride completed successfully!', 'success');
                
                // Clean up
                RideManager.cleanupAfterRide();
            }
            
            static handleRideCancellation(ride) {
                UIManager.hideRideInfo();
                UIManager.showNotification('Ride cancelled', 'warning');
                
                // Clean up
                RideManager.cleanupAfterRide();
            }
            
            static cleanupAfterRide() {
                // Remove listeners
                if (AppState.listeners.driverAssignment) {
                    database.ref('rides/' + AppState.currentRide?.id).off('value', AppState.listeners.driverAssignment);
                    AppState.listeners.driverAssignment = null;
                }
                
                if (AppState.listeners.driverLocation) {
                    if (AppState.currentRide?.driverId) {
                        database.ref('driverLocations/' + AppState.currentRide.driverId).off('value', AppState.listeners.driverLocation);
                    }
                    AppState.listeners.driverLocation = null;
                }
                
                // Clear markers
                mapManager.removeMarker('driver');
                mapManager.clearRoutes();
                
                // Reset state
                AppState.currentRide = null;
                AppState.emergencyMode = false;
                document.getElementById('emergencyRideStatus').style.display = 'none';
                document.getElementById('sosButton').style.display = 'none';
            }
            
            static async cancelRide() {
                if (!AppState.currentRide) {
                    UIManager.showNotification('No active ride to cancel', 'warning');
                    return;
                }
                
                if (!confirm('Are you sure you want to cancel this ride?')) {
                    return;
                }
                
                try {
                    await database.ref('rides/' + AppState.currentRide.id).update({
                        status: 'cancelled',
                        cancelledAt: firebase.database.ServerValue.TIMESTAMP,
                        updatedAt: firebase.database.ServerValue.TIMESTAMP
                    });
                    
                    UIManager.showNotification('Ride cancelled', 'success');
                    
                } catch (error) {
                    console.error('Error cancelling ride:', error);
                    UIManager.showNotification('Error cancelling ride', 'error');
                }
            }
        }

        // Enhanced schedule manager
        class ScheduleManager {
            static scheduledRides = new Map();
            
            static async loadScheduledRides() {
                if (!AppState.currentUser) return;
                
                try {
                    const snapshot = await database.ref('scheduledRides')
                        .orderByChild('passengerId')
                        .equalTo(AppState.currentUser.uid)
                        .once('value');
                    
                    const rides = snapshot.val();
                    if (!rides) return;
                    
                    Object.entries(rides).forEach(([id, ride]) => {
                        if (ride.status === 'scheduled') {
                            ScheduleManager.scheduledRides.set(id, ride);
                            ScheduleManager.checkAndStartCountdown(ride);
                        }
                    });
                    
                } catch (error) {
                    console.error('Error loading scheduled rides:', error);
                }
            }
            
            static checkAndStartCountdown(ride) {
                const now = Date.now();
                const scheduledTime = ride.scheduledTime;
                
                if (scheduledTime <= now) {
                    // Schedule is due, process it
                    ScheduleManager.processScheduledRide(ride);
                } else if (scheduledTime - now <= 3600000) { // Within 1 hour
                    ScheduleManager.startCountdown(ride);
                }
            }
            
            static startCountdown(ride) {
                const countdownElement = document.getElementById('countdownTimer');
                const timeElement = document.getElementById('countdownTime');
                
                countdownElement.classList.add('active');
                
                const updateCountdown = () => {
                    const now = Date.now();
                    const timeLeft = ride.scheduledTime - now;
                    
                    if (timeLeft <= 0) {
                        clearInterval(AppState.countdownInterval);
                        countdownElement.classList.remove('active');
                        ScheduleManager.processScheduledRide(ride);
                        return;
                    }
                    
                    const hours = Math.floor(timeLeft / 3600000);
                    const minutes = Math.floor((timeLeft % 3600000) / 60000);
                    const seconds = Math.floor((timeLeft % 60000) / 1000);
                    
                    timeElement.textContent = 
                        `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                };
                
                updateCountdown();
                AppState.countdownInterval = setInterval(updateCountdown, 1000);
            }
            
            static async processScheduledRide(ride) {
                try {
                    // Update status
                    await database.ref('scheduledRides/' + ride.id).update({
                        status: 'processing'
                    });
                    
                    // Remove from scheduled rides
                    ScheduleManager.scheduledRides.delete(ride.id);
                    
                    // Show notification
                    UIManager.showNotification('Scheduled ride is due! Processing...', 'info');
                    
                    // Request the ride
                    const rideData = {
                        ...ride,
                        status: 'requested',
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        updatedAt: firebase.database.ServerValue.TIMESTAMP
                    };
                    
                    await RideManager.requestRide(rideData);
                    
                } catch (error) {
                    console.error('Error processing scheduled ride:', error);
                    UIManager.showNotification('Error processing scheduled ride', 'error');
                }
            }
            
            static async scheduleRide(rideData) {
                try {
                    const rideId = database.ref().child('scheduledRides').push().key;
                    
                    const scheduledRide = {
                        id: rideId,
                        passengerId: AppState.currentUser.uid,
                        passengerName: AppState.userData?.name || 'Passenger',
                        ...rideData,
                        status: 'scheduled',
                        scheduledTime: new Date(`${rideData.scheduleDate}T${rideData.scheduleTime}`).getTime(),
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    };
                    
                    await database.ref('scheduledRides/' + rideId).set(scheduledRide);
                    
                    // Add to local cache
                    ScheduleManager.scheduledRides.set(rideId, scheduledRide);
                    
                    // Start countdown if within 1 hour
                    const timeLeft = scheduledRide.scheduledTime - Date.now();
                    if (timeLeft <= 3600000) {
                        ScheduleManager.startCountdown(scheduledRide);
                    }
                    
                    UIManager.showNotification('Ride scheduled successfully!', 'success');
                    return true;
                    
                } catch (error) {
                    console.error('Error scheduling ride:', error);
                    UIManager.showNotification('Error scheduling ride', 'error');
                    return false;
                }
            }
        }

        // Enhanced location manager
        class LocationManager {
            static async initialize() {
                if (!navigator.geolocation) {
                    UIManager.showNotification('Geolocation is not supported by your browser', 'error');
                    return;
                }
                
                // Get initial position
                await LocationManager.getCurrentPosition();
                
                // Start watching position
                LocationManager.startWatching();
            }
            
            static getCurrentPosition() {
                return new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(
                        position => {
                            LocationManager.handlePositionUpdate(position);
                            resolve(position);
                        },
                        error => {
                            LocationManager.handleGeolocationError(error);
                            reject(error);
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 15000,
                            maximumAge: 30000
                        }
                    );
                });
            }
            
            static startWatching() {
                if (AppState.locationWatchId) {
                    navigator.geolocation.clearWatch(AppState.locationWatchId);
                }
                
                AppState.locationWatchId = navigator.geolocation.watchPosition(
                    LocationManager.handlePositionUpdate,
                    LocationManager.handleGeolocationError,
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
                
                // Also update periodically for Firebase
                AppState.locationUpdateInterval = setInterval(() => {
                    if (AppState.currentUser && AppState.userLocation) {
                        database.ref('passengerLocations/' + AppState.currentUser.uid).set({
                            latitude: AppState.userLocation.lat,
                            longitude: AppState.userLocation.lng,
                            timestamp: firebase.database.ServerValue.TIMESTAMP
                        });
                    }
                }, 10000);
            }
            
            static handlePositionUpdate(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                
                AppState.userLocation = { lat, lng };
                
                // Update map
                mapManager.addMarker('current-location', L.latLng(lat, lng), {
                    type: 'current-location',
                    popup: 'Your location'
                });
                
                // Update pickup location
                mapManager.addMarker('pickup', L.latLng(lat, lng), {
                    type: 'pickup',
                    popup: 'Pickup location'
                });
                
                // Update pickup input
                document.getElementById('pickupLocation').value = `Current Location (${lat.toFixed(6)}, ${lng.toFixed(6)})`;
                
                // Update map view
                mapManager.setView(L.latLng(lat, lng));
                
                // Detect city
                LocationManager.detectCity(lat, lng);
            }
            
            static async detectCity(lat, lng) {
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18`);
                    const data = await response.json();
                    
                    if (data && data.address) {
                        const city = data.address.city || data.address.town || data.address.village;
                        if (city && ZambianCities.cities.includes(city)) {
                            AppState.currentCity = city;
                            console.log(`Detected city: ${city}`);
                        }
                    }
                } catch (error) {
                    console.error('Error detecting city:', error);
                }
            }
            
            static handleGeolocationError(error) {
                let message = 'Unable to get location. ';
                
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        message += 'Please enable location services.';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        message += 'Location information is unavailable.';
                        break;
                    case error.TIMEOUT:
                        message += 'Location request timed out.';
                        break;
                    default:
                        message += 'Unknown error.';
                }
                
                UIManager.showNotification(message, 'error');
            }
            
            static stopWatching() {
                if (AppState.locationWatchId) {
                    navigator.geolocation.clearWatch(AppState.locationWatchId);
                    AppState.locationWatchId = null;
                }
                
                if (AppState.locationUpdateInterval) {
                    clearInterval(AppState.locationUpdateInterval);
                    AppState.locationUpdateInterval = null;
                }
            }
        }

        // Enhanced search handler
        class SearchHandler {
            static async handleSearchInput(event, containerId) {
                const query = event.target.value.trim();
                
                if (query.length < 2) {
                    document.getElementById(containerId).classList.remove('visible');
                    return;
                }
                
                // Clear previous timer
                if (SearchHandler.currentTimer) {
                    clearTimeout(SearchHandler.currentTimer);
                }
                
                // Show loading indicator
                const container = document.getElementById(containerId);
                container.innerHTML = '<div class="suggestion-item">Searching...</div>';
                container.classList.add('visible');
                
                // Debounce search
                SearchHandler.currentTimer = setTimeout(async () => {
                    try {
                        const results = await searchIndex.search(query, 8);
                        UIManager.showSearchSuggestions(results, containerId);
                    } catch (error) {
                        console.error('Search error:', error);
                        container.innerHTML = '<div class="suggestion-item">Search error</div>';
                    }
                }, 300);
            }
            
            static handleSearchKeydown(event, containerId) {
                const container = document.getElementById(containerId);
                if (!container.classList.contains('visible')) return;
                
                const items = container.querySelectorAll('.suggestion-item');
                if (items.length === 0) return;
                
                const selectedItem = container.querySelector('.suggestion-item.selected');
                let selectedIndex = Array.from(items).indexOf(selectedItem);
                
                switch(event.key) {
                    case 'ArrowDown':
                        event.preventDefault();
                        if (selectedItem) selectedItem.classList.remove('selected');
                        selectedIndex = (selectedIndex + 1) % items.length;
                        items[selectedIndex].classList.add('selected');
                        items[selectedIndex].scrollIntoView({ block: 'nearest' });
                        break;
                        
                    case 'ArrowUp':
                        event.preventDefault();
                        if (selectedItem) selectedItem.classList.remove('selected');
                        selectedIndex = (selectedIndex - 1 + items.length) % items.length;
                        items[selectedIndex].classList.add('selected');
                        items[selectedIndex].scrollIntoView({ block: 'nearest' });
                        break;
                        
                    case 'Enter':
                        event.preventDefault();
                        if (selectedItem) {
                            selectedItem.click();
                        }
                        break;
                        
                    case 'Escape':
                        container.classList.remove('visible');
                        break;
                }
            }
        }

        // Enhanced authentication manager
        class AuthManager {
            static async initialize() {
                // Check URL parameters for email/uid (for direct login)
                const urlParams = new URLSearchParams(window.location.search);
                const email = urlParams.get('email');
                const uid = urlParams.get('uid');
                
                if (email && uid) {
                    await AuthManager.loadUserData(uid);
                } else {
                    // Listen for auth state changes
                    auth.onAuthStateChanged(user => {
                        if (user) {
                            AuthManager.handleUserLogin(user);
                        } else {
                            window.location.href = 'signup.html';
                        }
                    });
                }
            }
            
            static async handleUserLogin(user) {
                AppState.currentUser = user;
                await AuthManager.loadUserData(user.uid);
            }
            
            static async loadUserData(uid) {
                try {
                    const snapshot = await database.ref('users/' + uid).once('value');
                    const userData = snapshot.val();
                    
                    if (!userData) {
                        UIManager.showNotification('User data not found', 'error');
                        setTimeout(() => window.location.href = 'signup.html', 2000);
                        return;
                    }
                    
                    AppState.userData = userData;
                    AppState.walletBalance = userData.walletBalance || 0;
                    
                    // Initialize app components
                    await AuthManager.initializeAppComponents();
                    
                    UIManager.showNotification('Welcome to Jubel!', 'success');
                    
                } catch (error) {
                    console.error('Error loading user data:', error);
                    UIManager.showNotification('Error loading user data', 'error');
                }
            }
            
            static async initializeAppComponents() {
                // Initialize map
                window.mapManager = new MapManager();
                
                // Initialize location
                await LocationManager.initialize();
                
                // Initialize wallet balance listener
                AuthManager.setupWalletBalanceListener();
                
                // Load SOS config
                await AuthManager.loadSOSConfig();
                
                // Check for active ride
                await AuthManager.checkActiveRide();
                
                // Load scheduled rides
                await ScheduleManager.loadScheduledRides();
                
                // Setup event listeners
                AuthManager.setupEventListeners();
                
                // Update UI
                UIManager.updateWalletBalance();
            }
            
            static setupWalletBalanceListener() {
                if (!AppState.currentUser) return;
                
                if (AppState.listeners.walletBalance) {
                    database.ref('users/' + AppState.currentUser.uid + '/walletBalance')
                        .off('value', AppState.listeners.walletBalance);
                }
                
                AppState.listeners.walletBalance = database.ref('users/' + AppState.currentUser.uid + '/walletBalance')
                    .on('value', snapshot => {
                        const newBalance = snapshot.val() || 0;
                        if (newBalance !== AppState.walletBalance) {
                            AppState.walletBalance = newBalance;
                            UIManager.updateWalletBalance();
                        }
                    });
            }
            
            static async loadSOSConfig() {
                if (!AppState.currentUser) return;
                
                try {
                    const snapshot = await database.ref('sosConfig/' + AppState.currentUser.uid).once('value');
                    AppState.sosConfig = snapshot.val();
                } catch (error) {
                    console.error('Error loading SOS config:', error);
                }
            }
            
            static async checkActiveRide() {
                if (!AppState.currentUser) return;
                
                try {
                    const snapshot = await database.ref('rides')
                        .orderByChild('passengerId')
                        .equalTo(AppState.currentUser.uid)
                        .once('value');
                    
                    const rides = snapshot.val();
                    if (!rides) return;
                    
                    // Find active ride
                    for (const [rideId, ride] of Object.entries(rides)) {
                        if (!['completed', 'cancelled', 'requested'].includes(ride.status)) {
                            AuthManager.restoreActiveRide(rideId, ride);
                            break;
                        }
                    }
                } catch (error) {
                    console.error('Error checking active ride:', error);
                }
            }
            
            static restoreActiveRide(rideId, ride) {
                AppState.currentRide = { id: rideId, ...ride };
                AppState.activeRideRestored = true;
                
                UIManager.showRideInfo(AppState.currentRide);
                UIManager.updateRideStatus(ride.status);
                
                if (ride.driverId) {
                    RideManager.listenForDriverAssignment(rideId);
                }
                
                if (ride.emergencyDetails) {
                    AppState.emergencyMode = true;
                    document.getElementById('emergencyRideStatus').style.display = 'flex';
                }
                
                if (AppState.sosConfig) {
                    document.getElementById('sosButton').style.display = 'flex';
                }
                
                UIManager.showNotification('Active ride restored', 'info');
            }
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await AuthManager.initialize();
            } catch (error) {
                console.error('App initialization error:', error);
                UIManager.showNotification('Error initializing app', 'error');
            }
        });

        // Global functions for HTML event handlers
        window.toggleMoreOptions = function() {
            document.getElementById('moreOptionsDropdown').classList.toggle('active');
        };
        
        window.handleMoreOption = function(option) {
            // Hide all forms
            document.querySelectorAll('.form-container').forEach(form => {
                form.classList.remove('active');
            });
            
            // Show selected form
            const formId = option.replace(/-/g, '') + 'Form';
            const form = document.getElementById(formId);
            if (form) {
                form.classList.add('active');
            }
            
            // Hide dropdown
            document.getElementById('moreOptionsDropdown').classList.remove('active');
        };
        
        window.cancelMoreOption = function() {
            // Hide all forms
            document.querySelectorAll('.form-container').forEach(form => {
                form.classList.remove('active');
            });
            
            // Show ride request form
            document.getElementById('rideRequestForm').classList.add('active');
        };
        
        window.selectRideType = function() {
            const selectedOption = document.querySelector('.ride-type-option.selected');
            if (selectedOption) {
                const rideType = selectedOption.dataset.type;
                AppState.selectedRideType = rideType;
                
                // Recalculate fare with new ride type
                if (AppState.userLocation && document.getElementById('destinationLocation').value) {
                    // This would recalculate the fare
                    // Implementation depends on your specific logic
                }
                
                UIManager.hideModal('rideTypeModal');
                UIManager.showNotification(`${rideType.charAt(0).toUpperCase() + rideType.slice(1)} ride selected`, 'success');
            }
        };
        
        window.selectPaymentMethod = function() {
            const selectedOption = document.querySelector('.payment-option.selected');
            if (selectedOption) {
                const paymentType = selectedOption.dataset.paymentType;
                AppState.selectedPaymentType = paymentType;
                
                // Check wallet balance if paying with wallet
                if (paymentType === 'wallet' && AppState.walletBalance < AppState.rideFare) {
                    document.getElementById('insufficientBalance').style.display = 'block';
                    document.getElementById('confirmPaymentBtn').disabled = true;
                } else {
                    document.getElementById('insufficientBalance').style.display = 'none';
                    document.getElementById('confirmPaymentBtn').disabled = false;
                }
            }
        };
        
        window.confirmPayment = async function() {
            if (!AppState.currentRideRequestData) {
                UIManager.showNotification('No ride request data', 'error');
                return;
            }
            
            // Process payment
            if (AppState.selectedPaymentType === 'wallet') {
                if (AppState.walletBalance < AppState.rideFare) {
                    UIManager.showNotification('Insufficient wallet balance', 'error');
                    return;
                }
                
                // Deduct from wallet
                const newBalance = AppState.walletBalance - AppState.rideFare;
                try {
                    await database.ref('users/' + AppState.currentUser.uid).update({
                        walletBalance: newBalance
                    });
                    AppState.walletBalance = newBalance;
                } catch (error) {
                    UIManager.showNotification('Payment processing error', 'error');
                    return;
                }
            }
            
            // Request the ride
            await RideManager.requestRide(AppState.currentRideRequestData);
            
            // Hide payment modal
            UIManager.hideModal('paymentSelectionModal');
        };
        
        window.applyPromoCode = function() {
            const promoCode = document.getElementById('promoCode').value.trim();
            
            if (!promoCode) {
                UIManager.showNotification('Please enter a promo code', 'error');
                return;
            }
            
            // Check if it's a referral code
            if (promoCode.startsWith('JUBEL-')) {
                // Verify referral code
                database.ref('users').orderByChild('referralCode').equalTo(promoCode).once('value')
                    .then(snapshot => {
                        if (snapshot.exists()) {
                            AppState.appliedPromoCode = promoCode;
                            UIManager.showNotification('Referral code applied! 50% discount', 'success');
                            
                            // Update fare display
                            document.getElementById('promoCode').style.borderColor = 'var(--success-green)';
                            document.getElementById('applyPromoBtn').innerHTML = '<i class="fas fa-check"></i> Applied';
                            document.getElementById('applyPromoBtn').style.background = 'var(--success-green)';
                        } else {
                            UIManager.showNotification('Invalid referral code', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error applying referral code:', error);
                        UIManager.showNotification('Error applying referral code', 'error');
                    });
            } else {
                // Check other promo codes
                const validPromoCodes = ['SAVE20', 'WELCOME25', 'JUBEL50'];
                if (validPromoCodes.includes(promoCode.toUpperCase())) {
                    AppState.appliedPromoCode = promoCode.toUpperCase();
                    UIManager.showNotification('Promo code applied!', 'success');
                    
                    // Update fare display
                    document.getElementById('promoCode').style.borderColor = 'var(--success-green)';
                    document.getElementById('applyPromoBtn').innerHTML = '<i class="fas fa-check"></i> Applied';
                    document.getElementById('applyPromoBtn').style.background = 'var(--success-green)';
                } else {
                    UIManager.showNotification('Invalid promo code', 'error');
                }
            }
        };
        
        window.requestRide = function() {
            const destination = document.getElementById('destinationLocation').value;
            
            if (!destination) {
                UIManager.showNotification('Please enter a destination', 'error');
                return;
            }
            
            if (!AppState.userLocation) {
                UIManager.showNotification('Please enable location services', 'error');
                return;
            }
            
            // Get destination coordinates from map marker
            const destMarker = mapManager.markers.get('destination');
            if (!destMarker) {
                UIManager.showNotification('Please select a valid destination', 'error');
                return;
            }
            
            const destLatLng = destMarker.getLatLng();
            const distance = UIManager.calculateDistance(
                AppState.userLocation.lat,
                AppState.userLocation.lng,
                destLatLng.lat,
                destLatLng.lng
            );
            
            // Prepare ride request data
            AppState.currentRideRequestData = {
                pickupLocation: document.getElementById('pickupLocation').value,
                destination: destination,
                pickupLat: AppState.userLocation.lat,
                pickupLng: AppState.userLocation.lng,
                destLat: destLatLng.lat,
                destLng: destLatLng.lng,
                rideType: AppState.selectedVehicleType,
                rideClass: AppState.selectedRideType,
                fare: AppState.rideFare,
                distance: (distance / 1000).toFixed(2) + ' km',
                promoCode: AppState.appliedPromoCode,
                paymentMethod: AppState.selectedPaymentType,
                currentCity: AppState.currentCity
            };
            
            // Show payment selection
            UIManager.showModal('paymentSelectionModal');
        };
        
        window.cancelRide = function() {
            RideManager.cancelRide();
        };
        
        window.contactDriver = function() {
            if (!AppState.currentRide?.driverId) {
                UIManager.showNotification('No driver assigned', 'warning');
                return;
            }
            
            database.ref('users/' + AppState.currentRide.driverId).once('value')
                .then(snapshot => {
                    const driver = snapshot.val();
                    if (driver?.phone) {
                        window.open(`tel:${driver.phone}`, '_self');
                    } else {
                        UIManager.showNotification('Driver phone not available', 'warning');
                    }
                })
                .catch(error => {
                    console.error('Error getting driver info:', error);
                    UIManager.showNotification('Error contacting driver', 'error');
                });
        };
        
        window.triggerSOS = function() {
            if (!AppState.sosConfig || !AppState.sosConfig.contact1) {
                UIManager.showNotification('Please setup SOS contacts first', 'error');
                return;
            }
            
            if (!AppState.currentRide) {
                UIManager.showNotification('No active ride', 'warning');
                return;
            }
            
            const sosAlert = {
                passengerId: AppState.currentUser.uid,
                passengerName: AppState.userData?.name || 'Passenger',
                emergencyContact1: AppState.sosConfig.contact1,
                emergencyContact2: AppState.sosConfig.contact2,
                message: AppState.sosConfig.message || 'I need help!',
                rideDetails: AppState.currentRide,
                location: AppState.userLocation,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            
            database.ref('sosAlerts').push().set(sosAlert)
                .then(() => {
                    UIManager.showNotification('SOS alert sent to emergency contacts!', 'success');
                })
                .catch(error => {
                    console.error('Error sending SOS alert:', error);
                    UIManager.showNotification('Error sending SOS alert', 'error');
                });
        };
        
        window.downloadReceipt = function() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const receiptContent = document.getElementById('receiptContent').innerText;
            
            doc.setFontSize(20);
            doc.setTextColor(255, 107, 53);
            doc.text('JUBEL RIDE RECEIPT', 105, 20, { align: 'center' });
            
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            
            // Add receipt content
            const lines = doc.splitTextToSize(receiptContent, 180);
            doc.text(lines, 20, 40);
            
            // Save PDF
            doc.save('jubel-receipt.pdf');
            UIManager.showNotification('Receipt downloaded', 'success');
        };
        
        window.shareReferralCode = function() {
            AccountManager.shareReferralCode();
        };
        
        window.deposit = function() {
            AccountManager.deposit();
        };
        
        window.withdraw = function() {
            AccountManager.withdraw();
        };
        
        window.contactWhatsApp = function() {
            window.open('https://wa.me/260768658484?text=Hello%20Jubel%20support', '_blank');
        };
        
        window.contactPhone = function() {
            window.open('tel:0768658484', '_self');
        };
        
        window.selectVehicle = function(element) {
            // Remove selected class from all vehicle options
            document.querySelectorAll('.vehicle-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Add selected class to clicked option
            element.classList.add('selected');
            
            // Update selected vehicle type
            AppState.selectedVehicleType = element.dataset.type;
            
            // Recalculate fare
            if (AppState.userLocation && document.getElementById('destinationLocation').value) {
                // This would recalculate the fare
                // Implementation depends on your specific logic
            }
        };
        
        window.selectPayment = function(element) {
            // Remove selected class from all payment options
            document.querySelectorAll('.payment-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Add selected class to clicked option
            element.classList.add('selected');
            
            // Update selected payment type
            AppState.selectedPaymentType = element.dataset.paymentType;
            
            // Check wallet balance
            if (AppState.selectedPaymentType === 'wallet') {
                if (AppState.walletBalance < AppState.rideFare) {
                    document.getElementById('insufficientBalance').style.display = 'block';
                    document.getElementById('confirmPaymentBtn').disabled = true;
                } else {
                    document.getElementById('insufficientBalance').style.display = 'none';
                    document.getElementById('confirmPaymentBtn').disabled = false;
                }
            } else {
                document.getElementById('insufficientBalance').style.display = 'none';
                document.getElementById('confirmPaymentBtn').disabled = false;
            }
        };
        
        window.selectRideTypeOption = function(element) {
            // Remove selected class from all ride type options
            document.querySelectorAll('.ride-type-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Add selected class to clicked option
            element.classList.add('selected');
        };

        // Event listeners setup
        AuthManager.setupEventListeners = function() {
            // Navigation buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    UIManager.switchScreen(this.dataset.screen);
                });
            });
            
            // Back buttons
            document.querySelectorAll('.back-button').forEach(btn => {
                btn.addEventListener('click', function() {
                    UIManager.switchScreen(this.dataset.screen);
                });
            });
            
            // Panel collapse handle
            document.getElementById('panelCollapseHandle').addEventListener('click', UIManager.togglePanel);
            
            // Close modals
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', function() {
                    const modal = this.closest('.modal');
                    if (modal) {
                        modal.classList.remove('active');
                    }
                });
            });
            
            // Destination search
            document.getElementById('destinationLocation').addEventListener('input', (e) => {
                SearchHandler.handleSearchInput(e, 'destinationSuggestions');
            });
            
            document.getElementById('destinationLocation').addEventListener('keydown', (e) => {
                SearchHandler.handleSearchKeydown(e, 'destinationSuggestions');
            });
            
            document.getElementById('destinationLocation').addEventListener('focus', () => {
                const query = document.getElementById('destinationLocation').value;
                if (query.length >= 2) {
                    SearchHandler.handleSearchInput({ target: { value: query } }, 'destinationSuggestions');
                }
            });
            
            // Click outside to close suggestions
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.location-input') && !e.target.closest('.suggestion-list')) {
                    document.querySelectorAll('.suggestion-list').forEach(list => {
                        list.classList.remove('visible');
                    });
                }
            });
            
            // Saved locations
            document.querySelectorAll('.saved-location-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const addressType = this.dataset.address;
                    const addresses = {
                        home: '123 Home Street, Lusaka',
                        work: '456 Work Avenue, Lusaka'
                    };
                    
                    if (addresses[addressType]) {
                        document.getElementById('destinationLocation').value = addresses[addressType];
                        
                        // Trigger search for this address
                        SearchHandler.handleSearchInput(
                            { target: { value: addresses[addressType] } },
                            'destinationSuggestions'
                        );
                    }
                });
            });
            
            // History filter
            document.getElementById('historyFilter').addEventListener('change', HistoryManager.loadHistory);
            document.getElementById('historyDate').addEventListener('change', HistoryManager.loadHistory);
            
            // More options dropdown
            document.querySelectorAll('.more-option-item').forEach(item => {
                item.addEventListener('click', function() {
                    window.handleMoreOption(this.dataset.option);
                });
            });
            
            // Promo toggle
            document.getElementById('promoToggle').addEventListener('click', function() {
                document.getElementById('promoSection').classList.toggle('active');
            });
            
            // Vehicle options
            document.querySelectorAll('.vehicle-option').forEach(option => {
                option.addEventListener('click', function() {
                    window.selectVehicle(this);
                });
            });
            
            // Payment options
            document.querySelectorAll('.payment-option').forEach(option => {
                option.addEventListener('click', function() {
                    window.selectPayment(this);
                });
            });
            
            // Ride type options
            document.querySelectorAll('.ride-type-option').forEach(option => {
                option.addEventListener('click', function() {
                    window.selectRideTypeOption(this);
                });
            });
            
            // Emergency services
            document.querySelectorAll('.emergency-service').forEach(service => {
                service.addEventListener('click', function() {
                    const vehicleType = this.dataset.type;
                    UIManager.showNotification(`${vehicleType} service selected`, 'info');
                    // Handle emergency service selection
                });
            });
            
            // Request ride button
            document.getElementById('requestRideBtn').addEventListener('click', window.requestRide);
            
            // Apply promo button
            document.getElementById('applyPromoBtn').addEventListener('click', window.applyPromoCode);
            
            // Select ride type button
            document.getElementById('selectRideTypeBtn').addEventListener('click', window.selectRideType);
            
            // Confirm payment button
            document.getElementById('confirmPaymentBtn').addEventListener('click', window.confirmPayment);
            
            // Cancel ride button
            document.getElementById('cancelRideBtn')?.addEventListener('click', window.cancelRide);
            
            // Contact driver button
            document.getElementById('contactDriverBtn')?.addEventListener('click', window.contactDriver);
            
            // SOS button
            document.getElementById('sosButton')?.addEventListener('click', window.triggerSOS);
            
            // Download receipt button
            document.getElementById('downloadReceiptBtn')?.addEventListener('click', window.downloadReceipt);
            
            // Account actions
            document.getElementById('shareReferralBtn')?.addEventListener('click', window.shareReferralCode);
            document.getElementById('depositBtn')?.addEventListener('click', window.deposit);
            document.getElementById('withdrawBtn')?.addEventListener('click', window.withdraw);
            document.getElementById('whatsappBtn')?.addEventListener('click', window.contactWhatsApp);
            document.getElementById('callBtn')?.addEventListener('click', window.contactPhone);
            
            // More options button
            document.getElementById('moreOptionsBtn').addEventListener('click', window.toggleMoreOptions);
        };

        // Global helper functions
        window.UIManager = UIManager;
        window.RideManager = RideManager;
        window.HistoryManager = HistoryManager;
        window.AccountManager = AccountManager;
        window.ScheduleManager = ScheduleManager;

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Enhanced Jubel Passenger App Initialized');
            UIManager.showNotification('Welcome to Jubel!', 'success');
        });

        // Handle offline/online status
        window.addEventListener('online', () => {
            UIManager.showNotification('Connection restored', 'success');
            if (AppState.currentScreen === 'home') {
                LocationManager.getCurrentPosition().catch(console.error);
            }
        });

        window.addEventListener('offline', () => {
            UIManager.showNotification('You are offline. Some features may not work.', 'warning');
        });

        // Handle page visibility
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && AppState.currentScreen === 'home') {
                // Refresh location when page becomes visible
                LocationManager.getCurrentPosition().catch(console.error);
            }
        });

        // Clean up on page unload
        window.addEventListener('beforeunload', () => {
            LocationManager.stopWatching();
            
            // Remove all Firebase listeners
            Object.values(AppState.listeners).forEach(listener => {
                if (listener && typeof listener === 'function') {
                    listener();
                }
            });
        });
    </script>
</body>
</html>
    </script>
</body>
</html>

