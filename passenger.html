<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jubel - Ride Hailing App</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-orange: #FF6B35;
            --primary-orange-dark: #E55A2B;
            --primary-orange-light: #FF8B5C;
            --background-white: #FFFFFF;
            --card-white: #F9FAFB;
            --text-dark: #1F2937;
            --text-gray: #6B7280;
            --text-light: #9CA3AF;
            --border-light: #E5E7EB;
            --shadow-light: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-medium: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-large: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --success-green: #10B981;
            --error-red: #EF4444;
            --warning-yellow: #F59E0B;
            --info-blue: #3B82F6;
            --radius-small: 8px;
            --radius-medium: 12px;
            --radius-large: 16px;
            --radius-xlarge: 24px;
            --transition-fast: 150ms;
            --transition-normal: 300ms;
            --transition-slow: 500ms;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        body {
            background: var(--background-white);
            color: var(--text-dark);
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        /* Map Container - 60% of screen */
        #map {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 60%;
            z-index: 1;
            transition: height var(--transition-normal);
        }

        .map-loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-light);
            border-top-color: var(--primary-orange);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .map-loading-text {
            color: var(--text-gray);
            font-weight: 500;
        }

        /* Top Navigation Bar */
        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 100;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: var(--primary-orange);
            border-radius: var(--radius-small);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-icon img {
            width: 24px;
            height: 24px;
        }

        .logo-text {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-dark);
        }

        .user-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .balance-badge {
            background: var(--card-white);
            padding: 8px 12px;
            border-radius: var(--radius-large);
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            color: var(--text-gray);
            border: 1px solid var(--border-light);
            transition: all var(--transition-fast);
        }

        .balance-badge:hover {
            background: white;
            box-shadow: var(--shadow-light);
        }

        .balance-amount {
            color: var(--primary-orange);
            font-weight: 600;
        }

        .notification-bell {
            position: relative;
            width: 36px;
            height: 36px;
            background: var(--card-white);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-fast);
            border: 1px solid var(--border-light);
        }

        .notification-bell:hover {
            background: white;
            box-shadow: var(--shadow-light);
        }

        .notification-bell i {
            color: var(--text-gray);
            font-size: 16px;
        }

        .notification-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            background: var(--error-red);
            color: white;
            font-size: 10px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        /* Main Panel - 40% of screen */
        .main-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 45%;
            background: white;
            border-radius: var(--radius-xlarge) var(--radius-xlarge) 0 0;
            box-shadow: var(--shadow-large);
            z-index: 200;
            transition: all var(--transition-normal);
            padding: 0 20px;
            overflow-y: auto;
            padding-bottom: 20px;
        }

        .main-panel.collapsed {
            height: 80px;
        }

        .panel-handle {
            width: 40px;
            height: 4px;
            background: var(--border-light);
            border-radius: 2px;
            margin: 12px auto;
            cursor: pointer;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-light);
            margin-bottom: 15px;
        }

        .nav-tab {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 12px;
            padding: 8px 12px;
            border-radius: var(--radius-medium);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .nav-tab i {
            font-size: 18px;
            margin-bottom: 2px;
        }

        .nav-tab.active {
            color: var(--primary-orange);
            background: rgba(255, 107, 53, 0.1);
        }

        .nav-tab:hover:not(.active) {
            background: var(--card-white);
        }

        /* Service Tabs */
        .service-tabs {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .service-tab {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 8px;
            background: var(--card-white);
            border-radius: var(--radius-medium);
            cursor: pointer;
            transition: all var(--transition-fast);
            border: 1px solid transparent;
        }

        .service-tab.active {
            background: white;
            border-color: var(--primary-orange);
            box-shadow: var(--shadow-light);
        }

        .service-tab:hover:not(.active) {
            background: white;
            box-shadow: var(--shadow-light);
        }

        .service-icon {
            width: 36px;
            height: 36px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            box-shadow: var(--shadow-light);
        }

        .service-tab.active .service-icon {
            background: var(--primary-orange);
        }

        .service-tab.active .service-icon i {
            color: white;
        }

        .service-icon i {
            color: var(--text-gray);
            font-size: 18px;
        }

        .service-name {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 2px;
        }

        .service-desc {
            font-size: 10px;
            color: var(--text-light);
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .quick-action-btn {
            display: flex;
            align-items: center;
            padding: 12px;
            background: var(--card-white);
            border-radius: var(--radius-medium);
            border: none;
            cursor: pointer;
            transition: all var(--transition-fast);
            text-align: left;
        }

        .quick-action-btn:hover {
            background: white;
            box-shadow: var(--shadow-light);
        }

        .quick-action-icon {
            width: 36px;
            height: 36px;
            background: white;
            border-radius: var(--radius-small);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            box-shadow: var(--shadow-light);
        }

        .quick-action-icon i {
            color: var(--primary-orange);
            font-size: 16px;
        }

        .quick-action-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 2px;
        }

        .quick-action-desc {
            font-size: 11px;
            color: var(--text-light);
        }

        /* Ride Request Form */
        .ride-request-form {
            display: block;
            animation: fadeIn var(--transition-normal);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 18px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 20px;
        }

        .form-title i {
            color: var(--primary-orange);
        }

        .location-inputs {
            background: var(--card-white);
            border-radius: var(--radius-medium);
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
        }

        .location-input {
            display: flex;
            align-items: center;
            position: relative;
            margin-bottom: 12px;
            padding: 12px;
            background: white;
            border-radius: var(--radius-small);
            border: 1px solid var(--border-light);
            transition: all var(--transition-fast);
        }

        .location-input:last-child {
            margin-bottom: 0;
        }

        .location-input.active {
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }

        .location-input i {
            color: var(--text-light);
            margin-right: 12px;
            font-size: 16px;
            min-width: 16px;
        }

        .location-input input {
            flex: 1;
            border: none;
            outline: none;
            background: none;
            font-size: 14px;
            color: var(--text-dark);
        }

        .location-input input::placeholder {
            color: var(--text-light);
        }

        .suggestion-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: var(--radius-medium);
            box-shadow: var(--shadow-medium);
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            margin-top: 5px;
        }

        .suggestion-list.active {
            display: block;
        }

        .suggestion-item {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-light);
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: flex-start;
        }

        .suggestion-item:hover {
            background: var(--card-white);
        }

        .suggestion-icon {
            width: 20px;
            margin-right: 12px;
            color: var(--text-light);
        }

        .suggestion-details {
            flex: 1;
        }

        .suggestion-name {
            font-weight: 500;
            color: var(--text-dark);
            margin-bottom: 2px;
        }

        .suggestion-address {
            font-size: 12px;
            color: var(--text-light);
        }

        .suggestion-distance {
            font-size: 11px;
            color: var(--primary-orange);
            margin-top: 4px;
        }

        .search-loading {
            display: none;
            position: absolute;
            right: 12px;
            width: 16px;
            height: 16px;
            border: 2px solid var(--border-light);
            border-top-color: var(--primary-orange);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .location-input.searching .search-loading {
            display: block;
        }

        /* Ride Type Selection */
        .ride-type-selection {
            margin: 20px 0;
        }

        .ride-type-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .ride-type-title span:first-child {
            font-weight: 600;
            color: var(--text-dark);
        }

        .ride-type-cards {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .ride-type-card {
            min-width: 110px;
            padding: 15px;
            background: var(--card-white);
            border-radius: var(--radius-medium);
            border: 2px solid transparent;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .ride-type-card.selected {
            background: white;
            border-color: var(--primary-orange);
            box-shadow: var(--shadow-light);
        }

        .ride-type-card:hover:not(.selected) {
            background: white;
            box-shadow: var(--shadow-light);
        }

        .ride-type-icon {
            width: 36px;
            height: 36px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
        }

        .ride-type-card.selected .ride-type-icon {
            background: var(--primary-orange);
        }

        .ride-type-card.selected .ride-type-icon i {
            color: white;
        }

        .ride-type-icon i {
            color: var(--text-gray);
            font-size: 16px;
        }

        .ride-type-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 4px;
        }

        .ride-type-price {
            font-size: 16px;
            font-weight: 700;
            color: var(--primary-orange);
        }

        /* Fare Display */
        .fare-display {
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-orange-dark));
            color: white;
            border-radius: var(--radius-medium);
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            animation: slideInUp var(--transition-normal);
        }

        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fare-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 4px;
        }

        .fare-amount {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .fare-details {
            display: flex;
            justify-content: center;
            gap: 15px;
            font-size: 12px;
            opacity: 0.9;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: var(--radius-medium);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary-orange);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-orange-dark);
            box-shadow: var(--shadow-medium);
        }

        .btn-secondary {
            background: var(--card-white);
            color: var(--text-dark);
            border: 1px solid var(--border-light);
        }

        .btn-secondary:hover {
            background: white;
            box-shadow: var(--shadow-light);
        }

        .btn-danger {
            background: var(--error-red);
            color: white;
        }

        .btn-danger:hover {
            background: #DC2626;
            box-shadow: var(--shadow-medium);
        }

        .btn-orange {
            background: var(--primary-orange);
            color: white;
        }

        .btn-orange:hover {
            background: var(--primary-orange-dark);
        }

        /* Ride Info Panel */
        .ride-info-panel {
            animation: fadeIn var(--transition-normal);
        }

        .driver-info {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: var(--card-white);
            border-radius: var(--radius-medium);
            margin-bottom: 15px;
        }

        .driver-avatar {
            width: 60px;
            height: 60px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: var(--text-light);
            border: 2px solid var(--primary-orange);
        }

        .driver-details {
            flex: 1;
        }

        .driver-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 4px;
        }

        .driver-rating {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .driver-rating i {
            color: var(--warning-yellow);
        }

        .driver-vehicle {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 14px;
            color: var(--text-gray);
        }

        .driver-media {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .media-container {
            position: relative;
            height: 100px;
            border-radius: var(--radius-medium);
            overflow: hidden;
        }

        .media-placeholder {
            width: 100%;
            height: 100%;
            background: var(--card-white);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
        }

        .media-placeholder i {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .media-placeholder span {
            font-size: 12px;
        }

        /* Timeline */
        .timeline {
            display: flex;
            justify-content: space-between;
            position: relative;
            margin: 20px 0;
            padding: 0 10px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            top: 12px;
            left: 10%;
            right: 10%;
            height: 2px;
            background: var(--border-light);
            z-index: 1;
        }

        .timeline-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
            flex: 1;
        }

        .step-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--border-light);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            transition: all var(--transition-normal);
        }

        .step-dot i {
            font-size: 10px;
            color: var(--text-light);
        }

        .step-dot.active {
            background: var(--primary-orange);
        }

        .step-dot.active i {
            color: white;
        }

        .step-dot.completed {
            background: var(--success-green);
        }

        .step-dot.completed i {
            color: white;
        }

        .step-label {
            font-size: 11px;
            color: var(--text-light);
            text-align: center;
            max-width: 60px;
        }

        .step-label.active {
            color: var(--primary-orange);
            font-weight: 600;
        }

        /* Trip Details */
        .trip-locations {
            background: var(--card-white);
            border-radius: var(--radius-medium);
            padding: 15px;
            margin-bottom: 15px;
        }

        .location-point {
            display: flex;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .location-point:last-child {
            margin-bottom: 0;
        }

        .location-marker {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .location-marker.pickup {
            background: var(--primary-orange);
        }

        .location-marker.pickup i {
            color: white;
            font-size: 14px;
        }

        .location-marker.destination {
            background: var(--info-blue);
        }

        .location-marker.destination i {
            color: white;
            font-size: 14px;
        }

        .location-text {
            flex: 1;
        }

        .location-label {
            font-size: 11px;
            color: var(--text-light);
            margin-bottom: 2px;
        }

        .location-address {
            font-size: 14px;
            color: var(--text-dark);
            font-weight: 500;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            animation: fadeIn var(--transition-normal);
        }

        .modal {
            background: white;
            border-radius: var(--radius-xlarge);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-large);
            animation: slideInUp var(--transition-normal);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            border-bottom: 1px solid var(--border-light);
            position: sticky;
            top: 0;
            background: white;
            border-radius: var(--radius-xlarge) var(--radius-xlarge) 0 0;
            z-index: 10;
        }

        .modal-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
            font-weight: 600;
            color: var(--text-dark);
        }

        .modal-title i {
            color: var(--primary-orange);
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: var(--card-white);
            color: var(--text-gray);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }

        .modal-close:hover {
            background: var(--error-red);
            color: white;
        }

        .modal-content {
            padding: 20px;
        }

        /* Form Groups */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-dark);
            margin-bottom: 8px;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-medium);
            font-size: 14px;
            color: var(--text-dark);
            background: white;
            transition: all var(--transition-fast);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* Payment Methods */
        .payment-methods {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }

        .payment-method {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 2px solid var(--border-light);
            border-radius: var(--radius-medium);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .payment-method.selected {
            border-color: var(--primary-orange);
            background: rgba(255, 107, 53, 0.05);
        }

        .payment-method:hover:not(.selected) {
            border-color: var(--primary-orange-light);
        }

        .payment-icon {
            width: 40px;
            height: 40px;
            background: var(--card-white);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
        }

        .payment-icon i {
            color: var(--primary-orange);
            font-size: 18px;
        }

        .payment-details {
            flex: 1;
        }

        .payment-name {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 2px;
        }

        .payment-info {
            font-size: 12px;
            color: var(--text-light);
        }

        /* Toast Container */
        .toast-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 350px;
        }

        .toast {
            background: white;
            border-radius: var(--radius-medium);
            padding: 15px;
            box-shadow: var(--shadow-medium);
            display: flex;
            align-items: flex-start;
            gap: 12px;
            animation: slideInRight var(--transition-normal);
            transform-origin: top right;
        }

        .toast.success {
            border-left: 4px solid var(--success-green);
        }

        .toast.error {
            border-left: 4px solid var(--error-red);
        }

        .toast.warning {
            border-left: 4px solid var(--warning-yellow);
        }

        .toast.info {
            border-left: 4px solid var(--info-blue);
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .toast-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .toast.success .toast-icon {
            background: var(--success-green);
            color: white;
        }

        .toast.error .toast-icon {
            background: var(--error-red);
            color: white;
        }

        .toast.warning .toast-icon {
            background: var(--warning-yellow);
            color: white;
        }

        .toast.info .toast-icon {
            background: var(--info-blue);
            color: white;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 4px;
        }

        .toast-message {
            font-size: 14px;
            color: var(--text-gray);
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toast.hiding {
            animation: slideOutRight var(--transition-normal);
        }

        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .loading-text {
            margin-top: 15px;
            color: var(--text-gray);
            font-weight: 500;
        }

        /* Map Controls */
        .map-controls {
            position: fixed;
            bottom: calc(45% + 20px);
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 150;
            transition: bottom var(--transition-normal);
        }

        .map-control-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: white;
            border: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-dark);
            cursor: pointer;
            transition: all var(--transition-fast);
            box-shadow: var(--shadow-light);
        }

        .map-control-btn:hover {
            background: var(--primary-orange);
            color: white;
            border-color: var(--primary-orange);
            transform: scale(1.05);
        }

        .map-control-btn i {
            font-size: 18px;
        }

        /* SOS Button */
        .sos-button {
            position: fixed;
            bottom: calc(45% + 20px);
            left: 20px;
            width: 60px;
            height: 60px;
            background: var(--error-red);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            cursor: pointer;
            z-index: 150;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
            transition: all var(--transition-fast);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        .sos-button:hover {
            transform: scale(1.1);
        }

        /* Emergency Status */
        .emergency-status {
            position: fixed;
            top: 70px;
            left: 0;
            right: 0;
            background: linear-gradient(90deg, var(--error-red), #F87171);
            color: white;
            padding: 12px 20px;
            text-align: center;
            font-weight: 600;
            z-index: 150;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            animation: slideInDown var(--transition-normal);
        }

        @keyframes slideInDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }

        /* Ride Status Bar */
        .ride-status-bar {
            position: fixed;
            top: 70px;
            left: 0;
            right: 0;
            background: white;
            padding: 12px 20px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 150;
            box-shadow: var(--shadow-light);
            animation: slideInDown var(--transition-normal);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .status-dot.searching {
            background: var(--warning-yellow);
            animation: pulse 1.5s infinite;
        }

        .status-dot.arriving {
            background: var(--info-blue);
            animation: pulse 1s infinite;
        }

        .status-dot.riding {
            background: var(--success-green);
        }

        .status-text {
            font-weight: 600;
            color: var(--text-dark);
        }

        .status-eta {
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--primary-orange);
            font-weight: 600;
        }

        /* City Detection */
        .city-detection {
            position: fixed;
            top: 70px;
            left: 0;
            right: 0;
            background: var(--primary-orange);
            color: white;
            padding: 8px 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px;
            z-index: 150;
            animation: slideInDown var(--transition-normal);
        }

        /* History Screen */
        .history-screen,
        .account-screen,
        .emergency-screen {
            display: none;
            animation: fadeIn var(--transition-normal);
        }

        .screen-header {
            display: flex;
            align-items: center;
            padding: 10px 0 20px;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-light);
        }

        .back-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: var(--card-white);
            color: var(--text-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .back-btn:hover {
            background: var(--primary-orange);
            color: white;
        }

        .screen-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-dark);
        }

        .history-filters {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 10px 0;
            margin-bottom: 20px;
        }

        .filter-btn {
            padding: 8px 16px;
            background: var(--card-white);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-large);
            font-size: 12px;
            color: var(--text-gray);
            cursor: pointer;
            white-space: nowrap;
            transition: all var(--transition-fast);
        }

        .filter-btn.active {
            background: var(--primary-orange);
            color: white;
            border-color: var(--primary-orange);
        }

        .filter-btn:hover:not(.active) {
            background: white;
            border-color: var(--primary-orange-light);
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .history-item {
            background: var(--card-white);
            border-radius: var(--radius-medium);
            padding: 15px;
            border: 1px solid transparent;
            transition: all var(--transition-fast);
            cursor: pointer;
        }

        .history-item:hover {
            background: white;
            border-color: var(--border-light);
            box-shadow: var(--shadow-light);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .history-type {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .history-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .history-icon i {
            font-size: 14px;
        }

        .history-type-name {
            font-weight: 600;
            color: var(--text-dark);
        }

        .history-date {
            font-size: 11px;
            color: var(--text-light);
        }

        .history-locations {
            margin-bottom: 10px;
        }

        .history-location {
            display: flex;
            align-items: flex-start;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .history-location:last-child {
            margin-bottom: 0;
        }

        .history-location i {
            color: var(--text-light);
            margin-right: 8px;
            margin-top: 2px;
            font-size: 12px;
        }

        .history-location-text {
            flex: 1;
            color: var(--text-gray);
        }

        .history-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-price {
            font-size: 16px;
            font-weight: 700;
            color: var(--primary-orange);
        }

        .history-status {
            font-size: 11px;
            padding: 4px 8px;
            border-radius: var(--radius-large);
            font-weight: 600;
        }

        .status-completed {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-green);
        }

        .status-cancelled {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error-red);
        }

        .status-ongoing {
            background: rgba(59, 130, 246, 0.1);
            color: var(--info-blue);
        }

        /* Account Screen */
        .account-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .account-avatar {
            width: 80px;
            height: 80px;
            background: var(--card-white);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: var(--text-light);
            margin: 0 auto 15px;
            border: 3px solid var(--primary-orange);
        }

        .account-name {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 4px;
        }

        .account-phone {
            font-size: 14px;
            color: var(--text-gray);
        }

        .account-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--card-white);
            border-radius: var(--radius-medium);
            padding: 15px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-orange);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .account-section {
            background: var(--card-white);
            border-radius: var(--radius-medium);
            padding: 20px;
            margin-bottom: 15px;
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 15px;
        }

        .section-title i {
            color: var(--primary-orange);
        }

        .wallet-balance {
            text-align: center;
            margin-bottom: 20px;
        }

        .balance-label {
            font-size: 12px;
            color: var(--text-light);
            margin-bottom: 4px;
        }

        .balance-amount-large {
            font-size: 36px;
            font-weight: 700;
            color: var(--primary-orange);
        }

        .wallet-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .btn-wallet {
            padding: 12px;
            background: white;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-medium);
            font-size: 14px;
            font-weight: 500;
            color: var(--text-dark);
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-wallet:hover {
            background: var(--primary-orange);
            color: white;
            border-color: var(--primary-orange);
        }

        .referral-card {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: var(--radius-medium);
            margin-bottom: 15px;
        }

        .referral-code {
            background: var(--primary-orange);
            color: white;
            padding: 15px;
            border-radius: var(--radius-medium);
            font-size: 20px;
            font-weight: 700;
            letter-spacing: 1px;
            margin: 15px 0;
            font-family: monospace;
        }

        .referral-note {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 10px;
        }

        /* Emergency Screen */
        .emergency-services {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .emergency-service {
            background: var(--card-white);
            border-radius: var(--radius-medium);
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-fast);
            border: 2px solid transparent;
        }

        .emergency-service:hover {
            background: white;
            border-color: var(--primary-orange);
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .emergency-service.police:hover {
            border-color: #3B82F6;
        }

        .emergency-service.fire:hover {
            border-color: #EF4444;
        }

        .emergency-service.medical:hover {
            border-color: #10B981;
        }

        .emergency-icon {
            width: 60px;
            height: 60px;
            background: var(--primary-orange);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-size: 24px;
            color: white;
        }

        .emergency-service.police .emergency-icon {
            background: #3B82F6;
        }

        .emergency-service.fire .emergency-icon {
            background: #EF4444;
        }

        .emergency-service.medical .emergency-icon {
            background: #10B981;
        }

        .emergency-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 4px;
        }

        .emergency-description {
            font-size: 12px;
            color: var(--text-light);
        }

        .emergency-note {
            background: rgba(245, 158, 11, 0.1);
            border-left: 4px solid var(--warning-yellow);
            padding: 15px;
            border-radius: var(--radius-small);
            font-size: 13px;
            color: var(--text-gray);
        }

        .emergency-note p {
            margin-bottom: 8px;
        }

        .emergency-note p:last-child {
            margin-bottom: 0;
        }

        /* Chat Container */
        .chat-container {
            position: fixed;
            bottom: 45%;
            right: 20px;
            width: 320px;
            height: 400px;
            background: white;
            border-radius: var(--radius-large);
            box-shadow: var(--shadow-large);
            display: flex;
            flex-direction: column;
            z-index: 300;
            transform: translateY(100%);
            transition: transform var(--transition-normal);
        }

        .chat-container.active {
            transform: translateY(0);
        }

        .chat-header {
            padding: 15px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--primary-orange);
            color: white;
            border-radius: var(--radius-large) var(--radius-large) 0 0;
        }

        .chat-title {
            font-weight: 600;
        }

        .chat-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .message {
            max-width: 80%;
            padding: 10px 12px;
            border-radius: var(--radius-medium);
            font-size: 14px;
            position: relative;
        }

        .message.sent {
            background: var(--primary-orange);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .message.received {
            background: var(--card-white);
            color: var(--text-dark);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .message-time {
            font-size: 10px;
            opacity: 0.7;
            margin-top: 4px;
            text-align: right;
        }

        .chat-typing-indicator {
            padding: 0 15px 10px;
            font-size: 12px;
            color: var(--text-light);
            display: none;
        }

        .chat-typing-indicator.active {
            display: block;
        }

        .chat-input-container {
            padding: 15px;
            border-top: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-attachment-btn,
        .chat-send-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: var(--card-white);
            color: var(--text-gray);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }

        .chat-send-btn {
            background: var(--primary-orange);
            color: white;
        }

        .chat-send-btn:hover {
            background: var(--primary-orange-dark);
        }

        .chat-attachment-btn:hover {
            background: white;
            color: var(--primary-orange);
        }

        .chat-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-large);
            font-size: 14px;
            color: var(--text-dark);
            background: var(--card-white);
            transition: all var(--transition-fast);
        }

        .chat-input:focus {
            outline: none;
            background: white;
            border-color: var(--primary-orange);
        }

        /* Notifications Panel */
        .notifications-panel {
            position: fixed;
            top: 60px;
            right: 20px;
            width: 320px;
            height: 400px;
            background: white;
            border-radius: var(--radius-large);
            box-shadow: var(--shadow-large);
            display: flex;
            flex-direction: column;
            z-index: 300;
            transform: translateX(100%);
            transition: transform var(--transition-normal);
        }

        .notifications-panel.active {
            transform: translateX(0);
        }

        .notifications-header {
            padding: 15px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--primary-orange);
            color: white;
            border-radius: var(--radius-large) var(--radius-large) 0 0;
        }

        .notifications-title {
            font-weight: 600;
        }

        .notifications-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notifications-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .notification-item {
            padding: 12px;
            background: var(--card-white);
            border-radius: var(--radius-medium);
            margin-bottom: 10px;
            cursor: pointer;
            transition: all var(--transition-fast);
            border-left: 3px solid transparent;
        }

        .notification-item.unread {
            border-left-color: var(--primary-orange);
            background: white;
        }

        .notification-item:hover {
            background: white;
            box-shadow: var(--shadow-light);
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .notification-title {
            font-weight: 600;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .notification-time {
            font-size: 11px;
            color: var(--text-light);
        }

        .notification-message {
            font-size: 13px;
            color: var(--text-gray);
            line-height: 1.4;
        }

        /* Dropdown Menu */
        .dropdown-menu,
        .more-options-menu {
            position: fixed;
            top: 60px;
            right: 20px;
            background: white;
            border-radius: var(--radius-medium);
            box-shadow: var(--shadow-large);
            z-index: 300;
            min-width: 200px;
            overflow: hidden;
            display: none;
        }

        .more-options-menu {
            top: auto;
            bottom: calc(45% + 60px);
            left: 20px;
            right: auto;
        }

        .more-options-menu.active {
            display: block;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            padding: 15px;
            gap: 12px;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .dropdown-item:hover {
            background: var(--card-white);
        }

        .dropdown-item i {
            width: 20px;
            color: var(--text-gray);
        }

        .dropdown-item span {
            flex: 1;
            color: var(--text-dark);
        }

        /* Pulsing Ride Icon */
        .pulsing-ride-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            background: rgba(255, 107, 53, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 36px;
            z-index: 100;
            animation: ridePulse 2s infinite;
            box-shadow: 0 0 30px rgba(255, 107, 53, 0.5);
        }

        @keyframes ridePulse {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        /* Real-time Indicators */
        .real-time-indicator,
        .sync-indicator {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 16px;
            border-radius: var(--radius-large);
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 150;
            opacity: 0;
            transition: opacity var(--transition-normal);
        }

        .real-time-indicator.active,
        .sync-indicator.active {
            opacity: 1;
        }

        .sync-indicator.syncing .sync-icon {
            animation: spin 1s linear infinite;
        }

        /* Schedule Countdown */
        .schedule-countdown {
            background: var(--primary-orange);
            color: white;
            padding: 15px;
            border-radius: var(--radius-medium);
            margin-bottom: 15px;
            text-align: center;
            animation: slideInUp var(--transition-normal);
        }

        .countdown-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .countdown-timer {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
            margin-bottom: 15px;
        }

        .time-unit {
            text-align: center;
        }

        .time-value {
            font-size: 32px;
            font-weight: 700;
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 10px;
            border-radius: var(--radius-small);
            min-width: 60px;
        }

        .time-label {
            font-size: 10px;
            opacity: 0.8;
            margin-top: 4px;
            text-transform: uppercase;
        }

        .time-separator {
            font-size: 24px;
            font-weight: 700;
            margin: 0 2px;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--card-white);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-orange-light);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-orange);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .service-tabs {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .quick-actions {
                grid-template-columns: 1fr;
            }
            
            .history-filters {
                padding-bottom: 5px;
            }
            
            .filter-btn {
                font-size: 11px;
                padding: 6px 12px;
            }
            
            .chat-container,
            .notifications-panel {
                width: calc(100vw - 40px);
                right: 20px;
            }
            
            .emergency-services {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .service-tabs {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .account-stats {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Map Container - 60% of screen -->
    <div id="map">
        <div class="map-loading-overlay" id="mapLoadingOverlay">
            <div class="loading-spinner"></div>
            <div class="map-loading-text">Loading map...</div>
        </div>
    </div>

    <!-- Top Navigation Bar -->
    <div class="top-bar">
        <div class="logo-container">
            <div class="logo-icon">
                <img src="jubel.png" alt="Jubel Logo" id="jubelLogo">
            </div>
            <div class="logo-text" id="userFullName">Loading...</div>
        </div>
        
        <div class="user-actions">
            <div class="balance-badge" id="balanceBadge">
                <i class="fas fa-wallet"></i>
                <span>Balance: <span class="balance-amount" id="walletBalance">ZMW 0.00</span></span>
            </div>
            <div class="notification-bell" id="notificationBell">
                <i class="fas fa-bell"></i>
                <span class="notification-badge" id="notificationCount">0</span>
            </div>
        </div>
    </div>

    <!-- City Detection Indicator -->
    <div class="city-detection" id="cityDetection">
        <i class="fas fa-map-marker-alt"></i>
        <span id="currentCityDisplay">Detecting your city...</span>
    </div>

    <!-- Ride Status Bar -->
    <div class="ride-status-bar" id="rideStatusBar">
        <div class="status-indicator">
            <div class="status-dot searching" id="statusDot"></div>
            <span class="status-text" id="statusText">Searching for driver</span>
        </div>
        <div class="status-eta">
            <i class="fas fa-clock"></i>
            <span id="etaText">5 min</span>
        </div>
    </div>

    <!-- Emergency Status -->
    <div class="emergency-status" id="emergencyStatus">
        <i class="fas fa-exclamation-triangle"></i>
        <span>EMERGENCY RIDE IN PROGRESS</span>
    </div>

    <!-- SOS Button -->
    <div class="sos-button" id="sosButton">
        <i class="fas fa-exclamation-triangle"></i>
    </div>

    <!-- Map Controls -->
    <div class="map-controls">
        <button class="map-control-btn" id="locateMeBtn" title="Locate Me">
            <i class="fas fa-location-arrow"></i>
        </button>
        <button class="map-control-btn" id="zoomInBtn" title="Zoom In">
            <i class="fas fa-plus"></i>
        </button>
        <button class="map-control-btn" id="zoomOutBtn" title="Zoom Out">
            <i class="fas fa-minus"></i>
        </button>
        <button class="map-control-btn" id="clearRouteBtn" title="Clear Route">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <!-- Main Panel - 40% of screen -->
    <div class="main-panel" id="mainPanel">
        <div class="panel-handle" id="panelHandle"></div>
        
        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" data-screen="home">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </button>
            <button class="nav-tab" data-screen="history">
                <i class="fas fa-history"></i>
                <span>History</span>
            </button>
            <button class="nav-tab" data-screen="account">
                <i class="fas fa-user"></i>
                <span>Account</span>
            </button>
            <button class="nav-tab" data-screen="emergency">
                <i class="fas fa-ambulance"></i>
                <span>Emergency</span>
            </button>
        </div>
        
        <!-- Home Screen Content -->
        <div id="homeContent">
            <!-- Service Tabs -->
            <div class="service-tabs" id="serviceTabs">
                <div class="service-tab car active" data-service="car">
                    <div class="service-icon">
                        <i class="fas fa-car"></i>
                    </div>
                    <div class="service-name">Car</div>
                    <div class="service-desc">Ride anywhere</div>
                </div>
                
                <div class="service-tab delivery" data-service="delivery">
                    <div class="service-icon">
                        <i class="fas fa-shipping-fast"></i>
                    </div>
                    <div class="service-name">Delivery</div>
                    <div class="service-desc">Send packages</div>
                </div>
                
                <div class="service-tab short-delivery" data-service="short-delivery">
                    <div class="service-icon">
                        <i class="fas fa-bicycle"></i>
                    </div>
                    <div class="service-name">Short Delivery</div>
                    <div class="service-desc">Quick deliveries</div>
                </div>
                
                <div class="service-tab" data-service="express">
                    <div class="service-icon">
                        <i class="fas fa-shopping-bag"></i>
                    </div>
                    <div class="service-name">Express Shopping</div>
                    <div class="service-desc">Shop for you</div>
                </div>
                
                <div class="service-tab" data-service="truck">
                    <div class="service-icon">
                        <i class="fas fa-truck"></i>
                    </div>
                    <div class="service-name">Truck</div>
                    <div class="service-desc">Move items</div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="quick-actions">
                <button class="quick-action-btn" id="moreOptionsBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-ellipsis-h"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">More Options</div>
                        <div class="quick-action-desc">Schedule, share, broadcast</div>
                    </div>
                </button>
                <button class="quick-action-btn" id="broadcastRideBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-broadcast-tower"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">Broadcast Ride</div>
                        <div class="quick-action-desc">Share with friends</div>
                    </div>
                </button>
                <button class="quick-action-btn" id="sosSetupBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">SOS Setup</div>
                        <div class="quick-action-desc">Emergency contacts</div>
                    </div>
                </button>
                <button class="quick-action-btn" id="recentDestinationsBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-history"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">Recent Destinations</div>
                        <div class="quick-action-desc">Quick access</div>
                    </div>
                </button>
            </div>
            
            <!-- Car Service Form -->
            <div class="ride-request-form active" id="carForm">
                <div class="form-title">
                    <i class="fas fa-car"></i>
                    Book a Ride
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="pickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="pickupLocation" placeholder="Current location" readonly>
                        <div class="search-loading" id="pickupSearchLoading"></div>
                        <div class="suggestion-list" id="pickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="destinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="destinationLocation" placeholder="Where to?" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="destinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Stops Container -->
                <div id="stopsContainer" style="margin: 10px 0;"></div>
                <button type="button" class="btn btn-secondary" id="addStopBtn" style="width: 100%; margin-bottom: 15px;">
                    <i class="fas fa-plus"></i> Add Stop
                </button>
                
                <!-- Ride Type Selection -->
                <div class="ride-type-selection" id="rideTypeSelection">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                        <span id="rideTypeInfo" style="font-size: 11px; color: var(--text-light); cursor: pointer;">
                            <i class="fas fa-info-circle"></i>
                        </span>
                    </div>
                    
                    <!-- Ride Type Cards -->
                    <div class="ride-type-cards" id="rideTypeCardsContainer">
                        <div class="ride-type-card economy" data-type="economy">
                            <div class="ride-type-icon">
                                <i class="fas fa-car-side"></i>
                            </div>
                            <div class="ride-type-name">Economy</div>
                            <div class="ride-type-price" id="economyPrice">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card selected" data-type="standard">
                            <div class="ride-type-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="ride-type-name">Standard</div>
                            <div class="ride-type-price" id="standardPrice">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card premium" data-type="premium">
                            <div class="ride-type-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="ride-type-name">Premium</div>
                            <div class="ride-type-price" id="premiumPrice">ZMW 0.00</div>
                        </div>
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="fareDisplay">
                    <div class="fare-label">Estimated Fare</div>
                    <div class="fare-amount" id="estimatedFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="distanceDetail">0 km</span>
                        <span id="timeDetail">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestRideBtn">
                        <i class="fas fa-search"></i>
                        Request Ride
                    </button>
                </div>
            </div>
            
            <!-- Other service forms (Delivery, Shopping, Truck, etc.) -->
            <!-- These are collapsed for brevity but follow the same pattern -->
            
            <!-- Ride Info Panel -->
            <div class="ride-info-panel" id="rideInfoPanel" style="display: none;">
                <div class="driver-info">
                    <div class="driver-avatar" id="driverAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="driver-details">
                        <div class="driver-name" id="driverName">Driver Name</div>
                        <div class="driver-rating">
                            <i class="fas fa-star"></i>
                            <span id="driverRating">4.8</span>
                        </div>
                        <div class="driver-vehicle">
                            <i class="fas fa-car"></i>
                            <span id="vehicleDetails">Toyota Corolla - ABC 123</span>
                        </div>
                    </div>
                </div>
                
                <!-- Timeline -->
                <div class="timeline" id="rideTimeline">
                    <div class="timeline-step">
                        <div class="step-dot active" id="stepRequested">
                            <i class="fas fa-search"></i>
                        </div>
                        <div class="step-label active">Requested</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepAccepted">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <div class="step-label">Accepted</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepArrived">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="step-label">Arrived</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepStarted">
                            <i class="fas fa-play"></i>
                        </div>
                        <div class="step-label">Started</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepCompleted">
                            <i class="fas fa-flag-checkered"></i>
                        </div>
                        <div class="step-label">Completed</div>
                    </div>
                </div>
                
                <div class="trip-details">
                    <div class="trip-locations">
                        <div class="location-point">
                            <div class="location-marker pickup">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="location-text">
                                <div class="location-label">Pickup</div>
                                <div class="location-address" id="currentPickup">Loading...</div>
                            </div>
                        </div>
                        
                        <div class="location-point">
                            <div class="location-marker destination">
                                <i class="fas fa-flag"></i>
                            </div>
                            <div class="location-text">
                                <div class="location-label">Destination</div>
                                <div class="location-address" id="currentDestination">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="fare-breakdown">
                    <div class="fare-row">
                        <span class="fare-label">Base Fare</span>
                        <span class="fare-value" id="baseFareValue">ZMW 15.00</span>
                    </div>
                    <div class="fare-row">
                        <span class="fare-label">Distance</span>
                        <span class="fare-value" id="distanceFareValue">ZMW 5.00</span>
                    </div>
                    <div class="fare-row">
                        <span class="fare-label">Ride Type</span>
                        <span class="fare-value" id="rideTypeValue">Standard</span>
                    </div>
                    <div class="fare-row total">
                        <span class="fare-label">Total Fare</span>
                        <span class="fare-value" id="totalFareValue">ZMW 20.00</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-danger" id="cancelRideBtn">
                        <i class="fas fa-times-circle"></i>
                        Cancel Ride
                    </button>
                    <button class="btn btn-secondary" id="contactDriverBtn">
                        <i class="fas fa-phone"></i>
                        Call Driver
                    </button>
                    <button class="btn btn-secondary" id="openChatBtn">
                        <i class="fas fa-comment"></i>
                        Chat
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Other screens (History, Account, Emergency) -->
    <!-- These are collapsed for brevity but follow the same pattern -->
    
    <!-- Modals (Payment, Cancel, Emergency, etc.) -->
    <!-- These are collapsed for brevity but follow the same pattern -->
    
    <!-- Chat Container -->
    <div class="chat-container" id="chatContainer">
        <div class="chat-header">
            <div class="chat-title">Chat with Driver</div>
            <button class="chat-close" id="chatClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <!-- Messages will be inserted here -->
        </div>
        <div class="chat-typing-indicator" id="typingIndicator">
            Driver is typing...
        </div>
        <div class="chat-input-container">
            <button class="chat-attachment-btn" id="attachmentBtn">
                <i class="fas fa-paperclip"></i>
            </button>
            <input type="text" class="chat-input" id="chatInput" placeholder="Type your message...">
            <button class="chat-send-btn" id="chatSend">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
    
    <!-- Notifications Panel -->
    <div class="notifications-panel" id="notificationsPanel">
        <div class="notifications-header">
            <div class="notifications-title">Notifications</div>
            <button class="notifications-close" id="notificationsClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="notifications-list" id="notificationsList">
            <!-- Notifications will be inserted here -->
        </div>
    </div>
    
    <!-- More Options Menu -->
    <div class="more-options-menu" id="moreOptionsMenu">
        <div class="dropdown-item" data-option="schedule">
            <i class="fas fa-calendar-alt"></i>
            <span>Schedule Ride</span>
        </div>
        <div class="dropdown-item" data-option="orderForSomeone">
            <i class="fas fa-user-friends"></i>
            <span>Order for Someone</span>
        </div>
        <div class="dropdown-item" data-option="shareRide">
            <i class="fas fa-share-alt"></i>
            <span>Share Ride</span>
        </div>
        <div class="dropdown-item" data-option="broadcast">
            <i class="fas fa-broadcast-tower"></i>
            <span>Broadcast Ride</span>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Loading...</div>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Real-time Indicator -->
    <div class="real-time-indicator" id="realTimeIndicator">
        <i class="fas fa-sync-alt"></i>
        <span>Real-time updates active</span>
    </div>
    
    <!-- Sync Indicator -->
    <div class="sync-indicator" id="syncIndicator">
        <i class="fas fa-sync-alt sync-icon"></i>
        <span>Syncing...</span>
    </div>
    
    <!-- External Libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>
    
    <!-- Main Application Script -->
    <script>
    // ============================================
    // FIREBASE CONFIGURATION
    // ============================================
    const firebaseConfig = {
        apiKey: "AIzaSyDEACX_P4c5q7djJAcA0I7Lk7leO2TlQ74",
        authDomain: "jubel-13e1a.firebaseapp.com",
        databaseURL: "https://jubel-13e1a-default-rtdb.firebaseio.com",
        projectId: "jubel-13e1a",
        storageBucket: "jubel-13e1a.firebasestorage.app",
        messagingSenderId: "882241095445",
        appId: "1:882241095445:web:ee9ca40fddd008ca910b1c",
        measurementId: "G-J5JPKL6B5F"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const auth = firebase.auth();
    const storage = firebase.storage();

    // ============================================
    // APPLICATION STATE
    // ============================================
    const AppState = {
        currentUser: null,
        userData: null,
        currentRide: null,
        activeScreen: 'home',
        activeService: 'car',
        walletBalance: 0,
        userLocation: null,
        currentCity: null,
        selectedRideType: 'standard',
        rideFare: 0,
        pickup: null,
        destination: null,
        notifications: [],
        unreadNotifications: 0,
        sosConfig: null,
        scheduledRides: [],
        shareRideFriends: [],
        maxShareFriends: 4,
        activeScheduledTimer: null,
        referralDiscountApplied: false,
        referralCodeUsed: null,
        referralOwnerName: null,
        rideTypes: {
            economy: { base: 15, perKm: 2.5, multiplier: 0.8, min: 10 },
            standard: { base: 20, perKm: 3.0, multiplier: 1.0, min: 15 },
            premium: { base: 30, perKm: 4.0, multiplier: 1.5, min: 25 }
        },
        realtimeListeners: []
    };

    // ============================================
    // MAP VARIABLES
    // ============================================
    let map = null;
    let currentLocationMarker = null;
    let pickupMarker = null;
    let destinationMarker = null;
    let driverMarker = null;
    let routeLayer = null;
    let pulsingIcon = null;

    // ============================================
    // CORE APPLICATION FUNCTIONS
    // ============================================

    // Initialize the application
    async function initializeApp() {
        try {
            showLoading('Initializing app...');
            
            // Check authentication
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    AppState.currentUser = user;
                    await loadUserData(user.uid);
                    await initializeMap();
                    await getCurrentLocation();
                    setupEventListeners();
                    startRealtimeSync(user.uid);
                    hideLoading();
                    showToast('Jubel Passenger App Ready', 'success');
                } else {
                    window.location.href = 'signup.html';
                }
            });
        } catch (error) {
            console.error('Error initializing app:', error);
            hideLoading();
            showToast('Error initializing app', 'error');
        }
    }

    // Load user data from Firebase
    async function loadUserData(uid) {
        try {
            const snapshot = await database.ref(`users/${uid}`).once('value');
            AppState.userData = snapshot.val();
            
            if (AppState.userData) {
                AppState.walletBalance = AppState.userData.walletBalance || 0;
                updateWalletBalance(AppState.walletBalance);
                updateUserInfo(AppState.userData);
                
                // Load SOS config
                await loadSOSConfig(uid);
                
                // Load scheduled rides
                await loadScheduledRides(uid);
                
                // Check for active ride
                await checkActiveRide(uid);
                
                // Load notifications
                await loadNotifications(uid);
            }
        } catch (error) {
            console.error('Error loading user data:', error);
        }
    }

    // Initialize the map
    function initializeMap() {
        return new Promise((resolve) => {
            const defaultLat = -15.4167; // Lusaka coordinates
            const defaultLng = 28.2833;
            
            map = L.map('map').setView([defaultLat, defaultLng], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: ' OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
            
            hideMapLoading();
            resolve();
        });
    }

    // Get current location
    async function getCurrentLocation() {
        if (!navigator.geolocation) {
            showToast('Geolocation not supported', 'warning');
            return;
        }
        
        try {
            const position = await new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject, {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                });
            });
            
            const { latitude, longitude } = position.coords;
            AppState.userLocation = { lat: latitude, lng: longitude };
            
            // Center map on user location
            map.setView([latitude, longitude], 15);
            
            // Add user location marker
            if (currentLocationMarker) {
                map.removeLayer(currentLocationMarker);
            }
            
            currentLocationMarker = L.marker([latitude, longitude], {
                icon: L.divIcon({
                    className: 'current-location-marker',
                    html: '<i class="fas fa-user"></i>',
                    iconSize: [18, 18],
                    iconAnchor: [9, 18]
                })
            }).addTo(map).bindPopup('Your Location');
            
            // Detect city from location
            await detectCityFromLocation(latitude, longitude);
            
        } catch (error) {
            console.error('Error getting location:', error);
            showToast('Could not get your location', 'warning');
        }
    }

    // Detect city from coordinates
    async function detectCityFromLocation(lat, lng) {
        try {
            const response = await fetch(
                `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=10&addressdetails=1`
            );
            const data = await response.json();
            
            const city = data.address.city || data.address.town || data.address.village;
            if (city) {
                AppState.currentCity = city;
                updateCityDisplay(city);
                showToast(`Detected city: ${city}`, 'success');
            }
        } catch (error) {
            console.error('Error detecting city:', error);
        }
    }

    // ============================================
    // UI UPDATE FUNCTIONS
    // ============================================

    function updateWalletBalance(balance) {
        const formatted = `ZMW ${balance.toFixed(2)}`;
        document.getElementById('walletBalance').textContent = formatted;
    }

    function updateUserInfo(userData) {
        if (userData.name) {
            document.getElementById('userFullName').textContent = userData.name;
        }
    }

    function updateCityDisplay(city) {
        document.getElementById('currentCityDisplay').textContent = `City: ${city}`;
    }

    function showToast(message, type = 'info', duration = 5000) {
        const toastContainer = document.getElementById('toastContainer');
        const toastId = 'toast-' + Date.now();
        
        const icons = {
            success: 'fa-check-circle',
            error: 'fa-exclamation-circle',
            warning: 'fa-exclamation-triangle',
            info: 'fa-info-circle'
        };
        
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.id = toastId;
        toast.innerHTML = `
            <div class="toast-icon">
                <i class="fas ${icons[type] || icons.info}"></i>
            </div>
            <div class="toast-content">
                <div class="toast-title">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
                <div class="toast-message">${message}</div>
            </div>
            <button class="toast-close" onclick="document.getElementById('${toastId}').remove()">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        toastContainer.appendChild(toast);
        
        setTimeout(() => {
            const toastElement = document.getElementById(toastId);
            if (toastElement) {
                toastElement.remove();
            }
        }, duration);
    }

    function showLoading(message = 'Loading...') {
        document.getElementById('loadingText').textContent = message;
        document.getElementById('loadingOverlay').style.display = 'flex';
    }

    function hideLoading() {
        document.getElementById('loadingOverlay').style.display = 'none';
    }

    function showMapLoading() {
        document.getElementById('mapLoadingOverlay').style.display = 'flex';
    }

    function hideMapLoading() {
        document.getElementById('mapLoadingOverlay').style.display = 'none';
    }

    // ============================================
    // SEARCH FUNCTIONS
    // ============================================

    async function searchLocations(query, type = 'destination') {
        if (!AppState.currentCity) {
            showToast('Please wait while we detect your city', 'warning');
            return [];
        }
        
        try {
            const searchUrl = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}+${encodeURIComponent(AppState.currentCity)}+Zambia&format=json&limit=10`;
            const response = await fetch(searchUrl);
            const data = await response.json();
            
            return data.map(place => ({
                id: place.place_id,
                name: place.display_name.split(',')[0],
                address: place.display_name,
                lat: parseFloat(place.lat),
                lng: parseFloat(place.lon)
            }));
        } catch (error) {
            console.error('Search error:', error);
            return [];
        }
    }

    function showSearchSuggestions(inputId, results) {
        const container = document.getElementById(`${inputId}Suggestions`);
        container.innerHTML = '';
        
        if (results.length === 0) {
            container.innerHTML = '<div class="suggestion-item">No results found</div>';
        } else {
            results.forEach(result => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.innerHTML = `
                    <div class="suggestion-icon">
                        <i class="fas fa-map-marker-alt"></i>
                    </div>
                    <div class="suggestion-details">
                        <div class="suggestion-name">${result.name}</div>
                        <div class="suggestion-address">${result.address}</div>
                    </div>
                `;
                item.addEventListener('click', () => {
                    selectLocation(inputId, result);
                });
                container.appendChild(item);
            });
        }
        
        container.style.display = 'block';
    }

    function selectLocation(inputId, location) {
        const input = document.getElementById(inputId);
        input.value = location.address;
        
        if (inputId === 'pickupLocation') {
            AppState.pickup = location;
            updatePickupMarker(location);
        } else if (inputId === 'destinationLocation') {
            AppState.destination = location;
            updateDestinationMarker(location);
            
            if (AppState.pickup) {
                calculateFare();
                drawRoute();
            }
        }
        
        document.getElementById(`${inputId}Suggestions`).style.display = 'none';
    }

    // ============================================
    // MAP FUNCTIONS
    // ============================================

    function updatePickupMarker(location) {
        if (pickupMarker) {
            map.removeLayer(pickupMarker);
        }
        
        pickupMarker = L.marker([location.lat, location.lng], {
            icon: L.divIcon({
                className: 'pickup-marker',
                html: '<i class="fas fa-map-marker-alt"></i>',
                iconSize: [20, 20],
                iconAnchor: [10, 20]
            })
        }).addTo(map).bindPopup('Pickup Location');
    }

    function updateDestinationMarker(location) {
        if (destinationMarker) {
            map.removeLayer(destinationMarker);
        }
        
        destinationMarker = L.marker([location.lat, location.lng], {
            icon: L.divIcon({
                className: 'destination-marker',
                html: '<i class="fas fa-flag"></i>',
                iconSize: [20, 20],
                iconAnchor: [10, 20]
            })
        }).addTo(map).bindPopup('Destination');
    }

    function drawRoute() {
        if (!AppState.pickup || !AppState.destination) return;
        
        if (routeLayer) {
            map.removeLayer(routeLayer);
        }
        
        const routeCoordinates = [
            [AppState.pickup.lat, AppState.pickup.lng],
            [AppState.destination.lat, AppState.destination.lng]
        ];
        
        routeLayer = L.polyline(routeCoordinates, {
            color: '#FF6B35',
            weight: 4,
            opacity: 0.7
        }).addTo(map);
        
        const bounds = L.latLngBounds(routeCoordinates);
        map.fitBounds(bounds, { padding: [50, 50] });
    }

    // ============================================
    // PRICE CALCULATION
    // ============================================

    function calculateFare() {
        if (!AppState.pickup || !AppState.destination) return;
        
        const distance = calculateDistance(
            AppState.pickup.lat, AppState.pickup.lng,
            AppState.destination.lat, AppState.destination.lng
        );
        
        const rideType = AppState.selectedRideType;
        const config = AppState.rideTypes[rideType];
        
        let fare = config.base + (distance * config.perKm);
        fare *= config.multiplier;
        fare = Math.max(fare, config.min);
        
        AppState.rideFare = fare;
        
        // Update UI
        document.getElementById('estimatedFare').textContent = `ZMW ${fare.toFixed(2)}`;
        document.getElementById('distanceDetail').textContent = `${distance.toFixed(1)} km`;
        
        // Update ride type prices
        Object.keys(AppState.rideTypes).forEach(type => {
            const typeConfig = AppState.rideTypes[type];
            let typeFare = typeConfig.base + (distance * typeConfig.perKm);
            typeFare *= typeConfig.multiplier;
            typeFare = Math.max(typeFare, typeConfig.min);
            document.getElementById(`${type}Price`).textContent = `ZMW ${typeFare.toFixed(2)}`;
        });
        
        // Show fare display
        document.getElementById('fareDisplay').style.display = 'block';
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // Earth's radius in km
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        const a = 
            Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * 
            Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    function toRad(value) {
        return value * Math.PI / 180;
    }

    // ============================================
    // RIDE MANAGEMENT
    // ============================================

    async function requestRide() {
        if (!AppState.pickup || !AppState.destination) {
            showToast('Please select pickup and destination', 'warning');
            return;
        }
        
        showPaymentModal('car', AppState.rideFare);
    }

    async function processPayment(paymentMethod) {
        try {
            showLoading('Processing payment...');
            
            // Create ride data
            const rideData = {
                pickup: AppState.pickup.address,
                pickupDisplay: AppState.pickup.name,
                destination: AppState.destination.address,
                destinationDisplay: AppState.destination.name,
                pickupLat: AppState.pickup.lat,
                pickupLng: AppState.pickup.lng,
                destLat: AppState.destination.lat,
                destLng: AppState.destination.lng,
                rideType: AppState.selectedRideType,
                fare: AppState.rideFare,
                paymentMethod: paymentMethod,
                status: 'requested',
                timestamp: Date.now(),
                passengerId: AppState.currentUser.uid,
                passengerName: AppState.userData.name,
                passengerPhone: AppState.userData.phone,
                city: AppState.currentCity
            };
            
            // Apply referral discount if applicable
            if (AppState.referralDiscountApplied) {
                rideData.referredBy = AppState.referralCodeUsed;
                rideData.referralOwnerName = AppState.referralOwnerName;
                rideData.referralDiscount = AppState.rideFare * 0.5;
                rideData.fare = AppState.rideFare * 0.5;
            }
            
            // Save ride to database
            const rideId = database.ref().child('rides').push().key;
            await database.ref(`rides/${rideId}`).set(rideData);
            
            // Update wallet if paying with wallet
            if (paymentMethod === 'wallet') {
                const newBalance = AppState.walletBalance - rideData.fare;
                await database.ref(`users/${AppState.currentUser.uid}/walletBalance`).set(newBalance);
                AppState.walletBalance = newBalance;
                updateWalletBalance(newBalance);
            }
            
            // Show ride info panel
            AppState.currentRide = { id: rideId, ...rideData };
            showRideInfo(rideData);
            showPulsingRideIcon();
            
            hideLoading();
            hideModal('payment');
            showToast('Ride requested successfully', 'success');
            
            // Start listening for ride updates
            listenToRideUpdates(rideId);
            
        } catch (error) {
            console.error('Error processing payment:', error);
            hideLoading();
            showToast('Error processing payment', 'error');
        }
    }

    function showRideInfo(ride) {
        // Hide ride request form
        document.querySelectorAll('.ride-request-form, .service-form').forEach(form => {
            form.style.display = 'none';
        });
        
        // Show ride info panel
        const rideInfoPanel = document.getElementById('rideInfoPanel');
        rideInfoPanel.style.display = 'block';
        
        // Update ride info
        document.getElementById('currentPickup').textContent = ride.pickupDisplay || ride.pickup;
        document.getElementById('currentDestination').textContent = ride.destinationDisplay || ride.destination;
        document.getElementById('totalFareValue').textContent = `ZMW ${ride.fare.toFixed(2)}`;
        
        // Show ride status bar
        document.getElementById('rideStatusBar').style.display = 'flex';
    }

    function showPulsingRideIcon() {
        // Remove existing icon
        if (pulsingIcon) {
            pulsingIcon.remove();
        }
        
        // Create new pulsing icon
        pulsingIcon = document.createElement('div');
        pulsingIcon.className = 'pulsing-ride-icon';
        pulsingIcon.innerHTML = '<i class="fas fa-car"></i>';
        document.getElementById('map').appendChild(pulsingIcon);
    }

    // ============================================
    // REAL-TIME SYNC
    // ============================================

    function startRealtimeSync(uid) {
        // Listen for ride updates
        const ridesRef = database.ref('rides')
            .orderByChild('passengerId')
            .equalTo(uid)
            .orderByChild('status')
            .startAt('requested')
            .endAt('started');
        
        AppState.realtimeListeners.push(
            ridesRef.on('value', (snapshot) => {
                const rides = snapshot.val();
                if (rides) {
                    const rideId = Object.keys(rides)[0];
                    const ride = { id: rideId, ...rides[rideId] };
                    
                    if (!AppState.currentRide || AppState.currentRide.id !== rideId) {
                        AppState.currentRide = ride;
                        showRideInfo(ride);
                        
                        if (ride.driverId) {
                            loadDriverInfo(ride.driverId);
                            listenToDriverLocation(ride.driverId);
                        }
                    } else {
                        // Update existing ride
                        AppState.currentRide = ride;
                        updateRideStatus(ride.status);
                        
                        if (ride.status === 'completed') {
                            handleRideCompletion(ride);
                        }
                    }
                }
            })
        );
        
        // Listen for notifications
        const notificationsRef = database.ref(`notifications/${uid}`).orderByChild('timestamp').limitToLast(20);
        AppState.realtimeListeners.push(
            notificationsRef.on('value', (snapshot) => {
                const notifications = snapshot.val();
                if (notifications) {
                    AppState.notifications = Object.values(notifications).reverse();
                    const unreadCount = AppState.notifications.filter(n => !n.read).length;
                    AppState.unreadNotifications = unreadCount;
                    updateNotificationBadge(unreadCount);
                }
            })
        );
    }

    function listenToRideUpdates(rideId) {
        const rideRef = database.ref(`rides/${rideId}`);
        AppState.realtimeListeners.push(
            rideRef.on('value', (snapshot) => {
                const ride = snapshot.val();
                if (ride) {
                    AppState.currentRide = { id: rideId, ...ride };
                    updateRideStatus(ride.status);
                    
                    if (ride.driverId && !AppState.driverInfo) {
                        loadDriverInfo(ride.driverId);
                        listenToDriverLocation(ride.driverId);
                    }
                    
                    if (ride.status === 'completed') {
                        handleRideCompletion(ride);
                    }
                }
            })
        );
    }

    function updateRideStatus(status) {
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const etaText = document.getElementById('etaText');
        
        switch(status) {
            case 'requested':
                statusDot.className = 'status-dot searching';
                statusText.textContent = 'Searching for driver';
                etaText.textContent = '5-10 min';
                updateTimeline('requested');
                break;
            case 'accepted':
                statusDot.className = 'status-dot arriving';
                statusText.textContent = 'Driver on the way';
                etaText.textContent = '5 min';
                updateTimeline('accepted');
                break;
            case 'arrived':
                statusDot.className = 'status-dot riding';
                statusText.textContent = 'Driver arrived';
                etaText.textContent = '0 min';
                updateTimeline('arrived');
                break;
            case 'started':
                statusDot.className = 'status-dot riding';
                statusText.textContent = 'Trip in progress';
                etaText.textContent = 'En route';
                updateTimeline('started');
                break;
            case 'completed':
                document.getElementById('rideStatusBar').style.display = 'none';
                updateTimeline('completed');
                break;
        }
    }

    function updateTimeline(step) {
        const steps = ['stepRequested', 'stepAccepted', 'stepArrived', 'stepStarted', 'stepCompleted'];
        const stepIndex = {
            'requested': 0,
            'accepted': 1,
            'arrived': 2,
            'started': 3,
            'completed': 4
        }[step];
        
        steps.forEach((stepId, index) => {
            const stepElement = document.getElementById(stepId);
            if (index <= stepIndex) {
                stepElement.classList.add('active');
                if (index < stepIndex) {
                    stepElement.classList.add('completed');
                }
            } else {
                stepElement.classList.remove('active', 'completed');
            }
        });
    }

    async function loadDriverInfo(driverId) {
        try {
            const snapshot = await database.ref(`users/${driverId}`).once('value');
            const driver = snapshot.val();
            
            if (driver) {
                document.getElementById('driverName').textContent = driver.name || 'Driver';
                document.getElementById('driverRating').textContent = driver.rating?.toFixed(1) || '4.8';
                document.getElementById('vehicleDetails').textContent = 
                    `${driver.vehicle?.model || 'Car'} - ${driver.vehicle?.plate || 'ABC 123'}`;
            }
        } catch (error) {
            console.error('Error loading driver info:', error);
        }
    }

    function listenToDriverLocation(driverId) {
        const locationRef = database.ref(`driverLocations/${driverId}`);
        
        AppState.realtimeListeners.push(
            locationRef.on('value', (snapshot) => {
                const location = snapshot.val();
                if (location) {
                    updateDriverMarker(location);
                }
            })
        );
    }

    function updateDriverMarker(location) {
        if (driverMarker) {
            map.removeLayer(driverMarker);
        }
        
        driverMarker = L.marker([location.latitude, location.longitude], {
            icon: L.divIcon({
                className: 'driver-marker',
                html: '<i class="fas fa-car"></i>',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup('Your Driver');
    }

    function handleRideCompletion(ride) {
        // Remove pulsing icon
        if (pulsingIcon) {
            pulsingIcon.remove();
            pulsingIcon = null;
        }
        
        // Show completion message
        showToast('Ride completed successfully', 'success');
        
        // Process referral earnings
        if (ride.referredBy) {
            processReferralEarnings(ride);
        }
        
        // Reset current ride after delay
        setTimeout(() => {
            AppState.currentRide = null;
            document.getElementById('rideInfoPanel').style.display = 'none';
            document.getElementById('carForm').style.display = 'block';
        }, 3000);
    }

    function processReferralEarnings(ride) {
        // Award K25 to referral owner
        database.ref(`users/${ride.referredBy}/walletBalance`).transaction((currentBalance) => {
            return (currentBalance || 0) + 25;
        });
        
        // Record referral transaction
        const transactionId = database.ref().child('transactions').push().key;
        database.ref(`transactions/${transactionId}`).set({
            type: 'referral_earnings',
            amount: 25,
            fromUserId: AppState.currentUser.uid,
            fromUserName: AppState.userData.name,
            toUserId: ride.referredBy,
            toUserName: ride.referralOwnerName,
            rideId: ride.id,
            timestamp: Date.now()
        });
        
        showToast(`K25 awarded to ${ride.referralOwnerName} for referral`, 'success');
    }

    // ============================================
    // MODAL FUNCTIONS
    // ============================================

    function showPaymentModal(serviceType, amount) {
        document.getElementById('paymentAmount').textContent = `ZMW ${amount.toFixed(2)}`;
        document.getElementById('paymentBalance').textContent = `ZMW ${AppState.walletBalance.toFixed(2)}`;
        document.getElementById('paymentModal').style.display = 'flex';
    }

    function hideModal(modalId) {
        document.getElementById(`${modalId}Modal`).style.display = 'none';
    }

    function showModal(modalId) {
        document.getElementById(`${modalId}Modal`).style.display = 'flex';
    }

    // ============================================
    // HELPER FUNCTIONS
    // ============================================

    async function loadSOSConfig(uid) {
        try {
            const snapshot = await database.ref(`sosConfig/${uid}`).once('value');
            AppState.sosConfig = snapshot.val();
        } catch (error) {
            console.error('Error loading SOS config:', error);
        }
    }

    async function loadScheduledRides(uid) {
        try {
            const snapshot = await database.ref('scheduledRides')
                .orderByChild('passengerId')
                .equalTo(uid)
                .once('value');
            
            const rides = snapshot.val();
            if (rides) {
                AppState.scheduledRides = Object.values(rides);
            }
        } catch (error) {
            console.error('Error loading scheduled rides:', error);
        }
    }

    async function checkActiveRide(uid) {
        try {
            const snapshot = await database.ref('rides')
                .orderByChild('passengerId')
                .equalTo(uid)
                .orderByChild('status')
                .startAt('requested')
                .endAt('started')
                .once('value');
            
            const rides = snapshot.val();
            if (rides) {
                const rideId = Object.keys(rides)[0];
                AppState.currentRide = { id: rideId, ...rides[rideId] };
                showRideInfo(AppState.currentRide);
                listenToRideUpdates(rideId);
            }
        } catch (error) {
            console.error('Error checking active ride:', error);
        }
    }

    async function loadNotifications(uid) {
        try {
            const snapshot = await database.ref(`notifications/${uid}`)
                .orderByChild('timestamp')
                .limitToLast(20)
                .once('value');
            
            const notifications = snapshot.val();
            if (notifications) {
                AppState.notifications = Object.values(notifications).reverse();
                const unreadCount = AppState.notifications.filter(n => !n.read).length;
                AppState.unreadNotifications = unreadCount;
                updateNotificationBadge(unreadCount);
            }
        } catch (error) {
            console.error('Error loading notifications:', error);
        }
    }

    function updateNotificationBadge(count) {
        const badge = document.getElementById('notificationCount');
        if (count > 0) {
            badge.textContent = count;
            badge.style.display = 'flex';
        } else {
            badge.style.display = 'none';
        }
    }

    // ============================================
    // EVENT LISTENERS SETUP
    // ============================================

    function setupEventListeners() {
        // Navigation tabs
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const screen = tab.dataset.screen;
                switchScreen(screen);
            });
        });
        
        // Service tabs
        document.querySelectorAll('.service-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const service = tab.dataset.service;
                switchService(service);
            });
        });
        
        // Ride type selection
        document.querySelectorAll('.ride-type-card').forEach(card => {
            card.addEventListener('click', () => {
                document.querySelectorAll('.ride-type-card').forEach(c => {
                    c.classList.remove('selected');
                });
                card.classList.add('selected');
                AppState.selectedRideType = card.dataset.type;
                calculateFare();
            });
        });
        
        // Location search
        document.getElementById('destinationLocation').addEventListener('input', async (e) => {
            const query = e.target.value;
            if (query.length > 2) {
                const results = await searchLocations(query, 'destination');
                showSearchSuggestions('destinationLocation', results);
            }
        });
        
        // Request ride button
        document.getElementById('requestRideBtn').addEventListener('click', requestRide);
        
        // Payment methods
        document.querySelectorAll('.payment-method').forEach(method => {
            method.addEventListener('click', () => {
                document.querySelectorAll('.payment-method').forEach(m => {
                    m.classList.remove('selected');
                });
                method.classList.add('selected');
            });
        });
        
        // Confirm payment
        document.getElementById('confirmPaymentBtn').addEventListener('click', () => {
            const selectedMethod = document.querySelector('.payment-method.selected');
            if (!selectedMethod) {
                showToast('Please select a payment method', 'warning');
                return;
            }
            
            const paymentMethod = selectedMethod.dataset.payment;
            
            // Check wallet balance for wallet payment
            if (paymentMethod === 'wallet' && AppState.walletBalance < AppState.rideFare) {
                showToast('Insufficient wallet balance', 'error');
                return;
            }
            
            processPayment(paymentMethod);
        });
        
        // Map controls
        document.getElementById('locateMeBtn').addEventListener('click', getCurrentLocation);
        document.getElementById('zoomInBtn').addEventListener('click', () => map.zoomIn());
        document.getElementById('zoomOutBtn').addEventListener('click', () => map.zoomOut());
        document.getElementById('clearRouteBtn').addEventListener('click', () => {
            if (routeLayer) {
                map.removeLayer(routeLayer);
                routeLayer = null;
            }
        });
        
        // More options button
        document.getElementById('moreOptionsBtn').addEventListener('click', () => {
            document.getElementById('moreOptionsMenu').classList.toggle('active');
        });
        
        // More options items
        document.querySelectorAll('#moreOptionsMenu .dropdown-item').forEach(item => {
            item.addEventListener('click', () => {
                const option = item.dataset.option;
                handleMoreOption(option);
            });
        });
        
        // Panel handle
        document.getElementById('panelHandle').addEventListener('click', () => {
            document.getElementById('mainPanel').classList.toggle('collapsed');
        });
        
        // Close modals
        document.querySelectorAll('.modal-close').forEach(btn => {
            btn.addEventListener('click', () => {
                const modal = btn.dataset.modal;
                hideModal(modal);
            });
        });
        
        // Close chat
        document.getElementById('chatClose').addEventListener('click', () => {
            document.getElementById('chatContainer').classList.remove('active');
        });
        
        // Open chat
        document.getElementById('openChatBtn').addEventListener('click', () => {
            document.getElementById('chatContainer').classList.add('active');
        });
        
        // Send chat message
        document.getElementById('chatSend').addEventListener('click', sendChatMessage);
        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendChatMessage();
        });
        
        // Notification bell
        document.getElementById('notificationBell').addEventListener('click', () => {
            document.getElementById('notificationsPanel').classList.toggle('active');
        });
        
        // Close notifications
        document.getElementById('notificationsClose').addEventListener('click', () => {
            document.getElementById('notificationsPanel').classList.remove('active');
        });
        
        // SOS button
        document.getElementById('sosButton').addEventListener('click', triggerSOS);
        
        // Cancel ride
        document.getElementById('cancelRideBtn').addEventListener('click', () => {
            showModal('cancel');
        });
        
        // Emergency services
        document.querySelectorAll('.emergency-service').forEach(service => {
            service.addEventListener('click', () => {
                const type = service.dataset.type;
                handleEmergencyService(type);
            });
        });
    }

    function switchScreen(screen) {
        // Hide all screens
        document.querySelectorAll('.history-screen, .account-screen, .emergency-screen').forEach(s => {
            s.style.display = 'none';
        });
        
        // Update active tab
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelector(`.nav-tab[data-screen="${screen}"]`).classList.add('active');
        
        // Show selected screen
        if (screen === 'home') {
            document.getElementById('homeContent').style.display = 'block';
        } else {
            document.getElementById(`${screen}Screen`).style.display = 'block';
        }
        
        AppState.activeScreen = screen;
    }

    function switchService(service) {
        // Hide all forms
        document.querySelectorAll('.ride-request-form, .service-form').forEach(form => {
            form.style.display = 'none';
        });
        
        // Update active service tab
        document.querySelectorAll('.service-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelector(`.service-tab[data-service="${service}"]`).classList.add('active');
        
        // Show selected service form
        AppState.activeService = service;
        
        // For now, only car service is fully implemented
        if (service === 'car') {
            document.getElementById('carForm').style.display = 'block';
        } else {
            showToast(`${service} service coming soon`, 'info');
            document.getElementById('carForm').style.display = 'block';
        }
    }

    function handleMoreOption(option) {
        document.getElementById('moreOptionsMenu').classList.remove('active');
        
        switch(option) {
            case 'schedule':
                showModal('schedule');
                break;
            case 'orderForSomeone':
                showModal('orderForSomeone');
                break;
            case 'shareRide':
                showModal('shareRide');
                break;
            case 'broadcast':
                showModal('broadcast');
                break;
        }
    }

    function handleEmergencyService(type) {
        if (type === 'sos') {
            showModal('sos');
        } else {
            showModal('emergency');
            document.getElementById('emergencyServiceType').textContent = 
                type.charAt(0).toUpperCase() + type.slice(1) + ' Ride';
        }
    }

    function triggerSOS() {
        if (!AppState.sosConfig) {
            showToast('Please setup SOS contacts first', 'warning');
            showModal('sos');
            return;
        }
        
        if (confirm('Send SOS alert to emergency contacts?')) {
            // Send SOS alert
            const sosId = database.ref().child('sosAlerts').push().key;
            database.ref(`sosAlerts/${sosId}`).set({
                userId: AppState.currentUser.uid,
                userName: AppState.userData.name,
                userPhone: AppState.userData.phone,
                location: AppState.userLocation,
                timestamp: Date.now(),
                emergencyContacts: AppState.sosConfig,
                status: 'active'
            });
            
            showToast('SOS alert sent to emergency contacts', 'success');
        }
    }

    async function sendChatMessage() {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();
        
        if (message && AppState.currentRide) {
            const messageData = {
                text: message,
                senderId: AppState.currentUser.uid,
                senderName: AppState.userData.name,
                timestamp: Date.now()
            };
            
            const messageId = database.ref().child(`chats/${AppState.currentRide.id}/messages`).push().key;
            await database.ref(`chats/${AppState.currentRide.id}/messages/${messageId}`).set(messageData);
            
            input.value = '';
        }
    }

    // ============================================
    // INITIALIZE APPLICATION
    // ============================================

    window.addEventListener('load', initializeApp);

    // ============================================
    // ADDITIONAL FEATURE IMPLEMENTATIONS
    // ============================================

    // Add Stop functionality
    let stopCount = 0;
    document.getElementById('addStopBtn').addEventListener('click', () => {
        if (stopCount >= 3) {
            showToast('Maximum 3 stops allowed', 'warning');
            return;
        }
        
        stopCount++;
        const stopContainer = document.getElementById('stopsContainer');
        const stopDiv = document.createElement('div');
        stopDiv.className = 'location-input';
        stopDiv.innerHTML = `
            <i class="fas fa-plus-circle"></i>
            <input type="text" class="stop-input" placeholder="Add stop ${stopCount}" data-stop-id="${stopCount}">
            <button class="remove-stop" data-stop-id="${stopCount}">
                <i class="fas fa-times"></i>
            </button>
        `;
        stopContainer.appendChild(stopDiv);
        
        // Add event listener for stop removal
        stopDiv.querySelector('.remove-stop').addEventListener('click', function() {
            const stopId = this.dataset.stopId;
            document.querySelector(`[data-stop-id="${stopId}"]`).closest('.location-input').remove();
            stopCount--;
            calculateFare();
        });
        
        // Add event listener for stop search
        stopDiv.querySelector('.stop-input').addEventListener('input', async function(e) {
            const query = e.target.value;
            if (query.length > 2) {
                const results = await searchLocations(query, 'stop');
                // Show suggestions for stops
            }
        });
    });

    // Referral discount application
    document.getElementById('applyReferralBtn')?.addEventListener('click', async function() {
        const referralCode = document.getElementById('referralCodeInput').value.trim();
        
        if (!referralCode) {
            showToast('Please enter a referral code', 'warning');
            return;
        }
        
        try {
            // Check if referral code exists
            const usersSnapshot = await database.ref('users').orderByChild('referralCode').equalTo(referralCode).once('value');
            if (usersSnapshot.exists()) {
                const userData = Object.values(usersSnapshot.val())[0];
                AppState.referralDiscountApplied = true;
                AppState.referralCodeUsed = referralCode;
                AppState.referralOwnerName = userData.name;
                
                // Update fare with 50% discount
                const discountedFare = AppState.rideFare * 0.5;
                document.getElementById('paymentAmount').textContent = `ZMW ${discountedFare.toFixed(2)}`;
                
                // Show discount breakdown
                document.getElementById('originalFareAmount').textContent = `ZMW ${AppState.rideFare.toFixed(2)}`;
                document.getElementById('discountAmount').textContent = `-ZMW ${(AppState.rideFare * 0.5).toFixed(2)}`;
                document.getElementById('finalFareAmount').textContent = `ZMW ${discountedFare.toFixed(2)}`;
                
                showToast(`50% discount applied! Referral from ${userData.name}`, 'success');
            } else {
                showToast('Invalid referral code', 'error');
            }
        } catch (error) {
            console.error('Error validating referral:', error);
            showToast('Error validating referral code', 'error');
        }
    });

    // Schedule ride functionality
    document.getElementById('confirmScheduleBtn')?.addEventListener('click', async function() {
        const date = document.getElementById('scheduleDate').value;
        const time = document.getElementById('scheduleTime').value;
        
        if (!date || !time) {
            showToast('Please select date and time', 'warning');
            return;
        }
        
        const scheduledTime = new Date(`${date}T${time}`).getTime();
        const now = Date.now();
        
        if (scheduledTime <= now) {
            showToast('Please select a future time', 'warning');
            return;
        }
        
        // Create scheduled ride
        const rideData = {
            pickup: AppState.pickup?.address,
            destination: AppState.destination?.address,
            scheduledTime: scheduledTime,
            status: 'scheduled',
            passengerId: AppState.currentUser.uid,
            passengerName: AppState.userData.name,
            createdAt: now
        };
        
        const scheduledRideId = database.ref().child('scheduledRides').push().key;
        await database.ref(`scheduledRides/${scheduledRideId}`).set(rideData);
        
        hideModal('schedule');
        showToast('Ride scheduled successfully', 'success');
        
        // Start countdown if within 1 hour
        const timeUntilRide = scheduledTime - now;
        if (timeUntilRide <= 3600000) {
            showScheduleCountdown(scheduledTime);
        }
    });

    function showScheduleCountdown(scheduledTime) {
        const countdownContainer = document.createElement('div');
        countdownContainer.className = 'schedule-countdown';
        countdownContainer.innerHTML = `
            <div class="countdown-header">
                <i class="fas fa-clock"></i>
                <span>Scheduled Ride Countdown</span>
            </div>
            <div class="countdown-timer">
                <div class="time-unit">
                    <div class="time-value" id="countdownHours">00</div>
                    <div class="time-label">Hours</div>
                </div>
                <div class="time-separator">:</div>
                <div class="time-unit">
                    <div class="time-value" id="countdownMinutes">00</div>
                    <div class="time-label">Minutes</div>
                </div>
                <div class="time-separator">:</div>
                <div class="time-unit">
                    <div class="time-value" id="countdownSeconds">00</div>
                    <div class="time-label">Seconds</div>
                </div>
            </div>
            <button id="cancelScheduleBtn" class="btn btn-danger">
                <i class="fas fa-times"></i> Cancel Schedule
            </button>
        `;
        
        document.getElementById('homeContent').appendChild(countdownContainer);
        
        // Start countdown timer
        AppState.activeScheduledTimer = setInterval(() => {
            const timeLeft = scheduledTime - Date.now();
            if (timeLeft <= 0) {
                clearInterval(AppState.activeScheduledTimer);
                requestScheduledRide();
                countdownContainer.remove();
            } else {
                const hours = Math.floor(timeLeft / (1000 * 60 * 60));
                const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                
                document.getElementById('countdownHours').textContent = hours.toString().padStart(2, '0');
                document.getElementById('countdownMinutes').textContent = minutes.toString().padStart(2, '0');
                document.getElementById('countdownSeconds').textContent = seconds.toString().padStart(2, '0');
            }
        }, 1000);
        
        // Cancel schedule button
        document.getElementById('cancelScheduleBtn').addEventListener('click', () => {
            clearInterval(AppState.activeScheduledTimer);
            countdownContainer.remove();
            showToast('Scheduled ride cancelled', 'info');
        });
    }

    function requestScheduledRide() {
        showToast('Scheduled ride is now being requested', 'success');
        // Trigger ride request
        requestRide();
    }

    // Split ride functionality (up to 3 friends)
    document.getElementById('addShareMemberBtn')?.addEventListener('click', async function() {
        const friendCode = document.getElementById('shareMemberInput').value.trim();
        
        if (!friendCode) {
            showToast('Please enter a referral code', 'warning');
            return;
        }
        
        if (AppState.shareRideFriends.length >= 3) {
            showToast('Maximum 3 friends allowed for split rides', 'warning');
            return;
        }
        
        try {
            // Find friend by referral code
            const usersSnapshot = await database.ref('users').orderByChild('referralCode').equalTo(friendCode).once('value');
            if (usersSnapshot.exists()) {
                const friendData = Object.values(usersSnapshot.val())[0];
                
                // Add friend to list
                AppState.shareRideFriends.push({
                    code: friendCode,
                    name: friendData.name,
                    userId: Object.keys(usersSnapshot.val())[0]
                });
                
                // Update UI
                updateShareFriendsList();
                updateSplitRideFare();
                
                document.getElementById('shareMemberInput').value = '';
                showToast(`${friendData.name} added to split ride`, 'success');
            } else {
                showToast('Friend not found. Check referral code.', 'error');
            }
        } catch (error) {
            console.error('Error finding friend:', error);
            showToast('Error adding friend', 'error');
        }
    });

    function updateShareFriendsList() {
        const container = document.getElementById('shareFriendsList');
        container.innerHTML = '';
        
        AppState.shareRideFriends.forEach(friend => {
            const friendElement = document.createElement('div');
            friendElement.className = 'share-friend-item';
            friendElement.innerHTML = `
                <div class="friend-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="friend-info">
                    <div class="friend-name">${friend.name}</div>
                    <div class="friend-code">${friend.code}</div>
                </div>
                <button class="remove-friend-btn" data-code="${friend.code}">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.appendChild(friendElement);
            
            // Remove friend button
            friendElement.querySelector('.remove-friend-btn').addEventListener('click', function() {
                const code = this.dataset.code;
                AppState.shareRideFriends = AppState.shareRideFriends.filter(f => f.code !== code);
                updateShareFriendsList();
                updateSplitRideFare();
            });
        });
    }

    function updateSplitRideFare() {
        if (!AppState.pickup || !AppState.destination) return;
        
        const totalPeople = AppState.shareRideFriends.length + 1;
        const sharePerPerson = AppState.rideFare / totalPeople;
        
        document.getElementById('yourShare').textContent = `ZMW ${sharePerPerson.toFixed(2)}`;
        document.getElementById('friendShare').textContent = `ZMW ${sharePerPerson.toFixed(2)}`;
    }

    // Broadcast ride functionality
    document.getElementById('addBroadcastMemberBtn')?.addEventListener('click', async function() {
        const friendCode = document.getElementById('broadcastMemberInput').value.trim();
        
        if (!friendCode) {
            showToast('Please enter a referral code', 'warning');
            return;
        }
        
        try {
            // Find friend by referral code
            const usersSnapshot = await database.ref('users').orderByChild('referralCode').equalTo(friendCode).once('value');
            if (usersSnapshot.exists()) {
                const friendData = Object.values(usersSnapshot.val())[0];
                
                // Add to broadcast list
                const memberElement = document.createElement('div');
                memberElement.className = 'broadcast-member';
                memberElement.innerHTML = `
                    <div>${friendData.name}</div>
                    <div class="member-code">${friendCode}</div>
                `;
                document.getElementById('broadcastMembersContainer').appendChild(memberElement);
                
                document.getElementById('broadcastMemberInput').value = '';
                showToast(`${friendData.name} added to broadcast`, 'success');
            } else {
                showToast('Friend not found. Check referral code.', 'error');
            }
        } catch (error) {
            console.error('Error finding friend:', error);
            showToast('Error adding friend', 'error');
        }
    });

    // Shopping categories
    const shoppingCategories = {
        restaurants: ['Pizza', 'Nando\'s', 'Hungry Lion'],
        pharmacies: ['Pharmacies'],
        supermarkets: ['Supermarkets'],
        malls: ['Shopping Malls']
    };

    // Initialize shopping categories
    function initializeShoppingCategories() {
        const categoriesContainer = document.createElement('div');
        categoriesContainer.className = 'shopping-categories';
        categoriesContainer.innerHTML = `
            <div class="shopping-category" data-category="restaurants">
                <i class="fas fa-utensils"></i>
                <span>Restaurants</span>
            </div>
            <div class="shopping-category" data-category="pharmacies">
                <i class="fas fa-prescription-bottle-medical"></i>
                <span>Pharmacies</span>
            </div>
            <div class="shopping-category" data-category="supermarkets">
                <i class="fas fa-shopping-cart"></i>
                <span>Supermarkets</span>
            </div>
            <div class="shopping-category" data-category="malls">
                <i class="fas fa-store"></i>
                <span>Shopping Malls</span>
            </div>
        `;
        
        // Add to shopping form
        const shoppingForm = document.getElementById('expressForm');
        if (shoppingForm) {
            shoppingForm.insertBefore(categoriesContainer, shoppingForm.firstChild);
            
            // Add category click handlers
            categoriesContainer.querySelectorAll('.shopping-category').forEach(category => {
                category.addEventListener('click', async function() {
                    const categoryType = this.dataset.category;
                    await showShoppingPlaces(categoryType);
                });
            });
        }
    }

    async function showShoppingPlaces(category) {
        if (!AppState.currentCity) {
            showToast('Please wait while we detect your city', 'warning');
            return;
        }
        
        const places = await searchLocations(shoppingCategories[category][0], 'shopping');
        
        // Show places in modal
        const modal = document.getElementById('shoppingPlacesModal');
        if (!modal) {
            // Create modal if it doesn't exist
            const modalDiv = document.createElement('div');
            modalDiv.id = 'shoppingPlacesModal';
            modalDiv.className = 'modal-overlay';
            modalDiv.innerHTML = `
                <div class="modal">
                    <div class="modal-header">
                        <div class="modal-title">
                            <i class="fas fa-store"></i>
                            Select ${category}
                        </div>
                        <button class="modal-close" onclick="document.getElementById('shoppingPlacesModal').style.display='none'">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-content" id="shoppingPlacesList">
                        <!-- Places will be inserted here -->
                    </div>
                </div>
            `;
            document.body.appendChild(modalDiv);
        }
        
        // Update places list
        const placesList = document.getElementById('shoppingPlacesList');
        placesList.innerHTML = '';
        
        places.forEach(place => {
            const placeElement = document.createElement('div');
            placeElement.className = 'shopping-place';
            placeElement.innerHTML = `
                <div class="place-name">${place.name}</div>
                <div class="place-address">${place.address}</div>
            `;
            placeElement.addEventListener('click', () => {
                // Set shop name and location
                document.getElementById('shopName').value = place.name;
                document.getElementById('shopLocation').value = place.address;
                modal.style.display = 'none';
            });
            placesList.appendChild(placeElement);
        });
        
        document.getElementById('shoppingPlacesModal').style.display = 'flex';
    }

    // Emergency stations search
    async function searchEmergencyStations(type) {
        if (!AppState.currentCity) return [];
        
        const query = type === 'police' ? 'police station' : 
                     type === 'fire' ? 'fire station' : 
                     'hospital';
        
        const results = await searchLocations(`${query} ${AppState.currentCity}`, 'emergency');
        
        // Sort by distance
        if (AppState.userLocation) {
            results.forEach(result => {
                result.distance = calculateDistance(
                    AppState.userLocation.lat, AppState.userLocation.lng,
                    result.lat, result.lng
                );
            });
            results.sort((a, b) => a.distance - b.distance);
        }
        
        return results;
    }

    // Real-time indicator
    function showRealTimeIndicator() {
        const indicator = document.getElementById('realTimeIndicator');
        indicator.classList.add('active');
        setTimeout(() => {
            indicator.classList.remove('active');
        }, 3000);
    }

    // Sync indicator
    function showSyncIndicator(syncing) {
        const indicator = document.getElementById('syncIndicator');
        if (syncing) {
            indicator.classList.add('active', 'syncing');
        } else {
            indicator.classList.remove('active', 'syncing');
        }
    }

    // Periodic data sync
    setInterval(() => {
        if (AppState.currentUser) {
            showSyncIndicator(true);
            // Sync user data
            database.ref(`users/${AppState.currentUser.uid}`).once('value').then(snapshot => {
                const userData = snapshot.val();
                if (userData) {
                    AppState.userData = userData;
                    AppState.walletBalance = userData.walletBalance || 0;
                    updateWalletBalance(AppState.walletBalance);
                    updateUserInfo(userData);
                }
                showSyncIndicator(false);
            });
        }
    }, 60000); // Sync every minute

    // Initialize shopping categories on load
    window.addEventListener('load', () => {
        setTimeout(initializeShoppingCategories, 1000);
    });

    // Make functions available globally
    window.AppState = AppState;
    window.showToast = showToast;
    window.showModal = showModal;
    window.hideModal = hideModal;
    </script>
</body>
</html>

