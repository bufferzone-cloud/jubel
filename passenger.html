<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jubel Passenger App</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root {
            --primary-orange: #FF6B35;
            --primary-red: #E74C3C;
            --primary-gradient: linear-gradient(135deg, #FF6B35, #E74C3C);
            --secondary-orange: #E55A28;
            --secondary-red: #C0392B;
            --light-orange: #FFF5F0;
            --light-red: #FCE8E6;
            --white: #FFFFFF;
            --off-white: #F9F9F9;
            --light-gray: #F5F5F5;
            --medium-gray: #E0E0E0;
            --dark-gray: #333333;
            --text-gray: #666666;
            --text-light: #888888;
            --success-green: #2ECC71;
            --warning-yellow: #F39C12;
            --info-blue: #3498DB;
            --error-red: #E74C3C;
            --border-color: #EEEEEE;
            --shadow-light: 0 1px 6px rgba(0, 0, 0, 0.08);
            --shadow-medium: 0 2px 12px rgba(0, 0, 0, 0.12);
            --shadow-heavy: 0 4px 20px rgba(0, 0, 0, 0.15);
            --app-padding: 12px;
            --element-radius: 12px;
            --button-radius: 20px;
            --card-radius: 16px;
            --transition-speed: 0.25s;
            --ambulance-blue: #2980B9;
            --fire-truck-red: #C0392B;
            --police-blue: #2C3E50;
            --premium-gold: #FFD700;
            --economy-green: #27AE60;
            --light-truck-brown: #8B4513;
            --delivery-purple: #8E44AD;
            --express-shop-green: #16A085;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }
        
        body {
            background-color: var(--off-white);
            color: var(--dark-gray);
            max-width: 100%;
            overflow-x: hidden;
            height: 100vh;
            font-size: 13px;
            line-height: 1.4;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Map Container */
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 55%;
            z-index: 1;
            background: #f8f9fa;
        }
        
        /* Top Bar Components */
        .top-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 200;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px var(--app-padding);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            height: 56px;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .logo-icon {
            width: 32px;
            height: 32px;
            background: var(--primary-gradient);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-weight: 700;
            font-size: 14px;
            overflow: hidden;
        }
        
        .logo-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .logo-text {
            font-size: 14px;
            font-weight: 700;
            color: var(--dark-gray);
            line-height: 1.2;
        }
        
        .user-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .balance-badge {
            background: var(--white);
            padding: 6px 12px;
            border-radius: var(--button-radius);
            box-shadow: var(--shadow-light);
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 600;
            color: var(--dark-gray);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .balance-badge:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }
        
        .balance-amount {
            color: var(--primary-orange);
            font-weight: 700;
            font-size: 13px;
        }
        
        .notification-bell {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
            cursor: pointer;
            position: relative;
            transition: all var(--transition-speed) ease;
        }
        
        .notification-bell:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }
        
        .notification-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            width: 16px;
            height: 16px;
            background: var(--error-red);
            color: var(--white);
            border-radius: 50%;
            font-size: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            border: 2px solid var(--white);
        }
        
        /* Ride Status Bar */
        .ride-status-bar {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 150;
            display: none;
            background: var(--white);
            padding: 8px 16px;
            border-radius: var(--button-radius);
            box-shadow: var(--shadow-heavy);
            border: 1px solid var(--border-color);
            align-items: center;
            gap: 10px;
            min-width: 280px;
            max-width: 90%;
        }
        
        .ride-status-bar.active {
            display: flex;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                transform: translateX(-50%) translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--warning-yellow);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.1); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        .status-dot.searching { background: var(--warning-yellow); }
        .status-dot.arriving { background: var(--info-blue); }
        .status-dot.riding { background: var(--success-green); animation: none; }
        
        .status-text {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
        }
        
        .status-eta {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--text-gray);
            font-size: 12px;
            font-weight: 500;
        }
        
        /* Emergency Status */
        .emergency-status {
            position: absolute;
            top: 60px;
            right: var(--app-padding);
            z-index: 150;
            background: linear-gradient(135deg, var(--error-red), #C0392B);
            color: var(--white);
            padding: 8px 14px;
            border-radius: var(--button-radius);
            box-shadow: var(--shadow-heavy);
            display: none;
            align-items: center;
            gap: 6px;
            font-weight: 700;
            font-size: 12px;
            animation: emergencyPulse 1s infinite;
        }
        
        @keyframes emergencyPulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
            70% { transform: scale(1.02); box-shadow: 0 0 0 8px rgba(231, 76, 60, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
        }
        
        /* SOS Button */
        .sos-button {
            position: absolute;
            bottom: 160px;
            right: var(--app-padding);
            z-index: 150;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--error-red), #C0392B);
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 14px;
            font-weight: 700;
            box-shadow: var(--shadow-heavy);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            animation: sosPulse 2s infinite;
        }
        
        .sos-button:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(231, 76, 60, 0.4);
        }
        
        @keyframes sosPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* Main Panel */
        .main-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            border-radius: var(--card-radius) var(--card-radius) 0 0;
            box-shadow: 0 -4px 30px rgba(0, 0, 0, 0.1);
            z-index: 100;
            padding: var(--app-padding);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 45vh;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-orange) var(--light-gray);
        }
        
        .main-panel::-webkit-scrollbar {
            width: 4px;
        }
        
        .main-panel::-webkit-scrollbar-track {
            background: var(--light-gray);
            border-radius: 2px;
        }
        
        .main-panel::-webkit-scrollbar-thumb {
            background: var(--primary-orange);
            border-radius: 2px;
        }
        
        .main-panel.collapsed {
            transform: translateY(calc(100% - 48px));
        }
        
        .panel-handle {
            width: 36px;
            height: 3px;
            background: var(--medium-gray);
            border-radius: 2px;
            margin: 0 auto 12px;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .panel-handle:hover {
            background: var(--primary-orange);
            width: 48px;
        }
        
        /* Navigation Tabs */
        .nav-tabs {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            margin-bottom: 12px;
            padding: 4px;
            background: var(--light-gray);
            border-radius: var(--button-radius);
        }
        
        .nav-tab {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 10px 6px;
            border-radius: calc(var(--button-radius) - 4px);
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            color: var(--text-gray);
            font-size: 11px;
            font-weight: 600;
        }
        
        .nav-tab i {
            font-size: 16px;
            transition: all var(--transition-speed) ease;
        }
        
        .nav-tab.active {
            background: var(--white);
            color: var(--primary-orange);
            box-shadow: var(--shadow-light);
        }
        
        .nav-tab.active i {
            color: var(--primary-orange);
            transform: translateY(-2px);
        }
        
        .nav-tab:hover:not(.active) {
            background: rgba(255, 107, 53, 0.1);
            color: var(--primary-orange);
        }
        
        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .quick-action-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            text-align: left;
        }
        
        .quick-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
            border-color: var(--primary-orange);
        }
        
        .quick-action-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: var(--light-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-orange);
            font-size: 16px;
        }
        
        .quick-action-text {
            flex: 1;
        }
        
        .quick-action-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
            margin-bottom: 2px;
        }
        
        .quick-action-desc {
            font-size: 11px;
            color: var(--text-light);
        }
        
        /* Service Tabs */
        .service-tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 16px;
            overflow-x: auto;
            padding-bottom: 4px;
        }
        
        .service-tabs::-webkit-scrollbar {
            display: none;
        }
        
        .service-tab {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 12px 16px;
            background: var(--white);
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            min-width: 100px;
            text-align: center;
            flex-shrink: 0;
        }
        
        .service-tab:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .service-tab.active {
            border-color: var(--primary-orange);
            background: var(--light-orange);
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
        }
        
        .service-tab.car.active { border-color: var(--primary-orange); }
        .service-tab.delivery.active { border-color: var(--delivery-purple); background: #F4E6FA; }
        .service-tab.short-delivery.active { border-color: var(--express-shop-green); background: #E1F5FE; }
        
        .service-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--text-gray);
            transition: all var(--transition-speed) ease;
        }
        
        .service-tab.active .service-icon {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .service-tab.delivery.active .service-icon {
            background: var(--delivery-purple);
        }
        
        .service-tab.short-delivery.active .service-icon {
            background: var(--express-shop-green);
        }
        
        .service-name {
            font-weight: 600;
            font-size: 12px;
            color: var(--dark-gray);
        }
        
        .service-desc {
            font-size: 10px;
            color: var(--text-light);
            margin-top: 2px;
        }
        
        /* Ride Request Form */
        .ride-request-form {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }
        
        .form-title {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--dark-gray);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .location-inputs {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .location-input {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: var(--off-white);
            border: 2px solid transparent;
            border-radius: var(--element-radius);
            transition: all var(--transition-speed) ease;
            position: relative;
        }
        
        .location-input.active {
            border-color: var(--primary-orange);
            background: var(--white);
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
        }
        
        .location-input i {
            color: var(--primary-orange);
            font-size: 14px;
            width: 18px;
            text-align: center;
        }
        
        .location-input input {
            flex: 1;
            border: none;
            background: transparent;
            outline: none;
            font-size: 13px;
            color: var(--dark-gray);
            font-weight: 500;
        }
        
        .location-input input::placeholder {
            color: var(--text-light);
        }
        
        .suggestion-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 1000;
            max-height: 250px;
            overflow-y: auto;
            display: none;
            margin-top: 4px;
        }
        
        .suggestion-list.active {
            display: block;
            animation: fadeIn 0.2s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .suggestion-item {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        .suggestion-item:hover {
            background: var(--light-orange);
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
        
        .suggestion-icon {
            color: var(--primary-orange);
            font-size: 12px;
            margin-top: 2px;
        }
        
        .suggestion-details {
            flex: 1;
        }
        
        .suggestion-name {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
            margin-bottom: 2px;
        }
        
        .suggestion-address {
            font-size: 11px;
            color: var(--text-gray);
            line-height: 1.3;
        }
        
        .suggestion-distance {
            font-size: 10px;
            color: var(--text-light);
            margin-top: 2px;
        }
        
        /* Ride Type Selection */
        .ride-type-selection {
            margin: 16px 0;
            display: none;
        }
        
        .ride-type-selection.active {
            display: block;
            animation: fadeInUp 0.3s ease;
        }
        
        .ride-type-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--dark-gray);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .ride-type-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        
        .ride-type-card {
            background: var(--white);
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            padding: 14px 10px;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .ride-type-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .ride-type-card.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
        }
        
        .ride-type-card.economy.selected {
            border-color: var(--economy-green);
            background: #E8F6EF;
        }
        
        .ride-type-card.premium.selected {
            border-color: var(--premium-gold);
            background: #FFF9E6;
        }
        
        .ride-type-icon {
            width: 42px;
            height: 42px;
            border-radius: 10px;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 8px;
            font-size: 18px;
            color: var(--text-gray);
            transition: all var(--transition-speed) ease;
        }
        
        .ride-type-card.selected .ride-type-icon {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .ride-type-card.economy.selected .ride-type-icon {
            background: var(--economy-green);
        }
        
        .ride-type-card.premium.selected .ride-type-icon {
            background: var(--premium-gold);
            color: var(--dark-gray);
        }
        
        .ride-type-name {
            font-weight: 600;
            font-size: 12px;
            color: var(--dark-gray);
            margin-bottom: 2px;
        }
        
        .ride-type-price {
            font-size: 14px;
            font-weight: 700;
            color: var(--primary-orange);
            margin-bottom: 2px;
        }
        
        .ride-type-card.economy .ride-type-price {
            color: var(--economy-green);
        }
        
        .ride-type-card.premium .ride-type-price {
            color: #B8860B;
        }
        
        .ride-type-eta {
            font-size: 10px;
            color: var(--text-light);
        }
        
        /* Fare Display */
        .fare-display {
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            padding: 16px;
            border-radius: var(--element-radius);
            margin: 16px 0;
            text-align: center;
            box-shadow: var(--shadow-medium);
            display: none;
        }
        
        .fare-display.active {
            display: block;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fare-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 2px;
        }
        
        .fare-amount {
            font-size: 26px;
            font-weight: 800;
            margin: 6px 0;
        }
        
        .fare-details {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 11px;
            opacity: 0.9;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-top: 16px;
        }
        
        .btn {
            padding: 14px;
            border: none;
            border-radius: var(--button-radius);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            box-shadow: 0 3px 12px rgba(255, 107, 53, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 16px rgba(255, 107, 53, 0.4);
        }
        
        .btn-secondary {
            background: var(--white);
            color: var(--primary-orange);
            border: 2px solid var(--primary-orange);
        }
        
        .btn-secondary:hover {
            background: var(--light-orange);
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--error-red), #C0392B);
            color: var(--white);
            box-shadow: 0 3px 12px rgba(231, 76, 60, 0.3);
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 16px rgba(231, 76, 60, 0.4);
        }
        
        /* Ride Info Panel */
        .ride-info-panel {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-medium);
            border: 1px solid var(--border-color);
            display: none;
        }
        
        .ride-info-panel.active {
            display: block;
            animation: fadeInUp 0.3s ease;
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .driver-info {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .driver-avatar {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--white);
            font-weight: 700;
            overflow: hidden;
        }
        
        .driver-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .driver-details {
            flex: 1;
        }
        
        .driver-name {
            font-size: 14px;
            font-weight: 700;
            color: var(--dark-gray);
            margin-bottom: 2px;
        }
        
        .driver-rating {
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--warning-yellow);
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 12px;
        }
        
        .driver-vehicle {
            font-size: 12px;
            color: var(--text-gray);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .vehicle-image {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            overflow: hidden;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .vehicle-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .trip-details {
            margin-bottom: 16px;
        }
        
        .trip-locations {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .location-point {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        .location-marker {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            color: var(--white);
            font-size: 11px;
        }
        
        .location-marker.pickup {
            background: var(--primary-orange);
        }
        
        .location-marker.destination {
            background: var(--primary-red);
        }
        
        .location-text {
            flex: 1;
        }
        
        .location-label {
            font-size: 11px;
            color: var(--text-light);
            margin-bottom: 2px;
            font-weight: 600;
        }
        
        .location-address {
            font-size: 13px;
            color: var(--dark-gray);
            font-weight: 500;
            line-height: 1.3;
        }
        
        .fare-breakdown {
            background: var(--off-white);
            border-radius: var(--element-radius);
            padding: 14px;
            margin-bottom: 16px;
        }
        
        .fare-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .fare-row:last-child {
            border-bottom: none;
        }
        
        .fare-label {
            font-size: 13px;
            color: var(--text-gray);
        }
        
        .fare-value {
            font-size: 13px;
            font-weight: 600;
            color: var(--dark-gray);
        }
        
        .fare-row.total {
            margin-top: 6px;
            padding-top: 10px;
            border-top: 2px solid var(--border-color);
        }
        
        .fare-row.total .fare-label {
            font-size: 14px;
            font-weight: 700;
            color: var(--dark-gray);
        }
        
        .fare-row.total .fare-value {
            font-size: 18px;
            font-weight: 800;
            color: var(--primary-orange);
        }
        
        /* Chat System */
        .chat-container {
            position: absolute;
            bottom: 200px;
            right: var(--app-padding);
            z-index: 300;
            width: 320px;
            max-width: calc(100vw - 40px);
            background: var(--white);
            border-radius: var(--card-radius);
            box-shadow: var(--shadow-heavy);
            display: none;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        
        .chat-container.active {
            display: flex;
            animation: chatSlideUp 0.3s ease;
        }
        
        @keyframes chatSlideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .chat-header {
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            padding: 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .chat-title {
            font-weight: 600;
            font-size: 13px;
        }
        
        .chat-close {
            background: none;
            border: none;
            color: var(--white);
            font-size: 16px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all var(--transition-speed) ease;
        }
        
        .chat-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .chat-messages {
            flex: 1;
            padding: 14px;
            max-height: 250px;
            overflow-y: auto;
            background: var(--off-white);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .message {
            max-width: 80%;
            padding: 8px 12px;
            border-radius: 16px;
            font-size: 13px;
            line-height: 1.3;
        }
        
        .message.sent {
            align-self: flex-end;
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            border-bottom-right-radius: 4px;
        }
        
        .message.received {
            align-self: flex-start;
            background: var(--white);
            color: var(--dark-gray);
            border: 1px solid var(--border-color);
            border-bottom-left-radius: 4px;
        }
        
        .message-time {
            font-size: 10px;
            color: var(--text-light);
            margin-top: 2px;
            text-align: right;
        }
        
        .message.received .message-time {
            color: var(--text-gray);
        }
        
        .chat-input-container {
            padding: 14px;
            background: var(--white);
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 8px;
        }
        
        .chat-input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid var(--border-color);
            border-radius: var(--button-radius);
            font-size: 13px;
            outline: none;
            transition: all var(--transition-speed) ease;
        }
        
        .chat-input:focus {
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
        }
        
        .chat-send-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-speed) ease;
        }
        
        .chat-send-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 3px 10px rgba(255, 107, 53, 0.3);
        }
        
        .chat-notification {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 18px;
            height: 18px;
            background: var(--error-red);
            color: var(--white);
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            animation: bounce 1s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        
        /* Modal System */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
            backdrop-filter: blur(4px);
        }
        
        .modal-overlay.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        
        .modal {
            background: var(--white);
            border-radius: var(--card-radius);
            box-shadow: var(--shadow-heavy);
            max-width: 450px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            animation: modalSlideUp 0.3s ease;
        }
        
        @keyframes modalSlideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--dark-gray);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--text-light);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all var(--transition-speed) ease;
        }
        
        .modal-close:hover {
            color: var(--error-red);
            background: var(--light-red);
        }
        
        .modal-content {
            padding: 20px;
        }
        
        /* History Screen */
        .history-screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--white);
            z-index: 200;
            display: none;
            flex-direction: column;
            padding-top: 56px;
        }
        
        .history-screen.active {
            display: flex;
            animation: slideInRight 0.3s ease;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        .screen-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: var(--white);
            padding: 14px var(--app-padding);
            border-bottom: 1px solid var(--border-color);
            z-index: 10;
            display: flex;
            align-items: center;
            gap: 14px;
        }
        
        .back-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--dark-gray);
            border: none;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .back-btn:hover {
            background: var(--medium-gray);
            transform: translateX(-2px);
        }
        
        .screen-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--dark-gray);
        }
        
        .history-filters {
            padding: 14px var(--app-padding);
            background: var(--off-white);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 8px;
            overflow-x: auto;
            scrollbar-width: none;
        }
        
        .history-filters::-webkit-scrollbar {
            display: none;
        }
        
        .filter-btn {
            padding: 6px 14px;
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--button-radius);
            font-size: 12px;
            font-weight: 600;
            color: var(--text-gray);
            cursor: pointer;
            white-space: nowrap;
            transition: all var(--transition-speed) ease;
        }
        
        .filter-btn.active {
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            border-color: transparent;
        }
        
        .filter-btn:hover:not(.active) {
            border-color: var(--primary-orange);
            color: var(--primary-orange);
        }
        
        .history-list {
            flex: 1;
            overflow-y: auto;
            padding: 14px var(--app-padding);
        }
        
        .history-item {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 16px;
            margin-bottom: 10px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .history-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
            border-color: var(--primary-orange);
        }
        
        .history-item.expanded {
            margin-bottom: 16px;
        }
        
        .history-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .history-type {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .history-icon {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            background: var(--light-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-orange);
        }
        
        .history-type-name {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
        }
        
        .history-date {
            font-size: 12px;
            color: var(--text-light);
        }
        
        .history-status {
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-completed {
            background: #E8F6EF;
            color: var(--economy-green);
        }
        
        .status-cancelled {
            background: var(--light-red);
            color: var(--error-red);
        }
        
        .status-ongoing {
            background: #E3F2FD;
            color: var(--info-blue);
        }
        
        .history-locations {
            margin-bottom: 10px;
        }
        
        .history-location {
            display: flex;
            align-items: flex-start;
            gap: 6px;
            margin-bottom: 6px;
        }
        
        .history-location i {
            color: var(--text-light);
            margin-top: 2px;
        }
        
        .history-location-text {
            font-size: 12px;
            color: var(--text-gray);
            line-height: 1.3;
        }
        
        .history-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
        }
        
        .history-price {
            font-size: 14px;
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        .history-driver {
            font-size: 12px;
            color: var(--text-gray);
        }
        
        .history-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .history-item.expanded .history-details {
            max-height: 400px;
            margin-top: 14px;
            padding-top: 14px;
            border-top: 1px solid var(--border-color);
        }
        
        .detail-section {
            margin-bottom: 14px;
        }
        
        .detail-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--dark-gray);
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .detail-label {
            font-size: 11px;
            color: var(--text-light);
            font-weight: 500;
        }
        
        .detail-value {
            font-size: 13px;
            color: var(--dark-gray);
            font-weight: 500;
        }
        
        /* Account Screen */
        .account-screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--white);
            z-index: 200;
            display: none;
            flex-direction: column;
            padding-top: 56px;
        }
        
        .account-screen.active {
            display: flex;
        }
        
        .account-header {
            padding: 20px var(--app-padding);
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            text-align: center;
        }
        
        .account-avatar {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            margin: 0 auto 14px;
            border: 3px solid rgba(255, 255, 255, 0.3);
        }
        
        .account-name {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 2px;
        }
        
        .account-phone {
            font-size: 13px;
            opacity: 0.9;
        }
        
        .account-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            padding: 16px var(--app-padding);
            background: var(--white);
        }
        
        .stat-card {
            background: var(--off-white);
            border-radius: var(--element-radius);
            padding: 14px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary-orange);
            margin-bottom: 2px;
        }
        
        .stat-label {
            font-size: 11px;
            color: var(--text-gray);
            font-weight: 500;
        }
        
        .account-section {
            padding: 16px var(--app-padding);
            border-bottom: 1px solid var(--border-color);
        }
        
        .section-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--dark-gray);
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .wallet-balance {
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            padding: 20px;
            border-radius: var(--element-radius);
            text-align: center;
            margin-bottom: 16px;
        }
        
        .balance-label {
            font-size: 13px;
            opacity: 0.9;
            margin-bottom: 6px;
        }
        
        .balance-amount-large {
            font-size: 30px;
            font-weight: 800;
            margin-bottom: 2px;
        }
        
        .wallet-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 14px;
        }
        
        .btn-wallet {
            padding: 10px;
            border: 2px solid var(--primary-orange);
            background: var(--white);
            color: var(--primary-orange);
            border-radius: var(--button-radius);
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .btn-wallet:hover {
            background: var(--primary-orange);
            color: var(--white);
            transform: translateY(-2px);
        }
        
        .referral-card {
            background: var(--light-orange);
            border-radius: var(--element-radius);
            padding: 16px;
            text-align: center;
            margin-top: 14px;
        }
        
        .referral-code {
            background: var(--white);
            padding: 14px;
            border-radius: var(--element-radius);
            margin: 14px 0;
            font-family: monospace;
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-orange);
            letter-spacing: 2px;
        }
        
        .referral-note {
            font-size: 11px;
            color: var(--text-gray);
            margin-top: 6px;
        }
        
        /* Emergency Screen */
        .emergency-screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--white);
            z-index: 200;
            display: none;
            flex-direction: column;
            padding-top: 56px;
        }
        
        .emergency-screen.active {
            display: flex;
        }
        
        .emergency-services {
            padding: 16px var(--app-padding);
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .emergency-service {
            background: var(--white);
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .emergency-service:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-medium);
        }
        
        .emergency-service.police {
            border-color: var(--police-blue);
        }
        
        .emergency-service.police:hover {
            border-color: var(--police-blue);
            box-shadow: 0 6px 20px rgba(44, 62, 80, 0.2);
        }
        
        .emergency-service.fire {
            border-color: var(--fire-truck-red);
        }
        
        .emergency-service.fire:hover {
            border-color: var(--fire-truck-red);
            box-shadow: 0 6px 20px rgba(192, 57, 43, 0.2);
        }
        
        .emergency-service.medical {
            border-color: var(--ambulance-blue);
        }
        
        .emergency-service.medical:hover {
            border-color: var(--ambulance-blue);
            box-shadow: 0 6px 20px rgba(41, 128, 185, 0.2);
        }
        
        .emergency-icon {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin: 0 auto 10px;
            color: var(--white);
        }
        
        .emergency-service.police .emergency-icon {
            background: var(--police-blue);
        }
        
        .emergency-service.fire .emergency-icon {
            background: var(--fire-truck-red);
        }
        
        .emergency-service.medical .emergency-icon {
            background: var(--ambulance-blue);
        }
        
        .emergency-name {
            font-size: 14px;
            font-weight: 700;
            color: var(--dark-gray);
            margin-bottom: 6px;
        }
        
        .emergency-description {
            font-size: 12px;
            color: var(--text-gray);
            line-height: 1.3;
        }
        
        .emergency-note {
            padding: 16px var(--app-padding);
            background: var(--light-red);
            margin: 16px var(--app-padding);
            border-radius: var(--element-radius);
            border-left: 3px solid var(--error-red);
        }
        
        .emergency-note p {
            font-size: 12px;
            color: var(--dark-gray);
            line-height: 1.4;
        }
        
        /* Loading States */
        .loading {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid var(--light-gray);
            border-radius: 50%;
            border-top-color: var(--primary-orange);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            z-index: 10000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
        }
        
        .loading-overlay.active {
            display: flex;
        }
        
        .loading-spinner {
            width: 52px;
            height: 52px;
            border: 4px solid var(--light-gray);
            border-radius: 50%;
            border-top-color: var(--primary-orange);
            animation: spin 1s linear infinite;
        }
        
        .loading-text {
            font-size: 14px;
            font-weight: 600;
            color: var(--dark-gray);
        }
        
        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 90px;
            right: var(--app-padding);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-width: 350px;
        }
        
        .toast {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 14px;
            box-shadow: var(--shadow-heavy);
            border-left: 3px solid var(--primary-orange);
            display: flex;
            align-items: flex-start;
            gap: 10px;
            animation: slideInRight 0.3s ease;
            transform: translateX(0);
            transition: transform 0.3s ease;
        }
        
        .toast.hiding {
            transform: translateX(100%);
        }
        
        .toast-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--light-orange);
            color: var(--primary-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
            margin-bottom: 2px;
        }
        
        .toast-message {
            font-size: 12px;
            color: var(--text-gray);
            line-height: 1.3;
        }
        
        .toast-close {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 16px;
            cursor: pointer;
            padding: 2px;
            border-radius: 4px;
            transition: all var(--transition-speed) ease;
        }
        
        .toast-close:hover {
            color: var(--error-red);
            background: var(--light-red);
        }
        
        .toast.success {
            border-left-color: var(--success-green);
        }
        
        .toast.success .toast-icon {
            background: #E8F6EF;
            color: var(--success-green);
        }
        
        .toast.error {
            border-left-color: var(--error-red);
        }
        
        .toast.error .toast-icon {
            background: var(--light-red);
            color: var(--error-red);
        }
        
        .toast.warning {
            border-left-color: var(--warning-yellow);
        }
        
        .toast.warning .toast-icon {
            background: #FFF3E0;
            color: var(--warning-yellow);
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            :root {
                --app-padding: 10px;
                --element-radius: 10px;
                --button-radius: 16px;
            }
            
            .quick-actions {
                grid-template-columns: 1fr;
            }
            
            .ride-type-grid {
                grid-template-columns: 1fr;
            }
            
            .emergency-services {
                grid-template-columns: 1fr;
            }
            
            .chat-container {
                width: calc(100vw - 20px);
                right: 10px;
            }
            
            .detail-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 480px) {
            .nav-tabs {
                gap: 4px;
            }
            
            .nav-tab {
                padding: 8px 4px;
                font-size: 10px;
            }
            
            .nav-tab i {
                font-size: 14px;
            }
            
            .balance-badge {
                padding: 5px 8px;
                font-size: 12px;
            }
            
            .service-tab {
                min-width: 85px;
                padding: 10px 12px;
            }
        }
        
        /* Custom Markers */
        .current-location-marker {
            background: var(--info-blue);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            box-shadow: 0 1px 8px rgba(0,0,0,0.3);
            border: 2px solid white;
        }
        
        .pickup-marker {
            background: var(--primary-orange);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            box-shadow: 0 1px 8px rgba(0,0,0,0.3);
            border: 2px solid white;
        }
        
        .destination-marker {
            background: var(--primary-red);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            box-shadow: 0 1px 8px rgba(0,0,0,0.3);
            border: 2px solid white;
        }
        
        .driver-marker {
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: white;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            box-shadow: 0 1px 8px rgba(0,0,0,0.3);
            border: 2px solid white;
            animation: pulse 2s infinite;
        }
        
        .emergency-vehicle-marker {
            background: var(--error-red);
            color: white;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            box-shadow: 0 1px 8px rgba(0,0,0,0.3);
            border: 2px solid white;
            animation: emergencyPulse 1s infinite;
        }
        
        /* Enhanced Form Elements */
        .form-group {
            margin-bottom: 14px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 13px;
            color: var(--dark-gray);
            background: var(--white);
            transition: all var(--transition-speed) ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
        }
        
        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        /* Search Loading Indicator */
        .search-loading {
            display: none;
            position: absolute;
            top: 50%;
            right: 12px;
            transform: translateY(-50%);
            width: 14px;
            height: 14px;
            border: 2px solid var(--light-gray);
            border-radius: 50%;
            border-top-color: var(--primary-orange);
            animation: spin 0.6s linear infinite;
        }
        
        .location-input.searching .search-loading {
            display: block;
        }
        
        /* No Results Message */
        .no-results {
            padding: 30px 16px;
            text-align: center;
            color: var(--text-light);
            font-size: 13px;
        }
        
        .no-results i {
            font-size: 28px;
            margin-bottom: 10px;
            opacity: 0.5;
        }
        
        /* Price Calculation Display */
        .price-calculation {
            background: var(--off-white);
            border-radius: var(--element-radius);
            padding: 14px;
            margin: 14px 0;
            font-size: 12px;
            color: var(--text-gray);
        }
        
        .calculation-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }
        
        .calculation-row:last-child {
            margin-bottom: 0;
            padding-top: 6px;
            border-top: 1px solid var(--border-color);
            font-weight: 600;
            color: var(--dark-gray);
        }
        
        /* Cancel Reasons Modal */
        .cancel-reasons {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-bottom: 16px;
        }
        
        .cancel-reason {
            padding: 14px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .cancel-reason:hover {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .cancel-reason.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .reason-icon {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-gray);
        }
        
        .cancel-reason.selected .reason-icon {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .reason-text {
            flex: 1;
            font-weight: 500;
            color: var(--dark-gray);
        }
        
        /* Schedule Ride Form */
        .schedule-form {
            display: none;
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }
        
        .schedule-form.active {
            display: block;
        }
        
        .schedule-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 14px;
        }
        
        /* More Options */
        .more-options {
            display: none;
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }
        
        .more-options.active {
            display: block;
        }
        
        .options-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .option-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 14px;
            background: var(--off-white);
            border: 2px solid transparent;
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .option-btn:hover {
            border-color: var(--primary-orange);
            background: var(--white);
            transform: translateY(-2px);
        }
        
        .option-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: var(--light-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-orange);
            font-size: 16px;
        }
        
        .option-name {
            font-weight: 600;
            font-size: 12px;
            color: var(--dark-gray);
            text-align: center;
        }
        
        /* Empty States */
        .empty-state {
            padding: 50px 16px;
            text-align: center;
            color: var(--text-light);
        }
        
        .empty-icon {
            font-size: 40px;
            margin-bottom: 14px;
            opacity: 0.3;
        }
        
        .empty-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text-gray);
        }
        
        .empty-message {
            font-size: 13px;
            margin-bottom: 16px;
            line-height: 1.4;
        }
        
        /* Service Forms */
        .service-form {
            display: none;
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }
        
        .service-form.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        /* Truck Delivery Form */
        .truck-form {
            border-color: var(--light-truck-brown);
        }
        
        .truck-form .form-title {
            color: var(--light-truck-brown);
        }
        
        /* Delivery Form */
        .delivery-form {
            border-color: var(--delivery-purple);
        }
        
        .delivery-form .form-title {
            color: var(--delivery-purple);
        }
        
        /* Express Shopping Form */
        .express-form {
            border-color: var(--express-shop-green);
        }
        
        .express-form .form-title {
            color: var(--express-shop-green);
        }
        
        /* Order for Someone Else Form */
        .someone-else-form {
            border-color: var(--info-blue);
        }
        
        .someone-else-form .form-title {
            color: var(--info-blue);
        }
        
        /* Ride Sharing Form */
        .share-ride-form {
            border-color: var(--warning-yellow);
        }
        
        .share-ride-form .form-title {
            color: var(--warning-yellow);
        }
        
        /* Payment Selection Styles */
        .payment-methods {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin: 16px 0;
        }
        
        .payment-method {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .payment-method:hover {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .payment-method.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .payment-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-gray);
        }
        
        .payment-method.selected .payment-icon {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .payment-details {
            flex: 1;
        }
        
        .payment-name {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
        }
        
        .payment-info {
            font-size: 11px;
            color: var(--text-gray);
            margin-top: 2px;
        }
        
        /* Wallet Transfer Form */
        .transfer-form {
            display: none;
        }
        
        .transfer-form.active {
            display: block;
        }
        
        /* Timeline */
        .timeline {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 16px 0;
            padding: 0 20px;
            position: relative;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            top: 12px;
            left: 10%;
            right: 10%;
            height: 2px;
            background: var(--border-color);
            z-index: 1;
        }
        
        .timeline-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            position: relative;
            z-index: 2;
            flex: 1;
        }
        
        .step-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            font-size: 10px;
            border: 2px solid var(--white);
            transition: all var(--transition-speed) ease;
        }
        
        .step-dot.active {
            background: var(--primary-orange);
            color: var(--white);
            transform: scale(1.1);
        }
        
        .step-dot.completed {
            background: var(--success-green);
            color: var(--white);
        }
        
        .step-label {
            font-size: 11px;
            color: var(--text-light);
            text-align: center;
        }
        
        .step-label.active {
            color: var(--primary-orange);
            font-weight: 600;
        }
        
        /* Parcel Details */
        .parcel-details {
            background: var(--off-white);
            border-radius: var(--element-radius);
            padding: 14px;
            margin: 12px 0;
        }
        
        .parcel-value-input {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .parcel-value-input span {
            font-weight: 600;
            color: var(--text-gray);
        }
        
        .parcel-value-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 13px;
        }
        
        /* Truck Types */
        .truck-types {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 12px 0;
        }
        
        .truck-type {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            text-align: center;
        }
        
        .truck-type:hover {
            border-color: var(--light-truck-brown);
            transform: translateY(-2px);
        }
        
        .truck-type.selected {
            border-color: var(--light-truck-brown);
            background: rgba(139, 69, 19, 0.05);
        }
        
        .truck-icon {
            font-size: 20px;
            color: var(--light-truck-brown);
            margin-bottom: 6px;
        }
        
        .truck-name {
            font-weight: 600;
            font-size: 12px;
            color: var(--dark-gray);
            margin-bottom: 2px;
        }
        
        .truck-capacity {
            font-size: 10px;
            color: var(--text-gray);
        }
        
        /* Item List for Express Shopping */
        .item-list {
            margin: 12px 0;
        }
        
        .item-entry {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .item-entry input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 13px;
        }
        
        .remove-item {
            width: 36px;
            height: 36px;
            border-radius: var(--element-radius);
            background: var(--light-red);
            border: none;
            color: var(--error-red);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .add-item {
            width: 100%;
            padding: 10px;
            background: var(--light-orange);
            border: 2px dashed var(--primary-orange);
            border-radius: var(--element-radius);
            color: var(--primary-orange);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all var(--transition-speed) ease;
        }
        
        .add-item:hover {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        /* Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* Focus Styles */
        *:focus {
            outline: 2px solid var(--primary-orange);
            outline-offset: 2px;
        }
        
        *:focus:not(.focus-visible) {
            outline: none;
        }
        
        /* Print Styles */
        @media print {
            .main-panel,
            .top-bar,
            .chat-container,
            .modal-overlay,
            .sos-button,
            .ride-status-bar,
            .emergency-status {
                display: none !important;
            }
            
            #map {
                position: relative;
                height: 300px;
            }
        }
        
        /* Enhanced Broadcast Section */
        .broadcast-section {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 16px;
            margin: 12px 0;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }
        
        .broadcast-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .broadcast-input-group {
            display: flex;
            gap: 8px;
        }
        
        .broadcast-input-group input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 13px;
        }
        
        .broadcast-btn {
            padding: 10px 16px;
            background: var(--primary-orange);
            color: var(--white);
            border: none;
            border-radius: var(--element-radius);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .broadcast-btn:hover {
            background: var(--secondary-orange);
            transform: translateY(-2px);
        }
        
        .broadcast-list {
            margin-top: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .broadcast-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .broadcast-item:last-child {
            border-bottom: none;
        }
        
        .broadcast-name {
            font-weight: 600;
            font-size: 13px;
        }
        
        .broadcast-status {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 10px;
            background: var(--light-orange);
            color: var(--primary-orange);
        }
        
        .broadcast-status.pending {
            background: #FFF3E0;
            color: var(--warning-yellow);
        }
        
        .broadcast-status.accepted {
            background: #E8F6EF;
            color: var(--success-green);
        }
        
        /* Driver Media Display */
        .driver-media {
            display: flex;
            gap: 12px;
            margin-top: 10px;
        }
        
        .media-container {
            flex: 1;
            border-radius: var(--element-radius);
            overflow: hidden;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 80px;
        }
        
        .media-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .media-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            font-size: 12px;
        }
        
        .media-placeholder i {
            font-size: 24px;
            margin-bottom: 4px;
        }
        
        /* Emergency Reason Selection */
        .emergency-reasons {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin: 16px 0;
        }
        
        .emergency-reason {
            padding: 14px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .emergency-reason:hover {
            border-color: var(--error-red);
            background: var(--light-red);
        }
        
        .emergency-reason.selected {
            border-color: var(--error-red);
            background: var(--light-red);
        }
        
        .emergency-reason-icon {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            background: var(--light-red);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--error-red);
        }
        
        .emergency-reason.selected .emergency-reason-icon {
            background: var(--error-red);
            color: var(--white);
        }
        
        .emergency-reason-text {
            flex: 1;
            font-weight: 500;
            color: var(--dark-gray);
        }
        
        /* Emergency Stations List */
        .emergency-stations {
            margin: 16px 0;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .emergency-station {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            margin-bottom: 8px;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .emergency-station:hover {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .emergency-station.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .station-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        
        .station-name {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
        }
        
        .station-distance {
            font-size: 11px;
            color: var(--text-gray);
        }
        
        .station-address {
            font-size: 12px;
            color: var(--text-gray);
            line-height: 1.3;
        }
        
        .station-details {
            margin-top: 6px;
            font-size: 11px;
            color: var(--text-light);
            display: flex;
            gap: 10px;
        }
        
        /* Enhanced Search Results */
        .search-results-container {
            position: relative;
            z-index: 1001;
        }
        
        .search-result-item {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        
        .search-result-item:hover {
            background: var(--light-orange);
        }
        
        .search-result-icon {
            color: var(--primary-orange);
            font-size: 16px;
            margin-top: 2px;
        }
        
        .search-result-content {
            flex: 1;
        }
        
        .search-result-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
            margin-bottom: 2px;
        }
        
        .search-result-subtitle {
            font-size: 12px;
            color: var(--text-gray);
            margin-bottom: 2px;
        }
        
        .search-result-details {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-light);
        }
        
        /* City Detection Indicator */
        .city-detection {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 150;
            background: var(--white);
            padding: 8px 16px;
            border-radius: var(--button-radius);
            box-shadow: var(--shadow-heavy);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            font-weight: 500;
            color: var(--dark-gray);
        }
        
        .city-detection i {
            color: var(--primary-orange);
        }
        
        /* Enhanced Notifications Panel */
        .notifications-panel {
            position: absolute;
            top: 56px;
            right: var(--app-padding);
            z-index: 250;
            width: 320px;
            max-width: calc(100vw - 40px);
            background: var(--white);
            border-radius: var(--card-radius);
            box-shadow: var(--shadow-heavy);
            display: none;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        
        .notifications-panel.active {
            display: flex;
            animation: slideDown 0.3s ease;
        }
        
        .notifications-header {
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            padding: 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .notifications-title {
            font-weight: 600;
            font-size: 13px;
        }
        
        .notifications-close {
            background: none;
            border: none;
            color: var(--white);
            font-size: 16px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all var(--transition-speed) ease;
        }
        
        .notifications-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .notifications-list {
            flex: 1;
            max-height: 300px;
            overflow-y: auto;
            background: var(--off-white);
        }
        
        .notification-item {
            padding: 14px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .notification-item:hover {
            background: var(--white);
        }
        
        .notification-item.unread {
            background: var(--light-orange);
        }
        
        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        
        .notification-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .notification-time {
            font-size: 11px;
            color: var(--text-light);
        }
        
        .notification-message {
            font-size: 12px;
            color: var(--text-gray);
            line-height: 1.3;
        }
        
        .notification-actions {
            margin-top: 8px;
            display: flex;
            gap: 8px;
        }
        
        .notification-action-btn {
            padding: 4px 8px;
            font-size: 11px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background: var(--white);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .notification-action-btn:hover {
            background: var(--primary-orange);
            color: var(--white);
            border-color: var(--primary-orange);
        }
        
        /* Dropdown Menu */
        .dropdown-menu {
            position: absolute;
            top: 60px;
            right: var(--app-padding);
            z-index: 250;
            width: 200px;
            background: var(--white);
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            display: none;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        
        .dropdown-menu.active {
            display: flex;
            animation: slideDown 0.3s ease;
        }
        
        .dropdown-item {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            color: var(--dark-gray);
        }
        
        .dropdown-item:hover {
            background: var(--light-orange);
            color: var(--primary-orange);
        }
        
        .dropdown-item:last-child {
            border-bottom: none;
        }
        
        .dropdown-item i {
            width: 18px;
            text-align: center;
        }
        
        /* More Options Menu */
        .more-options-menu {
            position: absolute;
            bottom: 200px;
            left: var(--app-padding);
            z-index: 250;
            width: 200px;
            background: var(--white);
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            display: none;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        
        .more-options-menu.active {
            display: flex;
            animation: slideUp 0.3s ease;
        }
        
        /* Enhanced Emergency Modal */
        .emergency-modal-content {
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .emergency-reason-input {
            margin-top: 10px;
        }
        
        .emergency-reason-input textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 13px;
            resize: vertical;
            min-height: 80px;
        }
        
        /* Real-time Updates Indicator */
        .real-time-indicator {
            position: fixed;
            bottom: 10px;
            right: 10px;
            z-index: 1000;
            background: var(--success-green);
            color: var(--white);
            padding: 6px 12px;
            border-radius: var(--button-radius);
            font-size: 11px;
            font-weight: 600;
            display: none;
            align-items: center;
            gap: 6px;
            box-shadow: var(--shadow-medium);
        }
        
        .real-time-indicator.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        
        /* Enhanced Chat Features */
        .chat-typing-indicator {
            font-size: 11px;
            color: var(--text-light);
            font-style: italic;
            padding: 4px 12px;
            display: none;
        }
        
        .chat-typing-indicator.active {
            display: block;
        }
        
        .chat-attachment-btn {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 16px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all var(--transition-speed) ease;
        }
        
        .chat-attachment-btn:hover {
            color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        /* Enhanced Search Bar */
        .search-bar-container {
            position: relative;
            margin-bottom: 12px;
        }
        
        .search-bar {
            width: 100%;
            padding: 12px 16px 12px 40px;
            border: 2px solid var(--border-color);
            border-radius: var(--button-radius);
            font-size: 13px;
            transition: all var(--transition-speed) ease;
        }
        
        .search-bar:focus {
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
        }
        
        .search-bar-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
        }
        
        /* Enhanced Price Calculator */
        .price-calculator-display {
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            padding: 16px;
            border-radius: var(--element-radius);
            margin: 16px 0;
            box-shadow: var(--shadow-medium);
        }
        
        .price-breakdown {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .price-breakdown-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 12px;
            opacity: 0.9;
        }
        
        .price-breakdown-row.total {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            font-weight: 700;
            font-size: 14px;
        }
        
        /* Enhanced Map Controls */
        .map-controls {
            position: absolute;
            top: 100px;
            right: var(--app-padding);
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .map-control-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--white);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-medium);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--dark-gray);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .map-control-btn:hover {
            background: var(--primary-orange);
            color: var(--white);
            transform: scale(1.1);
        }
        
        /* Enhanced Driver Tracking */
        .tracking-info {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 12px;
            margin: 12px 0;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }
        
        .tracking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .tracking-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
        }
        
        .tracking-distance {
            font-size: 12px;
            color: var(--primary-orange);
            font-weight: 600;
        }
        
        .tracking-progress {
            height: 6px;
            background: var(--light-gray);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        
        .tracking-progress-bar {
            height: 100%;
            background: var(--primary-orange);
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        .tracking-details {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-gray);
        }
        
        /* Enhanced Broadcast Feature */
        .broadcast-feature {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 16px;
            margin: 16px 0;
            box-shadow: var(--shadow-medium);
            border: 1px solid var(--border-color);
        }
        
        .broadcast-feature-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        
        .broadcast-feature-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--dark-gray);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .broadcast-status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success-green);
            animation: pulse 1.5s infinite;
        }
        
        .broadcast-status-indicator.inactive {
            background: var(--text-light);
            animation: none;
        }
        
        .broadcast-recipients {
            max-height: 150px;
            overflow-y: auto;
            margin-bottom: 12px;
        }
        
        .broadcast-recipient {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .broadcast-recipient:last-child {
            border-bottom: none;
        }
        
        .recipient-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .recipient-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--light-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-orange);
            font-weight: 600;
            font-size: 12px;
        }
        
        .recipient-name {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
        }
        
        .recipient-status {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
        }
        
        .status-joined {
            background: #E8F6EF;
            color: var(--success-green);
        }
        
        .status-pending {
            background: #FFF3E0;
            color: var(--warning-yellow);
        }
        
        /* Enhanced Location Details */
        .location-details {
            background: var(--off-white);
            border-radius: var(--element-radius);
            padding: 14px;
            margin: 12px 0;
        }
        
        .location-detail-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .location-detail-item:last-child {
            margin-bottom: 0;
        }
        
        .location-detail-icon {
            color: var(--primary-orange);
            font-size: 14px;
            margin-top: 2px;
        }
        
        .location-detail-content {
            flex: 1;
        }
        
        .location-detail-label {
            font-size: 11px;
            color: var(--text-light);
            margin-bottom: 2px;
        }
        
        .location-detail-value {
            font-size: 13px;
            color: var(--dark-gray);
            font-weight: 500;
            line-height: 1.3;
        }
        
        /* Enhanced Emergency Contact */
        .emergency-contact-display {
            background: var(--light-red);
            border-radius: var(--element-radius);
            padding: 14px;
            margin: 12px 0;
            border-left: 3px solid var(--error-red);
        }
        
        .emergency-contact-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .emergency-contact-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
        }
        
        .emergency-contact-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(231, 76, 60, 0.1);
        }
        
        .emergency-contact-item:last-child {
            border-bottom: none;
        }
        
        .contact-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .contact-name {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
        }
        
        .contact-phone {
            font-size: 12px;
            color: var(--text-gray);
        }
        
        .contact-action-btn {
            padding: 4px 8px;
            font-size: 11px;
            border-radius: 12px;
            background: var(--white);
            border: 1px solid var(--error-red);
            color: var(--error-red);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .contact-action-btn:hover {
            background: var(--error-red);
            color: var(--white);
        }
        
        /* Enhanced Service Type Indicators */
        .service-type-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .indicator-car {
            background: var(--light-orange);
            color: var(--primary-orange);
        }
        
        .indicator-delivery {
            background: #F4E6FA;
            color: var(--delivery-purple);
        }
        
        .indicator-truck {
            background: rgba(139, 69, 19, 0.1);
            color: var(--light-truck-brown);
        }
        
        .indicator-emergency {
            background: var(--light-red);
            color: var(--error-red);
        }
        
        .indicator-shopping {
            background: #E1F5FE;
            color: var(--express-shop-green);
        }
        
        /* Enhanced Price Updates Animation */
        .price-update-animation {
            animation: priceUpdate 0.5s ease;
        }
        
        @keyframes priceUpdate {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* Enhanced Real-time Sync Indicator */
        .sync-indicator {
            position: fixed;
            bottom: 10px;
            left: 10px;
            z-index: 1000;
            background: var(--info-blue);
            color: var(--white);
            padding: 6px 12px;
            border-radius: var(--button-radius);
            font-size: 11px;
            font-weight: 600;
            display: none;
            align-items: center;
            gap: 6px;
            box-shadow: var(--shadow-medium);
        }
        
        .sync-indicator.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        
        .sync-indicator.syncing .sync-icon {
            animation: spin 1s linear infinite;
        }
        
        /* Enhanced Distance Display */
        .distance-display {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--light-orange);
            border-radius: var(--element-radius);
            font-size: 12px;
            color: var(--dark-gray);
        }
        
        .distance-value {
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        /* Enhanced ETA Display */
        .eta-display {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--light-gray);
            border-radius: var(--element-radius);
            font-size: 12px;
            color: var(--dark-gray);
        }
        
        .eta-value {
            font-weight: 700;
            color: var(--info-blue);
        }
        
        /* Enhanced Search History */
        .search-history {
            margin-top: 8px;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .search-history-item {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .search-history-item:hover {
            background: var(--light-orange);
        }
        
        .search-history-icon {
            color: var(--text-light);
            font-size: 12px;
        }
        
        .search-history-text {
            flex: 1;
            font-size: 13px;
            color: var(--dark-gray);
        }
        
        .search-history-time {
            font-size: 11px;
            color: var(--text-light);
        }
        
        /* Enhanced Broadcast Notifications */
        .broadcast-notification {
            background: var(--info-blue);
            color: var(--white);
            padding: 12px;
            border-radius: var(--element-radius);
            margin: 12px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .broadcast-notification-content {
            flex: 1;
        }
        
        .broadcast-notification-title {
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 4px;
        }
        
        .broadcast-notification-message {
            font-size: 12px;
            opacity: 0.9;
        }
        
        .broadcast-notification-actions {
            display: flex;
            gap: 8px;
        }
        
        /* Enhanced Map Loading */
        .map-loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 12px;
        }
        
        .map-loading-text {
            font-size: 14px;
            font-weight: 600;
            color: var(--dark-gray);
        }
        
        /* Enhanced Error Display */
        .error-display {
            background: var(--light-red);
            border-radius: var(--element-radius);
            padding: 14px;
            margin: 12px 0;
            border-left: 3px solid var(--error-red);
        }
        
        .error-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--error-red);
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .error-message {
            font-size: 12px;
            color: var(--dark-gray);
            line-height: 1.3;
        }
        
        /* Enhanced Success Display */
        .success-display {
            background: #E8F6EF;
            border-radius: var(--element-radius);
            padding: 14px;
            margin: 12px 0;
            border-left: 3px solid var(--success-green);
        }
        
        .success-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--success-green);
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .success-message {
            font-size: 12px;
            color: var(--dark-gray);
            line-height: 1.3;
        }
        
        /* Enhanced Warning Display */
        .warning-display {
            background: #FFF3E0;
            border-radius: var(--element-radius);
            padding: 14px;
            margin: 12px 0;
            border-left: 3px solid var(--warning-yellow);
        }
        
        .warning-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--warning-yellow);
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .warning-message {
            font-size: 12px;
            color: var(--dark-gray);
            line-height: 1.3;
        }
    </style>
</head>
<body>
    <!-- Map Container -->
    <div id="map">
        <div class="map-loading-overlay" id="mapLoadingOverlay">
            <div class="loading-spinner"></div>
            <div class="map-loading-text">Loading map...</div>
        </div>
    </div>
    
    <!-- Top Navigation Bar -->
    <div class="top-bar">
        <div class="logo-container">
            <div class="logo-icon">
                <img src="jubel.png" alt="Jubel Logo" id="jubelLogo">
            </div>
            <div class="logo-text" id="userFullName">Loading...</div>
        </div>
        
        <div class="user-actions">
            <div class="balance-badge" id="balanceBadge">
                <i class="fas fa-wallet"></i>
                <span>Balance: <span class="balance-amount" id="walletBalance">ZMW 0.00</span></span>
            </div>
            <div class="notification-bell" id="notificationBell">
                <i class="fas fa-bell"></i>
                <span class="notification-badge" id="notificationCount">0</span>
            </div>
        </div>
    </div>
    
    <!-- City Detection Indicator -->
    <div class="city-detection" id="cityDetection">
        <i class="fas fa-map-marker-alt"></i>
        <span id="currentCityDisplay">Detecting your city...</span>
    </div>
    
    <!-- Ride Status Bar -->
    <div class="ride-status-bar" id="rideStatusBar">
        <div class="status-indicator">
            <div class="status-dot searching" id="statusDot"></div>
            <span class="status-text" id="statusText">Searching for driver</span>
        </div>
        <div class="status-eta">
            <i class="fas fa-clock"></i>
            <span id="etaText">5 min</span>
        </div>
    </div>
    
    <!-- Emergency Status -->
    <div class="emergency-status" id="emergencyStatus">
        <i class="fas fa-exclamation-triangle"></i>
        <span>EMERGENCY RIDE IN PROGRESS</span>
    </div>
    
    <!-- SOS Button -->
    <div class="sos-button" id="sosButton">
        <i class="fas fa-exclamation-triangle"></i>
    </div>
    
    <!-- Map Controls -->
    <div class="map-controls">
        <button class="map-control-btn" id="locateMeBtn" title="Locate Me">
            <i class="fas fa-location-arrow"></i>
        </button>
        <button class="map-control-btn" id="zoomInBtn" title="Zoom In">
            <i class="fas fa-plus"></i>
        </button>
        <button class="map-control-btn" id="zoomOutBtn" title="Zoom Out">
            <i class="fas fa-minus"></i>
        </button>
        <button class="map-control-btn" id="clearRouteBtn" title="Clear Route">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <!-- Chat Container -->
    <div class="chat-container" id="chatContainer">
        <div class="chat-header">
            <div class="chat-title">Chat with Driver</div>
            <button class="chat-close" id="chatClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <!-- Messages will be inserted here -->
        </div>
        <div class="chat-typing-indicator" id="typingIndicator">
            Driver is typing...
        </div>
        <div class="chat-input-container">
            <button class="chat-attachment-btn" id="attachmentBtn">
                <i class="fas fa-paperclip"></i>
            </button>
            <input type="text" class="chat-input" id="chatInput" placeholder="Type your message...">
            <button class="chat-send-btn" id="chatSend">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
    
    <!-- Notifications Panel -->
    <div class="notifications-panel" id="notificationsPanel">
        <div class="notifications-header">
            <div class="notifications-title">Notifications</div>
            <button class="notifications-close" id="notificationsClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="notifications-list" id="notificationsList">
            <!-- Notifications will be inserted here -->
        </div>
    </div>
    
    <!-- Dropdown Menu -->
    <div class="dropdown-menu" id="dropdownMenu">
        <div class="dropdown-item" data-action="profile">
            <i class="fas fa-user"></i>
            <span>Profile</span>
        </div>
        <div class="dropdown-item" data-action="settings">
            <i class="fas fa-cog"></i>
            <span>Settings</span>
        </div>
        <div class="dropdown-item" data-action="help">
            <i class="fas fa-question-circle"></i>
            <span>Help & Support</span>
        </div>
        <div class="dropdown-item" data-action="logout">
            <i class="fas fa-sign-out-alt"></i>
            <span>Logout</span>
        </div>
    </div>
    
    <!-- More Options Menu -->
    <div class="more-options-menu" id="moreOptionsMenu">
        <div class="dropdown-item" data-option="schedule">
            <i class="fas fa-calendar-alt"></i>
            <span>Schedule Ride</span>
        </div>
        <div class="dropdown-item" data-option="orderForSomeone">
            <i class="fas fa-user-friends"></i>
            <span>Order for Someone</span>
        </div>
        <div class="dropdown-item" data-option="shareRide">
            <i class="fas fa-share-alt"></i>
            <span>Share Ride</span>
        </div>
        <div class="dropdown-item" data-option="broadcast">
            <i class="fas fa-broadcast-tower"></i>
            <span>Broadcast Ride</span>
        </div>
    </div>
    
    <!-- Main Panel -->
    <div class="main-panel" id="mainPanel">
        <div class="panel-handle" id="panelHandle"></div>
        
        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" data-screen="home">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </button>
            <button class="nav-tab" data-screen="history">
                <i class="fas fa-history"></i>
                <span>History</span>
            </button>
            <button class="nav-tab" data-screen="account">
                <i class="fas fa-user"></i>
                <span>Account</span>
            </button>
            <button class="nav-tab" data-screen="emergency">
                <i class="fas fa-ambulance"></i>
                <span>Emergency</span>
            </button>
        </div>
        
        <!-- Home Screen Content -->
        <div id="homeContent">
            <!-- Service Tabs -->
            <div class="service-tabs" id="serviceTabs">
                <div class="service-tab car active" data-service="car">
                    <div class="service-icon">
                        <i class="fas fa-car"></i>
                    </div>
                    <div class="service-name">Car</div>
                    <div class="service-desc">Ride anywhere</div>
                </div>
                
                <div class="service-tab delivery" data-service="delivery">
                    <div class="service-icon">
                        <i class="fas fa-shipping-fast"></i>
                    </div>
                    <div class="service-name">Delivery</div>
                    <div class="service-desc">Send packages</div>
                </div>
                
                <div class="service-tab short-delivery" data-service="short-delivery">
                    <div class="service-icon">
                        <i class="fas fa-bicycle"></i>
                    </div>
                    <div class="service-name">Short Delivery</div>
                    <div class="service-desc">Quick deliveries</div>
                </div>
                
                <div class="service-tab" data-service="express">
                    <div class="service-icon">
                        <i class="fas fa-shopping-bag"></i>
                    </div>
                    <div class="service-name">Express Shopping</div>
                    <div class="service-desc">Shop for you</div>
                </div>
                
                <div class="service-tab" data-service="truck">
                    <div class="service-icon">
                        <i class="fas fa-truck"></i>
                    </div>
                    <div class="service-name">Truck</div>
                    <div class="service-desc">Move items</div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="quick-actions">
                <button class="quick-action-btn" id="moreOptionsBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-ellipsis-h"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">More Options</div>
                        <div class="quick-action-desc">Schedule, share, broadcast</div>
                    </div>
                </button>
                <button class="quick-action-btn" id="broadcastRideBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-broadcast-tower"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">Broadcast Ride</div>
                        <div class="quick-action-desc">Share with friends</div>
                    </div>
                </button>
                <button class="quick-action-btn" id="sosSetupBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">SOS Setup</div>
                        <div class="quick-action-desc">Emergency contacts</div>
                    </div>
                </button>
                <button class="quick-action-btn" id="recentDestinationsBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-history"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">Recent Destinations</div>
                        <div class="quick-action-desc">Quick access</div>
                    </div>
                </button>
            </div>
            
            <!-- Car Service Form (Default) -->
            <div class="ride-request-form active" id="carForm">
                <div class="form-title">
                    <i class="fas fa-car"></i>
                    Book a Ride
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="pickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="pickupLocation" placeholder="Current location" readonly>
                        <div class="search-loading" id="searchLoading"></div>
                        <div class="suggestion-list" id="pickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="destinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="destinationLocation" placeholder="Where to?" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="destinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Stops Container -->
                <div id="stopsContainer" style="margin: 10px 0;"></div>
                <button type="button" class="btn btn-secondary" id="addStopBtn" style="width: 100%; margin-bottom: 15px;">
                    <i class="fas fa-plus"></i> Add Stop
                </button>
                
                <!-- Search History -->
                <div class="search-history" id="searchHistory" style="display: none;"></div>
                
                <!-- Ride Type Selection -->
                <div class="ride-type-selection" id="rideTypeSelection">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                        <span id="rideTypeInfo" style="font-size: 11px; color: var(--text-light); cursor: pointer;">
                            <i class="fas fa-info-circle"></i>
                        </span>
                    </div>
                    
                    <!-- Ride Type Cards will be inserted here by JavaScript -->
                    <div class="ride-type-cards" id="rideTypeCardsContainer"></div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="fareDisplay">
                    <div class="fare-label">Estimated Fare</div>
                    <div class="fare-amount" id="estimatedFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="distanceDetail">0 km</span>
                        <span id="timeDetail">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Price Calculator Display -->
                <div class="price-calculator-display" id="priceCalculator" style="display: none;">
                    <div class="fare-label">Fare Breakdown</div>
                    <div class="fare-amount" id="calculatedFare">ZMW 0.00</div>
                    <div class="price-breakdown" id="priceBreakdown">
                        <!-- Breakdown will be inserted here -->
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestRideBtn">
                        <i class="fas fa-search"></i>
                        Request Ride
                    </button>
                </div>
            </div>
            
            <!-- Delivery Service Form -->
            <div class="service-form delivery-form" id="deliveryForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-shipping-fast"></i>
                    Package Delivery
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="deliveryPickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="deliveryPickup" placeholder="Pickup location" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="deliveryPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="deliveryDestinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="deliveryDestination" placeholder="Delivery address" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="deliveryDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Delivery Details -->
                <div class="form-group">
                    <label class="form-label">Parcel Description</label>
                    <input type="text" class="form-control" id="parcelDescription" placeholder="What are you sending?">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Receiver's Details</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="receiverName" placeholder="Receiver name">
                        <input type="tel" class="form-control" id="receiverPhone" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Parcel Value (ZMW)</label>
                    <input type="number" class="form-control" id="parcelValue" placeholder="Value of parcel" min="0" step="0.01">
                </div>
                
                <!-- Delivery Options -->
                <div class="form-group">
                    <label class="form-label">Delivery Type</label>
                    <div style="display: flex; gap: 10px;">
                        <button class="filter-btn active" id="standardDelivery">Standard</button>
                        <button class="filter-btn" id="expressDelivery">Express</button>
                        <button class="filter-btn" id="sameDayDelivery">Same Day</button>
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="deliveryFareDisplay" style="display: none;">
                    <div class="fare-label">Delivery Fare</div>
                    <div class="fare-amount" id="deliveryFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="deliveryDistance">0 km</span>
                        <span id="deliveryTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestDeliveryBtn">
                        <i class="fas fa-shipping-fast"></i>
                        Request Delivery
                    </button>
                </div>
            </div>
            
            <!-- Short Delivery Form -->
            <div class="service-form delivery-form" id="shortDeliveryForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-bicycle"></i>
                    Short Delivery
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="shortDeliveryPickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="shortDeliveryPickup" placeholder="Pickup location" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shortDeliveryPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="shortDeliveryDestinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="shortDeliveryDestination" placeholder="Delivery address" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shortDeliveryDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Delivery Details -->
                <div class="form-group">
                    <label class="form-label">What are you sending?</label>
                    <input type="text" class="form-control" id="shortParcelDescription" placeholder="Food, documents, small items...">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Receiver's Phone</label>
                    <input type="tel" class="form-control" id="shortReceiverPhone" placeholder="Receiver phone number">
                </div>
                
                <!-- Quick Options -->
                <div class="form-group">
                    <label class="form-label">Quick Options</label>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <span class="filter-btn">Food</span>
                        <span class="filter-btn">Documents</span>
                        <span class="filter-btn">Medication</span>
                        <span class="filter-btn">Small Package</span>
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="shortDeliveryFareDisplay" style="display: none;">
                    <div class="fare-label">Delivery Fare</div>
                    <div class="fare-amount" id="shortDeliveryFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="shortDeliveryDistance">0 km</span>
                        <span id="shortDeliveryTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestShortDeliveryBtn">
                        <i class="fas fa-bolt"></i>
                        Quick Delivery
                    </button>
                </div>
            </div>
            
            <!-- Express Shopping Form -->
            <div class="service-form express-form" id="expressForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-shopping-bag"></i>
                    Express Shopping
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="shopNameInput">
                        <i class="fas fa-store"></i>
                        <input type="text" id="shopName" placeholder="Shop/Restaurant name" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shopSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="shopLocation" placeholder="Shop location" readonly>
                    </div>
                </div>
                
                <!-- Items List -->
                <div class="form-group">
                    <label class="form-label">Shopping List</label>
                    <div class="item-list" id="shoppingItems">
                        <div class="item-entry">
                            <input type="text" class="item-input" placeholder="Item name">
                            <button class="remove-item" type="button">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <button class="add-item" type="button" id="addItemBtn">
                        <i class="fas fa-plus"></i>
                        Add Item
                    </button>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Special Instructions</label>
                    <textarea class="form-control form-textarea" id="shoppingInstructions" placeholder="Any specific requests or instructions..."></textarea>
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="shoppingDestinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="shoppingDestination" placeholder="Delivery address" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shoppingDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Budget -->
                <div class="form-group">
                    <label class="form-label">Estimated Budget (ZMW)</label>
                    <input type="number" class="form-control" id="shoppingBudget" placeholder="Estimated cost of items">
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="shoppingFareDisplay" style="display: none;">
                    <div class="fare-label">Shopping Service Fare</div>
                    <div class="fare-amount" id="shoppingFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="shoppingDistance">0 km</span>
                        <span id="shoppingTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestShoppingBtn">
                        <i class="fas fa-shopping-cart"></i>
                        Request Shopping
                    </button>
                </div>
            </div>
            
            <!-- Truck Delivery Form -->
            <div class="service-form truck-form" id="truckForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-truck"></i>
                    Truck Delivery
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="truckPickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="truckPickup" placeholder="Pickup location (Current location)" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="truckPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="truckDestinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="truckDestination" placeholder="Destination" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="truckDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Truck Type Selection -->
                <div class="form-group">
                    <label class="form-label">Select Truck Type</label>
                    <div class="truck-types">
                        <div class="truck-type" data-type="pickup">
                            <div class="truck-icon">
                                <i class="fas fa-truck-pickup"></i>
                            </div>
                            <div class="truck-name">Pickup Truck</div>
                            <div class="truck-capacity">Up to 1.5 tons</div>
                        </div>
                        
                        <div class="truck-type selected" data-type="light">
                            <div class="truck-icon">
                                <i class="fas fa-truck-moving"></i>
                            </div>
                            <div class="truck-name">Light Truck</div>
                            <div class="truck-capacity">Up to 3 tons</div>
                        </div>
                        
                        <div class="truck-type" data-type="medium">
                            <div class="truck-icon">
                                <i class="fas fa-truck"></i>
                            </div>
                            <div class="truck-name">Medium Truck</div>
                            <div class="truck-capacity">Up to 7 tons</div>
                        </div>
                        
                        <div class="truck-type" data-type="heavy">
                            <div class="truck-icon">
                                <i class="fas fa-truck-loading"></i>
                            </div>
                            <div class="truck-name">Heavy Truck</div>
                            <div class="truck-capacity">Up to 15 tons</div>
                        </div>
                    </div>
                </div>
                
                <!-- Item Details -->
                <div class="form-group">
                    <label class="form-label">What are you moving?</label>
                    <input type="text" class="form-control" id="truckItemDescription" placeholder="Furniture, boxes, equipment...">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Estimated Weight (kg)</label>
                    <input type="number" class="form-control" id="estimatedWeight" placeholder="Approximate weight">
                </div>
                
                <!-- Additional Help -->
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="needHelpers">
                        <span style="margin-left: 8px;">Need loading/unloading helpers (+ZMW 50)</span>
                    </label>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="truckFareDisplay" style="display: none;">
                    <div class="fare-label">Truck Fare</div>
                    <div class="fare-amount" id="truckFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="truckDistance">0 km</span>
                        <span id="truckTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestTruckBtn">
                        <i class="fas fa-truck"></i>
                        Request Truck
                    </button>
                </div>
            </div>
            
            <!-- Ride Info Panel -->
            <div class="ride-info-panel" id="rideInfoPanel" style="display: none;">
                <div class="driver-info">
                    <div class="driver-avatar" id="driverAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="driver-details">
                        <div class="driver-name" id="driverName">Driver Name</div>
                        <div class="driver-rating">
                            <i class="fas fa-star"></i>
                            <span id="driverRating">4.8</span>
                        </div>
                        <div class="driver-vehicle">
                            <i class="fas fa-car"></i>
                            <span id="vehicleDetails">Toyota Corolla - ABC 123</span>
                        </div>
                    </div>
                </div>
                
                <!-- Driver Media Display -->
                <div class="driver-media" id="driverMedia">
                    <div class="media-container">
                        <div class="media-placeholder" id="driverImagePlaceholder">
                            <i class="fas fa-user"></i>
                            <span>Driver Image</span>
                        </div>
                        <img id="driverImage" style="display: none;">
                    </div>
                    <div class="media-container">
                        <div class="media-placeholder" id="vehicleImagePlaceholder">
                            <i class="fas fa-car"></i>
                            <span>Vehicle Image</span>
                        </div>
                        <img id="vehicleImage" style="display: none;">
                    </div>
                </div>
                
                <!-- Tracking Info -->
                <div class="tracking-info" id="trackingInfo">
                    <div class="tracking-header">
                        <div class="tracking-title">Driver Distance</div>
                        <div class="tracking-distance" id="driverDistance">0 km</div>
                    </div>
                    <div class="tracking-progress">
                        <div class="tracking-progress-bar" id="trackingProgress" style="width: 0%"></div>
                    </div>
                    <div class="tracking-details">
                        <span id="pickupDistance">0 km to pickup</span>
                        <span id="etaToPickup">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Timeline -->
                <div class="timeline" id="rideTimeline">
                    <div class="timeline-step">
                        <div class="step-dot active" id="stepRequested">
                            <i class="fas fa-search"></i>
                        </div>
                        <div class="step-label active">Requested</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepAccepted">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <div class="step-label">Accepted</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepArrived">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="step-label">Arrived</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepStarted">
                            <i class="fas fa-play"></i>
                        </div>
                        <div class="step-label">Started</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepCompleted">
                            <i class="fas fa-flag-checkered"></i>
                        </div>
                        <div class="step-label">Completed</div>
                    </div>
                </div>
                
                <!-- Ride Stops -->
                <div class="ride-stops" id="rideStopsContainer" style="display: none; margin-top: 15px;">
                    <div class="section-title" style="font-size: 14px; color: var(--text-gray); margin-bottom: 10px;">
                        <i class="fas fa-map-pin"></i> Stops
                    </div>
                    <div id="rideStopsList"></div>
                </div>
                
                <div class="trip-details">
                    <div class="trip-locations">
                        <div class="location-point">
                            <div class="location-marker pickup">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="location-text">
                                <div class="location-label">Pickup</div>
                                <div class="location-address" id="currentPickup">Loading...</div>
                            </div>
                        </div>
                        
                        <div class="location-point">
                            <div class="location-marker destination">
                                <i class="fas fa-flag"></i>
                            </div>
                            <div class="location-text">
                                <div class="location-label">Destination</div>
                                <div class="location-address" id="currentDestination">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Location Details -->
                <div class="location-details">
                    <div class="location-detail-item">
                        <div class="location-detail-icon">
                            <i class="fas fa-road"></i>
                        </div>
                        <div class="location-detail-content">
                            <div class="location-detail-label">Distance</div>
                            <div class="location-detail-value" id="rideDistance">0 km</div>
                        </div>
                    </div>
                    <div class="location-detail-item">
                        <div class="location-detail-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="location-detail-content">
                            <div class="location-detail-label">Estimated Time</div>
                            <div class="location-detail-value" id="rideTime">0 min</div>
                        </div>
                    </div>
                </div>
                
                <div class="fare-breakdown">
                    <div class="fare-row">
                        <span class="fare-label">Base Fare</span>
                        <span class="fare-value" id="baseFareValue">ZMW 15.00</span>
                    </div>
                    <div class="fare-row">
                        <span class="fare-label">Distance</span>
                        <span class="fare-value" id="distanceFareValue">ZMW 5.00</span>
                    </div>
                    <div class="fare-row">
                        <span class="fare-label">Ride Type</span>
                        <span class="fare-value" id="rideTypeValue">Standard</span>
                    </div>
                    <div class="fare-row total">
                        <span class="fare-label">Total Fare</span>
                        <span class="fare-value" id="totalFareValue">ZMW 20.00</span>
                    </div>
                </div>
                
                <!-- Emergency Contact Display -->
                <div class="emergency-contact-display" id="emergencyContactDisplay" style="display: none;">
                    <div class="emergency-contact-header">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div class="emergency-contact-title">Emergency Contacts</div>
                    </div>
                    <div class="emergency-contact-item">
                        <div class="contact-info">
                            <div class="contact-name" id="emergencyContact1Name">Contact 1</div>
                            <div class="contact-phone" id="emergencyContact1Phone">000-000-0000</div>
                        </div>
                        <button class="contact-action-btn" id="emergencyContact1Btn">
                            <i class="fas fa-phone"></i>
                        </button>
                    </div>
                    <div class="emergency-contact-item">
                        <div class="contact-info">
                            <div class="contact-name" id="emergencyContact2Name">Contact 2</div>
                            <div class="contact-phone" id="emergencyContact2Phone">000-000-0000</div>
                        </div>
                        <button class="contact-action-btn" id="emergencyContact2Btn">
                            <i class="fas fa-phone"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Broadcast Feature -->
                <div class="broadcast-feature" id="broadcastFeature" style="display: none;">
                    <div class="broadcast-feature-header">
                        <div class="broadcast-feature-title">
                            <i class="fas fa-broadcast-tower"></i>
                            <span>Broadcast Ride</span>
                        </div>
                        <div class="broadcast-status-indicator inactive" id="broadcastStatusIndicator"></div>
                    </div>
                    <div class="broadcast-form">
                        <div class="broadcast-input-group">
                            <input type="text" id="broadcastMemberInput" placeholder="Enter friend's referral code">
                            <button class="broadcast-btn" id="addBroadcastMemberBtn">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div class="broadcast-recipients" id="broadcastMembersContainer">
                            <!-- Recipients will be inserted here -->
                        </div>
                        <button class="btn btn-secondary" id="startBroadcastBtn">
                            <i class="fas fa-play"></i>
                            Start Broadcasting
                        </button>
                    </div>
                </div>

                <!-- Share Ride Status -->
                <div class="share-ride-status" id="shareRideStatus" style="display: none;"></div>
                
                <div class="action-buttons">
                    <button class="btn btn-danger" id="cancelRideBtn">
                        <i class="fas fa-times-circle"></i>
                        Cancel Ride
                    </button>
                    <button class="btn btn-secondary" id="contactDriverBtn">
                        <i class="fas fa-phone"></i>
                        Call Driver
                    </button>
                    <button class="btn btn-secondary" id="openChatBtn">
                        <i class="fas fa-comment"></i>
                        Chat
                    </button>
                </div>
            </div>
            
            <!-- Broadcast Ride Form -->
            <div class="service-form" id="broadcastForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-broadcast-tower"></i>
                    Broadcast Ride
                </div>
                
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="broadcastPickup" placeholder="Pickup location" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="broadcastPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="broadcastDestination" placeholder="Destination" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="broadcastDestinationSuggestions"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Passenger Phone Numbers (comma separated)</label>
                    <textarea class="form-control form-textarea" id="broadcastPassengers" placeholder="Enter phone numbers of passengers to share this ride with..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Ride Type</label>
                    <select class="form-control" id="broadcastRideType">
                        <option value="standard">Standard</option>
                        <option value="economy">Economy</option>
                        <option value="premium">Premium</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Split Fare</label>
                    <select class="form-control" id="broadcastSplitType">
                        <option value="equal">Equal Split</option>
                        <option value="you_pay_more">You Pay 70%</option>
                        <option value="you_pay_all">You Pay All</option>
                    </select>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="broadcastFareDisplay" style="display: none;">
                    <div class="fare-label">Broadcast Fare</div>
                    <div class="fare-amount" id="broadcastFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="broadcastDistance">0 km</span>
                        <span id="broadcastTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="startBroadcastRideBtn">
                        <i class="fas fa-broadcast-tower"></i>
                        Start Broadcast
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- History Screen -->
    <div class="history-screen" id="historyScreen" style="display: none;">
        <div class="screen-header">
            <button class="back-btn" data-screen="home">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="screen-title">Ride History</div>
        </div>
        
        <div class="history-filters">
            <button class="filter-btn active" data-filter="all">All</button>
            <button class="filter-btn" data-filter="completed">Completed</button>
            <button class="filter-btn" data-filter="cancelled">Cancelled</button>
            <button class="filter-btn" data-filter="scheduled">Scheduled</button>
            <button class="filter-btn" data-filter="emergency">Emergency</button>
            <button class="filter-btn" data-filter="delivery">Delivery</button>
            <button class="filter-btn" data-filter="truck">Truck</button>
            <button class="filter-btn" data-filter="broadcast">Broadcast</button>
        </div>
        
        <div class="history-list" id="historyList">
            <!-- History items will be inserted here -->
        </div>
    </div>
    
    <!-- Account Screen -->
    <div class="account-screen" id="accountScreen" style="display: none;">
        <div class="screen-header">
            <button class="back-btn" data-screen="home">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="screen-title">My Account</div>
        </div>
        
        <div class="account-header">
            <div class="account-avatar" id="accountAvatar">
                <i class="fas fa-user"></i>
            </div>
            <div class="account-name" id="accountName">Loading...</div>
            <div class="account-phone" id="accountPhone">Loading...</div>
        </div>
        
        <div class="account-stats">
            <div class="stat-card">
                <div class="stat-value" id="completedRides">0</div>
                <div class="stat-label">Completed Rides</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="cancelledRides">0</div>
                <div class="stat-label">Cancelled Rides</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalSpent">ZMW 0</div>
                <div class="stat-label">Total Spent</div>
            </div>
        </div>
        
        <div class="account-section">
            <div class="section-title">
                <i class="fas fa-wallet"></i>
                Wallet Balance
            </div>
            
            <div class="wallet-balance">
                <div class="balance-label">Available Balance</div>
                <div class="balance-amount-large" id="accountBalance">ZMW 0.00</div>
            </div>
            
            <div class="wallet-actions">
                <button class="btn-wallet" id="depositBtn">
                    <i class="fas fa-plus"></i>
                    Deposit
                </button>
                <button class="btn-wallet" id="withdrawBtn">
                    <i class="fas fa-minus"></i>
                    Withdraw
                </button>
                <button class="btn-wallet" id="transferBtn">
                    <i class="fas fa-exchange-alt"></i>
                    Transfer
                </button>
                <button class="btn-wallet" id="transactionsBtn">
                    <i class="fas fa-history"></i>
                    History
                </button>
            </div>
        </div>
        
        <div class="account-section">
            <div class="section-title">
                <i class="fas fa-gift"></i>
                Referral Program
            </div>
            
            <div class="referral-card">
                <div>Share your referral code and earn ZMW 25 for each friend's first ride</div>
                <div class="referral-code" id="referralCode">JUBEL-XXXX</div>
                <button class="btn btn-primary" id="shareReferralBtn">
                    <i class="fas fa-share"></i>
                    Share Code
                </button>
                <div class="referral-note">Your friend gets 50% off their first ride</div>
            </div>
        </div>
        
        <div class="account-section">
            <div class="section-title">
                <i class="fas fa-cog"></i>
                Settings
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-secondary" id="updateProfileBtn">
                    <i class="fas fa-user-edit"></i>
                    Update Profile
                </button>
                <button class="btn btn-secondary" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </button>
            </div>
        </div>
    </div>
    
    <!-- Emergency Screen -->
    <div class="emergency-screen" id="emergencyScreen" style="display: none;">
        <div class="screen-header">
            <button class="back-btn" data-screen="home">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="screen-title">Emergency Services</div>
        </div>
        
        <div class="emergency-services">
            <div class="emergency-service police" data-type="police">
                <div class="emergency-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <div class="emergency-name">Police Ride</div>
                <div class="emergency-description">Emergency transport with police escort</div>
            </div>
            
            <div class="emergency-service fire" data-type="fire">
                <div class="emergency-icon">
                    <i class="fas fa-fire-extinguisher"></i>
                </div>
                <div class="emergency-name">Fire Brigade</div>
                <div class="emergency-description">Fire emergency response team</div>
            </div>
            
            <div class="emergency-service medical" data-type="medical">
                <div class="emergency-icon">
                    <i class="fas fa-ambulance"></i>
                </div>
                <div class="emergency-name">Hospital Ride</div>
                <div class="emergency-description">Medical emergency transport</div>
            </div>
            
            <div class="emergency-service" data-type="sos">
                <div class="emergency-icon" style="background: var(--error-red);">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="emergency-name">SOS Emergency</div>
                <div class="emergency-description">Immediate emergency assistance</div>
            </div>
        </div>
        
        <div class="emergency-note">
            <p><strong>Important:</strong> Only use emergency services for genuine emergencies. Misuse may result in penalties. In case of immediate danger, call 911 first.</p>
        </div>
    </div>
    
    <!-- Modals -->
    
    <!-- Payment Modal -->
    <div class="modal-overlay" id="paymentModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-credit-card"></i>
                    Select Payment Method
                </div>
                <button class="modal-close" data-modal="payment">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <div class="form-label">Available Balance: <span id="paymentBalance">ZMW 0.00</span></div>
                    <div class="form-label">Total Amount: <span id="paymentAmount">ZMW 0.00</span></div>
                </div>
                
                <!-- Referral Discount Section -->
                <div class="referral-discount-section" id="referralDiscountSection" style="display: none;">
                    <div class="section-header">
                        <i class="fas fa-gift"></i>
                        <span>Referral Discount (50% off)</span>
                    </div>
                    <div class="referral-input-group">
                        <input type="text" id="referralCodeInput" placeholder="Enter referral code">
                        <button id="applyReferralBtn" class="btn btn-orange">
                            <i class="fas fa-check"></i> Apply
                        </button>
                    </div>
                    <div id="referrerInfo" style="display: none; font-size: 12px; color: var(--success-green); margin-top: 5px;"></div>
                    <div class="discount-breakdown" style="margin-top: 10px;">
                        <div class="price-row">
                            <span>Original Fare:</span>
                            <span id="originalFareAmount">ZMW 0.00</span>
                        </div>
                        <div class="price-row">
                            <span>Discount:</span>
                            <span id="discountAmount" style="color: var(--success-green);">-ZMW 0.00</span>
                        </div>
                        <div class="price-row total">
                            <span>Final Fare:</span>
                            <span id="finalFareAmount" style="font-weight: bold;">ZMW 0.00</span>
                        </div>
                    </div>
                </div>
                
                <div class="payment-methods">
                    <div class="payment-method" data-payment="wallet">
                        <div class="payment-icon">
                            <i class="fas fa-wallet"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Jubel Wallet</div>
                            <div class="payment-info">Pay with your wallet balance</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-payment="mobile">
                        <div class="payment-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Mobile Money</div>
                            <div class="payment-info">Pay via MTN/Zamtel/Airtel</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-payment="cash">
                        <div class="payment-icon">
                            <i class="fas fa-money-bill"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Cash</div>
                            <div class="payment-info">Pay driver directly</div>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmPaymentBtn">
                        <i class="fas fa-check"></i>
                        Confirm Payment
                    </button>
                    <button class="btn btn-secondary" data-modal="payment">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Cancel Ride Modal -->
    <div class="modal-overlay" id="cancelModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-times-circle"></i>
                    Cancel Ride
                </div>
                <button class="modal-close" data-modal="cancel">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <div class="form-label">Please select a reason for cancellation:</div>
                </div>
                
                <div class="cancel-reasons">
                    <div class="cancel-reason" data-reason="driver_late">
                        <div class="reason-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="reason-text">Driver is taking too long</div>
                    </div>
                    
                    <div class="cancel-reason" data-reason="change_plans">
                        <div class="reason-icon">
                            <i class="fas fa-calendar-times"></i>
                        </div>
                        <div class="reason-text">Change of plans</div>
                    </div>
                    
                    <div class="cancel-reason" data-reason="found_alternative">
                        <div class="reason-icon">
                            <i class="fas fa-car"></i>
                        </div>
                        <div class="reason-text">Found alternative transport</div>
                    </div>
                    
                    <div class="cancel-reason" data-reason="emergency">
                        <div class="reason-icon">
                            <i class="fas fa-exclamation"></i>
                        </div>
                        <div class="reason-text">Emergency situation</div>
                    </div>
                    
                    <div class="cancel-reason" data-reason="other">
                        <div class="reason-icon">
                            <i class="fas fa-ellipsis-h"></i>
                        </div>
                        <div class="reason-text">Other reason</div>
                    </div>
                </div>
                
                <div class="form-group" id="otherReasonGroup" style="display: none;">
                    <label class="form-label">Please specify:</label>
                    <textarea class="form-control form-textarea" id="otherReason" placeholder="Enter your reason here..."></textarea>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-danger" id="confirmCancelBtn">
                        <i class="fas fa-times"></i>
                        Cancel Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="cancel">
                        Go Back
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Emergency Ride Modal -->
    <div class="modal-overlay" id="emergencyModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-ambulance"></i>
                    Emergency Ride Details
                </div>
                <button class="modal-close" data-modal="emergency">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content emergency-modal-content">
                <div class="form-group">
                    <div class="form-label" id="emergencyServiceType">Police Ride</div>
                </div>
                
                <!-- Emergency Reasons -->
                <div class="form-group">
                    <label class="form-label">Select Emergency Reason</label>
                    <div class="emergency-reasons">
                        <div class="emergency-reason" data-reason="accident">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-car-crash"></i>
                            </div>
                            <div class="emergency-reason-text">Accident</div>
                        </div>
                        
                        <div class="emergency-reason" data-reason="medical">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-heartbeat"></i>
                            </div>
                            <div class="emergency-reason-text">Medical Emergency</div>
                        </div>
                        
                        <div class="emergency-reason" data-reason="crime">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="emergency-reason-text">Crime/Assault</div>
                        </div>
                        
                        <div class="emergency-reason" data-reason="fire">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-fire"></i>
                            </div>
                            <div class="emergency-reason-text">Fire Emergency</div>
                        </div>
                        
                        <div class="emergency-reason" data-reason="other">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="emergency-reason-text">Other Emergency</div>
                        </div>
                    </div>
                    
                    <div class="emergency-reason-input" id="emergencyReasonOther" style="display: none;">
                        <label class="form-label">Please describe the emergency:</label>
                        <textarea class="form-control form-textarea" id="emergencyOtherReason" placeholder="Describe the emergency situation..."></textarea>
                    </div>
                </div>
                
                <!-- Location Inputs -->
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="emergencyPickup" placeholder="Pickup location" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="emergencyPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="emergencyDestination" placeholder="Destination" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="emergencyDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Emergency Stations -->
                <div class="form-group">
                    <label class="form-label">Select Nearest Emergency Station</label>
                    <div class="emergency-stations" id="emergencyStations">
                        <!-- Stations will be inserted here -->
                    </div>
                </div>
                
                <!-- User Location Details -->
                <div class="location-details">
                    <div class="location-detail-item">
                        <div class="location-detail-icon">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="location-detail-content">
                            <div class="location-detail-label">Your Location</div>
                            <div class="location-detail-value" id="emergencyUserLocation">Detecting location...</div>
                        </div>
                    </div>
                </div>
                
                <!-- Price Calculation -->
                <div class="price-calculation">
                    <div class="calculation-row">
                        <span>Base Emergency Fare:</span>
                        <span id="emergencyBaseFare">ZMW 100.00</span>
                    </div>
                    <div class="calculation-row">
                        <span>Distance to Service:</span>
                        <span id="emergencyDistance">0 km</span>
                    </div>
                    <div class="calculation-row">
                        <span>Estimated Time:</span>
                        <span id="emergencyTime">5 min</span>
                    </div>
                    <div class="calculation-row total">
                        <span>Total Fare:</span>
                        <span id="emergencyTotalFare">ZMW 100.00</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-danger" id="confirmEmergencyBtn">
                        <i class="fas fa-exclamation-triangle"></i>
                        Request Emergency Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="emergency">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- SOS Setup Modal -->
    <div class="modal-overlay" id="sosModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    SOS Emergency Setup
                </div>
                <button class="modal-close" data-modal="sos">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <label class="form-label">Primary Emergency Contact</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="sosContact1Name" placeholder="Contact name">
                        <input type="tel" class="form-control" id="sosContact1Phone" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Secondary Emergency Contact (Optional)</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="sosContact2Name" placeholder="Contact name">
                        <input type="tel" class="form-control" id="sosContact2Phone" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Emergency Message</label>
                    <textarea class="form-control form-textarea" id="sosMessage">
I need help! My current location and ride details will be shared with you.
                    </textarea>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="saveSOSBtn">
                        <i class="fas fa-save"></i>
                        Save SOS Setup
                    </button>
                    <button class="btn btn-secondary" data-modal="sos">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Transfer Money Modal -->
    <div class="modal-overlay" id="transferModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-exchange-alt"></i>
                    Transfer Money
                </div>
                <button class="modal-close" data-modal="transfer">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <div class="form-label">Available Balance: <span id="transferBalance">ZMW 0.00</span></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Recipient's Referral Code</label>
                    <input type="text" class="form-control" id="recipientCode" placeholder="Enter recipient's Jubel referral code">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Amount (ZMW)</label>
                    <input type="number" class="form-control" id="transferAmount" placeholder="Enter amount" min="1" step="0.01">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Message (Optional)</label>
                    <input type="text" class="form-control" id="transferMessage" placeholder="Add a message">
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmTransferBtn">
                        <i class="fas fa-paper-plane"></i>
                        Send Money
                    </button>
                    <button class="btn btn-secondary" data-modal="transfer">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Wallet Transactions Modal -->
    <div class="modal-overlay" id="transactionsModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-history"></i>
                    Wallet Transactions
                </div>
                <button class="modal-close" data-modal="transactions">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div id="transactionsList">
                    <!-- Transactions will be inserted here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Schedule Ride Modal -->
    <div class="modal-overlay" id="scheduleModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-calendar-alt"></i>
                    Schedule a Ride
                </div>
                <button class="modal-close" data-modal="schedule">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="schedulePickup" placeholder="Pickup location">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="schedulePickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="scheduleDestination" placeholder="Destination">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="scheduleDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- For Someone Else -->
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="scheduleForSomeone">
                        <span style="margin-left: 8px;">Booking for someone else</span>
                    </label>
                </div>
                
                <div class="form-group" id="someoneElseDetails" style="display: none;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="recipientName" placeholder="Recipient name">
                        <input type="tel" class="form-control" id="recipientPhone" placeholder="Recipient phone">
                    </div>
                </div>
                
                <div class="schedule-grid">
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-control" id="scheduleDate" min="">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Time</label>
                        <input type="time" class="form-control" id="scheduleTime">
                    </div>
                </div>
                
                <!-- Ride Type Selection for Schedule -->
                <div class="ride-type-selection" style="margin: 0 0 16px 0;">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                    </div>
                    <div class="ride-type-grid" id="scheduleRideTypeGrid">
                        <div class="ride-type-card economy" data-type="economy">
                            <div class="ride-type-icon">
                                <i class="fas fa-car-side"></i>
                            </div>
                            <div class="ride-type-name">Economy</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card selected" data-type="standard">
                            <div class="ride-type-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="ride-type-name">Standard</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card premium" data-type="premium">
                            <div class="ride-type-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="ride-type-name">Premium</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="scheduleFareDisplay" style="display: none;">
                    <div class="fare-label">Scheduled Ride Fare</div>
                    <div class="fare-amount" id="scheduleFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="scheduleDistance">0 km</span>
                        <span id="scheduleTimeEstimate">ETA: 0 min</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmScheduleBtn">
                        <i class="fas fa-calendar-check"></i>
                        Schedule Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="schedule">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Order for Someone Modal -->
    <div class="modal-overlay" id="orderForSomeoneModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-user-friends"></i>
                    Order for Someone Else
                </div>
                <button class="modal-close" data-modal="orderForSomeone">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="someonePickup" placeholder="Pickup location">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="someonePickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="someoneDestination" placeholder="Destination">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="someoneDestinationSuggestions"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Recipient Details</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="someoneName" placeholder="Full name">
                        <input type="tel" class="form-control" id="someonePhone" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Special Instructions (Optional)</label>
                    <textarea class="form-control form-textarea" id="someoneInstructions" placeholder="Any instructions for the driver..."></textarea>
                </div>
                
                <!-- Ride Type Selection -->
                <div class="ride-type-selection" style="margin: 0 0 16px 0;">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                    </div>
                    <div class="ride-type-grid" id="someoneRideTypeGrid">
                        <div class="ride-type-card economy" data-type="economy">
                            <div class="ride-type-icon">
                                <i class="fas fa-car-side"></i>
                            </div>
                            <div class="ride-type-name">Economy</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card selected" data-type="standard">
                            <div class="ride-type-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="ride-type-name">Standard</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card premium" data-type="premium">
                            <div class="ride-type-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="ride-type-name">Premium</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="someoneFareDisplay" style="display: none;">
                    <div class="fare-label">Estimated Fare</div>
                    <div class="fare-amount" id="someoneFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="someoneDistance">0 km</span>
                        <span id="someoneTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmSomeoneRideBtn">
                        <i class="fas fa-car"></i>
                        Request Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="orderForSomeone">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Share Ride Modal -->
    <div class="modal-overlay" id="shareRideModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-share-alt"></i>
                    Share Ride
                </div>
                <button class="modal-close" data-modal="shareRide">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="sharePickup" placeholder="Pickup location">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="sharePickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="shareDestination" placeholder="Destination">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shareDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Share Members Input -->
                <div class="form-group">
                    <label class="form-label">Add Friends by Referral Code</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" class="form-control" id="shareMemberInput" placeholder="Enter friend's referral code">
                        <button class="btn btn-secondary" id="addShareMemberBtn">
                            <i class="fas fa-plus"></i> Add
                        </button>
                    </div>
                </div>
                
                <!-- Share Members List -->
                <div class="form-group">
                    <div id="shareFriendsList" class="share-friends-list">
                        <!-- Share members will be inserted here -->
                    </div>
                </div>
                
                <!-- Share Calculations -->
                <div class="form-group" id="shareCalculations" style="display: none;">
                    <!-- Calculations will be inserted here -->
                </div>
                
                <!-- Ride Type Selection -->
                <div class="ride-type-selection" style="margin: 0 0 16px 0;">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                    </div>
                    <div class="ride-type-grid" id="shareRideTypeGrid">
                        <div class="ride-type-card economy" data-type="economy">
                            <div class="ride-type-icon">
                                <i class="fas fa-car-side"></i>
                            </div>
                            <div class="ride-type-name">Economy</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card selected" data-type="standard">
                            <div class="ride-type-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="ride-type-name">Standard</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card premium" data-type="premium">
                            <div class="ride-type-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="ride-type-name">Premium</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Estimated Fare: <span id="shareFareEstimate">ZMW 0.00</span></label>
                    <div class="price-calculation">
                        <div class="calculation-row">
                            <span>Your Share:</span>
                            <span id="yourShare">ZMW 0.00</span>
                        </div>
                        <div class="calculation-row">
                            <span>Friend's Share:</span>
                            <span id="friendShare">ZMW 0.00</span>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmShareRideBtn">
                        <i class="fas fa-user-friends"></i>
                        Share Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="shareRide">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Share Ride Invitation Modal -->
    <div class="modal-overlay" id="shareRideInvitationModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-users"></i>
                    Share Ride Invitation
                </div>
                <button class="modal-close" data-modal="shareRideInvitation">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="invitation-details" id="invitationDetails">
                    <!-- Invitation details will be inserted here -->
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" id="acceptShareInvitationBtn">
                        <i class="fas fa-check"></i>
                        Accept Invitation
                    </button>
                    <button class="btn btn-secondary" id="rejectShareInvitationBtn">
                        <i class="fas fa-times"></i>
                        Decline
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Update Profile Modal -->
    <div class="modal-overlay" id="updateProfileModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-user-edit"></i>
                    Update Profile
                </div>
                <button class="modal-close" data-modal="updateProfile">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <input type="text" class="form-control" id="updateName" placeholder="Your full name">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Phone Number</label>
                    <input type="tel" class="form-control" id="updatePhone" placeholder="Your phone number">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" class="form-control" id="updateEmail" placeholder="Your email address" readonly>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Home Address (Optional)</label>
                    <input type="text" class="form-control" id="updateHomeAddress" placeholder="Your home address">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Work Address (Optional)</label>
                    <input type="text" class="form-control" id="updateWorkAddress" placeholder="Your work address">
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="saveProfileBtn">
                        <i class="fas fa-save"></i>
                        Save Changes
                    </button>
                    <button class="btn btn-secondary" data-modal="updateProfile">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Loading...</div>
    </div>
    
    <!-- Search Loading Overlay -->
    <div id="searchLoading" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); z-index: 10000;">
        <i class="fas fa-spinner fa-spin"></i> Searching...
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Real-time Indicator -->
    <div class="real-time-indicator" id="realTimeIndicator">
        <i class="fas fa-sync-alt"></i>
        <span>Real-time updates active</span>
    </div>
    
    <!-- Sync Indicator -->
    <div class="sync-indicator" id="syncIndicator">
        <i class="fas fa-sync-alt sync-icon"></i>
        <span>Syncing...</span>
    </div>
    
    <!-- Schedule Countdown -->
    <div id="scheduleCountdown" style="display: none;"></div>
    
    <!-- External JavaScript Libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>             
    <script>
// ============================================
// FIREBASE CONFIGURATION AND INITIALIZATION
// ============================================
const firebaseConfig = {
    apiKey: "AIzaSyDEACX_P4c5q7djJAcA0I7Lk7leO2TlQ74",
    authDomain: "jubel-13e1a.firebaseapp.com",
    databaseURL: "https://jubel-13e1a-default-rtdb.firebaseio.com",
    projectId: "jubel-13e1a",
    storageBucket: "jubel-13e1a.firebasestorage.app",
    messagingSenderId: "882241095445",
    appId: "1:882241095445:web:ee9ca40fddd008ca910b1c",
    measurementId: "G-J5JPKL6B5F"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const auth = firebase.auth();
const storage = firebase.storage();

// ============================================
// GLOBAL STATE MANAGEMENT
// ============================================
const AppState = {
    // User state
    currentUser: null,
    userData: null,
    walletBalance: 0,
    userLocation: null,
    currentCity: null,
    detectedCity: null,
    
    // Ride state
    currentRide: null,
    activeScreen: 'home',
    activeService: 'car',
    selectedRideType: 'standard',
    selectedVehicle: null,
    pickup: null,
    destination: null,
    rideFare: 0,
    
    // Stops management
    stops: [],
    maxStops: 3,
    
    // Real-time tracking
    driverLocation: null,
    chatMessages: [],
    notifications: [],
    unreadNotifications: 0,
    
    // Advanced features
    scheduledRides: [],
    emergencyMode: false,
    sosConfig: null,
    searchCache: new Map(),
    searchHistory: [],
    
    // Split ride management
    splitRideFriends: [],
    maxSplitFriends: 3,
    splitRideInvitations: new Map(),
    splitRideStatus: new Map(),
    
    // Broadcast management
    broadcastRecipients: [],
    broadcastInvitations: new Map(),
    
    // Shopping categories
    shoppingCategories: {
        restaurant: { icon: 'fa-utensils', name: 'Restaurants', types: ['pizza', 'nandos', 'hungry lion'] },
        pharmacy: { icon: 'fa-pills', name: 'Pharmacies' },
        supermarket: { icon: 'fa-shopping-cart', name: 'Supermarkets' },
        mall: { icon: 'fa-store', name: 'Shopping Malls' }
    },
    
    // Emergency stations cache
    emergencyStations: {
        police: [],
        fire: [],
        medical: []
    },
    
    // Referral system
    referralDiscountApplied: false,
    referralCodeUsed: null,
    referralOwnerName: null,
    
    // Ride pricing configuration
    rideTypes: {
        economy: { 
            base: 15, 
            perKm: 2.5, 
            multiplier: 0.8, 
            min: 10, 
            icon: 'fa-car-side',
            name: 'Economy'
        },
        standard: { 
            base: 20, 
            perKm: 3.0, 
            multiplier: 1.0, 
            min: 15, 
            icon: 'fa-car',
            name: 'Standard'
        },
        premium: { 
            base: 30, 
            perKm: 4.0, 
            multiplier: 1.5, 
            min: 25, 
            icon: 'fa-crown',
            name: 'Premium'
        }
    },
    
    // Emergency pricing
    emergencyServices: {
        police: { base: 150, perKm: 5.0, multiplier: 2.0, min: 100 },
        fire: { base: 200, perKm: 6.0, multiplier: 2.5, min: 150 },
        medical: { base: 180, perKm: 5.5, multiplier: 2.2, min: 120 }
    },
    
    // Delivery pricing
    deliveryTypes: {
        standard: { base: 25, perKm: 2.0, multiplier: 1.0 },
        express: { base: 40, perKm: 3.0, multiplier: 1.5 },
        sameDay: { base: 60, perKm: 4.0, multiplier: 2.0 }
    },
    
    // Truck pricing
    truckTypes: {
        pickup: { base: 80, perKm: 5.0, multiplier: 1.0, capacity: '1.5 tons' },
        light: { base: 120, perKm: 6.0, multiplier: 1.2, capacity: '3 tons' },
        medium: { base: 200, perKm: 8.0, multiplier: 1.5, capacity: '7 tons' },
        heavy: { base: 350, perKm: 12.0, multiplier: 2.0, capacity: '15 tons' }
    },
    
    // Shopping pricing
    shoppingMultiplier: 1.2,
    
    // Active listeners for real-time updates
    realtimeListeners: [],
    
    // Sync state
    isSyncing: false,
    syncInterval: null,
    
    // Chat state
    typingTimeout: null,
    driverTyping: false,
    
    // Location management
    locationManagement: {
        isEditingPickup: false,
        currentPickupInputId: null,
        pickupSearchResults: [],
        cityBounds: null
    },
    
    // Scheduled ride timer
    activeScheduledTimer: null,
    
    // Pulsing icons for ride requests
    pulsingIcon: null,
    
    // Split ride calculations
    rideSplitDetails: null,
    
    // Active route
    activeRoute: null,
    
    // Active filter for history
    activeFilter: 'all',
    
    // UI state
    chatOpen: false,
    notificationsOpen: false,
    mapInitialized: false,
    cityDetectionAttempts: 0,
    maxCityDetectionAttempts: 5
};

// ============================================
// CITY DETECTOR MODULE
// ============================================
const CityDetector = {
    async detectCityFromLocation(latitude, longitude) {
        try {
            const response = await fetch(
                `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`
            );
            
            if (!response.ok) throw new Error('Reverse geocoding failed');
            
            const data = await response.json();
            const address = data.address;
            
            // Get city from various possible fields
            let city = address.city || address.town || address.village || 
                       address.municipality || address.county || address.state;
            
            // Filter for Zambian cities only
            if (address.country === 'Zambia') {
                const zambianCities = [
                    'Lusaka', 'Ndola', 'Kitwe', 'Kabwe', 'Livingstone', 'Chipata',
                    'Chingola', 'Mufulira', 'Luanshya', 'Kasama', 'Solwezi', 'Mazabuka'
                ];
                
                // Check if detected city is a known Zambian city
                if (city && zambianCities.some(zCity => 
                    city.toLowerCase().includes(zCity.toLowerCase()))) {
                    return city.split(',')[0].trim(); // Return first part if comma separated
                }
                
                // If city not found in list but we're in Zambia, try state
                if (address.state && zambianCities.some(zCity => 
                    address.state.toLowerCase().includes(zCity.toLowerCase()))) {
                    return address.state.split(',')[0].trim();
                }
            }
            
            return null; // No city detected
        } catch (error) {
            console.error('City detection error:', error);
            return null;
        }
    },
    
    async getDetailedAddress(latitude, longitude) {
        try {
            const response = await fetch(
                `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&addressdetails=1`
            );
            
            if (!response.ok) throw new Error('Address lookup failed');
            
            const data = await response.json();
            const address = data.address;
            
            return {
                address: `${address.road || ''} ${address.house_number || ''}, ${address.suburb || ''}`.trim(),
                fullDisplay: data.display_name,
                city: address.city || address.town,
                road: address.road,
                suburb: address.suburb
            };
        } catch (error) {
            console.error('Address lookup error:', error);
            return {
                address: `Near ${latitude.toFixed(4)}, ${longitude.toFixed(4)}`,
                fullDisplay: `Latitude: ${latitude.toFixed(4)}, Longitude: ${longitude.toFixed(4)}`,
                city: null
            };
        }
    },
    
    validateCity(cityName) {
        const zambianCities = [
            'Lusaka', 'Ndola', 'Kitwe', 'Kabwe', 'Livingstone', 'Chipata',
            'Chingola', 'Mufulira', 'Luanshya', 'Kasama', 'Solwezi', 'Mazabuka'
        ];
        
        return zambianCities.some(city => 
            city.toLowerCase() === cityName.toLowerCase().trim()
        );
    }
};

// ============================================
// ENHANCED LOCATION SEARCH ENGINE
// ============================================
const EnhancedSearchEngine = {
    cache: new Map(),
    lastSearch: 0,
    debounceTimer: null,
    searchHistory: [],
    maxHistoryItems: 20,
    
    init() {
        this.loadSearchHistory();
        console.log('Enhanced Search Engine initialized');
    },
    
    loadSearchHistory() {
        try {
            const history = localStorage.getItem('jubel_search_history');
            if (history) {
                this.searchHistory = JSON.parse(history);
                console.log(`Loaded ${this.searchHistory.length} search history items`);
            }
        } catch (error) {
            console.error('Error loading search history:', error);
            this.searchHistory = [];
        }
    },
    
    saveSearchHistory() {
        try {
            localStorage.setItem('jubel_search_history', JSON.stringify(this.searchHistory));
        } catch (error) {
            console.error('Error saving search history:', error);
        }
    },
    
    addToHistory(query, location, type) {
        const historyItem = {
            query: query,
            location: location,
            type: type,
            timestamp: Date.now(),
            city: AppState.currentCity
        };
        
        // Remove duplicates
        this.searchHistory = this.searchHistory.filter(item => 
            !(item.query === query && item.type === type && item.city === AppState.currentCity)
        );
        
        this.searchHistory.unshift(historyItem);
        
        if (this.searchHistory.length > this.maxHistoryItems) {
            this.searchHistory = this.searchHistory.slice(0, this.maxHistoryItems);
        }
        
        this.saveSearchHistory();
        return historyItem;
    },
    
    async search(query, type = 'destination', location = null) {
        if (!AppState.currentCity) {
            console.warn('No city detected for search');
            return [];
        }
        
        const searchId = `${Date.now()}-${Math.random()}`;
        
        try {
            const cacheKey = `${query.toLowerCase()}-${type}-${AppState.currentCity}`;
            
            if (this.cache.has(cacheKey)) {
                const cached = this.cache.get(cacheKey);
                if (Date.now() - cached.timestamp < 300000) {
                    console.log('Returning cached search results');
                    return cached.results;
                }
            }
            
            console.log(`Searching for "${query}" in ${AppState.currentCity}, type: ${type}`);
            
            // City-constrained search URL
            const bounds = this.getCityBounds(AppState.currentCity);
            let searchUrl;
            
            if (bounds) {
                const params = new URLSearchParams({
                    q: `${query}, ${AppState.currentCity}, Zambia`,
                    format: 'json',
                    limit: 15,
                    countrycodes: 'zm',
                    bounded: 1,
                    viewbox: bounds.join(','),
                    'accept-language': 'en',
                    addressdetails: 1
                });
                searchUrl = `https://nominatim.openstreetmap.org/search?${params}`;
            } else {
                const params = new URLSearchParams({
                    q: `${query}, ${AppState.currentCity}, Zambia`,
                    format: 'json',
                    limit: 15,
                    countrycodes: 'zm',
                    'accept-language': 'en',
                    addressdetails: 1
                });
                searchUrl = `https://nominatim.openstreetmap.org/search?${params}`;
            }
            
            const response = await fetch(searchUrl, {
                headers: {
                    'User-Agent': 'JubelRideApp/1.0',
                    'Accept': 'application/json'
                }
            });
            
            if (!response.ok) {
                throw new Error(`Search failed: ${response.status}`);
            }
            
            const data = await response.json();
            console.log(`Received ${data.length} results for "${query}"`);
            
            // Process and filter results
            const results = this.processSearchResults(data, location, type);
            
            // Cache results
            this.cache.set(cacheKey, {
                results: results,
                timestamp: Date.now(),
                query: query,
                city: AppState.currentCity
            });
            
            // Add to history if destination search
            if (type === 'destination' && results.length > 0) {
                this.addToHistory(query, results[0], type);
            }
            
            this.lastSearch = Date.now();
            
            return results;
        } catch (error) {
            console.error('Search error:', error);
            return [];
        }
    },
    
    processSearchResults(data, userLocation, type) {
        if (!data || data.length === 0) return [];
        
        return data
            .map(place => {
                const address = place.address || {};
                
                // Calculate distance from user location if available
                let distance = 0;
                if (userLocation) {
                    distance = this.calculateDistance(
                        userLocation.lat, userLocation.lng,
                        parseFloat(place.lat), parseFloat(place.lon)
                    );
                }
                
                // Format display address
                const displayAddress = this.formatAddress(place);
                
                return {
                    id: place.place_id || `${place.lat}-${place.lon}`,
                    name: place.display_name.split(',')[0] || place.name || 'Location',
                    address: displayAddress,
                    fullAddress: place.display_name,
                    lat: parseFloat(place.lat),
                    lng: parseFloat(place.lon),
                    type: place.type || place.class || 'unknown',
                    distance: distance,
                    category: this.categorizePlace(place)
                };
            })
            .sort((a, b) => {
                // Sort by distance if location available
                if (userLocation && a.distance !== b.distance) {
                    return a.distance - b.distance;
                }
                // Otherwise sort by importance/relevance
                return 0;
            })
            .slice(0, 10); // Limit to 10 results
    },
    
    formatAddress(place) {
        const address = place.address || {};
        const parts = [];
        
        if (address.road) parts.push(address.road);
        if (address.suburb) parts.push(address.suburb);
        if (address.city && address.city !== AppState.currentCity) {
            parts.push(address.city);
        }
        
        return parts.length > 0 ? parts.join(', ') : place.display_name;
    },
    
    categorizePlace(place) {
        const type = (place.type || '').toLowerCase();
        const name = (place.display_name || '').toLowerCase();
        
        if (type.includes('restaurant') || name.includes('restaurant') || 
            name.includes('pizza') || name.includes('nando') || name.includes('hungry lion')) {
            return 'restaurant';
        } else if (type.includes('pharmacy') || name.includes('pharmacy')) {
            return 'pharmacy';
        } else if (type.includes('supermarket') || name.includes('supermarket')) {
            return 'supermarket';
        } else if (type.includes('mall') || name.includes('mall') || name.includes('shopping centre')) {
            return 'mall';
        } else if (type.includes('hospital') || type.includes('clinic')) {
            return 'medical';
        } else if (type.includes('police')) {
            return 'police';
        } else if (type.includes('fire_station')) {
            return 'fire';
        }
        
        return 'other';
    },
    
    calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // Earth's radius in km
        const dLat = this.deg2rad(lat2 - lat1);
        const dLon = this.deg2rad(lon2 - lon1);
        const a = 
            Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(this.deg2rad(lat1)) * Math.cos(this.deg2rad(lat2)) * 
            Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    },
    
    deg2rad(deg) {
        return deg * (Math.PI/180);
    },
    
    getCityBounds(cityName) {
        // City bounds for Zambian cities
        const cityBounds = {
            'Lusaka': [28.0, -15.6, 28.6, -15.2],
            'Ndola': [28.5, -13.1, 28.8, -12.9],
            'Kitwe': [27.9, -13.1, 28.4, -12.7],
            'Kabwe': [28.3, -14.6, 28.6, -14.3],
            'Livingstone': [25.7, -18.0, 26.0, -17.7],
            'Chipata': [32.5, -13.8, 32.8, -13.6],
            'Chingola': [27.8, -12.8, 27.9, -12.4],
            'Mufulira': [28.1, -12.7, 28.3, -12.5],
            'Luanshya': [28.3, -13.2, 28.5, -13.0],
            'Kasama': [31.1, -10.3, 31.3, -10.1],
            'Solwezi': [26.3, -12.3, 26.5, -12.1],
            'Mazabuka': [27.7, -15.9, 27.9, -15.7]
        };
        
        return cityBounds[cityName] || null;
    },
    
    async searchEmergencyStations(type, city) {
        const cacheKey = `emergency-${type}-${city}`;
        
        if (this.cache.has(cacheKey)) {
            const cached = this.cache.get(cacheKey);
            if (Date.now() - cached.timestamp < 3600000) {
                return cached.results;
            }
        }
        
        try {
            let query = '';
            switch(type) {
                case 'police': query = 'police station'; break;
                case 'fire': query = 'fire station'; break;
                case 'medical': query = 'hospital clinic'; break;
            }
            
            const bounds = this.getCityBounds(city);
            const params = new URLSearchParams({
                q: `${query} ${city} Zambia`,
                format: 'json',
                limit: 20,
                countrycodes: 'zm',
                'accept-language': 'en',
                addressdetails: 1
            });
            
            if (bounds) {
                params.append('bounded', '1');
                params.append('viewbox', bounds.join(','));
            }
            
            const searchUrl = `https://nominatim.openstreetmap.org/search?${params}`;
            const response = await fetch(searchUrl);
            
            if (!response.ok) throw new Error('Emergency search failed');
            
            const data = await response.json();
            const results = data.map(place => ({
                id: place.place_id,
                name: place.display_name.split(',')[0],
                address: this.formatAddress(place),
                fullAddress: place.display_name,
                lat: parseFloat(place.lat),
                lng: parseFloat(place.lon),
                type: type,
                distance: AppState.userLocation ? 
                    this.calculateDistance(
                        AppState.userLocation.lat, AppState.userLocation.lng,
                        parseFloat(place.lat), parseFloat(place.lon)
                    ) : 0
            })).sort((a, b) => a.distance - b.distance);
            
            this.cache.set(cacheKey, {
                results: results,
                timestamp: Date.now()
            });
            
            AppState.emergencyStations[type] = results;
            return results;
        } catch (error) {
            console.error('Emergency station search error:', error);
            return [];
        }
    },
    
    async searchShoppingLocations(category, city) {
        const cacheKey = `shopping-${category}-${city}`;
        
        if (this.cache.has(cacheKey)) {
            const cached = this.cache.get(cacheKey);
            if (Date.now() - cached.timestamp < 3600000) {
                return cached.results;
            }
        }
        
        try {
            let query = '';
            switch(category) {
                case 'restaurant': query = 'pizza nandos "hungry lion" restaurant'; break;
                case 'pharmacy': query = 'pharmacy chemist'; break;
                case 'supermarket': query = 'supermarket shoprite pick n pay'; break;
                case 'mall': query = 'shopping mall centre'; break;
            }
            
            const bounds = this.getCityBounds(city);
            const params = new URLSearchParams({
                q: `${query} ${city} Zambia`,
                format: 'json',
                limit: 15,
                countrycodes: 'zm',
                'accept-language': 'en',
                addressdetails: 1
            });
            
            if (bounds) {
                params.append('bounded', '1');
                params.append('viewbox', bounds.join(','));
            }
            
            const searchUrl = `https://nominatim.openstreetmap.org/search?${params}`;
            const response = await fetch(searchUrl);
            
            if (!response.ok) throw new Error('Shopping search failed');
            
            const data = await response.json();
            const results = data.map(place => ({
                id: place.place_id,
                name: place.display_name.split(',')[0],
                address: this.formatAddress(place),
                fullAddress: place.display_name,
                lat: parseFloat(place.lat),
                lng: parseFloat(place.lon),
                category: category,
                distance: AppState.userLocation ? 
                    this.calculateDistance(
                        AppState.userLocation.lat, AppState.userLocation.lng,
                        parseFloat(place.lat), parseFloat(place.lon)
                    ) : 0
            })).sort((a, b) => a.distance - b.distance);
            
            this.cache.set(cacheKey, {
                results: results,
                timestamp: Date.now()
            });
            
            return results;
        } catch (error) {
            console.error('Shopping location search error:', error);
            return [];
        }
    },
    
    getRecentSearches(type = null) {
        if (type) {
            return this.searchHistory.filter(item => item.type === type);
        }
        return this.searchHistory;
    },
    
    clearCache() {
        this.cache.clear();
        console.log('Search cache cleared');
    }
};

// ============================================
// LOCATION INPUT MANAGER
// ============================================
const LocationInputManager = {
    activeInput: null,
    suggestionsElement: null,
    searchTimeout: null,
    
    init() {
        console.log('Location Input Manager initialized');
        this.setupInputEvents();
    },
    
    setupInputEvents() {
        // Setup pickup inputs
        const pickupInputs = [
            'pickupLocation', 'deliveryPickup', 'shortDeliveryPickup',
            'truckPickup', 'schedulePickup', 'someonePickup',
            'sharePickup', 'broadcastPickup', 'emergencyPickup'
        ];
        
        pickupInputs.forEach(inputId => {
            const input = document.getElementById(inputId);
            if (input) {
                this.setupInput(input, 'pickup');
            }
        });
        
        // Setup destination inputs
        const destinationInputs = [
            'destinationLocation', 'deliveryDestination', 'shortDeliveryDestination',
            'truckDestination', 'scheduleDestination', 'someoneDestination',
            'shareDestination', 'broadcastDestination', 'shoppingDestination',
            'emergencyDestination'
        ];
        
        destinationInputs.forEach(inputId => {
            const input = document.getElementById(inputId);
            if (input) {
                this.setupInput(input, 'destination');
            }
        });
        
        // Setup shop name input for shopping
        const shopInput = document.getElementById('shopName');
        if (shopInput) {
            this.setupInput(shopInput, 'shop');
        }
    },
    
    setupInput(inputElement, type) {
        const inputId = inputElement.id;
        
        // Create suggestions container if it doesn't exist
        if (!document.getElementById(`${inputId}Suggestions`)) {
            const suggestionsContainer = document.createElement('div');
            suggestionsContainer.id = `${inputId}Suggestions`;
            suggestionsContainer.className = 'location-suggestions';
            suggestionsContainer.style.cssText = `
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: white;
                border: 1px solid #ddd;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                max-height: 300px;
                overflow-y: auto;
                z-index: 1000;
                display: none;
                margin-top: 5px;
            `;
            
            inputElement.parentNode.style.position = 'relative';
            inputElement.parentNode.appendChild(suggestionsContainer);
        }
        
        // Focus event
        inputElement.addEventListener('focus', (e) => {
            this.handleInputFocus(inputId, type);
        });
        
        // Input event with debouncing
        inputElement.addEventListener('input', (e) => {
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(() => {
                this.handleInputSearch(inputId, e.target.value, type);
            }, 300);
        });
        
        // Blur event
        inputElement.addEventListener('blur', () => {
            setTimeout(() => {
                this.hideSuggestions(inputId);
            }, 200);
        });
        
        // Key events
        inputElement.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                this.handleEnterKey(inputId);
            }
        });
    },
    
    handleInputFocus(inputId, type) {
        this.activeInput = inputId;
        const input = document.getElementById(inputId);
        
        // Show recent searches if input is empty
        if (!input.value.trim()) {
            this.showRecentSearches(inputId, type);
        }
    },
    
    async handleInputSearch(inputId, query, type) {
        if (query.length < 2) {
            this.hideSuggestions(inputId);
            return;
        }
        
        const input = document.getElementById(inputId);
        const parent = input.closest('.location-input');
        
        if (parent) {
            parent.classList.add('searching');
        }
        
        try {
            let results = [];
            
            if (type === 'shop') {
                // Special handling for shop search
                results = await EnhancedSearchEngine.searchShoppingLocations(
                    'restaurant', // Start with restaurants
                    AppState.currentCity
                );
            } else {
                // Regular location search
                results = await EnhancedSearchEngine.search(
                    query,
                    type,
                    AppState.userLocation
                );
            }
            
            this.showSearchSuggestions(inputId, results, type);
        } catch (error) {
            console.error('Search error:', error);
        } finally {
            if (parent) {
                parent.classList.remove('searching');
            }
        }
    },
    
    showSearchSuggestions(inputId, results, type) {
        const suggestions = document.getElementById(`${inputId}Suggestions`);
        if (!suggestions) return;
        
        suggestions.innerHTML = '';
        
        if (results.length === 0) {
            suggestions.innerHTML = `
                <div class="no-results">
                    <i class="fas fa-search"></i>
                    <div>No results found in ${AppState.currentCity}</div>
                </div>
            `;
        } else {
            results.forEach(result => {
                const item = this.createSuggestionItem(result, type);
                item.addEventListener('click', () => {
                    this.selectLocation(inputId, result, type);
                });
                suggestions.appendChild(item);
            });
        }
        
        suggestions.style.display = 'block';
    },
    
    createSuggestionItem(result, type) {
        const item = document.createElement('div');
        item.className = 'suggestion-item';
        item.dataset.lat = result.lat;
        item.dataset.lng = result.lng;
        
        let icon = 'fa-map-marker-alt';
        let iconColor = '#FF6B35';
        
        if (result.category === 'restaurant') {
            icon = 'fa-utensils';
            iconColor = '#FFC107';
        } else if (result.category === 'pharmacy') {
            icon = 'fa-pills';
            iconColor = '#2196F3';
        } else if (result.category === 'supermarket') {
            icon = 'fa-shopping-cart';
            iconColor = '#4CAF50';
        } else if (result.category === 'mall') {
            icon = 'fa-store';
            iconColor = '#9C27B0';
        } else if (result.category === 'medical') {
            icon = 'fa-hospital';
            iconColor = '#F44336';
        } else if (result.category === 'police') {
            icon = 'fa-shield-alt';
            iconColor = '#2196F3';
        }
        
        item.innerHTML = `
            <div class="suggestion-icon" style="color: ${iconColor}">
                <i class="fas ${icon}"></i>
            </div>
            <div class="suggestion-details">
                <div class="suggestion-name">${result.name}</div>
                <div class="suggestion-address">${result.address}</div>
                ${result.distance ? `<div class="suggestion-distance">${result.distance.toFixed(1)} km</div>` : ''}
            </div>
        `;
        
        return item;
    },
    
    showRecentSearches(inputId, type) {
        const suggestions = document.getElementById(`${inputId}Suggestions`);
        if (!suggestions) return;
        
        const recentSearches = EnhancedSearchEngine.getRecentSearches(type);
        
        if (recentSearches.length === 0) {
            this.hideSuggestions(inputId);
            return;
        }
        
        suggestions.innerHTML = `
            <div class="recent-searches-header">
                <i class="fas fa-history"></i>
                <span>Recent in ${AppState.currentCity}</span>
            </div>
        `;
        
        recentSearches.forEach(item => {
            const recentItem = document.createElement('div');
            recentItem.className = 'suggestion-item recent';
            recentItem.innerHTML = `
                <div class="suggestion-icon">
                    <i class="fas fa-${item.type === 'destination' ? 'flag' : 'map-marker-alt'}"></i>
                </div>
                <div class="suggestion-details">
                    <div class="suggestion-name">${item.location.name}</div>
                    <div class="suggestion-address">${item.location.address}</div>
                </div>
            `;
            
            recentItem.addEventListener('click', () => {
                this.selectLocation(inputId, item.location, item.type);
            });
            
            suggestions.appendChild(recentItem);
        });
        
        suggestions.style.display = 'block';
    },
    
    selectLocation(inputId, location, type) {
        const input = document.getElementById(inputId);
        input.value = location.name;
        
        // Store location data
        input.dataset.lat = location.lat;
        input.dataset.lng = location.lng;
        input.dataset.address = location.address;
        
        // Update AppState based on input type
        if (inputId.includes('pickup') || type === 'pickup') {
            AppState.pickup = location;
            MapManager.updatePickupMarker(location);
        } else if (inputId.includes('destination') || type === 'destination') {
            AppState.destination = location;
            MapManager.updateDestinationMarker(location);
            
            // Calculate price immediately
            if (AppState.pickup) {
                PriceCalculator.calculateAndUpdatePrice();
            }
        }
        
        // Draw route if both pickup and destination are set
        if (AppState.pickup && AppState.destination) {
            MapManager.drawRoute(AppState.pickup, AppState.destination);
        }
        
        this.hideSuggestions(inputId);
    },
    
    hideSuggestions(inputId) {
        const suggestions = document.getElementById(`${inputId}Suggestions`);
        if (suggestions) {
            suggestions.style.display = 'none';
        }
    },
    
    handleEnterKey(inputId) {
        const suggestions = document.getElementById(`${inputId}Suggestions`);
        if (suggestions && suggestions.style.display === 'block') {
            const firstItem = suggestions.querySelector('.suggestion-item');
            if (firstItem) {
                firstItem.click();
            }
        }
    },
    
    clearInput(inputId) {
        const input = document.getElementById(inputId);
        if (input) {
            input.value = '';
            delete input.dataset.lat;
            delete input.dataset.lng;
            delete input.dataset.address;
            
            if (inputId.includes('pickup')) {
                AppState.pickup = null;
                MapManager.removePickupMarker();
            } else if (inputId.includes('destination')) {
                AppState.destination = null;
                MapManager.removeDestinationMarker();
                MapManager.removeRoute();
            }
        }
    }
};

// ============================================
// MAP MANAGER
// ============================================
const MapManager = {
    map: null,
    currentLocationMarker: null,
    pickupMarker: null,
    destinationMarker: null,
    driverMarker: null,
    routeLayer: null,
    emergencyMarkers: [],
    
    init() {
        console.log('Initializing map...');
        this.initializeMap();
    },
    
    initializeMap() {
        // Default to Lusaka coordinates
        const defaultLat = -15.4167;
        const defaultLng = 28.2833;
        
        this.map = L.map('map').setView([defaultLat, defaultLng], 13);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: ' OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(this.map);
        
        L.control.scale().addTo(this.map);
        
        console.log('Map initialized');
        AppState.mapInitialized = true;
    },
    
    updateCurrentLocation(lat, lng) {
        if (!this.map) return;
        
        this.map.setView([lat, lng], 15);
        
        if (this.currentLocationMarker) {
            this.map.removeLayer(this.currentLocationMarker);
        }
        
        this.currentLocationMarker = L.marker([lat, lng], {
            icon: L.divIcon({
                className: 'current-location-marker',
                html: '<i class="fas fa-user"></i>',
                iconSize: [24, 24],
                iconAnchor: [12, 24]
            })
        }).addTo(this.map).bindPopup('Your Location');
    },
    
    updatePickupMarker(location) {
        if (!this.map) return;
        
        if (this.pickupMarker) {
            this.map.removeLayer(this.pickupMarker);
        }
        
        this.pickupMarker = L.marker([location.lat, location.lng], {
            icon: L.divIcon({
                className: 'pickup-marker',
                html: '<i class="fas fa-map-marker-alt"></i>',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(this.map).bindPopup('Pickup Location');
        
        // Center map on pickup if no destination
        if (!AppState.destination) {
            this.map.setView([location.lat, location.lng], 15);
        }
    },
    
    updateDestinationMarker(location) {
        if (!this.map) return;
        
        if (this.destinationMarker) {
            this.map.removeLayer(this.destinationMarker);
        }
        
        this.destinationMarker = L.marker([location.lat, location.lng], {
            icon: L.divIcon({
                className: 'destination-marker',
                html: '<i class="fas fa-flag"></i>',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(this.map).bindPopup('Destination');
    },
    
    async drawRoute(start, end) {
        if (!this.map) return;
        
        // Remove existing route
        if (this.routeLayer) {
            this.map.removeLayer(this.routeLayer);
            this.routeLayer = null;
        }
        
        try {
            const response = await fetch(
                `https://router.project-osrm.org/route/v1/driving/${start.lng},${start.lat};${end.lng},${end.lat}?overview=full&geometries=geojson`
            );
            
            if (response.ok) {
                const data = await response.json();
                
                if (data.routes && data.routes.length > 0) {
                    const route = data.routes[0];
                    const routeCoordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                    
                    this.routeLayer = L.polyline(routeCoordinates, {
                        color: '#FF6B35',
                        weight: 4,
                        opacity: 0.7,
                        lineJoin: 'round'
                    }).addTo(this.map);
                    
                    // Fit bounds to show entire route
                    const bounds = L.latLngBounds(routeCoordinates);
                    this.map.fitBounds(bounds, { padding: [50, 50] });
                    
                    // Store route data
                    AppState.activeRoute = {
                        distance: route.distance / 1000, // Convert to km
                        duration: route.duration / 60, // Convert to minutes
                        coordinates: routeCoordinates
                    };
                    
                    console.log(`Route drawn: ${AppState.activeRoute.distance.toFixed(2)} km`);
                    return AppState.activeRoute;
                }
            }
        } catch (error) {
            console.error('Routing error:', error);
            // Fallback: draw straight line
            this.routeLayer = L.polyline([
                [start.lat, start.lng],
                [end.lat, end.lng]
            ], {
                color: '#FF6B35',
                weight: 3,
                opacity: 0.7,
                dashArray: '10, 10'
            }).addTo(this.map);
        }
    },
    
    removePickupMarker() {
        if (this.pickupMarker) {
            this.map.removeLayer(this.pickupMarker);
            this.pickupMarker = null;
        }
    },
    
    removeDestinationMarker() {
        if (this.destinationMarker) {
            this.map.removeLayer(this.destinationMarker);
            this.destinationMarker = null;
        }
    },
    
    removeRoute() {
        if (this.routeLayer) {
            this.map.removeLayer(this.routeLayer);
            this.routeLayer = null;
        }
    },
    
    addStopMarker(location, index) {
        if (!this.map) return;
        
        const marker = L.marker([location.lat, location.lng], {
            icon: L.divIcon({
                className: 'stop-marker',
                html: `<i class="fas fa-map-pin"></i><span class="stop-index">${index}</span>`,
                iconSize: [28, 28],
                iconAnchor: [14, 28]
            })
        }).addTo(this.map).bindPopup(`Stop ${index}`);
        
        return marker;
    },
    
    updateDriverMarker(location) {
        if (!this.map) return;
        
        if (this.driverMarker) {
            this.map.removeLayer(this.driverMarker);
        }
        
        this.driverMarker = L.marker([location.lat, location.lng], {
            icon: L.divIcon({
                className: 'driver-marker',
                html: '<i class="fas fa-car"></i>',
                iconSize: [36, 36],
                iconAnchor: [18, 36]
            })
        }).addTo(this.map).bindPopup('Your Driver');
    },
    
    addEmergencyStationMarker(station, type) {
        if (!this.map) return;
        
        let iconHtml = '';
        switch(type) {
            case 'police': iconHtml = '<i class="fas fa-shield-alt"></i>'; break;
            case 'fire': iconHtml = '<i class="fas fa-fire-extinguisher"></i>'; break;
            case 'medical': iconHtml = '<i class="fas fa-ambulance"></i>'; break;
        }
        
        const marker = L.marker([station.lat, station.lng], {
            icon: L.divIcon({
                className: 'emergency-marker',
                html: iconHtml,
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(this.map).bindPopup(station.name);
        
        this.emergencyMarkers.push(marker);
        return marker;
    },
    
    clearEmergencyMarkers() {
        this.emergencyMarkers.forEach(marker => {
            if (marker) this.map.removeLayer(marker);
        });
        this.emergencyMarkers = [];
    },
    
    showPulsingIcon(serviceType) {
        this.removePulsingIcon();
        
        let iconClass = 'fa-car';
        let iconSize = '60px';
        
        switch(serviceType) {
            case 'delivery':
            case 'short-delivery':
                iconClass = 'fa-motorcycle';
                break;
            case 'truck':
                iconClass = 'fa-truck';
                iconSize = '70px';
                break;
            case 'shopping':
                iconClass = 'fa-shopping-bag';
                break;
        }
        
        const pulsingIcon = L.divIcon({
            className: 'pulsing-icon',
            html: `<i class="fas ${iconClass}" style="font-size: ${iconSize}; color: #FF6B35;"></i>`,
            iconSize: [80, 80],
            iconAnchor: [40, 40]
        });
        
        if (AppState.pickup) {
            AppState.pulsingIcon = L.marker([AppState.pickup.lat, AppState.pickup.lng], {
                icon: pulsingIcon
            }).addTo(this.map);
            
            // Add pulsing animation
            const iconElement = document.querySelector('.pulsing-icon');
            if (iconElement) {
                iconElement.style.animation = 'pulse 1.5s infinite';
            }
        }
    },
    
    removePulsingIcon() {
        if (AppState.pulsingIcon) {
            this.map.removeLayer(AppState.pulsingIcon);
            AppState.pulsingIcon = null;
        }
    },
    
    centerOnLocation(lat, lng, zoom = 15) {
        if (this.map) {
            this.map.setView([lat, lng], zoom);
        }
    },
    
    fitBoundsToRoute() {
        if (!this.map || !this.routeLayer) return;
        
        const bounds = this.routeLayer.getBounds();
        this.map.fitBounds(bounds, { padding: [50, 50] });
    }
};

// ============================================
// PRICE CALCULATOR
// ============================================
const PriceCalculator = {
    calculateAndUpdatePrice() {
        if (!AppState.pickup || !AppState.destination) {
            return;
        }
        
        const distance = this.calculateDistance(
            AppState.pickup.lat, AppState.pickup.lng,
            AppState.destination.lat, AppState.destination.lng
        );
        
        let fare = 0;
        let breakdown = null;
        
        switch(AppState.activeService) {
            case 'car':
                fare = this.calculateRideFare(distance, AppState.selectedRideType);
                breakdown = this.getRideBreakdown(distance, AppState.selectedRideType);
                break;
            case 'delivery':
                fare = this.calculateDeliveryFare(distance);
                break;
            case 'short-delivery':
                fare = this.calculateShortDeliveryFare(distance);
                break;
            case 'truck':
                fare = this.calculateTruckFare(distance);
                break;
            case 'express':
                fare = this.calculateShoppingFare(distance);
                break;
        }
        
        // Apply stops multiplier if stops exist
        if (AppState.stops.length > 0) {
            fare *= (1 + (AppState.stops.length * 0.15)); // 15% increase per stop
        }
        
        // Apply split ride calculation if applicable
        if (AppState.splitRideFriends.length > 0) {
            const splitCalculation = this.calculateSplitRideFare(fare, AppState.splitRideFriends.length + 1);
            AppState.rideSplitDetails = splitCalculation;
            fare = splitCalculation.yourShare;
        }
        
        // Store the base fare for referral calculations
        AppState.rideFare = fare;
        
        // Update UI
        this.updatePriceDisplay(fare, distance);
        
        return { fare, distance, breakdown };
    },
    
    calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = this.deg2rad(lat2 - lat1);
        const dLon = this.deg2rad(lon2 - lon1);
        const a = 
            Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(this.deg2rad(lat1)) * Math.cos(this.deg2rad(lat2)) * 
            Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    },
    
    deg2rad(deg) {
        return deg * (Math.PI/180);
    },
    
    calculateRideFare(distance, rideType) {
        const config = AppState.rideTypes[rideType];
        if (!config) return 0;
        
        let fare = config.base + (distance * config.perKm);
        fare *= config.multiplier;
        
        // Apply surge pricing based on time of day
        const hour = new Date().getHours();
        if ((hour >= 7 && hour <= 9) || (hour >= 16 && hour <= 19)) {
            fare *= 1.3; // Rush hour
        } else if (hour >= 22 || hour <= 5) {
            fare *= 1.2; // Late night
        }
        
        return Math.max(fare, config.min);
    },
    
    calculateDeliveryFare(distance) {
        let fare = 25 + (distance * 2.5);
        return Math.max(fare, 20);
    },
    
    calculateShortDeliveryFare(distance) {
        let fare = 15 + (distance * 2.0);
        return Math.max(fare, 12);
    },
    
    calculateTruckFare(distance) {
        let fare = 100 + (distance * 5.0);
        return Math.max(fare, 80);
    },
    
    calculateShoppingFare(distance) {
        let fare = 30 + (distance * 3.0);
        return Math.max(fare, 25);
    },
    
    calculateEmergencyFare(distance, serviceType) {
        const config = AppState.emergencyServices[serviceType];
        if (!config) return 0;
        
        let fare = config.base + (distance * config.perKm);
        fare *= config.multiplier;
        return Math.max(fare, config.min);
    },
    
    calculateSplitRideFare(totalFare, numberOfPeople) {
        const yourShare = totalFare / numberOfPeople;
        const friendShare = totalFare / numberOfPeople;
        
        return {
            total: totalFare,
            yourShare: yourShare,
            friendShare: friendShare,
            numberOfPeople: numberOfPeople
        };
    },
    
    getRideBreakdown(distance, rideType) {
        const config = AppState.rideTypes[rideType];
        if (!config) return null;
        
        const baseFare = config.base;
        const distanceFare = distance * config.perKm;
        const subtotal = baseFare + distanceFare;
        const multiplier = config.multiplier;
        const total = subtotal * multiplier;
        
        return {
            baseFare: baseFare,
            distanceFare: distanceFare,
            distance: distance,
            multiplier: multiplier,
            subtotal: subtotal,
            total: total,
            minFare: config.min
        };
    },
    
    updatePriceDisplay(fare, distance) {
        const fareElement = document.getElementById('estimatedFare');
        const distanceElement = document.getElementById('distanceDetail');
        const timeElement = document.getElementById('timeDetail');
        
        if (fareElement) {
            fareElement.textContent = `ZMW ${fare.toFixed(2)}`;
        }
        
        if (distanceElement) {
            distanceElement.textContent = `${distance.toFixed(1)} km`;
        }
        
        if (timeElement) {
            const time = this.estimateTravelTime(distance);
            timeElement.textContent = `ETA: ${time} min`;
        }
        
        // Update ride type cards
        this.updateRideTypeCards(distance);
    },
    
    updateRideTypeCards(distance) {
        const container = document.getElementById('rideTypeCardsContainer');
        if (!container) return;
        
        container.innerHTML = '';
        
        Object.entries(AppState.rideTypes).forEach(([type, config]) => {
            const fare = this.calculateRideFare(distance, type);
            const isSelected = AppState.selectedRideType === type;
            
            const card = document.createElement('div');
            card.className = `ride-type-card ${type} ${isSelected ? 'selected' : ''}`;
            card.dataset.type = type;
            
            card.innerHTML = `
                <div class="ride-type-icon">
                    <i class="fas ${config.icon}"></i>
                </div>
                <div class="ride-type-name">${config.name}</div>
                <div class="ride-type-price">ZMW ${fare.toFixed(2)}</div>
            `;
            
            card.addEventListener('click', () => {
                this.selectRideType(type);
                this.calculateAndUpdatePrice();
            });
            
            container.appendChild(card);
        });
    },
    
    selectRideType(type) {
        AppState.selectedRideType = type;
        
        // Update UI
        document.querySelectorAll('.ride-type-card').forEach(card => {
            card.classList.remove('selected');
        });
        
        const selectedCard = document.querySelector(`.ride-type-card[data-type="${type}"]`);
        if (selectedCard) {
            selectedCard.classList.add('selected');
        }
    },
    
    estimateTravelTime(distance) {
        const baseSpeed = AppState.selectedRideType === 'premium' ? 50 : 40;
        let time = (distance / baseSpeed) * 60;
        
        // Add traffic factor
        const hour = new Date().getHours();
        if ((hour >= 7 && hour <= 9) || (hour >= 16 && hour <= 19)) {
            time *= 1.5; // Rush hour
        }
        
        // Add buffer
        time += 5;
        
        return Math.ceil(time);
    },
    
    applyReferralDiscount(fare) {
        if (AppState.referralDiscountApplied) {
            const discount = fare * 0.5;
            const finalFare = fare - discount;
            
            return {
                originalFare: fare,
                discount: discount,
                finalFare: finalFare,
                discountApplied: true
            };
        }
        
        return {
            originalFare: fare,
            discount: 0,
            finalFare: fare,
            discountApplied: false
        };
    }
};

// ============================================
// STOPS MANAGER
// ============================================
const StopsManager = {
    init() {
        console.log('Stops Manager initialized');
        this.setupAddStopButton();
    },
    
    setupAddStopButton() {
        const addStopBtn = document.getElementById('addStopBtn');
        if (addStopBtn) {
            addStopBtn.addEventListener('click', () => {
                this.addStop();
            });
        }
    },
    
    addStop() {
        if (AppState.stops.length >= AppState.maxStops) {
            EnhancedUIUpdater.showToast(`Maximum ${AppState.maxStops} stops allowed`, 'warning');
            return;
        }
        
        const stopIndex = AppState.stops.length + 1;
        const stopContainer = document.getElementById('stopsContainer');
        
        const stopElement = document.createElement('div');
        stopElement.className = 'stop-item';
        stopElement.dataset.index = stopIndex;
        
        stopElement.innerHTML = `
            <div class="stop-header">
                <div class="stop-number">Stop ${stopIndex}</div>
                <button class="remove-stop" type="button">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="location-input">
                <i class="fas fa-map-pin"></i>
                <input type="text" class="stop-location" placeholder="Enter stop location" autocomplete="off">
                <div class="suggestion-list" id="stop${stopIndex}Suggestions"></div>
            </div>
        `;
        
        stopContainer.appendChild(stopElement);
        
        // Setup input events for this stop
        const stopInput = stopElement.querySelector('.stop-location');
        this.setupStopInput(stopInput, stopIndex);
        
        // Setup remove button
        const removeBtn = stopElement.querySelector('.remove-stop');
        removeBtn.addEventListener('click', () => {
            this.removeStop(stopIndex);
        });
        
        AppState.stops.push({
            index: stopIndex,
            location: null,
            element: stopElement
        });
        
        console.log(`Stop ${stopIndex} added`);
    },
    
    setupStopInput(inputElement, stopIndex) {
        inputElement.addEventListener('focus', () => {
            LocationInputManager.handleInputFocus(inputElement.id, 'stop');
        });
        
        inputElement.addEventListener('input', (e) => {
            clearTimeout(LocationInputManager.searchTimeout);
            LocationInputManager.searchTimeout = setTimeout(() => {
                this.searchStopLocation(inputElement.value, stopIndex);
            }, 300);
        });
    },
    
    async searchStopLocation(query, stopIndex) {
        if (query.length < 2) return;
        
        try {
            const results = await EnhancedSearchEngine.search(
                query,
                'stop',
                AppState.userLocation
            );
            
            this.showStopSuggestions(results, stopIndex);
        } catch (error) {
            console.error('Stop search error:', error);
        }
    },
    
    showStopSuggestions(results, stopIndex) {
        const suggestions = document.getElementById(`stop${stopIndex}Suggestions`);
        if (!suggestions) return;
        
        suggestions.innerHTML = '';
        
        if (results.length === 0) {
            suggestions.innerHTML = '<div class="no-results">No results found</div>';
        } else {
            results.forEach(result => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.innerHTML = `
                    <div class="suggestion-icon">
                        <i class="fas fa-map-marker-alt"></i>
                    </div>
                    <div class="suggestion-details">
                        <div class="suggestion-name">${result.name}</div>
                        <div class="suggestion-address">${result.address}</div>
                    </div>
                `;
                
                item.addEventListener('click', () => {
                    this.selectStopLocation(result, stopIndex);
                });
                
                suggestions.appendChild(item);
            });
        }
        
        suggestions.style.display = 'block';
    },
    
    selectStopLocation(location, stopIndex) {
        const stop = AppState.stops.find(s => s.index === stopIndex);
        if (!stop) return;
        
        const input = stop.element.querySelector('.stop-location');
        input.value = location.name;
        input.dataset.lat = location.lat;
        input.dataset.lng = location.lng;
        
        stop.location = location;
        
        // Add marker to map
        MapManager.addStopMarker(location, stopIndex);
        
        // Hide suggestions
        const suggestions = document.getElementById(`stop${stopIndex}Suggestions`);
        if (suggestions) {
            suggestions.style.display = 'none';
        }
        
        // Recalculate price with stops
        PriceCalculator.calculateAndUpdatePrice();
        
        console.log(`Stop ${stopIndex} location set`);
    },
    
    removeStop(stopIndex) {
        const stopIndexToRemove = parseInt(stopIndex);
        const stopElement = document.querySelector(`.stop-item[data-index="${stopIndexToRemove}"]`);
        
        if (stopElement) {
            stopElement.remove();
        }
        
        // Remove from AppState
        AppState.stops = AppState.stops.filter(stop => stop.index !== stopIndexToRemove);
        
        // Renumber remaining stops
        AppState.stops.forEach((stop, index) => {
            stop.index = index + 1;
            const stopElement = document.querySelector(`.stop-item[data-index="${stopIndexToRemove}"]`);
            if (stopElement) {
                stopElement.dataset.index = stop.index;
                stopElement.querySelector('.stop-number').textContent = `Stop ${stop.index}`;
            }
        });
        
        // Recalculate price
        PriceCalculator.calculateAndUpdatePrice();
        
        console.log(`Stop ${stopIndex} removed`);
    },
    
    clearAllStops() {
        AppState.stops.forEach(stop => {
            const stopElement = document.querySelector(`.stop-item[data-index="${stop.index}"]`);
            if (stopElement) {
                stopElement.remove();
            }
        });
        
        AppState.stops = [];
        console.log('All stops cleared');
    },
    
    getStopsWithLocations() {
        return AppState.stops.filter(stop => stop.location !== null);
    }
};

// ============================================
// SPLIT RIDE MANAGER
// ============================================
const SplitRideManager = {
    init() {
        console.log('Split Ride Manager initialized');
        this.setupSplitRideUI();
    },
    
    setupSplitRideUI() {
        // Setup split ride button in quick actions
        const splitRideBtn = document.createElement('button');
        splitRideBtn.className = 'quick-action-btn';
        splitRideBtn.id = 'splitRideBtn';
        splitRideBtn.innerHTML = `
            <div class="quick-action-icon">
                <i class="fas fa-user-friends"></i>
            </div>
            <div class="quick-action-text">
                <div class="quick-action-title">Split Ride</div>
                <div class="quick-action-desc">Share cost with friends</div>
            </div>
        `;
        
        const quickActions = document.querySelector('.quick-actions');
        if (quickActions) {
            quickActions.appendChild(splitRideBtn);
            splitRideBtn.addEventListener('click', () => {
                this.showSplitRideModal();
            });
        }
        
        // Create split ride modal
        this.createSplitRideModal();
    },
    
    createSplitRideModal() {
        const modalHTML = `
            <div class="modal-overlay" id="splitRideModal" style="display: none;">
                <div class="modal">
                    <div class="modal-header">
                        <div class="modal-title">
                            <i class="fas fa-user-friends"></i>
                            Split Ride
                        </div>
                        <button class="modal-close" onclick="ModalManager.hide('splitRide')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-content">
                        <div class="form-group">
                            <label class="form-label">Add Friends by Referral Code</label>
                            <div class="input-with-button">
                                <input type="text" id="splitFriendCode" placeholder="Enter friend's referral code">
                                <button class="btn btn-primary" onclick="SplitRideManager.addSplitFriend()">
                                    <i class="fas fa-plus"></i> Add
                                </button>
                            </div>
                        </div>
                        
                        <div class="split-friends-list" id="splitFriendsList">
                            <!-- Friends will be added here -->
                        </div>
                        
                        <div class="split-calculations" id="splitCalculations" style="display: none;">
                            <div class="calculation-header">
                                <i class="fas fa-calculator"></i>
                                Split Calculations
                            </div>
                            <div class="calculation-details">
                                <div class="calculation-row">
                                    <span>Total Fare:</span>
                                    <span id="splitTotalFare">ZMW 0.00</span>
                                </div>
                                <div class="calculation-row">
                                    <span>Your Share:</span>
                                    <span id="splitYourShare">ZMW 0.00</span>
                                </div>
                                <div class="calculation-row">
                                    <span>Friend's Share:</span>
                                    <span id="splitFriendShare">ZMW 0.00</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="split-options">
                            <div class="split-option" data-split="1" onclick="SplitRideManager.selectSplitOption(1)">
                                <div class="split-icon">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="split-label">Split with 1 friend</div>
                            </div>
                            <div class="split-option" data-split="2" onclick="SplitRideManager.selectSplitOption(2)">
                                <div class="split-icon">
                                    <i class="fas fa-user-friends"></i>
                                </div>
                                <div class="split-label">Split with 2 friends</div>
                            </div>
                            <div class="split-option" data-split="3" onclick="SplitRideManager.selectSplitOption(3)">
                                <div class="split-icon">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div class="split-label">Split with 3 friends</div>
                            </div>
                        </div>
                        
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="SplitRideManager.requestSplitRide()">
                                <i class="fas fa-user-friends"></i>
                                Request Split Ride
                            </button>
                            <button class="btn btn-secondary" onclick="ModalManager.hide('splitRide')">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
    },
    
    showSplitRideModal() {
        ModalManager.show('splitRide');
        this.updateSplitCalculations();
    },
    
    async addSplitFriend() {
        const friendCodeInput = document.getElementById('splitFriendCode');
        const friendCode = friendCodeInput.value.trim();
        
        if (!friendCode) {
            EnhancedUIUpdater.showToast('Please enter a referral code', 'warning');
            return;
        }
        
        if (AppState.splitRideFriends.length >= AppState.maxSplitFriends) {
            EnhancedUIUpdater.showToast(`Maximum ${AppState.maxSplitFriends} friends allowed`, 'warning');
            return;
        }
        
        // Check if friend already added
        if (AppState.splitRideFriends.some(friend => friend.code === friendCode)) {
            EnhancedUIUpdater.showToast('Friend already added', 'warning');
            return;
        }
        
        // Find user by referral code
        try {
            const friendData = await FirebaseManager.findUserByReferralCode(friendCode);
            
            if (friendData && friendData.id !== AppState.currentUser.uid) {
                const friend = {
                    code: friendCode,
                    name: friendData.name,
                    userId: friendData.id,
                    status: 'pending',
                    paymentMethod: null,
                    paymentConfirmed: false
                };
                
                AppState.splitRideFriends.push(friend);
                this.updateSplitFriendsList();
                this.updateSplitCalculations();
                
                friendCodeInput.value = '';
                EnhancedUIUpdater.showToast(`${friend.name} added to split ride`, 'success');
            } else {
                EnhancedUIUpdater.showToast('Invalid referral code or cannot add yourself', 'error');
            }
        } catch (error) {
            console.error('Error adding split friend:', error);
            EnhancedUIUpdater.showToast('Error adding friend', 'error');
        }
    },
    
    updateSplitFriendsList() {
        const container = document.getElementById('splitFriendsList');
        if (!container) return;
        
        container.innerHTML = '';
        
        if (AppState.splitRideFriends.length === 0) {
            container.innerHTML = '<div class="empty-list">No friends added yet</div>';
            return;
        }
        
        AppState.splitRideFriends.forEach((friend, index) => {
            const friendElement = document.createElement('div');
            friendElement.className = 'split-friend-item';
            friendElement.innerHTML = `
                <div class="friend-info">
                    <div class="friend-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div>
                        <div class="friend-name">${friend.name}</div>
                        <div class="friend-status ${friend.status}">
                            ${friend.status === 'pending' ? 'Pending' : 
                              friend.status === 'accepted' ? 'Accepted' : 'Declined'}
                        </div>
                    </div>
                </div>
                <button class="remove-friend" onclick="SplitRideManager.removeSplitFriend('${friend.code}')">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(friendElement);
        });
    },
    
    removeSplitFriend(friendCode) {
        AppState.splitRideFriends = AppState.splitRideFriends.filter(friend => friend.code !== friendCode);
        this.updateSplitFriendsList();
        this.updateSplitCalculations();
    },
    
    selectSplitOption(numberOfFriends) {
        // Update selected state
        document.querySelectorAll('.split-option').forEach(option => {
            option.classList.remove('selected');
        });
        
        const selectedOption = document.querySelector(`.split-option[data-split="${numberOfFriends}"]`);
        if (selectedOption) {
            selectedOption.classList.add('selected');
        }
        
        // Update calculations
        this.updateSplitCalculations();
    },
    
    updateSplitCalculations() {
        const totalPeople = AppState.splitRideFriends.filter(f => f.status === 'accepted').length + 1;
        
        if (totalPeople > 1 && AppState.rideFare > 0) {
            const calculations = PriceCalculator.calculateSplitRideFare(AppState.rideFare, totalPeople);
            
            document.getElementById('splitTotalFare').textContent = `ZMW ${calculations.total.toFixed(2)}`;
            document.getElementById('splitYourShare').textContent = `ZMW ${calculations.yourShare.toFixed(2)}`;
            document.getElementById('splitFriendShare').textContent = `ZMW ${calculations.friendShare.toFixed(2)}`;
            
            document.getElementById('splitCalculations').style.display = 'block';
        } else {
            document.getElementById('splitCalculations').style.display = 'none';
        }
    },
    
    async requestSplitRide() {
        if (!AppState.pickup || !AppState.destination) {
            EnhancedUIUpdater.showToast('Please set pickup and destination first', 'warning');
            return;
        }
        
        if (AppState.splitRideFriends.length === 0) {
            EnhancedUIUpdater.showToast('Please add at least one friend', 'warning');
            return;
        }
        
        // Check if all friends have referral codes
        const invalidFriends = AppState.splitRideFriends.filter(friend => !friend.userId);
        if (invalidFriends.length > 0) {
            EnhancedUIUpdater.showToast('Some friends have invalid referral codes', 'error');
            return;
        }
        
        // Calculate total fare
        const totalPeople = AppState.splitRideFriends.length + 1;
        const splitCalculation = PriceCalculator.calculateSplitRideFare(AppState.rideFare, totalPeople);
        
        // Create split ride invitation
        const splitRideData = {
            pickup: AppState.pickup,
            destination: AppState.destination,
            totalFare: splitCalculation.total,
            yourShare: splitCalculation.yourShare,
            friendShare: splitCalculation.friendShare,
            rideType: AppState.selectedRideType,
            serviceType: AppState.activeService,
            friends: AppState.splitRideFriends,
            hostId: AppState.currentUser.uid,
            hostName: AppState.userData.name,
            status: 'pending',
            timestamp: Date.now()
        };
        
        try {
            const splitRideId = await FirebaseManager.createSplitRideInvitation(splitRideData);
            
            // Send invitations to all friends
            AppState.splitRideFriends.forEach(friend => {
                FirebaseManager.sendSplitRideInvitation(splitRideId, friend.userId, splitRideData);
            });
            
            ModalManager.hide('splitRide');
            EnhancedUIUpdater.showToast('Split ride invitations sent successfully', 'success');
            
            // Show waiting screen
            this.showSplitRideWaitingScreen(splitRideId);
            
        } catch (error) {
            console.error('Error creating split ride:', error);
            EnhancedUIUpdater.showToast('Error creating split ride', 'error');
        }
    },
    
    showSplitRideWaitingScreen(splitRideId) {
        // Create waiting screen
        const waitingHTML = `
            <div class="split-ride-waiting" id="splitRideWaiting">
                <div class="waiting-header">
                    <i class="fas fa-user-friends"></i>
                    <h3>Waiting for Friends</h3>
                </div>
                <div class="waiting-friends" id="waitingFriendsList">
                    <!-- Friend status will be updated here -->
                </div>
                <div class="waiting-actions">
                    <button class="btn btn-danger" onclick="SplitRideManager.cancelSplitRide('${splitRideId}')">
                        <i class="fas fa-times"></i>
                        Cancel Split Ride
                    </button>
                </div>
            </div>
        `;
        
        const mainPanel = document.getElementById('mainPanel');
        if (mainPanel) {
            const existingWaiting = document.getElementById('splitRideWaiting');
            if (existingWaiting) {
                existingWaiting.remove();
            }
            
            mainPanel.insertAdjacentHTML('beforeend', waitingHTML);
            
            // Start listening for friend responses
            this.listenForSplitRideResponses(splitRideId);
        }
    },
    
    async listenForSplitRideResponses(splitRideId) {
        const splitRideRef = database.ref(`splitRides/${splitRideId}`);
        
        splitRideRef.on('value', (snapshot) => {
            const splitRide = snapshot.val();
            if (splitRide) {
                this.updateSplitRideStatus(splitRideId, splitRide);
            }
        });
    },
    
    updateSplitRideStatus(splitRideId, splitRide) {
        const waitingList = document.getElementById('waitingFriendsList');
        if (!waitingList) return;
        
        waitingList.innerHTML = '';
        
        if (splitRide.friends) {
            Object.values(splitRide.friends).forEach(friend => {
                const friendElement = document.createElement('div');
                friendElement.className = 'waiting-friend';
                friendElement.innerHTML = `
                    <div class="friend-name">${friend.name}</div>
                    <div class="friend-status ${friend.status}">
                        ${friend.status === 'pending' ? 'Waiting...' : 
                          friend.status === 'accepted' ? 'Accepted' : 'Declined'}
                    </div>
                `;
                waitingList.appendChild(friendElement);
            });
        }
        
        // Check if all friends have responded
        const allResponded = Object.values(splitRide.friends || {}).every(friend => 
            friend.status !== 'pending'
        );
        
        if (allResponded) {
            // Check if we have enough accepted friends
            const acceptedFriends = Object.values(splitRide.friends || {}).filter(f => 
                f.status === 'accepted'
            );
            
            if (acceptedFriends.length > 0) {
                // Show proceed to payment button
                const proceedButton = document.createElement('button');
                proceedButton.className = 'btn btn-primary';
                proceedButton.innerHTML = `
                    <i class="fas fa-credit-card"></i>
                    Proceed to Payment (${acceptedFriends.length + 1} people)
                `;
                proceedButton.addEventListener('click', () => {
                    this.proceedToSplitRidePayment(splitRideId, splitRide);
                });
                
                waitingList.appendChild(proceedButton);
            } else {
                EnhancedUIUpdater.showToast('No friends accepted the split ride', 'warning');
                this.cancelSplitRide(splitRideId);
            }
        }
    },
    
    proceedToSplitRidePayment(splitRideId, splitRideData) {
        // Calculate final amounts
        const acceptedFriends = Object.values(splitRideData.friends || {}).filter(f => 
            f.status === 'accepted'
        );
        const totalPeople = acceptedFriends.length + 1;
        
        const finalCalculation = PriceCalculator.calculateSplitRideFare(
            splitRideData.totalFare,
            totalPeople
        );
        
        // Store in pending ride data
        window.pendingRideData = {
            ...splitRideData,
            splitRideId: splitRideId,
            acceptedFriends: acceptedFriends,
            finalCalculation: finalCalculation,
            isSplitRide: true
        };
        
        // Show payment modal
        ModalManager.show('payment');
        
        // Remove waiting screen
        const waitingScreen = document.getElementById('splitRideWaiting');
        if (waitingScreen) {
            waitingScreen.remove();
        }
    },
    
    async cancelSplitRide(splitRideId) {
        try {
            await FirebaseManager.cancelSplitRide(splitRideId);
            EnhancedUIUpdater.showToast('Split ride cancelled', 'success');
            
            // Remove waiting screen
            const waitingScreen = document.getElementById('splitRideWaiting');
            if (waitingScreen) {
                waitingScreen.remove();
            }
            
            // Clear split ride friends
            AppState.splitRideFriends = [];
        } catch (error) {
            console.error('Error cancelling split ride:', error);
            EnhancedUIUpdater.showToast('Error cancelling split ride', 'error');
        }
    },
    
    async handleSplitRideInvitation(invitationId, response) {
        try {
            await FirebaseManager.respondToSplitRideInvitation(invitationId, response);
            
            if (response === 'accept') {
                EnhancedUIUpdater.showToast('Split ride invitation accepted', 'success');
            } else {
                EnhancedUIUpdater.showToast('Split ride invitation declined', 'info');
            }
        } catch (error) {
            console.error('Error handling split ride invitation:', error);
            EnhancedUIUpdater.showToast('Error processing invitation', 'error');
        }
    }
};

// ============================================
// BROADCAST RIDE MANAGER
// ============================================
const BroadcastRideManager = {
    init() {
        console.log('Broadcast Ride Manager initialized');
        this.setupBroadcastUI();
    },
    
    setupBroadcastUI() {
        // Setup broadcast button
        const broadcastBtn = document.getElementById('broadcastRideBtn');
        if (broadcastBtn) {
            broadcastBtn.addEventListener('click', () => {
                this.showBroadcastModal();
            });
        }
        
        // Create broadcast modal
        this.createBroadcastModal();
    },
    
    createBroadcastModal() {
        const modalHTML = `
            <div class="modal-overlay" id="broadcastModal" style="display: none;">
                <div class="modal">
                    <div class="modal-header">
                        <div class="modal-title">
                            <i class="fas fa-broadcast-tower"></i>
                            Broadcast Ride
                        </div>
                        <button class="modal-close" onclick="ModalManager.hide('broadcast')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-content">
                        <div class="location-inputs">
                            <div class="location-input">
                                <i class="fas fa-map-marker-alt"></i>
                                <input type="text" id="broadcastPickup" placeholder="Pickup location" readonly>
                            </div>
                            <div class="location-input">
                                <i class="fas fa-flag"></i>
                                <input type="text" id="broadcastDestination" placeholder="Destination" readonly>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Add Referral Codes to Broadcast To</label>
                            <div class="input-with-button">
                                <input type="text" id="broadcastReferralCode" placeholder="Enter referral code">
                                <button class="btn btn-primary" onclick="BroadcastRideManager.addBroadcastRecipient()">
                                    <i class="fas fa-plus"></i> Add
                                </button>
                            </div>
                        </div>
                        
                        <div class="broadcast-recipients" id="broadcastRecipientsList">
                            <!-- Recipients will be added here -->
                        </div>
                        
                        <div class="broadcast-info">
                            <div class="info-item">
                                <i class="fas fa-info-circle"></i>
                                <span>Recipients can see your location and track your ride in real-time</span>
                            </div>
                        </div>
                        
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="BroadcastRideManager.startBroadcast()">
                                <i class="fas fa-broadcast-tower"></i>
                                Start Broadcasting
                            </button>
                            <button class="btn btn-secondary" onclick="ModalManager.hide('broadcast')">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
    },
    
    showBroadcastModal() {
        if (!AppState.pickup || !AppState.destination) {
            EnhancedUIUpdater.showToast('Please set pickup and destination first', 'warning');
            return;
        }
        
        // Set pickup and destination in modal
        document.getElementById('broadcastPickup').value = AppState.pickup.name;
        document.getElementById('broadcastDestination').value = AppState.destination.name;
        
        ModalManager.show('broadcast');
        this.updateBroadcastRecipientsList();
    },
    
    async addBroadcastRecipient() {
        const referralCodeInput = document.getElementById('broadcastReferralCode');
        const referralCode = referralCodeInput.value.trim();
        
        if (!referralCode) {
            EnhancedUIUpdater.showToast('Please enter a referral code', 'warning');
            return;
        }
        
        // Check if recipient already added
        if (AppState.broadcastRecipients.some(recipient => recipient.code === referralCode)) {
            EnhancedUIUpdater.showToast('Recipient already added', 'warning');
            return;
        }
        
        // Find user by referral code
        try {
            const recipientData = await FirebaseManager.findUserByReferralCode(referralCode);
            
            if (recipientData && recipientData.id !== AppState.currentUser.uid) {
                const recipient = {
                    code: referralCode,
                    name: recipientData.name,
                    userId: recipientData.id,
                    status: 'pending'
                };
                
                AppState.broadcastRecipients.push(recipient);
                this.updateBroadcastRecipientsList();
                
                referralCodeInput.value = '';
                EnhancedUIUpdater.showToast(`${recipient.name} added to broadcast`, 'success');
            } else {
                EnhancedUIUpdater.showToast('Invalid referral code or cannot add yourself', 'error');
            }
        } catch (error) {
            console.error('Error adding broadcast recipient:', error);
            EnhancedUIUpdater.showToast('Error adding recipient', 'error');
        }
    },
    
    updateBroadcastRecipientsList() {
        const container = document.getElementById('broadcastRecipientsList');
        if (!container) return;
        
        container.innerHTML = '';
        
        if (AppState.broadcastRecipients.length === 0) {
            container.innerHTML = '<div class="empty-list">No recipients added yet</div>';
            return;
        }
        
        AppState.broadcastRecipients.forEach((recipient, index) => {
            const recipientElement = document.createElement('div');
            recipientElement.className = 'broadcast-recipient-item';
            recipientElement.innerHTML = `
                <div class="recipient-info">
                    <div class="recipient-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div>
                        <div class="recipient-name">${recipient.name}</div>
                        <div class="recipient-status ${recipient.status}">
                            ${recipient.status === 'pending' ? 'Pending' : 'Joined'}
                        </div>
                    </div>
                </div>
                <button class="remove-recipient" onclick="BroadcastRideManager.removeBroadcastRecipient('${recipient.code}')">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(recipientElement);
        });
    },
    
    removeBroadcastRecipient(recipientCode) {
        AppState.broadcastRecipients = AppState.broadcastRecipients.filter(
            recipient => recipient.code !== recipientCode
        );
        this.updateBroadcastRecipientsList();
    },
    
    async startBroadcast() {
        if (!AppState.pickup || !AppState.destination) {
            EnhancedUIUpdater.showToast('Please set pickup and destination', 'warning');
            return;
        }
        
        if (AppState.broadcastRecipients.length === 0) {
            EnhancedUIUpdater.showToast('Please add at least one recipient', 'warning');
            return;
        }
        
        const broadcastData = {
            pickup: AppState.pickup,
            destination: AppState.destination,
            rideType: AppState.selectedRideType,
            estimatedFare: AppState.rideFare,
            hostId: AppState.currentUser.uid,
            hostName: AppState.userData.name,
            recipients: AppState.broadcastRecipients,
            status: 'active',
            timestamp: Date.now()
        };
        
        try {
            const broadcastId = await FirebaseManager.createBroadcast(broadcastData);
            
            // Send invitations to all recipients
            AppState.broadcastRecipients.forEach(recipient => {
                FirebaseManager.sendBroadcastInvitation(broadcastId, recipient.userId, broadcastData);
            });
            
            ModalManager.hide('broadcast');
            EnhancedUIUpdater.showToast('Broadcast started successfully', 'success');
            
            // Show broadcast status
            this.showBroadcastStatus(broadcastId);
            
        } catch (error) {
            console.error('Error starting broadcast:', error);
            EnhancedUIUpdater.showToast('Error starting broadcast', 'error');
        }
    },
    
    showBroadcastStatus(broadcastId) {
        // Create status element
        const statusHTML = `
            <div class="broadcast-status" id="broadcastStatus">
                <div class="status-header">
                    <i class="fas fa-broadcast-tower"></i>
                    <span>Broadcasting Ride</span>
                </div>
                <div class="status-recipients" id="broadcastStatusRecipients">
                    <!-- Recipient status will be updated here -->
                </div>
                <div class="status-actions">
                    <button class="btn btn-danger" onclick="BroadcastRideManager.stopBroadcast('${broadcastId}')">
                        <i class="fas fa-stop"></i>
                        Stop Broadcast
                    </button>
                </div>
            </div>
        `;
        
        const mainPanel = document.getElementById('mainPanel');
        if (mainPanel) {
            const existingStatus = document.getElementById('broadcastStatus');
            if (existingStatus) {
                existingStatus.remove();
            }
            
            mainPanel.insertAdjacentHTML('beforeend', statusHTML);
            
            // Start listening for broadcast updates
            this.listenForBroadcastUpdates(broadcastId);
        }
    },
    
    listenForBroadcastUpdates(broadcastId) {
        const broadcastRef = database.ref(`broadcasts/${broadcastId}`);
        
        broadcastRef.on('value', (snapshot) => {
            const broadcast = snapshot.val();
            if (broadcast) {
                this.updateBroadcastStatus(broadcast);
            }
        });
    },
    
    updateBroadcastStatus(broadcast) {
        const statusContainer = document.getElementById('broadcastStatusRecipients');
        if (!statusContainer) return;
        
        statusContainer.innerHTML = '';
        
        if (broadcast.recipients) {
            Object.values(broadcast.recipients).forEach(recipient => {
                const recipientElement = document.createElement('div');
                recipientElement.className = 'broadcast-status-recipient';
                recipientElement.innerHTML = `
                    <div class="recipient-name">${recipient.name}</div>
                    <div class="recipient-status ${recipient.status}">
                        ${recipient.status === 'watching' ? 'Watching' : 'Not Watching'}
                    </div>
                `;
                statusContainer.appendChild(recipientElement);
            });
        }
    },
    
    async stopBroadcast(broadcastId) {
        try {
            await FirebaseManager.stopBroadcast(broadcastId);
            EnhancedUIUpdater.showToast('Broadcast stopped', 'success');
            
            // Remove status element
            const statusElement = document.getElementById('broadcastStatus');
            if (statusElement) {
                statusElement.remove();
            }
            
            // Clear broadcast recipients
            AppState.broadcastRecipients = [];
        } catch (error) {
            console.error('Error stopping broadcast:', error);
            EnhancedUIUpdater.showToast('Error stopping broadcast', 'error');
        }
    },
    
    async handleBroadcastInvitation(invitationId, response) {
        try {
            await FirebaseManager.respondToBroadcastInvitation(invitationId, response);
            
            if (response === 'accept') {
                EnhancedUIUpdater.showToast('Now watching broadcast', 'success');
                this.showBroadcastView(invitationId);
            } else {
                EnhancedUIUpdater.showToast('Broadcast invitation declined', 'info');
            }
        } catch (error) {
            console.error('Error handling broadcast invitation:', error);
            EnhancedUIUpdater.showToast('Error processing invitation', 'error');
        }
    },
    
    showBroadcastView(broadcastId) {
        // Create broadcast view
        const viewHTML = `
            <div class="broadcast-view" id="broadcastView">
                <div class="view-header">
                    <i class="fas fa-broadcast-tower"></i>
                    <span>Watching Ride</span>
                    <button class="close-view" onclick="BroadcastRideManager.closeBroadcastView()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="view-content" id="broadcastViewContent">
                    <div class="loading">Loading broadcast...</div>
                </div>
            </div>
        `;
        
        const mapContainer = document.getElementById('map');
        if (mapContainer) {
            const existingView = document.getElementById('broadcastView');
            if (existingView) {
                existingView.remove();
            }
            
            mapContainer.insertAdjacentHTML('beforeend', viewHTML);
            
            // Start listening to broadcast updates
            this.listenToBroadcastRide(broadcastId);
        }
    },
    
    listenToBroadcastRide(broadcastId) {
        const broadcastRef = database.ref(`broadcasts/${broadcastId}`);
        
        broadcastRef.on('value', (snapshot) => {
            const broadcast = snapshot.val();
            if (broadcast) {
                this.updateBroadcastView(broadcast);
            }
        });
    },
    
    updateBroadcastView(broadcast) {
        const viewContent = document.getElementById('broadcastViewContent');
        if (!viewContent) return;
        
        viewContent.innerHTML = `
            <div class="broadcast-info">
                <div class="info-row">
                    <i class="fas fa-user"></i>
                    <span>${broadcast.hostName}</span>
                </div>
                <div class="info-row">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>${broadcast.pickup.name}</span>
                </div>
                <div class="info-row">
                    <i class="fas fa-flag"></i>
                    <span>${broadcast.destination.name}</span>
                </div>
                <div class="info-row">
                    <i class="fas fa-road"></i>
                    <span>${broadcast.distance ? broadcast.distance.toFixed(1) + ' km' : 'Calculating...'}</span>
                </div>
                <div class="info-row">
                    <i class="fas fa-money-bill-wave"></i>
                    <span>ZMW ${broadcast.estimatedFare ? broadcast.estimatedFare.toFixed(2) : '0.00'}</span>
                </div>
            </div>
            <div class="broadcast-status-indicator">
                <div class="status-dot active"></div>
                <span>Ride in progress</span>
            </div>
        `;
    },
    
    closeBroadcastView() {
        const broadcastView = document.getElementById('broadcastView');
        if (broadcastView) {
            broadcastView.remove();
        }
    }
};

// ============================================
// EMERGENCY MANAGER
// ============================================
const EmergencyManager = {
    init() {
        console.log('Emergency Manager initialized');
        this.setupEmergencyUI();
    },
    
    setupEmergencyUI() {
        // Setup emergency service buttons
        document.querySelectorAll('.emergency-service').forEach(service => {
            service.addEventListener('click', (e) => {
                const type = service.dataset.type;
                if (type === 'sos') {
                    this.showSOSModal();
                } else {
                    this.showEmergencyModal(type);
                }
            });
        });
        
        // Create emergency modal
        this.createEmergencyModal();
        
        // Create SOS modal
        this.createSOSModal();
    },
    
    createEmergencyModal() {
        const modalHTML = `
            <div class="modal-overlay" id="emergencyModal" style="display: none;">
                <div class="modal emergency-modal">
                    <div class="modal-header">
                        <div class="modal-title">
                            <i class="fas fa-ambulance"></i>
                            <span id="emergencyServiceTitle">Emergency Service</span>
                        </div>
                        <button class="modal-close" onclick="ModalManager.hide('emergency')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-content">
                        <div class="emergency-service-info">
                            <div class="service-type" id="emergencyServiceType">
                                <!-- Service type will be set here -->
                            </div>
                            <div class="service-description" id="emergencyServiceDescription">
                                <!-- Description will be set here -->
                            </div>
                        </div>
                        
                        <div class="emergency-reasons" id="emergencyReasons">
                            <!-- Reasons will be loaded based on service type -->
                        </div>
                        
                        <div class="emergency-stations" id="emergencyStationsList">
                            <!-- Stations will be loaded here -->
                        </div>
                        
                        <div class="emergency-price">
                            <div class="price-label">Estimated Fare</div>
                            <div class="price-amount" id="emergencyPriceAmount">ZMW 0.00</div>
                        </div>
                        
                        <div class="action-buttons">
                            <button class="btn btn-danger" onclick="EmergencyManager.requestEmergency()">
                                <i class="fas fa-exclamation-triangle"></i>
                                Request Emergency Service
                            </button>
                            <button class="btn btn-secondary" onclick="ModalManager.hide('emergency')">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
    },
    
    createSOSModal() {
        const modalHTML = `
            <div class="modal-overlay" id="sosModal" style="display: none;">
                <div class="modal">
                    <div class="modal-header">
                        <div class="modal-title">
                            <i class="fas fa-exclamation-triangle"></i>
                            SOS Emergency Setup
                        </div>
                        <button class="modal-close" onclick="ModalManager.hide('sos')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-content">
                        <div class="form-group">
                            <label class="form-label">Primary Emergency Contact</label>
                            <div class="form-row">
                                <input type="text" id="sosContact1Name" placeholder="Contact name">
                                <input type="tel" id="sosContact1Phone" placeholder="Phone number">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Secondary Emergency Contact (Optional)</label>
                            <div class="form-row">
                                <input type="text" id="sosContact2Name" placeholder="Contact name">
                                <input type="tel" id="sosContact2Phone" placeholder="Phone number">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Emergency Message</label>
                            <textarea id="sosMessage" rows="3">
I need help! My current location and ride details will be shared with you.
                            </textarea>
                        </div>
                        
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="EmergencyManager.saveSOSConfig()">
                                <i class="fas fa-save"></i>
                                Save SOS Setup
                            </button>
                            <button class="btn btn-secondary" onclick="ModalManager.hide('sos')">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
    },
    
    async showEmergencyModal(serviceType) {
        if (!AppState.currentCity) {
            EnhancedUIUpdater.showToast('Please wait while we detect your city', 'warning');
            return;
        }
        
        // Set service type
        AppState.emergencyMode = true;
        AppState.emergencyServiceType = serviceType;
        
        // Update modal title
        let serviceTitle = '';
        let serviceDescription = '';
        
        switch(serviceType) {
            case 'police':
                serviceTitle = 'Police Emergency';
                serviceDescription = 'Request police assistance with transport';
                break;
            case 'fire':
                serviceTitle = 'Fire Brigade';
                serviceDescription = 'Request fire emergency response';
                break;
            case 'medical':
                serviceTitle = 'Medical Emergency';
                serviceDescription = 'Request ambulance or medical transport';
                break;
        }
        
        document.getElementById('emergencyServiceTitle').textContent = serviceTitle;
        document.getElementById('emergencyServiceType').textContent = serviceTitle;
        document.getElementById('emergencyServiceDescription').textContent = serviceDescription;
        
        // Load emergency stations
        await this.loadEmergencyStations(serviceType);
        
        // Load emergency reasons
        this.loadEmergencyReasons(serviceType);
        
        ModalManager.show('emergency');
    },
    
    showSOSModal() {
        // Load existing SOS config if available
        if (AppState.sosConfig) {
            document.getElementById('sosContact1Name').value = AppState.sosConfig.contact1Name || '';
            document.getElementById('sosContact1Phone').value = AppState.sosConfig.contact1Phone || '';
            document.getElementById('sosContact2Name').value = AppState.sosConfig.contact2Name || '';
            document.getElementById('sosContact2Phone').value = AppState.sosConfig.contact2Phone || '';
            document.getElementById('sosMessage').value = AppState.sosConfig.message || '';
        }
        
        ModalManager.show('sos');
    },
    
    async loadEmergencyStations(serviceType) {
        const stationsContainer = document.getElementById('emergencyStationsList');
        if (!stationsContainer) return;
        
        stationsContainer.innerHTML = '<div class="loading">Loading stations...</div>';
        
        try {
            const stations = await EnhancedSearchEngine.searchEmergencyStations(
                serviceType,
                AppState.currentCity
            );
            
            if (stations.length === 0) {
                stationsContainer.innerHTML = '<div class="no-stations">No stations found in your area</div>';
                return;
            }
            
            stationsContainer.innerHTML = '';
            
            stations.forEach((station, index) => {
                const stationElement = document.createElement('div');
                stationElement.className = 'emergency-station-item';
                stationElement.dataset.index = index;
                stationElement.dataset.lat = station.lat;
                stationElement.dataset.lng = station.lng;
                
                stationElement.innerHTML = `
                    <div class="station-header">
                        <div class="station-name">${station.name}</div>
                        <div class="station-distance">${station.distance.toFixed(1)} km</div>
                    </div>
                    <div class="station-address">${station.address}</div>
                `;
                
                stationElement.addEventListener('click', () => {
                    this.selectEmergencyStation(station, index);
                });
                
                stationsContainer.appendChild(stationElement);
            });
            
            // Select first station by default
            if (stations.length > 0) {
                this.selectEmergencyStation(stations[0], 0);
            }
            
        } catch (error) {
            console.error('Error loading emergency stations:', error);
            stationsContainer.innerHTML = '<div class="error">Error loading stations</div>';
        }
    },
    
    loadEmergencyReasons(serviceType) {
        const reasonsContainer = document.getElementById('emergencyReasons');
        if (!reasonsContainer) return;
        
        let reasons = [];
        
        switch(serviceType) {
            case 'police':
                reasons = [
                    'Accident',
                    'Crime in progress',
                    'Assault',
                    'Suspicious activity',
                    'Other emergency'
                ];
                break;
            case 'fire':
                reasons = [
                    'Fire emergency',
                    'Gas leak',
                    'Electrical fire',
                    'Building collapse',
                    'Other emergency'
                ];
                break;
            case 'medical':
                reasons = [
                    'Medical emergency',
                    'Accident with injuries',
                    'Heart attack',
                    'Difficulty breathing',
                    'Other emergency'
                ];
                break;
        }
        
        reasonsContainer.innerHTML = `
            <div class="reasons-header">Select Emergency Reason</div>
            <div class="reasons-list">
                ${reasons.map(reason => `
                    <div class="reason-item" data-reason="${reason}">
                        <i class="fas fa-circle"></i>
                        <span>${reason}</span>
                    </div>
                `).join('')}
            </div>
            <div class="other-reason" id="otherReasonContainer" style="display: none;">
                <textarea id="otherReasonText" placeholder="Please describe the emergency..."></textarea>
            </div>
        `;
        
        // Add event listeners to reason items
        document.querySelectorAll('.reason-item').forEach(item => {
            item.addEventListener('click', () => {
                document.querySelectorAll('.reason-item').forEach(i => {
                    i.classList.remove('selected');
                });
                item.classList.add('selected');
                
                const reason = item.dataset.reason;
                AppState.emergencyReason = reason;
                
                // Show other reason textarea if "Other emergency" is selected
                const otherContainer = document.getElementById('otherReasonContainer');
                if (reason === 'Other emergency') {
                    otherContainer.style.display = 'block';
                } else {
                    otherContainer.style.display = 'none';
                }
            });
        });
    },
    
    selectEmergencyStation(station, index) {
        // Update selected station
        document.querySelectorAll('.emergency-station-item').forEach(item => {
            item.classList.remove('selected');
        });
        
        const selectedItem = document.querySelector(`.emergency-station-item[data-index="${index}"]`);
        if (selectedItem) {
            selectedItem.classList.add('selected');
        }
        
        AppState.selectedEmergencyStation = station;
        
        // Calculate and update price
        this.updateEmergencyPrice(station);
        
        // Add marker to map
        MapManager.addEmergencyStationMarker(station, AppState.emergencyServiceType);
        
        // Center map on station
        MapManager.centerOnLocation(station.lat, station.lng, 14);
    },
    
    updateEmergencyPrice(station) {
        if (!AppState.userLocation) return;
        
        const distance = EnhancedSearchEngine.calculateDistance(
            AppState.userLocation.lat, AppState.userLocation.lng,
            station.lat, station.lng
        );
        
        const fare = PriceCalculator.calculateEmergencyFare(
            distance,
            AppState.emergencyServiceType
        );
        
        document.getElementById('emergencyPriceAmount').textContent = `ZMW ${fare.toFixed(2)}`;
        AppState.emergencyFare = fare;
    },
    
    async requestEmergency() {
        if (!AppState.selectedEmergencyStation) {
            EnhancedUIUpdater.showToast('Please select an emergency station', 'warning');
            return;
        }
        
        if (!AppState.emergencyReason) {
            EnhancedUIUpdater.showToast('Please select an emergency reason', 'warning');
            return;
        }
        
        // If other reason is selected, get the text
        let reason = AppState.emergencyReason;
        if (reason === 'Other emergency') {
            const otherReasonText = document.getElementById('otherReasonText').value.trim();
            if (!otherReasonText) {
                EnhancedUIUpdater.showToast('Please describe the emergency', 'warning');
                return;
            }
            reason = `Other: ${otherReasonText}`;
        }
        
        const emergencyData = {
            serviceType: AppState.emergencyServiceType,
            station: AppState.selectedEmergencyStation,
            reason: reason,
            fare: AppState.emergencyFare,
            userLocation: AppState.userLocation,
            userCity: AppState.currentCity,
            timestamp: Date.now(),
            status: 'requested',
            userId: AppState.currentUser.uid,
            userName: AppState.userData.name
        };
        
        try {
            await FirebaseManager.requestEmergency(emergencyData);
            
            ModalManager.hide('emergency');
            EnhancedUIUpdater.showToast('Emergency service requested', 'success');
            
            // Show emergency ride info
            this.showEmergencyRideInfo(emergencyData);
            
        } catch (error) {
            console.error('Error requesting emergency:', error);
            EnhancedUIUpdater.showToast('Error requesting emergency service', 'error');
        }
    },
    
    showEmergencyRideInfo(emergencyData) {
        // Create emergency ride info panel
        const infoHTML = `
            <div class="emergency-ride-info" id="emergencyRideInfo">
                <div class="info-header">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Emergency Ride in Progress</span>
                </div>
                <div class="info-content">
                    <div class="info-row">
                        <i class="fas fa-${AppState.emergencyServiceType === 'police' ? 'shield-alt' : 
                                         AppState.emergencyServiceType === 'fire' ? 'fire-extinguisher' : 'ambulance'}"></i>
                        <span>${emergencyData.serviceType.toUpperCase()} Service</span>
                    </div>
                    <div class="info-row">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>To: ${emergencyData.station.name}</span>
                    </div>
                    <div class="info-row">
                        <i class="fas fa-exclamation-circle"></i>
                        <span>Reason: ${emergencyData.reason}</span>
                    </div>
                    <div class="info-row">
                        <i class="fas fa-money-bill-wave"></i>
                        <span>Fare: ZMW ${emergencyData.fare.toFixed(2)}</span>
                    </div>
                </div>
                <div class="info-actions">
                    <button class="btn btn-danger" onclick="EmergencyManager.cancelEmergency()">
                        <i class="fas fa-times"></i>
                        Cancel Emergency
                    </button>
                </div>
            </div>
        `;
        
        const mainPanel = document.getElementById('mainPanel');
        if (mainPanel) {
            const existingInfo = document.getElementById('emergencyRideInfo');
            if (existingInfo) {
                existingInfo.remove();
            }
            
            mainPanel.insertAdjacentHTML('beforeend', infoHTML);
        }
    },
    
    async cancelEmergency() {
        try {
            await FirebaseManager.cancelEmergency();
            EnhancedUIUpdater.showToast('Emergency cancelled', 'success');
            
            const emergencyInfo = document.getElementById('emergencyRideInfo');
            if (emergencyInfo) {
                emergencyInfo.remove();
            }
            
            AppState.emergencyMode = false;
        } catch (error) {
            console.error('Error cancelling emergency:', error);
            EnhancedUIUpdater.showToast('Error cancelling emergency', 'error');
        }
    },
    
    async saveSOSConfig() {
        const contact1Name = document.getElementById('sosContact1Name').value.trim();
        const contact1Phone = document.getElementById('sosContact1Phone').value.trim();
        const contact2Name = document.getElementById('sosContact2Name').value.trim();
        const contact2Phone = document.getElementById('sosContact2Phone').value.trim();
        const message = document.getElementById('sosMessage').value.trim();
        
        if (!contact1Name || !contact1Phone) {
            EnhancedUIUpdater.showToast('Primary contact details are required', 'warning');
            return;
        }
        
        const sosConfig = {
            contact1Name: contact1Name,
            contact1Phone: contact1Phone,
            contact2Name: contact2Name || '',
            contact2Phone: contact2Phone || '',
            message: message || 'I need help! My current location and ride details will be shared with you.',
            updatedAt: Date.now()
        };
        
        try {
            await FirebaseManager.saveSOSConfig(sosConfig);
            
            AppState.sosConfig = sosConfig;
            ModalManager.hide('sos');
            EnhancedUIUpdater.showToast('SOS configuration saved', 'success');
            
        } catch (error) {
            console.error('Error saving SOS config:', error);
            EnhancedUIUpdater.showToast('Error saving SOS configuration', 'error');
        }
    },
    
    triggerSOS() {
        if (!AppState.sosConfig) {
            EnhancedUIUpdater.showToast('Please setup SOS contacts first', 'warning');
            this.showSOSModal();
            return;
        }
        
        if (!AppState.currentRide) {
            EnhancedUIUpdater.showToast('No active ride to report SOS for', 'warning');
            return;
        }
        
        if (confirm('Are you sure you want to send an SOS alert to your emergency contacts?')) {
            const sosData = {
                contacts: AppState.sosConfig,
                location: AppState.userLocation,
                rideDetails: AppState.currentRide,
                timestamp: Date.now(),
                city: AppState.currentCity
            };
            
            FirebaseManager.sendSOSAlert(sosData)
                .then(() => {
                    EnhancedUIUpdater.showToast('SOS alert sent to emergency contacts', 'success');
                })
                .catch(error => {
                    console.error('SOS error:', error);
                    EnhancedUIUpdater.showToast('Error sending SOS alert', 'error');
                });
        }
    }
};

// ============================================
// SHOPPING MANAGER
// ============================================
const ShoppingManager = {
    init() {
        console.log('Shopping Manager initialized');
        this.setupShoppingUI();
        this.setupShoppingItems();
    },
    
    setupShoppingUI() {
        // Create shopping categories overlay
        this.createShoppingCategories();
        
        // Setup shop name input
        const shopNameInput = document.getElementById('shopName');
        if (shopNameInput) {
            shopNameInput.addEventListener('focus', () => {
                this.showShoppingCategories();
            });
        }
        
        // Setup shopping items
        this.setupShoppingItems();
    },
    
    createShoppingCategories() {
        const categoriesHTML = `
            <div class="shopping-categories-overlay" id="shoppingCategories" style="display: none;">
                <div class="categories-header">
                    <i class="fas fa-store"></i>
                    <span>Select Shop Type</span>
                    <button class="close-categories" onclick="ShoppingManager.hideCategories()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="categories-grid">
                    <div class="category-item" data-category="restaurant">
                        <div class="category-icon">
                            <i class="fas fa-utensils"></i>
                        </div>
                        <div class="category-name">Restaurants</div>
                    </div>
                    <div class="category-item" data-category="pharmacy">
                        <div class="category-icon">
                            <i class="fas fa-pills"></i>
                        </div>
                        <div class="category-name">Pharmacies</div>
                    </div>
                    <div class="category-item" data-category="supermarket">
                        <div class="category-icon">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <div class="category-name">Supermarkets</div>
                    </div>
                    <div class="category-item" data-category="mall">
                        <div class="category-icon">
                            <i class="fas fa-store"></i>
                        </div>
                        <div class="category-name">Shopping Malls</div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', categoriesHTML);
        
        // Add event listeners to categories
        document.querySelectorAll('.category-item').forEach(item => {
            item.addEventListener('click', () => {
                const category = item.dataset.category;
                this.showShopsForCategory(category);
            });
        });
    },
    
    showShoppingCategories() {
        const categories = document.getElementById('shoppingCategories');
        if (categories) {
            categories.style.display = 'block';
        }
    },
    
    hideCategories() {
        const categories = document.getElementById('shoppingCategories');
        if (categories) {
            categories.style.display = 'none';
        }
    },
    
    async showShopsForCategory(category) {
        if (!AppState.currentCity) {
            EnhancedUIUpdater.showToast('Please wait while we detect your city', 'warning');
            return;
        }
        
        this.hideCategories();
        
        // Show loading
        const shopNameInput = document.getElementById('shopName');
        if (shopNameInput) {
            shopNameInput.value = 'Loading shops...';
        }
        
        try {
            const shops = await EnhancedSearchEngine.searchShoppingLocations(
                category,
                AppState.currentCity
            );
            
            this.showShopsList(shops, category);
            
        } catch (error) {
            console.error('Error loading shops:', error);
            EnhancedUIUpdater.showToast('Error loading shops', 'error');
            
            if (shopNameInput) {
                shopNameInput.value = '';
            }
        }
    },
    
    showShopsList(shops, category) {
        const shopsHTML = `
            <div class="shops-overlay" id="shopsOverlay">
                <div class="shops-header">
                    <i class="fas ${AppState.shoppingCategories[category].icon}"></i>
                    <span>${AppState.shoppingCategories[category].name}</span>
                    <button class="close-shops" onclick="ShoppingManager.hideShopsList()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="shops-list">
                    ${shops.length === 0 ? 
                        '<div class="no-shops">No shops found in your area</div>' :
                        shops.map((shop, index) => `
                            <div class="shop-item" data-index="${index}">
                                <div class="shop-name">${shop.name}</div>
                                <div class="shop-address">${shop.address}</div>
                                <div class="shop-distance">${shop.distance.toFixed(1)} km</div>
                            </div>
                        `).join('')
                    }
                </div>
            </div>
        `;
        
        const existingOverlay = document.getElementById('shopsOverlay');
        if (existingOverlay) {
            existingOverlay.remove();
        }
        
        document.body.insertAdjacentHTML('beforeend', shopsHTML);
        
        // Add event listeners to shop items
        document.querySelectorAll('.shop-item').forEach(item => {
            item.addEventListener('click', () => {
                const index = item.dataset.index;
                this.selectShop(shops[index], category);
            });
        });
    },
    
    hideShopsList() {
        const shopsOverlay = document.getElementById('shopsOverlay');
        if (shopsOverlay) {
            shopsOverlay.remove();
        }
    },
    
    selectShop(shop, category) {
        // Update shop name input
        const shopNameInput = document.getElementById('shopName');
        if (shopNameInput) {
            shopNameInput.value = shop.name;
            shopNameInput.dataset.lat = shop.lat;
            shopNameInput.dataset.lng = shop.lng;
            shopNameInput.dataset.address = shop.address;
        }
        
        // Update shop location input
        const shopLocationInput = document.getElementById('shopLocation');
        if (shopLocationInput) {
            shopLocationInput.value = shop.address;
        }
        
        // Update pickup location
        AppState.shoppingPickup = shop;
        
        this.hideShopsList();
        
        EnhancedUIUpdater.showToast(`${shop.name} selected`, 'success');
    },
    
    setupShoppingItems() {
        const addItemBtn = document.getElementById('addItemBtn');
        const shoppingItems = document.getElementById('shoppingItems');
        
        if (!addItemBtn || !shoppingItems) return;
        
        // Setup existing items
        const existingItems = shoppingItems.querySelectorAll('.item-entry');
        existingItems.forEach((item, index) => {
            this.setupItemEvents(item, index);
        });
        
        // Setup add item button
        addItemBtn.addEventListener('click', () => {
            this.addShoppingItem();
        });
    },
    
    addShoppingItem() {
        const shoppingItems = document.getElementById('shoppingItems');
        if (!shoppingItems) return;
        
        const itemCount = shoppingItems.querySelectorAll('.item-entry').length;
        const newIndex = itemCount;
        
        const itemHTML = `
            <div class="item-entry" data-index="${newIndex}">
                <input type="text" class="item-input" placeholder="Item name">
                <button class="remove-item" type="button">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        shoppingItems.insertAdjacentHTML('beforeend', itemHTML);
        
        const newItem = shoppingItems.querySelector(`.item-entry[data-index="${newIndex}"]`);
        this.setupItemEvents(newItem, newIndex);
    },
    
    setupItemEvents(itemElement, index) {
        const removeBtn = itemElement.querySelector('.remove-item');
        const itemInput = itemElement.querySelector('.item-input');
        
        if (removeBtn) {
            removeBtn.addEventListener('click', () => {
                this.removeShoppingItem(index);
            });
        }
        
        if (itemInput) {
            itemInput.addEventListener('input', () => {
                this.updateShoppingPrice();
            });
        }
    },
    
    removeShoppingItem(index) {
        const shoppingItems = document.getElementById('shoppingItems');
        if (!shoppingItems) return;
        
        const itemToRemove = shoppingItems.querySelector(`.item-entry[data-index="${index}"]`);
        if (itemToRemove) {
            itemToRemove.remove();
        }
        
        // Re-index remaining items
        const remainingItems = shoppingItems.querySelectorAll('.item-entry');
        remainingItems.forEach((item, newIndex) => {
            item.dataset.index = newIndex;
        });
        
        this.updateShoppingPrice();
    },
    
    updateShoppingPrice() {
        if (!AppState.pickup || !AppState.destination) return;
        
        const distance = PriceCalculator.calculateDistance(
            AppState.pickup.lat, AppState.pickup.lng,
            AppState.destination.lat, AppState.destination.lng
        );
        
        const itemCount = document.querySelectorAll('.item-input').length;
        const fare = PriceCalculator.calculateShoppingFare(distance) + (itemCount * 5);
        
        const fareDisplay = document.getElementById('shoppingFareDisplay');
        const fareAmount = document.getElementById('shoppingFare');
        const distanceElement = document.getElementById('shoppingDistance');
        const timeElement = document.getElementById('shoppingTime');
        
        if (fareDisplay) fareDisplay.style.display = 'block';
        if (fareAmount) fareAmount.textContent = `ZMW ${fare.toFixed(2)}`;
        if (distanceElement) distanceElement.textContent = `${distance.toFixed(1)} km`;
        if (timeElement) timeElement.textContent = `ETA: ${PriceCalculator.estimateTravelTime(distance) + 30} min`;
        
        AppState.rideFare = fare;
    },
    
    getShoppingItems() {
        const items = [];
        document.querySelectorAll('.item-input').forEach(input => {
            if (input.value.trim()) {
                items.push(input.value.trim());
            }
        });
        return items;
    },
    
    getShoppingInstructions() {
        const instructionsInput = document.getElementById('shoppingInstructions');
        return instructionsInput ? instructionsInput.value.trim() : '';
    },
    
    getShoppingBudget() {
        const budgetInput = document.getElementById('shoppingBudget');
        return budgetInput ? parseFloat(budgetInput.value) || 0 : 0;
    }
};

// ============================================
// SCHEDULED RIDE MANAGER
// ============================================
const ScheduledRideManager = {
    init() {
        console.log('Scheduled Ride Manager initialized');
        this.setupScheduledRideUI();
    },
    
    setupScheduledRideUI() {
        // Create schedule modal
        this.createScheduleModal();
        
        // Setup schedule button
        const scheduleBtn = document.querySelector('[data-option="schedule"]');
        if (scheduleBtn) {
            scheduleBtn.addEventListener('click', () => {
                this.showScheduleModal();
            });
        }
        
        // Load scheduled rides
        this.loadScheduledRides();
    },
    
    createScheduleModal() {
        const modalHTML = `
            <div class="modal-overlay" id="scheduleModal" style="display: none;">
                <div class="modal">
                    <div class="modal-header">
                        <div class="modal-title">
                            <i class="fas fa-calendar-alt"></i>
                            Schedule a Ride
                        </div>
                        <button class="modal-close" onclick="ModalManager.hide('schedule')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-content">
                        <div class="location-inputs">
                            <div class="location-input">
                                <i class="fas fa-map-marker-alt"></i>
                                <input type="text" id="schedulePickup" placeholder="Pickup location">
                            </div>
                            <div class="location-input">
                                <i class="fas fa-flag"></i>
                                <input type="text" id="scheduleDestination" placeholder="Destination">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="scheduleForSomeone">
                                <span>Booking for someone else</span>
                            </label>
                        </div>
                        
                        <div class="someone-else-details" id="someoneElseDetails" style="display: none;">
                            <div class="form-row">
                                <input type="text" id="scheduleRecipientName" placeholder="Recipient name">
                                <input type="tel" id="scheduleRecipientPhone" placeholder="Recipient phone">
                            </div>
                        </div>
                        
                        <div class="schedule-datetime">
                            <div class="form-group">
                                <label class="form-label">Date</label>
                                <input type="date" id="scheduleDate" min="">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Time</label>
                                <input type="time" id="scheduleTime">
                            </div>
                        </div>
                        
                        <div class="ride-type-selection">
                            <div class="ride-type-title">Select Ride Type</div>
                            <div class="ride-type-grid" id="scheduleRideTypeGrid">
                                <!-- Ride types will be loaded here -->
                            </div>
                        </div>
                        
                        <div class="schedule-price" id="schedulePriceDisplay" style="display: none;">
                            <div class="price-label">Estimated Fare</div>
                            <div class="price-amount" id="schedulePriceAmount">ZMW 0.00</div>
                        </div>
                        
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="ScheduledRideManager.confirmSchedule()">
                                <i class="fas fa-calendar-check"></i>
                                Schedule Ride
                            </button>
                            <button class="btn btn-secondary" onclick="ModalManager.hide('schedule')">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        
        // Setup event listeners
        this.setupScheduleModalEvents();
    },
    
    setupScheduleModalEvents() {
        // Setup for someone else checkbox
        const forSomeoneCheckbox = document.getElementById('scheduleForSomeone');
        if (forSomeoneCheckbox) {
            forSomeoneCheckbox.addEventListener('change', (e) => {
                const detailsContainer = document.getElementById('someoneElseDetails');
                if (detailsContainer) {
                    detailsContainer.style.display = e.target.checked ? 'block' : 'none';
                }
            });
        }
        
        // Setup date input min value
        const dateInput = document.getElementById('scheduleDate');
        if (dateInput) {
            const today = new Date().toISOString().split('T')[0];
            dateInput.min = today;
        }
        
        // Setup location inputs
        const pickupInput = document.getElementById('schedulePickup');
        const destinationInput = document.getElementById('scheduleDestination');
        
        if (pickupInput) {
            LocationInputManager.setupInput(pickupInput, 'pickup');
        }
        
        if (destinationInput) {
            LocationInputManager.setupInput(destinationInput, 'destination');
        }
    },
    
    showScheduleModal() {
        // Set current date and time as default
        const now = new Date();
        const dateInput = document.getElementById('scheduleDate');
        const timeInput = document.getElementById('scheduleTime');
        
        if (dateInput) {
            dateInput.value = now.toISOString().split('T')[0];
        }
        
        if (timeInput) {
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = (now.getMinutes() + 30).toString().padStart(2, '0'); // 30 minutes from now
            timeInput.value = `${hours}:${minutes}`;
        }
        
        // Load ride types
        this.loadScheduleRideTypes();
        
        ModalManager.show('schedule');
    },
    
    loadScheduleRideTypes() {
        const container = document.getElementById('scheduleRideTypeGrid');
        if (!container) return;
        
        container.innerHTML = '';
        
        Object.entries(AppState.rideTypes).forEach(([type, config]) => {
            const card = document.createElement('div');
            card.className = `ride-type-card ${type}`;
            card.dataset.type = type;
            
            // Calculate fare for a sample distance (5km)
            const sampleFare = PriceCalculator.calculateRideFare(5, type);
            
            card.innerHTML = `
                <div class="ride-type-icon">
                    <i class="fas ${config.icon}"></i>
                </div>
                <div class="ride-type-name">${config.name}</div>
                <div class="ride-type-price">ZMW ${sampleFare.toFixed(2)}</div>
            `;
            
            card.addEventListener('click', () => {
                this.selectScheduleRideType(type);
            });
            
            container.appendChild(card);
        });
        
        // Select standard by default
        this.selectScheduleRideType('standard');
    },
    
    selectScheduleRideType(type) {
        document.querySelectorAll('#scheduleRideTypeGrid .ride-type-card').forEach(card => {
            card.classList.remove('selected');
        });
        
        const selectedCard = document.querySelector(`#scheduleRideTypeGrid .ride-type-card[data-type="${type}"]`);
        if (selectedCard) {
            selectedCard.classList.add('selected');
            AppState.selectedRideType = type;
        }
        
        // Update price if locations are set
        this.updateSchedulePrice();
    },
    
    updateSchedulePrice() {
        const pickupInput = document.getElementById('schedulePickup');
        const destinationInput = document.getElementById('scheduleDestination');
        
        if (!pickupInput || !destinationInput) return;
        
        const pickupLat = pickupInput.dataset.lat;
        const pickupLng = pickupInput.dataset.lng;
        const destLat = destinationInput.dataset.lat;
        const destLng = destinationInput.dataset.lng;
        
        if (pickupLat && pickupLng && destLat && destLng) {
            const distance = PriceCalculator.calculateDistance(
                parseFloat(pickupLat), parseFloat(pickupLng),
                parseFloat(destLat), parseFloat(destLng)
            );
            
            const fare = PriceCalculator.calculateRideFare(distance, AppState.selectedRideType);
            
            const priceDisplay = document.getElementById('schedulePriceDisplay');
            const priceAmount = document.getElementById('schedulePriceAmount');
            
            if (priceDisplay) priceDisplay.style.display = 'block';
            if (priceAmount) priceAmount.textContent = `ZMW ${fare.toFixed(2)}`;
        }
    },
    
    async confirmSchedule() {
        const pickupInput = document.getElementById('schedulePickup');
        const destinationInput = document.getElementById('scheduleDestination');
        const dateInput = document.getElementById('scheduleDate');
        const timeInput = document.getElementById('scheduleTime');
        
        if (!pickupInput || !destinationInput || !dateInput || !timeInput) {
            EnhancedUIUpdater.showToast('Please fill all required fields', 'warning');
            return;
        }
        
        const pickupLat = pickupInput.dataset.lat;
        const pickupLng = pickupInput.dataset.lng;
        const destLat = destinationInput.dataset.lat;
        const destLng = destinationInput.dataset.lng;
        
        if (!pickupLat || !pickupLng || !destLat || !destLng) {
            EnhancedUIUpdater.showToast('Please select valid pickup and destination locations', 'warning');
            return;
        }
        
        const scheduleDate = new Date(`${dateInput.value}T${timeInput.value}`);
        const now = new Date();
        
        if (scheduleDate <= now) {
            EnhancedUIUpdater.showToast('Please select a future date and time', 'warning');
            return;
        }
        
        // Calculate distance and fare
        const distance = PriceCalculator.calculateDistance(
            parseFloat(pickupLat), parseFloat(pickupLng),
            parseFloat(destLat), parseFloat(destLng)
        );
        
        const fare = PriceCalculator.calculateRideFare(distance, AppState.selectedRideType);
        
        // Check for someone else booking
        const forSomeone = document.getElementById('scheduleForSomeone').checked;
        const recipientName = document.getElementById('scheduleRecipientName')?.value.trim() || '';
        const recipientPhone = document.getElementById('scheduleRecipientPhone')?.value.trim() || '';
        
        const scheduleData = {
            pickup: {
                name: pickupInput.value,
                lat: parseFloat(pickupLat),
                lng: parseFloat(pickupLng),
                address: pickupInput.dataset.address || ''
            },
            destination: {
                name: destinationInput.value,
                lat: parseFloat(destLat),
                lng: parseFloat(destLng),
                address: destinationInput.dataset.address || ''
            },
            rideType: AppState.selectedRideType,
            fare: fare,
            distance: distance,
            scheduledTime: scheduleDate.getTime(),
            forSomeone: forSomeone,
            recipientName: forSomeone ? recipientName : '',
            recipientPhone: forSomeone ? recipientPhone : '',
            userId: AppState.currentUser.uid,
            userName: AppState.userData.name,
            status: 'scheduled',
            createdAt: Date.now()
        };
        
        try {
            const scheduleId = await FirebaseManager.createScheduledRide(scheduleData);
            
            ModalManager.hide('schedule');
            EnhancedUIUpdater.showToast('Ride scheduled successfully', 'success');
            
            // Show countdown timer
            this.showScheduleCountdown(scheduleId, scheduleData);
            
        } catch (error) {
            console.error('Error scheduling ride:', error);
            EnhancedUIUpdater.showToast('Error scheduling ride', 'error');
        }
    },
    
    showScheduleCountdown(scheduleId, scheduleData) {
        const scheduledTime = scheduleData.scheduledTime;
        const now = Date.now();
        const timeUntilRide = scheduledTime - now;
        
        if (timeUntilRide <= 0) {
            this.executeScheduledRide(scheduleId, scheduleData);
            return;
        }
        
        // Create countdown element
        const countdownHTML = `
            <div class="schedule-countdown" id="scheduleCountdown">
                <div class="countdown-header">
                    <i class="fas fa-clock"></i>
                    <span>Scheduled Ride Countdown</span>
                </div>
                <div class="countdown-timer">
                    <div class="time-unit">
                        <div class="time-value" id="countdownHours">00</div>
                        <div class="time-label">Hours</div>
                    </div>
                    <div class="time-separator">:</div>
                    <div class="time-unit">
                        <div class="time-value" id="countdownMinutes">00</div>
                        <div class="time-label">Minutes</div>
                    </div>
                    <div class="time-separator">:</div>
                    <div class="time-unit">
                        <div class="time-value" id="countdownSeconds">00</div>
                        <div class="time-label">Seconds</div>
                    </div>
                </div>
                <div class="countdown-info">
                    <div class="info-item">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>${scheduleData.pickup.name}</span>
                    </div>
                    <div class="info-item">
                        <i class="fas fa-flag"></i>
                        <span>${scheduleData.destination.name}</span>
                    </div>
                </div>
                <div class="countdown-actions">
                    <button class="btn btn-danger" onclick="ScheduledRideManager.cancelScheduledRide('${scheduleId}')">
                        <i class="fas fa-times"></i>
                        Cancel Schedule
                    </button>
                </div>
            </div>
        `;
        
        const mainPanel = document.getElementById('mainPanel');
        if (mainPanel) {
            const existingCountdown = document.getElementById('scheduleCountdown');
            if (existingCountdown) {
                existingCountdown.remove();
            }
            
            mainPanel.insertAdjacentHTML('beforeend', countdownHTML);
            
            // Start countdown timer
            this.startCountdownTimer(scheduleId, scheduleData, timeUntilRide);
        }
    },
    
    startCountdownTimer(scheduleId, scheduleData, timeUntilRide) {
        const updateCountdown = () => {
            const now = Date.now();
            const timeLeft = scheduleData.scheduledTime - now;
            
            if (timeLeft <= 0) {
                clearInterval(AppState.activeScheduledTimer);
                this.executeScheduledRide(scheduleId, scheduleData);
                return;
            }
            
            const hours = Math.floor(timeLeft / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
            
            const hoursElement = document.getElementById('countdownHours');
            const minutesElement = document.getElementById('countdownMinutes');
            const secondsElement = document.getElementById('countdownSeconds');
            
            if (hoursElement) hoursElement.textContent = hours.toString().padStart(2, '0');
            if (minutesElement) minutesElement.textContent = minutes.toString().padStart(2, '0');
            if (secondsElement) secondsElement.textContent = seconds.toString().padStart(2, '0');
        };
        
        // Update immediately
        updateCountdown();
        
        // Update every second
        AppState.activeScheduledTimer = setInterval(updateCountdown, 1000);
    },
    
    async executeScheduledRide(scheduleId, scheduleData) {
        try {
            // Update scheduled ride status
            await FirebaseManager.updateScheduledRideStatus(scheduleId, 'executing');
            
            // Prepare ride data
            const rideData = {
                pickup: scheduleData.pickup.name,
                pickupDisplay: scheduleData.pickup.address,
                destination: scheduleData.destination.name,
                destinationDisplay: scheduleData.destination.address,
                pickupLat: scheduleData.pickup.lat,
                pickupLng: scheduleData.pickup.lng,
                destLat: scheduleData.destination.lat,
                destLng: scheduleData.destination.lng,
                rideType: scheduleData.rideType,
                fare: scheduleData.fare,
                distance: scheduleData.distance,
                scheduled: true,
                scheduledRideId: scheduleId,
                forSomeone: scheduleData.forSomeone,
                recipientName: scheduleData.recipientName,
                recipientPhone: scheduleData.recipientPhone
            };
            
            // Show payment modal
            window.pendingRideData = rideData;
            ModalManager.show('payment');
            
            // Remove countdown
            this.removeCountdown();
            
        } catch (error) {
            console.error('Error executing scheduled ride:', error);
            EnhancedUIUpdater.showToast('Error executing scheduled ride', 'error');
        }
    },
    
    async cancelScheduledRide(scheduleId) {
        if (confirm('Are you sure you want to cancel this scheduled ride?')) {
            try {
                await FirebaseManager.cancelScheduledRide(scheduleId);
                EnhancedUIUpdater.showToast('Scheduled ride cancelled', 'success');
                this.removeCountdown();
            } catch (error) {
                console.error('Error cancelling scheduled ride:', error);
                EnhancedUIUpdater.showToast('Error cancelling scheduled ride', 'error');
            }
        }
    },
    
    removeCountdown() {
        const countdownElement = document.getElementById('scheduleCountdown');
        if (countdownElement) {
            countdownElement.remove();
        }
        
        if (AppState.activeScheduledTimer) {
            clearInterval(AppState.activeScheduledTimer);
            AppState.activeScheduledTimer = null;
        }
    },
    
    async loadScheduledRides() {
        try {
            const scheduledRides = await FirebaseManager.getScheduledRides();
            AppState.scheduledRides = scheduledRides;
            
            // Show countdown for next scheduled ride
            if (scheduledRides.length > 0) {
                const nextRide = scheduledRides[0];
                const timeUntilRide = nextRide.scheduledTime - Date.now();
                
                if (timeUntilRide > 0 && timeUntilRide <= 3600000) { // Within 1 hour
                    this.showScheduleCountdown(nextRide.id, nextRide);
                }
            }
        } catch (error) {
            console.error('Error loading scheduled rides:', error);
        }
    }
};

// ============================================
// WALLET MANAGER
// ============================================
const WalletManager = {
    init() {
        console.log('Wallet Manager initialized');
        this.setupWalletUI();
        this.loadWalletBalance();
        this.loadWalletHistory();
    },
    
    setupWalletUI() {
        // Setup wallet buttons
        const depositBtn = document.getElementById('depositBtn');
        const withdrawBtn = document.getElementById('withdrawBtn');
        const transferBtn = document.getElementById('transferBtn');
        const transactionsBtn = document.getElementById('transactionsBtn');
        
        if (depositBtn) {
            depositBtn.addEventListener('click', () => {
                this.showDepositModal();
            });
        }
        
        if (withdrawBtn) {
            withdrawBtn.addEventListener('click', () => {
                this.showWithdrawModal();
            });
        }
        
        if (transferBtn) {
            transferBtn.addEventListener('click', () => {
                this.showTransferModal();
            });
        }
        
        if (transactionsBtn) {
            transactionsBtn.addEventListener('click', () => {
                this.showTransactionsModal();
            });
        }
        
        // Create wallet modals
        this.createWalletModals();
    },
    
    createWalletModals() {
        // Deposit modal
        const depositModal = `
            <div class="modal-overlay" id="depositModal" style="display: none;">
                <div class="modal">
                    <div class="modal-header">
                        <div class="modal-title">
                            <i class="fas fa-plus"></i>
                            Deposit Money
                        </div>
                        <button class="modal-close" onclick="ModalManager.hide('deposit')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-content">
                        <div class="form-group">
                            <label class="form-label">Amount (ZMW)</label>
                            <input type="number" id="depositAmount" placeholder="Enter amount" min="1" step="0.01">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Payment Method</label>
                            <select id="depositMethod" class="form-control">
                                <option value="mobile_money">Mobile Money</option>
                                <option value="bank_transfer">Bank Transfer</option>
                                <option value="card">Credit/Debit Card</option>
                            </select>
                        </div>
                        
                        <div class="payment-details" id="depositPaymentDetails">
                            <!-- Payment details will be shown based on method -->
                        </div>
                        
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="WalletManager.processDeposit()">
                                <i class="fas fa-check"></i>
                                Process Deposit
                            </button>
                            <button class="btn btn-secondary" onclick="ModalManager.hide('deposit')">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Withdraw modal
        const withdrawModal = `
            <div class="modal-overlay" id="withdrawModal" style="display: none;">
                <div class="modal">
                    <div class="modal-header">
                        <div class="modal-title">
                            <i class="fas fa-minus"></i>
                            Withdraw Money
                        </div>
                        <button class="modal-close" onclick="ModalManager.hide('withdraw')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-content">
                        <div class="wallet-info">
                            <div class="info-label">Available Balance</div>
                            <div class="info-value" id="withdrawBalance">ZMW 0.00</div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Amount (ZMW)</label>
                            <input type="number" id="withdrawAmount" placeholder="Enter amount" min="1" step="0.01">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Withdraw To</label>
                            <select id="withdrawMethod" class="form-control">
                                <option value="mobile_money">Mobile Money</option>
                                <option value="bank_account">Bank Account</option>
                            </select>
                        </div>
                        
                        <div class="withdrawal-details" id="withdrawDetails">
                            <!-- Withdrawal details will be shown based on method -->
                        </div>
                        
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="WalletManager.processWithdrawal()">
                                <i class="fas fa-check"></i>
                                Process Withdrawal
                            </button>
                            <button class="btn btn-secondary" onclick="ModalManager.hide('withdraw')">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Transfer modal
        const transferModal = `
            <div class="modal-overlay" id="transferModal" style="display: none;">
                <div class="modal">
                    <div class="modal-header">
                        <div class="modal-title">
                            <i class="fas fa-exchange-alt"></i>
                            Transfer Money
                        </div>
                        <button class="modal-close" onclick="ModalManager.hide('transfer')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-content">
                        <div class="wallet-info">
                            <div class="info-label">Available Balance</div>
                            <div class="info-value" id="transferBalance">ZMW 0.00</div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Recipient's Referral Code</label>
                            <input type="text" id="transferRecipientCode" placeholder="Enter referral code">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Amount (ZMW)</label>
                            <input type="number" id="transferAmount" placeholder="Enter amount" min="1" step="0.01">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Message (Optional)</label>
                            <input type="text" id="transferMessage" placeholder="Add a message">
                        </div>
                        
                        <div class="recipient-info" id="transferRecipientInfo" style="display: none;">
                            <!-- Recipient info will be shown here -->
                        </div>
                        
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="WalletManager.processTransfer()">
                                <i class="fas fa-paper-plane"></i>
                                Send Money
                            </button>
                            <button class="btn btn-secondary" onclick="ModalManager.hide('transfer')">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Transactions modal
        const transactionsModal = `
            <div class="modal-overlay" id="transactionsModal" style="display: none;">
                <div class="modal large-modal">
                    <div class="modal-header">
                        <div class="modal-title">
                            <i class="fas fa-history"></i>
                            Wallet Transactions
                        </div>
                        <button class="modal-close" onclick="ModalManager.hide('transactions')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-content">
                        <div class="transactions-filters">
                            <button class="filter-btn active" onclick="WalletManager.filterTransactions('all')">All</button>
                            <button class="filter-btn" onclick="WalletManager.filterTransactions('deposit')">Deposits</button>
                            <button class="filter-btn" onclick="WalletManager.filterTransactions('withdrawal')">Withdrawals</button>
                            <button class="filter-btn" onclick="WalletManager.filterTransactions('transfer')">Transfers</button>
                            <button class="filter-btn" onclick="WalletManager.filterTransactions('payment')">Payments</button>
                            <button class="filter-btn" onclick="WalletManager.filterTransactions('refund')">Refunds</button>
                            <button class="filter-btn" onclick="WalletManager.filterTransactions('referral')">Referrals</button>
                        </div>
                        
                        <div class="transactions-list" id="transactionsList">
                            <!-- Transactions will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', depositModal);
        document.body.insertAdjacentHTML('beforeend', withdrawModal);
        document.body.insertAdjacentHTML('beforeend', transferModal);
        document.body.insertAdjacentHTML('beforeend', transactionsModal);
        
        // Setup event listeners
        this.setupWalletModalEvents();
    },
    
    setupWalletModalEvents() {
        // Deposit method change
        const depositMethod = document.getElementById('depositMethod');
        if (depositMethod) {
            depositMethod.addEventListener('change', (e) => {
                this.showDepositPaymentDetails(e.target.value);
            });
        }
        
        // Withdraw method change
        const withdrawMethod = document.getElementById('withdrawMethod');
        if (withdrawMethod) {
            withdrawMethod.addEventListener('change', (e) => {
                this.showWithdrawDetails(e.target.value);
            });
        }
        
        // Transfer recipient code lookup
        const recipientCodeInput = document.getElementById('transferRecipientCode');
        if (recipientCodeInput) {
            recipientCodeInput.addEventListener('input', (e) => {
                this.lookupTransferRecipient(e.target.value);
            });
        }
    },
    
    showDepositModal() {
        document.getElementById('depositAmount').value = '';
        this.showDepositPaymentDetails('mobile_money');
        ModalManager.show('deposit');
    },
    
    showDepositPaymentDetails(method) {
        const detailsContainer = document.getElementById('depositPaymentDetails');
        if (!detailsContainer) return;
        
        let detailsHTML = '';
        
        switch(method) {
            case 'mobile_money':
                detailsHTML = `
                    <div class="mobile-money-details">
                        <div class="form-group">
                            <label class="form-label">Mobile Network</label>
                            <select id="mobileNetwork" class="form-control">
                                <option value="mtn">MTN</option>
                                <option value="airtel">Airtel</option>
                                <option value="zamtel">Zamtel</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone Number</label>
                            <input type="tel" id="mobileNumber" placeholder="096XXXXXXX">
                        </div>
                    </div>
                `;
                break;
                
            case 'bank_transfer':
                detailsHTML = `
                    <div class="bank-transfer-details">
                        <div class="form-group">
                            <label class="form-label">Bank Account Number</label>
                            <input type="text" id="accountNumber" placeholder="Account number">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Bank Name</label>
                            <input type="text" id="bankName" placeholder="Bank name">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Account Name</label>
                            <input type="text" id="accountName" placeholder="Account holder name">
                        </div>
                    </div>
                `;
                break;
                
            case 'card':
                detailsHTML = `
                    <div class="card-details">
                        <div class="form-group">
                            <label class="form-label">Card Number</label>
                            <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Expiry Date</label>
                                <input type="text" id="cardExpiry" placeholder="MM/YY">
                            </div>
                            <div class="form-group">
                                <label class="form-label">CVV</label>
                                <input type="text" id="cardCVV" placeholder="123">
                            </div>
                        </div>
                    </div>
                `;
                break;
        }
        
        detailsContainer.innerHTML = detailsHTML;
    },
    
    async processDeposit() {
        const amountInput = document.getElementById('depositAmount');
        const method = document.getElementById('depositMethod').value;
        
        if (!amountInput || !amountInput.value) {
            EnhancedUIUpdater.showToast('Please enter amount', 'warning');
            return;
        }
        
        const amount = parseFloat(amountInput.value);
        if (amount < 1) {
            EnhancedUIUpdater.showToast('Minimum deposit is ZMW 1', 'warning');
            return;
        }
        
        // In a real app, this would integrate with a payment gateway
        // For now, we'll simulate a successful deposit
        
        try {
            const depositData = {
                amount: amount,
                method: method,
                status: 'pending',
                timestamp: Date.now()
            };
            
            await FirebaseManager.processDeposit(depositData);
            
            ModalManager.hide('deposit');
            EnhancedUIUpdater.showToast(`Deposit of ZMW ${amount.toFixed(2)} initiated`, 'success');
            
            // In a real app, you would redirect to payment gateway
            // For simulation, we'll add the amount immediately
            setTimeout(() => {
                this.completeDeposit(amount);
            }, 2000);
            
        } catch (error) {
            console.error('Error processing deposit:', error);
            EnhancedUIUpdater.showToast('Error processing deposit', 'error');
        }
    },
    
    async completeDeposit(amount) {
        try {
            await FirebaseManager.addToWalletBalance(amount);
            
            // Add transaction record
            const transaction = {
                type: 'deposit',
                amount: amount,
                status: 'completed',
                timestamp: Date.now(),
                description: 'Wallet deposit'
            };
            
            await FirebaseManager.addWalletTransaction(transaction);
            
            EnhancedUIUpdater.showToast(`ZMW ${amount.toFixed(2)} added to your wallet`, 'success');
            this.loadWalletBalance();
            this.loadWalletHistory();
            
        } catch (error) {
            console.error('Error completing deposit:', error);
        }
    },
    
    showWithdrawModal() {
        document.getElementById('withdrawAmount').value = '';
        this.showWithdrawDetails('mobile_money');
        
        // Update balance display
        const balanceElement = document.getElementById('withdrawBalance');
        if (balanceElement) {
            balanceElement.textContent = `ZMW ${AppState.walletBalance.toFixed(2)}`;
        }
        
        ModalManager.show('withdraw');
    },
    
    showWithdrawDetails(method) {
        const detailsContainer = document.getElementById('withdrawDetails');
        if (!detailsContainer) return;
        
        let detailsHTML = '';
        
        switch(method) {
            case 'mobile_money':
                detailsHTML = `
                    <div class="mobile-money-withdraw">
                        <div class="form-group">
                            <label class="form-label">Mobile Network</label>
                            <select id="withdrawMobileNetwork" class="form-control">
                                <option value="mtn">MTN</option>
                                <option value="airtel">Airtel</option>
                                <option value="zamtel">Zamtel</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone Number</label>
                            <input type="tel" id="withdrawMobileNumber" placeholder="096XXXXXXX">
                        </div>
                    </div>
                `;
                break;
                
            case 'bank_account':
                detailsHTML = `
                    <div class="bank-account-withdraw">
                        <div class="form-group">
                            <label class="form-label">Bank Account Number</label>
                            <input type="text" id="withdrawAccountNumber" placeholder="Account number">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Bank Name</label>
                            <input type="text" id="withdrawBankName" placeholder="Bank name">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Account Name</label>
                            <input type="text" id="withdrawAccountName" placeholder="Account holder name">
                        </div>
                    </div>
                `;
                break;
        }
        
        detailsContainer.innerHTML = detailsHTML;
    },
    
    async processWithdrawal() {
        const amountInput = document.getElementById('withdrawAmount');
        const method = document.getElementById('withdrawMethod').value;
        
        if (!amountInput || !amountInput.value) {
            EnhancedUIUpdater.showToast('Please enter amount', 'warning');
            return;
        }
        
        const amount = parseFloat(amountInput.value);
        
        if (amount < 1) {
            EnhancedUIUpdater.showToast('Minimum withdrawal is ZMW 1', 'warning');
            return;
        }
        
        if (amount > AppState.walletBalance) {
            EnhancedUIUpdater.showToast('Insufficient balance', 'error');
            return;
        }
        
        // Validate withdrawal details based on method
        if (method === 'mobile_money') {
            const mobileNumber = document.getElementById('withdrawMobileNumber').value;
            if (!mobileNumber || mobileNumber.length < 10) {
                EnhancedUIUpdater.showToast('Please enter valid mobile number', 'warning');
                return;
            }
        } else if (method === 'bank_account') {
            const accountNumber = document.getElementById('withdrawAccountNumber').value;
            const bankName = document.getElementById('withdrawBankName').value;
            const accountName = document.getElementById('withdrawAccountName').value;
            
            if (!accountNumber || !bankName || !accountName) {
                EnhancedUIUpdater.showToast('Please fill all bank details', 'warning');
                return;
            }
        }
        
        try {
            const withdrawalData = {
                amount: amount,
                method: method,
                status: 'pending',
                timestamp: Date.now()
            };
            
            await FirebaseManager.processWithdrawal(withdrawalData);
            
            // Deduct from wallet
            await FirebaseManager.deductFromWalletBalance(amount);
            
            // Add transaction record
            const transaction = {
                type: 'withdrawal',
                amount: amount,
                status: 'processing',
                timestamp: Date.now(),
                description: `Withdrawal to ${method}`
            };
            
            await FirebaseManager.addWalletTransaction(transaction);
            
            ModalManager.hide('withdraw');
            EnhancedUIUpdater.showToast(`Withdrawal of ZMW ${amount.toFixed(2)} initiated`, 'success');
            
            this.loadWalletBalance();
            this.loadWalletHistory();
            
        } catch (error) {
            console.error('Error processing withdrawal:', error);
            EnhancedUIUpdater.showToast('Error processing withdrawal', 'error');
        }
    },
    
    showTransferModal() {
        document.getElementById('transferRecipientCode').value = '';
        document.getElementById('transferAmount').value = '';
        document.getElementById('transferMessage').value = '';
        
        // Update balance display
        const balanceElement = document.getElementById('transferBalance');
        if (balanceElement) {
            balanceElement.textContent = `ZMW ${AppState.walletBalance.toFixed(2)}`;
        }
        
        // Clear recipient info
        const recipientInfo = document.getElementById('transferRecipientInfo');
        if (recipientInfo) {
            recipientInfo.style.display = 'none';
            recipientInfo.innerHTML = '';
        }
        
        ModalManager.show('transfer');
    },
    
    async lookupTransferRecipient(referralCode) {
        if (!referralCode || referralCode.length < 3) {
            const recipientInfo = document.getElementById('transferRecipientInfo');
            if (recipientInfo) {
                recipientInfo.style.display = 'none';
            }
            return;
        }
        
        try {
            const recipientData = await FirebaseManager.findUserByReferralCode(referralCode);
            
            if (recipientData && recipientData.id !== AppState.currentUser.uid) {
                const recipientInfo = document.getElementById('transferRecipientInfo');
                if (recipientInfo) {
                    recipientInfo.innerHTML = `
                        <div class="recipient-found">
                            <div class="recipient-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="recipient-details">
                                <div class="recipient-name">${recipientData.name}</div>
                                <div class="recipient-phone">${recipientData.phone || ''}</div>
                            </div>
                        </div>
                    `;
                    recipientInfo.style.display = 'block';
                }
            } else {
                const recipientInfo = document.getElementById('transferRecipientInfo');
                if (recipientInfo) {
                    recipientInfo.innerHTML = '<div class="recipient-not-found">User not found</div>';
                    recipientInfo.style.display = 'block';
                }
            }
        } catch (error) {
            console.error('Error looking up recipient:', error);
        }
    },
    
    async processTransfer() {
        const recipientCode = document.getElementById('transferRecipientCode').value.trim();
        const amountInput = document.getElementById('transferAmount').value;
        const message = document.getElementById('transferMessage').value.trim();
        
        if (!recipientCode) {
            EnhancedUIUpdater.showToast('Please enter recipient referral code', 'warning');
            return;
        }
        
        if (!amountInput) {
            EnhancedUIUpdater.showToast('Please enter amount', 'warning');
            return;
        }
        
        const amount = parseFloat(amountInput);
        
        if (amount < 1) {
            EnhancedUIUpdater.showToast('Minimum transfer is ZMW 1', 'warning');
            return;
        }
        
        if (amount > AppState.walletBalance) {
            EnhancedUIUpdater.showToast('Insufficient balance', 'error');
            return;
        }
        
        // Find recipient
        try {
            const recipientData = await FirebaseManager.findUserByReferralCode(recipientCode);
            
            if (!recipientData || recipientData.id === AppState.currentUser.uid) {
                EnhancedUIUpdater.showToast('Invalid recipient', 'error');
                return;
            }
            
            // Process transfer
            const transferData = {
                amount: amount,
                recipientId: recipientData.id,
                recipientName: recipientData.name,
                recipientCode: recipientCode,
                message: message,
                timestamp: Date.now()
            };
            
            await FirebaseManager.processTransfer(transferData);
            
            // Deduct from sender's wallet
            await FirebaseManager.deductFromWalletBalance(amount);
            
            // Add transaction record for sender
            const senderTransaction = {
                type: 'transfer_sent',
                amount: amount,
                recipientId: recipientData.id,
                recipientName: recipientData.name,
                message: message,
                timestamp: Date.now(),
                description: `Transfer to ${recipientData.name}`
            };
            
            await FirebaseManager.addWalletTransaction(senderTransaction);
            
            ModalManager.hide('transfer');
            EnhancedUIUpdater.showToast(`ZMW ${amount.toFixed(2)} transferred successfully`, 'success');
            
            this.loadWalletBalance();
            this.loadWalletHistory();
            
        } catch (error) {
            console.error('Error processing transfer:', error);
            EnhancedUIUpdater.showToast('Error processing transfer', 'error');
        }
    },
    
    showTransactionsModal() {
        ModalManager.show('transactions');
        this.loadWalletHistory();
    },
    
    async loadWalletBalance() {
        try {
            const balance = await FirebaseManager.getWalletBalance();
            AppState.walletBalance = balance;
            
            // Update UI
            EnhancedUIUpdater.updateWalletBalance(balance);
        } catch (error) {
            console.error('Error loading wallet balance:', error);
        }
    },
    
    async loadWalletHistory() {
        try {
            const transactions = await FirebaseManager.getWalletTransactions();
            this.displayTransactions(transactions);
        } catch (error) {
            console.error('Error loading wallet history:', error);
        }
    },
    
    displayTransactions(transactions) {
        const container = document.getElementById('transactionsList');
        if (!container) return;
        
        if (transactions.length === 0) {
            container.innerHTML = `
                <div class="empty-transactions">
                    <i class="fas fa-receipt"></i>
                    <div>No transactions yet</div>
                </div>
            `;
            return;
        }
        
        let html = '';
        
        transactions.forEach(transaction => {
            const date = new Date(transaction.timestamp);
            const isPositive = ['deposit', 'refund', 'referral_earnings', 'transfer_received'].includes(transaction.type);
            const isNegative = ['withdrawal', 'payment', 'transfer_sent'].includes(transaction.type);
            
            let typeLabel = '';
            let icon = '';
            let iconColor = '';
            
            switch(transaction.type) {
                case 'deposit':
                    typeLabel = 'Deposit';
                    icon = 'fa-arrow-down';
                    iconColor = 'green';
                    break;
                case 'withdrawal':
                    typeLabel = 'Withdrawal';
                    icon = 'fa-arrow-up';
                    iconColor = 'red';
                    break;
                case 'payment':
                    typeLabel = 'Ride Payment';
                    icon = 'fa-car';
                    iconColor = 'orange';
                    break;
                case 'refund':
                    typeLabel = 'Refund';
                    icon = 'fa-undo';
                    iconColor = 'blue';
                    break;
                case 'transfer_sent':
                    typeLabel = 'Transfer Sent';
                    icon = 'fa-paper-plane';
                    iconColor = 'red';
                    break;
                case 'transfer_received':
                    typeLabel = 'Transfer Received';
                    icon = 'fa-paper-plane';
                    iconColor = 'green';
                    break;
                case 'referral_earnings':
                    typeLabel = 'Referral Earnings';
                    icon = 'fa-gift';
                    iconColor = 'purple';
                    break;
            }
            
            html += `
                <div class="transaction-item">
                    <div class="transaction-icon" style="color: ${iconColor}">
                        <i class="fas ${icon}"></i>
                    </div>
                    <div class="transaction-details">
                        <div class="transaction-type">${typeLabel}</div>
                        <div class="transaction-date">${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                        ${transaction.description ? `<div class="transaction-description">${transaction.description}</div>` : ''}
                        ${transaction.recipientName ? `<div class="transaction-recipient">To: ${transaction.recipientName}</div>` : ''}
                        ${transaction.senderName ? `<div class="transaction-sender">From: ${transaction.senderName}</div>` : ''}
                        ${transaction.rideId ? `<div class="transaction-ride">Ride ID: ${transaction.rideId.substring(0, 8)}...</div>` : ''}
                    </div>
                    <div class="transaction-amount ${isPositive ? 'positive' : isNegative ? 'negative' : ''}">
                        ${isPositive ? '+' : isNegative ? '-' : ''}ZMW ${transaction.amount.toFixed(2)}
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    },
    
    filterTransactions(filter) {
        // Update filter buttons
        document.querySelectorAll('.transactions-filters .filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        const activeBtn = document.querySelector(`.transactions-filters .filter-btn[onclick*="${filter}"]`);
        if (activeBtn) {
            activeBtn.classList.add('active');
        }
        
        // Reload filtered transactions
        this.loadWalletHistory(); // In a real app, you would filter the transactions array
    }
};

// ============================================
// PAYMENT MANAGER
// ============================================
const PaymentManager = {
    init() {
        console.log('Payment Manager initialized');
        this.setupPaymentModal();
    },
    
    setupPaymentModal() {
        // Create payment modal if it doesn't exist
        if (!document.getElementById('paymentModal')) {
            this.createPaymentModal();
        }
        
        // Setup payment method selection
        document.addEventListener('click', (e) => {
            if (e.target.closest('.payment-method')) {
                this.selectPaymentMethod(e.target.closest('.payment-method'));
            }
        });
        
        // Setup apply referral button
        const applyReferralBtn = document.getElementById('applyReferralBtn');
        if (applyReferralBtn) {
            applyReferralBtn.addEventListener('click', () => {
                this.applyReferralDiscount();
            });
        }
        
        // Setup confirm payment button
        const confirmPaymentBtn = document.getElementById('confirmPaymentBtn');
        if (confirmPaymentBtn) {
            confirmPaymentBtn.addEventListener('click', () => {
                this.confirmPayment();
            });
        }
    },
    
    createPaymentModal() {
        const modalHTML = `
            <div class="modal-overlay" id="paymentModal" style="display: none;">
                <div class="modal">
                    <div class="modal-header">
                        <div class="modal-title">
                            <i class="fas fa-credit-card"></i>
                            Select Payment Method
                        </div>
                        <button class="modal-close" onclick="ModalManager.hide('payment')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-content">
                        <div class="payment-info">
                            <div class="info-item">
                                <span>Available Balance:</span>
                                <span id="paymentBalance">ZMW 0.00</span>
                            </div>
                            <div class="info-item">
                                <span>Total Amount:</span>
                                <span id="paymentAmount">ZMW 0.00</span>
                            </div>
                        </div>
                        
                        <div class="referral-section" id="referralSection">
                            <div class="section-header">
                                <i class="fas fa-gift"></i>
                                <span>Referral Discount (50% off)</span>
                            </div>
                            <div class="referral-input-group">
                                <input type="text" id="referralCodeInput" placeholder="Enter referral code">
                                <button id="applyReferralBtn" class="btn btn-orange">
                                    <i class="fas fa-check"></i> Apply
                                </button>
                            </div>
                            <div id="referrerInfo" style="display: none;">
                                <!-- Referrer info will be shown here -->
                            </div>
                            <div class="discount-breakdown" id="discountBreakdown" style="display: none;">
                                <div class="price-row">
                                    <span>Original Fare:</span>
                                    <span id="originalFareAmount">ZMW 0.00</span>
                                </div>
                                <div class="price-row">
                                    <span>Discount:</span>
                                    <span id="discountAmount" style="color: green;">-ZMW 0.00</span>
                                </div>
                                <div class="price-row total">
                                    <span>Final Fare:</span>
                                    <span id="finalFareAmount">ZMW 0.00</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="payment-methods">
                            <div class="payment-method" data-payment="wallet">
                                <div class="payment-icon">
                                    <i class="fas fa-wallet"></i>
                                </div>
                                <div class="payment-details">
                                    <div class="payment-name">Jubel Wallet</div>
                                    <div class="payment-info">Pay with your wallet balance</div>
                                </div>
                            </div>
                            
                            <div class="payment-method" data-payment="mobile">
                                <div class="payment-icon">
                                    <i class="fas fa-mobile-alt"></i>
                                </div>
                                <div class="payment-details">
                                    <div class="payment-name">Mobile Money</div>
                                    <div class="payment-info">Pay via MTN/Zamtel/Airtel</div>
                                </div>
                            </div>
                            
                            <div class="payment-method" data-payment="cash">
                                <div class="payment-icon">
                                    <i class="fas fa-money-bill"></i>
                                </div>
                                <div class="payment-details">
                                    <div class="payment-name">Cash</div>
                                    <div class="payment-info">Pay driver directly</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="payment-warning" id="walletWarning" style="display: none; color: red; font-size: 12px; margin: 10px 0;">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span>Insufficient wallet balance</span>
                        </div>
                        
                        <div class="action-buttons">
                            <button class="btn btn-primary" id="confirmPaymentBtn">
                                <i class="fas fa-check"></i>
                                Confirm Payment
                            </button>
                            <button class="btn btn-secondary" onclick="ModalManager.hide('payment')">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
    },
    
    showPaymentModal(rideData) {
        if (!rideData || !rideData.fare) {
            EnhancedUIUpdater.showToast('Invalid ride data', 'error');
            return;
        }
        
        // Store ride data
        window.pendingRideData = rideData;
        
        // Update payment info
        const paymentBalance = document.getElementById('paymentBalance');
        const paymentAmount = document.getElementById('paymentAmount');
        
        if (paymentBalance) {
            paymentBalance.textContent = `ZMW ${AppState.walletBalance.toFixed(2)}`;
        }
        
        if (paymentAmount) {
            paymentAmount.textContent = `ZMW ${rideData.fare.toFixed(2)}`;
        }
        
        // Reset referral discount
        this.resetReferralDiscount();
        
        // Select wallet by default if balance is sufficient
        const walletMethod = document.querySelector('.payment-method[data-payment="wallet"]');
        if (walletMethod && AppState.walletBalance >= rideData.fare) {
            this.selectPaymentMethod(walletMethod);
        } else {
            // Select first available method
            const firstMethod = document.querySelector('.payment-method');
            if (firstMethod) {
                this.selectPaymentMethod(firstMethod);
            }
        }
        
        // Show/hide wallet warning
        const walletWarning = document.getElementById('walletWarning');
        if (walletWarning) {
            walletWarning.style.display = AppState.walletBalance < rideData.fare ? 'block' : 'none';
        }
        
        ModalManager.show('payment');
    },
    
    selectPaymentMethod(methodElement) {
        // Remove selected class from all methods
        document.querySelectorAll('.payment-method').forEach(method => {
            method.classList.remove('selected');
        });
        
        // Add selected class to clicked method
        methodElement.classList.add('selected');
        
        // Update payment method in ride data
        if (window.pendingRideData) {
            window.pendingRideData.paymentMethod = methodElement.dataset.payment;
        }
    },
    
    async applyReferralDiscount() {
        const referralCodeInput = document.getElementById('referralCodeInput');
        const referralCode = referralCodeInput.value.trim();
        
        if (!referralCode) {
            EnhancedUIUpdater.showToast('Please enter a referral code', 'warning');
            return;
        }
        
        if (!window.pendingRideData) {
            EnhancedUIUpdater.showToast('No ride data found', 'error');
            return;
        }
        
        try {
            // Validate referral code
            const referrerData = await FirebaseManager.validateReferralCode(referralCode);
            
            if (referrerData.valid && referrerData.userId !== AppState.currentUser.uid) {
                // Apply 50% discount
                const originalFare = window.pendingRideData.fare;
                const discount = originalFare * 0.5;
                const finalFare = originalFare - discount;
                
                // Update UI
                document.getElementById('originalFareAmount').textContent = `ZMW ${originalFare.toFixed(2)}`;
                document.getElementById('discountAmount').textContent = `-ZMW ${discount.toFixed(2)}`;
                document.getElementById('finalFareAmount').textContent = `ZMW ${finalFare.toFixed(2)}`;
                
                document.getElementById('discountBreakdown').style.display = 'block';
                
                // Show referrer info
                const referrerInfo = document.getElementById('referrerInfo');
                if (referrerInfo) {
                    referrerInfo.innerHTML = `
                        <div class="referrer-info">
                            <i class="fas fa-user-check"></i>
                            <span>Discount applied! Referral from ${referrerData.name}</span>
                        </div>
                    `;
                    referrerInfo.style.display = 'block';
                }
                
                // Update ride data
                window.pendingRideData.fare = finalFare;
                window.pendingRideData.referralCode = referralCode;
                window.pendingRideData.referrerId = referrerData.userId;
                window.pendingRideData.referrerName = referrerData.name;
                window.pendingRideData.originalFare = originalFare;
                window.pendingRideData.referralDiscount = discount;
                
                // Update payment amount
                const paymentAmount = document.getElementById('paymentAmount');
                if (paymentAmount) {
                    paymentAmount.textContent = `ZMW ${finalFare.toFixed(2)}`;
                }
                
                // Update wallet warning
                const walletWarning = document.getElementById('walletWarning');
                if (walletWarning) {
                    walletWarning.style.display = AppState.walletBalance < finalFare ? 'block' : 'none';
                }
                
                AppState.referralDiscountApplied = true;
                AppState.referralCodeUsed = referralCode;
                AppState.referralOwnerName = referrerData.name;
                
                EnhancedUIUpdater.showToast('50% discount applied!', 'success');
                
            } else {
                EnhancedUIUpdater.showToast('Invalid referral code or cannot use your own code', 'error');
            }
        } catch (error) {
            console.error('Error applying referral discount:', error);
            EnhancedUIUpdater.showToast('Error applying referral discount', 'error');
        }
    },
    
    resetReferralDiscount() {
        AppState.referralDiscountApplied = false;
        AppState.referralCodeUsed = null;
        AppState.referralOwnerName = null;
        
        document.getElementById('referralCodeInput').value = '';
        document.getElementById('referrerInfo').style.display = 'none';
        document.getElementById('discountBreakdown').style.display = 'none';
    },
    
    async confirmPayment() {
        if (!window.pendingRideData) {
            EnhancedUIUpdater.showToast('No ride data found', 'error');
            return;
        }
        
        const selectedMethod = document.querySelector('.payment-method.selected');
        if (!selectedMethod) {
            EnhancedUIUpdater.showToast('Please select a payment method', 'warning');
            return;
        }
        
        const paymentMethod = selectedMethod.dataset.payment;
        const fare = window.pendingRideData.fare;
        
        // Check wallet balance if paying with wallet
        if (paymentMethod === 'wallet' && AppState.walletBalance < fare) {
            EnhancedUIUpdater.showToast('Insufficient wallet balance', 'error');
            return;
        }
        
        // Process payment
        try {
            if (paymentMethod === 'wallet') {
                // Deduct from wallet
                await FirebaseManager.deductFromWalletBalance(fare);
                
                // Add wallet transaction
                const transaction = {
                    type: 'payment',
                    amount: fare,
                    timestamp: Date.now(),
                    description: `Ride payment - ${window.pendingRideData.pickup} to ${window.pendingRideData.destination}`,
                    rideId: window.pendingRideData.id || 'pending'
                };
                
                await FirebaseManager.addWalletTransaction(transaction);
                
                // Update wallet balance
                await WalletManager.loadWalletBalance();
            }
            
            // Update ride data with payment info
            window.pendingRideData.paymentMethod = paymentMethod;
            window.pendingRideData.paymentStatus = 'paid';
            window.pendingRideData.paymentTime = Date.now();
            
            // Request the ride
            await this.requestRideAfterPayment();
            
            ModalManager.hide('payment');
            
        } catch (error) {
            console.error('Error processing payment:', error);
            EnhancedUIUpdater.showToast('Error processing payment', 'error');
            
            // Refund wallet if payment failed
            if (paymentMethod === 'wallet') {
                await FirebaseManager.addToWalletBalance(fare);
                await WalletManager.loadWalletBalance();
            }
        }
    },
    
    async requestRideAfterPayment() {
        try {
            const rideData = window.pendingRideData;
            
            // Determine ride type and call appropriate function
            let rideId;
            
            if (rideData.isSplitRide) {
                // Handle split ride
                rideId = await FirebaseManager.createSplitRide(rideData);
            } else if (rideData.broadcast) {
                // Handle broadcast ride
                rideId = await FirebaseManager.createBroadcastRide(rideData);
            } else if (rideData.serviceType === 'delivery' || rideData.serviceType === 'short-delivery') {
                // Handle delivery
                rideId = await FirebaseManager.requestDelivery(rideData);
            } else if (rideData.serviceType === 'truck') {
                // Handle truck delivery
                rideId = await FirebaseManager.requestTruck(rideData);
            } else if (rideData.serviceType === 'shopping') {
                // Handle shopping
                rideId = await FirebaseManager.requestShopping(rideData);
            } else if (rideData.emergency) {
                // Handle emergency
                rideId = await FirebaseManager.requestEmergency(rideData);
            } else {
                // Handle regular ride
                rideId = await FirebaseManager.requestRide(rideData);
            }
            
            // Clear pending ride data
            delete window.pendingRideData;
            
            // Reset referral discount
            this.resetReferralDiscount();
            
            // Show success message
            EnhancedUIUpdater.showToast('Ride requested successfully', 'success');
            
            // Show pulsing icon
            MapManager.showPulsingIcon(rideData.serviceType || 'car');
            
            return rideId;
            
        } catch (error) {
            console.error('Error requesting ride:', error);
            throw error;
        }
    },
    
    async processRidePayment(rideId, userId, amount) {
        try {
            // Deduct from user's wallet
            await FirebaseManager.deductFromWalletBalance(amount, userId);
            
            // Add transaction record
            const transaction = {
                type: 'payment',
                amount: amount,
                rideId: rideId,
                timestamp: Date.now(),
                description: 'Ride payment'
            };
            
            await FirebaseManager.addWalletTransaction(transaction, userId);
            
            return true;
        } catch (error) {
            console.error('Error processing ride payment:', error);
            throw error;
        }
    },
    
    async processRefund(rideId, userId, amount, reason) {
        try {
            // Add to user's wallet
            await FirebaseManager.addToWalletBalance(amount, userId);
            
            // Add transaction record
            const transaction = {
                type: 'refund',
                amount: amount,
                rideId: rideId,
                reason: reason,
                timestamp: Date.now(),
                description: `Ride refund: ${reason}`
            };
            
            await FirebaseManager.addWalletTransaction(transaction, userId);
            
            return true;
        } catch (error) {
            console.error('Error processing refund:', error);
            throw error;
        }
    },
    
    async processReferralEarnings(referrerId, amount, referredUserId, rideId) {
        try {
            // Add to referrer's wallet
            await FirebaseManager.addToWalletBalance(amount, referrerId);
            
            // Add transaction record
            const transaction = {
                type: 'referral_earnings',
                amount: amount,
                rideId: rideId,
                referredUserId: referredUserId,
                timestamp: Date.now(),
                description: 'Referral earnings'
            };
            
            await FirebaseManager.addWalletTransaction(transaction, referrerId);
            
            return true;
        } catch (error) {
            console.error('Error processing referral earnings:', error);
            throw error;
        }
    }
};

// ============================================
// NOTIFICATIONS MANAGER
// ============================================
const NotificationsManager = {
    init() {
        console.log('Notifications Manager initialized');
        this.setupNotificationsUI();
        this.loadNotifications();
        this.startRealtimeNotifications();
    },
    
    setupNotificationsUI() {
        // Setup notification bell
        const notificationBell = document.getElementById('notificationBell');
        if (notificationBell) {
            notificationBell.addEventListener('click', () => {
                this.toggleNotificationsPanel();
            });
        }
        
        // Setup notifications close button
        const notificationsClose = document.getElementById('notificationsClose');
        if (notificationsClose) {
            notificationsClose.addEventListener('click', () => {
                this.hideNotificationsPanel();
            });
        }
        
        // Mark all as read button
        const markAllReadBtn = document.getElementById('markAllReadBtn');
        if (!markAllReadBtn) {
            const notificationsHeader = document.querySelector('.notifications-header');
            if (notificationsHeader) {
                const markAllBtn = document.createElement('button');
                markAllBtn.id = 'markAllReadBtn';
                markAllBtn.className = 'mark-all-read-btn';
                markAllBtn.innerHTML = '<i class="fas fa-check-double"></i> Mark all read';
                markAllBtn.addEventListener('click', () => {
                    this.markAllAsRead();
                });
                notificationsHeader.appendChild(markAllBtn);
            }
        }
    },
    
    toggleNotificationsPanel() {
        const panel = document.getElementById('notificationsPanel');
        if (panel) {
            if (panel.classList.contains('active')) {
                this.hideNotificationsPanel();
            } else {
                this.showNotificationsPanel();
            }
        }
    },
    
    showNotificationsPanel() {
        const panel = document.getElementById('notificationsPanel');
        if (panel) {
            panel.classList.add('active');
            AppState.notificationsOpen = true;
            this.loadNotifications();
        }
    },
    
    hideNotificationsPanel() {
        const panel = document.getElementById('notificationsPanel');
        if (panel) {
            panel.classList.remove('active');
            AppState.notificationsOpen = false;
        }
    },
    
    async loadNotifications() {
        try {
            const notifications = await FirebaseManager.getNotifications();
            AppState.notifications = notifications;
            this.updateNotificationsList(notifications);
            this.updateNotificationBadge();
        } catch (error) {
            console.error('Error loading notifications:', error);
        }
    },
    
    updateNotificationsList(notifications) {
        const container = document.getElementById('notificationsList');
        if (!container) return;
        
        if (notifications.length === 0) {
            container.innerHTML = `
                <div class="empty-notifications">
                    <i class="fas fa-bell-slash"></i>
                    <div>No notifications</div>
                </div>
            `;
            return;
        }
        
        let html = '';
        
        notifications.forEach(notification => {
            const time = new Date(notification.timestamp);
            const timeAgo = this.getTimeAgo(time);
            
            let icon = 'fa-info-circle';
            let iconColor = '#2196F3';
            
            switch(notification.type) {
                case 'ride':
                    icon = 'fa-car';
                    iconColor = '#FF6B35';
                    break;
                case 'payment':
                    icon = 'fa-credit-card';
                    iconColor = '#4CAF50';
                    break;
                case 'referral':
                    icon = 'fa-gift';
                    iconColor = '#FFC107';
                    break;
                case 'split_ride':
                    icon = 'fa-user-friends';
                    iconColor = '#2196F3';
                    break;
                case 'broadcast':
                    icon = 'fa-broadcast-tower';
                    iconColor = '#9C27B0';
                    break;
                case 'emergency':
                    icon = 'fa-exclamation-triangle';
                    iconColor = '#F44336';
                    break;
                case 'wallet':
                    icon = 'fa-wallet';
                    iconColor = '#4CAF50';
                    break;
            }
            
            html += `
                <div class="notification-item ${notification.read ? '' : 'unread'}" data-id="${notification.id}">
                    <div class="notification-icon" style="color: ${iconColor}">
                        <i class="fas ${icon}"></i>
                    </div>
                    <div class="notification-content">
                        <div class="notification-title">${notification.title}</div>
                        <div class="notification-message">${notification.message}</div>
                        <div class="notification-time">${timeAgo}</div>
                    </div>
                    ${!notification.read ? `
                    <div class="notification-unread-dot"></div>
                    ` : ''}
                </div>
            `;
        });
        
        container.innerHTML = html;
        
        // Add click events
        container.querySelectorAll('.notification-item').forEach(item => {
            item.addEventListener('click', () => {
                const notificationId = item.dataset.id;
                this.handleNotificationClick(notificationId);
            });
        });
    },
    
    getTimeAgo(date) {
        const now = new Date();
        const diff = now - date;
        
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);
        
        if (minutes < 1) return 'Just now';
        if (minutes < 60) return `${minutes}m ago`;
        if (hours < 24) return `${hours}h ago`;
        if (days < 7) return `${days}d ago`;
        
        return date.toLocaleDateString();
    },
    
    updateNotificationBadge() {
        const badge = document.getElementById('notificationCount');
        if (!badge) return;
        
        const unreadCount = AppState.notifications.filter(n => !n.read).length;
        AppState.unreadNotifications = unreadCount;
        
        if (unreadCount > 0) {
            badge.textContent = unreadCount > 9 ? '9+' : unreadCount.toString();
            badge.style.display = 'flex';
        } else {
            badge.style.display = 'none';
        }
    },
    
    async handleNotificationClick(notificationId) {
        try {
            // Mark as read
            await FirebaseManager.markNotificationAsRead(notificationId);
            
            // Find notification
            const notification = AppState.notifications.find(n => n.id === notificationId);
            if (notification) {
                // Handle notification action
                if (notification.action) {
                    this.handleNotificationAction(notification.action, notification.data);
                }
                
                // Reload notifications
                this.loadNotifications();
            }
        } catch (error) {
            console.error('Error handling notification click:', error);
        }
    },
    
    async markAllAsRead() {
        try {
            await FirebaseManager.markAllNotificationsAsRead();
            this.loadNotifications();
            EnhancedUIUpdater.showToast('All notifications marked as read', 'success');
        } catch (error) {
            console.error('Error marking all as read:', error);
            EnhancedUIUpdater.showToast('Error marking notifications as read', 'error');
        }
    },
    
    handleNotificationAction(action, data) {
        switch(action) {
            case 'view_ride':
                if (data.rideId) {
                    FirebaseManager.loadRideDetails(data.rideId);
                }
                break;
                
            case 'accept_split_invitation':
                if (data.invitationId) {
                    SplitRideManager.handleSplitRideInvitation(data.invitationId, 'accept');
                }
                break;
                
            case 'reject_split_invitation':
                if (data.invitationId) {
                    SplitRideManager.handleSplitRideInvitation(data.invitationId, 'reject');
                }
                break;
                
            case 'accept_broadcast_invitation':
                if (data.broadcastId) {
                    BroadcastRideManager.handleBroadcastInvitation(data.broadcastId, 'accept');
                }
                break;
                
            case 'view_wallet_transaction':
                WalletManager.showTransactionsModal();
                break;
                
            case 'emergency_alert':
                if (data.contactName) {
                    EnhancedUIUpdater.showToast(`Emergency alert from ${data.contactName}`, 'error');
                }
                break;
        }
    },
    
    startRealtimeNotifications() {
        // Listen for new notifications
        const notificationsRef = database.ref(`notifications/${AppState.currentUser.uid}`);
        
        notificationsRef.orderByChild('timestamp').limitToLast(1).on('child_added', (snapshot) => {
            const notification = snapshot.val();
            if (notification && !notification.read) {
                // Show desktop notification if supported
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification(notification.title, {
                        body: notification.message,
                        icon: '/jubel.png'
                    });
                }
                
                // Reload notifications
                this.loadNotifications();
            }
        });
    },
    
    async requestNotificationPermission() {
        if ('Notification' in window) {
            if (Notification.permission === 'default') {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    console.log('Notification permission granted');
                }
            }
        }
    },
    
    async sendNotification(title, message, type = 'info', data = null) {
        try {
            const notification = {
                title: title,
                message: message,
                type: type,
                data: data,
                read: false,
                timestamp: Date.now()
            };
            
            await FirebaseManager.addNotification(notification);
            
            // Update local notifications
            this.loadNotifications();
            
        } catch (error) {
            console.error('Error sending notification:', error);
        }
    }
};

// ============================================
// MODAL MANAGER
// ============================================
const ModalManager = {
    show(modalName) {
        const modal = document.getElementById(`${modalName}Modal`);
        if (modal) {
            modal.style.display = 'block';
            
            // Bring to front
            modal.style.zIndex = '10000';
        }
    },
    
    hide(modalName) {
        const modal = document.getElementById(`${modalName}Modal`);
        if (modal) {
            modal.style.display = 'none';
        }
    },
    
    hideAll() {
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.style.display = 'none';
        });
    },
    
    showOverlay() {
        const overlay = document.createElement('div');
        overlay.id = 'modalOverlay';
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
            display: block;
        `;
        document.body.appendChild(overlay);
    },
    
    hideOverlay() {
        const overlay = document.getElementById('modalOverlay');
        if (overlay) {
            overlay.remove();
        }
    }
};

// ============================================
// ENHANCED UI UPDATER
// ============================================
const EnhancedUIUpdater = {
    updateWalletBalance(balance) {
        // Update wallet balance in multiple locations
        const elements = [
            'walletBalance', 'accountBalance', 'paymentBalance',
            'transferBalance', 'withdrawBalance'
        ];
        
        elements.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = `ZMW ${balance.toFixed(2)}`;
            }
        });
        
        // Update AppState
        AppState.walletBalance = balance;
    },
    
    updateUserInfo(userData) {
        // Update user name
        const nameElements = ['userFullName', 'accountName'];
        nameElements.forEach(id => {
            const element = document.getElementById(id);
            if (element && userData.name) {
                element.textContent = userData.name;
            }
        });
        
        // Update user phone
        const phoneElement = document.getElementById('accountPhone');
        if (phoneElement && userData.phone) {
            phoneElement.textContent = userData.phone;
        }
        
        // Update email
        const emailElement = document.getElementById('updateEmail');
        if (emailElement && userData.email) {
            emailElement.value = userData.email;
        }
        
        // Update referral code
        const referralElement = document.getElementById('referralCode');
        if (referralElement && userData.referralCode) {
            referralElement.textContent = userData.referralCode;
        }
    },
    
    updateCityDisplay(city) {
        const display = document.getElementById('currentCityDisplay');
        if (display && city) {
            display.textContent = `City: ${city}`;
            display.parentElement.style.display = 'flex';
            
            // Hide after 5 seconds
            setTimeout(() => {
                if (display.parentElement) {
                    display.parentElement.style.display = 'none';
                }
            }, 5000);
        }
    },
    
    showToast(message, type = 'info', duration = 5000) {
        // Create toast container if it doesn't exist
        let container = document.getElementById('toastContainer');
        if (!container) {
            container = document.createElement('div');
            container.id = 'toastContainer';
            container.className = 'toast-container';
            document.body.appendChild(container);
        }
        
        // Create toast
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        let icon = 'fa-info-circle';
        switch(type) {
            case 'success': icon = 'fa-check-circle'; break;
            case 'error': icon = 'fa-exclamation-circle'; break;
            case 'warning': icon = 'fa-exclamation-triangle'; break;
        }
        
        toast.innerHTML = `
            <div class="toast-icon">
                <i class="fas ${icon}"></i>
            </div>
            <div class="toast-message">${message}</div>
            <button class="toast-close">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        container.appendChild(toast);
        
        // Show toast
        setTimeout(() => {
            toast.classList.add('show');
        }, 10);
        
        // Close button
        const closeBtn = toast.querySelector('.toast-close');
        closeBtn.addEventListener('click', () => {
            this.hideToast(toast);
        });
        
        // Auto hide
        setTimeout(() => {
            this.hideToast(toast);
        }, duration);
        
        return toast;
    },
    
    hideToast(toastElement) {
        if (toastElement) {
            toastElement.classList.remove('show');
            setTimeout(() => {
                if (toastElement.parentNode) {
                    toastElement.parentNode.removeChild(toastElement);
                }
            }, 300);
        }
    },
    
    showLoading(message = 'Loading...') {
        let overlay = document.getElementById('loadingOverlay');
        if (!overlay) {
            overlay = document.createElement('div');
            overlay.id = 'loadingOverlay';
            overlay.className = 'loading-overlay';
            overlay.innerHTML = `
                <div class="loading-spinner"></div>
                <div class="loading-text">${message}</div>
            `;
            document.body.appendChild(overlay);
        } else {
            const text = overlay.querySelector('.loading-text');
            if (text) {
                text.textContent = message;
            }
        }
        
        overlay.style.display = 'flex';
    },
    
    hideLoading() {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
            overlay.style.display = 'none';
        }
    },
    
    showMapLoading() {
        const overlay = document.getElementById('mapLoadingOverlay');
        if (overlay) {
            overlay.style.display = 'flex';
        }
    },
    
    hideMapLoading() {
        const overlay = document.getElementById('mapLoadingOverlay');
        if (overlay) {
            overlay.style.display = 'none';
        }
    },
    
    updateRideStatus(status) {
        const statusBar = document.getElementById('rideStatusBar');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const etaText = document.getElementById('etaText');
        
        if (!statusBar || !statusDot || !statusText || !etaText) return;
        
        statusBar.style.display = 'flex';
        
        switch(status) {
            case 'requested':
                statusDot.className = 'status-dot searching';
                statusText.textContent = 'Searching for driver';
                etaText.textContent = '5-10 min';
                break;
                
            case 'accepted':
                statusDot.className = 'status-dot arriving';
                statusText.textContent = 'Driver on the way';
                etaText.textContent = '5 min';
                break;
                
            case 'arrived':
                statusDot.className = 'status-dot arrived';
                statusText.textContent = 'Driver arrived';
                etaText.textContent = '0 min';
                break;
                
            case 'started':
                statusDot.className = 'status-dot riding';
                statusText.textContent = 'Trip in progress';
                etaText.textContent = 'En route';
                break;
                
            case 'completed':
                statusBar.style.display = 'none';
                break;
                
            case 'cancelled':
                statusBar.style.display = 'none';
                break;
        }
    },
    
    showRideInfo(ride) {
        // Hide all forms
        document.querySelectorAll('.ride-request-form, .service-form').forEach(form => {
            form.style.display = 'none';
        });
        
        // Show ride info panel
        const rideInfoPanel = document.getElementById('rideInfoPanel');
        if (rideInfoPanel) {
            rideInfoPanel.style.display = 'block';
            
            // Update ride info
            this.updateRideDetails(ride);
            
            // Update timeline
            this.updateTimeline(ride.status);
            
            // Show SOS button if ride is active and SOS is configured
            const sosButton = document.getElementById('sosButton');
            if (sosButton && ride.status === 'accepted' && AppState.sosConfig) {
                sosButton.style.display = 'flex';
            }
        }
    },
    
    updateRideDetails(ride) {
        // Update pickup and destination
        const pickupElement = document.getElementById('currentPickup');
        const destinationElement = document.getElementById('currentDestination');
        
        if (pickupElement) {
            pickupElement.textContent = ride.pickupDisplay || ride.pickup || 'Loading...';
        }
        
        if (destinationElement) {
            destinationElement.textContent = ride.destinationDisplay || ride.destination || 'Loading...';
        }
        
        // Update distance and time
        const distanceElement = document.getElementById('rideDistance');
        const timeElement = document.getElementById('rideTime');
        
        if (distanceElement && ride.distance) {
            distanceElement.textContent = `${ride.distance.toFixed(1)} km`;
        }
        
        if (timeElement && ride.estimatedTime) {
            timeElement.textContent = `${ride.estimatedTime} min`;
        }
        
        // Update fare
        const totalFareElement = document.getElementById('totalFareValue');
        if (totalFareElement && ride.fare) {
            totalFareElement.textContent = `ZMW ${ride.fare.toFixed(2)}`;
        }
    },
    
    updateTimeline(status) {
        const steps = ['stepRequested', 'stepAccepted', 'stepArrived', 'stepStarted', 'stepCompleted'];
        const currentStep = this.getCurrentStepIndex(status);
        
        steps.forEach((stepId, index) => {
            const stepElement = document.getElementById(stepId);
            if (stepElement) {
                if (index < currentStep) {
                    stepElement.className = 'step-dot completed';
                } else if (index === currentStep) {
                    stepElement.className = 'step-dot active';
                } else {
                    stepElement.className = 'step-dot';
                }
            }
        });
    },
    
    getCurrentStepIndex(status) {
        switch(status) {
            case 'requested': return 0;
            case 'accepted': return 1;
            case 'arrived': return 2;
            case 'started': return 3;
            case 'completed': return 4;
            default: return 0;
        }
    },
    
    updateDriverInfo(driver) {
        const driverName = document.getElementById('driverName');
        const driverRating = document.getElementById('driverRating');
        const vehicleDetails = document.getElementById('vehicleDetails');
        
        if (driverName && driver.name) {
            driverName.textContent = driver.name;
        }
        
        if (driverRating && driver.rating) {
            driverRating.textContent = driver.rating.toFixed(1);
        }
        
        if (vehicleDetails && driver.vehicle) {
            vehicleDetails.textContent = `${driver.vehicle.model} - ${driver.vehicle.plate}`;
        }
    },
    
    showChatMessage(message, isSender = false) {
        const container = document.getElementById('chatMessages');
        if (!container) return;
        
        const messageElement = document.createElement('div');
        messageElement.className = `message ${isSender ? 'sent' : 'received'}`;
        
        const time = new Date(message.timestamp);
        const timeString = time.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        messageElement.innerHTML = `
            <div class="message-content">${message.text}</div>
            <div class="message-time">${timeString}</div>
        `;
        
        container.appendChild(messageElement);
        container.scrollTop = container.scrollHeight;
    },
    
    updateTypingIndicator(isTyping) {
        const indicator = document.getElementById('typingIndicator');
        if (indicator) {
            indicator.style.display = isTyping ? 'block' : 'none';
        }
    },
    
    showSyncIndicator(isSyncing) {
        const indicator = document.getElementById('syncIndicator');
        if (indicator) {
            if (isSyncing) {
                indicator.classList.add('active');
            } else {
                indicator.classList.remove('active');
            }
        }
    },
    
    showRealTimeIndicator() {
        const indicator = document.getElementById('realTimeIndicator');
        if (indicator) {
            indicator.classList.add('active');
            setTimeout(() => {
                indicator.classList.remove('active');
            }, 3000);
        }
    }
};

// ============================================
// FIREBASE MANAGER
// ============================================
const FirebaseManager = {
    // User management
    async loadUserData(uid) {
        try {
            const snapshot = await database.ref(`users/${uid}`).once('value');
            const userData = snapshot.val();
            
            if (userData) {
                AppState.userData = userData;
                AppState.walletBalance = userData.walletBalance || 0;
                
                // Update UI
                EnhancedUIUpdater.updateUserInfo(userData);
                EnhancedUIUpdater.updateWalletBalance(AppState.walletBalance);
                
                return userData;
            }
            return null;
        } catch (error) {
            console.error('Error loading user data:', error);
            throw error;
        }
    },
    
    async updateUserData(uid, data) {
        try {
            await database.ref(`users/${uid}`).update(data);
            
            // Update local data
            if (AppState.userData) {
                AppState.userData = { ...AppState.userData, ...data };
            }
            
            return true;
        } catch (error) {
            console.error('Error updating user data:', error);
            throw error;
        }
    },
    
    async findUserByReferralCode(referralCode) {
        try {
            const snapshot = await database.ref('users')
                .orderByChild('referralCode')
                .equalTo(referralCode)
                .once('value');
            
            const users = snapshot.val();
            if (users) {
                const userId = Object.keys(users)[0];
                return { id: userId, ...users[userId] };
            }
            return null;
        } catch (error) {
            console.error('Error finding user by referral code:', error);
            throw error;
        }
    },
    
    // Wallet management
    async getWalletBalance() {
        if (!AppState.currentUser) return 0;
        
        try {
            const snapshot = await database.ref(`users/${AppState.currentUser.uid}/walletBalance`).once('value');
            return snapshot.val() || 0;
        } catch (error) {
            console.error('Error getting wallet balance:', error);
            return 0;
        }
    },
    
    async addToWalletBalance(amount, userId = null) {
        const uid = userId || AppState.currentUser.uid;
        
        try {
            const currentBalance = await this.getWalletBalance();
            const newBalance = currentBalance + amount;
            
            await database.ref(`users/${uid}/walletBalance`).set(newBalance);
            
            // Update local state
            if (uid === AppState.currentUser.uid) {
                AppState.walletBalance = newBalance;
                EnhancedUIUpdater.updateWalletBalance(newBalance);
            }
            
            return newBalance;
        } catch (error) {
            console.error('Error adding to wallet balance:', error);
            throw error;
        }
    },
    
    async deductFromWalletBalance(amount, userId = null) {
        const uid = userId || AppState.currentUser.uid;
        
        try {
            const currentBalance = await this.getWalletBalance();
            const newBalance = currentBalance - amount;
            
            if (newBalance < 0) {
                throw new Error('Insufficient balance');
            }
            
            await database.ref(`users/${uid}/walletBalance`).set(newBalance);
            
            // Update local state
            if (uid === AppState.currentUser.uid) {
                AppState.walletBalance = newBalance;
                EnhancedUIUpdater.updateWalletBalance(newBalance);
            }
            
            return newBalance;
        } catch (error) {
            console.error('Error deducting from wallet balance:', error);
            throw error;
        }
    },
    
    async getWalletTransactions() {
        if (!AppState.currentUser) return [];
        
        try {
            const snapshot = await database.ref(`walletTransactions/${AppState.currentUser.uid}`)
                .orderByChild('timestamp')
                .limitToLast(50)
                .once('value');
            
            const transactions = snapshot.val();
            if (transactions) {
                return Object.entries(transactions)
                    .map(([id, transaction]) => ({ id, ...transaction }))
                    .sort((a, b) => b.timestamp - a.timestamp);
            }
            return [];
        } catch (error) {
            console.error('Error getting wallet transactions:', error);
            return [];
        }
    },
    
    async addWalletTransaction(transaction, userId = null) {
        const uid = userId || AppState.currentUser.uid;
        
        try {
            const transactionId = database.ref().child('walletTransactions').child(uid).push().key;
            await database.ref(`walletTransactions/${uid}/${transactionId}`).set(transaction);
            return transactionId;
        } catch (error) {
            console.error('Error adding wallet transaction:', error);
            throw error;
        }
    },
    
    // Ride management
    async requestRide(rideData) {
        try {
            const rideId = database.ref().child('rides').push().key;
            
            const ride = {
                id: rideId,
                ...rideData,
                passengerId: AppState.currentUser.uid,
                passengerName: AppState.userData.name,
                status: 'requested',
                timestamp: Date.now(),
                city: AppState.currentCity
            };
            
            await database.ref(`rides/${rideId}`).set(ride);
            
            // Add to user's ride history
            await database.ref(`userRides/${AppState.currentUser.uid}/${rideId}`).set({
                rideId: rideId,
                timestamp: ride.timestamp
            });
            
            // Start listening to ride updates
            this.listenToRideUpdates(rideId);
            
            return rideId;
        } catch (error) {
            console.error('Error requesting ride:', error);
            throw error;
        }
    },
    
    async requestDelivery(deliveryData) {
        // Similar to requestRide but for deliveries
        return this.requestRide({
            ...deliveryData,
            serviceType: 'delivery'
        });
    },
    
    async requestTruck(truckData) {
        // Similar to requestRide but for trucks
        return this.requestRide({
            ...truckData,
            serviceType: 'truck'
        });
    },
    
    async requestShopping(shoppingData) {
        // Similar to requestRide but for shopping
        return this.requestRide({
            ...shoppingData,
            serviceType: 'shopping'
        });
    },
    
    async requestEmergency(emergencyData) {
        // Similar to requestRide but for emergencies
        return this.requestRide({
            ...emergencyData,
            serviceType: 'emergency',
            emergency: true
        });
    },
    
    async cancelRide(rideId, reason) {
        try {
            await database.ref(`rides/${rideId}`).update({
                status: 'cancelled',
                cancellationReason: reason,
                cancelledAt: Date.now()
            });
            
            // Process refund if payment was made
            const rideSnapshot = await database.ref(`rides/${rideId}`).once('value');
            const ride = rideSnapshot.val();
            
            if (ride.paymentMethod === 'wallet' && ride.fare) {
                await PaymentManager.processRefund(rideId, AppState.currentUser.uid, ride.fare, reason);
            }
            
            return true;
        } catch (error) {
            console.error('Error cancelling ride:', error);
            throw error;
        }
    },
    
    async getRideHistory() {
        if (!AppState.currentUser) return [];
        
        try {
            const snapshot = await database.ref(`userRides/${AppState.currentUser.uid}`)
                .orderByChild('timestamp')
                .limitToLast(50)
                .once('value');
            
            const rideRefs = snapshot.val();
            if (!rideRefs) return [];
            
            const rides = [];
            
            for (const [rideId, ref] of Object.entries(rideRefs)) {
                const rideSnapshot = await database.ref(`rides/${rideId}`).once('value');
                const ride = rideSnapshot.val();
                if (ride) {
                    rides.push({ id: rideId, ...ride });
                }
            }
            
            return rides.sort((a, b) => b.timestamp - a.timestamp);
        } catch (error) {
            console.error('Error getting ride history:', error);
            return [];
        }
    },
    
    // Split ride management
    async createSplitRideInvitation(splitRideData) {
        try {
            const invitationId = database.ref().child('splitRideInvitations').push().key;
            
            await database.ref(`splitRideInvitations/${invitationId}`).set({
                ...splitRideData,
                id: invitationId,
                status: 'pending',
                createdAt: Date.now()
            });
            
            return invitationId;
        } catch (error) {
            console.error('Error creating split ride invitation:', error);
            throw error;
        }
    },
    
    async sendSplitRideInvitation(invitationId, friendId, invitationData) {
        try {
            await database.ref(`userSplitInvitations/${friendId}/${invitationId}`).set({
                invitationId: invitationId,
                status: 'pending',
                receivedAt: Date.now()
            });
            
            // Send notification
            await NotificationsManager.sendNotification(
                'Split Ride Invitation',
                `${invitationData.hostName} invited you to split a ride`,
                'split_ride',
                {
                    invitationId: invitationId,
                    action: 'accept_split_invitation'
                }
            );
            
            return true;
        } catch (error) {
            console.error('Error sending split ride invitation:', error);
            throw error;
        }
    },
    
    async respondToSplitRideInvitation(invitationId, response) {
        try {
            await database.ref(`splitRideInvitations/${invitationId}/friends/${AppState.currentUser.uid}`).update({
                status: response,
                respondedAt: Date.now()
            });
            
            return true;
        } catch (error) {
            console.error('Error responding to split ride invitation:', error);
            throw error;
        }
    },
    
    async createSplitRide(splitRideData) {
        // Similar to requestRide but for split rides
        return this.requestRide({
            ...splitRideData,
            splitRide: true
        });
    },
    
    async cancelSplitRide(invitationId) {
        try {
            await database.ref(`splitRideInvitations/${invitationId}`).update({
                status: 'cancelled',
                cancelledAt: Date.now()
            });
            
            return true;
        } catch (error) {
            console.error('Error cancelling split ride:', error);
            throw error;
        }
    },
    
    // Broadcast management
    async createBroadcast(broadcastData) {
        try {
            const broadcastId = database.ref().child('broadcasts').push().key;
            
            await database.ref(`broadcasts/${broadcastId}`).set({
                ...broadcastData,
                id: broadcastId,
                status: 'active',
                createdAt: Date.now()
            });
            
            return broadcastId;
        } catch (error) {
            console.error('Error creating broadcast:', error);
            throw error;
        }
    },
    
    async sendBroadcastInvitation(broadcastId, recipientId, broadcastData) {
        try {
            await database.ref(`userBroadcastInvitations/${recipientId}/${broadcastId}`).set({
                broadcastId: broadcastId,
                status: 'pending',
                receivedAt: Date.now()
            });
            
            // Send notification
            await NotificationsManager.sendNotification(
                'Broadcast Ride Invitation',
                `${broadcastData.hostName} is sharing their ride with you`,
                'broadcast',
                {
                    broadcastId: broadcastId,
                    action: 'accept_broadcast_invitation'
                }
            );
            
            return true;
        } catch (error) {
            console.error('Error sending broadcast invitation:', error);
            throw error;
        }
    },
    
    async respondToBroadcastInvitation(invitationId, response) {
        try {
            const invitationSnapshot = await database.ref(`userBroadcastInvitations/${AppState.currentUser.uid}/${invitationId}`).once('value');
            const invitation = invitationSnapshot.val();
            
            if (invitation) {
                const broadcastId = invitation.broadcastId;
                
                await database.ref(`broadcasts/${broadcastId}/recipients/${AppState.currentUser.uid}`).update({
                    status: response === 'accept' ? 'watching' : 'declined',
                    respondedAt: Date.now()
                });
                
                // Update invitation status
                await database.ref(`userBroadcastInvitations/${AppState.currentUser.uid}/${invitationId}`).update({
                    status: response === 'accept' ? 'accepted' : 'declined'
                });
            }
            
            return true;
        } catch (error) {
            console.error('Error responding to broadcast invitation:', error);
            throw error;
        }
    },
    
    async stopBroadcast(broadcastId) {
        try {
            await database.ref(`broadcasts/${broadcastId}`).update({
                status: 'stopped',
                stoppedAt: Date.now()
            });
            
            return true;
        } catch (error) {
            console.error('Error stopping broadcast:', error);
            throw error;
        }
    },
    
    // Scheduled rides
    async createScheduledRide(scheduleData) {
        try {
            const scheduleId = database.ref().child('scheduledRides').push().key;
            
            await database.ref(`scheduledRides/${scheduleId}`).set({
                ...scheduleData,
                id: scheduleId,
                status: 'scheduled'
            });
            
            return scheduleId;
        } catch (error) {
            console.error('Error creating scheduled ride:', error);
            throw error;
        }
    },
    
    async getScheduledRides() {
        if (!AppState.currentUser) return [];
        
        try {
            const snapshot = await database.ref('scheduledRides')
                .orderByChild('userId')
                .equalTo(AppState.currentUser.uid)
                .once('value');
            
            const schedules = snapshot.val();
            if (schedules) {
                return Object.entries(schedules)
                    .map(([id, schedule]) => ({ id, ...schedule }))
                    .filter(schedule => schedule.status === 'scheduled')
                    .sort((a, b) => a.scheduledTime - b.scheduledTime);
            }
            return [];
        } catch (error) {
            console.error('Error getting scheduled rides:', error);
            return [];
        }
    },
    
    async updateScheduledRideStatus(scheduleId, status) {
        try {
            await database.ref(`scheduledRides/${scheduleId}`).update({
                status: status,
                updatedAt: Date.now()
            });
            
            return true;
        } catch (error) {
            console.error('Error updating scheduled ride status:', error);
            throw error;
        }
    },
    
    async cancelScheduledRide(scheduleId) {
        try {
            await database.ref(`scheduledRides/${scheduleId}`).update({
                status: 'cancelled',
                cancelledAt: Date.now()
            });
            
            return true;
        } catch (error) {
            console.error('Error cancelling scheduled ride:', error);
            throw error;
        }
    },
    
    // SOS management
    async saveSOSConfig(sosConfig) {
        if (!AppState.currentUser) return false;
        
        try {
            await database.ref(`sosConfig/${AppState.currentUser.uid}`).set(sosConfig);
            
            // Update local state
            AppState.sosConfig = sosConfig;
            
            return true;
        } catch (error) {
            console.error('Error saving SOS config:', error);
            throw error;
        }
    },
    
    async sendSOSAlert(sosData) {
        try {
            const sosId = database.ref().child('sosAlerts').push().key;
            
            await database.ref(`sosAlerts/${sosId}`).set({
                ...sosData,
                id: sosId,
                status: 'active',
                sentAt: Date.now()
            });
            
            // Send notifications to emergency contacts
            if (sosData.contacts.contact1Phone) {
                // In a real app, you would send SMS or call here
                console.log(`Sending SOS alert to ${sosData.contacts.contact1Phone}`);
            }
            
            if (sosData.contacts.contact2Phone) {
                console.log(`Sending SOS alert to ${sosData.contacts.contact2Phone}`);
            }
            
            return sosId;
        } catch (error) {
            console.error('Error sending SOS alert:', error);
            throw error;
        }
    },
    
    // Notifications
    async getNotifications() {
        if (!AppState.currentUser) return [];
        
        try {
            const snapshot = await database.ref(`notifications/${AppState.currentUser.uid}`)
                .orderByChild('timestamp')
                .limitToLast(50)
                .once('value');
            
            const notifications = snapshot.val();
            if (notifications) {
                return Object.entries(notifications)
                    .map(([id, notification]) => ({ id, ...notification }))
                    .sort((a, b) => b.timestamp - a.timestamp);
            }
            return [];
        } catch (error) {
            console.error('Error getting notifications:', error);
            return [];
        }
    },
    
    async addNotification(notification) {
        if (!AppState.currentUser) return null;
        
        try {
            const notificationId = database.ref().child('notifications').child(AppState.currentUser.uid).push().key;
            await database.ref(`notifications/${AppState.currentUser.uid}/${notificationId}`).set(notification);
            return notificationId;
        } catch (error) {
            console.error('Error adding notification:', error);
            throw error;
        }
    },
    
    async markNotificationAsRead(notificationId) {
        if (!AppState.currentUser) return false;
        
        try {
            await database.ref(`notifications/${AppState.currentUser.uid}/${notificationId}/read`).set(true);
            return true;
        } catch (error) {
            console.error('Error marking notification as read:', error);
            throw error;
        }
    },
    
    async markAllNotificationsAsRead() {
        if (!AppState.currentUser) return false;
        
        try {
            const snapshot = await database.ref(`notifications/${AppState.currentUser.uid}`).once('value');
            const notifications = snapshot.val();
            
            if (notifications) {
                const updates = {};
                Object.keys(notifications).forEach(id => {
                    updates[`${id}/read`] = true;
                });
                
                await database.ref(`notifications/${AppState.currentUser.uid}`).update(updates);
            }
            
            return true;
        } catch (error) {
            console.error('Error marking all notifications as read:', error);
            throw error;
        }
    },
    
    // Referral system
    async validateReferralCode(referralCode) {
        try {
            const userData = await this.findUserByReferralCode(referralCode);
            
            if (userData) {
                return {
                    valid: true,
                    userId: userData.id,
                    name: userData.name
                };
            }
            
            return {
                valid: false,
                error: 'Invalid referral code'
            };
        } catch (error) {
            console.error('Error validating referral code:', error);
            throw error;
        }
    },
    
    async processReferralEarnings(rideId, referrerId, referredUserId, amount) {
        try {
            // Record referral
            await database.ref(`referrals/${rideId}`).set({
                rideId: rideId,
                referrerId: referrerId,
                referredUserId: referredUserId,
                amount: amount,
                status: 'pending',
                createdAt: Date.now()
            });
            
            // The actual payment will be processed when the ride is completed
            return true;
        } catch (error) {
            console.error('Error processing referral earnings:', error);
            throw error;
        }
    },
    
    async completeReferralPayment(rideId) {
        try {
            const referralSnapshot = await database.ref(`referrals/${rideId}`).once('value');
            const referral = referralSnapshot.val();
            
            if (referral && referral.status === 'pending') {
                // Update referral status
                await database.ref(`referrals/${rideId}`).update({
                    status: 'completed',
                    completedAt: Date.now()
                });
                
                // Process payment to referrer
                await PaymentManager.processReferralEarnings(
                    referral.referrerId,
                    referral.amount,
                    referral.referredUserId,
                    rideId
                );
                
                return true;
            }
            
            return false;
        } catch (error) {
            console.error('Error completing referral payment:', error);
            throw error;
        }
    },
    
    // Real-time listeners
    listenToRideUpdates(rideId) {
        const rideRef = database.ref(`rides/${rideId}`);
        
        rideRef.on('value', (snapshot) => {
            const ride = snapshot.val();
            if (ride) {
                AppState.currentRide = { id: rideId, ...ride };
                
                // Update UI
                EnhancedUIUpdater.showRideInfo(AppState.currentRide);
                EnhancedUIUpdater.updateRideStatus(ride.status);
                
                // If ride has driver, listen to driver location
                if (ride.driverId) {
                    this.listenToDriverLocation(ride.driverId);
                    
                    // Load driver info
                    this.loadDriverInfo(ride.driverId);
                }
                
                // If ride is completed, process referral if applicable
                if (ride.status === 'completed' && ride.referrerId) {
                    this.completeReferralPayment(rideId);
                }
            }
        });
    },
    
    listenToDriverLocation(driverId) {
        const locationRef = database.ref(`driverLocations/${driverId}`);
        
        locationRef.on('value', (snapshot) => {
            const location = snapshot.val();
            if (location) {
                AppState.driverLocation = {
                    lat: location.latitude,
                    lng: location.longitude
                };
                
                // Update driver marker on map
                MapManager.updateDriverMarker(AppState.driverLocation);
            }
        });
    },
    
    async loadDriverInfo(driverId) {
        try {
            const snapshot = await database.ref(`users/${driverId}`).once('value');
            const driver = snapshot.val();
            
            if (driver) {
                AppState.selectedVehicle = driver;
                EnhancedUIUpdater.updateDriverInfo(driver);
            }
        } catch (error) {
            console.error('Error loading driver info:', error);
        }
    },
    
    // Chat
    async sendChatMessage(rideId, message, isDriver = false) {
        try {
            const messageId = database.ref().child('chats').child(rideId).child('messages').push().key;
            
            const chatMessage = {
                id: messageId,
                text: message,
                senderId: AppState.currentUser.uid,
                senderName: AppState.userData.name,
                isDriver: isDriver,
                timestamp: Date.now()
            };
            
            await database.ref(`chats/${rideId}/messages/${messageId}`).set(chatMessage);
            
            return messageId;
        } catch (error) {
            console.error('Error sending chat message:', error);
            throw error;
        }
    },
    
    listenToChatMessages(rideId) {
        const chatRef = database.ref(`chats/${rideId}/messages`).orderByChild('timestamp').limitToLast(50);
        
        chatRef.on('child_added', (snapshot) => {
            const message = snapshot.val();
            if (message) {
                const isSender = message.senderId === AppState.currentUser.uid;
                EnhancedUIUpdater.showChatMessage(message, isSender);
            }
        });
    },
    
    // Start real-time sync for user
    startRealtimeSync() {
        // Listen for wallet balance changes
        if (AppState.currentUser) {
            const walletRef = database.ref(`users/${AppState.currentUser.uid}/walletBalance`);
            
            walletRef.on('value', (snapshot) => {
                const balance = snapshot.val() || 0;
                if (balance !== AppState.walletBalance) {
                    AppState.walletBalance = balance;
                    EnhancedUIUpdater.updateWalletBalance(balance);
                }
            });
        }
        
        EnhancedUIUpdater.showRealTimeIndicator();
    },
    
    // Stop all real-time listeners
    stopRealtimeSync() {
        // In a real implementation, you would keep track of all listeners
        // and detach them here
        console.log('Stopping real-time sync');
    }
};

// ============================================
// APP INITIALIZATION
// ============================================
async function initializeApp() {
    try {
        console.log('Initializing Jubel Passenger App...');
        
        // Show loading
        EnhancedUIUpdater.showLoading('Initializing app...');
        
        // Initialize modules
        EnhancedSearchEngine.init();
        LocationInputManager.init();
        MapManager.init();
        StopsManager.init();
        SplitRideManager.init();
        BroadcastRideManager.init();
        EmergencyManager.init();
        ShoppingManager.init();
        ScheduledRideManager.init();
        WalletManager.init();
        PaymentManager.init();
        NotificationsManager.init();
        
        // Check authentication
        const urlParams = new URLSearchParams(window.location.search);
        const email = urlParams.get('email');
        const uid = urlParams.get('uid');
        
        if (email && uid) {
            // Authenticated via URL parameters
            AppState.currentUser = { uid, email };
            await FirebaseManager.loadUserData(uid);
        } else {
            // Check Firebase auth state
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    console.log('User authenticated:', user.uid);
                    AppState.currentUser = user;
                    await FirebaseManager.loadUserData(user.uid);
                } else {
                    console.log('No user logged in');
                    // Redirect to signup page
                    window.location.href = 'signup.html';
                }
            });
        }
        
        // Get current location
        await getCurrentLocation();
        
        // Start real-time sync
        FirebaseManager.startRealtimeSync();
        
        // Setup event listeners
        setupEventListeners();
        
        // Request notification permission
        await NotificationsManager.requestNotificationPermission();
        
        // Hide loading
        EnhancedUIUpdater.hideLoading();
        
        console.log('App initialization completed successfully');
        
        // Show welcome message
        EnhancedUIUpdater.showToast('Jubel Passenger App Ready', 'success');
        
    } catch (error) {
        console.error('Error initializing app:', error);
        EnhancedUIUpdater.hideLoading();
        EnhancedUIUpdater.showToast('Error initializing app', 'error');
    }
}

// ============================================
// LOCATION FUNCTIONS
// ============================================
async function getCurrentLocation() {
    return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
            EnhancedUIUpdater.showToast('Geolocation is not supported by your browser', 'warning');
            reject(new Error('Geolocation not supported'));
            return;
        }
        
        navigator.geolocation.getCurrentPosition(
            async (position) => {
                const { latitude, longitude } = position.coords;
                
                // Update user location
                AppState.userLocation = { lat: latitude, lng: longitude };
                
                // Update map
                MapManager.updateCurrentLocation(latitude, longitude);
                
                // Detect city
                const city = await CityDetector.detectCityFromLocation(latitude, longitude);
                if (city) {
                    AppState.currentCity = city;
                    EnhancedUIUpdater.updateCityDisplay(city);
                    
                    // Update pickup location with current address
                    const address = await CityDetector.getDetailedAddress(latitude, longitude);
                    
                    // Update all pickup inputs
                    document.querySelectorAll('input[id$="Pickup"], input[id$="pickup"]').forEach(input => {
                        if (input && !input.value) {
                            input.value = address.address;
                            input.dataset.lat = latitude;
                            input.dataset.lng = longitude;
                            input.dataset.address = address.address;
                            
                            // Update AppState pickup
                            if (!AppState.pickup) {
                                AppState.pickup = {
                                    lat: latitude,
                                    lng: longitude,
                                    name: 'Current Location',
                                    address: address.address
                                };
                            }
                        }
                    });
                } else {
                    EnhancedUIUpdater.showToast('Could not detect your city. Please ensure location services are enabled.', 'warning');
                }
                
                resolve({ latitude, longitude, city });
            },
            (error) => {
                console.error('Geolocation error:', error);
                EnhancedUIUpdater.showToast('Unable to get your location. Please enable location services.', 'warning');
                reject(error);
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            }
        );
    });
}

// ============================================
// EVENT LISTENERS SETUP
// ============================================
function setupEventListeners() {
    console.log('Setting up event listeners...');
    
    // Navigation tabs
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const screen = tab.dataset.screen;
            switchScreen(screen);
        });
    });
    
    // Back buttons
    document.querySelectorAll('.back-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            switchScreen('home');
        });
    });
    
    // Service tabs
    document.querySelectorAll('.service-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const service = tab.dataset.service;
            switchService(service);
        });
    });
    
    // Panel handle
    const panelHandle = document.getElementById('panelHandle');
    if (panelHandle) {
        panelHandle.addEventListener('click', () => {
            const panel = document.getElementById('mainPanel');
            panel.classList.toggle('collapsed');
        });
    }
    
    // Map controls
    const locateMeBtn = document.getElementById('locateMeBtn');
    if (locateMeBtn) {
        locateMeBtn.addEventListener('click', getCurrentLocation);
    }
    
    const zoomInBtn = document.getElementById('zoomInBtn');
    if (zoomInBtn) {
        zoomInBtn.addEventListener('click', () => {
            if (MapManager.map) {
                MapManager.map.zoomIn();
            }
        });
    }
    
    const zoomOutBtn = document.getElementById('zoomOutBtn');
    if (zoomOutBtn) {
        zoomOutBtn.addEventListener('click', () => {
            if (MapManager.map) {
                MapManager.map.zoomOut();
            }
        });
    }
    
    const clearRouteBtn = document.getElementById('clearRouteBtn');
    if (clearRouteBtn) {
        clearRouteBtn.addEventListener('click', () => {
            MapManager.removeRoute();
            MapManager.removeDestinationMarker();
            
            // Clear destination input
            const destinationInput = document.getElementById('destinationLocation');
            if (destinationInput) {
                destinationInput.value = '';
                AppState.destination = null;
            }
            
            EnhancedUIUpdater.showToast('Route cleared', 'info');
        });
    }
    
    // Request ride button
    const requestRideBtn = document.getElementById('requestRideBtn');
    if (requestRideBtn) {
        requestRideBtn.addEventListener('click', () => {
            if (!AppState.pickup || !AppState.destination) {
                EnhancedUIUpdater.showToast('Please select pickup and destination locations', 'warning');
                return;
            }
            
            // Calculate price if not already calculated
            if (!AppState.rideFare || AppState.rideFare === 0) {
                PriceCalculator.calculateAndUpdatePrice();
            }
            
            // Prepare ride data
            const rideData = {
                pickup: AppState.pickup.name,
                pickupDisplay: AppState.pickup.address,
                destination: AppState.destination.name,
                destinationDisplay: AppState.destination.address,
                pickupLat: AppState.pickup.lat,
                pickupLng: AppState.pickup.lng,
                destLat: AppState.destination.lat,
                destLng: AppState.destination.lng,
                rideType: AppState.selectedRideType,
                fare: AppState.rideFare,
                distance: AppState.activeRoute?.distance || 0,
                estimatedTime: AppState.activeRoute?.duration || 0,
                stops: StopsManager.getStopsWithLocations()
            };
            
            // Show payment modal
            PaymentManager.showPaymentModal(rideData);
        });
    }
    
    // More options button
    const moreOptionsBtn = document.getElementById('moreOptionsBtn');
    if (moreOptionsBtn) {
        moreOptionsBtn.addEventListener('click', () => {
            const menu = document.getElementById('moreOptionsMenu');
            menu.classList.toggle('active');
        });
    }
    
    // More options menu items
    document.querySelectorAll('#moreOptionsMenu .dropdown-item').forEach(item => {
        item.addEventListener('click', () => {
            const option = item.dataset.option;
            handleMoreOption(option);
        });
    });
    
    // SOS button
    const sosButton = document.getElementById('sosButton');
    if (sosButton) {
        sosButton.addEventListener('click', () => {
            EmergencyManager.triggerSOS();
        });
    }
    
    // Chat buttons
    const openChatBtn = document.getElementById('openChatBtn');
    if (openChatBtn) {
        openChatBtn.addEventListener('click', () => {
            const chatContainer = document.getElementById('chatContainer');
            if (chatContainer) {
                chatContainer.classList.add('active');
            }
        });
    }
    
    const chatClose = document.getElementById('chatClose');
    if (chatClose) {
        chatClose.addEventListener('click', () => {
            const chatContainer = document.getElementById('chatContainer');
            if (chatContainer) {
                chatContainer.classList.remove('active');
            }
        });
    }
    
    const chatSend = document.getElementById('chatSend');
    const chatInput = document.getElementById('chatInput');
    if (chatSend && chatInput) {
        chatSend.addEventListener('click', async () => {
            const message = chatInput.value.trim();
            if (message && AppState.currentRide) {
                try {
                    await FirebaseManager.sendChatMessage(AppState.currentRide.id, message, false);
                    chatInput.value = '';
                } catch (error) {
                    EnhancedUIUpdater.showToast('Error sending message', 'error');
                }
            }
        });
        
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                chatSend.click();
            }
        });
    }
    
    // Cancel ride button
    const cancelRideBtn = document.getElementById('cancelRideBtn');
    if (cancelRideBtn) {
        cancelRideBtn.addEventListener('click', () => {
            if (AppState.currentRide) {
                showCancelModal();
            } else {
                EnhancedUIUpdater.showToast('No active ride to cancel', 'warning');
            }
        });
    }
    
    // Contact driver button
    const contactDriverBtn = document.getElementById('contactDriverBtn');
    if (contactDriverBtn) {
        contactDriverBtn.addEventListener('click', () => {
            if (AppState.currentRide?.driverId) {
                const driverPhone = AppState.selectedVehicle?.phone;
                if (driverPhone) {
                    window.open(`tel:${driverPhone}`, '_blank');
                } else {
                    EnhancedUIUpdater.showToast('Driver phone number not available', 'warning');
                }
            } else {
                EnhancedUIUpdater.showToast('No driver assigned yet', 'warning');
            }
        });
    }
    
    // Close modals when clicking outside
    document.addEventListener('click', (e) => {
        // Close more options menu
        const moreOptionsMenu = document.getElementById('moreOptionsMenu');
        if (moreOptionsMenu && 
            !moreOptionsMenu.contains(e.target) && 
            !e.target.closest('#moreOptionsBtn')) {
            moreOptionsMenu.classList.remove('active');
        }
        
        // Close dropdown menu
        const dropdownMenu = document.getElementById('dropdownMenu');
        if (dropdownMenu && 
            !dropdownMenu.contains(e.target) && 
            !e.target.closest('.user-actions')) {
            dropdownMenu.classList.remove('active');
        }
    });
    
    // Prevent app refresh
    window.addEventListener('beforeunload', (e) => {
        if (AppState.currentRide && 
            ['requested', 'accepted', 'arrived', 'started'].includes(AppState.currentRide.status)) {
            e.preventDefault();
            e.returnValue = 'You have an active ride. Are you sure you want to leave?';
            return e.returnValue;
        }
    });
    
    // Keep app alive in background
    setInterval(() => {
        // Send heartbeat to keep real-time connections alive
        if (AppState.currentUser) {
            database.ref(`userPresence/${AppState.currentUser.uid}`).set({
                online: true,
                lastSeen: Date.now()
            });
        }
    }, 30000); // Every 30 seconds
    
    console.log('Event listeners setup completed');
}

// ============================================
// SCREEN MANAGEMENT
// ============================================
function switchScreen(screen) {
    console.log(`Switching to screen: ${screen}`);
    
    // Hide all screens
    document.querySelectorAll('.history-screen, .account-screen, .emergency-screen').forEach(s => {
        s.style.display = 'none';
    });
    
    // Hide home content if not home
    if (screen !== 'home') {
        document.getElementById('homeContent').style.display = 'none';
    }
    
    // Update active tab
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    const activeTab = document.querySelector(`.nav-tab[data-screen="${screen}"]`);
    if (activeTab) {
        activeTab.classList.add('active');
    }
    
    // Show selected screen
    if (screen === 'home') {
        document.getElementById('homeContent').style.display = 'block';
        AppState.activeScreen = 'home';
    } else {
        const screenElement = document.getElementById(`${screen}Screen`);
        if (screenElement) {
            screenElement.style.display = 'block';
            AppState.activeScreen = screen;
            
            // Load data for specific screens
            switch(screen) {
                case 'history':
                    loadRideHistory();
                    break;
                case 'account':
                    loadAccountData();
                    break;
            }
        }
    }
}

function switchService(service) {
    console.log(`Switching to service: ${service}`);
    
    // Update active service tab
    document.querySelectorAll('.service-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    const activeTab = document.querySelector(`.service-tab[data-service="${service}"]`);
    if (activeTab) {
        activeTab.classList.add('active');
    }
    
    // Hide all forms
    document.querySelectorAll('.ride-request-form, .service-form').forEach(form => {
        form.style.display = 'none';
    });
    
    // Show selected service form
    AppState.activeService = service;
    
    switch(service) {
        case 'car':
            document.getElementById('carForm').style.display = 'block';
            break;
        case 'delivery':
            document.getElementById('deliveryForm').style.display = 'block';
            break;
        case 'short-delivery':
            document.getElementById('shortDeliveryForm').style.display = 'block';
            break;
        case 'express':
            document.getElementById('expressForm').style.display = 'block';
            break;
        case 'truck':
            document.getElementById('truckForm').style.display = 'block';
            break;
    }
}

function handleMoreOption(option) {
    console.log(`More option selected: ${option}`);
    
    // Hide more options menu
    document.getElementById('moreOptionsMenu').classList.remove('active');
    
    switch(option) {
        case 'schedule':
            ScheduledRideManager.showScheduleModal();
            break;
        case 'orderForSomeone':
            showOrderForSomeoneModal();
            break;
        case 'shareRide':
            SplitRideManager.showSplitRideModal();
            break;
        case 'broadcast':
            BroadcastRideManager.showBroadcastModal();
            break;
    }
}

// ============================================
// HELPER FUNCTIONS
// ============================================
function showCancelModal() {
    // Create or show cancel modal
    if (!document.getElementById('cancelModal')) {
        createCancelModal();
    }
    
    ModalManager.show('cancel');
}

function createCancelModal() {
    const modalHTML = `
        <div class="modal-overlay" id="cancelModal" style="display: none;">
            <div class="modal">
                <div class="modal-header">
                    <div class="modal-title">
                        <i class="fas fa-times-circle"></i>
                        Cancel Ride
                    </div>
                    <button class="modal-close" onclick="ModalManager.hide('cancel')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-content">
                    <div class="cancel-reasons">
                        <div class="cancel-reason" data-reason="driver_late">
                            <div class="reason-icon">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="reason-text">Driver is taking too long</div>
                        </div>
                        <div class="cancel-reason" data-reason="change_plans">
                            <div class="reason-icon">
                                <i class="fas fa-calendar-times"></i>
                            </div>
                            <div class="reason-text">Change of plans</div>
                        </div>
                        <div class="cancel-reason" data-reason="found_alternative">
                            <div class="reason-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="reason-text">Found alternative transport</div>
                        </div>
                        <div class="cancel-reason" data-reason="emergency">
                            <div class="reason-icon">
                                <i class="fas fa-exclamation"></i>
                            </div>
                            <div class="reason-text">Emergency situation</div>
                        </div>
                        <div class="cancel-reason" data-reason="other">
                            <div class="reason-icon">
                                <i class="fas fa-ellipsis-h"></i>
                            </div>
                            <div class="reason-text">Other reason</div>
                        </div>
                    </div>
                    
                    <div class="other-reason" id="otherReasonContainer" style="display: none;">
                        <textarea id="otherReasonText" placeholder="Please specify your reason..."></textarea>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn btn-danger" onclick="confirmCancelRide()">
                            <i class="fas fa-times"></i>
                            Cancel Ride
                        </button>
                        <button class="btn btn-secondary" onclick="ModalManager.hide('cancel')">
                            Go Back
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Add event listeners to cancel reasons
    document.querySelectorAll('.cancel-reason').forEach(reason => {
        reason.addEventListener('click', () => {
            document.querySelectorAll('.cancel-reason').forEach(r => {
                r.classList.remove('selected');
            });
            reason.classList.add('selected');
            
            const otherContainer = document.getElementById('otherReasonContainer');
            if (reason.dataset.reason === 'other') {
                otherContainer.style.display = 'block';
            } else {
                otherContainer.style.display = 'none';
            }
        });
    });
}

async function confirmCancelRide() {
    const selectedReason = document.querySelector('.cancel-reason.selected');
    if (!selectedReason) {
        EnhancedUIUpdater.showToast('Please select a cancellation reason', 'warning');
        return;
    }
    
    let reason = selectedReason.dataset.reason;
    if (reason === 'other') {
        const otherReason = document.getElementById('otherReasonText').value.trim();
        if (!otherReason) {
            EnhancedUIUpdater.showToast('Please specify your reason', 'warning');
            return;
        }
        reason = `other: ${otherReason}`;
    }
    
    try {
        await FirebaseManager.cancelRide(AppState.currentRide.id, reason);
        ModalManager.hide('cancel');
        EnhancedUIUpdater.showToast('Ride cancelled successfully', 'success');
    } catch (error) {
        console.error('Error cancelling ride:', error);
        EnhancedUIUpdater.showToast('Error cancelling ride', 'error');
    }
}

function showOrderForSomeoneModal() {
    // Create or show order for someone modal
    if (!document.getElementById('orderForSomeoneModal')) {
        createOrderForSomeoneModal();
    }
    
    ModalManager.show('orderForSomeone');
}

function createOrderForSomeoneModal() {
    const modalHTML = `
        <div class="modal-overlay" id="orderForSomeoneModal" style="display: none;">
            <div class="modal">
                <div class="modal-header">
                    <div class="modal-title">
                        <i class="fas fa-user-friends"></i>
                        Order for Someone Else
                    </div>
                    <button class="modal-close" onclick="ModalManager.hide('orderForSomeone')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-content">
                    <div class="location-inputs">
                        <div class="location-input">
                            <i class="fas fa-map-marker-alt"></i>
                            <input type="text" id="someonePickup" placeholder="Pickup location">
                        </div>
                        <div class="location-input">
                            <i class="fas fa-flag"></i>
                            <input type="text" id="someoneDestination" placeholder="Destination">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Recipient Details</label>
                        <div class="form-row">
                            <input type="text" id="someoneName" placeholder="Full name">
                            <input type="tel" id="someonePhone" placeholder="Phone number">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Special Instructions (Optional)</label>
                        <textarea id="someoneInstructions" placeholder="Any instructions for the driver..."></textarea>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="confirmOrderForSomeone()">
                            <i class="fas fa-car"></i>
                            Request Ride
                        </button>
                        <button class="btn btn-secondary" onclick="ModalManager.hide('orderForSomeone')">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Setup location inputs
    const pickupInput = document.getElementById('someonePickup');
    const destinationInput = document.getElementById('someoneDestination');
    
    if (pickupInput) {
        LocationInputManager.setupInput(pickupInput, 'pickup');
    }
    
    if (destinationInput) {
        LocationInputManager.setupInput(destinationInput, 'destination');
    }
}

async function confirmOrderForSomeone() {
    // Similar to regular ride request but with recipient details
    // Implementation would be similar to the regular ride request flow
}

async function loadRideHistory() {
    try {
        const rides = await FirebaseManager.getRideHistory();
        displayRideHistory(rides);
    } catch (error) {
        console.error('Error loading ride history:', error);
        EnhancedUIUpdater.showToast('Error loading ride history', 'error');
    }
}

function displayRideHistory(rides) {
    const container = document.getElementById('historyList');
    if (!container) return;
    
    if (rides.length === 0) {
        container.innerHTML = `
            <div class="empty-history">
                <i class="fas fa-history"></i>
                <div>No ride history</div>
            </div>
        `;
        return;
    }
    
    let html = '';
    
    rides.forEach(ride => {
        const date = new Date(ride.timestamp);
        const dateString = date.toLocaleDateString();
        const timeString = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        let icon = 'fa-car';
        let iconColor = '#FF6B35';
        
        if (ride.serviceType === 'delivery') {
            icon = 'fa-shipping-fast';
            iconColor = '#4CAF50';
        } else if (ride.serviceType === 'truck') {
            icon = 'fa-truck';
            iconColor = '#795548';
        } else if (ride.serviceType === 'shopping') {
            icon = 'fa-shopping-bag';
            iconColor = '#FFC107';
        } else if (ride.emergency) {
            icon = 'fa-ambulance';
            iconColor = '#F44336';
        }
        
        html += `
            <div class="history-item">
                <div class="history-icon" style="background: ${iconColor}">
                    <i class="fas ${icon}"></i>
                </div>
                <div class="history-details">
                    <div class="history-route">
                        <div class="history-pickup">${ride.pickupDisplay || ride.pickup}</div>
                        <div class="history-destination">${ride.destinationDisplay || ride.destination}</div>
                    </div>
                    <div class="history-info">
                        <div class="history-date">${dateString} ${timeString}</div>
                        <div class="history-fare">ZMW ${ride.fare?.toFixed(2) || '0.00'}</div>
                    </div>
                </div>
                <div class="history-status ${ride.status}">
                    ${ride.status}
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

async function loadAccountData() {
    // Load user stats
    const rides = await FirebaseManager.getRideHistory();
    
    const completedRides = rides.filter(ride => ride.status === 'completed').length;
    const cancelledRides = rides.filter(ride => ride.status === 'cancelled').length;
    const totalSpent = rides
        .filter(ride => ride.status === 'completed')
        .reduce((sum, ride) => sum + (ride.fare || 0), 0);
    
    document.getElementById('completedRides').textContent = completedRides;
    document.getElementById('cancelledRides').textContent = cancelledRides;
    document.getElementById('totalSpent').textContent = `ZMW ${totalSpent.toFixed(2)}`;
}

// ============================================
// START THE APPLICATION
// ============================================
window.addEventListener('load', initializeApp);

// Export important functions to global scope for HTML onclick handlers
window.ModalManager = ModalManager;
window.SplitRideManager = SplitRideManager;
window.BroadcastRideManager = BroadcastRideManager;
window.EmergencyManager = EmergencyManager;
window.ShoppingManager = ShoppingManager;
window.ScheduledRideManager = ScheduledRideManager;
window.WalletManager = WalletManager;
window.PaymentManager = PaymentManager;
window.EnhancedUIUpdater = EnhancedUIUpdater;
window.switchScreen = switchScreen;
window.switchService = switchService;
window.getCurrentLocation = getCurrentLocation;
window.confirmCancelRide = confirmCancelRide;
window.confirmOrderForSomeone = confirmOrderForSomeone;

console.log('Jubel Passenger App JavaScript loaded successfully');
</script>
</body>
</html>






