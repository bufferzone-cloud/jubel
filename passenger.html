<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jubel - Passenger</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.3.0/ol.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-orange: #FF6B35;
            --primary-red: #E74C3C;
            --primary-gradient: linear-gradient(135deg, #FF6B35, #E74C3C);
            --secondary-orange: #E55A28;
            --secondary-red: #C0392B;
            --light-orange: #FFE8E0;
            --light-red: #FADBD8;
            --white: #FFFFFF;
            --light-gray: #F5F5F5;
            --dark-gray: #333333;
            --medium-gray: #777777;
            --success-green: #2ecc71;
            --warning-yellow: #f39c12;
            --info-blue: #3498db;
            --error-red: #e74c3c;
            --premium-gold: #FFD700;
            --economy-green: #27ae60;
            --emergency-red: #e74c3c;
            --ambulance-red: #c0392b;
            --fire-truck-red: #e74c3c;
            --border-color: #E8E8E8;
            --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 4px 15px rgba(0, 0, 0, 0.15);
            --shadow-heavy: 0 6px 20px rgba(0, 0, 0, 0.2);
            --app-padding: 10px;
            --element-radius: 6px;
            --transition-speed: 0.3s;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--white);
            color: var(--dark-gray);
            max-width: 100%;
            overflow-x: hidden;
            height: 100vh;
            font-size: 13px;
        }
        
        /* Main Map Container */
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        .ol-control {
            background-color: rgba(255, 255, 255, 0.9) !important;
            border-radius: var(--element-radius) !important;
            box-shadow: var(--shadow-medium) !important;
        }
        
        .ol-control button {
            background-color: var(--primary-orange) !important;
            color: white !important;
            border-radius: var(--element-radius) !important;
        }
        
        .ol-control button:hover {
            background-color: var(--secondary-orange) !important;
        }
        
        /* Custom OpenLayers Marker Styles */
        .ol-marker {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: white;
            box-shadow: var(--shadow-heavy);
            border: 3px solid white;
        }
        
        .driver-marker {
            background: var(--primary-gradient);
        }
        
        .pickup-marker {
            background: var(--primary-orange);
        }
        
        .destination-marker {
            background: var(--primary-red);
        }
        
        .current-location-marker {
            background: var(--info-blue);
        }
        
        .ambulance-marker {
            background: var(--ambulance-red);
            animation: pulse 1s infinite;
        }
        
        .fire-truck-marker {
            background: var(--fire-truck-red);
            animation: pulse 1s infinite;
        }
        
        .emergency-marker {
            background: var(--emergency-red);
            animation: pulse 0.5s infinite;
        }
        
        .premium-marker {
            background: var(--premium-gold);
        }
        
        .economy-marker {
            background: var(--economy-green);
        }
        
        .truck-marker {
            background: #8e44ad;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        /* Floating UI Elements */
        .floating-balance {
            position: fixed;
            top: 10px;
            right: 10px;
            background: var(--white);
            padding: 6px 10px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 700;
            color: var(--dark-gray);
            border: 2px solid var(--primary-orange);
            font-size: 0.75rem;
        }
        
        .balance-amount {
            color: var(--primary-orange);
            font-size: 0.8rem;
        }
        
        .passenger-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            border-radius: 15px 15px 0 0;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
            z-index: 100;
            padding: var(--app-padding);
            transform: translateY(0);
            transition: transform var(--transition-speed) ease;
            max-height: 45vh;
            overflow-y: auto;
        }
        
        .passenger-panel.collapsed {
            transform: translateY(calc(100% - 40px));
        }
        
        .panel-collapse-handle {
            width: 35px;
            height: 3px;
            background: var(--border-color);
            border-radius: 2px;
            margin: 0 auto 8px;
            cursor: pointer;
        }
        
        /* Navigation Buttons */
        .nav-buttons {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            padding: 6px 3px;
            border-radius: var(--element-radius);
            background: var(--light-gray);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            border: none;
            font-size: 0.6rem;
            font-weight: 600;
        }
        
        .nav-btn.active {
            background: var(--primary-gradient);
            color: var(--white);
        }
        
        .nav-btn i {
            font-size: 0.8rem;
        }
        
        /* Ride Type Selection */
        .ride-type-selector {
            display: none;
            flex-direction: column;
            gap: 8px;
            margin: 10px 0;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
        }
        
        .ride-type-selector.active {
            display: flex;
        }
        
        .ride-type-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            background: var(--white);
        }
        
        .ride-type-option.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .ride-type-icon {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: white;
        }
        
        .ride-type-option.standard .ride-type-icon {
            background: var(--primary-orange);
        }
        
        .ride-type-option.premium .ride-type-icon {
            background: var(--premium-gold);
        }
        
        .ride-type-option.economy .ride-type-icon {
            background: var(--economy-green);
        }
        
        .ride-type-option.emergency .ride-type-icon {
            background: var(--emergency-red);
            animation: pulse 2s infinite;
        }
        
        .ride-type-details {
            flex: 1;
        }
        
        .ride-type-name {
            font-weight: 700;
            font-size: 0.85rem;
            margin-bottom: 2px;
        }
        
        .ride-type-description {
            color: var(--medium-gray);
            font-size: 0.7rem;
        }
        
        .ride-type-price {
            font-weight: 700;
            font-size: 0.85rem;
            color: var(--primary-orange);
        }
        
        /* Emergency Questionnaire */
        .emergency-questionnaire {
            display: none;
            flex-direction: column;
            gap: 10px;
            margin: 10px 0;
            padding: 15px;
            border: 2px solid var(--emergency-red);
            border-radius: var(--element-radius);
            background: var(--light-red);
        }
        
        .emergency-questionnaire.active {
            display: flex;
        }
        
        .emergency-question {
            margin-bottom: 10px;
        }
        
        .emergency-question label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--emergency-red);
            font-size: 0.8rem;
        }
        
        .emergency-question select,
        .emergency-question textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--emergency-red);
            border-radius: var(--element-radius);
            font-size: 0.75rem;
        }
        
        .emergency-question textarea {
            min-height: 60px;
            resize: vertical;
        }
        
        .emergency-warning {
            background: var(--emergency-red);
            color: white;
            padding: 10px;
            border-radius: var(--element-radius);
            text-align: center;
            font-weight: 700;
            font-size: 0.8rem;
            margin: 5px 0;
        }
        
        /* Emergency Vehicle Selection */
        .emergency-vehicle-selection {
            display: none;
            flex-direction: column;
            gap: 8px;
            margin: 10px 0;
        }
        
        .emergency-vehicle-selection.active {
            display: flex;
        }
        
        .emergency-vehicle-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            background: var(--white);
        }
        
        .emergency-vehicle-option.selected {
            border-color: var(--emergency-red);
            background: var(--light-red);
        }
        
        .emergency-vehicle-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }
        
        .emergency-vehicle-option.ambulance .emergency-vehicle-icon {
            background: var(--ambulance-red);
        }
        
        .emergency-vehicle-option.fire-truck .emergency-vehicle-icon {
            background: var(--fire-truck-red);
        }
        
        .emergency-vehicle-option.emergency-ride .emergency-vehicle-icon {
            background: var(--emergency-red);
        }
        
        .emergency-vehicle-option.emergency-delivery .emergency-vehicle-icon {
            background: var(--secondary-red);
        }
        
        .emergency-vehicle-details {
            flex: 1;
        }
        
        .emergency-vehicle-name {
            font-weight: 700;
            font-size: 0.9rem;
            color: var(--emergency-red);
            margin-bottom: 2px;
        }
        
        .emergency-vehicle-description {
            color: var(--medium-gray);
            font-size: 0.7rem;
        }
        
        .emergency-vehicle-price {
            font-weight: 700;
            font-size: 0.85rem;
            color: var(--emergency-red);
        }
        
        /* Main Ride Request Form */
        .ride-request-form {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .location-input {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--white);
            position: relative;
        }
        
        .location-input i {
            color: var(--primary-orange);
        }
        
        .location-input input {
            border: none;
            outline: none;
            width: 100%;
            font-size: 0.8rem;
        }
        
        .vehicle-selection {
            display: flex;
            gap: 6px;
            margin: 8px 0;
        }
        
        .vehicle-option {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 4px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .vehicle-option.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .vehicle-icon {
            font-size: 1rem;
            color: var(--medium-gray);
        }
        
        .vehicle-option.selected .vehicle-icon {
            color: var(--primary-orange);
        }
        
        .vehicle-name {
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .vehicle-price {
            font-size: 0.65rem;
            color: var(--medium-gray);
        }
        
        /* Light Truck Option */
        .vehicle-option.truck .vehicle-icon {
            color: #8e44ad;
        }
        
        .vehicle-option.truck.selected {
            border-color: #8e44ad;
            background: #f3e6f8;
        }
        
        .vehicle-option.truck.selected .vehicle-icon {
            color: #8e44ad;
        }
        
        /* Package Delivery Form */
        .package-form {
            display: none;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
        }
        
        .package-form.active {
            display: block;
        }
        
        .form-row {
            display: flex;
            gap: 6px;
            margin-bottom: 6px;
        }
        
        .form-group {
            flex: 1;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 3px;
            font-weight: 600;
            font-size: 0.7rem;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 6px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 0.7rem;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 50px;
        }
        
        .package-toggle {
            width: 100%;
            padding: 6px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        /* Promo Section */
        .promo-section {
            margin-top: 8px;
            padding: 8px;
            border: 1px dashed var(--border-color);
            border-radius: var(--element-radius);
            display: none;
        }
        
        .promo-section.active {
            display: block;
        }
        
        .promo-input {
            display: flex;
            gap: 6px;
        }
        
        .promo-input input {
            flex: 1;
            padding: 6px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 0.75rem;
        }
        
        .btn-promo {
            background: var(--primary-orange);
            color: var(--white);
            border: none;
            border-radius: var(--element-radius);
            padding: 6px 10px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .promo-toggle {
            width: 100%;
            padding: 6px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        /* Fare Display */
        .fare-display {
            background: var(--primary-gradient);
            color: var(--white);
            padding: 10px;
            border-radius: var(--element-radius);
            text-align: center;
            margin: 8px 0;
            box-shadow: var(--shadow-medium);
        }
        
        .fare-amount {
            font-size: 1.5rem;
            font-weight: 800;
            margin: 4px 0;
        }
        
        .eta-display {
            font-size: 0.9rem;
            font-weight: 600;
            opacity: 0.9;
        }
        
        /* Action Buttons */
        .request-ride-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: var(--element-radius);
            background: var(--primary-gradient);
            color: var(--white);
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            margin-top: 8px;
            box-shadow: var(--shadow-medium);
        }
        
        .request-ride-btn:disabled {
            background: var(--medium-gray);
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .request-ride-btn.emergency {
            background: var(--emergency-red);
            animation: pulse 2s infinite;
        }
        
        /* Ride Info Panel */
        .ride-info-panel {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 10px;
            box-shadow: var(--shadow-medium);
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            display: none;
        }
        
        .driver-info {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .driver-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            color: var(--white);
            font-weight: 700;
        }
        
        .driver-details h2 {
            font-size: 0.85rem;
            margin-bottom: 2px;
        }
        
        .driver-details p {
            color: var(--medium-gray);
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 3px;
            font-size: 0.7rem;
        }
        
        /* Screen Content Areas */
        .screen-content {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 50px;
            background: var(--white);
            z-index: 90;
            padding: var(--app-padding);
            overflow-y: auto;
            display: none;
        }
        
        .screen-content.active {
            display: block;
        }
        
        .screen-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .back-button {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            font-size: 0.9rem;
        }
        
        .screen-title {
            font-size: 1rem;
            font-weight: 700;
        }
        
        /* SOS Button */
        .sos-button {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--error-red);
            color: var(--white);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 700;
            box-shadow: var(--shadow-heavy);
            z-index: 150;
            cursor: pointer;
            animation: sos-pulse 2s infinite;
            display: none;
        }
        
        @keyframes sos-pulse {
            0% {
                transform: translateX(-50%) scale(1);
                box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7);
            }
            70% {
                transform: translateX(-50%) scale(1.05);
                box-shadow: 0 0 0 10px rgba(231, 76, 60, 0);
            }
            100% {
                transform: translateX(-50%) scale(1);
                box-shadow: 0 0 0 0 rgba(231, 76, 60, 0);
            }
        }
        
        /* Ride Status Display */
        .ride-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: var(--white);
            padding: 6px 10px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 700;
            color: var(--dark-gray);
            border: 2px solid var(--border-color);
            font-size: 0.75rem;
            display: none;
        }
        
        .status-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: var(--medium-gray);
        }
        
        .status-dot.searching {
            background: var(--warning-yellow);
            animation: pulse 2s infinite;
        }
        
        .status-dot.arriving {
            background: var(--info-blue);
            animation: pulse 1.5s infinite;
        }
        
        .status-dot.riding {
            background: var(--success-green);
        }
        
        .status-dot.emergency {
            background: var(--emergency-red);
            animation: pulse 0.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* Estimated Time Display */
        .estimated-time {
            position: fixed;
            top: 50px;
            right: 10px;
            background: var(--white);
            padding: 6px 10px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 700;
            color: var(--dark-gray);
            border: 2px solid var(--border-color);
            font-size: 0.75rem;
            display: none;
        }
        
        /* Search Suggestions */
        .suggestion-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-medium);
            z-index: 200;
            max-height: 180px;
            overflow-y: auto;
            display: none;
        }
        
        .suggestion-item {
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .suggestion-item:hover {
            background: var(--light-orange);
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
        
        .suggestion-icon {
            font-size: 0.9rem;
            width: 18px;
            text-align: center;
        }
        
        .suggestion-details {
            flex: 1;
        }
        
        .suggestion-name {
            font-weight: 600;
            font-size: 0.75rem;
        }
        
        .suggestion-address {
            color: var(--medium-gray);
            font-size: 0.65rem;
        }
        
        .suggestion-distance {
            color: var(--medium-gray);
            font-size: 0.55rem;
            margin-top: 2px;
        }
        
        /* Loading and No Results */
        .loading-text {
            text-align: center;
            padding: 15px;
            color: var(--medium-gray);
        }
        
        .no-places {
            text-align: center;
            padding: 15px;
            color: var(--medium-gray);
        }
        
        /* Driver Search Animation */
        .searching-animation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 200;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .searching-pulse {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(255, 107, 53, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse-ring 2s infinite;
            position: relative;
        }
        
        .searching-pulse-inner {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }
        
        .searching-text {
            margin-top: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 12px;
            border-radius: var(--element-radius);
            font-weight: 600;
            color: var(--primary-orange);
            box-shadow: var(--shadow-medium);
        }
        
        .searching-animation.emergency .searching-pulse {
            background: rgba(231, 76, 60, 0.5);
        }
        
        .searching-animation.emergency .searching-pulse-inner {
            background: var(--emergency-red);
        }
        
        .searching-animation.emergency .searching-text {
            color: var(--emergency-red);
        }
        
        @keyframes pulse-ring {
            0% {
                transform: scale(0.8);
                opacity: 1;
            }
            80%, 100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }
        
        /* Account Screen Styles */
        .account-section, .history-section, .emergency-section {
            margin-bottom: 15px;
        }
        
        .section-title {
            font-size: 0.85rem;
            margin-bottom: 8px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .input-group {
            margin-bottom: 8px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 600;
            font-size: 0.75rem;
        }
        
        .input-field {
            width: 100%;
            padding: 8px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 0.75rem;
            transition: all var(--transition-speed) ease;
        }
        
        .input-field:focus {
            outline: none;
            border-color: var(--primary-orange);
        }
        
        .wallet-balance {
            background: var(--primary-gradient);
            color: var(--white);
            padding: 10px;
            border-radius: var(--element-radius);
            text-align: center;
            margin-bottom: 10px;
        }
        
        .balance-label {
            font-size: 0.7rem;
            margin-bottom: 2px;
        }
        
        .balance-amount-large {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 5px;
        }
        
        .wallet-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin-bottom: 10px;
        }
        
        .btn-wallet {
            background: var(--white);
            color: var(--primary-orange);
            border: 2px solid var(--primary-orange);
            padding: 6px;
            font-size: 0.7rem;
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .btn-wallet:hover {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .stat-card {
            background: var(--light-gray);
            padding: 10px;
            border-radius: var(--element-radius);
            text-align: center;
        }
        
        .stat-number {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        .stat-label {
            font-size: 0.65rem;
            color: var(--medium-gray);
        }
        
        /* Referral Section */
        .referral-section {
            background: var(--light-orange);
            padding: 12px;
            border-radius: var(--element-radius);
            margin-bottom: 12px;
        }
        
        .referral-code {
            background: var(--white);
            padding: 8px;
            border-radius: var(--element-radius);
            text-align: center;
            margin: 8px 0;
        }
        
        .code {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        .description {
            font-size: 0.65rem;
            color: var(--medium-gray);
            margin-top: 4px;
        }
        
        /* Contact Section */
        .contact-section {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .contact-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: var(--element-radius);
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .contact-btn.whatsapp {
            background: #25D366;
            color: white;
        }
        
        .contact-btn.phone {
            background: var(--info-blue);
            color: white;
        }
        
        /* History Section */
        .filter-options {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .filter-options select, .filter-options input {
            flex: 1;
        }
        
        .history-item {
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            font-size: 0.7rem;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-item:hover {
            background: var(--light-orange);
        }
        
        .history-locations {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .history-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.65rem;
            color: var(--medium-gray);
        }
        
        .history-fare {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        .status-badge {
            padding: 2px 5px;
            border-radius: 10px;
            font-size: 0.6rem;
            font-weight: 700;
        }
        
        .status-completed {
            background: #e6f7e9;
            color: #2e7d32;
        }
        
        .status-cancelled {
            background: #ffebee;
            color: #c62828;
        }
        
        .status-requested {
            background: #fff3e0;
            color: #ef6c00;
        }
        
        .status-accepted {
            background: #e3f2fd;
            color: #1565c0;
        }
        
        .status-emergency {
            background: #ffebee;
            color: #c62828;
            animation: pulse 2s infinite;
        }
        
        /* Popup Overlays */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
        }
        
        .popup-overlay.hidden {
            display: none;
        }
        
        .popup-form {
            background: var(--white);
            border-radius: var(--element-radius);
            width: 100%;
            max-width: 450px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: var(--shadow-heavy);
        }
        
        .large-popup {
            max-width: 700px;
        }
        
        .popup-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .popup-title {
            font-size: 1.1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .close-popup {
            background: none;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            color: var(--medium-gray);
        }
        
        .popup-content {
            padding: 12px;
        }
        
        .popup-map-container {
            height: 180px;
            border-radius: var(--element-radius);
            overflow: hidden;
            margin-bottom: 12px;
        }
        
        .popup-details {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .detail-row:last-child {
            border-bottom: none;
        }
        
        .detail-label {
            font-weight: 600;
            font-size: 0.75rem;
        }
        
        .detail-value {
            font-size: 0.75rem;
            color: var(--medium-gray);
        }
        
        .driver-details-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }
        
        .popup-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 12px;
        }
        
        /* Receipt Button */
        .receipt-button {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--primary-orange);
            border-radius: var(--element-radius);
            background: var(--white);
            color: var(--primary-orange);
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-gradient);
            color: var(--white);
            padding: 8px 14px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 300;
            display: none;
            font-weight: 600;
            text-align: center;
            font-size: 0.75rem;
            max-width: 80%;
        }
        
        .notification.emergency {
            background: var(--emergency-red);
        }
        
        /* Enhanced History Item Styles */
        .history-item-type {
            font-size: 0.65rem;
            font-weight: 600;
            padding: 2px 5px;
            border-radius: 8px;
            margin-bottom: 4px;
            display: inline-block;
        }
        
        .history-item-type.ride {
            background: var(--light-orange);
            color: var(--primary-orange);
        }
        
        .history-item-type.delivery {
            background: var(--light-red);
            color: var(--primary-red);
        }
        
        .history-item-type.emergency {
            background: var(--light-red);
            color: var(--emergency-red);
            animation: pulse 2s infinite;
        }
        
        .history-item-type.premium {
            background: #fff9e6;
            color: #b8860b;
        }
        
        .history-item-type.economy {
            background: #e6f7e9;
            color: #2e7d32;
        }
        
        .history-package-details {
            background: var(--light-gray);
            padding: 6px;
            border-radius: var(--element-radius);
            margin: 6px 0;
            font-size: 0.65rem;
        }
        
        .package-detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
        }
        
        .package-detail-label {
            font-weight: 600;
            color: var(--medium-gray);
        }
        
        .package-detail-value {
            color: var(--dark-gray);
        }
        
        .history-driver-info {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px dashed var(--border-color);
        }
        
        .history-driver-avatar {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            color: var(--white);
            font-weight: 700;
        }
        
        .history-driver-details {
            flex: 1;
        }
        
        .history-driver-name {
            font-size: 0.65rem;
            font-weight: 600;
        }
        
        .history-driver-rating {
            font-size: 0.55rem;
            color: var(--medium-gray);
        }
        
        /* Emergency Section Styles */
        .emergency-quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .emergency-quick-action {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 12px;
            border-radius: var(--element-radius);
            background: var(--light-red);
            border: 2px solid var(--emergency-red);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .emergency-quick-action:hover {
            background: var(--emergency-red);
            color: white;
        }
        
        .emergency-quick-action i {
            font-size: 1.5rem;
        }
        
        .emergency-quick-action span {
            font-size: 0.75rem;
            font-weight: 600;
            text-align: center;
        }
        
        .emergency-history-item {
            background: var(--light-red);
            border-left: 4px solid var(--emergency-red);
        }
        
        /* General Button Styles */
        .btn {
            padding: 8px;
            border: none;
            border-radius: var(--element-radius);
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .btn-cancel {
            background: var(--error-red);
            color: var(--white);
        }
        
        .btn-contact {
            background: var(--info-blue);
            color: var(--white);
        }
        
        .btn-primary {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .btn-success {
            background: var(--success-green);
            color: var(--white);
        }
        
        .btn-warning {
            background: var(--warning-yellow);
            color: var(--white);
        }
        
        .btn-emergency {
            background: var(--emergency-red);
            color: var(--white);
            animation: pulse 2s infinite;
        }
        
        /* Responsive Design */
        @media (max-width: 480px) {
            .floating-balance, .ride-status {
                padding: 5px 7px;
                font-size: 0.65rem;
            }
            
            .passenger-panel {
                padding: 8px;
            }
            
            .nav-buttons {
                gap: 3px;
            }
            
            .nav-btn {
                padding: 5px 2px;
                font-size: 0.55rem;
            }
            
            .emergency-quick-actions {
                grid-template-columns: 1fr;
            }
        }
        
        /* Additional OpenLayers Styles */
        .ol-popup {
            position: absolute;
            background-color: white;
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #cccccc;
            bottom: 12px;
            left: -50px;
            min-width: 200px;
        }
        
        .ol-popup:after, .ol-popup:before {
            top: 100%;
            border: solid transparent;
            content: " ";
            height: 0;
            width: 0;
            position: absolute;
            pointer-events: none;
        }
        
        .ol-popup:after {
            border-top-color: white;
            border-width: 10px;
            left: 48px;
            margin-left: -10px;
        }
        
        .ol-popup:before {
            border-top-color: #cccccc;
            border-width: 11px;
            left: 48px;
            margin-left: -11px;
        }
        
        .ol-popup-closer {
            text-decoration: none;
            position: absolute;
            top: 2px;
            right: 8px;
        }
        
        .ol-popup-closer:after {
            content: "âœ–";
        }
    </style>
</head>
<body>
    <!-- Main App -->
    <div id="mainApp">
        <!-- Main Map -->
        <div id="map"></div>
        
        <!-- Floating Balance (Only on Home Screen) -->
        <div class="floating-balance home-only">
            <i class="fas fa-wallet"></i>
            <span>Balance: <span class="balance-amount" id="walletBalance">K0.00</span></span>
        </div>
        
        <!-- Ride Status (Only on Home Screen) -->
        <div class="ride-status home-only" id="rideStatus">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Searching for driver</span>
        </div>
        
        <!-- Estimated Time (Only on Home Screen) -->
        <div class="estimated-time home-only" id="estimatedTime">
            <i class="fas fa-clock"></i>
            <span id="timeText">5 min</span>
        </div>
        
        <!-- SOS Button -->
        <div class="sos-button" id="sosButton">
            SOS
        </div>
        
        <!-- Driver Search Animation -->
        <div class="searching-animation" id="searchingAnimation">
            <div class="searching-pulse">
                <div class="searching-pulse-inner">
                    <i class="fas fa-car"></i>
                </div>
            </div>
            <div class="searching-text">Searching for driver</div>
        </div>
        
        <!-- Passenger Panel -->
        <div class="passenger-panel" id="passengerPanel">
            <div class="panel-collapse-handle" id="panelCollapseHandle"></div>
            
            <div class="nav-buttons">
                <button class="nav-btn active" data-screen="home">
                    <i class="fas fa-home"></i>
                    <span>Home</span>
                </button>
                <button class="nav-btn" data-screen="account">
                    <i class="fas fa-user"></i>
                    <span>Account</span>
                </button>
                <button class="nav-btn" data-screen="history">
                    <i class="fas fa-history"></i>
                    <span>History</span>
                </button>
                <button class="nav-btn" data-screen="emergency">
                    <i class="fas fa-ambulance"></i>
                    <span>Emergency</span>
                </button>
                <button class="nav-btn" data-screen="more">
                    <i class="fas fa-ellipsis-h"></i>
                    <span>More</span>
                </button>
            </div>
            
            <!-- Ride Type Selector (Hidden by default, shown when ride button clicked) -->
            <div class="ride-type-selector" id="rideTypeSelector">
                <div class="ride-type-option standard selected" data-ride-type="standard">
                    <div class="ride-type-icon">
                        <i class="fas fa-car"></i>
                    </div>
                    <div class="ride-type-details">
                        <div class="ride-type-name">Standard Ride</div>
                        <div class="ride-type-description">Clean, comfortable cars</div>
                    </div>
                    <div class="ride-type-price">K23+</div>
                </div>
                
                <div class="ride-type-option premium" data-ride-type="premium">
                    <div class="ride-type-icon">
                        <i class="fas fa-crown"></i>
                    </div>
                    <div class="ride-type-details">
                        <div class="ride-type-name">Premium Ride</div>
                        <div class="ride-type-description">Luxury vehicles with premium service</div>
                    </div>
                    <div class="ride-type-price">K50+</div>
                </div>
                
                <div class="ride-type-option economy" data-ride-type="economy">
                    <div class="ride-type-icon">
                        <i class="fas fa-leaf"></i>
                    </div>
                    <div class="ride-type-details">
                        <div class="ride-type-name">Economy Ride</div>
                        <div class="ride-type-description">Budget-friendly option</div>
                    </div>
                    <div class="ride-type-price">K15+</div>
                </div>
                
                <div class="ride-type-option emergency" data-ride-type="emergency">
                    <div class="ride-type-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="ride-type-details">
                        <div class="ride-type-name">Emergency Ride</div>
                        <div class="ride-type-description">Priority dispatch for emergencies</div>
                    </div>
                    <div class="ride-type-price">K100+</div>
                </div>
            </div>
            
            <!-- Emergency Vehicle Selection -->
            <div class="emergency-vehicle-selection" id="emergencyVehicleSelection">
                <div class="emergency-vehicle-option ambulance selected" data-vehicle-type="ambulance">
                    <div class="emergency-vehicle-icon">
                        <i class="fas fa-ambulance"></i>
                    </div>
                    <div class="emergency-vehicle-details">
                        <div class="emergency-vehicle-name">Ambulance</div>
                        <div class="emergency-vehicle-description">Medical emergency transport</div>
                    </div>
                    <div class="emergency-vehicle-price">K500+</div>
                </div>
                
                <div class="emergency-vehicle-option fire-truck" data-vehicle-type="fire-truck">
                    <div class="emergency-vehicle-icon">
                        <i class="fas fa-fire-extinguisher"></i>
                    </div>
                    <div class="emergency-vehicle-details">
                        <div class="emergency-vehicle-name">Fire Truck</div>
                        <div class="emergency-vehicle-description">Fire emergency response</div>
                    </div>
                    <div class="emergency-vehicle-price">K1000+</div>
                </div>
                
                <div class="emergency-vehicle-option emergency-ride" data-vehicle-type="emergency-ride">
                    <div class="emergency-vehicle-icon">
                        <i class="fas fa-car"></i>
                    </div>
                    <div class="emergency-vehicle-details">
                        <div class="emergency-vehicle-name">Emergency Ride</div>
                        <div class="emergency-vehicle-description">Priority vehicle for urgent transport</div>
                    </div>
                    <div class="emergency-vehicle-price">K200+</div>
                </div>
                
                <div class="emergency-vehicle-option emergency-delivery" data-vehicle-type="emergency-delivery">
                    <div class="emergency-vehicle-icon">
                        <i class="fas fa-shipping-fast"></i>
                    </div>
                    <div class="emergency-vehicle-details">
                        <div class="emergency-vehicle-name">Emergency Delivery</div>
                        <div class="emergency-vehicle-description">Urgent medical supplies delivery</div>
                    </div>
                    <div class="emergency-vehicle-price">K300+</div>
                </div>
            </div>
            
            <!-- Emergency Questionnaire -->
            <div class="emergency-questionnaire" id="emergencyQuestionnaire">
                <div class="emergency-warning">
                    <i class="fas fa-exclamation-circle"></i>
                    THIS IS FOR EMERGENCIES ONLY
                </div>
                
                <div class="emergency-question">
                    <label for="emergencyType">Type of Emergency:</label>
                    <select id="emergencyType">
                        <option value="">Select emergency type</option>
                        <option value="medical">Medical Emergency</option>
                        <option value="accident">Accident</option>
                        <option value="fire">Fire Emergency</option>
                        <option value="police">Police Required</option>
                        <option value="other">Other Emergency</option>
                    </select>
                </div>
                
                <div class="emergency-question">
                    <label for="emergencySeverity">Severity Level:</label>
                    <select id="emergencySeverity">
                        <option value="">Select severity</option>
                        <option value="critical">Critical (Life-threatening)</option>
                        <option value="urgent">Urgent (Requires immediate attention)</option>
                        <option value="serious">Serious (Needs prompt attention)</option>
                    </select>
                </div>
                
                <div class="emergency-question">
                    <label for="emergencyDescription">Description of Emergency:</label>
                    <textarea id="emergencyDescription" placeholder="Please describe the emergency situation..."></textarea>
                </div>
                
                <div class="emergency-question">
                    <label for="numberOfPeople">Number of People Involved:</label>
                    <select id="numberOfPeople">
                        <option value="1">1 Person</option>
                        <option value="2">2 People</option>
                        <option value="3">3 People</option>
                        <option value="4">4+ People</option>
                    </select>
                </div>
            </div>
            
            <!-- Home Screen Content -->
            <div id="homeScreenContent">
                <!-- Main Ride Request Form -->
                <div class="ride-request-form" id="rideRequestForm">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="pickupLocation" placeholder="Current location" readonly>
                    </div>
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="destinationLocation" placeholder="Where to?">
                        <div class="suggestion-list" id="destinationSuggestions"></div>
                    </div>
                    
                    <div class="saved-locations">
                        <button class="saved-location-btn" data-address="home">
                            <i class="fas fa-home"></i>
                            Home
                        </button>
                        <button class="saved-location-btn" data-address="work">
                            <i class="fas fa-briefcase"></i>
                            Work
                        </button>
                    </div>
                    
                    <!-- Show Ride Type Selection Button -->
                    <button class="btn btn-primary" id="selectRideTypeBtn">
                        <i class="fas fa-car"></i>
                        Select Ride Type
                    </button>
                    
                    <!-- Vehicle Selection (Only for non-emergency rides) -->
                    <div class="vehicle-selection" id="standardVehicleSelection">
                        <div class="vehicle-option selected" data-type="car">
                            <i class="fas fa-car vehicle-icon"></i>
                            <span class="vehicle-name">Car</span>
                            <span class="vehicle-price">Clean Cars</span>
                        </div>
                        <div class="vehicle-option" data-type="bike">
                            <i class="fas fa-motorcycle vehicle-icon"></i>
                            <span class="vehicle-name">Bike</span>
                            <span class="vehicle-price">Fast Delivery</span>
                        </div>
                        <div class="vehicle-option truck" data-type="truck">
                            <i class="fas fa-truck vehicle-icon"></i>
                            <span class="vehicle-name">Truck</span>
                            <span class="vehicle-price">Heavy Delivery</span>
                        </div>
                    </div>
                    
                    <!-- Package Delivery Form -->
                    <button class="package-toggle" id="packageToggle">
                        <i class="fas fa-box"></i>
                        Add Package Details
                    </button>
                    
                    <div class="package-form" id="packageForm">
                        <h4 class="section-title">Package Delivery Details</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="receiverName">Receiver Name</label>
                                <input type="text" id="receiverName" placeholder="Full name of receiver">
                            </div>
                            <div class="form-group">
                                <label for="receiverPhone">Receiver Phone</label>
                                <input type="tel" id="receiverPhone" placeholder="Phone number">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="packageDescription">Package Description</label>
                            <input type="text" id="packageDescription" placeholder="What is being delivered?">
                        </div>
                        <div class="form-group">
                            <label for="packageDimensions">Package Dimensions (cm)</label>
                            <div class="form-row">
                                <input type="number" id="packageLength" placeholder="Length" style="flex: 1;">
                                <input type="number" id="packageWidth" placeholder="Width" style="flex: 1;">
                                <input type="number" id="packageHeight" placeholder="Height" style="flex: 1;">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="packageWeight">Package Weight (kg)</label>
                            <input type="number" id="packageWeight" placeholder="Weight in kilograms">
                        </div>
                        <div class="form-group">
                            <label for="specialInstructions">Special Instructions</label>
                            <textarea id="specialInstructions" placeholder="Any special handling instructions?"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="packageValue">Package Value (K)</label>
                            <input type="number" id="packageValue" placeholder="Estimated value for insurance">
                        </div>
                    </div>
                    
                    <!-- Promo Code Section -->
                    <button class="promo-toggle" id="promoToggle">
                        <i class="fas fa-tag"></i>
                        Apply Promo Code
                    </button>
                    
                    <div class="promo-section" id="promoSection">
                        <div class="promo-input">
                            <input type="text" id="promoCode" placeholder="Enter promo code">
                            <button class="btn-promo" id="applyPromoBtn">Apply</button>
                        </div>
                        <div id="promoMessage" style="font-size: 0.7rem; margin-top: 5px;"></div>
                    </div>
                    
                    <!-- Fare Display -->
                    <div class="fare-display">
                        <p>Estimated Fare</p>
                        <div class="fare-amount" id="estimatedFare">K0.00</div>
                        <p class="eta-display" id="etaDisplay">ETA: -- min</p>
                    </div>
                    
                    <!-- Request Ride Button (Changes for emergency) -->
                    <button class="request-ride-btn" id="requestRideBtn">Request Ride</button>
                </div>
                
                <!-- Ride Info Panel (Hidden initially) -->
                <div class="ride-info-panel" id="rideInfoPanel">
                    <div class="driver-info">
                        <div class="driver-avatar" id="driverAvatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="driver-details">
                            <h2 id="driverName">Driver Name</h2>
                            <p><i class="fas fa-phone"></i> <span id="driverPhone">000-000-0000</span></p>
                            <p><i class="fas fa-car"></i> <span id="vehicleDetails">Toyota Corolla - ABC123</span></p>
                            <p><i class="fas fa-star"></i> <span id="driverRating">4.5 â˜…</span></p>
                        </div>
                    </div>
                    
                    <div class="trip-details">
                        <div class="location-row">
                            <div class="location-icon pickup-icon">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="location-text">
                                <h4>Pickup Location</h4>
                                <p id="currentPickupLocation">123 Main Street, City</p>
                            </div>
                        </div>
                        <div class="location-row">
                            <div class="location-icon destination-icon">
                                <i class="fas fa-flag"></i>
                            </div>
                            <div class="location-text">
                                <h4>Destination</h4>
                                <p id="currentDestinationLocation">456 Oak Avenue, City</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="fare-details">
                        <div class="fare-row">
                            <span>Base Fare</span>
                            <span id="baseFare">K15.00</span>
                        </div>
                        <div class="fare-row">
                            <span>Distance</span>
                            <span id="distanceFare">K5.00</span>
                        </div>
                        <div class="fare-row">
                            <span>Discount</span>
                            <span id="discountFare">-K2.00</span>
                        </div>
                        <div class="fare-row total">
                            <span>Total Fare</span>
                            <span id="totalFare">K18.00</span>
                        </div>
                    </div>
                    
                    <div class="ride-actions">
                        <button class="btn btn-cancel" id="cancelRideBtn">
                            <i class="fas fa-times-circle"></i>
                            Cancel Ride
                        </button>
                        <button class="btn btn-contact" id="contactDriverBtn">
                            <i class="fas fa-phone"></i>
                            Contact Driver
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Screen Contents -->
        <div class="screen-content" id="homeScreen">
            <!-- Home screen is the map, so this is empty -->
        </div>
        
        <div class="screen-content" id="accountScreen">
            <div class="screen-header">
                <button class="back-button" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="screen-title">Account</h2>
            </div>
            
            <div class="account-section">
                <div class="account-header">
                    <div class="driver-avatar" id="accountAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="driver-details">
                        <h2 id="accountName">Passenger</h2>
                        <p><i class="fas fa-phone"></i> <span id="accountPhone">Not set</span></p>
                        <p><i class="fas fa-envelope"></i> <span id="accountEmail">Not set</span></p>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="ridesCompleted">0</div>
                        <div class="stat-label">Completed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="ridesCancelled">0</div>
                        <div class="stat-label">Cancelled</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="ridesPending">0</div>
                        <div class="stat-label">Pending</div>
                    </div>
                </div>
                
                <div class="referral-section">
                    <h3 class="section-title">
                        <i class="fas fa-share-alt"></i>
                        Refer & Earn
                    </h3>
                    <p>Share your code and get K25 when friends complete their first ride</p>
                    <div class="referral-code">
                        <div class="code" id="referralCode">JUBEL-XXXX</div>
                        <div class="description">50% discount for new users on first ride</div>
                    </div>
                    <button class="btn btn-primary" id="shareReferralBtn">
                        <i class="fas fa-share"></i>
                        Share Referral Code
                    </button>
                </div>
                
                <div class="wallet-section">
                    <h3 class="section-title">
                        <i class="fas fa-wallet"></i>
                        Jubel Wallet
                    </h3>
                    <div class="wallet-balance">
                        <div class="balance-label">Current Balance</div>
                        <div class="balance-amount-large" id="accountBalance">K0.00</div>
                    </div>
                    <div class="wallet-actions">
                        <button class="btn-wallet" id="depositBtn">
                            <i class="fas fa-plus"></i>
                            Deposit
                        </button>
                        <button class="btn-wallet" id="withdrawBtn">
                            <i class="fas fa-minus"></i>
                            Withdraw
                        </button>
                    </div>
                </div>
                
                <div class="contact-section">
                    <button class="contact-btn whatsapp" id="whatsappBtn">
                        <i class="fab fa-whatsapp"></i>
                        WhatsApp
                    </button>
                    <button class="contact-btn phone" id="callBtn">
                        <i class="fas fa-phone"></i>
                        Call Us
                    </button>
                </div>
            </div>
        </div>
        
        <div class="screen-content" id="historyScreen">
            <div class="screen-header">
                <button class="back-button" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="screen-title">Ride History</h2>
            </div>
            
            <div class="filter-options">
                <select id="historyFilter" class="input-field">
                    <option value="all">All Rides</option>
                    <option value="standard">Standard Rides</option>
                    <option value="premium">Premium Rides</option>
                    <option value="economy">Economy Rides</option>
                    <option value="emergency">Emergency Rides</option>
                    <option value="delivery">Deliveries</option>
                    <option value="requested">Awaiting Driver</option>
                    <option value="accepted">In Progress</option>
                    <option value="completed">Completed</option>
                    <option value="cancelled">Cancelled</option>
                </select>
                <input type="date" id="historyDate" class="input-field">
            </div>
            
            <div class="history-section">
                <div id="historyList">
                    <div class="loading-text">
                        <i class="fas fa-spinner fa-spin"></i>
                        Loading ride history...
                    </div>
                </div>
            </div>
        </div>
        
        <div class="screen-content" id="emergencyScreen">
            <div class="screen-header">
                <button class="back-button" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="screen-title">Emergency Services</h2>
            </div>
            
            <div class="emergency-section">
                <div class="emergency-warning" style="margin-bottom: 15px;">
                    <i class="fas fa-exclamation-triangle"></i>
                    FOR EMERGENCIES ONLY - MISUSE MAY RESULT IN PENALTIES
                </div>
                
                <div class="emergency-quick-actions">
                    <div class="emergency-quick-action" data-emergency-type="ambulance">
                        <i class="fas fa-ambulance"></i>
                        <span>Request Ambulance</span>
                    </div>
                    <div class="emergency-quick-action" data-emergency-type="fire-truck">
                        <i class="fas fa-fire-extinguisher"></i>
                        <span>Fire Emergency</span>
                    </div>
                    <div class="emergency-quick-action" data-emergency-type="emergency-ride">
                        <i class="fas fa-car"></i>
                        <span>Emergency Ride</span>
                    </div>
                    <div class="emergency-quick-action" data-emergency-type="emergency-delivery">
                        <i class="fas fa-pills"></i>
                        <span>Medical Delivery</span>
                    </div>
                </div>
                
                <h3 class="section-title">
                    <i class="fas fa-history"></i>
                    Emergency History
                </h3>
                
                <div id="emergencyHistoryList">
                    <div class="loading-text">
                        <i class="fas fa-spinner fa-spin"></i>
                        Loading emergency history...
                    </div>
                </div>
                
                <div class="emergency-contact-info" style="margin-top: 20px; padding: 15px; background: var(--light-red); border-radius: var(--element-radius);">
                    <h4 class="section-title">
                        <i class="fas fa-phone-alt"></i>
                        Emergency Contacts
                    </h4>
                    <div style="font-size: 0.8rem; line-height: 1.5;">
                        <p><strong>Police:</strong> 999</p>
                        <p><strong>Ambulance:</strong> 992</p>
                        <p><strong>Fire:</strong> 993</p>
                        <p><strong>Jubel Emergency:</strong> 0768658484</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="screen-content" id="moreScreen">
            <div class="screen-header">
                <button class="back-button" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="screen-title">More Options</h2>
            </div>
            
            <div class="account-section">
                <div class="option-list">
                    <div class="option-item" data-option="sos">
                        <div class="option-icon" style="background: var(--emergency-red);">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="option-details">
                            <div class="option-name">SOS Setup</div>
                            <div class="option-description">Configure emergency contacts</div>
                        </div>
                    </div>
                    
                    <div class="option-item" data-option="scheduled">
                        <div class="option-icon" style="background: var(--info-blue);">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="option-details">
                            <div class="option-name">Scheduled Rides</div>
                            <div class="option-description">Schedule rides for later</div>
                        </div>
                    </div>
                    
                    <div class="option-item" data-option="favorites">
                        <div class="option-icon" style="background: var(--success-green);">
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="option-details">
                            <div class="option-name">Favorite Locations</div>
                            <div class="option-description">Save frequently visited places</div>
                        </div>
                    </div>
                    
                    <div class="option-item" data-option="settings">
                        <div class="option-icon" style="background: var(--medium-gray);">
                            <i class="fas fa-cog"></i>
                        </div>
                        <div class="option-details">
                            <div class="option-name">Settings</div>
                            <div class="option-description">App preferences and configuration</div>
                        </div>
                    </div>
                    
                    <div class="option-item" data-option="help">
                        <div class="option-icon" style="background: var(--warning-yellow);">
                            <i class="fas fa-question-circle"></i>
                        </div>
                        <div class="option-details">
                            <div class="option-name">Help & Support</div>
                            <div class="option-description">Get help and contact support</div>
                        </div>
                    </div>
                    
                    <div class="option-item" data-option="logout">
                        <div class="option-icon" style="background: var(--error-red);">
                            <i class="fas fa-sign-out-alt"></i>
                        </div>
                        <div class="option-details">
                            <div class="option-name">Logout</div>
                            <div class="option-description">Sign out of your account</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Ride Details Popup -->
    <div id="rideDetailsPopup" class="popup-overlay hidden">
        <div class="popup-form large-popup">
            <div class="popup-header">
                <h2 class="popup-title">
                    <i class="fas fa-info-circle"></i>
                    Ride Details
                </h2>
                <button class="close-popup" id="closeRidePopupTop">&times;</button>
            </div>
            <div class="popup-content">
                <div class="popup-map-container" id="popupRideMap"></div>
                <div class="popup-details">
                    <div class="detail-row">
                        <span class="detail-label">Pickup:</span>
                        <span class="detail-value" id="popupRidePickup">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Destination:</span>
                        <span class="detail-value" id="popupRideDestination">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Fare:</span>
                        <span class="detail-value" id="popupRideFare">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Distance:</span>
                        <span class="detail-value" id="popupRideDistance">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Ride Type:</span>
                        <span class="detail-value" id="popupRideType">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Status:</span>
                        <span class="detail-value" id="popupRideStatus">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Date & Time:</span>
                        <span class="detail-value" id="popupRideDate">Loading...</span>
                    </div>
                    
                    <!-- Driver Details Section -->
                    <div id="popupDriverDetails" class="driver-details-section hidden">
                        <h3 class="section-title">Driver Information</h3>
                        <div class="detail-row">
                            <span class="detail-label">Driver Name:</span>
                            <span class="detail-value" id="popupDriverName">Loading...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Phone:</span>
                            <span class="detail-value" id="popupDriverPhone">Loading...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Vehicle:</span>
                            <span class="detail-value" id="popupDriverVehicle">Loading...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Rating:</span>
                            <span class="detail-value" id="popupDriverRating">Loading...</span>
                        </div>
                    </div>
                    
                    <!-- Package Details Section -->
                    <div id="popupPackageDetails" class="driver-details-section hidden">
                        <h3 class="section-title">Package Details</h3>
                        <div class="detail-row">
                            <span class="detail-label">Receiver:</span>
                            <span class="detail-value" id="popupPackageReceiver">Loading...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Description:</span>
                            <span class="detail-value" id="popupPackageDescription">Loading...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Weight:</span>
                            <span class="detail-value" id="popupPackageWeight">Loading...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Value:</span>
                            <span class="detail-value" id="popupPackageValue">Loading...</span>
                        </div>
                    </div>
                    
                    <!-- Emergency Details Section -->
                    <div id="popupEmergencyDetails" class="driver-details-section hidden">
                        <h3 class="section-title">Emergency Details</h3>
                        <div class="detail-row">
                            <span class="detail-label">Emergency Type:</span>
                            <span class="detail-value" id="popupEmergencyType">Loading...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Severity:</span>
                            <span class="detail-value" id="popupEmergencySeverity">Loading...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Description:</span>
                            <span class="detail-value" id="popupEmergencyDescription">Loading...</span>
                        </div>
                    </div>
                    
                    <!-- Receipt Button -->
                    <button class="receipt-button" id="generateReceiptBtn">
                        <i class="fas fa-receipt"></i>
                        Generate & Download Receipt
                    </button>
                    
                    <div class="popup-actions">
                        <button class="btn btn-primary" id="closeRidePopup">
                            <i class="fas fa-times"></i>
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Payment Selection Popup -->
    <div id="paymentSelectionPopup" class="popup-overlay hidden">
        <div class="popup-form">
            <div class="popup-header">
                <h2 class="popup-title">
                    <i class="fas fa-credit-card"></i>
                    Select Payment Method
                </h2>
                <button class="close-popup" id="closePaymentPopup">&times;</button>
            </div>
            <div class="popup-content">
                <div class="payment-options">
                    <div class="payment-option selected" data-payment-type="wallet">
                        <div class="payment-option-icon">
                            <i class="fas fa-wallet"></i>
                        </div>
                        <div class="payment-option-details">
                            <div class="payment-option-name">Jubel Wallet</div>
                            <div class="payment-option-description">Pay with your Jubel wallet balance</div>
                            <div class="payment-option-balance" id="paymentWalletBalance">Balance: K0.00</div>
                        </div>
                    </div>
                    
                    <div class="payment-option" data-payment-type="mobile">
                        <div class="payment-option-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="payment-option-details">
                            <div class="payment-option-name">Mobile Money</div>
                            <div class="payment-option-description">Pay with Airtel, MTN or Zamtel Money</div>
                        </div>
                    </div>
                    
                    <div class="payment-option" data-payment-type="cash">
                        <div class="payment-option-icon">
                            <i class="fas fa-money-bill"></i>
                        </div>
                        <div class="payment-option-details">
                            <div class="payment-option-name">Cash on Delivery</div>
                            <div class="payment-option-description">Pay with cash when you arrive</div>
                        </div>
                    </div>
                </div>
                
                <div class="insufficient-balance" id="insufficientBalance">
                    <i class="fas fa-exclamation-circle"></i>
                    Insufficient balance in your Jubel wallet
                </div>
                
                <button class="confirm-payment-btn" id="confirmPaymentBtn">
                    Confirm Payment & Request Ride
                </button>
            </div>
        </div>
    </div>
    
    <!-- Rating Popup -->
    <div id="ratingPopup" class="popup-overlay hidden">
        <div class="popup-form">
            <div class="popup-header">
                <h2 class="popup-title">
                    <i class="fas fa-star"></i>
                    Rate Your Driver
                </h2>
                <button class="close-popup" id="closeRatingPopup">&times;</button>
            </div>
            <div class="popup-content">
                <div class="rating-driver-info">
                    <div class="driver-avatar" id="ratingDriverAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <h3 id="ratingDriverName">Driver Name</h3>
                    <p id="ratingVehicleInfo">Vehicle Info</p>
                </div>
                
                <div class="rating-stars-container">
                    <div class="rating-stars" id="ratingStars">
                        <span class="star" data-rating="1"><i class="far fa-star"></i></span>
                        <span class="star" data-rating="2"><i class="far fa-star"></i></span>
                        <span class="star" data-rating="3"><i class="far fa-star"></i></span>
                        <span class="star" data-rating="4"><i class="far fa-star"></i></span>
                        <span class="star" data-rating="5"><i class="far fa-star"></i></span>
                    </div>
                    <div id="ratingText">Tap to rate</div>
                </div>
                
                <div class="rating-comment">
                    <label for="ratingComment">Additional Comments (Optional)</label>
                    <textarea id="ratingComment" placeholder="How was your ride experience?"></textarea>
                </div>
                
                <button id="submitRatingBtn" class="request-ride-btn">
                    <i class="fas fa-paper-plane"></i> Submit Rating
                </button>
            </div>
        </div>
    </div>
    
    <!-- Emergency Alert Popup -->
    <div id="emergencyAlertPopup" class="popup-overlay hidden">
        <div class="popup-form">
            <div class="popup-header" style="background: var(--emergency-red); color: white;">
                <h2 class="popup-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    EMERGENCY ALERT
                </h2>
                <button class="close-popup" id="closeEmergencyPopup">&times;</button>
            </div>
            <div class="popup-content">
                <div class="emergency-warning" style="margin-bottom: 15px;">
                    <i class="fas fa-ambulance"></i>
                    EMERGENCY VEHICLE DISPATCHED
                </div>
                
                <div class="emergency-details">
                    <p><strong>Emergency Type:</strong> <span id="alertEmergencyType">Medical</span></p>
                    <p><strong>Vehicle:</strong> <span id="alertEmergencyVehicle">Ambulance</span></p>
                    <p><strong>ETA:</strong> <span id="alertEmergencyETA">5 minutes</span></p>
                    <p><strong>Contact Number:</strong> <span id="alertEmergencyContact">992</span></p>
                </div>
                
                <div class="emergency-instructions" style="margin-top: 15px; padding: 10px; background: var(--light-red); border-radius: var(--element-radius);">
                    <p style="font-size: 0.8rem; font-weight: 600;">IMPORTANT INSTRUCTIONS:</p>
                    <ul style="font-size: 0.75rem; margin-top: 5px; padding-left: 15px;">
                        <li>Stay on the line with emergency services</li>
                        <li>Clear the area for emergency vehicle access</li>
                        <li>Have identification and medical information ready</li>
                        <li>Follow instructions from emergency personnel</li>
                    </ul>
                </div>
                
                <button class="btn btn-emergency" id="confirmEmergencyBtn" style="width: 100%; margin-top: 15px;">
                    <i class="fas fa-check"></i> UNDERSTOOD
                </button>
            </div>
        </div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification"></div>
    
    <!-- Firebase and OpenLayers JS -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ol@v7.3.0/dist/ol.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script>
// Firebase configuration
const firebaseConfig = {
    apiKey: "AIzaSyDEACX_P4c5q7djJAcA0I7Lk7leO2TlQ74",
    authDomain: "jubel-13e1a.firebaseapp.com",
    databaseURL: "https://jubel-13e1a-default-rtdb.firebaseio.com",
    projectId: "jubel-13e1a",
    storageBucket: "jubel-13e1a.firebasestorage.app",
    messagingSenderId: "882241095445",
    appId: "1:882241095445:web:ee9ca40fddd008ca910b1c",
    measurementId: "G-J5JPKL6B5F"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const auth = firebase.auth();

// App state
let currentUser = null;
let currentRide = null;
let userData = null;
let walletBalance = 0;
let userLocation = null;
let currentCity = "Detecting...";
let selectedVehicleType = 'car';
let selectedRideType = 'standard';
let selectedEmergencyType = null;
let selectedPaymentType = 'wallet';
let appliedPromoCode = null;
let referralRewardPending = false;
let rideFare = 0;
let currentScreen = 'home';

// OpenLayers Map Objects
let map = null;
let vectorLayer = null;
let currentLocationMarker = null;
let pickupMarker = null;
let destinationMarker = null;
let driverMarker = null;
let routeLayer = null;
let emergencyMarkers = [];

// Firebase Listeners
let driverAssignmentListener = null;
let driverLocationListener = null;
let rideStatusListener = null;
let walletBalanceListener = null;
let rideHistoryListener = null;

// Search state
let destinationSearchResults = [];
let searchCache = new Map();
const CACHE_TTL = 10 * 60 * 1000;

// Zambian cities and boundaries
const zambianCities = [
    'Lusaka', 'Kitwe', 'Ndola', 'Kabwe', 'Chipata', 'Chingola', 
    'Mufulira', 'Luanshya', 'Livingstone', 'Kasama', 'Solwezi', 
    'Kapiri Mposhi', 'Chililabombwe', 'Mazabuka', 'Mongu', 'Kafue',
    'Choma', 'Mansa', 'Nchelenge', 'Kawambwa', 'Mbala', 'Mpika',
    'Petauke', 'Katete', 'Siavonga', 'Monze', 'Kalulushi', 'Mwinilunga'
];

const cityBoundaries = {
    'Lusaka': { center: [-15.4167, 28.2833], radius: 30000 },
    'Kitwe': { center: [-12.8139, 28.2136], radius: 25000 },
    'Ndola': { center: [-12.9667, 28.6333], radius: 25000 },
    'Kabwe': { center: [-14.4333, 28.4500], radius: 20000 },
    'Chipata': { center: [-13.6333, 32.6500], radius: 20000 },
    'Chingola': { center: [-12.5333, 27.8500], radius: 20000 },
    'Mufulira': { center: [-12.5500, 28.2333], radius: 20000 },
    'Luanshya': { center: [-13.1333, 28.4000], radius: 20000 },
    'Livingstone': { center: [-17.8500, 25.8667], radius: 20000 },
    'Kasama': { center: [-10.2000, 31.2000], radius: 20000 },
    'Solwezi': { center: [-12.1833, 26.4000], radius: 20000 }
};

// Common Zambian places
const commonZambianPlaces = {
    'Manda Hill': { city: 'Lusaka', coords: [-15.4070, 28.3147] },
    'East Park Mall': { city: 'Lusaka', coords: [-15.3942, 28.3403] },
    'Levy Mall': { city: 'Lusaka', coords: [-15.4167, 28.2833] },
    'Arcades Shopping Mall': { city: 'Lusaka', coords: [-15.3986, 28.3192] },
    'University of Zambia': { city: 'Lusaka', coords: [-15.3878, 28.3272] },
    'Lusaka Airport': { city: 'Lusaka', coords: [-15.3308, 28.4528] },
    'Ndola Airport': { city: 'Ndola', coords: [-12.9981, 28.6644] },
    'Victoria Falls': { city: 'Livingstone', coords: [-17.9244, 25.8572] }
};

// Initialize the app
document.addEventListener('DOMContentLoaded', function() {
    initializeAuth();
});

// Authentication
function initializeAuth() {
    const urlParams = new URLSearchParams(window.location.search);
    const email = urlParams.get('email');
    const uid = urlParams.get('uid');
    
    if (email && uid) {
        loadUserData(uid);
    } else {
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                loadUserData(user.uid);
            } else {
                window.location.href = 'signup.html';
            }
        });
    }
}

// Load user data
function loadUserData(uid) {
    database.ref('users/' + uid).once('value')
        .then(snapshot => {
            userData = snapshot.val();
            if (userData) {
                currentUser = {
                    uid: uid,
                    email: userData.email,
                    displayName: userData.name
                };
                
                initializeMap();
                setupEventListeners();
                setupFirebaseListeners(uid);
                
                // Update UI
                document.getElementById('accountName').textContent = userData.name || 'Passenger';
                document.getElementById('accountEmail').textContent = userData.email || 'Not set';
                document.getElementById('accountPhone').textContent = userData.phone || 'Not set';
                document.getElementById('referralCode').textContent = userData.referralCode || 'JUBEL-XXXX';
                
                walletBalance = userData.walletBalance || 0;
                updateWalletBalanceUI();
                
                checkActiveRide(uid);
                loadSOSConfig(uid);
                
                showNotification('Welcome back to Jubel!');
            } else {
                showNotification('User data not found. Please sign up again.');
                setTimeout(() => {
                    window.location.href = 'signup.html';
                }, 2000);
            }
        })
        .catch(error => {
            console.error('Error loading user data:', error);
            showNotification('Error loading user data. Please try again.');
        });
}

// Initialize OpenLayers map
function initializeMap() {
    // Set initial view to Zambia
    map = new ol.Map({
        target: 'map',
        layers: [
            new ol.layer.Tile({
                source: new ol.source.OSM()
            })
        ],
        view: new ol.View({
            center: ol.proj.fromLonLat([28, -14]),
            zoom: 7
        }),
        controls: ol.control.defaults().extend([
            new ol.control.Zoom(),
            new ol.control.Rotate()
        ])
    });
    
    // Add vector layer for markers
    vectorLayer = new ol.layer.Vector({
        source: new ol.source.Vector()
    });
    map.addLayer(vectorLayer);
    
    // Add route layer
    routeLayer = new ol.layer.Vector({
        source: new ol.source.Vector(),
        style: new ol.style.Style({
            stroke: new ol.style.Stroke({
                color: '#FF6B35',
                width: 4,
                lineDash: [8, 8]
            })
        })
    });
    map.addLayer(routeLayer);
    
    // Get user location
    refreshPassengerPosition();
}

// Setup Firebase listeners
function setupFirebaseListeners(uid) {
    // Wallet balance listener
    walletBalanceListener = database.ref('users/' + uid + '/walletBalance').on('value', snapshot => {
        const newBalance = snapshot.val() || 0;
        if (newBalance !== walletBalance) {
            walletBalance = newBalance;
            updateWalletBalanceUI();
        }
    });
}

// Update wallet balance UI
function updateWalletBalanceUI() {
    document.getElementById('walletBalance').textContent = `K${walletBalance.toFixed(2)}`;
    document.getElementById('accountBalance').textContent = `K${walletBalance.toFixed(2)}`;
    if (document.getElementById('paymentWalletBalance')) {
        document.getElementById('paymentWalletBalance').textContent = `Balance: K${walletBalance.toFixed(2)}`;
    }
}

// Refresh passenger position
function refreshPassengerPosition() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            userLocation = { lat, lng };
            
            // Update map view
            map.getView().setCenter(ol.proj.fromLonLat([lng, lat]));
            map.getView().setZoom(16);
            
            // Update or create current location marker
            updateCurrentLocationMarker(lat, lng);
            
            // Update pickup location
            updatePickupLocation(lat, lng);
            
            // Detect current city
            determineCurrentCity(lat, lng).then(city => {
                currentCity = city;
                showNotification(`Location detected in ${city}`);
            }).catch(error => {
                console.error('City detection failed:', error);
                currentCity = "Unknown Location";
            });
            
            // Start continuous location tracking
            startLocationTracking();
            
        }, error => {
            console.error('Geolocation error:', error);
            showNotification('Unable to get your location. Please enable location services.');
        });
    } else {
        showNotification('Geolocation is not supported by this browser.');
    }
}

// Update current location marker
function updateCurrentLocationMarker(lat, lng) {
    if (currentLocationMarker) {
        vectorLayer.getSource().removeFeature(currentLocationMarker);
    }
    
    const iconStyle = new ol.style.Style({
        image: new ol.style.Icon({
            src: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40"><circle cx="20" cy="20" r="18" fill="' + encodeURIComponent('#3498db') + '" stroke="white" stroke-width="3"/><text x="20" y="26" text-anchor="middle" fill="white" font-size="16" font-family="Arial">ðŸ“</text></svg>'
        })
    });
    
    currentLocationMarker = new ol.Feature({
        geometry: new ol.geom.Point(ol.proj.fromLonLat([lng, lat]))
    });
    currentLocationMarker.setStyle(iconStyle);
    vectorLayer.getSource().addFeature(currentLocationMarker);
}

// Update pickup location marker
function updatePickupLocation(lat, lng) {
    if (pickupMarker) {
        vectorLayer.getSource().removeFeature(pickupMarker);
    }
    
    const iconStyle = new ol.style.Style({
        image: new ol.style.Icon({
            src: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40"><circle cx="20" cy="20" r="18" fill="' + encodeURIComponent('#FF6B35') + '" stroke="white" stroke-width="3"/><text x="20" y="26" text-anchor="middle" fill="white" font-size="16" font-family="Arial">ðŸ“</text></svg>'
        })
    });
    
    pickupMarker = new ol.Feature({
        geometry: new ol.geom.Point(ol.proj.fromLonLat([lng, lat]))
    });
    pickupMarker.setStyle(iconStyle);
    vectorLayer.getSource().addFeature(pickupMarker);
    
    // Get precise address
    getPreciseAddress(lat, lng, 'pickupLocation');
}

// Get precise address format
function getPreciseAddress(lat, lng, elementId) {
    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`)
        .then(response => response.json())
        .then(data => {
            if (data && data.address) {
                const address = data.address;
                let preciseAddress = '';
                
                // House number or building name
                if (address.house_number || address.housenumber) {
                    preciseAddress += (address.house_number || address.housenumber) + ', ';
                }
                if (address.building) {
                    preciseAddress += address.building + ', ';
                }
                
                // Road/Street
                if (address.road) {
                    preciseAddress += address.road + ', ';
                }
                
                // Area/Suburb
                if (address.suburb) {
                    preciseAddress += address.suburb + ', ';
                } else if (address.neighbourhood) {
                    preciseAddress += address.neighbourhood + ', ';
                }
                
                // City
                if (address.city) {
                    preciseAddress += address.city;
                } else if (address.town) {
                    preciseAddress += address.town;
                } else if (address.village) {
                    preciseAddress += address.village;
                }
                
                document.getElementById(elementId).value = preciseAddress || `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            } else {
                document.getElementById(elementId).value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            }
        })
        .catch(error => {
            console.error('Reverse geocoding error:', error);
            document.getElementById(elementId).value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        });
}

// Determine current city
function determineCurrentCity(lat, lng) {
    return new Promise((resolve) => {
        // First check known city boundaries
        for (const [city, boundary] of Object.entries(cityBoundaries)) {
            const distance = calculateDistance(lat, lng, boundary.center[1], boundary.center[0]);
            if (distance <= boundary.radius) {
                resolve(city);
                return;
            }
        }
        
        // Fallback to Nominatim
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=10`)
            .then(response => response.json())
            .then(data => {
                if (data && data.address) {
                    const city = data.address.city || data.address.town || data.address.village || "Unknown Location";
                    resolve(city);
                } else {
                    resolve("Unknown Location");
                }
            })
            .catch(() => {
                resolve("Unknown Location");
            });
    });
}

// Calculate distance between coordinates
function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371e3;
    const Ï†1 = lat1 * Math.PI / 180;
    const Ï†2 = lat2 * Math.PI / 180;
    const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
    const Î”Î» = (lon2 - lon1) * Math.PI / 180;

    const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
              Math.cos(Ï†1) * Math.cos(Ï†2) *
              Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

    return R * c;
}

// Search places
function searchPlaces(query, searchType = 'destination') {
    if (!query || query.length < 2) {
        hideSearchSuggestions(searchType);
        return;
    }
    
    const suggestionsContainer = document.getElementById(`${searchType}Suggestions`);
    suggestionsContainer.innerHTML = '<div class="loading-text">Searching...</div>';
    suggestionsContainer.style.display = 'block';
    
    // Check cache
    const cacheKey = `${searchType}:${query.toLowerCase()}`;
    const cached = searchCache.get(cacheKey);
    if (cached && (Date.now() - cached.timestamp) < CACHE_TTL) {
        displaySearchResults(cached.results, searchType);
        return;
    }
    
    // Build search query
    let searchQuery = query;
    if (currentCity && currentCity !== "Unknown Location") {
        searchQuery = `${query}, ${currentCity}, Zambia`;
    } else {
        searchQuery = `${query}, Zambia`;
    }
    
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&limit=10&countrycodes=zm`)
        .then(response => response.json())
        .then(data => {
            const enhancedResults = data.map(place => {
                const distance = userLocation ? calculateDistance(
                    userLocation.lat, userLocation.lng,
                    parseFloat(place.lat), parseFloat(place.lon)
                ) : 0;
                
                return {
                    ...place,
                    distance,
                    displayLat: parseFloat(place.lat),
                    displayLon: parseFloat(place.lon)
                };
            });
            
            // Cache results
            searchCache.set(cacheKey, {
                results: enhancedResults,
                timestamp: Date.now()
            });
            
            displaySearchResults(enhancedResults, searchType);
        })
        .catch(error => {
            console.error('Search error:', error);
            suggestionsContainer.innerHTML = '<div class="no-places">Error searching. Please try again.</div>';
        });
}

// Display search results
function displaySearchResults(results, searchType) {
    const suggestionsContainer = document.getElementById(`${searchType}Suggestions`);
    suggestionsContainer.innerHTML = '';
    
    if (results.length === 0) {
        suggestionsContainer.innerHTML = '<div class="no-places">No places found. Try a different search term.</div>';
        return;
    }
    
    results.forEach((result, index) => {
        const suggestionItem = document.createElement('div');
        suggestionItem.className = 'suggestion-item';
        
        const distanceText = result.distance > 0 ? 
            `${(result.distance / 1000).toFixed(1)} km away` : '';
        
        suggestionItem.innerHTML = `
            <div class="suggestion-icon">ðŸ“</div>
            <div class="suggestion-details">
                <div class="suggestion-name">${result.display_name}</div>
                <div class="suggestion-address">${result.display_name.split(',').slice(0, 2).join(',')}</div>
                <div class="suggestion-distance">${distanceText}</div>
            </div>
        `;
        
        suggestionItem.addEventListener('click', function() {
            handleSearchResultSelection(result, searchType);
        });
        
        suggestionsContainer.appendChild(suggestionItem);
    });
}

// Handle search result selection
function handleSearchResultSelection(result, searchType) {
    const inputField = document.getElementById(searchType === 'destination' ? 'destinationLocation' : searchType);
    if (inputField) {
        inputField.value = result.display_name;
    }
    
    hideSearchSuggestions(searchType);
    
    if (searchType === 'destination') {
        updateFareEstimate();
        updateDestinationMarker(result.displayLat, result.displayLon, result.display_name);
        drawRoute(userLocation.lat, userLocation.lng, result.displayLat, result.displayLon);
    }
}

// Hide search suggestions
function hideSearchSuggestions(searchType) {
    const suggestionsContainer = document.getElementById(`${searchType}Suggestions`);
    if (suggestionsContainer) {
        suggestionsContainer.style.display = 'none';
    }
}

// Update destination marker
function updateDestinationMarker(lat, lng, name) {
    if (destinationMarker) {
        vectorLayer.getSource().removeFeature(destinationMarker);
    }
    
    const iconStyle = new ol.style.Style({
        image: new ol.style.Icon({
            src: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40"><circle cx="20" cy="20" r="18" fill="' + encodeURIComponent('#E74C3C') + '" stroke="white" stroke-width="3"/><text x="20" y="26" text-anchor="middle" fill="white" font-size="16" font-family="Arial">ðŸ</text></svg>'
        })
    });
    
    destinationMarker = new ol.Feature({
        geometry: new ol.geom.Point(ol.proj.fromLonLat([lng, lat]))
    });
    destinationMarker.setStyle(iconStyle);
    vectorLayer.getSource().addFeature(destinationMarker);
}

// Draw route between two points
function drawRoute(startLat, startLng, endLat, endLng) {
    routeLayer.getSource().clear();
    
    // Try OSRM routing
    fetch(`https://router.project-osrm.org/route/v1/driving/${startLng},${startLat};${endLng},${endLat}?overview=full&geometries=geojson`)
        .then(response => response.json())
        .then(data => {
            if (data.routes && data.routes.length > 0) {
                const route = data.routes[0];
                const coordinates = route.geometry.coordinates.map(coord => ol.proj.fromLonLat(coord));
                
                const routeFeature = new ol.Feature({
                    geometry: new ol.geom.LineString(coordinates)
                });
                routeLayer.getSource().addFeature(routeFeature);
                
                // Fit map to show the route
                const extent = routeFeature.getGeometry().getExtent();
                map.getView().fit(extent, { padding: [50, 50, 50, 50] });
            }
        })
        .catch(error => {
            console.error('Error fetching route:', error);
            // Draw straight line as fallback
            const coordinates = [
                ol.proj.fromLonLat([startLng, startLat]),
                ol.proj.fromLonLat([endLng, endLat])
            ];
            
            const routeFeature = new ol.Feature({
                geometry: new ol.geom.LineString(coordinates)
            });
            routeLayer.getSource().addFeature(routeFeature);
            
            const extent = routeFeature.getGeometry().getExtent();
            map.getView().fit(extent, { padding: [50, 50, 50, 50] });
        });
}

// Update fare estimate
function updateFareEstimate() {
    const destination = document.getElementById('destinationLocation').value;
    
    if (!destination || !userLocation) {
        document.getElementById('estimatedFare').textContent = 'K0.00';
        document.getElementById('etaDisplay').textContent = 'ETA: -- min';
        document.getElementById('requestRideBtn').disabled = true;
        return;
    }
    
    document.getElementById('estimatedFare').textContent = 'Calculating...';
    document.getElementById('etaDisplay').textContent = 'Estimating...';
    
    // Forward geocode destination
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(destination)}&limit=1`)
        .then(response => response.json())
        .then(results => {
            if (results.length > 0) {
                const destLat = parseFloat(results[0].lat);
                const destLng = parseFloat(results[0].lon);
                
                const distance = calculateDistance(userLocation.lat, userLocation.lng, destLat, destLng);
                const distanceKm = distance / 1000;
                
                // Calculate base fare based on ride type
                let baseFare = calculateBaseFare(distanceKm);
                
                // Apply promo discount if any
                if (appliedPromoCode) {
                    baseFare = baseFare * 0.8; // 20% discount for promo codes
                }
                
                // Update UI
                document.getElementById('estimatedFare').textContent = `K${baseFare.toFixed(2)}`;
                
                const etaMinutes = Math.ceil((distanceKm / 30) * 60);
                document.getElementById('etaDisplay').textContent = `ETA: ${etaMinutes} min`;
                
                document.getElementById('requestRideBtn').disabled = false;
                rideFare = baseFare;
            }
        })
        .catch(error => {
            console.error('Error calculating fare:', error);
            document.getElementById('estimatedFare').textContent = 'K0.00';
            document.getElementById('etaDisplay').textContent = 'ETA: -- min';
            document.getElementById('requestRideBtn').disabled = true;
        });
}

// Calculate base fare based on ride type and distance
function calculateBaseFare(distanceKm) {
    let baseFare = 0;
    
    switch(selectedRideType) {
        case 'standard':
            baseFare = 23 + Math.ceil(distanceKm * 5);
            break;
        case 'premium':
            baseFare = 50 + Math.ceil(distanceKm * 8);
            break;
        case 'economy':
            baseFare = 15 + Math.ceil(distanceKm * 3);
            break;
        case 'emergency':
            baseFare = 100 + Math.ceil(distanceKm * 15);
            break;
        default:
            baseFare = 23 + Math.ceil(distanceKm * 5);
    }
    
    // Vehicle type multiplier
    switch(selectedVehicleType) {
        case 'car':
            // Standard price
            break;
        case 'bike':
            baseFare = baseFare * 0.7;
            break;
        case 'truck':
            baseFare = baseFare * 1.5;
            break;
    }
    
    return Math.max(15, baseFare);
}

// Request ride
function requestRide() {
    const pickupLocation = document.getElementById('pickupLocation').value;
    const destinationLocation = document.getElementById('destinationLocation').value;
    
    if (!destinationLocation) {
        showNotification('Please enter a destination');
        return;
    }
    
    if (!userLocation) {
        showNotification('Unable to determine your location. Please try again.');
        return;
    }
    
    // For emergency rides, show questionnaire first
    if (selectedRideType === 'emergency') {
        showEmergencyQuestionnaire();
        return;
    }
    
    // Forward geocode destination
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(destinationLocation)}&limit=1`)
        .then(response => response.json())
        .then(destinationResults => {
            if (destinationResults.length === 0) {
                showNotification('Invalid destination address. Please select a valid destination.');
                return;
            }
            
            const destLat = parseFloat(destinationResults[0].lat);
            const destLng = parseFloat(destinationResults[0].lon);
            
            const distance = calculateDistance(userLocation.lat, userLocation.lng, destLat, destLng);
            const distanceKm = distance / 1000;
            
            const fare = calculateBaseFare(distanceKm);
            if (appliedPromoCode) {
                fare = fare * 0.8;
            }
            
            // Get package details if applicable
            let packageDetails = null;
            if (document.getElementById('packageForm').classList.contains('active')) {
                packageDetails = {
                    receiverName: document.getElementById('receiverName').value,
                    receiverPhone: document.getElementById('receiverPhone').value,
                    packageDescription: document.getElementById('packageDescription').value,
                    packageWeight: document.getElementById('packageWeight').value,
                    packageValue: document.getElementById('packageValue').value,
                    specialInstructions: document.getElementById('specialInstructions').value
                };
            }
            
            const rideId = database.ref().child('rides').push().key;
            
            const rideRequest = {
                id: rideId,
                passengerId: currentUser.uid,
                passengerName: userData.name || 'Passenger',
                passengerPhone: userData.phone || 'Not provided',
                pickupLocation: pickupLocation,
                destination: destinationResults[0].display_name,
                pickupLat: userLocation.lat,
                pickupLng: userLocation.lng,
                destLat: destLat,
                destLng: destLng,
                rideType: selectedRideType,
                vehicleType: selectedVehicleType,
                fare: fare,
                distance: distanceKm.toFixed(2) + ' km',
                status: 'requested',
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                updatedAt: firebase.database.ServerValue.TIMESTAMP,
                promoCode: appliedPromoCode,
                paymentMethod: selectedPaymentType,
                packageDetails: packageDetails,
                currentCity: currentCity
            };
            
            // Store ride request data
            window.currentRideRequestData = rideRequest;
            
            // Show payment selection
            showPaymentSelection(fare);
        })
        .catch(error => {
            console.error('Error in ride request process:', error);
            showNotification('Error calculating route. Please try again.');
        });
}

// Show emergency questionnaire
function showEmergencyQuestionnaire() {
    document.getElementById('emergencyQuestionnaire').classList.add('active');
    document.getElementById('emergencyVehicleSelection').classList.add('active');
    document.getElementById('rideRequestForm').style.display = 'none';
    document.getElementById('requestRideBtn').textContent = 'REQUEST EMERGENCY VEHICLE';
    document.getElementById('requestRideBtn').classList.add('emergency');
}

// Submit emergency request
function submitEmergencyRequest() {
    const emergencyType = document.getElementById('emergencyType').value;
    const emergencySeverity = document.getElementById('emergencySeverity').value;
    const emergencyDescription = document.getElementById('emergencyDescription').value;
    const numberOfPeople = document.getElementById('numberOfPeople').value;
    const destinationLocation = document.getElementById('destinationLocation').value;
    
    if (!emergencyType || !emergencySeverity || !emergencyDescription || !destinationLocation) {
        showNotification('Please fill in all emergency details');
        return;
    }
    
    // Get destination coordinates
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(destinationLocation)}&limit=1`)
        .then(response => response.json())
        .then(destinationResults => {
            if (destinationResults.length === 0) {
                showNotification('Invalid destination address. Please select a valid destination.');
                return;
            }
            
            const destLat = parseFloat(destinationResults[0].lat);
            const destLng = parseFloat(destinationResults[0].lon);
            
            const distance = calculateDistance(userLocation.lat, userLocation.lng, destLat, destLng);
            const distanceKm = distance / 1000;
            
            const fare = calculateBaseFare(distanceKm);
            
            const rideId = database.ref().child('rides').push().key;
            
            const rideRequest = {
                id: rideId,
                passengerId: currentUser.uid,
                passengerName: userData.name || 'Passenger',
                passengerPhone: userData.phone || 'Not provided',
                pickupLocation: document.getElementById('pickupLocation').value,
                destination: destinationResults[0].display_name,
                pickupLat: userLocation.lat,
                pickupLng: userLocation.lng,
                destLat: destLat,
                destLng: destLng,
                rideType: 'emergency',
                emergencyType: emergencyType,
                emergencySeverity: emergencySeverity,
                emergencyDescription: emergencyDescription,
                numberOfPeople: numberOfPeople,
                vehicleType: selectedEmergencyType,
                fare: fare,
                distance: distanceKm.toFixed(2) + ' km',
                status: 'requested',
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                updatedAt: firebase.database.ServerValue.TIMESTAMP,
                paymentMethod: 'cash', // Emergency rides are cash only
                currentCity: currentCity,
                isEmergency: true
            };
            
            // Store ride request data
            window.currentRideRequestData = rideRequest;
            
            // Submit emergency ride immediately (no payment selection)
            submitEmergencyRide(rideRequest);
        })
        .catch(error => {
            console.error('Error in emergency request process:', error);
            showNotification('Error processing emergency request. Please try again.');
        });
}

// Submit emergency ride
function submitEmergencyRide(rideRequest) {
    database.ref('rides/' + rideRequest.id).set(rideRequest)
        .then(() => {
            currentRide = rideRequest;
            
            // Hide emergency forms
            document.getElementById('emergencyQuestionnaire').classList.remove('active');
            document.getElementById('emergencyVehicleSelection').classList.remove('active');
            
            // Update UI for active ride
            updateUIForActiveRide();
            
            // Show emergency search animation
            document.getElementById('searchingAnimation').classList.add('emergency');
            document.getElementById('searchingAnimation').style.display = 'flex';
            document.getElementById('searchingAnimation').querySelector('.searching-text').textContent = 'Searching for emergency vehicle...';
            
            // Update ride status
            document.getElementById('rideStatus').style.display = 'flex';
            document.getElementById('statusDot').className = 'status-dot emergency';
            document.getElementById('statusText').textContent = 'Emergency vehicle dispatched';
            
            // Show SOS button
            document.getElementById('sosButton').style.display = 'flex';
            
            // Show emergency alert popup
            showEmergencyAlert(rideRequest);
            
            showNotification('EMERGENCY: Vehicle dispatched!', 'emergency');
            
            // Listen for driver assignment
            listenForDriverAssignment(rideRequest.id);
        })
        .catch(error => {
            console.error('Error requesting emergency ride:', error);
            showNotification('Error requesting emergency vehicle. Please try again or call 992 directly.', 'emergency');
        });
}

// Show emergency alert popup
function showEmergencyAlert(rideRequest) {
    document.getElementById('alertEmergencyType').textContent = rideRequest.emergencyType || 'Emergency';
    document.getElementById('alertEmergencyVehicle').textContent = rideRequest.vehicleType || 'Emergency Vehicle';
    document.getElementById('alertEmergencyETA').textContent = '5 minutes';
    document.getElementById('alertEmergencyContact').textContent = '992';
    
    document.getElementById('emergencyAlertPopup').classList.remove('hidden');
}

// Show payment selection
function showPaymentSelection(fare) {
    document.getElementById('paymentWalletBalance').textContent = `Balance: K${walletBalance.toFixed(2)}`;
    
    if (walletBalance < fare && selectedPaymentType === 'wallet') {
        document.getElementById('insufficientBalance').style.display = 'block';
        document.getElementById('confirmPaymentBtn').disabled = true;
    } else {
        document.getElementById('insufficientBalance').style.display = 'none';
        document.getElementById('confirmPaymentBtn').disabled = false;
    }
    
    document.getElementById('paymentSelectionPopup').classList.remove('hidden');
}

// Submit ride request after payment confirmation
function submitRideRequestAfterPayment() {
    const rideRequest = window.currentRideRequestData;
    if (!rideRequest) {
        showNotification('No ride request data found. Please try again.');
        return;
    }
    
    if (selectedPaymentType === 'wallet') {
        const newBalance = walletBalance - rideRequest.fare;
        
        if (newBalance < 0) {
            showNotification('Insufficient wallet balance. Please select another payment method.');
            return;
        }
        
        // Update wallet balance
        database.ref('users/' + currentUser.uid).update({
            walletBalance: newBalance
        })
        .then(() => {
            walletBalance = newBalance;
            updateWalletBalanceUI();
            
            return database.ref('rides/' + rideRequest.id).set(rideRequest);
        })
        .then(() => {
            currentRide = rideRequest;
            closePaymentSelection();
            updateUIForActiveRide();
            
            // Show searching animation
            document.getElementById('searchingAnimation').style.display = 'flex';
            document.getElementById('rideStatus').style.display = 'flex';
            document.getElementById('statusDot').className = 'status-dot searching';
            document.getElementById('statusText').textContent = 'Searching for driver';
            
            if (document.getElementById('sosButton')) {
                document.getElementById('sosButton').style.display = 'flex';
            }
            
            showNotification('Ride requested. Searching for a driver...');
            
            // Listen for driver assignment
            listenForDriverAssignment(rideRequest.id);
        })
        .catch(error => {
            console.error('Error requesting ride:', error);
            showNotification('Error requesting ride. Please try again.');
        });
    } else {
        // For cash or mobile money
        database.ref('rides/' + rideRequest.id).set(rideRequest)
            .then(() => {
                currentRide = rideRequest;
                closePaymentSelection();
                updateUIForActiveRide();
                
                document.getElementById('searchingAnimation').style.display = 'flex';
                document.getElementById('rideStatus').style.display = 'flex';
                document.getElementById('statusDot').className = 'status-dot searching';
                document.getElementById('statusText').textContent = 'Searching for driver';
                
                if (document.getElementById('sosButton')) {
                    document.getElementById('sosButton').style.display = 'flex';
                }
                
                showNotification('Ride requested. Searching for a driver...');
                
                listenForDriverAssignment(rideRequest.id);
            })
            .catch(error => {
                console.error('Error requesting ride:', error);
                showNotification('Error requesting ride. Please try again.');
            });
    }
    
    // Clear ride request data
    window.currentRideRequestData = null;
}

// Update UI for active ride
function updateUIForActiveRide() {
    if (!currentRide) return;
    
    document.getElementById('rideRequestForm').style.display = 'none';
    document.getElementById('rideInfoPanel').style.display = 'block';
    
    document.getElementById('currentPickupLocation').textContent = currentRide.pickupLocation;
    document.getElementById('currentDestinationLocation').textContent = currentRide.destination;
    
    const baseFare = currentRide.fare || 0;
    const discount = appliedPromoCode ? baseFare * 0.2 : 0;
    const totalFare = baseFare - discount;
    
    document.getElementById('baseFare').textContent = `K${baseFare.toFixed(2)}`;
    document.getElementById('discountFare').textContent = `-K${discount.toFixed(2)}`;
    document.getElementById('totalFare').textContent = `K${totalFare.toFixed(2)}`;
    
    // Show driver details if available
    if (currentRide.driverId) {
        loadDriverDetails(currentRide.driverId);
    }
}

// Listen for driver assignment
function listenForDriverAssignment(rideId) {
    if (driverAssignmentListener) {
        driverAssignmentListener();
    }
    
    driverAssignmentListener = database.ref('rides/' + rideId).on('value', snapshot => {
        const ride = snapshot.val();
        if (!ride) return;
        
        if (ride.driverId && ride.status === 'accepted') {
            handleDriverAssignment(ride);
        } else if (ride.status === 'completed') {
            showRideCompletion(ride);
        } else if (ride.status === 'cancelled') {
            handleRideCancellation(ride);
        }
    });
}

// Handle driver assignment
function handleDriverAssignment(ride) {
    document.getElementById('searchingAnimation').style.display = 'none';
    
    document.getElementById('statusDot').className = 'status-dot arriving';
    document.getElementById('statusText').textContent = 'Driver arriving';
    
    document.getElementById('estimatedTime').style.display = 'flex';
    document.getElementById('timeText').textContent = '5 min';
    
    // Load driver details
    loadDriverDetails(ride.driverId);
    
    // Add driver marker
    if (ride.driverLat && ride.driverLng) {
        addDriverMarker(ride.driverLat, ride.driverLng);
        drawRoute(ride.driverLat, ride.driverLng, ride.pickupLat, ride.pickupLng);
        trackDriverLocation(ride.driverId);
    }
    
    showNotification(`Driver ${ride.driverName || 'is'} on the way!`);
    
    // Listen for ride status updates
    listenForRideStatusUpdates(ride.id);
}

// Load driver details
function loadDriverDetails(driverId) {
    database.ref('users/' + driverId).once('value')
        .then(driverSnapshot => {
            const driver = driverSnapshot.val();
            if (driver) {
                updateDriverUI(driver);
            }
        })
        .catch(error => {
            console.error('Error loading driver details:', error);
        });
}

// Update driver UI
function updateDriverUI(driver) {
    document.getElementById('driverName').textContent = driver.name || 'Driver';
    document.getElementById('driverPhone').textContent = driver.phone || 'N/A';
    document.getElementById('driverRating').textContent = driver.rating ? `${driver.rating} â˜…` : '4.5 â˜…';
    
    if (driver.vehicle) {
        document.getElementById('vehicleDetails').textContent = 
            `${driver.vehicle.type || 'Vehicle'} - ${driver.vehicle.licensePlate || 'ABC123'}`;
    }
    
    // Update driver avatar
    const driverAvatar = document.getElementById('driverAvatar');
    if (driver.name) {
        driverAvatar.textContent = driver.name.charAt(0).toUpperCase();
    } else {
        driverAvatar.innerHTML = '<i class="fas fa-user"></i>';
    }
}

// Add driver marker
function addDriverMarker(lat, lng) {
    if (driverMarker) {
        vectorLayer.getSource().removeFeature(driverMarker);
    }
    
    const iconStyle = new ol.style.Style({
        image: new ol.style.Icon({
            src: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40"><circle cx="20" cy="20" r="18" fill="' + encodeURIComponent('#FF6B35') + '" stroke="white" stroke-width="3"/><text x="20" y="26" text-anchor="middle" fill="white" font-size="16" font-family="Arial">ðŸš—</text></svg>'
        })
    });
    
    driverMarker = new ol.Feature({
        geometry: new ol.geom.Point(ol.proj.fromLonLat([lng, lat]))
    });
    driverMarker.setStyle(iconStyle);
    vectorLayer.getSource().addFeature(driverMarker);
}

// Track driver location
function trackDriverLocation(driverId) {
    if (driverLocationListener) {
        driverLocationListener();
    }
    
    driverLocationListener = database.ref('driverLocations/' + driverId).on('value', snapshot => {
        const location = snapshot.val();
        if (location && driverMarker) {
            driverMarker.getGeometry().setCoordinates(ol.proj.fromLonLat([location.longitude, location.latitude]));
            updateDriverETA(location.latitude, location.longitude);
        }
    });
}

// Update driver ETA
function updateDriverETA(driverLat, driverLng) {
    if (userLocation) {
        const distance = calculateDistance(driverLat, driverLng, userLocation.lat, userLocation.lng);
        const etaMinutes = Math.ceil((distance / 1000) / 30 * 60);
        document.getElementById('timeText').textContent = `${etaMinutes} min`;
    }
}

// Listen for ride status updates
function listenForRideStatusUpdates(rideId) {
    if (rideStatusListener) {
        rideStatusListener();
    }
    
    rideStatusListener = database.ref('rides/' + rideId).on('value', snapshot => {
        const ride = snapshot.val();
        if (ride) {
            currentRide = ride;
            
            switch(ride.status) {
                case 'accepted':
                    document.getElementById('statusText').textContent = 'Driver on the way';
                    break;
                case 'arrived':
                    document.getElementById('statusText').textContent = 'Driver arrived';
                    document.getElementById('statusDot').className = 'status-dot riding';
                    showNotification('Your driver has arrived!');
                    break;
                case 'started':
                    document.getElementById('statusText').textContent = 'Trip in progress';
                    break;
                case 'completed':
                    handleRideCompletion(ride);
                    break;
                case 'cancelled':
                    handleRideCancellation(ride);
                    break;
            }
        }
    });
}

// Handle ride completion
function handleRideCompletion(ride) {
    document.getElementById('rideStatus').style.display = 'none';
    document.getElementById('estimatedTime').style.display = 'none';
    document.getElementById('sosButton').style.display = 'none';
    resetUIAfterRide();
    
    // Process referral reward if applicable
    if (ride.promoCode && ride.promoCode.startsWith('JUBEL-')) {
        processReferralReward(ride.promoCode, ride.passengerId, ride.fare);
    }
    
    // Show rating popup
    showRatingPopup(ride);
    
    showNotification('Trip completed. Thank you for using Jubel!');
}

// Process referral reward
function processReferralReward(referralCode, referredUserId, rideFare) {
    // Find referrer by referral code
    database.ref('users').orderByChild('referralCode').equalTo(referralCode).once('value')
        .then(snapshot => {
            if (snapshot.exists()) {
                const referrerData = snapshot.val();
                const referrerId = Object.keys(referrerData)[0];
                const referrer = referrerData[referrerId];
                
                // Check if this is the first completed ride for referred user
                database.ref('rides').orderByChild('passengerId').equalTo(referredUserId).once('value')
                    .then(ridesSnapshot => {
                        const rides = ridesSnapshot.val();
                        let completedRides = 0;
                        
                        if (rides) {
                            Object.values(rides).forEach(ride => {
                                if (ride.status === 'completed' || ride.status === 'paid') {
                                    completedRides++;
                                }
                            });
                        }
                        
                        // If this is the first completed ride, give reward
                        if (completedRides === 1) {
                            const rewardAmount = 25;
                            const newBalance = (referrer.walletBalance || 0) + rewardAmount;
                            
                            database.ref('users/' + referrerId).update({
                                walletBalance: newBalance
                            })
                            .then(() => {
                                // Record the referral
                                database.ref('referrals').push().set({
                                    referrerId: referrerId,
                                    referredUserId: referredUserId,
                                    referralCode: referralCode,
                                    rewardAmount: rewardAmount,
                                    rideFare: rideFare,
                                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                                    status: 'completed'
                                });
                                
                                showNotification(`You earned K${rewardAmount} from referral!`);
                            });
                        }
                    });
            }
        })
        .catch(error => {
            console.error('Error processing referral reward:', error);
        });
}

// Show rating popup
function showRatingPopup(ride) {
    if (!document.getElementById('ratingPopup')) {
        createRatingPopup();
    }
    
    document.getElementById('ratingPopup').setAttribute('data-ride-id', ride.id);
    document.getElementById('ratingDriverName').textContent = ride.driverName || 'Driver';
    document.getElementById('ratingVehicleInfo').textContent = 
        `${ride.driverVehicle?.type || 'Vehicle'} - ${ride.driverVehicle?.licensePlate || 'N/A'}`;
    
    resetRatingStars();
    document.getElementById('ratingPopup').classList.remove('hidden');
}

// Create rating popup
function createRatingPopup() {
    const ratingPopup = document.createElement('div');
    ratingPopup.id = 'ratingPopup';
    ratingPopup.className = 'popup-overlay hidden';
    ratingPopup.innerHTML = `
        <div class="popup-form">
            <div class="popup-header">
                <h2 class="popup-title">
                    <i class="fas fa-star"></i>
                    Rate Your Driver
                </h2>
                <button class="close-popup" id="closeRatingPopup">&times;</button>
            </div>
            <div class="popup-content">
                <div class="rating-driver-info">
                    <div class="driver-avatar" id="ratingDriverAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <h3 id="ratingDriverName">Driver Name</h3>
                    <p id="ratingVehicleInfo">Vehicle Info</p>
                </div>
                
                <div class="rating-stars-container">
                    <div class="rating-stars" id="ratingStars">
                        <span class="star" data-rating="1"><i class="far fa-star"></i></span>
                        <span class="star" data-rating="2"><i class="far fa-star"></i></span>
                        <span class="star" data-rating="3"><i class="far fa-star"></i></span>
                        <span class="star" data-rating="4"><i class="far fa-star"></i></span>
                        <span class="star" data-rating="5"><i class="far fa-star"></i></span>
                    </div>
                    <div id="ratingText">Tap to rate</div>
                </div>
                
                <div class="rating-comment">
                    <label for="ratingComment">Additional Comments (Optional)</label>
                    <textarea id="ratingComment" placeholder="How was your ride experience?"></textarea>
                </div>
                
                <button id="submitRatingBtn" class="request-ride-btn">
                    <i class="fas fa-paper-plane"></i> Submit Rating
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(ratingPopup);
    
    // Add event listeners
    document.getElementById('closeRatingPopup').addEventListener('click', closeRatingPopup);
    document.getElementById('submitRatingBtn').addEventListener('click', submitRating);
    
    const stars = document.querySelectorAll('#ratingStars .star');
    stars.forEach(star => {
        star.addEventListener('click', function() {
            const rating = parseInt(this.getAttribute('data-rating'));
            setRatingStars(rating);
        });
    });
}

// Set rating stars
function setRatingStars(rating) {
    const stars = document.querySelectorAll('#ratingStars .star');
    const ratingText = document.getElementById('ratingText');
    
    stars.forEach((star, index) => {
        if (index < rating) {
            star.innerHTML = '<i class="fas fa-star"></i>';
            star.style.color = '#FFD700';
        } else {
            star.innerHTML = '<i class="far fa-star"></i>';
            star.style.color = '#CCCCCC';
        }
    });
    
    const ratingTexts = {
        1: 'Poor',
        2: 'Fair',
        3: 'Good',
        4: 'Very Good',
        5: 'Excellent'
    };
    
    ratingText.textContent = ratingTexts[rating] || 'Tap to rate';
    ratingText.style.color = '#FF6B35';
}

// Submit rating
function submitRating() {
    const rideId = document.getElementById('ratingPopup').getAttribute('data-ride-id');
    const rating = document.querySelectorAll('#ratingStars .star i.fas').length;
    const comment = document.getElementById('ratingComment').value.trim();
    
    if (rating === 0) {
        showNotification('Please select a rating');
        return;
    }
    
    if (!rideId || !currentRide || !currentRide.driverId) {
        showNotification('Error submitting rating. Please try again.');
        return;
    }
    
    const ratingData = {
        rideId: rideId,
        driverId: currentRide.driverId,
        passengerId: currentUser.uid,
        passengerName: userData.name || 'Passenger',
        rating: rating,
        comment: comment,
        timestamp: firebase.database.ServerValue.TIMESTAMP
    };
    
    database.ref('ratings').push(ratingData)
        .then(() => {
            updateDriverRating(currentRide.driverId, rating);
            showNotification('Thank you for your rating!');
            closeRatingPopup();
        })
        .catch(error => {
            console.error('Error submitting rating:', error);
            showNotification('Error submitting rating. Please try again.');
        });
}

// Update driver rating
function updateDriverRating(driverId, newRating) {
    database.ref('ratings').orderByChild('driverId').equalTo(driverId).once('value')
        .then(snapshot => {
            const ratings = snapshot.val();
            let totalRating = 0;
            let ratingCount = 0;
            
            if (ratings) {
                Object.values(ratings).forEach(rating => {
                    totalRating += rating.rating;
                    ratingCount++;
                });
            }
            
            // Add new rating
            totalRating += newRating;
            ratingCount++;
            
            const averageRating = totalRating / ratingCount;
            return database.ref('users/' + driverId + '/rating').set(averageRating.toFixed(1));
        })
        .catch(error => {
            console.error('Error updating driver rating:', error);
        });
}

// Handle ride cancellation
function handleRideCancellation(ride) {
    document.getElementById('searchingAnimation').style.display = 'none';
    
    showNotification('Ride has been cancelled.');
    resetUIAfterRide();
    currentRide = null;
    
    if (driverMarker) {
        vectorLayer.getSource().removeFeature(driverMarker);
        driverMarker = null;
    }
    
    if (driverAssignmentListener) {
        driverAssignmentListener();
        driverAssignmentListener = null;
    }
    
    if (driverLocationListener) {
        driverLocationListener();
        driverLocationListener = null;
    }
}

// Cancel ride
function cancelRide() {
    if (currentRide) {
        if (confirm('Are you sure you want to cancel this ride?')) {
            database.ref('rides/' + currentRide.id).update({
                status: 'cancelled',
                cancelledAt: firebase.database.ServerValue.TIMESTAMP,
                updatedAt: firebase.database.ServerValue.TIMESTAMP
            })
            .then(() => {
                resetUIAfterRide();
                showNotification('Ride cancelled');
            })
            .catch(error => {
                console.error('Error cancelling ride:', error);
                showNotification('Error cancelling ride. Please try again.');
            });
        }
    }
}

// Contact driver
function contactDriver() {
    if (currentRide && currentRide.driverId) {
        database.ref('users/' + currentRide.driverId).once('value')
            .then(snapshot => {
                const driver = snapshot.val();
                if (driver && driver.phone) {
                    window.open(`tel:${driver.phone}`, '_self');
                } else {
                    showNotification('Driver phone number not available.');
                }
            });
    }
}

// Apply promo code
function applyPromoCode() {
    const promoCode = document.getElementById('promoCode').value.trim();
    const promoMessage = document.getElementById('promoMessage');
    
    if (!promoCode) {
        showNotification('Please enter a promo code.');
        return;
    }
    
    // Check if it's a referral code
    if (promoCode.startsWith('JUBEL-')) {
        database.ref('users').orderByChild('referralCode').equalTo(promoCode).once('value')
            .then(snapshot => {
                if (snapshot.exists()) {
                    appliedPromoCode = promoCode;
                    promoMessage.innerHTML = '<span style="color: var(--success-green);">âœ“ 50% discount applied for new user!</span>';
                    promoMessage.style.display = 'block';
                    
                    // Update fare estimate
                    updateFareEstimate();
                    
                    showNotification('Referral code applied! 50% discount will be applied to your ride.');
                } else {
                    promoMessage.innerHTML = '<span style="color: var(--error-red);">Invalid referral code.</span>';
                    promoMessage.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error checking referral code:', error);
                promoMessage.innerHTML = '<span style="color: var(--error-red);">Error checking code.</span>';
                promoMessage.style.display = 'block';
            });
    } else {
        // Regular promo code check (simplified for this example)
        if (promoCode === 'JUBEL20' || promoCode === 'WELCOME20') {
            appliedPromoCode = promoCode;
            promoMessage.innerHTML = '<span style="color: var(--success-green);">âœ“ 20% discount applied!</span>';
            promoMessage.style.display = 'block';
            
            updateFareEstimate();
            showNotification('Promo code applied! 20% discount will be applied to your ride.');
        } else {
            promoMessage.innerHTML = '<span style="color: var(--error-red);">Invalid promo code.</span>';
            promoMessage.style.display = 'block';
        }
    }
}

// Reset UI after ride
function resetUIAfterRide() {
    document.getElementById('rideRequestForm').style.display = 'flex';
    document.getElementById('rideInfoPanel').style.display = 'none';
    document.getElementById('destinationLocation').value = '';
    
    document.getElementById('packageForm').classList.remove('active');
    document.getElementById('receiverName').value = '';
    document.getElementById('receiverPhone').value = '';
    document.getElementById('packageDescription').value = '';
    document.getElementById('packageWeight').value = '';
    document.getElementById('packageValue').value = '';
    document.getElementById('specialInstructions').value = '';
    
    document.getElementById('promoCode').value = '';
    appliedPromoCode = null;
    document.getElementById('promoMessage').style.display = 'none';
    document.getElementById('promoSection').classList.remove('active');
    
    // Reset ride type selector
    document.getElementById('rideTypeSelector').classList.remove('active');
    document.querySelectorAll('.ride-type-option').forEach(opt => {
        opt.classList.remove('selected');
    });
    document.querySelector('.ride-type-option.standard').classList.add('selected');
    selectedRideType = 'standard';
    
    // Reset vehicle selection
    document.querySelectorAll('.vehicle-option').forEach(opt => {
        opt.classList.remove('selected');
    });
    document.querySelector('.vehicle-option[data-type="car"]').classList.add('selected');
    selectedVehicleType = 'car';
    
    // Reset emergency forms if active
    document.getElementById('emergencyQuestionnaire').classList.remove('active');
    document.getElementById('emergencyVehicleSelection').classList.remove('active');
    document.getElementById('requestRideBtn').classList.remove('emergency');
    document.getElementById('requestRideBtn').textContent = 'Request Ride';
    
    if (driverMarker) {
        vectorLayer.getSource().removeFeature(driverMarker);
        driverMarker = null;
    }
    
    if (destinationMarker) {
        vectorLayer.getSource().removeFeature(destinationMarker);
        destinationMarker = null;
    }
    
    routeLayer.getSource().clear();
    
    if (driverLocationListener) {
        driverLocationListener();
        driverLocationListener = null;
    }
    
    currentRide = null;
}

// Load ride history
function loadRideHistory() {
    if (!currentUser) return;
    
    const filter = document.getElementById('historyFilter').value;
    const dateFilter = document.getElementById('historyDate').value;
    
    if (rideHistoryListener) {
        rideHistoryListener();
    }
    
    rideHistoryListener = database.ref('rides').orderByChild('passengerId').equalTo(currentUser.uid).on('value', snapshot => {
        const historyList = document.getElementById('historyList');
        historyList.innerHTML = '';
        
        const rides = snapshot.val();
        if (rides) {
            let ridesArray = Object.keys(rides).map(rideId => ({
                id: rideId,
                ...rides[rideId]
            }));
            
            // Apply filters
            if (filter !== 'all') {
                if (['standard', 'premium', 'economy', 'emergency', 'delivery'].includes(filter)) {
                    ridesArray = ridesArray.filter(ride => ride.rideType === filter);
                } else {
                    ridesArray = ridesArray.filter(ride => ride.status === filter);
                }
            }
            
            if (dateFilter) {
                const filterDate = new Date(dateFilter);
                ridesArray = ridesArray.filter(ride => {
                    const rideDate = new Date(ride.timestamp);
                    return rideDate.toDateString() === filterDate.toDateString();
                });
            }
            
            ridesArray.sort((a, b) => b.timestamp - a.timestamp);
            
            if (ridesArray.length === 0) {
                historyList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--medium-gray);">No rides found matching your criteria.</p>';
                return;
            }
            
            ridesArray.forEach(ride => {
                const historyItem = createHistoryItem(ride);
                historyList.appendChild(historyItem);
            });
        } else {
            historyList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--medium-gray);">No ride history found.</p>';
        }
    });
}

// Create history item
function createHistoryItem(ride) {
    const historyItem = document.createElement('div');
    historyItem.className = 'history-item';
    historyItem.setAttribute('data-ride-id', ride.id);
    
    const date = new Date(ride.timestamp);
    const formattedDate = date.toLocaleDateString();
    const formattedTime = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    const typeClass = ride.rideType || 'ride';
    const typeText = getRideTypeText(ride.rideType);
    
    let statusClass = 'status-requested';
    let statusText = getStatusText(ride.status);
    
    if (ride.status === 'accepted') {
        statusClass = 'status-accepted';
    } else if (ride.status === 'completed' || ride.status === 'paid') {
        statusClass = 'status-completed';
    } else if (ride.status === 'cancelled') {
        statusClass = 'status-cancelled';
    }
    
    if (ride.isEmergency) {
        statusClass = 'status-emergency';
        statusText = 'EMERGENCY';
    }
    
    let historyContent = `
        <div class="history-item-type ${typeClass}">${typeText}</div>
        <div class="history-locations">
            <div>
                <strong>From:</strong> ${ride.pickupLocation || 'N/A'}
            </div>
            <div>
                <strong>To:</strong> ${ride.destination || 'N/A'}
            </div>
        </div>
        <div class="history-info">
            <div class="history-fare">K${ride.fare ? ride.fare.toFixed(2) : '0.00'}</div>
            <div>${formattedDate} ${formattedTime}</div>
            <div class="status-badge ${statusClass}">
                ${statusText}
            </div>
        </div>
    `;
    
    historyItem.innerHTML = historyContent;
    
    // Add click event to show details
    historyItem.addEventListener('click', function() {
        showRideDetailsPopup(ride.id);
    });
    
    return historyItem;
}

// Get ride type text
function getRideTypeText(rideType) {
    const types = {
        'standard': 'Standard Ride',
        'premium': 'Premium Ride',
        'economy': 'Economy Ride',
        'emergency': 'Emergency Ride',
        'delivery': 'Delivery'
    };
    return types[rideType] || 'Ride';
}

// Show ride details popup
function showRideDetailsPopup(rideId) {
    database.ref('rides/' + rideId).once('value')
        .then(snapshot => {
            const ride = snapshot.val();
            if (ride) {
                // Update popup content
                document.getElementById('popupRidePickup').textContent = ride.pickupLocation || 'N/A';
                document.getElementById('popupRideDestination').textContent = ride.destination || 'N/A';
                document.getElementById('popupRideFare').textContent = `K${ride.fare ? ride.fare.toFixed(2) : '0.00'}`;
                document.getElementById('popupRideDistance').textContent = ride.distance || 'Calculating...';
                document.getElementById('popupRideStatus').textContent = getStatusText(ride.status);
                document.getElementById('popupRideType').textContent = getRideTypeText(ride.rideType);
                
                const date = new Date(ride.timestamp);
                document.getElementById('popupRideDate').textContent = date.toLocaleString();
                
                // Show driver details if available
                if (ride.driverId) {
                    database.ref('users/' + ride.driverId).once('value')
                        .then(driverSnapshot => {
                            const driver = driverSnapshot.val();
                            if (driver) {
                                document.getElementById('popupDriverName').textContent = driver.name || 'Driver';
                                document.getElementById('popupDriverPhone').textContent = driver.phone || 'N/A';
                                document.getElementById('popupDriverVehicle').textContent = `${driver.vehicleType || 'Car'} (${driver.licensePlate || 'N/A'})`;
                                document.getElementById('popupDriverRating').textContent = driver.rating || '4.5';
                                document.getElementById('popupDriverDetails').classList.remove('hidden');
                            }
                        });
                } else {
                    document.getElementById('popupDriverDetails').classList.add('hidden');
                }
                
                // Show package details if available
                if (ride.packageDetails) {
                    document.getElementById('popupPackageReceiver').textContent = ride.packageDetails.receiverName || 'N/A';
                    document.getElementById('popupPackageDescription').textContent = ride.packageDetails.packageDescription || 'N/A';
                    document.getElementById('popupPackageWeight').textContent = ride.packageDetails.packageWeight || 'N/A';
                    document.getElementById('popupPackageValue').textContent = ride.packageDetails.packageValue ? `K${ride.packageDetails.packageValue}` : 'N/A';
                    document.getElementById('popupPackageDetails').classList.remove('hidden');
                } else {
                    document.getElementById('popupPackageDetails').classList.add('hidden');
                }
                
                // Show emergency details if available
                if (ride.isEmergency) {
                    document.getElementById('popupEmergencyType').textContent = ride.emergencyType || 'Emergency';
                    document.getElementById('popupEmergencySeverity').textContent = ride.emergencySeverity || 'Unknown';
                    document.getElementById('popupEmergencyDescription').textContent = ride.emergencyDescription || 'N/A';
                    document.getElementById('popupEmergencyDetails').classList.remove('hidden');
                } else {
                    document.getElementById('popupEmergencyDetails').classList.add('hidden');
                }
                
                // Show the popup
                document.getElementById('rideDetailsPopup').classList.remove('hidden');
            }
        })
        .catch(error => {
            console.error('Error loading ride details:', error);
            showNotification('Error loading ride details.');
        });
}

// Generate and download receipt
function generateReceipt() {
    const rideId = document.querySelector('#rideDetailsPopup').getAttribute('data-ride-id');
    if (!rideId) return;
    
    database.ref('rides/' + rideId).once('value')
        .then(snapshot => {
            const ride = snapshot.val();
            if (!ride) return;
            
            // Create receipt content
            const receiptContent = `
                <div id="receiptContent" style="padding: 20px; font-family: Arial, sans-serif;">
                    <h2 style="text-align: center; color: #FF6B35;">JUBEL RIDE RECEIPT</h2>
                    <hr style="border: 1px solid #FF6B35; margin: 10px 0;">
                    
                    <div style="margin-bottom: 15px;">
                        <h3>Ride Details</h3>
                        <p><strong>Ride ID:</strong> ${ride.id}</p>
                        <p><strong>Date:</strong> ${new Date(ride.timestamp).toLocaleString()}</p>
                        <p><strong>Type:</strong> ${getRideTypeText(ride.rideType)}</p>
                        <p><strong>Status:</strong> ${getStatusText(ride.status)}</p>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <h3>Route</h3>
                        <p><strong>From:</strong> ${ride.pickupLocation || 'N/A'}</p>
                        <p><strong>To:</strong> ${ride.destination || 'N/A'}</p>
                        <p><strong>Distance:</strong> ${ride.distance || 'N/A'}</p>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <h3>Fare Breakdown</h3>
                        <p><strong>Base Fare:</strong> K${ride.fare ? (ride.fare * 0.7).toFixed(2) : '0.00'}</p>
                        <p><strong>Distance Charge:</strong> K${ride.fare ? (ride.fare * 0.3).toFixed(2) : '0.00'}</p>
                        ${ride.promoCode ? `<p><strong>Discount (${ride.promoCode}):</strong> -K${(ride.fare * 0.2).toFixed(2)}</p>` : ''}
                        <hr style="border: 1px dashed #ccc; margin: 10px 0;">
                        <p><strong>Total Fare:</strong> K${ride.fare ? ride.fare.toFixed(2) : '0.00'}</p>
                    </div>
                    
                    ${ride.driverId ? `
                    <div style="margin-bottom: 15px;">
                        <h3>Driver Information</h3>
                        <p><strong>Driver:</strong> ${ride.driverName || 'N/A'}</p>
                        <p><strong>Vehicle:</strong> ${ride.driverVehicle || 'N/A'}</p>
                    </div>
                    ` : ''}
                    
                    <div style="margin-top: 20px; text-align: center; font-size: 0.8em; color: #777;">
                        <p>Thank you for choosing Jubel!</p>
                        <p>For support, contact: 0768658484</p>
                    </div>
                </div>
            `;
            
            // Create temporary div for receipt
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = receiptContent;
            document.body.appendChild(tempDiv);
            
            // Use html2canvas to capture receipt
            html2canvas(tempDiv.querySelector('#receiptContent')).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                
                // Create PDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF();
                const imgProps = pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save(`Jubel-Receipt-${ride.id}.pdf`);
                
                // Clean up
                document.body.removeChild(tempDiv);
                showNotification('Receipt downloaded successfully!');
            });
        })
        .catch(error => {
            console.error('Error generating receipt:', error);
            showNotification('Error generating receipt. Please try again.');
        });
}

// Check for active ride
function checkActiveRide(uid) {
    database.ref('rides').orderByChild('passengerId').equalTo(uid).once('value')
        .then(snapshot => {
            const rides = snapshot.val();
            if (rides) {
                const rideEntries = Object.entries(rides);
                
                for (const [rideId, ride] of rideEntries) {
                    // Check for active rides
                    if (ride.status !== 'completed' && ride.status !== 'cancelled') {
                        restoreActiveRide(rideId, ride);
                        return;
                    }
                }
            }
        })
        .catch(error => {
            console.error('Error checking active ride:', error);
        });
}

// Restore active ride
function restoreActiveRide(rideId, ride) {
    currentRide = {
        id: rideId,
        ...ride
    };
    
    updateUIForActiveRide();
    
    if (ride.status === 'requested') {
        document.getElementById('searchingAnimation').style.display = 'flex';
        document.getElementById('rideStatus').style.display = 'flex';
        document.getElementById('statusDot').className = 'status-dot searching';
        document.getElementById('statusText').textContent = 'Searching for driver';
        
        listenForDriverAssignment(rideId);
    } 
    else if (ride.driverId) {
        handleDriverAssignment(ride);
        
        if (ride.driverId) {
            trackDriverLocation(ride.driverId);
        }
        
        document.getElementById('sosButton').style.display = 'flex';
    }
    
    showNotification('Active ride restored');
}

// Load SOS configuration
function loadSOSConfig(uid) {
    database.ref('sosConfig/' + uid).once('value')
        .then(snapshot => {
            const sosConfig = snapshot.val();
            if (sosConfig) {
                // Store SOS config for later use
                window.sosConfig = sosConfig;
            }
        })
        .catch(error => {
            console.error('Error loading SOS config:', error);
        });
}

// Start location tracking
function startLocationTracking() {
    if (navigator.geolocation && currentUser) {
        navigator.geolocation.watchPosition(position => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            userLocation = { lat, lng };
            
            // Update database with passenger location
            database.ref('passengerLocations/' + currentUser.uid).set({
                latitude: lat,
                longitude: lng,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            
            // Update current location marker
            if (currentLocationMarker) {
                currentLocationMarker.getGeometry().setCoordinates(ol.proj.fromLonLat([lng, lat]));
            }
            
            // Update fare estimate if destination is set
            const destination = document.getElementById('destinationLocation').value;
            if (destination) {
                updateFareEstimate();
            }
        }, error => {
            console.error('Location tracking error:', error);
        }, {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 30000
        });
    }
}

// Show notification
function showNotification(message, type = 'normal') {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.className = 'notification';
    
    if (type === 'emergency') {
        notification.classList.add('emergency');
    }
    
    notification.style.display = 'block';
    
    setTimeout(() => {
        notification.style.display = 'none';
    }, 4000);
}

// Switch screen
function switchScreen(screenId) {
    currentScreen = screenId;
    
    document.querySelectorAll('.screen-content').forEach(screen => {
        screen.classList.remove('active');
    });
    
    document.getElementById(screenId + 'Screen').classList.add('active');
    
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`.nav-btn[data-screen="${screenId}"]`).classList.add('active');
    
    if (screenId === 'home') {
        document.querySelectorAll('.home-only').forEach(el => {
            el.style.display = 'flex';
        });
    } else {
        document.querySelectorAll('.home-only').forEach(el => {
            el.style.display = 'none';
        });
    }
    
    if (screenId === 'history') {
        loadRideHistory();
    } else if (screenId === 'account') {
        loadAccountData();
    } else if (screenId === 'emergency') {
        loadEmergencyHistory();
    }
}

// Load account data
function loadAccountData() {
    if (currentUser && userData) {
        document.getElementById('accountName').textContent = userData.name || 'Passenger';
        document.getElementById('accountPhone').textContent = userData.phone || 'Not set';
        document.getElementById('accountEmail').textContent = userData.email || 'Not set';
        document.getElementById('referralCode').textContent = userData.referralCode || 'JUBEL-XXXX';
        
        walletBalance = userData.walletBalance || 0;
        document.getElementById('accountBalance').textContent = `K${walletBalance.toFixed(2)}`;
        
        const accountAvatar = document.getElementById('accountAvatar');
        if (userData.name) {
            accountAvatar.textContent = userData.name.charAt(0).toUpperCase();
        } else {
            accountAvatar.innerHTML = '<i class="fas fa-user"></i>';
        }
        
        updateUserStats();
    }
}

// Update user stats
function updateUserStats() {
    if (!currentUser) return;
    
    database.ref('rides').orderByChild('passengerId').equalTo(currentUser.uid).once('value')
        .then(snapshot => {
            const rides = snapshot.val();
            if (rides) {
                const ridesArray = Object.values(rides);
                
                const stats = {
                    completed: ridesArray.filter(ride => ride.status === 'completed' || ride.status === 'paid').length,
                    cancelled: ridesArray.filter(ride => ride.status === 'cancelled').length,
                    pending: ridesArray.filter(ride => ride.status === 'requested' || ride.status === 'accepted').length
                };
                
                document.getElementById('ridesCompleted').textContent = stats.completed;
                document.getElementById('ridesCancelled').textContent = stats.cancelled;
                document.getElementById('ridesPending').textContent = stats.pending;
            }
        });
}

// Load emergency history
function loadEmergencyHistory() {
    if (!currentUser) return;
    
    database.ref('rides').orderByChild('passengerId').equalTo(currentUser.uid).once('value')
        .then(snapshot => {
            const emergencyList = document.getElementById('emergencyHistoryList');
            emergencyList.innerHTML = '';
            
            const rides = snapshot.val();
            if (rides) {
                let emergencyRides = Object.values(rides).filter(ride => ride.isEmergency);
                
                if (emergencyRides.length === 0) {
                    emergencyList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--medium-gray);">No emergency history found.</p>';
                    return;
                }
                
                emergencyRides.sort((a, b) => b.timestamp - a.timestamp);
                
                emergencyRides.forEach(ride => {
                    const historyItem = createEmergencyHistoryItem(ride);
                    emergencyList.appendChild(historyItem);
                });
            } else {
                emergencyList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--medium-gray);">No emergency history found.</p>';
            }
        });
}

// Create emergency history item
function createEmergencyHistoryItem(ride) {
    const historyItem = document.createElement('div');
    historyItem.className = 'history-item emergency-history-item';
    historyItem.setAttribute('data-ride-id', ride.id);
    
    const date = new Date(ride.timestamp);
    const formattedDate = date.toLocaleDateString();
    const formattedTime = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    historyItem.innerHTML = `
        <div class="history-item-type emergency">EMERGENCY</div>
        <div class="history-locations">
            <div>
                <strong>Type:</strong> ${ride.emergencyType || 'Emergency'}
            </div>
            <div>
                <strong>Vehicle:</strong> ${ride.vehicleType || 'Emergency Vehicle'}
            </div>
        </div>
        <div class="history-info">
            <div class="history-fare">K${ride.fare ? ride.fare.toFixed(2) : '0.00'}</div>
            <div>${formattedDate} ${formattedTime}</div>
            <div class="status-badge status-emergency">
                ${getStatusText(ride.status)}
            </div>
        </div>
    `;
    
    historyItem.addEventListener('click', function() {
        showRideDetailsPopup(ride.id);
    });
    
    return historyItem;
}

// Get status text
function getStatusText(status) {
    const statusMap = {
        'requested': 'Awaiting Driver',
        'accepted': 'In Progress',
        'completed': 'Completed',
        'cancelled': 'Cancelled',
        'arrived': 'Driver Arrived',
        'picked_up': 'Picked Up',
        'started': 'Trip Started'
    };
    
    return statusMap[status] || status;
}

// Close payment selection
function closePaymentSelection() {
    document.getElementById('paymentSelectionPopup').classList.add('hidden');
}

// Close rating popup
function closeRatingPopup() {
    document.getElementById('ratingPopup').classList.add('hidden');
    document.getElementById('ratingComment').value = '';
}

// Close ride details popup
function closeRideDetailsPopup() {
    document.getElementById('rideDetailsPopup').classList.add('hidden');
}

// Reset rating stars
function resetRatingStars() {
    const stars = document.querySelectorAll('#ratingStars .star');
    const ratingText = document.getElementById('ratingText');
    
    stars.forEach(star => {
        star.innerHTML = '<i class="far fa-star"></i>';
        star.style.color = '#CCCCCC';
    });
    
    ratingText.textContent = 'Tap to rate';
    ratingText.style.color = 'var(--medium-gray)';
}

// Setup event listeners
function setupEventListeners() {
    // Navigation buttons
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const screen = this.getAttribute('data-screen');
            switchScreen(screen);
        });
    });
    
    // Back buttons
    document.querySelectorAll('.back-button').forEach(btn => {
        btn.addEventListener('click', function() {
            const screen = this.getAttribute('data-screen');
            switchScreen(screen);
        });
    });
    
    // Ride type selection
    document.getElementById('selectRideTypeBtn').addEventListener('click', function() {
        document.getElementById('rideTypeSelector').classList.toggle('active');
    });
    
    document.querySelectorAll('.ride-type-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.ride-type-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            this.classList.add('selected');
            selectedRideType = this.getAttribute('data-ride-type');
            
            // Update fare estimate
            updateFareEstimate();
            
            // Hide/show vehicle selection based on ride type
            if (selectedRideType === 'emergency') {
                document.getElementById('standardVehicleSelection').style.display = 'none';
            } else {
                document.getElementById('standardVehicleSelection').style.display = 'flex';
            }
        });
    });
    
    // Emergency vehicle selection
    document.querySelectorAll('.emergency-vehicle-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.emergency-vehicle-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            this.classList.add('selected');
            selectedEmergencyType = this.getAttribute('data-vehicle-type');
        });
    });
    
    // Vehicle selection
    document.querySelectorAll('.vehicle-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.vehicle-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            this.classList.add('selected');
            selectedVehicleType = this.getAttribute('data-type');
            
            // Show/hide package form for truck deliveries
            if (selectedVehicleType === 'truck') {
                document.getElementById('packageToggle').style.display = 'flex';
            } else {
                document.getElementById('packageToggle').style.display = 'none';
                document.getElementById('packageForm').classList.remove('active');
            }
            
            updateFareEstimate();
        });
    });
    
    // Package toggle
    document.getElementById('packageToggle').addEventListener('click', function() {
        document.getElementById('packageForm').classList.toggle('active');
    });
    
    // Promo toggle
    document.getElementById('promoToggle').addEventListener('click', function() {
        document.getElementById('promoSection').classList.toggle('active');
    });
    
    // Apply promo code
    document.getElementById('applyPromoBtn').addEventListener('click', applyPromoCode);
    
    // Request ride button
    document.getElementById('requestRideBtn').addEventListener('click', function() {
        if (selectedRideType === 'emergency') {
            submitEmergencyRequest();
        } else {
            requestRide();
        }
    });
    
    // Payment selection
    document.querySelectorAll('.payment-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.payment-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            this.classList.add('selected');
            selectedPaymentType = this.getAttribute('data-payment-type');
            
            if (selectedPaymentType === 'wallet') {
                if (walletBalance < rideFare) {
                    document.getElementById('insufficientBalance').style.display = 'block';
                    document.getElementById('confirmPaymentBtn').disabled = true;
                } else {
                    document.getElementById('insufficientBalance').style.display = 'none';
                    document.getElementById('confirmPaymentBtn').disabled = false;
                }
            } else {
                document.getElementById('insufficientBalance').style.display = 'none';
                document.getElementById('confirmPaymentBtn').disabled = false;
            }
        });
    });
    
    // Confirm payment
    document.getElementById('confirmPaymentBtn').addEventListener('click', submitRideRequestAfterPayment);
    
    // Close payment popup
    document.getElementById('closePaymentPopup').addEventListener('click', closePaymentSelection);
    
    // Cancel ride
    document.getElementById('cancelRideBtn').addEventListener('click', cancelRide);
    
    // Contact driver
    document.getElementById('contactDriverBtn').addEventListener('click', contactDriver);
    
    // Destination search
    document.getElementById('destinationLocation').addEventListener('input', function() {
        searchPlaces(this.value, 'destination');
    });
    
    document.getElementById('destinationLocation').addEventListener('focus', function() {
        if (this.value.length >= 2) {
            searchPlaces(this.value, 'destination');
        }
    });
    
    // Click outside to hide suggestions
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.location-input') && !e.target.closest('.suggestion-list')) {
            hideSearchSuggestions('destination');
        }
    });
    
    // Panel collapse handle
    document.getElementById('panelCollapseHandle').addEventListener('click', function() {
        document.getElementById('passengerPanel').classList.toggle('collapsed');
    });
    
    // SOS button
    document.getElementById('sosButton').addEventListener('click', function() {
        if (window.sosConfig) {
            // Trigger SOS alert
            const sosAlert = {
                passengerId: currentUser.uid,
                passengerName: userData.name || 'Passenger',
                passengerPhone: userData.phone || 'Not provided',
                emergencyContact1: window.sosConfig.contact1,
                emergencyContact2: window.sosConfig.contact2,
                message: window.sosConfig.message || 'I need help!',
                rideDetails: currentRide,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                location: userLocation
            };
            
            database.ref('sosAlerts').push().set(sosAlert)
                .then(() => {
                    showNotification('SOS alert sent to emergency contacts!', 'emergency');
                })
                .catch(error => {
                    console.error('Error sending SOS alert:', error);
                    showNotification('Error sending SOS alert. Please call emergency services directly.', 'emergency');
                });
        } else {
            showNotification('SOS not configured. Please set up emergency contacts in settings.', 'emergency');
        }
    });
    
    // Emergency quick actions
    document.querySelectorAll('.emergency-quick-action').forEach(action => {
        action.addEventListener('click', function() {
            const emergencyType = this.getAttribute('data-emergency-type');
            selectedEmergencyType = emergencyType;
            selectedRideType = 'emergency';
            
            // Switch to home screen and show emergency form
            switchScreen('home');
            setTimeout(() => {
                showEmergencyQuestionnaire();
                
                // Pre-select emergency type in questionnaire
                document.getElementById('emergencyType').value = emergencyType;
                
                // Pre-select vehicle type
                document.querySelectorAll('.emergency-vehicle-option').forEach(opt => {
                    opt.classList.remove('selected');
                    if (opt.getAttribute('data-vehicle-type') === emergencyType) {
                        opt.classList.add('selected');
                    }
                });
            }, 100);
        });
    });
    
    // Close emergency popup
    document.getElementById('closeEmergencyPopup')?.addEventListener('click', function() {
        document.getElementById('emergencyAlertPopup').classList.add('hidden');
    });
    
    document.getElementById('confirmEmergencyBtn')?.addEventListener('click', function() {
        document.getElementById('emergencyAlertPopup').classList.add('hidden');
    });
    
    // Close ride details popup
    document.getElementById('closeRidePopup').addEventListener('click', closeRideDetailsPopup);
    document.getElementById('closeRidePopupTop').addEventListener('click', closeRideDetailsPopup);
    
    // Generate receipt
    document.getElementById('generateReceiptBtn').addEventListener('click', generateReceipt);
    
    // Account actions
    document.getElementById('shareReferralBtn').addEventListener('click', function() {
        const referralCode = document.getElementById('referralCode').textContent;
        const shareText = `Join me on Jubel! Use my referral code ${referralCode} for 50% off your first ride. Download the app now!`;
        
        if (navigator.share) {
            navigator.share({
                title: 'Jubel Referral',
                text: shareText,
                url: window.location.href
            });
        } else {
            navigator.clipboard.writeText(shareText)
                .then(() => showNotification('Referral code copied to clipboard!'));
        }
    });
    
    document.getElementById('depositBtn').addEventListener('click', function() {
        const amount = prompt('Enter deposit amount (K):');
        if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
            const depositAmount = parseFloat(amount);
            const newBalance = walletBalance + depositAmount;
            
            database.ref('users/' + currentUser.uid).update({
                walletBalance: newBalance
            })
            .then(() => {
                walletBalance = newBalance;
                updateWalletBalanceUI();
                showNotification(`Successfully deposited K${depositAmount.toFixed(2)} to your wallet.`);
            })
            .catch(error => {
                console.error('Error depositing to wallet:', error);
                showNotification('Error processing deposit. Please try again.');
            });
        }
    });
    
    document.getElementById('withdrawBtn').addEventListener('click', function() {
        if (walletBalance <= 0) {
            showNotification('Your wallet balance is zero.');
            return;
        }
        
        const amount = prompt(`Enter withdrawal amount (K). Available: K${walletBalance.toFixed(2)}:`);
        if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
            const withdrawalAmount = parseFloat(amount);
            
            if (withdrawalAmount > walletBalance) {
                showNotification('Insufficient balance for this withdrawal.');
                return;
            }
            
            const newBalance = walletBalance - withdrawalAmount;
            
            database.ref('users/' + currentUser.uid).update({
                walletBalance: newBalance
            })
            .then(() => {
                walletBalance = newBalance;
                updateWalletBalanceUI();
                showNotification(`Successfully withdrew K${withdrawalAmount.toFixed(2)} from your wallet.`);
            })
            .catch(error => {
                console.error('Error withdrawing from wallet:', error);
                showNotification('Error processing withdrawal. Please try again.');
            });
        }
    });
    
    document.getElementById('whatsappBtn').addEventListener('click', function() {
        const phoneNumber = '0768658484';
        const message = 'Hello, I need assistance with Jubel rides.';
        const url = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
        window.open(url, '_blank');
    });
    
    document.getElementById('callBtn').addEventListener('click', function() {
        const phoneNumber = '0768658484';
        window.open(`tel:${phoneNumber}`, '_self');
    });
    
    // More options
    document.querySelectorAll('.option-item').forEach(item => {
        item.addEventListener('click', function() {
            const option = this.getAttribute('data-option');
            
            switch(option) {
                case 'sos':
                    showNotification('SOS setup feature coming soon!');
                    break;
                case 'scheduled':
                    showNotification('Scheduled rides feature coming soon!');
                    break;
                case 'favorites':
                    showNotification('Favorite locations feature coming soon!');
                    break;
                case 'settings':
                    showNotification('Settings feature coming soon!');
                    break;
                case 'help':
                    showNotification('Help & support feature coming soon!');
                    break;
                case 'logout':
                    if (confirm('Are you sure you want to logout?')) {
                        auth.signOut().then(() => {
                            window.location.href = 'signup.html';
                        });
                    }
                    break;
            }
        });
    });
    
    // History filter changes
    document.getElementById('historyFilter').addEventListener('change', loadRideHistory);
    document.getElementById('historyDate').addEventListener('change', loadRideHistory);
}

// Initialize the app
console.log("Jubel Passenger App Initialized with OpenLayers");
showNotification('Jubel Passenger App Ready');
    </script>
</body>
</html>
