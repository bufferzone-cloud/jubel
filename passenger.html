<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jubel - Passenger</title>
    <!-- OpenLayers CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.3.0/ol.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* All existing CSS styles remain unchanged */
        :root {
            --primary-orange: #FF6B35;
            --primary-red: #E74C3C;
            --primary-gradient: linear-gradient(135deg, #FF6B35, #E74C3C);
            --secondary-orange: #E55A28;
            --secondary-red: #C0392B;
            --light-orange: #FFE8E0;
            --light-red: #FADBD8;
            --white: #FFFFFF;
            --light-gray: #F5F5F5;
            --dark-gray: #333333;
            --medium-gray: #777777;
            --success-green: #2ecc71;
            --warning-yellow: #f39c12;
            --info-blue: #3498db;
            --error-red: #e74c3c;
            --border-color: #E8E8E8;
            --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 4px 15px rgba(0, 0, 0, 0.15);
            --shadow-heavy: 0 6px 20px rgba(0, 0, 0, 0.2);
            --app-padding: 10px;
            --element-radius: 6px;
            --transition-speed: 0.3s;
            --premium-gold: #FFD700;
            --economy-green: #27ae60;
            --emergency-red: #e74c3c;
            --ambulance-red: #c0392b;
            --fire-truck-red: #e74c3c;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--white);
            color: var(--dark-gray);
            max-width: 100%;
            overflow-x: hidden;
            height: 100vh;
            font-size: 13px;
        }
        
        /* Main App */
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        /* OpenLayers map container */
        .ol-viewport {
            cursor: grab;
        }
        
        .ol-viewport:active {
            cursor: grabbing;
        }
        
        .floating-balance {
            position: fixed;
            top: 10px;
            right: 10px;
            background: var(--white);
            padding: 6px 10px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 700;
            color: var(--dark-gray);
            border: 2px solid var(--primary-orange);
            font-size: 0.75rem;
        }
        
        .balance-amount {
            color: var(--primary-orange);
            font-size: 0.8rem;
        }
        
        .passenger-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            border-radius: 15px 15px 0 0;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
            z-index: 100;
            padding: var(--app-padding);
            transform: translateY(0);
            transition: transform var(--transition-speed) ease;
            max-height: 45vh;
            overflow-y: auto;
        }
        
        .passenger-panel.collapsed {
            transform: translateY(calc(100% - 40px));
        }
        
        .panel-collapse-handle {
            width: 35px;
            height: 3px;
            background: var(--border-color);
            border-radius: 2px;
            margin: 0 auto 8px;
            cursor: pointer;
        }
        
        .nav-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            padding: 6px 3px;
            border-radius: var(--element-radius);
            background: var(--light-gray);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            border: none;
            font-size: 0.6rem;
            font-weight: 600;
        }
        
        .nav-btn.active {
            background: var(--primary-gradient);
            color: var(--white);
        }
        
        .nav-btn i {
            font-size: 0.8rem;
        }
        
        /* Ride Type Selection */
        .ride-type-selection {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            margin: 10px 0;
        }
        
        .ride-type-header {
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--dark-gray);
            margin-bottom: 5px;
        }
        
        .ride-type-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
        }
        
        .ride-type-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 4px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            background: var(--white);
        }
        
        .ride-type-option.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .ride-type-option.premium {
            border-color: var(--premium-gold);
        }
        
        .ride-type-option.premium.selected {
            background: linear-gradient(135deg, #FFF9E6, #FFE680);
        }
        
        .ride-type-option.economy {
            border-color: var(--economy-green);
        }
        
        .ride-type-option.economy.selected {
            background: linear-gradient(135deg, #E6F7E9, #80FFA3);
        }
        
        .ride-type-option.emergency {
            border-color: var(--emergency-red);
        }
        
        .ride-type-option.emergency.selected {
            background: linear-gradient(135deg, #FFEBEE, #FF8080);
        }
        
        .ride-type-option.ambulance {
            border-color: var(--ambulance-red);
        }
        
        .ride-type-option.ambulance.selected {
            background: linear-gradient(135deg, #FFE6E6, #FF8080);
        }
        
        .ride-type-option.fire-truck {
            border-color: var(--fire-truck-red);
        }
        
        .ride-type-option.fire-truck.selected {
            background: linear-gradient(135deg, #FFE6E6, #FF8080);
        }
        
        .ride-type-option.light-truck {
            border-color: var(--medium-gray);
        }
        
        .ride-type-option.light-truck.selected {
            background: linear-gradient(135deg, #F5F5F5, #CCCCCC);
        }
        
        .ride-type-icon {
            font-size: 1.2rem;
            color: var(--medium-gray);
        }
        
        .ride-type-option.selected .ride-type-icon {
            color: var(--primary-orange);
        }
        
        .ride-type-option.premium.selected .ride-type-icon {
            color: var(--premium-gold);
        }
        
        .ride-type-option.economy.selected .ride-type-icon {
            color: var(--economy-green);
        }
        
        .ride-type-option.emergency.selected .ride-type-icon,
        .ride-type-option.ambulance.selected .ride-type-icon,
        .ride-type-option.fire-truck.selected .ride-type-icon {
            color: var(--emergency-red);
        }
        
        .ride-type-name {
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .ride-type-price {
            font-size: 0.65rem;
            color: var(--medium-gray);
        }
        
        .ride-type-premium-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--premium-gold);
            color: var(--white);
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            font-weight: 700;
            box-shadow: var(--shadow-light);
        }
        
        /* Emergency Ride Questionnaire */
        .emergency-questionnaire {
            display: none;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
            padding: 15px;
            border: 2px solid var(--emergency-red);
            border-radius: var(--element-radius);
            background: linear-gradient(135deg, #FFEBEE, #FFCDD2);
        }
        
        .emergency-questionnaire.active {
            display: flex;
        }
        
        .emergency-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .emergency-header i {
            color: var(--emergency-red);
            font-size: 1.2rem;
        }
        
        .emergency-header h3 {
            color: var(--emergency-red);
            font-size: 0.9rem;
            font-weight: 700;
        }
        
        .emergency-question {
            margin-bottom: 8px;
        }
        
        .emergency-question label {
            display: block;
            margin-bottom: 4px;
            font-weight: 600;
            color: var(--dark-gray);
            font-size: 0.75rem;
        }
        
        .emergency-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }
        
        .emergency-option {
            padding: 8px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--white);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            text-align: center;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .emergency-option.selected {
            border-color: var(--emergency-red);
            background: var(--light-red);
            color: var(--emergency-red);
        }
        
        .emergency-input {
            width: 100%;
            padding: 8px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 0.75rem;
        }
        
        .emergency-input:focus {
            outline: none;
            border-color: var(--emergency-red);
        }
        
        .emergency-note {
            font-size: 0.7rem;
            color: var(--medium-gray);
            font-style: italic;
            margin-top: 5px;
        }
        
        .emergency-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        
        .btn-emergency {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: var(--element-radius);
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .btn-emergency-confirm {
            background: var(--emergency-red);
            color: var(--white);
        }
        
        .btn-emergency-cancel {
            background: var(--white);
            color: var(--emergency-red);
            border: 2px solid var(--emergency-red);
        }
        
        /* Original Schedule Ride Button */
        .schedule-ride-btn {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--primary-orange);
            color: var(--white);
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .schedule-ride-options {
            display: none;
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            margin-top: 5px;
            overflow: hidden;
            box-shadow: var(--shadow-medium);
        }
        
        .schedule-ride-options.active {
            display: block;
        }
        
        /* All other existing CSS styles remain unchanged */
        .location-input {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--white);
            position: relative;
        }
        
        .location-input i {
            color: var(--primary-orange);
        }
        
        .location-input input {
            border: none;
            outline: none;
            width: 100%;
            font-size: 0.8rem;
        }
        
        .vehicle-selection {
            display: none; /* Hidden, replaced by ride type selection */
        }
        
        .promo-section {
            margin-top: 8px;
            padding: 8px;
            border: 1px dashed var(--border-color);
            border-radius: var(--element-radius);
            display: none;
        }
        
        .promo-section.active {
            display: block;
        }
        
        .promo-input {
            display: flex;
            gap: 6px;
        }
        
        .promo-input input {
            flex: 1;
            padding: 6px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 0.75rem;
        }
        
        .btn-promo {
            background: var(--primary-orange);
            color: var(--white);
            border: none;
            border-radius: var(--element-radius);
            padding: 6px 10px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .promo-toggle {
            width: 100%;
            padding: 6px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .fare-display {
            background: var(--primary-gradient);
            color: var(--white);
            padding: 10px;
            border-radius: var(--element-radius);
            text-align: center;
            margin: 8px 0;
            box-shadow: var(--shadow-medium);
        }
        
        .fare-amount {
            font-size: 1.5rem;
            font-weight: 800;
            margin: 4px 0;
        }
        
        .eta-display {
            font-size: 0.9rem;
            font-weight: 600;
            opacity: 0.9;
        }
        
        .request-ride-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: var(--element-radius);
            background: var(--primary-gradient);
            color: var(--white);
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            margin-top: 8px;
            box-shadow: var(--shadow-medium);
        }
        
        .request-ride-btn:disabled {
            background: var(--medium-gray);
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .ride-info-panel {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 10px;
            box-shadow: var(--shadow-medium);
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            display: none;
        }
        
        /* Screen Contents */
        .screen-content {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 50px;
            background: var(--white);
            z-index: 90;
            padding: var(--app-padding);
            overflow-y: auto;
            display: none;
        }
        
        .screen-content.active {
            display: block;
        }
        
        .screen-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .back-button {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            font-size: 0.9rem;
        }
        
        .screen-title {
            font-size: 1rem;
            font-weight: 700;
        }
        
        /* Enhanced History Screen */
        .history-filters {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .history-filter-select {
            padding: 8px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 0.75rem;
            background: var(--white);
        }
        
        .history-date-input {
            padding: 8px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 0.75rem;
        }
        
        /* Enhanced History Items */
        .history-item {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            background: var(--white);
            border-radius: var(--element-radius);
            margin-bottom: 8px;
            border: 1px solid var(--border-color);
        }
        
        .history-item:hover {
            background: var(--light-orange);
            border-color: var(--primary-orange);
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .history-item-type {
            font-size: 0.65rem;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 8px;
            display: inline-block;
        }
        
        .history-item-type.ride {
            background: var(--light-orange);
            color: var(--primary-orange);
        }
        
        .history-item-type.delivery {
            background: var(--light-red);
            color: var(--primary-red);
        }
        
        .history-item-type.emergency {
            background: #FFEBEE;
            color: #c62828;
        }
        
        .history-item-type.ambulance {
            background: #FFE6E6;
            color: #b71c1c;
        }
        
        .history-item-type.fire-truck {
            background: #FFE6E6;
            color: #d32f2f;
        }
        
        .history-item-type.premium {
            background: #FFF9E6;
            color: #F57C00;
        }
        
        .history-item-type.economy {
            background: #E6F7E9;
            color: #2E7D32;
        }
        
        .history-item-date {
            font-size: 0.65rem;
            color: var(--medium-gray);
        }
        
        .history-item-locations {
            margin-bottom: 8px;
        }
        
        .history-location {
            display: flex;
            align-items: flex-start;
            gap: 6px;
            margin-bottom: 6px;
        }
        
        .history-location-icon {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            flex-shrink: 0;
            margin-top: 2px;
        }
        
        .history-location-pickup {
            background: var(--primary-orange);
            color: white;
        }
        
        .history-location-destination {
            background: var(--primary-red);
            color: white;
        }
        
        .history-location-text {
            flex: 1;
        }
        
        .history-location-name {
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .history-location-address {
            font-size: 0.65rem;
            color: var(--medium-gray);
        }
        
        .history-item-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
        }
        
        .history-item-fare {
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        .history-item-status {
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 600;
        }
        
        .history-item-status.completed {
            background: #e6f7e9;
            color: #2e7d32;
        }
        
        .history-item-status.cancelled {
            background: #ffebee;
            color: #c62828;
        }
        
        .history-item-status.in-progress {
            background: #fff3e0;
            color: #ef6c00;
        }
        
        .history-item-status.requested {
            background: #e3f2fd;
            color: #1565c0;
        }
        
        .history-item-driver {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed var(--border-color);
        }
        
        .history-driver-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: var(--white);
            font-weight: 700;
        }
        
        .history-driver-details {
            flex: 1;
        }
        
        .history-driver-name {
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .history-driver-rating {
            font-size: 0.6rem;
            color: var(--medium-gray);
            display: flex;
            align-items: center;
            gap: 2px;
        }
        
        /* Emergency Screen */
        .emergency-options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }
        
        .emergency-option-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--white);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .emergency-option-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-medium);
        }
        
        .emergency-option-card.ambulance {
            border-color: var(--ambulance-red);
        }
        
        .emergency-option-card.fire-truck {
            border-color: var(--fire-truck-red);
        }
        
        .emergency-option-card.emergency-ride {
            border-color: var(--emergency-red);
        }
        
        .emergency-option-card.emergency-delivery {
            border-color: var(--warning-yellow);
        }
        
        .emergency-option-icon {
            font-size: 2rem;
            color: var(--medium-gray);
        }
        
        .emergency-option-card.ambulance .emergency-option-icon {
            color: var(--ambulance-red);
        }
        
        .emergency-option-card.fire-truck .emergency-option-icon {
            color: var(--fire-truck-red);
        }
        
        .emergency-option-card.emergency-ride .emergency-option-icon {
            color: var(--emergency-red);
        }
        
        .emergency-option-card.emergency-delivery .emergency-option-icon {
            color: var(--warning-yellow);
        }
        
        .emergency-option-name {
            font-size: 0.8rem;
            font-weight: 700;
            text-align: center;
        }
        
        .emergency-option-description {
            font-size: 0.65rem;
            color: var(--medium-gray);
            text-align: center;
        }
        
        .emergency-instructions {
            margin-top: 15px;
            padding: 12px;
            background: linear-gradient(135deg, #FFEBEE, #FFCDD2);
            border-radius: var(--element-radius);
            border: 1px solid var(--emergency-red);
        }
        
        .emergency-instructions h4 {
            color: var(--emergency-red);
            margin-bottom: 8px;
            font-size: 0.8rem;
        }
        
        .emergency-instructions p {
            font-size: 0.7rem;
            color: var(--dark-gray);
            margin-bottom: 5px;
        }
        
        /* Enhanced Address Display */
        .address-breakdown {
            display: none;
            background: var(--light-gray);
            padding: 8px;
            border-radius: var(--element-radius);
            margin-top: 5px;
            font-size: 0.7rem;
        }
        
        .address-breakdown.active {
            display: block;
        }
        
        .address-component {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            padding-bottom: 4px;
            border-bottom: 1px dashed var(--border-color);
        }
        
        .address-component:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .address-label {
            font-weight: 600;
            color: var(--medium-gray);
        }
        
        .address-value {
            color: var(--dark-gray);
            text-align: right;
            max-width: 60%;
            word-break: break-word;
        }
        
        /* Enhanced Search Results */
        .suggestion-item {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: flex-start;
            gap: 8px;
            background: var(--white);
        }
        
        .suggestion-item:hover {
            background: var(--light-orange);
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
        
        .suggestion-icon {
            font-size: 1rem;
            width: 20px;
            text-align: center;
            color: var(--primary-orange);
            margin-top: 2px;
        }
        
        .suggestion-details {
            flex: 1;
        }
        
        .suggestion-primary {
            font-weight: 600;
            font-size: 0.8rem;
            margin-bottom: 2px;
            color: var(--dark-gray);
        }
        
        .suggestion-secondary {
            color: var(--medium-gray);
            font-size: 0.7rem;
            margin-bottom: 3px;
        }
        
        .suggestion-tertiary {
            color: var(--medium-gray);
            font-size: 0.65rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .suggestion-distance {
            background: var(--light-orange);
            color: var(--primary-orange);
            padding: 1px 4px;
            border-radius: 3px;
            font-weight: 600;
            font-size: 0.6rem;
        }
        
        .suggestion-city-badge {
            background: var(--primary-orange);
            color: white;
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 0.6rem;
            font-weight: 600;
        }
        
        /* Enhanced Popup Ride Map */
        .popup-ride-map {
            height: 200px;
            border-radius: var(--element-radius);
            overflow: hidden;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
        }
        
        /* All other existing CSS styles remain unchanged */
        .driver-info {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .driver-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            color: var(--white);
            font-weight: 700;
        }
        
        .driver-details h2 {
            font-size: 0.85rem;
            margin-bottom: 2px;
        }
        
        .driver-details p {
            color: var(--medium-gray);
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 3px;
            font-size: 0.7rem;
        }
        
        .trip-details {
            margin-bottom: 10px;
        }
        
        .location-row {
            display: flex;
            align-items: flex-start;
            gap: 5px;
            margin-bottom: 8px;
        }
        
        .location-icon {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            flex-shrink: 0;
        }
        
        .pickup-icon {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .destination-icon {
            background: var(--primary-red);
            color: var(--white);
        }
        
        .location-text {
            flex: 1;
        }
        
        .location-text h4 {
            font-size: 0.8rem;
            margin-bottom: 2px;
        }
        
        .location-text p {
            color: var(--medium-gray);
            font-size: 0.7rem;
        }
        
        .fare-details {
            background: var(--light-orange);
            padding: 8px;
            border-radius: var(--element-radius);
            margin-bottom: 10px;
        }
        
        .fare-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 0.7rem;
        }
        
        .fare-row.total {
            font-weight: 700;
            font-size: 0.8rem;
            border-top: 1px solid var(--border-color);
            padding-top: 5px;
            margin-top: 5px;
        }
        
        .ride-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }
        
        .btn {
            padding: 8px;
            border: none;
            border-radius: var(--element-radius);
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .btn-cancel {
            background: var(--error-red);
            color: var(--white);
        }
        
        .btn-contact {
            background: var(--info-blue);
            color: var(--white);
        }
        
        .account-section, .history-section, .emergency-section {
            margin-bottom: 15px;
        }
        
        .section-title {
            font-size: 0.85rem;
            margin-bottom: 8px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .input-group {
            margin-bottom: 8px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 600;
            font-size: 0.75rem;
        }
        
        .input-field {
            width: 100%;
            padding: 8px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 0.75rem;
            transition: all var(--transition-speed) ease;
        }
        
        .input-field:focus {
            outline: none;
            border-color: var(--primary-orange);
        }
        
        .wallet-balance {
            background: var(--primary-gradient);
            color: var(--white);
            padding: 10px;
            border-radius: var(--element-radius);
            text-align: center;
            margin-bottom: 10px;
        }
        
        .balance-label {
            font-size: 0.7rem;
            margin-bottom: 2px;
        }
        
        .balance-amount-large {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 5px;
        }
        
        .wallet-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin-bottom: 10px;
        }
        
        .btn-wallet {
            background: var(--white);
            color: var(--primary-orange);
            border: 2px solid var(--primary-orange);
            padding: 6px;
            font-size: 0.7rem;
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .btn-wallet:hover {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .history-item {
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            font-size: 0.7rem;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-item:hover {
            background: var(--light-orange);
        }
        
        .history-locations {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .history-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.65rem;
            color: var(--medium-gray);
        }
        
        .status-badge {
            padding: 2px 5px;
            border-radius: 10px;
            font-size: 0.6rem;
            font-weight: 700;
        }
        
        .status-completed {
            background: #e6f7e9;
            color: #2e7d32;
        }
        
        .status-cancelled {
            background: #ffebee;
            color: #c62828;
        }
        
        .status-requested {
            background: #fff3e0;
            color: #ef6c00;
        }
        
        .status-accepted {
            background: #e3f2fd;
            color: #1565c0;
        }
        
        .notification {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-gradient);
            color: var(--white);
            padding: 8px 14px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 300;
            display: none;
            font-weight: 600;
            text-align: center;
            font-size: 0.75rem;
            max-width: 80%;
        }
        
        .ride-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: var(--white);
            padding: 6px 10px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 700;
            color: var(--dark-gray);
            border: 2px solid var(--border-color);
            font-size: 0.75rem;
            display: none;
        }
        
        .status-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: var(--medium-gray);
        }
        
        .status-dot.searching {
            background: var(--warning-yellow);
            animation: pulse 2s infinite;
        }
        
        .status-dot.arriving {
            background: var(--info-blue);
            animation: pulse 1.5s infinite;
        }
        
        .status-dot.riding {
            background: var(--success-green);
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .estimated-time {
            position: fixed;
            top: 50px;
            right: 10px;
            background: var(--white);
            padding: 6px 10px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 700;
            color: var(--dark-gray);
            border: 2px solid var(--border-color);
            font-size: 0.75rem;
            display: none;
        }
        
        .saved-locations {
            display: flex;
            gap: 6px;
            margin: 8px 0;
        }
        
        .saved-location-btn {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
            cursor: pointer;
            font-size: 0.65rem;
            transition: all var(--transition-speed) ease;
        }
        
        .saved-location-btn:hover {
            background: var(--light-orange);
            border-color: var(--primary-orange);
        }
        
        .suggestion-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-medium);
            z-index: 200;
            max-height: 250px;
            overflow-y: auto;
            display: none;
        }
        
        .loading-text {
            text-align: center;
            padding: 15px;
            color: var(--medium-gray);
        }
        
        .no-places {
            text-align: center;
            padding: 15px;
            color: var(--medium-gray);
        }
        
        .filter-options {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .stat-card {
            background: var(--light-gray);
            padding: 10px;
            border-radius: var(--element-radius);
            text-align: center;
        }
        
        .stat-number {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        .stat-label {
            font-size: 0.65rem;
            color: var(--medium-gray);
        }
        
        .referral-section {
            background: var(--light-orange);
            padding: 12px;
            border-radius: var(--element-radius);
            margin-bottom: 12px;
        }
        
        .referral-code {
            background: var(--white);
            padding: 8px;
            border-radius: var(--element-radius);
            text-align: center;
            margin: 8px 0;
        }
        
        .code {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        .description {
            font-size: 0.65rem;
            color: var(--medium-gray);
            margin-top: 4px;
        }
        
        .contact-section {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .contact-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: var(--element-radius);
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .contact-btn.whatsapp {
            background: #25D366;
            color: white;
        }
        
        .contact-btn.phone {
            background: var(--info-blue);
            color: white;
        }
        
        .rating-stars {
            display: flex;
            gap: 4px;
            margin-top: 4px;
        }
        
        .star {
            font-size: 1.3rem;
            color: var(--light-gray);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .star.active {
            color: var(--warning-yellow);
        }
        
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
        }
        
        .popup-overlay.hidden {
            display: none;
        }
        
        .popup-form {
            background: var(--white);
            border-radius: var(--element-radius);
            width: 100%;
            max-width: 450px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: var(--shadow-heavy);
        }
        
        .large-popup {
            max-width: 700px;
        }
        
        .popup-header {
            display: flex;
            align-items: center;
            justify-content: between;
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .popup-title {
            font-size: 1.1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .close-popup {
            background: none;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            color: var(--medium-gray);
        }
        
        .popup-content {
            padding: 12px;
        }
        
        .popup-map-container {
            height: 180px;
            border-radius: var(--element-radius);
            overflow: hidden;
            margin-bottom: 12px;
        }
        
        .popup-details {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .detail-row:last-child {
            border-bottom: none;
        }
        
        .detail-label {
            font-weight: 600;
            font-size: 0.75rem;
        }
        
        .detail-value {
            font-size: 0.75rem;
            color: var(--medium-gray);
        }
        
        .driver-details-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }
        
        .popup-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 12px;
        }
        
        /* Payment Selection Popup Styles */
        .payment-selection-popup {
            max-width: 350px;
        }
        
        .payment-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            margin-bottom: 8px;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .payment-option.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .payment-option-icon {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            color: var(--medium-gray);
        }
        
        .payment-option.selected .payment-option-icon {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .payment-option-details {
            flex: 1;
        }
        
        .payment-option-name {
            font-weight: 600;
            font-size: 0.85rem;
        }
        
        .payment-option-description {
            color: var(--medium-gray);
            font-size: 0.7rem;
        }
        
        .payment-option-balance {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--primary-orange);
        }
        
        .confirm-payment-btn {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: var(--element-radius);
            background: var(--primary-gradient);
            color: var(--white);
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            margin-top: 12px;
        }
        
        .confirm-payment-btn:disabled {
            background: var(--medium-gray);
            cursor: not-allowed;
        }
        
        .insufficient-balance {
            color: var(--error-red);
            font-size: 0.75rem;
            margin-top: 4px;
            display: none;
        }
        
        /* Package Delivery Form Styles */
        .package-form {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
            display: none;
        }
        
        .package-form.active {
            display: block;
        }
        
        .form-row {
            display: flex;
            gap: 6px;
            margin-bottom: 6px;
        }
        
        .form-group {
            flex: 1;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 3px;
            font-weight: 600;
            font-size: 0.7rem;
        }
        
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 6px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 0.7rem;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 50px;
        }
        
        .package-toggle {
            width: 100%;
            padding: 6px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .driver-details-card {
            background: var(--light-orange);
            padding: 10px;
            border-radius: var(--element-radius);
            margin-bottom: 10px;
            border: 1px solid var(--primary-orange);
        }
        
        .driver-details-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 6px;
        }
        
        .driver-details-header h3 {
            font-size: 0.85rem;
            color: var(--primary-orange);
        }
        
        .driver-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }
        
        .driver-detail-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .driver-detail-label {
            font-size: 0.65rem;
            color: var(--medium-gray);
            font-weight: 600;
        }
        
        .driver-detail-value {
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .driver-vehicle-details {
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px dashed var(--border-color);
        }
        
        .vehicle-detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
            font-size: 0.65rem;
        }
        
        .vehicle-detail-label {
            color: var(--medium-gray);
        }
        
        .vehicle-detail-value {
            font-weight: 600;
        }
        
        .history-package-details {
            background: var(--light-gray);
            padding: 6px;
            border-radius: var(--element-radius);
            margin: 6px 0;
            font-size: 0.65rem;
        }
        
        .package-detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
        }
        
        .package-detail-label {
            font-weight: 600;
            color: var(--medium-gray);
        }
        
        .package-detail-value {
            color: var(--dark-gray);
        }
        
        .history-driver-info {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px dashed var(--border-color);
        }
        
        .history-driver-avatar {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            color: var(--white);
            font-weight: 700;
        }
        
        .history-driver-details {
            flex: 1;
        }
        
        .history-driver-name {
            font-size: 0.65rem;
            font-weight: 600;
        }
        
        .history-driver-rating {
            font-size: 0.55rem;
            color: var(--medium-gray);
        }
        
        .history-fare {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        /* Driver Search Animation */
        .searching-animation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 200;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .searching-pulse {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(255, 107, 53, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse-ring 2s infinite;
            position: relative;
        }
        
        .searching-pulse-inner {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }
        
        .searching-text {
            margin-top: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 12px;
            border-radius: var(--element-radius);
            font-weight: 600;
            color: var(--primary-orange);
            box-shadow: var(--shadow-medium);
        }
        
        @keyframes pulse-ring {
            0% {
                transform: scale(0.8);
                opacity: 1;
            }
            80%, 100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }
        
        /* Enhanced Ride History Popup Styles */
        .history-chat-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }
        
        .history-chat-messages {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 10px;
            padding: 10px;
            background: var(--light-gray);
            border-radius: var(--element-radius);
        }
        
        .history-chat-message {
            padding: 8px;
            margin-bottom: 8px;
            border-radius: var(--element-radius);
            max-width: 80%;
        }
        
        .history-chat-message.passenger {
            background: var(--primary-orange);
            color: white;
            margin-left: auto;
        }
        
        .history-chat-message.driver {
            background: var(--white);
            border: 1px solid var(--border-color);
            margin-right: auto;
        }
        
        .receipt-button {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--primary-orange);
            border-radius: var(--element-radius);
            background: var(--white);
            color: var(--primary-orange);
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }
        
        /* Scheduled Ride Item Styles */
        .scheduled-ride-item {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            background: var(--light-orange);
            border-radius: var(--element-radius);
            margin-bottom: 8px;
        }
        
        .scheduled-ride-time {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--primary-orange);
            margin-bottom: 5px;
        }
        
        .scheduled-ride-details {
            font-size: 0.75rem;
            margin-bottom: 8px;
        }
        
        .scheduled-ride-actions {
            display: flex;
            gap: 6px;
        }
        
        .scheduled-action-btn {
            flex: 1;
            padding: 6px;
            border: none;
            border-radius: var(--element-radius);
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
        }
        
        .scheduled-edit-btn {
            background: var(--info-blue);
            color: white;
        }
        
        .scheduled-cancel-btn {
            background: var(--error-red);
            color: white;
        }
        
        /* More Options Button */
        .more-options-btn {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--primary-orange);
            color: var(--white);
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .more-options-dropdown {
            display: none;
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            margin-top: 5px;
            overflow: hidden;
            box-shadow: var(--shadow-medium);
        }
        
        .more-options-dropdown.active {
            display: block;
        }
        
        .more-option-item {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all var(--transition-speed) ease;
        }
        
        .more-option-item:hover {
            background: var(--light-orange);
        }
        
        .more-option-item:last-child {
            border-bottom: none;
        }
        
        .more-option-icon {
            width: 20px;
            text-align: center;
            font-size: 0.9rem;
        }
        
        .more-option-text {
            flex: 1;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        /* Order for Someone Else Form */
        .order-for-someone-form {
            display: none;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
        }
        
        .order-for-someone-form.active {
            display: flex;
        }
        
        /* Express Delivery Form */
        .express-delivery-form {
            display: none;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
        }
        
        .express-delivery-form.active {
            display: flex;
        }
        
        /* SOS Setup Form */
        .sos-setup-form {
            display: none;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
        }
        
        .sos-setup-form.active {
            display: flex;
        }
        
        /* SOS Button */
        .sos-button {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--error-red);
            color: var(--white);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 700;
            box-shadow: var(--shadow-heavy);
            z-index: 150;
            cursor: pointer;
            animation: sos-pulse 2s infinite;
            display: none;
        }
        
        @keyframes sos-pulse {
            0% {
                transform: translateX(-50%) scale(1);
                box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7);
            }
            70% {
                transform: translateX(-50%) scale(1.05);
                box-shadow: 0 0 0 10px rgba(231, 76, 60, 0);
            }
            100% {
                transform: translateX(-50%) scale(1);
                box-shadow: 0 0 0 0 rgba(231, 76, 60, 0);
            }
        }
        
        /* Delivery Fee Display */
        .delivery-fee-display {
            background: var(--primary-gradient);
            color: var(--white);
            padding: 10px;
            border-radius: var(--element-radius);
            text-align: center;
            margin: 8px 0;
        }
        
        .delivery-fee-amount {
            font-size: 1.2rem;
            font-weight: 800;
            margin: 4px 0;
        }
        
        .delivery-eta-display {
            font-size: 0.8rem;
            font-weight: 600;
            opacity: 0.9;
        }
        
        @media (max-width: 480px) {
            .floating-balance, .ride-status {
                padding: 5px 7px;
                font-size: 0.65rem;
            }
            
            .passenger-panel {
                padding: 8px;
            }
            
            .nav-buttons {
                gap: 3px;
            }
            
            .nav-btn {
                padding: 5px 2px;
                font-size: 0.55rem;
            }
            
            .ride-type-options {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .emergency-options-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Main App -->
    <div id="mainApp">
        <!-- Main Map -->
        <div id="map"></div>
        
        <!-- Floating Balance -->
        <div class="floating-balance home-only">
            <i class="fas fa-wallet"></i>
            <span>Balance: <span class="balance-amount" id="walletBalance">K0.00</span></span>
        </div>
        
        <!-- Ride Status -->
        <div class="ride-status home-only" id="rideStatus">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Searching for driver</span>
        </div>
        
        <!-- Estimated Time -->
        <div class="estimated-time home-only" id="estimatedTime">
            <i class="fas fa-clock"></i>
            <span id="timeText">5 min</span>
        </div>
        
        <!-- SOS Button -->
        <div class="sos-button" id="sosButton">
            SOS
        </div>
        
        <!-- Driver Search Animation -->
        <div class="searching-animation" id="searchingAnimation">
            <div class="searching-pulse">
                <div class="searching-pulse-inner">
                    <i class="fas fa-car"></i>
                </div>
            </div>
            <div class="searching-text">Searching for driver</div>
        </div>
        
        <!-- Passenger Panel -->
        <div class="passenger-panel" id="passengerPanel">
            <div class="panel-collapse-handle" id="panelCollapseHandle"></div>
            
            <div class="nav-buttons">
                <button class="nav-btn active" data-screen="home">
                    <i class="fas fa-home"></i>
                    <span>Home</span>
                </button>
                <button class="nav-btn" data-screen="account">
                    <i class="fas fa-user"></i>
                    <span>Account</span>
                </button>
                <button class="nav-btn" data-screen="history">
                    <i class="fas fa-history"></i>
                    <span>History</span>
                </button>
                <button class="nav-btn" data-screen="emergency">
                    <i class="fas fa-ambulance"></i>
                    <span>Emergency</span>
                </button>
            </div>
            
            <!-- Ride Type Selection -->
            <div class="ride-type-selection" id="rideTypeSelection" style="display: none;">
                <div class="ride-type-header">Select Ride Type</div>
                <div class="ride-type-options">
                    <div class="ride-type-option standard selected" data-ride-type="standard">
                        <i class="fas fa-car ride-type-icon"></i>
                        <span class="ride-type-name">Standard</span>
                        <span class="ride-type-price">Clean Cars</span>
                    </div>
                    <div class="ride-type-option premium" data-ride-type="premium">
                        <i class="fas fa-crown ride-type-icon"></i>
                        <span class="ride-type-name">Premium</span>
                        <span class="ride-type-price">Luxury</span>
                        <div class="ride-type-premium-badge">P</div>
                    </div>
                    <div class="ride-type-option economy" data-ride-type="economy">
                        <i class="fas fa-car-side ride-type-icon"></i>
                        <span class="ride-type-name">Economy</span>
                        <span class="ride-type-price">Budget</span>
                    </div>
                </div>
            </div>
            
            <!-- Emergency Questionnaire -->
            <div class="emergency-questionnaire" id="emergencyQuestionnaire">
                <div class="emergency-header">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>Emergency Details</h3>
                </div>
                
                <div class="emergency-question">
                    <label>What type of emergency is this?</label>
                    <div class="emergency-options" id="emergencyTypeOptions">
                        <div class="emergency-option" data-type="medical">Medical</div>
                        <div class="emergency-option" data-type="fire">Fire</div>
                        <div class="emergency-option" data-type="accident">Accident</div>
                        <div class="emergency-option" data-type="other">Other</div>
                    </div>
                </div>
                
                <div class="emergency-question">
                    <label>How many people are affected?</label>
                    <div class="emergency-options" id="emergencyPeopleOptions">
                        <div class="emergency-option" data-people="1">1</div>
                        <div class="emergency-option" data-people="2-5">2-5</div>
                        <div class="emergency-option" data-people="5+">5+</div>
                    </div>
                </div>
                
                <div class="emergency-question">
                    <label>Additional details (optional)</label>
                    <textarea class="emergency-input" id="emergencyDetails" placeholder="Provide any additional information that could help"></textarea>
                </div>
                
                <div class="emergency-note">
                    <i class="fas fa-info-circle"></i> Your location and details will be shared with emergency services immediately.
                </div>
                
                <div class="emergency-actions">
                    <button class="btn-emergency btn-emergency-cancel" id="cancelEmergencyBtn">Cancel</button>
                    <button class="btn-emergency btn-emergency-confirm" id="confirmEmergencyBtn">Request Emergency</button>
                </div>
            </div>
            
            <!-- Schedule Ride Button -->
            <button class="schedule-ride-btn" id="scheduleRideBtn">
                <i class="fas fa-clock"></i>
                Schedule Ride
            </button>
            
            <!-- More Options Button -->
            <button class="more-options-btn" id="moreOptionsBtn">
                <i class="fas fa-ellipsis-h"></i>
                More Options
            </button>
            
            <!-- Home Screen Content -->
            <div id="homeScreenContent">
                <!-- Original Ride Request Form -->
                <div class="ride-request-form" id="rideRequestForm">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="pickupLocation" placeholder="Current location" readonly>
                    </div>
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="destinationLocation" placeholder="Where to?">
                        <div class="suggestion-list" id="destinationSuggestions"></div>
                    </div>
                    
                    <!-- Address Breakdown -->
                    <div class="address-breakdown" id="addressBreakdown">
                        <div class="address-component">
                            <span class="address-label">House/Infrastructure:</span>
                            <span class="address-value" id="addressHouse"></span>
                        </div>
                        <div class="address-component">
                            <span class="address-label">Road/Street:</span>
                            <span class="address-value" id="addressRoad"></span>
                        </div>
                        <div class="address-component">
                            <span class="address-label">Area/Suburb:</span>
                            <span class="address-value" id="addressArea"></span>
                        </div>
                        <div class="address-component">
                            <span class="address-label">City:</span>
                            <span class="address-value" id="addressCity"></span>
                        </div>
                    </div>
                    
                    <div class="saved-locations">
                        <button class="saved-location-btn" data-address="home">
                            <i class="fas fa-home"></i>
                            Home
                        </button>
                        <button class="saved-location-btn" data-address="work">
                            <i class="fas fa-briefcase"></i>
                            Work
                        </button>
                    </div>
                    
                    <button class="promo-toggle" id="promoToggle">
                        <i class="fas fa-tag"></i>
                        Apply Promo Coupon
                    </button>
                    
                    <div class="promo-section" id="promoSection">
                        <div class="promo-input">
                            <input type="text" id="promoCode" placeholder="Promo code">
                            <button class="btn-promo" id="applyPromoBtn">Apply</button>
                        </div>
                    </div>
                    
                    <div class="fare-display">
                        <p>Estimated Fare</p>
                        <div class="fare-amount" id="estimatedFare">K0.00</div>
                        <p class="eta-display" id="etaDisplay">ETA: -- min</p>
                    </div>
                    
                    <button class="request-ride-btn" id="requestRideBtn">Request Ride</button>
                </div>
                
                <!-- Ride Info Panel (Hidden initially) -->
                <div class="ride-info-panel" id="rideInfoPanel">
                    <!-- Driver Details Card -->
                    <div class="driver-details-card" id="driverDetailsCard" style="display: none;">
                        <div class="driver-details-header">
                            <i class="fas fa-id-card"></i>
                            <h3>Driver Details</h3>
                        </div>
                        <div class="driver-details-grid">
                            <div class="driver-detail-item">
                                <span class="driver-detail-label">Driver Name</span>
                                <span class="driver-detail-value" id="driverFullName">John Doe</span>
                            </div>
                            <div class="driver-detail-item">
                                <span class="driver-detail-label">Phone</span>
                                <span class="driver-detail-value" id="driverContactPhone">+260 123 456 789</span>
                            </div>
                            <div class="driver-detail-item">
                                <span class="driver-detail-label">Rating</span>
                                <span class="driver-detail-value" id="driverRatingValue">4.8 </span>
                            </div>
                            <div class="driver-detail-item">
                                <span class="driver-detail-label">Experience</span>
                                <span class="driver-detail-value" id="driverExperience">2 years</span>
                            </div>
                        </div>
                        <div class="driver-vehicle-details">
                            <div class="vehicle-detail-row">
                                <span class="vehicle-detail-label">Vehicle Type</span>
                                <span class="vehicle-detail-value" id="vehicleType">Car</span>
                            </div>
                            <div class="vehicle-detail-row">
                                <span class="vehicle-detail-label">Vehicle Model</span>
                                <span class="vehicle-detail-value" id="vehicleModel">Toyota Corolla</span>
                            </div>
                            <div class="vehicle-detail-row">
                                <span class="vehicle-detail-label">License Plate</span>
                                <span class="vehicle-detail-value" id="vehicleLicense">ABC 123</span>
                            </div>
                            <div class="vehicle-detail-row">
                                <span class="vehicle-detail-label">Color</span>
                                <span class="vehicle-detail-value" id="vehicleColor">Blue</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="driver-info">
                        <div class="driver-avatar" id="driverAvatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="driver-details">
                            <h2 id="driverName">Driver Name</h2>
                            <p><i class="fas fa-phone"></i> <span id="driverPhone">000-000-0000</span></p>
                            <p><i class="fas fa-car"></i> <span id="vehicleDetails">Toyota Corolla - ABC123</span></p>
                            <p><i class="fas fa-star"></i> <span id="driverRating">4.5 </span></p>
                        </div>
                    </div>
                    
                    <div class="trip-details">
                        <div class="location-row">
                            <div class="location-icon pickup-icon">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="location-text">
                                <h4>Pickup Location</h4>
                                <p id="currentPickupLocation">123 Main Street, City</p>
                            </div>
                        </div>
                        <div class="location-row">
                            <div class="location-icon destination-icon">
                                <i class="fas fa-flag"></i>
                            </div>
                            <div class="location-text">
                                <h4>Destination</h4>
                                <p id="currentDestinationLocation">456 Oak Avenue, City</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="fare-details">
                        <div class="fare-row">
                            <span>Base Fare</span>
                            <span id="baseFare">K15.00</span>
                        </div>
                        <div class="fare-row">
                            <span>Distance</span>
                            <span id="distanceFare">K5.00</span>
                        </div>
                        <div class="fare-row">
                            <span>Discount</span>
                            <span id="discountFare">-K2.00</span>
                        </div>
                        <div class="fare-row total">
                            <span>Total Fare</span>
                            <span id="totalFare">K18.00</span>
                        </div>
                    </div>
                    
                    <div class="ride-actions">
                        <button class="btn btn-cancel" id="cancelRideBtn">
                            <i class="fas fa-times-circle"></i>
                            Cancel Ride
                        </button>
                        <button class="btn btn-contact" id="contactDriverBtn">
                            <i class="fas fa-phone"></i>
                            Contact Driver
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Screen Contents -->
        <div class="screen-content" id="homeScreen">
            <!-- Home screen is the map -->
        </div>
        
        <div class="screen-content" id="accountScreen">
            <div class="screen-header">
                <button class="back-button" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="screen-title">Account</h2>
            </div>
            
            <div class="account-section">
                <div class="account-header">
                    <div class="driver-avatar" id="accountAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="driver-details">
                        <h2 id="accountName">Passenger</h2>
                        <p><i class="fas fa-phone"></i> <span id="accountPhone">Not set</span></p>
                        <p><i class="fas fa-envelope"></i> <span id="accountEmail">Not set</span></p>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="ridesCompleted">0</div>
                        <div class="stat-label">Completed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="ridesCancelled">0</div>
                        <div class="stat-label">Cancelled</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="ridesPending">0</div>
                        <div class="stat-label">Pending</div>
                    </div>
                </div>
                
                <div class="referral-section">
                    <h3 class="section-title">
                        <i class="fas fa-share-alt"></i>
                        Refer & Earn
                    </h3>
                    <p>Share your code and get K25 when friends complete their first ride</p>
                    <div class="referral-code">
                        <div class="code" id="referralCode">JUBEL-XXXX</div>
                        <div class="description">50% discount for new users</div>
                    </div>
                    <button class="btn btn-primary" id="shareReferralBtn">
                        <i class="fas fa-share"></i>
                        Share Referral Code
                    </button>
                </div>
                
                <div class="wallet-section">
                    <h3 class="section-title">
                        <i class="fas fa-wallet"></i>
                        Jubel Wallet
                    </h3>
                    <div class="wallet-balance">
                        <div class="balance-label">Current Balance</div>
                        <div class="balance-amount-large" id="accountBalance">K0.00</div>
                    </div>
                    <div class="wallet-actions">
                        <button class="btn-wallet" id="depositBtn">
                            <i class="fas fa-plus"></i>
                            Deposit
                        </button>
                        <button class="btn-wallet" id="withdrawBtn">
                            <i class="fas fa-minus"></i>
                            Withdraw
                        </button>
                    </div>
                </div>
                
                <div class="contact-section">
                    <button class="contact-btn whatsapp" id="whatsappBtn">
                        <i class="fab fa-whatsapp"></i>
                        WhatsApp
                    </button>
                    <button class="contact-btn phone" id="callBtn">
                        <i class="fas fa-phone"></i>
                        Call Us
                    </button>
                </div>
            </div>
        </div>
        
        <div class="screen-content" id="historyScreen">
            <div class="screen-header">
                <button class="back-button" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="screen-title">Ride History</h2>
            </div>
            
            <div class="history-filters">
                <select id="historyFilter" class="history-filter-select">
                    <option value="all">All Rides</option>
                    <option value="standard">Standard Rides</option>
                    <option value="premium">Premium Rides</option>
                    <option value="economy">Economy Rides</option>
                    <option value="emergency">Emergency</option>
                    <option value="ambulance">Ambulance</option>
                    <option value="fire-truck">Fire Truck</option>
                    <option value="completed">Completed</option>
                    <option value="cancelled">Cancelled</option>
                </select>
                <input type="date" id="historyDate" class="history-date-input">
            </div>
            
            <div class="history-section">
                <div id="historyList">
                    <div class="loading-text">
                        <i class="fas fa-spinner fa-spin"></i>
                        Loading ride history...
                    </div>
                </div>
            </div>
        </div>
        
        <div class="screen-content" id="emergencyScreen">
            <div class="screen-header">
                <button class="back-button" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="screen-title">Emergency Services</h2>
            </div>
            
            <div class="emergency-section">
                <div class="emergency-instructions">
                    <h4><i class="fas fa-exclamation-circle"></i> Important Information</h4>
                    <p> Emergency services will be dispatched immediately</p>
                    <p> Your location will be shared with emergency responders</p>
                    <p> Please provide accurate information about the emergency</p>
                    <p> Stay on the line if possible for further instructions</p>
                </div>
                
                <div class="emergency-options-grid">
                    <div class="emergency-option-card ambulance" data-emergency-type="ambulance">
                        <i class="fas fa-ambulance emergency-option-icon"></i>
                        <div class="emergency-option-name">Ambulance</div>
                        <div class="emergency-option-description">Medical emergency response</div>
                    </div>
                    
                    <div class="emergency-option-card fire-truck" data-emergency-type="fire-truck">
                        <i class="fas fa-fire-extinguisher emergency-option-icon"></i>
                        <div class="emergency-option-name">Fire Truck</div>
                        <div class="emergency-option-description">Fire and rescue services</div>
                    </div>
                    
                    <div class="emergency-option-card emergency-ride" data-emergency-type="emergency-ride">
                        <i class="fas fa-car emergency-option-icon"></i>
                        <div class="emergency-option-name">Emergency Ride</div>
                        <div class="emergency-option-description">Urgent transportation</div>
                    </div>
                    
                    <div class="emergency-option-card emergency-delivery" data-emergency-type="emergency-delivery">
                        <i class="fas fa-shipping-fast emergency-option-icon"></i>
                        <div class="emergency-option-name">Emergency Delivery</div>
                        <div class="emergency-option-description">Urgent item delivery</div>
                    </div>
                </div>
                
                <div class="emergency-instructions">
                    <h4><i class="fas fa-phone"></i> Direct Emergency Contact</h4>
                    <p>For immediate life-threatening emergencies, please call:</p>
                    <div style="text-align: center; margin: 10px 0;">
                        <button class="contact-btn phone" style="background: var(--emergency-red);">
                            <i class="fas fa-phone"></i> Emergency: 911
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Payment Selection Popup -->
    <div id="paymentSelectionPopup" class="popup-overlay hidden">
        <div class="popup-form payment-selection-popup">
            <div class="popup-header">
                <h2 class="popup-title">
                    <i class="fas fa-credit-card"></i>
                    Select Payment Method
                </h2>
                <button class="close-popup" id="closePaymentPopup">&times;</button>
            </div>
            <div class="popup-content">
                <div class="payment-options">
                    <div class="payment-option selected" data-payment-type="wallet">
                        <div class="payment-option-icon">
                            <i class="fas fa-wallet"></i>
                        </div>
                        <div class="payment-option-details">
                            <div class="payment-option-name">Jubel Wallet</div>
                            <div class="payment-option-description">Pay with your Jubel wallet balance</div>
                            <div class="payment-option-balance" id="paymentWalletBalance">Balance: K0.00</div>
                        </div>
                    </div>
                    
                    <div class="payment-option" data-payment-type="mobile">
                        <div class="payment-option-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="payment-option-details">
                            <div class="payment-option-name">Mobile Money</div>
                            <div class="payment-option-description">Pay with Airtel, MTN or Zamtel Money</div>
                        </div>
                    </div>
                    
                    <div class="payment-option" data-payment-type="cash">
                        <div class="payment-option-icon">
                            <i class="fas fa-money-bill"></i>
                        </div>
                        <div class="payment-option-details">
                            <div class="payment-option-name">Cash on Delivery</div>
                            <div class="payment-option-description">Pay with cash when you arrive</div>
                        </div>
                    </div>
                </div>
                
                <div class="insufficient-balance" id="insufficientBalance">
                    <i class="fas fa-exclamation-circle"></i>
                    Insufficient balance in your Jubel wallet
                </div>
                
                <button class="confirm-payment-btn" id="confirmPaymentBtn">
                    Confirm Payment & Request Ride
                </button>
            </div>
        </div>
    </div>
    
    <!-- Enhanced Ride Details Popup -->
    <div id="rideDetailsPopup" class="popup-overlay hidden">
        <div class="popup-form large-popup">
            <div class="popup-header">
                <h2 class="popup-title">
                    <i class="fas fa-info-circle"></i>
                    Ride Details
                </h2>
                <button class="close-popup" id="closeRidePopupTop">&times;</button>
            </div>
            <div class="popup-content">
                <div class="popup-ride-map" id="popupRideMap"></div>
                <div class="popup-details">
                    <div class="detail-row">
                        <span class="detail-label">Ride Type:</span>
                        <span class="detail-value" id="popupRideType">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Pickup:</span>
                        <span class="detail-value" id="popupRidePickup">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Destination:</span>
                        <span class="detail-value" id="popupRideDestination">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Fare:</span>
                        <span class="detail-value" id="popupRideFare">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Distance:</span>
                        <span class="detail-value" id="popupRideDistance">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Status:</span>
                        <span class="detail-value" id="popupRideStatus">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Date & Time:</span>
                        <span class="detail-value" id="popupRideDate">Loading...</span>
                    </div>
                    
                    <!-- Driver Details Section -->
                    <div id="popupDriverDetails" class="driver-details-section hidden">
                        <h3 class="section-title">Driver Information</h3>
                        <div class="detail-row">
                            <span class="detail-label">Driver Name:</span>
                            <span class="detail-value" id="popupDriverName">Loading...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Phone:</span>
                            <span class="detail-value" id="popupDriverPhone">Loading...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Vehicle:</span>
                            <span class="detail-value" id="popupDriverVehicle">Loading...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Rating:</span>
                            <span class="detail-value" id="popupDriverRating">Loading...</span>
                        </div>
                    </div>
                    
                    <!-- Receipt Button -->
                    <button class="receipt-button" id="generateReceiptBtn">
                        <i class="fas fa-receipt"></i>
                        Generate & Download Receipt
                    </button>
                    
                    <div class="popup-actions">
                        <button class="btn btn-primary" id="closeRidePopup">
                            <i class="fas fa-times"></i>
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Rating Popup -->
    <div id="ratingPopup" class="popup-overlay hidden">
        <div class="popup-form">
            <div class="popup-header">
                <h2 class="popup-title">
                    <i class="fas fa-star"></i>
                    Rate Your Driver
                </h2>
                <button class="close-popup" id="closeRatingPopup">&times;</button>
            </div>
            <div class="popup-content">
                <div class="rating-driver-info" style="text-align: center; margin-bottom: 20px;">
                    <div class="driver-avatar" id="ratingDriverAvatar" style="width: 60px; height: 60px; margin: 0 auto 10px; background: var(--primary-orange); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white;">
                        <i class="fas fa-user"></i>
                    </div>
                    <h3 id="ratingDriverName" style="margin-bottom: 5px;">Driver Name</h3>
                    <p id="ratingVehicleInfo" style="color: var(--medium-gray); font-size: 0.9rem;">Vehicle Info</p>
                </div>
                
                <div class="rating-stars-container" style="text-align: center; margin: 20px 0;">
                    <div class="rating-stars" id="ratingStars">
                        <span class="star" data-rating="1"><i class="far fa-star"></i></span>
                        <span class="star" data-rating="2"><i class="far fa-star"></i></span>
                        <span class="star" data-rating="3"><i class="far fa-star"></i></span>
                        <span class="star" data-rating="4"><i class="far fa-star"></i></span>
                        <span class="star" data-rating="5"><i class="far fa-star"></i></span>
                    </div>
                    <div id="ratingText" style="margin-top: 10px; font-size: 0.9rem; color: var(--medium-gray);">Tap to rate</div>
                </div>
                
                <div class="rating-comment" style="margin-bottom: 20px;">
                    <label for="ratingComment" style="display: block; margin-bottom: 8px; font-weight: 600;">Additional Comments (Optional)</label>
                    <textarea id="ratingComment" placeholder="How was your ride experience?" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: var(--element-radius); resize: vertical; min-height: 80px;"></textarea>
                </div>
                
                <button id="submitRatingBtn" class="request-ride-btn" style="width: 100%;">
                    <i class="fas fa-paper-plane"></i> Submit Rating
                </button>
            </div>
        </div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification"></div>
    
    <!-- Firebase and OpenLayers JS -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <!-- OpenLayers -->
    <script src="https://cdn.jsdelivr.net/npm/ol@v7.3.0/dist/ol.js"></script>
    <!-- HTML2Canvas for receipt generation -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script>
// Firebase configuration
const firebaseConfig = {
    apiKey: "AIzaSyDEACX_P4c5q7djJAcA0I7Lk7leO2TlQ74",
    authDomain: "jubel-13e1a.firebaseapp.com",
    databaseURL: "https://jubel-13e1a-default-rtdb.firebaseio.com",
    projectId: "jubel-13e1a",
    storageBucket: "jubel-13e1a.firebasestorage.app",
    messagingSenderId: "882241095445",
    appId: "1:882241095445:web:ee9ca40fddd008ca910b1c",
    measurementId: "G-J5JPKL6B5F"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const auth = firebase.auth();

// App state
let currentUser = null;
let currentRide = null;
let passengerMap = null;
let popupRideMap = null;
let locationWatchId = null;
let walletBalance = 0;
let userFullName = "Passenger";
let driverAssignmentListener = null;
let rideHistoryListener = null;
let activeRideListener = null;
let appliedPromoCode = null;
let userStats = {
    completed: 0,
    cancelled: 0,
    pending: 0
};
let userRating = 0;
let userLocation = null;
let destinationSearchResults = [];
let selectedDestination = null;
let driverLocationListener = null;
let userData = null;
let selectedPaymentType = 'wallet';
let rideFare = 0;
let currentCity = "Detecting...";
let packageDetails = null;
let walletBalanceListener = null;
let currentScreen = 'home';
let homeScreenRefreshRequired = false;

// Enhanced state variables
let sosConfig = null;
let activeMoreOption = null;
let activeScheduleOption = null;
let activeEmergencyType = null;
let selectedRideType = 'standard';
let emergencyDetails = {};
let currentEmergencyQuestionnaire = null;

// OpenLayers map variables
let map = null;
let mapView = null;
let vectorLayer = null;
let vectorSource = null;
let pickupFeature = null;
let destinationFeature = null;
let currentLocationFeature = null;
let driverFeature = null;
let routeFeature = null;

// Zambian cities for enhanced search
const zambianCities = [
    'Lusaka', 'Kitwe', 'Ndola', 'Kabwe', 'Chipata', 'Chingola', 
    'Mufulira', 'Luanshya', 'Livingstone', 'Kasama', 'Solwezi', 
    'Kapiri Mposhi', 'Chililabombwe', 'Mazabuka', 'Mongu', 'Kafue',
    'Choma', 'Mansa', 'Nchelenge', 'Kawambwa', 'Mbala', 'Mpika',
    'Petauke', 'Katete', 'Siavonga', 'Monze', 'Kalulushi', 'Mwinilunga'
];

// Ride type configurations
const rideTypeConfig = {
    'standard': {
        name: 'Standard',
        icon: 'fas fa-car',
        baseFare: 23,
        multiplier: 1.0,
        description: 'Clean Cars',
        color: '#FF6B35'
    },
    'premium': {
        name: 'Premium',
        icon: 'fas fa-crown',
        baseFare: 40,
        multiplier: 1.8,
        description: 'Luxury Vehicles',
        color: '#FFD700'
    },
    'economy': {
        name: 'Economy',
        icon: 'fas fa-car-side',
        baseFare: 18,
        multiplier: 0.8,
        description: 'Budget Rides',
        color: '#27ae60'
    },
    'emergency': {
        name: 'Emergency',
        icon: 'fas fa-exclamation-triangle',
        baseFare: 50,
        multiplier: 2.5,
        description: 'Urgent Ride',
        color: '#e74c3c'
    },
    'ambulance': {
        name: 'Ambulance',
        icon: 'fas fa-ambulance',
        baseFare: 100,
        multiplier: 5.0,
        description: 'Medical Emergency',
        color: '#c0392b'
    },
    'fire-truck': {
        name: 'Fire Truck',
        icon: 'fas fa-fire-extinguisher',
        baseFare: 100,
        multiplier: 5.0,
        description: 'Fire Emergency',
        color: '#e74c3c'
    },
    'light-truck': {
        name: 'Light Truck',
        icon: 'fas fa-truck',
        baseFare: 35,
        multiplier: 1.5,
        description: 'Cargo Delivery',
        color: '#7f8c8d'
    }
};

// Initialize the app
document.addEventListener('DOMContentLoaded', function() {
    initializeAuth();
});

// Authentication functions
function initializeAuth() {
    const urlParams = new URLSearchParams(window.location.search);
    const email = urlParams.get('email');
    const uid = urlParams.get('uid');
    
    if (email && uid) {
        loadUserData(uid);
    } else {
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                loadUserData(user.uid);
            } else {
                window.location.href = 'signup.html';
            }
        });
    }
}

// Load user data from Firebase
function loadUserData(uid) {
    database.ref('users/' + uid).once('value')
        .then(snapshot => {
            userData = snapshot.val();
            if (userData) {
                currentUser = {
                    uid: uid,
                    email: userData.email,
                    displayName: userData.name
                };
                
                initializeMap();
                setupEventListeners();
                loadPassengerData();
                
                document.getElementById('accountName').textContent = userData.name || 'Passenger';
                document.getElementById('accountEmail').textContent = userData.email || 'Not set';
                document.getElementById('accountPhone').textContent = userData.phone || 'Not set';
                document.getElementById('referralCode').textContent = userData.referralCode || 'JUBEL-XXXX';
                
                walletBalance = userData.walletBalance || 0;
                updateWalletBalanceUI();
                
                setupWalletBalanceListener(uid);
                loadSOSConfig(uid);
                checkActiveRide(uid);
                
                showNotification('Welcome back to Jubel!');
            } else {
                showNotification('User data not found. Please sign up again.');
                setTimeout(() => {
                    window.location.href = 'signup.html';
                }, 2000);
            }
        })
        .catch(error => {
            console.error('Error loading user data:', error);
            showNotification('Error loading user data. Please try again.');
        });
}

// Initialize OpenLayers map
function initializeMap() {
    // Set initial view to central Zambia
    mapView = new ol.View({
        center: ol.proj.fromLonLat([28, -14]),
        zoom: 7
    });
    
    // Create map with OpenStreetMap tiles
    map = new ol.Map({
        target: 'map',
        layers: [
            new ol.layer.Tile({
                source: new ol.source.OSM()
            })
        ],
        view: mapView,
        controls: ol.control.defaults({
            attributionOptions: {
                collapsible: false
            }
        })
    });
    
    // Initialize vector layer for markers and routes
    vectorSource = new ol.source.Vector();
    vectorLayer = new ol.layer.Vector({
        source: vectorSource,
        style: new ol.style.Style({
            image: new ol.style.Circle({
                radius: 6,
                fill: new ol.style.Fill({color: '#FF6B35'}),
                stroke: new ol.style.Stroke({
                    color: '#FFFFFF',
                    width: 2
                })
            })
        })
    });
    
    map.addLayer(vectorLayer);
    
    // Initialize popup map
    popupRideMap = new ol.Map({
        target: 'popupRideMap',
        layers: [
            new ol.layer.Tile({
                source: new ol.source.OSM()
            })
        ],
        view: new ol.View({
            center: ol.proj.fromLonLat([28, -14]),
            zoom: 7
        }),
        controls: []
    });
    
    // Refresh passenger position
    refreshPassengerPosition();
}

// Update pickup location with precise address
function updatePickupLocation(lat, lng) {
    userLocation = { lat, lng };
    
    // Update current location marker
    if (currentLocationFeature) {
        vectorSource.removeFeature(currentLocationFeature);
    }
    
    currentLocationFeature = new ol.Feature({
        geometry: new ol.geom.Point(ol.proj.fromLonLat([lng, lat]))
    });
    
    currentLocationFeature.setStyle(new ol.style.Style({
        image: new ol.style.Circle({
            radius: 8,
            fill: new ol.style.Fill({color: '#3498db'}),
            stroke: new ol.style.Stroke({
                color: '#FFFFFF',
                width: 2
            })
        })
    }));
    
    vectorSource.addFeature(currentLocationFeature);
    
    // Update pickup marker
    if (pickupFeature) {
        vectorSource.removeFeature(pickupFeature);
    }
    
    pickupFeature = new ol.Feature({
        geometry: new ol.geom.Point(ol.proj.fromLonLat([lng, lat]))
    });
    
    pickupFeature.setStyle(new ol.style.Style({
        image: new ol.style.Circle({
            radius: 6,
            fill: new ol.style.Fill({color: '#FF6B35'}),
            stroke: new ol.style.Stroke({
                color: '#FFFFFF',
                width: 2
            })
        })
    }));
    
    vectorSource.addFeature(pickupFeature);
    
    // Center map on location
    mapView.setCenter(ol.proj.fromLonLat([lng, lat]));
    mapView.setZoom(16);
    
    // Get precise address
    getPreciseAddress(lat, lng, 'pickupLocation');
}

// Get precise address with house number, road, area, and city
function getPreciseAddress(lat, lng, elementId) {
    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1&accept-language=en`)
        .then(response => response.json())
        .then(data => {
            if (data && data.address) {
                const address = data.address;
                
                // Build address components
                const houseNumber = address.house_number || address.housenumber || '';
                const road = address.road || address.street || '';
                const suburb = address.suburb || address.neighbourhood || address.residential || '';
                const city = address.city || address.town || address.village || '';
                
                // Create formatted address
                const addressParts = [];
                if (houseNumber) addressParts.push(houseNumber);
                if (road) addressParts.push(road);
                if (suburb) addressParts.push(suburb);
                if (city) addressParts.push(city);
                
                const formattedAddress = addressParts.join(', ');
                document.getElementById(elementId).value = formattedAddress;
                
                // Update address breakdown
                updateAddressBreakdown(address);
                
                // Update city for search
                if (city) {
                    currentCity = city;
                }
            } else {
                document.getElementById(elementId).value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            }
        })
        .catch(error => {
            console.error('Reverse geocoding error:', error);
            document.getElementById(elementId).value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        });
}

// Update address breakdown display
function updateAddressBreakdown(address) {
    const breakdown = document.getElementById('addressBreakdown');
    const house = document.getElementById('addressHouse');
    const road = document.getElementById('addressRoad');
    const area = document.getElementById('addressArea');
    const city = document.getElementById('addressCity');
    
    house.textContent = address.house_number || address.housenumber || address.building || 'Not specified';
    road.textContent = address.road || address.street || 'Not specified';
    area.textContent = address.suburb || address.neighbourhood || address.residential || 'Not specified';
    city.textContent = address.city || address.town || address.village || 'Not specified';
    
    breakdown.classList.add('active');
}

// Enhanced search function with city-based filtering
function searchPlacesEnhanced(query, searchType = 'destination') {
    if (!query || query.length < 2) {
        hideSearchSuggestions(searchType);
        return;
    }
    
    const suggestionsContainer = document.getElementById(`${searchType}Suggestions`);
    
    // Show loading state
    suggestionsContainer.innerHTML = '<div class="loading-text">Searching...</div>';
    suggestionsContainer.style.display = 'block';
    
    // Build search query with city priority
    let searchQuery = query;
    if (currentCity && currentCity !== "Unknown Location" && currentCity !== "Detecting...") {
        searchQuery = `${query}, ${currentCity}, Zambia`;
    } else {
        searchQuery = `${query}, Zambia`;
    }
    
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&limit=10&countrycodes=zm&addressdetails=1`)
        .then(response => response.json())
        .then(data => {
            if (data && data.length > 0) {
                displaySearchResults(data, searchType);
            } else {
                // Fallback to general search
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=10&addressdetails=1`)
                    .then(response => response.json())
                    .then(fallbackData => {
                        if (fallbackData && fallbackData.length > 0) {
                            displaySearchResults(fallbackData, searchType);
                        } else {
                            showNoResultsMessage(searchType);
                        }
                    })
                    .catch(() => showNoResultsMessage(searchType));
            }
        })
        .catch(error => {
            console.error('Search error:', error);
            showNoResultsMessage(searchType);
        });
}

// Display search results with enhanced formatting
function displaySearchResults(results, searchType) {
    const suggestionsContainer = document.getElementById(`${searchType}Suggestions`);
    
    suggestionsContainer.innerHTML = '';
    
    results.forEach((result, index) => {
        const suggestionItem = document.createElement('div');
        suggestionItem.className = 'suggestion-item';
        
        // Extract address components
        const address = result.address || {};
        const houseNumber = address.house_number || address.housenumber || '';
        const road = address.road || address.street || '';
        const suburb = address.suburb || address.neighbourhood || '';
        const city = address.city || address.town || address.village || '';
        
        // Calculate distance if user location is available
        let distanceText = '';
        if (userLocation) {
            const distance = calculateDistance(
                userLocation.lat, userLocation.lng,
                parseFloat(result.lat), parseFloat(result.lon)
            );
            if (distance < 1000) {
                distanceText = `${Math.round(distance)} m`;
            } else {
                distanceText = `${(distance / 1000).toFixed(1)} km`;
            }
        }
        
        // Create suggestion content
        const primaryText = result.display_name.split(',')[0] || result.display_name;
        const secondaryText = [road, suburb].filter(Boolean).join(', ') || city || '';
        const cityText = city || address.county || '';
        
        suggestionItem.innerHTML = `
            <div class="suggestion-icon">
                <i class="fas fa-map-marker-alt"></i>
            </div>
            <div class="suggestion-details">
                <div class="suggestion-primary">${primaryText}</div>
                <div class="suggestion-secondary">${secondaryText}</div>
                <div class="suggestion-tertiary">
                    ${cityText ? `<span class="suggestion-city-badge">${cityText}</span>` : ''}
                    ${distanceText ? `<span class="suggestion-distance">${distanceText}</span>` : ''}
                </div>
            </div>
        `;
        
        suggestionItem.addEventListener('click', function() {
            handleSearchResultSelection(result, searchType);
        });
        
        suggestionsContainer.appendChild(suggestionItem);
    });
    
    suggestionsContainer.style.display = 'block';
}

// Handle search result selection
function handleSearchResultSelection(result, searchType) {
    const inputField = document.getElementById(searchType === 'destination' ? 'destinationLocation' : 'pickupLocation');
    
    if (inputField) {
        inputField.value = result.display_name;
    }
    
    hideSearchSuggestions(searchType);
    
    // Update destination marker and fare estimate
    if (searchType === 'destination') {
        updateFareEstimate();
        updateDestinationMarker(
            parseFloat(result.lat),
            parseFloat(result.lon),
            result.display_name
        );
        
        if (userLocation) {
            drawRoute(
                userLocation.lat, userLocation.lng,
                parseFloat(result.lat), parseFloat(result.lon)
            );
        }
        
        selectedDestination = result;
        document.getElementById('requestRideBtn').disabled = false;
    }
}

// Update destination marker on map
function updateDestinationMarker(lat, lng, name) {
    if (destinationFeature) {
        vectorSource.removeFeature(destinationFeature);
    }
    
    destinationFeature = new ol.Feature({
        geometry: new ol.geom.Point(ol.proj.fromLonLat([lng, lat]))
    });
    
    destinationFeature.setStyle(new ol.style.Style({
        image: new ol.style.Circle({
            radius: 6,
            fill: new ol.style.Fill({color: '#E74C3C'}),
            stroke: new ol.style.Stroke({
                color: '#FFFFFF',
                width: 2
            })
        })
    }));
    
    vectorSource.addFeature(destinationFeature);
    
    // Fit map to show both pickup and destination
    if (pickupFeature && destinationFeature) {
        const extent = ol.extent.boundingExtent([
            pickupFeature.getGeometry().getCoordinates(),
            destinationFeature.getGeometry().getCoordinates()
        ]);
        mapView.fit(extent, {
            padding: [50, 50, 50, 50],
            duration: 500
        });
    }
}

// Draw route between two points
function drawRoute(startLat, startLng, endLat, endLng) {
    if (routeFeature) {
        vectorSource.removeFeature(routeFeature);
    }
    
    // Try OSRM routing
    fetch(`https://router.project-osrm.org/route/v1/driving/${startLng},${startLat};${endLng},${endLat}?overview=full&geometries=geojson`)
        .then(response => response.json())
        .then(data => {
            if (data.routes && data.routes.length > 0) {
                const route = data.routes[0];
                const coordinates = route.geometry.coordinates.map(coord => ol.proj.fromLonLat(coord));
                
                routeFeature = new ol.Feature({
                    geometry: new ol.geom.LineString(coordinates)
                });
                
                routeFeature.setStyle(new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: '#FF6B35',
                        width: 4,
                        lineDash: [10, 10]
                    })
                }));
                
                vectorSource.addFeature(routeFeature);
            }
        })
        .catch(error => {
            console.error('Error fetching route:', error);
            // Fallback to straight line
            const coordinates = [
                ol.proj.fromLonLat([startLng, startLat]),
                ol.proj.fromLonLat([endLng, endLat])
            ];
            
            routeFeature = new ol.Feature({
                geometry: new ol.geom.LineString(coordinates)
            });
            
            routeFeature.setStyle(new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: '#FF6B35',
                    width: 4,
                    lineDash: [10, 10]
                })
            }));
            
            vectorSource.addFeature(routeFeature);
        });
}

// Calculate distance between two coordinates
function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371e3; // Earth's radius in meters
    const 1 = lat1 * Math.PI / 180;
    const 2 = lat2 * Math.PI / 180;
    const  = (lat2 - lat1) * Math.PI / 180;
    const  = (lon2 - lon1) * Math.PI / 180;

    const a = Math.sin(/2) * Math.sin(/2) +
              Math.cos(1) * Math.cos(2) *
              Math.sin(/2) * Math.sin(/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

    return R * c;
}

// Update fare estimate based on selected ride type
function updateFareEstimate() {
    const destination = document.getElementById('destinationLocation').value;
    
    if (!destination || destination.length < 3 || !userLocation) {
        document.getElementById('estimatedFare').textContent = 'K0.00';
        document.getElementById('etaDisplay').textContent = 'ETA: -- min';
        document.getElementById('requestRideBtn').disabled = true;
        return;
    }
    
    // Show calculating message
    document.getElementById('estimatedFare').textContent = 'Calculating...';
    document.getElementById('etaDisplay').textContent = 'Estimating...';
    
    // Forward geocode destination
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(destination)}&limit=1`)
        .then(response => response.json())
        .then(results => {
            if (results.length > 0) {
                const destLat = parseFloat(results[0].lat);
                const destLng = parseFloat(results[0].lon);
                
                const distance = calculateDistance(
                    userLocation.lat, userLocation.lng,
                    destLat, destLng
                );
                
                const distanceKm = distance / 1000;
                
                // Calculate fare based on ride type
                const rideConfig = rideTypeConfig[selectedRideType];
                let baseFare = rideConfig.baseFare;
                
                // Add distance-based fare: K5 per km
                if (distanceKm > 0) {
                    baseFare += Math.ceil(distanceKm * 5 * rideConfig.multiplier);
                }
                
                // Apply promo code discount if any
                if (appliedPromoCode) {
                    baseFare = baseFare * 0.8; // 20% discount for promo codes
                }
                
                // Ensure minimum fare
                baseFare = Math.max(15, baseFare);
                
                // Update UI
                document.getElementById('estimatedFare').textContent = `K${baseFare.toFixed(2)}`;
                
                // Calculate ETA: Assume average speed of 30km/h in city
                const etaMinutes = Math.ceil((distanceKm / 30) * 60);
                document.getElementById('etaDisplay').textContent = `ETA: ${etaMinutes} min`;
                
                document.getElementById('requestRideBtn').disabled = false;
                
                // Store fare for later use
                rideFare = baseFare;
            } else {
                document.getElementById('estimatedFare').textContent = 'K0.00';
                document.getElementById('etaDisplay').textContent = 'ETA: -- min';
                document.getElementById('requestRideBtn').disabled = true;
            }
        })
        .catch(error => {
            console.error('Error calculating fare:', error);
            document.getElementById('estimatedFare').textContent = 'K0.00';
            document.getElementById('etaDisplay').textContent = 'ETA: -- min';
            document.getElementById('requestRideBtn').disabled = true;
        });
}

// Request ride function
function requestRide() {
    const pickupLocation = document.getElementById('pickupLocation').value;
    const destinationLocation = document.getElementById('destinationLocation').value;
    
    if (!destinationLocation) {
        showNotification('Please enter a destination');
        return;
    }
    
    if (!userLocation) {
        showNotification('Unable to determine your location. Please try again.');
        return;
    }
    
    // Get full addresses for both locations
    Promise.all([
        getFullAddress(userLocation.lat, userLocation.lng),
        forwardGeocode(destinationLocation)
    ]).then(([fullPickupAddress, destinationResults]) => {
        if (destinationResults.length === 0) {
            showNotification('Invalid destination address. Please select a valid destination.');
            return;
        }
        
        const destLat = parseFloat(destinationResults[0].lat);
        const destLng = parseFloat(destinationResults[0].lon);
        
        const distance = calculateDistance(
            userLocation.lat, userLocation.lng,
            destLat, destLng
        );
        const distanceKm = distance / 1000;
        
        // Calculate fare
        const rideConfig = rideTypeConfig[selectedRideType];
        let baseFare = rideConfig.baseFare;
        
        if (distanceKm > 0) {
            baseFare += Math.ceil(distanceKm * 5 * rideConfig.multiplier);
        }
        
        if (appliedPromoCode) {
            baseFare = baseFare * 0.8;
        }
        
        baseFare = Math.max(15, baseFare);
        
        const rideId = database.ref().child('rides').push().key;
        
        const rideRequest = {
            id: rideId,
            passengerId: currentUser.uid,
            passengerName: userData.name || 'Passenger',
            passengerPhone: userData.phone || 'Not provided',
            pickupLocation: fullPickupAddress,
            pickupDisplayLocation: pickupLocation,
            destination: destinationResults[0].display_name || destinationLocation,
            pickupLat: userLocation.lat,
            pickupLng: userLocation.lng,
            destLat: destLat,
            destLng: destLng,
            rideType: selectedRideType,
            fare: baseFare,
            distance: distanceKm.toFixed(2) + ' km',
            status: 'requested',
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            updatedAt: firebase.database.ServerValue.TIMESTAMP,
            promoCode: appliedPromoCode,
            paymentMethod: selectedPaymentType,
            currentCity: currentCity,
            emergencyDetails: emergencyDetails
        };
        
        currentRideRequestData = rideRequest;
        
        showPaymentSelection(baseFare);
    }).catch(error => {
        console.error('Error in ride request process:', error);
        showNotification('Error calculating route. Please try again.');
    });
}

// Show payment selection
function showPaymentSelection(fare) {
    const calculatedFare = fare || rideFare;
    
    document.getElementById('paymentWalletBalance').textContent = `Balance: K${walletBalance.toFixed(2)}`;
    
    if (walletBalance < calculatedFare && selectedPaymentType === 'wallet') {
        document.getElementById('insufficientBalance').style.display = 'block';
        document.getElementById('confirmPaymentBtn').disabled = true;
    } else {
        document.getElementById('insufficientBalance').style.display = 'none';
        document.getElementById('confirmPaymentBtn').disabled = false;
    }
    
    document.getElementById('paymentSelectionPopup').classList.remove('hidden');
}

// Submit ride request after payment confirmation
function submitRideRequest() {
    if (!currentRideRequestData) {
        showNotification('No ride request data found. Please try again.');
        return;
    }
    
    const rideRequest = currentRideRequestData;
    
    if (selectedPaymentType === 'wallet') {
        const newBalance = walletBalance - rideRequest.fare;
        
        if (newBalance < 0) {
            showNotification('Insufficient wallet balance. Please select another payment method.');
            return;
        }
        
        database.ref('users/' + currentUser.uid).update({
            walletBalance: newBalance
        })
        .then(() => {
            walletBalance = newBalance;
            updateWalletBalanceUI();
            
            return database.ref('rides/' + rideRequest.id).set(rideRequest);
        })
        .then(() => {
            currentRide = rideRequest;
            
            closePaymentSelection();
            updateUIForActiveRide();
            
            document.getElementById('searchingAnimation').style.display = 'flex';
            document.getElementById('rideStatus').style.display = 'flex';
            document.getElementById('statusDot').className = 'status-dot searching';
            document.getElementById('statusText').textContent = 'Searching for driver';
            
            if (sosConfig && sosConfig.contact1) {
                document.getElementById('sosButton').style.display = 'flex';
            }
            
            showNotification('Ride requested. Searching for a driver...');
            
            listenForDriverAssignment(rideRequest.id);
            
            // Handle referral code if applied
            if (appliedPromoCode && appliedPromoCode.startsWith('JUBEL-')) {
                handleReferralCode(rideRequest.id);
            }
        })
        .catch(error => {
            console.error('Error requesting ride:', error);
            showNotification('Error requesting ride. Please try again.');
        });
    } else {
        database.ref('rides/' + rideRequest.id).set(rideRequest)
            .then(() => {
                currentRide = rideRequest;
                
                closePaymentSelection();
                updateUIForActiveRide();
                
                document.getElementById('searchingAnimation').style.display = 'flex';
                document.getElementById('rideStatus').style.display = 'flex';
                document.getElementById('statusDot').className = 'status-dot searching';
                document.getElementById('statusText').textContent = 'Searching for driver';
                
                if (sosConfig && sosConfig.contact1) {
                    document.getElementById('sosButton').style.display = 'flex';
                }
                
                showNotification('Ride requested. Searching for a driver...');
                
                listenForDriverAssignment(rideRequest.id);
                
                // Handle referral code if applied
                if (appliedPromoCode && appliedPromoCode.startsWith('JUBEL-')) {
                    handleReferralCode(rideRequest.id);
                }
            })
            .catch(error => {
                console.error('Error requesting ride:', error);
                showNotification('Error requesting ride. Please try again.');
            });
    }
    
    currentRideRequestData = null;
}

// Handle referral code application
function handleReferralCode(rideId) {
    database.ref('users').orderByChild('referralCode').equalTo(appliedPromoCode).once('value')
        .then(snapshot => {
            if (snapshot.exists()) {
                const referrerData = snapshot.val();
                const referrerId = Object.keys(referrerData)[0];
                const referrer = referrerData[referrerId];
                
                // Store referral relationship but don't pay yet
                database.ref('referrals').push().set({
                    referrerId: referrerId,
                    referredUserId: currentUser.uid,
                    referralCode: appliedPromoCode,
                    rideId: rideId,
                    status: 'pending',
                    discountApplied: true,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                
                console.log(`Referral recorded for ${referrer.name}. Reward will be paid after ride completion.`);
            }
        })
        .catch(error => {
            console.error('Error handling referral code:', error);
        });
}

// Complete referral reward when ride is completed
function completeReferralReward(rideId) {
    database.ref('referrals').orderByChild('rideId').equalTo(rideId).once('value')
        .then(snapshot => {
            const referrals = snapshot.val();
            if (referrals) {
                const referralKey = Object.keys(referrals)[0];
                const referral = referrals[referralKey];
                
                if (referral.status === 'pending') {
                    // Update referral status
                    database.ref('referrals/' + referralKey).update({
                        status: 'completed',
                        completedAt: firebase.database.ServerValue.TIMESTAMP
                    });
                    
                    // Reward the referrer
                    database.ref('users/' + referral.referrerId).once('value')
                        .then(referrerSnapshot => {
                            const referrer = referrerSnapshot.val();
                            if (referrer) {
                                const newBalance = (referrer.walletBalance || 0) + 25;
                                return database.ref('users/' + referral.referrerId).update({
                                    walletBalance: newBalance
                                });
                            }
                        })
                        .then(() => {
                            console.log(`Rewarded referral for ride ${rideId}`);
                        });
                }
            }
        })
        .catch(error => {
            console.error('Error completing referral reward:', error);
        });
}

// Listen for driver assignment
function listenForDriverAssignment(rideId) {
    if (driverAssignmentListener) {
        driverAssignmentListener();
    }
    
    driverAssignmentListener = database.ref('rides/' + rideId).on('value', snapshot => {
        const ride = snapshot.val();
        if (!ride) return;
        
        if (ride.driverId && ride.status === 'accepted') {
            handleDriverAssignment(ride);
        } else if (ride.status === 'completed') {
            showRideCompletion(ride);
            completeReferralReward(rideId);
        } else if (ride.status === 'cancelled') {
            handleRideCancellation(ride);
        }
    });
}

// Handle driver assignment
function handleDriverAssignment(ride) {
    document.getElementById('searchingAnimation').style.display = 'none';
    document.getElementById('statusDot').className = 'status-dot arriving';
    document.getElementById('statusText').textContent = 'Driver arriving';
    document.getElementById('estimatedTime').style.display = 'flex';
    document.getElementById('timeText').textContent = '5 min';
    
    loadDriverDetails(ride.driverId);
    
    if (ride.driverLat && ride.driverLng) {
        addDriverMarker(ride.driverLat, ride.driverLng);
        drawRoute(ride.driverLat, ride.driverLng, ride.pickupLat, ride.pickupLng);
        trackDriverLocation(ride.driverId);
    }
    
    showNotification(`Driver ${ride.driverName || 'is'} on the way!`);
    listenForRideStatusUpdates(ride.id);
}

// Add driver marker to map
function addDriverMarker(lat, lng) {
    if (driverFeature) {
        vectorSource.removeFeature(driverFeature);
    }
    
    driverFeature = new ol.Feature({
        geometry: new ol.geom.Point(ol.proj.fromLonLat([lng, lat]))
    });
    
    driverFeature.setStyle(new ol.style.Style({
        image: new ol.style.Icon({
            src: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png',
            scale: 1.5
        })
    }));
    
    vectorSource.addFeature(driverFeature);
}

// Track driver location updates
function trackDriverLocation(driverId) {
    if (driverLocationListener) {
        driverLocationListener();
    }
    
    driverLocationListener = database.ref('driverLocations/' + driverId).on('value', snapshot => {
        const location = snapshot.val();
        if (location && driverFeature) {
            driverFeature.getGeometry().setCoordinates(ol.proj.fromLonLat([location.longitude, location.latitude]));
            updateDriverETA(location.latitude, location.longitude);
        }
    });
}

// Update driver ETA
function updateDriverETA(driverLat, driverLng) {
    if (userLocation) {
        const distance = calculateDistance(driverLat, driverLng, userLocation.lat, userLocation.lng);
        const etaMinutes = Math.ceil((distance / 1000) / 30 * 60);
        document.getElementById('timeText').textContent = `${etaMinutes} min`;
    }
}

// Load driver details
function loadDriverDetails(driverId) {
    database.ref('users/' + driverId).once('value')
        .then(driverSnapshot => {
            const driver = driverSnapshot.val();
            if (driver) {
                updateDriverUI(driver);
                updateDriverDetailsCard(driver);
            }
        })
        .catch(error => {
            console.error('Error loading driver details:', error);
        });
}

// Update driver UI
function updateDriverUI(driver) {
    document.getElementById('driverName').textContent = driver.name || 'Driver';
    document.getElementById('driverPhone').textContent = driver.phone || 'N/A';
    document.getElementById('driverRating').textContent = driver.rating ? `${driver.rating} ` : '4.5 ';
    
    if (driver.vehicle) {
        document.getElementById('vehicleDetails').textContent = 
            `${driver.vehicle.type || 'Vehicle'} - ${driver.vehicle.licensePlate || 'ABC123'}`;
    }
    
    const driverAvatar = document.getElementById('driverAvatar');
    if (driver.name) {
        driverAvatar.innerHTML = driver.name.charAt(0).toUpperCase();
    }
}

// Update driver details card
function updateDriverDetailsCard(driver) {
    const driverDetailsCard = document.getElementById('driverDetailsCard');
    if (driverDetailsCard) {
        driverDetailsCard.style.display = 'block';
        
        document.getElementById('driverFullName').textContent = driver.name || 'Driver';
        document.getElementById('driverContactPhone').textContent = driver.phone || 'Not available';
        document.getElementById('driverRatingValue').textContent = driver.rating ? `${driver.rating} ` : '4.5 ';
        document.getElementById('driverExperience').textContent = driver.experience || '2 years';
        
        if (driver.vehicle) {
            document.getElementById('vehicleType').textContent = driver.vehicle.type || 'Car';
            document.getElementById('vehicleModel').textContent = driver.vehicle.model || 'Not specified';
            document.getElementById('vehicleLicense').textContent = driver.vehicle.licensePlate || 'Not available';
            document.getElementById('vehicleColor').textContent = driver.vehicle.color || 'Not specified';
        }
    }
}

// Update UI for active ride
function updateUIForActiveRide() {
    if (!currentRide) return;
    
    document.getElementById('rideRequestForm').style.display = 'none';
    document.getElementById('rideInfoPanel').style.display = 'block';
    
    document.getElementById('currentPickupLocation').textContent = currentRide.pickupDisplayLocation || currentRide.pickupLocation;
    document.getElementById('currentDestinationLocation').textContent = currentRide.destination;
    
    const baseFare = currentRide.fare || 0;
    const discount = appliedPromoCode ? baseFare * 0.2 : 0;
    const totalFare = baseFare - discount;
    
    document.getElementById('baseFare').textContent = `K${baseFare.toFixed(2)}`;
    document.getElementById('discountFare').textContent = `-K${discount.toFixed(2)}`;
    document.getElementById('totalFare').textContent = `K${totalFare.toFixed(2)}`;
    
    if (currentRide.driverId) {
        loadDriverDetails(currentRide.driverId);
    }
}

// Reset UI after ride
function resetUIAfterRide() {
    document.getElementById('rideRequestForm').style.display = 'flex';
    document.getElementById('rideInfoPanel').style.display = 'none';
    document.getElementById('driverDetailsCard').style.display = 'none';
    document.getElementById('destinationLocation').value = '';
    document.getElementById('addressBreakdown').classList.remove('active');
    
    document.getElementById('promoCode').value = '';
    appliedPromoCode = null;
    document.getElementById('promoSection').classList.remove('active');
    
    if (driverFeature) {
        vectorSource.removeFeature(driverFeature);
        driverFeature = null;
    }
    
    if (destinationFeature) {
        vectorSource.removeFeature(destinationFeature);
        destinationFeature = null;
    }
    
    if (routeFeature) {
        vectorSource.removeFeature(routeFeature);
        routeFeature = null;
    }
    
    if (driverLocationListener) {
        driverLocationListener();
        driverLocationListener = null;
    }
    
    currentRide = null;
    emergencyDetails = {};
    selectedRideType = 'standard';
    document.getElementById('rideTypeSelection').style.display = 'none';
}

// Refresh passenger position
function refreshPassengerPosition() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            updatePickupLocation(lat, lng);
            
            determineCurrentCity(lat, lng).then(city => {
                currentCity = city;
                showNotification(`Location detected in ${city}`);
            });
            
            if (!locationWatchId) {
                startLocationTracking();
            }
        }, error => {
            console.error('Geolocation error:', error);
            handleGeolocationError(error);
        });
    }
}

// Start location tracking
function startLocationTracking() {
    if (navigator.geolocation) {
        locationWatchId = navigator.geolocation.watchPosition(position => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            userLocation = { lat, lng };
            
            if (currentLocationFeature) {
                currentLocationFeature.getGeometry().setCoordinates(ol.proj.fromLonLat([lng, lat]));
            }
            
            if (pickupFeature) {
                pickupFeature.getGeometry().setCoordinates(ol.proj.fromLonLat([lng, lat]));
            }
            
            if (currentUser) {
                database.ref('passengerLocations/' + currentUser.uid).set({
                    latitude: lat,
                    longitude: lng,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
            }
        });
    }
}

// Determine current city
function determineCurrentCity(lat, lng) {
    return new Promise((resolve, reject) => {
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=10&addressdetails=1`)
            .then(response => response.json())
            .then(data => {
                if (data && data.address) {
                    const city = data.address.city || data.address.town || data.address.village || "Unknown Location";
                    resolve(city);
                } else {
                    resolve("Unknown Location");
                }
            })
            .catch(error => {
                console.error('Error detecting city:', error);
                resolve("Unknown Location");
            });
    });
}

// Get full address for ride submission
function getFullAddress(lat, lng) {
    return new Promise((resolve, reject) => {
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=16&addressdetails=1`)
            .then(response => response.json())
            .then(data => {
                if (data && data.display_name) {
                    resolve(data.display_name);
                } else {
                    resolve(`${lat.toFixed(6)}, ${lng.toFixed(6)}`);
                }
            })
            .catch(error => {
                console.error('Full address geocoding error:', error);
                resolve(`${lat.toFixed(6)}, ${lng.toFixed(6)}`);
            });
    });
}

// Forward geocode function
function forwardGeocode(query) {
    return new Promise(resolve => {
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`)
            .then(response => response.json())
            .then(data => {
                resolve(data || []);
            })
            .catch(error => {
                console.error('Forward geocoding error:', error);
                resolve([]);
            });
    });
}

// Hide search suggestions
function hideSearchSuggestions(searchType) {
    const suggestionsContainer = document.getElementById(`${searchType}Suggestions`);
    if (suggestionsContainer) {
        suggestionsContainer.style.display = 'none';
    }
}

// Show no results message
function showNoResultsMessage(searchType) {
    const suggestionsContainer = document.getElementById(`${searchType}Suggestions`);
    if (suggestionsContainer) {
        suggestionsContainer.innerHTML = '<div class="no-places">No places found. Try a different search term.</div>';
    }
}

// Close payment selection
function closePaymentSelection() {
    document.getElementById('paymentSelectionPopup').classList.add('hidden');
}

// Cancel ride
function cancelRide() {
    if (currentRide && confirm('Are you sure you want to cancel this ride?')) {
        database.ref('rides/' + currentRide.id).update({
            status: 'cancelled',
            cancelledAt: firebase.database.ServerValue.TIMESTAMP,
            updatedAt: firebase.database.ServerValue.TIMESTAMP
        })
        .then(() => {
            resetUIAfterRide();
            showNotification('Ride cancelled');
        })
        .catch(error => {
            console.error('Error cancelling ride:', error);
            showNotification('Error cancelling ride. Please try again.');
        });
    }
}

// Contact driver
function contactDriver() {
    if (currentRide && currentRide.driverId) {
        database.ref('users/' + currentRide.driverId).once('value')
            .then(snapshot => {
                const driver = snapshot.val();
                if (driver && driver.phone) {
                    showNotification(`Calling driver: ${driver.phone}`);
                    window.open(`tel:${driver.phone}`, '_self');
                } else {
                    showNotification('Driver phone number not available.');
                }
            });
    }
}

// Apply promo code
function applyPromoCode() {
    const promoCode = document.getElementById('promoCode').value.trim();
    
    if (!promoCode) {
        showNotification('Please enter a promo code.');
        return;
    }
    
    if (promoCode.startsWith('JUBEL-')) {
        database.ref('users').orderByChild('referralCode').equalTo(promoCode).once('value')
            .then(snapshot => {
                if (snapshot.exists()) {
                    appliedPromoCode = promoCode;
                    showNotification('Referral code applied! 50% discount will be applied to your ride.');
                    updateFareEstimate();
                    
                    document.getElementById('promoCode').style.borderColor = 'var(--success-green)';
                    document.getElementById('applyPromoBtn').innerHTML = '<i class="fas fa-check"></i> Applied';
                } else {
                    showNotification('Invalid referral code. Please check and try again.');
                    document.getElementById('promoCode').style.borderColor = 'var(--error-red)';
                }
            })
            .catch(error => {
                console.error('Error applying promo code:', error);
                showNotification('Error applying promo code. Please try again.');
            });
    } else {
        showNotification('Invalid promo code format. Referral codes start with JUBEL-');
        document.getElementById('promoCode').style.borderColor = 'var(--error-red)';
    }
}

// Load passenger data
function loadPassengerData() {
    if (currentUser) {
        updateUserStats();
    }
}

// Update user stats
function updateUserStats() {
    if (!currentUser) return;
    
    database.ref('rides').orderByChild('passengerId').equalTo(currentUser.uid).once('value')
        .then(snapshot => {
            const rides = snapshot.val();
            if (rides) {
                const ridesArray = Object.values(rides);
                
                userStats = {
                    completed: ridesArray.filter(ride => ride.status === 'completed' || ride.status === 'paid').length,
                    cancelled: ridesArray.filter(ride => ride.status === 'cancelled').length,
                    pending: ridesArray.filter(ride => ride.status === 'requested' || ride.status === 'accepted').length
                };
                
                document.getElementById('ridesCompleted').textContent = userStats.completed;
                document.getElementById('ridesCancelled').textContent = userStats.cancelled;
                document.getElementById('ridesPending').textContent = userStats.pending;
            }
        });
}

// Load account data
function loadAccountData() {
    if (currentUser && userData) {
        document.getElementById('accountName').textContent = userData.name || 'Passenger';
        document.getElementById('accountPhone').textContent = userData.phone || 'Not set';
        document.getElementById('accountEmail').textContent = userData.email || 'Not set';
        document.getElementById('referralCode').textContent = userData.referralCode || 'JUBEL-XXXX';
        
        walletBalance = userData.walletBalance || 0;
        document.getElementById('accountBalance').textContent = `K${walletBalance.toFixed(2)}`;
        
        const accountAvatar = document.getElementById('accountAvatar');
        if (userData.name) {
            accountAvatar.textContent = userData.name.charAt(0).toUpperCase();
        }
    }
}

// Share referral code
function shareReferralCode() {
    const referralCode = document.getElementById('referralCode').textContent;
    const shareText = `Join me on Jubel! Use my referral code ${referralCode} for 50% off your first ride. Download the app now!`;
    
    if (navigator.share) {
        navigator.share({
            title: 'Jubel Referral',
            text: shareText,
            url: window.location.href
        })
        .then(() => showNotification('Referral code shared successfully!'))
        .catch(error => console.error('Error sharing:', error));
    } else {
        navigator.clipboard.writeText(shareText)
            .then(() => showNotification('Referral code copied to clipboard!'));
    }
}

// Deposit to wallet
function depositToWallet() {
    const amount = prompt('Enter deposit amount (K):');
    if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
        const depositAmount = parseFloat(amount);
        const newBalance = walletBalance + depositAmount;
        
        database.ref('users/' + currentUser.uid).update({
            walletBalance: newBalance
        })
        .then(() => {
            walletBalance = newBalance;
            updateWalletBalanceUI();
            showNotification(`Successfully deposited K${depositAmount.toFixed(2)} to your wallet.`);
        })
        .catch(error => {
            console.error('Error depositing to wallet:', error);
            showNotification('Error processing deposit. Please try again.');
        });
    } else if (amount) {
        showNotification('Please enter a valid amount.');
    }
}

// Withdraw from wallet
function withdrawFromWallet() {
    if (walletBalance <= 0) {
        showNotification('Your wallet balance is zero.');
        return;
    }
    
    const amount = prompt(`Enter withdrawal amount (K). Available: K${walletBalance.toFixed(2)}:`);
    if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
        const withdrawalAmount = parseFloat(amount);
        
        if (withdrawalAmount > walletBalance) {
            showNotification('Insufficient balance for this withdrawal.');
            return;
        }
        
        const newBalance = walletBalance - withdrawalAmount;
        
        database.ref('users/' + currentUser.uid).update({
            walletBalance: newBalance
        })
        .then(() => {
            walletBalance = newBalance;
            updateWalletBalanceUI();
            showNotification(`Successfully withdrew K${withdrawalAmount.toFixed(2)} from your wallet.`);
        })
        .catch(error => {
            console.error('Error withdrawing from wallet:', error);
            showNotification('Error processing withdrawal. Please try again.');
        });
    } else if (amount) {
        showNotification('Please enter a valid amount.');
    }
}

// Contact WhatsApp
function contactWhatsApp() {
    const phoneNumber = '0768658484';
    const message = 'Hello, I need assistance with Jubel rides.';
    const url = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
    window.open(url, '_blank');
}

// Contact phone
function contactPhone() {
    const phoneNumber = '0768658484';
    window.open(`tel:${phoneNumber}`, '_self');
}

// Load SOS config
function loadSOSConfig(uid) {
    database.ref('sosConfig/' + uid).once('value')
        .then(snapshot => {
            sosConfig = snapshot.val();
        })
        .catch(error => {
            console.error('Error loading SOS config:', error);
        });
}

// Check for active ride
function checkActiveRide(uid) {
    database.ref('rides').orderByChild('passengerId').equalTo(uid).once('value')
        .then(snapshot => {
            const rides = snapshot.val();
            if (rides) {
                const rideEntries = Object.entries(rides);
                
                for (const [rideId, ride] of rideEntries) {
                    if (ride.status !== 'completed' && ride.status !== 'cancelled' && ride.status !== 'requested') {
                        restoreActiveRide(rideId, ride);
                        return;
                    }
                }
            }
        })
        .catch(error => {
            console.error('Error checking active ride:', error);
        });
}

// Restore active ride
function restoreActiveRide(rideId, ride) {
    currentRide = {
        id: rideId,
        ...ride
    };
    
    updateUIForActiveRide();
    
    if (ride.status === 'requested' && !ride.driverId) {
        document.getElementById('searchingAnimation').style.display = 'flex';
        document.getElementById('rideStatus').style.display = 'flex';
        document.getElementById('statusDot').className = 'status-dot searching';
        document.getElementById('statusText').textContent = 'Searching for driver';
        
        listenForDriverAssignment(rideId);
    } 
    else if (ride.driverId && (ride.status === 'accepted' || ride.status === 'arrived' || ride.status === 'started')) {
        handleDriverAssignment(ride);
        updateRideStatusDisplay(ride.status);
        
        if (ride.driverId) {
            trackDriverLocation(ride.driverId);
        }
        
        if (sosConfig && sosConfig.contact1) {
            document.getElementById('sosButton').style.display = 'flex';
        }
    }
    
    showNotification('Active ride restored');
}

// Update ride status display
function updateRideStatusDisplay(status) {
    switch(status) {
        case 'accepted':
            document.getElementById('statusText').textContent = 'Driver on the way';
            break;
        case 'arrived':
            document.getElementById('statusText').textContent = 'Driver arrived';
            break;
        case 'started':
            document.getElementById('statusText').textContent = 'Trip in progress';
            break;
    }
}

// Listen for ride status updates
function listenForRideStatusUpdates(rideId) {
    database.ref('rides/' + rideId).on('value', snapshot => {
        const ride = snapshot.val();
        if (ride) {
            currentRide = ride;
            
            switch(ride.status) {
                case 'accepted':
                    document.getElementById('statusText').textContent = 'Driver on the way';
                    break;
                case 'arrived':
                    document.getElementById('statusText').textContent = 'Driver arrived';
                    document.getElementById('statusDot').className = 'status-dot riding';
                    showNotification('Your driver has arrived!');
                    break;
                case 'started':
                    document.getElementById('statusText').textContent = 'Trip in progress';
                    break;
                case 'completed':
                    document.getElementById('statusText').textContent = 'Trip completed';
                    document.getElementById('rideStatus').style.display = 'none';
                    document.getElementById('estimatedTime').style.display = 'none';
                    document.getElementById('sosButton').style.display = 'none';
                    resetUIAfterRide();
                    showRatingPopup(ride);
                    showNotification('Trip completed. Thank you for using Jubel!');
                    break;
                case 'cancelled':
                    document.getElementById('rideStatus').style.display = 'none';
                    document.getElementById('estimatedTime').style.display = 'none';
                    document.getElementById('sosButton').style.display = 'none';
                    resetUIAfterRide();
                    showNotification('Ride cancelled');
                    break;
            }
        }
    });
}

// Handle ride cancellation
function handleRideCancellation(ride) {
    document.getElementById('searchingAnimation').style.display = 'none';
    showNotification('Ride has been cancelled.');
    resetUIAfterRide();
    currentRide = null;
    
    if (driverFeature) {
        vectorSource.removeFeature(driverFeature);
        driverFeature = null;
    }
    
    if (driverAssignmentListener) {
        driverAssignmentListener();
        driverAssignmentListener = null;
    }
    
    if (driverLocationListener) {
        driverLocationListener();
        driverLocationListener = null;
    }
}

// Show ride completion
function showRideCompletion(ride) {
    document.getElementById('searchingAnimation').style.display = 'none';
    document.getElementById('rideStatus').style.display = 'none';
    document.getElementById('estimatedTime').style.display = 'none';
    document.getElementById('sosButton').style.display = 'none';
    resetUIAfterRide();
    showRatingPopup(ride);
    showNotification('Ride completed. Please complete payment and rating.');
}

// Show rating popup
function showRatingPopup(ride) {
    if (!document.getElementById('ratingPopup')) {
        createRatingPopup();
    }
    
    document.getElementById('ratingPopup').setAttribute('data-ride-id', ride.id);
    document.getElementById('ratingDriverName').textContent = ride.driverName || 'Driver';
    document.getElementById('ratingVehicleInfo').textContent = 
        `${ride.driverVehicle?.type || 'Vehicle'} - ${ride.driverVehicle?.licensePlate || 'N/A'}`;
    
    resetRatingStars();
    document.getElementById('ratingPopup').classList.remove('hidden');
}

// Create rating popup
function createRatingPopup() {
    const ratingPopup = document.createElement('div');
    ratingPopup.id = 'ratingPopup';
    ratingPopup.className = 'popup-overlay hidden';
    ratingPopup.innerHTML = `
        <div class="popup-form" style="max-width: 400px;">
            <div class="popup-header">
                <h2 class="popup-title">
                    <i class="fas fa-star"></i>
                    Rate Your Driver
                </h2>
                <button class="close-popup" id="closeRatingPopup">&times;</button>
            </div>
            <div class="popup-content">
                <div class="rating-driver-info" style="text-align: center; margin-bottom: 20px;">
                    <div class="driver-avatar" id="ratingDriverAvatar" style="width: 60px; height: 60px; margin: 0 auto 10px; background: var(--primary-orange); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white;">
                        <i class="fas fa-user"></i>
                    </div>
                    <h3 id="ratingDriverName" style="margin-bottom: 5px;">Driver Name</h3>
                    <p id="ratingVehicleInfo" style="color: var(--medium-gray); font-size: 0.9rem;">Vehicle Info</p>
                </div>
                
                <div class="rating-stars-container" style="text-align: center; margin: 20px 0;">
                    <div class="rating-stars" id="ratingStars">
                        <span class="star" data-rating="1"><i class="far fa-star"></i></span>
                        <span class="star" data-rating="2"><i class="far fa-star"></i></span>
                        <span class="star" data-rating="3"><i class="far fa-star"></i></span>
                        <span class="star" data-rating="4"><i class="far fa-star"></i></span>
                        <span class="star" data-rating="5"><i class="far fa-star"></i></span>
                    </div>
                    <div id="ratingText" style="margin-top: 10px; font-size: 0.9rem; color: var(--medium-gray);">Tap to rate</div>
                </div>
                
                <div class="rating-comment" style="margin-bottom: 20px;">
                    <label for="ratingComment" style="display: block; margin-bottom: 8px; font-weight: 600;">Additional Comments (Optional)</label>
                    <textarea id="ratingComment" placeholder="How was your ride experience?" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: var(--element-radius); resize: vertical; min-height: 80px;"></textarea>
                </div>
                
                <button id="submitRatingBtn" class="request-ride-btn" style="width: 100%;">
                    <i class="fas fa-paper-plane"></i> Submit Rating
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(ratingPopup);
    
    document.getElementById('closeRatingPopup').addEventListener('click', closeRatingPopup);
    document.getElementById('submitRatingBtn').addEventListener('click', submitRating);
    
    const stars = document.querySelectorAll('#ratingStars .star');
    stars.forEach(star => {
        star.addEventListener('click', function() {
            const rating = parseInt(this.getAttribute('data-rating'));
            setRatingStars(rating);
        });
    });
}

// Set rating stars
function setRatingStars(rating) {
    const stars = document.querySelectorAll('#ratingStars .star');
    const ratingText = document.getElementById('ratingText');
    
    stars.forEach((star, index) => {
        if (index < rating) {
            star.innerHTML = '<i class="fas fa-star"></i>';
            star.style.color = '#FFD700';
        } else {
            star.innerHTML = '<i class="far fa-star"></i>';
            star.style.color = '#CCCCCC';
        }
    });
    
    const ratingTexts = {
        1: 'Poor',
        2: 'Fair',
        3: 'Good',
        4: 'Very Good',
        5: 'Excellent'
    };
    
    ratingText.textContent = ratingTexts[rating] || 'Tap to rate';
    ratingText.style.color = '#FF6B35';
    document.getElementById('ratingStars').setAttribute('data-current-rating', rating);
}

// Reset rating stars
function resetRatingStars() {
    const stars = document.querySelectorAll('#ratingStars .star');
    const ratingText = document.getElementById('ratingText');
    
    stars.forEach(star => {
        star.innerHTML = '<i class="far fa-star"></i>';
        star.style.color = '#CCCCCC';
    });
    
    ratingText.textContent = 'Tap to rate';
    ratingText.style.color = 'var(--medium-gray)';
    document.getElementById('ratingStars').setAttribute('data-current-rating', '0');
}

// Submit rating
function submitRating() {
    const rideId = document.getElementById('ratingPopup').getAttribute('data-ride-id');
    const rating = parseInt(document.getElementById('ratingStars').getAttribute('data-current-rating') || '0');
    const comment = document.getElementById('ratingComment').value.trim();
    
    if (rating === 0) {
        showNotification('Please select a rating');
        return;
    }
    
    if (!rideId || !currentRide || !currentRide.driverId) {
        showNotification('Error submitting rating. Please try again.');
        return;
    }
    
    const ratingData = {
        rideId: rideId,
        driverId: currentRide.driverId,
        passengerId: currentUser.uid,
        passengerName: userData.name || 'Passenger',
        rating: rating,
        comment: comment,
        timestamp: firebase.database.ServerValue.TIMESTAMP
    };
    
    database.ref('ratings').push(ratingData)
        .then(() => {
            updateDriverRating(currentRide.driverId, rating);
            showNotification('Thank you for your rating!');
            closeRatingPopup();
        })
        .catch(error => {
            console.error('Error submitting rating:', error);
            showNotification('Error submitting rating. Please try again.');
        });
}

// Update driver rating
function updateDriverRating(driverId, newRating) {
    database.ref('ratings').orderByChild('driverId').equalTo(driverId).once('value')
        .then(snapshot => {
            const ratings = snapshot.val();
            let totalRating = 0;
            let ratingCount = 0;
            
            if (ratings) {
                Object.values(ratings).forEach(rating => {
                    totalRating += rating.rating;
                    ratingCount++;
                });
            }
            
            totalRating += newRating;
            ratingCount++;
            
            const averageRating = totalRating / ratingCount;
            return database.ref('users/' + driverId + '/stats/rating').set(averageRating.toFixed(1));
        })
        .catch(error => {
            console.error('Error updating driver rating:', error);
        });
}

// Close rating popup
function closeRatingPopup() {
    document.getElementById('ratingPopup').classList.add('hidden');
    document.getElementById('ratingComment').value = '';
    resetRatingStars();
}

// Load ride history
function loadRideHistory() {
    if (currentUser) {
        const filter = document.getElementById('historyFilter').value;
        const dateFilter = document.getElementById('historyDate').value;
        
        if (rideHistoryListener) {
            rideHistoryListener();
        }
        
        rideHistoryListener = database.ref('rides').orderByChild('passengerId').equalTo(currentUser.uid).on('value', snapshot => {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';
            
            const rides = snapshot.val();
            if (rides) {
                let ridesArray = Object.keys(rides).map(rideId => ({
                    id: rideId,
                    ...rides[rideId]
                }));
                
                if (filter !== 'all') {
                    if (['standard', 'premium', 'economy', 'emergency', 'ambulance', 'fire-truck'].includes(filter)) {
                        ridesArray = ridesArray.filter(ride => ride.rideType === filter);
                    } else {
                        ridesArray = ridesArray.filter(ride => ride.status === filter);
                    }
                }
                
                if (dateFilter) {
                    const filterDate = new Date(dateFilter);
                    ridesArray = ridesArray.filter(ride => {
                        const rideDate = new Date(ride.timestamp);
                        return rideDate.toDateString() === filterDate.toDateString();
                    });
                }
                
                ridesArray.sort((a, b) => b.timestamp - a.timestamp);
                
                if (ridesArray.length === 0) {
                    historyList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--medium-gray);">No rides found matching your criteria.</p>';
                    return;
                }
                
                ridesArray.forEach(ride => {
                    const historyItem = createHistoryItem(ride);
                    historyList.appendChild(historyItem);
                });
            } else {
                historyList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--medium-gray);">No ride history found.</p>';
            }
        }, error => {
            console.error('Error loading ride history:', error);
            historyList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--error-red);">Error loading ride history.</p>';
        });
    }
}

// Create history item
function createHistoryItem(ride) {
    const historyItem = document.createElement('div');
    historyItem.className = 'history-item';
    historyItem.setAttribute('data-ride-id', ride.id);
    
    const date = new Date(ride.timestamp);
    const formattedDate = date.toLocaleDateString();
    const formattedTime = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    const rideConfig = rideTypeConfig[ride.rideType] || rideTypeConfig.standard;
    const typeClass = ride.rideType;
    const typeText = rideConfig.name;
    
    let statusClass = 'history-item-status requested';
    let statusText = getStatusText(ride.status);
    
    if (ride.status === 'accepted' || ride.status === 'arrived' || ride.status === 'started') {
        statusClass = 'history-item-status in-progress';
    } else if (ride.status === 'completed' || ride.status === 'paid') {
        statusClass = 'history-item-status completed';
    } else if (ride.status === 'cancelled') {
        statusClass = 'history-item-status cancelled';
    }
    
    historyItem.innerHTML = `
        <div class="history-item-header">
            <span class="history-item-type ${typeClass}">${typeText}</span>
            <span class="history-item-date">${formattedDate} ${formattedTime}</span>
        </div>
        <div class="history-item-locations">
            <div class="history-location">
                <div class="history-location-icon history-location-pickup">
                    <i class="fas fa-map-marker-alt"></i>
                </div>
                <div class="history-location-text">
                    <div class="history-location-name">Pickup</div>
                    <div class="history-location-address">${ride.pickupDisplayLocation || ride.pickupLocation}</div>
                </div>
            </div>
            <div class="history-location">
                <div class="history-location-icon history-location-destination">
                    <i class="fas fa-flag"></i>
                </div>
                <div class="history-location-text">
                    <div class="history-location-name">Destination</div>
                    <div class="history-location-address">${ride.destination}</div>
                </div>
            </div>
        </div>
        <div class="history-item-footer">
            <div class="history-item-fare">K${ride.fare ? ride.fare.toFixed(2) : '0.00'}</div>
            <div class="${statusClass}">${statusText}</div>
        </div>
    `;
    
    historyItem.addEventListener('click', function() {
        showRideDetailsPopup(ride.id);
    });
    
    return historyItem;
}

// Get status text
function getStatusText(status) {
    const statusMap = {
        'requested': 'Awaiting Driver',
        'accepted': 'In Progress',
        'completed': 'Completed',
        'paid': 'Completed',
        'cancelled': 'Cancelled',
        'arrived': 'Driver Arrived',
        'started': 'Trip Started'
    };
    
    return statusMap[status] || status;
}

// Show ride details popup
function showRideDetailsPopup(rideId) {
    database.ref('rides/' + rideId).once('value')
        .then(snapshot => {
            const ride = snapshot.val();
            if (ride) {
                document.getElementById('popupRideType').textContent = rideTypeConfig[ride.rideType]?.name || 'Standard';
                document.getElementById('popupRidePickup').textContent = ride.pickupDisplayLocation || ride.pickupLocation;
                document.getElementById('popupRideDestination').textContent = ride.destination;
                document.getElementById('popupRideFare').textContent = `K${ride.fare ? ride.fare.toFixed(2) : '0.00'}`;
                document.getElementById('popupRideDistance').textContent = ride.distance || 'Calculating...';
                document.getElementById('popupRideStatus').textContent = getStatusText(ride.status);
                
                const date = new Date(ride.timestamp);
                document.getElementById('popupRideDate').textContent = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                updatePopupRideMap(ride);
                
                if (ride.driverId) {
                    database.ref('users/' + ride.driverId).once('value')
                        .then(driverSnapshot => {
                            const driver = driverSnapshot.val();
                            if (driver) {
                                document.getElementById('popupDriverName').textContent = driver.name || 'Driver';
                                document.getElementById('popupDriverPhone').textContent = driver.phone || 'N/A';
                                document.getElementById('popupDriverVehicle').textContent = `${driver.vehicleType || 'Car'} (${driver.licensePlate || 'N/A'})`;
                                document.getElementById('popupDriverRating').textContent = driver.rating || '4.5';
                                document.getElementById('popupDriverDetails').classList.remove('hidden');
                            }
                        });
                } else {
                    document.getElementById('popupDriverDetails').classList.add('hidden');
                }
                
                document.getElementById('rideDetailsPopup').classList.remove('hidden');
            }
        })
        .catch(error => {
            console.error('Error loading ride details:', error);
            showNotification('Error loading ride details.');
        });
}

// Update popup ride map
function updatePopupRideMap(ride) {
    if (!ride.pickupLat || !ride.pickupLng || !ride.destLat || !ride.destLng) return;
    
    // Clear existing features
    const popupVectorSource = new ol.source.Vector();
    const popupVectorLayer = new ol.layer.Vector({
        source: popupVectorSource
    });
    
    // Remove existing layers
    popupRideMap.getLayers().clear();
    popupRideMap.addLayer(new ol.layer.Tile({
        source: new ol.source.OSM()
    }));
    popupRideMap.addLayer(popupVectorLayer);
    
    // Add pickup marker
    const pickupFeature = new ol.Feature({
        geometry: new ol.geom.Point(ol.proj.fromLonLat([ride.pickupLng, ride.pickupLat]))
    });
    
    pickupFeature.setStyle(new ol.style.Style({
        image: new ol.style.Circle({
            radius: 6,
            fill: new ol.style.Fill({color: '#FF6B35'}),
            stroke: new ol.style.Stroke({
                color: '#FFFFFF',
                width: 2
            })
        })
    }));
    
    // Add destination marker
    const destFeature = new ol.Feature({
        geometry: new ol.geom.Point(ol.proj.fromLonLat([ride.destLng, ride.destLat]))
    });
    
    destFeature.setStyle(new ol.style.Style({
        image: new ol.style.Circle({
            radius: 6,
            fill: new ol.style.Fill({color: '#E74C3C'}),
            stroke: new ol.style.Stroke({
                color: '#FFFFFF',
                width: 2
            })
        })
    }));
    
    popupVectorSource.addFeature(pickupFeature);
    popupVectorSource.addFeature(destFeature);
    
    // Fit map to show both points
    const extent = ol.extent.boundingExtent([
        ol.proj.fromLonLat([ride.pickupLng, ride.pickupLat]),
        ol.proj.fromLonLat([ride.destLng, ride.destLat])
    ]);
    
    popupRideMap.getView().fit(extent, {
        padding: [50, 50, 50, 50],
        duration: 500
    });
}

// Generate receipt
function generateReceipt() {
    const rideId = document.querySelector('#rideDetailsPopup').getAttribute('data-ride-id');
    if (!rideId) return;
    
    database.ref('rides/' + rideId).once('value')
        .then(snapshot => {
            const ride = snapshot.val();
            if (!ride) return;
            
            // Create receipt content
            const receiptContent = `
                <div id="receiptContent" style="padding: 20px; font-family: Arial, sans-serif;">
                    <h2 style="text-align: center; color: #FF6B35;">Jubel Ride Receipt</h2>
                    <hr style="border: 1px solid #FF6B35; margin: 10px 0;">
                    
                    <div style="margin-bottom: 15px;">
                        <h3>Ride Details</h3>
                        <p><strong>Ride ID:</strong> ${ride.id}</p>
                        <p><strong>Date:</strong> ${new Date(ride.timestamp).toLocaleString()}</p>
                        <p><strong>Ride Type:</strong> ${rideTypeConfig[ride.rideType]?.name || 'Standard'}</p>
                        <p><strong>Status:</strong> ${getStatusText(ride.status)}</p>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <h3>Route</h3>
                        <p><strong>From:</strong> ${ride.pickupDisplayLocation || ride.pickupLocation}</p>
                        <p><strong>To:</strong> ${ride.destination}</p>
                        <p><strong>Distance:</strong> ${ride.distance || 'N/A'}</p>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <h3>Fare Breakdown</h3>
                        <p><strong>Base Fare:</strong> K${ride.fare ? (ride.fare * 0.7).toFixed(2) : '0.00'}</p>
                        <p><strong>Distance Charge:</strong> K${ride.fare ? (ride.fare * 0.3).toFixed(2) : '0.00'}</p>
                        ${ride.promoCode ? `<p><strong>Discount (${ride.promoCode}):</strong> -K${(ride.fare * 0.2).toFixed(2)}</p>` : ''}
                        <hr style="border: 1px dashed #ccc; margin: 10px 0;">
                        <p><strong>Total Fare:</strong> K${ride.fare ? ride.fare.toFixed(2) : '0.00'}</p>
                    </div>
                    
                    ${ride.driverId ? `
                    <div style="margin-bottom: 15px;">
                        <h3>Driver Information</h3>
                        <p><strong>Driver:</strong> ${ride.driverName || 'N/A'}</p>
                        <p><strong>Vehicle:</strong> ${ride.driverVehicle || 'N/A'}</p>
                    </div>
                    ` : ''}
                    
                    <div style="margin-top: 20px; text-align: center; font-size: 0.8em; color: #777;">
                        <p>Thank you for choosing Jubel!</p>
                        <p>For support, contact: 0768658484</p>
                    </div>
                </div>
            `;
            
            // Create a temporary div for the receipt
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = receiptContent;
            document.body.appendChild(tempDiv);
            
            // Use html2canvas to capture the receipt
            html2canvas(tempDiv.querySelector('#receiptContent')).then(canvas => {
                // Convert canvas to image
                const imgData = canvas.toDataURL('image/png');
                
                // Create PDF using jsPDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF();
                const imgProps = pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save(`Jubel-Receipt-${ride.id}.pdf`);
                
                // Clean up
                document.body.removeChild(tempDiv);
                showNotification('Receipt downloaded successfully!');
            });
        })
        .catch(error => {
            console.error('Error generating receipt:', error);
            showNotification('Error generating receipt. Please try again.');
        });
}

// Close ride details popup
function closeRideDetailsPopup() {
    document.getElementById('rideDetailsPopup').classList.add('hidden');
}

// Switch screen function
function switchScreen(screenId) {
    const previousScreen = currentScreen;
    currentScreen = screenId;
    
    document.querySelectorAll('.screen-content').forEach(screen => {
        screen.classList.remove('active');
    });
    
    document.getElementById(screenId + 'Screen').classList.add('active');
    
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`.nav-btn[data-screen="${screenId}"]`).classList.add('active');
    
    if (screenId === 'home') {
        document.querySelectorAll('.home-only').forEach(el => {
            el.style.display = 'flex';
        });
        
        if (previousScreen !== 'home' && homeScreenRefreshRequired) {
            refreshHomeScreen();
        }
    } else {
        document.querySelectorAll('.home-only').forEach(el => {
            el.style.display = 'none';
        });
        
        homeScreenRefreshRequired = true;
    }
    
    if (screenId === 'history') {
        loadRideHistory();
    } else if (screenId === 'account') {
        loadAccountData();
    }
}

// Refresh home screen
function refreshHomeScreen() {
    refreshPassengerPosition();
    document.getElementById('destinationLocation').value = '';
    document.getElementById('addressBreakdown').classList.remove('active');
    
    if (destinationFeature) {
        vectorSource.removeFeature(destinationFeature);
        destinationFeature = null;
    }
    
    if (routeFeature) {
        vectorSource.removeFeature(routeFeature);
        routeFeature = null;
    }
    
    document.getElementById('estimatedFare').textContent = 'K0.00';
    document.getElementById('etaDisplay').textContent = 'ETA: -- min';
    document.getElementById('requestRideBtn').disabled = true;
    
    document.getElementById('promoSection').classList.remove('active');
    document.getElementById('promoCode').value = '';
    appliedPromoCode = null;
    
    document.getElementById('rideRequestForm').style.display = 'flex';
    document.getElementById('rideInfoPanel').style.display = 'none';
    document.getElementById('rideTypeSelection').style.display = 'none';
    document.getElementById('emergencyQuestionnaire').classList.remove('active');
    
    selectedRideType = 'standard';
    emergencyDetails = {};
    
    homeScreenRefreshRequired = false;
    
    showNotification('Home screen refreshed');
}

// Handle emergency type selection
function handleEmergencySelection(emergencyType) {
    activeEmergencyType = emergencyType;
    emergencyDetails.type = emergencyType;
    
    // Show ride type selection for non-emergency rides
    if (!['ambulance', 'fire-truck', 'emergency-ride', 'emergency-delivery'].includes(emergencyType)) {
        document.getElementById('rideTypeSelection').style.display = 'block';
        
        // Update ride type options based on emergency type
        const rideTypeOptions = document.querySelectorAll('.ride-type-option');
        rideTypeOptions.forEach(option => {
            option.classList.remove('selected');
        });
        
        document.querySelector('.ride-type-option.standard').classList.add('selected');
        selectedRideType = 'standard';
    } else {
        // For emergency services, show questionnaire
        document.getElementById('emergencyQuestionnaire').classList.add('active');
        document.getElementById('rideRequestForm').style.display = 'none';
        currentEmergencyQuestionnaire = emergencyType;
    }
}

// Handle emergency option selection in questionnaire
function handleEmergencyOptionSelection(optionType, value) {
    emergencyDetails[optionType] = value;
}

// Confirm emergency request
function confirmEmergencyRequest() {
    if (!emergencyDetails.type || !emergencyDetails.people) {
        showNotification('Please provide all emergency details.');
        return;
    }
    
    // For ambulance and fire truck, use those ride types
    if (currentEmergencyQuestionnaire === 'ambulance') {
        selectedRideType = 'ambulance';
    } else if (currentEmergencyQuestionnaire === 'fire-truck') {
        selectedRideType = 'fire-truck';
    } else if (currentEmergencyQuestionnaire === 'emergency-ride') {
        selectedRideType = 'emergency';
    } else if (currentEmergencyQuestionnaire === 'emergency-delivery') {
        selectedRideType = 'light-truck';
        emergencyDetails.isEmergencyDelivery = true;
    }
    
    // Hide questionnaire and show ride form
    document.getElementById('emergencyQuestionnaire').classList.remove('active');
    document.getElementById('rideRequestForm').style.display = 'flex';
    
    // Update fare estimate
    updateFareEstimate();
    
    showNotification('Emergency details recorded. Please proceed with ride request.');
}

// Cancel emergency request
function cancelEmergencyRequest() {
    document.getElementById('emergencyQuestionnaire').classList.remove('active');
    document.getElementById('rideRequestForm').style.display = 'flex';
    emergencyDetails = {};
    currentEmergencyQuestionnaire = null;
}

// Toggle panel collapse
function togglePanelCollapse() {
    const panel = document.getElementById('passengerPanel');
    panel.classList.toggle('collapsed');
}

// Use saved location
function useSavedLocation(addressType) {
    if (userData) {
        const address = userData[addressType + 'Address'];
        
        if (address) {
            document.getElementById('destinationLocation').value = address;
            updateFareEstimate();
            showNotification(`${addressType.charAt(0).toUpperCase() + addressType.slice(1)} address set as destination.`);
            
            forwardGeocode(address).then(results => {
                if (results.length > 0) {
                    updateDestinationMarker(
                        parseFloat(results[0].lat),
                        parseFloat(results[0].lon),
                        address
                    );
                    
                    drawRoute(userLocation.lat, userLocation.lng, parseFloat(results[0].lat), parseFloat(results[0].lon));
                    document.getElementById('requestRideBtn').disabled = false;
                }
            });
        } else {
            showNotification(`No ${addressType} address saved. Please add it in settings.`);
        }
    }
}

// Update wallet balance UI
function updateWalletBalanceUI() {
    document.getElementById('walletBalance').textContent = `K${walletBalance.toFixed(2)}`;
    document.getElementById('accountBalance').textContent = `K${walletBalance.toFixed(2)}`;
    document.getElementById('paymentWalletBalance').textContent = `Balance: K${walletBalance.toFixed(2)}`;
}

// Setup wallet balance listener
function setupWalletBalanceListener(uid) {
    if (walletBalanceListener) {
        walletBalanceListener();
    }
    
    walletBalanceListener = database.ref('users/' + uid + '/walletBalance').on('value', snapshot => {
        const newBalance = snapshot.val() || 0;
        if (newBalance !== walletBalance) {
            walletBalance = newBalance;
            updateWalletBalanceUI();
        }
    });
}

// Show notification
function showNotification(message) {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.style.display = 'block';
    
    setTimeout(() => {
        notification.style.display = 'none';
    }, 4000);
}

// Handle geolocation error
function handleGeolocationError(error) {
    let errorMessage = 'Unable to refresh location. ';
    
    switch(error.code) {
        case error.PERMISSION_DENIED:
            errorMessage += 'Please enable location services in your browser settings.';
            break;
        case error.POSITION_UNAVAILABLE:
            errorMessage += 'Location information is unavailable.';
            break;
        case error.TIMEOUT:
            errorMessage += 'Location request timed out. Please try again.';
            break;
        default:
            errorMessage += 'Please enable location services.';
    }
    
    showNotification(errorMessage);
}

// Setup event listeners
function setupEventListeners() {
    // Navigation buttons
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const screen = this.getAttribute('data-screen');
            switchScreen(screen);
        });
    });
    
    // Back buttons
    document.querySelectorAll('.back-button').forEach(btn => {
        btn.addEventListener('click', function() {
            const screen = this.getAttribute('data-screen');
            switchScreen(screen);
        });
    });
    
    // Ride type selection
    document.querySelectorAll('.ride-type-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.ride-type-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            this.classList.add('selected');
            selectedRideType = this.getAttribute('data-ride-type');
            
            updateFareEstimate();
        });
    });
    
    // Emergency options
    document.querySelectorAll('.emergency-option-card').forEach(card => {
        card.addEventListener('click', function() {
            const emergencyType = this.getAttribute('data-emergency-type');
            handleEmergencySelection(emergencyType);
        });
    });
    
    // Emergency type options
    document.querySelectorAll('.emergency-option[data-type]').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.emergency-option[data-type]').forEach(opt => {
                opt.classList.remove('selected');
            });
            this.classList.add('selected');
            handleEmergencyOptionSelection('type', this.getAttribute('data-type'));
        });
    });
    
    // Emergency people options
    document.querySelectorAll('.emergency-option[data-people]').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.emergency-option[data-people]').forEach(opt => {
                opt.classList.remove('selected');
            });
            this.classList.add('selected');
            handleEmergencyOptionSelection('people', this.getAttribute('data-people'));
        });
    });
    
    // Emergency actions
    document.getElementById('confirmEmergencyBtn').addEventListener('click', confirmEmergencyRequest);
    document.getElementById('cancelEmergencyBtn').addEventListener('click', cancelEmergencyRequest);
    
    // Payment options
    document.querySelectorAll('.payment-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.payment-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            this.classList.add('selected');
            selectedPaymentType = this.getAttribute('data-payment-type');
            
            if (selectedPaymentType === 'wallet') {
                if (walletBalance < rideFare) {
                    document.getElementById('insufficientBalance').style.display = 'block';
                    document.getElementById('confirmPaymentBtn').disabled = true;
                } else {
                    document.getElementById('insufficientBalance').style.display = 'none';
                    document.getElementById('confirmPaymentBtn').disabled = false;
                }
            } else {
                document.getElementById('insufficientBalance').style.display = 'none';
                document.getElementById('confirmPaymentBtn').disabled = false;
            }
        });
    });
    
    // Main action buttons
    document.getElementById('requestRideBtn').addEventListener('click', requestRide);
    document.getElementById('confirmPaymentBtn').addEventListener('click', submitRideRequest);
    document.getElementById('closePaymentPopup').addEventListener('click', closePaymentSelection);
    document.getElementById('cancelRideBtn').addEventListener('click', cancelRide);
    document.getElementById('contactDriverBtn').addEventListener('click', contactDriver);
    document.getElementById('promoToggle').addEventListener('click', function() {
        document.getElementById('promoSection').classList.toggle('active');
    });
    document.getElementById('applyPromoBtn').addEventListener('click', applyPromoCode);
    document.getElementById('shareReferralBtn').addEventListener('click', shareReferralCode);
    document.getElementById('depositBtn').addEventListener('click', depositToWallet);
    document.getElementById('withdrawBtn').addEventListener('click', withdrawFromWallet);
    document.getElementById('whatsappBtn').addEventListener('click', contactWhatsApp);
    document.getElementById('callBtn').addEventListener('click', contactPhone);
    document.getElementById('panelCollapseHandle').addEventListener('click', togglePanelCollapse);
    document.getElementById('generateReceiptBtn').addEventListener('click', generateReceipt);
    document.getElementById('closeRidePopup').addEventListener('click', closeRideDetailsPopup);
    document.getElementById('closeRidePopupTop').addEventListener('click', closeRideDetailsPopup);
    
    // Search input listeners
    document.getElementById('destinationLocation').addEventListener('input', function() {
        const query = this.value.trim();
        if (query.length >= 2) {
            searchPlacesEnhanced(query, 'destination');
        } else {
            hideSearchSuggestions('destination');
        }
    });
    
    document.getElementById('destinationLocation').addEventListener('focus', function() {
        const query = this.value.trim();
        if (query.length >= 2) {
            searchPlacesEnhanced(query, 'destination');
        }
    });
    
    // Click outside to hide suggestions
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.location-input') && !e.target.closest('.suggestion-list')) {
            hideSearchSuggestions('destination');
        }
    });
    
    // Saved location buttons
    document.querySelectorAll('.saved-location-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const addressType = this.getAttribute('data-address');
            useSavedLocation(addressType);
        });
    });
    
    // History filters
    document.getElementById('historyFilter').addEventListener('change', loadRideHistory);
    document.getElementById('historyDate').addEventListener('change', loadRideHistory);
    
    // Direct emergency contact button
    document.querySelector('.emergency-screen .contact-btn.phone').addEventListener('click', function() {
        window.open('tel:911', '_self');
    });
}

// Initialize enhanced app features
function initializeApp() {
    console.log("Jubel Passenger App Initialized with Enhanced Features");
    
    // Handle app visibility changes
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden && currentScreen === 'home') {
            setTimeout(refreshHomeScreen, 1000);
        }
    });
    
    // Handle offline/online status
    window.addEventListener('online', function() {
        showNotification('Connection restored.');
        if (currentScreen === 'home') {
            setTimeout(refreshPassengerPosition, 1000);
        }
    });
    
    window.addEventListener('offline', function() {
        showNotification('You are currently offline. Some features may not work.');
    });
}

// Initialize enhanced app features
initializeApp();
    </script>
</body>
</html>
