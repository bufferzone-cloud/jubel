<!DOCTYPE html><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jubel - Passenger</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
    /* Orange theme colors */
    --primary-orange: #FF6B35;
    --primary-orange-dark: #E55A28;
    --primary-orange-light: #FF8A5C;
    --primary-orange-ultralight: #FFF5F0;
    
    /* White theme colors */
    --pure-white: #FFFFFF;
    --off-white: #F9F9F9;
    --white-gray: #F5F5F5;
    --white-gray-dark: #E0E0E0;
    
    /* Background colors */
    --app-background: #F8F9FA;
    --card-background: var(--pure-white);
    --input-background: var(--off-white);
    
    /* Text colors */
    --text-primary: #333333;
    --text-secondary: #666666;
    --text-tertiary: #888888;
    --text-on-orange: var(--pure-white);
    
    /* Status colors */
    --status-success: #2ECC71;
    --status-warning: #F39C12;
    --status-info: #3498DB;
    --status-error: #E74C3C;
    
    /* Service type colors */
    --car-service: var(--primary-orange);
    --delivery-service: #8E44AD;
    --truck-service: #8B4513;
    --shopping-service: #16A085;
    --emergency-service: var(--status-error);
    
    /* Sizing - Smaller app-like dimensions */
    --app-max-width: 480px;
    --app-padding: 12px;
    --app-header-height: 52px;
    --app-footer-height: 60px;
    
    /* Border radius - Curved design */
    --radius-xs: 4px;
    --radius-sm: 8px;
    --radius-md: 12px;
    --radius-lg: 16px;
    --radius-xl: 20px;
    --radius-xxl: 24px;
    --radius-circle: 50%;
    --radius-button: 20px; /* Curved buttons */
    --radius-card: 16px;
    --radius-input: 12px;
    
    /* Spacing - Smaller for mobile app */
    --space-xs: 4px;
    --space-sm: 8px;
    --space-md: 12px;
    --space-lg: 16px;
    --space-xl: 20px;
    --space-xxl: 24px;
    
    /* Typography - App-optimized */
    --font-size-xs: 10px;
    --font-size-sm: 11px;
    --font-size-md: 12px;
    --font-size-lg: 13px;
    --font-size-xl: 14px;
    --font-size-xxl: 16px;
    --font-size-xxxl: 18px;
    --font-size-display: 22px;
    
    /* Shadows - Subtle app shadows */
    --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.08);
    --shadow-md: 0 2px 6px rgba(0, 0, 0, 0.1);
    --shadow-lg: 0 4px 12px rgba(0, 0, 0, 0.12);
    --shadow-xl: 0 6px 20px rgba(0, 0, 0, 0.15);
    --shadow-orange: 0 3px 10px rgba(255, 107, 53, 0.2);
    --shadow-orange-heavy: 0 5px 20px rgba(255, 107, 53, 0.25);
    
    /* Transitions - App-like animations */
    --transition-fast: 150ms ease;
    --transition-normal: 250ms cubic-bezier(0.4, 0, 0.2, 1);
    --transition-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);
    --transition-bounce: 300ms cubic-bezier(0.68, -0.55, 0.265, 1.55);
    
    /* Z-index layers */
    --z-base: 1;
    --z-elevated: 10;
    --z-dropdown: 100;
    --z-sticky: 200;
    --z-fixed: 300;
    --z-modal: 400;
    --z-popover: 500;
    --z-tooltip: 600;
    --z-toast: 700;
    --z-max: 9999;
    
    /* Animation keyframes */
    --animation-slide-up: slideUp 0.3s ease;
    --animation-slide-down: slideDown 0.3s ease;
    --animation-fade-in: fadeIn 0.3s ease;
    --animation-slide-in-right: slideInRight 0.3s ease;
    --animation-slide-in-left: slideInLeft 0.3s ease;
    --animation-pulse: pulse 2s infinite;
    --animation-bounce: bounce 1s infinite;
    --animation-shake: shake 0.5s ease;
    --animation-rotate: rotate 1s linear infinite;
    --animation-scale: scale 0.2s ease;
    
    /* App-specific dimensions */
    --button-height: 44px;
    --input-height: 48px;
    --icon-size-sm: 16px;
    --icon-size-md: 20px;
    --icon-size-lg: 24px;
    --avatar-size-sm: 32px;
    --avatar-size-md: 40px;
    --avatar-size-lg: 56px;
    --badge-size: 18px;
    --map-height: 55vh;
    --panel-height: 45vh;
    --tab-height: 48px;
    --card-padding: var(--space-md);
    
    /* Navigation */
    --nav-item-padding: var(--space-sm) var(--space-md);
    --nav-icon-size: 20px;
    
    /* Route Navigation Specific */
    --route-guide-width: 280px;
    --route-guide-height: 180px;
    --route-guide-top: calc(var(--app-header-height) + var(--space-md));
    --route-guide-right: var(--space-md);
    --route-step-height: 36px;
    --route-guide-z: var(--z-fixed);
}

/* Base Reset - App Optimized */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

html {
    font-size: 14px;
    height: 100%;
    overflow: hidden;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
    background-color: var(--app-background);
    color: var(--text-primary);
    line-height: 1.4;
    font-size: var(--font-size-md);
    max-width: var(--app-max-width);
    margin: 0 auto;
    height: 100vh;
    overflow: hidden;
    position: relative;
    box-shadow: var(--shadow-xl);
    border-radius: var(--radius-lg);
}

/* App Container */
.app-container {
    height: 100vh;
    display: flex;
    flex-direction: column;
    position: relative;
    overflow: hidden;
    background: var(--app-background);
}

/* Typography Scale - App Optimized */
h1, h2, h3, h4, h5, h6 {
    font-weight: 600;
    line-height: 1.3;
    margin-bottom: var(--space-sm);
    color: var(--text-primary);
}

h1 { font-size: var(--font-size-xxxl); }
h2 { font-size: var(--font-size-xxl); }
h3 { font-size: var(--font-size-xl); }
h4 { font-size: var(--font-size-lg); }
h5 { font-size: var(--font-size-md); }
h6 { font-size: var(--font-size-sm); }

p, span, div {
    font-size: var(--font-size-md);
    line-height: 1.4;
}

small {
    font-size: var(--font-size-sm);
    color: var(--text-tertiary);
}

strong {
    font-weight: 600;
}

/* App Header */
.app-header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: var(--app-header-height);
    background: var(--pure-white);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--white-gray-dark);
    z-index: var(--z-fixed);
    padding: 0 var(--app-padding);
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: var(--shadow-sm);
}

.header-left, .header-right {
    display: flex;
    align-items: center;
    gap: var(--space-md);
}

.logo {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    text-decoration: none;
}

.logo-icon {
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-orange-dark));
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--pure-white);
    font-weight: 700;
    font-size: var(--font-size-lg);
}

.logo-text {
    font-size: var(--font-size-lg);
    font-weight: 700;
    color: var(--text-primary);
    line-height: 1.2;
}

.user-avatar {
    width: var(--avatar-size-md);
    height: var(--avatar-size-md);
    border-radius: var(--radius-circle);
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-orange-dark));
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--pure-white);
    font-weight: 600;
    border: 2px solid var(--pure-white);
    box-shadow: var(--shadow-md);
    cursor: pointer;
    transition: all var(--transition-normal);
}

.user-avatar:hover {
    transform: scale(1.05);
    box-shadow: var(--shadow-lg);
}

/* App Footer/Navigation */
.app-navigation {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: var(--app-footer-height);
    background: var(--pure-white);
    border-top: 1px solid var(--white-gray-dark);
    z-index: var(--z-fixed);
    padding: var(--space-sm) var(--app-padding);
    display: flex;
    justify-content: space-around;
    align-items: center;
    box-shadow: var(--shadow-lg);
}

.nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: var(--space-xs);
    padding: var(--space-sm);
    border-radius: var(--radius-md);
    background: transparent;
    border: none;
    cursor: pointer;
    transition: all var(--transition-fast);
    min-width: 56px;
    color: var(--text-tertiary);
    text-decoration: none;
    position: relative;
}

.nav-item.active {
    color: var(--primary-orange);
    background: var(--primary-orange-ultralight);
}

.nav-item:hover:not(.active) {
    color: var(--primary-orange);
    background: rgba(255, 107, 53, 0.05);
}

.nav-icon {
    font-size: var(--icon-size-lg);
    transition: all var(--transition-normal);
}

.nav-item.active .nav-icon {
    transform: translateY(-2px);
}

.nav-label {
    font-size: var(--font-size-xs);
    font-weight: 500;
    white-space: nowrap;
}

.nav-badge {
    position: absolute;
    top: -2px;
    right: -2px;
    width: var(--badge-size);
    height: var(--badge-size);
    background: var(--status-error);
    color: var(--pure-white);
    border-radius: var(--radius-circle);
    font-size: var(--font-size-xs);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    border: 2px solid var(--pure-white);
    animation: var(--animation-pulse);
}

/* Main Content Area */
.app-content {
    flex: 1;
    overflow-y: auto;
    padding-top: var(--app-header-height);
    padding-bottom: var(--app-footer-height);
    -webkit-overflow-scrolling: touch;
    scrollbar-width: thin;
    scrollbar-color: var(--primary-orange) var(--white-gray);
}

.app-content::-webkit-scrollbar {
    width: 4px;
}

.app-content::-webkit-scrollbar-track {
    background: var(--white-gray);
    border-radius: var(--radius-xs);
}

.app-content::-webkit-scrollbar-thumb {
    background: var(--primary-orange);
    border-radius: var(--radius-xs);
}

/* Cards - App Style */
.card {
    background: var(--card-background);
    border-radius: var(--radius-card);
    padding: var(--card-padding);
    margin: var(--space-md);
    box-shadow: var(--shadow-md);
    border: 1px solid var(--white-gray-dark);
    transition: all var(--transition-normal);
}

.card:hover {
    box-shadow: var(--shadow-lg);
    transform: translateY(-2px);
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-md);
}

.card-title {
    font-size: var(--font-size-lg);
    font-weight: 600;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.card-subtitle {
    font-size: var(--font-size-sm);
    color: var(--text-tertiary);
    margin-top: var(--space-xs);
}

.card-body {
    font-size: var(--font-size-md);
    color: var(--text-secondary);
}

.card-footer {
    margin-top: var(--space-md);
    padding-top: var(--space-md);
    border-top: 1px solid var(--white-gray-dark);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

/* Buttons - Curved Design */
.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-sm);
    padding: 0 var(--space-xl);
    height: var(--button-height);
    border-radius: var(--radius-button);
    font-size: var(--font-size-md);
    font-weight: 600;
    text-decoration: none;
    cursor: pointer;
    transition: all var(--transition-normal);
    border: none;
    outline: none;
    position: relative;
    overflow: hidden;
    white-space: nowrap;
    user-select: none;
    -webkit-user-select: none;
}

.btn::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: var(--radius-circle);
    background: rgba(255, 255, 255, 0.2);
    transform: translate(-50%, -50%);
    transition: width 0.6s, height 0.6s;
}

.btn:active::after {
    width: 200px;
    height: 200px;
}

.btn-sm {
    height: 36px;
    padding: 0 var(--space-lg);
    font-size: var(--font-size-sm);
    border-radius: calc(var(--radius-button) - 2px);
}

.btn-lg {
    height: 52px;
    padding: 0 var(--space-xxl);
    font-size: var(--font-size-lg);
    border-radius: calc(var(--radius-button) + 2px);
}

.btn-block {
    width: 100%;
}

.btn-primary {
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-orange-dark));
    color: var(--pure-white);
    box-shadow: var(--shadow-orange);
}

.btn-primary:hover {
    background: linear-gradient(135deg, var(--primary-orange-light), var(--primary-orange));
    transform: translateY(-2px);
    box-shadow: var(--shadow-orange-heavy);
}

.btn-primary:active {
    transform: translateY(0);
}

.btn-secondary {
    background: var(--pure-white);
    color: var(--primary-orange);
    border: 2px solid var(--primary-orange);
}

.btn-secondary:hover {
    background: var(--primary-orange-ultralight);
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.btn-outline {
    background: transparent;
    color: var(--text-secondary);
    border: 1px solid var(--white-gray-dark);
}

.btn-outline:hover {
    background: var(--white-gray);
    border-color: var(--text-tertiary);
    color: var(--text-primary);
}

.btn-ghost {
    background: transparent;
    color: var(--text-secondary);
    border: none;
}

.btn-ghost:hover {
    background: rgba(0, 0, 0, 0.05);
    color: var(--text-primary);
}

.btn-danger {
    background: linear-gradient(135deg, var(--status-error), #C0392B);
    color: var(--pure-white);
}

.btn-success {
    background: linear-gradient(135deg, var(--status-success), #27AE60);
    color: var(--pure-white);
}

.btn-warning {
    background: linear-gradient(135deg, var(--status-warning), #E67E22);
    color: var(--pure-white);
}

.btn-info {
    background: linear-gradient(135deg, var(--status-info), #2980B9);
    color: var(--pure-white);
}

.btn-disabled {
    opacity: 0.6;
    cursor: not-allowed;
    pointer-events: none;
}

.btn-loading {
    position: relative;
    color: transparent !important;
}

.btn-loading::before {
    content: '';
    position: absolute;
    width: 16px;
    height: 16px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: var(--radius-circle);
    border-top-color: var(--pure-white);
    animation: var(--animation-rotate);
}

.btn-icon {
    padding: var(--space-sm);
    width: var(--button-height);
    height: var(--button-height);
    border-radius: var(--radius-circle);
}

.btn-icon-sm {
    width: 36px;
    height: 36px;
    padding: var(--space-xs);
}

/* Form Elements */
.form-group {
    margin-bottom: var(--space-lg);
}

.form-label {
    display: block;
    margin-bottom: var(--space-xs);
    font-weight: 600;
    color: var(--text-primary);
    font-size: var(--font-size-sm);
}

.form-control {
    width: 100%;
    height: var(--input-height);
    padding: 0 var(--space-md);
    background: var(--input-background);
    border: 2px solid var(--white-gray-dark);
    border-radius: var(--radius-input);
    font-size: var(--font-size-md);
    color: var(--text-primary);
    transition: all var(--transition-fast);
    outline: none;
}

.form-control:focus {
    border-color: var(--primary-orange);
    background: var(--pure-white);
    box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
}

.form-control::placeholder {
    color: var(--text-tertiary);
}

.form-textarea {
    height: auto;
    min-height: 100px;
    padding: var(--space-md);
    resize: vertical;
    line-height: 1.5;
}

.form-select {
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right var(--space-md) center;
    background-size: 16px;
    padding-right: var(--space-xl);
}

.form-check {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    cursor: pointer;
}

.form-check-input {
    width: 18px;
    height: 18px;
    border: 2px solid var(--white-gray-dark);
    border-radius: var(--radius-xs);
    background: var(--pure-white);
    transition: all var(--transition-fast);
    cursor: pointer;
    position: relative;
}

.form-check-input:checked {
    background: var(--primary-orange);
    border-color: var(--primary-orange);
}

.form-check-input:checked::after {
    content: 'âœ“';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: var(--pure-white);
    font-size: var(--font-size-sm);
    font-weight: bold;
}

.form-check-label {
    font-size: var(--font-size-md);
    color: var(--text-secondary);
    user-select: none;
}

.form-radio {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    cursor: pointer;
}

.form-radio-input {
    width: 18px;
    height: 18px;
    border: 2px solid var(--white-gray-dark);
    border-radius: var(--radius-circle);
    background: var(--pure-white);
    transition: all var(--transition-fast);
    cursor: pointer;
    position: relative;
}

.form-radio-input:checked {
    border-color: var(--primary-orange);
}

.form-radio-input:checked::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 8px;
    height: 8px;
    background: var(--primary-orange);
    border-radius: var(--radius-circle);
}

/* Input Groups */
.input-group {
    display: flex;
    gap: var(--space-sm);
    align-items: center;
}

.input-group-prepend,
.input-group-append {
    display: flex;
    align-items: center;
    padding: 0 var(--space-md);
    background: var(--input-background);
    border: 2px solid var(--white-gray-dark);
    color: var(--text-tertiary);
    font-size: var(--font-size-md);
    white-space: nowrap;
}

.input-group-prepend {
    border-right: none;
    border-radius: var(--radius-input) 0 0 var(--radius-input);
}

.input-group-append {
    border-left: none;
    border-radius: 0 var(--radius-input) var(--radius-input) 0;
}

.input-group .form-control {
    flex: 1;
    border-radius: 0;
}

.input-group .form-control:first-child {
    border-radius: var(--radius-input) 0 0 var(--radius-input);
}

.input-group .form-control:last-child {
    border-radius: 0 var(--radius-input) var(--radius-input) 0;
}

/* Tabs */
.tabs {
    display: flex;
    background: var(--white-gray);
    border-radius: var(--radius-md);
    padding: var(--space-xs);
    margin: var(--space-md);
}

.tab {
    flex: 1;
    padding: var(--space-sm) var(--space-md);
    background: transparent;
    border: none;
    border-radius: var(--radius-sm);
    font-size: var(--font-size-md);
    font-weight: 500;
    color: var(--text-tertiary);
    cursor: pointer;
    transition: all var(--transition-fast);
    text-align: center;
    white-space: nowrap;
}

.tab.active {
    background: var(--pure-white);
    color: var(--primary-orange);
    box-shadow: var(--shadow-sm);
}

.tab:hover:not(.active) {
    color: var(--primary-orange);
    background: rgba(255, 107, 53, 0.05);
}

.tab-content {
    display: none;
    animation: var(--animation-fade-in);
}

.tab-content.active {
    display: block;
}

/* Badges */
.badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-xs) var(--space-sm);
    font-size: var(--font-size-xs);
    font-weight: 600;
    border-radius: var(--radius-xl);
    white-space: nowrap;
    line-height: 1;
}

.badge-primary {
    background: var(--primary-orange-ultralight);
    color: var(--primary-orange);
    border: 1px solid rgba(255, 107, 53, 0.2);
}

.badge-secondary {
    background: var(--white-gray);
    color: var(--text-secondary);
}

.badge-success {
    background: rgba(46, 204, 113, 0.1);
    color: var(--status-success);
    border: 1px solid rgba(46, 204, 113, 0.2);
}

.badge-warning {
    background: rgba(243, 156, 18, 0.1);
    color: var(--status-warning);
    border: 1px solid rgba(243, 156, 18, 0.2);
}

.badge-error {
    background: rgba(231, 76, 60, 0.1);
    color: var(--status-error);
    border: 1px solid rgba(231, 76, 60, 0.2);
}

.badge-info {
    background: rgba(52, 152, 219, 0.1);
    color: var(--status-info);
    border: 1px solid rgba(52, 152, 219, 0.2);
}

.badge-pill {
    border-radius: var(--radius-circle);
    padding: var(--space-xs) var(--space-xs);
    min-width: 20px;
    height: 20px;
}

/* Alerts */
.alert {
    padding: var(--space-md);
    border-radius: var(--radius-md);
    margin: var(--space-md);
    border: 1px solid transparent;
    display: flex;
    align-items: flex-start;
    gap: var(--space-md);
    animation: var(--animation-slide-up);
}

.alert-icon {
    font-size: var(--icon-size-lg);
    flex-shrink: 0;
    margin-top: 1px;
}

.alert-content {
    flex: 1;
}

.alert-title {
    font-weight: 600;
    margin-bottom: var(--space-xs);
    font-size: var(--font-size-md);
}

.alert-message {
    font-size: var(--font-size-sm);
    line-height: 1.4;
}

.alert-primary {
    background: var(--primary-orange-ultralight);
    border-color: rgba(255, 107, 53, 0.3);
    color: var(--primary-orange-dark);
}

.alert-success {
    background: rgba(46, 204, 113, 0.1);
    border-color: rgba(46, 204, 113, 0.3);
    color: #27AE60;
}

.alert-warning {
    background: rgba(243, 156, 18, 0.1);
    border-color: rgba(243, 156, 18, 0.3);
    color: #D35400;
}

.alert-error {
    background: rgba(231, 76, 60, 0.1);
    border-color: rgba(231, 76, 60, 0.3);
    color: #C0392B;
}

.alert-info {
    background: rgba(52, 152, 219, 0.1);
    border-color: rgba(52, 152, 219, 0.3);
    color: #2980B9;
}

/* Modals */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    z-index: var(--z-modal);
    display: none;
    align-items: center;
    justify-content: center;
    padding: var(--app-padding);
    animation: var(--animation-fade-in);
}

.modal-overlay.active {
    display: flex;
}

.modal {
    background: var(--card-background);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-xl);
    max-width: 400px;
    width: 100%;
    max-height: 80vh;
    overflow-y: auto;
    animation: var(--animation-slide-up);
}

.modal-header {
    padding: var(--space-lg);
    border-bottom: 1px solid var(--white-gray-dark);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.modal-title {
    font-size: var(--font-size-lg);
    font-weight: 600;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.modal-close {
    background: transparent;
    border: none;
    font-size: var(--icon-size-lg);
    color: var(--text-tertiary);
    cursor: pointer;
    padding: var(--space-xs);
    border-radius: var(--radius-xs);
    transition: all var(--transition-fast);
}

.modal-close:hover {
    color: var(--status-error);
    background: rgba(231, 76, 60, 0.1);
}

.modal-body {
    padding: var(--space-lg);
}

.modal-footer {
    padding: var(--space-lg);
    border-top: 1px solid var(--white-gray-dark);
    display: flex;
    gap: var(--space-md);
    justify-content: flex-end;
}

/* Toast Notifications */
.toast-container {
    position: fixed;
    top: calc(var(--app-header-height) + var(--space-md));
    right: var(--app-padding);
    z-index: var(--z-toast);
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
    max-width: 320px;
    width: 100%;
}

.toast {
    background: var(--card-background);
    border-radius: var(--radius-md);
    padding: var(--space-md);
    box-shadow: var(--shadow-lg);
    border-left: 4px solid var(--primary-orange);
    display: flex;
    align-items: flex-start;
    gap: var(--space-md);
    animation: var(--animation-slide-in-right);
    transform: translateX(0);
    transition: transform var(--transition-normal);
}

.toast.hiding {
    transform: translateX(100%);
}

.toast-icon {
    width: 20px;
    height: 20px;
    border-radius: var(--radius-circle);
    background: var(--primary-orange-ultralight);
    color: var(--primary-orange);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.toast-success {
    border-left-color: var(--status-success);
}

.toast-success .toast-icon {
    background: rgba(46, 204, 113, 0.1);
    color: var(--status-success);
}

.toast-error {
    border-left-color: var(--status-error);
}

.toast-error .toast-icon {
    background: rgba(231, 76, 60, 0.1);
    color: var(--status-error);
}

.toast-warning {
    border-left-color: var(--status-warning);
}

.toast-warning .toast-icon {
    background: rgba(243, 156, 18, 0.1);
    color: var(--status-warning);
}

.toast-content {
    flex: 1;
}

.toast-title {
    font-weight: 600;
    font-size: var(--font-size-md);
    color: var(--text-primary);
    margin-bottom: var(--space-xs);
}

.toast-message {
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
    line-height: 1.3;
}

.toast-close {
    background: none;
    border: none;
    color: var(--text-tertiary);
    font-size: var(--icon-size-md);
    cursor: pointer;
    padding: var(--space-xs);
    border-radius: var(--radius-xs);
    transition: all var(--transition-fast);
    flex-shrink: 0;
}

.toast-close:hover {
    color: var(--status-error);
    background: rgba(231, 76, 60, 0.1);
}

/* Loading States */
.loading {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid var(--white-gray-dark);
    border-radius: var(--radius-circle);
    border-top-color: var(--primary-orange);
    animation: var(--animation-rotate);
}

.loading-sm {
    width: 12px;
    height: 12px;
    border-width: 1.5px;
}

.loading-lg {
    width: 24px;
    height: 24px;
    border-width: 3px;
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(4px);
    z-index: var(--z-modal);
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: var(--space-lg);
}

.loading-overlay.active {
    display: flex;
}

.loading-spinner {
    width: 48px;
    height: 48px;
    border: 4px solid var(--white-gray-dark);
    border-radius: var(--radius-circle);
    border-top-color: var(--primary-orange);
    animation: var(--animation-rotate);
}

.loading-text {
    font-size: var(--font-size-lg);
    font-weight: 600;
    color: var(--text-primary);
}

/* Progress Bars */
.progress {
    height: 6px;
    background: var(--white-gray);
    border-radius: var(--radius-xs);
    overflow: hidden;
    margin: var(--space-md) 0;
}

.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--primary-orange), var(--primary-orange-light));
    border-radius: var(--radius-xs);
    transition: width var(--transition-slow);
    position: relative;
    overflow: hidden;
}

.progress-bar::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    bottom: 0;
    width: 20px;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
    animation: progressShimmer 1.5s infinite;
}

@keyframes progressShimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(400%); }
}

.progress-lg {
    height: 8px;
}

.progress-sm {
    height: 4px;
}

/* Avatars */
.avatar {
    border-radius: var(--radius-circle);
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-orange-dark));
    color: var(--pure-white);
    font-weight: 600;
    overflow: hidden;
}

.avatar-sm {
    width: var(--avatar-size-sm);
    height: var(--avatar-size-sm);
    font-size: var(--font-size-sm);
}

.avatar-md {
    width: var(--avatar-size-md);
    height: var(--avatar-size-md);
    font-size: var(--font-size-md);
}

.avatar-lg {
    width: var(--avatar-size-lg);
    height: var(--avatar-size-lg);
    font-size: var(--font-size-xl);
}

.avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* Lists */
.list {
    list-style: none;
}

.list-item {
    padding: var(--space-md);
    border-bottom: 1px solid var(--white-gray-dark);
    display: flex;
    align-items: center;
    gap: var(--space-md);
    transition: all var(--transition-fast);
}

.list-item:last-child {
    border-bottom: none;
}

.list-item:hover {
    background: var(--white-gray);
}

.list-icon {
    color: var(--primary-orange);
    font-size: var(--icon-size-md);
    flex-shrink: 0;
}

.list-content {
    flex: 1;
}

.list-title {
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: var(--space-xs);
    font-size: var(--font-size-md);
}

.list-subtitle {
    color: var(--text-tertiary);
    font-size: var(--font-size-sm);
}

.list-action {
    flex-shrink: 0;
}

/* Grid System */
.row {
    display: flex;
    flex-wrap: wrap;
    margin: 0 calc(-1 * var(--space-sm));
}

.col {
    flex: 1;
    padding: 0 var(--space-sm);
    min-width: 0;
}

.col-1 { flex: 0 0 8.33333%; max-width: 8.33333%; }
.col-2 { flex: 0 0 16.66667%; max-width: 16.66667%; }
.col-3 { flex: 0 0 25%; max-width: 25%; }
.col-4 { flex: 0 0 33.33333%; max-width: 33.33333%; }
.col-5 { flex: 0 0 41.66667%; max-width: 41.66667%; }
.col-6 { flex: 0 0 50%; max-width: 50%; }
.col-7 { flex: 0 0 58.33333%; max-width: 58.33333%; }
.col-8 { flex: 0 0 66.66667%; max-width: 66.66667%; }
.col-9 { flex: 0 0 75%; max-width: 75%; }
.col-10 { flex: 0 0 83.33333%; max-width: 83.33333%; }
.col-11 { flex: 0 0 91.66667%; max-width: 91.66667%; }
.col-12 { flex: 0 0 100%; max-width: 100%; }

/* Spacing Utilities */
.m-0 { margin: 0 !important; }
.m-1 { margin: var(--space-xs) !important; }
.m-2 { margin: var(--space-sm) !important; }
.m-3 { margin: var(--space-md) !important; }
.m-4 { margin: var(--space-lg) !important; }
.m-5 { margin: var(--space-xl) !important; }

.mt-0 { margin-top: 0 !important; }
.mt-1 { margin-top: var(--space-xs) !important; }
.mt-2 { margin-top: var(--space-sm) !important; }
.mt-3 { margin-top: var(--space-md) !important; }
.mt-4 { margin-top: var(--space-lg) !important; }
.mt-5 { margin-top: var(--space-xl) !important; }

.mb-0 { margin-bottom: 0 !important; }
.mb-1 { margin-bottom: var(--space-xs) !important; }
.mb-2 { margin-bottom: var(--space-sm) !important; }
.mb-3 { margin-bottom: var(--space-md) !important; }
.mb-4 { margin-bottom: var(--space-lg) !important; }
.mb-5 { margin-bottom: var(--space-xl) !important; }

.p-0 { padding: 0 !important; }
.p-1 { padding: var(--space-xs) !important; }
.p-2 { padding: var(--space-sm) !important; }
.p-3 { padding: var(--space-md) !important; }
.p-4 { padding: var(--space-lg) !important; }
.p-5 { padding: var(--space-xl) !important; }

.pt-0 { padding-top: 0 !important; }
.pt-1 { padding-top: var(--space-xs) !important; }
.pt-2 { padding-top: var(--space-sm) !important; }
.pt-3 { padding-top: var(--space-md) !important; }
.pt-4 { padding-top: var(--space-lg) !important; }
.pt-5 { padding-top: var(--space-xl) !important; }

.pb-0 { padding-bottom: 0 !important; }
.pb-1 { padding-bottom: var(--space-xs) !important; }
.pb-2 { padding-bottom: var(--space-sm) !important; }
.pb-3 { padding-bottom: var(--space-md) !important; }
.pb-4 { padding-bottom: var(--space-lg) !important; }
.pb-5 { padding-bottom: var(--space-xl) !important; }

/* Text Utilities */
.text-center { text-align: center !important; }
.text-left { text-align: left !important; }
.text-right { text-align: right !important; }
.text-justify { text-align: justify !important; }

.text-primary { color: var(--text-primary) !important; }
.text-secondary { color: var(--text-secondary) !important; }
.text-tertiary { color: var(--text-tertiary) !important; }
.text-orange { color: var(--primary-orange) !important; }
.text-white { color: var(--pure-white) !important; }
.text-success { color: var(--status-success) !important; }
.text-warning { color: var(--status-warning) !important; }
.text-error { color: var(--status-error) !important; }
.text-info { color: var(--status-info) !important; }

.text-xs { font-size: var(--font-size-xs) !important; }
.text-sm { font-size: var(--font-size-sm) !important; }
.text-md { font-size: var(--font-size-md) !important; }
.text-lg { font-size: var(--font-size-lg) !important; }
.text-xl { font-size: var(--font-size-xl) !important; }
.text-xxl { font-size: var(--font-size-xxl) !important; }

.font-light { font-weight: 300 !important; }
.font-normal { font-weight: 400 !important; }
.font-medium { font-weight: 500 !important; }
.font-semibold { font-weight: 600 !important; }
.font-bold { font-weight: 700 !important; }

.uppercase { text-transform: uppercase !important; }
.lowercase { text-transform: lowercase !important; }
.capitalize { text-transform: capitalize !important; }

.truncate {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* Flex Utilities */
.d-flex { display: flex !important; }
.d-inline-flex { display: inline-flex !important; }
.d-block { display: block !important; }
.d-inline-block { display: inline-block !important; }
.d-none { display: none !important; }

.flex-row { flex-direction: row !important; }
.flex-column { flex-direction: column !important; }
.flex-wrap { flex-wrap: wrap !important; }
.flex-nowrap { flex-wrap: nowrap !important; }

.justify-start { justify-content: flex-start !important; }
.justify-end { justify-content: flex-end !important; }
.justify-center { justify-content: center !important; }
.justify-between { justify-content: space-between !important; }
.justify-around { justify-content: space-around !important; }

.align-start { align-items: flex-start !important; }
.align-end { align-items: flex-end !important; }
.align-center { align-items: center !important; }
.align-baseline { align-items: baseline !important; }
.align-stretch { align-items: stretch !important; }

.flex-1 { flex: 1 !important; }
.flex-auto { flex: auto !important; }
.flex-none { flex: none !important; }

.gap-0 { gap: 0 !important; }
.gap-1 { gap: var(--space-xs) !important; }
.gap-2 { gap: var(--space-sm) !important; }
.gap-3 { gap: var(--space-md) !important; }
.gap-4 { gap: var(--space-lg) !important; }
.gap-5 { gap: var(--space-xl) !important; }

/* Position Utilities */
.position-static { position: static !important; }
.position-relative { position: relative !important; }
.position-absolute { position: absolute !important; }
.position-fixed { position: fixed !important; }
.position-sticky { position: sticky !important; }

.top-0 { top: 0 !important; }
.right-0 { right: 0 !important; }
.bottom-0 { bottom: 0 !important; }
.left-0 { left: 0 !important; }

.z-0 { z-index: 0 !important; }
.z-1 { z-index: var(--z-base) !important; }
.z-2 { z-index: var(--z-elevated) !important; }
.z-3 { z-index: var(--z-dropdown) !important; }
.z-4 { z-index: var(--z-sticky) !important; }
.z-5 { z-index: var(--z-fixed) !important; }
.z-max { z-index: var(--z-max) !important; }

/* Border Utilities */
.border { border: 1px solid var(--white-gray-dark) !important; }
.border-top { border-top: 1px solid var(--white-gray-dark) !important; }
.border-right { border-right: 1px solid var(--white-gray-dark) !important; }
.border-bottom { border-bottom: 1px solid var(--white-gray-dark) !important; }
.border-left { border-left: 1px solid var(--white-gray-dark) !important; }

.border-0 { border: 0 !important; }
.border-top-0 { border-top: 0 !important; }
.border-right-0 { border-right: 0 !important; }
.border-bottom-0 { border-bottom: 0 !important; }
.border-left-0 { border-left: 0 !important; }

.border-orange { border-color: var(--primary-orange) !important; }
.border-white { border-color: var(--pure-white) !important; }
.border-success { border-color: var(--status-success) !important; }
.border-warning { border-color: var(--status-warning) !important; }
.border-error { border-color: var(--status-error) !important; }
.border-info { border-color: var(--status-info) !important; }

.rounded { border-radius: var(--radius-md) !important; }
.rounded-sm { border-radius: var(--radius-sm) !important; }
.rounded-md { border-radius: var(--radius-md) !important; }
.rounded-lg { border-radius: var(--radius-lg) !important; }
.rounded-xl { border-radius: var(--radius-xl) !important; }
.rounded-circle { border-radius: var(--radius-circle) !important; }
.rounded-pill { border-radius: var(--radius-button) !important; }

.rounded-top { border-top-left-radius: var(--radius-md) !important; border-top-right-radius: var(--radius-md) !important; }
.rounded-bottom { border-bottom-left-radius: var(--radius-md) !important; border-bottom-right-radius: var(--radius-md) !important; }
.rounded-left { border-top-left-radius: var(--radius-md) !important; border-bottom-left-radius: var(--radius-md) !important; }
.rounded-right { border-top-right-radius: var(--radius-md) !important; border-bottom-right-radius: var(--radius-md) !important; }

/* Background Utilities */
.bg-white { background-color: var(--pure-white) !important; }
.bg-off-white { background-color: var(--off-white) !important; }
.bg-gray { background-color: var(--white-gray) !important; }
.bg-orange { background-color: var(--primary-orange) !important; }
.bg-orange-light { background-color: var(--primary-orange-ultralight) !important; }
.bg-success { background-color: var(--status-success) !important; }
.bg-warning { background-color: var(--status-warning) !important; }
.bg-error { background-color: var(--status-error) !important; }
.bg-info { background-color: var(--status-info) !important; }
.bg-transparent { background-color: transparent !important; }

/* Shadow Utilities */
.shadow-sm { box-shadow: var(--shadow-sm) !important; }
.shadow-md { box-shadow: var(--shadow-md) !important; }
.shadow-lg { box-shadow: var(--shadow-lg) !important; }
.shadow-xl { box-shadow: var(--shadow-xl) !important; }
.shadow-orange { box-shadow: var(--shadow-orange) !important; }
.shadow-none { box-shadow: none !important; }

/* Width & Height Utilities */
.w-25 { width: 25% !important; }
.w-50 { width: 50% !important; }
.w-75 { width: 75% !important; }
.w-100 { width: 100% !important; }
.w-auto { width: auto !important; }

.h-25 { height: 25% !important; }
.h-50 { height: 50% !important; }
.h-75 { height: 75% !important; }
.h-100 { height: 100% !important; }
.h-auto { height: auto !important; }

.mw-100 { max-width: 100% !important; }
.mh-100 { max-height: 100% !important; }

.vw-100 { width: 100vw !important; }
.vh-100 { height: 100vh !important; }

.min-vw-100 { min-width: 100vw !important; }
.min-vh-100 { min-height: 100vh !important; }

/* Opacity Utilities */
.opacity-0 { opacity: 0 !important; }
.opacity-25 { opacity: 0.25 !important; }
.opacity-50 { opacity: 0.5 !important; }
.opacity-75 { opacity: 0.75 !important; }
.opacity-100 { opacity: 1 !important; }

/* Overflow Utilities */
.overflow-auto { overflow: auto !important; }
.overflow-hidden { overflow: hidden !important; }
.overflow-visible { overflow: visible !important; }
.overflow-scroll { overflow: scroll !important; }

.overflow-x-auto { overflow-x: auto !important; }
.overflow-y-auto { overflow-y: auto !important; }
.overflow-x-hidden { overflow-x: hidden !important; }
.overflow-y-hidden { overflow-y: hidden !important; }

/* Cursor Utilities */
.cursor-pointer { cursor: pointer !important; }
.cursor-default { cursor: default !important; }
.cursor-not-allowed { cursor: not-allowed !important; }
.cursor-wait { cursor: wait !important; }
.cursor-move { cursor: move !important; }

/* User Select Utilities */
.user-select-none { user-select: none !important; }
.user-select-auto { user-select: auto !important; }
.user-select-all { user-select: all !important; }

/* Visibility Utilities */
.visible { visibility: visible !important; }
.invisible { visibility: hidden !important; }

/* Animation Keyframes */
@keyframes slideUp {
    from {
        transform: translateY(20px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

@keyframes slideDown {
    from {
        transform: translateY(-20px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

@keyframes fadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideInLeft {
    from {
        transform: translateX(-100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes pulse {
    0%, 100% {
        opacity: 1;
        transform: scale(1);
    }
    50% {
        opacity: 0.7;
        transform: scale(1.05);
    }
}

@keyframes bounce {
    0%, 100% {
        transform: translateY(0);
    }
    50% {
        transform: translateY(-5px);
    }
}

@keyframes shake {
    0%, 100% {
        transform: translateX(0);
    }
    10%, 30%, 50%, 70%, 90% {
        transform: translateX(-5px);
    }
    20%, 40%, 60%, 80% {
        transform: translateX(5px);
    }
}

@keyframes rotate {
    from {
        transform: rotate(0deg);
    }
    to {
        transform: rotate(360deg);
    }
}

@keyframes scale {
    from {
        transform: scale(0.95);
        opacity: 0;
    }
    to {
        transform: scale(1);
        opacity: 1;
    }
}

/* Map Container */
#map {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: var(--map-height);
    z-index: var(--z-base);
    background: var(--app-background);
}

.map-controls {
    position: absolute;
    top: calc(var(--app-header-height) + var(--space-md));
    right: var(--app-padding);
    z-index: var(--z-sticky);
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
}

.map-control-btn {
    width: 40px;
    height: 40px;
    border-radius: var(--radius-circle);
    background: var(--pure-white);
    border: 1px solid var(--white-gray-dark);
    box-shadow: var(--shadow-md);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-primary);
    cursor: pointer;
    transition: all var(--transition-normal);
}

.map-control-btn:hover {
    background: var(--primary-orange);
    color: var(--pure-white);
    transform: scale(1.1);
    box-shadow: var(--shadow-lg);
}

/* Route Navigation Guide - Top Right Corner */
.route-guide {
    position: fixed;
    top: var(--route-guide-top);
    right: var(--route-guide-right);
    width: var(--route-guide-width);
    max-height: var(--route-guide-height);
    background: var(--card-background);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-xl);
    z-index: var(--route-guide-z);
    overflow: hidden;
    animation: var(--animation-slide-in-right);
    border: 1px solid var(--white-gray-dark);
    display: none;
}

.route-guide.active {
    display: block;
}

.route-guide-header {
    padding: var(--space-md);
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-orange-dark));
    color: var(--pure-white);
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.route-guide-title {
    font-size: var(--font-size-md);
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.route-guide-close {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: var(--pure-white);
    font-size: var(--icon-size-md);
    cursor: pointer;
    padding: var(--space-xs);
    border-radius: var(--radius-xs);
    transition: all var(--transition-fast);
}

.route-guide-close:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: rotate(90deg);
}

.route-guide-body {
    padding: 0;
    max-height: calc(var(--route-guide-height) - 60px);
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: var(--primary-orange) var(--white-gray);
}

.route-guide-body::-webkit-scrollbar {
    width: 4px;
}

.route-guide-body::-webkit-scrollbar-track {
    background: var(--white-gray);
}

.route-guide-body::-webkit-scrollbar-thumb {
    background: var(--primary-orange);
    border-radius: var(--radius-xs);
}

.route-step {
    padding: var(--space-md);
    border-bottom: 1px solid var(--white-gray-dark);
    display: flex;
    align-items: flex-start;
    gap: var(--space-md);
    transition: all var(--transition-fast);
    min-height: var(--route-step-height);
}

.route-step:last-child {
    border-bottom: none;
}

.route-step.active {
    background: var(--primary-orange-ultralight);
    border-left: 3px solid var(--primary-orange);
}

.route-step-icon {
    width: 24px;
    height: 24px;
    border-radius: var(--radius-circle);
    background: var(--white-gray);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-secondary);
    font-size: var(--font-size-sm);
    flex-shrink: 0;
    margin-top: 1px;
}

.route-step.active .route-step-icon {
    background: var(--primary-orange);
    color: var(--pure-white);
}

.route-step-content {
    flex: 1;
}

.route-step-instruction {
    font-size: var(--font-size-md);
    color: var(--text-primary);
    font-weight: 500;
    margin-bottom: var(--space-xs);
    line-height: 1.3;
}

.route-step-distance {
    font-size: var(--font-size-sm);
    color: var(--text-tertiary);
    display: flex;
    align-items: center;
    gap: var(--space-xs);
}

.route-step-duration {
    font-size: var(--font-size-sm);
    color: var(--text-tertiary);
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    margin-top: var(--space-xs);
}

.route-step-progress {
    width: 100%;
    height: 3px;
    background: var(--white-gray);
    border-radius: var(--radius-xs);
    overflow: hidden;
    margin-top: var(--space-sm);
}

.route-step-progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--primary-orange), var(--primary-orange-light));
    border-radius: var(--radius-xs);
    transition: width var(--transition-slow);
}

.route-guide-minimized {
    position: fixed;
    top: var(--route-guide-top);
    right: var(--route-guide-right);
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-orange-dark));
    border-radius: var(--radius-circle);
    box-shadow: var(--shadow-lg);
    z-index: var(--route-guide-z);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--pure-white);
    cursor: pointer;
    transition: all var(--transition-normal);
    border: 2px solid var(--pure-white);
    animation: var(--animation-pulse);
}

.route-guide-minimized:hover {
    transform: scale(1.1);
    box-shadow: var(--shadow-xl);
}

.route-guide-minimized .badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: var(--status-error);
    color: var(--pure-white);
    font-size: var(--font-size-xs);
    width: 20px;
    height: 20px;
    border-radius: var(--radius-circle);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    border: 2px solid var(--pure-white);
}

/* Ride Status Components */
.ride-status-bar {
    position: fixed;
    top: calc(var(--app-header-height) + var(--space-md));
    left: 50%;
    transform: translateX(-50%);
    z-index: var(--z-sticky);
    background: var(--card-background);
    padding: var(--space-md) var(--space-lg);
    border-radius: var(--radius-button);
    box-shadow: var(--shadow-lg);
    border: 1px solid var(--white-gray-dark);
    display: none;
    align-items: center;
    gap: var(--space-md);
    min-width: 280px;
    max-width: 90%;
    animation: var(--animation-slide-down);
}

.ride-status-bar.active {
    display: flex;
}

.status-indicator {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.status-dot {
    width: 8px;
    height: 8px;
    border-radius: var(--radius-circle);
    background: var(--status-warning);
    animation: var(--animation-pulse);
}

.status-dot.searching { background: var(--status-warning); }
.status-dot.arriving { background: var(--status-info); }
.status-dot.riding { background: var(--status-success); animation: none; }

.status-text {
    font-weight: 600;
    font-size: var(--font-size-md);
    color: var(--text-primary);
}

.status-eta {
    margin-left: auto;
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    color: var(--text-secondary);
    font-size: var(--font-size-sm);
    font-weight: 500;
}

/* Emergency Components */
.emergency-status {
    position: fixed;
    top: calc(var(--app-header-height) + var(--space-md));
    right: var(--app-padding);
    z-index: var(--z-sticky);
    background: linear-gradient(135deg, var(--status-error), #C0392B);
    color: var(--pure-white);
    padding: var(--space-sm) var(--space-md);
    border-radius: var(--radius-button);
    box-shadow: var(--shadow-lg);
    display: none;
    align-items: center;
    gap: var(--space-sm);
    font-weight: 700;
    font-size: var(--font-size-sm);
    animation: emergencyPulse 1s infinite;
}

@keyframes emergencyPulse {
    0% { 
        transform: scale(1); 
        box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); 
    }
    70% { 
        transform: scale(1.02); 
        box-shadow: 0 0 0 8px rgba(231, 76, 60, 0); 
    }
    100% { 
        transform: scale(1); 
        box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); 
    }
}

.sos-button {
    position: fixed;
    bottom: calc(var(--app-footer-height) + var(--space-lg));
    right: var(--app-padding);
    z-index: var(--z-fixed);
    width: 56px;
    height: 56px;
    background: linear-gradient(135deg, var(--status-error), #C0392B);
    border-radius: var(--radius-circle);
    display: none;
    align-items: center;
    justify-content: center;
    color: var(--pure-white);
    font-size: var(--font-size-lg);
    font-weight: 700;
    box-shadow: var(--shadow-xl);
    cursor: pointer;
    transition: all var(--transition-normal);
    animation: sosPulse 2s infinite;
    border: 2px solid var(--pure-white);
}

@keyframes sosPulse {
    0%, 100% { 
        transform: scale(1); 
        box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.4); 
    }
    50% { 
        transform: scale(1.05); 
        box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); 
    }
}

.sos-button:hover {
    transform: scale(1.1);
    box-shadow: 0 0 20px rgba(231, 76, 60, 0.6);
}

/* Main Panel */
.main-panel {
    position: fixed;
    bottom: var(--app-footer-height);
    left: 0;
    right: 0;
    background: var(--card-background);
    border-radius: var(--radius-lg) var(--radius-lg) 0 0;
    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
    z-index: var(--z-sticky);
    padding: var(--app-padding);
    transition: transform var(--transition-normal);
    max-height: var(--panel-height);
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: var(--primary-orange) var(--white-gray);
    -webkit-overflow-scrolling: touch;
}

.main-panel::-webkit-scrollbar {
    width: 4px;
}

.main-panel::-webkit-scrollbar-track {
    background: var(--white-gray);
    border-radius: var(--radius-xs);
}

.main-panel::-webkit-scrollbar-thumb {
    background: var(--primary-orange);
    border-radius: var(--radius-xs);
}

.main-panel.collapsed {
    transform: translateY(calc(100% - 48px));
}

.panel-handle {
    width: 36px;
    height: 3px;
    background: var(--white-gray-dark);
    border-radius: var(--radius-xs);
    margin: 0 auto var(--space-md);
    cursor: pointer;
    transition: all var(--transition-fast);
}

.panel-handle:hover {
    background: var(--primary-orange);
    width: 48px;
}

/* Service Tabs */
.service-tabs {
    display: flex;
    gap: var(--space-sm);
    margin-bottom: var(--space-lg);
    overflow-x: auto;
    padding: var(--space-xs);
    scrollbar-width: none;
    -webkit-overflow-scrolling: touch;
}

.service-tabs::-webkit-scrollbar {
    display: none;
}

.service-tab {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-sm) var(--space-md);
    background: var(--pure-white);
    border: 2px solid var(--white-gray-dark);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-normal);
    min-width: 90px;
    text-align: center;
    flex-shrink: 0;
}

.service-tab:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
    border-color: var(--primary-orange-light);
}

.service-tab.active {
    border-color: var(--primary-orange);
    background: var(--primary-orange-ultralight);
    box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
}

.service-icon {
    width: 36px;
    height: 36px;
    border-radius: var(--radius-circle);
    background: var(--white-gray);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--icon-size-lg);
    color: var(--text-tertiary);
    transition: all var(--transition-normal);
}

.service-tab.active .service-icon {
    background: var(--primary-orange);
    color: var(--pure-white);
}

.service-name {
    font-weight: 600;
    font-size: var(--font-size-sm);
    color: var(--text-primary);
}

.service-desc {
    font-size: var(--font-size-xs);
    color: var(--text-tertiary);
    margin-top: var(--space-xs);
}

/* Location Inputs */
.location-inputs {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
    margin-bottom: var(--space-lg);
}

.location-input {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-md);
    background: var(--input-background);
    border: 2px solid transparent;
    border-radius: var(--radius-input);
    transition: all var(--transition-fast);
    position: relative;
}

.location-input.active {
    border-color: var(--primary-orange);
    background: var(--pure-white);
    box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
}

.location-input i {
    color: var(--primary-orange);
    font-size: var(--icon-size-md);
    width: 20px;
    text-align: center;
    flex-shrink: 0;
}

.location-input input {
    flex: 1;
    border: none;
    background: transparent;
    outline: none;
    font-size: var(--font-size-md);
    color: var(--text-primary);
    font-weight: 500;
    min-width: 0;
}

.location-input input::placeholder {
    color: var(--text-tertiary);
}

.suggestion-list {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--card-background);
    border: 1px solid var(--white-gray-dark);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-lg);
    z-index: var(--z-dropdown);
    max-height: 250px;
    overflow-y: auto;
    display: none;
    margin-top: var(--space-xs);
    animation: var(--animation-slide-up);
}

.suggestion-list.active {
    display: block;
}

.suggestion-item {
    padding: var(--space-md);
    border-bottom: 1px solid var(--white-gray-dark);
    cursor: pointer;
    transition: all var(--transition-fast);
    display: flex;
    align-items: flex-start;
    gap: var(--space-md);
}

.suggestion-item:hover {
    background: var(--primary-orange-ultralight);
}

.suggestion-item:last-child {
    border-bottom: none;
}

.suggestion-icon {
    color: var(--primary-orange);
    font-size: var(--icon-size-sm);
    margin-top: 2px;
    flex-shrink: 0;
}

.suggestion-details {
    flex: 1;
    min-width: 0;
}

.suggestion-name {
    font-weight: 600;
    font-size: var(--font-size-md);
    color: var(--text-primary);
    margin-bottom: var(--space-xs);
    @extend .truncate;
}

.suggestion-address {
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
    line-height: 1.3;
    @extend .line-clamp-2;
}

.suggestion-distance {
    font-size: var(--font-size-xs);
    color: var(--text-tertiary);
    margin-top: var(--space-xs);
}

/* Ride Type Selection */
.ride-type-selection {
    margin: var(--space-lg) 0;
    display: none;
}

.ride-type-selection.active {
    display: block;
    animation: var(--animation-fade-in);
}

.ride-type-title {
    font-size: var(--font-size-md);
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: var(--space-md);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.ride-type-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--space-sm);
}

.ride-type-card {
    background: var(--pure-white);
    border: 2px solid var(--white-gray-dark);
    border-radius: var(--radius-md);
    padding: var(--space-md);
    cursor: pointer;
    transition: all var(--transition-normal);
    text-align: center;
    position: relative;
    overflow: hidden;
}

.ride-type-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.ride-type-card.selected {
    border-color: var(--primary-orange);
    background: var(--primary-orange-ultralight);
    box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
}

.ride-type-icon {
    width: 40px;
    height: 40px;
    border-radius: var(--radius-md);
    background: var(--white-gray);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto var(--space-sm);
    font-size: var(--icon-size-lg);
    color: var(--text-tertiary);
    transition: all var(--transition-normal);
}

.ride-type-card.selected .ride-type-icon {
    background: var(--primary-orange);
    color: var(--pure-white);
}

.ride-type-name {
    font-weight: 600;
    font-size: var(--font-size-sm);
    color: var(--text-primary);
    margin-bottom: var(--space-xs);
}

.ride-type-price {
    font-size: var(--font-size-lg);
    font-weight: 700;
    color: var(--primary-orange);
    margin-bottom: var(--space-xs);
}

.ride-type-eta {
    font-size: var(--font-size-xs);
    color: var(--text-tertiary);
}

/* Fare Display */
.fare-display {
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-orange-dark));
    color: var(--pure-white);
    padding: var(--space-lg);
    border-radius: var(--radius-md);
    margin: var(--space-lg) 0;
    text-align: center;
    box-shadow: var(--shadow-md);
    display: none;
}

.fare-display.active {
    display: block;
    animation: var(--animation-scale);
}

.fare-label {
    font-size: var(--font-size-sm);
    opacity: 0.9;
    margin-bottom: var(--space-xs);
}

.fare-amount {
    font-size: 28px;
    font-weight: 800;
    margin: var(--space-sm) 0;
}

.fare-details {
    display: flex;
    justify-content: space-between;
    margin-top: var(--space-md);
    font-size: var(--font-size-sm);
    opacity: 0.9;
}

/* Action Buttons */
.action-buttons {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-md);
    margin-top: var(--space-lg);
}

/* Chat Container */
.chat-container {
    position: fixed;
    bottom: calc(var(--app-footer-height) + var(--space-lg));
    right: var(--app-padding);
    z-index: var(--z-modal);
    width: 320px;
    max-width: calc(100vw - 40px);
    background: var(--card-background);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-xl);
    display: none;
    flex-direction: column;
    overflow: hidden;
    border: 1px solid var(--white-gray-dark);
    animation: var(--animation-slide-in-right);
}

.chat-container.active {
    display: flex;
}

.chat-header {
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-orange-dark));
    color: var(--pure-white);
    padding: var(--space-md);
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.chat-title {
    font-weight: 600;
    font-size: var(--font-size-md);
}

.chat-close {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: var(--pure-white);
    font-size: var(--icon-size-md);
    cursor: pointer;
    padding: var(--space-xs);
    border-radius: var(--radius-xs);
    transition: all var(--transition-fast);
}

.chat-close:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: rotate(90deg);
}

.chat-messages {
    flex: 1;
    padding: var(--space-md);
    max-height: 250px;
    overflow-y: auto;
    background: var(--off-white);
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
    scrollbar-width: thin;
    scrollbar-color: var(--primary-orange) var(--white-gray);
}

.chat-messages::-webkit-scrollbar {
    width: 4px;
}

.chat-messages::-webkit-scrollbar-track {
    background: var(--white-gray);
}

.chat-messages::-webkit-scrollbar-thumb {
    background: var(--primary-orange);
    border-radius: var(--radius-xs);
}

.message {
    max-width: 80%;
    padding: var(--space-sm) var(--space-md);
    border-radius: var(--radius-lg);
    font-size: var(--font-size-md);
    line-height: 1.3;
}

.message.sent {
    align-self: flex-end;
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-orange-dark));
    color: var(--pure-white);
    border-bottom-right-radius: var(--radius-xs);
}

.message.received {
    align-self: flex-start;
    background: var(--pure-white);
    color: var(--text-primary);
    border: 1px solid var(--white-gray-dark);
    border-bottom-left-radius: var(--radius-xs);
}

.message-time {
    font-size: var(--font-size-xs);
    color: rgba(255, 255, 255, 0.7);
    margin-top: var(--space-xs);
    text-align: right;
}

.message.received .message-time {
    color: var(--text-tertiary);
}

.chat-input-container {
    padding: var(--space-md);
    background: var(--pure-white);
    border-top: 1px solid var(--white-gray-dark);
    display: flex;
    gap: var(--space-sm);
}

.chat-input {
    flex: 1;
    padding: var(--space-sm) var(--space-md);
    border: 1px solid var(--white-gray-dark);
    border-radius: var(--radius-button);
    font-size: var(--font-size-md);
    outline: none;
    transition: all var(--transition-fast);
}

.chat-input:focus {
    border-color: var(--primary-orange);
    box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
}

.chat-send-btn {
    width: 40px;
    height: 40px;
    border-radius: var(--radius-circle);
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-orange-dark));
    color: var(--pure-white);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-normal);
}

.chat-send-btn:hover {
    transform: scale(1.1);
    box-shadow: var(--shadow-md);
}

/* Media Queries for Responsive Design */
@media (max-width: 480px) {
    :root {
        --app-padding: 10px;
        --space-md: 10px;
        --space-lg: 14px;
        --font-size-md: 11px;
        --font-size-lg: 12px;
        --font-size-xl: 13px;
    }
    
    .ride-type-grid {
        grid-template-columns: 1fr;
        gap: var(--space-xs);
    }
    
    .service-tab {
        min-width: 80px;
        padding: var(--space-xs) var(--space-sm);
    }
    
    .service-icon {
        width: 32px;
        height: 32px;
        font-size: var(--icon-size-md);
    }
    
    .fare-amount {
        font-size: 24px;
    }
    
    .chat-container {
        width: calc(100vw - 20px);
        right: 10px;
        bottom: calc(var(--app-footer-height) + 10px);
    }
    
    .route-guide {
        width: calc(100vw - 40px);
        right: 20px;
    }
    
    .ride-status-bar {
        min-width: 250px;
        padding: var(--space-sm) var(--space-md);
    }
}

@media (max-width: 360px) {
    :root {
        --app-padding: 8px;
        --space-md: 8px;
        --space-lg: 12px;
        --font-size-md: 10px;
        --font-size-lg: 11px;
        --font-size-xl: 12px;
    }
    
    .logo-text {
        font-size: var(--font-size-md);
    }
    
    .nav-label {
        display: none;
    }
    
    .nav-item {
        min-width: 44px;
    }
    
    .service-tabs {
        gap: var(--space-xs);
    }
    
    .service-tab {
        min-width: 70px;
        padding: 6px;
    }
    
    .service-name {
        font-size: var(--font-size-xs);
    }
    
    .service-desc {
        display: none;
    }
}

/* Dark Mode Support */
@media (prefers-color-scheme: dark) {
    :root {
        --app-background: #121212;
        --card-background: #1E1E1E;
        --input-background: #2D2D2D;
        --white-gray: #333333;
        --white-gray-dark: #444444;
        --text-primary: #FFFFFF;
        --text-secondary: #B0B0B0;
        --text-tertiary: #888888;
        --pure-white: #1E1E1E;
        --off-white: #252525;
    }
    
    .shadow-sm { box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3) !important; }
    .shadow-md { box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4) !important; }
    .shadow-lg { box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5) !important; }
    .shadow-xl { box-shadow: 0 6px 20px rgba(0, 0, 0, 0.6) !important; }
    
    .modal-overlay {
        background: rgba(0, 0, 0, 0.7);
    }
    
    .btn-outline {
        border-color: var(--white-gray);
    }
    
    .form-control {
        background: var(--input-background);
        border-color: var(--white-gray);
        color: var(--text-primary);
    }
    
    .form-control:focus {
        background: var(--card-background);
    }
}

/* Print Styles */
@media print {
    .app-header,
    .app-navigation,
    .map-controls,
    .route-guide,
    .route-guide-minimized,
    .ride-status-bar,
    .emergency-status,
    .sos-button,
    .chat-container,
    .modal-overlay,
    .toast-container {
        display: none !important;
    }
    
    #map {
        position: relative;
        height: 300px;
    }
    
    .app-content {
        padding-top: 0;
        padding-bottom: 0;
        overflow: visible;
    }
    
    .card {
        box-shadow: none;
        border: 1px solid #ddd;
        break-inside: avoid;
    }
}

/* Accessibility */
@media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
}

/* High Contrast Mode */
@media (prefers-contrast: high) {
    :root {
        --primary-orange: #FF5500;
        --primary-orange-dark: #CC4400;
        --text-primary: #000000;
        --text-secondary: #333333;
        --white-gray-dark: #000000;
    }
    
    .btn-primary {
        border: 2px solid #000000;
    }
    
    .form-control {
        border: 2px solid #000000;
    }
    
    .card {
        border: 2px solid #000000;
    }
}

/* Touch Device Optimizations */
@media (hover: none) and (pointer: coarse) {
    .btn:hover {
        transform: none;
    }
    
    .btn:active {
        transform: scale(0.98);
    }
    
    .nav-item:hover:not(.active) {
        background: transparent;
    }
    
    .service-tab:hover {
        transform: none;
    }
    
    .card:hover {
        transform: none;
    }
    
    .map-control-btn:hover {
        transform: none;
    }
    
    input, button, select, textarea {
        font-size: 16px; /* Prevents iOS zoom on focus */
    }
    
    .btn, .form-control, .tab, .nav-item {
        min-height: 44px; /* Apple's recommended minimum touch target size */
    }
    
    .btn-icon, .map-control-btn, .modal-close, .toast-close {
        min-width: 44px;
        min-height: 44px;
    }
}

/* Landscape Mode */
@media (orientation: landscape) and (max-height: 500px) {
    :root {
        --map-height: 65vh;
        --panel-height: 35vh;
        --app-footer-height: 50px;
    }
    
    .app-header {
        height: 48px;
    }
    
    .app-navigation {
        height: 50px;
        padding: 5px;
    }
    
    .nav-item {
        padding: 5px;
    }
    
    .nav-icon {
        font-size: var(--icon-size-md);
    }
    
    .chat-container {
        max-height: 80vh;
    }
    
    .route-guide {
        max-height: 150px;
    }
}

/* Very Large Screens */
@media (min-width: 481px) {
    body {
        border-radius: var(--radius-lg);
        margin: 20px auto;
        height: calc(100vh - 40px);
        max-height: 900px;
    }
    
    .app-container {
        border-radius: var(--radius-lg);
        overflow: hidden;
    }
}

/* Loading States */
.loading-skeleton {
    background: linear-gradient(90deg, var(--white-gray) 25%, var(--white-gray-dark) 50%, var(--white-gray) 75%);
    background-size: 200% 100%;
    animation: loadingShimmer 1.5s infinite;
    border-radius: var(--radius-md);
}

@keyframes loadingShimmer {
    0% {
        background-position: 200% 0;
    }
    100% {
        background-position: -200% 0;
    }
}

.skeleton-text {
    height: 1em;
    margin-bottom: var(--space-sm);
    border-radius: var(--radius-xs);
}

.skeleton-text:last-child {
    margin-bottom: 0;
    width: 80%;
}

.skeleton-circle {
    width: 48px;
    height: 48px;
    border-radius: var(--radius-circle);
}

.skeleton-button {
    height: var(--button-height);
    border-radius: var(--radius-button);
}

/* Custom Scrollbar for Webkit */
::-webkit-scrollbar {
    width: 6px;
    height: 6px;
}

::-webkit-scrollbar-track {
    background: var(--white-gray);
    border-radius: var(--radius-xs);
}

::-webkit-scrollbar-thumb {
    background: var(--primary-orange);
    border-radius: var(--radius-xs);
}

::-webkit-scrollbar-thumb:hover {
    background: var(--primary-orange-dark);
}

/* Selection Styling */
::selection {
    background: var(--primary-orange);
    color: var(--pure-white);
}

::-moz-selection {
    background: var(--primary-orange);
    color: var(--pure-white);
}

/* Focus Visible Polyfill */
.js-focus-visible :focus:not(.focus-visible) {
    outline: none;
}

.focus-visible {
    outline: 2px solid var(--primary-orange);
    outline-offset: 2px;
}

/* Reduced Transparency */
@media (prefers-reduced-transparency: reduce) {
    .app-header {
        backdrop-filter: none;
        background: var(--pure-white);
    }
    
    .modal-overlay {
        backdrop-filter: none;
    }
}

/* Custom Font Loading */
@font-face {
    font-family: 'Inter';
    font-style: normal;
    font-weight: 400;
    font-display: swap;
    src: url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
}

/* Performance Optimizations */
.will-change-transform {
    will-change: transform;
}

.will-change-opacity {
    will-change: opacity;
}

.contain-paint {
    contain: paint;
}

/* Service Specific Styles */
.service-indicator {
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-xs) var(--space-sm);
    border-radius: var(--radius-xl);
    font-size: var(--font-size-xs);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.indicator-car {
    background: var(--primary-orange-ultralight);
    color: var(--primary-orange);
    border: 1px solid rgba(255, 107, 53, 0.2);
}

.indicator-delivery {
    background: rgba(142, 68, 173, 0.1);
    color: var(--delivery-service);
    border: 1px solid rgba(142, 68, 173, 0.2);
}

.indicator-truck {
    background: rgba(139, 69, 19, 0.1);
    color: var(--truck-service);
    border: 1px solid rgba(139, 69, 19, 0.2);
}

.indicator-shopping {
    background: rgba(22, 160, 133, 0.1);
    color: var(--shopping-service);
    border: 1px solid rgba(22, 160, 133, 0.2);
}

.indicator-emergency {
    background: rgba(231, 76, 60, 0.1);
    color: var(--emergency-service);
    border: 1px solid rgba(231, 76, 60, 0.2);
}

/* Price Tag Styles */
.price-tag {
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-xs) var(--space-sm);
    background: var(--primary-orange-ultralight);
    border: 1px solid rgba(255, 107, 53, 0.2);
    border-radius: var(--radius-md);
    font-size: var(--font-size-sm);
    font-weight: 600;
    color: var(--primary-orange);
}

.price-tag::before {
    content: 'ZMW';
    font-size: var(--font-size-xs);
    opacity: 0.7;
}

/* Distance Indicator */
.distance-indicator {
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-xs) var(--space-sm);
    background: var(--white-gray);
    border-radius: var(--radius-md);
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
}

.distance-indicator i {
    color: var(--primary-orange);
}

/* ETA Indicator */
.eta-indicator {
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-xs) var(--space-sm);
    background: var(--white-gray);
    border-radius: var(--radius-md);
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
}

.eta-indicator i {
    color: var(--status-info);
}

/* Rating Stars */
.rating-stars {
    display: inline-flex;
    align-items: center;
    gap: 1px;
}

.star {
    color: var(--white-gray-dark);
    font-size: var(--font-size-sm);
}

.star.filled {
    color: var(--status-warning);
}

.star.half {
    position: relative;
    color: var(--white-gray-dark);
}

.star.half::before {
    content: 'â˜…';
    position: absolute;
    left: 0;
    width: 50%;
    overflow: hidden;
    color: var(--status-warning);
}

/* Driver Verification Badge */
.verified-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 16px;
    height: 16px;
    background: var(--status-success);
    color: var(--pure-white);
    border-radius: var(--radius-circle);
    font-size: var(--font-size-xs);
    margin-left: var(--space-xs);
}

/* Online Status Indicator */
.status-indicator-circle {
    width: 8px;
    height: 8px;
    border-radius: var(--radius-circle);
    background: var(--status-success);
    border: 2px solid var(--pure-white);
    box-shadow: var(--shadow-sm);
}

.status-indicator-circle.offline {
    background: var(--text-tertiary);
}

.status-indicator-circle.busy {
    background: var(--status-error);
}

.status-indicator-circle.away {
    background: var(--status-warning);
}

/* Gradient Text */
.gradient-text {
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-orange-dark));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

/* Glass Morphism */
.glass-effect {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

/* Neumorphism */
.neumorphic {
    background: var(--app-background);
    border-radius: var(--radius-md);
    box-shadow: 
        5px 5px 10px rgba(0, 0, 0, 0.1),
        -5px -5px 10px rgba(255, 255, 255, 0.7);
}

.neumorphic-inset {
    background: var(--app-background);
    border-radius: var(--radius-md);
    box-shadow: 
        inset 5px 5px 10px rgba(0, 0, 0, 0.1),
        inset -5px -5px 10px rgba(255, 255, 255, 0.7);
}

/* Tooltip */
.tooltip {
    position: absolute;
    background: var(--text-primary);
    color: var(--pure-white);
    padding: var(--space-xs) var(--space-sm);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-xs);
    white-space: nowrap;
    z-index: var(--z-tooltip);
    pointer-events: none;
    opacity: 0;
    transform: translateY(-5px);
    transition: all var(--transition-fast);
}

.tooltip::before {
    content: '';
    position: absolute;
    bottom: -4px;
    left: 50%;
    transform: translateX(-50%);
    border-width: 4px 4px 0;
    border-style: solid;
    border-color: var(--text-primary) transparent transparent transparent;
}

.tooltip.visible {
    opacity: 1;
    transform: translateY(0);
}

/* Divider */
.divider {
    height: 1px;
    background: var(--white-gray-dark);
    margin: var(--space-lg) 0;
    position: relative;
    overflow: hidden;
}

.divider.dashed {
    background: none;
    border-bottom: 1px dashed var(--white-gray-dark);
}

.divider.or {
    text-align: center;
}

.divider.or::before {
    content: 'or';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: var(--app-background);
    padding: 0 var(--space-md);
    color: var(--text-tertiary);
    font-size: var(--font-size-sm);
}

/* Empty State */
.empty-state {
    padding: var(--space-xl) var(--space-lg);
    text-align: center;
    color: var(--text-tertiary);
}

.empty-icon {
    font-size: 48px;
    margin-bottom: var(--space-lg);
    opacity: 0.3;
}

.empty-title {
    font-size: var(--font-size-lg);
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: var(--space-sm);
}

.empty-description {
    font-size: var(--font-size-md);
    line-height: 1.4;
    max-width: 300px;
    margin: 0 auto;
}

/* Pull to Refresh */
.pull-to-refresh {
    position: absolute;
    top: -60px;
    left: 0;
    right: 0;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s;
}

.pull-to-refresh.active {
    opacity: 1;
}

.pull-to-refresh-icon {
    width: 40px;
    height: 40px;
    border-radius: var(--radius-circle);
    background: var(--primary-orange);
    color: var(--pure-white);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--icon-size-lg);
    transform: rotate(0deg);
    transition: transform 0.3s;
}

.pull-to-refresh.active .pull-to-refresh-icon {
    animation: var(--animation-rotate);
}

/* Swipe Actions */
.swipe-actions {
    position: relative;
    overflow: hidden;
}

.swipe-content {
    position: relative;
    z-index: 1;
    background: var(--card-background);
    transition: transform 0.3s;
}

.swipe-actions-container {
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    display: flex;
}

.swipe-action {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 var(--space-lg);
    color: var(--pure-white);
    font-size: var(--font-size-sm);
    font-weight: 600;
    white-space: nowrap;
    transition: all 0.3s;
}

.swipe-action.delete {
    background: var(--status-error);
}

.swipe-action.archive {
    background: var(--status-warning);
}

.swipe-action.more {
    background: var(--text-secondary);
}

/* Haptic Feedback */
.haptic-light {
    -webkit-tap-highlight-color: rgba(255, 107, 53, 0.3);
}

.haptic-medium {
    -webkit-tap-highlight-color: rgba(255, 107, 53, 0.5);
}

.haptic-strong {
    -webkit-tap-highlight-color: rgba(255, 107, 53, 0.7);
}

/* Micro Interactions */
.micro-interaction {
    transition: all var(--transition-fast);
}

.micro-interaction:active {
    transform: scale(0.98);
}

.micro-interaction.hover-lift:hover {
    transform: translateY(-2px);
}

.micro-interaction.hover-scale:hover {
    transform: scale(1.02);
}

.micro-interaction.hover-rotate:hover {
    transform: rotate(5deg);
}

/* Loading Shimmer */
.shimmer {
    background: linear-gradient(
        90deg,
        var(--white-gray) 0%,
        var(--white-gray-dark) 50%,
        var(--white-gray) 100%
    );
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
}

@keyframes shimmer {
    0% {
        background-position: -200% 0;
    }
    100% {
        background-position: 200% 0;
    }
}

/* Confetti Effect */
.confetti {
    position: fixed;
    width: 10px;
    height: 10px;
    background: var(--primary-orange);
    border-radius: var(--radius-xs);
    opacity: 0;
    z-index: var(--z-max);
    pointer-events: none;
}

/* Ripple Effect */
.ripple {
    position: absolute;
    border-radius: var(--radius-circle);
    background: rgba(255, 107, 53, 0.3);
    transform: scale(0);
    animation: ripple 0.6s linear;
    pointer-events: none;
}

@keyframes ripple {
    to {
        transform: scale(4);
        opacity: 0;
    }
}

/* Page Transitions */
.page-transition-enter {
    opacity: 0;
    transform: translateX(20px);
}

.page-transition-enter-active {
    opacity: 1;
    transform: translateX(0);
    transition: opacity 300ms, transform 300ms;
}

.page-transition-exit {
    opacity: 1;
    transform: translateX(0);
}

.page-transition-exit-active {
    opacity: 0;
    transform: translateX(-20px);
    transition: opacity 300ms, transform 300ms;
}

/* App Store Like Animations */
.app-store-card {
    transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.app-store-card:hover {
    transform: translateY(-10px) scale(1.02);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
}

/* iOS Style Switch */
.ios-switch {
    position: relative;
    width: 51px;
    height: 31px;
    background: var(--white-gray-dark);
    border-radius: 31px;
    transition: all 0.3s;
    cursor: pointer;
}

.ios-switch::after {
    content: '';
    position: absolute;
    top: 2px;
    left: 2px;
    width: 27px;
    height: 27px;
    background: var(--pure-white);
    border-radius: var(--radius-circle);
    transition: all 0.3s;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.ios-switch.active {
    background: var(--primary-orange);
}

.ios-switch.active::after {
    transform: translateX(20px);
}

/* Material Design Ripple */
.material-ripple {
    position: relative;
    overflow: hidden;
}

.material-ripple::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 5px;
    height: 5px;
    background: rgba(255, 107, 53, 0.3);
    opacity: 0;
    border-radius: var(--radius-circle);
    transform: scale(1, 1) translate(-50%);
    transform-origin: 50% 50%;
}

.material-ripple:focus:not(:active)::after {
    animation: material-ripple 1s ease-out;
}

@keyframes material-ripple {
    0% {
        transform: scale(0, 0);
        opacity: 0.5;
    }
    100% {
        transform: scale(20, 20);
        opacity: 0;
    }
}

/* Final Touches - Performance Optimizations */
@media (prefers-reduced-motion: reduce) {
    .shimmer,
    .ripple,
    .confetti,
    .material-ripple::after,
    .pull-to-refresh-icon,
    .route-step-progress-bar::after,
    .progress-bar::after {
        animation: none !important;
    }
    
    .micro-interaction,
    .app-store-card,
    .btn,
    .card,
    .service-tab,
    .ride-type-card,
    .nav-item,
    .user-avatar,
    .map-control-btn,
    .sos-button,
    .route-guide-minimized {
        transition: none !important;
    }
}

/* Print Optimization */
@media print {
    * {
        color: #000 !important;
        background: #fff !important;
        box-shadow: none !important;
        text-shadow: none !important;
    }
    
    .btn,
    .badge,
    .alert,
    .modal,
    .toast,
    .tooltip {
        display: none !important;
    }
    
    a[href]::after {
        content: " (" attr(href) ")";
    }
    
    abbr[title]::after {
        content: " (" attr(title) ")";
    }
}

/* Extreme Edge Cases */
@media (max-width: 240px) {
    .logo-text,
    .nav-label,
    .service-desc,
    .fare-details,
    .status-eta {
        display: none;
    }
    
    .service-tab {
        min-width: 60px;
        padding: 4px;
    }
    
    .service-icon {
        width: 24px;
        height: 24px;
        font-size: var(--icon-size-sm);
    }
    
    .btn {
        padding: 0 12px;
        font-size: var(--font-size-sm);
    }
}

/* Pixel Perfect Adjustments */
.pixel-perfect {
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    text-rendering: optimizeLegibility;
    image-rendering: -webkit-optimize-contrast;
    image-rendering: crisp-edges;
}

/* Final Export Ready */
.export-ready {
    /* This class ensures all styles are properly exported */
    all: initial;
    all: unset;
}

/* The following ensures compatibility with the original HTML structure */
#mapLoadingOverlay,
#cityDetection,
#rideStatusBar,
#emergencyStatus,
#sosButton,
#chatContainer,
#notificationsPanel,
#dropdownMenu,
#moreOptionsMenu,
#homeContent,
#historyScreen,
#accountScreen,
#emergencyScreen,
.modal-overlay,
#loadingOverlay,
#toastContainer,
#realTimeIndicator,
#syncIndicator {
    /* These IDs are preserved from original HTML */
    position: relative;
}

/* Ensure all original functionality is maintained */
[class*="jubel-"],
[data-ride],
[data-service],
[data-screen],
[data-modal],
[data-action],
[data-option],
[data-type],
[data-reason],
[data-payment],
[data-ride-id],
[data-notification-id],
[data-station-id],
[data-phone] {
    /* Preserve data attribute functionality */
    cursor: pointer;
}

/* Touch device optimizations for original elements */
@media (hover: none) and (pointer: coarse) {
    .location-input,
    .suggestion-item,
    .ride-type-card,
    .service-tab,
    .tab,
    .nav-tab,
    .dropdown-item,
    .emergency-service,
    .cancel-reason,
    .emergency-reason,
    .payment-method,
    .filter-btn,
    .history-item,
    .notification-item,
    .emergency-station,
    .broadcast-recipient {
        min-height: 44px;
    }
}

/* Ensure route guide is always on top of map controls */
.route-guide,
.route-guide-minimized {
    z-index: calc(var(--z-fixed) + 1);
}

/* Final size adjustments for app-like feel */
body {
    font-size: 14px;
}

.app-container {
    font-size: 14px;
}

/* Ensure all buttons have proper curved design */
button,
.btn,
[type="button"],
[type="submit"],
[type="reset"],
.nav-tab,
.service-tab,
.tab,
.filter-btn,
.dropdown-item,
.emergency-service,
.cancel-reason,
.emergency-reason,
.payment-method {
    border-radius: var(--radius-button);
}

/* Ensure all cards have consistent curved design */
.card,
.modal,
.toast,
.alert,
.route-guide,
.chat-container,
.ride-status-bar,
.emergency-status,
.suggestion-list,
.dropdown-menu,
.notifications-panel,
.more-options-menu {
    border-radius: var(--radius-card);
}

/* Ensure all inputs have consistent curved design */
input,
select,
textarea,
.form-control,
.location-input,
.chat-input {
    border-radius: var(--radius-input);
}

/* Final color consistency check */
.primary-color {
    color: var(--primary-orange);
}

.primary-bg {
    background-color: var(--primary-orange);
}

.white-color {
    color: var(--pure-white);
}

.white-bg {
    background-color: var(--pure-white);
}

/* Export complete - This CSS file is now ready for production use */
    </style>
</head>
<body>
    <!-- Map Container -->
    <div id="map">
        <div class="map-loading-overlay" id="mapLoadingOverlay">
            <div class="loading-spinner"></div>
            <div class="map-loading-text">Loading map...</div>
        </div>
    </div>
    
    <!-- Top Navigation Bar -->
    <div class="top-bar">
        <div class="logo-container">
            <div class="logo-icon">
                <img src="jubel.png" alt="Jubel Logo" id="jubelLogo">
            </div>
            <div class="logo-text" id="userFullName">Loading...</div>
        </div>
        
        <div class="user-actions">
            <div class="balance-badge" id="balanceBadge">
                <i class="fas fa-wallet"></i>
                <span>Balance: <span class="balance-amount" id="walletBalance">ZMW 0.00</span></span>
            </div>
            <div class="notification-bell" id="notificationBell">
                <i class="fas fa-bell"></i>
                <span class="notification-badge" id="notificationCount">0</span>
            </div>
        </div>
    </div>
    
    <!-- City Detection Indicator -->
    <div class="city-detection" id="cityDetection">
        <i class="fas fa-map-marker-alt"></i>
        <span id="currentCityDisplay">Detecting your city...</span>
    </div>
    
    <!-- Ride Status Bar -->
    <div class="ride-status-bar" id="rideStatusBar">
        <div class="status-indicator">
            <div class="status-dot searching" id="statusDot"></div>
            <span class="status-text" id="statusText">Searching for driver</span>
        </div>
        <div class="status-eta">
            <i class="fas fa-clock"></i>
            <span id="etaText">5 min</span>
        </div>
    </div>
    
    <!-- Emergency Status -->
    <div class="emergency-status" id="emergencyStatus">
        <i class="fas fa-exclamation-triangle"></i>
        <span>EMERGENCY RIDE IN PROGRESS</span>
    </div>
    
    <!-- SOS Button -->
    <div class="sos-button" id="sosButton">
        <i class="fas fa-exclamation-triangle"></i>
    </div>
    
    <!-- Map Controls -->
    <div class="map-controls">
        <button class="map-control-btn" id="locateMeBtn" title="Locate Me">
            <i class="fas fa-location-arrow"></i>
        </button>
        <button class="map-control-btn" id="zoomInBtn" title="Zoom In">
            <i class="fas fa-plus"></i>
        </button>
        <button class="map-control-btn" id="zoomOutBtn" title="Zoom Out">
            <i class="fas fa-minus"></i>
        </button>
        <button class="map-control-btn" id="clearRouteBtn" title="Clear Route">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <!-- Chat Container -->
    <div class="chat-container" id="chatContainer">
        <div class="chat-header">
            <div class="chat-title">Chat with Driver</div>
            <button class="chat-close" id="chatClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <!-- Messages will be inserted here -->
        </div>
        <div class="chat-typing-indicator" id="typingIndicator">
            Driver is typing...
        </div>
        <div class="chat-input-container">
            <button class="chat-attachment-btn" id="attachmentBtn">
                <i class="fas fa-paperclip"></i>
            </button>
            <input type="text" class="chat-input" id="chatInput" placeholder="Type your message...">
            <button class="chat-send-btn" id="chatSend">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
    
    <!-- Notifications Panel -->
    <div class="notifications-panel" id="notificationsPanel">
        <div class="notifications-header">
            <div class="notifications-title">Notifications</div>
            <button class="notifications-close" id="notificationsClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="notifications-list" id="notificationsList">
            <!-- Notifications will be inserted here -->
        </div>
    </div>
    
    <!-- Dropdown Menu -->
    <div class="dropdown-menu" id="dropdownMenu">
        <div class="dropdown-item" data-action="profile">
            <i class="fas fa-user"></i>
            <span>Profile</span>
        </div>
        <div class="dropdown-item" data-action="settings">
            <i class="fas fa-cog"></i>
            <span>Settings</span>
        </div>
        <div class="dropdown-item" data-action="help">
            <i class="fas fa-question-circle"></i>
            <span>Help & Support</span>
        </div>
        <div class="dropdown-item" data-action="logout">
            <i class="fas fa-sign-out-alt"></i>
            <span>Logout</span>
        </div>
    </div>
    
    <!-- More Options Menu -->
    <div class="more-options-menu" id="moreOptionsMenu">
        <div class="dropdown-item" data-option="schedule">
            <i class="fas fa-calendar-alt"></i>
            <span>Schedule Ride</span>
        </div>
        <div class="dropdown-item" data-option="orderForSomeone">
            <i class="fas fa-user-friends"></i>
            <span>Order for Someone</span>
        </div>
        <div class="dropdown-item" data-option="shareRide">
            <i class="fas fa-share-alt"></i>
            <span>Share Ride</span>
        </div>
        <div class="dropdown-item" data-option="broadcast">
            <i class="fas fa-broadcast-tower"></i>
            <span>Broadcast Ride</span>
        </div>
    </div>
    
    <!-- Main Panel -->
    <div class="main-panel" id="mainPanel">
        <div class="panel-handle" id="panelHandle"></div>
        
        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" data-screen="home">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </button>
            <button class="nav-tab" data-screen="history">
                <i class="fas fa-history"></i>
                <span>History</span>
            </button>
            <button class="nav-tab" data-screen="account">
                <i class="fas fa-user"></i>
                <span>Account</span>
            </button>
            <button class="nav-tab" data-screen="emergency">
                <i class="fas fa-ambulance"></i>
                <span>Emergency</span>
            </button>
        </div>
        
        <!-- Home Screen Content -->
        <div id="homeContent">
            <!-- Service Tabs -->
            <div class="service-tabs" id="serviceTabs">
                <div class="service-tab car active" data-service="car">
                    <div class="service-icon">
                        <i class="fas fa-car"></i>
                    </div>
                    <div class="service-name">Car</div>
                    <div class="service-desc">Ride anywhere</div>
                </div>
                
                <div class="service-tab delivery" data-service="delivery">
                    <div class="service-icon">
                        <i class="fas fa-shipping-fast"></i>
                    </div>
                    <div class="service-name">Delivery</div>
                    <div class="service-desc">Send packages</div>
                </div>
                
                <div class="service-tab short-delivery" data-service="short-delivery">
                    <div class="service-icon">
                        <i class="fas fa-bicycle"></i>
                    </div>
                    <div class="service-name">Short Delivery</div>
                    <div class="service-desc">Quick deliveries</div>
                </div>
                
                <div class="service-tab" data-service="express">
                    <div class="service-icon">
                        <i class="fas fa-shopping-bag"></i>
                    </div>
                    <div class="service-name">Express Shopping</div>
                    <div class="service-desc">Shop for you</div>
                </div>
                
                <div class="service-tab" data-service="truck">
                    <div class="service-icon">
                        <i class="fas fa-truck"></i>
                    </div>
                    <div class="service-name">Truck</div>
                    <div class="service-desc">Move items</div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="quick-actions">
                <button class="quick-action-btn" id="moreOptionsBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-ellipsis-h"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">More Options</div>
                        <div class="quick-action-desc">Schedule, share, broadcast</div>
                    </div>
                </button>
                <button class="quick-action-btn" id="broadcastRideBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-broadcast-tower"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">Broadcast Ride</div>
                        <div class="quick-action-desc">Share with friends</div>
                    </div>
                </button>
                <button class="quick-action-btn" id="sosSetupBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">SOS Setup</div>
                        <div class="quick-action-desc">Emergency contacts</div>
                    </div>
                </button>
                <button class="quick-action-btn" id="recentDestinationsBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-history"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">Recent Destinations</div>
                        <div class="quick-action-desc">Quick access</div>
                    </div>
                </button>
            </div>
            
            <!-- Car Service Form (Default) -->
            <div class="ride-request-form active" id="carForm">
                <div class="form-title">
                    <i class="fas fa-car"></i>
                    Book a Ride
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="pickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="pickupLocation" placeholder="Current location" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="pickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="destinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="destinationLocation" placeholder="Where to?" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="destinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Search History -->
                <div class="search-history" id="searchHistory" style="display: none;"></div>
                
                <!-- Ride Type Selection -->
                <div class="ride-type-selection" id="rideTypeSelection">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                        <span id="rideTypeInfo" style="font-size: 11px; color: var(--text-light); cursor: pointer;">
                            <i class="fas fa-info-circle"></i>
                        </span>
                    </div>
                    
                    <div class="ride-type-grid">
                        <div class="ride-type-card economy" data-type="economy">
                            <div class="ride-type-icon">
                                <i class="fas fa-car-side"></i>
                            </div>
                            <div class="ride-type-name">Economy</div>
                            <div class="ride-type-price" id="economyPrice">ZMW 0.00</div>
                            <div class="ride-type-eta">ETA: 5-10 min</div>
                        </div>
                        
                        <div class="ride-type-card selected" data-type="standard">
                            <div class="ride-type-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="ride-type-name">Standard</div>
                            <div class="ride-type-price" id="standardPrice">ZMW 0.00</div>
                            <div class="ride-type-eta">ETA: 3-7 min</div>
                        </div>
                        
                        <div class="ride-type-card premium" data-type="premium">
                            <div class="ride-type-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="ride-type-name">Premium</div>
                            <div class="ride-type-price" id="premiumPrice">ZMW 0.00</div>
                            <div class="ride-type-eta">ETA: 2-5 min</div>
                        </div>
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="fareDisplay">
                    <div class="fare-label">Estimated Fare</div>
                    <div class="fare-amount" id="estimatedFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="distanceDetail">0 km</span>
                        <span id="timeDetail">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Price Calculator Display -->
                <div class="price-calculator-display" id="priceCalculator" style="display: none;">
                    <div class="fare-label">Fare Breakdown</div>
                    <div class="fare-amount" id="calculatedFare">ZMW 0.00</div>
                    <div class="price-breakdown" id="priceBreakdown">
                        <!-- Breakdown will be inserted here -->
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestRideBtn">
                        <i class="fas fa-search"></i>
                        Request Ride
                    </button>
                </div>
            </div>
            
            <!-- Delivery Service Form -->
            <div class="service-form delivery-form" id="deliveryForm">
                <div class="form-title">
                    <i class="fas fa-shipping-fast"></i>
                    Package Delivery
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="deliveryPickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="deliveryPickup" placeholder="Pickup location" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="deliveryPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="deliveryDestinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="deliveryDestination" placeholder="Delivery address" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="deliveryDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Delivery Details -->
                <div class="form-group">
                    <label class="form-label">Parcel Description</label>
                    <input type="text" class="form-control" id="parcelDescription" placeholder="What are you sending?">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Receiver's Details</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="receiverName" placeholder="Receiver name">
                        <input type="tel" class="form-control" id="receiverPhone" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Parcel Value (ZMW)</label>
                    <input type="number" class="form-control" id="parcelValue" placeholder="Value of parcel" min="0" step="0.01">
                </div>
                
                <!-- Delivery Options -->
                <div class="form-group">
                    <label class="form-label">Delivery Type</label>
                    <div style="display: flex; gap: 10px;">
                        <button class="filter-btn active" id="standardDelivery">Standard</button>
                        <button class="filter-btn" id="expressDelivery">Express</button>
                        <button class="filter-btn" id="sameDayDelivery">Same Day</button>
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="deliveryFareDisplay" style="display: none;">
                    <div class="fare-label">Delivery Fare</div>
                    <div class="fare-amount" id="deliveryFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="deliveryDistance">0 km</span>
                        <span id="deliveryTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestDeliveryBtn">
                        <i class="fas fa-shipping-fast"></i>
                        Request Delivery
                    </button>
                </div>
            </div>
            
            <!-- Short Delivery Form -->
            <div class="service-form delivery-form" id="shortDeliveryForm">
                <div class="form-title">
                    <i class="fas fa-bicycle"></i>
                    Short Delivery
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="shortDeliveryPickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="shortDeliveryPickup" placeholder="Pickup location" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shortDeliveryPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="shortDeliveryDestinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="shortDeliveryDestination" placeholder="Delivery address" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shortDeliveryDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Delivery Details -->
                <div class="form-group">
                    <label class="form-label">What are you sending?</label>
                    <input type="text" class="form-control" id="shortParcelDescription" placeholder="Food, documents, small items...">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Receiver's Phone</label>
                    <input type="tel" class="form-control" id="shortReceiverPhone" placeholder="Receiver phone number">
                </div>
                
                <!-- Quick Options -->
                <div class="form-group">
                    <label class="form-label">Quick Options</label>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <span class="filter-btn">Food</span>
                        <span class="filter-btn">Documents</span>
                        <span class="filter-btn">Medication</span>
                        <span class="filter-btn">Small Package</span>
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="shortDeliveryFareDisplay" style="display: none;">
                    <div class="fare-label">Delivery Fare</div>
                    <div class="fare-amount" id="shortDeliveryFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="shortDeliveryDistance">0 km</span>
                        <span id="shortDeliveryTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestShortDeliveryBtn">
                        <i class="fas fa-bolt"></i>
                        Quick Delivery
                    </button>
                </div>
            </div>
            
            <!-- Express Shopping Form -->
            <div class="service-form express-form" id="expressForm">
                <div class="form-title">
                    <i class="fas fa-shopping-bag"></i>
                    Express Shopping
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="shopNameInput">
                        <i class="fas fa-store"></i>
                        <input type="text" id="shopName" placeholder="Shop/Restaurant name" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shopSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="shopLocation" placeholder="Shop location" readonly>
                    </div>
                </div>
                
                <!-- Items List -->
                <div class="form-group">
                    <label class="form-label">Shopping List</label>
                    <div class="item-list" id="shoppingItems">
                        <div class="item-entry">
                            <input type="text" class="item-input" placeholder="Item name">
                            <button class="remove-item" type="button">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <button class="add-item" type="button" id="addItemBtn">
                        <i class="fas fa-plus"></i>
                        Add Item
                    </button>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Special Instructions</label>
                    <textarea class="form-control form-textarea" id="shoppingInstructions" placeholder="Any specific requests or instructions..."></textarea>
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="shoppingDestinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="shoppingDestination" placeholder="Delivery address" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shoppingDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Budget -->
                <div class="form-group">
                    <label class="form-label">Estimated Budget (ZMW)</label>
                    <input type="number" class="form-control" id="shoppingBudget" placeholder="Estimated cost of items">
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="shoppingFareDisplay" style="display: none;">
                    <div class="fare-label">Shopping Service Fare</div>
                    <div class="fare-amount" id="shoppingFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="shoppingDistance">0 km</span>
                        <span id="shoppingTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestShoppingBtn">
                        <i class="fas fa-shopping-cart"></i>
                        Request Shopping
                    </button>
                </div>
            </div>
            
            <!-- Truck Delivery Form -->
            <div class="service-form truck-form" id="truckForm">
                <div class="form-title">
                    <i class="fas fa-truck"></i>
                    Truck Delivery
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="truckPickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="truckPickup" placeholder="Pickup location (Current location)" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="truckPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="truckDestinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="truckDestination" placeholder="Destination" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="truckDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Truck Type Selection -->
                <div class="form-group">
                    <label class="form-label">Select Truck Type</label>
                    <div class="truck-types">
                        <div class="truck-type" data-type="pickup">
                            <div class="truck-icon">
                                <i class="fas fa-truck-pickup"></i>
                            </div>
                            <div class="truck-name">Pickup Truck</div>
                            <div class="truck-capacity">Up to 1.5 tons</div>
                        </div>
                        
                        <div class="truck-type selected" data-type="light">
                            <div class="truck-icon">
                                <i class="fas fa-truck-moving"></i>
                            </div>
                            <div class="truck-name">Light Truck</div>
                            <div class="truck-capacity">Up to 3 tons</div>
                        </div>
                        
                        <div class="truck-type" data-type="medium">
                            <div class="truck-icon">
                                <i class="fas fa-truck"></i>
                            </div>
                            <div class="truck-name">Medium Truck</div>
                            <div class="truck-capacity">Up to 7 tons</div>
                        </div>
                        
                        <div class="truck-type" data-type="heavy">
                            <div class="truck-icon">
                                <i class="fas fa-truck-loading"></i>
                            </div>
                            <div class="truck-name">Heavy Truck</div>
                            <div class="truck-capacity">Up to 15 tons</div>
                        </div>
                    </div>
                </div>
                
                <!-- Item Details -->
                <div class="form-group">
                    <label class="form-label">What are you moving?</label>
                    <input type="text" class="form-control" id="truckItemDescription" placeholder="Furniture, boxes, equipment...">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Estimated Weight (kg)</label>
                    <input type="number" class="form-control" id="estimatedWeight" placeholder="Approximate weight">
                </div>
                
                <!-- Additional Help -->
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="needHelpers">
                        <span style="margin-left: 8px;">Need loading/unloading helpers (+ZMW 50)</span>
                    </label>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="truckFareDisplay" style="display: none;">
                    <div class="fare-label">Truck Fare</div>
                    <div class="fare-amount" id="truckFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="truckDistance">0 km</span>
                        <span id="truckTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestTruckBtn">
                        <i class="fas fa-truck"></i>
                        Request Truck
                    </button>
                </div>
            </div>
            
            <!-- Ride Info Panel -->
            <div class="ride-info-panel" id="rideInfoPanel">
                <div class="driver-info">
                    <div class="driver-avatar" id="driverAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="driver-details">
                        <div class="driver-name" id="driverName">Driver Name</div>
                        <div class="driver-rating">
                            <i class="fas fa-star"></i>
                            <span id="driverRating">4.8</span>
                        </div>
                        <div class="driver-vehicle">
                            <i class="fas fa-car"></i>
                            <span id="vehicleDetails">Toyota Corolla - ABC 123</span>
                        </div>
                    </div>
                </div>
                
                <!-- Driver Media Display -->
                <div class="driver-media" id="driverMedia">
                    <div class="media-container">
                        <div class="media-placeholder" id="driverImagePlaceholder">
                            <i class="fas fa-user"></i>
                            <span>Driver Image</span>
                        </div>
                        <img id="driverImage" style="display: none;">
                    </div>
                    <div class="media-container">
                        <div class="media-placeholder" id="vehicleImagePlaceholder">
                            <i class="fas fa-car"></i>
                            <span>Vehicle Image</span>
                        </div>
                        <img id="vehicleImage" style="display: none;">
                    </div>
                </div>
                
                <!-- Tracking Info -->
                <div class="tracking-info" id="trackingInfo">
                    <div class="tracking-header">
                        <div class="tracking-title">Driver Distance</div>
                        <div class="tracking-distance" id="driverDistance">0 km</div>
                    </div>
                    <div class="tracking-progress">
                        <div class="tracking-progress-bar" id="trackingProgress" style="width: 0%"></div>
                    </div>
                    <div class="tracking-details">
                        <span id="pickupDistance">0 km to pickup</span>
                        <span id="etaToPickup">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Timeline -->
                <div class="timeline" id="rideTimeline">
                    <div class="timeline-step">
                        <div class="step-dot active" id="stepRequested">
                            <i class="fas fa-search"></i>
                        </div>
                        <div class="step-label active">Requested</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepAccepted">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <div class="step-label">Accepted</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepArrived">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="step-label">Arrived</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepStarted">
                            <i class="fas fa-play"></i>
                        </div>
                        <div class="step-label">Started</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepCompleted">
                            <i class="fas fa-flag-checkered"></i>
                        </div>
                        <div class="step-label">Completed</div>
                    </div>
                </div>
                
                <div class="trip-details">
                    <div class="trip-locations">
                        <div class="location-point">
                            <div class="location-marker pickup">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="location-text">
                                <div class="location-label">Pickup</div>
                                <div class="location-address" id="currentPickup">Loading...</div>
                            </div>
                        </div>
                        
                        <div class="location-point">
                            <div class="location-marker destination">
                                <i class="fas fa-flag"></i>
                            </div>
                            <div class="location-text">
                                <div class="location-label">Destination</div>
                                <div class="location-address" id="currentDestination">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Location Details -->
                <div class="location-details">
                    <div class="location-detail-item">
                        <div class="location-detail-icon">
                            <i class="fas fa-road"></i>
                        </div>
                        <div class="location-detail-content">
                            <div class="location-detail-label">Distance</div>
                            <div class="location-detail-value" id="rideDistance">0 km</div>
                        </div>
                    </div>
                    <div class="location-detail-item">
                        <div class="location-detail-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="location-detail-content">
                            <div class="location-detail-label">Estimated Time</div>
                            <div class="location-detail-value" id="rideTime">0 min</div>
                        </div>
                    </div>
                </div>
                
                <div class="fare-breakdown">
                    <div class="fare-row">
                        <span class="fare-label">Base Fare</span>
                        <span class="fare-value" id="baseFareValue">ZMW 15.00</span>
                    </div>
                    <div class="fare-row">
                        <span class="fare-label">Distance</span>
                        <span class="fare-value" id="distanceFareValue">ZMW 5.00</span>
                    </div>
                    <div class="fare-row">
                        <span class="fare-label">Ride Type</span>
                        <span class="fare-value" id="rideTypeValue">Standard</span>
                    </div>
                    <div class="fare-row total">
                        <span class="fare-label">Total Fare</span>
                        <span class="fare-value" id="totalFareValue">ZMW 20.00</span>
                    </div>
                </div>
                
                <!-- Emergency Contact Display -->
                <div class="emergency-contact-display" id="emergencyContactDisplay" style="display: none;">
                    <div class="emergency-contact-header">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div class="emergency-contact-title">Emergency Contacts</div>
                    </div>
                    <div class="emergency-contact-item">
                        <div class="contact-info">
                            <div class="contact-name" id="emergencyContact1Name">Contact 1</div>
                            <div class="contact-phone" id="emergencyContact1Phone">000-000-0000</div>
                        </div>
                        <button class="contact-action-btn" onclick="callEmergencyContact('contact1')">
                            <i class="fas fa-phone"></i>
                        </button>
                    </div>
                    <div class="emergency-contact-item">
                        <div class="contact-info">
                            <div class="contact-name" id="emergencyContact2Name">Contact 2</div>
                            <div class="contact-phone" id="emergencyContact2Phone">000-000-0000</div>
                        </div>
                        <button class="contact-action-btn" onclick="callEmergencyContact('contact2')">
                            <i class="fas fa-phone"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Broadcast Feature -->
                <div class="broadcast-feature" id="broadcastFeature" style="display: none;">
                    <div class="broadcast-feature-header">
                        <div class="broadcast-feature-title">
                            <i class="fas fa-broadcast-tower"></i>
                            <span>Broadcast Ride</span>
                        </div>
                        <div class="broadcast-status-indicator inactive" id="broadcastStatusIndicator"></div>
                    </div>
                    <div class="broadcast-form">
                        <div class="broadcast-input-group">
                            <input type="text" id="broadcastPhone" placeholder="Enter passenger phone number">
                            <button class="broadcast-btn" id="addBroadcastRecipient">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div class="broadcast-recipients" id="broadcastRecipients">
                            <!-- Recipients will be inserted here -->
                        </div>
                        <button class="btn btn-secondary" id="startBroadcastBtn">
                            <i class="fas fa-play"></i>
                            Start Broadcasting
                        </button>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-danger" id="cancelRideBtn">
                        <i class="fas fa-times-circle"></i>
                        Cancel Ride
                    </button>
                    <button class="btn btn-secondary" id="contactDriverBtn">
                        <i class="fas fa-phone"></i>
                        Call Driver
                    </button>
                    <button class="btn btn-secondary" id="openChatBtn">
                        <i class="fas fa-comment"></i>
                        Chat
                    </button>
                </div>
            </div>
            
            <!-- Broadcast Ride Form -->
            <div class="service-form" id="broadcastForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-broadcast-tower"></i>
                    Broadcast Ride
                </div>
                
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="broadcastPickup" placeholder="Pickup location" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="broadcastPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="broadcastDestination" placeholder="Destination" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="broadcastDestinationSuggestions"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Passenger Phone Numbers (comma separated)</label>
                    <textarea class="form-control form-textarea" id="broadcastPassengers" placeholder="Enter phone numbers of passengers to share this ride with..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Ride Type</label>
                    <select class="form-control" id="broadcastRideType">
                        <option value="standard">Standard</option>
                        <option value="economy">Economy</option>
                        <option value="premium">Premium</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Split Fare</label>
                    <select class="form-control" id="broadcastSplitType">
                        <option value="equal">Equal Split</option>
                        <option value="you_pay_more">You Pay 70%</option>
                        <option value="you_pay_all">You Pay All</option>
                    </select>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="broadcastFareDisplay" style="display: none;">
                    <div class="fare-label">Broadcast Fare</div>
                    <div class="fare-amount" id="broadcastFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="broadcastDistance">0 km</span>
                        <span id="broadcastTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="startBroadcastRideBtn">
                        <i class="fas fa-broadcast-tower"></i>
                        Start Broadcast
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- History Screen -->
    <div class="history-screen" id="historyScreen">
        <div class="screen-header">
            <button class="back-btn" data-screen="home">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="screen-title">Ride History</div>
        </div>
        
        <div class="history-filters">
            <button class="filter-btn active" data-filter="all">All</button>
            <button class="filter-btn" data-filter="completed">Completed</button>
            <button class="filter-btn" data-filter="cancelled">Cancelled</button>
            <button class="filter-btn" data-filter="scheduled">Scheduled</button>
            <button class="filter-btn" data-filter="emergency">Emergency</button>
            <button class="filter-btn" data-filter="delivery">Delivery</button>
            <button class="filter-btn" data-filter="truck">Truck</button>
            <button class="filter-btn" data-filter="broadcast">Broadcast</button>
        </div>
        
        <div class="history-list" id="historyList">
            <!-- History items will be inserted here -->
        </div>
    </div>
    
    <!-- Account Screen -->
    <div class="account-screen" id="accountScreen">
        <div class="screen-header">
            <button class="back-btn" data-screen="home">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="screen-title">My Account</div>
        </div>
        
        <div class="account-header">
            <div class="account-avatar" id="accountAvatar">
                <i class="fas fa-user"></i>
            </div>
            <div class="account-name" id="accountName">Loading...</div>
            <div class="account-phone" id="accountPhone">Loading...</div>
        </div>
        
        <div class="account-stats">
            <div class="stat-card">
                <div class="stat-value" id="completedRides">0</div>
                <div class="stat-label">Completed Rides</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="cancelledRides">0</div>
                <div class="stat-label">Cancelled Rides</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalSpent">ZMW 0</div>
                <div class="stat-label">Total Spent</div>
            </div>
        </div>
        
        <div class="account-section">
            <div class="section-title">
                <i class="fas fa-wallet"></i>
                Wallet Balance
            </div>
            
            <div class="wallet-balance">
                <div class="balance-label">Available Balance</div>
                <div class="balance-amount-large" id="accountBalance">ZMW 0.00</div>
            </div>
            
            <div class="wallet-actions">
                <button class="btn-wallet" id="depositBtn">
                    <i class="fas fa-plus"></i>
                    Deposit
                </button>
                <button class="btn-wallet" id="withdrawBtn">
                    <i class="fas fa-minus"></i>
                    Withdraw
                </button>
                <button class="btn-wallet" id="transferBtn">
                    <i class="fas fa-exchange-alt"></i>
                    Transfer
                </button>
                <button class="btn-wallet" id="transactionsBtn">
                    <i class="fas fa-history"></i>
                    History
                </button>
            </div>
        </div>
        
        <div class="account-section">
            <div class="section-title">
                <i class="fas fa-gift"></i>
                Referral Program
            </div>
            
            <div class="referral-card">
                <div>Share your referral code and earn ZMW 25 for each friend's first ride</div>
                <div class="referral-code" id="referralCode">JUBEL-XXXX</div>
                <button class="btn btn-primary" id="shareReferralBtn">
                    <i class="fas fa-share"></i>
                    Share Code
                </button>
                <div class="referral-note">Your friend gets 50% off their first ride</div>
            </div>
        </div>
        
        <div class="account-section">
            <div class="section-title">
                <i class="fas fa-cog"></i>
                Settings
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-secondary" id="updateProfileBtn">
                    <i class="fas fa-user-edit"></i>
                    Update Profile
                </button>
                <button class="btn btn-secondary" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </button>
            </div>
        </div>
    </div>
    
    <!-- Emergency Screen -->
    <div class="emergency-screen" id="emergencyScreen">
        <div class="screen-header">
            <button class="back-btn" data-screen="home">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="screen-title">Emergency Services</div>
        </div>
        
        <div class="emergency-services">
            <div class="emergency-service police" data-type="police">
                <div class="emergency-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <div class="emergency-name">Police Ride</div>
                <div class="emergency-description">Emergency transport with police escort</div>
            </div>
            
            <div class="emergency-service fire" data-type="fire">
                <div class="emergency-icon">
                    <i class="fas fa-fire-extinguisher"></i>
                </div>
                <div class="emergency-name">Fire Brigade</div>
                <div class="emergency-description">Fire emergency response team</div>
            </div>
            
            <div class="emergency-service medical" data-type="medical">
                <div class="emergency-icon">
                    <i class="fas fa-ambulance"></i>
                </div>
                <div class="emergency-name">Hospital Ride</div>
                <div class="emergency-description">Medical emergency transport</div>
            </div>
            
            <div class="emergency-service" data-type="sos">
                <div class="emergency-icon" style="background: var(--error-red);">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="emergency-name">SOS Emergency</div>
                <div class="emergency-description">Immediate emergency assistance</div>
            </div>
        </div>
        
        <div class="emergency-note">
            <p><strong>Important:</strong> Only use emergency services for genuine emergencies. Misuse may result in penalties. In case of immediate danger, call 911 first.</p>
        </div>
    </div>
    
    <!-- Modals -->
    
    <!-- Payment Modal -->
    <div class="modal-overlay" id="paymentModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-credit-card"></i>
                    Select Payment Method
                </div>
                <button class="modal-close" data-modal="payment">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <div class="form-label">Available Balance: <span id="paymentBalance">ZMW 0.00</span></div>
                    <div class="form-label">Total Amount: <span id="paymentAmount">ZMW 0.00</span></div>
                </div>
                
                <div class="payment-methods">
                    <div class="payment-method" data-payment="wallet">
                        <div class="payment-icon">
                            <i class="fas fa-wallet"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Jubel Wallet</div>
                            <div class="payment-info">Pay with your wallet balance</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-payment="mobile">
                        <div class="payment-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Mobile Money</div>
                            <div class="payment-info">Pay via MTN/Zamtel/Airtel</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-payment="cash">
                        <div class="payment-icon">
                            <i class="fas fa-money-bill"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Cash</div>
                            <div class="payment-info">Pay driver directly</div>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmPaymentBtn">
                        <i class="fas fa-check"></i>
                        Confirm Payment
                    </button>
                    <button class="btn btn-secondary" data-modal="payment">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Cancel Ride Modal -->
    <div class="modal-overlay" id="cancelModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-times-circle"></i>
                    Cancel Ride
                </div>
                <button class="modal-close" data-modal="cancel">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <div class="form-label">Please select a reason for cancellation:</div>
                </div>
                
                <div class="cancel-reasons">
                    <div class="cancel-reason" data-reason="driver_late">
                        <div class="reason-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="reason-text">Driver is taking too long</div>
                    </div>
                    
                    <div class="cancel-reason" data-reason="change_plans">
                        <div class="reason-icon">
                            <i class="fas fa-calendar-times"></i>
                        </div>
                        <div class="reason-text">Change of plans</div>
                    </div>
                    
                    <div class="cancel-reason" data-reason="found_alternative">
                        <div class="reason-icon">
                            <i class="fas fa-car"></i>
                        </div>
                        <div class="reason-text">Found alternative transport</div>
                    </div>
                    
                    <div class="cancel-reason" data-reason="emergency">
                        <div class="reason-icon">
                            <i class="fas fa-exclamation"></i>
                        </div>
                        <div class="reason-text">Emergency situation</div>
                    </div>
                    
                    <div class="cancel-reason" data-reason="other">
                        <div class="reason-icon">
                            <i class="fas fa-ellipsis-h"></i>
                        </div>
                        <div class="reason-text">Other reason</div>
                    </div>
                </div>
                
                <div class="form-group" id="otherReasonGroup" style="display: none;">
                    <label class="form-label">Please specify:</label>
                    <textarea class="form-control form-textarea" id="otherReason" placeholder="Enter your reason here..."></textarea>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-danger" id="confirmCancelBtn">
                        <i class="fas fa-times"></i>
                        Cancel Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="cancel">
                        Go Back
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Emergency Ride Modal -->
    <div class="modal-overlay" id="emergencyModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-ambulance"></i>
                    Emergency Ride Details
                </div>
                <button class="modal-close" data-modal="emergency">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content emergency-modal-content">
                <div class="form-group">
                    <div class="form-label" id="emergencyServiceType">Police Ride</div>
                </div>
                
                <!-- Emergency Reasons -->
                <div class="form-group">
                    <label class="form-label">Select Emergency Reason</label>
                    <div class="emergency-reasons">
                        <div class="emergency-reason" data-reason="accident">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-car-crash"></i>
                            </div>
                            <div class="emergency-reason-text">Accident</div>
                        </div>
                        
                        <div class="emergency-reason" data-reason="medical">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-heartbeat"></i>
                            </div>
                            <div class="emergency-reason-text">Medical Emergency</div>
                        </div>
                        
                        <div class="emergency-reason" data-reason="crime">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="emergency-reason-text">Crime/Assault</div>
                        </div>
                        
                        <div class="emergency-reason" data-reason="fire">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-fire"></i>
                            </div>
                            <div class="emergency-reason-text">Fire Emergency</div>
                        </div>
                        
                        <div class="emergency-reason" data-reason="other">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="emergency-reason-text">Other Emergency</div>
                        </div>
                    </div>
                    
                    <div class="emergency-reason-input" id="emergencyReasonOther" style="display: none;">
                        <label class="form-label">Please describe the emergency:</label>
                        <textarea class="form-control form-textarea" id="emergencyOtherReason" placeholder="Describe the emergency situation..."></textarea>
                    </div>
                </div>
                
                <!-- Emergency Stations -->
                <div class="form-group">
                    <label class="form-label">Select Nearest Emergency Station</label>
                    <div class="emergency-stations" id="emergencyStations">
                        <!-- Stations will be inserted here -->
                    </div>
                </div>
                
                <!-- User Location Details -->
                <div class="location-details">
                    <div class="location-detail-item">
                        <div class="location-detail-icon">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="location-detail-content">
                            <div class="location-detail-label">Your Location</div>
                            <div class="location-detail-value" id="emergencyUserLocation">Detecting location...</div>
                        </div>
                    </div>
                </div>
                
                <!-- Price Calculation -->
                <div class="price-calculation">
                    <div class="calculation-row">
                        <span>Base Emergency Fare:</span>
                        <span id="emergencyBaseFare">ZMW 100.00</span>
                    </div>
                    <div class="calculation-row">
                        <span>Distance to Service:</span>
                        <span id="emergencyDistance">0 km</span>
                    </div>
                    <div class="calculation-row">
                        <span>Estimated Time:</span>
                        <span id="emergencyTime">5 min</span>
                    </div>
                    <div class="calculation-row total">
                        <span>Total Fare:</span>
                        <span id="emergencyTotalFare">ZMW 100.00</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-danger" id="confirmEmergencyBtn">
                        <i class="fas fa-exclamation-triangle"></i>
                        Request Emergency Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="emergency">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- SOS Setup Modal -->
    <div class="modal-overlay" id="sosModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    SOS Emergency Setup
                </div>
                <button class="modal-close" data-modal="sos">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <label class="form-label">Primary Emergency Contact</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="sosContact1Name" placeholder="Contact name">
                        <input type="tel" class="form-control" id="sosContact1Phone" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Secondary Emergency Contact (Optional)</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="sosContact2Name" placeholder="Contact name">
                        <input type="tel" class="form-control" id="sosContact2Phone" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Emergency Message</label>
                    <textarea class="form-control form-textarea" id="sosMessage">
I need help! My current location and ride details will be shared with you.
                    </textarea>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="saveSOSBtn">
                        <i class="fas fa-save"></i>
                        Save SOS Setup
                    </button>
                    <button class="btn btn-secondary" data-modal="sos">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Transfer Money Modal -->
    <div class="modal-overlay" id="transferModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-exchange-alt"></i>
                    Transfer Money
                </div>
                <button class="modal-close" data-modal="transfer">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <div class="form-label">Available Balance: <span id="transferBalance">ZMW 0.00</span></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Recipient's Referral Code</label>
                    <input type="text" class="form-control" id="recipientCode" placeholder="Enter recipient's Jubel referral code">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Amount (ZMW)</label>
                    <input type="number" class="form-control" id="transferAmount" placeholder="Enter amount" min="1" step="0.01">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Message (Optional)</label>
                    <input type="text" class="form-control" id="transferMessage" placeholder="Add a message">
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmTransferBtn">
                        <i class="fas fa-paper-plane"></i>
                        Send Money
                    </button>
                    <button class="btn btn-secondary" data-modal="transfer">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Wallet Transactions Modal -->
    <div class="modal-overlay" id="transactionsModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-history"></i>
                    Wallet Transactions
                </div>
                <button class="modal-close" data-modal="transactions">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div id="transactionsList">
                    <!-- Transactions will be inserted here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Schedule Ride Modal -->
    <div class="modal-overlay" id="scheduleModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-calendar-alt"></i>
                    Schedule a Ride
                </div>
                <button class="modal-close" data-modal="schedule">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="schedulePickup" placeholder="Pickup location">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="schedulePickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="scheduleDestination" placeholder="Destination">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="scheduleDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- For Someone Else -->
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="scheduleForSomeone">
                        <span style="margin-left: 8px;">Booking for someone else</span>
                    </label>
                </div>
                
                <div class="form-group" id="someoneElseDetails" style="display: none;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="recipientName" placeholder="Recipient name">
                        <input type="tel" class="form-control" id="recipientPhone" placeholder="Recipient phone">
                    </div>
                </div>
                
                <div class="schedule-grid">
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-control" id="scheduleDate" min="">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Time</label>
                        <input type="time" class="form-control" id="scheduleTime">
                    </div>
                </div>
                
                <!-- Ride Type Selection for Schedule -->
                <div class="ride-type-selection active" style="margin: 0 0 16px 0;">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                    </div>
                    <div class="ride-type-grid">
                        <div class="ride-type-card economy" data-type="economy">
                            <div class="ride-type-icon">
                                <i class="fas fa-car-side"></i>
                            </div>
                            <div class="ride-type-name">Economy</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card selected" data-type="standard">
                            <div class="ride-type-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="ride-type-name">Standard</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card premium" data-type="premium">
                            <div class="ride-type-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="ride-type-name">Premium</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="scheduleFareDisplay" style="display: none;">
                    <div class="fare-label">Scheduled Ride Fare</div>
                    <div class="fare-amount" id="scheduleFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="scheduleDistance">0 km</span>
                        <span id="scheduleTimeEstimate">ETA: 0 min</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmScheduleBtn">
                        <i class="fas fa-calendar-check"></i>
                        Schedule Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="schedule">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Order for Someone Modal -->
    <div class="modal-overlay" id="orderForSomeoneModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-user-friends"></i>
                    Order for Someone Else
                </div>
                <button class="modal-close" data-modal="orderForSomeone">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="someonePickup" placeholder="Pickup location">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="someonePickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="someoneDestination" placeholder="Destination">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="someoneDestinationSuggestions"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Recipient Details</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="someoneName" placeholder="Full name">
                        <input type="tel" class="form-control" id="someonePhone" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Special Instructions (Optional)</label>
                    <textarea class="form-control form-textarea" id="someoneInstructions" placeholder="Any instructions for the driver..."></textarea>
                </div>
                
                <!-- Ride Type Selection -->
                <div class="ride-type-selection active" style="margin: 0 0 16px 0;">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                    </div>
                    <div class="ride-type-grid">
                        <div class="ride-type-card economy" data-type="economy">
                            <div class="ride-type-icon">
                                <i class="fas fa-car-side"></i>
                            </div>
                            <div class="ride-type-name">Economy</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card selected" data-type="standard">
                            <div class="ride-type-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="ride-type-name">Standard</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card premium" data-type="premium">
                            <div class="ride-type-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="ride-type-name">Premium</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="someoneFareDisplay" style="display: none;">
                    <div class="fare-label">Estimated Fare</div>
                    <div class="fare-amount" id="someoneFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="someoneDistance">0 km</span>
                        <span id="someoneTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmSomeoneRideBtn">
                        <i class="fas fa-car"></i>
                        Request Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="orderForSomeone">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Share Ride Modal -->
    <div class="modal-overlay" id="shareRideModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-share-alt"></i>
                    Share Ride
                </div>
                <button class="modal-close" data-modal="shareRide">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="sharePickup" placeholder="Pickup location">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="sharePickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="shareDestination" placeholder="Destination">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shareDestinationSuggestions"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Friend's Referral Code</label>
                    <input type="text" class="form-control" id="friendReferralCode" placeholder="Enter friend's Jubel referral code">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Split Fare</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select class="form-control" id="splitPercentage" style="flex: 1;">
                            <option value="50">50/50 Split</option>
                            <option value="60">You pay 60%</option>
                            <option value="70">You pay 70%</option>
                            <option value="80">You pay 80%</option>
                            <option value="100">You pay full</option>
                        </select>
                    </div>
                </div>
                
                <!-- Ride Type Selection -->
                <div class="ride-type-selection active" style="margin: 0 0 16px 0;">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                    </div>
                    <div class="ride-type-grid">
                        <div class="ride-type-card economy" data-type="economy">
                            <div class="ride-type-icon">
                                <i class="fas fa-car-side"></i>
                            </div>
                            <div class="ride-type-name">Economy</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card selected" data-type="standard">
                            <div class="ride-type-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="ride-type-name">Standard</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card premium" data-type="premium">
                            <div class="ride-type-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="ride-type-name">Premium</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Estimated Fare: <span id="shareFareEstimate">ZMW 0.00</span></label>
                    <div class="price-calculation">
                        <div class="calculation-row">
                            <span>Your Share:</span>
                            <span id="yourShare">ZMW 0.00</span>
                        </div>
                        <div class="calculation-row">
                            <span>Friend's Share:</span>
                            <span id="friendShare">ZMW 0.00</span>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmShareRideBtn">
                        <i class="fas fa-user-friends"></i>
                        Share Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="shareRide">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Update Profile Modal -->
    <div class="modal-overlay" id="updateProfileModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-user-edit"></i>
                    Update Profile
                </div>
                <button class="modal-close" data-modal="updateProfile">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <input type="text" class="form-control" id="updateName" placeholder="Your full name">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Phone Number</label>
                    <input type="tel" class="form-control" id="updatePhone" placeholder="Your phone number">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" class="form-control" id="updateEmail" placeholder="Your email address" readonly>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Home Address (Optional)</label>
                    <input type="text" class="form-control" id="updateHomeAddress" placeholder="Your home address">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Work Address (Optional)</label>
                    <input type="text" class="form-control" id="updateWorkAddress" placeholder="Your work address">
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="saveProfileBtn">
                        <i class="fas fa-save"></i>
                        Save Changes
                    </button>
                    <button class="btn btn-secondary" data-modal="updateProfile">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Loading...</div>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Real-time Indicator -->
    <div class="real-time-indicator" id="realTimeIndicator">
        <i class="fas fa-sync-alt"></i>
        <span>Real-time updates active</span>
    </div>
    
    <!-- Sync Indicator -->
    <div class="sync-indicator" id="syncIndicator">
        <i class="fas fa-sync-alt sync-icon"></i>
        <span>Syncing...</span>
    </div>
    
    <!-- Firebase and Leaflet JS -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script>
        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyDEACX_P4c5q7djJAcA0I7Lk7leO2TlQ74",
            authDomain: "jubel-13e1a.firebaseapp.com",
            databaseURL: "https://jubel-13e1a-default-rtdb.firebaseio.com",
            projectId: "jubel-13e1a",
            storageBucket: "jubel-13e1a.firebasestorage.app",
            messagingSenderId: "882241095445",
            appId: "1:882241095445:web:ee9ca40fddd008ca910b1c",
            measurementId: "G-J5JPKL6B5F"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        const storage = firebase.storage();

        // ============================================
        // APP STATE MANAGEMENT
        // ============================================
        const AppState = {
            currentUser: null,
            userData: null,
            currentRide: null,
            activeScreen: 'home',
            activeService: 'car',
            walletBalance: 0,
            userLocation: null,
            currentCity: null,
            detectedCity: null,
            selectedRideType: 'standard',
            selectedVehicle: null,
            destination: null,
            pickup: null,
            rideFare: 0,
            driverLocation: null,
            chatMessages: [],
            scheduledRides: [],
            emergencyMode: false,
            sosConfig: null,
            searchCache: new Map(),
            lastSearchTime: 0,
            notifications: [],
            unreadNotifications: 0,
            searchHistory: [],
            broadcastRecipients: [],
            emergencyStations: {
                police: [],
                fire: [],
                medical: []
            },
            realtimeListeners: [],
            rideTypes: {
                economy: { base: 15, perKm: 2.5, multiplier: 0.8, min: 10, icon: 'fa-car-side' },
                standard: { base: 20, perKm: 3.0, multiplier: 1.0, min: 15, icon: 'fa-car' },
                premium: { base: 30, perKm: 4.0, multiplier: 1.5, min: 25, icon: 'fa-crown' }
            },
            emergencyServices: {
                police: { base: 150, perKm: 5.0, multiplier: 2.0, min: 100 },
                fire: { base: 200, perKm: 6.0, multiplier: 2.5, min: 150 },
                medical: { base: 180, perKm: 5.5, multiplier: 2.2, min: 120 }
            },
            deliveryTypes: {
                standard: { base: 25, perKm: 2.0, multiplier: 1.0 },
                express: { base: 40, perKm: 3.0, multiplier: 1.5 },
                sameDay: { base: 60, perKm: 4.0, multiplier: 2.0 }
            },
            truckTypes: {
                pickup: { base: 80, perKm: 5.0, multiplier: 1.0, capacity: '1.5 tons' },
                light: { base: 120, perKm: 6.0, multiplier: 1.2, capacity: '3 tons' },
                medium: { base: 200, perKm: 8.0, multiplier: 1.5, capacity: '7 tons' },
                heavy: { base: 350, perKm: 12.0, multiplier: 2.0, capacity: '15 tons' }
            },
            lastPriceUpdate: 0,
            cityDetectionAttempts: 0,
            maxCityDetectionAttempts: 3,
            isSyncing: false,
            syncInterval: null,
            emergencyReason: null,
            selectedEmergencyStation: null,
            activeBroadcast: null,
            typingTimeout: null,
            driverTyping: false
        };

        // ============================================
        // MAP MANAGEMENT
        // ============================================
        let map = null;
        let currentLocationMarker = null;
        let pickupMarker = null;
        let destinationMarker = null;
        let driverMarker = null;
        let routeLayer = null;
        let emergencyMarkers = [];
        let emergencyStationMarkers = [];

        // ============================================
        // ENHANCED SEARCH ENGINE
        // ============================================
        const EnhancedSearchEngine = {
            cache: new Map(),
            lastSearch: 0,
            debounceTimer: null,
            searchHistory: [],
            maxHistoryItems: 10,
            
            init: function() {
                this.loadSearchHistory();
            },
            
            loadSearchHistory: function() {
                const history = localStorage.getItem('jubel_search_history');
                if (history) {
                    this.searchHistory = JSON.parse(history);
                }
            },
            
            saveSearchHistory: function() {
                localStorage.setItem('jubel_search_history', JSON.stringify(this.searchHistory));
            },
            
            addToHistory: function(query, location, type) {
                const historyItem = {
                    query: query,
                    location: location,
                    type: type,
                    timestamp: Date.now()
                };
                
                // Remove duplicates
                this.searchHistory = this.searchHistory.filter(item => 
                    item.query !== query || item.type !== type
                );
                
                // Add to beginning
                this.searchHistory.unshift(historyItem);
                
                // Keep only max items
                if (this.searchHistory.length > this.maxHistoryItems) {
                    this.searchHistory = this.searchHistory.slice(0, this.maxHistoryItems);
                }
                
                this.saveSearchHistory();
            },
            
            search: async function(query, type = 'destination', location = null, city = null) {
                const cacheKey = `${query}-${type}-${city || 'any'}-${location ? `${location.lat.toFixed(2)},${location.lng.toFixed(2)}` : 'none'}`;
                
                // Return cached results if available and recent (3 minutes)
                if (this.cache.has(cacheKey)) {
                    const cached = this.cache.get(cacheKey);
                    if (Date.now() - cached.timestamp < 180000) {
                        return cached.results;
                    }
                }
                
                try {
                    const searchUrl = this.buildSearchUrl(query, location, city);
                    const response = await fetch(searchUrl);
                    
                    if (!response.ok) {
                        throw new Error(`Search failed: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    const results = this.processResults(data, location, city);
                    
                    // Cache the results
                    this.cache.set(cacheKey, {
                        results: results,
                        timestamp: Date.now()
                    });
                    
                    // Add to search history if it's a destination search
                    if (type === 'destination' && results.length > 0) {
                        this.addToHistory(query, results[0], type);
                    }
                    
                    return results;
                } catch (error) {
                    console.error('Search error:', error);
                    
                    // Fallback to local search if available
                    if (city) {
                        return this.localSearch(query, city);
                    }
                    
                    return [];
                }
            },
            
            buildSearchUrl: function(query, location, city) {
                const bounds = this.getSearchBounds(location, city);
                const params = new URLSearchParams({
                    q: `${query}${city ? `, ${city}, Zambia` : ', Zambia'}`,
                    format: 'json',
                    limit: 15,
                    countrycodes: 'zm',
                    bounded: 1,
                    viewbox: bounds.join(','),
                    'accept-language': 'en',
                    addressdetails: 1
                });
                
                return `https://nominatim.openstreetmap.org/search?${params}`;
            },
            
            getSearchBounds: function(location, city) {
                if (city && AppState.currentCity) {
                    // Get bounds for the detected city
                    const cityBounds = this.getCityBounds(AppState.currentCity);
                    if (cityBounds) {
                        return cityBounds;
                    }
                }
                
                if (location) {
                    // 15km radius around current location
                    const radius = 0.135; // ~15km in degrees
                    return [
                        location.lng - radius,
                        location.lat - radius,
                        location.lng + radius,
                        location.lat + radius
                    ];
                }
                
                // Default to Lusaka bounds
                return [28.0, -15.6, 28.6, -15.2];
            },
            
            getCityBounds: function(cityName) {
                const cityBounds = {
                    'Lusaka': [28.0, -15.6, 28.6, -15.2],
                    'Ndola': [28.6, -13.0, 28.7, -12.9],
                    'Kitwe': [28.1, -12.9, 28.3, -12.7],
                    'Kabwe': [28.4, -14.5, 28.5, -14.4],
                    'Livingstone': [25.8, -17.9, 25.9, -17.8],
                    'Chipata': [32.6, -13.7, 32.7, -13.6]
                };
                
                return cityBounds[cityName] || null;
            },
            
            processResults: function(data, location, city) {
                return data
                    .map(place => ({
                        id: place.place_id,
                        name: place.display_name.split(',')[0],
                        address: this.formatAddress(place),
                        fullAddress: place.display_name,
                        lat: parseFloat(place.lat),
                        lng: parseFloat(place.lon),
                        type: place.type || place.class,
                        importance: place.importance || 0,
                        distance: location ? this.calculateDistance(
                            location.lat, location.lng,
                            parseFloat(place.lat), parseFloat(place.lon)
                        ) : 0,
                        city: place.address?.city || place.address?.town || place.address?.village,
                        relevance: this.calculateRelevance(place, location, city)
                    }))
                    .sort((a, b) => {
                        // Sort by relevance score (higher is better)
                        if (a.relevance !== b.relevance) {
                            return b.relevance - a.relevance;
                        }
                        
                        // Then by distance if location is available
                        if (location && a.distance !== b.distance) {
                            return a.distance - b.distance;
                        }
                        
                        // Finally by importance
                        return b.importance - a.importance;
                    })
                    .slice(0, 10); // Limit to 10 results
            },
            
            calculateRelevance: function(place, location, city) {
                let score = place.importance || 0;
                
                // Boost if in current city
                if (city && place.address) {
                    const placeCity = place.address.city || place.address.town || place.address.village;
                    if (placeCity && placeCity.toLowerCase().includes(city.toLowerCase())) {
                        score += 0.3;
                    }
                }
                
                // Boost by proximity if location is available
                if (location) {
                    const distance = this.calculateDistance(
                        location.lat, location.lng,
                        parseFloat(place.lat), parseFloat(place.lon)
                    );
                    
                    if (distance < 5) score += 0.2;
                    else if (distance < 10) score += 0.1;
                    else if (distance < 20) score += 0.05;
                }
                
                // Boost exact matches
                if (place.display_name.split(',')[0].toLowerCase() === 
                    AppState.lastSearchQuery?.toLowerCase()) {
                    score += 0.5;
                }
                
                return Math.min(score, 1.0);
            },
            
            formatAddress: function(place) {
                const address = place.address || {};
                const parts = [];
                
                if (address.house_number || address.housenumber) {
                    parts.push(address.house_number || address.housenumber);
                }
                
                if (address.road) {
                    parts.push(address.road);
                }
                
                if (address.suburb || address.neighbourhood) {
                    parts.push(address.suburb || address.neighbourhood);
                }
                
                if (address.city || address.town) {
                    parts.push(address.city || address.town);
                }
                
                return parts.join(', ') || place.display_name.split(',').slice(0, 3).join(',');
            },
            
            calculateDistance: function(lat1, lon1, lat2, lon2) {
                const R = 6371; // Earth's radius in km
                const dLat = this.toRad(lat2 - lat1);
                const dLon = this.toRad(lon2 - lon1);
                const a = 
                    Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(this.toRad(lat1)) * Math.cos(this.toRad(lat2)) * 
                    Math.sin(dLon/2) * Math.sin(dLon/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            },
            
            toRad: function(value) {
                return value * Math.PI / 180;
            },
            
            localSearch: function(query, city) {
                // Implement local search from cache or predefined places
                const localPlaces = this.getLocalPlaces(city);
                if (!localPlaces) return [];
                
                const searchTerm = query.toLowerCase();
                return localPlaces
                    .filter(place => 
                        place.name.toLowerCase().includes(searchTerm) ||
                        place.address.toLowerCase().includes(searchTerm)
                    )
                    .map(place => ({
                        ...place,
                        distance: AppState.userLocation ? 
                            this.calculateDistance(
                                AppState.userLocation.lat, AppState.userLocation.lng,
                                place.lat, place.lng
                            ) : 0
                    }))
                    .sort((a, b) => a.distance - b.distance)
                    .slice(0, 10);
            },
            
            getLocalPlaces: function(city) {
                // Predefined places for major cities
                const cityPlaces = {
                    'Lusaka': [
                        { name: 'Manda Hill Mall', address: 'Manda Hill, Lusaka', lat: -15.4167, lng: 28.2833 },
                        { name: 'East Park Mall', address: 'Great East Road, Lusaka', lat: -15.4000, lng: 28.3000 },
                        { name: 'University of Zambia', address: 'Great East Road, Lusaka', lat: -15.3900, lng: 28.3200 },
                        { name: 'Kamwala Market', address: 'Kamwala, Lusaka', lat: -15.4200, lng: 28.2700 },
                        { name: 'Lusaka Airport', address: 'Kenneth Kaunda International Airport', lat: -15.3308, lng: 28.4526 }
                    ],
                    'Ndola': [
                        { name: 'Northrise Mall', address: 'Northrise, Ndola', lat: -13.0000, lng: 28.6500 },
                        { name: 'Mukuba Mall', address: 'Ndola Central', lat: -12.9700, lng: 28.6300 }
                    ]
                };
                
                return cityPlaces[city] || [];
            },
            
            searchEmergencyStations: async function(type, city) {
                const cacheKey = `emergency-${type}-${city}`;
                
                if (this.cache.has(cacheKey)) {
                    const cached = this.cache.get(cacheKey);
                    if (Date.now() - cached.timestamp < 3600000) { // 1 hour cache
                        return cached.results;
                    }
                }
                
                try {
                    let query = '';
                    switch(type) {
                        case 'police':
                            query = `police station ${city} Zambia`;
                            break;
                        case 'fire':
                            query = `fire station ${city} Zambia`;
                            break;
                        case 'medical':
                            query = `hospital ${city} Zambia`;
                            break;
                    }
                    
                    const searchUrl = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=10&countrycodes=zm&addressdetails=1`;
                    const response = await fetch(searchUrl);
                    
                    if (!response.ok) throw new Error(`Emergency search failed: ${response.status}`);
                    
                    const data = await response.json();
                    const results = data.map(place => ({
                        id: place.place_id,
                        name: place.display_name.split(',')[0],
                        address: this.formatAddress(place),
                        fullAddress: place.display_name,
                        lat: parseFloat(place.lat),
                        lng: parseFloat(place.lon),
                        type: type,
                        distance: AppState.userLocation ? 
                            this.calculateDistance(
                                AppState.userLocation.lat, AppState.userLocation.lng,
                                parseFloat(place.lat), parseFloat(place.lon)
                            ) : 0
                    })).sort((a, b) => a.distance - b.distance);
                    
                    // Cache the results
                    this.cache.set(cacheKey, {
                        results: results,
                        timestamp: Date.now()
                    });
                    
                    AppState.emergencyStations[type] = results;
                    return results;
                } catch (error) {
                    console.error('Emergency station search error:', error);
                    return this.getDefaultEmergencyStations(type, city);
                }
            },
            
            getDefaultEmergencyStations: function(type, city) {
                const defaultStations = {
                    'Lusaka': {
                        police: [
                            { name: 'Lusaka Central Police', address: 'Cairo Road, Lusaka', lat: -15.4167, lng: 28.2833, distance: 0 },
                            { name: 'Kabulonga Police Station', address: 'Kabulonga, Lusaka', lat: -15.4000, lng: 28.3000, distance: 0 },
                            { name: 'Woodlands Police Station', address: 'Woodlands, Lusaka', lat: -15.3900, lng: 28.3200, distance: 0 }
                        ],
                        fire: [
                            { name: 'Lusaka Fire Brigade', address: 'Cairo Road, Lusaka', lat: -15.4100, lng: 28.2900, distance: 0 },
                            { name: 'Industrial Fire Station', address: 'Industrial Area, Lusaka', lat: -15.4200, lng: 28.2700, distance: 0 }
                        ],
                        medical: [
                            { name: 'University Teaching Hospital', address: 'Ridgeway, Lusaka', lat: -15.4050, lng: 28.2950, distance: 0 },
                            { name: 'Levy Mwanawasa Hospital', address: 'Great North Road, Lusaka', lat: -15.3950, lng: 28.3050, distance: 0 },
                            { name: 'Matero Hospital', address: 'Matero, Lusaka', lat: -15.4150, lng: 28.2750, distance: 0 }
                        ]
                    }
                };
                
                const stations = defaultStations[city]?.[type] || [];
                
                // Calculate distances
                if (AppState.userLocation) {
                    stations.forEach(station => {
                        station.distance = this.calculateDistance(
                            AppState.userLocation.lat, AppState.userLocation.lng,
                            station.lat, station.lng
                        );
                    });
                    
                    stations.sort((a, b) => a.distance - b.distance);
                }
                
                AppState.emergencyStations[type] = stations;
                return stations;
            },
            
            clearCache: function() {
                this.cache.clear();
            },
            
            getSearchHistory: function(type = null) {
                if (type) {
                    return this.searchHistory.filter(item => item.type === type);
                }
                return this.searchHistory;
            },
            
            clearSearchHistory: function() {
                this.searchHistory = [];
                this.saveSearchHistory();
            }
        };

        // ============================================
        // ENHANCED PRICE CALCULATOR
        // ============================================
        const EnhancedPriceCalculator = {
            calculateRideFare: function(distanceKm, rideType = 'standard', surge = 1.0, timeOfDay = null) {
                const config = AppState.rideTypes[rideType] || AppState.rideTypes.standard;
                
                // Base fare + distance fare
                let fare = config.base + (distanceKm * config.perKm);
                
                // Apply ride type multiplier
                fare *= config.multiplier;
                
                // Apply surge pricing
                fare *= surge;
                
                // Apply time of day multiplier
                if (!timeOfDay) {
                    timeOfDay = new Date().getHours();
                }
                
                if (timeOfDay >= 22 || timeOfDay <= 5) {
                    fare *= 1.2; // 20% extra for late night
                } else if (timeOfDay >= 7 && timeOfDay <= 9) {
                    fare *= 1.3; // 30% extra for morning rush
                } else if (timeOfDay >= 16 && timeOfDay <= 19) {
                    fare *= 1.4; // 40% extra for evening rush
                }
                
                // Ensure minimum fare
                fare = Math.max(fare, config.min);
                
                // Round to 2 decimal places
                return Math.round(fare * 100) / 100;
            },
            
            calculateEmergencyFare: function(distanceKm, serviceType, surge = 1.0) {
                const config = AppState.emergencyServices[serviceType] || AppState.emergencyServices.police;
                
                let fare = config.base + (distanceKm * config.perKm);
                fare *= config.multiplier;
                fare *= surge;
                fare = Math.max(fare, config.min);
                
                return Math.round(fare * 100) / 100;
            },
            
            calculateDeliveryFare: function(distanceKm, deliveryType = 'standard', parcelValue = 0) {
                const config = AppState.deliveryTypes[deliveryType] || AppState.deliveryTypes.standard;
                
                let fare = config.base + (distanceKm * config.perKm);
                fare *= config.multiplier;
                
                // Add insurance for valuable parcels (1% of parcel value)
                if (parcelValue > 500) {
                    fare += parcelValue * 0.01;
                }
                
                return Math.round(fare * 100) / 100;
            },
            
            calculateTruckFare: function(distanceKm, truckType = 'light', helpers = false) {
                const config = AppState.truckTypes[truckType] || AppState.truckTypes.light;
                
                let fare = config.base + (distanceKm * config.perKm);
                fare *= config.multiplier;
                
                // Add helper cost if needed
                if (helpers) {
                    fare += 50;
                }
                
                return Math.round(fare * 100) / 100;
            },
            
            calculateShoppingFare: function(distanceKm, itemsCount = 1, budget = 0) {
                // Base fare + distance + item count
                let fare = 30 + (distanceKm * 2.5) + (itemsCount * 5);
                
                // Add 5% of budget for shopping service
                if (budget > 0) {
                    fare += budget * 0.05;
                }
                
                return Math.round(fare * 100) / 100;
            },
            
            calculateDistance: function(lat1, lon1, lat2, lon2) {
                return EnhancedSearchEngine.calculateDistance(lat1, lon1, lat2, lon2);
            },
            
            estimateTime: function(distanceKm, rideType = 'standard', traffic = null) {
                // Base time + traffic factor
                const baseSpeed = rideType === 'premium' ? 45 : 35; // km/h
                let baseTime = (distanceKm / baseSpeed) * 60; // minutes
                
                // Apply traffic factor
                if (!traffic) {
                    traffic = this.getTrafficFactor();
                }
                
                baseTime *= traffic;
                
                // Add pickup time
                if (rideType === 'premium') {
                    baseTime += 2; // Premium cars are faster
                } else {
                    baseTime += 5; // Standard pickup time
                }
                
                return Math.ceil(baseTime);
            },
            
            getTrafficFactor: function() {
                const hour = new Date().getHours();
                const day = new Date().getDay();
                
                // Weekday traffic patterns
                if (day >= 1 && day <= 5) { // Monday to Friday
                    if ((hour >= 7 && hour <= 9) || (hour >= 16 && hour <= 19)) {
                        return 1.5; // Rush hour
                    }
                }
                
                // Weekend traffic
                if (day === 6 || day === 0) { // Saturday or Sunday
                    if (hour >= 12 && hour <= 16) {
                        return 1.3; // Weekend afternoon
                    }
                }
                
                return 1.0; // Normal traffic
            },
            
            getSurgeMultiplier: function() {
                const hour = new Date().getHours();
                const day = new Date().getDay();
                
                // High demand times
                if (day >= 1 && day <= 5) { // Weekdays
                    if (hour >= 7 && hour <= 9) return 1.5; // Morning rush
                    if (hour >= 16 && hour <= 19) return 1.8; // Evening rush
                }
                
                if (day === 5 || day === 6) { // Friday or Saturday
                    if (hour >= 20 && hour <= 23) return 2.0; // Weekend night
                }
                
                if (hour >= 22 || hour <= 5) return 1.8; // Late night
                
                return 1.0; // Normal demand
            },
            
            getFareBreakdown: function(distanceKm, rideType = 'standard', surge = 1.0) {
                const config = AppState.rideTypes[rideType] || AppState.rideTypes.standard;
                const baseFare = config.base;
                const distanceFare = distanceKm * config.perKm;
                const rideTypeMultiplier = config.multiplier;
                const surgeMultiplier = surge;
                const timeMultiplier = this.getTimeMultiplier();
                
                const subtotal = (baseFare + distanceFare) * rideTypeMultiplier;
                const surgeAmount = subtotal * (surgeMultiplier - 1);
                const timeAmount = subtotal * (timeMultiplier - 1);
                const total = subtotal * surgeMultiplier * timeMultiplier;
                
                return {
                    baseFare: baseFare,
                    distanceFare: distanceFare,
                    rideTypeMultiplier: rideTypeMultiplier,
                    surgeMultiplier: surgeMultiplier,
                    timeMultiplier: timeMultiplier,
                    surgeAmount: surgeAmount,
                    timeAmount: timeAmount,
                    subtotal: subtotal,
                    total: Math.max(total, config.min)
                };
            },
            
            getTimeMultiplier: function() {
                const hour = new Date().getHours();
                if (hour >= 22 || hour <= 5) return 1.2; // Late night
                return 1.0;
            },
            
            calculateBroadcastFare: function(distanceKm, rideType = 'standard', splitType = 'equal', passengerCount = 2) {
                const totalFare = this.calculateRideFare(distanceKm, rideType);
                let yourShare = totalFare;
                let passengerShare = 0;
                
                switch(splitType) {
                    case 'equal':
                        yourShare = totalFare / passengerCount;
                        passengerShare = totalFare / passengerCount;
                        break;
                    case 'you_pay_more':
                        yourShare = totalFare * 0.7;
                        passengerShare = totalFare * 0.3;
                        break;
                    case 'you_pay_all':
                        yourShare = totalFare;
                        passengerShare = 0;
                        break;
                }
                
                return {
                    total: totalFare,
                    yourShare: yourShare,
                    passengerShare: passengerShare,
                    splitType: splitType
                };
            }
        };

        // ============================================
        // ENHANCED UI UPDATER
        // ============================================
        const EnhancedUIUpdater = {
            updateWalletBalance: function(balance) {
                const formatted = `ZMW ${balance.toFixed(2)}`;
                document.getElementById('walletBalance').textContent = formatted;
                document.getElementById('accountBalance').textContent = formatted;
                document.getElementById('paymentBalance').textContent = formatted;
                document.getElementById('transferBalance').textContent = formatted;
                AppState.walletBalance = balance;
            },
            
            updateUserInfo: function(userData) {
                if (userData.name) {
                    document.getElementById('userFullName').textContent = userData.name;
                    document.getElementById('accountName').textContent = userData.name;
                }
                
                if (userData.phone) {
                    document.getElementById('accountPhone').textContent = userData.phone;
                }
                
                if (userData.email) {
                    document.getElementById('updateEmail').value = userData.email;
                }
                
                if (userData.referralCode) {
                    document.getElementById('referralCode').textContent = userData.referralCode;
                }
            },
            
            showToast: function(message, type = 'info', duration = 5000) {
                const toastContainer = document.getElementById('toastContainer');
                const toastId = 'toast-' + Date.now();
                
                const icons = {
                    success: 'fa-check-circle',
                    error: 'fa-exclamation-circle',
                    warning: 'fa-exclamation-triangle',
                    info: 'fa-info-circle'
                };
                
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.id = toastId;
                toast.innerHTML = `
                    <div class="toast-icon">
                        <i class="fas ${icons[type] || icons.info}"></i>
                    </div>
                    <div class="toast-content">
                        <div class="toast-title">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
                        <div class="toast-message">${message}</div>
                    </div>
                    <button class="toast-close" onclick="EnhancedUIUpdater.removeToast('${toastId}')">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                toastContainer.appendChild(toast);
                
                // Auto-remove after duration
                setTimeout(() => {
                    this.removeToast(toastId);
                }, duration);
                
                return toastId;
            },
            
            removeToast: function(toastId) {
                const toast = document.getElementById(toastId);
                if (toast) {
                    toast.classList.add('hiding');
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, 300);
                }
            },
            
            showLoading: function(message = 'Loading...') {
                const overlay = document.getElementById('loadingOverlay');
                const text = document.getElementById('loadingText');
                text.textContent = message;
                overlay.classList.add('active');
            },
            
            hideLoading: function() {
                const overlay = document.getElementById('loadingOverlay');
                overlay.classList.remove('active');
            },
            
            showMapLoading: function() {
                document.getElementById('mapLoadingOverlay').style.display = 'flex';
            },
            
            hideMapLoading: function() {
                document.getElementById('mapLoadingOverlay').style.display = 'none';
            },
            
            updateCityDisplay: function(city) {
                const display = document.getElementById('currentCityDisplay');
                if (city) {
                    display.textContent = `City: ${city}`;
                    display.parentElement.style.display = 'flex';
                    
                    // Hide after 5 seconds
                    setTimeout(() => {
                        display.parentElement.style.display = 'none';
                    }, 5000);
                }
            },
            
            updateRidePrices: function(distanceKm) {
                const types = ['economy', 'standard', 'premium'];
                const surge = EnhancedPriceCalculator.getSurgeMultiplier();
                
                types.forEach(type => {
                    const price = EnhancedPriceCalculator.calculateRideFare(distanceKm, type, surge);
                    const element = document.getElementById(`${type}Price`);
                    if (element) {
                        element.textContent = `ZMW ${price.toFixed(2)}`;
                    }
                });
                
                // Update estimated fare display
                const selectedPrice = EnhancedPriceCalculator.calculateRideFare(distanceKm, AppState.selectedRideType, surge);
                document.getElementById('estimatedFare').textContent = `ZMW ${selectedPrice.toFixed(2)}`;
                
                // Update distance and time
                const time = EnhancedPriceCalculator.estimateTime(distanceKm, AppState.selectedRideType);
                document.getElementById('distanceDetail').textContent = `${distanceKm.toFixed(1)} km`;
                document.getElementById('timeDetail').textContent = `ETA: ${time} min`;
                
                AppState.rideFare = selectedPrice;
                
                // Update price calculator display
                this.updatePriceCalculator(distanceKm, AppState.selectedRideType, surge);
            },
            
            updatePriceCalculator: function(distanceKm, rideType = 'standard', surge = 1.0) {
                const breakdown = EnhancedPriceCalculator.getFareBreakdown(distanceKm, rideType, surge);
                const calculator = document.getElementById('priceCalculator');
                const fareElement = document.getElementById('calculatedFare');
                const breakdownElement = document.getElementById('priceBreakdown');
                
                calculator.style.display = 'block';
                fareElement.textContent = `ZMW ${breakdown.total.toFixed(2)}`;
                
                let breakdownHTML = `
                    <div class="price-breakdown-row">
                        <span>Base Fare:</span>
                        <span>ZMW ${breakdown.baseFare.toFixed(2)}</span>
                    </div>
                    <div class="price-breakdown-row">
                        <span>Distance (${distanceKm.toFixed(1)}km):</span>
                        <span>ZMW ${breakdown.distanceFare.toFixed(2)}</span>
                    </div>
                `;
                
                if (breakdown.rideTypeMultiplier !== 1) {
                    breakdownHTML += `
                        <div class="price-breakdown-row">
                            <span>${rideType.charAt(0).toUpperCase() + rideType.slice(1)} Multiplier:</span>
                            <span>${breakdown.rideTypeMultiplier.toFixed(1)}x</span>
                        </div>
                    `;
                }
                
                if (breakdown.surgeMultiplier !== 1) {
                    breakdownHTML += `
                        <div class="price-breakdown-row">
                            <span>Surge Pricing:</span>
                            <span>+ZMW ${breakdown.surgeAmount.toFixed(2)}</span>
                        </div>
                    `;
                }
                
                if (breakdown.timeMultiplier !== 1) {
                    breakdownHTML += `
                        <div class="price-breakdown-row">
                            <span>Time of Day:</span>
                            <span>+ZMW ${breakdown.timeAmount.toFixed(2)}</span>
                        </div>
                    `;
                }
                
                breakdownHTML += `
                    <div class="price-breakdown-row total">
                        <span>Total:</span>
                        <span>ZMW ${breakdown.total.toFixed(2)}</span>
                    </div>
                `;
                
                breakdownElement.innerHTML = breakdownHTML;
                
                // Add animation
                calculator.classList.add('price-update-animation');
                setTimeout(() => {
                    calculator.classList.remove('price-update-animation');
                }, 500);
            },
            
            updateDeliveryPrices: function(distanceKm, deliveryType = 'standard', parcelValue = 0) {
                const fare = EnhancedPriceCalculator.calculateDeliveryFare(distanceKm, deliveryType, parcelValue);
                const time = EnhancedPriceCalculator.estimateTime(distanceKm, 'standard');
                
                const display = document.getElementById('deliveryFareDisplay');
                const fareElement = document.getElementById('deliveryFare');
                const distanceElement = document.getElementById('deliveryDistance');
                const timeElement = document.getElementById('deliveryTime');
                
                display.style.display = 'block';
                fareElement.textContent = `ZMW ${fare.toFixed(2)}`;
                distanceElement.textContent = `${distanceKm.toFixed(1)} km`;
                timeElement.textContent = `ETA: ${time} min`;
                
                return { fare, time };
            },
            
            updateTruckPrices: function(distanceKm, truckType = 'light', helpers = false) {
                const fare = EnhancedPriceCalculator.calculateTruckFare(distanceKm, truckType, helpers);
                const time = EnhancedPriceCalculator.estimateTime(distanceKm, 'standard');
                
                const display = document.getElementById('truckFareDisplay');
                const fareElement = document.getElementById('truckFare');
                const distanceElement = document.getElementById('truckDistance');
                const timeElement = document.getElementById('truckTime');
                
                display.style.display = 'block';
                fareElement.textContent = `ZMW ${fare.toFixed(2)}`;
                distanceElement.textContent = `${distanceKm.toFixed(1)} km`;
                timeElement.textContent = `ETA: ${time} min`;
                
                return { fare, time };
            },
            
            updateShoppingPrices: function(distanceKm, itemsCount = 1, budget = 0) {
                const fare = EnhancedPriceCalculator.calculateShoppingFare(distanceKm, itemsCount, budget);
                const time = EnhancedPriceCalculator.estimateTime(distanceKm, 'standard') + 30; // Add shopping time
                
                const display = document.getElementById('shoppingFareDisplay');
                const fareElement = document.getElementById('shoppingFare');
                const distanceElement = document.getElementById('shoppingDistance');
                const timeElement = document.getElementById('shoppingTime');
                
                display.style.display = 'block';
                fareElement.textContent = `ZMW ${fare.toFixed(2)}`;
                distanceElement.textContent = `${distanceKm.toFixed(1)} km`;
                timeElement.textContent = `ETA: ${time} min`;
                
                return { fare, time };
            },
            
            updateShortDeliveryPrices: function(distanceKm) {
                const fare = Math.max(15, distanceKm * 2.5);
                const time = EnhancedPriceCalculator.estimateTime(distanceKm, 'standard');
                
                const display = document.getElementById('shortDeliveryFareDisplay');
                const fareElement = document.getElementById('shortDeliveryFare');
                const distanceElement = document.getElementById('shortDeliveryDistance');
                const timeElement = document.getElementById('shortDeliveryTime');
                
                display.style.display = 'block';
                fareElement.textContent = `ZMW ${fare.toFixed(2)}`;
                distanceElement.textContent = `${distanceKm.toFixed(1)} km`;
                timeElement.textContent = `ETA: ${time} min`;
                
                return { fare, time };
            },
            
            updateBroadcastPrices: function(distanceKm, rideType = 'standard', splitType = 'equal', passengerCount = 2) {
                const calculation = EnhancedPriceCalculator.calculateBroadcastFare(distanceKm, rideType, splitType, passengerCount);
                
                const display = document.getElementById('broadcastFareDisplay');
                const fareElement = document.getElementById('broadcastFare');
                const distanceElement = document.getElementById('broadcastDistance');
                const timeElement = document.getElementById('broadcastTime');
                
                if (display) {
                    display.style.display = 'block';
                    fareElement.textContent = `ZMW ${calculation.total.toFixed(2)}`;
                    distanceElement.textContent = `${distanceKm.toFixed(1)} km`;
                    timeElement.textContent = `ETA: ${EnhancedPriceCalculator.estimateTime(distanceKm, rideType)} min`;
                }
                
                return calculation;
            },
            
            showRideInfo: function(ride) {
                // Hide all forms
                document.querySelectorAll('.ride-request-form, .service-form, #broadcastForm').forEach(form => {
                    form.style.display = 'none';
                });
                
                document.getElementById('rideInfoPanel').classList.add('active');
                
                // Update ride details
                document.getElementById('currentPickup').textContent = ride.pickupDisplay || ride.pickup;
                document.getElementById('currentDestination').textContent = ride.destinationDisplay || ride.destination;
                document.getElementById('rideDistance').textContent = ride.distance ? `${ride.distance.toFixed(1)} km` : '0 km';
                document.getElementById('rideTime').textContent = ride.estimatedTime ? `${ride.estimatedTime} min` : '0 min';
                
                // Calculate and display fare breakdown
                const distance = ride.distance || 0;
                let baseFare, distanceFare, total;
                
                if (ride.serviceType === 'truck') {
                    const config = AppState.truckTypes[ride.truckType] || AppState.truckTypes.light;
                    baseFare = config.base;
                    distanceFare = distance * config.perKm;
                    total = ride.fare || baseFare + distanceFare;
                } else if (ride.serviceType === 'delivery') {
                    const config = AppState.deliveryTypes[ride.deliveryType] || AppState.deliveryTypes.standard;
                    baseFare = config.base;
                    distanceFare = distance * config.perKm;
                    total = ride.fare || baseFare + distanceFare;
                } else if (ride.serviceType === 'shopping') {
                    baseFare = 30;
                    distanceFare = distance * 2.5;
                    total = ride.fare || baseFare + distanceFare + (ride.itemsCount || 1) * 5;
                } else {
                    const config = AppState.rideTypes[ride.rideType] || AppState.rideTypes.standard;
                    baseFare = config.base;
                    distanceFare = distance * config.perKm;
                    total = ride.fare || baseFare + distanceFare;
                }
                
                document.getElementById('baseFareValue').textContent = `ZMW ${baseFare.toFixed(2)}`;
                document.getElementById('distanceFareValue').textContent = `ZMW ${distanceFare.toFixed(2)}`;
                
                if (ride.serviceType) {
                    document.getElementById('rideTypeValue').textContent = 
                        ride.serviceType.charAt(0).toUpperCase() + ride.serviceType.slice(1);
                } else {
                    document.getElementById('rideTypeValue').textContent = 
                        ride.rideType?.charAt(0).toUpperCase() + ride.rideType?.slice(1) || 'Standard';
                }
                
                document.getElementById('totalFareValue').textContent = `ZMW ${total.toFixed(2)}`;
                
                // Show ride status bar
                this.updateRideStatus(ride.status);
                
                // Update timeline
                this.updateTimeline(ride.status);
                
                // Show SOS button if driver accepted and SOS is configured
                if (ride.status === 'accepted' && AppState.sosConfig) {
                    document.getElementById('sosButton').style.display = 'flex';
                }
                
                // Show emergency contacts if emergency ride
                if (ride.emergency && AppState.sosConfig) {
                    document.getElementById('emergencyContactDisplay').style.display = 'block';
                }
                
                // Show broadcast feature if broadcast ride
                if (ride.broadcast) {
                    document.getElementById('broadcastFeature').style.display = 'block';
                }
            },
            
            updateRideStatus: function(status) {
                const statusBar = document.getElementById('rideStatusBar');
                const statusDot = document.getElementById('statusDot');
                const statusText = document.getElementById('statusText');
                const etaText = document.getElementById('etaText');
                
                statusBar.classList.add('active');
                
                switch(status) {
                    case 'requested':
                        statusDot.className = 'status-dot searching';
                        statusText.textContent = 'Searching for driver';
                        etaText.textContent = '5-10 min';
                        break;
                    case 'accepted':
                        statusDot.className = 'status-dot arriving';
                        statusText.textContent = 'Driver on the way';
                        etaText.textContent = '5 min';
                        break;
                    case 'arrived':
                        statusDot.className = 'status-dot riding';
                        statusText.textContent = 'Driver arrived';
                        etaText.textContent = '0 min';
                        break;
                    case 'started':
                        statusDot.className = 'status-dot riding';
                        statusText.textContent = 'Trip in progress';
                        etaText.textContent = 'En route';
                        break;
                    case 'completed':
                        statusBar.classList.remove('active');
                        break;
                    case 'cancelled':
                        statusBar.classList.remove('active');
                        break;
                }
            },
            
            updateTimeline: function(status) {
                const steps = ['stepRequested', 'stepAccepted', 'stepArrived', 'stepStarted', 'stepCompleted'];
                const stepLabels = ['Requested', 'Accepted', 'Arrived', 'Started', 'Completed'];
                let currentIndex = stepLabels.indexOf(status);
                
                if (currentIndex === -1) {
                    currentIndex = 0;
                }
                
                steps.forEach((stepId, index) => {
                    const step = document.getElementById(stepId);
                    const label = step.parentNode.querySelector('.step-label');
                    
                    if (index < currentIndex) {
                        step.className = 'step-dot completed';
                        label.className = 'step-label';
                    } else if (index === currentIndex) {
                        step.className = 'step-dot active';
                        label.className = 'step-label active';
                    } else {
                        step.className = 'step-dot';
                        label.className = 'step-label';
                    }
                });
            },
            
            showSearchSuggestions: function(inputId, results) {
                const container = document.getElementById(`${inputId}Suggestions`);
                if (!container) return;
                
                container.innerHTML = '';
                
                if (results.length === 0) {
                    container.innerHTML = '<div class="no-results"><i class="fas fa-search"></i><div>No results found</div></div>';
                } else {
                    results.forEach(result => {
                        const item = document.createElement('div');
                        item.className = 'suggestion-item';
                        item.innerHTML = `
                            <div class="suggestion-icon">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="suggestion-details">
                                <div class="suggestion-name">${result.name}</div>
                                <div class="suggestion-address">${result.address}</div>
                                ${result.distance ? `<div class="suggestion-distance">${result.distance.toFixed(1)} km away</div>` : ''}
                            </div>
                        `;
                        
                        item.addEventListener('click', () => {
                            this.selectLocation(inputId, result);
                        });
                        
                        container.appendChild(item);
                    });
                }
                
                container.classList.add('active');
            },
            
            showSearchHistory: function(inputId) {
                const container = document.getElementById('searchHistory');
                const history = EnhancedSearchEngine.getSearchHistory('destination');
                
                if (history.length === 0) {
                    container.style.display = 'none';
                    return;
                }
                
                let html = '';
                history.forEach(item => {
                    html += `
                        <div class="search-history-item" data-lat="${item.location.lat}" data-lng="${item.location.lng}">
                            <div class="search-history-icon">
                                <i class="fas fa-history"></i>
                            </div>
                            <div class="search-history-text">
                                <div>${item.location.name}</div>
                                <div style="font-size: 11px; color: var(--text-light);">${item.location.address}</div>
                            </div>
                            <div class="search-history-time">
                                ${this.formatTimeAgo(item.timestamp)}
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                container.style.display = 'block';
                
                // Add click events
                container.querySelectorAll('.search-history-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const lat = parseFloat(item.dataset.lat);
                        const lng = parseFloat(item.dataset.lng);
                        const location = {
                            lat: lat,
                            lng: lng,
                            name: item.querySelector('.search-history-text div').textContent,
                            address: item.querySelector('.search-history-text div:nth-child(2)').textContent
                        };
                        
                        this.selectLocation(inputId, location);
                        container.style.display = 'none';
                    });
                });
            },
            
            formatTimeAgo: function(timestamp) {
                const now = Date.now();
                const diff = now - timestamp;
                
                if (diff < 60000) return 'Just now';
                if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
                if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
                return `${Math.floor(diff / 86400000)}d ago`;
            },
            
            selectLocation: function(inputId, location) {
                const input = document.getElementById(inputId);
                const container = document.getElementById(`${inputId}Suggestions`);
                const historyContainer = document.getElementById('searchHistory');
                
                if (input && location) {
                    input.value = location.address || location.name;
                    
                    // Update AppState based on input type
                    if (inputId.includes('destination') || inputId.includes('Destination')) {
                        AppState.destination = location;
                        this.updateDestinationMarker(location);
                        this.calculateAndUpdatePrices();
                    } else if (inputId.includes('pickup') || inputId.includes('Pickup')) {
                        AppState.pickup = location;
                        this.updatePickupMarker(location);
                    }
                    
                    if (container) {
                        container.classList.remove('active');
                    }
                    
                    if (historyContainer) {
                        historyContainer.style.display = 'none';
                    }
                }
            },
            
            updatePickupMarker: function(location) {
                if (pickupMarker) {
                    pickupMarker.setLatLng([location.lat, location.lng]);
                } else {
                    pickupMarker = L.marker([location.lat, location.lng], {
                        icon: L.divIcon({
                            className: 'pickup-marker',
                            html: '<i class="fas fa-map-marker-alt"></i>',
                            iconSize: [20, 20]
                        })
                    }).addTo(map).bindPopup('Pickup Location');
                }
                
                if (AppState.destination) {
                    this.drawRoute(location, AppState.destination);
                }
            },
            
            updateDestinationMarker: function(location) {
                if (destinationMarker) {
                    destinationMarker.setLatLng([location.lat, location.lng]);
                } else {
                    destinationMarker = L.marker([location.lat, location.lng], {
                        icon: L.divIcon({
                            className: 'destination-marker',
                            html: '<i class="fas fa-flag"></i>',
                            iconSize: [20, 20]
                        })
                    }).addTo(map).bindPopup('Destination');
                }
                
                if (AppState.pickup) {
                    this.drawRoute(AppState.pickup, location);
                }
            },
            
            drawRoute: function(start, end) {
                if (routeLayer) {
                    map.removeLayer(routeLayer);
                }
                
                routeLayer = L.Routing.control({
                    waypoints: [
                        L.latLng(start.lat, start.lng),
                        L.latLng(end.lat, end.lng)
                    ],
                    routeWhileDragging: false,
                    showAlternatives: false,
                    lineOptions: {
                        styles: [{color: '#FF6B35', weight: 3, opacity: 0.7}]
                    },
                    createMarker: function() { return null; }
                }).addTo(map);
                
                // Fit bounds to show entire route
                const bounds = L.latLngBounds(
                    [start.lat, start.lng],
                    [end.lat, end.lng]
                );
                map.fitBounds(bounds, { padding: [30, 30] });
            },
            
            calculateAndUpdatePrices: function() {
                if (AppState.pickup && AppState.destination) {
                    const distance = EnhancedPriceCalculator.calculateDistance(
                        AppState.pickup.lat, AppState.pickup.lng,
                        AppState.destination.lat, AppState.destination.lng
                    );
                    
                    // Update prices based on active service
                    switch(AppState.activeService) {
                        case 'car':
                            this.updateRidePrices(distance);
                            document.getElementById('fareDisplay').classList.add('active');
                            document.getElementById('rideTypeSelection').classList.add('active');
                            break;
                        case 'delivery':
                            this.updateDeliveryPrices(distance);
                            break;
                        case 'short-delivery':
                            this.updateShortDeliveryPrices(distance);
                            break;
                        case 'truck':
                            this.updateTruckPrices(distance);
                            break;
                        case 'express':
                            this.updateShoppingPrices(distance);
                            break;
                    }
                }
            },
            
            showDriverInfo: function(driver) {
                const avatar = document.getElementById('driverAvatar');
                const name = document.getElementById('driverName');
                const rating = document.getElementById('driverRating');
                const vehicle = document.getElementById('vehicleDetails');
                
                if (driver.photoUrl) {
                    avatar.innerHTML = `<img src="${driver.photoUrl}" alt="${driver.name}">`;
                } else {
                    avatar.innerHTML = `<i class="fas fa-user"></i>`;
                }
                
                name.textContent = driver.name || 'Driver';
                rating.textContent = driver.rating?.toFixed(1) || '4.8';
                vehicle.textContent = `${driver.vehicle?.model || 'Car'} - ${driver.vehicle?.plate || 'ABC 123'}`;
                
                // Load driver and vehicle images
                this.loadDriverImages(driver);
                
                // Add driver marker to map
                if (driver.location) {
                    this.updateDriverMarker(driver.location);
                }
            },
            
            loadDriverImages: function(driver) {
                // Load driver image
                if (driver.photoUrl) {
                    const driverImg = document.getElementById('driverImage');
                    const driverPlaceholder = document.getElementById('driverImagePlaceholder');
                    
                    driverImg.src = driver.photoUrl;
                    driverImg.onload = function() {
                        driverImg.style.display = 'block';
                        driverPlaceholder.style.display = 'none';
                    };
                    driverImg.onerror = function() {
                        driverImg.style.display = 'none';
                        driverPlaceholder.style.display = 'flex';
                    };
                }
                
                // Load vehicle image
                if (driver.vehicle?.photoUrl) {
                    const vehicleImg = document.getElementById('vehicleImage');
                    const vehiclePlaceholder = document.getElementById('vehicleImagePlaceholder');
                    
                    vehicleImg.src = driver.vehicle.photoUrl;
                    vehicleImg.onload = function() {
                        vehicleImg.style.display = 'block';
                        vehiclePlaceholder.style.display = 'none';
                    };
                    vehicleImg.onerror = function() {
                        vehicleImg.style.display = 'none';
                        vehiclePlaceholder.style.display = 'flex';
                    };
                }
            },
            
            updateDriverMarker: function(location) {
                if (driverMarker) {
                    driverMarker.setLatLng([location.lat, location.lng]);
                } else {
                    driverMarker = L.marker([location.lat, location.lng], {
                        icon: L.divIcon({
                            className: 'driver-marker',
                            html: '<i class="fas fa-car"></i>',
                            iconSize: [32, 32]
                        })
                    }).addTo(map).bindPopup('Your Driver');
                }
            },
            
            updateDriverTracking: function(driverLocation, pickupLocation) {
                if (!driverLocation || !pickupLocation) return;
                
                const distance = EnhancedPriceCalculator.calculateDistance(
                    driverLocation.lat, driverLocation.lng,
                    pickupLocation.lat, pickupLocation.lng
                );
                
                const progress = document.getElementById('trackingProgress');
                const distanceElement = document.getElementById('driverDistance');
                const pickupDistanceElement = document.getElementById('pickupDistance');
                const etaElement = document.getElementById('etaToPickup');
                
                distanceElement.textContent = `${distance.toFixed(1)} km`;
                pickupDistanceElement.textContent = `${distance.toFixed(1)} km to pickup`;
                
                // Calculate ETA (assuming average speed of 40 km/h)
                const eta = Math.ceil((distance / 40) * 60);
                etaElement.textContent = `ETA: ${eta} min`;
                
                // Update progress bar (inverse of distance, capped at 100%)
                const maxDistance = 10; // Assume 10km is max distance to show progress
                const progressPercent = Math.max(0, 100 - (distance / maxDistance) * 100);
                progress.style.width = `${Math.min(progressPercent, 100)}%`;
            },
            
            showChatMessage: function(message, isSender = false) {
                const container = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                
                messageDiv.className = `message ${isSender ? 'sent' : 'received'}`;
                messageDiv.innerHTML = `
                    <div>${message.text}</div>
                    <div class="message-time">${new Date(message.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                `;
                
                container.appendChild(messageDiv);
                container.scrollTop = container.scrollHeight;
                
                // Show chat notification if not open
                if (!isSender && !document.getElementById('chatContainer').classList.contains('active')) {
                    this.showChatNotification();
                }
            },
            
            showChatNotification: function() {
                // Implement chat notification badge
                const chatBtn = document.getElementById('openChatBtn');
                if (chatBtn) {
                    let badge = chatBtn.querySelector('.chat-notification');
                    if (!badge) {
                        badge = document.createElement('div');
                        badge.className = 'chat-notification';
                        chatBtn.appendChild(badge);
                    }
                    badge.textContent = '1';
                }
            },
            
            updateTypingIndicator: function(isTyping) {
                const indicator = document.getElementById('typingIndicator');
                if (isTyping) {
                    indicator.classList.add('active');
                } else {
                    indicator.classList.remove('active');
                }
            },
            
            updateHistoryList: function(rides) {
                const container = document.getElementById('historyList');
                container.innerHTML = '';
                
                if (rides.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">
                                <i class="fas fa-history"></i>
                            </div>
                            <div class="empty-title">No rides found</div>
                            <div class="empty-message">${AppState.activeFilter === 'all' ? 'You haven\'t taken any rides yet' : 'No rides match your filter'}</div>
                        </div>
                    `;
                    return;
                }
                
                rides.forEach(ride => {
                    const item = this.createHistoryItem(ride);
                    container.appendChild(item);
                });
            },
            
            createHistoryItem: function(ride) {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.dataset.rideId = ride.id;
                
                const date = new Date(ride.timestamp);
                let typeIcon, typeColor, typeName;
                
                if (ride.emergency) {
                    typeIcon = 'fa-ambulance';
                    typeColor = 'var(--error-red)';
                    typeName = 'Emergency Ride';
                } else if (ride.scheduled) {
                    typeIcon = 'fa-calendar-alt';
                    typeColor = 'var(--info-blue)';
                    typeName = 'Scheduled Ride';
                } else if (ride.broadcast) {
                    typeIcon = 'fa-broadcast-tower';
                    typeColor = 'var(--warning-yellow)';
                    typeName = 'Broadcast Ride';
                } else if (ride.serviceType === 'delivery') {
                    typeIcon = 'fa-shipping-fast';
                    typeColor = 'var(--delivery-purple)';
                    typeName = 'Delivery';
                } else if (ride.serviceType === 'truck') {
                    typeIcon = 'fa-truck';
                    typeColor = 'var(--light-truck-brown)';
                    typeName = 'Truck Delivery';
                } else if (ride.serviceType === 'shopping') {
                    typeIcon = 'fa-shopping-bag';
                    typeColor = 'var(--express-shop-green)';
                    typeName = 'Express Shopping';
                } else {
                    typeIcon = 'fa-car';
                    typeColor = 'var(--primary-orange)';
                    typeName = 'Standard Ride';
                }
                
                const statusClass = ride.status === 'completed' ? 'status-completed' :
                                 ride.status === 'cancelled' ? 'status-cancelled' :
                                 'status-ongoing';
                
                item.innerHTML = `
                    <div class="history-header">
                        <div class="history-type">
                            <div class="history-icon" style="background: ${typeColor}">
                                <i class="fas ${typeIcon}"></i>
                            </div>
                            <div class="history-type-name">
                                ${typeName}
                            </div>
                        </div>
                        <div class="history-date">
                            ${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                        </div>
                    </div>
                    
                    <div class="history-locations">
                        <div class="history-location">
                            <i class="fas fa-map-marker-alt"></i>
                            <div class="history-location-text">${ride.pickupDisplay || ride.pickup || 'Not specified'}</div>
                        </div>
                        <div class="history-location">
                            <i class="fas fa-flag"></i>
                            <div class="history-location-text">${ride.destinationDisplay || ride.destination || 'Not specified'}</div>
                        </div>
                    </div>
                    
                    <div class="history-footer">
                        <div class="history-price">ZMW ${ride.fare?.toFixed(2) || '0.00'}</div>
                        <div class="history-status ${statusClass}">
                            ${ride.status?.charAt(0).toUpperCase() + ride.status?.slice(1) || 'Unknown'}
                        </div>
                    </div>
                    
                    <div class="history-details">
                        <div class="detail-section">
                            <div class="detail-title">
                                <i class="fas fa-info-circle"></i>
                                Ride Details
                            </div>
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <div class="detail-label">Distance</div>
                                    <div class="detail-value">${ride.distance?.toFixed(1) || '0'} km</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Ride Type</div>
                                    <div class="detail-value">${ride.rideType?.charAt(0).toUpperCase() + ride.rideType?.slice(1) || ride.serviceType?.charAt(0).toUpperCase() + ride.serviceType?.slice(1) || 'Standard'}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Payment</div>
                                    <div class="detail-value">${ride.paymentMethod?.charAt(0).toUpperCase() + ride.paymentMethod?.slice(1) || 'Wallet'}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Driver</div>
                                    <div class="detail-value">${ride.driverName || 'Not assigned'}</div>
                                </div>
                            </div>
                        </div>
                        
                        ${ride.emergency ? `
                        <div class="detail-section">
                            <div class="detail-title">
                                <i class="fas fa-exclamation-triangle"></i>
                                Emergency Details
                            </div>
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <div class="detail-label">Service Type</div>
                                    <div class="detail-value">${ride.emergencyType?.charAt(0).toUpperCase() + ride.emergencyType?.slice(1) || 'Emergency'}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Priority</div>
                                    <div class="detail-value">${ride.priority || 'High'}</div>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${ride.broadcast ? `
                        <div class="detail-section">
                            <div class="detail-title">
                                <i class="fas fa-broadcast-tower"></i>
                                Broadcast Details
                            </div>
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <div class="detail-label">Passengers</div>
                                    <div class="detail-value">${ride.passengerCount || 1}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Split Type</div>
                                    <div class="detail-value">${ride.splitType?.replace(/_/g, ' ') || 'Equal'}</div>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${ride.serviceType === 'delivery' ? `
                        <div class="detail-section">
                            <div class="detail-title">
                                <i class="fas fa-box"></i>
                                Delivery Details
                            </div>
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <div class="detail-label">Parcel</div>
                                    <div class="detail-value">${ride.parcelDescription || 'Not specified'}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Receiver</div>
                                    <div class="detail-value">${ride.receiverName || 'Not specified'}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Parcel Value</div>
                                    <div class="detail-value">ZMW ${ride.parcelValue?.toFixed(2) || '0.00'}</div>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;
                
                // Add click event to expand/collapse details
                item.addEventListener('click', (e) => {
                    if (!e.target.closest('.history-details')) {
                        item.classList.toggle('expanded');
                    }
                });
                
                return item;
            },
            
            updateShareRideCalculations: function(distanceKm, splitPercentage = 50) {
                const surge = EnhancedPriceCalculator.getSurgeMultiplier();
                const totalFare = EnhancedPriceCalculator.calculateRideFare(distanceKm, AppState.selectedRideType, surge);
                const yourShare = (totalFare * splitPercentage) / 100;
                const friendShare = totalFare - yourShare;
                
                document.getElementById('shareFareEstimate').textContent = `ZMW ${totalFare.toFixed(2)}`;
                document.getElementById('yourShare').textContent = `ZMW ${yourShare.toFixed(2)}`;
                document.getElementById('friendShare').textContent = `ZMW ${friendShare.toFixed(2)}`;
                
                return { totalFare, yourShare, friendShare };
            },
            
            updateNotifications: function(notifications) {
                const container = document.getElementById('notificationsList');
                if (!container) return;
                
                container.innerHTML = '';
                
                if (notifications.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state" style="padding: 30px 20px;">
                            <div class="empty-icon">
                                <i class="fas fa-bell-slash"></i>
                            </div>
                            <div class="empty-title">No notifications</div>
                            <div class="empty-message">You're all caught up!</div>
                        </div>
                    `;
                    return;
                }
                
                notifications.forEach(notification => {
                    const item = document.createElement('div');
                    item.className = `notification-item ${notification.read ? '' : 'unread'}`;
                    item.dataset.notificationId = notification.id;
                    
                    const time = new Date(notification.timestamp);
                    let icon = 'fa-info-circle';
                    let iconColor = 'var(--info-blue)';
                    
                    if (notification.type === 'success') {
                        icon = 'fa-check-circle';
                        iconColor = 'var(--success-green)';
                    } else if (notification.type === 'error') {
                        icon = 'fa-exclamation-circle';
                        iconColor = 'var(--error-red)';
                    } else if (notification.type === 'warning') {
                        icon = 'fa-exclamation-triangle';
                        iconColor = 'var(--warning-yellow)';
                    } else if (notification.type === 'ride') {
                        icon = 'fa-car';
                        iconColor = 'var(--primary-orange)';
                    } else if (notification.type === 'payment') {
                        icon = 'fa-money-bill-wave';
                        iconColor = 'var(--success-green)';
                    } else if (notification.type === 'referral') {
                        icon = 'fa-gift';
                        iconColor = 'var(--primary-orange)';
                    } else if (notification.type === 'broadcast') {
                        icon = 'fa-broadcast-tower';
                        iconColor = 'var(--warning-yellow)';
                    }
                    
                    item.innerHTML = `
                        <div class="notification-header">
                            <div class="notification-title">
                                <i class="fas ${icon}" style="color: ${iconColor}"></i>
                                ${notification.title || 'Notification'}
                            </div>
                            <div class="notification-time">
                                ${time.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                            </div>
                        </div>
                        <div class="notification-message">
                            ${notification.message}
                        </div>
                        ${notification.actions ? `
                        <div class="notification-actions">
                            ${notification.actions.map(action => `
                                <button class="notification-action-btn" data-action="${action.action}">
                                    ${action.label}
                                </button>
                            `).join('')}
                        </div>
                        ` : ''}
                    `;
                    
                    container.appendChild(item);
                    
                    // Add click event
                    item.addEventListener('click', () => {
                        if (!notification.read) {
                            EnhancedFirebaseManager.markNotificationAsRead(notification.id);
                        }
                        
                        // Handle notification actions
                        if (notification.action) {
                            this.handleNotificationAction(notification.action, notification.data);
                        }
                    });
                });
            },
            
            handleNotificationAction: function(action, data) {
                switch(action) {
                    case 'view_ride':
                        if (data.rideId) {
                            EnhancedFirebaseManager.loadRideDetails(data.rideId);
                        }
                        break;
                    case 'accept_broadcast':
                        if (data.broadcastId) {
                            EnhancedFirebaseManager.acceptBroadcastInvitation(data.broadcastId);
                        }
                        break;
                    case 'view_payment':
                        // Handle payment view
                        break;
                }
            },
            
            updateNotificationBadge: function(count) {
                const badge = document.getElementById('notificationCount');
                if (badge) {
                    badge.textContent = count;
                    if (count > 0) {
                        badge.style.display = 'flex';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            },
            
            showEmergencyStations: function(stations) {
                const container = document.getElementById('emergencyStations');
                if (!container) return;
                
                container.innerHTML = '';
                
                if (stations.length === 0) {
                    container.innerHTML = '<div class="no-results">No emergency stations found in your city</div>';
                    return;
                }
                
                stations.forEach(station => {
                    const stationElement = document.createElement('div');
                    stationElement.className = 'emergency-station';
                    stationElement.dataset.stationId = station.id;
                    stationElement.dataset.lat = station.lat;
                    stationElement.dataset.lng = station.lng;
                    stationElement.dataset.distance = station.distance;
                    
                    stationElement.innerHTML = `
                        <div class="station-header">
                            <div class="station-name">${station.name}</div>
                            <div class="station-distance">${station.distance.toFixed(1)} km</div>
                        </div>
                        <div class="station-address">${station.address}</div>
                        <div class="station-details">
                            <span><i class="fas fa-phone"></i> Emergency</span>
                            <span><i class="fas fa-clock"></i> 24/7</span>
                        </div>
                    `;
                    
                    stationElement.addEventListener('click', () => {
                        // Remove selected class from all stations
                        container.querySelectorAll('.emergency-station').forEach(s => {
                            s.classList.remove('selected');
                        });
                        
                        // Add selected class to clicked station
                        stationElement.classList.add('selected');
                        
                        // Update selected station
                        AppState.selectedEmergencyStation = station;
                        
                        // Update emergency modal with station details
                        this.updateEmergencyStationDetails(station);
                    });
                    
                    container.appendChild(stationElement);
                });
                
                // Select first station by default
                if (stations.length > 0) {
                    const firstStation = container.querySelector('.emergency-station');
                    if (firstStation) {
                        firstStation.classList.add('selected');
                        AppState.selectedEmergencyStation = stations[0];
                        this.updateEmergencyStationDetails(stations[0]);
                    }
                }
            },
            
            updateEmergencyStationDetails: function(station) {
                // Update emergency modal with station details and calculate fare
                if (!station || !AppState.userLocation) return;
                
                const distance = EnhancedPriceCalculator.calculateDistance(
                    AppState.userLocation.lat, AppState.userLocation.lng,
                    station.lat, station.lng
                );
                
                const emergencyType = document.getElementById('emergencyServiceType').dataset.type;
                const fare = EnhancedPriceCalculator.calculateEmergencyFare(distance, emergencyType);
                const time = EnhancedPriceCalculator.estimateTime(distance, 'standard');
                
                document.getElementById('emergencyDistance').textContent = `${distance.toFixed(1)} km`;
                document.getElementById('emergencyTime').textContent = `${time} min`;
                document.getElementById('emergencyTotalFare').textContent = `ZMW ${fare.toFixed(2)}`;
                
                // Update emergency base fare
                const config = AppState.emergencyServices[emergencyType];
                if (config) {
                    document.getElementById('emergencyBaseFare').textContent = `ZMW ${config.base.toFixed(2)}`;
                }
                
                // Add station marker to map
                this.addEmergencyStationMarker(station);
            },
            
            addEmergencyStationMarker: function(station) {
                // Clear existing station markers
                emergencyStationMarkers.forEach(marker => map.removeLayer(marker));
                emergencyStationMarkers = [];
                
                // Add new marker
                const marker = L.marker([station.lat, station.lng], {
                    icon: L.divIcon({
                        className: 'emergency-vehicle-marker',
                        html: `<i class="fas fa-${station.type === 'police' ? 'shield-alt' : station.type === 'fire' ? 'fire-extinguisher' : 'ambulance'}"></i>`,
                        iconSize: [36, 36]
                    })
                }).addTo(map).bindPopup(station.name);
                
                emergencyStationMarkers.push(marker);
                
                // Fit map to show user location and station
                if (AppState.userLocation) {
                    const bounds = L.latLngBounds(
                        [AppState.userLocation.lat, AppState.userLocation.lng],
                        [station.lat, station.lng]
                    );
                    map.fitBounds(bounds, { padding: [50, 50] });
                }
            },
            
            updateEmergencyReason: function(reason) {
                AppState.emergencyReason = reason;
                
                // Show/hide other reason input
                const otherInput = document.getElementById('emergencyReasonOther');
                if (reason === 'other') {
                    otherInput.style.display = 'block';
                } else {
                    otherInput.style.display = 'none';
                }
            },
            
            updateBroadcastRecipients: function(recipients) {
                const container = document.getElementById('broadcastRecipients');
                if (!container) return;
                
                container.innerHTML = '';
                
                if (recipients.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: var(--text-light); padding: 10px;">No recipients added</div>';
                    return;
                }
                
                recipients.forEach(recipient => {
                    const recipientElement = document.createElement('div');
                    recipientElement.className = 'broadcast-recipient';
                    recipientElement.dataset.phone = recipient.phone;
                    
                    recipientElement.innerHTML = `
                        <div class="recipient-info">
                            <div class="recipient-avatar">
                                ${recipient.name ? recipient.name.charAt(0).toUpperCase() : '?'}
                            </div>
                            <div>
                                <div class="recipient-name">${recipient.name || 'Unknown'}</div>
                                <div style="font-size: 11px; color: var(--text-light);">${recipient.phone}</div>
                            </div>
                        </div>
                        <div class="recipient-status ${recipient.status === 'joined' ? 'status-joined' : 'status-pending'}">
                            ${recipient.status === 'joined' ? 'Joined' : 'Pending'}
                        </div>
                    `;
                    
                    container.appendChild(recipientElement);
                });
            },
            
            updateBroadcastStatus: function(isActive) {
                const indicator = document.getElementById('broadcastStatusIndicator');
                if (indicator) {
                    if (isActive) {
                        indicator.classList.remove('inactive');
                        indicator.classList.add('active');
                    } else {
                        indicator.classList.remove('active');
                        indicator.classList.add('inactive');
                    }
                }
            },
            
            showSyncIndicator: function(isSyncing) {
                const indicator = document.getElementById('syncIndicator');
                if (indicator) {
                    if (isSyncing) {
                        indicator.classList.add('active', 'syncing');
                    } else {
                        indicator.classList.remove('active', 'syncing');
                    }
                }
            },
            
            showRealTimeIndicator: function() {
                const indicator = document.getElementById('realTimeIndicator');
                if (indicator) {
                    indicator.classList.add('active');
                    setTimeout(() => {
                        indicator.classList.remove('active');
                    }, 3000);
                }
            }
        };

        // ============================================
        // ENHANCED FIREBASE MANAGER
        // ============================================
        const EnhancedFirebaseManager = {
            async loadUserData(uid) {
                try {
                    const snapshot = await database.ref(`users/${uid}`).once('value');
                    AppState.userData = snapshot.val();
                    
                    if (AppState.userData) {
                        AppState.walletBalance = AppState.userData.walletBalance || 0;
                        EnhancedUIUpdater.updateWalletBalance(AppState.walletBalance);
                        EnhancedUIUpdater.updateUserInfo(AppState.userData);
                        
                        // Load SOS config
                        await this.loadSOSConfig(uid);
                        
                        // Load scheduled rides
                        await this.loadScheduledRides(uid);
                        
                        // Check for active ride
                        await this.checkActiveRide(uid);
                        
                        // Load ride history
                        await this.loadRideHistory(uid);
                        
                        // Load notifications
                        await this.loadNotifications(uid);
                        
                        // Load search history
                        EnhancedSearchEngine.loadSearchHistory();
                        
                        // Start real-time sync
                        this.startRealtimeSync(uid);
                        
                        return true;
                    }
                    return false;
                } catch (error) {
                    console.error('Error loading user data:', error);
                    EnhancedUIUpdater.showToast('Error loading user data', 'error');
                    return false;
                }
            },
            
            startRealtimeSync: function(uid) {
                // Clear existing listeners
                this.stopRealtimeSync();
                
                // Listen for user data changes
                const userRef = database.ref(`users/${uid}`);
                AppState.realtimeListeners.push(
                    userRef.on('value', (snapshot) => {
                        const userData = snapshot.val();
                        if (userData) {
                            AppState.userData = userData;
                            AppState.walletBalance = userData.walletBalance || 0;
                            EnhancedUIUpdater.updateWalletBalance(AppState.walletBalance);
                            EnhancedUIUpdater.updateUserInfo(userData);
                        }
                    })
                );
                
                // Listen for active ride changes
                const activeRideRef = database.ref('rides')
                    .orderByChild('passengerId')
                    .equalTo(uid)
                    .orderByChild('status')
                    .startAt('requested')
                    .endAt('started');
                
                AppState.realtimeListeners.push(
                    activeRideRef.on('value', (snapshot) => {
                        const rides = snapshot.val();
                        if (rides) {
                            const rideId = Object.keys(rides)[0];
                            const ride = { id: rideId, ...rides[rideId] };
                            
                            if (!AppState.currentRide || AppState.currentRide.id !== rideId) {
                                AppState.currentRide = ride;
                                EnhancedUIUpdater.showRideInfo(ride);
                                
                                // Listen to driver location if assigned
                                if (ride.driverId) {
                                    this.listenToDriverLocation(ride.driverId);
                                    this.loadDriverInfo(ride.driverId);
                                }
                                
                                // Listen to chat messages
                                this.listenToChatMessages(rideId);
                            } else {
                                // Update existing ride
                                AppState.currentRide = ride;
                                EnhancedUIUpdater.updateRideStatus(ride.status);
                                EnhancedUIUpdater.updateTimeline(ride.status);
                                
                                // Show SOS button when driver accepted
                                if (ride.status === 'accepted' && AppState.sosConfig) {
                                    document.getElementById('sosButton').style.display = 'flex';
                                }
                                
                                // Handle ride completion
                                if (ride.status === 'completed') {
                                    this.handleRideCompletion(ride);
                                }
                            }
                        } else if (AppState.currentRide) {
                            // No active ride found
                            this.resetActiveRide();
                        }
                    })
                );
                
                // Listen for notifications
                const notificationsRef = database.ref(`notifications/${uid}`)
                    .orderByChild('timestamp')
                    .limitToLast(20);
                
                AppState.realtimeListeners.push(
                    notificationsRef.on('value', (snapshot) => {
                        const notifications = snapshot.val();
                        if (notifications) {
                            AppState.notifications = Object.values(notifications).reverse();
                            const unreadCount = AppState.notifications.filter(n => !n.read).length;
                            AppState.unreadNotifications = unreadCount;
                            EnhancedUIUpdater.updateNotificationBadge(unreadCount);
                            EnhancedUIUpdater.updateNotifications(AppState.notifications);
                        }
                    })
                );
                
                // Show real-time indicator
                EnhancedUIUpdater.showRealTimeIndicator();
            },
            
            stopRealtimeSync: function() {
                AppState.realtimeListeners.forEach(listener => {
                    if (listener && typeof listener === 'function') {
                        listener(); // Call to unsubscribe
                    }
                });
                AppState.realtimeListeners = [];
            },
            
            async loadSOSConfig(uid) {
                try {
                    const snapshot = await database.ref(`sosConfig/${uid}`).once('value');
                    AppState.sosConfig = snapshot.val();
                    
                    if (AppState.sosConfig) {
                        // Update emergency contact display
                        document.getElementById('emergencyContact1Name').textContent = AppState.sosConfig.contact1Name || 'Contact 1';
                        document.getElementById('emergencyContact1Phone').textContent = AppState.sosConfig.contact1Phone || '';
                        document.getElementById('emergencyContact2Name').textContent = AppState.sosConfig.contact2Name || 'Contact 2';
                        document.getElementById('emergencyContact2Phone').textContent = AppState.sosConfig.contact2Phone || '';
                        
                        // Show SOS button in forms
                        document.getElementById('sosButton').style.display = 'none'; // Will show when ride is accepted
                    }
                } catch (error) {
                    console.error('Error loading SOS config:', error);
                }
            },
            
            async loadScheduledRides(uid) {
                try {
                    const snapshot = await database.ref('scheduledRides')
                        .orderByChild('passengerId')
                        .equalTo(uid)
                        .once('value');
                    
                    const rides = snapshot.val();
                    if (rides) {
                        AppState.scheduledRides = Object.values(rides).filter(ride => 
                            ride.status === 'scheduled' || ride.status === 'upcoming'
                        );
                    }
                } catch (error) {
                    console.error('Error loading scheduled rides:', error);
                }
            },
            
            async checkActiveRide(uid) {
                try {
                    const snapshot = await database.ref('rides')
                        .orderByChild('passengerId')
                        .equalTo(uid)
                        .orderByChild('status')
                        .startAt('requested')
                        .endAt('started')
                        .once('value');
                    
                    const rides = snapshot.val();
                    if (rides) {
                        const rideId = Object.keys(rides)[0];
                        AppState.currentRide = { id: rideId, ...rides[rideId] };
                        EnhancedUIUpdater.showRideInfo(AppState.currentRide);
                        
                        // Listen for ride updates
                        this.listenToRideUpdates(rideId);
                        
                        // If driver assigned, listen to driver location
                        if (AppState.currentRide.driverId) {
                            this.listenToDriverLocation(AppState.currentRide.driverId);
                            this.loadDriverInfo(AppState.currentRide.driverId);
                        }
                        
                        // Listen to chat messages
                        this.listenToChatMessages(rideId);
                        
                        return true;
                    }
                    return false;
                } catch (error) {
                    console.error('Error checking active ride:', error);
                    return false;
                }
            },
            
            async loadRideHistory(uid) {
                try {
                    const snapshot = await database.ref('rides')
                        .orderByChild('passengerId')
                        .equalTo(uid)
                        .once('value');
                    
                    const rides = snapshot.val();
                    if (rides) {
                        const ridesArray = Object.keys(rides).map(id => ({
                            id,
                            ...rides[id]
                        })).sort((a, b) => b.timestamp - a.timestamp);
                        
                        // Filter based on active filter
                        const filtered = this.filterRides(ridesArray, AppState.activeFilter);
                        
                        // Update UI
                        EnhancedUIUpdater.updateHistoryList(filtered);
                        
                        // Update stats
                        this.updateUserStats(ridesArray);
                    }
                } catch (error) {
                    console.error('Error loading ride history:', error);
                }
            },
            
            async loadNotifications(uid) {
                try {
                    const snapshot = await database.ref(`notifications/${uid}`)
                        .orderByChild('timestamp')
                        .limitToLast(20)
                        .once('value');
                    
                    const notifications = snapshot.val();
                    if (notifications) {
                        AppState.notifications = Object.values(notifications).reverse();
                        const unreadCount = AppState.notifications.filter(n => !n.read).length;
                        AppState.unreadNotifications = unreadCount;
                        EnhancedUIUpdater.updateNotificationBadge(unreadCount);
                        EnhancedUIUpdater.updateNotifications(AppState.notifications);
                    }
                } catch (error) {
                    console.error('Error loading notifications:', error);
                }
            },
            
            async markNotificationAsRead(notificationId) {
                try {
                    await database.ref(`notifications/${AppState.currentUser.uid}/${notificationId}/read`).set(true);
                } catch (error) {
                    console.error('Error marking notification as read:', error);
                }
            },
            
            filterRides: function(rides, filter) {
                switch(filter) {
                    case 'completed':
                        return rides.filter(ride => ride.status === 'completed');
                    case 'cancelled':
                        return rides.filter(ride => ride.status === 'cancelled');
                    case 'scheduled':
                        return rides.filter(ride => ride.scheduled);
                    case 'emergency':
                        return rides.filter(ride => ride.emergency);
                    case 'delivery':
                        return rides.filter(ride => ride.serviceType === 'delivery');
                    case 'truck':
                        return rides.filter(ride => ride.serviceType === 'truck');
                    case 'broadcast':
                        return rides.filter(ride => ride.broadcast);
                    default:
                        return rides;
                }
            },
            
            updateUserStats: function(rides) {
                const completed = rides.filter(ride => ride.status === 'completed').length;
                const cancelled = rides.filter(ride => ride.status === 'cancelled').length;
                const totalSpent = rides
                    .filter(ride => ride.status === 'completed')
                    .reduce((sum, ride) => sum + (ride.fare || 0), 0);
                
                document.getElementById('completedRides').textContent = completed;
                document.getElementById('cancelledRides').textContent = cancelled;
                document.getElementById('totalSpent').textContent = `ZMW ${totalSpent.toFixed(2)}`;
            },
            
            listenToRideUpdates: function(rideId) {
                const rideRef = database.ref(`rides/${rideId}`);
                
                AppState.realtimeListeners.push(
                    rideRef.on('value', (snapshot) => {
                        const ride = snapshot.val();
                        if (ride) {
                            AppState.currentRide = { id: rideId, ...ride };
                            EnhancedUIUpdater.updateRideStatus(ride.status);
                            EnhancedUIUpdater.updateTimeline(ride.status);
                            
                            // Update driver info if assigned
                            if (ride.driverId && !AppState.selectedVehicle) {
                                this.loadDriverInfo(ride.driverId);
                            }
                            
                            // Show SOS button when driver accepted
                            if (ride.status === 'accepted' && AppState.sosConfig) {
                                document.getElementById('sosButton').style.display = 'flex';
                            }
                            
                            // Handle ride completion
                            if (ride.status === 'completed') {
                                this.handleRideCompletion(ride);
                            }
                            
                            // Handle ride cancellation
                            if (ride.status === 'cancelled') {
                                this.resetActiveRide();
                            }
                        }
                    })
                );
            },
            
            async loadDriverInfo(driverId) {
                try {
                    const snapshot = await database.ref(`users/${driverId}`).once('value');
                    const driver = snapshot.val();
                    if (driver) {
                        AppState.selectedVehicle = driver;
                        EnhancedUIUpdater.showDriverInfo(driver);
                        
                        // Load driver and vehicle images from storage
                        this.loadDriverImages(driverId);
                    }
                } catch (error) {
                    console.error('Error loading driver info:', error);
                }
            },
            
            async loadDriverImages(driverId) {
                try {
                    // Load driver photo
                    const driverPhotoRef = storage.ref(`driver_photos/${driverId}.jpg`);
                    driverPhotoRef.getDownloadURL().then(url => {
                        const driverImg = document.getElementById('driverImage');
                        const driverPlaceholder = document.getElementById('driverImagePlaceholder');
                        
                        driverImg.src = url;
                        driverImg.onload = function() {
                            driverImg.style.display = 'block';
                            driverPlaceholder.style.display = 'none';
                        };
                    }).catch(() => {
                        // Driver photo not found, use placeholder
                    });
                    
                    // Load vehicle photo
                    const vehiclePhotoRef = storage.ref(`vehicle_photos/${driverId}.jpg`);
                    vehiclePhotoRef.getDownloadURL().then(url => {
                        const vehicleImg = document.getElementById('vehicleImage');
                        const vehiclePlaceholder = document.getElementById('vehicleImagePlaceholder');
                        
                        vehicleImg.src = url;
                        vehicleImg.onload = function() {
                            vehicleImg.style.display = 'block';
                            vehiclePlaceholder.style.display = 'none';
                        };
                    }).catch(() => {
                        // Vehicle photo not found, use placeholder
                    });
                } catch (error) {
                    console.error('Error loading driver images:', error);
                }
            },
            
            listenToDriverLocation(driverId) {
                const locationRef = database.ref(`driverLocations/${driverId}`);
                
                AppState.realtimeListeners.push(
                    locationRef.on('value', (snapshot) => {
                        const location = snapshot.val();
                        if (location) {
                            AppState.driverLocation = {
                                lat: location.latitude,
                                lng: location.longitude
                            };
                            EnhancedUIUpdater.updateDriverMarker(AppState.driverLocation);
                            
                            // Update tracking info if we have pickup location
                            if (AppState.currentRide && AppState.currentRide.pickupLat) {
                                const pickupLocation = {
                                    lat: AppState.currentRide.pickupLat,
                                    lng: AppState.currentRide.pickupLng
                                };
                                EnhancedUIUpdater.updateDriverTracking(AppState.driverLocation, pickupLocation);
                            }
                        }
                    })
                );
            },
            
            listenToChatMessages(rideId) {
                const chatRef = database.ref(`chats/${rideId}/messages`).orderByChild('timestamp').limitToLast(50);
                
                AppState.realtimeListeners.push(
                    chatRef.on('child_added', (snapshot) => {
                        const message = snapshot.val();
                        if (message) {
                            EnhancedUIUpdater.showChatMessage(message, message.senderId === AppState.currentUser.uid);
                        }
                    })
                );
                
                // Listen for typing indicators
                const typingRef = database.ref(`chats/${rideId}/typing`);
                AppState.realtimeListeners.push(
                    typingRef.on('value', (snapshot) => {
                        const typingData = snapshot.val();
                        if (typingData && typingData.driverTyping) {
                            EnhancedUIUpdater.updateTypingIndicator(true);
                            
                            // Clear typing indicator after 3 seconds
                            clearTimeout(AppState.typingTimeout);
                            AppState.typingTimeout = setTimeout(() => {
                                EnhancedUIUpdater.updateTypingIndicator(false);
                            }, 3000);
                        } else {
                            EnhancedUIUpdater.updateTypingIndicator(false);
                        }
                    })
                );
            },
            
            async requestRide(rideData) {
                try {
                    EnhancedUIUpdater.showLoading('Requesting ride...');
                    
                    const rideId = database.ref().child('rides').push().key;
                    const ride = {
                        id: rideId,
                        ...rideData,
                        status: 'requested',
                        timestamp: Date.now(),
                        updatedAt: Date.now(),
                        passengerId: AppState.currentUser.uid,
                        passengerName: AppState.userData.name,
                        passengerPhone: AppState.userData.phone
                    };
                    
                    await database.ref(`rides/${rideId}`).set(ride);
                    
                    AppState.currentRide = ride;
                    EnhancedUIUpdater.showRideInfo(ride);
                    EnhancedUIUpdater.updateTimeline('requested');
                    
                    // Listen for updates
                    this.listenToRideUpdates(rideId);
                    
                    // Send notification to available drivers
                    await this.notifyAvailableDrivers(ride);
                    
                    EnhancedUIUpdater.hideLoading();
                    EnhancedUIUpdater.showToast('Ride requested successfully', 'success');
                    
                    // Start broadcast if it's a broadcast ride
                    if (rideData.broadcast && rideData.broadcastRecipients) {
                        await this.startBroadcast(rideId, rideData.broadcastRecipients);
                    }
                    
                    return rideId;
                } catch (error) {
                    console.error('Error requesting ride:', error);
                    EnhancedUIUpdater.hideLoading();
                    EnhancedUIUpdater.showToast('Error requesting ride', 'error');
                    throw error;
                }
            },
            
            async notifyAvailableDrivers(ride) {
                try {
                    // Find available drivers near pickup location
                    const driversSnapshot = await database.ref('drivers')
                        .orderByChild('status')
                        .equalTo('available')
                        .once('value');
                    
                    const drivers = driversSnapshot.val();
                    if (drivers) {
                        Object.keys(drivers).forEach(driverId => {
                            const driver = drivers[driverId];
                            
                            // Check if driver is within reasonable distance (optional)
                            // For now, notify all available drivers
                            
                            // Send notification to driver
                            this.sendNotification(driverId, 'New Ride Request', 
                                `New ride request from ${ride.passengerName} to ${ride.destinationDisplay || ride.destination}`, 
                                'ride',
                                { rideId: ride.id, action: 'view_ride' }
                            );
                        });
                    }
                } catch (error) {
                    console.error('Error notifying drivers:', error);
                }
            },
            
            async requestDelivery(deliveryData) {
                try {
                    EnhancedUIUpdater.showLoading('Requesting delivery...');
                    
                    const rideId = database.ref().child('rides').push().key;
                    const ride = {
                        id: rideId,
                        ...deliveryData,
                        serviceType: 'delivery',
                        status: 'requested',
                        timestamp: Date.now(),
                        updatedAt: Date.now(),
                        passengerId: AppState.currentUser.uid,
                        passengerName: AppState.userData.name,
                        passengerPhone: AppState.userData.phone
                    };
                    
                    await database.ref(`rides/${rideId}`).set(ride);
                    
                    AppState.currentRide = ride;
                    EnhancedUIUpdater.showRideInfo(ride);
                    EnhancedUIUpdater.updateTimeline('requested');
                    
                    // Listen for updates
                    this.listenToRideUpdates(rideId);
                    
                    EnhancedUIUpdater.hideLoading();
                    EnhancedUIUpdater.showToast('Delivery requested successfully', 'success');
                    return rideId;
                } catch (error) {
                    console.error('Error requesting delivery:', error);
                    EnhancedUIUpdater.hideLoading();
                    EnhancedUIUpdater.showToast('Error requesting delivery', 'error');
                    throw error;
                }
            },
            
            async requestTruck(truckData) {
                try {
                    EnhancedUIUpdater.showLoading('Requesting truck...');
                    
                    const rideId = database.ref().child('rides').push().key;
                    const ride = {
                        id: rideId,
                        ...truckData,
                        serviceType: 'truck',
                        status: 'requested',
                        timestamp: Date.now(),
                        updatedAt: Date.now(),
                        passengerId: AppState.currentUser.uid,
                        passengerName: AppState.userData.name,
                        passengerPhone: AppState.userData.phone
                    };
                    
                    await database.ref(`rides/${rideId}`).set(ride);
                    
                    AppState.currentRide = ride;
                    EnhancedUIUpdater.showRideInfo(ride);
                    EnhancedUIUpdater.updateTimeline('requested');
                    
                    // Listen for updates
                    this.listenToRideUpdates(rideId);
                    
                    EnhancedUIUpdater.hideLoading();
                    EnhancedUIUpdater.showToast('Truck requested successfully', 'success');
                    return rideId;
                } catch (error) {
                    console.error('Error requesting truck:', error);
                    EnhancedUIUpdater.hideLoading();
                    EnhancedUIUpdater.showToast('Error requesting truck', 'error');
                    throw error;
                }
            },
            
            async requestShopping(shoppingData) {
                try {
                    EnhancedUIUpdater.showLoading('Submitting shopping request...');
                    
                    const rideId = database.ref().child('rides').push().key;
                    const ride = {
                        id: rideId,
                        ...shoppingData,
                        serviceType: 'shopping',
                        status: 'requested',
                        timestamp: Date.now(),
                        updatedAt: Date.now(),
                        passengerId: AppState.currentUser.uid,
                        passengerName: AppState.userData.name,
                        passengerPhone: AppState.userData.phone
                    };
                    
                    await database.ref(`rides/${rideId}`).set(ride);
                    
                    AppState.currentRide = ride;
                    EnhancedUIUpdater.showRideInfo(ride);
                    EnhancedUIUpdater.updateTimeline('requested');
                    
                    // Listen for updates
                    this.listenToRideUpdates(rideId);
                    
                    EnhancedUIUpdater.hideLoading();
                    EnhancedUIUpdater.showToast('Shopping request submitted', 'success');
                    return rideId;
                } catch (error) {
                    console.error('Error requesting shopping:', error);
                    EnhancedUIUpdater.hideLoading();
                    EnhancedUIUpdater.showToast('Error requesting shopping', 'error');
                    throw error;
                }
            },
            
            async requestEmergencyRide(emergencyData) {
                try {
                    EnhancedUIUpdater.showLoading('Requesting emergency ride...');
                    
                    const rideId = database.ref().child('rides').push().key;
                    const ride = {
                        id: rideId,
                        ...emergencyData,
                        emergency: true,
                        status: 'requested',
                        timestamp: Date.now(),
                        updatedAt: Date.now(),
                        passengerId: AppState.currentUser.uid,
                        passengerName: AppState.userData.name,
                        passengerPhone: AppState.userData.phone,
                        priority: 'high'
                    };
                    
                    await database.ref(`rides/${rideId}`).set(ride);
                    
                    AppState.currentRide = ride;
                    AppState.emergencyMode = true;
                    EnhancedUIUpdater.showRideInfo(ride);
                    EnhancedUIUpdater.updateTimeline('requested');
                    
                    // Show emergency status
                    document.getElementById('emergencyStatus').style.display = 'flex';
                    
                    // Listen for updates
                    this.listenToRideUpdates(rideId);
                    
                    // Send emergency notifications
                    await this.sendEmergencyNotifications(ride);
                    
                    EnhancedUIUpdater.hideLoading();
                    EnhancedUIUpdater.showToast('Emergency ride requested', 'success');
                    return rideId;
                } catch (error) {
                    console.error('Error requesting emergency ride:', error);
                    EnhancedUIUpdater.hideLoading();
                    EnhancedUIUpdater.showToast('Error requesting emergency ride', 'error');
                    throw error;
                }
            },
            
            async sendEmergencyNotifications(ride) {
                try {
                    // Notify emergency services
                    const emergencyServicesRef = database.ref('emergencyServices').push();
                    await emergencyServicesRef.set({
                        rideId: ride.id,
                        emergencyType: ride.emergencyType,
                        location: {
                            lat: ride.pickupLat,
                            lng: ride.pickupLng
                        },
                        timestamp: Date.now(),
                        status: 'pending'
                    });
                    
                    // Send SOS alert to emergency contacts if configured
                    if (AppState.sosConfig) {
                        await this.sendSOSAlert(ride.id, {
                            emergencyContact1: AppState.sosConfig.contact1Phone,
                            emergencyContact1Name: AppState.sosConfig.contact1Name,
                            emergencyContact2: AppState.sosConfig.contact2Phone,
                            emergencyContact2Name: AppState.sosConfig.contact2Name,
                            message: AppState.sosConfig.message || 'Emergency ride requested',
                            location: {
                                lat: ride.pickupLat,
                                lng: ride.pickupLng
                            },
                            rideDetails: {
                                pickup: ride.pickupDisplay,
                                destination: ride.destinationDisplay,
                                emergencyType: ride.emergencyType
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error sending emergency notifications:', error);
                }
            },
            
            async cancelRide(rideId, reason) {
                try {
                    EnhancedUIUpdater.showLoading('Cancelling ride...');
                    
                    await database.ref(`rides/${rideId}`).update({
                        status: 'cancelled',
                        cancelReason: reason,
                        cancelledAt: Date.now(),
                        updatedAt: Date.now()
                    });
                    
                    // Notify driver if assigned
                    if (AppState.currentRide?.driverId) {
                        await this.sendNotification(
                            AppState.currentRide.driverId,
                            'Ride Cancelled',
                            `Ride cancelled by passenger. Reason: ${reason}`,
                            'warning'
                        );
                    }
                    
                                        EnhancedUIUpdater.hideLoading();
                    EnhancedUIUpdater.showToast('Ride cancelled successfully', 'success');
                    return true;
                } catch (error) {
                    console.error('Error cancelling ride:', error);
                    EnhancedUIUpdater.hideLoading();
                    EnhancedUIUpdater.showToast('Error cancelling ride', 'error');
                    return false;
                }
            },
            
            async scheduleRide(rideData) {
                try {
                    EnhancedUIUpdater.showLoading('Scheduling ride...');
                    
                    const rideId = database.ref().child('scheduledRides').push().key;
                    const ride = {
                        id: rideId,
                        ...rideData,
                        status: 'scheduled',
                        timestamp: Date.now(),
                        passengerId: AppState.currentUser.uid,
                        passengerName: AppState.userData.name
                    };
                    
                    await database.ref(`scheduledRides/${rideId}`).set(ride);
                    
                    AppState.scheduledRides.push(ride);
                    
                    EnhancedUIUpdater.hideLoading();
                    EnhancedUIUpdater.showToast('Ride scheduled successfully', 'success');
                    
                    // Set up notification for scheduled ride
                    const scheduleTime = new Date(rideData.scheduledTime);
                    const notificationTime = new Date(scheduleTime.getTime() - 30 * 60000); // 30 minutes before
                    
                    // Schedule notification
                    this.scheduleNotification(
                        rideId,
                        'Scheduled Ride Reminder',
                        `Your ride is scheduled for ${scheduleTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`,
                        notificationTime.getTime()
                    );
                    
                    return rideId;
                } catch (error) {
                    console.error('Error scheduling ride:', error);
                    EnhancedUIUpdater.hideLoading();
                    EnhancedUIUpdater.showToast('Error scheduling ride', 'error');
                    throw error;
                }
            },
            
            async scheduleNotification(notificationId, title, message, timestamp) {
                try {
                    await database.ref(`scheduledNotifications/${notificationId}`).set({
                        userId: AppState.currentUser.uid,
                        title: title,
                        message: message,
                        timestamp: timestamp,
                        status: 'pending'
                    });
                } catch (error) {
                    console.error('Error scheduling notification:', error);
                }
            },
            
            async sendChatMessage(rideId, message, isDriver = false) {
                try {
                    const messageId = database.ref().child(`chats/${rideId}/messages`).push().key;
                    const chatMessage = {
                        id: messageId,
                        text: message,
                        senderId: isDriver ? AppState.currentRide?.driverId : AppState.currentUser.uid,
                        senderName: isDriver ? AppState.selectedVehicle?.name : AppState.userData?.name,
                        timestamp: Date.now(),
                        isDriver: isDriver
                    };
                    
                    await database.ref(`chats/${rideId}/messages/${messageId}`).set(chatMessage);
                    
                    // Update typing indicator
                    await database.ref(`chats/${rideId}/typing/${isDriver ? 'driverTyping' : 'passengerTyping'}`).set(false);
                    
                    return messageId;
                } catch (error) {
                    console.error('Error sending chat message:', error);
                    throw error;
                }
            },
            
            async updateTypingStatus(rideId, isTyping, isDriver = false) {
                try {
                    await database.ref(`chats/${rideId}/typing/${isDriver ? 'driverTyping' : 'passengerTyping'}`).set(isTyping);
                } catch (error) {
                    console.error('Error updating typing status:', error);
                }
            },
            
            async saveSOSConfig(config) {
                try {
                    await database.ref(`sosConfig/${AppState.currentUser.uid}`).set(config);
                    AppState.sosConfig = config;
                    
                    // Update emergency contact display
                    document.getElementById('emergencyContact1Name').textContent = config.contact1Name || 'Contact 1';
                    document.getElementById('emergencyContact1Phone').textContent = config.contact1Phone || '';
                    document.getElementById('emergencyContact2Name').textContent = config.contact2Name || 'Contact 2';
                    document.getElementById('emergencyContact2Phone').textContent = config.contact2Phone || '';
                    
                    EnhancedUIUpdater.showToast('SOS configuration saved', 'success');
                    return true;
                } catch (error) {
                    console.error('Error saving SOS config:', error);
                    EnhancedUIUpdater.showToast('Error saving SOS config', 'error');
                    return false;
                }
            },
            
            async sendSOSAlert(rideId, sosData) {
                try {
                    const alertId = database.ref().child('sosAlerts').push().key;
                    await database.ref(`sosAlerts/${alertId}`).set({
                        ...sosData,
                        rideId: rideId,
                        timestamp: Date.now(),
                        status: 'active'
                    });
                    
                    // Also send as notification to emergency contacts
                    if (sosData.emergencyContact1) {
                        await this.sendSMSNotification(
                            sosData.emergencyContact1,
                            'SOS Alert',
                            `EMERGENCY: ${sosData.message}. Location: ${sosData.location?.lat},${sosData.location?.lng}. Ride Details: ${sosData.rideDetails?.pickup} to ${sosData.rideDetails?.destination}`
                        );
                    }
                    if (sosData.emergencyContact2) {
                        await this.sendSMSNotification(
                            sosData.emergencyContact2,
                            'SOS Alert',
                            `EMERGENCY: ${sosData.message}. Location: ${sosData.location?.lat},${sosData.location?.lng}. Ride Details: ${sosData.rideDetails?.pickup} to ${sosData.rideDetails?.destination}`
                        );
                    }
                    
                    EnhancedUIUpdater.showToast('SOS alert sent to emergency contacts', 'success');
                    return true;
                } catch (error) {
                    console.error('Error sending SOS alert:', error);
                    EnhancedUIUpdater.showToast('Error sending SOS alert', 'error');
                    return false;
                }
            },
            
            async sendSMSNotification(phoneNumber, title, message) {
                try {
                    // This would typically call an SMS gateway API
                    // For now, we'll log it and store in database
                    console.log(`SMS to ${phoneNumber}: ${title} - ${message}`);
                    
                    const smsId = database.ref().child('smsNotifications').push().key;
                    await database.ref(`smsNotifications/${smsId}`).set({
                        phoneNumber: phoneNumber,
                        title: title,
                        message: message,
                        timestamp: Date.now(),
                        status: 'sent'
                    });
                    
                    return true;
                } catch (error) {
                    console.error('Error sending SMS:', error);
                    return false;
                }
            },
            
            async sendNotification(userId, title, message, type = 'info', data = null) {
                try {
                    const notificationId = database.ref().child(`notifications/${userId}`).push().key;
                    const notification = {
                        id: notificationId,
                        title: title,
                        message: message,
                        type: type,
                        read: false,
                        timestamp: Date.now(),
                        data: data
                    };
                    
                    await database.ref(`notifications/${userId}/${notificationId}`).set(notification);
                    return true;
                } catch (error) {
                    console.error('Error sending notification:', error);
                    return false;
                }
            },
            
            async transferMoney(recipientCode, amount, message = '') {
                try {
                    EnhancedUIUpdater.showLoading('Processing transfer...');
                    
                    // Find recipient by referral code
                    const usersSnapshot = await database.ref('users').once('value');
                    const users = usersSnapshot.val();
                    let recipientId = null;
                    let recipientName = '';
                    
                    for (const [userId, userData] of Object.entries(users)) {
                        if (userData.referralCode === recipientCode) {
                            recipientId = userId;
                            recipientName = userData.name;
                            break;
                        }
                    }
                    
                    if (!recipientId) {
                        throw new Error('Recipient not found. Please check the referral code.');
                    }
                    
                    if (recipientId === AppState.currentUser.uid) {
                        throw new Error('Cannot transfer money to yourself.');
                    }
                    
                    // Check sender balance
                    if (AppState.walletBalance < amount) {
                        throw new Error('Insufficient balance');
                    }
                    
                    // Perform transfer
                    const senderNewBalance = AppState.walletBalance - amount;
                    const recipientSnapshot = await database.ref(`users/${recipientId}/walletBalance`).once('value');
                    const recipientBalance = recipientSnapshot.val() || 0;
                    const recipientNewBalance = recipientBalance + amount;
                    
                    // Update balances in a transaction
                    await database.ref().update({
                        [`users/${AppState.currentUser.uid}/walletBalance`]: senderNewBalance,
                        [`users/${recipientId}/walletBalance`]: recipientNewBalance
                    });
                    
                    // Record transaction
                    const transactionId = database.ref().child('transactions').push().key;
                    const transaction = {
                        id: transactionId,
                        senderId: AppState.currentUser.uid,
                        senderName: AppState.userData.name,
                        recipientId: recipientId,
                        recipientName: recipientName,
                        amount: amount,
                        message: message,
                        timestamp: Date.now(),
                        type: 'transfer',
                        status: 'completed'
                    };
                    
                    await database.ref(`transactions/${transactionId}`).set(transaction);
                    
                    // Update local balance
                    EnhancedUIUpdater.updateWalletBalance(senderNewBalance);
                    
                    // Send notification to recipient
                    await this.sendNotification(
                        recipientId,
                        'Money Received',
                        `You received ZMW ${amount.toFixed(2)} from ${AppState.userData.name}`,
                        'success',
                        { transactionId: transactionId, action: 'view_payment' }
                    );
                    
                    EnhancedUIUpdater.hideLoading();
                    EnhancedUIUpdater.showToast(`ZMW ${amount.toFixed(2)} sent to ${recipientName}`, 'success');
                    return true;
                } catch (error) {
                    console.error('Error transferring money:', error);
                    EnhancedUIUpdater.hideLoading();
                    EnhancedUIUpdater.showToast(error.message, 'error');
                    return false;
                }
            },
            
            async loadTransactions(userId) {
                try {
                    EnhancedUIUpdater.showLoading('Loading transactions...');
                    
                    const snapshot = await database.ref('transactions')
                        .orderByChild('senderId')
                        .equalTo(userId)
                        .once('value');
                    
                    const sentTransactions = snapshot.val() || {};
                    
                    const receivedSnapshot = await database.ref('transactions')
                        .orderByChild('recipientId')
                        .equalTo(userId)
                        .once('value');
                    
                    const receivedTransactions = receivedSnapshot.val() || {};
                    
                    // Combine and sort transactions
                    const allTransactions = [
                        ...Object.values(sentTransactions),
                        ...Object.values(receivedTransactions)
                    ].sort((a, b) => b.timestamp - a.timestamp);
                    
                    EnhancedUIUpdater.hideLoading();
                    return allTransactions;
                } catch (error) {
                    console.error('Error loading transactions:', error);
                    EnhancedUIUpdater.hideLoading();
                    return [];
                }
            },
            
            async loadRideDetails(rideId) {
                try {
                    const snapshot = await database.ref(`rides/${rideId}`).once('value');
                    const ride = snapshot.val();
                    if (ride) {
                        return { id: rideId, ...ride };
                    }
                    return null;
                } catch (error) {
                    console.error('Error loading ride details:', error);
                    return null;
                }
            },
            
            handleRideCompletion: function(ride) {
                // Hide ride status bar
                document.getElementById('rideStatusBar').classList.remove('active');
                
                // Hide SOS button
                document.getElementById('sosButton').style.display = 'none';
                
                // Hide emergency status
                document.getElementById('emergencyStatus').style.display = 'none';
                
                // Update timeline to completed
                EnhancedUIUpdater.updateTimeline('completed');
                
                // Add receipt button
                const actionButtons = document.querySelector('#rideInfoPanel .action-buttons');
                const existingReceiptBtn = document.querySelector('#receiptBtn');
                
                if (!existingReceiptBtn) {
                    const receiptBtn = document.createElement('button');
                    receiptBtn.id = 'receiptBtn';
                    receiptBtn.className = 'btn btn-primary';
                    receiptBtn.innerHTML = '<i class="fas fa-receipt"></i> View Receipt';
                    receiptBtn.addEventListener('click', () => {
                        this.generateReceipt(ride);
                    });
                    
                    actionButtons.appendChild(receiptBtn);
                }
                
                // Update wallet balance if paid with wallet
                if (ride.paymentMethod === 'wallet') {
                    const newBalance = AppState.walletBalance - ride.fare;
                    EnhancedUIUpdater.updateWalletBalance(newBalance);
                }
                
                // Handle referral reward if applicable
                if (ride.referredBy) {
                    this.handleReferralReward(ride);
                }
                
                // Send completion notification
                this.sendNotification(
                    AppState.currentUser.uid,
                    'Ride Completed',
                    `Your ride to ${ride.destinationDisplay || ride.destination} has been completed. Fare: ZMW ${ride.fare?.toFixed(2)}`,
                    'success',
                    { rideId: ride.id, action: 'view_ride' }
                );
                
                // Reset active ride after delay
                setTimeout(() => {
                    this.resetActiveRide();
                }, 5000);
            },
            
            async handleReferralReward(ride) {
                try {
                    // Find referrer by referral code
                    const usersSnapshot = await database.ref('users').once('value');
                    const users = usersSnapshot.val();
                    let referrerId = null;
                    
                    for (const [userId, userData] of Object.entries(users)) {
                        if (userData.referralCode === ride.referredBy) {
                            referrerId = userId;
                            break;
                        }
                    }
                    
                    if (referrerId) {
                        // Add ZMW 25 reward to referrer
                        const referrerSnapshot = await database.ref(`users/${referrerId}/walletBalance`).once('value');
                        const referrerBalance = referrerSnapshot.val() || 0;
                        const newReferrerBalance = referrerBalance + 25;
                        
                        await database.ref(`users/${referrerId}/walletBalance`).set(newReferrerBalance);
                        
                        // Record transaction
                        const transactionId = database.ref().child('transactions').push().key;
                        const transaction = {
                            id: transactionId,
                            senderId: 'system',
                            senderName: 'Jubel System',
                            recipientId: referrerId,
                            recipientName: users[referrerId].name,
                            amount: 25,
                            message: `Referral reward from ${AppState.userData.name}`,
                            timestamp: Date.now(),
                            type: 'referral',
                            status: 'completed'
                        };
                        
                        await database.ref(`transactions/${transactionId}`).set(transaction);
                        
                        // Send notification to referrer
                        await this.sendNotification(
                            referrerId,
                            'Referral Reward',
                            `You earned ZMW 25.00 because ${AppState.userData.name} used your referral code`,
                            'success',
                            { transactionId: transactionId, action: 'view_payment' }
                        );
                    }
                } catch (error) {
                    console.error('Error handling referral reward:', error);
                }
            },
            
            generateReceipt: function(ride) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Add receipt content
                doc.setFontSize(18);
                doc.setTextColor(255, 107, 53);
                doc.text('JUBEL RIDE RECEIPT', 105, 20, { align: 'center' });
                
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.text(`Receipt No: ${ride.id.substring(0, 8)}`, 20, 40);
                doc.text(`Date: ${new Date(ride.timestamp).toLocaleString()}`, 20, 45);
                
                // Add ride details
                doc.text(`Passenger: ${AppState.userData.name}`, 20, 55);
                doc.text(`Driver: ${ride.driverName || 'Not assigned'}`, 20, 60);
                doc.text(`Pickup: ${ride.pickupDisplay || ride.pickup}`, 20, 65);
                doc.text(`Destination: ${ride.destinationDisplay || ride.destination}`, 20, 70);
                doc.text(`Distance: ${ride.distance?.toFixed(1) || '0'} km`, 20, 75);
                
                if (ride.serviceType) {
                    doc.text(`Service Type: ${ride.serviceType.charAt(0).toUpperCase() + ride.serviceType.slice(1)}`, 20, 80);
                } else {
                    doc.text(`Ride Type: ${ride.rideType?.charAt(0).toUpperCase() + ride.rideType?.slice(1)}`, 20, 80);
                }
                
                // Add fare breakdown
                doc.text('Fare Breakdown:', 20, 90);
                
                let yPos = 95;
                if (ride.serviceType === 'truck') {
                    const config = AppState.truckTypes[ride.truckType] || AppState.truckTypes.light;
                    doc.text(`Base Fare: ZMW ${config.base.toFixed(2)}`, 30, yPos);
                    yPos += 5;
                    doc.text(`Distance Fare: ZMW ${((ride.distance || 0) * config.perKm).toFixed(2)}`, 30, yPos);
                } else if (ride.serviceType === 'delivery') {
                    const config = AppState.deliveryTypes[ride.deliveryType] || AppState.deliveryTypes.standard;
                    doc.text(`Base Fare: ZMW ${config.base.toFixed(2)}`, 30, yPos);
                    yPos += 5;
                    doc.text(`Distance Fare: ZMW ${((ride.distance || 0) * config.perKm).toFixed(2)}`, 30, yPos);
                } else {
                    doc.text(`Base Fare: ZMW ${(AppState.rideTypes[ride.rideType]?.base || 20).toFixed(2)}`, 30, yPos);
                    yPos += 5;
                    doc.text(`Distance Fare: ZMW ${((ride.distance || 0) * (AppState.rideTypes[ride.rideType]?.perKm || 3)).toFixed(2)}`, 30, yPos);
                }
                
                yPos += 5;
                doc.text(`Total: ZMW ${ride.fare?.toFixed(2) || '0.00'}`, 30, yPos);
                
                // Add payment method
                yPos += 10;
                doc.text(`Payment Method: ${ride.paymentMethod?.charAt(0).toUpperCase() + ride.paymentMethod?.slice(1)}`, 20, yPos);
                
                // Add QR code for verification
                doc.text('Scan for verification:', 20, yPos + 10);
                
                // Save PDF
                doc.save(`Jubel_Receipt_${ride.id.substring(0, 8)}.pdf`);
                EnhancedUIUpdater.showToast('Receipt downloaded', 'success');
            },
            
            resetActiveRide: function() {
                // Hide ride info panel
                document.getElementById('rideInfoPanel').classList.remove('active');
                
                // Show active service form
                switchService(AppState.activeService);
                
                // Hide fare display
                document.getElementById('fareDisplay').classList.remove('active');
                
                // Hide ride type selection
                document.getElementById('rideTypeSelection').classList.remove('active');
                
                // Hide price calculator
                document.getElementById('priceCalculator').style.display = 'none';
                
                // Hide emergency status
                document.getElementById('emergencyStatus').style.display = 'none';
                
                // Hide SOS button
                document.getElementById('sosButton').style.display = 'none';
                
                // Hide ride status bar
                document.getElementById('rideStatusBar').classList.remove('active');
                
                // Hide emergency contact display
                document.getElementById('emergencyContactDisplay').style.display = 'none';
                
                // Hide broadcast feature
                document.getElementById('broadcastFeature').style.display = 'none';
                
                // Clear current ride
                AppState.currentRide = null;
                AppState.emergencyMode = false;
                AppState.selectedVehicle = null;
                AppState.driverLocation = null;
                
                // Remove driver marker
                if (driverMarker) {
                    map.removeLayer(driverMarker);
                    driverMarker = null;
                }
                
                // Remove route
                if (routeLayer) {
                    map.removeLayer(routeLayer);
                    routeLayer = null;
                }
                
                // Clear destination input
                document.getElementById('destinationLocation').value = '';
                
                // Remove destination marker
                if (destinationMarker) {
                    map.removeLayer(destinationMarker);
                    destinationMarker = null;
                }
                
                // Clear emergency station markers
                emergencyStationMarkers.forEach(marker => map.removeLayer(marker));
                emergencyStationMarkers = [];
                
                // Clear emergency markers
                emergencyMarkers.forEach(marker => map.removeLayer(marker));
                emergencyMarkers = [];
                
                // Clear chat messages
                document.getElementById('chatMessages').innerHTML = '';
                
                // Reset typing indicator
                EnhancedUIUpdater.updateTypingIndicator(false);
                
                EnhancedUIUpdater.showToast('Ride completed', 'success');
            },
            
            async startBroadcast(rideId, recipients) {
                try {
                    const broadcastId = database.ref().child('broadcasts').push().key;
                    const broadcast = {
                        id: broadcastId,
                        rideId: rideId,
                        hostId: AppState.currentUser.uid,
                        hostName: AppState.userData.name,
                        recipients: recipients,
                        status: 'active',
                        timestamp: Date.now()
                    };
                    
                    await database.ref(`broadcasts/${broadcastId}`).set(broadcast);
                    
                    AppState.activeBroadcast = broadcast;
                    EnhancedUIUpdater.updateBroadcastStatus(true);
                    EnhancedUIUpdater.updateBroadcastRecipients(recipients);
                    
                    // Send notifications to recipients
                    recipients.forEach(async (recipient) => {
                        // Find user by phone number
                        const usersSnapshot = await database.ref('users').once('value');
                        const users = usersSnapshot.val();
                        
                        let recipientUserId = null;
                        for (const [userId, userData] of Object.entries(users)) {
                            if (userData.phone === recipient.phone) {
                                recipientUserId = userId;
                                break;
                            }
                        }
                        
                        if (recipientUserId) {
                            await this.sendNotification(
                                recipientUserId,
                                'Ride Broadcast Invitation',
                                `${AppState.userData.name} has invited you to join their ride`,
                                'broadcast',
                                { 
                                    broadcastId: broadcastId,
                                    rideId: rideId,
                                    action: 'accept_broadcast'
                                }
                            );
                        }
                    });
                    
                    EnhancedUIUpdater.showToast('Broadcast started', 'success');
                    return broadcastId;
                } catch (error) {
                    console.error('Error starting broadcast:', error);
                    EnhancedUIUpdater.showToast('Error starting broadcast', 'error');
                    throw error;
                }
            },
            
            async acceptBroadcastInvitation(broadcastId) {
                try {
                    const snapshot = await database.ref(`broadcasts/${broadcastId}`).once('value');
                    const broadcast = snapshot.val();
                    
                    if (broadcast && broadcast.status === 'active') {
                        // Update recipient status
                        const updatedRecipients = broadcast.recipients.map(recipient => {
                            if (recipient.phone === AppState.userData.phone) {
                                return { ...recipient, status: 'joined' };
                            }
                            return recipient;
                        });
                        
                        await database.ref(`broadcasts/${broadcastId}/recipients`).set(updatedRecipients);
                        
                        // Load the ride
                        const ride = await this.loadRideDetails(broadcast.rideId);
                        if (ride) {
                            AppState.currentRide = ride;
                            EnhancedUIUpdater.showRideInfo(ride);
                            
                            // Notify host
                            await this.sendNotification(
                                broadcast.hostId,
                                'Broadcast Ride Joined',
                                `${AppState.userData.name} has joined your broadcast ride`,
                                'info'
                            );
                            
                            EnhancedUIUpdater.showToast('You have joined the broadcast ride', 'success');
                        }
                    }
                } catch (error) {
                    console.error('Error accepting broadcast invitation:', error);
                    EnhancedUIUpdater.showToast('Error joining broadcast ride', 'error');
                }
            },
            
            async updateProfile(profileData) {
                try {
                    EnhancedUIUpdater.showLoading('Updating profile...');
                    
                    await database.ref(`users/${AppState.currentUser.uid}`).update({
                        name: profileData.name,
                        phone: profileData.phone,
                        homeAddress: profileData.homeAddress,
                        workAddress: profileData.workAddress,
                        updatedAt: Date.now()
                    });
                    
                    // Update local state
                    AppState.userData = {
                        ...AppState.userData,
                        ...profileData
                    };
                    
                    EnhancedUIUpdater.updateUserInfo(AppState.userData);
                    
                    EnhancedUIUpdater.hideLoading();
                    EnhancedUIUpdater.showToast('Profile updated successfully', 'success');
                    return true;
                } catch (error) {
                    console.error('Error updating profile:', error);
                    EnhancedUIUpdater.hideLoading();
                    EnhancedUIUpdater.showToast('Error updating profile', 'error');
                    return false;
                }
            },
            
            async depositMoney(amount) {
                try {
                    EnhancedUIUpdater.showLoading('Processing deposit...');
                    
                    const newBalance = AppState.walletBalance + amount;
                    
                    await database.ref(`users/${AppState.currentUser.uid}/walletBalance`).set(newBalance);
                    
                    // Record transaction
                    const transactionId = database.ref().child('transactions').push().key;
                    const transaction = {
                        id: transactionId,
                        senderId: 'system',
                        senderName: 'Deposit',
                        recipientId: AppState.currentUser.uid,
                        recipientName: AppState.userData.name,
                        amount: amount,
                        message: 'Wallet deposit',
                        timestamp: Date.now(),
                        type: 'deposit',
                        status: 'completed'
                    };
                    
                    await database.ref(`transactions/${transactionId}`).set(transaction);
                    
                    // Update local balance
                    EnhancedUIUpdater.updateWalletBalance(newBalance);
                    
                    EnhancedUIUpdater.hideLoading();
                    EnhancedUIUpdater.showToast(`ZMW ${amount.toFixed(2)} deposited successfully`, 'success');
                    return true;
                } catch (error) {
                    console.error('Error depositing money:', error);
                    EnhancedUIUpdater.hideLoading();
                    EnhancedUIUpdater.showToast('Error processing deposit', 'error');
                    return false;
                }
            },
            
            async withdrawMoney(amount) {
                try {
                    EnhancedUIUpdater.showLoading('Processing withdrawal...');
                    
                    if (AppState.walletBalance < amount) {
                        throw new Error('Insufficient balance');
                    }
                    
                    const newBalance = AppState.walletBalance - amount;
                    
                    await database.ref(`users/${AppState.currentUser.uid}/walletBalance`).set(newBalance);
                    
                    // Record transaction
                    const transactionId = database.ref().child('transactions').push().key;
                    const transaction = {
                        id: transactionId,
                        senderId: AppState.currentUser.uid,
                        senderName: AppState.userData.name,
                        recipientId: 'system',
                        recipientName: 'Withdrawal',
                        amount: amount,
                        message: 'Wallet withdrawal',
                        timestamp: Date.now(),
                        type: 'withdrawal',
                        status: 'completed'
                    };
                    
                    await database.ref(`transactions/${transactionId}`).set(transaction);
                    
                    // Update local balance
                    EnhancedUIUpdater.updateWalletBalance(newBalance);
                    
                    EnhancedUIUpdater.hideLoading();
                    EnhancedUIUpdater.showToast(`ZMW ${amount.toFixed(2)} withdrawn successfully`, 'success');
                    return true;
                } catch (error) {
                    console.error('Error withdrawing money:', error);
                    EnhancedUIUpdater.hideLoading();
                    EnhancedUIUpdater.showToast(error.message, 'error');
                    return false;
                }
            },
            
            async loadEmergencyStations(city, type) {
                try {
                    EnhancedUIUpdater.showLoading('Loading emergency stations...');
                    
                    const stations = await EnhancedSearchEngine.searchEmergencyStations(type, city);
                    
                    EnhancedUIUpdater.hideLoading();
                    EnhancedUIUpdater.showEmergencyStations(stations);
                    
                    return stations;
                } catch (error) {
                    console.error('Error loading emergency stations:', error);
                    EnhancedUIUpdater.hideLoading();
                    EnhancedUIUpdater.showToast('Error loading emergency stations', 'error');
                    return [];
                }
            },
            
            syncUserData: async function() {
                if (AppState.isSyncing) return;
                
                try {
                    AppState.isSyncing = true;
                    EnhancedUIUpdater.showSyncIndicator(true);
                    
                    // Sync user data
                    if (AppState.currentUser) {
                        await this.loadUserData(AppState.currentUser.uid);
                    }
                    
                    // Sync current ride if exists
                    if (AppState.currentRide) {
                        const ride = await this.loadRideDetails(AppState.currentRide.id);
                        if (ride) {
                            AppState.currentRide = ride;
                            EnhancedUIUpdater.showRideInfo(ride);
                        }
                    }
                    
                    EnhancedUIUpdater.showToast('Data synced successfully', 'success');
                } catch (error) {
                    console.error('Error syncing data:', error);
                    EnhancedUIUpdater.showToast('Error syncing data', 'error');
                } finally {
                    AppState.isSyncing = false;
                    EnhancedUIUpdater.showSyncIndicator(false);
                }
            }
        };

        // ============================================
        // ENHANCED EMERGENCY SERVICE LOCATOR
        // ============================================
        const EnhancedEmergencyLocator = {
            async loadEmergencyStationsForCity(city) {
                try {
                    EnhancedUIUpdater.showLoading('Loading emergency services...');
                    
                    // Load all emergency station types for the city
                    const types = ['police', 'fire', 'medical'];
                    const promises = types.map(type => 
                        EnhancedSearchEngine.searchEmergencyStations(type, city)
                    );
                    
                    const results = await Promise.all(promises);
                    
                    // Update AppState
                    types.forEach((type, index) => {
                        AppState.emergencyStations[type] = results[index];
                    });
                    
                    EnhancedUIUpdater.hideLoading();
                    return AppState.emergencyStations;
                } catch (error) {
                    console.error('Error loading emergency stations:', error);
                    EnhancedUIUpdater.hideLoading();
                    return AppState.emergencyStations;
                }
            },
            
            showEmergencyStationsOnMap: function(type) {
                // Clear existing emergency markers
                emergencyMarkers.forEach(marker => map.removeLayer(marker));
                emergencyMarkers = [];
                
                // Add markers for all stations of this type
                const stations = AppState.emergencyStations[type];
                if (stations && stations.length > 0) {
                    stations.forEach(station => {
                        let iconClass = '';
                        switch(type) {
                            case 'police':
                                iconClass = 'shield-alt';
                                break;
                            case 'fire':
                                iconClass = 'fire-extinguisher';
                                break;
                            case 'medical':
                                iconClass = 'ambulance';
                                break;
                        }
                        
                        const marker = L.marker([station.lat, station.lng], {
                            icon: L.divIcon({
                                className: 'emergency-vehicle-marker',
                                html: `<i class="fas fa-${iconClass}"></i>`,
                                iconSize: [36, 36]
                            })
                        }).addTo(map).bindPopup(`
                            <strong>${station.name}</strong><br>
                            ${station.address}<br>
                            Distance: ${station.distance?.toFixed(1) || '0'} km
                        `);
                        
                        emergencyMarkers.push(marker);
                    });
                    
                    // Fit map to show all emergency stations
                    if (emergencyMarkers.length > 0) {
                        const group = new L.featureGroup(emergencyMarkers);
                        map.fitBounds(group.getBounds().pad(0.1));
                    }
                }
            },
            
            findNearestEmergencyStation: function(type, location) {
                const stations = AppState.emergencyStations[type];
                if (!stations || !location) return null;
                
                let nearest = null;
                let minDistance = Infinity;
                
                stations.forEach(station => {
                    const distance = EnhancedPriceCalculator.calculateDistance(
                        location.lat, location.lng,
                        station.lat, station.lng
                    );
                    
                    if (distance < minDistance) {
                        minDistance = distance;
                        nearest = { ...station, distance };
                    }
                });
                
                return nearest;
            },
            
            getEmergencyContactInfo: function(type) {
                const contacts = {
                    'police': {
                        name: 'Police Emergency',
                        phone: '991',
                        description: 'Police emergency services'
                    },
                    'fire': {
                        name: 'Fire Brigade',
                        phone: '992',
                        description: 'Fire and rescue services'
                    },
                    'medical': {
                        name: 'Medical Emergency',
                        phone: '993',
                        description: 'Ambulance and medical services'
                    }
                };
                
                return contacts[type] || contacts.police;
            }
        };

        // ============================================
        // CITY DETECTION AND LOCATION SERVICES
        // ============================================
        const CityDetector = {
            async detectCityFromLocation(lat, lng) {
                try {
                    const response = await fetch(
                        `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=10&addressdetails=1`
                    );
                    
                    if (!response.ok) {
                        throw new Error('Reverse geocoding failed');
                    }
                    
                    const data = await response.json();
                    
                    if (data && data.address) {
                        const city = data.address.city || data.address.town || data.address.village;
                        const state = data.address.state;
                        
                        if (city) {
                            AppState.currentCity = city;
                            AppState.detectedCity = city;
                            
                            // Update UI
                            EnhancedUIUpdater.updateCityDisplay(city);
                            
                            // Load emergency stations for this city
                            EnhancedEmergencyLocator.loadEmergencyStationsForCity(city);
                            
                            // Clear search cache for new city
                            EnhancedSearchEngine.clearCache();
                            
                            return city;
                        }
                    }
                    
                    return null;
                } catch (error) {
                    console.error('City detection error:', error);
                    AppState.cityDetectionAttempts++;
                    
                    if (AppState.cityDetectionAttempts < AppState.maxCityDetectionAttempts) {
                        // Retry after delay
                        setTimeout(() => {
                            this.detectCityFromLocation(lat, lng);
                        }, 2000);
                    } else {
                        // Use default city
                        AppState.currentCity = 'Lusaka';
                        AppState.detectedCity = 'Lusaka';
                        EnhancedUIUpdater.updateCityDisplay('Lusaka (Default)');
                    }
                    
                    return null;
                }
            },
            
            async getDetailedAddress(lat, lng) {
                try {
                    const response = await fetch(
                        `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`
                    );
                    
                    if (!response.ok) {
                        throw new Error('Detailed reverse geocoding failed');
                    }
                    
                    const data = await response.json();
                    
                    if (data && data.address) {
                        const address = data.address;
                        const parts = [];
                        
                        if (address.house_number || address.housenumber) {
                            parts.push(address.house_number || address.housenumber);
                        }
                        
                        if (address.road) {
                            parts.push(address.road);
                        }
                        
                        if (address.suburb || address.neighbourhood) {
                            parts.push(address.suburb || address.neighbourhood);
                        }
                        
                        if (address.city || address.town) {
                            parts.push(address.city || address.town);
                        }
                        
                        const fullAddress = parts.join(', ') || data.display_name;
                        
                        return {
                            address: fullAddress,
                            houseNumber: address.house_number || address.housenumber,
                            road: address.road,
                            suburb: address.suburb || address.neighbourhood,
                            city: address.city || address.town,
                            state: address.state,
                            fullDisplay: data.display_name
                        };
                    }
                    
                    return {
                        address: `${lat.toFixed(6)}, ${lng.toFixed(6)}`,
                        fullDisplay: `${lat.toFixed(6)}, ${lng.toFixed(6)}`
                    };
                } catch (error) {
                    console.error('Detailed address error:', error);
                    return {
                        address: `${lat.toFixed(6)}, ${lng.toFixed(6)}`,
                        fullDisplay: `${lat.toFixed(6)}, ${lng.toFixed(6)}`
                    };
                }
            },
            
            validateCity: function(cityName) {
                const validCities = [
                    'Lusaka', 'Ndola', 'Kitwe', 'Kabwe', 'Livingstone', 'Chipata',
                    'Chingola', 'Mufulira', 'Luanshya', 'Kasama', 'Solwezi', 'Mazabuka'
                ];
                
                return validCities.some(validCity => 
                    cityName.toLowerCase().includes(validCity.toLowerCase())
                );
            }
        };

        // ============================================
        // BROADCAST RIDE MANAGER
        // ============================================
        const BroadcastManager = {
            async createBroadcast(rideData, recipients) {
                try {
                    EnhancedUIUpdater.showLoading('Creating broadcast...');
                    
                    // First create the ride
                    const rideId = await EnhancedFirebaseManager.requestRide({
                        ...rideData,
                        broadcast: true,
                        broadcastRecipients: recipients
                    });
                    
                    // Then create the broadcast
                    const broadcastId = await EnhancedFirebaseManager.startBroadcast(rideId, recipients);
                    
                    EnhancedUIUpdater.hideLoading();
                    EnhancedUIUpdater.showToast('Broadcast ride created successfully', 'success');
                    
                    return { rideId, broadcastId };
                } catch (error) {
                    console.error('Error creating broadcast:', error);
                    EnhancedUIUpdater.hideLoading();
                    EnhancedUIUpdater.showToast('Error creating broadcast', 'error');
                    throw error;
                }
            },
            
            async addRecipientToBroadcast(broadcastId, recipientPhone, recipientName = '') {
                try {
                    const snapshot = await database.ref(`broadcasts/${broadcastId}`).once('value');
                    const broadcast = snapshot.val();
                    
                    if (!broadcast) {
                        throw new Error('Broadcast not found');
                    }
                    
                    // Check if recipient already exists
                    const existingRecipient = broadcast.recipients.find(r => r.phone === recipientPhone);
                    if (existingRecipient) {
                        throw new Error('Recipient already added');
                    }
                    
                    // Add new recipient
                    const updatedRecipients = [
                        ...broadcast.recipients,
                        {
                            phone: recipientPhone,
                            name: recipientName,
                            status: 'pending'
                        }
                    ];
                    
                    await database.ref(`broadcasts/${broadcastId}/recipients`).set(updatedRecipients);
                    
                    // Send notification to recipient
                    const recipient = await this.findUserByPhone(recipientPhone);
                    if (recipient) {
                        await EnhancedFirebaseManager.sendNotification(
                            recipient.id,
                            'Ride Broadcast Invitation',
                            `${broadcast.hostName} has invited you to join their ride`,
                            'broadcast',
                            { 
                                broadcastId: broadcastId,
                                rideId: broadcast.rideId,
                                action: 'accept_broadcast'
                            }
                        );
                    }
                    
                    EnhancedUIUpdater.showToast('Recipient added to broadcast', 'success');
                    return true;
                } catch (error) {
                    console.error('Error adding recipient:', error);
                    EnhancedUIUpdater.showToast(error.message, 'error');
                    return false;
                }
            },
            
            async findUserByPhone(phoneNumber) {
                try {
                    const usersSnapshot = await database.ref('users').once('value');
                    const users = usersSnapshot.val();
                    
                    for (const [userId, userData] of Object.entries(users)) {
                        if (userData.phone === phoneNumber) {
                            return { id: userId, ...userData };
                        }
                    }
                    
                    return null;
                } catch (error) {
                    console.error('Error finding user by phone:', error);
                    return null;
                }
            },
            
            async joinBroadcast(broadcastId) {
                try {
                    EnhancedUIUpdater.showLoading('Joining broadcast...');
                    
                    await EnhancedFirebaseManager.acceptBroadcastInvitation(broadcastId);
                    
                    EnhancedUIUpdater.hideLoading();
                    return true;
                } catch (error) {
                    console.error('Error joining broadcast:', error);
                    EnhancedUIUpdater.hideLoading();
                    return false;
                }
            },
            
            async leaveBroadcast(broadcastId) {
                try {
                    const snapshot = await database.ref(`broadcasts/${broadcastId}`).once('value');
                    const broadcast = snapshot.val();
                    
                    if (!broadcast) return;
                    
                    // Update recipient status
                    const updatedRecipients = broadcast.recipients.map(recipient => {
                        if (recipient.phone === AppState.userData.phone) {
                            return { ...recipient, status: 'left' };
                        }
                        return recipient;
                    });
                    
                    await database.ref(`broadcasts/${broadcastId}/recipients`).set(updatedRecipients);
                    
                    // Notify host
                    await EnhancedFirebaseManager.sendNotification(
                        broadcast.hostId,
                        'Broadcast Ride Left',
                        `${AppState.userData.name} has left your broadcast ride`,
                        'info'
                    );
                    
                    EnhancedUIUpdater.showToast('You have left the broadcast ride', 'success');
                    return true;
                } catch (error) {
                    console.error('Error leaving broadcast:', error);
                    EnhancedUIUpdater.showToast('Error leaving broadcast', 'error');
                    return false;
                }
            },
            
            async endBroadcast(broadcastId) {
                try {
                    await database.ref(`broadcasts/${broadcastId}/status`).set('ended');
                    
                    AppState.activeBroadcast = null;
                    EnhancedUIUpdater.updateBroadcastStatus(false);
                    
                    EnhancedUIUpdater.showToast('Broadcast ended', 'success');
                    return true;
                } catch (error) {
                    console.error('Error ending broadcast:', error);
                    EnhancedUIUpdater.showToast('Error ending broadcast', 'error');
                    return false;
                }
            },
            
            updateBroadcastUI: function(broadcast) {
                if (!broadcast) return;
                
                // Update broadcast feature display
                document.getElementById('broadcastFeature').style.display = 'block';
                EnhancedUIUpdater.updateBroadcastStatus(broadcast.status === 'active');
                EnhancedUIUpdater.updateBroadcastRecipients(broadcast.recipients);
            }
        };

        // ============================================
        // ENHANCED NOTIFICATION MANAGER
        // ============================================
        const NotificationManager = {
            async checkForScheduledNotifications() {
                try {
                    const snapshot = await database.ref('scheduledNotifications')
                        .orderByChild('timestamp')
                        .startAt(Date.now() - 60000) // Check last minute
                        .endAt(Date.now() + 60000) // And next minute
                        .once('value');
                    
                    const notifications = snapshot.val();
                    if (notifications) {
                        Object.entries(notifications).forEach(([id, notification]) => {
                            if (notification.userId === AppState.currentUser?.uid && notification.status === 'pending') {
                                // Send notification
                                EnhancedFirebaseManager.sendNotification(
                                    notification.userId,
                                    notification.title,
                                    notification.message,
                                    'info'
                                );
                                
                                // Mark as sent
                                database.ref(`scheduledNotifications/${id}/status`).set('sent');
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error checking scheduled notifications:', error);
                }
            },
            
            requestNotificationPermission: async function() {
                if (!("Notification" in window)) {
                    console.log("This browser does not support desktop notification");
                    return false;
                }
                
                if (Notification.permission === "granted") {
                    return true;
                } else if (Notification.permission !== "denied") {
                    const permission = await Notification.requestPermission();
                    return permission === "granted";
                }
                
                return false;
            },
            
            showDesktopNotification: function(title, message) {
                if (Notification.permission === "granted") {
                    new Notification(title, {
                        body: message,
                        icon: 'jubel.png'
                    });
                }
            },
            
            schedulePeriodicChecks: function() {
                // Check for scheduled notifications every minute
                setInterval(() => {
                    this.checkForScheduledNotifications();
                }, 60000);
                
                // Check for ride updates every 30 seconds
                setInterval(() => {
                    if (AppState.currentRide) {
                        EnhancedFirebaseManager.syncUserData();
                    }
                }, 30000);
            }
        };

        // ============================================
        // INITIALIZATION
        // ============================================
        async function initializeApp() {
            try {
                EnhancedUIUpdater.showLoading('Initializing app...');
                
                // Initialize search engine
                EnhancedSearchEngine.init();
                
                // Check authentication
                const urlParams = new URLSearchParams(window.location.search);
                const email = urlParams.get('email');
                const uid = urlParams.get('uid');
                
                if (email && uid) {
                    AppState.currentUser = { uid, email };
                    await EnhancedFirebaseManager.loadUserData(uid);
                } else {
                    // Listen for auth state changes
                    auth.onAuthStateChanged(async (user) => {
                        if (user) {
                            AppState.currentUser = user;
                            await EnhancedFirebaseManager.loadUserData(user.uid);
                        } else {
                            window.location.href = 'signup.html';
                        }
                    });
                }
                
                // Initialize map
                initializeMap();
                
                // Set up event listeners
                setupEventListeners();
                
                // Get current location
                getCurrentLocation();
                
                // Set minimum date for schedule form
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('scheduleDate').min = today;
                
                // Initialize shopping items
                initializeShoppingItems();
                
                // Request notification permission
                await NotificationManager.requestNotificationPermission();
                
                // Start periodic checks
                NotificationManager.schedulePeriodicChecks();
                
                // Start sync interval
                AppState.syncInterval = setInterval(() => {
                    EnhancedFirebaseManager.syncUserData();
                }, 60000); // Sync every minute
                
                EnhancedUIUpdater.hideLoading();
                EnhancedUIUpdater.showToast('Jubel Passenger App Ready', 'success');
                
            } catch (error) {
                console.error('Error initializing app:', error);
                EnhancedUIUpdater.hideLoading();
                EnhancedUIUpdater.showToast('Error initializing app', 'error');
            }
        }
        
        function initializeMap() {
            // Default to Lusaka coordinates
            const defaultLat = -15.4167;
            const defaultLng = 28.2833;
            
            map = L.map('map').setView([defaultLat, defaultLng], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
            
            EnhancedUIUpdater.hideMapLoading();
        }
        
        function initializeShoppingItems() {
            const itemsContainer = document.getElementById('shoppingItems');
            const addItemBtn = document.getElementById('addItemBtn');
            
            // Add first item removal button
            const firstItem = itemsContainer.querySelector('.item-entry');
            if (firstItem) {
                const removeBtn = firstItem.querySelector('.remove-item');
                removeBtn.addEventListener('click', function() {
                    if (itemsContainer.children.length > 1) {
                        firstItem.remove();
                    }
                });
            }
            
            // Add new item
            addItemBtn.addEventListener('click', function() {
                const itemEntry = document.createElement('div');
                itemEntry.className = 'item-entry';
                itemEntry.innerHTML = `
                    <input type="text" class="item-input" placeholder="Item name">
                    <button class="remove-item" type="button">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                itemsContainer.appendChild(itemEntry);
                
                // Add event to remove button
                const removeBtn = itemEntry.querySelector('.remove-item');
                removeBtn.addEventListener('click', function() {
                    itemEntry.remove();
                });
            });
        }
        
        async function getCurrentLocation() {
            if (!navigator.geolocation) {
                EnhancedUIUpdater.showToast('Geolocation is not supported by your browser', 'warning');
                return;
            }
            
            EnhancedUIUpdater.showLoading('Getting your location...');
            
            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    });
                });
                
                const { latitude, longitude } = position.coords;
                AppState.userLocation = { lat: latitude, lng: longitude };
                
                // Center map on user location
                map.setView([latitude, longitude], 15);
                
                // Add current location marker
                currentLocationMarker = L.marker([latitude, longitude], {
                    icon: L.divIcon({
                        className: 'current-location-marker',
                        html: '<i class="fas fa-user"></i>',
                        iconSize: [18, 18]
                    })
                }).addTo(map).bindPopup('Your Location');
                
                // Get detailed address
                const detailedAddress = await CityDetector.getDetailedAddress(latitude, longitude);
                
                // Update pickup location inputs
                const addressInputs = [
                    'pickupLocation', 'deliveryPickup', 'shortDeliveryPickup', 
                    'truckPickup', 'schedulePickup', 'someonePickup',
                    'sharePickup', 'broadcastPickup'
                ];
                
                addressInputs.forEach(inputId => {
                    const input = document.getElementById(inputId);
                    if (input) {
                        input.value = detailedAddress.address;
                        input.dataset.lat = latitude;
                        input.dataset.lng = longitude;
                    }
                });
                
                // Update emergency user location display
                document.getElementById('emergencyUserLocation').textContent = detailedAddress.fullDisplay;
                
                AppState.pickup = {
                    lat: latitude,
                    lng: longitude,
                    address: detailedAddress.address,
                    name: 'Current Location',
                    fullDisplay: detailedAddress.fullDisplay
                };
                
                // Detect city based on location
                await CityDetector.detectCityFromLocation(latitude, longitude);
                
                EnhancedUIUpdater.hideLoading();
                EnhancedUIUpdater.showToast('Location detected successfully', 'success');
                
            } catch (error) {
                console.error('Geolocation error:', error);
                EnhancedUIUpdater.hideLoading();
                EnhancedUIUpdater.showToast('Unable to get your location. Using default location.', 'warning');
                
                // Use default location
                AppState.userLocation = { lat: -15.4167, lng: 28.2833 };
                map.setView([-15.4167, 28.2833], 13);
                
                // Set default city
                AppState.currentCity = 'Lusaka';
                AppState.detectedCity = 'Lusaka';
                EnhancedUIUpdater.updateCityDisplay('Lusaka (Default)');
            }
        }

        // ============================================
        // EVENT HANDLERS SETUP
        // ============================================
        function setupEventListeners() {
            // Navigation tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const screen = tab.dataset.screen;
                    switchScreen(screen);
                });
            });
            
            // Back buttons
            document.querySelectorAll('.back-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    switchScreen('home');
                });
            });
            
            // Panel handle
            document.getElementById('panelHandle').addEventListener('click', togglePanel);
            
            // Service tabs
            document.querySelectorAll('.service-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const service = tab.dataset.service;
                    switchService(service);
                });
            });
            
            // Ride type selection
            document.querySelectorAll('.ride-type-card').forEach(card => {
                card.addEventListener('click', () => {
                    // Remove selected class from all cards
                    document.querySelectorAll('.ride-type-card').forEach(c => {
                        c.classList.remove('selected');
                    });
                    
                    // Add selected class to clicked card
                    card.classList.add('selected');
                    
                    // Update selected ride type
                    AppState.selectedRideType = card.dataset.type;
                    
                    // Update prices
                    if (AppState.pickup && AppState.destination) {
                        EnhancedUIUpdater.calculateAndUpdatePrices();
                    }
                });
            });
            
            // Truck type selection
            document.querySelectorAll('.truck-type').forEach(truck => {
                truck.addEventListener('click', () => {
                    document.querySelectorAll('.truck-type').forEach(t => {
                        t.classList.remove('selected');
                    });
                    truck.classList.add('selected');
                });
            });
            
            // Delivery type selection
            document.getElementById('standardDelivery').addEventListener('click', () => {
                document.querySelectorAll('#deliveryForm .filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.getElementById('standardDelivery').classList.add('active');
                
                if (AppState.pickup && AppState.destination) {
                    EnhancedUIUpdater.calculateAndUpdatePrices();
                }
            });
            
            document.getElementById('expressDelivery').addEventListener('click', () => {
                document.querySelectorAll('#deliveryForm .filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.getElementById('expressDelivery').classList.add('active');
                
                if (AppState.pickup && AppState.destination) {
                    EnhancedUIUpdater.calculateAndUpdatePrices();
                }
            });
            
            document.getElementById('sameDayDelivery').addEventListener('click', () => {
                document.querySelectorAll('#deliveryForm .filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.getElementById('sameDayDelivery').classList.add('active');
                
                if (AppState.pickup && AppState.destination) {
                    EnhancedUIUpdater.calculateAndUpdatePrices();
                }
            });
            
            // Location input focus
            document.querySelectorAll('input[type="text"]').forEach(input => {
                if (input.id.includes('destination') || input.id.includes('Location') || 
                    input.id.includes('Pickup') || input.id === 'shopName') {
                    
                    input.addEventListener('focus', function() {
                        const parent = this.closest('.location-input');
                        if (parent) parent.classList.add('active');
                        
                        // Show search history for destination inputs
                        if (this.id.includes('destination') || this.id === 'shopName') {
                            EnhancedUIUpdater.showSearchHistory(this.id);
                        }
                    });
                    
                    input.addEventListener('blur', function() {
                        setTimeout(() => {
                            const parent = this.closest('.location-input');
                            if (parent) parent.classList.remove('active');
                        }, 200);
                    });
                }
            });
            
            // Enhanced Search input with debounce
            document.querySelectorAll('input[type="text"]').forEach(input => {
                if (input.id.includes('destination') || input.id.includes('Pickup') || 
                    input.id === 'shopName' || input.id.includes('Location')) {
                    
                    let searchTimer;
                    
                    input.addEventListener('input', async function(e) {
                        clearTimeout(searchTimer);
                        
                        const query = e.target.value.trim();
                        if (query.length < 2) {
                            const suggestions = document.getElementById(`${this.id}Suggestions`);
                            if (suggestions) suggestions.classList.remove('active');
                            return;
                        }
                        
                        // Store last search query
                        AppState.lastSearchQuery = query;
                        
                        // Show loading
                        const parent = this.closest('.location-input');
                        if (parent) parent.classList.add('searching');
                        
                        searchTimer = setTimeout(async () => {
                            try {
                                const results = await EnhancedSearchEngine.search(
                                    query, 
                                    'destination', 
                                    AppState.userLocation,
                                    AppState.currentCity
                                );
                                EnhancedUIUpdater.showSearchSuggestions(this.id, results);
                            } catch (error) {
                                console.error('Search error:', error);
                            } finally {
                                if (parent) parent.classList.remove('searching');
                            }
                        }, 300);
                    });
                }
            });
            
            // Map control buttons
            document.getElementById('locateMeBtn').addEventListener('click', () => {
                if (AppState.userLocation) {
                    map.setView([AppState.userLocation.lat, AppState.userLocation.lng], 15);
                    EnhancedUIUpdater.showToast('Centered on your location', 'info');
                } else {
                    getCurrentLocation();
                }
            });
            
            document.getElementById('zoomInBtn').addEventListener('click', () => {
                map.zoomIn();
            });
            
            document.getElementById('zoomOutBtn').addEventListener('click', () => {
                map.zoomOut();
            });
            
            document.getElementById('clearRouteBtn').addEventListener('click', () => {
                if (routeLayer) {
                    map.removeLayer(routeLayer);
                    routeLayer = null;
                }
                
                if (destinationMarker) {
                    map.removeLayer(destinationMarker);
                    destinationMarker = null;
                }
                
                document.getElementById('destinationLocation').value = '';
                AppState.destination = null;
                
                EnhancedUIUpdater.showToast('Route cleared', 'info');
            });
            
            // Request ride button
            document.getElementById('requestRideBtn').addEventListener('click', async () => {
                if (!AppState.pickup || !AppState.destination) {
                    EnhancedUIUpdater.showToast('Please select pickup and destination locations', 'warning');
                    return;
                }
                
                // Calculate distance
                const distance = EnhancedPriceCalculator.calculateDistance(
                    AppState.pickup.lat, AppState.pickup.lng,
                    AppState.destination.lat, AppState.destination.lng
                );
                
                if (distance < 0.5) {
                    EnhancedUIUpdater.showToast('Minimum ride distance is 0.5 km', 'warning');
                    return;
                }
                
                // Show payment modal with ride details
                document.getElementById('paymentAmount').textContent = `ZMW ${AppState.rideFare.toFixed(2)}`;
                showModal('payment');
            });
            
            // Request delivery button
            document.getElementById('requestDeliveryBtn').addEventListener('click', async () => {
                const pickupInput = document.getElementById('deliveryPickup');
                const destinationInput = document.getElementById('deliveryDestination');
                const parcelDesc = document.getElementById('parcelDescription');
                const receiverName = document.getElementById('receiverName');
                const receiverPhone = document.getElementById('receiverPhone');
                const parcelValue = document.getElementById('parcelValue');
                
                if (!pickupInput.value || !destinationInput.value || !parcelDesc.value || 
                    !receiverName.value || !receiverPhone.value) {
                    EnhancedUIUpdater.showToast('Please fill all required fields', 'warning');
                    return;
                }
                
                if (!AppState.pickup || !AppState.destination) {
                    EnhancedUIUpdater.showToast('Please select valid pickup and delivery locations', 'warning');
                    return;
                }
                
                const distance = EnhancedPriceCalculator.calculateDistance(
                    AppState.pickup.lat, AppState.pickup.lng,
                    AppState.destination.lat, AppState.destination.lng
                );
                
                // Get delivery type
                let deliveryType = 'standard';
                if (document.getElementById('expressDelivery').classList.contains('active')) {
                    deliveryType = 'express';
                } else if (document.getElementById('sameDayDelivery').classList.contains('active')) {
                    deliveryType = 'sameDay';
                }
                
                // Calculate fare
                const fare = EnhancedPriceCalculator.calculateDeliveryFare(
                    distance, 
                    deliveryType, 
                    parseFloat(parcelValue.value) || 0
                );
                
                // Show payment modal
                document.getElementById('paymentAmount').textContent = `ZMW ${fare.toFixed(2)}`;
                showModal('payment');
                
                // Store delivery data for after payment
                window.pendingDeliveryData = {
                    pickup: AppState.pickup.address,
                    pickupDisplay: AppState.pickup.fullDisplay || AppState.pickup.name,
                    destination: AppState.destination.address,
                    destinationDisplay: AppState.destination.fullAddress || AppState.destination.name,
                    pickupLat: AppState.pickup.lat,
                    pickupLng: AppState.pickup.lng,
                    destLat: AppState.destination.lat,
                    destLng: AppState.destination.lng,
                    parcelDescription: parcelDesc.value,
                    receiverName: receiverName.value,
                    receiverPhone: receiverPhone.value,
                    parcelValue: parseFloat(parcelValue.value) || 0,
                    deliveryType: deliveryType,
                    fare: fare,
                    distance: distance
                };
            });
            
            // Request truck button
            document.getElementById('requestTruckBtn').addEventListener('click', async () => {
                const pickupInput = document.getElementById('truckPickup');
                const destinationInput = document.getElementById('truckDestination');
                const itemDesc = document.getElementById('truckItemDescription');
                const estimatedWeight = document.getElementById('estimatedWeight');
                const needHelpers = document.getElementById('needHelpers').checked;
                
                if (!pickupInput.value || !destinationInput.value || !itemDesc.value || !estimatedWeight.value) {
                    EnhancedUIUpdater.showToast('Please fill all required fields', 'warning');
                    return;
                }
                
                if (!AppState.pickup || !AppState.destination) {
                    EnhancedUIUpdater.showToast('Please select valid pickup and destination locations', 'warning');
                    return;
                }
                
                const distance = EnhancedPriceCalculator.calculateDistance(
                    AppState.pickup.lat, AppState.pickup.lng,
                    AppState.destination.lat, AppState.destination.lng
                );
                
                // Get selected truck type
                const selectedTruck = document.querySelector('.truck-type.selected');
                const truckType = selectedTruck ? selectedTruck.dataset.type : 'light';
                
                // Calculate fare
                const fare = EnhancedPriceCalculator.calculateTruckFare(distance, truckType, needHelpers);
                
                // Show payment modal
                document.getElementById('paymentAmount').textContent = `ZMW ${fare.toFixed(2)}`;
                showModal('payment');
                
                // Store truck data for after payment
                window.pendingTruckData = {
                    pickup: AppState.pickup.address,
                    pickupDisplay: AppState.pickup.fullDisplay || AppState.pickup.name,
                    destination: AppState.destination.address,
                    destinationDisplay: AppState.destination.fullAddress || AppState.destination.name,
                    pickupLat: AppState.pickup.lat,
                    pickupLng: AppState.pickup.lng,
                    destLat: AppState.destination.lat,
                    destLng: AppState.destination.lng,
                    truckType: truckType,
                    itemDescription: itemDesc.value,
                    estimatedWeight: parseFloat(estimatedWeight.value) || 0,
                    needHelpers: needHelpers,
                    fare: fare,
                    distance: distance
                };
            });
            
            // Request shopping button
            document.getElementById('requestShoppingBtn').addEventListener('click', async () => {
                const shopName = document.getElementById('shopName');
                const shopLocation = document.getElementById('shopLocation');
                const destinationInput = document.getElementById('shoppingDestination');
                const instructions = document.getElementById('shoppingInstructions');
                const budget = document.getElementById('shoppingBudget');
                
                if (!shopName.value || !shopLocation.value || !destinationInput.value) {
                    EnhancedUIUpdater.showToast('Please fill all required fields', 'warning');
                    return;
                }
                
                if (!AppState.destination) {
                    EnhancedUIUpdater.showToast('Please select a valid delivery location', 'warning');
                    return;
                }
                
                // Calculate distance from shop to destination
                const distance = AppState.shopLocation ? 
                    EnhancedPriceCalculator.calculateDistance(
                        AppState.shopLocation.lat, AppState.shopLocation.lng,
                        AppState.destination.lat, AppState.destination.lng
                    ) : 5; // Default 5km if shop location not set
                
                // Count items
                const itemsCount = document.querySelectorAll('.item-input').length;
                
                // Calculate fare
                const fare = EnhancedPriceCalculator.calculateShoppingFare(
                    distance, 
                    itemsCount, 
                    parseFloat(budget.value) || 0
                );
                
                // Show payment modal
                document.getElementById('paymentAmount').textContent = `ZMW ${fare.toFixed(2)}`;
                showModal('payment');
                
                // Store shopping data for after payment
                window.pendingShoppingData = {
                    shopName: shopName.value,
                    shopLocation: shopLocation.value,
                    shopLat: AppState.shopLocation?.lat,
                    shopLng: AppState.shopLocation?.lng,
                    destination: AppState.destination.address,
                    destinationDisplay: AppState.destination.fullAddress || AppState.destination.name,
                    destLat: AppState.destination.lat,
                    destLng: AppState.destination.lng,
                    items: Array.from(document.querySelectorAll('.item-input')).map(input => input.value),
                    itemsCount: itemsCount,
                    instructions: instructions.value,
                    estimatedBudget: parseFloat(budget.value) || 0,
                    fare: fare,
                    distance: distance
                };
            });
            
            // Short delivery button
            document.getElementById('requestShortDeliveryBtn').addEventListener('click', async () => {
                const pickupInput = document.getElementById('shortDeliveryPickup');
                const destinationInput = document.getElementById('shortDeliveryDestination');
                const parcelDesc = document.getElementById('shortParcelDescription');
                const receiverPhone = document.getElementById('shortReceiverPhone');
                
                if (!pickupInput.value || !destinationInput.value || !parcelDesc.value || !receiverPhone.value) {
                    EnhancedUIUpdater.showToast('Please fill all required fields', 'warning');
                    return;
                }
                
                if (!AppState.pickup || !AppState.destination) {
                    EnhancedUIUpdater.showToast('Please select valid pickup and delivery locations', 'warning');
                    return;
                }
                
                const distance = EnhancedPriceCalculator.calculateDistance(
                    AppState.pickup.lat, AppState.pickup.lng,
                    AppState.destination.lat, AppState.destination.lng
                );
                
                // Calculate fare (short delivery has fixed pricing)
                const fare = Math.max(15, distance * 2.5);
                
                // Show payment modal
                document.getElementById('paymentAmount').textContent = `ZMW ${fare.toFixed(2)}`;
                showModal('payment');
                
                // Store delivery data for after payment
                window.pendingShortDeliveryData = {
                    pickup: AppState.pickup.address,
                    pickupDisplay: AppState.pickup.fullDisplay || AppState.pickup.name,
                    destination: AppState.destination.address,
                    destinationDisplay: AppState.destination.fullAddress || AppState.destination.name,
                    pickupLat: AppState.pickup.lat,
                    pickupLng: AppState.pickup.lng,
                    destLat: AppState.destination.lat,
                    destLng: AppState.destination.lng,
                    parcelDescription: parcelDesc.value,
                    receiverPhone: receiverPhone.value,
                    fare: fare,
                    distance: distance,
                    serviceType: 'short-delivery'
                };
            });
            
            // More options button
            document.getElementById('moreOptionsBtn').addEventListener('click', () => {
                const menu = document.getElementById('moreOptionsMenu');
                menu.classList.toggle('active');
            });
            
            // Broadcast ride button
            document.getElementById('broadcastRideBtn').addEventListener('click', () => {
                switchService('broadcast');
                document.getElementById('moreOptionsMenu').classList.remove('active');
            });
            
            // SOS setup button
            document.getElementById('sosSetupBtn').addEventListener('click', () => {
                showModal('sos');
                document.getElementById('moreOptionsMenu').classList.remove('active');
            });
            
            // Recent destinations button
            document.getElementById('recentDestinationsBtn').addEventListener('click', () => {
                EnhancedUIUpdater.showSearchHistory('destinationLocation');
                document.getElementById('moreOptionsMenu').classList.remove('active');
            });
            
            // More options menu items
            document.querySelectorAll('#moreOptionsMenu .dropdown-item').forEach(item => {
                item.addEventListener('click', () => {
                    const option = item.dataset.option;
                    handleMoreOptionSelection(option);
                });
            });
            
            // Cancel ride button
            document.getElementById('cancelRideBtn').addEventListener('click', () => {
                if (AppState.currentRide) {
                    showModal('cancel');
                } else {
                    EnhancedUIUpdater.showToast('No active ride to cancel', 'warning');
                }
            });
            
            // Contact driver button
            document.getElementById('contactDriverBtn').addEventListener('click', () => {
                if (AppState.currentRide?.driverId) {
                    const driverPhone = AppState.selectedVehicle?.phone;
                    if (driverPhone) {
                        window.open(`tel:${driverPhone}`, '_blank');
                    } else {
                        EnhancedUIUpdater.showToast('Driver phone number not available', 'warning');
                    }
                } else {
                    EnhancedUIUpdater.showToast('No driver assigned yet', 'warning');
                }
            });
            
            // Open chat button
            document.getElementById('openChatBtn').addEventListener('click', () => {
                if (AppState.currentRide?.driverId) {
                    document.getElementById('chatContainer').classList.add('active');
                } else {
                    EnhancedUIUpdater.showToast('No driver assigned yet', 'warning');
                }
            });
            
            // SOS button
            document.getElementById('sosButton').addEventListener('click', () => {
                triggerSOS();
            });
            
            // Chat close button
            document.getElementById('chatClose').addEventListener('click', () => {
                document.getElementById('chatContainer').classList.remove('active');
            });
            
            // Chat send button
            document.getElementById('chatSend').addEventListener('click', async () => {
                const input = document.getElementById('chatInput');
                const message = input.value.trim();
                
                if (message && AppState.currentRide) {
                    try {
                        await EnhancedFirebaseManager.sendChatMessage(AppState.currentRide.id, message, false);
                        input.value = '';
                    } catch (error) {
                        EnhancedUIUpdater.showToast('Error sending message', 'error');
                    }
                }
            });
            
            // Chat input events
            const chatInput = document.getElementById('chatInput');
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('chatSend').click();
                }
            });
            
            chatInput.addEventListener('input', () => {
                if (AppState.currentRide) {
                    // Update typing status
                    EnhancedFirebaseManager.updateTypingStatus(AppState.currentRide.id, true, false);
                    
                    // Clear previous timeout
                    clearTimeout(AppState.typingTimeout);
                    
                    // Set timeout to clear typing status after 2 seconds of inactivity
                    AppState.typingTimeout = setTimeout(() => {
                        EnhancedFirebaseManager.updateTypingStatus(AppState.currentRide.id, false, false);
                    }, 2000);
                }
            });
            
            // Emergency service selection
            document.querySelectorAll('.emergency-service').forEach(service => {
                service.addEventListener('click', () => {
                    const type = service.dataset.type;
                    
                    if (type === 'sos') {
                        showModal('sos');
                    } else {
                        handleEmergencyService(type);
                    }
                });
            });
            
            // Emergency reason selection
            document.querySelectorAll('.emergency-reason').forEach(reason => {
                reason.addEventListener('click', () => {
                    // Remove selected from all
                    document.querySelectorAll('.emergency-reason').forEach(r => {
                        r.classList.remove('selected');
                    });
                    
                    // Add selected to clicked
                    reason.classList.add('selected');
                    
                    // Update emergency reason
                    EnhancedUIUpdater.updateEmergencyReason(reason.dataset.reason);
                });
            });
            
            // Modal close buttons
            document.querySelectorAll('.modal-close').forEach(btn => {
                btn.addEventListener('click', () => {
                    const modal = btn.dataset.modal;
                    hideModal(modal);
                });
            });
            
            // Cancel reason selection
            document.querySelectorAll('.cancel-reason[data-reason]').forEach(reason => {
                reason.addEventListener('click', () => {
                    // Remove selected from all
                    document.querySelectorAll('.cancel-reason').forEach(r => {
                        r.classList.remove('selected');
                    });
                    
                    // Add selected to clicked
                    reason.classList.add('selected');
                    
                    // Show other reason input if selected
                    const reasonType = reason.dataset.reason;
                    document.getElementById('otherReasonGroup').style.display = 
                        reasonType === 'other' ? 'block' : 'none';
                });
            });
            
            // Confirm cancel button
            document.getElementById('confirmCancelBtn').addEventListener('click', async () => {
                const selectedReason = document.querySelector('.cancel-reason.selected');
                if (!selectedReason) {
                    EnhancedUIUpdater.showToast('Please select a cancellation reason', 'warning');
                    return;
                }
                
                let reason = selectedReason.dataset.reason;
                if (reason === 'other') {
                    const otherReason = document.getElementById('otherReason').value.trim();
                    if (!otherReason) {
                        EnhancedUIUpdater.showToast('Please specify your reason', 'warning');
                        return;
                    }
                    reason = `other: ${otherReason}`;
                }
                
                if (AppState.currentRide) {
                    try {
                        await EnhancedFirebaseManager.cancelRide(AppState.currentRide.id, reason);
                        hideModal('cancel');
                    } catch (error) {
                        EnhancedUIUpdater.showToast('Error cancelling ride', 'error');
                    }
                }
            });
            
            // Payment method selection
            document.querySelectorAll('.payment-method').forEach(method => {
                method.addEventListener('click', () => {
                    document.querySelectorAll('.payment-method').forEach(m => {
                        m.classList.remove('selected');
                    });
                    method.classList.add('selected');
                });
            });
            
            // Confirm payment button
            document.getElementById('confirmPaymentBtn').addEventListener('click', async () => {
                const selectedMethod = document.querySelector('.payment-method.selected');
                if (!selectedMethod) {
                    EnhancedUIUpdater.showToast('Please select a payment method', 'warning');
                    return;
                }
                
                const paymentMethod = selectedMethod.dataset.payment;
                const amount = parseFloat(document.getElementById('paymentAmount').textContent.replace('ZMW ', ''));
                
                // Check wallet balance if paying with wallet
                if (paymentMethod === 'wallet' && AppState.walletBalance < amount) {
                    EnhancedUIUpdater.showToast('Insufficient wallet balance', 'error');
                    return;
                }
                
                // Prepare ride data based on pending service
                let rideData = {};
                
                if (window.pendingDeliveryData) {
                    rideData = {
                        ...window.pendingDeliveryData,
                        paymentMethod: paymentMethod,
                        status: 'requested'
                    };
                    
                    try {
                        // If paying with wallet, deduct from balance
                        if (paymentMethod === 'wallet') {
                            await EnhancedFirebaseManager.withdrawMoney(amount);
                        }
                        
                        await EnhancedFirebaseManager.requestDelivery(rideData);
                        hideModal('payment');
                        delete window.pendingDeliveryData;
                    } catch (error) {
                        EnhancedUIUpdater.showToast('Error processing delivery request', 'error');
                    }
                } else if (window.pendingTruckData) {
                    rideData = {
                        ...window.pendingTruckData,
                        paymentMethod: paymentMethod,
                        status: 'requested'
                    };
                    
                    try {
                        if (paymentMethod === 'wallet') {
                            await EnhancedFirebaseManager.withdrawMoney(amount);
                        }
                        
                        await EnhancedFirebaseManager.requestTruck(rideData);
                        hideModal('payment');
                        delete window.pendingTruckData;
                    } catch (error) {
                        EnhancedUIUpdater.showToast('Error processing truck request', 'error');
                    }
                } else if (window.pendingShoppingData) {
                    rideData = {
                        ...window.pendingShoppingData,
                        paymentMethod: paymentMethod,
                        status: 'requested'
                    };
                    
                    try {
                        if (paymentMethod === 'wallet') {
                            await EnhancedFirebaseManager.withdrawMoney(amount);
                        }
                        
                        await EnhancedFirebaseManager.requestShopping(rideData);
                        hideModal('payment');
                        delete window.pendingShoppingData;
                    } catch (error) {
                        EnhancedUIUpdater.showToast('Error processing shopping request', 'error');
                    }
                } else if (window.pendingShortDeliveryData) {
                    rideData = {
                        ...window.pendingShortDeliveryData,
                        paymentMethod: paymentMethod,
                        status: 'requested'
                    };
                    
                    try {
                        if (paymentMethod === 'wallet') {
                            await EnhancedFirebaseManager.withdrawMoney(amount);
                        }
                        
                        await EnhancedFirebaseManager.requestDelivery(rideData);
                        hideModal('payment');
                        delete window.pendingShortDeliveryData;
                    } catch (error) {
                        EnhancedUIUpdater.showToast('Error processing delivery request', 'error');
                    }
                } else {
                    // Regular car ride
                    const distance = EnhancedPriceCalculator.calculateDistance(
                        AppState.pickup.lat, AppState.pickup.lng,
                        AppState.destination.lat, AppState.destination.lng
                    );
                    
                    rideData = {
                        pickup: AppState.pickup.address,
                        pickupDisplay: AppState.pickup.fullDisplay || AppState.pickup.name,
                        destination: AppState.destination.address,
                        destinationDisplay: AppState.destination.fullAddress || AppState.destination.name,
                        pickupLat: AppState.pickup.lat,
                        pickupLng: AppState.pickup.lng,
                        destLat: AppState.destination.lat,
                        destLng: AppState.destination.lng,
                        rideType: AppState.selectedRideType,
                        fare: AppState.rideFare,
                        distance: distance,
                        paymentMethod: paymentMethod,
                        status: 'requested'
                    };
                    
                    try {
                        if (paymentMethod === 'wallet') {
                            await EnhancedFirebaseManager.withdrawMoney(amount);
                        }
                        
                        await EnhancedFirebaseManager.requestRide(rideData);
                        hideModal('payment');
                    } catch (error) {
                        EnhancedUIUpdater.showToast('Error processing ride request', 'error');
                    }
                }
            });
            
            // Confirm emergency button
            document.getElementById('confirmEmergencyBtn').addEventListener('click', async () => {
                if (!AppState.selectedEmergencyStation) {
                    EnhancedUIUpdater.showToast('Please select an emergency station', 'warning');
                    return;
                }
                
                const emergencyType = document.getElementById('emergencyServiceType').dataset.type;
                const selectedReason = document.querySelector('.emergency-reason.selected');
                
                if (!selectedReason) {
                    EnhancedUIUpdater.showToast('Please select an emergency reason', 'warning');
                    return;
                }
                
                let reason = selectedReason.dataset.reason;
                if (reason === 'other') {
                    const otherReason = document.getElementById('emergencyOtherReason').value.trim();
                    if (!otherReason) {
                        EnhancedUIUpdater.showToast('Please describe the emergency', 'warning');
                        return;
                    }
                    reason = otherReason;
                }
                
                // Calculate fare
                const distance = EnhancedPriceCalculator.calculateDistance(
                    AppState.userLocation.lat, AppState.userLocation.lng,
                    AppState.selectedEmergencyStation.lat, AppState.selectedEmergencyStation.lng
                );
                
                const fare = EnhancedPriceCalculator.calculateEmergencyFare(distance, emergencyType);
                
                const rideData = {
                    pickup: AppState.selectedEmergencyStation.name,
                    pickupDisplay: AppState.selectedEmergencyStation.name,
                    destination: AppState.userLocation.fullDisplay || 'Your Location',
                    destinationDisplay: 'Emergency Location',
                    pickupLat: AppState.selectedEmergencyStation.lat,
                    pickupLng: AppState.selectedEmergencyStation.lng,
                    destLat: AppState.userLocation.lat,
                    destLng: AppState.userLocation.lng,
                    emergencyType: emergencyType,
                    emergencyReason: reason,
                    fare: fare,
                    distance: distance,
                    paymentMethod: 'emergency',
                    emergencyDescription: `Emergency: ${reason}. Station: ${AppState.selectedEmergencyStation.name}`
                };
                
                try {
                    await EnhancedFirebaseManager.requestEmergencyRide(rideData);
                    hideModal('emergency');
                } catch (error) {
                    EnhancedUIUpdater.showToast('Error requesting emergency ride', 'error');
                }
            });
            
            // Save SOS button
            document.getElementById('saveSOSBtn').addEventListener('click', async () => {
                const contact1Name = document.getElementById('sosContact1Name').value.trim();
                const contact1Phone = document.getElementById('sosContact1Phone').value.trim();
                const contact2Name = document.getElementById('sosContact2Name').value.trim();
                const contact2Phone = document.getElementById('sosContact2Phone').value.trim();
                const message = document.getElementById('sosMessage').value.trim();
                
                if (!contact1Name || !contact1Phone) {
                    EnhancedUIUpdater.showToast('Please provide primary emergency contact details', 'warning');
                    return;
                }
                
                // Validate phone numbers
                const phoneRegex = /^[0-9\-\+\s\(\)]{10,}$/;
                if (!phoneRegex.test(contact1Phone)) {
                    EnhancedUIUpdater.showToast('Please enter a valid primary phone number', 'warning');
                    return;
                }
                
                if (contact2Phone && !phoneRegex.test(contact2Phone)) {
                    EnhancedUIUpdater.showToast('Please enter a valid secondary phone number', 'warning');
                    return;
                }
                
                const config = {
                    contact1Name,
                    contact1Phone,
                    contact2Name: contact2Name || '',
                    contact2Phone: contact2Phone || '',
                    message: message || 'I need help! My current location and ride details will be shared with you.',
                    updatedAt: Date.now()
                };
                
                await EnhancedFirebaseManager.saveSOSConfig(config);
                hideModal('sos');
            });
            
            // Transfer money button
            document.getElementById('transferBtn').addEventListener('click', () => {
                showModal('transfer');
            });
            
            // Confirm transfer button
            document.getElementById('confirmTransferBtn').addEventListener('click', async () => {
                const recipientCode = document.getElementById('recipientCode').value.trim();
                const amount = parseFloat(document.getElementById('transferAmount').value);
                const message = document.getElementById('transferMessage').value.trim();
                
                if (!recipientCode || !amount || amount <= 0) {
                    EnhancedUIUpdater.showToast('Please enter valid transfer details', 'warning');
                    return;
                }
                
                if (amount > AppState.walletBalance) {
                    EnhancedUIUpdater.showToast('Insufficient balance', 'error');
                    return;
                }
                
                await EnhancedFirebaseManager.transferMoney(recipientCode, amount, message);
                hideModal('transfer');
            });
            
            // Transactions button
            document.getElementById('transactionsBtn').addEventListener('click', async () => {
                showModal('transactions');
                const transactions = await EnhancedFirebaseManager.loadTransactions(AppState.currentUser.uid);
                displayTransactions(transactions);
            });
            
            // History filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    // Update active button
                    document.querySelectorAll('.filter-btn').forEach(b => {
                        b.classList.remove('active');
                    });
                    btn.classList.add('active');
                    
                    // Update filter and reload history
                    AppState.activeFilter = btn.dataset.filter;
                    EnhancedFirebaseManager.loadRideHistory(AppState.currentUser.uid);
                });
            });
            
            // Deposit button
            document.getElementById('depositBtn').addEventListener('click', () => {
                const amount = prompt('Enter deposit amount (ZMW):');
                if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
                    const depositAmount = parseFloat(amount);
                    EnhancedFirebaseManager.depositMoney(depositAmount);
                }
            });
            
            // Withdraw button
            document.getElementById('withdrawBtn').addEventListener('click', () => {
                if (AppState.walletBalance <= 0) {
                    EnhancedUIUpdater.showToast('No balance to withdraw', 'warning');
                    return;
                }
                
                const amount = prompt(`Enter withdrawal amount (ZMW). Available: ZMW ${AppState.walletBalance.toFixed(2)}:`);
                if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
                    const withdrawalAmount = parseFloat(amount);
                    
                    if (withdrawalAmount > AppState.walletBalance) {
                        EnhancedUIUpdater.showToast('Insufficient balance', 'error');
                        return;
                    }
                    
                    EnhancedFirebaseManager.withdrawMoney(withdrawalAmount);
                }
            });
            
            // Share referral button
            document.getElementById('shareReferralBtn').addEventListener('click', () => {
                const code = document.getElementById('referralCode').textContent;
                const text = `Join me on Jubel! Use my referral code ${code} for 50% off your first ride. Download the app now!`;
                
                if (navigator.share) {
                    navigator.share({
                        title: 'Jubel Referral',
                        text: text,
                        url: window.location.href
                    }).catch(() => {
                        // Fallback to clipboard
                        navigator.clipboard.writeText(text)
                            .then(() => EnhancedUIUpdater.showToast('Referral code copied', 'success'))
                            .catch(() => EnhancedUIUpdater.showToast('Error copying code', 'error'));
                    });
                } else {
                    navigator.clipboard.writeText(text)
                        .then(() => EnhancedUIUpdater.showToast('Referral code copied', 'success'))
                        .catch(() => EnhancedUIUpdater.showToast('Error copying code', 'error'));
                }
            });
            
            // Update profile button
            document.getElementById('updateProfileBtn').addEventListener('click', () => {
                showModal('updateProfile');
                
                // Pre-fill form with current data
                document.getElementById('updateName').value = AppState.userData?.name || '';
                document.getElementById('updatePhone').value = AppState.userData?.phone || '';
                document.getElementById('updateEmail').value = AppState.currentUser?.email || '';
                document.getElementById('updateHomeAddress').value = AppState.userData?.homeAddress || '';
                document.getElementById('updateWorkAddress').value = AppState.userData?.workAddress || '';
            });
            
            // Save profile button
            document.getElementById('saveProfileBtn').addEventListener('click', async () => {
                const name = document.getElementById('updateName').value.trim();
                const phone = document.getElementById('updatePhone').value.trim();
                const homeAddress = document.getElementById('updateHomeAddress').value.trim();
                const workAddress = document.getElementById('updateWorkAddress').value.trim();
                
                if (!name || !phone) {
                    EnhancedUIUpdater.showToast('Please fill in name and phone number', 'warning');
                    return;
                }
                
                const profileData = {
                    name: name,
                    phone: phone,
                    homeAddress: homeAddress,
                    workAddress: workAddress
                };
                
                await EnhancedFirebaseManager.updateProfile(profileData);
                hideModal('updateProfile');
            });
            
            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', () => {
                if (confirm('Are you sure you want to logout?')) {
                    EnhancedFirebaseManager.stopRealtimeSync();
                    
                    if (AppState.syncInterval) {
                        clearInterval(AppState.syncInterval);
                    }
                    
                    auth.signOut().then(() => {
                        window.location.href = 'signup.html';
                    });
                }
            });
            
            // Notification bell
            document.getElementById('notificationBell').addEventListener('click', () => {
                const panel = document.getElementById('notificationsPanel');
                panel.classList.toggle('active');
            });
            
            document.getElementById('notificationsClose').addEventListener('click', () => {
                document.getElementById('notificationsPanel').classList.remove('active');
            });
            
            // Schedule ride option
            document.querySelector('[data-option="schedule"]')?.addEventListener('click', () => {
                showModal('schedule');
                document.getElementById('moreOptionsMenu').classList.remove('active');
            });
            
            // Order for someone option
            document.querySelector('[data-option="orderForSomeone"]')?.addEventListener('click', () => {
                showModal('orderForSomeone');
                document.getElementById('moreOptionsMenu').classList.remove('active');
            });
            
            // Share ride option
            document.querySelector('[data-option="shareRide"]')?.addEventListener('click', () => {
                showModal('shareRide');
                document.getElementById('moreOptionsMenu').classList.remove('active');
            });
            
            // Confirm schedule button
            document.getElementById('confirmScheduleBtn').addEventListener('click', async () => {
                const pickup = document.getElementById('schedulePickup').value;
                const destination = document.getElementById('scheduleDestination').value;
                const date = document.getElementById('scheduleDate').value;
                const time = document.getElementById('scheduleTime').value;
                const forSomeone = document.getElementById('scheduleForSomeone').checked;
                const recipientName = document.getElementById('recipientName');
                const recipientPhone = document.getElementById('recipientPhone');
                
                if (!pickup || !destination || !date || !time) {
                    EnhancedUIUpdater.showToast('Please fill all schedule details', 'warning');
                    return;
                }
                
                if (forSomeone && (!recipientName.value || !recipientPhone.value)) {
                    EnhancedUIUpdater.showToast('Please fill recipient details', 'warning');
                    return;
                }
                
                const scheduledTime = new Date(`${date}T${time}`);
                if (scheduledTime <= new Date()) {
                    EnhancedUIUpdater.showToast('Please select a future date and time', 'warning');
                    return;
                }
                
                // Get selected ride type
                const selectedRideType = document.querySelector('#scheduleModal .ride-type-card.selected')?.dataset.type || 'standard';
                
                // Calculate fare
                const distance = AppState.pickup && AppState.destination ? 
                    EnhancedPriceCalculator.calculateDistance(
                        AppState.pickup.lat, AppState.pickup.lng,
                        AppState.destination.lat, AppState.destination.lng
                    ) : 0;
                
                const surge = EnhancedPriceCalculator.getSurgeMultiplier();
                const fare = EnhancedPriceCalculator.calculateRideFare(distance, selectedRideType, surge);
                
                const rideData = {
                    pickup: AppState.pickup?.address || pickup,
                    pickupDisplay: AppState.pickup?.fullDisplay || AppState.pickup?.name || pickup,
                    destination: AppState.destination?.address || destination,
                    destinationDisplay: AppState.destination?.fullAddress || AppState.destination?.name || destination,
                    pickupLat: AppState.pickup?.lat,
                    pickupLng: AppState.pickup?.lng,
                    destLat: AppState.destination?.lat,
                    destLng: AppState.destination?.lng,
                    rideType: selectedRideType,
                    fare: fare,
                    distance: distance,
                    scheduled: true,
                    scheduledTime: scheduledTime.getTime(),
                    status: 'scheduled'
                };
                
                if (forSomeone) {
                    rideData.recipientName = recipientName.value;
                    rideData.recipientPhone = recipientPhone.value;
                    rideData.forSomeoneElse = true;
                }
                
                try {
                    await EnhancedFirebaseManager.scheduleRide(rideData);
                    hideModal('schedule');
                    EnhancedUIUpdater.showToast('Ride scheduled successfully', 'success');
                } catch (error) {
                    EnhancedUIUpdater.showToast('Error scheduling ride', 'error');
                }
            });
            
            // Confirm someone ride button
            document.getElementById('confirmSomeoneRideBtn').addEventListener('click', async () => {
                const pickup = document.getElementById('someonePickup').value;
                const destination = document.getElementById('someoneDestination').value;
                const name = document.getElementById('someoneName').value;
                const phone = document.getElementById('someonePhone').value;
                const instructions = document.getElementById('someoneInstructions').value;
                
                if (!pickup || !destination || !name || !phone) {
                    EnhancedUIUpdater.showToast('Please fill all required fields', 'warning');
                    return;
                }
                
                // Get selected ride type
                const selectedRideType = document.querySelector('#orderForSomeoneModal .ride-type-card.selected')?.dataset.type || 'standard';
                
                // Calculate fare
                const distance = AppState.pickup && AppState.destination ? 
                    EnhancedPriceCalculator.calculateDistance(
                        AppState.pickup.lat, AppState.pickup.lng,
                        AppState.destination.lat, AppState.destination.lng
                    ) : 0;
                
                const surge = EnhancedPriceCalculator.getSurgeMultiplier();
                const fare = EnhancedPriceCalculator.calculateRideFare(distance, selectedRideType, surge);
                
                // Show payment modal
                document.getElementById('paymentAmount').textContent = `ZMW ${fare.toFixed(2)}`;
                showModal('payment');
                
                // Store ride data for after payment
                window.pendingSomeoneData = {
                    pickup: AppState.pickup?.address || pickup,
                    pickupDisplay: AppState.pickup?.fullDisplay || AppState.pickup?.name || pickup,
                    destination: AppState.destination?.address || destination,
                    destinationDisplay: AppState.destination?.fullAddress || AppState.destination?.name || destination,
                    pickupLat: AppState.pickup?.lat,
                    pickupLng: AppState.pickup?.lng,
                    destLat: AppState.destination?.lat,
                    destLng: AppState.destination?.lng,
                    rideType: selectedRideType,
                    recipientName: name,
                    recipientPhone: phone,
                    instructions: instructions,
                    fare: fare,
                    distance: distance,
                    forSomeoneElse: true
                };
                
                hideModal('orderForSomeone');
            });
            
            // Confirm share ride button
            document.getElementById('confirmShareRideBtn').addEventListener('click', async () => {
                const pickup = document.getElementById('sharePickup').value;
                const destination = document.getElementById('shareDestination').value;
                const friendCode = document.getElementById('friendReferralCode').value;
                const splitPercentage = document.getElementById('splitPercentage').value;
                
                if (!pickup || !destination || !friendCode) {
                    EnhancedUIUpdater.showToast('Please fill all required fields', 'warning');
                    return;
                }
                
                // Get selected ride type
                const selectedRideType = document.querySelector('#shareRideModal .ride-type-card.selected')?.dataset.type || 'standard';
                
                // Calculate distance and fare
                const distance = AppState.pickup && AppState.destination ? 
                    EnhancedPriceCalculator.calculateDistance(
                        AppState.pickup.lat, AppState.pickup.lng,
                        AppState.destination.lat, AppState.destination.lng
                    ) : 0;
                
                const calculations = EnhancedUIUpdater.updateShareRideCalculations(distance, parseInt(splitPercentage));
                
                // Show payment modal for your share
                document.getElementById('paymentAmount').textContent = `ZMW ${calculations.yourShare.toFixed(2)}`;
                showModal('payment');
                
                // Store share ride data for after payment
                window.pendingShareData = {
                    pickup: AppState.pickup?.address || pickup,
                    pickupDisplay: AppState.pickup?.fullDisplay || AppState.pickup?.name || pickup,
                    destination: AppState.destination?.address || destination,
                    destinationDisplay: AppState.destination?.fullAddress || AppState.destination?.name || destination,
                    pickupLat: AppState.pickup?.lat,
                    pickupLng: AppState.pickup?.lng,
                    destLat: AppState.destination?.lat,
                    destLng: AppState.destination?.lng,
                    rideType: selectedRideType,
                    friendReferralCode: friendCode,
                    splitPercentage: parseInt(splitPercentage),
                    yourShare: calculations.yourShare,
                    friendShare: calculations.friendShare,
                    totalFare: calculations.totalFare,
                    fare: calculations.yourShare,
                    distance: distance,
                    sharedRide: true
                };
                
                hideModal('shareRide');
            });
            
            // Broadcast form
            document.getElementById('startBroadcastRideBtn').addEventListener('click', async () => {
                const pickup = document.getElementById('broadcastPickup').value;
                const destination = document.getElementById('broadcastDestination').value;
                const passengers = document.getElementById('broadcastPassengers').value;
                const rideType = document.getElementById('broadcastRideType').value;
                const splitType = document.getElementById('broadcastSplitType').value;
                
                if (!pickup || !destination || !passengers) {
                    EnhancedUIUpdater.showToast('Please fill all required fields', 'warning');
                    return;
                }
                
                // Parse passenger phone numbers
                const phoneNumbers = passengers.split(',')
                    .map(phone => phone.trim())
                    .filter(phone => phone.length > 0);
                
                if (phoneNumbers.length === 0) {
                    EnhancedUIUpdater.showToast('Please enter at least one passenger phone number', 'warning');
                    return;
                }
                
                // Create recipients array
                const recipients = phoneNumbers.map(phone => ({
                    phone: phone,
                    name: '', // Name will be fetched from database if user exists
                    status: 'pending'
                }));
                
                // Calculate distance and fare
                const distance = AppState.pickup && AppState.destination ? 
                    EnhancedPriceCalculator.calculateDistance(
                        AppState.pickup.lat, AppState.pickup.lng,
                        AppState.destination.lat, AppState.destination.lng
                    ) : 0;
                
                const calculation = EnhancedPriceCalculator.calculateBroadcastFare(
                    distance, 
                    rideType, 
                    splitType === 'equal' ? 'equal' : 
                    splitType === 'you_pay_more' ? 'you_pay_more' : 'you_pay_all',
                    recipients.length + 1 // +1 for yourself
                );
                
                // Show payment modal
                document.getElementById('paymentAmount').textContent = `ZMW ${calculation.yourShare.toFixed(2)}`;
                showModal('payment');
                
                // Store broadcast data for after payment
                window.pendingBroadcastData = {
                    pickup: AppState.pickup?.address || pickup,
                    pickupDisplay: AppState.pickup?.fullDisplay || AppState.pickup?.name || pickup,
                    destination: AppState.destination?.address || destination,
                    destinationDisplay: AppState.destination?.fullAddress || AppState.destination?.name || destination,
                    pickupLat: AppState.pickup?.lat,
                    pickupLng: AppState.pickup?.lng,
                    destLat: AppState.destination?.lat,
                    destLng: AppState.destination?.lng,
                    rideType: rideType,
                    splitType: splitType,
                    broadcastRecipients: recipients,
                    fare: calculation.yourShare,
                    totalFare: calculation.total,
                    distance: distance,
                    broadcast: true
                };
            });
            
            // Click outside suggestion lists to close them
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.location-input') && !e.target.closest('.suggestion-list') && !e.target.closest('.search-history')) {
                    document.querySelectorAll('.suggestion-list').forEach(list => {
                        list.classList.remove('active');
                    });
                    document.getElementById('searchHistory').style.display = 'none';
                }
                
                // Close dropdown menus
                if (!e.target.closest('.more-options-menu') && !e.target.closest('#moreOptionsBtn')) {
                    document.getElementById('moreOptionsMenu').classList.remove('active');
                }
                
                if (!e.target.closest('.notifications-panel') && !e.target.closest('#notificationBell')) {
                    document.getElementById('notificationsPanel').classList.remove('active');
                }
            });
            
            // Escape key to close modals and panels
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    hideAllModals();
                    document.getElementById('moreOptionsMenu').classList.remove('active');
                    document.getElementById('notificationsPanel').classList.remove('active');
                    document.getElementById('chatContainer').classList.remove('active');
                }
            });
            
            // Window beforeunload event
            window.addEventListener('beforeunload', () => {
                EnhancedFirebaseManager.stopRealtimeSync();
                
                if (AppState.syncInterval) {
                    clearInterval(AppState.syncInterval);
                }
            });
        }
        
        // ============================================
        // HELPER FUNCTIONS
        // ============================================
        function switchScreen(screen) {
            // Hide all screens
            document.querySelectorAll('.history-screen, .account-screen, .emergency-screen').forEach(s => {
                s.classList.remove('active');
            });
            
            // Update navigation tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Hide chat and notifications
            document.getElementById('chatContainer').classList.remove('active');
            document.getElementById('notificationsPanel').classList.remove('active');
            document.getElementById('moreOptionsMenu').classList.remove('active');
            
            // Show selected screen
            if (screen === 'home') {
                AppState.activeScreen = 'home';
                document.querySelector(`.nav-tab[data-screen="home"]`).classList.add('active');
            } else {
                document.getElementById(`${screen}Screen`).classList.add('active');
                document.querySelector(`.nav-tab[data-screen="${screen}"]`).classList.add('active');
                AppState.activeScreen = screen;
                
                // Load data for specific screens
                if (screen === 'history') {
                    EnhancedFirebaseManager.loadRideHistory(AppState.currentUser.uid);
                }
            }
        }
        
        function switchService(service) {
            // Hide all forms
            document.querySelectorAll('.ride-request-form, .service-form, #broadcastForm').forEach(form => {
                form.style.display = 'none';
                form.classList.remove('active');
            });
            
            // Update service tabs
            document.querySelectorAll('.service-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected service form
            AppState.activeService = service;
            
            switch(service) {
                case 'car':
                    document.querySelector('.service-tab.car').classList.add('active');
                    document.getElementById('carForm').style.display = 'block';
                    break;
                case 'delivery':
                    document.querySelector('.service-tab.delivery').classList.add('active');
                    document.getElementById('deliveryForm').style.display = 'block';
                    document.getElementById('deliveryForm').classList.add('active');
                    break;
                case 'short-delivery':
                    document.querySelector('.service-tab.short-delivery').classList.add('active');
                    document.getElementById('shortDeliveryForm').style.display = 'block';
                    document.getElementById('shortDeliveryForm').classList.add('active');
                    break;
                case 'express':
                    document.querySelector('.service-tab[data-service="express"]').classList.add('active');
                    document.getElementById('expressForm').style.display = 'block';
                    document.getElementById('expressForm').classList.add('active');
                    break;
                case 'truck':
                    document.querySelector('.service-tab[data-service="truck"]').classList.add('active');
                    document.getElementById('truckForm').style.display = 'block';
                    document.getElementById('truckForm').classList.add('active');
                    break;
                case 'broadcast':
                    document.getElementById('broadcastForm').style.display = 'block';
                    document.getElementById('broadcastForm').classList.add('active');
                    break;
            }
        }
        
        function handleMoreOptionSelection(option) {
            switch(option) {
                case 'schedule':
                    showModal('schedule');
                    break;
                case 'orderForSomeone':
                    showModal('orderForSomeone');
                    break;
                case 'shareRide':
                    showModal('shareRide');
                    break;
                case 'broadcast':
                    switchService('broadcast');
                    break;
            }
        }
        
        function handleEmergencyService(type) {
            if (!AppState.userLocation) {
                EnhancedUIUpdater.showToast('Please allow location access for emergency services', 'warning');
                return;
            }
            
            if (!AppState.currentCity) {
                EnhancedUIUpdater.showToast('Please wait while we detect your city', 'warning');
                return;
            }
            
            // Load emergency stations for this type
            EnhancedFirebaseManager.loadEmergencyStations(AppState.currentCity, type)
                .then(() => {
                    // Update modal with service details
                    document.getElementById('emergencyServiceType').textContent = 
                        type.charAt(0).toUpperCase() + type.slice(1) + ' Ride';
                    document.getElementById('emergencyServiceType').dataset.type = type;
                    
                    // Show emergency stations on map
                    EnhancedEmergencyLocator.showEmergencyStationsOnMap(type);
                    
                    // Show modal
                    showModal('emergency');
                });
        }
        
        function triggerSOS() {
            if (!AppState.sosConfig) {
                EnhancedUIUpdater.showToast('Please setup SOS contacts first', 'warning');
                return;
            }
            
            if (!AppState.currentRide) {
                EnhancedUIUpdater.showToast('No active ride to report SOS for', 'warning');
                return;
            }
            
            if (!confirm('Are you sure you want to send an SOS alert to your emergency contacts?')) {
                return;
            }
            
            const sosData = {
                emergencyContact1: AppState.sosConfig.contact1Phone,
                emergencyContact1Name: AppState.sosConfig.contact1Name,
                emergencyContact2: AppState.sosConfig.contact2Phone,
                emergencyContact2Name: AppState.sosConfig.contact2Name,
                message: AppState.sosConfig.message,
                location: AppState.userLocation,
                rideDetails: {
                    pickup: AppState.currentRide.pickupDisplay,
                    destination: AppState.currentRide.destinationDisplay,
                    driver: AppState.currentRide.driverName
                }
            };
            
            EnhancedFirebaseManager.sendSOSAlert(AppState.currentRide.id, sosData)
                .then(() => {
                    EnhancedUIUpdater.showToast('SOS alert sent to emergency contacts', 'success');
                })
                .catch(error => {
                    console.error('SOS error:', error);
                    EnhancedUIUpdater.showToast('Error sending SOS alert', 'error');
                });
        }
        
        function showModal(modalId) {
            document.getElementById(`${modalId}Modal`).classList.add('active');
        }
        
        function hideModal(modalId) {
            document.getElementById(`${modalId}Modal`).classList.remove('active');
        }
        
        function hideAllModals() {
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.classList.remove('active');
            });
        }
        
        function togglePanel() {
            const panel = document.getElementById('mainPanel');
            panel.classList.toggle('collapsed');
        }
        
        function displayTransactions(transactions) {
            const container = document.getElementById('transactionsList');
            
            if (transactions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 30px 0;">
                        <div class="empty-icon">
                            <i class="fas fa-receipt"></i>
                        </div>
                        <div class="empty-title">No transactions yet</div>
                        <div class="empty-message">Your wallet transactions will appear here</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            transactions.forEach(transaction => {
                const isSent = transaction.senderId === AppState.currentUser.uid;
                const isSystem = transaction.senderId === 'system' || transaction.recipientId === 'system';
                const date = new Date(transaction.timestamp);
                
                html += `
                    <div class="history-item" style="margin-bottom: 10px;">
                        <div class="history-header">
                            <div class="history-type">
                                <div class="history-icon" style="background: ${isSent ? 'var(--error-red)' : isSystem ? 'var(--info-blue)' : 'var(--success-green)'}">
                                    <i class="fas fa-${isSent ? 'arrow-up' : isSystem ? 'exchange-alt' : 'arrow-down'}"></i>
                                </div>
                                <div class="history-type-name">
                                    ${isSent ? 'Money Sent' : isSystem ? transaction.type === 'deposit' ? 'Deposit' : transaction.type === 'withdrawal' ? 'Withdrawal' : 'System' : 'Money Received'}
                                </div>
                            </div>
                            <div class="history-date">
                                ${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                            </div>
                        </div>
                        
                        <div style="padding: 10px 0;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span style="color: var(--text-gray);">${isSent ? 'To' : isSystem ? 'Type' : 'From'}:</span>
                                <span style="font-weight: 600;">${isSent ? transaction.recipientName : isSystem ? transaction.type.charAt(0).toUpperCase() + transaction.type.slice(1) : transaction.senderName}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span style="color: var(--text-gray);">Amount:</span>
                                <span style="font-weight: 700; color: ${isSent ? 'var(--error-red)' : 'var(--success-green)'}">
                                    ${isSent ? '-' : '+'}ZMW ${transaction.amount.toFixed(2)}
                                </span>
                            </div>
                            ${transaction.message ? `
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-gray);">Message:</span>
                                <span style="font-size: 12px;">${transaction.message}</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function callEmergencyContact(contactType) {
            let phoneNumber = '';
            
            if (contactType === 'contact1') {
                phoneNumber = AppState.sosConfig?.contact1Phone;
            } else if (contactType === 'contact2') {
                phoneNumber = AppState.sosConfig?.contact2Phone;
            }
            
            if (phoneNumber) {
                window.open(`tel:${phoneNumber}`, '_blank');
            } else {
                EnhancedUIUpdater.showToast('Phone number not available', 'warning');
            }
        }

        // ============================================
        // START THE APPLICATION
        // ============================================
        window.addEventListener('load', initializeApp);
    </script>
</body>
</html>

