<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jubel - Passenger</title>
    <!-- OpenLayers CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.3.0/ol.css" type="text/css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Print styles for receipts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/print-js/1.6.0/print.min.css">
    <style>
        /* All existing CSS styles remain unchanged */
        :root {
            --primary-orange: #FF6B35;
            --primary-red: #E74C3C;
            --primary-gradient: linear-gradient(135deg, #FF6B35, #E74C3C);
            --secondary-orange: #E55A28;
            --secondary-red: #C0392B;
            --light-orange: #FFE8E0;
            --light-red: #FADBD8;
            --white: #FFFFFF;
            --light-gray: #F5F5F5;
            --dark-gray: #333333;
            --medium-gray: #777777;
            --success-green: #2ecc71;
            --warning-yellow: #f39c12;
            --info-blue: #3498db;
            --error-red: #e74c3c;
            --emergency-red: #e74c3c;
            --ambulance-red: #ff4444;
            --fire-truck-red: #ff3333;
            --police-blue: #3366ff;
            --border-color: #E8E8E8;
            --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 4px 15px rgba(0, 0, 0, 0.15);
            --shadow-heavy: 0 6px 20px rgba(0, 0, 0, 0.2);
            --app-padding: 10px;
            --element-radius: 6px;
            --transition-speed: 0.3s;
            --premium-gold: #FFD700;
            --economy-green: #27ae60;
            --standard-blue: #3498db;
            --truck-brown: #8B4513;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--white);
            color: var(--dark-gray);
            max-width: 100%;
            overflow-x: hidden;
            height: 100vh;
            font-size: 13px;
        }
        
        /* OpenLayers Map Container */
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        /* OpenLayers Controls */
        .ol-control {
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-medium);
        }
        
        .ol-control button {
            background-color: var(--primary-orange);
            color: var(--white);
            border-radius: var(--element-radius);
            font-size: 1.2rem;
        }
        
        .ol-control button:hover {
            background-color: var(--secondary-orange);
        }
        
        /* Map Controls Container */
        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .map-control-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--white);
            border: 2px solid var(--primary-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.1rem;
            color: var(--primary-orange);
            box-shadow: var(--shadow-heavy);
            transition: all var(--transition-speed) ease;
        }
        
        .map-control-btn:hover {
            background: var(--primary-orange);
            color: var(--white);
            transform: scale(1.05);
        }
        
        /* Floating Balance */
        .floating-balance {
            position: fixed;
            top: 10px;
            left: 10px;
            background: var(--white);
            padding: 6px 10px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 700;
            color: var(--dark-gray);
            border: 2px solid var(--primary-orange);
            font-size: 0.75rem;
        }
        
        .balance-amount {
            color: var(--primary-orange);
            font-size: 0.8rem;
        }
        
        /* Passenger Panel */
        .passenger-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            border-radius: 15px 15px 0 0;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
            z-index: 100;
            padding: var(--app-padding);
            transform: translateY(0);
            transition: transform var(--transition-speed) ease;
            max-height: 45vh;
            overflow-y: auto;
        }
        
        .passenger-panel.collapsed {
            transform: translateY(calc(100% - 40px));
        }
        
        .panel-collapse-handle {
            width: 35px;
            height: 3px;
            background: var(--border-color);
            border-radius: 2px;
            margin: 0 auto 8px;
            cursor: pointer;
        }
        
        .nav-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            padding: 6px 3px;
            border-radius: var(--element-radius);
            background: var(--light-gray);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            border: none;
            font-size: 0.6rem;
            font-weight: 600;
        }
        
        .nav-btn.active {
            background: var(--primary-gradient);
            color: var(--white);
        }
        
        .nav-btn i {
            font-size: 0.8rem;
        }
        
        /* NEW: Emergency Button */
        .emergency-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: var(--element-radius);
            background: var(--emergency-red);
            color: var(--white);
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            margin-top: 8px;
            box-shadow: var(--shadow-medium);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .emergency-btn:hover {
            background: #c0392b;
            transform: scale(1.02);
        }
        
        /* Emergency Popup */
        .emergency-popup {
            max-width: 450px;
        }
        
        .emergency-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        
        .emergency-option {
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            text-align: center;
        }
        
        .emergency-option:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .emergency-option.ambulance {
            border-color: var(--ambulance-red);
            background: linear-gradient(135deg, #ffebee, #ffcdd2);
        }
        
        .emergency-option.fire-truck {
            border-color: var(--fire-truck-red);
            background: linear-gradient(135deg, #ffebee, #ffccbc);
        }
        
        .emergency-option.police {
            border-color: var(--police-blue);
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        }
        
        .emergency-option.emergency-ride {
            border-color: var(--emergency-red);
            background: linear-gradient(135deg, #ffebee, #ffccbc);
        }
        
        .emergency-option.emergency-delivery {
            border-color: var(--warning-yellow);
            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
        }
        
        .emergency-icon {
            font-size: 2rem;
            margin-bottom: 5px;
        }
        
        .emergency-option.ambulance .emergency-icon {
            color: var(--ambulance-red);
        }
        
        .emergency-option.fire-truck .emergency-icon {
            color: var(--fire-truck-red);
        }
        
        .emergency-option.police .emergency-icon {
            color: var(--police-blue);
        }
        
        .emergency-option.emergency-ride .emergency-icon {
            color: var(--emergency-red);
        }
        
        .emergency-option.emergency-delivery .emergency-icon {
            color: var(--warning-yellow);
        }
        
        .emergency-title {
            font-size: 0.9rem;
            font-weight: 700;
            margin-bottom: 3px;
        }
        
        .emergency-description {
            font-size: 0.7rem;
            color: var(--medium-gray);
        }
        
        /* Emergency Questionnaire */
        .emergency-questionnaire {
            display: none;
            flex-direction: column;
            gap: 12px;
            margin-top: 15px;
            padding: 15px;
            border: 2px solid var(--emergency-red);
            border-radius: var(--element-radius);
            background: var(--light-red);
        }
        
        .emergency-questionnaire.active {
            display: flex;
        }
        
        .emergency-question {
            margin-bottom: 8px;
        }
        
        .emergency-question label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--emergency-red);
            font-size: 0.8rem;
        }
        
        .emergency-question textarea,
        .emergency-question input,
        .emergency-question select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--emergency-red);
            border-radius: var(--element-radius);
            font-size: 0.8rem;
        }
        
        .emergency-question textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .emergency-submit-btn {
            background: var(--emergency-red);
            color: var(--white);
            border: none;
            padding: 12px;
            border-radius: var(--element-radius);
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .emergency-submit-btn:hover {
            background: #c0392b;
        }
        
        /* Ride Type Selection */
        .ride-type-selection {
            display: none;
            flex-direction: column;
            gap: 8px;
            margin: 10px 0;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
        }
        
        .ride-type-selection.active {
            display: flex;
        }
        
        .ride-type-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        
        .ride-type-option {
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .ride-type-option.selected {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .ride-type-option.premium {
            border-color: var(--premium-gold);
            background: linear-gradient(135deg, #fff9c4, #fff59d);
        }
        
        .ride-type-option.premium.selected {
            background: linear-gradient(135deg, var(--premium-gold), #ffca28);
            color: var(--dark-gray);
        }
        
        .ride-type-option.economy {
            border-color: var(--economy-green);
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
        }
        
        .ride-type-option.economy.selected {
            background: linear-gradient(135deg, var(--economy-green), #2ecc71);
            color: var(--white);
        }
        
        .ride-type-option.standard {
            border-color: var(--standard-blue);
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        }
        
        .ride-type-option.standard.selected {
            background: linear-gradient(135deg, var(--standard-blue), #2980b9);
            color: var(--white);
        }
        
        .ride-type-option.truck {
            border-color: var(--truck-brown);
            background: linear-gradient(135deg, #efebe9, #d7ccc8);
        }
        
        .ride-type-option.truck.selected {
            background: linear-gradient(135deg, var(--truck-brown), #a1887f);
            color: var(--white);
        }
        
        .ride-type-icon {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .ride-type-name {
            font-weight: 700;
            font-size: 0.8rem;
        }
        
        .ride-type-price {
            font-size: 0.7rem;
            color: var(--medium-gray);
        }
        
        .ride-type-option.selected .ride-type-price {
            color: rgba(255, 255, 255, 0.9);
        }
        
        /* More Options Button */
        .more-options-btn {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--primary-orange);
            color: var(--white);
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .more-options-dropdown {
            display: none;
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            margin-top: 5px;
            overflow: hidden;
            box-shadow: var(--shadow-medium);
        }
        
        .more-options-dropdown.active {
            display: block;
        }
        
        .more-option-item {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all var(--transition-speed) ease;
        }
        
        .more-option-item:hover {
            background: var(--light-orange);
        }
        
        .more-option-item:last-child {
            border-bottom: none;
        }
        
        .more-option-icon {
            width: 20px;
            text-align: center;
            font-size: 0.9rem;
        }
        
        .more-option-text {
            flex: 1;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        /* Order for Someone Else Form */
        .order-for-someone-form {
            display: none;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
        }
        
        .order-for-someone-form.active {
            display: flex;
        }
        
        /* Express Delivery Form */
        .express-delivery-form {
            display: none;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
        }
        
        .express-delivery-form.active {
            display: flex;
        }
        
        /* SOS Setup Form */
        .sos-setup-form {
            display: none;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
        }
        
        .sos-setup-form.active {
            display: flex;
        }
        
        /* SOS Button */
        .sos-button {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--error-red);
            color: var(--white);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 700;
            box-shadow: var(--shadow-heavy);
            z-index: 150;
            cursor: pointer;
            animation: sos-pulse 2s infinite;
            display: none;
        }
        
        @keyframes sos-pulse {
            0% {
                transform: translateX(-50%) scale(1);
                box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7);
            }
            70% {
                transform: translateX(-50%) scale(1.05);
                box-shadow: 0 0 0 10px rgba(231, 76, 60, 0);
            }
            100% {
                transform: translateX(-50%) scale(1);
                box-shadow: 0 0 0 0 rgba(231, 76, 60, 0);
            }
        }
        
        /* Delivery Fee Display */
        .delivery-fee-display {
            background: var(--primary-gradient);
            color: var(--white);
            padding: 10px;
            border-radius: var(--element-radius);
            text-align: center;
            margin: 8px 0;
        }
        
        .delivery-fee-amount {
            font-size: 1.2rem;
            font-weight: 800;
            margin: 4px 0;
        }
        
        .delivery-eta-display {
            font-size: 0.8rem;
            font-weight: 600;
            opacity: 0.9;
        }
        
        /* All other existing CSS styles remain unchanged */
        .ride-request-form {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .location-input {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--white);
            position: relative;
        }
        
        .location-input i {
            color: var(--primary-orange);
        }
        
        .location-input input {
            border: none;
            outline: none;
            width: 100%;
            font-size: 0.8rem;
        }
        
        .vehicle-selection {
            display: flex;
            gap: 6px;
            margin: 8px 0;
        }
        
        .vehicle-option {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 4px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .vehicle-option.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .vehicle-icon {
            font-size: 1rem;
            color: var(--medium-gray);
        }
        
        .vehicle-option.selected .vehicle-icon {
            color: var(--primary-orange);
        }
        
        .vehicle-name {
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .vehicle-price {
            font-size: 0.65rem;
            color: var(--medium-gray);
        }
        
        .promo-section {
            margin-top: 8px;
            padding: 8px;
            border: 1px dashed var(--border-color);
            border-radius: var(--element-radius);
            display: none;
        }
        
        .promo-section.active {
            display: block;
        }
        
        .promo-input {
            display: flex;
            gap: 6px;
        }
        
        .promo-input input {
            flex: 1;
            padding: 6px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 0.75rem;
        }
        
        .btn-promo {
            background: var(--primary-orange);
            color: var(--white);
            border: none;
            border-radius: var(--element-radius);
            padding: 6px 10px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .promo-toggle {
            width: 100%;
            padding: 6px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .fare-display {
            background: var(--primary-gradient);
            color: var(--white);
            padding: 10px;
            border-radius: var(--element-radius);
            text-align: center;
            margin: 8px 0;
            box-shadow: var(--shadow-medium);
        }
        
        .fare-amount {
            font-size: 1.5rem;
            font-weight: 800;
            margin: 4px 0;
        }
        
        .eta-display {
            font-size: 0.9rem;
            font-weight: 600;
            opacity: 0.9;
        }
        
        .request-ride-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: var(--element-radius);
            background: var(--primary-gradient);
            color: var(--white);
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            margin-top: 8px;
            box-shadow: var(--shadow-medium);
        }
        
        .request-ride-btn:disabled {
            background: var(--medium-gray);
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .ride-info-panel {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 10px;
            box-shadow: var(--shadow-medium);
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            display: none;
        }
        
        .driver-info {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .driver-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            color: var(--white);
            font-weight: 700;
        }
        
        .driver-details h2 {
            font-size: 0.85rem;
            margin-bottom: 2px;
        }
        
        .driver-details p {
            color: var(--medium-gray);
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 3px;
            font-size: 0.7rem;
        }
        
        .trip-details {
            margin-bottom: 10px;
        }
        
        .location-row {
            display: flex;
            align-items: flex-start;
            gap: 5px;
            margin-bottom: 8px;
        }
        
        .location-icon {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            flex-shrink: 0;
        }
        
        .pickup-icon {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .destination-icon {
            background: var(--primary-red);
            color: var(--white);
        }
        
        .location-text {
            flex: 1;
        }
        
        .location-text h4 {
            font-size: 0.8rem;
            margin-bottom: 2px;
        }
        
        .location-text p {
            color: var(--medium-gray);
            font-size: 0.7rem;
        }
        
        .fare-details {
            background: var(--light-orange);
            padding: 8px;
            border-radius: var(--element-radius);
            margin-bottom: 10px;
        }
        
        .fare-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 0.7rem;
        }
        
        .fare-row.total {
            font-weight: 700;
            font-size: 0.8rem;
            border-top: 1px solid var(--border-color);
            padding-top: 5px;
            margin-top: 5px;
        }
        
        .ride-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }
        
        .btn {
            padding: 8px;
            border: none;
            border-radius: var(--element-radius);
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .btn-cancel {
            background: var(--error-red);
            color: var(--white);
        }
        
        .btn-contact {
            background: var(--info-blue);
            color: var(--white);
        }
        
        .screen-content {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 50px;
            background: var(--white);
            z-index: 90;
            padding: var(--app-padding);
            overflow-y: auto;
            display: none;
        }
        
        .screen-content.active {
            display: block;
        }
        
        .screen-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .back-button {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            font-size: 0.9rem;
        }
        
        .screen-title {
            font-size: 1rem;
            font-weight: 700;
        }
        
        .account-section, .history-section, .emergency-section {
            margin-bottom: 15px;
        }
        
        .section-title {
            font-size: 0.85rem;
            margin-bottom: 8px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .input-group {
            margin-bottom: 8px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 600;
            font-size: 0.75rem;
        }
        
        .input-field {
            width: 100%;
            padding: 8px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 0.75rem;
            transition: all var(--transition-speed) ease;
        }
        
        .input-field:focus {
            outline: none;
            border-color: var(--primary-orange);
        }
        
        .wallet-balance {
            background: var(--primary-gradient);
            color: var(--white);
            padding: 10px;
            border-radius: var(--element-radius);
            text-align: center;
            margin-bottom: 10px;
        }
        
        .balance-label {
            font-size: 0.7rem;
            margin-bottom: 2px;
        }
        
        .balance-amount-large {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 5px;
        }
        
        .wallet-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin-bottom: 10px;
        }
        
        .btn-wallet {
            background: var(--white);
            color: var(--primary-orange);
            border: 2px solid var(--primary-orange);
            padding: 6px;
            font-size: 0.7rem;
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .btn-wallet:hover {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .history-item {
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            font-size: 0.7rem;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-item:hover {
            background: var(--light-orange);
        }
        
        .history-locations {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .history-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.65rem;
            color: var(--medium-gray);
        }
        
        .status-badge {
            padding: 2px 5px;
            border-radius: 10px;
            font-size: 0.6rem;
            font-weight: 700;
        }
        
        .status-completed {
            background: #e6f7e9;
            color: #2e7d32;
        }
        
        .status-cancelled {
            background: #ffebee;
            color: #c62828;
        }
        
        .status-requested {
            background: #fff3e0;
            color: #ef6c00;
        }
        
        .status-accepted {
            background: #e3f2fd;
            color: #1565c0;
        }
        
        .notification {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-gradient);
            color: var(--white);
            padding: 8px 14px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 300;
            display: none;
            font-weight: 600;
            text-align: center;
            font-size: 0.75rem;
            max-width: 80%;
        }
        
        .ride-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: var(--white);
            padding: 6px 10px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 700;
            color: var(--dark-gray);
            border: 2px solid var(--border-color);
            font-size: 0.75rem;
            display: none;
        }
        
        .status-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: var(--medium-gray);
        }
        
        .status-dot.searching {
            background: var(--warning-yellow);
            animation: pulse 2s infinite;
        }
        
        .status-dot.arriving {
            background: var(--info-blue);
            animation: pulse 1.5s infinite;
        }
        
        .status-dot.riding {
            background: var(--success-green);
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .estimated-time {
            position: fixed;
            top: 50px;
            right: 10px;
            background: var(--white);
            padding: 6px 10px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 700;
            color: var(--dark-gray);
            border: 2px solid var(--border-color);
            font-size: 0.75rem;
            display: none;
        }
        
        .saved-locations {
            display: flex;
            gap: 6px;
            margin: 8px 0;
        }
        
        .saved-location-btn {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
            cursor: pointer;
            font-size: 0.65rem;
            transition: all var(--transition-speed) ease;
        }
        
        .saved-location-btn:hover {
            background: var(--light-orange);
            border-color: var(--primary-orange);
        }
        
        .suggestion-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-medium);
            z-index: 200;
            max-height: 180px;
            overflow-y: auto;
            display: none;
        }
        
        .suggestion-item {
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .suggestion-item:hover {
            background: var(--light-orange);
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
        
        .suggestion-icon {
            font-size: 0.9rem;
            width: 18px;
            text-align: center;
        }
        
        .suggestion-details {
            flex: 1;
        }
        
        .suggestion-name {
            font-weight: 600;
            font-size: 0.75rem;
        }
        
        .suggestion-address {
            color: var(--medium-gray);
            font-size: 0.65rem;
        }
        
        .suggestion-distance {
            color: var(--medium-gray);
            font-size: 0.55rem;
            margin-top: 2px;
        }
        
        .loading-text {
            text-align: center;
            padding: 15px;
            color: var(--medium-gray);
        }
        
        .no-places {
            text-align: center;
            padding: 15px;
            color: var(--medium-gray);
        }
        
        .filter-options {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .filter-options select, .filter-options input {
            flex: 1;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .stat-card {
            background: var(--light-gray);
            padding: 10px;
            border-radius: var(--element-radius);
            text-align: center;
        }
        
        .stat-number {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        .stat-label {
            font-size: 0.65rem;
            color: var(--medium-gray);
        }
        
        .referral-section {
            background: var(--light-orange);
            padding: 12px;
            border-radius: var(--element-radius);
            margin-bottom: 12px;
        }
        
        .referral-code {
            background: var(--white);
            padding: 8px;
            border-radius: var(--element-radius);
            text-align: center;
            margin: 8px 0;
        }
        
        .code {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        .description {
            font-size: 0.65rem;
            color: var(--medium-gray);
            margin-top: 4px;
        }
        
        .contact-section {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .contact-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: var(--element-radius);
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .contact-btn.whatsapp {
            background: #25D366;
            color: white;
        }
        
        .contact-btn.phone {
            background: var(--info-blue);
            color: white;
        }
        
        .rating-stars {
            display: flex;
            gap: 4px;
            margin-top: 4px;
        }
        
        .star {
            font-size: 1.3rem;
            color: var(--light-gray);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .star.active {
            color: var(--warning-yellow);
        }
        
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
        }
        
        .popup-overlay.hidden {
            display: none;
        }
        
        .popup-form {
            background: var(--white);
            border-radius: var(--element-radius);
            width: 100%;
            max-width: 450px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: var(--shadow-heavy);
        }
        
        .large-popup {
            max-width: 700px;
        }
        
        .popup-header {
            display: flex;
            align-items: center;
            justify-content: between;
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .popup-title {
            font-size: 1.1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .close-popup {
            background: none;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            color: var(--medium-gray);
        }
        
        .popup-content {
            padding: 12px;
        }
        
        .popup-map-container {
            height: 180px;
            border-radius: var(--element-radius);
            overflow: hidden;
            margin-bottom: 12px;
        }
        
        .popup-details {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .detail-row:last-child {
            border-bottom: none;
        }
        
        .detail-label {
            font-weight: 600;
            font-size: 0.75rem;
        }
        
        .detail-value {
            font-size: 0.75rem;
            color: var(--medium-gray);
        }
        
        .driver-details-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }
        
        .popup-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 12px;
        }
        
        /* Payment Selection Popup */
        .payment-selection-popup {
            max-width: 350px;
        }
        
        .payment-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            margin-bottom: 8px;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .payment-option.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .payment-option-icon {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            color: var(--medium-gray);
        }
        
        .payment-option.selected .payment-option-icon {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .payment-option-details {
            flex: 1;
        }
        
        .payment-option-name {
            font-weight: 600;
            font-size: 0.85rem;
        }
        
        .payment-option-description {
            color: var(--medium-gray);
            font-size: 0.7rem;
        }
        
        .payment-option-balance {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--primary-orange);
        }
        
        .confirm-payment-btn {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: var(--element-radius);
            background: var(--primary-gradient);
            color: var(--white);
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            margin-top: 12px;
        }
        
        .confirm-payment-btn:disabled {
            background: var(--medium-gray);
            cursor: not-allowed;
        }
        
        .insufficient-balance {
            color: var(--error-red);
            font-size: 0.75rem;
            margin-top: 4px;
            display: none;
        }
        
        /* Package Delivery Form */
        .package-form {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
            display: none;
        }
        
        .package-form.active {
            display: block;
        }
        
        .form-row {
            display: flex;
            gap: 6px;
            margin-bottom: 6px;
        }
        
        .form-group {
            flex: 1;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 3px;
            font-weight: 600;
            font-size: 0.7rem;
        }
        
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 6px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 0.7rem;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 50px;
        }
        
        .package-toggle {
            width: 100%;
            padding: 6px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .driver-details-card {
            background: var(--light-orange);
            padding: 10px;
            border-radius: var(--element-radius);
            margin-bottom: 10px;
            border: 1px solid var(--primary-orange);
        }
        
        .driver-details-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 6px;
        }
        
        .driver-details-header h3 {
            font-size: 0.85rem;
            color: var(--primary-orange);
        }
        
        .driver-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }
        
        .driver-detail-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .driver-detail-label {
            font-size: 0.65rem;
            color: var(--medium-gray);
            font-weight: 600;
        }
        
        .driver-detail-value {
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .driver-vehicle-details {
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px dashed var(--border-color);
        }
        
        .vehicle-detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
            font-size: 0.65rem;
        }
        
        .vehicle-detail-label {
            color: var(--medium-gray);
        }
        
        .vehicle-detail-value {
            font-weight: 600;
        }
        
        /* Enhanced History Item */
        .history-item-type {
            font-size: 0.65rem;
            font-weight: 600;
            padding: 2px 5px;
            border-radius: 8px;
            margin-bottom: 4px;
            display: inline-block;
        }
        
        .history-item-type.ride {
            background: var(--light-orange);
            color: var(--primary-orange);
        }
        
        .history-item-type.delivery {
            background: var(--light-red);
            color: var(--primary-red);
        }
        
        .history-item-type.emergency {
            background: var(--light-red);
            color: var(--emergency-red);
        }
        
        .history-item-type.premium {
            background: linear-gradient(135deg, #fff9c4, #fff59d);
            color: #b8860b;
        }
        
        .history-item-type.economy {
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            color: var(--economy-green);
        }
        
        .history-item-type.truck {
            background: linear-gradient(135deg, #efebe9, #d7ccc8);
            color: var(--truck-brown);
        }
        
        .history-package-details {
            background: var(--light-gray);
            padding: 6px;
            border-radius: var(--element-radius);
            margin: 6px 0;
            font-size: 0.65rem;
        }
        
        .package-detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
        }
        
        .package-detail-label {
            font-weight: 600;
            color: var(--medium-gray);
        }
        
        .package-detail-value {
            color: var(--dark-gray);
        }
        
        .history-driver-info {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px dashed var(--border-color);
        }
        
        .history-driver-avatar {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            color: var(--white);
            font-weight: 700;
        }
        
        .history-driver-details {
            flex: 1;
        }
        
        .history-driver-name {
            font-size: 0.65rem;
            font-weight: 600;
        }
        
        .history-driver-rating {
            font-size: 0.55rem;
            color: var(--medium-gray);
        }
        
        .history-fare {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        /* Driver Search Animation */
        .searching-animation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 200;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .searching-pulse {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(255, 107, 53, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse-ring 2s infinite;
            position: relative;
        }
        
        .searching-pulse-inner {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }
        
        .searching-text {
            margin-top: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 12px;
            border-radius: var(--element-radius);
            font-weight: 600;
            color: var(--primary-orange);
            box-shadow: var(--shadow-medium);
        }
        
        @keyframes pulse-ring {
            0% {
                transform: scale(0.8);
                opacity: 1;
            }
            80%, 100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }
        
        /* Receipt Styles */
        .receipt-popup {
            max-width: 400px;
        }
        
        .receipt-content {
            font-family: 'Courier New', monospace;
            background: white;
            padding: 20px;
            border-radius: var(--element-radius);
            border: 2px solid var(--border-color);
        }
        
        .receipt-header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px dashed var(--border-color);
            padding-bottom: 10px;
        }
        
        .receipt-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-orange);
            margin-bottom: 5px;
        }
        
        .receipt-subtitle {
            font-size: 0.8rem;
            color: var(--medium-gray);
        }
        
        .receipt-details {
            margin-bottom: 20px;
        }
        
        .receipt-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        
        .receipt-row.total {
            font-weight: 700;
            font-size: 1.1rem;
            border-top: 2px solid var(--border-color);
            padding-top: 10px;
            margin-top: 10px;
        }
        
        .receipt-footer {
            text-align: center;
            margin-top: 20px;
            padding-top: 10px;
            border-top: 2px dashed var(--border-color);
            font-size: 0.8rem;
            color: var(--medium-gray);
        }
        
        .print-receipt-btn {
            width: 100%;
            padding: 12px;
            background: var(--primary-orange);
            color: white;
            border: none;
            border-radius: var(--element-radius);
            font-weight: 700;
            cursor: pointer;
            margin-top: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        /* Enhanced Address Display */
        .address-details {
            font-size: 0.7rem;
            color: var(--medium-gray);
            margin-top: 2px;
        }
        
        .address-component {
            display: inline-block;
            background: var(--light-gray);
            padding: 1px 4px;
            border-radius: 3px;
            margin-right: 3px;
            margin-bottom: 2px;
        }
        
        .address-house {
            background: var(--light-orange);
            color: var(--primary-orange);
        }
        
        .address-road {
            background: var(--light-gray);
            color: var(--dark-gray);
        }
        
        .address-area {
            background: #e3f2fd;
            color: var(--info-blue);
        }
        
        .address-city {
            background: #e8f5e9;
            color: var(--economy-green);
        }
        
        /* Advanced Search Results */
        .search-result-details {
            font-size: 0.6rem;
            color: var(--medium-gray);
            margin-top: 2px;
        }
        
        .search-result-type {
            display: inline-block;
            background: var(--light-orange);
            padding: 1px 4px;
            border-radius: 3px;
            margin-right: 3px;
            font-size: 0.55rem;
        }
        
        /* City Filter Badge */
        .city-filter-badge {
            display: inline-block;
            background: var(--primary-orange);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.6rem;
            margin-left: 5px;
            font-weight: 600;
        }
        
        /* Emergency Ride Status */
        .emergency-ride-status {
            background: var(--emergency-red);
            color: white;
            animation: emergency-pulse 1s infinite;
        }
        
        @keyframes emergency-pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        /* Emergency Vehicle Icons */
        .emergency-vehicle-icon {
            position: absolute;
            z-index: 100;
            font-size: 1.5rem;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }
        
        .ambulance-icon {
            color: var(--ambulance-red);
        }
        
        .fire-truck-icon {
            color: var(--fire-truck-red);
        }
        
        .police-icon {
            color: var(--police-blue);
        }
        
        /* Ride Type Badges */
        .ride-type-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.6rem;
            font-weight: 700;
            margin-left: 5px;
        }
        
        .premium-badge {
            background: linear-gradient(135deg, var(--premium-gold), #ffca28);
            color: var(--dark-gray);
        }
        
        .economy-badge {
            background: linear-gradient(135deg, var(--economy-green), #2ecc71);
            color: white;
        }
        
        .standard-badge {
            background: linear-gradient(135deg, var(--standard-blue), #2980b9);
            color: white;
        }
        
        .truck-badge {
            background: linear-gradient(135deg, var(--truck-brown), #a1887f);
            color: white;
        }
        
        .emergency-badge {
            background: linear-gradient(135deg, var(--emergency-red), #c0392b);
            color: white;
        }
        
        @media (max-width: 480px) {
            .floating-balance, .ride-status {
                padding: 5px 7px;
                font-size: 0.65rem;
            }
            
            .passenger-panel {
                padding: 8px;
            }
            
            .nav-buttons {
                gap: 3px;
            }
            
            .nav-btn {
                padding: 5px 2px;
                font-size: 0.55rem;
            }
            
            .emergency-options {
                grid-template-columns: 1fr;
            }
            
            .ride-type-options {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Main App -->
    <div id="mainApp">
        <!-- OpenLayers Map -->
        <div id="map"></div>
        
        <!-- Map Controls -->
        <div class="map-controls">
            <button class="map-control-btn" id="locateMeBtn" title="Locate Me">
                <i class="fas fa-location-arrow"></i>
            </button>
            <button class="map-control-btn" id="zoomInBtn" title="Zoom In">
                <i class="fas fa-plus"></i>
            </button>
            <button class="map-control-btn" id="zoomOutBtn" title="Zoom Out">
                <i class="fas fa-minus"></i>
            </button>
        </div>
        
        <!-- Floating Balance -->
        <div class="floating-balance home-only">
            <i class="fas fa-wallet"></i>
            <span>Balance: <span class="balance-amount" id="walletBalance">K0.00</span></span>
        </div>
        
        <!-- Ride Status -->
        <div class="ride-status home-only" id="rideStatus">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Searching for driver</span>
        </div>
        
        <!-- Estimated Time -->
        <div class="estimated-time home-only" id="estimatedTime">
            <i class="fas fa-clock"></i>
            <span id="timeText">5 min</span>
        </div>
        
        <!-- SOS Button -->
        <div class="sos-button" id="sosButton">
            SOS
        </div>
        
        <!-- Driver Search Animation -->
        <div class="searching-animation" id="searchingAnimation">
            <div class="searching-pulse">
                <div class="searching-pulse-inner">
                    <i class="fas fa-car"></i>
                </div>
            </div>
            <div class="searching-text">Searching for driver</div>
        </div>
        
        <!-- Passenger Panel -->
        <div class="passenger-panel" id="passengerPanel">
            <div class="panel-collapse-handle" id="panelCollapseHandle"></div>
            
            <div class="nav-buttons">
                <button class="nav-btn active" data-screen="home">
                    <i class="fas fa-home"></i>
                    <span>Home</span>
                </button>
                <button class="nav-btn" data-screen="account">
                    <i class="fas fa-user"></i>
                    <span>Account</span>
                </button>
                <button class="nav-btn" data-screen="history">
                    <i class="fas fa-history"></i>
                    <span>History</span>
                </button>
                <button class="nav-btn" data-screen="emergency">
                    <i class="fas fa-ambulance"></i>
                    <span>Emergency</span>
                </button>
            </div>
            
            <!-- Emergency Button -->
            <button class="emergency-btn" id="emergencyBtn">
                <i class="fas fa-exclamation-triangle"></i>
                EMERGENCY
            </button>
            
            <!-- More Options Button -->
            <button class="more-options-btn" id="moreOptionsBtn">
                <i class="fas fa-ellipsis-h"></i>
                More Options
            </button>
            
            <!-- More Options Dropdown -->
            <div class="more-options-dropdown" id="moreOptionsDropdown">
                <div class="more-option-item" data-option="order-for-someone">
                    <div class="more-option-icon">
                        <i class="fas fa-user-friends"></i>
                    </div>
                    <div class="more-option-text">Order for Someone Else</div>
                </div>
                <div class="more-option-item" data-option="express-delivery">
                    <div class="more-option-icon">
                        <i class="fas fa-shipping-fast"></i>
                    </div>
                    <div class="more-option-text">Express Delivery</div>
                </div>
                <div class="more-option-item" data-option="sos-setup">
                    <div class="more-option-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="more-option-text">SOS Setup</div>
                </div>
            </div>
            
            <!-- Home Screen Content -->
            <div id="homeScreenContent">
                <!-- Order for Someone Else Form -->
                <div class="order-for-someone-form" id="orderForSomeoneForm">
                    <h4 class="section-title">Order for Someone Else</h4>
                    
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="recipientPickupLocation" placeholder="Pickup location">
                        <div class="suggestion-list" id="recipientPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="recipientDestinationLocation" placeholder="Drop-off location">
                        <div class="suggestion-list" id="recipientDestinationSuggestions"></div>
                    </div>
                    
                    <div class="input-group">
                        <label for="recipientName">Recipient's Full Name</label>
                        <input type="text" id="recipientName" class="input-field" placeholder="Full name">
                    </div>
                    
                    <div class="input-group">
                        <label for="recipientEmail">Recipient's Email</label>
                        <input type="email" id="recipientEmail" class="input-field" placeholder="Email address">
                    </div>
                    
                    <div class="input-group">
                        <label for="recipientPhone">Recipient's Phone Number</label>
                        <input type="tel" id="recipientPhone" class="input-field" placeholder="Phone number">
                    </div>
                    
                    <div class="delivery-fee-display">
                        <p>Delivery Fee</p>
                        <div class="delivery-fee-amount" id="recipientDeliveryFee">K0.00</div>
                        <p class="delivery-eta-display" id="recipientEtaDisplay">ETA: -- min</p>
                    </div>
                    
                    <button class="request-ride-btn" id="orderForSomeoneBtn">Book Ride</button>
                    <button class="btn btn-cancel" id="cancelOrderForSomeoneBtn">Cancel</button>
                </div>
                
                <!-- Express Delivery Form -->
                <div class="express-delivery-form" id="expressDeliveryForm">
                    <h4 class="section-title">Express Delivery</h4>
                    
                    <div class="input-group">
                        <label for="shopName">Shop or Restaurant Name</label>
                        <input type="text" id="shopName" class="input-field" placeholder="Name of shop or restaurant">
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="shopLocation" placeholder="Shop location">
                        <div class="suggestion-list" id="shopLocationSuggestions"></div>
                    </div>
                    
                    <div class="input-group">
                        <label for="deliveryItems">Items to Purchase</label>
                        <textarea id="deliveryItems" class="input-field" placeholder="List of items to be purchased"></textarea>
                    </div>
                    
                    <div class="input-group">
                        <label for="deliveryAmount">Total Amount to Spend (K)</label>
                        <input type="number" id="deliveryAmount" class="input-field" placeholder="Total amount">
                    </div>
                    
                    <div class="input-group">
                        <label for="deliveryInstructions">Special Instructions</label>
                        <textarea id="deliveryInstructions" class="input-field" placeholder="Any special instructions"></textarea>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="deliveryDestination" placeholder="Delivery destination">
                        <div class="suggestion-list" id="deliveryDestinationSuggestions"></div>
                    </div>
                    
                    <div class="vehicle-selection">
                        <div class="vehicle-option" data-type="car">
                            <i class="fas fa-car vehicle-icon"></i>
                            <span class="vehicle-name">Car</span>
                            <span class="vehicle-price">Fast & Secure</span>
                        </div>
                        <div class="vehicle-option selected" data-type="bike">
                            <i class="fas fa-motorcycle vehicle-icon"></i>
                            <span class="vehicle-name">Bike</span>
                            <span class="vehicle-price">Quick Delivery</span>
                        </div>
                        <div class="vehicle-option" data-type="bicycle">
                            <i class="fas fa-bicycle vehicle-icon"></i>
                            <span class="vehicle-name">Bicycle</span>
                            <span class="vehicle-price">Eco Friendly</span>
                        </div>
                    </div>
                    
                    <div class="delivery-fee-display">
                        <p>Delivery Fee</p>
                        <div class="delivery-fee-amount" id="expressDeliveryFee">K0.00</div>
                        <p class="delivery-eta-display" id="expressDeliveryEtaDisplay">ETA: -- min</p>
                    </div>
                    
                    <button class="request-ride-btn" id="expressDeliveryBtn">Request Delivery</button>
                    <button class="btn btn-cancel" id="cancelExpressDeliveryBtn">Cancel</button>
                </div>
                
                <!-- SOS Setup Form -->
                <div class="sos-setup-form" id="sosSetupForm">
                    <h4 class="section-title">SOS Setup</h4>
                    
                    <div class="input-group">
                        <label for="emergencyContact1">Emergency Contact 1</label>
                        <input type="tel" id="emergencyContact1" class="input-field" placeholder="Phone number">
                    </div>
                    
                    <div class="input-group">
                        <label for="emergencyContact2">Emergency Contact 2</label>
                        <input type="tel" id="emergencyContact2" class="input-field" placeholder="Phone number">
                    </div>
                    
                    <div class="input-group">
                        <label for="sosMessage">Emergency Message</label>
                        <textarea id="sosMessage" class="input-field" placeholder="Pre-typed emergency message">I need help! My current location and ride details will be shared with you.</textarea>
                    </div>
                    
                    <button class="request-ride-btn" id="saveSosBtn">Save SOS Configuration</button>
                    <button class="btn btn-cancel" id="cancelSosSetupBtn">Cancel</button>
                </div>
                
                <!-- Original Ride Request Form -->
                <div class="ride-request-form" id="rideRequestForm">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="pickupLocation" placeholder="Current location" readonly>
                    </div>
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="destinationLocation" placeholder="Where to?">
                        <div class="suggestion-list" id="destinationSuggestions"></div>
                    </div>
                    
                    <div class="saved-locations">
                        <button class="saved-location-btn" data-address="home">
                            <i class="fas fa-home"></i>
                            Home
                        </button>
                        <button class="saved-location-btn" data-address="work">
                            <i class="fas fa-briefcase"></i>
                            Work
                        </button>
                    </div>
                    
                    <!-- Ride Type Selection -->
                    <div class="ride-type-selection" id="rideTypeSelection">
                        <h4 class="section-title">Select Ride Type</h4>
                        <div class="ride-type-options">
                            <div class="ride-type-option premium selected" data-type="premium">
                                <div class="ride-type-icon"></div>
                                <div class="ride-type-name">Premium</div>
                                <div class="ride-type-price">Luxury Cars</div>
                            </div>
                            <div class="ride-type-option economy" data-type="economy">
                                <div class="ride-type-icon"></div>
                                <div class="ride-type-name">Economy</div>
                                <div class="ride-type-price">Budget Friendly</div>
                            </div>
                            <div class="ride-type-option standard" data-type="standard">
                                <div class="ride-type-icon"></div>
                                <div class="ride-type-name">Standard</div>
                                <div class="ride-type-price">Regular Cars</div>
                            </div>
                            <div class="ride-type-option truck" data-type="truck">
                                <div class="ride-type-icon"></div>
                                <div class="ride-type-name">Truck</div>
                                <div class="ride-type-price">Large Items</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Package Delivery Form -->
                    <button class="package-toggle" id="packageToggle" style="display: none;">
                        <i class="fas fa-box"></i>
                        Add Package Details
                    </button>
                    
                    <div class="package-form" id="packageForm">
                        <h4 class="section-title">Package Delivery Details</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="receiverName">Receiver Name</label>
                                <input type="text" id="receiverName" placeholder="Full name of receiver">
                            </div>
                            <div class="form-group">
                                <label for="receiverPhone">Receiver Phone</label>
                                <input type="tel" id="receiverPhone" placeholder="Phone number">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="packageDescription">Package Description</label>
                            <input type="text" id="packageDescription" placeholder="What is being delivered?">
                        </div>
                        <div class="form-group">
                            <label for="specialInstructions">Special Instructions</label>
                            <textarea id="specialInstructions" placeholder="Any special handling instructions?"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="packageValue">Package Value (K)</label>
                            <input type="number" id="packageValue" placeholder="Estimated value for insurance">
                        </div>
                    </div>
                    
                    <button class="promo-toggle" id="promoToggle">
                        <i class="fas fa-tag"></i>
                        Apply Promo Coupon
                    </button>
                    
                    <div class="promo-section" id="promoSection">
                        <div class="promo-input">
                            <input type="text" id="promoCode" placeholder="Promo code">
                            <button class="btn-promo" id="applyPromoBtn">Apply</button>
                        </div>
                    </div>
                    
                    <div class="fare-display">
                        <p>Estimated Fare</p>
                        <div class="fare-amount" id="estimatedFare">K0.00</div>
                        <p class="eta-display" id="etaDisplay">ETA: -- min</p>
                    </div>
                    
                    <button class="request-ride-btn" id="requestRideBtn">Request Ride</button>
                </div>
                
                <!-- Ride Info Panel -->
                <div class="ride-info-panel" id="rideInfoPanel">
                    <div class="driver-details-card" id="driverDetailsCard" style="display: none;">
                        <div class="driver-details-header">
                            <i class="fas fa-id-card"></i>
                            <h3>Driver Details</h3>
                        </div>
                        <div class="driver-details-grid">
                            <div class="driver-detail-item">
                                <span class="driver-detail-label">Driver Name</span>
                                <span class="driver-detail-value" id="driverFullName">John Doe</span>
                            </div>
                            <div class="driver-detail-item">
                                <span class="driver-detail-label">Phone</span>
                                <span class="driver-detail-value" id="driverContactPhone">+260 123 456 789</span>
                            </div>
                            <div class="driver-detail-item">
                                <span class="driver-detail-label">Rating</span>
                                <span class="driver-detail-value" id="driverRatingValue">4.8 </span>
                            </div>
                            <div class="driver-detail-item">
                                <span class="driver-detail-label">Experience</span>
                                <span class="driver-detail-value" id="driverExperience">2 years</span>
                            </div>
                        </div>
                        <div class="driver-vehicle-details">
                            <div class="vehicle-detail-row">
                                <span class="vehicle-detail-label">Vehicle Type</span>
                                <span class="vehicle-detail-value" id="vehicleType">Car</span>
                            </div>
                            <div class="vehicle-detail-row">
                                <span class="vehicle-detail-label">Vehicle Model</span>
                                <span class="vehicle-detail-value" id="vehicleModel">Toyota Corolla</span>
                            </div>
                            <div class="vehicle-detail-row">
                                <span class="vehicle-detail-label">License Plate</span>
                                <span class="vehicle-detail-value" id="vehicleLicense">ABC 123</span>
                            </div>
                            <div class="vehicle-detail-row">
                                <span class="vehicle-detail-label">Color</span>
                                <span class="vehicle-detail-value" id="vehicleColor">Blue</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="driver-info">
                        <div class="driver-avatar" id="driverAvatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="driver-details">
                            <h2 id="driverName">Driver Name</h2>
                            <p><i class="fas fa-phone"></i> <span id="driverPhone">000-000-0000</span></p>
                            <p><i class="fas fa-car"></i> <span id="vehicleDetails">Toyota Corolla - ABC123</span></p>
                            <p><i class="fas fa-star"></i> <span id="driverRating">4.5 </span></p>
                        </div>
                    </div>
                    
                    <div class="trip-details">
                        <div class="location-row">
                            <div class="location-icon pickup-icon">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="location-text">
                                <h4>Pickup Location</h4>
                                <p id="currentPickupLocation">123 Main Street, City</p>
                                <div id="pickupAddressDetails" class="address-details"></div>
                            </div>
                        </div>
                        <div class="location-row">
                            <div class="location-icon destination-icon">
                                <i class="fas fa-flag"></i>
                            </div>
                            <div class="location-text">
                                <h4>Destination</h4>
                                <p id="currentDestinationLocation">456 Oak Avenue, City</p>
                                <div id="destinationAddressDetails" class="address-details"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="fare-details">
                        <div class="fare-row">
                            <span>Base Fare</span>
                            <span id="baseFare">K15.00</span>
                        </div>
                        <div class="fare-row">
                            <span>Distance</span>
                            <span id="distanceFare">K5.00</span>
                        </div>
                        <div class="fare-row">
                            <span>Discount</span>
                            <span id="discountFare">-K2.00</span>
                        </div>
                        <div class="fare-row total">
                            <span>Total Fare</span>
                            <span id="totalFare">K18.00</span>
                        </div>
                    </div>
                    
                    <div class="ride-actions">
                        <button class="btn btn-cancel" id="cancelRideBtn">
                            <i class="fas fa-times-circle"></i>
                            Cancel Ride
                        </button>
                        <button class="btn btn-contact" id="contactDriverBtn">
                            <i class="fas fa-phone"></i>
                            Contact Driver
                        </button>
                        <button class="btn btn-primary" id="downloadReceiptBtn" style="display: none;">
                            <i class="fas fa-receipt"></i>
                            Receipt
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Screen Contents -->
        <div class="screen-content" id="homeScreen">
            <!-- Home screen is the map, so this is empty -->
        </div>
        
        <div class="screen-content" id="accountScreen">
            <div class="screen-header">
                <button class="back-button" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="screen-title">Account</h2>
            </div>
            
            <div class="account-section">
                <div class="account-header">
                    <div class="driver-avatar" id="accountAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="driver-details">
                        <h2 id="accountName">Passenger</h2>
                        <p><i class="fas fa-phone"></i> <span id="accountPhone">Not set</span></p>
                        <p><i class="fas fa-envelope"></i> <span id="accountEmail">Not set</span></p>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="ridesCompleted">0</div>
                        <div class="stat-label">Completed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="ridesCancelled">0</div>
                        <div class="stat-label">Cancelled</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="ridesPending">0</div>
                        <div class="stat-label">Pending</div>
                    </div>
                </div>
                
                <div class="referral-section">
                    <h3 class="section-title">
                        <i class="fas fa-share-alt"></i>
                        Refer & Earn
                    </h3>
                    <p>Share your code and get K25 when friends complete their first ride</p>
                    <div class="referral-code">
                        <div class="code" id="referralCode">JUBEL-XXXX</div>
                        <div class="description">50% discount for new users</div>
                    </div>
                    <button class="btn btn-primary" id="shareReferralBtn">
                        <i class="fas fa-share"></i>
                        Share Referral Code
                    </button>
                </div>
                
                <div class="wallet-section">
                    <h3 class="section-title">
                        <i class="fas fa-wallet"></i>
                        Jubel Wallet
                    </h3>
                    <div class="wallet-balance">
                        <div class="balance-label">Current Balance</div>
                        <div class="balance-amount-large" id="accountBalance">K0.00</div>
                    </div>
                    <div class="wallet-actions">
                        <button class="btn-wallet" id="depositBtn">
                            <i class="fas fa-plus"></i>
                            Deposit
                        </button>
                        <button class="btn-wallet" id="withdrawBtn">
                            <i class="fas fa-minus"></i>
                            Withdraw
                        </button>
                    </div>
                </div>
                
                <div class="contact-section">
                    <button class="contact-btn whatsapp" id="whatsappBtn">
                        <i class="fab fa-whatsapp"></i>
                        WhatsApp
                    </button>
                    <button class="contact-btn phone" id="callBtn">
                        <i class="fas fa-phone"></i>
                        Call Us
                    </button>
                </div>
            </div>
        </div>
        
        <div class="screen-content" id="historyScreen">
            <div class="screen-header">
                <button class="back-button" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="screen-title">Ride History</h2>
            </div>
            
            <div class="filter-options">
                <select id="historyFilter" class="input-field">
                    <option value="all">All Rides</option>
                    <option value="requested">Awaiting Driver</option>
                    <option value="accepted">In Progress</option>
                    <option value="completed">Completed</option>
                    <option value="cancelled">Cancelled</option>
                    <option value="emergency">Emergency</option>
                    <option value="premium">Premium</option>
                    <option value="economy">Economy</option>
                    <option value="truck">Truck</option>
                </select>
                <input type="date" id="historyDate" class="input-field">
            </div>
            
            <div class="history-section">
                <div id="historyList">
                    <div class="loading-text">
                        <i class="fas fa-spinner fa-spin"></i>
                        Loading ride history...
                    </div>
                </div>
            </div>
        </div>
        
        <div class="screen-content" id="emergencyScreen">
            <div class="screen-header">
                <button class="back-button" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="screen-title">Emergency Services</h2>
            </div>
            
            <div class="emergency-section">
                <h3 class="section-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    Quick Emergency Access
                </h3>
                
                <div class="emergency-options">
                    <div class="emergency-option ambulance" data-emergency="ambulance">
                        <div class="emergency-icon">
                            <i class="fas fa-ambulance"></i>
                        </div>
                        <div class="emergency-title">Ambulance</div>
                        <div class="emergency-description">Medical emergency assistance</div>
                    </div>
                    
                    <div class="emergency-option fire-truck" data-emergency="fire-truck">
                        <div class="emergency-icon">
                            <i class="fas fa-fire-extinguisher"></i>
                        </div>
                        <div class="emergency-title">Fire Truck</div>
                        <div class="emergency-description">Fire emergency response</div>
                    </div>
                    
                    <div class="emergency-option police" data-emergency="police">
                        <div class="emergency-icon">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <div class="emergency-title">Police</div>
                        <div class="emergency-description">Security emergency</div>
                    </div>
                    
                    <div class="emergency-option emergency-ride" data-emergency="emergency-ride">
                        <div class="emergency-icon">
                            <i class="fas fa-car-crash"></i>
                        </div>
                        <div class="emergency-title">Emergency Ride</div>
                        <div class="emergency-description">Urgent transportation</div>
                    </div>
                    
                    <div class="emergency-option emergency-delivery" data-emergency="emergency-delivery">
                        <div class="emergency-icon">
                            <i class="fas fa-shipping-fast"></i>
                        </div>
                        <div class="emergency-title">Emergency Delivery</div>
                        <div class="emergency-description">Urgent medical supplies</div>
                    </div>
                </div>
                
                <div class="emergency-questionnaire" id="emergencyQuestionnaire">
                    <h4 class="section-title" id="emergencyQuestionnaireTitle">Emergency Details</h4>
                    
                    <div class="emergency-question">
                        <label for="emergencyType">Type of Emergency:</label>
                        <input type="text" id="emergencyType" readonly>
                    </div>
                    
                    <div class="emergency-question">
                        <label for="emergencyDescription">Describe the emergency:</label>
                        <textarea id="emergencyDescription" placeholder="Please describe what happened and what help is needed..."></textarea>
                    </div>
                    
                    <div class="emergency-question">
                        <label for="numberOfPeople">Number of people affected:</label>
                        <select id="numberOfPeople">
                            <option value="1">1 person</option>
                            <option value="2">2 people</option>
                            <option value="3">3 people</option>
                            <option value="4">4 people</option>
                            <option value="5">5+ people</option>
                        </select>
                    </div>
                    
                    <div class="emergency-question">
                        <label for="emergencySeverity">Severity level:</label>
                        <select id="emergencySeverity">
                            <option value="low">Low - Non-urgent</option>
                            <option value="medium">Medium - Urgent</option>
                            <option value="high">High - Critical</option>
                            <option value="critical">Critical - Life-threatening</option>
                        </select>
                    </div>
                    
                    <div class="emergency-question">
                        <label for="additionalInfo">Additional information:</label>
                        <textarea id="additionalInfo" placeholder="Any other important information..."></textarea>
                    </div>
                    
                    <button class="emergency-submit-btn" id="submitEmergencyBtn">
                        <i class="fas fa-paper-plane"></i>
                        Send Emergency Request
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Emergency Popup -->
    <div id="emergencyPopup" class="popup-overlay hidden">
        <div class="popup-form emergency-popup">
            <div class="popup-header">
                <h2 class="popup-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    Emergency Services
                </h2>
                <button class="close-popup" id="closeEmergencyPopup">&times;</button>
            </div>
            <div class="popup-content">
                <div class="emergency-options">
                    <div class="emergency-option ambulance" data-emergency="ambulance">
                        <div class="emergency-icon">
                            <i class="fas fa-ambulance"></i>
                        </div>
                        <div class="emergency-title">Ambulance</div>
                        <div class="emergency-description">Medical emergency assistance</div>
                    </div>
                    
                    <div class="emergency-option fire-truck" data-emergency="fire-truck">
                        <div class="emergency-icon">
                            <i class="fas fa-fire-extinguisher"></i>
                        </div>
                        <div class="emergency-title">Fire Truck</div>
                        <div class="emergency-description">Fire emergency response</div>
                    </div>
                    
                    <div class="emergency-option police" data-emergency="police">
                        <div class="emergency-icon">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <div class="emergency-title">Police</div>
                        <div class="emergency-description">Security emergency</div>
                    </div>
                    
                    <div class="emergency-option emergency-ride" data-emergency="emergency-ride">
                        <div class="emergency-icon">
                            <i class="fas fa-car-crash"></i>
                        </div>
                        <div class="emergency-title">Emergency Ride</div>
                        <div class="emergency-description">Urgent transportation</div>
                    </div>
                    
                    <div class="emergency-option emergency-delivery" data-emergency="emergency-delivery">
                        <div class="emergency-icon">
                            <i class="fas fa-shipping-fast"></i>
                        </div>
                        <div class="emergency-title">Emergency Delivery</div>
                        <div class="emergency-description">Urgent medical supplies</div>
                    </div>
                </div>
                
                <div class="emergency-questionnaire" id="popupEmergencyQuestionnaire">
                    <h4 class="section-title" id="popupEmergencyQuestionnaireTitle">Emergency Details</h4>
                    
                    <div class="emergency-question">
                        <label for="popupEmergencyType">Type of Emergency:</label>
                        <input type="text" id="popupEmergencyType" readonly>
                    </div>
                    
                    <div class="emergency-question">
                        <label for="popupEmergencyDescription">Describe the emergency:</label>
                        <textarea id="popupEmergencyDescription" placeholder="Please describe what happened and what help is needed..."></textarea>
                    </div>
                    
                    <div class="emergency-question">
                        <label for="popupNumberOfPeople">Number of people affected:</label>
                        <select id="popupNumberOfPeople">
                            <option value="1">1 person</option>
                            <option value="2">2 people</option>
                            <option value="3">3 people</option>
                            <option value="4">4 people</option>
                            <option value="5">5+ people</option>
                        </select>
                    </div>
                    
                    <div class="emergency-question">
                        <label for="popupEmergencySeverity">Severity level:</label>
                        <select id="popupEmergencySeverity">
                            <option value="low">Low - Non-urgent</option>
                            <option value="medium">Medium - Urgent</option>
                            <option value="high">High - Critical</option>
                            <option value="critical">Critical - Life-threatening</option>
                        </select>
                    </div>
                    
                    <div class="emergency-question">
                        <label for="popupAdditionalInfo">Additional information:</label>
                        <textarea id="popupAdditionalInfo" placeholder="Any other important information..."></textarea>
                    </div>
                    
                    <button class="emergency-submit-btn" id="popupSubmitEmergencyBtn">
                        <i class="fas fa-paper-plane"></i>
                        Send Emergency Request
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Ride Details Popup -->
    <div id="rideDetailsPopup" class="popup-overlay hidden">
        <div class="popup-form large-popup">
            <div class="popup-header">
                <h2 class="popup-title">
                    <i class="fas fa-info-circle"></i>
                    Ride Details
                </h2>
                <button class="close-popup" id="closeRidePopupTop">&times;</button>
            </div>
            <div class="popup-content">
                <div class="popup-map-container" id="popupRideMap"></div>
                <div class="popup-details">
                    <div class="detail-row">
                        <span class="detail-label">Pickup:</span>
                        <span class="detail-value" id="popupRidePickup">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Destination:</span>
                        <span class="detail-value" id="popupRideDestination">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Fare:</span>
                        <span class="detail-value" id="popupRideFare">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Distance:</span>
                        <span class="detail-value" id="popupRideDistance">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Ride Type:</span>
                        <span class="detail-value" id="popupRideType">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Status:</span>
                        <span class="detail-value" id="popupRideStatus">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Date & Time:</span>
                        <span class="detail-value" id="popupRideDate">Loading...</span>
                    </div>
                    
                    <!-- Driver Details Section -->
                    <div id="popupDriverDetails" class="driver-details-section hidden">
                        <h3 class="section-title">Driver Information</h3>
                        <div class="detail-row">
                            <span class="detail-label">Driver Name:</span>
                            <span class="detail-value" id="popupDriverName">Loading...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Phone:</span>
                            <span class="detail-value" id="popupDriverPhone">Loading...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Vehicle:</span>
                            <span class="detail-value" id="popupDriverVehicle">Loading...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Rating:</span>
                            <span class="detail-value" id="popupDriverRating">Loading...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Progress:</span>
                            <span class="detail-value" id="popupDriverProgress">Loading...</span>
                        </div>
                    </div>
                    
                    <div class="popup-actions">
                        <button class="btn btn-primary" id="viewRideReceiptBtn">
                            <i class="fas fa-receipt"></i>
                            View Receipt
                        </button>
                        <button class="btn btn-cancel" id="closeRidePopup">
                            <i class="fas fa-times"></i>
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Receipt Popup -->
    <div id="receiptPopup" class="popup-overlay hidden">
        <div class="popup-form receipt-popup">
            <div class="popup-header">
                <h2 class="popup-title">
                    <i class="fas fa-receipt"></i>
                    Ride Receipt
                </h2>
                <button class="close-popup" id="closeReceiptPopup">&times;</button>
            </div>
            <div class="popup-content">
                <div class="receipt-content" id="receiptContent">
                    <div class="receipt-header">
                        <div class="receipt-title">JUBEL</div>
                        <div class="receipt-subtitle">Transport & Delivery Services</div>
                    </div>
                    
                    <div class="receipt-details">
                        <div class="receipt-row">
                            <span>Receipt No:</span>
                            <span id="receiptNumber">JUB-001</span>
                        </div>
                        <div class="receipt-row">
                            <span>Date:</span>
                            <span id="receiptDate">01 Jan 2024</span>
                        </div>
                        <div class="receipt-row">
                            <span>Time:</span>
                            <span id="receiptTime">12:00 PM</span>
                        </div>
                        <div class="receipt-row">
                            <span>Ride Type:</span>
                            <span id="receiptRideType">Standard</span>
                        </div>
                        <div class="receipt-row">
                            <span>Pickup:</span>
                            <span id="receiptPickup">Location</span>
                        </div>
                        <div class="receipt-row">
                            <span>Destination:</span>
                            <span id="receiptDestination">Location</span>
                        </div>
                        <div class="receipt-row">
                            <span>Distance:</span>
                            <span id="receiptDistance">5.2 km</span>
                        </div>
                        <div class="receipt-row">
                            <span>Base Fare:</span>
                            <span id="receiptBaseFare">K23.00</span>
                        </div>
                        <div class="receipt-row">
                            <span>Distance Fare:</span>
                            <span id="receiptDistanceFare">K5.00</span>
                        </div>
                        <div class="receipt-row">
                            <span>Discount:</span>
                            <span id="receiptDiscount">-K0.00</span>
                        </div>
                        <div class="receipt-row total">
                            <span>TOTAL:</span>
                            <span id="receiptTotal">K28.00</span>
                        </div>
                    </div>
                    
                    <div class="receipt-footer">
                        <p>Thank you for choosing JUBEL!</p>
                        <p>For support: +260 768 658 484</p>
                    </div>
                </div>
                
                <button class="print-receipt-btn" id="printReceiptBtn">
                    <i class="fas fa-print"></i>
                    Print Receipt
                </button>
            </div>
        </div>
    </div>
    
    <!-- Payment Selection Popup -->
    <div id="paymentSelectionPopup" class="popup-overlay hidden">
        <div class="popup-form payment-selection-popup">
            <div class="popup-header">
                <h2 class="popup-title">
                    <i class="fas fa-credit-card"></i>
                    Select Payment Method
                </h2>
                <button class="close-popup" id="closePaymentPopup">&times;</button>
            </div>
            <div class="popup-content">
                <div class="payment-options">
                    <div class="payment-option selected" data-payment-type="wallet">
                        <div class="payment-option-icon">
                            <i class="fas fa-wallet"></i>
                        </div>
                        <div class="payment-option-details">
                            <div class="payment-option-name">Jubel Wallet</div>
                            <div class="payment-option-description">Pay with your Jubel wallet balance</div>
                            <div class="payment-option-balance" id="paymentWalletBalance">Balance: K0.00</div>
                        </div>
                    </div>
                    
                    <div class="payment-option" data-payment-type="mobile">
                        <div class="payment-option-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="payment-option-details">
                            <div class="payment-option-name">Mobile Money</div>
                            <div class="payment-option-description">Pay with Airtel, MTN or Zamtel Money</div>
                        </div>
                    </div>
                    
                    <div class="payment-option" data-payment-type="cash">
                        <div class="payment-option-icon">
                            <i class="fas fa-money-bill"></i>
                        </div>
                        <div class="payment-option-details">
                            <div class="payment-option-name">Cash on Delivery</div>
                            <div class="payment-option-description">Pay with cash when you arrive</div>
                        </div>
                    </div>
                </div>
                
                <div class="insufficient-balance" id="insufficientBalance">
                    <i class="fas fa-exclamation-circle"></i>
                    Insufficient balance in your Jubel wallet
                </div>
                
                <button class="confirm-payment-btn" id="confirmPaymentBtn">
                    Confirm Payment & Request Ride
                </button>
            </div>
        </div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification"></div>
    
    <!-- External Libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ol@v7.3.0/dist/ol.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/print-js/1.6.0/print.min.js"></script>
    
    <script>
// Firebase configuration
const firebaseConfig = {
    apiKey: "AIzaSyDEACX_P4c5q7djJAcA0I7Lk7leO2TlQ74",
    authDomain: "jubel-13e1a.firebaseapp.com",
    databaseURL: "https://jubel-13e1a-default-rtdb.firebaseio.com",
    projectId: "jubel-13e1a",
    storageBucket: "jubel-13e1a.firebasestorage.app",
    messagingSenderId: "882241095445",
    appId: "1:882241095445:web:ee9ca40fddd008ca910b1c",
    measurementId: "G-J5JPKL6B5F"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const auth = firebase.auth();

// App state
let currentUser = null;
let currentRide = null;
let passengerMap;
let popupRideMap;
let locationWatchId = null;
let currentLocationMarker = null;
let pickupMarker = null;
let destinationMarker = null;
let driverMarker = null;
let routeLayer = null;
let selectedVehicleType = 'standard';
let selectedRideType = 'premium';
let walletBalance = 0;
let userFullName = "Passenger";
let driverAssignmentListener = null;
let rideHistoryListener = null;
let activeRideListener = null;
let appliedPromoCode = null;
let userStats = {
    completed: 0,
    cancelled: 0,
    pending: 0
};
let userRating = 0;
let userLocation = null;
let destinationSearchResults = [];
let selectedDestination = null;
let driverLocationListener = null;
let userData = null;
let selectedPaymentType = 'wallet';
let rideFare = 0;
let currentCity = null;
let packageDetails = null;
let walletBalanceListener = null;
let currentScreen = 'home';
let homeScreenRefreshRequired = false;

// State variables for new features
let sosConfig = null;
let activeMoreOption = null;
let recipientPickupMarker = null;
let recipientDestinationMarker = null;
let shopLocationMarker = null;
let deliveryDestinationMarker = null;
let emergencyVehicleMarkers = [];
let currentEmergencyType = null;
let emergencyRideActive = false;
let referralRewardsListener = null;

// Map state
let map;
let mapView;
let vectorSource;
let vectorLayer;
let pickupSource;
let pickupLayer;
let destinationSource;
let destinationLayer;
let driverSource;
let driverLayer;
let routeSource;
let currentLocationSource;

// Enhanced city detection
const zambianCities = [
    'Lusaka', 'Kitwe', 'Ndola', 'Kabwe', 'Chipata', 'Chingola', 
    'Mufulira', 'Luanshya', 'Livingstone', 'Kasama', 'Solwezi', 
    'Kapiri Mposhi', 'Chililabombwe'
];

const cityAliases = {
    'lusaka': 'Lusaka',
    'lsk': 'Lusaka',
    'lsk city': 'Lusaka',
    'kitwe': 'Kitwe',
    'ndola': 'Ndola',
    'kabwe': 'Kabwe',
    'chipata': 'Chipata',
    'chingola': 'Chingola',
    'mufulira': 'Mufulira',
    'luanshya': 'Luanshya',
    'livingstone': 'Livingstone',
    'kasama': 'Kasama',
    'solwezi': 'Solwezi',
    'kapiri': 'Kapiri Mposhi',
    'kapiri mposhi': 'Kapiri Mposhi',
    'chililabombwe': 'Chililabombwe',
    'chili': 'Chililabombwe'
};

const cityBoundaries = {
    'Lusaka': { lat: -15.4167, lng: 28.2833, radius: 25000 },
    'Kitwe': { lat: -12.8139, lng: 28.2136, radius: 20000 },
    'Ndola': { lat: -12.9667, lng: 28.6333, radius: 20000 },
    'Kabwe': { lat: -14.4333, lng: 28.4500, radius: 15000 },
    'Chipata': { lat: -13.6333, lng: 32.6500, radius: 15000 },
    'Chingola': { lat: -12.5333, lng: 27.8500, radius: 15000 },
    'Mufulira': { lat: -12.5500, lng: 28.2333, radius: 15000 },
    'Luanshya': { lat: -13.1333, lng: 28.4000, radius: 15000 },
    'Livingstone': { lat: -17.8500, lng: 25.8667, radius: 15000 },
    'Kasama': { lat: -10.2000, lng: 31.2000, radius: 15000 },
    'Solwezi': { lat: -12.1833, lng: 26.4000, radius: 15000 },
    'Kapiri Mposhi': { lat: -13.9667, lng: 28.6833, radius: 10000 },
    'Chililabombwe': { lat: -12.3667, lng: 27.8333, radius: 10000 }
};

// Initialize the app
document.addEventListener('DOMContentLoaded', function() {
    initializeAuth();
});

// Authentication functions
function initializeAuth() {
    const urlParams = new URLSearchParams(window.location.search);
    const email = urlParams.get('email');
    const uid = urlParams.get('uid');
    
    if (email && uid) {
        loadUserData(uid);
    } else {
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                loadUserData(user.uid);
            } else {
                window.location.href = 'signup.html';
            }
        });
    }
}

function loadUserData(uid) {
    database.ref('users/' + uid).once('value')
        .then(snapshot => {
            userData = snapshot.val();
            if (userData) {
                currentUser = {
                    uid: uid,
                    email: userData.email,
                    displayName: userData.name
                };
                
                initializeMap();
                setupEventListeners();
                loadPassengerData();
                
                document.getElementById('accountName').textContent = userData.name || 'Passenger';
                document.getElementById('accountEmail').textContent = userData.email || 'Not set';
                document.getElementById('accountPhone').textContent = userData.phone || 'Not set';
                document.getElementById('referralCode').textContent = userData.referralCode || 'JUBEL-XXXX';
                
                walletBalance = userData.walletBalance || 0;
                updateWalletBalanceUI();
                
                setupWalletBalanceListener(uid);
                loadSOSConfig(uid);
                checkActiveRide(uid);
                setupReferralRewardsListener(uid);
                
                showNotification('Welcome back to Jubel!');
            } else {
                showNotification('User data not found. Please sign up again.');
                setTimeout(() => {
                    window.location.href = 'signup.html';
                }, 2000);
            }
        })
        .catch(error => {
            console.error('Error loading user data:', error);
            showNotification('Error loading user data. Please try again.');
        });
}

function setupReferralRewardsListener(uid) {
    if (referralRewardsListener) {
        referralRewardsListener();
    }
    
    referralRewardsListener = database.ref('referralRewards').orderByChild('referredUserId').equalTo(uid).on('value', snapshot => {
        const rewards = snapshot.val();
        if (rewards) {
            Object.keys(rewards).forEach(rewardId => {
                const reward = rewards[rewardId];
                if (reward.status === 'pending' && reward.rewardedUserId === currentUser.uid) {
                    // Reward the referrer when referred user completes their first ride
                    database.ref('users/' + reward.referrerId + '/walletBalance').transaction(currentBalance => {
                        return (currentBalance || 0) + 25;
                    }).then(() => {
                        database.ref('referralRewards/' + rewardId).update({
                            status: 'completed',
                            completedAt: firebase.database.ServerValue.TIMESTAMP
                        });
                        showNotification('You earned K25 from referral!');
                    });
                }
            });
        }
    });
}

function checkActiveRide(uid) {
    database.ref('rides').orderByChild('passengerId').equalTo(uid).once('value')
        .then(snapshot => {
            const rides = snapshot.val();
            if (rides) {
                for (const rideId in rides) {
                    const ride = rides[rideId];
                    if (ride.status !== 'completed' && ride.status !== 'cancelled' && ride.status !== 'requested') {
                        restoreActiveRide(rideId, ride);
                        break;
                    }
                }
            }
        })
        .catch(error => {
            console.error('Error checking active ride:', error);
        });
}

function restoreActiveRide(rideId, ride) {
    currentRide = {
        id: rideId,
        ...ride
    };
    
    updateUIForActiveRide();
    
    if (ride.status === 'requested') {
        document.getElementById('searchingAnimation').style.display = 'flex';
        document.getElementById('rideStatus').style.display = 'flex';
        document.getElementById('statusDot').className = 'status-dot searching';
        document.getElementById('statusText').textContent = 'Searching for driver';
        
        listenForDriverAssignment(rideId);
    } else if (ride.driverId && (ride.status === 'accepted' || ride.status === 'arrived' || ride.status === 'started' || ride.status === 'picked_up')) {
        handleDriverAssignment(ride);
        updateRideStatusDisplay(ride.status);
        
        if (ride.driverId) {
            trackDriverLocation(ride.driverId);
        }
        
        if (sosConfig && sosConfig.contact1) {
            document.getElementById('sosButton').style.display = 'flex';
        }
    }
    
    activeRideRestored = true;
    showNotification('Active ride restored');
}

function updateRideStatusDisplay(status) {
    const statusText = document.getElementById('statusText');
    const statusDot = document.getElementById('statusDot');
    const estimatedTime = document.getElementById('estimatedTime');
    
    switch(status) {
        case 'accepted':
            statusText.textContent = 'Driver on the way';
            statusDot.className = 'status-dot arriving';
            estimatedTime.style.display = 'flex';
            break;
        case 'arrived':
            statusText.textContent = 'Driver arrived';
            statusDot.className = 'status-dot riding';
            break;
        case 'started':
            statusText.textContent = 'Trip in progress';
            statusDot.className = 'status-dot riding';
            break;
        case 'picked_up':
            statusText.textContent = 'Trip in progress';
            statusDot.className = 'status-dot riding';
            break;
        case 'emergency':
            statusText.textContent = 'Emergency vehicle dispatched';
            statusDot.className = 'status-dot emergency-ride-status';
            break;
    }
}

function loadSOSConfig(uid) {
    database.ref('sosConfig/' + uid).once('value')
        .then(snapshot => {
            sosConfig = snapshot.val();
            if (sosConfig) {
                document.getElementById('emergencyContact1').value = sosConfig.contact1 || '';
                document.getElementById('emergencyContact2').value = sosConfig.contact2 || '';
                document.getElementById('sosMessage').value = sosConfig.message || 'I need help! My current location and ride details will be shared with you.';
            }
        })
        .catch(error => {
            console.error('Error loading SOS config:', error);
        });
}

function setupWalletBalanceListener(uid) {
    if (walletBalanceListener) {
        walletBalanceListener();
    }
    
    walletBalanceListener = database.ref('users/' + uid + '/walletBalance').on('value', snapshot => {
        const newBalance = snapshot.val() || 0;
        if (newBalance !== walletBalance) {
            walletBalance = newBalance;
            updateWalletBalanceUI();
            showNotification(`Wallet balance updated: K${walletBalance.toFixed(2)}`);
        }
    }, error => {
        console.error('Error listening to wallet balance:', error);
    });
}

function updateWalletBalanceUI() {
    document.getElementById('walletBalance').textContent = `K${walletBalance.toFixed(2)}`;
    document.getElementById('accountBalance').textContent = `K${walletBalance.toFixed(2)}`;
    document.getElementById('paymentWalletBalance').textContent = `Balance: K${walletBalance.toFixed(2)}`;
}

// OpenLayers Map Initialization
function initializeMap() {
    // Initialize map view centered on Zambia
    mapView = new ol.View({
        center: ol.proj.fromLonLat([28.2833, -15.4167]), // Lusaka coordinates
        zoom: 13,
        maxZoom: 18,
        minZoom: 10
    });
    
    // Create base map layer
    const osmLayer = new ol.layer.Tile({
        source: new ol.source.OSM()
    });
    
    // Create vector source for markers
    vectorSource = new ol.source.Vector();
    vectorLayer = new ol.layer.Vector({
        source: vectorSource,
        style: new ol.style.Style({
            image: new ol.style.Icon({
                anchor: [0.5, 1],
                scale: 0.8
            })
        })
    });
    
    // Create separate sources for different marker types
    currentLocationSource = new ol.source.Vector();
    pickupSource = new ol.source.Vector();
    destinationSource = new ol.source.Vector();
    driverSource = new ol.source.Vector();
    routeSource = new ol.source.Vector();
    
    // Create layers for each source
    const currentLocationLayer = new ol.layer.Vector({
        source: currentLocationSource,
        style: new ol.style.Style({
            image: new ol.style.Circle({
                radius: 8,
                fill: new ol.style.Fill({
                    color: '#3498db'
                }),
                stroke: new ol.style.Stroke({
                    color: '#ffffff',
                    width: 2
                })
            })
        })
    });
    
    const pickupLayer = new ol.layer.Vector({
        source: pickupSource,
        style: new ol.style.Style({
            image: new ol.style.Circle({
                radius: 10,
                fill: new ol.style.Fill({
                    color: '#FF6B35'
                }),
                stroke: new ol.style.Stroke({
                    color: '#ffffff',
                    width: 3
                })
            })
        })
    });
    
    const destinationLayer = new ol.layer.Vector({
        source: destinationSource,
        style: new ol.style.Style({
            image: new ol.style.Circle({
                radius: 10,
                fill: new ol.style.Fill({
                    color: '#E74C3C'
                }),
                stroke: new ol.style.Stroke({
                    color: '#ffffff',
                    width: 3
                })
            })
        })
    });
    
    const driverLayer = new ol.layer.Vector({
        source: driverSource,
        style: new ol.style.Style({
            image: new ol.style.Icon({
                src: 'data:image/svg+xml;utf8,' + encodeURIComponent(`
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="40" fill="#FF6B35" stroke="#FFFFFF" stroke-width="5"/>
                        <text x="50" y="60" font-size="40" text-anchor="middle" fill="#FFFFFF"></text>
                    </svg>
                `),
                scale: 0.5,
                anchor: [0.5, 0.5]
            })
        })
    });
    
    const routeLayer = new ol.layer.Vector({
        source: routeSource,
        style: new ol.style.Style({
            stroke: new ol.style.Stroke({
                color: '#FF6B35',
                width: 4,
                lineDash: [10, 10]
            })
        })
    });
    
    // Create the map
    map = new ol.Map({
        target: 'map',
        layers: [osmLayer, routeLayer, currentLocationLayer, pickupLayer, destinationLayer, driverLayer],
        view: mapView,
        controls: ol.control.defaults({
            attributionOptions: {
                collapsible: false
            }
        })
    });
    
    // Add custom controls
    addMapControls();
    
    // Get passenger's current location
    refreshPassengerPosition();
    
    // Initialize popup map for ride details
    initializePopupMap();
}

function initializePopupMap() {
    const popupMapView = new ol.View({
        center: ol.proj.fromLonLat([28.2833, -15.4167]),
        zoom: 13
    });
    
    const popupOsmLayer = new ol.layer.Tile({
        source: new ol.source.OSM()
    });
    
    const popupVectorSource = new ol.source.Vector();
    const popupVectorLayer = new ol.layer.Vector({
        source: popupVectorSource,
        style: new ol.style.Style({
            stroke: new ol.style.Stroke({
                color: '#FF6B35',
                width: 4
            }),
            image: new ol.style.Circle({
                radius: 6,
                fill: new ol.style.Fill({
                    color: '#FF6B35'
                }),
                stroke: new ol.style.Stroke({
                    color: '#ffffff',
                    width: 2
                })
            })
        })
    });
    
    popupRideMap = new ol.Map({
        target: 'popupRideMap',
        layers: [popupOsmLayer, popupVectorLayer],
        view: popupMapView,
        controls: []
    });
}

function addMapControls() {
    // Add locate me button functionality
    document.getElementById('locateMeBtn').addEventListener('click', function() {
        if (userLocation) {
            const center = ol.proj.fromLonLat([userLocation.lng, userLocation.lat]);
            mapView.animate({
                center: center,
                zoom: 16,
                duration: 500
            });
            showNotification('Map centered on your location');
        }
    });
    
    // Add zoom controls
    document.getElementById('zoomInBtn').addEventListener('click', function() {
        mapView.animate({
            zoom: mapView.getZoom() + 1,
            duration: 200
        });
    });
    
    document.getElementById('zoomOutBtn').addEventListener('click', function() {
        mapView.animate({
            zoom: mapView.getZoom() - 1,
            duration: 200
        });
    });
}

function addMarker(coordinates, type, title = '') {
    const [lng, lat] = coordinates;
    const point = new ol.geom.Point(ol.proj.fromLonLat([lng, lat]));
    const feature = new ol.Feature({
        geometry: point,
        type: type,
        title: title
    });
    
    let style;
    switch(type) {
        case 'currentLocation':
            style = new ol.style.Style({
                image: new ol.style.Circle({
                    radius: 8,
                    fill: new ol.style.Fill({
                        color: '#3498db'
                    }),
                    stroke: new ol.style.Stroke({
                        color: '#ffffff',
                        width: 2
                    })
                })
            });
            currentLocationSource.clear();
            currentLocationSource.addFeature(feature);
            break;
            
        case 'pickup':
            style = new ol.style.Style({
                image: new ol.style.Circle({
                    radius: 10,
                    fill: new ol.style.Fill({
                        color: '#FF6B35'
                    }),
                    stroke: new ol.style.Stroke({
                        color: '#ffffff',
                        width: 3
                    })
                })
            });
            pickupSource.clear();
            pickupSource.addFeature(feature);
            break;
            
        case 'destination':
            style = new ol.style.Circle({
                radius: 10,
                fill: new ol.style.Fill({
                    color: '#E74C3C'
                }),
                stroke: new ol.style.Stroke({
                    color: '#ffffff',
                    width: 3
                })
            });
            destinationSource.clear();
            destinationSource.addFeature(feature);
            break;
            
        case 'driver':
            style = new ol.style.Icon({
                src: 'data:image/svg+xml;utf8,' + encodeURIComponent(`
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="40" fill="#FF6B35" stroke="#FFFFFF" stroke-width="5"/>
                        <text x="50" y="60" font-size="40" text-anchor="middle" fill="#FFFFFF"></text>
                    </svg>
                `),
                scale: 0.5,
                anchor: [0.5, 0.5]
            });
            driverSource.clear();
            driverSource.addFeature(feature);
            break;
            
        case 'emergency-ambulance':
            style = new ol.style.Icon({
                src: 'data:image/svg+xml;utf8,' + encodeURIComponent(`
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="40" fill="#ff4444" stroke="#FFFFFF" stroke-width="5"/>
                        <text x="50" y="60" font-size="40" text-anchor="middle" fill="#FFFFFF"></text>
                    </svg>
                `),
                scale: 0.6,
                anchor: [0.5, 0.5]
            });
            vectorSource.addFeature(feature);
            break;
            
        case 'emergency-fire':
            style = new ol.style.Icon({
                src: 'data:image/svg+xml;utf8,' + encodeURIComponent(`
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="40" fill="#ff3333" stroke="#FFFFFF" stroke-width="5"/>
                        <text x="50" y="60" font-size="40" text-anchor="middle" fill="#FFFFFF"></text>
                    </svg>
                `),
                scale: 0.6,
                anchor: [0.5, 0.5]
            });
            vectorSource.addFeature(feature);
            break;
            
        case 'emergency-police':
            style = new ol.style.Icon({
                src: 'data:image/svg+xml;utf8,' + encodeURIComponent(`
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="40" fill="#3366ff" stroke="#FFFFFF" stroke-width="5"/>
                        <text x="50" y="60" font-size="40" text-anchor="middle" fill="#FFFFFF"></text>
                    </svg>
                `),
                scale: 0.6,
                anchor: [0.5, 0.5]
            });
            vectorSource.addFeature(feature);
            break;
    }
    
    feature.setStyle(style);
    return feature;
}

function drawRouteOnMap(startCoords, endCoords) {
    routeSource.clear();
    
    const startPoint = ol.proj.fromLonLat(startCoords);
    const endPoint = ol.proj.fromLonLat(endCoords);
    
    const routeLine = new ol.geom.LineString([startPoint, endPoint]);
    const routeFeature = new ol.Feature({
        geometry: routeLine
    });
    
    routeFeature.setStyle(new ol.style.Style({
        stroke: new ol.style.Stroke({
            color: '#FF6B35',
            width: 4,
            lineDash: [10, 10]
        })
    }));
    
    routeSource.addFeature(routeFeature);
    
    // Fit map to show both points
    const extent = routeLine.getExtent();
    mapView.fit(extent, {
        padding: [50, 50, 50, 50],
        duration: 1000
    });
}

function drawRouteWithOSRM(startCoords, endCoords) {
    const [startLng, startLat] = startCoords;
    const [endLng, endLat] = endCoords;
    
    fetch(`https://router.project-osrm.org/route/v1/driving/${startLng},${startLat};${endLng},${endLat}?overview=full&geometries=geojson`)
        .then(response => response.json())
        .then(data => {
            if (data.routes && data.routes.length > 0) {
                const route = data.routes[0];
                const coordinates = route.geometry.coordinates.map(coord => ol.proj.fromLonLat(coord));
                
                const routeLine = new ol.geom.LineString(coordinates);
                const routeFeature = new ol.Feature({
                    geometry: routeLine
                });
                
                routeFeature.setStyle(new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: '#FF6B35',
                        width: 4,
                        lineDash: [10, 10]
                    })
                }));
                
                routeSource.clear();
                routeSource.addFeature(routeFeature);
                
                // Fit map to show route
                const extent = routeLine.getExtent();
                mapView.fit(extent, {
                    padding: [50, 50, 50, 50],
                    duration: 1000
                });
            }
        })
        .catch(error => {
            console.error('Error fetching OSRM route:', error);
            drawRouteOnMap(startCoords, endCoords);
        });
}

function updatePopupRideMap(ride) {
    const popupMap = popupRideMap;
    const popupView = popupMap.getView();
    const popupVectorSource = popupMap.getLayers().item(1).getSource();
    
    popupVectorSource.clear();
    
    // Add pickup marker
    const pickupPoint = new ol.geom.Point(ol.proj.fromLonLat([ride.pickupLng, ride.pickupLat]));
    const pickupFeature = new ol.Feature({
        geometry: pickupPoint
    });
    pickupFeature.setStyle(new ol.style.Style({
        image: new ol.style.Circle({
            radius: 8,
            fill: new ol.style.Fill({
                color: '#FF6B35'
            }),
            stroke: new ol.style.Stroke({
                color: '#ffffff',
                width: 3
            })
        })
    }));
    
    // Add destination marker
    const destPoint = new ol.geom.Point(ol.proj.fromLonLat([ride.destLng, ride.destLat]));
    const destFeature = new ol.Feature({
        geometry: destPoint
    });
    destFeature.setStyle(new ol.style.Style({
        image: new ol.style.Circle({
            radius: 8,
            fill: new ol.style.Fill({
                color: '#E74C3C'
            }),
            stroke: new ol.style.Stroke({
                color: '#ffffff',
                width: 3
            })
        })
    }));
    
    // Draw route
    const routeLine = new ol.geom.LineString([
        ol.proj.fromLonLat([ride.pickupLng, ride.pickupLat]),
        ol.proj.fromLonLat([ride.destLng, ride.destLat])
    ]);
    const routeFeature = new ol.Feature({
        geometry: routeLine
    });
    routeFeature.setStyle(new ol.style.Style({
        stroke: new ol.style.Stroke({
            color: '#FF6B35',
            width: 4
        })
    }));
    
    popupVectorSource.addFeatures([pickupFeature, destFeature, routeFeature]);
    
    // Fit view to show both points
    const extent = routeLine.getExtent();
    popupView.fit(extent, {
        padding: [30, 30, 30, 30],
        duration: 500
    });
}

function determineCurrentCity(lat, lng) {
    return new Promise((resolve, reject) => {
        const boundaryCity = checkCityBoundaries(lat, lng);
        if (boundaryCity) {
            currentCity = boundaryCity;
            resolve(currentCity);
            return;
        }
        
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1&accept-language=en`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data && data.address) {
                    const detectedCity = extractCityFromAddress(data.address);
                    
                    if (detectedCity && detectedCity !== "Unknown Location") {
                        currentCity = detectedCity;
                        resolve(currentCity);
                    } else {
                        const fallbackCity = extractCityFromDisplayName(data.display_name);
                        currentCity = fallbackCity;
                        resolve(currentCity);
                    }
                } else {
                    currentCity = "Lusaka";
                    resolve(currentCity);
                }
            })
            .catch(error => {
                console.error('Error in city detection:', error);
                currentCity = determineCityByProximity(lat, lng) || "Lusaka";
                resolve(currentCity);
            });
    });
}

function checkCityBoundaries(lat, lng) {
    for (const [city, boundary] of Object.entries(cityBoundaries)) {
        const distance = calculateDistance(lat, lng, boundary.lat, boundary.lng);
        if (distance <= boundary.radius) {
            return city;
        }
    }
    return null;
}

function extractCityFromAddress(address) {
    const priorityFields = [
        'city', 'town', 'village', 'municipality', 
        'suburb', 'county', 'state_district', 'state'
    ];
    
    for (const field of priorityFields) {
        if (address[field]) {
            const detectedName = address[field].toString().trim();
            const normalized = normalizeCityName(detectedName);
            if (zambianCities.includes(normalized)) {
                return normalized;
            }
        }
    }
    
    return null;
}

function extractCityFromDisplayName(displayName) {
    if (!displayName) return "Unknown Location";
    
    const nameLower = displayName.toLowerCase();
    
    for (const city of zambianCities) {
        if (nameLower.includes(city.toLowerCase())) {
            return city;
        }
    }
    
    for (const [alias, actualCity] of Object.entries(cityAliases)) {
        if (nameLower.includes(alias)) {
            return actualCity;
        }
    }
    
    return "Unknown Location";
}

function normalizeCityName(cityName) {
    if (!cityName) return "";
    
    const normalized = cityName.toString().trim();
    
    const variations = {
        'lusaka city': 'Lusaka',
        'lska': 'Lusaka',
        'kitwe town': 'Kitwe',
        'ndola city': 'Ndola',
        'kabwe town': 'Kabwe',
        'chipata town': 'Chipata',
        'chingola town': 'Chingola',
        'mufulira town': 'Mufulira',
        'luanshya town': 'Luanshya',
        'livingstone town': 'Livingstone',
        'kasama town': 'Kasama',
        'solwezi town': 'Solwezi',
        'kapiri mposhi town': 'Kapiri Mposhi',
        'chililabombwe town': 'Chililabombwe'
    };
    
    return variations[normalized.toLowerCase()] || 
           zambianCities.find(city => city.toLowerCase() === normalized.toLowerCase()) || 
           normalized;
}

function determineCityByProximity(lat, lng) {
    let closestCity = null;
    let shortestDistance = Infinity;
    
    for (const [city, center] of Object.entries(cityBoundaries)) {
        const distance = calculateDistance(lat, lng, center.lat, center.lng);
        if (distance < shortestDistance) {
            shortestDistance = distance;
            closestCity = city;
        }
    }
    
    return shortestDistance <= 100000 ? closestCity : "Unknown Location";
}

function updatePickupLocation(lat, lng) {
    addMarker([lng, lat], 'pickup', 'Pickup Location');
    getEnhancedAddress(lat, lng, 'pickupLocation');
}

function getEnhancedAddress(lat, lng, elementId) {
    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1&accept-language=en`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Geocoding error: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data && data.address) {
                const address = data.address;
                const enhancedAddress = buildEnhancedAddress(address);
                document.getElementById(elementId).value = enhancedAddress;
                
                // Store address components for display
                if (elementId === 'pickupLocation') {
                    displayAddressComponents(address, 'pickupAddressDetails');
                }
            } else {
                document.getElementById(elementId).value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            }
        })
        .catch(error => {
            console.error('Reverse geocoding error:', error);
            document.getElementById(elementId).value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        });
}

function buildEnhancedAddress(address) {
    const parts = [];
    
    // House/Plot number
    if (address.house_number || address.housenumber) {
        parts.push(`House ${address.house_number || address.housenumber}`);
    }
    
    // Building name
    if (address.building) {
        parts.push(address.building);
    }
    
    // Road/Street
    if (address.road) {
        parts.push(address.road);
    }
    
    // Suburb/Neighborhood
    if (address.suburb) {
        parts.push(address.suburb);
    }
    
    // City/Town
    if (address.city || address.town) {
        parts.push(address.city || address.town);
    }
    
    return parts.join(', ');
}

function displayAddressComponents(address, containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    let html = '';
    
    if (address.house_number || address.housenumber) {
        html += `<span class="address-component address-house">House ${address.house_number || address.housenumber}</span>`;
    }
    
    if (address.building) {
        html += `<span class="address-component address-house">${address.building}</span>`;
    }
    
    if (address.road) {
        html += `<span class="address-component address-road">${address.road}</span>`;
    }
    
    if (address.suburb || address.neighbourhood) {
        html += `<span class="address-component address-area">${address.suburb || address.neighbourhood}</span>`;
    }
    
    if (address.city || address.town) {
        html += `<span class="address-component address-city">${address.city || address.town}</span>`;
    }
    
    container.innerHTML = html;
}

function searchPlacesEnhanced(query, searchType = 'destination') {
    if (!query || query.length < 2) {
        hideSearchSuggestions(searchType);
        return;
    }
    
    const suggestionsContainer = document.getElementById(`${searchType}Suggestions`);
    
    if (window.searchTimeout) {
        clearTimeout(window.searchTimeout);
    }
    
    suggestionsContainer.innerHTML = '<div class="loading-text">Searching...</div>';
    suggestionsContainer.style.display = 'block';
    
    window.searchTimeout = setTimeout(() => {
        const processedQuery = preprocessSearchQuery(query);
        let hasResults = false;
        
        performUnifiedSearch(processedQuery)
            .then(results => {
                if (results.length > 0) {
                    hasResults = true;
                    displaySearchResults(results, searchType);
                } else {
                    showNoResultsMessage(processedQuery, searchType);
                }
            })
            .catch(error => {
                console.error('Search error:', error);
                const cachedResults = getCachedSearchResults(searchType);
                if (cachedResults.length > 0) {
                    displaySearchResults(cachedResults, searchType);
                } else {
                    showNoResultsMessage(processedQuery, searchType);
                }
            });
            
        setTimeout(() => {
            if (!hasResults) {
                const cachedResults = getCachedSearchResults(searchType);
                if (cachedResults.length === 0) {
                    showNoResultsMessage(processedQuery, searchType);
                }
            }
        }, 2000);
        
    }, 300);
}

function getCachedSearchResults(searchType) {
    switch(searchType) {
        case 'destination': return destinationSearchResults;
        case 'pickup': return pickupSearchResults;
        case 'recipientPickup': return recipientPickupSearchResults;
        case 'recipientDestination': return destinationSearchResults;
        case 'shopLocation': return shopLocationSearchResults;
        case 'deliveryDestination': return deliveryDestinationSearchResults;
        default: return [];
    }
}

function performUnifiedSearch(query) {
    return new Promise((resolve, reject) => {
        let searchQuery = query;
        if (currentCity && currentCity !== "Unknown Location") {
            searchQuery = `${query} ${currentCity} Zambia`;
        } else {
            searchQuery = `${query} Zambia`;
        }
        
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&limit=10&dedupe=1&countrycodes=zm`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Search API error: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data && data.length > 0) {
                    const enhancedResults = data
                        .filter(place => place.display_name && place.lat && place.lon)
                        .map(place => {
                            const distance = userLocation ? calculateDistance(
                                userLocation.lat, userLocation.lng,
                                parseFloat(place.lat), parseFloat(place.lon)
                            ) : 0;
                            
                            const placeCity = extractCityFromPlace(place) || currentCity || "Unknown";
                            
                            return {
                                ...place,
                                displayLat: parseFloat(place.lat),
                                displayLon: parseFloat(place.lon),
                                distance,
                                city: placeCity,
                                isCurrentCity: placeCity === currentCity,
                                priority: placeCity === currentCity ? 1 : 2,
                                relevanceScore: calculateRelevanceScore(place, query, placeCity),
                                displayName: formatDisplayName(place.display_name, placeCity),
                                address: place.address || {}
                            };
                        })
                        .sort((a, b) => {
                            if (b.relevanceScore !== a.relevanceScore) {
                                return b.relevanceScore - a.relevanceScore;
                            }
                            return a.distance - b.distance;
                        });
                    
                    resolve(enhancedResults);
                } else {
                    resolve([]);
                }
            })
            .catch(error => {
                console.error('Unified search error:', error);
                reject(error);
            });
    });
}

function displaySearchResults(results, searchType) {
    const suggestionsContainer = document.getElementById(`${searchType}Suggestions`);
    suggestionsContainer.innerHTML = '';
    
    updateSearchResultsCache(results, searchType);
    
    if (results.length === 0) {
        showNoResultsMessage('', searchType);
        return;
    }
    
    const uniqueResults = removeDuplicatePlaces(results).slice(0, 8);
    
    uniqueResults.forEach((result, index) => {
        const suggestionItem = document.createElement('div');
        suggestionItem.className = 'suggestion-item';
        if (index === 0) suggestionItem.classList.add('first-result');
        
        const placeType = getPlaceType(result);
        const placeIcon = getPlaceIcon(placeType);
        
        const cityBadge = result.isCurrentCity ? '' : 
            `<span class="city-filter-badge">${result.city}</span>`;
        
        const distanceText = userLocation && result.distance > 0 ? 
            `${(result.distance / 1000).toFixed(1)} km away` : '';
        
        const displayName = result.displayName || result.display_name;
        
        suggestionItem.innerHTML = `
            <div class="suggestion-icon">${placeIcon}</div>
            <div class="suggestion-details">
                <div class="suggestion-name">
                    ${displayName}
                    ${cityBadge}
                </div>
                <div class="suggestion-address">${getShortAddress(result.display_name)}</div>
                <div class="suggestion-distance">${distanceText}</div>
                <div class="search-result-details">
                    ${getAddressComponentsHTML(result.address)}
                </div>
            </div>
        `;
        
        suggestionItem.addEventListener('click', function() {
            handleSearchResultSelection(result, searchType);
        });
        
        suggestionsContainer.appendChild(suggestionItem);
    });
    
    suggestionsContainer.style.display = 'block';
}

function getAddressComponentsHTML(address) {
    if (!address) return '';
    
    let html = '';
    if (address.road) {
        html += `<span class="search-result-type">${address.road}</span>`;
    }
    if (address.suburb) {
        html += `<span class="search-result-type">${address.suburb}</span>`;
    }
    if (address.city || address.town) {
        html += `<span class="search-result-type">${address.city || address.town}</span>`;
    }
    
    return html;
}

function handleSearchResultSelection(result, searchType) {
    const inputField = document.getElementById(searchType + (searchType === 'pickup' ? 'Location' : 
                                 searchType === 'destination' ? 'Location' :
                                 searchType === 'recipientPickup' ? 'Location' :
                                 searchType === 'recipientDestination' ? 'Location' :
                                 searchType === 'shopLocation' ? '' :
                                 searchType === 'deliveryDestination' ? '' : ''));
    
    if (inputField) {
        inputField.value = result.display_name;
        
        // Display address components
        if (result.address) {
            const containerId = searchType === 'destination' ? 'destinationAddressDetails' : 
                              searchType === 'pickup' ? 'pickupAddressDetails' : '';
            if (containerId) {
                displayAddressComponents(result.address, containerId);
            }
        }
    }
    
    hideSearchSuggestions(searchType);
    
    switch(searchType) {
        case 'destination':
            updateFareEstimate();
            addMarker([result.displayLon, result.displayLat], 'destination', result.display_name);
            
            if (userLocation) {
                drawRouteWithOSRM([userLocation.lng, userLocation.lat], [result.displayLon, result.displayLat]);
            }
            
            selectedDestination = result;
            document.getElementById('requestRideBtn').disabled = false;
            
            showNotification(`Destination set to ${result.displayName}`);
            break;
            
        case 'pickup':
            updateManualPickupLocation(result.displayLat, result.displayLon, result.display_name);
            showNotification(`Pickup location set to ${result.displayName}`);
            break;
            
        case 'recipientPickup':
            calculateRecipientDeliveryFee();
            showNotification(`Recipient pickup set to ${result.displayName}`);
            break;
            
        case 'recipientDestination':
            calculateRecipientDeliveryFee();
            showNotification(`Recipient destination set to ${result.displayName}`);
            break;
            
        case 'shopLocation':
            calculateExpressDeliveryFee();
            showNotification(`Shop location set to ${result.displayName}`);
            break;
            
        case 'deliveryDestination':
            calculateExpressDeliveryFee();
            showNotification(`Delivery destination set to ${result.displayName}`);
            break;
    }
}

function updateManualPickupLocation(lat, lng, name) {
    currentLocationSource.clear();
    pickupSource.clear();
    
    addMarker([lng, lat], 'pickup', name);
    
    userLocation = { lat, lng };
    
    const destination = document.getElementById('destinationLocation').value;
    if (destination) {
        updateFareEstimate();
        
        forwardGeocode(destination).then(results => {
            if (results.length > 0) {
                const destLat = parseFloat(results[0].lat);
                const destLng = parseFloat(results[0].lon);
                drawRouteWithOSRM([lng, lat], [destLng, destLat]);
            }
        });
    }
    
    const center = ol.proj.fromLonLat([lng, lat]);
    mapView.animate({
        center: center,
        zoom: 16,
        duration: 500
    });
}

function updateSearchResultsCache(results, searchType) {
    switch(searchType) {
        case 'destination': 
            destinationSearchResults = results;
            break;
        case 'pickup':
            pickupSearchResults = results;
            break;
        case 'recipientPickup':
            recipientPickupSearchResults = results;
            break;
        case 'recipientDestination':
            destinationSearchResults = results;
            break;
        case 'shopLocation':
            shopLocationSearchResults = results;
            break;
        case 'deliveryDestination':
            deliveryDestinationSearchResults = results;
            break;
    }
}

function setupSearchInputListeners() {
    const searchTypes = [
        'destination', 'pickup', 'recipientPickup', 
        'recipientDestination', 'shopLocation', 'deliveryDestination'
    ];
    
    searchTypes.forEach(searchType => {
        const inputId = searchType + (searchType.includes('Location') ? '' : 'Location');
        const suggestionsId = searchType + 'Suggestions';
        
        let lastQuery = '';
        const inputField = document.getElementById(inputId);
        
        if (!inputField) return;
        
        inputField.addEventListener('input', function() {
            const query = this.value.trim();
            
            if (window.searchTimeout) {
                clearTimeout(window.searchTimeout);
            }
            
            if (query.length >= 2 && query !== lastQuery) {
                window.searchTimeout = setTimeout(() => {
                    lastQuery = query;
                    searchPlacesEnhanced(query, searchType);
                }, 300);
            } else if (query.length < 2) {
                hideSearchSuggestions(searchType);
                lastQuery = '';
            }
        });
        
        inputField.addEventListener('focus', function() {
            const query = this.value.trim();
            const cachedResults = getCachedSearchResults(searchType);
            
            if (query.length >= 2 && cachedResults.length > 0) {
                displaySearchResults(cachedResults, searchType);
            } else if (query.length >= 2) {
                searchPlacesEnhanced(query, searchType);
            }
        });
        
        inputField.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                hideSearchSuggestions(searchType);
            } else if (e.key === 'Enter') {
                hideSearchSuggestions(searchType);
                const cachedResults = getCachedSearchResults(searchType);
                if (cachedResults.length > 0) {
                    handleSearchResultSelection(cachedResults[0], searchType);
                }
            }
        });
    });
}

function hideSearchSuggestions(searchType) {
    const suggestionsContainer = document.getElementById(`${searchType}Suggestions`);
    if (suggestionsContainer) {
        suggestionsContainer.style.display = 'none';
    }
    
    if (window.searchTimeout) {
        clearTimeout(window.searchTimeout);
        window.searchTimeout = null;
    }
}

function showNoResultsMessage(query = '', searchType = 'destination') {
    const suggestionsContainer = document.getElementById(`${searchType}Suggestions`);
    
    if (suggestionsContainer) {
        suggestionsContainer.innerHTML = '<div class="no-places">No places found</div>';
    }
}

function preprocessSearchQuery(query) {
    let processed = query.trim().toLowerCase();
    
    const stopWords = ['the', 'a', 'an', 'in', 'on', 'at', 'to', 'for', 'of', 'and', 'or', 'but'];
    stopWords.forEach(word => {
        processed = processed.replace(new RegExp(`\\b${word}\\b`, 'gi'), '');
    });
    
    processed = processed.replace(/\s+/g, ' ').trim();
    
    const abbreviations = {
        'st': 'street',
        'ave': 'avenue',
        'rd': 'road',
        'blvd': 'boulevard',
        'hwy': 'highway',
        'ln': 'lane',
        'dr': 'drive'
    };
    
    Object.keys(abbreviations).forEach(abbr => {
        processed = processed.replace(new RegExp(`\\b${abbr}\\b`, 'gi'), abbreviations[abbr]);
    });
    
    return processed;
}

function calculateRelevanceScore(place, query, city) {
    let score = 0;
    const placeName = place.display_name.toLowerCase();
    const queryLower = query.toLowerCase();
    const cityLower = city.toLowerCase();
    
    if (placeName.includes(queryLower)) {
        score += 10;
    }
    
    const queryWords = queryLower.split(' ');
    queryWords.forEach(word => {
        if (word.length > 2 && placeName.includes(word)) {
            score += 5;
        }
    });
    
    if (city === currentCity) {
        score += 8;
    }
    
    if (place.type === 'administrative' || place.class === 'boundary') {
        score -= 2;
    }
    
    if (place.importance) {
        score += place.importance * 5;
    }
    
    if (userLocation) {
        const distance = calculateDistance(
            userLocation.lat, userLocation.lng,
            parseFloat(place.lat), parseFloat(place.lon)
        );
        if (distance > 50000) {
            score -= 3;
        }
    }
    
    return Math.max(0, score);
}

function extractCityFromPlace(place) {
    if (place.address) {
        return extractCityFromAddress(place.address);
    }
    
    return extractCityFromDisplayName(place.display_name);
}

function formatDisplayName(fullName, city) {
    if (!fullName) return 'Unknown Location';
    
    const parts = fullName.split(',');
    const relevantParts = [];
    
    for (let i = 0; i < parts.length; i++) {
        const part = parts[i].trim();
        const partLower = part.toLowerCase();
        
        if (zambianCities.some(c => c.toLowerCase() === partLower) ||
            partLower === 'zambia' ||
            partLower.includes('province')) {
            break;
        }
        
        relevantParts.push(part);
    }
    
    return relevantParts.join(', ') || fullName;
}

function getShortAddress(fullAddress) {
    if (!fullAddress) return '';
    
    const parts = fullAddress.split(',');
    return parts.slice(0, Math.min(3, parts.length)).join(', ');
}

function removeDuplicatePlaces(places) {
    const seen = new Set();
    return places.filter(place => {
        const coordKey = `${place.lat}-${place.lon}`;
        const nameKey = place.display_name.substring(0, 50).toLowerCase();
        const uniqueKey = `${coordKey}-${nameKey}`;
        
        if (seen.has(uniqueKey)) {
            return false;
        }
        seen.add(uniqueKey);
        return true;
    });
}

function refreshPassengerPosition() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            userLocation = { lat, lng };
            
            const center = ol.proj.fromLonLat([lng, lat]);
            mapView.setCenter(center);
            mapView.setZoom(16);
            
            addMarker([lng, lat], 'currentLocation', 'Your location');
            
            updatePickupLocation(lat, lng);
            
            showNotification('Detecting your location...');
            determineCurrentCity(lat, lng).then(city => {
                if (currentScreen === 'home') {
                    showNotification(`Location detected in ${city}`);
                    updateCitySpecificUI(city);
                }
            }).catch(error => {
                console.error('City detection failed:', error);
                currentCity = "Lusaka";
                if (currentScreen === 'home') {
                    showNotification('Using default location: Lusaka');
                }
            });
            
            if (!locationWatchId) {
                startLocationTracking();
            }
            
            if (currentScreen === 'home') {
                showNotification('Location refreshed');
            }
        }, error => {
            console.error('Geolocation error:', error);
            handleGeolocationError(error);
        }, {
            enableHighAccuracy: true,
            timeout: 15000,
            maximumAge: 30000
        });
    } else {
        showNotification('Geolocation is not supported by this browser.');
        currentCity = "Lusaka";
    }
}

function handleGeolocationError(error) {
    let errorMessage = 'Unable to refresh location. ';
    
    switch(error.code) {
        case error.PERMISSION_DENIED:
            errorMessage += 'Please enable location services in your browser settings.';
            break;
        case error.POSITION_UNAVAILABLE:
            errorMessage += 'Location information is unavailable.';
            break;
        case error.TIMEOUT:
            errorMessage += 'Location request timed out. Please try again.';
            break;
        default:
            errorMessage += 'Please enable location services.';
    }
    
    if (currentScreen === 'home') {
        showNotification(errorMessage);
    }
    
    currentCity = currentCity || "Lusaka";
}

function updateCitySpecificUI(city) {
    const cityElement = document.getElementById('currentCity');
    if (cityElement) {
        cityElement.textContent = city;
    }
}

function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371e3;
    const 1 = lat1 * Math.PI / 180;
    const 2 = lat2 * Math.PI / 180;
    const  = (lat2 - lat1) * Math.PI / 180;
    const  = (lon2 - lon1) * Math.PI / 180;

    const a = Math.sin(/2) * Math.sin(/2) +
              Math.cos(1) * Math.cos(2) *
              Math.sin(/2) * Math.sin(/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

    return R * c;
}

function forwardGeocode(query) {
    return new Promise(resolve => {
        if (!userLocation) {
            resolve([]);
            return;
        }
        
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=10&countrycodes=zm`)
            .then(response => response.json())
            .then(data => {
                const filteredResults = data.filter(result => {
                    const distance = calculateDistance(
                        userLocation.lat, userLocation.lng,
                        parseFloat(result.lat), parseFloat(result.lon)
                    );
                    return distance <= 50000;
                });
                
                resolve(filteredResults);
            })
            .catch(error => {
                console.error('Forward geocoding error:', error);
                resolve([]);
            });
    });
}

function updateFareEstimate() {
    const destination = document.getElementById('destinationLocation').value;
    
    if (destination.length > 3 && userLocation) {
        forwardGeocode(destination).then(results => {
            if (results.length > 0) {
                const destLat = parseFloat(results[0].lat);
                const destLng = parseFloat(results[0].lon);
                
                const distance = calculateDistance(
                    userLocation.lat, userLocation.lng,
                    destLat, destLng
                );
                
                // Base fare based on ride type
                let baseFare = 0;
                switch(selectedRideType) {
                    case 'premium':
                        baseFare = 35; // Premium base fare
                        break;
                    case 'economy':
                        baseFare = 18; // Economy base fare
                        break;
                    case 'standard':
                        baseFare = 23; // Standard base fare
                        break;
                    case 'truck':
                        baseFare = 40; // Truck base fare
                        break;
                }
                
                // Distance fare (K1 per 90 meters)
                if (distance > 0) {
                    baseFare += Math.ceil(distance / 90);
                }
                
                // Vehicle type multiplier
                switch(selectedVehicleType) {
                    case 'car':
                        baseFare = baseFare;
                        break;
                    case 'bike':
                        baseFare = baseFare * 0.7;
                        break;
                    case 'bicycle':
                        baseFare = baseFare * 0.5;
                        break;
                }
                
                // Promo code discount
                if (appliedPromoCode) {
                    baseFare = baseFare * 0.8; // 20% discount
                }
                
                document.getElementById('estimatedFare').textContent = `K${baseFare.toFixed(2)}`;
                
                const etaMinutes = Math.ceil((distance / 1000) / 30 * 60);
                document.getElementById('etaDisplay').textContent = `ETA: ${etaMinutes} min`;
                
                document.getElementById('requestRideBtn').disabled = false;
                
                rideFare = baseFare;
            }
        });
    } else {
        document.getElementById('estimatedFare').textContent = 'K0.00';
        document.getElementById('etaDisplay').textContent = 'ETA: -- min';
        document.getElementById('requestRideBtn').disabled = true;
    }
}

function requestRide() {
    const pickupLocation = document.getElementById('pickupLocation').value;
    const destinationLocation = document.getElementById('destinationLocation').value;
    
    if (!destinationLocation) {
        showNotification('Please enter a destination');
        return;
    }
    
    if (!userLocation) {
        showNotification('Unable to determine your location. Please try again.');
        return;
    }
    
    // Collect package details if active
    if (document.getElementById('packageForm').classList.contains('active')) {
        packageDetails = {
            receiverName: document.getElementById('receiverName').value,
            receiverPhone: document.getElementById('receiverPhone').value,
            packageDescription: document.getElementById('packageDescription').value,
            specialInstructions: document.getElementById('specialInstructions').value,
            packageValue: document.getElementById('packageValue').value
        };
    } else {
        packageDetails = null;
    }
    
    Promise.all([
        getFullAddress(userLocation.lat, userLocation.lng),
        forwardGeocode(destinationLocation)
    ]).then(([fullPickupAddress, destinationResults]) => {
        if (destinationResults.length === 0) {
            showNotification('Invalid destination address. Please select a valid destination.');
            return;
        }
        
        const destLat = parseFloat(destinationResults[0].lat);
        const destLng = parseFloat(destinationResults[0].lon);
        
        const distance = calculateDistance(
            userLocation.lat, userLocation.lng,
            destLat, destLng
        );
        
        // Calculate fare
        let baseFare = 0;
        switch(selectedRideType) {
            case 'premium':
                baseFare = 35;
                break;
            case 'economy':
                baseFare = 18;
                break;
            case 'standard':
                baseFare = 23;
                break;
            case 'truck':
                baseFare = 40;
                break;
        }
        
        if (distance > 0) {
            baseFare += Math.ceil(distance / 90);
        }
        
        switch(selectedVehicleType) {
            case 'car':
                baseFare = baseFare;
                break;
            case 'bike':
                baseFare = baseFare * 0.7;
                break;
            case 'bicycle':
                baseFare = baseFare * 0.5;
                break;
        }
        
        if (appliedPromoCode) {
            baseFare = baseFare * 0.8;
        }
        
        const rideId = database.ref().child('rides').push().key;
        
        const rideRequest = {
            id: rideId,
            passengerId: currentUser.uid,
            passengerName: userData.name || 'Passenger',
            passengerPhone: userData.phone || 'Not provided',
            pickupLocation: fullPickupAddress,
            pickupDisplayLocation: pickupLocation,
            destination: destinationLocation,
            pickupLat: userLocation.lat,
            pickupLng: userLocation.lng,
            destLat: destLat,
            destLng: destLng,
            rideType: selectedRideType,
            vehicleType: selectedVehicleType,
            fare: baseFare,
            distance: (distance / 1000).toFixed(2) + ' km',
            status: 'requested',
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            updatedAt: firebase.database.ServerValue.TIMESTAMP,
            promoCode: appliedPromoCode,
            paymentMethod: selectedPaymentType,
            packageDetails: packageDetails,
            currentCity: currentCity
        };
        
        currentRideRequestData = rideRequest;
        currentRideRequestType = 'standard';
        
        showPaymentSelection(baseFare);
    }).catch(error => {
        console.error('Error in ride request process:', error);
        showNotification('Error calculating route. Please try again.');
    });
}

function getFullAddress(lat, lng) {
    return new Promise((resolve, reject) => {
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=16&addressdetails=1&accept-language=en`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Full address geocoding error: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data && data.display_name) {
                    resolve(data.display_name);
                } else {
                    resolve(`${lat.toFixed(6)}, ${lng.toFixed(6)}`);
                }
            })
            .catch(error => {
                console.error('Full address geocoding error:', error);
                resolve(`${lat.toFixed(6)}, ${lng.toFixed(6)}`);
            });
    });
}

function showPaymentSelection(fare = null) {
    const calculatedFare = fare || rideFare;
    
    document.getElementById('paymentWalletBalance').textContent = `Balance: K${walletBalance.toFixed(2)}`;
    
    if (walletBalance < calculatedFare) {
        document.getElementById('insufficientBalance').style.display = 'block';
        document.getElementById('confirmPaymentBtn').disabled = true;
    } else {
        document.getElementById('insufficientBalance').style.display = 'none';
        document.getElementById('confirmPaymentBtn').disabled = false;
    }
    
    document.getElementById('paymentSelectionPopup').classList.remove('hidden');
}

function closePaymentSelection() {
    document.getElementById('paymentSelectionPopup').classList.add('hidden');
}

function submitRideRequest() {
    if (!currentRideRequestData) {
        showNotification('No ride request data found. Please try again.');
        return;
    }
    
    const rideRequest = currentRideRequestData;
    
    if (selectedPaymentType === 'wallet') {
        const newBalance = walletBalance - rideRequest.fare;
        
        database.ref('users/' + currentUser.uid).update({
            walletBalance: newBalance
        })
        .then(() => {
            walletBalance = newBalance;
            updateWalletBalanceUI();
            
            return database.ref('rides/' + rideRequest.id).set(rideRequest);
        })
        .then(() => {
            currentRide = rideRequest;
            
            closePaymentSelection();
            updateUIForActiveRide();
            
            document.getElementById('searchingAnimation').style.display = 'flex';
            document.getElementById('rideStatus').style.display = 'flex';
            document.getElementById('statusDot').className = 'status-dot searching';
            document.getElementById('statusText').textContent = 'Searching for driver';
            
            if (sosConfig && sosConfig.contact1) {
                document.getElementById('sosButton').style.display = 'flex';
            }
            
            showNotification('Ride requested. Searching for a driver...');
            
            listenForDriverAssignment(rideRequest.id);
        })
        .catch(error => {
            console.error('Error requesting ride:', error);
            showNotification('Error requesting ride. Please try again.');
        });
    } else {
        database.ref('rides/' + rideRequest.id).set(rideRequest)
            .then(() => {
                currentRide = rideRequest;
                
                closePaymentSelection();
                updateUIForActiveRide();
                
                document.getElementById('searchingAnimation').style.display = 'flex';
                document.getElementById('rideStatus').style.display = 'flex';
                document.getElementById('statusDot').className = 'status-dot searching';
                document.getElementById('statusText').textContent = 'Searching for driver';
                
                if (sosConfig && sosConfig.contact1) {
                    document.getElementById('sosButton').style.display = 'flex';
                }
                
                showNotification('Ride requested. Searching for a driver...');
                
                listenForDriverAssignment(rideRequest.id);
            })
            .catch(error => {
                console.error('Error requesting ride:', error);
                showNotification('Error requesting ride. Please try again.');
            });
    }
    
    currentRideRequestData = null;
}

function updateUIForActiveRide() {
    document.getElementById('rideRequestForm').style.display = 'none';
    document.getElementById('rideInfoPanel').style.display = 'block';
    document.getElementById('currentPickupLocation').textContent = currentRide.pickupDisplayLocation || currentRide.pickupLocation;
    document.getElementById('currentDestinationLocation').textContent = currentRide.destination;
    
    const baseFare = currentRide.fare;
    const discount = appliedPromoCode ? baseFare * 0.2 : 0;
    const totalFare = baseFare - discount;
    
    document.getElementById('baseFare').textContent = `K${baseFare.toFixed(2)}`;
    document.getElementById('discountFare').textContent = `-K${discount.toFixed(2)}`;
    document.getElementById('totalFare').textContent = `K${totalFare.toFixed(2)}`;
    
    // Show download receipt button
    if (currentRide.status === 'completed') {
        document.getElementById('downloadReceiptBtn').style.display = 'flex';
    }
}

function listenForDriverAssignment(rideId) {
    if (driverAssignmentListener) {
        driverAssignmentListener();
    }
    
    driverAssignmentListener = database.ref('rides/' + rideId).on('value', snapshot => {
        const ride = snapshot.val();
        if (!ride) {
            showNotification('Ride not found. Please try again.');
            return;
        }
        
        if (ride.driverId && ride.status === 'accepted') {
            handleDriverAssignment(ride);
        } else if (ride.status === 'completed') {
            showRideCompletion(ride);
        } else if (ride.status === 'cancelled') {
            handleRideCancellation(ride);
        } else if (ride.status === 'arrived') {
            showNotification('Your driver has arrived at the pickup location.');
        } else if (ride.status === 'picked_up') {
            showNotification('You have been picked up. Enjoy your ride!');
        } else if (ride.status === 'started') {
            showNotification('Your trip has started.');
        } else if (ride.status === 'emergency') {
            handleEmergencyRideAssignment(ride);
        }
    }, error => {
        console.error('Error listening for driver assignment:', error);
        showNotification('Connection error. Please check your internet connection.');
    });
}

function handleDriverAssignment(ride) {
    document.getElementById('searchingAnimation').style.display = 'none';
    document.getElementById('statusDot').className = 'status-dot arriving';
    document.getElementById('statusText').textContent = 'Driver arriving';
    document.getElementById('estimatedTime').style.display = 'flex';
    document.getElementById('timeText').textContent = '5 min';
    
    database.ref('users/' + ride.driverId).once('value')
        .then(driverSnapshot => {
            const driver = driverSnapshot.val();
            if (driver) {
                document.getElementById('driverName').textContent = driver.name || 'Driver';
                document.getElementById('driverPhone').textContent = driver.phone || 'N/A';
                document.getElementById('driverRating').textContent = driver.rating || '4.5';
                
                if (driver.vehicle) {
                    document.getElementById('vehicleDetails').textContent = 
                        `${driver.vehicle.type || 'Vehicle'} - ${driver.vehicle.licensePlate || 'ABC123'}`;
                }
                
                updateDriverDetailsCard(driver);
                
                addDriverMarker(ride.driverLng, ride.driverLat);
                drawRouteWithOSRM([ride.driverLng, ride.driverLat], [ride.pickupLng, ride.pickupLat]);
                trackDriverLocation(ride.driverId);
                showNotification(`Driver ${driver.name} is on the way!`);
            }
        });
    
    listenForRideStatusUpdates(ride.id);
}

function handleEmergencyRideAssignment(ride) {
    document.getElementById('searchingAnimation').style.display = 'none';
    document.getElementById('statusDot').className = 'status-dot emergency-ride-status';
    document.getElementById('statusText').textContent = 'Emergency vehicle dispatched';
    document.getElementById('estimatedTime').style.display = 'flex';
    document.getElementById('timeText').textContent = '3 min';
    
    // Add emergency vehicle marker based on type
    let emergencyType = 'emergency-ambulance';
    if (ride.emergencyType === 'fire-truck') emergencyType = 'emergency-fire';
    if (ride.emergencyType === 'police') emergencyType = 'emergency-police';
    
    addMarker([ride.driverLng, ride.driverLat], emergencyType);
    
    drawRouteWithOSRM([ride.driverLng, ride.driverLat], [ride.pickupLng, ride.pickupLat]);
    trackDriverLocation(ride.driverId);
    showNotification(`${ride.emergencyType} is on the way!`);
    
    listenForRideStatusUpdates(ride.id);
}

function updateDriverDetailsCard(driver) {
    const driverDetailsCard = document.getElementById('driverDetailsCard');
    driverDetailsCard.style.display = 'block';
    
    document.getElementById('driverFullName').textContent = driver.name || 'Driver';
    document.getElementById('driverContactPhone').textContent = driver.phone || 'Not available';
    document.getElementById('driverRatingValue').textContent = driver.rating ? `${driver.rating} ` : '4.5 ';
    document.getElementById('driverExperience').textContent = driver.experience || '2 years';
    
    if (driver.vehicle) {
        document.getElementById('vehicleType').textContent = driver.vehicle.type || 'Car';
        document.getElementById('vehicleModel').textContent = driver.vehicle.model || 'Not specified';
        document.getElementById('vehicleLicense').textContent = driver.vehicle.licensePlate || 'Not available';
        document.getElementById('vehicleColor').textContent = driver.vehicle.color || 'Not specified';
    }
}

function trackDriverLocation(driverId) {
    if (driverLocationListener) {
        driverLocationListener();
    }
    
    driverLocationListener = database.ref('driverLocations/' + driverId).on('value', snapshot => {
        const location = snapshot.val();
        if (location) {
            driverSource.clear();
            addMarker([location.longitude, location.latitude], 'driver');
            updateDriverETA(location.latitude, location.longitude);
        }
    });
}

function updateDriverETA(driverLat, driverLng) {
    if (userLocation) {
        const distance = calculateDistance(
            driverLat, driverLng,
            userLocation.lat, userLocation.lng
        );
        
        const etaMinutes = Math.ceil((distance / 1000) / 30 * 60);
        document.getElementById('timeText').textContent = `${etaMinutes} min`;
    }
}

function listenForRideStatusUpdates(rideId) {
    database.ref('rides/' + rideId).on('value', snapshot => {
        const ride = snapshot.val();
        if (ride) {
            currentRide = ride;
            
            switch(ride.status) {
                case 'accepted':
                    document.getElementById('statusText').textContent = 'Driver on the way';
                    break;
                case 'arrived':
                    document.getElementById('statusText').textContent = 'Driver arrived';
                    document.getElementById('statusDot').className = 'status-dot riding';
                    showNotification('Your driver has arrived!');
                    break;
                case 'started':
                    document.getElementById('statusText').textContent = 'Trip in progress';
                    addMarker([ride.destLng, ride.destLat], 'destination');
                    drawRouteWithOSRM([ride.pickupLng, ride.pickupLat], [ride.destLng, ride.destLat]);
                    break;
                case 'completed':
                    document.getElementById('statusText').textContent = 'Trip completed';
                    document.getElementById('rideStatus').style.display = 'none';
                    document.getElementById('estimatedTime').style.display = 'none';
                    document.getElementById('sosButton').style.display = 'none';
                    resetUIAfterRide();
                    showNotification('Trip completed. Thank you for using Jubel!');
                    generateReceipt(ride);
                    break;
                case 'cancelled':
                    document.getElementById('rideStatus').style.display = 'none';
                    document.getElementById('estimatedTime').style.display = 'none';
                    document.getElementById('sosButton').style.display = 'none';
                    resetUIAfterRide();
                    showNotification('Ride cancelled');
                    break;
                case 'emergency':
                    document.getElementById('statusText').textContent = 'Emergency vehicle dispatched';
                    document.getElementById('statusDot').className = 'status-dot emergency-ride-status';
                    break;
            }
        }
    });
}

function generateReceipt(ride) {
    const receipt = {
        id: `JUB-${ride.id.substring(0, 8).toUpperCase()}`,
        date: new Date(ride.timestamp).toLocaleDateString(),
        time: new Date(ride.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
        rideType: ride.rideType ? ride.rideType.charAt(0).toUpperCase() + ride.rideType.slice(1) : 'Standard',
        pickup: ride.pickupDisplayLocation || ride.pickupLocation,
        destination: ride.destination,
        distance: ride.distance || '0 km',
        baseFare: `K${(ride.fare * 0.7).toFixed(2)}`,
        distanceFare: `K${(ride.fare * 0.3).toFixed(2)}`,
        discount: appliedPromoCode ? `-K${(ride.fare * 0.2).toFixed(2)}` : 'K0.00',
        total: `K${ride.fare.toFixed(2)}`
    };
    
    // Store receipt in Firebase
    database.ref('receipts/' + ride.id).set({
        ...receipt,
        passengerId: currentUser.uid,
        rideId: ride.id,
        createdAt: firebase.database.ServerValue.TIMESTAMP
    });
    
    showReceiptPopup(receipt);
}

function showReceiptPopup(receipt) {
    document.getElementById('receiptNumber').textContent = receipt.id;
    document.getElementById('receiptDate').textContent = receipt.date;
    document.getElementById('receiptTime').textContent = receipt.time;
    document.getElementById('receiptRideType').textContent = receipt.rideType;
    document.getElementById('receiptPickup').textContent = receipt.pickup;
    document.getElementById('receiptDestination').textContent = receipt.destination;
    document.getElementById('receiptDistance').textContent = receipt.distance;
    document.getElementById('receiptBaseFare').textContent = receipt.baseFare;
    document.getElementById('receiptDistanceFare').textContent = receipt.distanceFare;
    document.getElementById('receiptDiscount').textContent = receipt.discount;
    document.getElementById('receiptTotal').textContent = receipt.total;
    
    document.getElementById('receiptPopup').classList.remove('hidden');
}

function handleRideCancellation(ride) {
    document.getElementById('searchingAnimation').style.display = 'none';
    showNotification('Ride has been cancelled.');
    resetUIAfterRide();
    currentRide = null;
    
    driverSource.clear();
    
    if (driverAssignmentListener) {
        driverAssignmentListener();
        driverAssignmentListener = null;
    }
    
    if (driverLocationListener) {
        driverLocationListener();
        driverLocationListener = null;
    }
}

function cancelRide() {
    if (currentRide) {
        if (confirm('Are you sure you want to cancel this ride?')) {
            database.ref('rides/' + currentRide.id).update({
                status: 'cancelled',
                cancelledAt: firebase.database.ServerValue.TIMESTAMP,
                updatedAt: firebase.database.ServerValue.TIMESTAMP
            })
            .then(() => {
                resetUIAfterRide();
                showNotification('Ride cancelled');
            })
            .catch(error => {
                console.error('Error cancelling ride:', error);
                showNotification('Error cancelling ride. Please try again.');
            });
        }
    }
}

function contactDriver() {
    if (currentRide && currentRide.driverId) {
        database.ref('users/' + currentRide.driverId).once('value')
            .then(snapshot => {
                const driver = snapshot.val();
                if (driver && driver.phone) {
                    showNotification(`Calling driver: ${driver.phone}`);
                    window.open(`tel:${driver.phone}`, '_self');
                } else {
                    showNotification('Driver phone number not available.');
                }
            });
    }
}

function applyPromoCode() {
    const promoCode = document.getElementById('promoCode').value.trim();
    
    if (!promoCode) {
        showNotification('Please enter a promo code.');
        return;
    }
    
    if (promoCode.startsWith('JUBEL')) {
        applyReferralCode(promoCode);
    } else {
        if (promoCode.startsWith('JUBEL-')) {
            appliedPromoCode = promoCode;
            showNotification('Promo code applied! 20% discount will be applied to your ride.');
            updateFareEstimate();
            
            document.getElementById('promoCode').style.borderColor = 'var(--success-green)';
            document.getElementById('applyPromoBtn').innerHTML = '<i class="fas fa-check"></i> Applied';
            document.getElementById('applyPromoBtn').classList.remove('btn-promo');
            document.getElementById('applyPromoBtn').classList.add('btn-success');
        } else {
            showNotification('Invalid promo code. Please check and try again.');
            document.getElementById('promoCode').style.borderColor = 'var(--error-red)';
        }
    }
}

function applyReferralCode(referralCode) {
    database.ref('users').orderByChild('referralCode').equalTo(referralCode).once('value')
        .then(snapshot => {
            if (snapshot.exists()) {
                const referrerData = snapshot.val();
                const referrerId = Object.keys(referrerData)[0];
                const referrer = referrerData[referrerId];
                
                // Apply instant discount for new user
                appliedPromoCode = referralCode;
                showNotification('Referral code applied! 50% discount will be applied to your ride.');
                updateFareEstimate();
                
                document.getElementById('promoCode').style.borderColor = 'var(--success-green)';
                document.getElementById('applyPromoBtn').innerHTML = '<i class="fas fa-check"></i> Applied';
                document.getElementById('applyPromoBtn').classList.remove('btn-promo');
                document.getElementById('applyPromoBtn').classList.add('btn-success');
                
                // Create referral reward record - reward will be given when ride is completed
                const rewardId = database.ref().child('referralRewards').push().key;
                database.ref('referralRewards/' + rewardId).set({
                    id: rewardId,
                    referrerId: referrerId,
                    referredUserId: currentUser.uid,
                    referralCode: referralCode,
                    amount: 25,
                    status: 'pending',
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                });
                
                showNotification('Referral recorded. K25 will be rewarded to referrer after your first completed ride.');
            } else {
                showNotification('Invalid referral code. Please check and try again.');
                document.getElementById('promoCode').style.borderColor = 'var(--error-red)';
            }
        })
        .catch(error => {
            console.error('Error applying referral code:', error);
            showNotification('Error applying referral code. Please try again.');
        });
}

function resetUIAfterRide() {
    document.getElementById('rideRequestForm').style.display = 'flex';
    document.getElementById('rideInfoPanel').style.display = 'none';
    document.getElementById('driverDetailsCard').style.display = 'none';
    document.getElementById('destinationLocation').value = '';
    
    document.getElementById('packageForm').classList.remove('active');
    document.getElementById('receiverName').value = '';
    document.getElementById('receiverPhone').value = '';
    document.getElementById('packageDescription').value = '';
    document.getElementById('specialInstructions').value = '';
    document.getElementById('packageValue').value = '';
    
    document.getElementById('promoCode').value = '';
    appliedPromoCode = null;
    document.getElementById('promoCode').style.borderColor = '';
    document.getElementById('applyPromoBtn').innerHTML = 'Apply';
    document.getElementById('applyPromoBtn').classList.remove('btn-success');
    document.getElementById('applyPromoBtn').classList.add('btn-promo');
    document.getElementById('promoSection').classList.remove('active');
    
    if (driverMarker) {
        driverSource.clear();
        driverMarker = null;
    }
    
    if (destinationMarker) {
        destinationSource.clear();
        destinationMarker = null;
    }
    
    if (routeSource) {
        routeSource.clear();
    }
    
    if (driverLocationListener) {
        driverLocationListener();
        driverLocationListener = null;
    }
    
    currentRide = null;
}

function loadPassengerData() {
    if (currentUser) {
        updateUserStats();
    }
}

function loadAccountData() {
    if (currentUser && userData) {
        document.getElementById('accountName').textContent = userData.name || 'Passenger';
        document.getElementById('accountPhone').textContent = userData.phone || 'Not set';
        document.getElementById('accountEmail').textContent = userData.email || 'Not set';
        document.getElementById('referralCode').textContent = userData.referralCode || 'JUBEL-XXXX';
        
        walletBalance = userData.walletBalance || 0;
        document.getElementById('accountBalance').textContent = `K${walletBalance.toFixed(2)}`;
        
        const accountAvatar = document.getElementById('accountAvatar');
        if (userData.name) {
            accountAvatar.textContent = userData.name.charAt(0).toUpperCase();
        } else {
            accountAvatar.innerHTML = '<i class="fas fa-user"></i>';
        }
        
        updateUserStats();
    }
}

function updateUserStats() {
    if (!currentUser) return;
    
    database.ref('rides').orderByChild('passengerId').equalTo(currentUser.uid).once('value')
        .then(snapshot => {
            const rides = snapshot.val();
            if (rides) {
                const ridesArray = Object.values(rides);
                
                userStats = {
                    completed: ridesArray.filter(ride => ride.status === 'completed' || ride.status === 'paid').length,
                    cancelled: ridesArray.filter(ride => ride.status === 'cancelled').length,
                    pending: ridesArray.filter(ride => ride.status === 'requested' || ride.status === 'accepted').length
                };
                
                document.getElementById('ridesCompleted').textContent = userStats.completed;
                document.getElementById('ridesCancelled').textContent = userStats.cancelled;
                document.getElementById('ridesPending').textContent = userStats.pending;
            }
        });
}

function shareReferralCode() {
    const referralCode = document.getElementById('referralCode').textContent;
    const shareText = `Join me on Jubel! Use my referral code ${referralCode} for 50% off your first ride. Download the app now!`;
    
    if (navigator.share) {
        navigator.share({
            title: 'Jubel Referral',
            text: shareText,
            url: window.location.href
        })
        .then(() => showNotification('Referral code shared successfully!'))
        .catch(error => console.error('Error sharing:', error));
    } else {
        navigator.clipboard.writeText(shareText)
            .then(() => showNotification('Referral code copied to clipboard!'));
    }
}

function depositToWallet() {
    const amount = prompt('Enter deposit amount (K):');
    if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
        const depositAmount = parseFloat(amount);
        const newBalance = walletBalance + depositAmount;
        
        database.ref('users/' + currentUser.uid).update({
            walletBalance: newBalance
        })
        .then(() => {
            walletBalance = newBalance;
            updateWalletBalanceUI();
            showNotification(`Successfully deposited K${depositAmount.toFixed(2)} to your wallet.`);
        })
        .catch(error => {
            console.error('Error depositing to wallet:', error);
            showNotification('Error processing deposit. Please try again.');
        });
    } else if (amount) {
        showNotification('Please enter a valid amount.');
    }
}

function withdrawFromWallet() {
    if (walletBalance <= 0) {
        showNotification('Your wallet balance is zero.');
        return;
    }
    
    const amount = prompt(`Enter withdrawal amount (K). Available: K${walletBalance.toFixed(2)}:`);
    if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
        const withdrawalAmount = parseFloat(amount);
        
        if (withdrawalAmount > walletBalance) {
            showNotification('Insufficient balance for this withdrawal.');
            return;
        }
        
        const newBalance = walletBalance - withdrawalAmount;
        
        database.ref('users/' + currentUser.uid).update({
            walletBalance: newBalance
        })
        .then(() => {
            walletBalance = newBalance;
            updateWalletBalanceUI();
            showNotification(`Successfully withdrew K${withdrawalAmount.toFixed(2)} from your wallet.`);
        })
        .catch(error => {
            console.error('Error withdrawing from wallet:', error);
            showNotification('Error processing withdrawal. Please try again.');
        });
    } else if (amount) {
        showNotification('Please enter a valid amount.');
    }
}

function contactWhatsApp() {
    const phoneNumber = '0768658484';
    const message = 'Hello, I need assistance with Jubel rides.';
    const url = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
    window.open(url, '_blank');
}

function contactPhone() {
    const phoneNumber = '0768658484';
    window.open(`tel:${phoneNumber}`, '_self');
}

function loadRideHistory() {
    if (currentUser) {
        const filter = document.getElementById('historyFilter').value;
        const dateFilter = document.getElementById('historyDate').value;
        
        if (rideHistoryListener) {
            rideHistoryListener();
        }
        
        rideHistoryListener = database.ref('rides').orderByChild('passengerId').equalTo(currentUser.uid).on('value', snapshot => {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';
            
            const rides = snapshot.val();
            if (rides) {
                let ridesArray = Object.keys(rides).map(rideId => ({
                    id: rideId,
                    ...rides[rideId]
                }));
                
                if (filter !== 'all') {
                    if (filter === 'emergency') {
                        ridesArray = ridesArray.filter(ride => ride.emergencyType);
                    } else if (['premium', 'economy', 'standard', 'truck'].includes(filter)) {
                        ridesArray = ridesArray.filter(ride => ride.rideType === filter);
                    } else {
                        ridesArray = ridesArray.filter(ride => ride.status === filter);
                    }
                }
                
                if (dateFilter) {
                    const filterDate = new Date(dateFilter);
                    ridesArray = ridesArray.filter(ride => {
                        const rideDate = new Date(ride.timestamp);
                        return rideDate.toDateString() === filterDate.toDateString();
                    });
                }
                
                ridesArray.sort((a, b) => b.timestamp - a.timestamp);
                
                if (ridesArray.length === 0) {
                    historyList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--medium-gray);">No rides found matching your criteria.</p>';
                    return;
                }
                
                ridesArray.forEach(ride => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item';
                    historyItem.setAttribute('data-ride-id', ride.id);
                    
                    const date = new Date(ride.timestamp);
                    const formattedDate = date.toLocaleDateString();
                    const formattedTime = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    // Determine ride type badge
                    let typeClass = 'ride';
                    let typeText = 'Ride';
                    let typeBadge = '';
                    
                    if (ride.emergencyType) {
                        typeClass = 'emergency';
                        typeText = 'Emergency';
                        typeBadge = '<span class="emergency-badge">EMERGENCY</span>';
                    } else if (ride.rideType) {
                        typeClass = ride.rideType;
                        typeText = ride.rideType.charAt(0).toUpperCase() + ride.rideType.slice(1);
                        typeBadge = `<span class="${ride.rideType}-badge">${typeText.toUpperCase()}</span>`;
                    }
                    
                    let statusClass = 'status-requested';
                    let statusText = getStatusText(ride.status);
                    
                    if (ride.status === 'accepted') {
                        statusClass = 'status-accepted';
                    } else if (ride.status === 'completed' || ride.status === 'paid') {
                        statusClass = 'status-completed';
                    } else if (ride.status === 'cancelled') {
                        statusClass = 'status-cancelled';
                    } else if (ride.status === 'requested') {
                        statusClass = 'status-pending';
                        statusText = 'Pending';
                    } else if (ride.status === 'emergency') {
                        statusClass = 'status-emergency';
                        statusText = 'Emergency';
                    }
                    
                    const hasPackage = ride.packageDetails && Object.keys(ride.packageDetails).length > 0;
                    
                    let historyContent = `
                        <div class="history-item-type ${typeClass}">
                            ${typeText}
                            ${typeBadge}
                        </div>
                        <div class="history-locations">
                            <div>
                                <strong>From:</strong> ${ride.pickupDisplayLocation || ride.pickupLocation}
                            </div>
                            <div>
                                <strong>To:</strong> ${ride.destination}
                            </div>
                        </div>
                        ${hasPackage ? `
                        <div class="history-package-details">
                            <div class="package-detail-row">
                                <span class="package-detail-label">Receiver:</span>
                                <span class="package-detail-value">${ride.packageDetails.receiverName || 'N/A'}</span>
                            </div>
                            <div class="package-detail-row">
                                <span class="package-detail-label">Package:</span>
                                <span class="package-detail-value">${ride.packageDetails.packageDescription || 'N/A'}</span>
                            </div>
                        </div>
                        ` : ''}
                        <div class="history-info">
                            <div class="history-fare">K${ride.fare ? ride.fare.toFixed(2) : '0.00'}</div>
                            <div>${formattedDate} ${formattedTime}</div>
                            <div class="status-badge ${statusClass}">
                                ${statusText}
                            </div>
                        </div>
                    `;
                    
                    historyItem.innerHTML = historyContent;
                    historyList.appendChild(historyItem);
                });
            } else {
                historyList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--medium-gray);">No ride history found.</p>';
            }
        }, error => {
            console.error('Error loading ride history:', error);
            historyList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--error-red);">Error loading ride history.</p>';
        });
    }
}

function getStatusText(status) {
    const statusMap = {
        'requested': 'Awaiting Driver',
        'accepted': 'In Progress',
        'completed': 'Completed',
        'paid': 'Completed',
        'cancelled': 'Cancelled',
        'arrived': 'Driver Arrived',
        'picked_up': 'Picked Up',
        'started': 'Trip Started',
        'emergency': 'Emergency Dispatched'
    };
    
    return statusMap[status] || status;
}

function showRideDetailsPopup(rideId) {
    database.ref('rides/' + rideId).once('value')
        .then(snapshot => {
            const ride = snapshot.val();
            if (ride) {
                document.getElementById('popupRidePickup').textContent = ride.pickupDisplayLocation || ride.pickupLocation;
                document.getElementById('popupRideDestination').textContent = ride.destination;
                document.getElementById('popupRideFare').textContent = `K${ride.fare ? ride.fare.toFixed(2) : '0.00'}`;
                document.getElementById('popupRideDistance').textContent = ride.distance || 'Calculating...';
                document.getElementById('popupRideStatus').textContent = getStatusText(ride.status);
                
                let rideTypeText = 'Standard';
                if (ride.emergencyType) {
                    rideTypeText = `Emergency - ${ride.emergencyType}`;
                } else if (ride.rideType) {
                    rideTypeText = ride.rideType.charAt(0).toUpperCase() + ride.rideType.slice(1);
                }
                document.getElementById('popupRideType').textContent = rideTypeText;
                
                const date = new Date(ride.timestamp);
                document.getElementById('popupRideDate').textContent = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                updatePopupRideMap(ride);
                
                if (ride.driverId) {
                    database.ref('users/' + ride.driverId).once('value')
                        .then(driverSnapshot => {
                            const driver = driverSnapshot.val();
                            if (driver) {
                                document.getElementById('popupDriverName').textContent = driver.name || 'Driver';
                                document.getElementById('popupDriverPhone').textContent = driver.phone || 'N/A';
                                document.getElementById('popupDriverVehicle').textContent = `${driver.vehicleType || 'Car'} (${driver.licensePlate || 'N/A'})`;
                                document.getElementById('popupDriverRating').textContent = driver.rating || '4.5';
                                document.getElementById('popupDriverProgress').textContent = getStatusText(ride.status);
                                
                                document.getElementById('popupDriverDetails').classList.remove('hidden');
                            }
                        });
                } else {
                    document.getElementById('popupDriverDetails').classList.add('hidden');
                }
                
                document.getElementById('rideDetailsPopup').classList.remove('hidden');
            }
        })
        .catch(error => {
            console.error('Error loading ride details:', error);
            showNotification('Error loading ride details.');
        });
}

function updateDriverProgress(status) {
    const progressElement = document.getElementById('popupDriverProgress');
    
    switch(status) {
        case 'requested':
            progressElement.textContent = 'Waiting for driver to accept';
            break;
        case 'accepted':
            progressElement.textContent = 'Driver on the way to pickup';
            break;
        case 'arrived':
            progressElement.textContent = 'Driver arrived at pickup location';
            break;
        case 'picked_up':
            progressElement.textContent = 'Passenger picked up';
            break;
        case 'started':
            progressElement.textContent = 'Trip in progress';
            break;
        case 'completed':
            progressElement.textContent = 'Trip completed';
            break;
        case 'paid':
            progressElement.textContent = 'Payment completed';
            break;
        case 'emergency':
            progressElement.textContent = 'Emergency vehicle dispatched';
            break;
        default:
            progressElement.textContent = 'Status: ' + status;
    }
}

function closeRideDetailsPopup() {
    document.getElementById('rideDetailsPopup').classList.add('hidden');
}

function showRideCompletion(ride) {
    document.getElementById('finalFare').textContent = `K${ride.fare.toFixed(2)}`;
    switchScreen('rideCompletionScreen');
    showNotification('Ride completed. Please complete payment and rating.');
    
    if (driverMarker) {
        driverSource.clear();
        driverMarker = null;
    }
    
    if (driverAssignmentListener) {
        driverAssignmentListener();
        driverAssignmentListener = null;
    }
    
    if (driverLocationListener) {
        driverLocationListener();
        driverLocationListener = null;
    }
}

function centerMap() {
    if (userLocation) {
        const center = ol.proj.fromLonLat([userLocation.lng, userLocation.lat]);
        mapView.animate({
            center: center,
            zoom: 16,
            duration: 500
        });
        showNotification('Map centered on your location');
    }
}

function togglePanelCollapse() {
    const panel = document.getElementById('passengerPanel');
    panel.classList.toggle('collapsed');
}

function useSavedLocation(addressType) {
    if (userData) {
        const address = userData[addressType + 'Address'];
        
        if (address) {
            document.getElementById('destinationLocation').value = address;
            updateFareEstimate();
            showNotification(`${addressType.charAt(0).toUpperCase() + addressType.slice(1)} address set as destination.`);
            
            forwardGeocode(address).then(results => {
                if (results.length > 0) {
                    addMarker([parseFloat(results[0].lon), parseFloat(results[0].lat)], 'destination', address);
                    
                    if (userLocation) {
                        drawRouteWithOSRM([userLocation.lng, userLocation.lat], [parseFloat(results[0].lon), parseFloat(results[0].lat)]);
                    }
                    
                    document.getElementById('requestRideBtn').disabled = false;
                }
            });
        } else {
            showNotification(`No ${addressType} address saved. Please add it in settings.`);
        }
    }
}

function getPlaceType(place) {
    if (place.type === 'restaurant' || place.class === 'amenity' && place.type === 'restaurant') {
        return 'restaurant';
    } else if (place.type === 'cafe' || place.class === 'amenity' && place.type === 'cafe') {
        return 'cafe';
    } else if (place.type === 'bar' || place.class === 'amenity' && place.type === 'bar') {
        return 'bar';
    } else if (place.type === 'pub' || place.class === 'amenity' && place.type === 'pub') {
        return 'pub';
    } else if (place.type === 'fast_food' || place.class === 'amenity' && place.type === 'fast_food') {
        return 'fast_food';
    } else if (place.type === 'bank' || place.class === 'amenity' && place.type === 'bank') {
        return 'bank';
    } else if (place.type === 'atm' || place.class === 'amenity' && place.type === 'atm') {
        return 'atm';
    } else if (place.type === 'hospital' || place.class === 'amenity' && place.type === 'hospital') {
        return 'hospital';
    } else if (place.type === 'pharmacy' || place.class === 'amenity' && place.type === 'pharmacy') {
        return 'pharmacy';
    } else if (place.type === 'school' || place.class === 'amenity' && place.type === 'school') {
        return 'school';
    } else if (place.type === 'university' || place.class === 'amenity' && place.type === 'university') {
        return 'university';
    } else if (place.type === 'library' || place.class === 'amenity' && place.type === 'library') {
        return 'library';
    } else if (place.type === 'cinema' || place.class === 'amenity' && place.type === 'cinema') {
        return 'cinema';
    } else if (place.type === 'theatre' || place.class === 'amenity' && place.type === 'theatre') {
        return 'theatre';
    } else if (place.type === 'museum' || place.class === 'amenity' && place.type === 'museum') {
        return 'museum';
    } else if (place.type === 'hotel' || place.class === 'tourism' && place.type === 'hotel') {
        return 'hotel';
    } else if (place.type === 'supermarket' || place.class === 'shop' && place.type === 'supermarket') {
        return 'supermarket';
    } else if (place.type === 'mall' || place.class === 'shop' && place.type === 'mall') {
        return 'mall';
    } else if (place.type === 'clothes' || place.class === 'shop' && place.type === 'clothes') {
        return 'clothes';
    } else if (place.type === 'fuel' || place.class === 'amenity' && place.type === 'fuel') {
        return 'fuel';
    } else if (place.type === 'parking' || place.class === 'amenity' && place.type === 'parking') {
        return 'parking';
    } else if (place.type === 'bus_station' || place.class === 'amenity' && place.type === 'bus_station') {
        return 'bus_station';
    } else if (place.type === 'taxi' || place.class === 'amenity' && place.type === 'taxi') {
        return 'taxi';
    } else if (place.type === 'police' || place.class === 'amenity' && place.type === 'police') {
        return 'police';
    } else if (place.type === 'market' || place.class === 'amenity' && place.type === 'marketplace') {
        return 'market';
    } else if (place.type === 'post_office' || place.class === 'amenity' && place.type === 'post_office') {
        return 'post_office';
    } else if (place.type === 'place_of_worship' || place.class === 'amenity' && place.type === 'place_of_worship') {
        return 'place_of_worship';
    } else if (place.type === 'stadium' || place.class === 'leisure' && place.type === 'stadium') {
        return 'stadium';
    } else if (place.type === 'park' || place.class === 'leisure' && place.type === 'park') {
        return 'park';
    } else if (place.type === 'monument' || place.class === 'historic' && place.type === 'monument') {
        return 'monument';
    } else if (place.type === 'castle' || place.class === 'historic' && place.type === 'castle') {
        return 'castle';
    } else {
        return 'place';
    }
}

function getPlaceIcon(placeType) {
    const icons = {
        'restaurant': '',
        'cafe': '',
        'bar': '',
        'pub': '',
        'fast_food': '',
        'bank': '',
        'atm': '',
        'hospital': '',
        'pharmacy': '',
        'school': '',
        'university': '',
        'library': '',
        'cinema': '',
        'theatre': '',
        'museum': '',
        'hotel': '',
        'supermarket': '',
        'mall': '',
        'clothes': '',
        'fuel': '',
        'parking': '',
        'bus_station': '',
        'taxi': '',
        'police': '',
        'market': '',
        'post_office': '',
        'place_of_worship': '',
        'stadium': '',
        'park': '',
        'monument': '',
        'castle': ''
    };
    
    return icons[placeType] || '';
}

function startLocationTracking() {
    if (navigator.geolocation && currentUser) {
        locationWatchId = navigator.geolocation.watchPosition(position => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            userLocation = { lat, lng };
            
            database.ref('passengerLocations/' + currentUser.uid).set({
                latitude: lat,
                longitude: lng,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            
            currentLocationSource.clear();
            addMarker([lng, lat], 'currentLocation', 'Your location');
            
            if (destinationMarker) {
                const destination = document.getElementById('destinationLocation').value;
                if (destination) {
                    updateFareEstimate();
                }
            }
        }, error => {
            console.error('Location tracking error:', error);
        }, {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 30000
        });
    }
}

function showNotification(message) {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.style.display = 'block';
    
    setTimeout(() => {
        notification.style.display = 'none';
    }, 4000);
}

function switchScreen(screenId) {
    const previousScreen = currentScreen;
    currentScreen = screenId;
    
    document.querySelectorAll('.screen-content').forEach(screen => {
        screen.classList.remove('active');
    });
    
    document.getElementById(screenId + 'Screen').classList.add('active');
    
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`.nav-btn[data-screen="${screenId}"]`).classList.add('active');
    
    if (screenId === 'home') {
        document.querySelectorAll('.home-only').forEach(el => {
            el.style.display = 'flex';
        });
        
        if (previousScreen !== 'home' && homeScreenRefreshRequired) {
            refreshHomeScreen();
        }
    } else {
        document.querySelectorAll('.home-only').forEach(el => {
            el.style.display = 'none';
        });
        
        homeScreenRefreshRequired = true;
    }
    
    if (screenId === 'history') {
        loadRideHistory();
    } else if (screenId === 'account') {
        loadAccountData();
    } else if (screenId === 'emergency') {
        // Emergency screen specific initialization
    }
}

function refreshHomeScreen() {
    console.log("Refreshing home screen...");
    
    refreshPassengerPosition();
    document.getElementById('destinationLocation').value = '';
    
    destinationSource.clear();
    routeSource.clear();
    
    document.getElementById('estimatedFare').textContent = 'K0.00';
    document.getElementById('etaDisplay').textContent = 'ETA: -- min';
    document.getElementById('requestRideBtn').disabled = true;
    
    document.getElementById('promoSection').classList.remove('active');
    document.getElementById('promoCode').value = '';
    appliedPromoCode = null;
    
    document.getElementById('packageForm').classList.remove('active');
    document.getElementById('packageToggle').style.display = 'none';
    
    document.getElementById('rideRequestForm').style.display = 'flex';
    document.getElementById('rideInfoPanel').style.display = 'none';
    
    homeScreenRefreshRequired = false;
    
    showNotification('Home screen refreshed');
}

// Emergency Functions
function openEmergencyPopup() {
    document.getElementById('emergencyPopup').classList.remove('hidden');
}

function closeEmergencyPopup() {
    document.getElementById('emergencyPopup').classList.add('hidden');
    document.getElementById('popupEmergencyQuestionnaire').classList.remove('active');
}

function handleEmergencySelection(emergencyType) {
    currentEmergencyType = emergencyType;
    
    document.getElementById('popupEmergencyType').value = getEmergencyTypeName(emergencyType);
    document.getElementById('popupEmergencyQuestionnaireTitle').textContent = `${getEmergencyTypeName(emergencyType)} Request`;
    document.getElementById('popupEmergencyQuestionnaire').classList.add('active');
}

function getEmergencyTypeName(emergencyType) {
    const names = {
        'ambulance': 'Ambulance',
        'fire-truck': 'Fire Truck',
        'police': 'Police',
        'emergency-ride': 'Emergency Ride',
        'emergency-delivery': 'Emergency Delivery'
    };
    return names[emergencyType] || emergencyType;
}

function submitEmergencyRequest() {
    const description = document.getElementById('popupEmergencyDescription').value;
    const numberOfPeople = document.getElementById('popupNumberOfPeople').value;
    const severity = document.getElementById('popupEmergencySeverity').value;
    const additionalInfo = document.getElementById('popupAdditionalInfo').value;
    
    if (!description) {
        showNotification('Please describe the emergency.');
        return;
    }
    
    if (!userLocation) {
        showNotification('Unable to determine your location. Please enable location services.');
        return;
    }
    
    const emergencyId = database.ref().child('emergencyRequests').push().key;
    
    const emergencyRequest = {
        id: emergencyId,
        passengerId: currentUser.uid,
        passengerName: userData.name || 'Passenger',
        passengerPhone: userData.phone || 'Not provided',
        emergencyType: currentEmergencyType,
        description: description,
        numberOfPeople: numberOfPeople,
        severity: severity,
        additionalInfo: additionalInfo,
        location: {
            lat: userLocation.lat,
            lng: userLocation.lng
        },
        status: 'requested',
        timestamp: firebase.database.ServerValue.TIMESTAMP
    };
    
    // Create emergency ride record
    const rideId = database.ref().child('rides').push().key;
    
    const emergencyRide = {
        id: rideId,
        passengerId: currentUser.uid,
        passengerName: userData.name || 'Passenger',
        emergencyType: currentEmergencyType,
        emergencyDetails: emergencyRequest,
        status: 'emergency',
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        pickupLat: userLocation.lat,
        pickupLng: userLocation.lng,
        fare: 0, // Emergency rides are free
        currentCity: currentCity
    };
    
    database.ref('emergencyRequests/' + emergencyId).set(emergencyRequest)
        .then(() => {
            return database.ref('rides/' + rideId).set(emergencyRide);
        })
        .then(() => {
            currentRide = emergencyRide;
            
            closeEmergencyPopup();
            updateUIForActiveRide();
            
            document.getElementById('searchingAnimation').style.display = 'flex';
            document.getElementById('rideStatus').style.display = 'flex';
            document.getElementById('statusDot').className = 'status-dot emergency-ride-status';
            document.getElementById('statusText').textContent = 'Dispatching emergency vehicle';
            
            if (sosConfig && sosConfig.contact1) {
                document.getElementById('sosButton').style.display = 'flex';
            }
            
            showNotification('Emergency request sent. Help is on the way!');
            
            listenForDriverAssignment(rideId);
        })
        .catch(error => {
            console.error('Error sending emergency request:', error);
            showNotification('Error sending emergency request. Please try again or call emergency services directly.');
        });
}

// More Options Functions
function toggleMoreOptions() {
    const dropdown = document.getElementById('moreOptionsDropdown');
    dropdown.classList.toggle('active');
}

function handleMoreOptionSelection(option) {
    document.getElementById('orderForSomeoneForm').classList.remove('active');
    document.getElementById('expressDeliveryForm').classList.remove('active');
    document.getElementById('sosSetupForm').classList.remove('active');
    document.getElementById('rideRequestForm').style.display = 'none';
    
    switch(option) {
        case 'order-for-someone':
            document.getElementById('orderForSomeoneForm').classList.add('active');
            activeMoreOption = 'order-for-someone';
            break;
        case 'express-delivery':
            document.getElementById('expressDeliveryForm').classList.add('active');
            activeMoreOption = 'express-delivery';
            break;
        case 'sos-setup':
            document.getElementById('sosSetupForm').classList.add('active');
            activeMoreOption = 'sos-setup';
            break;
    }
    
    document.getElementById('moreOptionsDropdown').classList.remove('active');
}

function cancelMoreOptionForm() {
    document.getElementById('orderForSomeoneForm').classList.remove('active');
    document.getElementById('expressDeliveryForm').classList.remove('active');
    document.getElementById('sosSetupForm').classList.remove('active');
    
    document.getElementById('rideRequestForm').style.display = 'flex';
    
    activeMoreOption = null;
}

// Order for Someone Else Functions
function calculateRecipientDeliveryFee() {
    const pickupLocation = document.getElementById('recipientPickupLocation').value;
    const destinationLocation = document.getElementById('recipientDestinationLocation').value;
    
    if (pickupLocation.length > 3 && destinationLocation.length > 3) {
        Promise.all([
            forwardGeocode(pickupLocation),
            forwardGeocode(destinationLocation)
        ]).then(([pickupResults, destinationResults]) => {
            if (pickupResults.length > 0 && destinationResults.length > 0) {
                const pickupLat = parseFloat(pickupResults[0].lat);
                const pickupLng = parseFloat(pickupResults[0].lon);
                const destLat = parseFloat(destinationResults[0].lat);
                const destLng = parseFloat(destinationResults[0].lon);
                
                const distance = calculateDistance(pickupLat, pickupLng, destLat, destLng);
                
                let baseFare = 23;
                
                if (distance > 0) {
                    baseFare += Math.ceil(distance / 90);
                }
                
                document.getElementById('recipientDeliveryFee').textContent = `K${baseFare.toFixed(2)}`;
                
                const etaMinutes = Math.ceil((distance / 1000) / 30 * 60);
                document.getElementById('recipientEtaDisplay').textContent = `ETA: ${etaMinutes} min`;
                
                document.getElementById('orderForSomeoneBtn').disabled = false;
            }
        });
    } else {
        document.getElementById('recipientDeliveryFee').textContent = 'K0.00';
        document.getElementById('recipientEtaDisplay').textContent = 'ETA: -- min';
        document.getElementById('orderForSomeoneBtn').disabled = true;
    }
}

function submitOrderForSomeone() {
    const pickupLocation = document.getElementById('recipientPickupLocation').value;
    const destinationLocation = document.getElementById('recipientDestinationLocation').value;
    const recipientName = document.getElementById('recipientName').value;
    const recipientEmail = document.getElementById('recipientEmail').value;
    const recipientPhone = document.getElementById('recipientPhone').value;
    
    if (!pickupLocation || !destinationLocation || !recipientName) {
        showNotification('Please fill in all required fields.');
        return;
    }
    
    Promise.all([
        forwardGeocode(pickupLocation),
        forwardGeocode(destinationLocation)
    ]).then(([pickupResults, destinationResults]) => {
        if (pickupResults.length === 0 || destinationResults.length === 0) {
            showNotification('Invalid pickup or destination address. Please select valid locations.');
            return;
        }
        
        const pickupLat = parseFloat(pickupResults[0].lat);
        const pickupLng = parseFloat(pickupResults[0].lon);
        const destLat = parseFloat(destinationResults[0].lat);
        const destLng = parseFloat(destinationResults[0].lon);
        
        const distance = calculateDistance(pickupLat, pickupLng, destLat, destLng);
        
        let baseFare = 23;
        
        if (distance > 0) {
            baseFare += Math.ceil(distance / 90);
        }
        
        const rideId = database.ref().child('rides').push().key;
        
        const rideRequest = {
            id: rideId,
            passengerId: currentUser.uid,
            passengerName: userData.name || 'Passenger',
            passengerPhone: userData.phone || 'Not provided',
            pickupLocation: pickupResults[0].display_name,
            destination: destinationResults[0].display_name,
            pickupLat: pickupLat,
            pickupLng: pickupLng,
            destLat: destLat,
            destLng: destLng,
            rideType: 'standard',
            fare: baseFare,
            distance: (distance / 1000).toFixed(2) + ' km',
            status: 'requested',
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            updatedAt: firebase.database.ServerValue.TIMESTAMP,
            paymentMethod: selectedPaymentType,
            orderForSomeone: {
                recipientName: recipientName,
                recipientEmail: recipientEmail,
                recipientPhone: recipientPhone,
                orderedBy: userData.name || 'Passenger'
            },
            currentCity: currentCity
        };
        
        currentRideRequestData = rideRequest;
        currentRideRequestType = 'order-for-someone';
        
        showPaymentSelection(baseFare);
    }).catch(error => {
        console.error('Error in order for someone process:', error);
        showNotification('Error calculating route. Please try again.');
    });
}

// Express Delivery Functions
function calculateExpressDeliveryFee() {
    const shopLocation = document.getElementById('shopLocation').value;
    const deliveryDestination = document.getElementById('deliveryDestination').value;
    
    if (shopLocation.length > 3 && deliveryDestination.length > 3) {
        Promise.all([
            forwardGeocode(shopLocation),
            forwardGeocode(deliveryDestination)
        ]).then(([shopResults, destinationResults]) => {
            if (shopResults.length > 0 && destinationResults.length > 0) {
                const shopLat = parseFloat(shopResults[0].lat);
                const shopLng = parseFloat(shopResults[0].lon);
                const destLat = parseFloat(destinationResults[0].lat);
                const destLng = parseFloat(destinationResults[0].lon);
                
                const distance = calculateDistance(shopLat, shopLng, destLat, destLng);
                
                let baseFare = 23;
                
                if (distance > 0) {
                    baseFare += Math.ceil(distance / 90);
                }
                
                const vehicleType = document.querySelector('.express-delivery-form .vehicle-option.selected').getAttribute('data-type');
                switch(vehicleType) {
                    case 'car':
                        baseFare = baseFare;
                        break;
                    case 'bike':
                        baseFare = baseFare * 0.7;
                        break;
                    case 'bicycle':
                        baseFare = baseFare * 0.5;
                        break;
                }
                
                document.getElementById('expressDeliveryFee').textContent = `K${baseFare.toFixed(2)}`;
                
                const etaMinutes = Math.ceil((distance / 1000) / 30 * 60);
                document.getElementById('expressDeliveryEtaDisplay').textContent = `ETA: ${etaMinutes} min`;
                
                document.getElementById('expressDeliveryBtn').disabled = false;
            }
        });
    } else {
        document.getElementById('expressDeliveryFee').textContent = 'K0.00';
        document.getElementById('expressDeliveryEtaDisplay').textContent = 'ETA: -- min';
        document.getElementById('expressDeliveryBtn').disabled = true;
    }
}

function submitExpressDelivery() {
    const shopName = document.getElementById('shopName').value;
    const shopLocation = document.getElementById('shopLocation').value;
    const deliveryItems = document.getElementById('deliveryItems').value;
    const deliveryAmount = document.getElementById('deliveryAmount').value;
    const deliveryInstructions = document.getElementById('deliveryInstructions').value;
    const deliveryDestination = document.getElementById('deliveryDestination').value;
    const vehicleType = document.querySelector('.express-delivery-form .vehicle-option.selected').getAttribute('data-type');
    
    if (!shopName || !shopLocation || !deliveryDestination) {
        showNotification('Please fill in all required fields.');
        return;
    }
    
    Promise.all([
        forwardGeocode(shopLocation),
        forwardGeocode(deliveryDestination)
    ]).then(([shopResults, destinationResults]) => {
        if (shopResults.length === 0 || destinationResults.length === 0) {
            showNotification('Invalid shop or destination address. Please select valid locations.');
            return;
        }
        
        const shopLat = parseFloat(shopResults[0].lat);
        const shopLng = parseFloat(shopResults[0].lon);
        const destLat = parseFloat(destinationResults[0].lat);
        const destLng = parseFloat(destinationResults[0].lon);
        
        const distance = calculateDistance(shopLat, shopLng, destLat, destLng);
        
        let baseFare = 23;
        
        if (distance > 0) {
            baseFare += Math.ceil(distance / 90);
        }
        
        switch(vehicleType) {
            case 'car':
                baseFare = baseFare;
                break;
            case 'bike':
                baseFare = baseFare * 0.7;
                break;
            case 'bicycle':
                baseFare = baseFare * 0.5;
                break;
        }
        
        const rideId = database.ref().child('rides').push().key;
        
        const rideRequest = {
            id: rideId,
            passengerId: currentUser.uid,
            passengerName: userData.name || 'Passenger',
            passengerPhone: userData.phone || 'Not provided',
            pickupLocation: shopResults[0].display_name,
            destination: destinationResults[0].display_name,
            pickupLat: shopLat,
            pickupLng: shopLng,
            destLat: destLat,
            destLng: destLng,
            rideType: vehicleType,
            fare: baseFare,
            distance: (distance / 1000).toFixed(2) + ' km',
            status: 'requested',
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            updatedAt: firebase.database.ServerValue.TIMESTAMP,
            paymentMethod: selectedPaymentType,
            expressDelivery: {
                shopName: shopName,
                items: deliveryItems,
                amount: deliveryAmount,
                instructions: deliveryInstructions
            },
            currentCity: currentCity
        };
        
        currentRideRequestData = rideRequest;
        currentRideRequestType = 'express-delivery';
        
        showPaymentSelection(baseFare);
    }).catch(error => {
        console.error('Error in express delivery process:', error);
        showNotification('Error calculating route. Please try again.');
    });
}

// SOS Functions
function saveSOSConfig() {
    const contact1 = document.getElementById('emergencyContact1').value;
    const contact2 = document.getElementById('emergencyContact2').value;
    const message = document.getElementById('sosMessage').value;
    
    if (!contact1) {
        showNotification('Please provide at least one emergency contact.');
        return;
    }
    
    sosConfig = {
        contact1: contact1,
        contact2: contact2,
        message: message
    };
    
    database.ref('sosConfig/' + currentUser.uid).set(sosConfig)
        .then(() => {
            showNotification('SOS configuration saved successfully.');
            
            document.getElementById('sosSetupForm').classList.remove('active');
            document.getElementById('rideRequestForm').style.display = 'flex';
        })
        .catch(error => {
            console.error('Error saving SOS config:', error);
            showNotification('Error saving SOS configuration. Please try again.');
        });
}

function triggerSOS() {
    if (!sosConfig || !sosConfig.contact1) {
        showNotification('SOS not configured. Please set up emergency contacts first.');
        return;
    }
    
    if (!currentRide) {
        showNotification('No active ride to report SOS for.');
        return;
    }
    
    const sosAlert = {
        passengerId: currentUser.uid,
        passengerName: userData.name || 'Passenger',
        passengerPhone: userData.phone || 'Not provided',
        emergencyContact1: sosConfig.contact1,
        emergencyContact2: sosConfig.contact2,
        message: sosConfig.message,
        rideDetails: currentRide,
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        location: userLocation
    };
    
    if (currentRide.driverId) {
        database.ref('users/' + currentRide.driverId).once('value')
            .then(driverSnapshot => {
                const driver = driverSnapshot.val();
                if (driver) {
                    sosAlert.driverDetails = {
                        name: driver.name,
                        phone: driver.phone,
                        vehicle: driver.vehicle
                    };
                }
                
                return database.ref('sosAlerts').push().set(sosAlert);
            })
            .then(() => {
                showNotification('SOS alert sent to emergency contacts!');
                console.log('SOS Alert:', sosAlert);
            })
            .catch(error => {
                console.error('Error sending SOS alert:', error);
                showNotification('Error sending SOS alert. Please try again or call emergency services directly.');
            });
    } else {
        database.ref('sosAlerts').push().set(sosAlert)
            .then(() => {
                showNotification('SOS alert sent to emergency contacts!');
                console.log('SOS Alert:', sosAlert);
            })
            .catch(error => {
                console.error('Error sending SOS alert:', error);
                showNotification('Error sending SOS alert. Please try again or call emergency services directly.');
            });
    }
}

function hideAllSearchSuggestions() {
    const searchTypes = [
        'destination', 'pickup', 'recipientPickup', 
        'recipientDestination', 'shopLocation', 'deliveryDestination'
    ];
    
    searchTypes.forEach(type => {
        hideSearchSuggestions(type);
    });
}

// Event listeners setup
function setupEventListeners() {
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const screen = this.getAttribute('data-screen');
            switchScreen(screen);
        });
    });
    
    document.querySelectorAll('.back-button').forEach(btn => {
        btn.addEventListener('click', function() {
            const screen = this.getAttribute('data-screen');
            switchScreen(screen);
        });
    });
    
    // Ride type selection
    document.querySelectorAll('.ride-type-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.ride-type-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            this.classList.add('selected');
            selectedRideType = this.getAttribute('data-type');
            updateFareEstimate();
        });
    });
    
    // Vehicle selection
    document.querySelectorAll('.vehicle-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.vehicle-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            this.classList.add('selected');
            selectedVehicleType = this.getAttribute('data-type');
            
            if (selectedVehicleType === 'bike' || selectedVehicleType === 'bicycle') {
                document.getElementById('packageToggle').style.display = 'flex';
            } else {
                document.getElementById('packageToggle').style.display = 'none';
                document.getElementById('packageForm').classList.remove('active');
            }
            
            updateFareEstimate();
        });
    });
    
    // Package toggle
    document.getElementById('packageToggle').addEventListener('click', function() {
        document.getElementById('packageForm').classList.toggle('active');
    });
    
    // Payment options
    document.querySelectorAll('.payment-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.payment-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            this.classList.add('selected');
            selectedPaymentType = this.getAttribute('data-payment-type');
            
            if (selectedPaymentType === 'wallet') {
                if (walletBalance < rideFare) {
                    document.getElementById('insufficientBalance').style.display = 'block';
                    document.getElementById('confirmPaymentBtn').disabled = true;
                } else {
                    document.getElementById('insufficientBalance').style.display = 'none';
                    document.getElementById('confirmPaymentBtn').disabled = false;
                }
            } else {
                document.getElementById('insufficientBalance').style.display = 'none';
                document.getElementById('confirmPaymentBtn').disabled = false;
            }
        });
    });
    
    // Main buttons
    document.getElementById('requestRideBtn').addEventListener('click', requestRide);
    document.getElementById('confirmPaymentBtn').addEventListener('click', submitRideRequest);
    document.getElementById('closePaymentPopup').addEventListener('click', closePaymentSelection);
    document.getElementById('cancelRideBtn').addEventListener('click', cancelRide);
    document.getElementById('contactDriverBtn').addEventListener('click', contactDriver);
    document.getElementById('downloadReceiptBtn').addEventListener('click', function() {
        if (currentRide) {
            database.ref('receipts').orderByChild('rideId').equalTo(currentRide.id).once('value')
                .then(snapshot => {
                    const receipts = snapshot.val();
                    if (receipts) {
                        const receipt = Object.values(receipts)[0];
                        showReceiptPopup(receipt);
                    }
                });
        }
    });
    
    // Promo code
    document.getElementById('promoToggle').addEventListener('click', function() {
        document.getElementById('promoSection').classList.toggle('active');
    });
    document.getElementById('applyPromoBtn').addEventListener('click', applyPromoCode);
    
    // Account functions
    document.getElementById('shareReferralBtn').addEventListener('click', shareReferralCode);
    document.getElementById('depositBtn').addEventListener('click', depositToWallet);
    document.getElementById('withdrawBtn').addEventListener('click', withdrawFromWallet);
    document.getElementById('whatsappBtn').addEventListener('click', contactWhatsApp);
    document.getElementById('callBtn').addEventListener('click', contactPhone);
    
    // Panel collapse
    document.getElementById('panelCollapseHandle').addEventListener('click', togglePanelCollapse);
    
    // Setup search listeners
    setupSearchInputListeners();
    
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.location-input') && 
            !e.target.closest('.suggestion-list')) {
            hideAllSearchSuggestions();
        }
    });
    
    // Saved locations
    document.querySelectorAll('.saved-location-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const addressType = this.getAttribute('data-address');
            useSavedLocation(addressType);
        });
    });
    
    // History filter
    document.getElementById('historyFilter').addEventListener('change', loadRideHistory);
    document.getElementById('historyDate').addEventListener('change', loadRideHistory);
    
    // Ride details popup
    document.addEventListener('click', function(e) {
        if (e.target.closest('.history-item')) {
            const historyItem = e.target.closest('.history-item');
            const rideId = historyItem.getAttribute('data-ride-id');
            if (rideId) {
                showRideDetailsPopup(rideId);
            }
        }
    });
    
    document.getElementById('closeRidePopup').addEventListener('click', closeRideDetailsPopup);
    document.getElementById('closeRidePopupTop').addEventListener('click', closeRideDetailsPopup);
    document.getElementById('viewRideReceiptBtn').addEventListener('click', function() {
        const rideId = document.querySelector('#rideDetailsPopup').getAttribute('data-ride-id');
        if (rideId) {
            database.ref('receipts').orderByChild('rideId').equalTo(rideId).once('value')
                .then(snapshot => {
                    const receipts = snapshot.val();
                    if (receipts) {
                        const receipt = Object.values(receipts)[0];
                        showReceiptPopup(receipt);
                        closeRideDetailsPopup();
                    }
                });
        }
    });
    
    // Receipt popup
    document.getElementById('closeReceiptPopup').addEventListener('click', function() {
        document.getElementById('receiptPopup').classList.add('hidden');
    });
    document.getElementById('printReceiptBtn').addEventListener('click', function() {
        printJS({
            printable: 'receiptContent',
            type: 'html',
            style: `
                .receipt-content { font-family: 'Courier New', monospace; }
                .receipt-header { text-align: center; margin-bottom: 20px; }
                .receipt-title { font-size: 24px; font-weight: bold; }
                .receipt-subtitle { font-size: 12px; color: #666; }
                .receipt-row { display: flex; justify-content: space-between; margin-bottom: 8px; }
                .receipt-row.total { font-weight: bold; border-top: 1px solid #000; padding-top: 10px; }
                .receipt-footer { text-align: center; margin-top: 20px; font-size: 10px; color: #666; }
            `
        });
    });
    
    // More Options
    document.getElementById('moreOptionsBtn').addEventListener('click', toggleMoreOptions);
    document.querySelectorAll('.more-option-item').forEach(item => {
        item.addEventListener('click', function() {
            const option = this.getAttribute('data-option');
            handleMoreOptionSelection(option);
        });
    });
    
    // Order for Someone Else
    document.getElementById('orderForSomeoneBtn').addEventListener('click', submitOrderForSomeone);
    document.getElementById('cancelOrderForSomeoneBtn').addEventListener('click', cancelMoreOptionForm);
    
    // Express Delivery
    document.querySelectorAll('.express-delivery-form .vehicle-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.express-delivery-form .vehicle-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            this.classList.add('selected');
            calculateExpressDeliveryFee();
        });
    });
    document.getElementById('expressDeliveryBtn').addEventListener('click', submitExpressDelivery);
    document.getElementById('cancelExpressDeliveryBtn').addEventListener('click', cancelMoreOptionForm);
    
    // SOS Setup
    document.getElementById('saveSosBtn').addEventListener('click', saveSOSConfig);
    document.getElementById('cancelSosSetupBtn').addEventListener('click', cancelMoreOptionForm);
    
    // SOS Button
    document.getElementById('sosButton').addEventListener('click', triggerSOS);
    
    // Emergency Button
    document.getElementById('emergencyBtn').addEventListener('click', openEmergencyPopup);
    document.getElementById('closeEmergencyPopup').addEventListener('click', closeEmergencyPopup);
    
    // Emergency options
    document.querySelectorAll('.emergency-option').forEach(option => {
        option.addEventListener('click', function() {
            const emergencyType = this.getAttribute('data-emergency');
            handleEmergencySelection(emergencyType);
        });
    });
    
    // Emergency submit
    document.getElementById('popupSubmitEmergencyBtn').addEventListener('click', submitEmergencyRequest);
    
    // Screen emergency options
    document.querySelectorAll('#emergencyScreen .emergency-option').forEach(option => {
        option.addEventListener('click', function() {
            const emergencyType = this.getAttribute('data-emergency');
            handleScreenEmergencySelection(emergencyType);
        });
    });
}

function handleScreenEmergencySelection(emergencyType) {
    currentEmergencyType = emergencyType;
    
    document.getElementById('emergencyType').value = getEmergencyTypeName(emergencyType);
    document.getElementById('emergencyQuestionnaireTitle').textContent = `${getEmergencyTypeName(emergencyType)} Request`;
    document.getElementById('emergencyQuestionnaire').classList.add('active');
}

function initializeApp() {
    console.log("Jubel Passenger App Initialized with OpenLayers");
    
    setInterval(() => {
        if (userLocation && currentScreen === 'home') {
            determineCurrentCity(userLocation.lat, userLocation.lng)
                .then(city => {
                    console.log("Periodic city update:", city);
                })
                .catch(error => {
                    console.error("Periodic city detection failed:", error);
                });
        }
    }, 60000);
    
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden && currentScreen === 'home') {
            setTimeout(refreshHomeScreen, 1000);
        }
    });
    
    window.addEventListener('load', function() {
        console.log("Jubel Passenger App fully loaded with OpenLayers");
        showNotification('Jubel Passenger App Ready');
    });
}

window.addEventListener('online', function() {
    showNotification('Connection restored.');
    if (currentScreen === 'home') {
        setTimeout(refreshPassengerPosition, 1000);
    }
});

window.addEventListener('offline', function() {
    showNotification('You are currently offline. Some features may not work.');
});

initializeApp();
    </script>
</body>
</html>
