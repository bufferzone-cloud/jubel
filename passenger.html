<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jubel - Passenger (Enhanced)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Enhanced CSS with Modern Design */
        :root {
            --primary-orange: #FF6B35;
            --primary-orange-light: #FF8B5A;
            --primary-orange-dark: #E55A28;
            --primary-red: #E74C3C;
            --primary-gradient: linear-gradient(135deg, #FF6B35, #FF8B5A);
            --secondary-gradient: linear-gradient(135deg, #FF8B5A, #FF6B35);
            --light-orange: #FFF5F0;
            --light-orange-2: #FFE8E0;
            --light-gray: #F8F9FA;
            --light-gray-2: #F1F3F5;
            --medium-gray: #868E96;
            --dark-gray: #212529;
            --white: #FFFFFF;
            --success-green: #2ECC71;
            --warning-yellow: #F39C12;
            --info-blue: #3498DB;
            --error-red: #E74C3C;
            --ambulance-blue: #0066CC;
            --fire-truck-red: #CC0000;
            --police-blue: #0047AB;
            --hospital-green: #008000;
            --premium-gold: #FFD700;
            --economy-green: #27AE60;
            --light-truck-brown: #8B4513;
            --shadow-xs: 0 1px 3px rgba(0,0,0,0.05);
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.12);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.15);
            --shadow-xl: 0 12px 36px rgba(0,0,0,0.18);
            --border-radius-sm: 8px;
            --border-radius-md: 12px;
            --border-radius-lg: 16px;
            --border-radius-xl: 20px;
            --border-radius-circle: 50%;
            --transition-fast: 150ms ease;
            --transition-normal: 250ms ease;
            --transition-slow: 350ms ease;
        }

        /* Reset & Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        html {
            font-size: 16px;
            scroll-behavior: smooth;
        }

        body {
            background-color: var(--white);
            color: var(--dark-gray);
            max-width: 100%;
            overflow-x: hidden;
            height: 100vh;
            font-size: 14px;
            line-height: 1.5;
        }

        /* Map Container */
        #map {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            background: var(--light-gray);
        }

        /* Floating Elements */
        .floating-balance {
            position: fixed;
            top: 16px;
            right: 16px;
            background: var(--white);
            padding: 10px 16px;
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-lg);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: var(--dark-gray);
            border: 2px solid var(--primary-orange);
            font-size: 13px;
            backdrop-filter: blur(10px);
            transition: var(--transition-normal);
        }

        .floating-balance:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl);
        }

        .balance-amount {
            color: var(--primary-orange);
            font-size: 14px;
            font-weight: 700;
        }

        /* Main Panel */
        .passenger-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            border-radius: var(--border-radius-xl) var(--border-radius-xl) 0 0;
            box-shadow: var(--shadow-xl);
            z-index: 100;
            padding: 16px;
            transform: translateY(0);
            transition: transform var(--transition-normal) cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 60vh;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-orange) transparent;
        }

        .passenger-panel::-webkit-scrollbar {
            width: 6px;
        }

        .passenger-panel::-webkit-scrollbar-track {
            background: transparent;
        }

        .passenger-panel::-webkit-scrollbar-thumb {
            background-color: var(--primary-orange);
            border-radius: 3px;
        }

        .passenger-panel.collapsed {
            transform: translateY(calc(100% - 50px));
        }

        .panel-collapse-handle {
            width: 40px;
            height: 4px;
            background: var(--medium-gray);
            border-radius: 2px;
            margin: 0 auto 12px;
            cursor: pointer;
            transition: var(--transition-normal);
            opacity: 0.6;
        }

        .panel-collapse-handle:hover {
            background: var(--primary-orange);
            opacity: 1;
            transform: scaleX(1.2);
        }

        /* Navigation */
        .nav-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 16px;
            padding: 4px;
            background: var(--light-gray);
            border-radius: var(--border-radius-md);
        }

        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 12px 8px;
            border-radius: var(--border-radius-sm);
            background: transparent;
            cursor: pointer;
            transition: all var(--transition-fast);
            border: none;
            font-size: 12px;
            font-weight: 600;
            color: var(--medium-gray);
        }

        .nav-btn i {
            font-size: 18px;
            transition: var(--transition-fast);
        }

        .nav-btn.active {
            background: var(--white);
            color: var(--primary-orange);
            box-shadow: var(--shadow-sm);
        }

        .nav-btn.active i {
            transform: scale(1.1);
            color: var(--primary-orange);
        }

        .nav-btn:hover:not(.active) {
            color: var(--dark-gray);
            transform: translateY(-2px);
        }

        /* More Options */
        .more-options-btn {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--primary-orange);
            border-radius: var(--border-radius-md);
            background: var(--white);
            color: var(--primary-orange);
            cursor: pointer;
            font-size: 14px;
            font-weight: 700;
            margin: 12px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all var(--transition-normal);
        }

        .more-options-btn:hover {
            background: var(--primary-gradient);
            color: var(--white);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .more-options-dropdown {
            display: none;
            background: var(--white);
            border: 2px solid var(--light-gray-2);
            border-radius: var(--border-radius-md);
            margin-top: 8px;
            overflow: hidden;
            box-shadow: var(--shadow-md);
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .more-options-dropdown.active {
            display: block;
        }

        .more-option-item {
            padding: 14px 16px;
            border-bottom: 1px solid var(--light-gray-2);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all var(--transition-fast);
        }

        .more-option-item:last-child {
            border-bottom: none;
        }

        .more-option-item:hover {
            background: var(--light-orange);
            padding-left: 20px;
        }

        .more-option-icon {
            width: 24px;
            text-align: center;
            font-size: 18px;
            color: var(--primary-orange);
        }

        .more-option-text {
            flex: 1;
            font-size: 14px;
            font-weight: 600;
            color: var(--dark-gray);
        }

        /* Enhanced Ride Request Form */
        .ride-request-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 8px 0;
        }

        .location-input {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            border: 2px solid var(--light-gray-2);
            border-radius: var(--border-radius-md);
            background: var(--white);
            position: relative;
            transition: var(--transition-fast);
        }

        .location-input:focus-within {
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }

        .location-input i {
            color: var(--primary-orange);
            font-size: 18px;
        }

        .location-input input {
            border: none;
            outline: none;
            width: 100%;
            font-size: 15px;
            background: transparent;
            color: var(--dark-gray);
        }

        .location-input input::placeholder {
            color: var(--medium-gray);
            font-weight: 500;
        }

        /* Vehicle Selection - Enhanced */
        .vehicle-selection {
            display: none;
            gap: 8px;
            margin: 12px 0;
        }

        .vehicle-selection.active {
            display: flex;
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .vehicle-option {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 16px 8px;
            border: 2px solid var(--light-gray-2);
            border-radius: var(--border-radius-md);
            cursor: pointer;
            transition: all var(--transition-normal);
            background: var(--white);
        }

        .vehicle-option:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary-orange-light);
        }

        .vehicle-option.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
            box-shadow: var(--shadow-sm);
        }

        .vehicle-icon {
            font-size: 24px;
            color: var(--medium-gray);
            transition: var(--transition-fast);
        }

        .vehicle-option.selected .vehicle-icon {
            color: var(--primary-orange);
            transform: scale(1.1);
        }

        .vehicle-name {
            font-size: 13px;
            font-weight: 700;
            color: var(--dark-gray);
        }

        .vehicle-price {
            font-size: 12px;
            color: var(--primary-orange);
            font-weight: 600;
            background: var(--light-orange);
            padding: 4px 8px;
            border-radius: var(--border-radius-sm);
        }

        /* Enhanced Fare Display */
        .fare-display {
            background: var(--primary-gradient);
            color: var(--white);
            padding: 20px;
            border-radius: var(--border-radius-lg);
            text-align: center;
            margin: 16px 0;
            box-shadow: var(--shadow-md);
            display: none;
            animation: slideUp 0.4s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fare-display.active {
            display: block;
        }

        .fare-amount {
            font-size: 32px;
            font-weight: 800;
            margin: 8px 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .eta-display {
            font-size: 14px;
            font-weight: 600;
            opacity: 0.9;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        /* Buttons - Enhanced */
        .request-ride-btn {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: var(--border-radius-md);
            background: var(--primary-gradient);
            color: var(--white);
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-normal);
            margin-top: 16px;
            box-shadow: var(--shadow-md);
            letter-spacing: 0.5px;
            display: none;
        }

        .request-ride-btn.active {
            display: block;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 107, 53, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255, 107, 53, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 107, 53, 0); }
        }

        .request-ride-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
            background: var(--secondary-gradient);
        }

        .request-ride-btn:disabled {
            background: var(--medium-gray);
            cursor: not-allowed;
            box-shadow: none;
            animation: none;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: var(--border-radius-md);
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-normal);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: var(--white);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: var(--white);
            color: var(--primary-orange);
            border: 2px solid var(--primary-orange);
        }

        .btn-secondary:hover {
            background: var(--light-orange);
            transform: translateY(-2px);
        }

        .btn-cancel {
            background: var(--error-red);
            color: var(--white);
        }

        .btn-cancel:hover {
            background: #d62c1a;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-success {
            background: var(--success-green);
            color: var(--white);
        }

        .btn-success:hover {
            background: #25a25a;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* Ride Info Panel - Enhanced */
        .ride-info-panel {
            background: var(--white);
            border-radius: var(--border-radius-lg);
            padding: 20px;
            box-shadow: var(--shadow-lg);
            margin-bottom: 16px;
            border: 2px solid var(--light-gray-2);
            display: none;
            animation: slideUp 0.4s ease;
        }

        .driver-info {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--light-gray-2);
        }

        .driver-avatar {
            width: 60px;
            height: 60px;
            border-radius: var(--border-radius-circle);
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: var(--white);
            font-weight: 700;
            box-shadow: var(--shadow-md);
        }

        .driver-avatar img {
            width: 100%;
            height: 100%;
            border-radius: var(--border-radius-circle);
            object-fit: cover;
        }

        .driver-details {
            flex: 1;
        }

        .driver-details h2 {
            font-size: 18px;
            margin-bottom: 6px;
            color: var(--dark-gray);
        }

        .driver-details p {
            color: var(--medium-gray);
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
        }

        /* Trip Details */
        .trip-details {
            margin-bottom: 20px;
        }

        .location-row {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 16px;
        }

        .location-icon {
            width: 32px;
            height: 32px;
            border-radius: var(--border-radius-circle);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
            box-shadow: var(--shadow-sm);
        }

        .pickup-icon {
            background: var(--primary-orange);
            color: var(--white);
        }

        .destination-icon {
            background: var(--primary-red);
            color: var(--white);
        }

        .location-text {
            flex: 1;
        }

        .location-text h4 {
            font-size: 14px;
            font-weight: 600;
            color: var(--medium-gray);
            margin-bottom: 4px;
        }

        .location-text p {
            color: var(--dark-gray);
            font-size: 15px;
            font-weight: 500;
            line-height: 1.4;
        }

        /* Fare Details */
        .fare-details {
            background: var(--light-orange);
            padding: 20px;
            border-radius: var(--border-radius-md);
            margin-bottom: 20px;
        }

        .fare-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .fare-row.total {
            font-weight: 700;
            font-size: 18px;
            border-top: 2px solid rgba(255, 107, 53, 0.2);
            padding-top: 12px;
            margin-top: 12px;
            color: var(--primary-orange);
        }

        .ride-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        /* Enhanced Search Suggestions */
        .suggestion-list {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            right: 0;
            background: var(--white);
            border: 2px solid var(--light-gray-2);
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            animation: slideDown 0.2s ease;
        }

        .suggestion-item {
            padding: 14px 16px;
            border-bottom: 1px solid var(--light-gray-2);
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .suggestion-item:hover {
            background: var(--light-orange);
            padding-left: 20px;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-icon {
            font-size: 18px;
            width: 24px;
            text-align: center;
            color: var(--primary-orange);
        }

        .suggestion-details {
            flex: 1;
        }

        .suggestion-name {
            font-weight: 600;
            font-size: 14px;
            color: var(--dark-gray);
            margin-bottom: 4px;
        }

        .suggestion-address {
            color: var(--medium-gray);
            font-size: 12px;
            line-height: 1.4;
        }

        .suggestion-distance {
            color: var(--primary-orange);
            font-size: 11px;
            font-weight: 600;
            margin-top: 4px;
        }

        /* Loading States */
        .loading-text {
            text-align: center;
            padding: 20px;
            color: var(--medium-gray);
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .loading-text i {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Enhanced Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(4px);
            animation: fadeIn 0.3s ease;
        }

        .modal-overlay.hidden {
            display: none;
        }

        .modal-content {
            background: var(--white);
            border-radius: var(--border-radius-lg);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            animation: modalSlideUp 0.4s ease;
        }

        @keyframes modalSlideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 2px solid var(--light-gray-2);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--dark-gray);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--medium-gray);
            width: 36px;
            height: 36px;
            border-radius: var(--border-radius-circle);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-fast);
        }

        .modal-close:hover {
            background: var(--light-gray);
            color: var(--dark-gray);
        }

        .modal-body {
            padding: 24px;
        }

        /* Ride Type Selection - Enhanced */
        .ride-type-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 20px 0;
        }

        .ride-type-option {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 20px;
            border: 2px solid var(--light-gray-2);
            border-radius: var(--border-radius-md);
            cursor: pointer;
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .ride-type-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: transparent;
            transition: var(--transition-normal);
        }

        .ride-type-option:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary-orange-light);
        }

        .ride-type-option.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
            box-shadow: var(--shadow-sm);
        }

        .ride-type-option.premium {
            border-color: var(--premium-gold);
        }

        .ride-type-option.premium::before {
            background: var(--premium-gold);
        }

        .ride-type-option.standard {
            border-color: var(--primary-orange);
        }

        .ride-type-option.standard::before {
            background: var(--primary-orange);
        }

        .ride-type-option.economy {
            border-color: var(--economy-green);
        }

        .ride-type-option.economy::before {
            background: var(--economy-green);
        }

        .ride-type-option.selected::before {
            height: 4px;
        }

        .ride-type-icon {
            width: 56px;
            height: 56px;
            border-radius: var(--border-radius-circle);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
            box-shadow: var(--shadow-sm);
        }

        .ride-type-option.premium .ride-type-icon {
            background: linear-gradient(135deg, #FFD700, #FFC107);
            color: #333;
        }

        .ride-type-option.standard .ride-type-icon {
            background: var(--primary-gradient);
            color: var(--white);
        }

        .ride-type-option.economy .ride-type-icon {
            background: linear-gradient(135deg, #27AE60, #2ECC71);
            color: var(--white);
        }

        .ride-type-details {
            flex: 1;
        }

        .ride-type-name {
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 4px;
            color: var(--dark-gray);
        }

        .ride-type-description {
            font-size: 13px;
            color: var(--medium-gray);
            line-height: 1.4;
        }

        .ride-type-price {
            font-size: 18px;
            font-weight: 800;
            color: var(--primary-orange);
            white-space: nowrap;
        }

        /* Emergency Ride Options - Enhanced */
        .emergency-ride-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin: 24px 0;
        }

        .emergency-ride-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            padding: 24px 16px;
            border: 2px solid var(--light-gray-2);
            border-radius: var(--border-radius-lg);
            cursor: pointer;
            transition: all var(--transition-normal);
            text-align: center;
            background: var(--white);
        }

        .emergency-ride-option:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
        }

        .emergency-ride-option.selected {
            border-width: 3px;
            box-shadow: var(--shadow-lg);
        }

        .emergency-ride-option.police {
            border-color: var(--police-blue);
        }

        .emergency-ride-option.police.selected {
            background: linear-gradient(135deg, rgba(0, 71, 171, 0.1), rgba(0, 71, 171, 0.05));
        }

        .emergency-ride-option.fire {
            border-color: var(--fire-truck-red);
        }

        .emergency-ride-option.fire.selected {
            background: linear-gradient(135deg, rgba(204, 0, 0, 0.1), rgba(204, 0, 0, 0.05));
        }

        .emergency-ride-option.hospital {
            border-color: var(--hospital-green);
        }

        .emergency-ride-option.hospital.selected {
            background: linear-gradient(135deg, rgba(0, 128, 0, 0.1), rgba(0, 128, 0, 0.05));
        }

        .emergency-ride-option.ambulance {
            border-color: var(--ambulance-blue);
        }

        .emergency-ride-option.ambulance.selected {
            background: linear-gradient(135deg, rgba(0, 102, 204, 0.1), rgba(0, 102, 204, 0.05));
        }

        .emergency-ride-icon {
            width: 64px;
            height: 64px;
            border-radius: var(--border-radius-circle);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            box-shadow: var(--shadow-md);
        }

        .emergency-ride-option.police .emergency-ride-icon {
            background: var(--police-blue);
            color: white;
        }

        .emergency-ride-option.fire .emergency-ride-icon {
            background: var(--fire-truck-red);
            color: white;
        }

        .emergency-ride-option.hospital .emergency-ride-icon {
            background: var(--hospital-green);
            color: white;
        }

        .emergency-ride-option.ambulance .emergency-ride-icon {
            background: var(--ambulance-blue);
            color: white;
        }

        .emergency-ride-name {
            font-weight: 700;
            font-size: 16px;
            color: var(--dark-gray);
        }

        .emergency-ride-description {
            font-size: 13px;
            color: var(--medium-gray);
            line-height: 1.4;
        }

        .emergency-ride-price {
            font-size: 18px;
            font-weight: 800;
            color: var(--dark-gray);
            margin-top: 8px;
        }

        /* Enhanced History Section */
        .history-section {
            padding: 8px;
        }

        .history-filter {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            padding: 8px;
            background: var(--light-gray);
            border-radius: var(--border-radius-md);
        }

        .history-filter select,
        .history-filter input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--light-gray-2);
            border-radius: var(--border-radius-md);
            font-size: 14px;
            color: var(--dark-gray);
            background: var(--white);
            transition: var(--transition-fast);
        }

        .history-filter select:focus,
        .history-filter input:focus {
            outline: none;
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }

        .history-item {
            background: var(--white);
            border: 2px solid var(--light-gray-2);
            border-radius: var(--border-radius-md);
            margin-bottom: 12px;
            overflow: hidden;
            transition: all var(--transition-normal);
            cursor: pointer;
        }

        .history-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary-orange-light);
        }

        .history-item.expanded {
            border-color: var(--primary-orange);
            box-shadow: var(--shadow-lg);
        }

        .history-item-header {
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-item-type {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: var(--border-radius-sm);
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .history-item-type.ride {
            background: var(--light-orange);
            color: var(--primary-orange);
        }

        .history-item-type.delivery {
            background: #E8F6F3;
            color: #1ABC9C;
        }

        .history-item-type.emergency {
            background: #FFE6E6;
            color: var(--error-red);
        }

        .history-item-date {
            font-size: 13px;
            color: var(--medium-gray);
            font-weight: 500;
        }

        .history-item-content {
            padding: 0 16px 16px;
        }

        .history-item-locations {
            margin-bottom: 12px;
        }

        .history-location {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 8px;
        }

        .history-location-icon {
            width: 20px;
            height: 20px;
            border-radius: var(--border-radius-circle);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .history-location.pickup .history-location-icon {
            background: var(--primary-orange);
            color: var(--white);
        }

        .history-location.destination .history-location-icon {
            background: var(--primary-red);
            color: var(--white);
        }

        .history-location-text {
            font-size: 14px;
            color: var(--dark-gray);
            line-height: 1.4;
        }

        .history-item-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .history-detail-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .history-detail-label {
            font-size: 12px;
            color: var(--medium-gray);
            font-weight: 600;
        }

        .history-detail-value {
            font-size: 14px;
            color: var(--dark-gray);
            font-weight: 600;
        }

        .history-item-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 16px;
            border-top: 2px solid var(--light-gray-2);
        }

        .history-fare {
            font-size: 20px;
            font-weight: 800;
            color: var(--primary-orange);
        }

        .history-status {
            padding: 6px 12px;
            border-radius: var(--border-radius-sm);
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .status-completed {
            background: #E8F6F3;
            color: #1ABC9C;
        }

        .status-cancelled {
            background: #FFE6E6;
            color: var(--error-red);
        }

        .status-in-progress {
            background: #FFF3E0;
            color: #F39C12;
        }

        /* Expanded Details */
        .history-expanded-details {
            display: none;
            padding: 20px;
            background: var(--light-gray);
            border-top: 2px solid var(--light-gray-2);
            animation: slideDown 0.3s ease;
        }

        .history-item.expanded .history-expanded-details {
            display: block;
        }

        .expanded-section {
            margin-bottom: 20px;
        }

        .expanded-section-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--dark-gray);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .expanded-section-title i {
            color: var(--primary-orange);
        }

        .driver-info-expanded {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--white);
            border-radius: var(--border-radius-md);
            border: 2px solid var(--light-gray-2);
        }

        .driver-avatar-expanded {
            width: 48px;
            height: 48px;
            border-radius: var(--border-radius-circle);
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--white);
            font-weight: 700;
        }

        .driver-details-expanded {
            flex: 1;
        }

        .driver-details-expanded h4 {
            font-size: 16px;
            margin-bottom: 4px;
            color: var(--dark-gray);
        }

        .driver-rating {
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--warning-yellow);
            font-size: 14px;
        }

        .vehicle-details-expanded {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            padding: 16px;
            background: var(--white);
            border-radius: var(--border-radius-md);
            border: 2px solid var(--light-gray-2);
        }

        .vehicle-detail-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .vehicle-detail-label {
            font-size: 12px;
            color: var(--medium-gray);
        }

        .vehicle-detail-value {
            font-size: 14px;
            color: var(--dark-gray);
            font-weight: 600;
        }

        .ride-timeline {
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding: 16px;
            background: var(--white);
            border-radius: var(--border-radius-md);
            border: 2px solid var(--light-gray-2);
        }

        .timeline-item {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .timeline-time {
            font-size: 13px;
            color: var(--medium-gray);
            font-weight: 600;
            min-width: 70px;
        }

        .timeline-dot {
            width: 12px;
            height: 12px;
            border-radius: var(--border-radius-circle);
            background: var(--primary-orange);
            position: relative;
        }

        .timeline-dot::after {
            content: '';
            position: absolute;
            top: 12px;
            left: 5px;
            width: 2px;
            height: calc(100% + 4px);
            background: var(--light-gray-2);
        }

        .timeline-item:last-child .timeline-dot::after {
            display: none;
        }

        .timeline-description {
            font-size: 14px;
            color: var(--dark-gray);
            flex: 1;
        }

        /* Payment Selection */
        .payment-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 20px 0;
        }

        .payment-option {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            border: 2px solid var(--light-gray-2);
            border-radius: var(--border-radius-md);
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .payment-option:hover {
            border-color: var(--primary-orange-light);
            transform: translateX(4px);
        }

        .payment-option.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
            box-shadow: var(--shadow-sm);
        }

        .payment-option-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--border-radius-circle);
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: var(--medium-gray);
            transition: var(--transition-normal);
        }

        .payment-option.selected .payment-option-icon {
            background: var(--primary-orange);
            color: var(--white);
        }

        .payment-option-details {
            flex: 1;
        }

        .payment-option-name {
            font-weight: 600;
            font-size: 16px;
            color: var(--dark-gray);
            margin-bottom: 4px;
        }

        .payment-option-description {
            color: var(--medium-gray);
            font-size: 13px;
        }

        .payment-option-balance {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary-orange);
        }

        /* Enhanced SOS Button */
        .sos-button {
            position: fixed;
            top: 16px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--error-red);
            color: var(--white);
            width: 60px;
            height: 60px;
            border-radius: var(--border-radius-circle);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 800;
            box-shadow: var(--shadow-xl);
            z-index: 150;
            cursor: pointer;
            animation: sos-pulse 2s infinite;
            border: 3px solid white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: var(--transition-normal);
        }

        .sos-button:hover {
            transform: translateX(-50%) scale(1.1);
            box-shadow: 0 0 0 10px rgba(231, 76, 60, 0.2);
        }

        @keyframes sos-pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7);
            }
            70% {
                box-shadow: 0 0 0 15px rgba(231, 76, 60, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(231, 76, 60, 0);
            }
        }

        /* Countdown Timer */
        .countdown-timer {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-gradient);
            color: var(--white);
            padding: 12px 24px;
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-xl);
            z-index: 150;
            display: none;
            font-weight: 700;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.2);
        }

        .countdown-timer.active {
            display: block;
            animation: slideDown 0.4s ease;
        }

        .countdown-text {
            font-size: 12px;
            opacity: 0.9;
            letter-spacing: 0.5px;
        }

        .countdown-time {
            font-size: 24px;
            font-weight: 800;
            margin: 4px 0;
            letter-spacing: 1px;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-gradient);
            color: var(--white);
            padding: 16px 28px;
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-xl);
            z-index: 300;
            display: none;
            font-weight: 600;
            text-align: center;
            font-size: 14px;
            max-width: 80%;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.2);
            animation: slideDown 0.3s ease;
        }

        /* Screen Content */
        .screen-content {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 50px;
            background: var(--white);
            z-index: 90;
            padding: 20px;
            overflow-y: auto;
            display: none;
        }

        .screen-content.active {
            display: block;
            animation: slideUp 0.4s ease;
        }

        .screen-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--light-gray-2);
        }

        .back-button {
            width: 44px;
            height: 44px;
            border-radius: var(--border-radius-circle);
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            font-size: 18px;
            color: var(--dark-gray);
            transition: var(--transition-normal);
        }

        .back-button:hover {
            background: var(--primary-orange);
            color: var(--white);
            transform: translateX(-4px);
        }

        .screen-title {
            font-size: 24px;
            font-weight: 800;
            color: var(--dark-gray);
        }

        /* Account Screen */
        .account-section {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .account-header {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 24px;
            background: var(--primary-gradient);
            border-radius: var(--border-radius-lg);
            color: var(--white);
        }

        .account-avatar {
            width: 80px;
            height: 80px;
            border-radius: var(--border-radius-circle);
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            backdrop-filter: blur(10px);
            border: 3px solid rgba(255,255,255,0.3);
        }

        .account-info {
            flex: 1;
        }

        .account-name {
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 8px;
        }

        .account-details {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .account-detail {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            opacity: 0.9;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .stat-card {
            background: var(--white);
            padding: 20px;
            border-radius: var(--border-radius-md);
            text-align: center;
            border: 2px solid var(--light-gray-2);
            transition: var(--transition-normal);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            border-color: var(--primary-orange);
            box-shadow: var(--shadow-md);
        }

        .stat-number {
            font-size: 32px;
            font-weight: 800;
            color: var(--primary-orange);
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 13px;
            color: var(--medium-gray);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .emergency-ride-options {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .vehicle-selection.active {
                flex-direction: column;
            }
            
            .ride-actions {
                grid-template-columns: 1fr;
            }
            
            .history-item-details {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .nav-buttons {
                gap: 4px;
            }
            
            .nav-btn {
                padding: 8px 4px;
                font-size: 11px;
            }
            
            .nav-btn i {
                font-size: 16px;
            }
            
            .fare-amount {
                font-size: 28px;
            }
            
            .modal-content {
                padding: 16px;
            }
        }

        /* Custom Map Markers */
        .driver-marker {
            background: var(--primary-gradient);
            color: white;
            border-radius: var(--border-radius-circle);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            box-shadow: var(--shadow-lg);
            border: 3px solid white;
        }

        .emergency-marker {
            border-radius: var(--border-radius-circle);
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: var(--shadow-xl);
            border: 3px solid white;
        }

        .pickup-marker {
            background: var(--primary-orange);
            color: white;
            border-radius: var(--border-radius-circle);
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            box-shadow: var(--shadow-md);
            border: 2px solid white;
        }

        .destination-marker {
            background: var(--primary-red);
            color: white;
            border-radius: var(--border-radius-circle);
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            box-shadow: var(--shadow-md);
            border: 2px solid white;
        }

        /* Loading Animation */
        .searching-animation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 200;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .searching-pulse {
            width: 100px;
            height: 100px;
            border-radius: var(--border-radius-circle);
            background: rgba(255, 107, 53, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse-ring 2s infinite;
            position: relative;
        }

        .searching-pulse-inner {
            width: 70px;
            height: 70px;
            border-radius: var(--border-radius-circle);
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 28px;
            box-shadow: var(--shadow-lg);
        }

        .searching-text {
            margin-top: 20px;
            background: var(--white);
            padding: 16px 24px;
            border-radius: var(--border-radius-md);
            font-weight: 700;
            color: var(--primary-orange);
            box-shadow: var(--shadow-lg);
            font-size: 16px;
        }

        /* Emergency Status */
        .emergency-ride-status {
            position: fixed;
            top: 16px;
            right: 16px;
            background: var(--error-red);
            color: var(--white);
            padding: 12px 20px;
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-xl);
            z-index: 100;
            display: none;
            font-weight: 800;
            font-size: 14px;
            animation: emergency-pulse 1s infinite;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.2);
        }

        @keyframes emergency-pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* Price Display Enhancements */
        .price-display {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
            font-weight: 800;
            letter-spacing: 0.5px;
        }

        .currency {
            font-size: 0.8em;
            margin-right: 2px;
        }

        /* Form Enhancements */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-gray);
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--light-gray-2);
            border-radius: var(--border-radius-md);
            font-size: 15px;
            color: var(--dark-gray);
            background: var(--white);
            transition: var(--transition-fast);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }

        /* Card Styles */
        .card {
            background: var(--white);
            border-radius: var(--border-radius-lg);
            padding: 24px;
            border: 2px solid var(--light-gray-2);
            margin-bottom: 20px;
            transition: var(--transition-normal);
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .card-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--dark-gray);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Section Styles */
        .section {
            margin-bottom: 32px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 800;
            color: var(--dark-gray);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .section-title i {
            color: var(--primary-orange);
        }

        /* Divider */
        .divider {
            height: 2px;
            background: var(--light-gray-2);
            margin: 24px 0;
            border: none;
        }

        /* Badge Styles */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            border-radius: var(--border-radius-sm);
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-primary {
            background: var(--light-orange);
            color: var(--primary-orange);
        }

        .badge-success {
            background: #E8F6F3;
            color: #1ABC9C;
        }

        .badge-warning {
            background: #FFF3E0;
            color: #F39C12;
        }

        .badge-danger {
            background: #FFE6E6;
            color: var(--error-red);
        }

        /* Tooltip */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background: var(--dark-gray);
            color: var(--white);
            text-align: center;
            padding: 8px 12px;
            border-radius: var(--border-radius-sm);
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            font-weight: 500;
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* Progress Bar */
        .progress-bar {
            height: 8px;
            background: var(--light-gray-2);
            border-radius: 4px;
            overflow: hidden;
            margin: 12px 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-gradient);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 52px;
            height: 28px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--light-gray-2);
            transition: .4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background: var(--white);
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background: var(--primary-orange);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: var(--medium-gray);
        }

        .empty-state-icon {
            font-size: 48px;
            color: var(--light-gray-2);
            margin-bottom: 16px;
        }

        .empty-state-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--dark-gray);
        }

        .empty-state-description {
            font-size: 14px;
            line-height: 1.5;
            max-width: 400px;
            margin: 0 auto;
        }

        /* Success Animation */
        .success-animation {
            animation: successPop 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes successPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Shimmer Loading */
        .shimmer {
            background: linear-gradient(
                90deg,
                var(--light-gray) 25%,
                var(--light-gray-2) 50%,
                var(--light-gray) 75%
            );
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Enhanced Focus States */
        *:focus {
            outline: 3px solid rgba(255, 107, 53, 0.3);
            outline-offset: 2px;
        }

        /* Smooth Scrolling */
        .smooth-scroll {
            scroll-behavior: smooth;
        }

        /* Enhanced Selection */
        ::selection {
            background: rgba(255, 107, 53, 0.3);
            color: var(--dark-gray);
        }

        /* Print Styles */
        @media print {
            .no-print {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Main App Container -->
    <div id="mainApp">
        <!-- Map -->
        <div id="map"></div>
        
        <!-- Floating Balance -->
        <div class="floating-balance home-only">
            <i class="fas fa-wallet"></i>
            <span>Balance: <span class="balance-amount" id="walletBalance">ZMW 0.00</span></span>
        </div>
        
        <!-- SOS Button -->
        <div class="sos-button" id="sosButton">
            SOS
        </div>
        
        <!-- Countdown Timer -->
        <div class="countdown-timer" id="countdownTimer">
            <div class="countdown-text">Scheduled Ride In:</div>
            <div class="countdown-time" id="countdownTime">00:00:00</div>
        </div>
        
        <!-- Emergency Ride Status -->
        <div class="emergency-ride-status" id="emergencyRideStatus">
            <i class="fas fa-exclamation-triangle"></i>
            <span>EMERGENCY RIDE IN PROGRESS</span>
        </div>
        
        <!-- Notification -->
        <div class="notification" id="notification"></div>
        
        <!-- Searching Animation -->
        <div class="searching-animation" id="searchingAnimation">
            <div class="searching-pulse">
                <div class="searching-pulse-inner">
                    <i class="fas fa-car"></i>
                </div>
            </div>
            <div class="searching-text">Searching for driver...</div>
        </div>
        
        <!-- Main Panel -->
        <div class="passenger-panel" id="passengerPanel">
            <div class="panel-collapse-handle" id="panelCollapseHandle"></div>
            
            <!-- Navigation -->
            <div class="nav-buttons">
                <button class="nav-btn active" data-screen="home">
                    <i class="fas fa-home"></i>
                    <span>Home</span>
                </button>
                <button class="nav-btn" data-screen="account">
                    <i class="fas fa-user"></i>
                    <span>Account</span>
                </button>
                <button class="nav-btn" data-screen="history">
                    <i class="fas fa-history"></i>
                    <span>History</span>
                </button>
                <button class="nav-btn" data-screen="emergency">
                    <i class="fas fa-ambulance"></i>
                    <span>Emergency</span>
                </button>
            </div>
            
            <!-- More Options -->
            <button class="more-options-btn" id="moreOptionsBtn">
                <i class="fas fa-ellipsis-h"></i>
                More Options
            </button>
            
            <div class="more-options-dropdown" id="moreOptionsDropdown">
                <div class="more-option-item" data-option="order-for-someone">
                    <div class="more-option-icon">
                        <i class="fas fa-user-friends"></i>
                    </div>
                    <div class="more-option-text">Order for Someone Else</div>
                </div>
                <div class="more-option-item" data-option="express-delivery">
                    <div class="more-option-icon">
                        <i class="fas fa-shipping-fast"></i>
                    </div>
                    <div class="more-option-text">Express Delivery</div>
                </div>
                <div class="more-option-item" data-option="light-truck-delivery">
                    <div class="more-option-icon">
                        <i class="fas fa-truck-pickup"></i>
                    </div>
                    <div class="more-option-text">Light Truck Delivery</div>
                </div>
                <div class="more-option-item" data-option="schedule-ride">
                    <div class="more-option-icon">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <div class="more-option-text">Schedule Ride</div>
                </div>
                <div class="more-option-item" data-option="schedule-delivery">
                    <div class="more-option-icon">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div class="more-option-text">Schedule Delivery</div>
                </div>
            </div>
            
            <!-- Home Screen Content -->
            <div id="homeScreenContent">
                <!-- Standard Ride Form -->
                <div class="ride-request-form" id="rideRequestForm">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="pickupLocation" placeholder="Current location" readonly>
                    </div>
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="destinationLocation" placeholder="Where to?" autocomplete="off">
                        <div class="suggestion-list" id="destinationSuggestions"></div>
                    </div>
                    
                    <!-- Saved Locations -->
                    <div class="saved-locations" style="display: flex; gap: 8px; margin: 12px 0;">
                        <button class="btn-secondary" data-address="home" style="flex: 1;">
                            <i class="fas fa-home"></i>
                            Home
                        </button>
                        <button class="btn-secondary" data-address="work" style="flex: 1;">
                            <i class="fas fa-briefcase"></i>
                            Work
                        </button>
                    </div>
                    
                    <!-- Vehicle Selection -->
                    <div class="vehicle-selection" id="vehicleSelection">
                        <div class="vehicle-option selected" data-type="car">
                            <i class="fas fa-car vehicle-icon"></i>
                            <span class="vehicle-name">Standard</span>
                            <span class="vehicle-price">ZMW 23</span>
                        </div>
                        <div class="vehicle-option" data-type="bike">
                            <i class="fas fa-motorcycle vehicle-icon"></i>
                            <span class="vehicle-name">Express</span>
                            <span class="vehicle-price">ZMW 18</span>
                        </div>
                        <div class="vehicle-option" data-type="bicycle">
                            <i class="fas fa-bicycle vehicle-icon"></i>
                            <span class="vehicle-name">Economy</span>
                            <span class="vehicle-price">ZMW 15</span>
                        </div>
                    </div>
                    
                    <!-- Fare Display -->
                    <div class="fare-display" id="fareDisplay">
                        <p>Estimated Fare</p>
                        <div class="fare-amount" id="estimatedFare">ZMW 0.00</div>
                        <p class="eta-display">
                            <i class="fas fa-clock"></i>
                            <span id="etaDisplay">ETA: -- min</span>
                        </p>
                    </div>
                    
                    <!-- Promo Code -->
                    <button class="btn-secondary" id="promoToggle" style="width: 100%; margin-top: 12px;">
                        <i class="fas fa-tag"></i>
                        Apply Promo Code
                    </button>
                    
                    <div class="card" id="promoSection" style="display: none; margin-top: 12px;">
                        <div class="form-group">
                            <input type="text" id="promoCode" class="form-control" placeholder="Enter promo code">
                        </div>
                        <button class="btn-primary" id="applyPromoBtn" style="width: 100%;">
                            Apply Promo Code
                        </button>
                    </div>
                    
                    <!-- Request Ride Button -->
                    <button class="request-ride-btn" id="requestRideBtn">
                        <i class="fas fa-car"></i>
                        Request Ride
                    </button>
                </div>
                
                <!-- Ride Info Panel -->
                <div class="ride-info-panel" id="rideInfoPanel">
                    <div class="driver-info">
                        <div class="driver-avatar" id="driverAvatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="driver-details">
                            <h2 id="driverName">Driver Name</h2>
                            <p><i class="fas fa-phone"></i> <span id="driverPhone">000-000-0000</span></p>
                            <p><i class="fas fa-car"></i> <span id="vehicleDetails">Vehicle Details</span></p>
                            <p><i class="fas fa-star"></i> <span id="driverRating">4.5 </span></p>
                        </div>
                    </div>
                    
                    <div class="trip-details">
                        <div class="location-row">
                            <div class="location-icon pickup-icon">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="location-text">
                                <h4>Pickup Location</h4>
                                <p id="currentPickupLocation">Current Location</p>
                            </div>
                        </div>
                        <div class="location-row">
                            <div class="location-icon destination-icon">
                                <i class="fas fa-flag"></i>
                            </div>
                            <div class="location-text">
                                <h4>Destination</h4>
                                <p id="currentDestinationLocation">Destination</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="fare-details">
                        <div class="fare-row">
                            <span>Base Fare</span>
                            <span id="baseFare">ZMW 23.00</span>
                        </div>
                        <div class="fare-row">
                            <span>Distance</span>
                            <span id="distanceFare">ZMW 5.00</span>
                        </div>
                        <div class="fare-row">
                            <span>Discount</span>
                            <span id="discountFare">-ZMW 0.00</span>
                        </div>
                        <div class="fare-row total">
                            <span>Total Fare</span>
                            <span id="totalFare">ZMW 28.00</span>
                        </div>
                    </div>
                    
                    <div class="ride-actions">
                        <button class="btn btn-cancel" id="cancelRideBtn">
                            <i class="fas fa-times-circle"></i>
                            Cancel Ride
                        </button>
                        <button class="btn btn-primary" id="contactDriverBtn">
                            <i class="fas fa-phone"></i>
                            Contact Driver
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Screen Contents -->
        <div class="screen-content" id="homeScreen"></div>
        
        <div class="screen-content" id="accountScreen">
            <div class="screen-header">
                <button class="back-button" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="screen-title">Account</h2>
            </div>
            
            <div class="account-section">
                <div class="account-header">
                    <div class="account-avatar" id="accountAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="account-info">
                        <h2 class="account-name" id="accountName">Passenger</h2>
                        <div class="account-details">
                            <div class="account-detail">
                                <i class="fas fa-phone"></i>
                                <span id="accountPhone">Not set</span>
                            </div>
                            <div class="account-detail">
                                <i class="fas fa-envelope"></i>
                                <span id="accountEmail">Not set</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="ridesCompleted">0</div>
                        <div class="stat-label">Completed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="ridesCancelled">0</div>
                        <div class="stat-label">Cancelled</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="ridesPending">0</div>
                        <div class="stat-label">Pending</div>
                    </div>
                </div>
                
                <div class="card">
                    <h3 class="card-title">
                        <i class="fas fa-wallet"></i>
                        Wallet Balance
                    </h3>
                    <div style="text-align: center; margin: 20px 0;">
                        <div style="font-size: 48px; font-weight: 800; color: var(--primary-orange);" id="accountBalance">
                            ZMW 0.00
                        </div>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn-primary" id="depositBtn" style="flex: 1;">
                            <i class="fas fa-plus"></i>
                            Deposit
                        </button>
                        <button class="btn-secondary" id="withdrawBtn" style="flex: 1;">
                            <i class="fas fa-minus"></i>
                            Withdraw
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <h3 class="card-title">
                        <i class="fas fa-share-alt"></i>
                        Refer & Earn
                    </h3>
                    <p style="margin-bottom: 16px; color: var(--medium-gray);">
                        Share your code and get ZMW 25 when friends complete their first ride
                    </p>
                    <div style="background: var(--light-gray); padding: 16px; border-radius: var(--border-radius-md); text-align: center; margin-bottom: 16px;">
                        <div style="font-size: 24px; font-weight: 800; color: var(--primary-orange);" id="referralCode">
                            JUBEL-XXXX
                        </div>
                        <div style="font-size: 12px; color: var(--medium-gray); margin-top: 8px;">
                            50% discount for new users
                        </div>
                    </div>
                    <button class="btn-primary" id="shareReferralBtn" style="width: 100%;">
                        <i class="fas fa-share"></i>
                        Share Referral Code
                    </button>
                </div>
                
                <div class="card">
                    <h3 class="card-title">
                        <i class="fas fa-headset"></i>
                        Support
                    </h3>
                    <div style="display: flex; gap: 12px; margin-top: 16px;">
                        <button class="btn-success" id="whatsappBtn" style="flex: 1;">
                            <i class="fab fa-whatsapp"></i>
                            WhatsApp
                        </button>
                        <button class="btn-primary" id="callBtn" style="flex: 1;">
                            <i class="fas fa-phone"></i>
                            Call Us
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="screen-content" id="historyScreen">
            <div class="screen-header">
                <button class="back-button" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="screen-title">Ride History</h2>
            </div>
            
            <div class="history-section">
                <div class="history-filter">
                    <select id="historyFilter" class="form-control">
                        <option value="all">All Rides</option>
                        <option value="ride">Rides Only</option>
                        <option value="delivery">Deliveries Only</option>
                        <option value="emergency">Emergency Services</option>
                        <option value="completed">Completed</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                    <input type="date" id="historyDate" class="form-control">
                </div>
                
                <div id="historyList">
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-history"></i>
                        </div>
                        <div class="empty-state-title">No Ride History</div>
                        <div class="empty-state-description">
                            Your completed rides will appear here. Book your first ride to get started!
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="screen-content" id="emergencyScreen">
            <div class="screen-header">
                <button class="back-button" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="screen-title">Emergency Services</h2>
            </div>
            
            <div class="account-section">
                <div class="card">
                    <h3 class="card-title">
                        <i class="fas fa-exclamation-triangle"></i>
                        Emergency Ride Services
                    </h3>
                    <p style="margin-bottom: 20px; color: var(--medium-gray);">
                        Select an emergency service for immediate assistance. Prices are fixed and include priority response.
                    </p>
                    
                    <div class="emergency-ride-options">
                        <div class="emergency-ride-option police" data-type="police">
                            <div class="emergency-ride-icon">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="emergency-ride-name">Police Ride</div>
                            <div class="emergency-ride-description">Immediate police response</div>
                            <div class="emergency-ride-price">ZMW 300</div>
                        </div>
                        
                        <div class="emergency-ride-option fire" data-type="fire">
                            <div class="emergency-ride-icon">
                                <i class="fas fa-fire-extinguisher"></i>
                            </div>
                            <div class="emergency-ride-name">Fire Brigade</div>
                            <div class="emergency-ride-description">Fire emergency response</div>
                            <div class="emergency-ride-price">ZMW 500</div>
                        </div>
                        
                        <div class="emergency-ride-option hospital" data-type="hospital">
                            <div class="emergency-ride-icon">
                                <i class="fas fa-hospital"></i>
                            </div>
                            <div class="emergency-ride-name">Hospital Ride</div>
                            <div class="emergency-ride-description">Medical emergency transport</div>
                            <div class="emergency-ride-price">ZMW 400</div>
                        </div>
                        
                        <div class="emergency-ride-option ambulance" data-type="ambulance">
                            <div class="emergency-ride-icon">
                                <i class="fas fa-ambulance"></i>
                            </div>
                            <div class="emergency-ride-name">Ambulance</div>
                            <div class="emergency-ride-description">Medical emergency with staff</div>
                            <div class="emergency-ride-price">ZMW 600</div>
                        </div>
                    </div>
                    
                    <button class="btn-primary" id="requestEmergencyBtn" style="width: 100%; margin-top: 20px;">
                        <i class="fas fa-ambulance"></i>
                        Request Emergency Service
                    </button>
                </div>
                
                <div class="card">
                    <h3 class="card-title">
                        <i class="fas fa-info-circle"></i>
                        Emergency Instructions
                    </h3>
                    <div style="padding: 16px; background: var(--light-orange); border-radius: var(--border-radius-md);">
                        <p style="margin-bottom: 12px; font-weight: 600; color: var(--dark-gray);">
                            <i class="fas fa-exclamation-circle"></i>
                            Important Information:
                        </p>
                        <ul style="padding-left: 20px; color: var(--medium-gray);">
                            <li style="margin-bottom: 8px;">Only use emergency services for genuine emergencies</li>
                            <li style="margin-bottom: 8px;">Misuse may result in penalties and legal action</li>
                            <li style="margin-bottom: 8px;">In case of immediate danger, call 911 first</li>
                            <li>Emergency services have priority routing and faster response times</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="rideTypeModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-car"></i>
                    Select Ride Type
                </h2>
                <button class="modal-close" id="closeRideTypeModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="ride-type-options">
                    <div class="ride-type-option premium" data-type="premium">
                        <div class="ride-type-icon">
                            <i class="fas fa-crown"></i>
                        </div>
                        <div class="ride-type-details">
                            <div class="ride-type-name">Premium Ride</div>
                            <div class="ride-type-description">Luxury vehicles with premium service</div>
                        </div>
                        <div class="ride-type-price">ZMW 45</div>
                    </div>
                    
                    <div class="ride-type-option standard selected" data-type="standard">
                        <div class="ride-type-icon">
                            <i class="fas fa-car"></i>
                        </div>
                        <div class="ride-type-details">
                            <div class="ride-type-name">Standard Ride</div>
                            <div class="ride-type-description">Comfortable and reliable service</div>
                        </div>
                        <div class="ride-type-price">ZMW 23</div>
                    </div>
                    
                    <div class="ride-type-option economy" data-type="economy">
                        <div class="ride-type-icon">
                            <i class="fas fa-car-side"></i>
                        </div>
                        <div class="ride-type-details">
                            <div class="ride-type-name">Economy Ride</div>
                            <div class="ride-type-description">Budget-friendly option</div>
                        </div>
                        <div class="ride-type-price">ZMW 15</div>
                    </div>
                </div>
                <button class="btn-primary" id="selectRideTypeBtn" style="width: 100%; margin-top: 20px;">
                    Confirm Ride Type
                </button>
            </div>
        </div>
    </div>
    
    <div id="paymentModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-credit-card"></i>
                    Select Payment Method
                </h2>
                <button class="modal-close" id="closePaymentModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="payment-options">
                    <div class="payment-option selected" data-type="wallet">
                        <div class="payment-option-icon">
                            <i class="fas fa-wallet"></i>
                        </div>
                        <div class="payment-option-details">
                            <div class="payment-option-name">Jubel Wallet</div>
                            <div class="payment-option-description">Pay with your Jubel wallet balance</div>
                            <div class="payment-option-balance" id="paymentWalletBalance">Balance: ZMW 0.00</div>
                        </div>
                    </div>
                    
                    <div class="payment-option" data-type="mobile">
                        <div class="payment-option-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="payment-option-details">
                            <div class="payment-option-name">Mobile Money</div>
                            <div class="payment-option-description">Pay with Airtel, MTN or Zamtel Money</div>
                        </div>
                    </div>
                    
                    <div class="payment-option" data-type="cash">
                        <div class="payment-option-icon">
                            <i class="fas fa-money-bill"></i>
                        </div>
                        <div class="payment-option-details">
                            <div class="payment-option-name">Cash on Delivery</div>
                            <div class="payment-option-description">Pay with cash when you arrive</div>
                        </div>
                    </div>
                </div>
                
                <div style="padding: 16px; background: var(--light-orange); border-radius: var(--border-radius-md); margin: 20px 0;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>Total Fare:</span>
                        <span style="font-weight: 800; font-size: 18px; color: var(--primary-orange);" id="modalFareAmount">
                            ZMW 0.00
                        </span>
                    </div>
                    <div id="insufficientBalance" style="color: var(--error-red); font-size: 13px; display: none;">
                        <i class="fas fa-exclamation-circle"></i>
                        Insufficient balance in your Jubel wallet
                    </div>
                </div>
                
                <button class="btn-primary" id="confirmPaymentBtn" style="width: 100%;">
                    Confirm Payment & Request Ride
                </button>
            </div>
        </div>
    </div>
    
    <div id="receiptModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-receipt"></i>
                    Ride Receipt
                </h2>
                <button class="modal-close" id="closeReceiptModal">&times;</button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; margin-bottom: 24px;">
                    <div style="font-size: 28px; font-weight: 800; color: var(--primary-orange);" id="receiptTotal">
                        ZMW 0.00
                    </div>
                    <div style="font-size: 13px; color: var(--medium-gray); margin-top: 8px;" id="receiptDate">
                        Date and Time
                    </div>
                </div>
                
                <div style="background: var(--light-gray); padding: 20px; border-radius: var(--border-radius-md); margin-bottom: 20px;">
                    <div class="fare-row" style="margin-bottom: 12px;">
                        <span>Receipt No:</span>
                        <span style="font-weight: 600;" id="receiptNumber">JUB-000000</span>
                    </div>
                    <div class="fare-row" style="margin-bottom: 12px;">
                        <span>Passenger:</span>
                        <span id="receiptPassenger">Passenger Name</span>
                    </div>
                    <div class="fare-row" style="margin-bottom: 12px;">
                        <span>Driver:</span>
                        <span id="receiptDriver">Driver Name</span>
                    </div>
                    <div class="fare-row" style="margin-bottom: 12px;">
                        <span>Vehicle:</span>
                        <span id="receiptVehicle">Vehicle Details</span>
                    </div>
                </div>
                
                <div style="background: var(--light-orange); padding: 20px; border-radius: var(--border-radius-md); margin-bottom: 20px;">
                    <div class="fare-row">
                        <span>Pickup:</span>
                        <span id="receiptPickup">Pickup Location</span>
                    </div>
                    <div class="fare-row" style="margin: 12px 0;">
                        <span>Destination:</span>
                        <span id="receiptDestination">Destination</span>
                    </div>
                    <div class="fare-row">
                        <span>Distance:</span>
                        <span id="receiptDistance">0 km</span>
                    </div>
                </div>
                
                <div style="background: var(--white); padding: 20px; border-radius: var(--border-radius-md); border: 2px solid var(--light-gray-2);">
                    <div class="fare-row">
                        <span>Base Fare:</span>
                        <span id="receiptBaseFare">ZMW 0.00</span>
                    </div>
                    <div class="fare-row" style="margin: 12px 0;">
                        <span>Distance Fare:</span>
                        <span id="receiptDistanceFare">ZMW 0.00</span>
                    </div>
                    <div class="fare-row">
                        <span>Discount:</span>
                        <span id="receiptDiscount">ZMW 0.00</span>
                    </div>
                    <hr class="divider">
                    <div class="fare-row total">
                        <span>TOTAL:</span>
                        <span id="receiptTotalAmount">ZMW 0.00</span>
                    </div>
                </div>
                
                <div style="display: flex; gap: 12px; margin-top: 24px;">
                    <button class="btn-success" id="downloadReceiptBtn" style="flex: 1;">
                        <i class="fas fa-download"></i>
                        Download
                    </button>
                    <button class="btn-secondary" id="closeReceiptBtn" style="flex: 1;">
                        <i class="fas fa-times"></i>
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script>
        // Ultra-Enhanced Jubel Passenger App
        // Version 2.0 - Advanced Features & Performance

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDEACX_P4c5q7djJAcA0I7Lk7leO2TlQ74",
            authDomain: "jubel-13e1a.firebaseapp.com",
            databaseURL: "https://jubel-13e1a-default-rtdb.firebaseio.com",
            projectId: "jubel-13e1a",
            storageBucket: "jubel-13e1a.firebasestorage.app",
            messagingSenderId: "882241095445",
            appId: "1:882241095445:web:ee9ca40fddd008ca910b1c",
            measurementId: "G-J5JPKL6B5F"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        // App State Management
        class AppState {
            constructor() {
                this.currentUser = null;
                this.userData = null;
                this.currentRide = null;
                this.currentScreen = 'home';
                this.userLocation = null;
                this.currentCity = 'Lusaka';
                this.walletBalance = 0;
                this.selectedVehicleType = 'car';
                this.selectedRideType = 'standard';
                this.selectedPaymentType = 'wallet';
                this.appliedPromoCode = null;
                this.rideFare = 0;
                this.sosConfig = null;
                this.scheduledRides = [];
                this.countdownInterval = null;
                this.emergencyMode = false;
                this.emergencyServiceType = null;
                this.driverLocationListener = null;
                this.rideStatusListener = null;
                this.walletBalanceListener = null;
                this.searchCache = new Map();
                this.emergencyServicesCache = new Map();
                this.activeMoreOption = null;
            }

            reset() {
                this.currentRide = null;
                this.emergencyMode = false;
                this.emergencyServiceType = null;
                this.appliedPromoCode = null;
                this.rideFare = 0;
            }
        }

        const appState = new AppState();

        // Map Manager
        class MapManager {
            constructor() {
                this.map = null;
                this.currentLocationMarker = null;
                this.pickupMarker = null;
                this.destinationMarker = null;
                this.driverMarker = null;
                this.emergencyMarker = null;
                this.routePolyline = null;
                this.markers = [];
            }

            initialize(containerId, center, zoom) {
                this.map = L.map(containerId).setView(center, zoom);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: ' OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(this.map);
                
                return this.map;
            }

            addCurrentLocationMarker(lat, lng) {
                if (this.currentLocationMarker) {
                    this.currentLocationMarker.setLatLng([lat, lng]);
                } else {
                    this.currentLocationMarker = L.marker([lat, lng], {
                        icon: L.divIcon({
                            className: 'pickup-marker',
                            html: '<div class="pickup-marker"><i class="fas fa-user"></i></div>',
                            iconSize: [28, 28]
                        })
                    }).addTo(this.map)
                      .bindPopup('Your Location');
                }
                return this.currentLocationMarker;
            }

            addPickupMarker(lat, lng, title = 'Pickup Location') {
                if (this.pickupMarker) {
                    this.map.removeLayer(this.pickupMarker);
                }
                
                this.pickupMarker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        className: 'pickup-marker',
                        html: '<div class="pickup-marker"><i class="fas fa-map-marker-alt"></i></div>',
                        iconSize: [28, 28]
                    })
                }).addTo(this.map)
                  .bindPopup(`<strong>${title}</strong>`)
                  .openPopup();
                
                return this.pickupMarker;
            }

            addDestinationMarker(lat, lng, title = 'Destination') {
                if (this.destinationMarker) {
                    this.map.removeLayer(this.destinationMarker);
                }
                
                this.destinationMarker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        className: 'destination-marker',
                        html: '<div class="destination-marker"><i class="fas fa-flag"></i></div>',
                        iconSize: [28, 28]
                    })
                }).addTo(this.map)
                  .bindPopup(`<strong>${title}</strong>`)
                  .openPopup();
                
                return this.destinationMarker;
            }

            addDriverMarker(lat, lng, isEmergency = false) {
                if (this.driverMarker) {
                    this.map.removeLayer(this.driverMarker);
                }
                
                if (isEmergency && this.emergencyMarker) {
                    this.map.removeLayer(this.emergencyMarker);
                }
                
                if (isEmergency) {
                    this.emergencyMarker = L.marker([lat, lng], {
                        icon: L.divIcon({
                            className: 'emergency-marker',
                            html: '<div class="emergency-marker"><i class="fas fa-ambulance"></i></div>',
                            iconSize: [48, 48]
                        })
                    }).addTo(this.map)
                      .bindPopup('Emergency Vehicle');
                } else {
                    this.driverMarker = L.marker([lat, lng], {
                        icon: L.divIcon({
                            className: 'driver-marker',
                            html: '<div class="driver-marker"><i class="fas fa-car"></i></div>',
                            iconSize: [40, 40]
                        })
                    }).addTo(this.map)
                      .bindPopup('Your Driver');
                }
            }

            drawRoute(startLat, startLng, endLat, endLng) {
                if (this.routePolyline) {
                    this.map.removeLayer(this.routePolyline);
                }
                
                // Create a simple straight line for immediate feedback
                this.routePolyline = L.polyline([
                    [startLat, startLng],
                    [endLat, endLng]
                ], {
                    color: '#FF6B35',
                    weight: 4,
                    opacity: 0.7,
                    dashArray: '8, 8'
                }).addTo(this.map);
                
                // Fit bounds to show both points
                const bounds = L.latLngBounds(
                    [startLat, startLng],
                    [endLat, endLng]
                );
                this.map.fitBounds(bounds, { padding: [50, 50] });
                
                // Asynchronously fetch detailed route
                this.fetchDetailedRoute(startLat, startLng, endLat, endLng);
                
                return this.routePolyline;
            }

            async fetchDetailedRoute(startLat, startLng, endLat, endLng) {
                try {
                    const response = await fetch(
                        `https://router.project-osrm.org/route/v1/driving/${startLng},${startLat};${endLng},${endLat}?overview=full&geometries=geojson`
                    );
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.routes && data.routes.length > 0) {
                            const route = data.routes[0];
                            const coordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                            
                            // Update the polyline with detailed route
                            if (this.routePolyline) {
                                this.map.removeLayer(this.routePolyline);
                                this.routePolyline = L.polyline(coordinates, {
                                    color: '#FF6B35',
                                    weight: 4,
                                    opacity: 0.8
                                }).addTo(this.map);
                            }
                        }
                    }
                } catch (error) {
                    console.log('Using simplified route');
                }
            }

            clearRoute() {
                if (this.routePolyline) {
                    this.map.removeLayer(this.routePolyline);
                    this.routePolyline = null;
                }
            }

            clearMarkers() {
                if (this.pickupMarker) {
                    this.map.removeLayer(this.pickupMarker);
                    this.pickupMarker = null;
                }
                if (this.destinationMarker) {
                    this.map.removeLayer(this.destinationMarker);
                    this.destinationMarker = null;
                }
                if (this.driverMarker) {
                    this.map.removeLayer(this.driverMarker);
                    this.driverMarker = null;
                }
                if (this.emergencyMarker) {
                    this.map.removeLayer(this.emergencyMarker);
                    this.emergencyMarker = null;
                }
                this.clearRoute();
            }

            centerMap(lat, lng, zoom = 16) {
                this.map.setView([lat, lng], zoom);
            }
        }

        // Search Manager with Ultra-Fast Performance
        class SearchManager {
            constructor() {
                this.cache = new Map();
                this.searchTimeout = null;
                this.debounceDelay = 200;
                this.maxCacheSize = 100;
                this.zambianCities = [
                    'Lusaka', 'Kitwe', 'Ndola', 'Kabwe', 'Chipata', 'Chingola',
                    'Mufulira', 'Luanshya', 'Livingstone', 'Kasama', 'Solwezi',
                    'Kapiri Mposhi', 'Chililabombwe', 'Mongu', 'Mazabuka', 'Kafue'
                ];
            }

            async search(query, city = null, limit = 10) {
                // Check cache first
                const cacheKey = `${query}-${city}`;
                if (this.cache.has(cacheKey)) {
                    return this.cache.get(cacheKey);
                }

                try {
                    // Prepare search query
                    let searchQuery = query;
                    if (city && this.zambianCities.includes(city)) {
                        searchQuery = `${query}, ${city}, Zambia`;
                    } else {
                        searchQuery = `${query}, Zambia`;
                    }

                    // Fetch from Nominatim with optimized parameters
                    const response = await fetch(
                        `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&limit=${limit}&countrycodes=zm&dedupe=1&polygon=0&addressdetails=1`
                    );

                    if (!response.ok) throw new Error('Search failed');

                    const results = await response.json();
                    
                    // Process and enhance results
                    const enhancedResults = results.map(result => ({
                        ...result,
                        lat: parseFloat(result.lat),
                        lon: parseFloat(result.lon),
                        display_name: this.formatAddress(result),
                        relevance: this.calculateRelevance(result, query)
                    })).sort((a, b) => b.relevance - a.relevance);

                    // Cache results
                    this.cache.set(cacheKey, enhancedResults);
                    
                    // Manage cache size
                    if (this.cache.size > this.maxCacheSize) {
                        const firstKey = this.cache.keys().next().value;
                        this.cache.delete(firstKey);
                    }

                    return enhancedResults;
                } catch (error) {
                    console.error('Search error:', error);
                    return [];
                }
            }

            formatAddress(result) {
                if (!result.address) return result.display_name;
                
                const address = result.address;
                const parts = [];
                
                // House number or building name
                if (address.house_number || address.housenumber) {
                    parts.push(address.house_number || address.housenumber);
                } else if (address.building) {
                    parts.push(address.building);
                }
                
                // Road name
                if (address.road) {
                    parts.push(address.road);
                }
                
                // Area/Suburb
                if (address.suburb) {
                    parts.push(address.suburb);
                } else if (address.neighbourhood) {
                    parts.push(address.neighbourhood);
                }
                
                // Return formatted address
                return parts.join(', ') || result.display_name;
            }

            calculateRelevance(result, query) {
                let score = 0;
                const queryLower = query.toLowerCase();
                const displayLower = result.display_name.toLowerCase();
                
                // Exact match bonus
                if (displayLower.includes(queryLower)) {
                    score += 10;
                }
                
                // Word match bonus
                const queryWords = queryLower.split(' ');
                queryWords.forEach(word => {
                    if (word.length > 2 && displayLower.includes(word)) {
                        score += 5;
                    }
                });
                
                // Address component bonus
                if (result.address) {
                    if (result.address.road && result.address.road.toLowerCase().includes(queryLower)) {
                        score += 8;
                    }
                    if (result.address.house_number || result.address.building) {
                        score += 3;
                    }
                }
                
                return score;
            }

            clearCache() {
                this.cache.clear();
            }

            debounceSearch(func, delay) {
                return (...args) => {
                    if (this.searchTimeout) {
                        clearTimeout(this.searchTimeout);
                    }
                    this.searchTimeout = setTimeout(() => func(...args), delay);
                };
            }
        }

        // Price Calculator with Advanced Logic
        class PriceCalculator {
            constructor() {
                this.baseFares = {
                    economy: 15,
                    standard: 23,
                    premium: 45,
                    bike: 18,
                    bicycle: 15,
                    'light-truck': 50,
                    ambulance: 600,
                    police: 300,
                    fire: 500,
                    hospital: 400
                };
                
                this.distanceRate = 0.9; // ZMW per 90 meters
                this.timeRate = 0.3; // ZMW per minute
                this.surgeMultipliers = {
                    low: 1.0,
                    medium: 1.2,
                    high: 1.5,
                    peak: 2.0
                };
            }

            calculateFare(rideType, distance, duration, surgeLevel = 'low') {
                let fare = this.baseFares[rideType] || this.baseFares.standard;
                
                // Distance-based fare
                if (distance > 0) {
                    fare += Math.ceil(distance / 90) * this.distanceRate;
                }
                
                // Time-based fare (for traffic)
                if (duration > 0) {
                    fare += Math.ceil(duration / 60) * this.timeRate;
                }
                
                // Apply surge pricing
                const surge = this.surgeMultipliers[surgeLevel] || 1.0;
                fare *= surge;
                
                // Round to nearest kwacha
                fare = Math.ceil(fare);
                
                return fare;
            }

            calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 6371e3; // Earth's radius in meters
                const 1 = lat1 * Math.PI / 180;
                const 2 = lat2 * Math.PI / 180;
                const  = (lat2 - lat1) * Math.PI / 180;
                const  = (lon2 - lon1) * Math.PI / 180;

                const a = Math.sin(/2) * Math.sin(/2) +
                          Math.cos(1) * Math.cos(2) *
                          Math.sin(/2) * Math.sin(/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

                return R * c; // Distance in meters
            }

            estimateDuration(distance) {
                // Estimate duration based on distance and average speed
                const averageSpeed = 30; // km/h
                const duration = (distance / 1000) / averageSpeed * 60; // minutes
                return Math.max(5, Math.ceil(duration)); // Minimum 5 minutes
            }

            formatPrice(amount) {
                return `ZMW ${amount.toFixed(2)}`;
            }
        }

        // Emergency Service Manager
        class EmergencyServiceManager {
            constructor() {
                this.services = {
                    police: {
                        name: 'Police Station',
                        icon: 'fas fa-shield-alt',
                        color: '#0047AB',
                        basePrice: 300,
                        locations: this.getPoliceStations()
                    },
                    fire: {
                        name: 'Fire Brigade',
                        icon: 'fas fa-fire-extinguisher',
                        color: '#CC0000',
                        basePrice: 500,
                        locations: this.getFireStations()
                    },
                    hospital: {
                        name: 'Hospital',
                        icon: 'fas fa-hospital',
                        color: '#008000',
                        basePrice: 400,
                        locations: this.getHospitals()
                    },
                    ambulance: {
                        name: 'Ambulance',
                        icon: 'fas fa-ambulance',
                        color: '#0066CC',
                        basePrice: 600,
                        locations: this.getAmbulanceStations()
                    }
                };
            }

            getPoliceStations() {
                // Major police stations in Zambian cities
                return [
                    { name: 'Lusaka Central Police', lat: -15.4167, lng: 28.2833 },
                    { name: 'Kitwe Central Police', lat: -12.8139, lng: 28.2136 },
                    { name: 'Ndola Central Police', lat: -12.9667, lng: 28.6333 },
                    { name: 'Kabwe Police Station', lat: -14.4333, lng: 28.4500 },
                    { name: 'Livingstone Police', lat: -17.8500, lng: 25.8667 }
                ];
            }

            getFireStations() {
                return [
                    { name: 'Lusaka Fire Station', lat: -15.4167, lng: 28.2833 },
                    { name: 'Kitwe Fire Station', lat: -12.8139, lng: 28.2136 },
                    { name: 'Ndola Fire Station', lat: -12.9667, lng: 28.6333 }
                ];
            }

            getHospitals() {
                return [
                    { name: 'University Teaching Hospital', lat: -15.4167, lng: 28.2833 },
                    { name: 'Kitwe Central Hospital', lat: -12.8139, lng: 28.2136 },
                    { name: 'Ndola Central Hospital', lat: -12.9667, lng: 28.6333 },
                    { name: 'Livingstone Central Hospital', lat: -17.8500, lng: 25.8667 }
                ];
            }

            getAmbulanceStations() {
                return [
                    { name: 'Lusaka Ambulance Base', lat: -15.4167, lng: 28.2833 },
                    { name: 'Kitwe Ambulance Base', lat: -12.8139, lng: 28.2136 },
                    { name: 'Ndola Ambulance Base', lat: -12.9667, lng: 28.6333 }
                ];
            }

            findNearestService(serviceType, userLat, userLng) {
                const service = this.services[serviceType];
                if (!service) return null;

                let nearest = null;
                let minDistance = Infinity;

                service.locations.forEach(location => {
                    const distance = this.calculateDistance(
                        userLat, userLng,
                        location.lat, location.lng
                    );
                    
                    if (distance < minDistance) {
                        minDistance = distance;
                        nearest = location;
                    }
                });

                return nearest ? {
                    ...nearest,
                    distance: minDistance,
                    estimatedPrice: service.basePrice + Math.ceil(minDistance / 50) * 10
                } : null;
            }

            calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 6371e3;
                const 1 = lat1 * Math.PI / 180;
                const 2 = lat2 * Math.PI / 180;
                const  = (lat2 - lat1) * Math.PI / 180;
                const  = (lon2 - lon1) * Math.PI / 180;

                const a = Math.sin(/2) * Math.sin(/2) +
                          Math.cos(1) * Math.cos(2) *
                          Math.sin(/2) * Math.sin(/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

                return R * c;
            }

            getServiceInfo(serviceType) {
                return this.services[serviceType];
            }
        }

        // UI Manager
        class UIManager {
            constructor() {
                this.elements = {};
                this.initializeElements();
            }

            initializeElements() {
                // Map all DOM elements for quick access
                this.elements = {
                    // Map and main containers
                    map: document.getElementById('map'),
                    passengerPanel: document.getElementById('passengerPanel'),
                    panelCollapseHandle: document.getElementById('panelCollapseHandle'),
                    
                    // Navigation
                    navButtons: document.querySelectorAll('.nav-btn'),
                    backButtons: document.querySelectorAll('.back-button'),
                    
                    // Ride request
                    pickupLocation: document.getElementById('pickupLocation'),
                    destinationLocation: document.getElementById('destinationLocation'),
                    destinationSuggestions: document.getElementById('destinationSuggestions'),
                    vehicleSelection: document.getElementById('vehicleSelection'),
                    vehicleOptions: document.querySelectorAll('.vehicle-option'),
                    fareDisplay: document.getElementById('fareDisplay'),
                    estimatedFare: document.getElementById('estimatedFare'),
                    etaDisplay: document.getElementById('etaDisplay'),
                    requestRideBtn: document.getElementById('requestRideBtn'),
                    
                    // Ride info
                    rideInfoPanel: document.getElementById('rideInfoPanel'),
                    driverName: document.getElementById('driverName'),
                    driverPhone: document.getElementById('driverPhone'),
                    vehicleDetails: document.getElementById('vehicleDetails'),
                    driverRating: document.getElementById('driverRating'),
                    driverAvatar: document.getElementById('driverAvatar'),
                    currentPickupLocation: document.getElementById('currentPickupLocation'),
                    currentDestinationLocation: document.getElementById('currentDestinationLocation'),
                    baseFare: document.getElementById('baseFare'),
                    distanceFare: document.getElementById('distanceFare'),
                    discountFare: document.getElementById('discountFare'),
                    totalFare: document.getElementById('totalFare'),
                    cancelRideBtn: document.getElementById('cancelRideBtn'),
                    contactDriverBtn: document.getElementById('contactDriverBtn'),
                    
                    // Account screen
                    walletBalance: document.getElementById('walletBalance'),
                    accountBalance: document.getElementById('accountBalance'),
                    accountName: document.getElementById('accountName'),
                    accountPhone: document.getElementById('accountPhone'),
                    accountEmail: document.getElementById('accountEmail'),
                    referralCode: document.getElementById('referralCode'),
                    ridesCompleted: document.getElementById('ridesCompleted'),
                    ridesCancelled: document.getElementById('ridesCancelled'),
                    ridesPending: document.getElementById('ridesPending'),
                    depositBtn: document.getElementById('depositBtn'),
                    withdrawBtn: document.getElementById('withdrawBtn'),
                    shareReferralBtn: document.getElementById('shareReferralBtn'),
                    whatsappBtn: document.getElementById('whatsappBtn'),
                    callBtn: document.getElementById('callBtn'),
                    
                    // History screen
                    historyFilter: document.getElementById('historyFilter'),
                    historyDate: document.getElementById('historyDate'),
                    historyList: document.getElementById('historyList'),
                    
                    // Emergency screen
                    emergencyRideOptions: document.querySelectorAll('.emergency-ride-option'),
                    requestEmergencyBtn: document.getElementById('requestEmergencyBtn'),
                    
                    // Modals
                    rideTypeModal: document.getElementById('rideTypeModal'),
                    closeRideTypeModal: document.getElementById('closeRideTypeModal'),
                    rideTypeOptions: document.querySelectorAll('.ride-type-option'),
                    selectRideTypeBtn: document.getElementById('selectRideTypeBtn'),
                    
                    paymentModal: document.getElementById('paymentModal'),
                    closePaymentModal: document.getElementById('closePaymentModal'),
                    paymentOptions: document.querySelectorAll('.payment-option'),
                    paymentWalletBalance: document.getElementById('paymentWalletBalance'),
                    modalFareAmount: document.getElementById('modalFareAmount'),
                    insufficientBalance: document.getElementById('insufficientBalance'),
                    confirmPaymentBtn: document.getElementById('confirmPaymentBtn'),
                    
                    receiptModal: document.getElementById('receiptModal'),
                    closeReceiptModal: document.getElementById('closeReceiptModal'),
                    receiptTotal: document.getElementById('receiptTotal'),
                    receiptDate: document.getElementById('receiptDate'),
                    receiptNumber: document.getElementById('receiptNumber'),
                    receiptPassenger: document.getElementById('receiptPassenger'),
                    receiptDriver: document.getElementById('receiptDriver'),
                    receiptVehicle: document.getElementById('receiptVehicle'),
                    receiptPickup: document.getElementById('receiptPickup'),
                    receiptDestination: document.getElementById('receiptDestination'),
                    receiptDistance: document.getElementById('receiptDistance'),
                    receiptBaseFare: document.getElementById('receiptBaseFare'),
                    receiptDistanceFare: document.getElementById('receiptDistanceFare'),
                    receiptDiscount: document.getElementById('receiptDiscount'),
                    receiptTotalAmount: document.getElementById('receiptTotalAmount'),
                    downloadReceiptBtn: document.getElementById('downloadReceiptBtn'),
                    closeReceiptBtn: document.getElementById('closeReceiptBtn'),
                    
                    // More options
                    moreOptionsBtn: document.getElementById('moreOptionsBtn'),
                    moreOptionsDropdown: document.getElementById('moreOptionsDropdown'),
                    moreOptionItems: document.querySelectorAll('.more-option-item'),
                    
                    // Promo code
                    promoToggle: document.getElementById('promoToggle'),
                    promoSection: document.getElementById('promoSection'),
                    promoCode: document.getElementById('promoCode'),
                    applyPromoBtn: document.getElementById('applyPromoBtn'),
                    
                    // SOS and notifications
                    sosButton: document.getElementById('sosButton'),
                    countdownTimer: document.getElementById('countdownTimer'),
                    countdownTime: document.getElementById('countdownTime'),
                    emergencyRideStatus: document.getElementById('emergencyRideStatus'),
                    notification: document.getElementById('notification'),
                    searchingAnimation: document.getElementById('searchingAnimation'),
                    
                    // Saved locations
                    savedLocations: document.querySelectorAll('.saved-location-btn')
                };
            }

            showNotification(message, type = 'info') {
                const notification = this.elements.notification;
                notification.textContent = message;
                
                // Set color based on type
                if (type === 'error') {
                    notification.style.background = 'var(--error-red)';
                } else if (type === 'success') {
                    notification.style.background = 'var(--success-green)';
                } else {
                    notification.style.background = 'var(--primary-gradient)';
                }
                
                notification.style.display = 'block';
                
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 4000);
            }

            showModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.remove('hidden');
                }
            }

            hideModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.add('hidden');
                }
            }

            switchScreen(screenId) {
                // Hide all screens
                document.querySelectorAll('.screen-content').forEach(screen => {
                    screen.classList.remove('active');
                });
                
                // Show selected screen
                const screen = document.getElementById(screenId + 'Screen');
                if (screen) {
                    screen.classList.add('active');
                }
                
                // Update navigation buttons
                this.elements.navButtons.forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.getAttribute('data-screen') === screenId) {
                        btn.classList.add('active');
                    }
                });
                
                // Update app state
                appState.currentScreen = screenId;
                
                // Show/hide floating elements
                const homeOnlyElements = document.querySelectorAll('.home-only');
                homeOnlyElements.forEach(el => {
                    el.style.display = screenId === 'home' ? 'flex' : 'none';
                });
            }

            updateWalletBalance(balance) {
                const formattedBalance = `ZMW ${balance.toFixed(2)}`;
                this.elements.walletBalance.textContent = formattedBalance;
                this.elements.accountBalance.textContent = formattedBalance;
                this.elements.paymentWalletBalance.textContent = `Balance: ${formattedBalance}`;
            }

            showSearchingAnimation() {
                this.elements.searchingAnimation.style.display = 'flex';
            }

            hideSearchingAnimation() {
                this.elements.searchingAnimation.style.display = 'none';
            }

            updateFareDisplay(fare, eta) {
                this.elements.estimatedFare.textContent = `ZMW ${fare.toFixed(2)}`;
                this.elements.etaDisplay.textContent = `ETA: ${eta} min`;
                this.elements.fareDisplay.classList.add('active');
            }

            showRideInfo(ride) {
                this.elements.rideRequestForm.style.display = 'none';
                this.elements.rideInfoPanel.style.display = 'block';
                
                if (ride.driverName) {
                    this.elements.driverName.textContent = ride.driverName;
                    this.elements.driverPhone.textContent = ride.driverPhone || 'N/A';
                    this.elements.vehicleDetails.textContent = ride.vehicleDetails || 'N/A';
                    this.elements.driverRating.textContent = ride.driverRating || '4.5 ';
                }
                
                this.elements.currentPickupLocation.textContent = ride.pickupLocation || 'Current Location';
                this.elements.currentDestinationLocation.textContent = ride.destination || 'Destination';
                
                const baseFare = ride.baseFare || 23;
                const distanceFare = ride.distanceFare || 0;
                const discount = ride.discount || 0;
                const total = baseFare + distanceFare - discount;
                
                this.elements.baseFare.textContent = `ZMW ${baseFare.toFixed(2)}`;
                this.elements.distanceFare.textContent = `ZMW ${distanceFare.toFixed(2)}`;
                this.elements.discountFare.textContent = `-ZMW ${discount.toFixed(2)}`;
                this.elements.totalFare.textContent = `ZMW ${total.toFixed(2)}`;
            }

            showPaymentModal(fare) {
                this.elements.modalFareAmount.textContent = `ZMW ${fare.toFixed(2)}`;
                
                // Check wallet balance
                if (appState.selectedPaymentType === 'wallet' && appState.walletBalance < fare) {
                    this.elements.insufficientBalance.style.display = 'block';
                    this.elements.confirmPaymentBtn.disabled = true;
                } else {
                    this.elements.insufficientBalance.style.display = 'none';
                    this.elements.confirmPaymentBtn.disabled = false;
                }
                
                this.showModal('paymentModal');
            }

            updateVehicleSelection(selectedType) {
                this.elements.vehicleOptions.forEach(option => {
                    option.classList.remove('selected');
                    if (option.getAttribute('data-type') === selectedType) {
                        option.classList.add('selected');
                    }
                });
            }

            showSearchSuggestions(results, containerId) {
                const container = document.getElementById(containerId);
                if (!container) return;
                
                container.innerHTML = '';
                
                if (results.length === 0) {
                    container.innerHTML = '<div class="suggestion-item"><div class="suggestion-details">No results found</div></div>';
                } else {
                    results.forEach(result => {
                        const item = document.createElement('div');
                        item.className = 'suggestion-item';
                        item.innerHTML = `
                            <div class="suggestion-icon">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="suggestion-details">
                                <div class="suggestion-name">${result.display_name}</div>
                                <div class="suggestion-distance">${this.formatDistance(result.distance)}</div>
                            </div>
                        `;
                        
                        item.addEventListener('click', () => {
                            this.handleSearchResultSelection(result, containerId);
                        });
                        
                        container.appendChild(item);
                    });
                }
                
                container.style.display = 'block';
            }

            formatDistance(distance) {
                if (distance < 1000) {
                    return `${Math.round(distance)}m away`;
                } else {
                    return `${(distance / 1000).toFixed(1)}km away`;
                }
            }

            handleSearchResultSelection(result, containerId) {
                if (containerId === 'destinationSuggestions') {
                    this.elements.destinationLocation.value = result.display_name;
                    this.hideSearchSuggestions(containerId);
                    
                    // Trigger fare calculation
                    if (appState.userLocation) {
                        const distance = priceCalculator.calculateDistance(
                            appState.userLocation.lat,
                            appState.userLocation.lng,
                            result.lat,
                            result.lon
                        );
                        
                        const fare = priceCalculator.calculateFare(
                            appState.selectedVehicleType,
                            distance,
                            priceCalculator.estimateDuration(distance)
                        );
                        
                        const eta = priceCalculator.estimateDuration(distance);
                        this.updateFareDisplay(fare, eta);
                        appState.rideFare = fare;
                        
                        // Show ride type selection modal
                        this.showModal('rideTypeModal');
                    }
                }
            }

            hideSearchSuggestions(containerId) {
                const container = document.getElementById(containerId);
                if (container) {
                    container.style.display = 'none';
                }
            }

            showEmergencyRideStatus() {
                this.elements.emergencyRideStatus.style.display = 'flex';
            }

            hideEmergencyRideStatus() {
                this.elements.emergencyRideStatus.style.display = 'none';
            }

            showCountdownTimer() {
                this.elements.countdownTimer.classList.add('active');
            }

            hideCountdownTimer() {
                this.elements.countdownTimer.classList.remove('active');
            }

            updateCountdownTime(time) {
                this.elements.countdownTime.textContent = time;
            }

            showSOSButton() {
                this.elements.sosButton.style.display = 'flex';
            }

            hideSOSButton() {
                this.elements.sosButton.style.display = 'none';
            }

            toggleMoreOptions() {
                this.elements.moreOptionsDropdown.classList.toggle('active');
            }

            showPromoSection() {
                this.elements.promoSection.style.display = 'block';
            }

            hidePromoSection() {
                this.elements.promoSection.style.display = 'none';
            }

            updateHistoryList(rides) {
                const historyList = this.elements.historyList;
                historyList.innerHTML = '';
                
                if (rides.length === 0) {
                    historyList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">
                                <i class="fas fa-history"></i>
                            </div>
                            <div class="empty-state-title">No Rides Found</div>
                            <div class="empty-state-description">
                                No rides match your current filters. Try changing your search criteria.
                            </div>
                        </div>
                    `;
                    return;
                }
                
                rides.forEach(ride => {
                    const historyItem = this.createHistoryItem(ride);
                    historyList.appendChild(historyItem);
                });
            }

            createHistoryItem(ride) {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.setAttribute('data-ride-id', ride.id);
                
                const date = new Date(ride.timestamp);
                const formattedDate = date.toLocaleDateString();
                const formattedTime = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                // Determine ride type and status
                const typeClass = ride.emergencyDetails ? 'emergency' : 
                                 ride.expressDelivery || ride.truckDelivery ? 'delivery' : 'ride';
                const typeText = ride.emergencyDetails ? 'Emergency' : 
                                ride.expressDelivery || ride.truckDelivery ? 'Delivery' : 'Ride';
                
                const statusClass = ride.status === 'completed' ? 'completed' :
                                   ride.status === 'cancelled' ? 'cancelled' : 'in-progress';
                const statusText = ride.status === 'completed' ? 'Completed' :
                                  ride.status === 'cancelled' ? 'Cancelled' : 'In Progress';
                
                item.innerHTML = `
                    <div class="history-item-header">
                        <div class="history-item-type ${typeClass}">
                            <i class="fas fa-${typeClass === 'emergency' ? 'ambulance' : typeClass === 'delivery' ? 'shipping-fast' : 'car'}"></i>
                            ${typeText}
                        </div>
                        <div class="history-item-date">${formattedDate} ${formattedTime}</div>
                    </div>
                    <div class="history-item-content">
                        <div class="history-item-locations">
                            <div class="history-location pickup">
                                <div class="history-location-icon">
                                    <i class="fas fa-map-marker-alt"></i>
                                </div>
                                <div class="history-location-text">
                                    ${ride.pickupDisplayLocation || ride.pickupLocation}
                                </div>
                            </div>
                            <div class="history-location destination">
                                <div class="history-location-icon">
                                    <i class="fas fa-flag"></i>
                                </div>
                                <div class="history-location-text">
                                    ${ride.destination}
                                </div>
                            </div>
                        </div>
                        <div class="history-item-details">
                            <div class="history-detail-item">
                                <div class="history-detail-label">Fare</div>
                                <div class="history-detail-value">ZMW ${ride.fare ? ride.fare.toFixed(2) : '0.00'}</div>
                            </div>
                            <div class="history-detail-item">
                                <div class="history-detail-label">Distance</div>
                                <div class="history-detail-value">${ride.distance || '0 km'}</div>
                            </div>
                        </div>
                        <div class="history-item-footer">
                            <div class="history-fare">ZMW ${ride.fare ? ride.fare.toFixed(2) : '0.00'}</div>
                            <div class="history-status status-${statusClass}">
                                ${statusText}
                            </div>
                        </div>
                    </div>
                    <div class="history-expanded-details">
                        <!-- Expanded details will be loaded on click -->
                    </div>
                `;
                
                // Add click event for expansion
                item.addEventListener('click', (e) => {
                    if (!e.target.closest('.history-item-header') && 
                        !e.target.closest('.history-item-footer')) {
                        this.toggleHistoryItemExpansion(item, ride);
                    }
                });
                
                return item;
            }

            toggleHistoryItemExpansion(item, ride) {
                const isExpanded = item.classList.contains('expanded');
                const expandedDetails = item.querySelector('.history-expanded-details');
                
                if (isExpanded) {
                    item.classList.remove('expanded');
                    expandedDetails.innerHTML = '';
                } else {
                    item.classList.add('expanded');
                    this.loadExpandedDetails(expandedDetails, ride);
                }
            }

            async loadExpandedDetails(container, ride) {
                container.innerHTML = `
                    <div class="loading-text">
                        <i class="fas fa-spinner fa-spin"></i>
                        Loading details...
                    </div>
                `;
                
                try {
                    // Load driver details if available
                    let driverDetails = '';
                    if (ride.driverId) {
                        const driverSnapshot = await database.ref('users/' + ride.driverId).once('value');
                        const driver = driverSnapshot.val();
                        if (driver) {
                            driverDetails = `
                                <div class="expanded-section">
                                    <div class="expanded-section-title">
                                        <i class="fas fa-user"></i>
                                        Driver Information
                                    </div>
                                    <div class="driver-info-expanded">
                                        <div class="driver-avatar-expanded">
                                            ${driver.name ? driver.name.charAt(0).toUpperCase() : 'D'}
                                        </div>
                                        <div class="driver-details-expanded">
                                            <h4>${driver.name || 'Driver'}</h4>
                                            <div style="display: flex; align-items: center; gap: 12px; margin-top: 8px;">
                                                <span><i class="fas fa-phone"></i> ${driver.phone || 'N/A'}</span>
                                                <span class="driver-rating">
                                                    <i class="fas fa-star"></i>
                                                    ${driver.rating || '4.5'}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                    }
                    
                    // Load vehicle details
                    let vehicleDetails = '';
                    if (ride.driverId) {
                        const driverSnapshot = await database.ref('users/' + ride.driverId).once('value');
                        const driver = driverSnapshot.val();
                        if (driver && driver.vehicle) {
                            vehicleDetails = `
                                <div class="expanded-section">
                                    <div class="expanded-section-title">
                                        <i class="fas fa-car"></i>
                                        Vehicle Details
                                    </div>
                                    <div class="vehicle-details-expanded">
                                        <div class="vehicle-detail-item">
                                            <div class="vehicle-detail-label">Type</div>
                                            <div class="vehicle-detail-value">${driver.vehicle.type || 'N/A'}</div>
                                        </div>
                                        <div class="vehicle-detail-item">
                                            <div class="vehicle-detail-label">Model</div>
                                            <div class="vehicle-detail-value">${driver.vehicle.model || 'N/A'}</div>
                                        </div>
                                        <div class="vehicle-detail-item">
                                            <div class="vehicle-detail-label">Color</div>
                                            <div class="vehicle-detail-value">${driver.vehicle.color || 'N/A'}</div>
                                        </div>
                                        <div class="vehicle-detail-item">
                                            <div class="vehicle-detail-label">Plate</div>
                                            <div class="vehicle-detail-value">${driver.vehicle.licensePlate || 'N/A'}</div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                    }
                    
                    // Timeline
                    const timeline = this.createRideTimeline(ride);
                    
                    container.innerHTML = `
                        ${driverDetails}
                        ${vehicleDetails}
                        ${timeline}
                    `;
                } catch (error) {
                    console.error('Error loading expanded details:', error);
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">
                                <i class="fas fa-exclamation-circle"></i>
                            </div>
                            <div class="empty-state-title">Error Loading Details</div>
                            <div class="empty-state-description">
                                Unable to load ride details. Please try again.
                            </div>
                        </div>
                    `;
                }
            }

            createRideTimeline(ride) {
                const date = new Date(ride.timestamp);
                const timelineItems = [];
                
                // Requested
                timelineItems.push({
                    time: date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                    description: 'Ride requested'
                });
                
                // Accepted (if applicable)
                if (ride.status === 'accepted' || ride.status === 'completed') {
                    const acceptedTime = new Date(ride.acceptedAt || ride.timestamp + 60000);
                    timelineItems.push({
                        time: acceptedTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                        description: 'Driver accepted'
                    });
                }
                
                // Started (if applicable)
                if (ride.status === 'completed') {
                    const startedTime = new Date(ride.startedAt || ride.timestamp + 120000);
                    timelineItems.push({
                        time: startedTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                        description: 'Trip started'
                    });
                }
                
                // Completed (if applicable)
                if (ride.status === 'completed') {
                    const completedTime = new Date(ride.completedAt || ride.timestamp + 1800000);
                    timelineItems.push({
                        time: completedTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                        description: 'Trip completed'
                    });
                }
                
                const timelineHTML = timelineItems.map((item, index) => `
                    <div class="timeline-item">
                        <div class="timeline-time">${item.time}</div>
                        <div class="timeline-dot"></div>
                        <div class="timeline-description">${item.description}</div>
                    </div>
                `).join('');
                
                return `
                    <div class="expanded-section">
                        <div class="expanded-section-title">
                            <i class="fas fa-history"></i>
                            Ride Timeline
                        </div>
                        <div class="ride-timeline">
                            ${timelineHTML}
                        </div>
                    </div>
                `;
            }
        }

        // Firebase Manager
        class FirebaseManager {
            constructor() {
                this.database = database;
                this.auth = auth;
            }

            async getUserData(uid) {
                try {
                    const snapshot = await this.database.ref('users/' + uid).once('value');
                    return snapshot.val();
                } catch (error) {
                    console.error('Error getting user data:', error);
                    throw error;
                }
            }

            async updateUserData(uid, data) {
                try {
                    await this.database.ref('users/' + uid).update(data);
                    return true;
                } catch (error) {
                    console.error('Error updating user data:', error);
                    throw error;
                }
            }

            async createRide(rideData) {
                try {
                    const rideId = this.database.ref().child('rides').push().key;
                    const ride = {
                        id: rideId,
                        ...rideData,
                        createdAt: firebase.database.ServerValue.TIMESTAMP,
                        updatedAt: firebase.database.ServerValue.TIMESTAMP
                    };
                    
                    await this.database.ref('rides/' + rideId).set(ride);
                    return { rideId, ride };
                } catch (error) {
                    console.error('Error creating ride:', error);
                    throw error;
                }
            }

            async updateRide(rideId, data) {
                try {
                    await this.database.ref('rides/' + rideId).update({
                        ...data,
                        updatedAt: firebase.database.ServerValue.TIMESTAMP
                    });
                    return true;
                } catch (error) {
                    console.error('Error updating ride:', error);
                    throw error;
                }
            }

            async getRide(rideId) {
                try {
                    const snapshot = await this.database.ref('rides/' + rideId).once('value');
                    return snapshot.val();
                } catch (error) {
                    console.error('Error getting ride:', error);
                    throw error;
                }
            }

            async getUserRides(uid, filter = 'all') {
                try {
                    const snapshot = await this.database.ref('rides')
                        .orderByChild('passengerId')
                        .equalTo(uid)
                        .once('value');
                    
                    const rides = snapshot.val();
                    if (!rides) return [];
                    
                    let ridesArray = Object.keys(rides).map(rideId => ({
                        id: rideId,
                        ...rides[rideId]
                    }));
                    
                    // Apply filters
                    if (filter !== 'all') {
                        if (filter === 'ride') {
                            ridesArray = ridesArray.filter(ride => 
                                !ride.emergencyDetails && 
                                !ride.expressDelivery && 
                                !ride.truckDelivery);
                        } else if (filter === 'delivery') {
                            ridesArray = ridesArray.filter(ride => 
                                ride.expressDelivery || ride.truckDelivery);
                        } else if (filter === 'emergency') {
                            ridesArray = ridesArray.filter(ride => ride.emergencyDetails);
                        } else {
                            ridesArray = ridesArray.filter(ride => ride.status === filter);
                        }
                    }
                    
                    // Sort by timestamp (newest first)
                    ridesArray.sort((a, b) => b.timestamp - a.timestamp);
                    
                    return ridesArray;
                } catch (error) {
                    console.error('Error getting user rides:', error);
                    throw error;
                }
            }

            async updateWalletBalance(uid, amount) {
                try {
                    await this.database.ref('users/' + uid).update({
                        walletBalance: amount
                    });
                    return true;
                } catch (error) {
                    console.error('Error updating wallet balance:', error);
                    throw error;
                }
            }

            setupWalletBalanceListener(uid, callback) {
                return this.database.ref('users/' + uid + '/walletBalance').on('value', (snapshot) => {
                    const newBalance = snapshot.val() || 0;
                    callback(newBalance);
                });
            }

            setupRideStatusListener(rideId, callback) {
                return this.database.ref('rides/' + rideId).on('value', (snapshot) => {
                    const ride = snapshot.val();
                    if (ride) {
                        callback(ride);
                    }
                });
            }

            removeListener(listener) {
                if (listener) {
                    listener();
                }
            }
        }

        // App Initialization
        class JubelApp {
            constructor() {
                this.mapManager = new MapManager();
                this.searchManager = new SearchManager();
                this.priceCalculator = new PriceCalculator();
                this.emergencyServiceManager = new EmergencyServiceManager();
                this.uiManager = new UIManager();
                this.firebaseManager = new FirebaseManager();
                this.initialize();
            }

            async initialize() {
                try {
                    // Check authentication
                    const urlParams = new URLSearchParams(window.location.search);
                    const email = urlParams.get('email');
                    const uid = urlParams.get('uid');
                    
                    if (email && uid) {
                        await this.loadUser(uid);
                    } else {
                        // Listen for auth state changes
                        this.auth = auth;
                        this.auth.onAuthStateChanged(async (user) => {
                            if (user) {
                                await this.loadUser(user.uid);
                            } else {
                                window.location.href = 'signup.html';
                            }
                        });
                    }
                    
                    // Initialize event listeners
                    this.setupEventListeners();
                    
                    // Initialize map
                    this.mapManager.initialize('map', [-15.4167, 28.2833], 13);
                    
                    console.log('Jubel App initialized successfully');
                } catch (error) {
                    console.error('App initialization error:', error);
                    this.uiManager.showNotification('Failed to initialize app. Please refresh.', 'error');
                }
            }

            async loadUser(uid) {
                try {
                    appState.currentUser = { uid };
                    appState.userData = await this.firebaseManager.getUserData(uid);
                    
                    if (!appState.userData) {
                        throw new Error('User data not found');
                    }
                    
                    // Update app state
                    appState.walletBalance = appState.userData.walletBalance || 0;
                    
                    // Update UI
                    this.uiManager.updateWalletBalance(appState.walletBalance);
                    this.uiManager.elements.accountName.textContent = appState.userData.name || 'Passenger';
                    this.uiManager.elements.accountPhone.textContent = appState.userData.phone || 'Not set';
                    this.uiManager.elements.accountEmail.textContent = appState.userData.email || 'Not set';
                    this.uiManager.elements.referralCode.textContent = appState.userData.referralCode || 'JUBEL-XXXX';
                    
                    // Setup wallet balance listener
                    appState.walletBalanceListener = this.firebaseManager.setupWalletBalanceListener(
                        uid,
                        (newBalance) => {
                            appState.walletBalance = newBalance;
                            this.uiManager.updateWalletBalance(newBalance);
                        }
                    );
                    
                    // Get current location
                    await this.getCurrentLocation();
                    
                    // Check for active ride
                    await this.checkActiveRide(uid);
                    
                    // Load scheduled rides
                    await this.loadScheduledRides(uid);
                    
                    this.uiManager.showNotification('Welcome back to Jubel!', 'success');
                } catch (error) {
                    console.error('Error loading user:', error);
                    this.uiManager.showNotification('Error loading user data. Please sign in again.', 'error');
                    setTimeout(() => {
                        window.location.href = 'signup.html';
                    }, 2000);
                }
            }

            async getCurrentLocation() {
                return new Promise((resolve, reject) => {
                    if (!navigator.geolocation) {
                        reject(new Error('Geolocation not supported'));
                        return;
                    }
                    
                    navigator.geolocation.getCurrentPosition(
                        async (position) => {
                            const lat = position.coords.latitude;
                            const lng = position.coords.longitude;
                            
                            appState.userLocation = { lat, lng };
                            
                            // Update map
                            this.mapManager.centerMap(lat, lng);
                            this.mapManager.addCurrentLocationMarker(lat, lng);
                            
                            // Get address
                            await this.updatePickupLocation(lat, lng);
                            
                            // Determine city
                            await this.determineCity(lat, lng);
                            
                            resolve({ lat, lng });
                        },
                        (error) => {
                            console.error('Geolocation error:', error);
                            this.uiManager.showNotification('Unable to get your location. Please enable location services.', 'error');
                            reject(error);
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 0
                        }
                    );
                });
            }

            async updatePickupLocation(lat, lng) {
                try {
                    const response = await fetch(
                        `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`
                    );
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data && data.address) {
                            const address = data.address;
                            const parts = [];
                            
                            if (address.house_number || address.housenumber) {
                                parts.push(address.house_number || address.housenumber);
                            } else if (address.building) {
                                parts.push(address.building);
                            }
                            
                            if (address.road) {
                                parts.push(address.road);
                            }
                            
                            if (address.suburb || address.neighbourhood) {
                                parts.push(address.suburb || address.neighbourhood);
                            }
                            
                            const formattedAddress = parts.join(', ') || 'Current Location';
                            this.uiManager.elements.pickupLocation.value = formattedAddress;
                        }
                    }
                } catch (error) {
                    console.error('Error getting address:', error);
                    this.uiManager.elements.pickupLocation.value = 'Current Location';
                }
            }

            async determineCity(lat, lng) {
                try {
                    const response = await fetch(
                        `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=10`
                    );
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data && data.address) {
                            const city = data.address.city || 
                                       data.address.town || 
                                       data.address.village || 
                                       'Lusaka';
                            appState.currentCity = city;
                        }
                    }
                } catch (error) {
                    console.error('Error determining city:', error);
                    appState.currentCity = 'Lusaka';
                }
            }

            async checkActiveRide(uid) {
                try {
                    const rides = await this.firebaseManager.getUserRides(uid);
                    const activeRide = rides.find(ride => 
                        ride.status !== 'completed' && 
                        ride.status !== 'cancelled' &&
                        ride.status !== 'paid'
                    );
                    
                    if (activeRide) {
                        appState.currentRide = activeRide;
                        this.uiManager.showRideInfo(activeRide);
                        
                        if (activeRide.emergencyDetails) {
                            this.uiManager.showEmergencyRideStatus();
                            appState.emergencyMode = true;
                        }
                        
                        // Setup ride status listener
                        appState.rideStatusListener = this.firebaseManager.setupRideStatusListener(
                            activeRide.id,
                            (ride) => this.handleRideStatusUpdate(ride)
                        );
                    }
                } catch (error) {
                    console.error('Error checking active ride:', error);
                }
            }

            async loadScheduledRides(uid) {
                // Implement scheduled rides loading
                // This would typically query a scheduledRides node in Firebase
            }

            setupEventListeners() {
                const ui = this.uiManager.elements;
                
                // Navigation
                ui.navButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const screen = btn.getAttribute('data-screen');
                        this.uiManager.switchScreen(screen);
                        
                        if (screen === 'history') {
                            this.loadHistory();
                        }
                    });
                });
                
                ui.backButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const screen = btn.getAttribute('data-screen');
                        this.uiManager.switchScreen(screen);
                    });
                });
                
                // Panel collapse
                ui.panelCollapseHandle.addEventListener('click', () => {
                    ui.passengerPanel.classList.toggle('collapsed');
                });
                
                // Vehicle selection
                ui.vehicleOptions.forEach(option => {
                    option.addEventListener('click', () => {
                        const type = option.getAttribute('data-type');
                        appState.selectedVehicleType = type;
                        this.uiManager.updateVehicleSelection(type);
                        this.calculateFare();
                    });
                });
                
                // Destination search
                const debouncedSearch = this.searchManager.debounceSearch(
                    async (query) => {
                        if (query.length < 2) {
                            this.uiManager.hideSearchSuggestions('destinationSuggestions');
                            return;
                        }
                        
                        const results = await this.searchManager.search(query, appState.currentCity);
                        
                        // Calculate distances
                        if (appState.userLocation) {
                            results.forEach(result => {
                                result.distance = this.priceCalculator.calculateDistance(
                                    appState.userLocation.lat,
                                    appState.userLocation.lng,
                                    result.lat,
                                    result.lon
                                );
                            });
                        }
                        
                        this.uiManager.showSearchSuggestions(results, 'destinationSuggestions');
                    },
                    200
                );
                
                ui.destinationLocation.addEventListener('input', (e) => {
                    debouncedSearch(e.target.value);
                });
                
                ui.destinationLocation.addEventListener('focus', () => {
                    const query = ui.destinationLocation.value;
                    if (query.length >= 2) {
                        debouncedSearch(query);
                    }
                });
                
                // Request ride
                ui.requestRideBtn.addEventListener('click', () => {
                    this.requestRide();
                });
                
                // Ride type selection
                ui.rideTypeOptions.forEach(option => {
                    option.addEventListener('click', () => {
                        ui.rideTypeOptions.forEach(opt => opt.classList.remove('selected'));
                        option.classList.add('selected');
                        appState.selectedRideType = option.getAttribute('data-type');
                    });
                });
                
                ui.selectRideTypeBtn.addEventListener('click', () => {
                    this.uiManager.hideModal('rideTypeModal');
                    this.uiManager.elements.vehicleSelection.classList.add('active');
                    this.uiManager.elements.requestRideBtn.classList.add('active');
                    this.uiManager.showNotification(`${appState.selectedRideType} ride selected`, 'success');
                });
                
                ui.closeRideTypeModal.addEventListener('click', () => {
                    this.uiManager.hideModal('rideTypeModal');
                });
                
                // Payment selection
                ui.paymentOptions.forEach(option => {
                    option.addEventListener('click', () => {
                        ui.paymentOptions.forEach(opt => opt.classList.remove('selected'));
                        option.classList.add('selected');
                        appState.selectedPaymentType = option.getAttribute('data-type');
                        
                        // Check wallet balance for wallet payment
                        if (appState.selectedPaymentType === 'wallet') {
                            if (appState.walletBalance < appState.rideFare) {
                                ui.insufficientBalance.style.display = 'block';
                                ui.confirmPaymentBtn.disabled = true;
                            } else {
                                ui.insufficientBalance.style.display = 'none';
                                ui.confirmPaymentBtn.disabled = false;
                            }
                        } else {
                            ui.insufficientBalance.style.display = 'none';
                            ui.confirmPaymentBtn.disabled = false;
                        }
                    });
                });
                
                ui.confirmPaymentBtn.addEventListener('click', async () => {
                    await this.confirmPayment();
                });
                
                ui.closePaymentModal.addEventListener('click', () => {
                    this.uiManager.hideModal('paymentModal');
                });
                
                // Cancel ride
                ui.cancelRideBtn.addEventListener('click', () => {
                    if (confirm('Are you sure you want to cancel this ride?')) {
                        this.cancelRide();
                    }
                });
                
                // Contact driver
                ui.contactDriverBtn.addEventListener('click', () => {
                    this.contactDriver();
                });
                
                // SOS button
                ui.sosButton.addEventListener('click', () => {
                    this.triggerSOS();
                });
                
                // Emergency ride selection
                ui.emergencyRideOptions.forEach(option => {
                    option.addEventListener('click', () => {
                        ui.emergencyRideOptions.forEach(opt => opt.classList.remove('selected'));
                        option.classList.add('selected');
                        appState.emergencyServiceType = option.getAttribute('data-type');
                    });
                });
                
                ui.requestEmergencyBtn.addEventListener('click', () => {
                    this.requestEmergencyRide();
                });
                
                // More options
                ui.moreOptionsBtn.addEventListener('click', () => {
                    this.uiManager.toggleMoreOptions();
                });
                
                ui.moreOptionItems.forEach(item => {
                    item.addEventListener('click', () => {
                        const option = item.getAttribute('data-option');
                        this.handleMoreOption(option);
                    });
                });
                
                // Promo code
                ui.promoToggle.addEventListener('click', () => {
                    this.uiManager.toggleMoreOptions();
                    this.uiManager.showPromoSection();
                });
                
                ui.applyPromoBtn.addEventListener('click', () => {
                    this.applyPromoCode();
                });
                
                // Account actions
                ui.depositBtn.addEventListener('click', () => {
                    this.depositToWallet();
                });
                
                ui.withdrawBtn.addEventListener('click', () => {
                    this.withdrawFromWallet();
                });
                
                ui.shareReferralBtn.addEventListener('click', () => {
                    this.shareReferralCode();
                });
                
                ui.whatsappBtn.addEventListener('click', () => {
                    this.contactWhatsApp();
                });
                
                ui.callBtn.addEventListener('click', () => {
                    this.contactPhone();
                });
                
                // History filter
                ui.historyFilter.addEventListener('change', () => {
                    this.loadHistory();
                });
                
                ui.historyDate.addEventListener('change', () => {
                    this.loadHistory();
                });
                
                // Close receipt modal
                ui.closeReceiptBtn.addEventListener('click', () => {
                    this.uiManager.hideModal('receiptModal');
                });
                
                ui.closeReceiptModal.addEventListener('click', () => {
                    this.uiManager.hideModal('receiptModal');
                });
                
                ui.downloadReceiptBtn.addEventListener('click', () => {
                    this.downloadReceipt();
                });
                
                // Saved locations
                ui.savedLocations.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const addressType = btn.getAttribute('data-address');
                        this.useSavedLocation(addressType);
                    });
                });
                
                // Click outside to close suggestions
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.location-input') && 
                        !e.target.closest('.suggestion-list')) {
                        this.uiManager.hideSearchSuggestions('destinationSuggestions');
                    }
                    
                    if (!e.target.closest('.more-options-btn') && 
                        !e.target.closest('.more-options-dropdown')) {
                        this.uiManager.elements.moreOptionsDropdown.classList.remove('active');
                    }
                });
                
                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    // Escape to close modals and suggestions
                    if (e.key === 'Escape') {
                        this.uiManager.hideModal('rideTypeModal');
                        this.uiManager.hideModal('paymentModal');
                        this.uiManager.hideModal('receiptModal');
                        this.uiManager.hideSearchSuggestions('destinationSuggestions');
                        this.uiManager.elements.moreOptionsDropdown.classList.remove('active');
                    }
                });
            }

            async calculateFare() {
                const destination = this.uiManager.elements.destinationLocation.value;
                if (!destination || !appState.userLocation) return;
                
                try {
                    // Search for destination
                    const results = await this.searchManager.search(destination, appState.currentCity, 1);
                    if (results.length === 0) return;
                    
                    const destinationResult = results[0];
                    
                    // Calculate distance
                    const distance = this.priceCalculator.calculateDistance(
                        appState.userLocation.lat,
                        appState.userLocation.lng,
                        destinationResult.lat,
                        destinationResult.lon
                    );
                    
                    // Calculate fare
                    const duration = this.priceCalculator.estimateDuration(distance);
                    const fare = this.priceCalculator.calculateFare(
                        appState.selectedVehicleType,
                        distance,
                        duration
                    );
                    
                    // Update UI
                    this.uiManager.updateFareDisplay(fare, duration);
                    appState.rideFare = fare;
                    
                    // Update map
                    this.mapManager.addDestinationMarker(destinationResult.lat, destinationResult.lon, destinationResult.display_name);
                    this.mapManager.drawRoute(
                        appState.userLocation.lat,
                        appState.userLocation.lng,
                        destinationResult.lat,
                        destinationResult.lon
                    );
                    
                } catch (error) {
                    console.error('Error calculating fare:', error);
                }
            }

            async requestRide() {
                const destination = this.uiManager.elements.destinationLocation.value;
                if (!destination) {
                    this.uiManager.showNotification('Please enter a destination', 'error');
                    return;
                }
                
                if (!appState.userLocation) {
                    this.uiManager.showNotification('Unable to determine your location', 'error');
                    return;
                }
                
                try {
                    // Search for destination
                    const results = await this.searchManager.search(destination, appState.currentCity, 1);
                    if (results.length === 0) {
                        this.uiManager.showNotification('Invalid destination address', 'error');
                        return;
                    }
                    
                    const destinationResult = results[0];
                    
                    // Create ride data
                    const rideData = {
                        passengerId: appState.currentUser.uid,
                        passengerName: appState.userData.name || 'Passenger',
                        passengerPhone: appState.userData.phone || 'Not provided',
                        pickupLocation: this.uiManager.elements.pickupLocation.value,
                        pickupDisplayLocation: this.uiManager.elements.pickupLocation.value,
                        destination: destinationResult.display_name,
                        pickupLat: appState.userLocation.lat,
                        pickupLng: appState.userLocation.lng,
                        destLat: destinationResult.lat,
                        destLng: destinationResult.lon,
                        rideType: appState.selectedVehicleType,
                        rideClass: appState.selectedRideType,
                        fare: appState.rideFare,
                        distance: `${(this.priceCalculator.calculateDistance(
                            appState.userLocation.lat,
                            appState.userLocation.lng,
                            destinationResult.lat,
                            destinationResult.lon
                        ) / 1000).toFixed(2)} km`,
                        status: 'requested',
                        promoCode: appState.appliedPromoCode,
                        paymentMethod: appState.selectedPaymentType,
                        currentCity: appState.currentCity,
                        timestamp: Date.now()
                    };
                    
                    // Show payment modal
                    this.uiManager.showPaymentModal(appState.rideFare);
                    appState.currentRideData = rideData;
                    
                } catch (error) {
                    console.error('Error requesting ride:', error);
                    this.uiManager.showNotification('Error requesting ride', 'error');
                }
            }

            async confirmPayment() {
                if (!appState.currentRideData) return;
                
                try {
                    // If paying with wallet, check balance
                    if (appState.selectedPaymentType === 'wallet') {
                        if (appState.walletBalance < appState.rideFare) {
                            this.uiManager.showNotification('Insufficient wallet balance', 'error');
                            return;
                        }
                        
                        // Deduct from wallet
                        const newBalance = appState.walletBalance - appState.rideFare;
                        await this.firebaseManager.updateWalletBalance(appState.currentUser.uid, newBalance);
                        appState.walletBalance = newBalance;
                        this.uiManager.updateWalletBalance(newBalance);
                    }
                    
                    // Create ride in Firebase
                    const { rideId, ride } = await this.firebaseManager.createRide(appState.currentRideData);
                    
                    // Update app state
                    appState.currentRide = ride;
                    
                    // Update UI
                    this.uiManager.hideModal('paymentModal');
                    this.uiManager.showRideInfo(ride);
                    this.uiManager.showSearchingAnimation();
                    this.uiManager.showNotification('Ride requested. Searching for driver...');
                    
                    // Setup ride status listener
                    appState.rideStatusListener = this.firebaseManager.setupRideStatusListener(
                        rideId,
                        (ride) => this.handleRideStatusUpdate(ride)
                    );
                    
                    // Show SOS button
                    this.uiManager.showSOSButton();
                    
                } catch (error) {
                    console.error('Error confirming payment:', error);
                    this.uiManager.showNotification('Error processing payment', 'error');
                }
            }

            async handleRideStatusUpdate(ride) {
                appState.currentRide = ride;
                
                switch (ride.status) {
                    case 'accepted':
                        this.uiManager.hideSearchingAnimation();
                        this.uiManager.showNotification('Driver found!', 'success');
                        
                        // Load driver details
                        if (ride.driverId) {
                            await this.loadDriverDetails(ride.driverId);
                        }
                        break;
                        
                    case 'arrived':
                        this.uiManager.showNotification('Driver has arrived', 'success');
                        break;
                        
                    case 'started':
                        this.uiManager.showNotification('Trip started', 'success');
                        break;
                        
                    case 'completed':
                        this.handleRideCompletion(ride);
                        break;
                        
                    case 'cancelled':
                        this.handleRideCancellation(ride);
                        break;
                }
            }

            async loadDriverDetails(driverId) {
                try {
                    const driverData = await this.firebaseManager.getUserData(driverId);
                    if (driverData) {
                        // Update UI with driver details
                        this.uiManager.elements.driverName.textContent = driverData.name || 'Driver';
                        this.uiManager.elements.driverPhone.textContent = driverData.phone || 'N/A';
                        this.uiManager.elements.driverRating.textContent = driverData.rating ? `${driverData.rating} ` : '4.5 ';
                        
                        if (driverData.vehicle) {
                            this.uiManager.elements.vehicleDetails.textContent = 
                                `${driverData.vehicle.type || 'Vehicle'} - ${driverData.vehicle.licensePlate || 'N/A'}`;
                        }
                        
                        // Setup driver location tracking
                        this.setupDriverLocationTracking(driverId);
                    }
                } catch (error) {
                    console.error('Error loading driver details:', error);
                }
            }

            setupDriverLocationTracking(driverId) {
                // Remove existing listener
                if (appState.driverLocationListener) {
                    this.firebaseManager.removeListener(appState.driverLocationListener);
                }
                
                // Setup new listener
                appState.driverLocationListener = this.firebaseManager.database.ref(`driverLocations/${driverId}`).on('value', (snapshot) => {
                    const location = snapshot.val();
                    if (location && appState.currentRide) {
                        // Update driver marker on map
                        this.mapManager.addDriverMarker(location.latitude, location.longitude, appState.emergencyMode);
                        
                        // Calculate and update ETA
                        if (appState.userLocation) {
                            const distance = this.priceCalculator.calculateDistance(
                                location.latitude,
                                location.longitude,
                                appState.userLocation.lat,
                                appState.userLocation.lng
                            );
                            const eta = this.priceCalculator.estimateDuration(distance);
                            // Update ETA display if needed
                        }
                    }
                });
            }

            handleRideCompletion(ride) {
                // Update UI
                this.uiManager.hideSearchingAnimation();
                this.uiManager.showNotification('Ride completed!', 'success');
                
                // Show receipt
                this.showReceipt(ride);
                
                // Reset UI
                this.resetAfterRide();
            }

            handleRideCancellation(ride) {
                this.uiManager.hideSearchingAnimation();
                this.uiManager.showNotification('Ride cancelled', 'error');
                this.resetAfterRide();
            }

            resetAfterRide() {
                // Clear current ride
                appState.currentRide = null;
                appState.emergencyMode = false;
                
                // Remove listeners
                if (appState.rideStatusListener) {
                    this.firebaseManager.removeListener(appState.rideStatusListener);
                    appState.rideStatusListener = null;
                }
                
                if (appState.driverLocationListener) {
                    this.firebaseManager.removeListener(appState.driverLocationListener);
                    appState.driverLocationListener = null;
                }
                
                // Reset UI
                this.uiManager.elements.rideRequestForm.style.display = 'flex';
                this.uiManager.elements.rideInfoPanel.style.display = 'none';
                this.uiManager.elements.destinationLocation.value = '';
                this.uiManager.elements.vehicleSelection.classList.remove('active');
                this.uiManager.elements.fareDisplay.classList.remove('active');
                this.uiManager.elements.requestRideBtn.classList.remove('active');
                this.uiManager.hideEmergencyRideStatus();
                this.uiManager.hideSOSButton();
                
                // Clear map
                this.mapManager.clearMarkers();
            }

            async cancelRide() {
                if (!appState.currentRide) return;
                
                try {
                    await this.firebaseManager.updateRide(appState.currentRide.id, {
                        status: 'cancelled',
                        cancelledAt: Date.now()
                    });
                    
                    this.uiManager.showNotification('Ride cancelled', 'success');
                    this.resetAfterRide();
                } catch (error) {
                    console.error('Error cancelling ride:', error);
                    this.uiManager.showNotification('Error cancelling ride', 'error');
                }
            }

            contactDriver() {
                if (!appState.currentRide || !appState.currentRide.driverPhone) {
                    this.uiManager.showNotification('Driver phone not available', 'error');
                    return;
                }
                
                window.open(`tel:${appState.currentRide.driverPhone}`, '_self');
            }

            async requestEmergencyRide() {
                if (!appState.emergencyServiceType) {
                    this.uiManager.showNotification('Please select an emergency service', 'error');
                    return;
                }
                
                if (!appState.userLocation) {
                    this.uiManager.showNotification('Unable to determine your location', 'error');
                    return;
                }
                
                try {
                    // Find nearest emergency service location
                    const nearestService = this.emergencyServiceManager.findNearestService(
                        appState.emergencyServiceType,
                        appState.userLocation.lat,
                        appState.userLocation.lng
                    );
                    
                    if (!nearestService) {
                        this.uiManager.showNotification('No emergency service available in your area', 'error');
                        return;
                    }
                    
                    // Get service info
                    const serviceInfo = this.emergencyServiceManager.getServiceInfo(appState.emergencyServiceType);
                    
                    // Create emergency ride data
                    const rideData = {
                        passengerId: appState.currentUser.uid,
                        passengerName: appState.userData.name || 'Passenger',
                        passengerPhone: appState.userData.phone || 'Not provided',
                        pickupLocation: nearestService.name,
                        pickupDisplayLocation: nearestService.name,
                        destination: 'Emergency Location',
                        pickupLat: nearestService.lat,
                        pickupLng: nearestService.lng,
                        destLat: appState.userLocation.lat,
                        destLng: appState.userLocation.lng,
                        rideType: appState.emergencyServiceType,
                        rideClass: 'emergency',
                        fare: nearestService.estimatedPrice,
                        distance: `${(nearestService.distance / 1000).toFixed(2)} km`,
                        status: 'requested',
                        paymentMethod: 'emergency',
                        emergencyDetails: {
                            type: appState.emergencyServiceType,
                            serviceName: serviceInfo.name,
                            estimatedArrival: Math.ceil(nearestService.distance / 833), // 50 km/h average
                            priority: 'high'
                        },
                        currentCity: appState.currentCity,
                        timestamp: Date.now()
                    };
                    
                    // Create ride in Firebase
                    const { rideId, ride } = await this.firebaseManager.createRide(rideData);
                    
                    // Update app state
                    appState.currentRide = ride;
                    appState.emergencyMode = true;
                    
                    // Update UI
                    this.uiManager.showRideInfo(ride);
                    this.uiManager.showSearchingAnimation();
                    this.uiManager.showEmergencyRideStatus();
                    this.uiManager.showSOSButton();
                    this.uiManager.showNotification('Emergency service requested!', 'success');
                    
                    // Update map
                    this.mapManager.addPickupMarker(nearestService.lat, nearestService.lng, nearestService.name);
                    this.mapManager.addDestinationMarker(appState.userLocation.lat, appState.userLocation.lng, 'Emergency Location');
                    this.mapManager.drawRoute(nearestService.lat, nearestService.lng, appState.userLocation.lat, appState.userLocation.lng);
                    
                    // Setup ride status listener
                    appState.rideStatusListener = this.firebaseManager.setupRideStatusListener(
                        rideId,
                        (ride) => this.handleRideStatusUpdate(ride)
                    );
                    
                } catch (error) {
                    console.error('Error requesting emergency ride:', error);
                    this.uiManager.showNotification('Error requesting emergency service', 'error');
                }
            }

            triggerSOS() {
                if (!appState.sosConfig) {
                    this.uiManager.showNotification('Please configure SOS contacts first', 'error');
                    return;
                }
                
                if (!appState.currentRide) {
                    this.uiManager.showNotification('No active ride to report SOS for', 'error');
                    return;
                }
                
                // Create SOS alert
                const sosAlert = {
                    passengerId: appState.currentUser.uid,
                    passengerName: appState.userData.name || 'Passenger',
                    passengerPhone: appState.userData.phone || 'Not provided',
                    emergencyContact1: appState.sosConfig.contact1,
                    emergencyContact2: appState.sosConfig.contact2,
                    message: appState.sosConfig.message || 'I need help!',
                    rideDetails: appState.currentRide,
                    timestamp: Date.now(),
                    location: appState.userLocation
                };
                
                // Send SOS alert (in a real app, this would send to server)
                console.log('SOS Alert:', sosAlert);
                this.uiManager.showNotification('SOS alert sent to emergency contacts!', 'success');
                
                // In a real implementation, you would:
                // 1. Send to Firebase
                // 2. Send SMS to emergency contacts
                // 3. Notify authorities if needed
            }

            async loadHistory() {
                if (!appState.currentUser) return;
                
                try {
                    const filter = this.uiManager.elements.historyFilter.value;
                    const dateFilter = this.uiManager.elements.historyDate.value;
                    
                    let rides = await this.firebaseManager.getUserRides(appState.currentUser.uid, filter);
                    
                    // Apply date filter if selected
                    if (dateFilter) {
                        const filterDate = new Date(dateFilter);
                        rides = rides.filter(ride => {
                            const rideDate = new Date(ride.timestamp);
                            return rideDate.toDateString() === filterDate.toDateString();
                        });
                    }
                    
                    this.uiManager.updateHistoryList(rides);
                } catch (error) {
                    console.error('Error loading history:', error);
                    this.uiManager.showNotification('Error loading ride history', 'error');
                }
            }

            showReceipt(ride) {
                const date = new Date(ride.timestamp);
                
                // Update receipt modal
                this.uiManager.elements.receiptTotal.textContent = `ZMW ${ride.fare ? ride.fare.toFixed(2) : '0.00'}`;
                this.uiManager.elements.receiptDate.textContent = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                this.uiManager.elements.receiptNumber.textContent = ride.id.substring(0, 8).toUpperCase();
                this.uiManager.elements.receiptPassenger.textContent = ride.passengerName || 'Passenger';
                this.uiManager.elements.receiptDriver.textContent = ride.driverName || 'Driver';
                this.uiManager.elements.receiptVehicle.textContent = ride.vehicleDetails || 'Vehicle';
                this.uiManager.elements.receiptPickup.textContent = ride.pickupDisplayLocation || ride.pickupLocation;
                this.uiManager.elements.receiptDestination.textContent = ride.destination;
                this.uiManager.elements.receiptDistance.textContent = ride.distance || '0 km';
                
                // Calculate fare breakdown
                const baseFare = 23;
                const distanceFare = ride.fare ? Math.max(0, ride.fare - baseFare) : 0;
                const discount = ride.promoCode ? ride.fare * 0.2 : 0;
                const total = ride.fare || 0;
                
                this.uiManager.elements.receiptBaseFare.textContent = `ZMW ${baseFare.toFixed(2)}`;
                this.uiManager.elements.receiptDistanceFare.textContent = `ZMW ${distanceFare.toFixed(2)}`;
                this.uiManager.elements.receiptDiscount.textContent = `-ZMW ${discount.toFixed(2)}`;
                this.uiManager.elements.receiptTotalAmount.textContent = `ZMW ${total.toFixed(2)}`;
                
                // Show modal
                this.uiManager.showModal('receiptModal');
            }

            downloadReceipt() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Add receipt content
                doc.setFontSize(20);
                doc.setTextColor(255, 107, 53);
                doc.text('JUBEL RIDE RECEIPT', 105, 20, { align: 'center' });
                
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.text(`Receipt No: ${this.uiManager.elements.receiptNumber.textContent}`, 20, 40);
                doc.text(`Date: ${this.uiManager.elements.receiptDate.textContent}`, 20, 45);
                
                // Add ride details
                doc.text(`Passenger: ${this.uiManager.elements.receiptPassenger.textContent}`, 20, 55);
                doc.text(`Driver: ${this.uiManager.elements.receiptDriver.textContent}`, 20, 60);
                doc.text(`Vehicle: ${this.uiManager.elements.receiptVehicle.textContent}`, 20, 65);
                
                doc.text(`Pickup: ${this.uiManager.elements.receiptPickup.textContent}`, 20, 75);
                doc.text(`Destination: ${this.uiManager.elements.receiptDestination.textContent}`, 20, 80);
                doc.text(`Distance: ${this.uiManager.elements.receiptDistance.textContent}`, 20, 85);
                
                // Add fare breakdown
                doc.text('Fare Breakdown:', 20, 95);
                doc.text(`Base Fare: ${this.uiManager.elements.receiptBaseFare.textContent}`, 30, 100);
                doc.text(`Distance Fare: ${this.uiManager.elements.receiptDistanceFare.textContent}`, 30, 105);
                doc.text(`Discount: ${this.uiManager.elements.receiptDiscount.textContent}`, 30, 110);
                
                // Add total
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text(`TOTAL: ${this.uiManager.elements.receiptTotalAmount.textContent}`, 20, 120);
                
                // Add footer
                doc.setFontSize(8);
                doc.setFont(undefined, 'normal');
                doc.text('Thank you for choosing Jubel!', 105, 140, { align: 'center' });
                doc.text('For any queries, contact: support@jubel.com', 105, 145, { align: 'center' });
                
                // Save PDF
                doc.save(`Jubel_Receipt_${this.uiManager.elements.receiptNumber.textContent}.pdf`);
                this.uiManager.showNotification('Receipt downloaded successfully!', 'success');
            }

            async depositToWallet() {
                const amount = prompt('Enter deposit amount (ZMW):');
                if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
                    this.uiManager.showNotification('Please enter a valid amount', 'error');
                    return;
                }
                
                const depositAmount = parseFloat(amount);
                const newBalance = appState.walletBalance + depositAmount;
                
                try {
                    await this.firebaseManager.updateWalletBalance(appState.currentUser.uid, newBalance);
                    appState.walletBalance = newBalance;
                    this.uiManager.updateWalletBalance(newBalance);
                    this.uiManager.showNotification(`Successfully deposited ZMW ${depositAmount.toFixed(2)}`, 'success');
                } catch (error) {
                    console.error('Error depositing to wallet:', error);
                    this.uiManager.showNotification('Error processing deposit', 'error');
                }
            }

            async withdrawFromWallet() {
                if (appState.walletBalance <= 0) {
                    this.uiManager.showNotification('Your wallet balance is zero', 'error');
                    return;
                }
                
                const amount = prompt(`Enter withdrawal amount (ZMW). Available: ZMW ${appState.walletBalance.toFixed(2)}:`);
                if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
                    this.uiManager.showNotification('Please enter a valid amount', 'error');
                    return;
                }
                
                const withdrawalAmount = parseFloat(amount);
                
                if (withdrawalAmount > appState.walletBalance) {
                    this.uiManager.showNotification('Insufficient balance', 'error');
                    return;
                }
                
                const newBalance = appState.walletBalance - withdrawalAmount;
                
                try {
                    await this.firebaseManager.updateWalletBalance(appState.currentUser.uid, newBalance);
                    appState.walletBalance = newBalance;
                    this.uiManager.updateWalletBalance(newBalance);
                    this.uiManager.showNotification(`Successfully withdrew ZMW ${withdrawalAmount.toFixed(2)}`, 'success');
                } catch (error) {
                    console.error('Error withdrawing from wallet:', error);
                    this.uiManager.showNotification('Error processing withdrawal', 'error');
                }
            }

            shareReferralCode() {
                const referralCode = this.uiManager.elements.referralCode.textContent;
                const shareText = `Join me on Jubel! Use my referral code ${referralCode} for 50% off your first ride. Download the app now!`;
                
                if (navigator.share) {
                    navigator.share({
                        title: 'Jubel Referral',
                        text: shareText,
                        url: window.location.href
                    }).then(() => {
                        this.uiManager.showNotification('Referral code shared successfully!', 'success');
                    }).catch(error => {
                        console.error('Error sharing:', error);
                        this.copyToClipboard(shareText);
                    });
                } else {
                    this.copyToClipboard(shareText);
                }
            }

            copyToClipboard(text) {
                navigator.clipboard.writeText(text).then(() => {
                    this.uiManager.showNotification('Referral code copied to clipboard!', 'success');
                }).catch(error => {
                    console.error('Error copying to clipboard:', error);
                    this.uiManager.showNotification('Error sharing referral code', 'error');
                });
            }

            contactWhatsApp() {
                const phoneNumber = '0768658484';
                const message = 'Hello, I need assistance with Jubel rides.';
                const url = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
                window.open(url, '_blank');
            }

            contactPhone() {
                const phoneNumber = '0768658484';
                window.open(`tel:${phoneNumber}`, '_self');
            }

            applyPromoCode() {
                const promoCode = this.uiManager.elements.promoCode.value.trim();
                if (!promoCode) {
                    this.uiManager.showNotification('Please enter a promo code', 'error');
                    return;
                }
                
                // Check if it's a referral code
                if (promoCode.startsWith('JUBEL-')) {
                    // Apply referral discount
                    appState.appliedPromoCode = promoCode;
                    this.uiManager.showNotification('Referral code applied! 50% discount', 'success');
                    
                    // Update fare calculation with discount
                    if (appState.rideFare > 0) {
                        const discountedFare = appState.rideFare * 0.5;
                        this.uiManager.updateFareDisplay(discountedFare, this.priceCalculator.estimateDuration(0));
                        appState.rideFare = discountedFare;
                    }
                } else {
                    this.uiManager.showNotification('Invalid promo code', 'error');
                }
            }

            useSavedLocation(addressType) {
                // In a real app, this would use saved addresses from user data
                const addresses = {
                    home: '123 Home Street, Lusaka',
                    work: '456 Work Avenue, Lusaka'
                };
                
                const address = addresses[addressType];
                if (address) {
                    this.uiManager.elements.destinationLocation.value = address;
                    this.calculateFare();
                }
            }

            handleMoreOption(option) {
                // Handle different more options
                switch (option) {
                    case 'order-for-someone':
                        this.uiManager.showNotification('Order for someone else feature coming soon!', 'info');
                        break;
                    case 'express-delivery':
                        this.uiManager.showNotification('Express delivery feature coming soon!', 'info');
                        break;
                    case 'light-truck-delivery':
                        this.uiManager.showNotification('Light truck delivery feature coming soon!', 'info');
                        break;
                    case 'schedule-ride':
                        this.uiManager.showNotification('Schedule ride feature coming soon!', 'info');
                        break;
                    case 'schedule-delivery':
                        this.uiManager.showNotification('Schedule delivery feature coming soon!', 'info');
                        break;
                }
                
                this.uiManager.elements.moreOptionsDropdown.classList.remove('active');
            }

            // Utility method to format currency
            formatCurrency(amount) {
                return `ZMW ${amount.toFixed(2)}`;
            }
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            window.jubelApp = new JubelApp();
        });

        // Export for debugging
        window.AppState = AppState;
        window.MapManager = MapManager;
        window.SearchManager = SearchManager;
        window.PriceCalculator = PriceCalculator;
        window.EmergencyServiceManager = EmergencyServiceManager;
        window.UIManager = UIManager;
        window.FirebaseManager = FirebaseManager;
        window.JubelApp = JubelApp;
    </script>
</body>
</html>
