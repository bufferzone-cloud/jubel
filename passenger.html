<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jubel - Passenger</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-orange: #FF6B35;
            --primary-red: #E74C3C;
            --primary-gradient: linear-gradient(135deg, #FF6B35, #E74C3C);
            --secondary-orange: #E55A28;
            --secondary-red: #C0392B;
            --light-orange: #FFF5F0;
            --light-red: #FCE8E6;
            --white: #FFFFFF;
            --off-white: #F9F9F9;
            --light-gray: #F5F5F5;
            --medium-gray: #E0E0E0;
            --dark-gray: #333333;
            --text-gray: #666666;
            --text-light: #888888;
            --success-green: #2ECC71;
            --warning-yellow: #F39C12;
            --info-blue: #3498DB;
            --error-red: #E74C3C;
            --border-color: #EEEEEE;
            --shadow-light: 0 1px 6px rgba(0, 0, 0, 0.08);
            --shadow-medium: 0 2px 12px rgba(0, 0, 0, 0.12);
            --shadow-heavy: 0 4px 20px rgba(0, 0, 0, 0.15);
            --app-padding: 12px;
            --element-radius: 12px;
            --button-radius: 20px;
            --card-radius: 16px;
            --transition-speed: 0.25s;
            --ambulance-blue: #2980B9;
            --fire-truck-red: #C0392B;
            --police-blue: #2C3E50;
            --premium-gold: #FFD700;
            --economy-green: #27AE60;
            --light-truck-brown: #8B4513;
            --delivery-purple: #8E44AD;
            --express-shop-green: #16A085;
            --broadcast-blue: #3498DB;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }
        
        body {
            background-color: var(--off-white);
            color: var(--dark-gray);
            max-width: 100%;
            overflow-x: hidden;
            height: 100vh;
            font-size: 13px;
            line-height: 1.4;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Map Container */
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 55%;
            z-index: 1;
            background: #f8f9fa;
        }
        
        /* Top Bar Components */
        .top-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 200;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px var(--app-padding);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            height: 56px;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .logo-img {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            object-fit: cover;
        }
        
        .logo-text {
            font-size: 16px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .user-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--dark-gray);
            margin-left: 4px;
        }
        
        .user-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .balance-badge {
            background: var(--white);
            padding: 6px 12px;
            border-radius: var(--button-radius);
            box-shadow: var(--shadow-light);
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 600;
            color: var(--dark-gray);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .balance-badge:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }
        
        .balance-amount {
            color: var(--primary-orange);
            font-weight: 700;
            font-size: 13px;
        }
        
        .notification-bell {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
            cursor: pointer;
            position: relative;
            transition: all var(--transition-speed) ease;
        }
        
        .notification-bell:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }
        
        .notification-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            width: 16px;
            height: 16px;
            background: var(--error-red);
            color: var(--white);
            border-radius: 50%;
            font-size: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            border: 2px solid var(--white);
        }
        
        /* Enhanced Notifications Panel */
        .notifications-panel {
            position: absolute;
            top: 60px;
            right: var(--app-padding);
            z-index: 1000;
            width: 350px;
            max-width: 90vw;
            background: var(--white);
            border-radius: var(--card-radius);
            box-shadow: var(--shadow-heavy);
            display: none;
            flex-direction: column;
            max-height: 500px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        
        .notifications-panel.active {
            display: flex;
            animation: slideDown 0.3s ease;
        }
        
        .notifications-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .notifications-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--dark-gray);
        }
        
        .mark-all-read {
            background: none;
            border: none;
            color: var(--primary-orange);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all var(--transition-speed) ease;
        }
        
        .mark-all-read:hover {
            background: var(--light-orange);
        }
        
        .notifications-list {
            flex: 1;
            overflow-y: auto;
            max-height: 400px;
        }
        
        .notification-item {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        
        .notification-item:hover {
            background: var(--off-white);
        }
        
        .notification-item.unread {
            background: var(--light-orange);
        }
        
        .notification-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--light-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-orange);
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .notification-content {
            flex: 1;
        }
        
        .notification-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
            margin-bottom: 4px;
        }
        
        .notification-message {
            font-size: 12px;
            color: var(--text-gray);
            line-height: 1.4;
            margin-bottom: 4px;
        }
        
        .notification-time {
            font-size: 10px;
            color: var(--text-light);
        }
        
        .notification-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        
        .notification-action-btn {
            padding: 4px 10px;
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            color: var(--primary-orange);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .notification-action-btn:hover {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .notifications-empty {
            padding: 40px 20px;
            text-align: center;
            color: var(--text-light);
        }
        
        /* Enhanced Search Results */
        .search-results-container {
            position: absolute;
            top: 56px;
            left: 0;
            right: 0;
            z-index: 500;
            background: var(--white);
            border-radius: 0 0 var(--card-radius) var(--card-radius);
            box-shadow: var(--shadow-heavy);
            max-height: 400px;
            overflow-y: auto;
            display: none;
            animation: fadeInDown 0.2s ease;
        }
        
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .search-results-container.active {
            display: block;
        }
        
        .search-result-item {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        
        .search-result-item:hover {
            background: var(--light-orange);
        }
        
        .search-result-item.selected {
            background: var(--light-orange);
            border-left: 3px solid var(--primary-orange);
        }
        
        .search-result-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--light-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-orange);
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .search-result-content {
            flex: 1;
        }
        
        .search-result-name {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
            margin-bottom: 2px;
        }
        
        .search-result-address {
            font-size: 12px;
            color: var(--text-gray);
            line-height: 1.3;
            margin-bottom: 4px;
        }
        
        .search-result-distance {
            font-size: 11px;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .search-loading {
            padding: 20px;
            text-align: center;
            color: var(--text-light);
        }
        
        /* Enhanced Location Input */
        .location-input {
            position: relative;
        }
        
        .location-input input {
            width: 100%;
            padding: 12px 40px 12px 36px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 13px;
            background: var(--white);
            transition: all var(--transition-speed) ease;
        }
        
        .location-input input:focus {
            outline: none;
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
        }
        
        .location-input i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary-orange);
            font-size: 14px;
        }
        
        .location-input .clear-input {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 14px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all var(--transition-speed) ease;
            display: none;
        }
        
        .location-input input:not(:placeholder-shown) + .clear-input {
            display: block;
        }
        
        .clear-input:hover {
            color: var(--error-red);
            background: var(--light-red);
        }
        
        /* Ride Status Bar */
        .ride-status-bar {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 150;
            display: none;
            background: var(--white);
            padding: 8px 16px;
            border-radius: var(--button-radius);
            box-shadow: var(--shadow-heavy);
            border: 1px solid var(--border-color);
            align-items: center;
            gap: 10px;
            min-width: 280px;
            max-width: 90%;
        }
        
        .ride-status-bar.active {
            display: flex;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                transform: translateX(-50%) translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--warning-yellow);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.1); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        .status-dot.searching { background: var(--warning-yellow); }
        .status-dot.arriving { background: var(--info-blue); }
        .status-dot.riding { background: var(--success-green); animation: none; }
        
        .status-text {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
        }
        
        .status-eta {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--text-gray);
            font-size: 12px;
            font-weight: 500;
        }
        
        /* Emergency Status */
        .emergency-status {
            position: absolute;
            top: 60px;
            right: var(--app-padding);
            z-index: 150;
            background: linear-gradient(135deg, var(--error-red), #C0392B);
            color: var(--white);
            padding: 8px 14px;
            border-radius: var(--button-radius);
            box-shadow: var(--shadow-heavy);
            display: none;
            align-items: center;
            gap: 6px;
            font-weight: 700;
            font-size: 12px;
            animation: emergencyPulse 1s infinite;
        }
        
        @keyframes emergencyPulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
            70% { transform: scale(1.02); box-shadow: 0 0 0 8px rgba(231, 76, 60, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
        }
        
        /* SOS Button */
        .sos-button {
            position: absolute;
            bottom: 160px;
            right: var(--app-padding);
            z-index: 150;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--error-red), #C0392B);
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 14px;
            font-weight: 700;
            box-shadow: var(--shadow-heavy);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            animation: sosPulse 2s infinite;
        }
        
        @keyframes sosPulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 15px rgba(231, 76, 60, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
        }
        
        .sos-button:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(231, 76, 60, 0.4);
            animation: none;
        }
        
        /* Main Panel */
        .main-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            border-radius: var(--card-radius) var(--card-radius) 0 0;
            box-shadow: 0 -4px 30px rgba(0, 0, 0, 0.1);
            z-index: 100;
            padding: var(--app-padding);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 45vh;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-orange) var(--light-gray);
        }
        
        .main-panel::-webkit-scrollbar {
            width: 4px;
        }
        
        .main-panel::-webkit-scrollbar-track {
            background: var(--light-gray);
            border-radius: 2px;
        }
        
        .main-panel::-webkit-scrollbar-thumb {
            background: var(--primary-orange);
            border-radius: 2px;
        }
        
        .main-panel.collapsed {
            transform: translateY(calc(100% - 48px));
        }
        
        .panel-handle {
            width: 36px;
            height: 3px;
            background: var(--medium-gray);
            border-radius: 2px;
            margin: 0 auto 12px;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .panel-handle:hover {
            background: var(--primary-orange);
            width: 48px;
        }
        
        /* Navigation Tabs */
        .nav-tabs {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            margin-bottom: 12px;
            padding: 4px;
            background: var(--light-gray);
            border-radius: var(--button-radius);
        }
        
        .nav-tab {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 10px 6px;
            border-radius: calc(var(--button-radius) - 4px);
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            color: var(--text-gray);
            font-size: 11px;
            font-weight: 600;
        }
        
        .nav-tab i {
            font-size: 16px;
            transition: all var(--transition-speed) ease;
        }
        
        .nav-tab.active {
            background: var(--white);
            color: var(--primary-orange);
            box-shadow: var(--shadow-light);
        }
        
        .nav-tab.active i {
            color: var(--primary-orange);
            transform: translateY(-2px);
        }
        
        .nav-tab:hover:not(.active) {
            background: rgba(255, 107, 53, 0.1);
            color: var(--primary-orange);
        }
        
        /* Quick Actions - Updated for dropdown */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 16px;
            position: relative;
        }
        
        .quick-action-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            text-align: left;
            position: relative;
        }
        
        .quick-action-btn.has-dropdown::after {
            content: 'â–¼';
            font-size: 10px;
            margin-left: auto;
            color: var(--text-light);
            transition: transform var(--transition-speed) ease;
        }
        
        .quick-action-btn.dropdown-open::after {
            transform: rotate(180deg);
        }
        
        .quick-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
            border-color: var(--primary-orange);
        }
        
        .quick-action-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: var(--light-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-orange);
            font-size: 16px;
        }
        
        .quick-action-text {
            flex: 1;
        }
        
        .quick-action-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
            margin-bottom: 2px;
        }
        
        .quick-action-desc {
            font-size: 11px;
            color: var(--text-light);
        }
        
        /* Dropdown for More Options */
        .quick-actions-dropdown {
            position: absolute;
            bottom: calc(100% + 8px);
            left: 0;
            right: 0;
            background: var(--white);
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            border: 1px solid var(--border-color);
            z-index: 1000;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        
        .quick-actions-dropdown.active {
            display: flex;
            animation: fadeInUp 0.2s ease;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .dropdown-item {
            padding: 14px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            border-bottom: 1px solid var(--border-color);
        }
        
        .dropdown-item:last-child {
            border-bottom: none;
        }
        
        .dropdown-item:hover {
            background: var(--light-orange);
        }
        
        .dropdown-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--light-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-orange);
            font-size: 14px;
        }
        
        .dropdown-text {
            flex: 1;
        }
        
        .dropdown-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
            margin-bottom: 2px;
        }
        
        .dropdown-desc {
            font-size: 11px;
            color: var(--text-light);
        }
        
        /* Ride Type Selection Tabs */
        .service-tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 16px;
            overflow-x: auto;
            padding-bottom: 4px;
        }
        
        .service-tab {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 12px 16px;
            background: var(--white);
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            min-width: 100px;
            text-align: center;
        }
        
        .service-tab:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .service-tab.active {
            border-color: var(--primary-orange);
            background: var(--light-orange);
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
        }
        
        .service-tab.car.active { border-color: var(--primary-orange); }
        .service-tab.delivery.active { border-color: var(--delivery-purple); background: #F4E6FA; }
        .service-tab.short-delivery.active { border-color: var(--express-shop-green); background: #E1F5FE; }
        
        .service-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--text-gray);
            transition: all var(--transition-speed) ease;
        }
        
        .service-tab.active .service-icon {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .service-tab.delivery.active .service-icon {
            background: var(--delivery-purple);
        }
        
        .service-tab.short-delivery.active .service-icon {
            background: var(--express-shop-green);
        }
        
        .service-name {
            font-weight: 600;
            font-size: 12px;
            color: var(--dark-gray);
        }
        
        .service-desc {
            font-size: 10px;
            color: var(--text-light);
            margin-top: 2px;
        }
        
        /* Ride Request Form */
        .ride-request-form {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }
        
        .form-title {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--dark-gray);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .location-inputs {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .location-input-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: var(--off-white);
            border: 2px solid transparent;
            border-radius: var(--element-radius);
            transition: all var(--transition-speed) ease;
            position: relative;
        }
        
        .location-input-wrapper.active {
            border-color: var(--primary-orange);
            background: var(--white);
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
        }
        
        .location-input-wrapper i {
            color: var(--primary-orange);
            font-size: 14px;
            width: 18px;
            text-align: center;
        }
        
        .location-input-wrapper input {
            flex: 1;
            border: none;
            background: transparent;
            outline: none;
            font-size: 13px;
            color: var(--dark-gray);
            font-weight: 500;
        }
        
        .location-input-wrapper input::placeholder {
            color: var(--text-light);
        }
        
        .search-loading-indicator {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 14px;
            height: 14px;
            border: 2px solid var(--light-gray);
            border-radius: 50%;
            border-top-color: var(--primary-orange);
            animation: spin 0.6s linear infinite;
            display: none;
        }
        
        .location-input-wrapper.searching .search-loading-indicator {
            display: block;
        }
        
        /* Enhanced Ride Type Selection */
        .ride-type-selection {
            margin: 16px 0;
            display: none;
        }
        
        .ride-type-selection.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        .ride-type-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--dark-gray);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .ride-type-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        
        .ride-type-card {
            background: var(--white);
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            padding: 14px 10px;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .ride-type-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .ride-type-card.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
        }
        
        .ride-type-card.economy.selected {
            border-color: var(--economy-green);
            background: #E8F6EF;
        }
        
        .ride-type-card.premium.selected {
            border-color: var(--premium-gold);
            background: #FFF9E6;
        }
        
        .ride-type-icon {
            width: 42px;
            height: 42px;
            border-radius: 10px;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 8px;
            font-size: 18px;
            color: var(--text-gray);
            transition: all var(--transition-speed) ease;
        }
        
        .ride-type-card.selected .ride-type-icon {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .ride-type-card.economy.selected .ride-type-icon {
            background: var(--economy-green);
        }
        
        .ride-type-card.premium.selected .ride-type-icon {
            background: var(--premium-gold);
            color: var(--dark-gray);
        }
        
        .ride-type-name {
            font-weight: 600;
            font-size: 12px;
            color: var(--dark-gray);
            margin-bottom: 2px;
        }
        
        .ride-type-price {
            font-size: 14px;
            font-weight: 700;
            color: var(--primary-orange);
            margin-bottom: 2px;
        }
        
        .ride-type-card.economy .ride-type-price {
            color: var(--economy-green);
        }
        
        .ride-type-card.premium .ride-type-price {
            color: #B8860B;
        }
        
        .ride-type-eta {
            font-size: 10px;
            color: var(--text-light);
        }
        
        /* Enhanced Fare Display */
        .fare-display {
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            padding: 16px;
            border-radius: var(--element-radius);
            margin: 16px 0;
            text-align: center;
            box-shadow: var(--shadow-medium);
            display: none;
        }
        
        .fare-display.active {
            display: block;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fare-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 2px;
        }
        
        .fare-amount {
            font-size: 26px;
            font-weight: 800;
            margin: 6px 0;
        }
        
        .fare-details {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 11px;
            opacity: 0.9;
        }
        
        /* Enhanced Action Buttons */
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-top: 16px;
        }
        
        .btn {
            padding: 14px;
            border: none;
            border-radius: var(--button-radius);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            box-shadow: 0 3px 12px rgba(255, 107, 53, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 16px rgba(255, 107, 53, 0.4);
        }
        
        .btn-secondary {
            background: var(--white);
            color: var(--primary-orange);
            border: 2px solid var(--primary-orange);
        }
        
        .btn-secondary:hover {
            background: var(--light-orange);
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--error-red), #C0392B);
            color: var(--white);
            box-shadow: 0 3px 12px rgba(231, 76, 60, 0.3);
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 16px rgba(231, 76, 60, 0.4);
        }
        
        .btn-broadcast {
            background: linear-gradient(135deg, var(--broadcast-blue), #2980B9);
            color: var(--white);
            box-shadow: 0 3px 12px rgba(52, 152, 219, 0.3);
        }
        
        .btn-broadcast:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 16px rgba(52, 152, 219, 0.4);
        }
        
        /* Enhanced Ride Info Panel */
        .ride-info-panel {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-medium);
            border: 1px solid var(--border-color);
            display: none;
        }
        
        .ride-info-panel.active {
            display: block;
            animation: fadeInUp 0.3s ease;
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Enhanced Driver Info with Images */
        .driver-info {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .driver-avatar {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--white);
            font-weight: 700;
            overflow: hidden;
            border: 2px solid var(--white);
            box-shadow: var(--shadow-light);
        }
        
        .driver-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .driver-details {
            flex: 1;
        }
        
        .driver-name {
            font-size: 14px;
            font-weight: 700;
            color: var(--dark-gray);
            margin-bottom: 2px;
        }
        
        .driver-rating {
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--warning-yellow);
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 12px;
        }
        
        .driver-vehicle {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }
        
        .vehicle-image {
            width: 60px;
            height: 40px;
            border-radius: 6px;
            overflow: hidden;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .vehicle-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .vehicle-details {
            flex: 1;
        }
        
        .vehicle-model {
            font-size: 13px;
            font-weight: 600;
            color: var(--dark-gray);
            margin-bottom: 2px;
        }
        
        .vehicle-plate {
            font-size: 12px;
            color: var(--text-gray);
            background: var(--light-gray);
            padding: 2px 6px;
            border-radius: 4px;
            display: inline-block;
        }
        
        .trip-details {
            margin-bottom: 16px;
        }
        
        .trip-locations {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .location-point {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        .location-marker {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            color: var(--white);
            font-size: 11px;
        }
        
        .location-marker.pickup {
            background: var(--primary-orange);
        }
        
        .location-marker.destination {
            background: var(--primary-red);
        }
        
        .location-text {
            flex: 1;
        }
        
        .location-label {
            font-size: 11px;
            color: var(--text-light);
            margin-bottom: 2px;
            font-weight: 600;
        }
        
        .location-address {
            font-size: 13px;
            color: var(--dark-gray);
            font-weight: 500;
            line-height: 1.3;
        }
        
        .fare-breakdown {
            background: var(--off-white);
            border-radius: var(--element-radius);
            padding: 14px;
            margin-bottom: 16px;
        }
        
        .fare-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .fare-row:last-child {
            border-bottom: none;
        }
        
        .fare-label {
            font-size: 13px;
            color: var(--text-gray);
        }
        
        .fare-value {
            font-size: 13px;
            font-weight: 600;
            color: var(--dark-gray);
        }
        
        .fare-row.total {
            margin-top: 6px;
            padding-top: 10px;
            border-top: 2px solid var(--border-color);
        }
        
        .fare-row.total .fare-label {
            font-size: 14px;
            font-weight: 700;
            color: var(--dark-gray);
        }
        
        .fare-row.total .fare-value {
            font-size: 18px;
            font-weight: 800;
            color: var(--primary-orange);
        }
        
        /* Enhanced Chat System */
        .chat-container {
            position: absolute;
            bottom: 200px;
            right: var(--app-padding);
            z-index: 300;
            width: 380px;
            max-width: calc(100vw - 40px);
            background: var(--white);
            border-radius: var(--card-radius);
            box-shadow: var(--shadow-heavy);
            display: none;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        
        .chat-container.active {
            display: flex;
            animation: chatSlideUp 0.3s ease;
        }
        
        @keyframes chatSlideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .chat-header {
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            padding: 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .chat-title {
            font-weight: 600;
            font-size: 13px;
        }
        
        .chat-close {
            background: none;
            border: none;
            color: var(--white);
            font-size: 16px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all var(--transition-speed) ease;
        }
        
        .chat-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .chat-messages {
            flex: 1;
            padding: 14px;
            max-height: 300px;
            overflow-y: auto;
            background: var(--off-white);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .message {
            max-width: 80%;
            padding: 10px 14px;
            border-radius: 16px;
            font-size: 13px;
            line-height: 1.3;
            position: relative;
        }
        
        .message.sent {
            align-self: flex-end;
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            border-bottom-right-radius: 4px;
        }
        
        .message.received {
            align-self: flex-start;
            background: var(--white);
            color: var(--dark-gray);
            border: 1px solid var(--border-color);
            border-bottom-left-radius: 4px;
        }
        
        .message-sender {
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 2px;
            opacity: 0.8;
        }
        
        .message-time {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 4px;
            text-align: right;
        }
        
        .message.received .message-time {
            color: var(--text-gray);
        }
        
        .chat-input-container {
            padding: 14px;
            background: var(--white);
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .chat-input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid var(--border-color);
            border-radius: var(--button-radius);
            font-size: 13px;
            outline: none;
            transition: all var(--transition-speed) ease;
        }
        
        .chat-input:focus {
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
        }
        
        .chat-send-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-speed) ease;
        }
        
        .chat-send-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 3px 10px rgba(255, 107, 53, 0.3);
        }
        
        .chat-attachment-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--light-orange);
            color: var(--primary-orange);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-speed) ease;
        }
        
        .chat-attachment-btn:hover {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .chat-notification {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 18px;
            height: 18px;
            background: var(--error-red);
            color: var(--white);
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            animation: bounce 1s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        
        /* Enhanced Modal System */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
            backdrop-filter: blur(4px);
        }
        
        .modal-overlay.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        
        .modal {
            background: var(--white);
            border-radius: var(--card-radius);
            box-shadow: var(--shadow-heavy);
            max-width: 450px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            animation: modalSlideUp 0.3s ease;
        }
        
        @keyframes modalSlideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--dark-gray);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--text-light);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all var(--transition-speed) ease;
        }
        
        .modal-close:hover {
            color: var(--error-red);
            background: var(--light-red);
        }
        
        .modal-content {
            padding: 20px;
        }
        
        /* Enhanced Emergency Modal with Reasons */
        .emergency-reasons {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-bottom: 16px;
        }
        
        .emergency-reason {
            padding: 14px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .emergency-reason:hover {
            border-color: var(--error-red);
            background: var(--light-red);
        }
        
        .emergency-reason.selected {
            border-color: var(--error-red);
            background: var(--light-red);
        }
        
        .emergency-reason-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--light-red);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--error-red);
            font-size: 14px;
        }
        
        .emergency-reason.selected .emergency-reason-icon {
            background: var(--error-red);
            color: var(--white);
        }
        
        .emergency-reason-text {
            flex: 1;
            font-weight: 500;
            color: var(--dark-gray);
        }
        
        /* Enhanced Emergency Service Selection */
        .emergency-services-list {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin: 16px 0;
        }
        
        .emergency-service-item {
            padding: 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            gap: 14px;
        }
        
        .emergency-service-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .emergency-service-item.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .emergency-service-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-gray);
            font-size: 18px;
        }
        
        .emergency-service-item.police .emergency-service-icon {
            background: var(--police-blue);
            color: var(--white);
        }
        
        .emergency-service-item.fire .emergency-service-icon {
            background: var(--fire-truck-red);
            color: var(--white);
        }
        
        .emergency-service-item.medical .emergency-service-icon {
            background: var(--ambulance-blue);
            color: var(--white);
        }
        
        .emergency-service-details {
            flex: 1;
        }
        
        .emergency-service-name {
            font-weight: 600;
            font-size: 14px;
            color: var(--dark-gray);
            margin-bottom: 2px;
        }
        
        .emergency-service-address {
            font-size: 12px;
            color: var(--text-gray);
            margin-bottom: 4px;
        }
        
        .emergency-service-distance {
            font-size: 11px;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        /* Enhanced Broadcast Modal */
        .broadcast-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .broadcast-recipients {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .recipient-input {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .recipient-input input {
            flex: 1;
            padding: 10px 14px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 13px;
            transition: all var(--transition-speed) ease;
        }
        
        .recipient-input input:focus {
            outline: none;
            border-color: var(--primary-orange);
        }
        
        .add-recipient-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--light-orange);
            border: 2px solid var(--primary-orange);
            color: var(--primary-orange);
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-speed) ease;
        }
        
        .add-recipient-btn:hover {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .broadcast-preview {
            background: var(--off-white);
            border-radius: var(--element-radius);
            padding: 16px;
            margin-top: 8px;
        }
        
        .preview-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--dark-gray);
            margin-bottom: 8px;
        }
        
        .preview-details {
            font-size: 12px;
            color: var(--text-gray);
            line-height: 1.4;
        }
        
        /* History Screen */
        .history-screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--white);
            z-index: 200;
            display: none;
            flex-direction: column;
            padding-top: 56px;
        }
        
        .history-screen.active {
            display: flex;
            animation: slideInRight 0.3s ease;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        .screen-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: var(--white);
            padding: 14px var(--app-padding);
            border-bottom: 1px solid var(--border-color);
            z-index: 10;
            display: flex;
            align-items: center;
            gap: 14px;
        }
        
        .back-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--dark-gray);
            border: none;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .back-btn:hover {
            background: var(--medium-gray);
            transform: translateX(-2px);
        }
        
        .screen-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--dark-gray);
        }
        
        .history-filters {
            padding: 14px var(--app-padding);
            background: var(--off-white);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 8px;
            overflow-x: auto;
            scrollbar-width: none;
        }
        
        .history-filters::-webkit-scrollbar {
            display: none;
        }
        
        .filter-btn {
            padding: 6px 14px;
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--button-radius);
            font-size: 12px;
            font-weight: 600;
            color: var(--text-gray);
            cursor: pointer;
            white-space: nowrap;
            transition: all var(--transition-speed) ease;
        }
        
        .filter-btn.active {
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            border-color: transparent;
        }
        
        .filter-btn:hover:not(.active) {
            border-color: var(--primary-orange);
            color: var(--primary-orange);
        }
        
        .history-list {
            flex: 1;
            overflow-y: auto;
            padding: 14px var(--app-padding);
        }
        
        .history-item {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 16px;
            margin-bottom: 10px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .history-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
            border-color: var(--primary-orange);
        }
        
        .history-item.expanded {
            margin-bottom: 16px;
        }
        
        .history-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .history-type {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .history-icon {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            background: var(--light-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-orange);
        }
        
        .history-type-name {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
        }
        
        .history-date {
            font-size: 12px;
            color: var(--text-light);
        }
        
        .history-status {
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-completed {
            background: #E8F6EF;
            color: var(--economy-green);
        }
        
        .status-cancelled {
            background: var(--light-red);
            color: var(--error-red);
        }
        
        .status-ongoing {
            background: #E3F2FD;
            color: var(--info-blue);
        }
        
        .history-locations {
            margin-bottom: 10px;
        }
        
        .history-location {
            display: flex;
            align-items: flex-start;
            gap: 6px;
            margin-bottom: 6px;
        }
        
        .history-location i {
            color: var(--text-light);
            margin-top: 2px;
        }
        
        .history-location-text {
            font-size: 12px;
            color: var(--text-gray);
            line-height: 1.3;
        }
        
        .history-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
        }
        
        .history-price {
            font-size: 14px;
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        .history-driver {
            font-size: 12px;
            color: var(--text-gray);
        }
        
        .history-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .history-item.expanded .history-details {
            max-height: 400px;
            margin-top: 14px;
            padding-top: 14px;
            border-top: 1px solid var(--border-color);
        }
        
        .detail-section {
            margin-bottom: 14px;
        }
        
        .detail-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--dark-gray);
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .detail-label {
            font-size: 11px;
            color: var(--text-light);
            font-weight: 500;
        }
        
        .detail-value {
            font-size: 13px;
            color: var(--dark-gray);
            font-weight: 500;
        }
        
        /* Account Screen */
        .account-screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--white);
            z-index: 200;
            display: none;
            flex-direction: column;
            padding-top: 56px;
        }
        
        .account-screen.active {
            display: flex;
        }
        
        .account-header {
            padding: 20px var(--app-padding);
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            text-align: center;
        }
        
        .account-avatar {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            margin: 0 auto 14px;
            border: 3px solid rgba(255, 255, 255, 0.3);
        }
        
        .account-name {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 2px;
        }
        
        .account-phone {
            font-size: 13px;
            opacity: 0.9;
        }
        
        .account-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            padding: 16px var(--app-padding);
            background: var(--white);
        }
        
        .stat-card {
            background: var(--off-white);
            border-radius: var(--element-radius);
            padding: 14px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary-orange);
            margin-bottom: 2px;
        }
        
        .stat-label {
            font-size: 11px;
            color: var(--text-gray);
            font-weight: 500;
        }
        
        .account-section {
            padding: 16px var(--app-padding);
            border-bottom: 1px solid var(--border-color);
        }
        
        .section-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--dark-gray);
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .wallet-balance {
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            padding: 20px;
            border-radius: var(--element-radius);
            text-align: center;
            margin-bottom: 16px;
        }
        
        .balance-label {
            font-size: 13px;
            opacity: 0.9;
            margin-bottom: 6px;
        }
        
        .balance-amount-large {
            font-size: 30px;
            font-weight: 800;
            margin-bottom: 2px;
        }
        
        .wallet-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 14px;
        }
        
        .btn-wallet {
            padding: 10px;
            border: 2px solid var(--primary-orange);
            background: var(--white);
            color: var(--primary-orange);
            border-radius: var(--button-radius);
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .btn-wallet:hover {
            background: var(--primary-orange);
            color: var(--white);
            transform: translateY(-2px);
        }
        
        .referral-card {
            background: var(--light-orange);
            border-radius: var(--element-radius);
            padding: 16px;
            text-align: center;
            margin-top: 14px;
        }
        
        .referral-code {
            background: var(--white);
            padding: 14px;
            border-radius: var(--element-radius);
            margin: 14px 0;
            font-family: monospace;
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-orange);
            letter-spacing: 2px;
        }
        
        .referral-note {
            font-size: 11px;
            color: var(--text-gray);
            margin-top: 6px;
        }
        
        /* Emergency Screen */
        .emergency-screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--white);
            z-index: 200;
            display: none;
            flex-direction: column;
            padding-top: 56px;
        }
        
        .emergency-screen.active {
            display: flex;
        }
        
        .emergency-services {
            padding: 16px var(--app-padding);
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .emergency-service {
            background: var(--white);
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .emergency-service:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-medium);
        }
        
        .emergency-service.police {
            border-color: var(--police-blue);
        }
        
        .emergency-service.police:hover {
            border-color: var(--police-blue);
            box-shadow: 0 6px 20px rgba(44, 62, 80, 0.2);
        }
        
        .emergency-service.fire {
            border-color: var(--fire-truck-red);
        }
        
        .emergency-service.fire:hover {
            border-color: var(--fire-truck-red);
            box-shadow: 0 6px 20px rgba(192, 57, 43, 0.2);
        }
        
        .emergency-service.medical {
            border-color: var(--ambulance-blue);
        }
        
        .emergency-service.medical:hover {
            border-color: var(--ambulance-blue);
            box-shadow: 0 6px 20px rgba(41, 128, 185, 0.2);
        }
        
        .emergency-icon {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin: 0 auto 10px;
            color: var(--white);
        }
        
        .emergency-service.police .emergency-icon {
            background: var(--police-blue);
        }
        
        .emergency-service.fire .emergency-icon {
            background: var(--fire-truck-red);
        }
        
        .emergency-service.medical .emergency-icon {
            background: var(--ambulance-blue);
        }
        
        .emergency-name {
            font-size: 14px;
            font-weight: 700;
            color: var(--dark-gray);
            margin-bottom: 6px;
        }
        
        .emergency-description {
            font-size: 12px;
            color: var(--text-gray);
            line-height: 1.3;
        }
        
        .emergency-note {
            padding: 16px var(--app-padding);
            background: var(--light-red);
            margin: 16px var(--app-padding);
            border-radius: var(--element-radius);
            border-left: 3px solid var(--error-red);
        }
        
        .emergency-note p {
            font-size: 12px;
            color: var(--dark-gray);
            line-height: 1.4;
        }
        
        /* Loading States */
        .loading {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid var(--light-gray);
            border-radius: 50%;
            border-top-color: var(--primary-orange);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            z-index: 10000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
        }
        
        .loading-overlay.active {
            display: flex;
        }
        
        .loading-spinner {
            width: 52px;
            height: 52px;
            border: 4px solid var(--light-gray);
            border-radius: 50%;
            border-top-color: var(--primary-orange);
            animation: spin 1s linear infinite;
        }
        
        .loading-text {
            font-size: 14px;
            font-weight: 600;
            color: var(--dark-gray);
        }
        
        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 90px;
            right: var(--app-padding);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-width: 350px;
        }
        
        .toast {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 14px;
            box-shadow: var(--shadow-heavy);
            border-left: 3px solid var(--primary-orange);
            display: flex;
            align-items: flex-start;
            gap: 10px;
            animation: slideInRight 0.3s ease;
            transform: translateX(0);
            transition: transform 0.3s ease;
        }
        
        .toast.hiding {
            transform: translateX(100%);
        }
        
        .toast-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--light-orange);
            color: var(--primary-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
            margin-bottom: 2px;
        }
        
        .toast-message {
            font-size: 12px;
            color: var(--text-gray);
            line-height: 1.3;
        }
        
        .toast-close {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 16px;
            cursor: pointer;
            padding: 2px;
            border-radius: 4px;
            transition: all var(--transition-speed) ease;
        }
        
        .toast-close:hover {
            color: var(--error-red);
            background: var(--light-red);
        }
        
        .toast.success {
            border-left-color: var(--success-green);
        }
        
        .toast.success .toast-icon {
            background: #E8F6EF;
            color: var(--success-green);
        }
        
        .toast.error {
            border-left-color: var(--error-red);
        }
        
        .toast.error .toast-icon {
            background: var(--light-red);
            color: var(--error-red);
        }
        
        .toast.warning {
            border-left-color: var(--warning-yellow);
        }
        
        .toast.warning .toast-icon {
            background: #FFF3E0;
            color: var(--warning-yellow);
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            :root {
                --app-padding: 10px;
                --element-radius: 10px;
                --button-radius: 16px;
            }
            
            .quick-actions {
                grid-template-columns: 1fr;
            }
            
            .ride-type-grid {
                grid-template-columns: 1fr;
            }
            
            .emergency-services {
                grid-template-columns: 1fr;
            }
            
            .chat-container {
                width: calc(100vw - 20px);
                right: 10px;
            }
            
            .detail-grid {
                grid-template-columns: 1fr;
            }
            
            .notifications-panel {
                width: calc(100vw - 20px);
                right: 10px;
            }
        }
        
        @media (max-width: 480px) {
            .nav-tabs {
                gap: 4px;
            }
            
            .nav-tab {
                padding: 8px 4px;
                font-size: 10px;
            }
            
            .nav-tab i {
                font-size: 14px;
            }
            
            .balance-badge {
                padding: 5px 8px;
                font-size: 12px;
            }
            
            .service-tab {
                min-width: 85px;
                padding: 10px 12px;
            }
            
            .user-name {
                display: none;
            }
        }
        
        /* Custom Markers */
        .current-location-marker {
            background: var(--info-blue);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            box-shadow: 0 1px 8px rgba(0,0,0,0.3);
            border: 2px solid white;
        }
        
        .pickup-marker {
            background: var(--primary-orange);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            box-shadow: 0 1px 8px rgba(0,0,0,0.3);
            border: 2px solid white;
        }
        
        .destination-marker {
            background: var(--primary-red);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            box-shadow: 0 1px 8px rgba(0,0,0,0.3);
            border: 2px solid white;
        }
        
        .driver-marker {
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: white;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            box-shadow: 0 1px 8px rgba(0,0,0,0.3);
            border: 2px solid white;
            animation: pulse 2s infinite;
        }
        
        .emergency-vehicle-marker {
            background: var(--error-red);
            color: white;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            box-shadow: 0 1px 8px rgba(0,0,0,0.3);
            border: 2px solid white;
            animation: emergencyPulse 1s infinite;
        }
        
        /* Enhanced Form Elements */
        .form-group {
            margin-bottom: 14px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 13px;
            color: var(--dark-gray);
            background: var(--white);
            transition: all var(--transition-speed) ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
        }
        
        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        /* Enhanced Search Loading Indicator */
        .search-loading {
            display: none;
            position: absolute;
            top: 50%;
            right: 12px;
            transform: translateY(-50%);
            width: 14px;
            height: 14px;
            border: 2px solid var(--light-gray);
            border-radius: 50%;
            border-top-color: var(--primary-orange);
            animation: spin 0.6s linear infinite;
        }
        
        .location-input-wrapper.searching .search-loading {
            display: block;
        }
        
        /* No Results Message */
        .no-results {
            padding: 30px 16px;
            text-align: center;
            color: var(--text-light);
            font-size: 13px;
        }
        
        .no-results i {
            font-size: 28px;
            margin-bottom: 10px;
            opacity: 0.5;
        }
        
        /* Price Calculation Display */
        .price-calculation {
            background: var(--off-white);
            border-radius: var(--element-radius);
            padding: 14px;
            margin: 14px 0;
            font-size: 12px;
            color: var(--text-gray);
        }
        
        .calculation-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }
        
        .calculation-row:last-child {
            margin-bottom: 0;
            padding-top: 6px;
            border-top: 1px solid var(--border-color);
            font-weight: 600;
            color: var(--dark-gray);
        }
        
        /* Cancel Reasons Modal */
        .cancel-reasons {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-bottom: 16px;
        }
        
        .cancel-reason {
            padding: 14px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .cancel-reason:hover {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .cancel-reason.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .reason-icon {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-gray);
        }
        
        .cancel-reason.selected .reason-icon {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .reason-text {
            flex: 1;
            font-weight: 500;
            color: var(--dark-gray);
        }
        
        /* Schedule Ride Form */
        .schedule-form {
            display: none;
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }
        
        .schedule-form.active {
            display: block;
        }
        
        .schedule-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 14px;
        }
        
        /* More Options */
        .more-options {
            display: none;
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }
        
        .more-options.active {
            display: block;
        }
        
        .options-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .option-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 14px;
            background: var(--off-white);
            border: 2px solid transparent;
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .option-btn:hover {
            border-color: var(--primary-orange);
            background: var(--white);
            transform: translateY(-2px);
        }
        
        .option-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: var(--light-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-orange);
            font-size: 16px;
        }
        
        .option-name {
            font-weight: 600;
            font-size: 12px;
            color: var(--dark-gray);
            text-align: center;
        }
        
        /* Empty States */
        .empty-state {
            padding: 50px 16px;
            text-align: center;
            color: var(--text-light);
        }
        
        .empty-icon {
            font-size: 40px;
            margin-bottom: 14px;
            opacity: 0.3;
        }
        
        .empty-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text-gray);
        }
        
        .empty-message {
            font-size: 13px;
            margin-bottom: 16px;
            line-height: 1.4;
        }
        
        /* Service Forms */
        .service-form {
            display: none;
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }
        
        .service-form.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        /* Truck Delivery Form */
        .truck-form {
            border-color: var(--light-truck-brown);
        }
        
        .truck-form .form-title {
            color: var(--light-truck-brown);
        }
        
        /* Delivery Form */
        .delivery-form {
            border-color: var(--delivery-purple);
        }
        
        .delivery-form .form-title {
            color: var(--delivery-purple);
        }
        
        /* Express Shopping Form */
        .express-form {
            border-color: var(--express-shop-green);
        }
        
        .express-form .form-title {
            color: var(--express-shop-green);
        }
        
        /* Order for Someone Else Form */
        .someone-else-form {
            border-color: var(--info-blue);
        }
        
        .someone-else-form .form-title {
            color: var(--info-blue);
        }
        
        /* Ride Sharing Form */
        .share-ride-form {
            border-color: var(--warning-yellow);
        }
        
        .share-ride-form .form-title {
            color: var(--warning-yellow);
        }
        
        /* Payment Selection Styles */
        .payment-methods {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin: 16px 0;
        }
        
        .payment-method {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .payment-method:hover {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .payment-method.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .payment-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-gray);
        }
        
        .payment-method.selected .payment-icon {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .payment-details {
            flex: 1;
        }
        
        .payment-name {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
        }
        
        .payment-info {
            font-size: 11px;
            color: var(--text-gray);
            margin-top: 2px;
        }
        
        /* Wallet Transfer Form */
        .transfer-form {
            display: none;
        }
        
        .transfer-form.active {
            display: block;
        }
        
        /* Timeline */
        .timeline {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 16px 0;
            padding: 0 20px;
            position: relative;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            top: 12px;
            left: 10%;
            right: 10%;
            height: 2px;
            background: var(--border-color);
            z-index: 1;
        }
        
        .timeline-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            position: relative;
            z-index: 2;
            flex: 1;
        }
        
        .step-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            font-size: 10px;
            border: 2px solid var(--white);
            transition: all var(--transition-speed) ease;
        }
        
        .step-dot.active {
            background: var(--primary-orange);
            color: var(--white);
            transform: scale(1.1);
        }
        
        .step-dot.completed {
            background: var(--success-green);
            color: var(--white);
        }
        
        .step-label {
            font-size: 11px;
            color: var(--text-light);
            text-align: center;
        }
        
        .step-label.active {
            color: var(--primary-orange);
            font-weight: 600;
        }
        
        /* Parcel Details */
        .parcel-details {
            background: var(--off-white);
            border-radius: var(--element-radius);
            padding: 14px;
            margin: 12px 0;
        }
        
        .parcel-value-input {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .parcel-value-input span {
            font-weight: 600;
            color: var(--text-gray);
        }
        
        .parcel-value-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 13px;
        }
        
        /* Truck Types */
        .truck-types {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 12px 0;
        }
        
        .truck-type {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            text-align: center;
        }
        
        .truck-type:hover {
            border-color: var(--light-truck-brown);
            transform: translateY(-2px);
        }
        
        .truck-type.selected {
            border-color: var(--light-truck-brown);
            background: rgba(139, 69, 19, 0.05);
        }
        
        .truck-icon {
            font-size: 20px;
            color: var(--light-truck-brown);
            margin-bottom: 6px;
        }
        
        .truck-name {
            font-weight: 600;
            font-size: 12px;
            color: var(--dark-gray);
            margin-bottom: 2px;
        }
        
        .truck-capacity {
            font-size: 10px;
            color: var(--text-gray);
        }
        
        /* Item List for Express Shopping */
        .item-list {
            margin: 12px 0;
        }
        
        .item-entry {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .item-entry input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 13px;
        }
        
        .remove-item {
            width: 36px;
            height: 36px;
            border-radius: var(--element-radius);
            background: var(--light-red);
            border: none;
            color: var(--error-red);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .add-item {
            width: 100%;
            padding: 10px;
            background: var(--light-orange);
            border: 2px dashed var(--primary-orange);
            border-radius: var(--element-radius);
            color: var(--primary-orange);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all var(--transition-speed) ease;
        }
        
        .add-item:hover {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        /* Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* Focus Styles */
        *:focus {
            outline: 2px solid var(--primary-orange);
            outline-offset: 2px;
        }
        
        *:focus:not(.focus-visible) {
            outline: none;
        }
        
        /* Print Styles */
        @media print {
            .main-panel,
            .top-bar,
            .chat-container,
            .modal-overlay,
            .sos-button,
            .ride-status-bar,
            .emergency-status {
                display: none !important;
            }
            
            #map {
                position: relative;
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <!-- Map Container -->
    <div id="map"></div>
    
    <!-- Top Navigation Bar -->
    <div class="top-bar">
        <div class="logo-container">
            <img src="jubel.png" alt="Jubel Logo" class="logo-img">
            <div class="logo-text">Jubel</div>
            <div class="user-name" id="userName">Loading...</div>
        </div>
        
        <div class="user-actions">
            <div class="balance-badge" id="balanceBadge">
                <i class="fas fa-wallet"></i>
                <span>Balance: <span class="balance-amount" id="walletBalance">ZMW 0.00</span></span>
            </div>
            <div class="notification-bell" id="notificationBell">
                <i class="fas fa-bell"></i>
                <span class="notification-badge" id="notificationCount">0</span>
            </div>
        </div>
    </div>
    
    <!-- Notifications Panel -->
    <div class="notifications-panel" id="notificationsPanel">
        <div class="notifications-header">
            <div class="notifications-title">Notifications</div>
            <button class="mark-all-read" id="markAllReadBtn">Mark all as read</button>
        </div>
        <div class="notifications-list" id="notificationsList">
            <!-- Notifications will be inserted here -->
        </div>
    </div>
    
    <!-- Search Results Container -->
    <div class="search-results-container" id="searchResultsContainer">
        <!-- Search results will be inserted here -->
    </div>
    
    <!-- Ride Status Bar -->
    <div class="ride-status-bar" id="rideStatusBar">
        <div class="status-indicator">
            <div class="status-dot searching" id="statusDot"></div>
            <span class="status-text" id="statusText">Searching for driver</span>
        </div>
        <div class="status-eta">
            <i class="fas fa-clock"></i>
            <span id="etaText">5 min</span>
        </div>
    </div>
    
    <!-- Emergency Status -->
    <div class="emergency-status" id="emergencyStatus">
        <i class="fas fa-exclamation-triangle"></i>
        <span>EMERGENCY RIDE IN PROGRESS</span>
    </div>
    
    <!-- SOS Button -->
    <div class="sos-button" id="sosButton">
        SOS
    </div>
    
    <!-- Enhanced Chat Container -->
    <div class="chat-container" id="chatContainer">
        <div class="chat-header">
            <div class="chat-title">Chat with Driver</div>
            <button class="chat-close" id="chatClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <!-- Messages will be inserted here -->
        </div>
        <div class="chat-input-container">
            <button class="chat-attachment-btn" id="chatAttachmentBtn">
                <i class="fas fa-paperclip"></i>
            </button>
            <input type="text" class="chat-input" id="chatInput" placeholder="Type your message...">
            <button class="chat-send-btn" id="chatSend">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
    
    <!-- Main Panel -->
    <div class="main-panel" id="mainPanel">
        <div class="panel-handle" id="panelHandle"></div>
        
        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" data-screen="home">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </button>
            <button class="nav-tab" data-screen="history">
                <i class="fas fa-history"></i>
                <span>History</span>
            </button>
            <button class="nav-tab" data-screen="account">
                <i class="fas fa-user"></i>
                <span>Account</span>
            </button>
            <button class="nav-tab" data-screen="emergency">
                <i class="fas fa-ambulance"></i>
                <span>Emergency</span>
            </button>
        </div>
        
        <!-- Home Screen Content -->
        <div id="homeContent">
            <!-- Service Tabs -->
            <div class="service-tabs" id="serviceTabs">
                <div class="service-tab car active" data-service="car">
                    <div class="service-icon">
                        <i class="fas fa-car"></i>
                    </div>
                    <div class="service-name">Car</div>
                    <div class="service-desc">Ride anywhere</div>
                </div>
                
                <div class="service-tab delivery" data-service="delivery">
                    <div class="service-icon">
                        <i class="fas fa-shipping-fast"></i>
                    </div>
                    <div class="service-name">Delivery</div>
                    <div class="service-desc">Send packages</div>
                </div>
                
                <div class="service-tab short-delivery" data-service="short-delivery">
                    <div class="service-icon">
                        <i class="fas fa-bicycle"></i>
                    </div>
                    <div class="service-name">Short Delivery</div>
                    <div class="service-desc">Quick deliveries</div>
                </div>
                
                <div class="service-tab" data-service="express">
                    <div class="service-icon">
                        <i class="fas fa-shopping-bag"></i>
                    </div>
                    <div class="service-name">Express Shopping</div>
                    <div class="service-desc">Shop for you</div>
                </div>
                
                <div class="service-tab" data-service="truck">
                    <div class="service-icon">
                        <i class="fas fa-truck"></i>
                    </div>
                    <div class="service-name">Truck</div>
                    <div class="service-desc">Move items</div>
                </div>
            </div>
            
            <!-- Quick Actions with Enhanced Dropdown -->
            <div class="quick-actions" id="quickActionsContainer">
                <div class="quick-actions-dropdown" id="quickActionsDropdown">
                    <div class="dropdown-item" data-action="schedule">
                        <div class="dropdown-icon">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <div class="dropdown-text">
                            <div class="dropdown-title">Schedule Ride</div>
                            <div class="dropdown-desc">Plan your ride in advance</div>
                        </div>
                    </div>
                    <div class="dropdown-item" data-action="someone">
                        <div class="dropdown-icon">
                            <i class="fas fa-user-friends"></i>
                        </div>
                        <div class="dropdown-text">
                            <div class="dropdown-title">Order for Someone</div>
                            <div class="dropdown-desc">Book a ride for others</div>
                        </div>
                    </div>
                    <div class="dropdown-item" data-action="share">
                        <div class="dropdown-icon">
                            <i class="fas fa-share-alt"></i>
                        </div>
                        <div class="dropdown-text">
                            <div class="dropdown-title">Share Ride</div>
                            <div class="dropdown-desc">Split fare with friends</div>
                        </div>
                    </div>
                    <div class="dropdown-item" data-action="broadcast">
                        <div class="dropdown-icon">
                            <i class="fas fa-broadcast-tower"></i>
                        </div>
                        <div class="dropdown-text">
                            <div class="dropdown-title">Broadcast Ride</div>
                            <div class="dropdown-desc">Share ride details with others</div>
                        </div>
                    </div>
                </div>
                
                <button class="quick-action-btn has-dropdown" id="moreOptionsBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-ellipsis-h"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">More Options</div>
                        <div class="quick-action-desc">Additional services</div>
                    </div>
                </button>
            </div>
            
            <!-- Car Service Form (Default) -->
            <div class="ride-request-form active" id="carForm">
                <div class="form-title">
                    <i class="fas fa-car"></i>
                    Book a Ride
                </div>
                
                <div class="location-inputs">
                    <div class="location-input-wrapper" id="pickupInputWrapper">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="pickupLocation" placeholder="Current location" readonly>
                        <div class="search-loading-indicator"></div>
                        <button class="clear-input" id="clearPickupBtn">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="location-input-wrapper" id="destinationInputWrapper">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="destinationLocation" placeholder="Where to?" autocomplete="off">
                        <div class="search-loading-indicator"></div>
                        <button class="clear-input" id="clearDestinationBtn">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Ride Type Selection - Only shows for Car service -->
                <div class="ride-type-selection" id="rideTypeSelection">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                        <span id="rideTypeInfo" style="font-size: 11px; color: var(--text-light); cursor: pointer;">
                            <i class="fas fa-info-circle"></i>
                        </span>
                    </div>
                    
                    <div class="ride-type-grid">
                        <div class="ride-type-card economy" data-type="economy">
                            <div class="ride-type-icon">
                                <i class="fas fa-car-side"></i>
                            </div>
                            <div class="ride-type-name">Economy</div>
                            <div class="ride-type-price" id="economyPrice">ZMW 0.00</div>
                            <div class="ride-type-eta">ETA: 5-10 min</div>
                        </div>
                        
                        <div class="ride-type-card selected" data-type="standard">
                            <div class="ride-type-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="ride-type-name">Standard</div>
                            <div class="ride-type-price" id="standardPrice">ZMW 0.00</div>
                            <div class="ride-type-eta">ETA: 3-7 min</div>
                        </div>
                        
                        <div class="ride-type-card premium" data-type="premium">
                            <div class="ride-type-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="ride-type-name">Premium</div>
                            <div class="ride-type-price" id="premiumPrice">ZMW 0.00</div>
                            <div class="ride-type-eta">ETA: 2-5 min</div>
                        </div>
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="fareDisplay">
                    <div class="fare-label">Estimated Fare</div>
                    <div class="fare-amount" id="estimatedFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="distanceDetail">0 km</span>
                        <span id="timeDetail">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestRideBtn">
                        <i class="fas fa-search"></i>
                        Request Ride
                    </button>
                </div>
            </div>
            
            <!-- Other service forms remain similar but updated with enhanced search -->
            <!-- ... [All other service forms remain similar with enhanced search functionality] ... -->
            
            <!-- Enhanced Ride Info Panel -->
            <div class="ride-info-panel" id="rideInfoPanel">
                <div class="driver-info">
                    <div class="driver-avatar" id="driverAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="driver-details">
                        <div class="driver-name" id="driverName">Driver Name</div>
                        <div class="driver-rating">
                            <i class="fas fa-star"></i>
                            <span id="driverRating">4.8</span>
                        </div>
                        <div class="driver-vehicle">
                            <div class="vehicle-image" id="vehicleImage">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="vehicle-details">
                                <div class="vehicle-model" id="vehicleModel">Toyota Corolla</div>
                                <div class="vehicle-plate" id="vehiclePlate">ABC 123</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Timeline -->
                <div class="timeline" id="rideTimeline">
                    <div class="timeline-step">
                        <div class="step-dot active" id="stepRequested">
                            <i class="fas fa-search"></i>
                        </div>
                        <div class="step-label active">Requested</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepAccepted">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <div class="step-label">Accepted</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepArrived">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="step-label">Arrived</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepStarted">
                            <i class="fas fa-play"></i>
                        </div>
                        <div class="step-label">Started</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepCompleted">
                            <i class="fas fa-flag-checkered"></i>
                        </div>
                        <div class="step-label">Completed</div>
                    </div>
                </div>
                
                <div class="trip-details">
                    <div class="trip-locations">
                        <div class="location-point">
                            <div class="location-marker pickup">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="location-text">
                                <div class="location-label">Pickup</div>
                                <div class="location-address" id="currentPickup">Loading...</div>
                            </div>
                        </div>
                        
                        <div class="location-point">
                            <div class="location-marker destination">
                                <i class="fas fa-flag"></i>
                            </div>
                            <div class="location-text">
                                <div class="location-label">Destination</div>
                                <div class="location-address" id="currentDestination">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="fare-breakdown">
                    <div class="fare-row">
                        <span class="fare-label">Base Fare</span>
                        <span class="fare-value" id="baseFareValue">ZMW 15.00</span>
                    </div>
                    <div class="fare-row">
                        <span class="fare-label">Distance</span>
                        <span class="fare-value" id="distanceFareValue">ZMW 5.00</span>
                    </div>
                    <div class="fare-row">
                        <span class="fare-label">Ride Type</span>
                        <span class="fare-value" id="rideTypeValue">Standard</span>
                    </div>
                    <div class="fare-row total">
                        <span class="fare-label">Total Fare</span>
                        <span class="fare-value" id="totalFareValue">ZMW 20.00</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-broadcast" id="broadcastRideBtn">
                        <i class="fas fa-broadcast-tower"></i>
                        Broadcast Ride
                    </button>
                    <button class="btn btn-danger" id="cancelRideBtn">
                        <i class="fas fa-times-circle"></i>
                        Cancel Ride
                    </button>
                    <button class="btn btn-secondary" id="contactDriverBtn">
                        <i class="fas fa-phone"></i>
                        Call Driver
                    </button>
                    <button class="btn btn-secondary" id="openChatBtn">
                        <i class="fas fa-comment"></i>
                        Chat
                        <div class="chat-notification" id="chatNotificationBadge" style="display: none;"></div>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Other screens and modals remain similar with enhanced functionality -->
    <!-- ... [All other screens and modals remain with enhanced functionality] ... -->
    
    <!-- Enhanced Emergency Modal -->
    <div class="modal-overlay" id="emergencyModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-ambulance"></i>
                    Emergency Ride Details
                </div>
                <button class="modal-close" data-modal="emergency">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="emergency-reasons">
                    <div class="emergency-reason" data-reason="accident">
                        <div class="emergency-reason-icon">
                            <i class="fas fa-car-crash"></i>
                        </div>
                        <div class="emergency-reason-text">Road Accident</div>
                    </div>
                    <div class="emergency-reason" data-reason="medical">
                        <div class="emergency-reason-icon">
                            <i class="fas fa-heartbeat"></i>
                        </div>
                        <div class="emergency-reason-text">Medical Emergency</div>
                    </div>
                    <div class="emergency-reason" data-reason="crime">
                        <div class="emergency-reason-icon">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <div class="emergency-reason-text">Crime/Police Required</div>
                    </div>
                    <div class="emergency-reason" data-reason="fire">
                        <div class="emergency-reason-icon">
                            <i class="fas fa-fire"></i>
                        </div>
                        <div class="emergency-reason-text">Fire Emergency</div>
                    </div>
                    <div class="emergency-reason" data-reason="other">
                        <div class="emergency-reason-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="emergency-reason-text">Other Emergency</div>
                    </div>
                </div>
                
                <div class="form-group" id="otherEmergencyReason" style="display: none;">
                    <label class="form-label">Please specify your emergency:</label>
                    <textarea class="form-control form-textarea" id="emergencyDescription" placeholder="Briefly describe the emergency..."></textarea>
                </div>
                
                <div class="emergency-services-list" id="emergencyServicesList">
                    <!-- Emergency services will be loaded here -->
                </div>
                
                <div class="price-calculation" id="emergencyFareCalculation" style="display: none;">
                    <div class="calculation-row">
                        <span>Base Emergency Fare:</span>
                        <span id="emergencyBaseFare">ZMW 100.00</span>
                    </div>
                    <div class="calculation-row">
                        <span>Distance to Service:</span>
                        <span id="emergencyDistance">0 km</span>
                    </div>
                    <div class="calculation-row">
                        <span>Estimated Time:</span>
                        <span id="emergencyTime">5 min</span>
                    </div>
                    <div class="calculation-row">
                        <span>Total Fare:</span>
                        <span id="emergencyTotalFare">ZMW 100.00</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-danger" id="confirmEmergencyBtn" disabled>
                        <i class="fas fa-exclamation-triangle"></i>
                        Request Emergency Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="emergency">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Broadcast Ride Modal -->
    <div class="modal-overlay" id="broadcastModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-broadcast-tower"></i>
                    Broadcast Ride
                </div>
                <button class="modal-close" data-modal="broadcast">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="broadcast-form">
                    <div class="form-group">
                        <label class="form-label">Recipient's Phone Number</label>
                        <div class="recipient-input">
                            <input type="tel" id="recipientPhone" placeholder="Enter registered Jubel phone number">
                            <button class="add-recipient-btn" id="addRecipientBtn">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div id="recipientsList" style="margin-top: 10px;"></div>
                    </div>
                    
                    <div class="broadcast-preview">
                        <div class="preview-title">Ride Details to Share:</div>
                        <div class="preview-details" id="broadcastPreview">
                            <!-- Ride details will be shown here -->
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn btn-broadcast" id="sendBroadcastBtn">
                            <i class="fas fa-paper-plane"></i>
                            Send Broadcast
                        </button>
                        <button class="btn btn-secondary" data-modal="broadcast">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Loading...</div>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Firebase and Leaflet JS -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-messaging.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script>
        // ============================================
        // ENHANCED FIREBASE CONFIGURATION
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyDEACX_P4c5q7djJAcA0I7Lk7leO2TlQ74",
            authDomain: "jubel-13e1a.firebaseapp.com",
            databaseURL: "https://jubel-13e1a-default-rtdb.firebaseio.com",
            projectId: "jubel-13e1a",
            storageBucket: "jubel-13e1a.firebasestorage.app",
            messagingSenderId: "882241095445",
            appId: "1:882241095445:web:ee9ca40fddd008ca910b1c",
            measurementId: "G-J5JPKL6B5F"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        const messaging = firebase.messaging();

        // ============================================
        // ENHANCED APP STATE MANAGEMENT
        // ============================================
        const AppState = {
            currentUser: null,
            userData: null,
            currentRide: null,
            activeScreen: 'home',
            activeService: 'car',
            walletBalance: 0,
            userLocation: null,
            currentCity: 'Lusaka',
            selectedRideType: 'standard',
            selectedVehicle: null,
            destination: null,
            pickup: null,
            rideFare: 0,
            driverLocation: null,
            chatMessages: [],
            scheduledRides: [],
            emergencyMode: false,
            sosConfig: null,
            searchDebounceTimers: new Map(),
            searchCache: new Map(),
            emergencyServices: [],
            notifications: [],
            broadcastRecipients: [],
            enhancedSearchEngine: null,
            searchHistory: new Map(),
            activeSearchType: null,
            currentEmergencyReason: null,
            rideTypes: {
                economy: { base: 15, perKm: 2.5, multiplier: 0.8, min: 10, icon: 'fa-car-side' },
                standard: { base: 20, perKm: 3.0, multiplier: 1.0, min: 15, icon: 'fa-car' },
                premium: { base: 30, perKm: 4.0, multiplier: 1.5, min: 25, icon: 'fa-crown' }
            },
            emergencyServiceTypes: {
                police: { base: 150, perKm: 5.0, multiplier: 2.0, min: 100, icon: 'fa-shield-alt' },
                fire: { base: 200, perKm: 6.0, multiplier: 2.5, min: 150, icon: 'fa-fire-extinguisher' },
                medical: { base: 180, perKm: 5.5, multiplier: 2.2, min: 120, icon: 'fa-ambulance' }
            },
            deliveryTypes: {
                standard: { base: 25, perKm: 2.0, multiplier: 1.0 },
                express: { base: 40, perKm: 3.0, multiplier: 1.5 },
                sameDay: { base: 60, perKm: 4.0, multiplier: 2.0 }
            },
            truckTypes: {
                pickup: { base: 80, perKm: 5.0, multiplier: 1.0, capacity: '1.5 tons' },
                light: { base: 120, perKm: 6.0, multiplier: 1.2, capacity: '3 tons' },
                medium: { base: 200, perKm: 8.0, multiplier: 1.5, capacity: '7 tons' },
                heavy: { base: 350, perKm: 12.0, multiplier: 2.0, capacity: '15 tons' }
            },
            notificationTypes: {
                ride_assigned: { icon: 'fa-car', color: 'var(--primary-orange)' },
                wallet_update: { icon: 'fa-wallet', color: 'var(--success-green)' },
                referral_reward: { icon: 'fa-gift', color: 'var(--warning-yellow)' },
                promotion: { icon: 'fa-bullhorn', color: 'var(--info-blue)' },
                emergency: { icon: 'fa-exclamation-triangle', color: 'var(--error-red)' },
                broadcast: { icon: 'fa-broadcast-tower', color: 'var(--broadcast-blue)' }
            }
        };

        // ============================================
        // ULTRA-FAST SEARCH ENGINE
        // ============================================
        class UltraFastSearchEngine {
            constructor() {
                this.cache = new Map();
                this.localSearchIndex = new Map();
                this.cityBounds = null;
                this.searchWorker = null;
                this.debounceTimers = new Map();
                this.maxResults = 10;
                this.lastUserCity = null;
                this.preloadedCities = new Set(['Lusaka', 'Ndola', 'Kitwe', 'Kabwe', 'Livingstone']);
            }

            async initialize() {
                // Pre-load common city data
                await this.preloadCityData('Lusaka');
                
                // Initialize worker if supported
                if (window.Worker) {
                    this.searchWorker = new Worker(URL.createObjectURL(
                        new Blob([`(${this.workerFunction.toString()})()`], { type: 'text/javascript' })
                    ));
                }
            }

            workerFunction() {
                self.onmessage = function(e) {
                    const { query, city, userLocation, type } = e.data;
                    
                    // Simulate search processing
                    const results = [];
                    
                    // Process and sort results
                    results.sort((a, b) => {
                        if (userLocation) {
                            const distA = calculateDistance(userLocation.lat, userLocation.lng, a.lat, a.lng);
                            const distB = calculateDistance(userLocation.lat, userLocation.lng, b.lat, b.lng);
                            return distA - distB;
                        }
                        return a.importance - b.importance;
                    });
                    
                    self.postMessage({ results: results.slice(0, 10) });
                };

                function calculateDistance(lat1, lon1, lat2, lon2) {
                    const R = 6371;
                    const dLat = (lat2 - lat1) * Math.PI / 180;
                    const dLon = (lon2 - lon1) * Math.PI / 180;
                    const a = 
                        Math.sin(dLat/2) * Math.sin(dLat/2) +
                        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                        Math.sin(dLon/2) * Math.sin(dLon/2);
                    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                    return R * c;
                }
            }

            async search(query, type = 'destination', userLocation = null, city = 'Lusaka') {
                // Return cached results immediately if available
                const cacheKey = `${query.toLowerCase()}-${type}-${city}`;
                if (this.cache.has(cacheKey)) {
                    const cached = this.cache.get(cacheKey);
                    if (Date.now() - cached.timestamp < 300000) { // 5 minutes
                        return cached.results;
                    }
                }

                // Check local index first for instant results
                const localResults = this.searchLocalIndex(query, city, userLocation);
                if (localResults.length > 0) {
                    this.cache.set(cacheKey, {
                        results: localResults,
                        timestamp: Date.now()
                    });
                    return localResults;
                }

                // Use external API with debouncing
                try {
                    const results = await this.externalSearch(query, city, userLocation);
                    
                    // Update cache
                    this.cache.set(cacheKey, {
                        results: results,
                        timestamp: Date.now()
                    });
                    
                    // Update local index for future searches
                    this.updateLocalIndex(results, city);
                    
                    return results;
                } catch (error) {
                    console.error('Search error:', error);
                    return localResults; // Return local results as fallback
                }
            }

            searchLocalIndex(query, city, userLocation) {
                const results = [];
                const lowerQuery = query.toLowerCase();
                
                // Search in preloaded data
                const cityData = this.localSearchIndex.get(city) || [];
                
                for (const place of cityData) {
                    if (place.name.toLowerCase().includes(lowerQuery) || 
                        place.address.toLowerCase().includes(lowerQuery)) {
                        
                        const distance = userLocation ? 
                            this.calculateDistance(userLocation.lat, userLocation.lng, place.lat, place.lng) : 0;
                        
                        results.push({
                            ...place,
                            distance: distance
                        });
                        
                        if (results.length >= this.maxResults) break;
                    }
                }
                
                // Sort by distance if user location available
                if (userLocation) {
                    results.sort((a, b) => a.distance - b.distance);
                }
                
                return results;
            }

            async externalSearch(query, city, userLocation) {
                // Use multiple search providers for redundancy
                const providers = [
                    this.searchOpenStreetMap,
                    this.searchGoogleMapsFallback,
                    this.searchNominatim
                ];

                for (const provider of providers) {
                    try {
                        const results = await provider(query, city, userLocation);
                        if (results.length > 0) {
                            return results.slice(0, this.maxResults);
                        }
                    } catch (error) {
                        console.warn(`Provider failed:`, error);
                        continue;
                    }
                }
                
                return [];
            }

            async searchOpenStreetMap(query, city, userLocation) {
                const bounds = this.getCityBounds(city);
                const params = new URLSearchParams({
                    q: `${query}, ${city}, Zambia`,
                    format: 'json',
                    limit: 15,
                    countrycodes: 'zm',
                    bounded: 1,
                    viewbox: bounds.join(','),
                    'accept-language': 'en',
                    polygon: 0
                });

                const response = await fetch(`https://nominatim.openstreetmap.org/search?${params}`, {
                    headers: {
                        'Accept': 'application/json',
                        'User-Agent': 'JubelPassengerApp/1.0'
                    }
                });

                if (!response.ok) throw new Error('OSM search failed');
                
                const data = await response.json();
                return this.processResults(data, userLocation);
            }

            async searchNominatim(query, city, userLocation) {
                const params = new URLSearchParams({
                    q: `${query}`,
                    format: 'json',
                    limit: 10,
                    addressdetails: 1,
                    country: 'Zambia',
                    city: city
                });

                const response = await fetch(`https://nominatim.openstreetmap.org/search?${params}`);
                const data = await response.json();
                return this.processResults(data, userLocation);
            }

            async searchGoogleMapsFallback(query, city, userLocation) {
                // Fallback using local data if external APIs fail
                return this.searchLocalIndex(query, city, userLocation);
            }

            processResults(data, userLocation) {
                return data.map(place => {
                    const distance = userLocation ? 
                        this.calculateDistance(userLocation.lat, userLocation.lng, parseFloat(place.lat), parseFloat(place.lon)) : 0;
                    
                    return {
                        id: place.place_id,
                        name: place.display_name.split(',')[0],
                        address: this.formatAddress(place),
                        fullAddress: place.display_name,
                        lat: parseFloat(place.lat),
                        lng: parseFloat(place.lon),
                        type: place.type || place.class,
                        importance: place.importance || 0,
                        distance: distance
                    };
                }).sort((a, b) => {
                    // Priority: distance (if available), then importance
                    if (userLocation) {
                        return a.distance - b.distance;
                    }
                    return b.importance - a.importance;
                });
            }

            formatAddress(place) {
                const address = place.address || {};
                const parts = [];
                
                // Build address in logical order
                if (address.house_number || address.housenumber) {
                    parts.push(address.house_number || address.housenumber);
                }
                if (address.road) {
                    parts.push(address.road);
                }
                if (address.suburb || address.neighbourhood) {
                    parts.push(address.suburb || address.neighbourhood);
                }
                if (address.city || address.town || address.village) {
                    parts.push(address.city || address.town || address.village);
                }
                
                return parts.length > 0 ? parts.join(', ') : place.display_name.split(',')[0];
            }

            calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 6371;
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a = 
                    Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                    Math.sin(dLon/2) * Math.sin(dLon/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            }

            getCityBounds(city) {
                // Default bounds for major Zambian cities
                const bounds = {
                    'Lusaka': [28.0, -15.6, 28.6, -15.2],
                    'Ndola': [28.6, -13.0, 28.7, -12.9],
                    'Kitwe': [28.1, -12.9, 28.3, -12.8],
                    'Kabwe': [28.4, -14.5, 28.5, -14.4],
                    'Livingstone': [25.8, -17.9, 25.9, -17.8]
                };
                
                return bounds[city] || bounds['Lusaka'];
            }

            async preloadCityData(city) {
                if (this.preloadedCities.has(city)) {
                    try {
                        // Pre-load common places for the city
                        const commonPlaces = [
                            `${city} City Center`,
                            `${city} Airport`,
                            `${city} Bus Station`,
                            `${city} Hospital`,
                            `${city} Police Station`,
                            `${city} Mall`,
                            `${city} Market`
                        ];

                        for (const place of commonPlaces) {
                            const results = await this.searchOpenStreetMap(place, city, null);
                            if (results.length > 0) {
                                if (!this.localSearchIndex.has(city)) {
                                    this.localSearchIndex.set(city, []);
                                }
                                this.localSearchIndex.get(city).push(...results.slice(0, 3));
                            }
                        }
                    } catch (error) {
                        console.warn(`Failed to preload data for ${city}:`, error);
                    }
                }
            }

            updateLocalIndex(results, city) {
                if (!this.localSearchIndex.has(city)) {
                    this.localSearchIndex.set(city, []);
                }
                
                const cityIndex = this.localSearchIndex.get(city);
                for (const result of results) {
                    // Check for duplicates
                    if (!cityIndex.some(item => item.id === result.id)) {
                        cityIndex.push(result);
                    }
                }
                
                // Keep index size manageable
                if (cityIndex.length > 100) {
                    cityIndex.splice(100);
                }
            }

            clearCache() {
                this.cache.clear();
            }

            clearDebounceTimer(inputId) {
                if (this.debounceTimers.has(inputId)) {
                    clearTimeout(this.debounceTimers.get(inputId));
                    this.debounceTimers.delete(inputId);
                }
            }

            debounceSearch(inputId, callback, delay = 300) {
                this.clearDebounceTimer(inputId);
                const timer = setTimeout(() => {
                    callback();
                    this.debounceTimers.delete(inputId);
                }, delay);
                this.debounceTimers.set(inputId, timer);
            }
        }

        // ============================================
        // ENHANCED MAP MANAGEMENT
        // ============================================
        let map = null;
        let currentLocationMarker = null;
        let pickupMarker = null;
        let destinationMarker = null;
        let driverMarker = null;
        let routeLayer = null;
        let emergencyMarkers = [];

        // ============================================
        // ENHANCED PRICE CALCULATOR
        // ============================================
        const EnhancedPriceCalculator = {
            calculateRideFare: function(distanceKm, rideType = 'standard', surge = 1.0) {
                const config = AppState.rideTypes[rideType] || AppState.rideTypes.standard;
                
                // Base fare + distance fare
                let fare = config.base + (distanceKm * config.perKm);
                
                // Apply ride type multiplier
                fare *= config.multiplier;
                
                // Apply surge pricing
                fare *= surge;
                
                // Ensure minimum fare
                fare = Math.max(fare, config.min);
                
                // Round to 2 decimal places
                return Math.round(fare * 100) / 100;
            },
            
            calculateEmergencyFare: function(distanceKm, serviceType, surge = 1.0) {
                const config = AppState.emergencyServiceTypes[serviceType] || AppState.emergencyServiceTypes.police;
                
                let fare = config.base + (distanceKm * config.perKm);
                fare *= config.multiplier;
                fare *= surge;
                fare = Math.max(fare, config.min);
                
                return Math.round(fare * 100) / 100;
            },
            
            calculateDeliveryFare: function(distanceKm, deliveryType = 'standard', parcelValue = 0) {
                const config = AppState.deliveryTypes[deliveryType] || AppState.deliveryTypes.standard;
                
                let fare = config.base + (distanceKm * config.perKm);
                fare *= config.multiplier;
                
                // Add insurance for valuable parcels (1% of parcel value)
                if (parcelValue > 500) {
                    fare += parcelValue * 0.01;
                }
                
                return Math.round(fare * 100) / 100;
            },
            
            calculateTruckFare: function(distanceKm, truckType = 'light', helpers = false) {
                const config = AppState.truckTypes[truckType] || AppState.truckTypes.light;
                
                let fare = config.base + (distanceKm * config.perKm);
                fare *= config.multiplier;
                
                // Add helper cost if needed
                if (helpers) {
                    fare += 50;
                }
                
                return Math.round(fare * 100) / 100;
            },
            
            calculateShoppingFare: function(distanceKm, itemsCount = 1, budget = 0) {
                // Base fare + distance + item count
                let fare = 30 + (distanceKm * 2.5) + (itemsCount * 5);
                
                // Add 5% of budget for shopping service
                if (budget > 0) {
                    fare += budget * 0.05;
                }
                
                return Math.round(fare * 100) / 100;
            },
            
            calculateDistance: function(lat1, lon1, lat2, lon2) {
                const R = 6371;
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a = 
                    Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                    Math.sin(dLon/2) * Math.sin(dLon/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            },
            
            estimateTime: function(distanceKm, rideType = 'standard') {
                // Base time + traffic factor
                const baseSpeed = rideType === 'premium' ? 40 : 30; // km/h
                const baseTime = (distanceKm / baseSpeed) * 60; // minutes
                const trafficFactor = 1.3; // 30% extra for traffic
                
                return Math.ceil(baseTime * trafficFactor);
            },
            
            getSurgeMultiplier: function() {
                // Enhanced surge pricing based on multiple factors
                const now = new Date();
                const hour = now.getHours();
                const day = now.getDay();
                const isWeekend = day === 0 || day === 6;
                
                let surge = 1.0;
                
                // Time-based surge
                if (hour >= 7 && hour <= 9) surge *= 1.3; // Morning rush
                if (hour >= 16 && hour <= 19) surge *= 1.5; // Evening rush
                if (hour >= 22 || hour <= 5) surge *= 1.8; // Late night
                
                // Weekend surge
                if (isWeekend) surge *= 1.2;
                
                // Weather-based surge (simulated)
                // In production, this would integrate with weather API
                const weatherSurge = Math.random() * 0.3 + 0.9; // 0.9-1.2
                surge *= weatherSurge;
                
                return Math.min(surge, 3.0); // Cap at 3x
            }
        };

        // ============================================
        // ENHANCED UI UPDATER
        // ============================================
        const EnhancedUIUpdater = {
            updateUserInfo: function(userData) {
                if (userData) {
                    document.getElementById('userName').textContent = userData.name || 'User';
                    document.getElementById('accountName').textContent = userData.name || 'User';
                    document.getElementById('accountPhone').textContent = userData.phone || 'Not set';
                    
                    // Update avatar if available
                    const avatarElement = document.getElementById('accountAvatar');
                    if (userData.photoUrl) {
                        avatarElement.innerHTML = `<img src="${userData.photoUrl}" alt="${userData.name}">`;
                    }
                }
            },
            
            updateWalletBalance: function(balance) {
                const formatted = `ZMW ${balance.toFixed(2)}`;
                document.getElementById('walletBalance').textContent = formatted;
                document.getElementById('accountBalance').textContent = formatted;
                document.getElementById('paymentBalance').textContent = formatted;
                document.getElementById('transferBalance').textContent = formatted;
                AppState.walletBalance = balance;
            },
            
            showToast: function(message, type = 'info', duration = 5000) {
                const toastContainer = document.getElementById('toastContainer');
                const toastId = 'toast-' + Date.now();
                
                const icons = {
                    success: 'fa-check-circle',
                    error: 'fa-exclamation-circle',
                    warning: 'fa-exclamation-triangle',
                    info: 'fa-info-circle'
                };
                
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.id = toastId;
                toast.innerHTML = `
                    <div class="toast-icon">
                        <i class="fas ${icons[type] || icons.info}"></i>
                    </div>
                    <div class="toast-content">
                        <div class="toast-title">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
                        <div class="toast-message">${message}</div>
                    </div>
                    <button class="toast-close" onclick="EnhancedUIUpdater.removeToast('${toastId}')">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                toastContainer.appendChild(toast);
                
                // Auto-remove after duration
                setTimeout(() => {
                    this.removeToast(toastId);
                }, duration);
                
                return toastId;
            },
            
            removeToast: function(toastId) {
                const toast = document.getElementById(toastId);
                if (toast) {
                    toast.classList.add('hiding');
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, 300);
                }
            },
            
            showSearchResults: function(results, searchType) {
                const container = document.getElementById('searchResultsContainer');
                if (!container) return;
                
                container.innerHTML = '';
                
                if (results.length === 0) {
                    container.innerHTML = `
                        <div class="no-results">
                            <i class="fas fa-search"></i>
                            <div>No results found</div>
                            <div style="font-size: 11px; margin-top: 8px;">Try a different search term</div>
                        </div>
                    `;
                } else {
                    results.forEach((result, index) => {
                        const item = document.createElement('div');
                        item.className = 'search-result-item';
                        if (index === 0) item.classList.add('selected');
                        
                        item.innerHTML = `
                            <div class="search-result-icon">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="search-result-content">
                                <div class="search-result-name">${result.name}</div>
                                <div class="search-result-address">${result.address}</div>
                                ${result.distance ? `
                                <div class="search-result-distance">
                                    <i class="fas fa-ruler"></i>
                                    ${result.distance.toFixed(1)} km away
                                </div>
                                ` : ''}
                            </div>
                        `;
                        
                        item.addEventListener('click', () => {
                            this.selectSearchResult(result, searchType);
                        });
                        
                        container.appendChild(item);
                    });
                }
                
                container.classList.add('active');
                AppState.activeSearchType = searchType;
                
                // Position container below search input
                const inputId = searchType === 'pickup' ? 'pickupLocation' : 'destinationLocation';
                const input = document.getElementById(inputId);
                if (input) {
                    const rect = input.getBoundingClientRect();
                    container.style.top = `${rect.bottom + window.scrollY}px`;
                    container.style.left = `${rect.left}px`;
                    container.style.width = `${rect.width}px`;
                }
            },
            
            selectSearchResult: function(result, searchType) {
                const container = document.getElementById('searchResultsContainer');
                const inputId = searchType === 'pickup' ? 'pickupLocation' : 'destinationLocation';
                const input = document.getElementById(inputId);
                
                if (input) {
                    input.value = result.address;
                    
                    // Update AppState
                    if (searchType === 'pickup') {
                        AppState.pickup = result;
                        this.updatePickupMarker(result);
                    } else {
                        AppState.destination = result;
                        this.updateDestinationMarker(result);
                    }
                    
                    // Calculate prices if both locations are set
                    if (AppState.pickup && AppState.destination) {
                        this.calculateAndUpdatePrices();
                    }
                    
                    // Hide search results
                    container.classList.remove('active');
                    AppState.activeSearchType = null;
                }
            },
            
            hideSearchResults: function() {
                const container = document.getElementById('searchResultsContainer');
                container.classList.remove('active');
                AppState.activeSearchType = null;
            },
            
            updatePickupMarker: function(location) {
                if (pickupMarker) {
                    pickupMarker.setLatLng([location.lat, location.lng]);
                } else {
                    pickupMarker = L.marker([location.lat, location.lng], {
                        icon: L.divIcon({
                            className: 'pickup-marker',
                            html: '<i class="fas fa-map-marker-alt"></i>',
                            iconSize: [20, 20]
                        })
                    }).addTo(map).bindPopup('Pickup Location');
                }
                
                if (AppState.destination) {
                    this.drawRoute(location, AppState.destination);
                }
            },
            
            updateDestinationMarker: function(location) {
                if (destinationMarker) {
                    destinationMarker.setLatLng([location.lat, location.lng]);
                } else {
                    destinationMarker = L.marker([location.lat, location.lng], {
                        icon: L.divIcon({
                            className: 'destination-marker',
                            html: '<i class="fas fa-flag"></i>',
                            iconSize: [20, 20]
                        })
                    }).addTo(map).bindPopup('Destination');
                }
                
                if (AppState.pickup) {
                    this.drawRoute(AppState.pickup, location);
                }
            },
            
            drawRoute: function(start, end) {
                if (routeLayer) {
                    map.removeLayer(routeLayer);
                }
                
                routeLayer = L.Routing.control({
                    waypoints: [
                        L.latLng(start.lat, start.lng),
                        L.latLng(end.lat, end.lng)
                    ],
                    routeWhileDragging: false,
                    showAlternatives: false,
                    lineOptions: {
                        styles: [{color: '#FF6B35', weight: 3, opacity: 0.7}]
                    },
                    createMarker: function() { return null; }
                }).addTo(map);
                
                // Fit bounds to show entire route
                const bounds = L.latLngBounds(
                    [start.lat, start.lng],
                    [end.lat, end.lng]
                );
                map.fitBounds(bounds, { padding: [30, 30] });
            },
            
            calculateAndUpdatePrices: function() {
                if (AppState.pickup && AppState.destination) {
                    const distance = EnhancedPriceCalculator.calculateDistance(
                        AppState.pickup.lat, AppState.pickup.lng,
                        AppState.destination.lat, AppState.destination.lng
                    );
                    
                    // Update prices based on active service
                    switch(AppState.activeService) {
                        case 'car':
                            this.updateRidePrices(distance);
                            document.getElementById('fareDisplay').classList.add('active');
                            break;
                        case 'delivery':
                        case 'short-delivery':
                            const deliveryFare = EnhancedPriceCalculator.calculateDeliveryFare(distance);
                            // Update delivery fare display
                            break;
                        case 'truck':
                            const truckFare = EnhancedPriceCalculator.calculateTruckFare(distance);
                            // Update truck fare display
                            break;
                        case 'express':
                            const shoppingFare = EnhancedPriceCalculator.calculateShoppingFare(distance);
                            // Update shopping fare display
                            break;
                    }
                }
            },
            
            updateRidePrices: function(distanceKm) {
                const types = ['economy', 'standard', 'premium'];
                const surge = EnhancedPriceCalculator.getSurgeMultiplier();
                
                types.forEach(type => {
                    const price = EnhancedPriceCalculator.calculateRideFare(distanceKm, type, surge);
                    const element = document.getElementById(`${type}Price`);
                    if (element) {
                        element.textContent = `ZMW ${price.toFixed(2)}`;
                    }
                });
                
                // Update estimated fare display
                const selectedPrice = EnhancedPriceCalculator.calculateRideFare(distanceKm, AppState.selectedRideType, surge);
                document.getElementById('estimatedFare').textContent = `ZMW ${selectedPrice.toFixed(2)}`;
                
                // Update distance and time
                const time = EnhancedPriceCalculator.estimateTime(distanceKm, AppState.selectedRideType);
                document.getElementById('distanceDetail').textContent = `${distanceKm.toFixed(1)} km`;
                document.getElementById('timeDetail').textContent = `ETA: ${time} min`;
                
                AppState.rideFare = selectedPrice;
            },
            
            updateEmergencyServices: function(services) {
                const container = document.getElementById('emergencyServicesList');
                if (!container) return;
                
                container.innerHTML = '';
                
                services.forEach((service, index) => {
                    const item = document.createElement('div');
                    item.className = `emergency-service-item ${service.type} ${index === 0 ? 'selected' : ''}`;
                    item.dataset.service = service.type;
                    
                    item.innerHTML = `
                        <div class="emergency-service-icon">
                            <i class="fas ${AppState.emergencyServiceTypes[service.type]?.icon || 'fa-shield-alt'}"></i>
                        </div>
                        <div class="emergency-service-details">
                            <div class="emergency-service-name">${service.name}</div>
                            <div class="emergency-service-address">${service.address}</div>
                            <div class="emergency-service-distance">
                                <i class="fas fa-ruler"></i>
                                ${service.distance.toFixed(1)} km away
                            </div>
                        </div>
                    `;
                    
                    item.addEventListener('click', () => {
                        // Remove selected class from all items
                        container.querySelectorAll('.emergency-service-item').forEach(el => {
                            el.classList.remove('selected');
                        });
                        
                        // Add selected class to clicked item
                        item.classList.add('selected');
                        
                        // Update emergency fare calculation
                        this.updateEmergencyFare(service);
                    });
                    
                    container.appendChild(item);
                });
                
                // Update fare for first item
                if (services.length > 0) {
                    this.updateEmergencyFare(services[0]);
                }
            },
            
            updateEmergencyFare: function(service) {
                const fare = EnhancedPriceCalculator.calculateEmergencyFare(service.distance, service.type);
                
                document.getElementById('emergencyBaseFare').textContent = 
                    `ZMW ${AppState.emergencyServiceTypes[service.type]?.base || 100}`;
                document.getElementById('emergencyDistance').textContent = 
                    `${service.distance.toFixed(1)} km`;
                document.getElementById('emergencyTotalFare').textContent = 
                    `ZMW ${fare.toFixed(2)}`;
                
                document.getElementById('emergencyFareCalculation').style.display = 'block';
                document.getElementById('confirmEmergencyBtn').disabled = false;
            },
            
            updateNotifications: function(notifications) {
                const container = document.getElementById('notificationsList');
                if (!container) return;
                
                container.innerHTML = '';
                
                if (notifications.length === 0) {
                    container.innerHTML = `
                        <div class="notifications-empty">
                            <i class="fas fa-bell-slash"></i>
                            <div style="margin-top: 10px;">No notifications</div>
                        </div>
                    `;
                    return;
                }
                
                notifications.forEach(notification => {
                    const item = document.createElement('div');
                    item.className = `notification-item ${notification.read ? '' : 'unread'}`;
                    
                    const notificationType = AppState.notificationTypes[notification.type] || 
                                           AppState.notificationTypes.info;
                    
                    item.innerHTML = `
                        <div class="notification-icon" style="background: ${notificationType.color}">
                            <i class="fas ${notificationType.icon}"></i>
                        </div>
                        <div class="notification-content">
                            <div class="notification-title">${notification.title}</div>
                            <div class="notification-message">${notification.message}</div>
                            <div class="notification-time">${this.formatTime(notification.timestamp)}</div>
                            ${notification.actions ? `
                            <div class="notification-actions">
                                ${notification.actions.map(action => `
                                    <button class="notification-action-btn" data-action="${action.type}">
                                        ${action.label}
                                    </button>
                                `).join('')}
                            </div>
                            ` : ''}
                        </div>
                    `;
                    
                    item.addEventListener('click', () => {
                        this.handleNotificationClick(notification);
                    });
                    
                    container.appendChild(item);
                });
                
                // Update notification badge
                const unreadCount = notifications.filter(n => !n.read).length;
                document.getElementById('notificationCount').textContent = unreadCount;
            },
            
            formatTime: function(timestamp) {
                const now = Date.now();
                const diff = now - timestamp;
                
                if (diff < 60000) return 'Just now';
                if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
                if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
                return `${Math.floor(diff / 86400000)}d ago`;
            },
            
            handleNotificationClick: function(notification) {
                // Handle notification click based on type
                switch(notification.type) {
                    case 'ride_assigned':
                        // Navigate to ride info
                        if (notification.rideId) {
                            EnhancedFirebaseManager.loadRideDetails(notification.rideId);
                        }
                        break;
                    case 'wallet_update':
                        // Show wallet transaction
                        showModal('transactions');
                        break;
                    case 'referral_reward':
                        // Show referral details
                        switchScreen('account');
                        break;
                    case 'broadcast':
                        // Navigate to broadcasted ride
                        if (notification.rideId) {
                            EnhancedFirebaseManager.loadBroadcastedRide(notification.rideId);
                        }
                        break;
                }
                
                // Mark as read
                if (!notification.read) {
                    EnhancedFirebaseManager.markNotificationAsRead(notification.id);
                }
            },
            
            showDriverInfo: function(driver) {
                const avatar = document.getElementById('driverAvatar');
                const name = document.getElementById('driverName');
                const rating = document.getElementById('driverRating');
                const vehicleModel = document.getElementById('vehicleModel');
                const vehiclePlate = document.getElementById('vehiclePlate');
                const vehicleImage = document.getElementById('vehicleImage');
                
                // Update driver avatar
                if (driver.photoUrl) {
                    avatar.innerHTML = `<img src="${driver.photoUrl}" alt="${driver.name}">`;
                } else {
                    avatar.innerHTML = `<i class="fas fa-user"></i>`;
                }
                
                // Update driver details
                name.textContent = driver.name || 'Driver';
                rating.textContent = driver.rating?.toFixed(1) || '4.8';
                vehicleModel.textContent = driver.vehicle?.model || 'Vehicle';
                vehiclePlate.textContent = driver.vehicle?.plate || 'ABC 123';
                
                // Update vehicle image
                if (driver.vehicle?.imageUrl) {
                    vehicleImage.innerHTML = `<img src="${driver.vehicle.imageUrl}" alt="${driver.vehicle.model}">`;
                } else {
                    vehicleImage.innerHTML = `<i class="fas fa-car"></i>`;
                }
                
                // Add driver marker to map if location available
                if (driver.location) {
                    this.updateDriverMarker(driver.location);
                }
                
                // Show SOS button if driver is assigned
                document.getElementById('sosButton').style.display = 'flex';
            },
            
            updateDriverMarker: function(location) {
                if (driverMarker) {
                    driverMarker.setLatLng([location.lat, location.lng]);
                } else {
                    driverMarker = L.marker([location.lat, location.lng], {
                        icon: L.divIcon({
                            className: 'driver-marker',
                            html: '<i class="fas fa-car"></i>',
                            iconSize: [32, 32]
                        })
                    }).addTo(map).bindPopup('Your Driver');
                }
            },
            
            showChatMessage: function(message, isSender = false) {
                const container = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                
                messageDiv.className = `message ${isSender ? 'sent' : 'received'}`;
                messageDiv.innerHTML = `
                    ${!isSender ? `<div class="message-sender">${message.senderName || 'Driver'}</div>` : ''}
                    <div>${message.text}</div>
                    <div class="message-time">${new Date(message.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                `;
                
                container.appendChild(messageDiv);
                container.scrollTop = container.scrollHeight;
                
                // Show chat notification if not open
                if (!isSender && !document.getElementById('chatContainer').classList.contains('active')) {
                    this.showChatNotification();
                }
            },
            
            showChatNotification: function() {
                const badge = document.getElementById('chatNotificationBadge');
                if (badge) {
                    const currentCount = parseInt(badge.textContent) || 0;
                    badge.textContent = currentCount + 1;
                    badge.style.display = 'flex';
                }
            },
            
            clearChatNotification: function() {
                const badge = document.getElementById('chatNotificationBadge');
                if (badge) {
                    badge.textContent = '';
                    badge.style.display = 'none';
                }
            },
            
            showLoading: function(message = 'Loading...') {
                const overlay = document.getElementById('loadingOverlay');
                const text = document.getElementById('loadingText');
                text.textContent = message;
                overlay.classList.add('active');
            },
            
            hideLoading: function() {
                const overlay = document.getElementById('loadingOverlay');
                overlay.classList.remove('active');
            }
        };

        // ============================================
        // ENHANCED FIREBASE MANAGER
        // ============================================
        const EnhancedFirebaseManager = {
            async loadUserData(uid) {
                try {
                    const snapshot = await database.ref(`users/${uid}`).once('value');
                    AppState.userData = snapshot.val();
                    
                    if (AppState.userData) {
                        // Update wallet balance
                        AppState.walletBalance = AppState.userData.walletBalance || 0;
                        EnhancedUIUpdater.updateWalletBalance(AppState.walletBalance);
                        
                        // Update user info
                        EnhancedUIUpdater.updateUserInfo(AppState.userData);
                        
                        // Load referral code
                        document.getElementById('referralCode').textContent = 
                            AppState.userData.referralCode || 'JUBEL-' + uid.substring(0, 8).toUpperCase();
                        
                        // Load SOS config
                        await this.loadSOSConfig(uid);
                        
                        // Load notifications
                        await this.loadNotifications(uid);
                        
                        // Check for active ride
                        await this.checkActiveRide(uid);
                        
                        // Load ride history
                        await this.loadRideHistory(uid);
                        
                        // Listen for real-time updates
                        this.setupRealtimeListeners(uid);
                        
                        return true;
                    }
                    return false;
                } catch (error) {
                    console.error('Error loading user data:', error);
                    EnhancedUIUpdater.showToast('Error loading user data', 'error');
                    return false;
                }
            },
            
            setupRealtimeListeners(uid) {
                // Listen for notification updates
                database.ref(`notifications/${uid}`).on('value', (snapshot) => {
                    const notifications = snapshot.val();
                    if (notifications) {
                        const notificationsArray = Object.values(notifications).reverse();
                        AppState.notifications = notificationsArray;
                        EnhancedUIUpdater.updateNotifications(notificationsArray);
                    }
                });
                
                // Listen for wallet balance updates
                database.ref(`users/${uid}/walletBalance`).on('value', (snapshot) => {
                    const balance = snapshot.val() || 0;
                    if (balance !== AppState.walletBalance) {
                        AppState.walletBalance = balance;
                        EnhancedUIUpdater.updateWalletBalance(balance);
                        
                        // Show notification for balance change
                        if (balance > AppState.walletBalance) {
                            this.sendNotification(uid, 'Wallet Updated', 
                                `Your wallet has been credited with ZMW ${(balance - AppState.walletBalance).toFixed(2)}`,
                                'wallet_update');
                        }
                    }
                });
            },
            
            async loadNotifications(uid) {
                try {
                    const snapshot = await database.ref(`notifications/${uid}`)
                        .orderByChild('timestamp')
                        .limitToLast(50)
                        .once('value');
                    
                    const notifications = snapshot.val();
                    if (notifications) {
                        const notificationsArray = Object.values(notifications).reverse();
                        AppState.notifications = notificationsArray;
                        EnhancedUIUpdater.updateNotifications(notificationsArray);
                    }
                } catch (error) {
                    console.error('Error loading notifications:', error);
                }
            },
            
            async markNotificationAsRead(notificationId) {
                try {
                    await database.ref(`notifications/${AppState.currentUser.uid}/${notificationId}/read`).set(true);
                    return true;
                } catch (error) {
                    console.error('Error marking notification as read:', error);
                    return false;
                }
            },
            
            async markAllNotificationsAsRead() {
                try {
                    const updates = {};
                    AppState.notifications.forEach(notification => {
                        if (!notification.read) {
                            updates[`${AppState.currentUser.uid}/${notification.id}/read`] = true;
                        }
                    });
                    
                    await database.ref('notifications').update(updates);
                    return true;
                } catch (error) {
                    console.error('Error marking all notifications as read:', error);
                    return false;
                }
            },
            
            async sendNotification(userId, title, message, type = 'info', data = {}) {
                try {
                    const notificationId = database.ref().child(`notifications/${userId}`).push().key;
                    const notification = {
                        id: notificationId,
                        title,
                        message,
                        type,
                        data,
                        read: false,
                        timestamp: Date.now()
                    };
                    
                    await database.ref(`notifications/${userId}/${notificationId}`).set(notification);
                    return notificationId;
                } catch (error) {
                    console.error('Error sending notification:', error);
                    return null;
                }
            },
            
            async loadSOSConfig(uid) {
                try {
                    const snapshot = await database.ref(`sosConfig/${uid}`).once('value');
                    AppState.sosConfig = snapshot.val();
                    
                    // Update SOS modal with saved config
                    if (AppState.sosConfig) {
                        document.getElementById('sosContact1Name').value = AppState.sosConfig.contact1Name || '';
                        document.getElementById('sosContact1Phone').value = AppState.sosConfig.contact1Phone || '';
                        document.getElementById('sosContact2Name').value = AppState.sosConfig.contact2Name || '';
                        document.getElementById('sosContact2Phone').value = AppState.sosConfig.contact2Phone || '';
                        document.getElementById('sosMessage').value = AppState.sosConfig.message || 
                            'I need help! My current location and ride details will be shared with you.';
                    }
                } catch (error) {
                    console.error('Error loading SOS config:', error);
                }
            },
            
            async saveSOSConfig(config) {
                try {
                    await database.ref(`sosConfig/${AppState.currentUser.uid}`).set(config);
                    AppState.sosConfig = config;
                    
                    // Show SOS button if ride is active
                    if (AppState.currentRide && AppState.currentRide.status === 'accepted') {
                        document.getElementById('sosButton').style.display = 'flex';
                    }
                    
                    EnhancedUIUpdater.showToast('SOS configuration saved', 'success');
                    return true;
                } catch (error) {
                    console.error('Error saving SOS config:', error);
                    EnhancedUIUpdater.showToast('Error saving SOS config', 'error');
                    return false;
                }
            },
            
            async checkActiveRide(uid) {
                try {
                    const snapshot = await database.ref('rides')
                        .orderByChild('passengerId')
                        .equalTo(uid)
                        .orderByChild('status')
                        .startAt('requested')
                        .endAt('started')
                        .once('value');
                    
                    const rides = snapshot.val();
                    if (rides) {
                        const rideId = Object.keys(rides)[0];
                        AppState.currentRide = { id: rideId, ...rides[rideId] };
                        
                        // Show ride info
                        this.showRideInfo(AppState.currentRide);
                        
                        // Listen for ride updates
                        this.listenToRideUpdates(rideId);
                        
                        // If driver assigned, load driver info
                        if (AppState.currentRide.driverId) {
                            await this.loadDriverInfo(AppState.currentRide.driverId);
                        }
                        
                        return true;
                    }
                    return false;
                } catch (error) {
                    console.error('Error checking active ride:', error);
                    return false;
                }
            },
            
            async loadDriverInfo(driverId) {
                try {
                    const snapshot = await database.ref(`users/${driverId}`).once('value');
                    const driver = snapshot.val();
                    if (driver) {
                        AppState.selectedVehicle = driver;
                        EnhancedUIUpdater.showDriverInfo(driver);
                        
                        // Listen to driver location
                        this.listenToDriverLocation(driverId);
                    }
                } catch (error) {
                    console.error('Error loading driver info:', error);
                }
            },
            
            listenToDriverLocation(driverId) {
                database.ref(`driverLocations/${driverId}`).on('value', (snapshot) => {
                    const location = snapshot.val();
                    if (location) {
                        AppState.driverLocation = location;
                        EnhancedUIUpdater.updateDriverMarker({
                            lat: location.latitude,
                            lng: location.longitude
                        });
                    }
                });
            },
            
            listenToRideUpdates(rideId) {
                database.ref(`rides/${rideId}`).on('value', (snapshot) => {
                    const ride = snapshot.val();
                    if (ride) {
                        AppState.currentRide = { id: rideId, ...ride };
                        
                        // Update UI
                        this.updateRideStatus(ride.status);
                        
                        // Handle driver assignment
                        if (ride.driverId && !AppState.selectedVehicle) {
                            this.loadDriverInfo(ride.driverId);
                        }
                        
                        // Handle ride completion
                        if (ride.status === 'completed') {
                            this.handleRideCompletion(ride);
                        }
                        
                        // Listen to chat messages
                        this.listenToChatMessages(rideId);
                    }
                });
            },
            
            updateRideStatus: function(status) {
                const statusBar = document.getElementById('rideStatusBar');
                const statusDot = document.getElementById('statusDot');
                const statusText = document.getElementById('statusText');
                const etaText = document.getElementById('etaText');
                
                statusBar.classList.add('active');
                
                switch(status) {
                    case 'requested':
                        statusDot.className = 'status-dot searching';
                        statusText.textContent = 'Searching for driver';
                        etaText.textContent = '5-10 min';
                        break;
                    case 'accepted':
                        statusDot.className = 'status-dot arriving';
                        statusText.textContent = 'Driver on the way';
                        etaText.textContent = '5 min';
                        
                        // Show SOS button if configured
                        if (AppState.sosConfig) {
                            document.getElementById('sosButton').style.display = 'flex';
                        }
                        break;
                    case 'arrived':
                        statusDot.className = 'status-dot riding';
                        statusText.textContent = 'Driver arrived';
                        etaText.textContent = '0 min';
                        break;
                    case 'started':
                        statusDot.className = 'status-dot riding';
                        statusText.textContent = 'Trip in progress';
                        etaText.textContent = 'En route';
                        break;
                    case 'completed':
                        statusBar.classList.remove('active');
                        break;
                }
                
                // Update timeline
                this.updateTimeline(status);
            },
            
            updateTimeline: function(status) {
                const steps = ['stepRequested', 'stepAccepted', 'stepArrived', 'stepStarted', 'stepCompleted'];
                const stepLabels = ['Requested', 'Accepted', 'Arrived', 'Started', 'Completed'];
                const currentIndex = stepLabels.indexOf(status);
                
                steps.forEach((stepId, index) => {
                    const step = document.getElementById(stepId);
                    const label = step.parentNode.querySelector('.step-label');
                    
                    if (index < currentIndex) {
                        step.className = 'step-dot completed';
                        label.className = 'step-label';
                    } else if (index === currentIndex) {
                        step.className = 'step-dot active';
                        label.className = 'step-label active';
                    } else {
                        step.className = 'step-dot';
                        label.className = 'step-label';
                    }
                });
            },
            
            showRideInfo: function(ride) {
                // Hide all forms
                document.querySelectorAll('.ride-request-form, .service-form').forEach(form => {
                    form.style.display = 'none';
                });
                
                // Show ride info panel
                document.getElementById('rideInfoPanel').classList.add('active');
                
                // Update ride details
                document.getElementById('currentPickup').textContent = ride.pickupDisplay || ride.pickup;
                document.getElementById('currentDestination').textContent = ride.destinationDisplay || ride.destination;
                
                // Update fare breakdown
                this.updateFareBreakdown(ride);
            },
            
            updateFareBreakdown: function(ride) {
                const distance = ride.distance || 0;
                let baseFare, distanceFare, total;
                
                if (ride.serviceType === 'truck') {
                    const config = AppState.truckTypes[ride.truckType] || AppState.truckTypes.light;
                    baseFare = config.base;
                    distanceFare = distance * config.perKm;
                    total = ride.fare || baseFare + distanceFare;
                } else if (ride.serviceType === 'delivery') {
                    const config = AppState.deliveryTypes[ride.deliveryType] || AppState.deliveryTypes.standard;
                    baseFare = config.base;
                    distanceFare = distance * config.perKm;
                    total = ride.fare || baseFare + distanceFare;
                } else {
                    baseFare = AppState.rideTypes[ride.rideType]?.base || 20;
                    distanceFare = distance * (AppState.rideTypes[ride.rideType]?.perKm || 3);
                    total = ride.fare || baseFare + distanceFare;
                }
                
                document.getElementById('baseFareValue').textContent = `ZMW ${baseFare.toFixed(2)}`;
                document.getElementById('distanceFareValue').textContent = `ZMW ${distanceFare.toFixed(2)}`;
                
                if (ride.serviceType) {
                    document.getElementById('rideTypeValue').textContent = 
                        ride.serviceType.charAt(0).toUpperCase() + ride.serviceType.slice(1);
                } else {
                    document.getElementById('rideTypeValue').textContent = 
                        ride.rideType.charAt(0).toUpperCase() + ride.rideType.slice(1);
                }
                
                document.getElementById('totalFareValue').textContent = `ZMW ${total.toFixed(2)}`;
            },
            
            async requestRide(rideData) {
                try {
                    const rideId = database.ref().child('rides').push().key;
                    const ride = {
                        id: rideId,
                        ...rideData,
                        status: 'requested',
                        timestamp: Date.now(),
                        updatedAt: Date.now()
                    };
                    
                    await database.ref(`rides/${rideId}`).set(ride);
                    
                    AppState.currentRide = ride;
                    this.showRideInfo(ride);
                    this.updateTimeline('requested');
                    
                    // Listen for updates
                    this.listenToRideUpdates(rideId);
                    
                    EnhancedUIUpdater.showToast('Ride requested successfully', 'success');
                    return rideId;
                } catch (error) {
                    console.error('Error requesting ride:', error);
                    EnhancedUIUpdater.showToast('Error requesting ride', 'error');
                    throw error;
                }
            },
            
            async broadcastRide(rideId, recipients, message = '') {
                try {
                    for (const recipientPhone of recipients) {
                        // Find user by phone number
                        const usersSnapshot = await database.ref('users').orderByChild('phone').equalTo(recipientPhone).once('value');
                        const users = usersSnapshot.val();
                        
                        if (users) {
                            const recipientId = Object.keys(users)[0];
                            
                            // Send notification
                            await this.sendNotification(
                                recipientId,
                                'Ride Broadcast',
                                message || `Your friend ${AppState.userData.name} has shared their ride details with you.`,
                                'broadcast',
                                { rideId: rideId }
                            );
                        }
                    }
                    
                    EnhancedUIUpdater.showToast(`Ride broadcasted to ${recipients.length} recipient(s)`, 'success');
                    return true;
                } catch (error) {
                    console.error('Error broadcasting ride:', error);
                    EnhancedUIUpdater.showToast('Error broadcasting ride', 'error');
                    return false;
                }
            },
            
            async sendSOSAlert(rideId, sosData) {
                try {
                    const alertId = database.ref().child('sosAlerts').push().key;
                    await database.ref(`sosAlerts/${alertId}`).set(sosData);
                    
                    // Send notifications to emergency contacts
                    if (sosData.emergencyContact1) {
                        await this.sendNotificationToPhone(
                            sosData.emergencyContact1,
                            'SOS Alert',
                            `${AppState.userData.name} has triggered an SOS alert: ${sosData.message}`
                        );
                    }
                    
                    if (sosData.emergencyContact2) {
                        await this.sendNotificationToPhone(
                            sosData.emergencyContact2,
                            'SOS Alert',
                            `${AppState.userData.name} has triggered an SOS alert: ${sosData.message}`
                        );
                    }
                    
                    // Notify emergency services
                    await database.ref('emergencyAlerts').push().set({
                        rideId: rideId,
                        passengerId: AppState.currentUser.uid,
                        location: sosData.location,
                        timestamp: Date.now(),
                        status: 'pending'
                    });
                    
                    EnhancedUIUpdater.showToast('SOS alert sent to emergency contacts', 'success');
                    return true;
                } catch (error) {
                    console.error('Error sending SOS alert:', error);
                    EnhancedUIUpdater.showToast('Error sending SOS alert', 'error');
                    return false;
                }
            },
            
            async sendNotificationToPhone(phone, title, message) {
                // This would integrate with SMS gateway in production
                console.log(`SMS to ${phone}: ${title} - ${message}`);
                
                // For now, we'll use Firebase notifications
                try {
                    // Find user by phone
                    const usersSnapshot = await database.ref('users').orderByChild('phone').equalTo(phone).once('value');
                    const users = usersSnapshot.val();
                    
                    if (users) {
                        const userId = Object.keys(users)[0];
                        await this.sendNotification(userId, title, message, 'emergency');
                    }
                } catch (error) {
                    console.error('Error sending notification to phone:', error);
                }
            },
            
            listenToChatMessages(rideId) {
                database.ref(`chats/${rideId}/messages`).on('child_added', (snapshot) => {
                    const message = snapshot.val();
                    if (message) {
                        EnhancedUIUpdater.showChatMessage(message, message.senderId === AppState.currentUser.uid);
                    }
                });
            },
            
            async sendChatMessage(rideId, message, isDriver = false) {
                try {
                    const messageId = database.ref().child(`chats/${rideId}/messages`).push().key;
                    const chatMessage = {
                        id: messageId,
                        text: message,
                        senderId: isDriver ? AppState.currentRide?.driverId : AppState.currentUser.uid,
                        senderName: isDriver ? AppState.selectedVehicle?.name : AppState.userData?.name,
                        timestamp: Date.now(),
                        isDriver: isDriver
                    };
                    
                    await database.ref(`chats/${rideId}/messages/${messageId}`).set(chatMessage);
                    return messageId;
                } catch (error) {
                    console.error('Error sending chat message:', error);
                    throw error;
                }
            },
            
            async loadEmergencyServices(city, userLocation) {
                try {
                    // Load emergency services for the city
                    const snapshot = await database.ref(`emergencyServices/${city}`).once('value');
                    let services = snapshot.val();
                    
                    if (!services) {
                        // Use default services if none found
                        services = this.getDefaultEmergencyServices(city);
                    }
                    
                    // Convert to array and calculate distances
                    const servicesArray = Object.values(services).map(service => {
                        const distance = userLocation ? 
                            EnhancedPriceCalculator.calculateDistance(
                                userLocation.lat, userLocation.lng,
                                service.lat, service.lng
                            ) : 0;
                        
                        return {
                            ...service,
                            distance: distance
                        };
                    });
                    
                    // Sort by distance
                    servicesArray.sort((a, b) => a.distance - b.distance);
                    
                    AppState.emergencyServices = servicesArray;
                    EnhancedUIUpdater.updateEmergencyServices(servicesArray);
                    
                    return servicesArray;
                } catch (error) {
                    console.error('Error loading emergency services:', error);
                    return [];
                }
            },
            
            getDefaultEmergencyServices(city) {
                // Default emergency services for major cities
                const defaultServices = {
                    police: [
                        { name: `${city} Central Police`, type: 'police', lat: -15.4167, lng: 28.2833 },
                        { name: `${city} Police Station 1`, type: 'police', lat: -15.4000, lng: 28.3000 },
                        { name: `${city} Police Station 2`, type: 'police', lat: -15.3900, lng: 28.3200 }
                    ],
                    fire: [
                        { name: `${city} Fire Brigade`, type: 'fire', lat: -15.4100, lng: 28.2900 },
                        { name: `${city} Fire Station`, type: 'fire', lat: -15.4200, lng: 28.2700 }
                    ],
                    medical: [
                        { name: `${city} General Hospital`, type: 'medical', lat: -15.4050, lng: 28.2950 },
                        { name: `${city} Emergency Hospital`, type: 'medical', lat: -15.3950, lng: 28.3050 }
                    ]
                };
                
                // Flatten the object
                return Object.values(defaultServices).flat();
            },
            
            handleRideCompletion(ride) {
                // Hide ride status bar
                document.getElementById('rideStatusBar').classList.remove('active');
                
                // Hide SOS button
                document.getElementById('sosButton').style.display = 'none';
                
                // Update timeline to completed
                this.updateTimeline('completed');
                
                // Add receipt button
                const actionButtons = document.querySelector('#rideInfoPanel .action-buttons');
                const existingReceiptBtn = document.querySelector('#receiptBtn');
                
                if (!existingReceiptBtn) {
                    const receiptBtn = document.createElement('button');
                    receiptBtn.id = 'receiptBtn';
                    receiptBtn.className = 'btn btn-primary';
                    receiptBtn.innerHTML = '<i class="fas fa-receipt"></i> View Receipt';
                    receiptBtn.addEventListener('click', () => {
                        this.generateReceipt(ride);
                    });
                    
                    actionButtons.appendChild(receiptBtn);
                }
                
                // Update wallet balance if paid with wallet
                if (ride.paymentMethod === 'wallet') {
                    const newBalance = AppState.walletBalance - ride.fare;
                    EnhancedUIUpdater.updateWalletBalance(newBalance);
                    
                    // Update in database
                    database.ref(`users/${AppState.currentUser.uid}/walletBalance`).set(newBalance);
                }
                
                // Handle referral reward if applicable
                if (ride.referredBy) {
                    this.handleReferralReward(ride);
                }
                
                // Send completion notification
                this.sendNotification(
                    AppState.currentUser.uid,
                    'Ride Completed',
                    `Your ride has been completed. Fare: ZMW ${ride.fare?.toFixed(2)}`,
                    'ride_assigned'
                );
            },
            
            async handleReferralReward(ride) {
                try {
                    // Find referrer by referral code
                    const usersSnapshot = await database.ref('users').once('value');
                    const users = usersSnapshot.val();
                    let referrerId = null;
                    
                    for (const [userId, userData] of Object.entries(users)) {
                        if (userData.referralCode === ride.referredBy) {
                            referrerId = userId;
                            break;
                        }
                    }
                    
                    if (referrerId) {
                        // Add ZMW 25 reward to referrer
                        const referrerSnapshot = await database.ref(`users/${referrerId}/walletBalance`).once('value');
                        const referrerBalance = referrerSnapshot.val() || 0;
                        const newReferrerBalance = referrerBalance + 25;
                        
                        await database.ref(`users/${referrerId}/walletBalance`).set(newReferrerBalance);
                        
                        // Record transaction
                        const transactionId = database.ref().child('transactions').push().key;
                        const transaction = {
                            id: transactionId,
                            senderId: 'system',
                            senderName: 'Jubel System',
                            recipientId: referrerId,
                            recipientName: users[referrerId].name,
                            amount: 25,
                            message: `Referral reward from ${AppState.userData.name}`,
                            timestamp: Date.now(),
                            type: 'referral'
                        };
                        
                        await database.ref(`transactions/${transactionId}`).set(transaction);
                        
                        // Send notification to referrer
                        await this.sendNotification(
                            referrerId,
                            'Referral Reward',
                            `You earned ZMW 25.00 because ${AppState.userData.name} used your referral code`,
                            'referral_reward'
                        );
                        
                        // Send notification to passenger
                        await this.sendNotification(
                            AppState.currentUser.uid,
                            'Referral Applied',
                            'Your referral has been applied successfully',
                            'wallet_update'
                        );
                    }
                } catch (error) {
                    console.error('Error handling referral reward:', error);
                }
            },
            
            generateReceipt(ride) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Add receipt content
                doc.setFontSize(18);
                doc.setTextColor(255, 107, 53);
                doc.text('JUBEL RIDE RECEIPT', 105, 20, { align: 'center' });
                
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.text(`Receipt No: ${ride.id.substring(0, 8)}`, 20, 40);
                doc.text(`Date: ${new Date(ride.timestamp).toLocaleString()}`, 20, 45);
                
                // Add ride details
                doc.text(`Passenger: ${AppState.userData.name}`, 20, 55);
                doc.text(`Driver: ${ride.driverName || 'Not assigned'}`, 20, 60);
                doc.text(`Pickup: ${ride.pickupDisplay || ride.pickup}`, 20, 65);
                doc.text(`Destination: ${ride.destinationDisplay || ride.destination}`, 20, 70);
                doc.text(`Distance: ${ride.distance?.toFixed(1) || '0'} km`, 20, 75);
                
                if (ride.serviceType) {
                    doc.text(`Service Type: ${ride.serviceType.charAt(0).toUpperCase() + ride.serviceType.slice(1)}`, 20, 80);
                } else {
                    doc.text(`Ride Type: ${ride.rideType?.charAt(0).toUpperCase() + ride.rideType?.slice(1)}`, 20, 80);
                }
                
                // Add fare breakdown
                doc.text('Fare Breakdown:', 20, 90);
                
                let yPos = 95;
                if (ride.serviceType === 'truck') {
                    const config = AppState.truckTypes[ride.truckType] || AppState.truckTypes.light;
                    doc.text(`Base Fare: ZMW ${config.base.toFixed(2)}`, 30, yPos);
                    yPos += 5;
                    doc.text(`Distance Fare: ZMW ${((ride.distance || 0) * config.perKm).toFixed(2)}`, 30, yPos);
                } else if (ride.serviceType === 'delivery') {
                    const config = AppState.deliveryTypes[ride.deliveryType] || AppState.deliveryTypes.standard;
                    doc.text(`Base Fare: ZMW ${config.base.toFixed(2)}`, 30, yPos);
                    yPos += 5;
                    doc.text(`Distance Fare: ZMW ${((ride.distance || 0) * config.perKm).toFixed(2)}`, 30, yPos);
                } else {
                    doc.text(`Base Fare: ZMW ${(AppState.rideTypes[ride.rideType]?.base || 20).toFixed(2)}`, 30, yPos);
                    yPos += 5;
                    doc.text(`Distance Fare: ZMW ${((ride.distance || 0) * (AppState.rideTypes[ride.rideType]?.perKm || 3)).toFixed(2)}`, 30, yPos);
                }
                
                yPos += 5;
                doc.text(`Total: ZMW ${ride.fare?.toFixed(2) || '0.00'}`, 30, yPos);
                
                // Add payment method
                yPos += 10;
                doc.text(`Payment Method: ${ride.paymentMethod?.charAt(0).toUpperCase() + ride.paymentMethod?.slice(1)}`, 20, yPos);
                
                // Save PDF
                doc.save(`Jubel_Receipt_${ride.id.substring(0, 8)}.pdf`);
                EnhancedUIUpdater.showToast('Receipt downloaded', 'success');
            }
        };

        // ============================================
        // ENHANCED EMERGENCY SERVICE LOCATOR
        // ============================================
        class EnhancedEmergencyLocator {
            constructor() {
                this.services = new Map();
                this.userCity = null;
            }

            async loadServicesForCity(city) {
                try {
                    // Load from database
                    const services = await EnhancedFirebaseManager.loadEmergencyServices(city, AppState.userLocation);
                    this.services.set(city, services);
                    this.userCity = city;
                    return services;
                } catch (error) {
                    console.error('Error loading emergency services:', error);
                    return [];
                }
            }

            findNearestService(type, userLocation) {
                if (!this.userCity || !this.services.has(this.userCity)) {
                    return null;
                }

                const cityServices = this.services.get(this.userCity);
                const filteredServices = cityServices.filter(service => service.type === type);

                if (filteredServices.length === 0) {
                    return null;
                }

                // Find nearest service
                let nearest = null;
                let minDistance = Infinity;

                filteredServices.forEach(service => {
                    const distance = EnhancedPriceCalculator.calculateDistance(
                        userLocation.lat, userLocation.lng,
                        service.lat, service.lng
                    );

                    if (distance < minDistance) {
                        minDistance = distance;
                        nearest = { ...service, distance };
                    }
                });

                return nearest;
            }

            showEmergencyMarkers(type) {
                // Clear existing markers
                if (emergencyMarkers.length > 0) {
                    emergencyMarkers.forEach(marker => map.removeLayer(marker));
                    emergencyMarkers = [];
                }

                // Add markers for emergency services
                if (this.userCity && this.services.has(this.userCity)) {
                    const cityServices = this.services.get(this.userCity);
                    const filteredServices = cityServices.filter(service => service.type === type);

                    filteredServices.forEach(service => {
                        const marker = L.marker([service.lat, service.lng], {
                            icon: L.divIcon({
                                className: 'emergency-vehicle-marker',
                                html: `<i class="fas ${AppState.emergencyServiceTypes[service.type]?.icon || 'fa-shield-alt'}"></i>`,
                                iconSize: [36, 36]
                            })
                        }).addTo(map).bindPopup(`${service.name}<br>${service.address}`);

                        emergencyMarkers.push(marker);
                    });
                }
            }

            getServicesByType(type) {
                if (!this.userCity || !this.services.has(this.userCity)) {
                    return [];
                }

                const cityServices = this.services.get(this.userCity);
                return cityServices
                    .filter(service => service.type === type)
                    .sort((a, b) => a.distance - b.distance);
            }
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        async function initializeApp() {
            try {
                // Check authentication
                const urlParams = new URLSearchParams(window.location.search);
                const email = urlParams.get('email');
                const uid = urlParams.get('uid');
                
                if (email && uid) {
                    AppState.currentUser = { uid, email };
                    await EnhancedFirebaseManager.loadUserData(uid);
                } else {
                    // Listen for auth state changes
                    auth.onAuthStateChanged(async (user) => {
                        if (user) {
                            AppState.currentUser = user;
                            await EnhancedFirebaseManager.loadUserData(user.uid);
                        } else {
                            window.location.href = 'signup.html';
                        }
                    });
                }
                
                // Initialize enhanced search engine
                AppState.enhancedSearchEngine = new UltraFastSearchEngine();
                await AppState.enhancedSearchEngine.initialize();
                
                // Initialize emergency locator
                AppState.emergencyLocator = new EnhancedEmergencyLocator();
                
                // Initialize map
                initializeMap();
                
                // Set up event listeners
                setupEventListeners();
                
                // Get current location
                getCurrentLocation();
                
                // Set minimum date for schedule form
                const today = new Date().toISOString().split('T')[0];
                if (document.getElementById('scheduleDate')) {
                    document.getElementById('scheduleDate').min = today;
                }
                
                // Initialize shopping items
                initializeShoppingItems();
                
                EnhancedUIUpdater.showToast('Jubel Passenger App Ready', 'success');
                
            } catch (error) {
                console.error('Error initializing app:', error);
                EnhancedUIUpdater.showToast('Error initializing app', 'error');
            }
        }
        
        function initializeMap() {
            map = L.map('map').setView([-15.4167, 28.2833], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
        }
        
        function initializeShoppingItems() {
            const itemsContainer = document.getElementById('shoppingItems');
            const addItemBtn = document.getElementById('addItemBtn');
            
            if (itemsContainer && addItemBtn) {
                // Add first item removal button
                const firstItem = itemsContainer.querySelector('.item-entry');
                if (firstItem) {
                    const removeBtn = firstItem.querySelector('.remove-item');
                    removeBtn.addEventListener('click', function() {
                        if (itemsContainer.children.length > 1) {
                            firstItem.remove();
                        }
                    });
                }
                
                // Add new item
                addItemBtn.addEventListener('click', function() {
                    const itemEntry = document.createElement('div');
                    itemEntry.className = 'item-entry';
                    itemEntry.innerHTML = `
                        <input type="text" class="item-input" placeholder="Item name">
                        <button class="remove-item" type="button">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    
                    itemsContainer.appendChild(itemEntry);
                    
                    // Add event to remove button
                    const removeBtn = itemEntry.querySelector('.remove-item');
                    removeBtn.addEventListener('click', function() {
                        itemEntry.remove();
                    });
                });
            }
        }
        
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const { latitude, longitude } = position.coords;
                        AppState.userLocation = { lat: latitude, lng: longitude };
                        
                        // Center map on user location
                        map.setView([latitude, longitude], 15);
                        
                        // Add current location marker
                        currentLocationMarker = L.marker([latitude, longitude], {
                            icon: L.divIcon({
                                className: 'current-location-marker',
                                html: '<i class="fas fa-user"></i>',
                                iconSize: [18, 18]
                            })
                        }).addTo(map).bindPopup('Your Location');
                        
                        // Get detailed address
                        const address = await reverseGeocode(latitude, longitude);
                        
                        // Update pickup location inputs
                        document.getElementById('pickupLocation').value = address;
                        
                        AppState.pickup = {
                            lat: latitude,
                            lng: longitude,
                            address: address,
                            name: 'Current Location'
                        };
                        
                        // Detect city
                        await detectCity(latitude, longitude);
                        
                        // Pre-load emergency services for the city
                        if (AppState.currentCity) {
                            await AppState.emergencyLocator.loadServicesForCity(AppState.currentCity);
                        }
                        
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                        EnhancedUIUpdater.showToast('Unable to get your location. Using default location.', 'warning');
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            }
        }
        
        async function reverseGeocode(lat, lng) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`
                );
                const data = await response.json();
                
                if (data && data.address) {
                    const address = data.address;
                    const parts = [];
                    
                    // Build detailed address
                    if (address.house_number || address.housenumber) {
                        parts.push(`House ${address.house_number || address.housenumber}`);
                    }
                    if (address.road) {
                        parts.push(address.road);
                    }
                    if (address.suburb || address.neighbourhood) {
                        parts.push(address.suburb || address.neighbourhood);
                    }
                    if (address.city || address.town) {
                        parts.push(address.city || address.town);
                    }
                    
                    return parts.join(', ') || data.display_name;
                }
                
                return `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
            } catch (error) {
                console.error('Reverse geocode error:', error);
                return `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
            }
        }
        
        async function detectCity(lat, lng) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=10`
                );
                const data = await response.json();
                
                if (data && data.address) {
                    const city = data.address.city || data.address.town || data.address.village;
                    if (city) {
                        AppState.currentCity = city;
                        
                        // Update search engine city
                        if (AppState.enhancedSearchEngine) {
                            AppState.enhancedSearchEngine.preloadCityData(city);
                        }
                    }
                }
            } catch (error) {
                console.error('City detection error:', error);
            }
        }

        // ============================================
        // ENHANCED EVENT HANDLERS
        // ============================================
        function setupEventListeners() {
            // Navigation tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const screen = tab.dataset.screen;
                    switchScreen(screen);
                });
            });
            
            // Back buttons
            document.querySelectorAll('.back-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    switchScreen('home');
                });
            });
            
            // Panel handle
            document.getElementById('panelHandle').addEventListener('click', togglePanel);
            
            // Service tabs
            document.querySelectorAll('.service-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const service = tab.dataset.service;
                    switchService(service);
                });
            });
            
            // More options dropdown
            document.getElementById('moreOptionsBtn').addEventListener('click', (e) => {
                e.stopPropagation();
                const dropdown = document.getElementById('quickActionsDropdown');
                const isOpen = dropdown.classList.contains('active');
                
                // Close all other dropdowns
                document.querySelectorAll('.quick-actions-dropdown.active').forEach(d => {
                    d.classList.remove('active');
                });
                document.querySelectorAll('.quick-action-btn.dropdown-open').forEach(btn => {
                    btn.classList.remove('dropdown-open');
                });
                
                // Toggle current dropdown
                if (!isOpen) {
                    dropdown.classList.add('active');
                    document.getElementById('moreOptionsBtn').classList.add('dropdown-open');
                }
            });
            
            // Dropdown items
            document.querySelectorAll('.dropdown-item').forEach(item => {
                item.addEventListener('click', () => {
                    const action = item.dataset.action;
                    handleDropdownAction(action);
                    
                    // Close dropdown
                    document.getElementById('quickActionsDropdown').classList.remove('active');
                    document.getElementById('moreOptionsBtn').classList.remove('dropdown-open');
                });
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.quick-actions')) {
                    document.getElementById('quickActionsDropdown').classList.remove('active');
                    document.getElementById('moreOptionsBtn').classList.remove('dropdown-open');
                }
            });
            
            // Enhanced search inputs
            document.getElementById('destinationLocation').addEventListener('input', async function(e) {
                const query = e.target.value.trim();
                
                if (query.length < 2) {
                    EnhancedUIUpdater.hideSearchResults();
                    return;
                }
                
                // Show loading indicator
                document.getElementById('destinationInputWrapper').classList.add('searching');
                
                // Debounce search
                AppState.enhancedSearchEngine.debounceSearch('destination', async () => {
                    try {
                        const results = await AppState.enhancedSearchEngine.search(
                            query, 
                            'destination', 
                            AppState.userLocation,
                            AppState.currentCity
                        );
                        
                        EnhancedUIUpdater.showSearchResults(results, 'destination');
                    } catch (error) {
                        console.error('Search error:', error);
                        EnhancedUIUpdater.showToast('Search failed. Please try again.', 'error');
                    } finally {
                        document.getElementById('destinationInputWrapper').classList.remove('searching');
                    }
                }, 200);
            });
            
            // Clear input buttons
            document.getElementById('clearDestinationBtn').addEventListener('click', () => {
                document.getElementById('destinationLocation').value = '';
                AppState.destination = null;
                EnhancedUIUpdater.hideSearchResults();
                
                // Remove destination marker
                if (destinationMarker) {
                    map.removeLayer(destinationMarker);
                    destinationMarker = null;
                }
                
                // Remove route
                if (routeLayer) {
                    map.removeLayer(routeLayer);
                    routeLayer = null;
                }
                
                // Hide fare display
                document.getElementById('fareDisplay').classList.remove('active');
            });
            
            document.getElementById('clearPickupBtn').addEventListener('click', () => {
                document.getElementById('pickupLocation').value = '';
                AppState.pickup = null;
                EnhancedUIUpdater.hideSearchResults();
                
                // Remove pickup marker
                if (pickupMarker) {
                    map.removeLayer(pickupMarker);
                    pickupMarker = null;
                }
                
                // Remove route
                if (routeLayer) {
                    map.removeLayer(routeLayer);
                    routeLayer = null;
                }
            });
            
            // Close search results when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.location-input-wrapper') && 
                    !e.target.closest('.search-results-container')) {
                    EnhancedUIUpdater.hideSearchResults();
                }
            });
            
            // Escape key to close search results
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    EnhancedUIUpdater.hideSearchResults();
                }
            });
            
            // Ride type selection - only for car service
            document.querySelectorAll('.ride-type-card').forEach(card => {
                card.addEventListener('click', () => {
                    // Only allow selection if car service is active
                    if (AppState.activeService === 'car') {
                        document.querySelectorAll('.ride-type-card').forEach(c => {
                            c.classList.remove('selected');
                        });
                        
                        card.classList.add('selected');
                        AppState.selectedRideType = card.dataset.type;
                        
                        // Update prices
                        if (AppState.pickup && AppState.destination) {
                            EnhancedUIUpdater.calculateAndUpdatePrices();
                        }
                    }
                });
            });
            
            // Request ride button
            document.getElementById('requestRideBtn').addEventListener('click', async () => {
                if (!AppState.pickup || !AppState.destination) {
                    EnhancedUIUpdater.showToast('Please select pickup and destination locations', 'warning');
                    return;
                }
                
                // Calculate distance
                const distance = EnhancedPriceCalculator.calculateDistance(
                    AppState.pickup.lat, AppState.pickup.lng,
                    AppState.destination.lat, AppState.destination.lng
                );
                
                if (distance < 0.5) {
                    EnhancedUIUpdater.showToast('Minimum ride distance is 0.5 km', 'warning');
                    return;
                }
                
                // Show payment modal
                document.getElementById('paymentAmount').textContent = `ZMW ${AppState.rideFare.toFixed(2)}`;
                showModal('payment');
            });
            
            // Broadcast ride button
            document.getElementById('broadcastRideBtn').addEventListener('click', () => {
                if (!AppState.currentRide) {
                    EnhancedUIUpdater.showToast('No active ride to broadcast', 'warning');
                    return;
                }
                
                // Update broadcast preview
                const preview = document.getElementById('broadcastPreview');
                if (preview) {
                    preview.innerHTML = `
                        <div><strong>Driver:</strong> ${AppState.selectedVehicle?.name || 'Not assigned'}</div>
                        <div><strong>Pickup:</strong> ${AppState.currentRide.pickupDisplay || AppState.currentRide.pickup}</div>
                        <div><strong>Destination:</strong> ${AppState.currentRide.destinationDisplay || AppState.currentRide.destination}</div>
                        <div><strong>ETA:</strong> ${document.getElementById('etaText').textContent}</div>
                        <div><strong>Vehicle:</strong> ${AppState.selectedVehicle?.vehicle?.model || 'Not specified'}</div>
                    `;
                }
                
                showModal('broadcast');
            });
            
            // Send broadcast button
            document.getElementById('sendBroadcastBtn').addEventListener('click', async () => {
                const recipientPhone = document.getElementById('recipientPhone').value.trim();
                
                if (!recipientPhone) {
                    EnhancedUIUpdater.showToast('Please enter recipient phone number', 'warning');
                    return;
                }
                
                // Validate phone number
                const phoneRegex = /^\+?[0-9]{10,13}$/;
                if (!phoneRegex.test(recipientPhone)) {
                    EnhancedUIUpdater.showToast('Please enter a valid phone number', 'warning');
                    return;
                }
                
                try {
                    await EnhancedFirebaseManager.broadcastRide(
                        AppState.currentRide.id,
                        [recipientPhone],
                        `Your friend ${AppState.userData.name} has shared their ride details with you.`
                    );
                    
                    hideModal('broadcast');
                    document.getElementById('recipientPhone').value = '';
                } catch (error) {
                    console.error('Broadcast error:', error);
                }
            });
            
            // Add recipient button
            document.getElementById('addRecipientBtn').addEventListener('click', () => {
                const recipientPhone = document.getElementById('recipientPhone').value.trim();
                
                if (!recipientPhone) {
                    EnhancedUIUpdater.showToast('Please enter phone number', 'warning');
                    return;
                }
                
                // Add to recipients list
                AppState.broadcastRecipients.push(recipientPhone);
                updateRecipientsList();
                
                // Clear input
                document.getElementById('recipientPhone').value = '';
            });
            
            // SOS button
            document.getElementById('sosButton').addEventListener('click', () => {
                triggerSOS();
            });
            
            // Emergency service selection
            document.querySelectorAll('.emergency-service').forEach(service => {
                service.addEventListener('click', () => {
                    const type = service.dataset.type;
                    handleEmergencyService(type);
                });
            });
            
            // Emergency reason selection
            document.querySelectorAll('.emergency-reason').forEach(reason => {
                reason.addEventListener('click', () => {
                    // Remove selected from all
                    document.querySelectorAll('.emergency-reason').forEach(r => {
                        r.classList.remove('selected');
                    });
                    
                    // Add selected to clicked
                    reason.classList.add('selected');
                    
                    // Update emergency reason
                    AppState.currentEmergencyReason = reason.dataset.reason;
                    
                    // Show other reason input if selected
                    const otherReasonGroup = document.getElementById('otherEmergencyReason');
                    if (reason.dataset.reason === 'other') {
                        otherReasonGroup.style.display = 'block';
                    } else {
                        otherReasonGroup.style.display = 'none';
                    }
                    
                    // Load emergency services if not already loaded
                    if (AppState.userLocation && AppState.currentCity) {
                        loadEmergencyServicesForType(type);
                    }
                });
            });
            
            // Confirm emergency button
            document.getElementById('confirmEmergencyBtn').addEventListener('click', async () => {
                if (!AppState.currentEmergencyReason) {
                    EnhancedUIUpdater.showToast('Please select an emergency reason', 'warning');
                    return;
                }
                
                const selectedService = document.querySelector('.emergency-service-item.selected');
                if (!selectedService) {
                    EnhancedUIUpdater.showToast('Please select an emergency service', 'warning');
                    return;
                }
                
                const serviceType = selectedService.dataset.service;
                const emergencyDescription = document.getElementById('emergencyDescription').value.trim();
                
                // Get selected service details
                const services = AppState.emergencyLocator.getServicesByType(serviceType);
                const selectedServiceDetails = services[0]; // First is nearest
                
                if (!selectedServiceDetails) {
                    EnhancedUIUpdater.showToast('No emergency service available', 'error');
                    return;
                }
                
                // Prepare emergency ride data
                const rideData = {
                    passengerId: AppState.currentUser.uid,
                    passengerName: AppState.userData.name,
                    passengerPhone: AppState.userData.phone,
                    pickup: AppState.userLocation ? await reverseGeocode(AppState.userLocation.lat, AppState.userLocation.lng) : 'Current Location',
                    pickupDisplay: 'Current Location',
                    destination: selectedServiceDetails.name,
                    destinationDisplay: selectedServiceDetails.name,
                    pickupLat: AppState.userLocation?.lat,
                    pickupLng: AppState.userLocation?.lng,
                    destLat: selectedServiceDetails.lat,
                    destLng: selectedServiceDetails.lng,
                    rideType: 'emergency',
                    emergencyType: serviceType,
                    emergencyReason: AppState.currentEmergencyReason,
                    emergencyDescription: AppState.currentEmergencyReason === 'other' ? emergencyDescription : '',
                    fare: parseFloat(document.getElementById('emergencyTotalFare').textContent.replace('ZMW ', '')),
                    distance: selectedServiceDetails.distance,
                    paymentMethod: 'emergency',
                    status: 'requested'
                };
                
                try {
                    await EnhancedFirebaseManager.requestRide(rideData);
                    hideModal('emergency');
                } catch (error) {
                    EnhancedUIUpdater.showToast('Error requesting emergency ride', 'error');
                }
            });
            
            // Notifications bell
            document.getElementById('notificationBell').addEventListener('click', (e) => {
                e.stopPropagation();
                const panel = document.getElementById('notificationsPanel');
                panel.classList.toggle('active');
            });
            
            // Mark all as read
            document.getElementById('markAllReadBtn').addEventListener('click', async () => {
                await EnhancedFirebaseManager.markAllNotificationsAsRead();
            });
            
            // Close notifications panel when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.notification-bell') && 
                    !e.target.closest('.notifications-panel')) {
                    document.getElementById('notificationsPanel').classList.remove('active');
                }
            });
            
            // Chat functionality
            document.getElementById('openChatBtn').addEventListener('click', () => {
                if (AppState.currentRide?.driverId) {
                    document.getElementById('chatContainer').classList.add('active');
                    EnhancedUIUpdater.clearChatNotification();
                } else {
                    EnhancedUIUpdater.showToast('No driver assigned yet', 'warning');
                }
            });
            
            document.getElementById('chatClose').addEventListener('click', () => {
                document.getElementById('chatContainer').classList.remove('active');
            });
            
            document.getElementById('chatSend').addEventListener('click', async () => {
                const input = document.getElementById('chatInput');
                const message = input.value.trim();
                
                if (message && AppState.currentRide) {
                    try {
                        await EnhancedFirebaseManager.sendChatMessage(AppState.currentRide.id, message, false);
                        input.value = '';
                    } catch (error) {
                        EnhancedUIUpdater.showToast('Error sending message', 'error');
                    }
                }
            });
            
            document.getElementById('chatInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('chatSend').click();
                }
            });
            
            // Modal close buttons
            document.querySelectorAll('.modal-close').forEach(btn => {
                btn.addEventListener('click', () => {
                    const modal = btn.dataset.modal;
                    hideModal(modal);
                });
            });
            
            // Payment method selection
            document.querySelectorAll('.payment-method').forEach(method => {
                method.addEventListener('click', () => {
                    document.querySelectorAll('.payment-method').forEach(m => {
                        m.classList.remove('selected');
                    });
                    method.classList.add('selected');
                });
            });
            
            // Confirm payment button
            document.getElementById('confirmPaymentBtn').addEventListener('click', async () => {
                const selectedMethod = document.querySelector('.payment-method.selected');
                if (!selectedMethod) {
                    EnhancedUIUpdater.showToast('Please select a payment method', 'warning');
                    return;
                }
                
                const paymentMethod = selectedMethod.dataset.payment;
                const amount = parseFloat(document.getElementById('paymentAmount').textContent.replace('ZMW ', ''));
                
                // Check wallet balance if paying with wallet
                if (paymentMethod === 'wallet' && AppState.walletBalance < amount) {
                    EnhancedUIUpdater.showToast('Insufficient wallet balance', 'error');
                    return;
                }
                
                // Prepare ride data
                const rideData = {
                    passengerId: AppState.currentUser.uid,
                    passengerName: AppState.userData.name,
                    passengerPhone: AppState.userData.phone,
                    pickup: AppState.pickup.address,
                    pickupDisplay: AppState.pickup.name,
                    destination: AppState.destination.address,
                    destinationDisplay: AppState.destination.name,
                    pickupLat: AppState.pickup.lat,
                    pickupLng: AppState.pickup.lng,
                    destLat: AppState.destination.lat,
                    destLng: AppState.destination.lng,
                    rideType: AppState.selectedRideType,
                    fare: AppState.rideFare,
                    distance: EnhancedPriceCalculator.calculateDistance(
                        AppState.pickup.lat, AppState.pickup.lng,
                        AppState.destination.lat, AppState.destination.lng
                    ),
                    paymentMethod: paymentMethod,
                    status: 'requested'
                };
                
                try {
                    // If paying with wallet, deduct from balance
                    if (paymentMethod === 'wallet') {
                        const newBalance = AppState.walletBalance - amount;
                        await database.ref(`users/${AppState.currentUser.uid}/walletBalance`).set(newBalance);
                        EnhancedUIUpdater.updateWalletBalance(newBalance);
                    }
                    
                    // Request the ride
                    const rideId = await EnhancedFirebaseManager.requestRide(rideData);
                    
                    hideModal('payment');
                    
                    // Show ride info
                    EnhancedFirebaseManager.showRideInfo({ ...rideData, id: rideId });
                    
                } catch (error) {
                    EnhancedUIUpdater.showToast('Error processing payment', 'error');
                }
            });
            
            // Save SOS button
            document.getElementById('saveSOSBtn').addEventListener('click', async () => {
                const contact1Name = document.getElementById('sosContact1Name').value.trim();
                const contact1Phone = document.getElementById('sosContact1Phone').value.trim();
                const contact2Name = document.getElementById('sosContact2Name').value.trim();
                const contact2Phone = document.getElementById('sosContact2Phone').value.trim();
                const message = document.getElementById('sosMessage').value.trim();
                
                if (!contact1Name || !contact1Phone) {
                    EnhancedUIUpdater.showToast('Please provide primary emergency contact details', 'warning');
                    return;
                }
                
                const config = {
                    contact1Name,
                    contact1Phone,
                    contact2Name: contact2Name || '',
                    contact2Phone: contact2Phone || '',
                    message: message || 'I need help! My current location and ride details will be shared with you.'
                };
                
                await EnhancedFirebaseManager.saveSOSConfig(config);
                hideModal('sos');
            });
            
            // Cancel ride button
            document.getElementById('cancelRideBtn').addEventListener('click', () => {
                if (AppState.currentRide) {
                    showModal('cancel');
                }
            });
            
            // Contact driver button
            document.getElementById('contactDriverBtn').addEventListener('click', () => {
                if (AppState.currentRide?.driverId) {
                    const driverPhone = AppState.selectedVehicle?.phone;
                    if (driverPhone) {
                        window.open(`tel:${driverPhone}`, '_blank');
                    } else {
                        EnhancedUIUpdater.showToast('Driver phone number not available', 'warning');
                    }
                } else {
                    EnhancedUIUpdater.showToast('No driver assigned yet', 'warning');
                }
            });
            
            // Escape key to close modals
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    hideAllModals();
                    EnhancedUIUpdater.hideSearchResults();
                    document.getElementById('notificationsPanel').classList.remove('active');
                }
            });
            
            // Click outside to close modals
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                    }
                });
            });
        }
        
        function handleDropdownAction(action) {
            switch(action) {
                case 'schedule':
                    // Show schedule form
                    document.querySelectorAll('.ride-request-form, .service-form').forEach(form => {
                        form.style.display = 'none';
                    });
                    document.getElementById('scheduleForm').classList.add('active');
                    break;
                    
                case 'someone':
                    // Show order for someone form
                    switchService('someone');
                    break;
                    
                case 'share':
                    // Show share ride form
                    switchService('share');
                    break;
                    
                case 'broadcast':
                    // Show broadcast modal if ride is active
                    if (AppState.currentRide) {
                        showModal('broadcast');
                    } else {
                        EnhancedUIUpdater.showToast('No active ride to broadcast', 'warning');
                    }
                    break;
            }
        }
        
        function switchScreen(screen) {
            // Hide all screens
            document.querySelectorAll('.history-screen, .account-screen, .emergency-screen').forEach(s => {
                s.classList.remove('active');
            });
            
            // Hide notifications panel
            document.getElementById('notificationsPanel').classList.remove('active');
            
            // Update navigation tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected screen
            if (screen === 'home') {
                AppState.activeScreen = 'home';
                document.querySelector(`.nav-tab[data-screen="home"]`).classList.add('active');
            } else {
                document.getElementById(`${screen}Screen`).classList.add('active');
                document.querySelector(`.nav-tab[data-screen="${screen}"]`).classList.add('active');
                AppState.activeScreen = screen;
                
                // Load data for specific screens
                if (screen === 'history') {
                    // Load history data
                } else if (screen === 'account') {
                    // Load account data
                } else if (screen === 'emergency') {
                    // Load emergency services
                }
            }
        }
        
        function switchService(service) {
            // Hide all forms
            document.querySelectorAll('.ride-request-form, .service-form, .schedule-form').forEach(form => {
                form.style.display = 'none';
                form.classList.remove('active');
            });
            
            // Update service tabs
            document.querySelectorAll('.service-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected service form
            AppState.activeService = service;
            
            switch(service) {
                case 'car':
                    document.querySelector('.service-tab.car').classList.add('active');
                    document.getElementById('carForm').style.display = 'block';
                    
                    // Show ride type selection for car service
                    document.getElementById('rideTypeSelection').classList.add('active');
                    break;
                    
                default:
                    // For non-car services, don't show ride type selection
                    document.getElementById('rideTypeSelection').classList.remove('active');
                    
                    // Show the appropriate form
                    const formId = `${service}Form`;
                    const form = document.getElementById(formId);
                    if (form) {
                        form.style.display = 'block';
                        form.classList.add('active');
                        
                        // Update service tab
                        const tab = document.querySelector(`.service-tab[data-service="${service}"]`);
                        if (tab) tab.classList.add('active');
                    }
                    break;
            }
        }
        
        function togglePanel() {
            const panel = document.getElementById('mainPanel');
            panel.classList.toggle('collapsed');
        }
        
        function showModal(modalId) {
            document.getElementById(`${modalId}Modal`).classList.add('active');
        }
        
        function hideModal(modalId) {
            document.getElementById(`${modalId}Modal`).classList.remove('active');
        }
        
        function hideAllModals() {
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.classList.remove('active');
            });
        }
        
        function updateRecipientsList() {
            const container = document.getElementById('recipientsList');
            if (!container) return;
            
            container.innerHTML = '';
            
            AppState.broadcastRecipients.forEach((phone, index) => {
                const chip = document.createElement('div');
                chip.style.display = 'inline-flex';
                chip.style.alignItems = 'center';
                chip.style.gap = '4px';
                chip.style.background = 'var(--light-orange)';
                chip.style.padding = '4px 8px';
                chip.style.borderRadius = '12px';
                chip.style.margin = '2px';
                chip.style.fontSize = '12px';
                
                chip.innerHTML = `
                    <span>${phone}</span>
                    <button class="remove-recipient" data-index="${index}" style="background: none; border: none; color: var(--error-red); cursor: pointer;">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                container.appendChild(chip);
            });
            
            // Add event listeners to remove buttons
            container.querySelectorAll('.remove-recipient').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    AppState.broadcastRecipients.splice(index, 1);
                    updateRecipientsList();
                });
            });
        }
        
        async function handleEmergencyService(type) {
            if (!AppState.userLocation) {
                EnhancedUIUpdater.showToast('Please allow location access for emergency services', 'warning');
                return;
            }
            
            // Show emergency modal
            showModal('emergency');
            
            // Load emergency services for the selected type
            await loadEmergencyServicesForType(type);
            
            // Show emergency markers on map
            AppState.emergencyLocator.showEmergencyMarkers(type);
        }
        
        async function loadEmergencyServicesForType(type) {
            if (AppState.userLocation && AppState.currentCity) {
                // Load services for the type
                const services = AppState.emergencyLocator.getServicesByType(type);
                
                if (services.length > 0) {
                    EnhancedUIUpdater.updateEmergencyServices(services);
                } else {
                    // Load from database if not cached
                    await AppState.emergencyLocator.loadServicesForCity(AppState.currentCity);
                    const updatedServices = AppState.emergencyLocator.getServicesByType(type);
                    EnhancedUIUpdater.updateEmergencyServices(updatedServices);
                }
            }
        }
        
        async function triggerSOS() {
            if (!AppState.sosConfig) {
                EnhancedUIUpdater.showToast('Please setup SOS contacts first', 'warning');
                showModal('sos');
                return;
            }
            
            if (!AppState.currentRide) {
                EnhancedUIUpdater.showToast('No active ride to report SOS for', 'warning');
                return;
            }
            
            if (!confirm('Are you sure you want to send an SOS alert to your emergency contacts?')) {
                return;
            }
            
            const sosData = {
                passengerId: AppState.currentUser.uid,
                passengerName: AppState.userData.name,
                passengerPhone: AppState.userData.phone,
                emergencyContact1: AppState.sosConfig.contact1Phone,
                emergencyContact1Name: AppState.sosConfig.contact1Name,
                emergencyContact2: AppState.sosConfig.contact2Phone,
                emergencyContact2Name: AppState.sosConfig.contact2Name,
                message: AppState.sosConfig.message,
                rideId: AppState.currentRide.id,
                location: AppState.userLocation,
                timestamp: Date.now()
            };
            
            EnhancedFirebaseManager.sendSOSAlert(AppState.currentRide.id, sosData)
                .then(() => {
                    EnhancedUIUpdater.showToast('SOS alert sent to emergency contacts', 'success');
                })
                .catch(error => {
                    console.error('SOS error:', error);
                    EnhancedUIUpdater.showToast('Error sending SOS alert', 'error');
                });
        }

        // ============================================
        // START THE APPLICATION
        // ============================================
        window.addEventListener('load', initializeApp);
    </script>
</body>
</html>
