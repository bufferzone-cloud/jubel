<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jubel Passenger App</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root {
            --primary-orange: #FF6B35;
            --primary-red: #E74C3C;
            --primary-gradient: linear-gradient(135deg, #FF6B35, #E74C3C);
            --secondary-orange: #E55A28;
            --secondary-red: #C0392B;
            --light-orange: #FFF5F0;
            --light-red: #FCE8E6;
            --white: #FFFFFF;
            --off-white: #F9F9F9;
            --light-gray: #F5F5F5;
            --medium-gray: #E0E0E0;
            --dark-gray: #333333;
            --text-gray: #666666;
            --text-light: #888888;
            --success-green: #2ECC71;
            --warning-yellow: #F39C12;
            --info-blue: #3498DB;
            --error-red: #E74C3C;
            --border-color: #EEEEEE;
            --shadow-light: 0 1px 6px rgba(0, 0, 0, 0.08);
            --shadow-medium: 0 2px 12px rgba(0, 0, 0, 0.12);
            --shadow-heavy: 0 4px 20px rgba(0, 0, 0, 0.15);
            --app-padding: 12px;
            --element-radius: 12px;
            --button-radius: 20px;
            --card-radius: 16px;
            --transition-speed: 0.25s;
            --ambulance-blue: #2980B9;
            --fire-truck-red: #C0392B;
            --police-blue: #2C3E50;
            --premium-gold: #FFD700;
            --economy-green: #27AE60;
            --light-truck-brown: #8B4513;
            --delivery-purple: #8E44AD;
            --express-shop-green: #16A085;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }
        
        body {
            background-color: var(--off-white);
            color: var(--dark-gray);
            max-width: 100%;
            overflow-x: hidden;
            height: 100vh;
            font-size: 13px;
            line-height: 1.4;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Map Container */
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 55%;
            z-index: 1;
            background: #f8f9fa;
        }
        
        /* Top Bar Components */
        .top-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 200;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px var(--app-padding);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            height: 56px;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .logo-icon {
            width: 32px;
            height: 32px;
            background: var(--primary-gradient);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-weight: 700;
            font-size: 14px;
            overflow: hidden;
        }
        
        .logo-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .logo-text {
            font-size: 14px;
            font-weight: 700;
            color: var(--dark-gray);
            line-height: 1.2;
        }
        
        .user-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .balance-badge {
            background: var(--white);
            padding: 6px 12px;
            border-radius: var(--button-radius);
            box-shadow: var(--shadow-light);
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 600;
            color: var(--dark-gray);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .balance-badge:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }
        
        .balance-amount {
            color: var(--primary-orange);
            font-weight: 700;
            font-size: 13px;
        }
        
        .notification-bell {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
            cursor: pointer;
            position: relative;
            transition: all var(--transition-speed) ease;
        }
        
        .notification-bell:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }
        
        .notification-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            width: 16px;
            height: 16px;
            background: var(--error-red);
            color: var(--white);
            border-radius: 50%;
            font-size: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            border: 2px solid var(--white);
        }
        
        /* Ride Status Bar */
        .ride-status-bar {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 150;
            display: none;
            background: var(--white);
            padding: 8px 16px;
            border-radius: var(--button-radius);
            box-shadow: var(--shadow-heavy);
            border: 1px solid var(--border-color);
            align-items: center;
            gap: 10px;
            min-width: 280px;
            max-width: 90%;
        }
        
        .ride-status-bar.active {
            display: flex;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                transform: translateX(-50%) translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--warning-yellow);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.1); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        .status-dot.searching { background: var(--warning-yellow); }
        .status-dot.arriving { background: var(--info-blue); }
        .status-dot.riding { background: var(--success-green); animation: none; }
        
        .status-text {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
        }
        
        .status-eta {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--text-gray);
            font-size: 12px;
            font-weight: 500;
        }
        
        /* Emergency Status */
        .emergency-status {
            position: absolute;
            top: 60px;
            right: var(--app-padding);
            z-index: 150;
            background: linear-gradient(135deg, var(--error-red), #C0392B);
            color: var(--white);
            padding: 8px 14px;
            border-radius: var(--button-radius);
            box-shadow: var(--shadow-heavy);
            display: none;
            align-items: center;
            gap: 6px;
            font-weight: 700;
            font-size: 12px;
            animation: emergencyPulse 1s infinite;
        }
        
        @keyframes emergencyPulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
            70% { transform: scale(1.02); box-shadow: 0 0 0 8px rgba(231, 76, 60, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
        }
        
        /* SOS Button */
        .sos-button {
            position: absolute;
            bottom: 160px;
            right: var(--app-padding);
            z-index: 150;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--error-red), #C0392B);
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 14px;
            font-weight: 700;
            box-shadow: var(--shadow-heavy);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            animation: sosPulse 2s infinite;
        }
        
        .sos-button:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(231, 76, 60, 0.4);
        }
        
        @keyframes sosPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* Main Panel */
        .main-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            border-radius: var(--card-radius) var(--card-radius) 0 0;
            box-shadow: 0 -4px 30px rgba(0, 0, 0, 0.1);
            z-index: 100;
            padding: var(--app-padding);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 45vh;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-orange) var(--light-gray);
        }
        
        .main-panel::-webkit-scrollbar {
            width: 4px;
        }
        
        .main-panel::-webkit-scrollbar-track {
            background: var(--light-gray);
            border-radius: 2px;
        }
        
        .main-panel::-webkit-scrollbar-thumb {
            background: var(--primary-orange);
            border-radius: 2px;
        }
        
        .main-panel.collapsed {
            transform: translateY(calc(100% - 48px));
        }
        
        .panel-handle {
            width: 36px;
            height: 3px;
            background: var(--medium-gray);
            border-radius: 2px;
            margin: 0 auto 12px;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .panel-handle:hover {
            background: var(--primary-orange);
            width: 48px;
        }
        
        /* Navigation Tabs */
        .nav-tabs {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            margin-bottom: 12px;
            padding: 4px;
            background: var(--light-gray);
            border-radius: var(--button-radius);
        }
        
        .nav-tab {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 10px 6px;
            border-radius: calc(var(--button-radius) - 4px);
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            color: var(--text-gray);
            font-size: 11px;
            font-weight: 600;
        }
        
        .nav-tab i {
            font-size: 16px;
            transition: all var(--transition-speed) ease;
        }
        
        .nav-tab.active {
            background: var(--white);
            color: var(--primary-orange);
            box-shadow: var(--shadow-light);
        }
        
        .nav-tab.active i {
            color: var(--primary-orange);
            transform: translateY(-2px);
        }
        
        .nav-tab:hover:not(.active) {
            background: rgba(255, 107, 53, 0.1);
            color: var(--primary-orange);
        }
        
        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .quick-action-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            text-align: left;
        }
        
        .quick-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
            border-color: var(--primary-orange);
        }
        
        .quick-action-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: var(--light-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-orange);
            font-size: 16px;
        }
        
        .quick-action-text {
            flex: 1;
        }
        
        .quick-action-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
            margin-bottom: 2px;
        }
        
        .quick-action-desc {
            font-size: 11px;
            color: var(--text-light);
        }
        
        /* Service Tabs */
        .service-tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 16px;
            overflow-x: auto;
            padding-bottom: 4px;
        }
        
        .service-tabs::-webkit-scrollbar {
            display: none;
        }
        
        .service-tab {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 12px 16px;
            background: var(--white);
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            min-width: 100px;
            text-align: center;
            flex-shrink: 0;
        }
        
        .service-tab:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .service-tab.active {
            border-color: var(--primary-orange);
            background: var(--light-orange);
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
        }
        
        .service-tab.car.active { border-color: var(--primary-orange); }
        .service-tab.delivery.active { border-color: var(--delivery-purple); background: #F4E6FA; }
        .service-tab.short-delivery.active { border-color: var(--express-shop-green); background: #E1F5FE; }
        
        .service-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--text-gray);
            transition: all var(--transition-speed) ease;
        }
        
        .service-tab.active .service-icon {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .service-tab.delivery.active .service-icon {
            background: var(--delivery-purple);
        }
        
        .service-tab.short-delivery.active .service-icon {
            background: var(--express-shop-green);
        }
        
        .service-name {
            font-weight: 600;
            font-size: 12px;
            color: var(--dark-gray);
        }
        
        .service-desc {
            font-size: 10px;
            color: var(--text-light);
            margin-top: 2px;
        }
        
        /* Ride Request Form */
        .ride-request-form {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }
        
        .form-title {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--dark-gray);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .location-inputs {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .location-input {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: var(--off-white);
            border: 2px solid transparent;
            border-radius: var(--element-radius);
            transition: all var(--transition-speed) ease;
            position: relative;
        }
        
        .location-input.active {
            border-color: var(--primary-orange);
            background: var(--white);
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
        }
        
        .location-input i {
            color: var(--primary-orange);
            font-size: 14px;
            width: 18px;
            text-align: center;
        }
        
        .location-input input {
            flex: 1;
            border: none;
            background: transparent;
            outline: none;
            font-size: 13px;
            color: var(--dark-gray);
            font-weight: 500;
        }
        
        .location-input input::placeholder {
            color: var(--text-light);
        }
        
        .suggestion-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 1000;
            max-height: 250px;
            overflow-y: auto;
            display: none;
            margin-top: 4px;
        }
        
        .suggestion-list.active {
            display: block;
            animation: fadeIn 0.2s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .suggestion-item {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        .suggestion-item:hover {
            background: var(--light-orange);
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
        
        .suggestion-icon {
            color: var(--primary-orange);
            font-size: 12px;
            margin-top: 2px;
        }
        
        .suggestion-details {
            flex: 1;
        }
        
        .suggestion-name {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
            margin-bottom: 2px;
        }
        
        .suggestion-address {
            font-size: 11px;
            color: var(--text-gray);
            line-height: 1.3;
        }
        
        .suggestion-distance {
            font-size: 10px;
            color: var(--text-light);
            margin-top: 2px;
        }
        
        /* Ride Type Selection */
        .ride-type-selection {
            margin: 16px 0;
            display: none;
        }
        
        .ride-type-selection.active {
            display: block;
            animation: fadeInUp 0.3s ease;
        }
        
        .ride-type-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--dark-gray);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .ride-type-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        
        .ride-type-card {
            background: var(--white);
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            padding: 14px 10px;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .ride-type-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .ride-type-card.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
        }
        
        .ride-type-card.economy.selected {
            border-color: var(--economy-green);
            background: #E8F6EF;
        }
        
        .ride-type-card.premium.selected {
            border-color: var(--premium-gold);
            background: #FFF9E6;
        }
        
        .ride-type-icon {
            width: 42px;
            height: 42px;
            border-radius: 10px;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 8px;
            font-size: 18px;
            color: var(--text-gray);
            transition: all var(--transition-speed) ease;
        }
        
        .ride-type-card.selected .ride-type-icon {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .ride-type-card.economy.selected .ride-type-icon {
            background: var(--economy-green);
        }
        
        .ride-type-card.premium.selected .ride-type-icon {
            background: var(--premium-gold);
            color: var(--dark-gray);
        }
        
        .ride-type-name {
            font-weight: 600;
            font-size: 12px;
            color: var(--dark-gray);
            margin-bottom: 2px;
        }
        
        .ride-type-price {
            font-size: 14px;
            font-weight: 700;
            color: var(--primary-orange);
            margin-bottom: 2px;
        }
        
        .ride-type-card.economy .ride-type-price {
            color: var(--economy-green);
        }
        
        .ride-type-card.premium .ride-type-price {
            color: #B8860B;
        }
        
        .ride-type-eta {
            font-size: 10px;
            color: var(--text-light);
        }
        
        /* Fare Display */
        .fare-display {
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            padding: 16px;
            border-radius: var(--element-radius);
            margin: 16px 0;
            text-align: center;
            box-shadow: var(--shadow-medium);
            display: none;
        }
        
        .fare-display.active {
            display: block;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fare-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 2px;
        }
        
        .fare-amount {
            font-size: 26px;
            font-weight: 800;
            margin: 6px 0;
        }
        
        .fare-details {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 11px;
            opacity: 0.9;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-top: 16px;
        }
        
        .btn {
            padding: 14px;
            border: none;
            border-radius: var(--button-radius);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            box-shadow: 0 3px 12px rgba(255, 107, 53, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 16px rgba(255, 107, 53, 0.4);
        }
        
        .btn-secondary {
            background: var(--white);
            color: var(--primary-orange);
            border: 2px solid var(--primary-orange);
        }
        
        .btn-secondary:hover {
            background: var(--light-orange);
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--error-red), #C0392B);
            color: var(--white);
            box-shadow: 0 3px 12px rgba(231, 76, 60, 0.3);
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 16px rgba(231, 76, 60, 0.4);
        }
        
        /* Ride Info Panel */
        .ride-info-panel {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-medium);
            border: 1px solid var(--border-color);
            display: none;
        }
        
        .ride-info-panel.active {
            display: block;
            animation: fadeInUp 0.3s ease;
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .driver-info {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .driver-avatar {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--white);
            font-weight: 700;
            overflow: hidden;
        }
        
        .driver-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .driver-details {
            flex: 1;
        }
        
        .driver-name {
            font-size: 14px;
            font-weight: 700;
            color: var(--dark-gray);
            margin-bottom: 2px;
        }
        
        .driver-rating {
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--warning-yellow);
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 12px;
        }
        
        .driver-vehicle {
            font-size: 12px;
            color: var(--text-gray);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .vehicle-image {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            overflow: hidden;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .vehicle-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .trip-details {
            margin-bottom: 16px;
        }
        
        .trip-locations {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .location-point {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        .location-marker {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            color: var(--white);
            font-size: 11px;
        }
        
        .location-marker.pickup {
            background: var(--primary-orange);
        }
        
        .location-marker.destination {
            background: var(--primary-red);
        }
        
        .location-text {
            flex: 1;
        }
        
        .location-label {
            font-size: 11px;
            color: var(--text-light);
            margin-bottom: 2px;
            font-weight: 600;
        }
        
        .location-address {
            font-size: 13px;
            color: var(--dark-gray);
            font-weight: 500;
            line-height: 1.3;
        }
        
        .fare-breakdown {
            background: var(--off-white);
            border-radius: var(--element-radius);
            padding: 14px;
            margin-bottom: 16px;
        }
        
        .fare-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .fare-row:last-child {
            border-bottom: none;
        }
        
        .fare-label {
            font-size: 13px;
            color: var(--text-gray);
        }
        
        .fare-value {
            font-size: 13px;
            font-weight: 600;
            color: var(--dark-gray);
        }
        
        .fare-row.total {
            margin-top: 6px;
            padding-top: 10px;
            border-top: 2px solid var(--border-color);
        }
        
        .fare-row.total .fare-label {
            font-size: 14px;
            font-weight: 700;
            color: var(--dark-gray);
        }
        
        .fare-row.total .fare-value {
            font-size: 18px;
            font-weight: 800;
            color: var(--primary-orange);
        }
        
        /* Chat System */
        .chat-container {
            position: absolute;
            bottom: 200px;
            right: var(--app-padding);
            z-index: 300;
            width: 320px;
            max-width: calc(100vw - 40px);
            background: var(--white);
            border-radius: var(--card-radius);
            box-shadow: var(--shadow-heavy);
            display: none;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        
        .chat-container.active {
            display: flex;
            animation: chatSlideUp 0.3s ease;
        }
        
        @keyframes chatSlideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .chat-header {
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            padding: 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .chat-title {
            font-weight: 600;
            font-size: 13px;
        }
        
        .chat-close {
            background: none;
            border: none;
            color: var(--white);
            font-size: 16px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all var(--transition-speed) ease;
        }
        
        .chat-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .chat-messages {
            flex: 1;
            padding: 14px;
            max-height: 250px;
            overflow-y: auto;
            background: var(--off-white);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .message {
            max-width: 80%;
            padding: 8px 12px;
            border-radius: 16px;
            font-size: 13px;
            line-height: 1.3;
        }
        
        .message.sent {
            align-self: flex-end;
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            border-bottom-right-radius: 4px;
        }
        
        .message.received {
            align-self: flex-start;
            background: var(--white);
            color: var(--dark-gray);
            border: 1px solid var(--border-color);
            border-bottom-left-radius: 4px;
        }
        
        .message-time {
            font-size: 10px;
            color: var(--text-light);
            margin-top: 2px;
            text-align: right;
        }
        
        .message.received .message-time {
            color: var(--text-gray);
        }
        
        .chat-input-container {
            padding: 14px;
            background: var(--white);
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 8px;
        }
        
        .chat-input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid var(--border-color);
            border-radius: var(--button-radius);
            font-size: 13px;
            outline: none;
            transition: all var(--transition-speed) ease;
        }
        
        .chat-input:focus {
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
        }
        
        .chat-send-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-speed) ease;
        }
        
        .chat-send-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 3px 10px rgba(255, 107, 53, 0.3);
        }
        
        .chat-notification {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 18px;
            height: 18px;
            background: var(--error-red);
            color: var(--white);
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            animation: bounce 1s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        
        /* Modal System */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
            backdrop-filter: blur(4px);
        }
        
        .modal-overlay.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        
        .modal {
            background: var(--white);
            border-radius: var(--card-radius);
            box-shadow: var(--shadow-heavy);
            max-width: 450px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            animation: modalSlideUp 0.3s ease;
        }
        
        @keyframes modalSlideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--dark-gray);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--text-light);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all var(--transition-speed) ease;
        }
        
        .modal-close:hover {
            color: var(--error-red);
            background: var(--light-red);
        }
        
        .modal-content {
            padding: 20px;
        }
        
        /* History Screen */
        .history-screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--white);
            z-index: 200;
            display: none;
            flex-direction: column;
            padding-top: 56px;
        }
        
        .history-screen.active {
            display: flex;
            animation: slideInRight 0.3s ease;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        .screen-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: var(--white);
            padding: 14px var(--app-padding);
            border-bottom: 1px solid var(--border-color);
            z-index: 10;
            display: flex;
            align-items: center;
            gap: 14px;
        }
        
        .back-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--dark-gray);
            border: none;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .back-btn:hover {
            background: var(--medium-gray);
            transform: translateX(-2px);
        }
        
        .screen-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--dark-gray);
        }
        
        .history-filters {
            padding: 14px var(--app-padding);
            background: var(--off-white);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 8px;
            overflow-x: auto;
            scrollbar-width: none;
        }
        
        .history-filters::-webkit-scrollbar {
            display: none;
        }
        
        .filter-btn {
            padding: 6px 14px;
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--button-radius);
            font-size: 12px;
            font-weight: 600;
            color: var(--text-gray);
            cursor: pointer;
            white-space: nowrap;
            transition: all var(--transition-speed) ease;
        }
        
        .filter-btn.active {
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            border-color: transparent;
        }
        
        .filter-btn:hover:not(.active) {
            border-color: var(--primary-orange);
            color: var(--primary-orange);
        }
        
        .history-list {
            flex: 1;
            overflow-y: auto;
            padding: 14px var(--app-padding);
        }
        
        .history-item {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 16px;
            margin-bottom: 10px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .history-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
            border-color: var(--primary-orange);
        }
        
        .history-item.expanded {
            margin-bottom: 16px;
        }
        
        .history-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .history-type {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .history-icon {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            background: var(--light-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-orange);
        }
        
        .history-type-name {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
        }
        
        .history-date {
            font-size: 12px;
            color: var(--text-light);
        }
        
        .history-status {
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-completed {
            background: #E8F6EF;
            color: var(--economy-green);
        }
        
        .status-cancelled {
            background: var(--light-red);
            color: var(--error-red);
        }
        
        .status-ongoing {
            background: #E3F2FD;
            color: var(--info-blue);
        }
        
        .history-locations {
            margin-bottom: 10px;
        }
        
        .history-location {
            display: flex;
            align-items: flex-start;
            gap: 6px;
            margin-bottom: 6px;
        }
        
        .history-location i {
            color: var(--text-light);
            margin-top: 2px;
        }
        
        .history-location-text {
            font-size: 12px;
            color: var(--text-gray);
            line-height: 1.3;
        }
        
        .history-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
        }
        
        .history-price {
            font-size: 14px;
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        .history-driver {
            font-size: 12px;
            color: var(--text-gray);
        }
        
        .history-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .history-item.expanded .history-details {
            max-height: 400px;
            margin-top: 14px;
            padding-top: 14px;
            border-top: 1px solid var(--border-color);
        }
        
        .detail-section {
            margin-bottom: 14px;
        }
        
        .detail-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--dark-gray);
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .detail-label {
            font-size: 11px;
            color: var(--text-light);
            font-weight: 500;
        }
        
        .detail-value {
            font-size: 13px;
            color: var(--dark-gray);
            font-weight: 500;
        }
        
        /* Account Screen */
        .account-screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--white);
            z-index: 200;
            display: none;
            flex-direction: column;
            padding-top: 56px;
        }
        
        .account-screen.active {
            display: flex;
        }
        
        .account-header {
            padding: 20px var(--app-padding);
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            text-align: center;
        }
        
        .account-avatar {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            margin: 0 auto 14px;
            border: 3px solid rgba(255, 255, 255, 0.3);
        }
        
        .account-name {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 2px;
        }
        
        .account-phone {
            font-size: 13px;
            opacity: 0.9;
        }
        
        .account-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            padding: 16px var(--app-padding);
            background: var(--white);
        }
        
        .stat-card {
            background: var(--off-white);
            border-radius: var(--element-radius);
            padding: 14px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary-orange);
            margin-bottom: 2px;
        }
        
        .stat-label {
            font-size: 11px;
            color: var(--text-gray);
            font-weight: 500;
        }
        
        .account-section {
            padding: 16px var(--app-padding);
            border-bottom: 1px solid var(--border-color);
        }
        
        .section-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--dark-gray);
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .wallet-balance {
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            padding: 20px;
            border-radius: var(--element-radius);
            text-align: center;
            margin-bottom: 16px;
        }
        
        .balance-label {
            font-size: 13px;
            opacity: 0.9;
            margin-bottom: 6px;
        }
        
        .balance-amount-large {
            font-size: 30px;
            font-weight: 800;
            margin-bottom: 2px;
        }
        
        .wallet-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 14px;
        }
        
        .btn-wallet {
            padding: 10px;
            border: 2px solid var(--primary-orange);
            background: var(--white);
            color: var(--primary-orange);
            border-radius: var(--button-radius);
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .btn-wallet:hover {
            background: var(--primary-orange);
            color: var(--white);
            transform: translateY(-2px);
        }
        
        .referral-card {
            background: var(--light-orange);
            border-radius: var(--element-radius);
            padding: 16px;
            text-align: center;
            margin-top: 14px;
        }
        
        .referral-code {
            background: var(--white);
            padding: 14px;
            border-radius: var(--element-radius);
            margin: 14px 0;
            font-family: monospace;
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-orange);
            letter-spacing: 2px;
        }
        
        .referral-note {
            font-size: 11px;
            color: var(--text-gray);
            margin-top: 6px;
        }
        
        /* Emergency Screen */
        .emergency-screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--white);
            z-index: 200;
            display: none;
            flex-direction: column;
            padding-top: 56px;
        }
        
        .emergency-screen.active {
            display: flex;
        }
        
        .emergency-services {
            padding: 16px var(--app-padding);
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .emergency-service {
            background: var(--white);
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .emergency-service:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-medium);
        }
        
        .emergency-service.police {
            border-color: var(--police-blue);
        }
        
        .emergency-service.police:hover {
            border-color: var(--police-blue);
            box-shadow: 0 6px 20px rgba(44, 62, 80, 0.2);
        }
        
        .emergency-service.fire {
            border-color: var(--fire-truck-red);
        }
        
        .emergency-service.fire:hover {
            border-color: var(--fire-truck-red);
            box-shadow: 0 6px 20px rgba(192, 57, 43, 0.2);
        }
        
        .emergency-service.medical {
            border-color: var(--ambulance-blue);
        }
        
        .emergency-service.medical:hover {
            border-color: var(--ambulance-blue);
            box-shadow: 0 6px 20px rgba(41, 128, 185, 0.2);
        }
        
        .emergency-icon {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin: 0 auto 10px;
            color: var(--white);
        }
        
        .emergency-service.police .emergency-icon {
            background: var(--police-blue);
        }
        
        .emergency-service.fire .emergency-icon {
            background: var(--fire-truck-red);
        }
        
        .emergency-service.medical .emergency-icon {
            background: var(--ambulance-blue);
        }
        
        .emergency-name {
            font-size: 14px;
            font-weight: 700;
            color: var(--dark-gray);
            margin-bottom: 6px;
        }
        
        .emergency-description {
            font-size: 12px;
            color: var(--text-gray);
            line-height: 1.3;
        }
        
        .emergency-note {
            padding: 16px var(--app-padding);
            background: var(--light-red);
            margin: 16px var(--app-padding);
            border-radius: var(--element-radius);
            border-left: 3px solid var(--error-red);
        }
        
        .emergency-note p {
            font-size: 12px;
            color: var(--dark-gray);
            line-height: 1.4;
        }
        
        /* Loading States */
        .loading {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid var(--light-gray);
            border-radius: 50%;
            border-top-color: var(--primary-orange);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            z-index: 10000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
        }
        
        .loading-overlay.active {
            display: flex;
        }
        
        .loading-spinner {
            width: 52px;
            height: 52px;
            border: 4px solid var(--light-gray);
            border-radius: 50%;
            border-top-color: var(--primary-orange);
            animation: spin 1s linear infinite;
        }
        
        .loading-text {
            font-size: 14px;
            font-weight: 600;
            color: var(--dark-gray);
        }
        
        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 90px;
            right: var(--app-padding);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-width: 350px;
        }
        
        .toast {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 14px;
            box-shadow: var(--shadow-heavy);
            border-left: 3px solid var(--primary-orange);
            display: flex;
            align-items: flex-start;
            gap: 10px;
            animation: slideInRight 0.3s ease;
            transform: translateX(0);
            transition: transform 0.3s ease;
        }
        
        .toast.hiding {
            transform: translateX(100%);
        }
        
        .toast-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--light-orange);
            color: var(--primary-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
            margin-bottom: 2px;
        }
        
        .toast-message {
            font-size: 12px;
            color: var(--text-gray);
            line-height: 1.3;
        }
        
        .toast-close {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 16px;
            cursor: pointer;
            padding: 2px;
            border-radius: 4px;
            transition: all var(--transition-speed) ease;
        }
        
        .toast-close:hover {
            color: var(--error-red);
            background: var(--light-red);
        }
        
        .toast.success {
            border-left-color: var(--success-green);
        }
        
        .toast.success .toast-icon {
            background: #E8F6EF;
            color: var(--success-green);
        }
        
        .toast.error {
            border-left-color: var(--error-red);
        }
        
        .toast.error .toast-icon {
            background: var(--light-red);
            color: var(--error-red);
        }
        
        .toast.warning {
            border-left-color: var(--warning-yellow);
        }
        
        .toast.warning .toast-icon {
            background: #FFF3E0;
            color: var(--warning-yellow);
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            :root {
                --app-padding: 10px;
                --element-radius: 10px;
                --button-radius: 16px;
            }
            
            .quick-actions {
                grid-template-columns: 1fr;
            }
            
            .ride-type-grid {
                grid-template-columns: 1fr;
            }
            
            .emergency-services {
                grid-template-columns: 1fr;
            }
            
            .chat-container {
                width: calc(100vw - 20px);
                right: 10px;
            }
            
            .detail-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 480px) {
            .nav-tabs {
                gap: 4px;
            }
            
            .nav-tab {
                padding: 8px 4px;
                font-size: 10px;
            }
            
            .nav-tab i {
                font-size: 14px;
            }
            
            .balance-badge {
                padding: 5px 8px;
                font-size: 12px;
            }
            
            .service-tab {
                min-width: 85px;
                padding: 10px 12px;
            }
        }
        
        /* Custom Markers */
        .current-location-marker {
            background: var(--info-blue);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            box-shadow: 0 1px 8px rgba(0,0,0,0.3);
            border: 2px solid white;
        }
        
        .pickup-marker {
            background: var(--primary-orange);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            box-shadow: 0 1px 8px rgba(0,0,0,0.3);
            border: 2px solid white;
        }
        
        .destination-marker {
            background: var(--primary-red);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            box-shadow: 0 1px 8px rgba(0,0,0,0.3);
            border: 2px solid white;
        }
        
        .driver-marker {
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: white;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            box-shadow: 0 1px 8px rgba(0,0,0,0.3);
            border: 2px solid white;
            animation: pulse 2s infinite;
        }
        
        .emergency-vehicle-marker {
            background: var(--error-red);
            color: white;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            box-shadow: 0 1px 8px rgba(0,0,0,0.3);
            border: 2px solid white;
            animation: emergencyPulse 1s infinite;
        }
        
        /* Enhanced Form Elements */
        .form-group {
            margin-bottom: 14px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 13px;
            color: var(--dark-gray);
            background: var(--white);
            transition: all var(--transition-speed) ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
        }
        
        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        /* Search Loading Indicator */
        .search-loading {
            display: none;
            position: absolute;
            top: 50%;
            right: 12px;
            transform: translateY(-50%);
            width: 14px;
            height: 14px;
            border: 2px solid var(--light-gray);
            border-radius: 50%;
            border-top-color: var(--primary-orange);
            animation: spin 0.6s linear infinite;
        }
        
        .location-input.searching .search-loading {
            display: block;
        }
        
        /* No Results Message */
        .no-results {
            padding: 30px 16px;
            text-align: center;
            color: var(--text-light);
            font-size: 13px;
        }
        
        .no-results i {
            font-size: 28px;
            margin-bottom: 10px;
            opacity: 0.5;
        }
        
        /* Price Calculation Display */
        .price-calculation {
            background: var(--off-white);
            border-radius: var(--element-radius);
            padding: 14px;
            margin: 14px 0;
            font-size: 12px;
            color: var(--text-gray);
        }
        
        .calculation-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }
        
        .calculation-row:last-child {
            margin-bottom: 0;
            padding-top: 6px;
            border-top: 1px solid var(--border-color);
            font-weight: 600;
            color: var(--dark-gray);
        }
        
        /* Cancel Reasons Modal */
        .cancel-reasons {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-bottom: 16px;
        }
        
        .cancel-reason {
            padding: 14px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .cancel-reason:hover {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .cancel-reason.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .reason-icon {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-gray);
        }
        
        .cancel-reason.selected .reason-icon {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .reason-text {
            flex: 1;
            font-weight: 500;
            color: var(--dark-gray);
        }
        
        /* Schedule Ride Form */
        .schedule-form {
            display: none;
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }
        
        .schedule-form.active {
            display: block;
        }
        
        .schedule-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 14px;
        }
        
        /* More Options */
        .more-options {
            display: none;
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }
        
        .more-options.active {
            display: block;
        }
        
        .options-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .option-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 14px;
            background: var(--off-white);
            border: 2px solid transparent;
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .option-btn:hover {
            border-color: var(--primary-orange);
            background: var(--white);
            transform: translateY(-2px);
        }
        
        .option-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: var(--light-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-orange);
            font-size: 16px;
        }
        
        .option-name {
            font-weight: 600;
            font-size: 12px;
            color: var(--dark-gray);
            text-align: center;
        }
        
        /* Empty States */
        .empty-state {
            padding: 50px 16px;
            text-align: center;
            color: var(--text-light);
        }
        
        .empty-icon {
            font-size: 40px;
            margin-bottom: 14px;
            opacity: 0.3;
        }
        
        .empty-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text-gray);
        }
        
        .empty-message {
            font-size: 13px;
            margin-bottom: 16px;
            line-height: 1.4;
        }
        
        /* Service Forms */
        .service-form {
            display: none;
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }
        
        .service-form.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        /* Truck Delivery Form */
        .truck-form {
            border-color: var(--light-truck-brown);
        }
        
        .truck-form .form-title {
            color: var(--light-truck-brown);
        }
        
        /* Delivery Form */
        .delivery-form {
            border-color: var(--delivery-purple);
        }
        
        .delivery-form .form-title {
            color: var(--delivery-purple);
        }
        
        /* Express Shopping Form */
        .express-form {
            border-color: var(--express-shop-green);
        }
        
        .express-form .form-title {
            color: var(--express-shop-green);
        }
        
        /* Order for Someone Else Form */
        .someone-else-form {
            border-color: var(--info-blue);
        }
        
        .someone-else-form .form-title {
            color: var(--info-blue);
        }
        
        /* Ride Sharing Form */
        .share-ride-form {
            border-color: var(--warning-yellow);
        }
        
        .share-ride-form .form-title {
            color: var(--warning-yellow);
        }
        
        /* Payment Selection Styles */
        .payment-methods {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin: 16px 0;
        }
        
        .payment-method {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .payment-method:hover {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .payment-method.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .payment-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-gray);
        }
        
        .payment-method.selected .payment-icon {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .payment-details {
            flex: 1;
        }
        
        .payment-name {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
        }
        
        .payment-info {
            font-size: 11px;
            color: var(--text-gray);
            margin-top: 2px;
        }
        
        /* Wallet Transfer Form */
        .transfer-form {
            display: none;
        }
        
        .transfer-form.active {
            display: block;
        }
        
        /* Timeline */
        .timeline {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 16px 0;
            padding: 0 20px;
            position: relative;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            top: 12px;
            left: 10%;
            right: 10%;
            height: 2px;
            background: var(--border-color);
            z-index: 1;
        }
        
        .timeline-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            position: relative;
            z-index: 2;
            flex: 1;
        }
        
        .step-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            font-size: 10px;
            border: 2px solid var(--white);
            transition: all var(--transition-speed) ease;
        }
        
        .step-dot.active {
            background: var(--primary-orange);
            color: var(--white);
            transform: scale(1.1);
        }
        
        .step-dot.completed {
            background: var(--success-green);
            color: var(--white);
        }
        
        .step-label {
            font-size: 11px;
            color: var(--text-light);
            text-align: center;
        }
        
        .step-label.active {
            color: var(--primary-orange);
            font-weight: 600;
        }
        
        /* Parcel Details */
        .parcel-details {
            background: var(--off-white);
            border-radius: var(--element-radius);
            padding: 14px;
            margin: 12px 0;
        }
        
        .parcel-value-input {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .parcel-value-input span {
            font-weight: 600;
            color: var(--text-gray);
        }
        
        .parcel-value-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 13px;
        }
        
        /* Truck Types */
        .truck-types {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 12px 0;
        }
        
        .truck-type {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            text-align: center;
        }
        
        .truck-type:hover {
            border-color: var(--light-truck-brown);
            transform: translateY(-2px);
        }
        
        .truck-type.selected {
            border-color: var(--light-truck-brown);
            background: rgba(139, 69, 19, 0.05);
        }
        
        .truck-icon {
            font-size: 20px;
            color: var(--light-truck-brown);
            margin-bottom: 6px;
        }
        
        .truck-name {
            font-weight: 600;
            font-size: 12px;
            color: var(--dark-gray);
            margin-bottom: 2px;
        }
        
        .truck-capacity {
            font-size: 10px;
            color: var(--text-gray);
        }
        
        /* Item List for Express Shopping */
        .item-list {
            margin: 12px 0;
        }
        
        .item-entry {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .item-entry input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 13px;
        }
        
        .remove-item {
            width: 36px;
            height: 36px;
            border-radius: var(--element-radius);
            background: var(--light-red);
            border: none;
            color: var(--error-red);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .add-item {
            width: 100%;
            padding: 10px;
            background: var(--light-orange);
            border: 2px dashed var(--primary-orange);
            border-radius: var(--element-radius);
            color: var(--primary-orange);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all var(--transition-speed) ease;
        }
        
        .add-item:hover {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        /* Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* Focus Styles */
        *:focus {
            outline: 2px solid var(--primary-orange);
            outline-offset: 2px;
        }
        
        *:focus:not(.focus-visible) {
            outline: none;
        }
        
        /* Print Styles */
        @media print {
            .main-panel,
            .top-bar,
            .chat-container,
            .modal-overlay,
            .sos-button,
            .ride-status-bar,
            .emergency-status {
                display: none !important;
            }
            
            #map {
                position: relative;
                height: 300px;
            }
        }
        
        /* Enhanced Broadcast Section */
        .broadcast-section {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 16px;
            margin: 12px 0;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }
        
        .broadcast-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .broadcast-input-group {
            display: flex;
            gap: 8px;
        }
        
        .broadcast-input-group input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 13px;
        }
        
        .broadcast-btn {
            padding: 10px 16px;
            background: var(--primary-orange);
            color: var(--white);
            border: none;
            border-radius: var(--element-radius);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .broadcast-btn:hover {
            background: var(--secondary-orange);
            transform: translateY(-2px);
        }
        
        .broadcast-list {
            margin-top: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .broadcast-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .broadcast-item:last-child {
            border-bottom: none;
        }
        
        .broadcast-name {
            font-weight: 600;
            font-size: 13px;
        }
        
        .broadcast-status {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 10px;
            background: var(--light-orange);
            color: var(--primary-orange);
        }
        
        .broadcast-status.pending {
            background: #FFF3E0;
            color: var(--warning-yellow);
        }
        
        .broadcast-status.accepted {
            background: #E8F6EF;
            color: var(--success-green);
        }
        
        /* Driver Media Display */
        .driver-media {
            display: flex;
            gap: 12px;
            margin-top: 10px;
        }
        
        .media-container {
            flex: 1;
            border-radius: var(--element-radius);
            overflow: hidden;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 80px;
        }
        
        .media-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .media-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            font-size: 12px;
        }
        
        .media-placeholder i {
            font-size: 24px;
            margin-bottom: 4px;
        }
        
        /* Emergency Reason Selection */
        .emergency-reasons {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin: 16px 0;
        }
        
        .emergency-reason {
            padding: 14px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .emergency-reason:hover {
            border-color: var(--error-red);
            background: var(--light-red);
        }
        
        .emergency-reason.selected {
            border-color: var(--error-red);
            background: var(--light-red);
        }
        
        .emergency-reason-icon {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            background: var(--light-red);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--error-red);
        }
        
        .emergency-reason.selected .emergency-reason-icon {
            background: var(--error-red);
            color: var(--white);
        }
        
        .emergency-reason-text {
            flex: 1;
            font-weight: 500;
            color: var(--dark-gray);
        }
        
        /* Emergency Stations List */
        .emergency-stations {
            margin: 16px 0;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .emergency-station {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            margin-bottom: 8px;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .emergency-station:hover {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .emergency-station.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .station-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        
        .station-name {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
        }
        
        .station-distance {
            font-size: 11px;
            color: var(--text-gray);
        }
        
        .station-address {
            font-size: 12px;
            color: var(--text-gray);
            line-height: 1.3;
        }
        
        .station-details {
            margin-top: 6px;
            font-size: 11px;
            color: var(--text-light);
            display: flex;
            gap: 10px;
        }
        
        /* Enhanced Search Results */
        .search-results-container {
            position: relative;
            z-index: 1001;
        }
        
        .search-result-item {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        
        .search-result-item:hover {
            background: var(--light-orange);
        }
        
        .search-result-icon {
            color: var(--primary-orange);
            font-size: 16px;
            margin-top: 2px;
        }
        
        .search-result-content {
            flex: 1;
        }
        
        .search-result-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
            margin-bottom: 2px;
        }
        
        .search-result-subtitle {
            font-size: 12px;
            color: var(--text-gray);
            margin-bottom: 2px;
        }
        
        .search-result-details {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-light);
        }
        
        /* City Detection Indicator */
        .city-detection {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 150;
            background: var(--white);
            padding: 8px 16px;
            border-radius: var(--button-radius);
            box-shadow: var(--shadow-heavy);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            font-weight: 500;
            color: var(--dark-gray);
        }
        
        .city-detection i {
            color: var(--primary-orange);
        }
        
        /* Enhanced Notifications Panel */
        .notifications-panel {
            position: absolute;
            top: 56px;
            right: var(--app-padding);
            z-index: 250;
            width: 320px;
            max-width: calc(100vw - 40px);
            background: var(--white);
            border-radius: var(--card-radius);
            box-shadow: var(--shadow-heavy);
            display: none;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        
        .notifications-panel.active {
            display: flex;
            animation: slideDown 0.3s ease;
        }
        
        .notifications-header {
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            padding: 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .notifications-title {
            font-weight: 600;
            font-size: 13px;
        }
        
        .notifications-close {
            background: none;
            border: none;
            color: var(--white);
            font-size: 16px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all var(--transition-speed) ease;
        }
        
        .notifications-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .notifications-list {
            flex: 1;
            max-height: 300px;
            overflow-y: auto;
            background: var(--off-white);
        }
        
        .notification-item {
            padding: 14px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .notification-item:hover {
            background: var(--white);
        }
        
        .notification-item.unread {
            background: var(--light-orange);
        }
        
        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        
        .notification-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .notification-time {
            font-size: 11px;
            color: var(--text-light);
        }
        
        .notification-message {
            font-size: 12px;
            color: var(--text-gray);
            line-height: 1.3;
        }
        
        .notification-actions {
            margin-top: 8px;
            display: flex;
            gap: 8px;
        }
        
        .notification-action-btn {
            padding: 4px 8px;
            font-size: 11px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background: var(--white);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .notification-action-btn:hover {
            background: var(--primary-orange);
            color: var(--white);
            border-color: var(--primary-orange);
        }
        
        /* Dropdown Menu */
        .dropdown-menu {
            position: absolute;
            top: 60px;
            right: var(--app-padding);
            z-index: 250;
            width: 200px;
            background: var(--white);
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            display: none;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        
        .dropdown-menu.active {
            display: flex;
            animation: slideDown 0.3s ease;
        }
        
        .dropdown-item {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            color: var(--dark-gray);
        }
        
        .dropdown-item:hover {
            background: var(--light-orange);
            color: var(--primary-orange);
        }
        
        .dropdown-item:last-child {
            border-bottom: none;
        }
        
        .dropdown-item i {
            width: 18px;
            text-align: center;
        }
        
        /* More Options Menu */
        .more-options-menu {
            position: absolute;
            bottom: 200px;
            left: var(--app-padding);
            z-index: 250;
            width: 200px;
            background: var(--white);
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            display: none;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        
        .more-options-menu.active {
            display: flex;
            animation: slideUp 0.3s ease;
        }
        
        /* Enhanced Emergency Modal */
        .emergency-modal-content {
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .emergency-reason-input {
            margin-top: 10px;
        }
        
        .emergency-reason-input textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 13px;
            resize: vertical;
            min-height: 80px;
        }
        
        /* Real-time Updates Indicator */
        .real-time-indicator {
            position: fixed;
            bottom: 10px;
            right: 10px;
            z-index: 1000;
            background: var(--success-green);
            color: var(--white);
            padding: 6px 12px;
            border-radius: var(--button-radius);
            font-size: 11px;
            font-weight: 600;
            display: none;
            align-items: center;
            gap: 6px;
            box-shadow: var(--shadow-medium);
        }
        
        .real-time-indicator.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        
        /* Enhanced Chat Features */
        .chat-typing-indicator {
            font-size: 11px;
            color: var(--text-light);
            font-style: italic;
            padding: 4px 12px;
            display: none;
        }
        
        .chat-typing-indicator.active {
            display: block;
        }
        
        .chat-attachment-btn {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 16px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all var(--transition-speed) ease;
        }
        
        .chat-attachment-btn:hover {
            color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        /* Enhanced Search Bar */
        .search-bar-container {
            position: relative;
            margin-bottom: 12px;
        }
        
        .search-bar {
            width: 100%;
            padding: 12px 16px 12px 40px;
            border: 2px solid var(--border-color);
            border-radius: var(--button-radius);
            font-size: 13px;
            transition: all var(--transition-speed) ease;
        }
        
        .search-bar:focus {
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
        }
        
        .search-bar-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
        }
        
        /* Enhanced Price Calculator */
        .price-calculator-display {
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            padding: 16px;
            border-radius: var(--element-radius);
            margin: 16px 0;
            box-shadow: var(--shadow-medium);
        }
        
        .price-breakdown {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .price-breakdown-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 12px;
            opacity: 0.9;
        }
        
        .price-breakdown-row.total {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            font-weight: 700;
            font-size: 14px;
        }
        
        /* Enhanced Map Controls */
        .map-controls {
            position: absolute;
            top: 100px;
            right: var(--app-padding);
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .map-control-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--white);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-medium);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--dark-gray);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .map-control-btn:hover {
            background: var(--primary-orange);
            color: var(--white);
            transform: scale(1.1);
        }
        
        /* Enhanced Driver Tracking */
        .tracking-info {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 12px;
            margin: 12px 0;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }
        
        .tracking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .tracking-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
        }
        
        .tracking-distance {
            font-size: 12px;
            color: var(--primary-orange);
            font-weight: 600;
        }
        
        .tracking-progress {
            height: 6px;
            background: var(--light-gray);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        
        .tracking-progress-bar {
            height: 100%;
            background: var(--primary-orange);
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        .tracking-details {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-gray);
        }
        
        /* Enhanced Broadcast Feature */
        .broadcast-feature {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 16px;
            margin: 16px 0;
            box-shadow: var(--shadow-medium);
            border: 1px solid var(--border-color);
        }
        
        .broadcast-feature-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        
        .broadcast-feature-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--dark-gray);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .broadcast-status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success-green);
            animation: pulse 1.5s infinite;
        }
        
        .broadcast-status-indicator.inactive {
            background: var(--text-light);
            animation: none;
        }
        
        .broadcast-recipients {
            max-height: 150px;
            overflow-y: auto;
            margin-bottom: 12px;
        }
        
        .broadcast-recipient {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .broadcast-recipient:last-child {
            border-bottom: none;
        }
        
        .recipient-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .recipient-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--light-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-orange);
            font-weight: 600;
            font-size: 12px;
        }
        
        .recipient-name {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
        }
        
        .recipient-status {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
        }
        
        .status-joined {
            background: #E8F6EF;
            color: var(--success-green);
        }
        
        .status-pending {
            background: #FFF3E0;
            color: var(--warning-yellow);
        }
        
        /* Enhanced Location Details */
        .location-details {
            background: var(--off-white);
            border-radius: var(--element-radius);
            padding: 14px;
            margin: 12px 0;
        }
        
        .location-detail-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .location-detail-item:last-child {
            margin-bottom: 0;
        }
        
        .location-detail-icon {
            color: var(--primary-orange);
            font-size: 14px;
            margin-top: 2px;
        }
        
        .location-detail-content {
            flex: 1;
        }
        
        .location-detail-label {
            font-size: 11px;
            color: var(--text-light);
            margin-bottom: 2px;
        }
        
        .location-detail-value {
            font-size: 13px;
            color: var(--dark-gray);
            font-weight: 500;
            line-height: 1.3;
        }
        
        /* Enhanced Emergency Contact */
        .emergency-contact-display {
            background: var(--light-red);
            border-radius: var(--element-radius);
            padding: 14px;
            margin: 12px 0;
            border-left: 3px solid var(--error-red);
        }
        
        .emergency-contact-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .emergency-contact-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
        }
        
        .emergency-contact-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(231, 76, 60, 0.1);
        }
        
        .emergency-contact-item:last-child {
            border-bottom: none;
        }
        
        .contact-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .contact-name {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
        }
        
        .contact-phone {
            font-size: 12px;
            color: var(--text-gray);
        }
        
        .contact-action-btn {
            padding: 4px 8px;
            font-size: 11px;
            border-radius: 12px;
            background: var(--white);
            border: 1px solid var(--error-red);
            color: var(--error-red);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .contact-action-btn:hover {
            background: var(--error-red);
            color: var(--white);
        }
        
        /* Enhanced Service Type Indicators */
        .service-type-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .indicator-car {
            background: var(--light-orange);
            color: var(--primary-orange);
        }
        
        .indicator-delivery {
            background: #F4E6FA;
            color: var(--delivery-purple);
        }
        
        .indicator-truck {
            background: rgba(139, 69, 19, 0.1);
            color: var(--light-truck-brown);
        }
        
        .indicator-emergency {
            background: var(--light-red);
            color: var(--error-red);
        }
        
        .indicator-shopping {
            background: #E1F5FE;
            color: var(--express-shop-green);
        }
        
        /* Enhanced Price Updates Animation */
        .price-update-animation {
            animation: priceUpdate 0.5s ease;
        }
        
        @keyframes priceUpdate {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* Enhanced Real-time Sync Indicator */
        .sync-indicator {
            position: fixed;
            bottom: 10px;
            left: 10px;
            z-index: 1000;
            background: var(--info-blue);
            color: var(--white);
            padding: 6px 12px;
            border-radius: var(--button-radius);
            font-size: 11px;
            font-weight: 600;
            display: none;
            align-items: center;
            gap: 6px;
            box-shadow: var(--shadow-medium);
        }
        
        .sync-indicator.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        
        .sync-indicator.syncing .sync-icon {
            animation: spin 1s linear infinite;
        }
        
        /* Enhanced Distance Display */
        .distance-display {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--light-orange);
            border-radius: var(--element-radius);
            font-size: 12px;
            color: var(--dark-gray);
        }
        
        .distance-value {
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        /* Enhanced ETA Display */
        .eta-display {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--light-gray);
            border-radius: var(--element-radius);
            font-size: 12px;
            color: var(--dark-gray);
        }
        
        .eta-value {
            font-weight: 700;
            color: var(--info-blue);
        }
        
        /* Enhanced Search History */
        .search-history {
            margin-top: 8px;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .search-history-item {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .search-history-item:hover {
            background: var(--light-orange);
        }
        
        .search-history-icon {
            color: var(--text-light);
            font-size: 12px;
        }
        
        .search-history-text {
            flex: 1;
            font-size: 13px;
            color: var(--dark-gray);
        }
        
        .search-history-time {
            font-size: 11px;
            color: var(--text-light);
        }
        
        /* Enhanced Broadcast Notifications */
        .broadcast-notification {
            background: var(--info-blue);
            color: var(--white);
            padding: 12px;
            border-radius: var(--element-radius);
            margin: 12px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .broadcast-notification-content {
            flex: 1;
        }
        
        .broadcast-notification-title {
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 4px;
        }
        
        .broadcast-notification-message {
            font-size: 12px;
            opacity: 0.9;
        }
        
        .broadcast-notification-actions {
            display: flex;
            gap: 8px;
        }
        
        /* Enhanced Map Loading */
        .map-loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 12px;
        }
        
        .map-loading-text {
            font-size: 14px;
            font-weight: 600;
            color: var(--dark-gray);
        }
        
        /* Enhanced Error Display */
        .error-display {
            background: var(--light-red);
            border-radius: var(--element-radius);
            padding: 14px;
            margin: 12px 0;
            border-left: 3px solid var(--error-red);
        }
        
        .error-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--error-red);
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .error-message {
            font-size: 12px;
            color: var(--dark-gray);
            line-height: 1.3;
        }
        
        /* Enhanced Success Display */
        .success-display {
            background: #E8F6EF;
            border-radius: var(--element-radius);
            padding: 14px;
            margin: 12px 0;
            border-left: 3px solid var(--success-green);
        }
        
        .success-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--success-green);
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .success-message {
            font-size: 12px;
            color: var(--dark-gray);
            line-height: 1.3;
        }
        
        /* Enhanced Warning Display */
        .warning-display {
            background: #FFF3E0;
            border-radius: var(--element-radius);
            padding: 14px;
            margin: 12px 0;
            border-left: 3px solid var(--warning-yellow);
        }
        
        .warning-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--warning-yellow);
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .warning-message {
            font-size: 12px;
            color: var(--dark-gray);
            line-height: 1.3;
        }
    </style>
</head>
<body>
    <!-- Map Container -->
    <div id="map">
        <div class="map-loading-overlay" id="mapLoadingOverlay">
            <div class="loading-spinner"></div>
            <div class="map-loading-text">Loading map...</div>
        </div>
    </div>
    
    <!-- Top Navigation Bar -->
    <div class="top-bar">
        <div class="logo-container">
            <div class="logo-icon">
                <img src="jubel.png" alt="Jubel Logo" id="jubelLogo">
            </div>
            <div class="logo-text" id="userFullName">Loading...</div>
        </div>
        
        <div class="user-actions">
            <div class="balance-badge" id="balanceBadge">
                <i class="fas fa-wallet"></i>
                <span>Balance: <span class="balance-amount" id="walletBalance">ZMW 0.00</span></span>
            </div>
            <div class="notification-bell" id="notificationBell">
                <i class="fas fa-bell"></i>
                <span class="notification-badge" id="notificationCount">0</span>
            </div>
        </div>
    </div>
    
    <!-- City Detection Indicator -->
    <div class="city-detection" id="cityDetection">
        <i class="fas fa-map-marker-alt"></i>
        <span id="currentCityDisplay">Detecting your city...</span>
    </div>
    
    <!-- Ride Status Bar -->
    <div class="ride-status-bar" id="rideStatusBar">
        <div class="status-indicator">
            <div class="status-dot searching" id="statusDot"></div>
            <span class="status-text" id="statusText">Searching for driver</span>
        </div>
        <div class="status-eta">
            <i class="fas fa-clock"></i>
            <span id="etaText">5 min</span>
        </div>
    </div>
    
    <!-- Emergency Status -->
    <div class="emergency-status" id="emergencyStatus">
        <i class="fas fa-exclamation-triangle"></i>
        <span>EMERGENCY RIDE IN PROGRESS</span>
    </div>
    
    <!-- SOS Button -->
    <div class="sos-button" id="sosButton">
        <i class="fas fa-exclamation-triangle"></i>
    </div>
    
    <!-- Map Controls -->
    <div class="map-controls">
        <button class="map-control-btn" id="locateMeBtn" title="Locate Me">
            <i class="fas fa-location-arrow"></i>
        </button>
        <button class="map-control-btn" id="zoomInBtn" title="Zoom In">
            <i class="fas fa-plus"></i>
        </button>
        <button class="map-control-btn" id="zoomOutBtn" title="Zoom Out">
            <i class="fas fa-minus"></i>
        </button>
        <button class="map-control-btn" id="clearRouteBtn" title="Clear Route">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <!-- Chat Container -->
    <div class="chat-container" id="chatContainer">
        <div class="chat-header">
            <div class="chat-title">Chat with Driver</div>
            <button class="chat-close" id="chatClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <!-- Messages will be inserted here -->
        </div>
        <div class="chat-typing-indicator" id="typingIndicator">
            Driver is typing...
        </div>
        <div class="chat-input-container">
            <button class="chat-attachment-btn" id="attachmentBtn">
                <i class="fas fa-paperclip"></i>
            </button>
            <input type="text" class="chat-input" id="chatInput" placeholder="Type your message...">
            <button class="chat-send-btn" id="chatSend">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
    
    <!-- Notifications Panel -->
    <div class="notifications-panel" id="notificationsPanel">
        <div class="notifications-header">
            <div class="notifications-title">Notifications</div>
            <button class="notifications-close" id="notificationsClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="notifications-list" id="notificationsList">
            <!-- Notifications will be inserted here -->
        </div>
    </div>
    
    <!-- Dropdown Menu -->
    <div class="dropdown-menu" id="dropdownMenu">
        <div class="dropdown-item" data-action="profile">
            <i class="fas fa-user"></i>
            <span>Profile</span>
        </div>
        <div class="dropdown-item" data-action="settings">
            <i class="fas fa-cog"></i>
            <span>Settings</span>
        </div>
        <div class="dropdown-item" data-action="help">
            <i class="fas fa-question-circle"></i>
            <span>Help & Support</span>
        </div>
        <div class="dropdown-item" data-action="logout">
            <i class="fas fa-sign-out-alt"></i>
            <span>Logout</span>
        </div>
    </div>
    
    <!-- More Options Menu -->
    <div class="more-options-menu" id="moreOptionsMenu">
        <div class="dropdown-item" data-option="schedule">
            <i class="fas fa-calendar-alt"></i>
            <span>Schedule Ride</span>
        </div>
        <div class="dropdown-item" data-option="orderForSomeone">
            <i class="fas fa-user-friends"></i>
            <span>Order for Someone</span>
        </div>
        <div class="dropdown-item" data-option="shareRide">
            <i class="fas fa-share-alt"></i>
            <span>Share Ride</span>
        </div>
        <div class="dropdown-item" data-option="broadcast">
            <i class="fas fa-broadcast-tower"></i>
            <span>Broadcast Ride</span>
        </div>
    </div>
    
    <!-- Main Panel -->
    <div class="main-panel" id="mainPanel">
        <div class="panel-handle" id="panelHandle"></div>
        
        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" data-screen="home">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </button>
            <button class="nav-tab" data-screen="history">
                <i class="fas fa-history"></i>
                <span>History</span>
            </button>
            <button class="nav-tab" data-screen="account">
                <i class="fas fa-user"></i>
                <span>Account</span>
            </button>
            <button class="nav-tab" data-screen="emergency">
                <i class="fas fa-ambulance"></i>
                <span>Emergency</span>
            </button>
        </div>
        
        <!-- Home Screen Content -->
        <div id="homeContent">
            <!-- Service Tabs -->
            <div class="service-tabs" id="serviceTabs">
                <div class="service-tab car active" data-service="car">
                    <div class="service-icon">
                        <i class="fas fa-car"></i>
                    </div>
                    <div class="service-name">Car</div>
                    <div class="service-desc">Ride anywhere</div>
                </div>
                
                <div class="service-tab delivery" data-service="delivery">
                    <div class="service-icon">
                        <i class="fas fa-shipping-fast"></i>
                    </div>
                    <div class="service-name">Delivery</div>
                    <div class="service-desc">Send packages</div>
                </div>
                
                <div class="service-tab short-delivery" data-service="short-delivery">
                    <div class="service-icon">
                        <i class="fas fa-bicycle"></i>
                    </div>
                    <div class="service-name">Short Delivery</div>
                    <div class="service-desc">Quick deliveries</div>
                </div>
                
                <div class="service-tab" data-service="express">
                    <div class="service-icon">
                        <i class="fas fa-shopping-bag"></i>
                    </div>
                    <div class="service-name">Express Shopping</div>
                    <div class="service-desc">Shop for you</div>
                </div>
                
                <div class="service-tab" data-service="truck">
                    <div class="service-icon">
                        <i class="fas fa-truck"></i>
                    </div>
                    <div class="service-name">Truck</div>
                    <div class="service-desc">Move items</div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="quick-actions">
                <button class="quick-action-btn" id="moreOptionsBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-ellipsis-h"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">More Options</div>
                        <div class="quick-action-desc">Schedule, share, broadcast</div>
                    </div>
                </button>
                <button class="quick-action-btn" id="broadcastRideBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-broadcast-tower"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">Broadcast Ride</div>
                        <div class="quick-action-desc">Share with friends</div>
                    </div>
                </button>
                <button class="quick-action-btn" id="sosSetupBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">SOS Setup</div>
                        <div class="quick-action-desc">Emergency contacts</div>
                    </div>
                </button>
                <button class="quick-action-btn" id="recentDestinationsBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-history"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">Recent Destinations</div>
                        <div class="quick-action-desc">Quick access</div>
                    </div>
                </button>
            </div>
            
            <!-- Car Service Form (Default) -->
            <div class="ride-request-form active" id="carForm">
                <div class="form-title">
                    <i class="fas fa-car"></i>
                    Book a Ride
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="pickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="pickupLocation" placeholder="Current location" readonly>
                        <div class="search-loading" id="searchLoading"></div>
                        <div class="suggestion-list" id="pickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="destinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="destinationLocation" placeholder="Where to?" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="destinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Stops Container -->
                <div id="stopsContainer" style="margin: 10px 0;"></div>
                <button type="button" class="btn btn-secondary" id="addStopBtn" style="width: 100%; margin-bottom: 15px;">
                    <i class="fas fa-plus"></i> Add Stop
                </button>
                
                <!-- Search History -->
                <div class="search-history" id="searchHistory" style="display: none;"></div>
                
                <!-- Ride Type Selection -->
                <div class="ride-type-selection" id="rideTypeSelection">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                        <span id="rideTypeInfo" style="font-size: 11px; color: var(--text-light); cursor: pointer;">
                            <i class="fas fa-info-circle"></i>
                        </span>
                    </div>
                    
                    <!-- Ride Type Cards will be inserted here by JavaScript -->
                    <div class="ride-type-cards" id="rideTypeCardsContainer"></div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="fareDisplay">
                    <div class="fare-label">Estimated Fare</div>
                    <div class="fare-amount" id="estimatedFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="distanceDetail">0 km</span>
                        <span id="timeDetail">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Price Calculator Display -->
                <div class="price-calculator-display" id="priceCalculator" style="display: none;">
                    <div class="fare-label">Fare Breakdown</div>
                    <div class="fare-amount" id="calculatedFare">ZMW 0.00</div>
                    <div class="price-breakdown" id="priceBreakdown">
                        <!-- Breakdown will be inserted here -->
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestRideBtn">
                        <i class="fas fa-search"></i>
                        Request Ride
                    </button>
                </div>
            </div>
            
            <!-- Delivery Service Form -->
            <div class="service-form delivery-form" id="deliveryForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-shipping-fast"></i>
                    Package Delivery
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="deliveryPickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="deliveryPickup" placeholder="Pickup location" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="deliveryPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="deliveryDestinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="deliveryDestination" placeholder="Delivery address" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="deliveryDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Delivery Details -->
                <div class="form-group">
                    <label class="form-label">Parcel Description</label>
                    <input type="text" class="form-control" id="parcelDescription" placeholder="What are you sending?">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Receiver's Details</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="receiverName" placeholder="Receiver name">
                        <input type="tel" class="form-control" id="receiverPhone" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Parcel Value (ZMW)</label>
                    <input type="number" class="form-control" id="parcelValue" placeholder="Value of parcel" min="0" step="0.01">
                </div>
                
                <!-- Delivery Options -->
                <div class="form-group">
                    <label class="form-label">Delivery Type</label>
                    <div style="display: flex; gap: 10px;">
                        <button class="filter-btn active" id="standardDelivery">Standard</button>
                        <button class="filter-btn" id="expressDelivery">Express</button>
                        <button class="filter-btn" id="sameDayDelivery">Same Day</button>
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="deliveryFareDisplay" style="display: none;">
                    <div class="fare-label">Delivery Fare</div>
                    <div class="fare-amount" id="deliveryFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="deliveryDistance">0 km</span>
                        <span id="deliveryTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestDeliveryBtn">
                        <i class="fas fa-shipping-fast"></i>
                        Request Delivery
                    </button>
                </div>
            </div>
            
            <!-- Short Delivery Form -->
            <div class="service-form delivery-form" id="shortDeliveryForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-bicycle"></i>
                    Short Delivery
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="shortDeliveryPickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="shortDeliveryPickup" placeholder="Pickup location" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shortDeliveryPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="shortDeliveryDestinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="shortDeliveryDestination" placeholder="Delivery address" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shortDeliveryDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Delivery Details -->
                <div class="form-group">
                    <label class="form-label">What are you sending?</label>
                    <input type="text" class="form-control" id="shortParcelDescription" placeholder="Food, documents, small items...">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Receiver's Phone</label>
                    <input type="tel" class="form-control" id="shortReceiverPhone" placeholder="Receiver phone number">
                </div>
                
                <!-- Quick Options -->
                <div class="form-group">
                    <label class="form-label">Quick Options</label>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <span class="filter-btn">Food</span>
                        <span class="filter-btn">Documents</span>
                        <span class="filter-btn">Medication</span>
                        <span class="filter-btn">Small Package</span>
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="shortDeliveryFareDisplay" style="display: none;">
                    <div class="fare-label">Delivery Fare</div>
                    <div class="fare-amount" id="shortDeliveryFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="shortDeliveryDistance">0 km</span>
                        <span id="shortDeliveryTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestShortDeliveryBtn">
                        <i class="fas fa-bolt"></i>
                        Quick Delivery
                    </button>
                </div>
            </div>
            
            <!-- Express Shopping Form -->
            <div class="service-form express-form" id="expressForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-shopping-bag"></i>
                    Express Shopping
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="shopNameInput">
                        <i class="fas fa-store"></i>
                        <input type="text" id="shopName" placeholder="Shop/Restaurant name" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shopSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="shopLocation" placeholder="Shop location" readonly>
                    </div>
                </div>
                
                <!-- Items List -->
                <div class="form-group">
                    <label class="form-label">Shopping List</label>
                    <div class="item-list" id="shoppingItems">
                        <div class="item-entry">
                            <input type="text" class="item-input" placeholder="Item name">
                            <button class="remove-item" type="button">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <button class="add-item" type="button" id="addItemBtn">
                        <i class="fas fa-plus"></i>
                        Add Item
                    </button>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Special Instructions</label>
                    <textarea class="form-control form-textarea" id="shoppingInstructions" placeholder="Any specific requests or instructions..."></textarea>
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="shoppingDestinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="shoppingDestination" placeholder="Delivery address" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shoppingDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Budget -->
                <div class="form-group">
                    <label class="form-label">Estimated Budget (ZMW)</label>
                    <input type="number" class="form-control" id="shoppingBudget" placeholder="Estimated cost of items">
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="shoppingFareDisplay" style="display: none;">
                    <div class="fare-label">Shopping Service Fare</div>
                    <div class="fare-amount" id="shoppingFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="shoppingDistance">0 km</span>
                        <span id="shoppingTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestShoppingBtn">
                        <i class="fas fa-shopping-cart"></i>
                        Request Shopping
                    </button>
                </div>
            </div>
            
            <!-- Truck Delivery Form -->
            <div class="service-form truck-form" id="truckForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-truck"></i>
                    Truck Delivery
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="truckPickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="truckPickup" placeholder="Pickup location (Current location)" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="truckPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="truckDestinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="truckDestination" placeholder="Destination" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="truckDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Truck Type Selection -->
                <div class="form-group">
                    <label class="form-label">Select Truck Type</label>
                    <div class="truck-types">
                        <div class="truck-type" data-type="pickup">
                            <div class="truck-icon">
                                <i class="fas fa-truck-pickup"></i>
                            </div>
                            <div class="truck-name">Pickup Truck</div>
                            <div class="truck-capacity">Up to 1.5 tons</div>
                        </div>
                        
                        <div class="truck-type selected" data-type="light">
                            <div class="truck-icon">
                                <i class="fas fa-truck-moving"></i>
                            </div>
                            <div class="truck-name">Light Truck</div>
                            <div class="truck-capacity">Up to 3 tons</div>
                        </div>
                        
                        <div class="truck-type" data-type="medium">
                            <div class="truck-icon">
                                <i class="fas fa-truck"></i>
                            </div>
                            <div class="truck-name">Medium Truck</div>
                            <div class="truck-capacity">Up to 7 tons</div>
                        </div>
                        
                        <div class="truck-type" data-type="heavy">
                            <div class="truck-icon">
                                <i class="fas fa-truck-loading"></i>
                            </div>
                            <div class="truck-name">Heavy Truck</div>
                            <div class="truck-capacity">Up to 15 tons</div>
                        </div>
                    </div>
                </div>
                
                <!-- Item Details -->
                <div class="form-group">
                    <label class="form-label">What are you moving?</label>
                    <input type="text" class="form-control" id="truckItemDescription" placeholder="Furniture, boxes, equipment...">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Estimated Weight (kg)</label>
                    <input type="number" class="form-control" id="estimatedWeight" placeholder="Approximate weight">
                </div>
                
                <!-- Additional Help -->
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="needHelpers">
                        <span style="margin-left: 8px;">Need loading/unloading helpers (+ZMW 50)</span>
                    </label>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="truckFareDisplay" style="display: none;">
                    <div class="fare-label">Truck Fare</div>
                    <div class="fare-amount" id="truckFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="truckDistance">0 km</span>
                        <span id="truckTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestTruckBtn">
                        <i class="fas fa-truck"></i>
                        Request Truck
                    </button>
                </div>
            </div>
            
            <!-- Ride Info Panel -->
            <div class="ride-info-panel" id="rideInfoPanel" style="display: none;">
                <div class="driver-info">
                    <div class="driver-avatar" id="driverAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="driver-details">
                        <div class="driver-name" id="driverName">Driver Name</div>
                        <div class="driver-rating">
                            <i class="fas fa-star"></i>
                            <span id="driverRating">4.8</span>
                        </div>
                        <div class="driver-vehicle">
                            <i class="fas fa-car"></i>
                            <span id="vehicleDetails">Toyota Corolla - ABC 123</span>
                        </div>
                    </div>
                </div>
                
                <!-- Driver Media Display -->
                <div class="driver-media" id="driverMedia">
                    <div class="media-container">
                        <div class="media-placeholder" id="driverImagePlaceholder">
                            <i class="fas fa-user"></i>
                            <span>Driver Image</span>
                        </div>
                        <img id="driverImage" style="display: none;">
                    </div>
                    <div class="media-container">
                        <div class="media-placeholder" id="vehicleImagePlaceholder">
                            <i class="fas fa-car"></i>
                            <span>Vehicle Image</span>
                        </div>
                        <img id="vehicleImage" style="display: none;">
                    </div>
                </div>
                
                <!-- Tracking Info -->
                <div class="tracking-info" id="trackingInfo">
                    <div class="tracking-header">
                        <div class="tracking-title">Driver Distance</div>
                        <div class="tracking-distance" id="driverDistance">0 km</div>
                    </div>
                    <div class="tracking-progress">
                        <div class="tracking-progress-bar" id="trackingProgress" style="width: 0%"></div>
                    </div>
                    <div class="tracking-details">
                        <span id="pickupDistance">0 km to pickup</span>
                        <span id="etaToPickup">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Timeline -->
                <div class="timeline" id="rideTimeline">
                    <div class="timeline-step">
                        <div class="step-dot active" id="stepRequested">
                            <i class="fas fa-search"></i>
                        </div>
                        <div class="step-label active">Requested</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepAccepted">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <div class="step-label">Accepted</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepArrived">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="step-label">Arrived</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepStarted">
                            <i class="fas fa-play"></i>
                        </div>
                        <div class="step-label">Started</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepCompleted">
                            <i class="fas fa-flag-checkered"></i>
                        </div>
                        <div class="step-label">Completed</div>
                    </div>
                </div>
                
                <!-- Ride Stops -->
                <div class="ride-stops" id="rideStopsContainer" style="display: none; margin-top: 15px;">
                    <div class="section-title" style="font-size: 14px; color: var(--text-gray); margin-bottom: 10px;">
                        <i class="fas fa-map-pin"></i> Stops
                    </div>
                    <div id="rideStopsList"></div>
                </div>
                
                <div class="trip-details">
                    <div class="trip-locations">
                        <div class="location-point">
                            <div class="location-marker pickup">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="location-text">
                                <div class="location-label">Pickup</div>
                                <div class="location-address" id="currentPickup">Loading...</div>
                            </div>
                        </div>
                        
                        <div class="location-point">
                            <div class="location-marker destination">
                                <i class="fas fa-flag"></i>
                            </div>
                            <div class="location-text">
                                <div class="location-label">Destination</div>
                                <div class="location-address" id="currentDestination">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Location Details -->
                <div class="location-details">
                    <div class="location-detail-item">
                        <div class="location-detail-icon">
                            <i class="fas fa-road"></i>
                        </div>
                        <div class="location-detail-content">
                            <div class="location-detail-label">Distance</div>
                            <div class="location-detail-value" id="rideDistance">0 km</div>
                        </div>
                    </div>
                    <div class="location-detail-item">
                        <div class="location-detail-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="location-detail-content">
                            <div class="location-detail-label">Estimated Time</div>
                            <div class="location-detail-value" id="rideTime">0 min</div>
                        </div>
                    </div>
                </div>
                
                <div class="fare-breakdown">
                    <div class="fare-row">
                        <span class="fare-label">Base Fare</span>
                        <span class="fare-value" id="baseFareValue">ZMW 15.00</span>
                    </div>
                    <div class="fare-row">
                        <span class="fare-label">Distance</span>
                        <span class="fare-value" id="distanceFareValue">ZMW 5.00</span>
                    </div>
                    <div class="fare-row">
                        <span class="fare-label">Ride Type</span>
                        <span class="fare-value" id="rideTypeValue">Standard</span>
                    </div>
                    <div class="fare-row total">
                        <span class="fare-label">Total Fare</span>
                        <span class="fare-value" id="totalFareValue">ZMW 20.00</span>
                    </div>
                </div>
                
                <!-- Emergency Contact Display -->
                <div class="emergency-contact-display" id="emergencyContactDisplay" style="display: none;">
                    <div class="emergency-contact-header">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div class="emergency-contact-title">Emergency Contacts</div>
                    </div>
                    <div class="emergency-contact-item">
                        <div class="contact-info">
                            <div class="contact-name" id="emergencyContact1Name">Contact 1</div>
                            <div class="contact-phone" id="emergencyContact1Phone">000-000-0000</div>
                        </div>
                        <button class="contact-action-btn" id="emergencyContact1Btn">
                            <i class="fas fa-phone"></i>
                        </button>
                    </div>
                    <div class="emergency-contact-item">
                        <div class="contact-info">
                            <div class="contact-name" id="emergencyContact2Name">Contact 2</div>
                            <div class="contact-phone" id="emergencyContact2Phone">000-000-0000</div>
                        </div>
                        <button class="contact-action-btn" id="emergencyContact2Btn">
                            <i class="fas fa-phone"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Broadcast Feature -->
                <div class="broadcast-feature" id="broadcastFeature" style="display: none;">
                    <div class="broadcast-feature-header">
                        <div class="broadcast-feature-title">
                            <i class="fas fa-broadcast-tower"></i>
                            <span>Broadcast Ride</span>
                        </div>
                        <div class="broadcast-status-indicator inactive" id="broadcastStatusIndicator"></div>
                    </div>
                    <div class="broadcast-form">
                        <div class="broadcast-input-group">
                            <input type="text" id="broadcastMemberInput" placeholder="Enter friend's referral code">
                            <button class="broadcast-btn" id="addBroadcastMemberBtn">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div class="broadcast-recipients" id="broadcastMembersContainer">
                            <!-- Recipients will be inserted here -->
                        </div>
                        <button class="btn btn-secondary" id="startBroadcastBtn">
                            <i class="fas fa-play"></i>
                            Start Broadcasting
                        </button>
                    </div>
                </div>

                <!-- Share Ride Status -->
                <div class="share-ride-status" id="shareRideStatus" style="display: none;"></div>
                
                <div class="action-buttons">
                    <button class="btn btn-danger" id="cancelRideBtn">
                        <i class="fas fa-times-circle"></i>
                        Cancel Ride
                    </button>
                    <button class="btn btn-secondary" id="contactDriverBtn">
                        <i class="fas fa-phone"></i>
                        Call Driver
                    </button>
                    <button class="btn btn-secondary" id="openChatBtn">
                        <i class="fas fa-comment"></i>
                        Chat
                    </button>
                </div>
            </div>
            
            <!-- Broadcast Ride Form -->
            <div class="service-form" id="broadcastForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-broadcast-tower"></i>
                    Broadcast Ride
                </div>
                
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="broadcastPickup" placeholder="Pickup location" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="broadcastPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="broadcastDestination" placeholder="Destination" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="broadcastDestinationSuggestions"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Passenger Phone Numbers (comma separated)</label>
                    <textarea class="form-control form-textarea" id="broadcastPassengers" placeholder="Enter phone numbers of passengers to share this ride with..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Ride Type</label>
                    <select class="form-control" id="broadcastRideType">
                        <option value="standard">Standard</option>
                        <option value="economy">Economy</option>
                        <option value="premium">Premium</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Split Fare</label>
                    <select class="form-control" id="broadcastSplitType">
                        <option value="equal">Equal Split</option>
                        <option value="you_pay_more">You Pay 70%</option>
                        <option value="you_pay_all">You Pay All</option>
                    </select>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="broadcastFareDisplay" style="display: none;">
                    <div class="fare-label">Broadcast Fare</div>
                    <div class="fare-amount" id="broadcastFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="broadcastDistance">0 km</span>
                        <span id="broadcastTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="startBroadcastRideBtn">
                        <i class="fas fa-broadcast-tower"></i>
                        Start Broadcast
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- History Screen -->
    <div class="history-screen" id="historyScreen" style="display: none;">
        <div class="screen-header">
            <button class="back-btn" data-screen="home">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="screen-title">Ride History</div>
        </div>
        
        <div class="history-filters">
            <button class="filter-btn active" data-filter="all">All</button>
            <button class="filter-btn" data-filter="completed">Completed</button>
            <button class="filter-btn" data-filter="cancelled">Cancelled</button>
            <button class="filter-btn" data-filter="scheduled">Scheduled</button>
            <button class="filter-btn" data-filter="emergency">Emergency</button>
            <button class="filter-btn" data-filter="delivery">Delivery</button>
            <button class="filter-btn" data-filter="truck">Truck</button>
            <button class="filter-btn" data-filter="broadcast">Broadcast</button>
        </div>
        
        <div class="history-list" id="historyList">
            <!-- History items will be inserted here -->
        </div>
    </div>
    
    <!-- Account Screen -->
    <div class="account-screen" id="accountScreen" style="display: none;">
        <div class="screen-header">
            <button class="back-btn" data-screen="home">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="screen-title">My Account</div>
        </div>
        
        <div class="account-header">
            <div class="account-avatar" id="accountAvatar">
                <i class="fas fa-user"></i>
            </div>
            <div class="account-name" id="accountName">Loading...</div>
            <div class="account-phone" id="accountPhone">Loading...</div>
        </div>
        
        <div class="account-stats">
            <div class="stat-card">
                <div class="stat-value" id="completedRides">0</div>
                <div class="stat-label">Completed Rides</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="cancelledRides">0</div>
                <div class="stat-label">Cancelled Rides</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalSpent">ZMW 0</div>
                <div class="stat-label">Total Spent</div>
            </div>
        </div>
        
        <div class="account-section">
            <div class="section-title">
                <i class="fas fa-wallet"></i>
                Wallet Balance
            </div>
            
            <div class="wallet-balance">
                <div class="balance-label">Available Balance</div>
                <div class="balance-amount-large" id="accountBalance">ZMW 0.00</div>
            </div>
            
            <div class="wallet-actions">
                <button class="btn-wallet" id="depositBtn">
                    <i class="fas fa-plus"></i>
                    Deposit
                </button>
                <button class="btn-wallet" id="withdrawBtn">
                    <i class="fas fa-minus"></i>
                    Withdraw
                </button>
                <button class="btn-wallet" id="transferBtn">
                    <i class="fas fa-exchange-alt"></i>
                    Transfer
                </button>
                <button class="btn-wallet" id="transactionsBtn">
                    <i class="fas fa-history"></i>
                    History
                </button>
            </div>
        </div>
        
        <div class="account-section">
            <div class="section-title">
                <i class="fas fa-gift"></i>
                Referral Program
            </div>
            
            <div class="referral-card">
                <div>Share your referral code and earn ZMW 25 for each friend's first ride</div>
                <div class="referral-code" id="referralCode">JUBEL-XXXX</div>
                <button class="btn btn-primary" id="shareReferralBtn">
                    <i class="fas fa-share"></i>
                    Share Code
                </button>
                <div class="referral-note">Your friend gets 50% off their first ride</div>
            </div>
        </div>
        
        <div class="account-section">
            <div class="section-title">
                <i class="fas fa-cog"></i>
                Settings
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-secondary" id="updateProfileBtn">
                    <i class="fas fa-user-edit"></i>
                    Update Profile
                </button>
                <button class="btn btn-secondary" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </button>
            </div>
        </div>
    </div>
    
    <!-- Emergency Screen -->
    <div class="emergency-screen" id="emergencyScreen" style="display: none;">
        <div class="screen-header">
            <button class="back-btn" data-screen="home">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="screen-title">Emergency Services</div>
        </div>
        
        <div class="emergency-services">
            <div class="emergency-service police" data-type="police">
                <div class="emergency-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <div class="emergency-name">Police Ride</div>
                <div class="emergency-description">Emergency transport with police escort</div>
            </div>
            
            <div class="emergency-service fire" data-type="fire">
                <div class="emergency-icon">
                    <i class="fas fa-fire-extinguisher"></i>
                </div>
                <div class="emergency-name">Fire Brigade</div>
                <div class="emergency-description">Fire emergency response team</div>
            </div>
            
            <div class="emergency-service medical" data-type="medical">
                <div class="emergency-icon">
                    <i class="fas fa-ambulance"></i>
                </div>
                <div class="emergency-name">Hospital Ride</div>
                <div class="emergency-description">Medical emergency transport</div>
            </div>
            
            <div class="emergency-service" data-type="sos">
                <div class="emergency-icon" style="background: var(--error-red);">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="emergency-name">SOS Emergency</div>
                <div class="emergency-description">Immediate emergency assistance</div>
            </div>
        </div>
        
        <div class="emergency-note">
            <p><strong>Important:</strong> Only use emergency services for genuine emergencies. Misuse may result in penalties. In case of immediate danger, call 911 first.</p>
        </div>
    </div>
    
    <!-- Modals -->
    
    <!-- Payment Modal -->
    <div class="modal-overlay" id="paymentModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-credit-card"></i>
                    Select Payment Method
                </div>
                <button class="modal-close" data-modal="payment">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <div class="form-label">Available Balance: <span id="paymentBalance">ZMW 0.00</span></div>
                    <div class="form-label">Total Amount: <span id="paymentAmount">ZMW 0.00</span></div>
                </div>
                
                <!-- Referral Discount Section -->
                <div class="referral-discount-section" id="referralDiscountSection" style="display: none;">
                    <div class="section-header">
                        <i class="fas fa-gift"></i>
                        <span>Referral Discount (50% off)</span>
                    </div>
                    <div class="referral-input-group">
                        <input type="text" id="referralCodeInput" placeholder="Enter referral code">
                        <button id="applyReferralBtn" class="btn btn-orange">
                            <i class="fas fa-check"></i> Apply
                        </button>
                    </div>
                    <div id="referrerInfo" style="display: none; font-size: 12px; color: var(--success-green); margin-top: 5px;"></div>
                    <div class="discount-breakdown" style="margin-top: 10px;">
                        <div class="price-row">
                            <span>Original Fare:</span>
                            <span id="originalFareAmount">ZMW 0.00</span>
                        </div>
                        <div class="price-row">
                            <span>Discount:</span>
                            <span id="discountAmount" style="color: var(--success-green);">-ZMW 0.00</span>
                        </div>
                        <div class="price-row total">
                            <span>Final Fare:</span>
                            <span id="finalFareAmount" style="font-weight: bold;">ZMW 0.00</span>
                        </div>
                    </div>
                </div>
                
                <div class="payment-methods">
                    <div class="payment-method" data-payment="wallet">
                        <div class="payment-icon">
                            <i class="fas fa-wallet"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Jubel Wallet</div>
                            <div class="payment-info">Pay with your wallet balance</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-payment="mobile">
                        <div class="payment-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Mobile Money</div>
                            <div class="payment-info">Pay via MTN/Zamtel/Airtel</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-payment="cash">
                        <div class="payment-icon">
                            <i class="fas fa-money-bill"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Cash</div>
                            <div class="payment-info">Pay driver directly</div>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmPaymentBtn">
                        <i class="fas fa-check"></i>
                        Confirm Payment
                    </button>
                    <button class="btn btn-secondary" data-modal="payment">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Cancel Ride Modal -->
    <div class="modal-overlay" id="cancelModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-times-circle"></i>
                    Cancel Ride
                </div>
                <button class="modal-close" data-modal="cancel">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <div class="form-label">Please select a reason for cancellation:</div>
                </div>
                
                <div class="cancel-reasons">
                    <div class="cancel-reason" data-reason="driver_late">
                        <div class="reason-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="reason-text">Driver is taking too long</div>
                    </div>
                    
                    <div class="cancel-reason" data-reason="change_plans">
                        <div class="reason-icon">
                            <i class="fas fa-calendar-times"></i>
                        </div>
                        <div class="reason-text">Change of plans</div>
                    </div>
                    
                    <div class="cancel-reason" data-reason="found_alternative">
                        <div class="reason-icon">
                            <i class="fas fa-car"></i>
                        </div>
                        <div class="reason-text">Found alternative transport</div>
                    </div>
                    
                    <div class="cancel-reason" data-reason="emergency">
                        <div class="reason-icon">
                            <i class="fas fa-exclamation"></i>
                        </div>
                        <div class="reason-text">Emergency situation</div>
                    </div>
                    
                    <div class="cancel-reason" data-reason="other">
                        <div class="reason-icon">
                            <i class="fas fa-ellipsis-h"></i>
                        </div>
                        <div class="reason-text">Other reason</div>
                    </div>
                </div>
                
                <div class="form-group" id="otherReasonGroup" style="display: none;">
                    <label class="form-label">Please specify:</label>
                    <textarea class="form-control form-textarea" id="otherReason" placeholder="Enter your reason here..."></textarea>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-danger" id="confirmCancelBtn">
                        <i class="fas fa-times"></i>
                        Cancel Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="cancel">
                        Go Back
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Emergency Ride Modal -->
    <div class="modal-overlay" id="emergencyModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-ambulance"></i>
                    Emergency Ride Details
                </div>
                <button class="modal-close" data-modal="emergency">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content emergency-modal-content">
                <div class="form-group">
                    <div class="form-label" id="emergencyServiceType">Police Ride</div>
                </div>
                
                <!-- Emergency Reasons -->
                <div class="form-group">
                    <label class="form-label">Select Emergency Reason</label>
                    <div class="emergency-reasons">
                        <div class="emergency-reason" data-reason="accident">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-car-crash"></i>
                            </div>
                            <div class="emergency-reason-text">Accident</div>
                        </div>
                        
                        <div class="emergency-reason" data-reason="medical">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-heartbeat"></i>
                            </div>
                            <div class="emergency-reason-text">Medical Emergency</div>
                        </div>
                        
                        <div class="emergency-reason" data-reason="crime">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="emergency-reason-text">Crime/Assault</div>
                        </div>
                        
                        <div class="emergency-reason" data-reason="fire">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-fire"></i>
                            </div>
                            <div class="emergency-reason-text">Fire Emergency</div>
                        </div>
                        
                        <div class="emergency-reason" data-reason="other">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="emergency-reason-text">Other Emergency</div>
                        </div>
                    </div>
                    
                    <div class="emergency-reason-input" id="emergencyReasonOther" style="display: none;">
                        <label class="form-label">Please describe the emergency:</label>
                        <textarea class="form-control form-textarea" id="emergencyOtherReason" placeholder="Describe the emergency situation..."></textarea>
                    </div>
                </div>
                
                <!-- Location Inputs -->
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="emergencyPickup" placeholder="Pickup location" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="emergencyPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="emergencyDestination" placeholder="Destination" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="emergencyDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Emergency Stations -->
                <div class="form-group">
                    <label class="form-label">Select Nearest Emergency Station</label>
                    <div class="emergency-stations" id="emergencyStations">
                        <!-- Stations will be inserted here -->
                    </div>
                </div>
                
                <!-- User Location Details -->
                <div class="location-details">
                    <div class="location-detail-item">
                        <div class="location-detail-icon">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="location-detail-content">
                            <div class="location-detail-label">Your Location</div>
                            <div class="location-detail-value" id="emergencyUserLocation">Detecting location...</div>
                        </div>
                    </div>
                </div>
                
                <!-- Price Calculation -->
                <div class="price-calculation">
                    <div class="calculation-row">
                        <span>Base Emergency Fare:</span>
                        <span id="emergencyBaseFare">ZMW 100.00</span>
                    </div>
                    <div class="calculation-row">
                        <span>Distance to Service:</span>
                        <span id="emergencyDistance">0 km</span>
                    </div>
                    <div class="calculation-row">
                        <span>Estimated Time:</span>
                        <span id="emergencyTime">5 min</span>
                    </div>
                    <div class="calculation-row total">
                        <span>Total Fare:</span>
                        <span id="emergencyTotalFare">ZMW 100.00</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-danger" id="confirmEmergencyBtn">
                        <i class="fas fa-exclamation-triangle"></i>
                        Request Emergency Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="emergency">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- SOS Setup Modal -->
    <div class="modal-overlay" id="sosModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    SOS Emergency Setup
                </div>
                <button class="modal-close" data-modal="sos">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <label class="form-label">Primary Emergency Contact</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="sosContact1Name" placeholder="Contact name">
                        <input type="tel" class="form-control" id="sosContact1Phone" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Secondary Emergency Contact (Optional)</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="sosContact2Name" placeholder="Contact name">
                        <input type="tel" class="form-control" id="sosContact2Phone" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Emergency Message</label>
                    <textarea class="form-control form-textarea" id="sosMessage">
I need help! My current location and ride details will be shared with you.
                    </textarea>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="saveSOSBtn">
                        <i class="fas fa-save"></i>
                        Save SOS Setup
                    </button>
                    <button class="btn btn-secondary" data-modal="sos">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Transfer Money Modal -->
    <div class="modal-overlay" id="transferModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-exchange-alt"></i>
                    Transfer Money
                </div>
                <button class="modal-close" data-modal="transfer">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <div class="form-label">Available Balance: <span id="transferBalance">ZMW 0.00</span></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Recipient's Referral Code</label>
                    <input type="text" class="form-control" id="recipientCode" placeholder="Enter recipient's Jubel referral code">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Amount (ZMW)</label>
                    <input type="number" class="form-control" id="transferAmount" placeholder="Enter amount" min="1" step="0.01">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Message (Optional)</label>
                    <input type="text" class="form-control" id="transferMessage" placeholder="Add a message">
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmTransferBtn">
                        <i class="fas fa-paper-plane"></i>
                        Send Money
                    </button>
                    <button class="btn btn-secondary" data-modal="transfer">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Wallet Transactions Modal -->
    <div class="modal-overlay" id="transactionsModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-history"></i>
                    Wallet Transactions
                </div>
                <button class="modal-close" data-modal="transactions">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div id="transactionsList">
                    <!-- Transactions will be inserted here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Schedule Ride Modal -->
    <div class="modal-overlay" id="scheduleModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-calendar-alt"></i>
                    Schedule a Ride
                </div>
                <button class="modal-close" data-modal="schedule">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="schedulePickup" placeholder="Pickup location">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="schedulePickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="scheduleDestination" placeholder="Destination">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="scheduleDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- For Someone Else -->
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="scheduleForSomeone">
                        <span style="margin-left: 8px;">Booking for someone else</span>
                    </label>
                </div>
                
                <div class="form-group" id="someoneElseDetails" style="display: none;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="recipientName" placeholder="Recipient name">
                        <input type="tel" class="form-control" id="recipientPhone" placeholder="Recipient phone">
                    </div>
                </div>
                
                <div class="schedule-grid">
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-control" id="scheduleDate" min="">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Time</label>
                        <input type="time" class="form-control" id="scheduleTime">
                    </div>
                </div>
                
                <!-- Ride Type Selection for Schedule -->
                <div class="ride-type-selection" style="margin: 0 0 16px 0;">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                    </div>
                    <div class="ride-type-grid" id="scheduleRideTypeGrid">
                        <div class="ride-type-card economy" data-type="economy">
                            <div class="ride-type-icon">
                                <i class="fas fa-car-side"></i>
                            </div>
                            <div class="ride-type-name">Economy</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card selected" data-type="standard">
                            <div class="ride-type-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="ride-type-name">Standard</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card premium" data-type="premium">
                            <div class="ride-type-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="ride-type-name">Premium</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="scheduleFareDisplay" style="display: none;">
                    <div class="fare-label">Scheduled Ride Fare</div>
                    <div class="fare-amount" id="scheduleFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="scheduleDistance">0 km</span>
                        <span id="scheduleTimeEstimate">ETA: 0 min</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmScheduleBtn">
                        <i class="fas fa-calendar-check"></i>
                        Schedule Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="schedule">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Order for Someone Modal -->
    <div class="modal-overlay" id="orderForSomeoneModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-user-friends"></i>
                    Order for Someone Else
                </div>
                <button class="modal-close" data-modal="orderForSomeone">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="someonePickup" placeholder="Pickup location">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="someonePickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="someoneDestination" placeholder="Destination">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="someoneDestinationSuggestions"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Recipient Details</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="someoneName" placeholder="Full name">
                        <input type="tel" class="form-control" id="someonePhone" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Special Instructions (Optional)</label>
                    <textarea class="form-control form-textarea" id="someoneInstructions" placeholder="Any instructions for the driver..."></textarea>
                </div>
                
                <!-- Ride Type Selection -->
                <div class="ride-type-selection" style="margin: 0 0 16px 0;">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                    </div>
                    <div class="ride-type-grid" id="someoneRideTypeGrid">
                        <div class="ride-type-card economy" data-type="economy">
                            <div class="ride-type-icon">
                                <i class="fas fa-car-side"></i>
                            </div>
                            <div class="ride-type-name">Economy</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card selected" data-type="standard">
                            <div class="ride-type-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="ride-type-name">Standard</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card premium" data-type="premium">
                            <div class="ride-type-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="ride-type-name">Premium</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="someoneFareDisplay" style="display: none;">
                    <div class="fare-label">Estimated Fare</div>
                    <div class="fare-amount" id="someoneFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="someoneDistance">0 km</span>
                        <span id="someoneTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmSomeoneRideBtn">
                        <i class="fas fa-car"></i>
                        Request Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="orderForSomeone">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Share Ride Modal -->
    <div class="modal-overlay" id="shareRideModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-share-alt"></i>
                    Share Ride
                </div>
                <button class="modal-close" data-modal="shareRide">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="sharePickup" placeholder="Pickup location">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="sharePickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="shareDestination" placeholder="Destination">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shareDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Share Members Input -->
                <div class="form-group">
                    <label class="form-label">Add Friends by Referral Code</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" class="form-control" id="shareMemberInput" placeholder="Enter friend's referral code">
                        <button class="btn btn-secondary" id="addShareMemberBtn">
                            <i class="fas fa-plus"></i> Add
                        </button>
                    </div>
                </div>
                
                <!-- Share Members List -->
                <div class="form-group">
                    <div id="shareFriendsList" class="share-friends-list">
                        <!-- Share members will be inserted here -->
                    </div>
                </div>
                
                <!-- Share Calculations -->
                <div class="form-group" id="shareCalculations" style="display: none;">
                    <!-- Calculations will be inserted here -->
                </div>
                
                <!-- Ride Type Selection -->
                <div class="ride-type-selection" style="margin: 0 0 16px 0;">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                    </div>
                    <div class="ride-type-grid" id="shareRideTypeGrid">
                        <div class="ride-type-card economy" data-type="economy">
                            <div class="ride-type-icon">
                                <i class="fas fa-car-side"></i>
                            </div>
                            <div class="ride-type-name">Economy</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card selected" data-type="standard">
                            <div class="ride-type-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="ride-type-name">Standard</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card premium" data-type="premium">
                            <div class="ride-type-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="ride-type-name">Premium</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Estimated Fare: <span id="shareFareEstimate">ZMW 0.00</span></label>
                    <div class="price-calculation">
                        <div class="calculation-row">
                            <span>Your Share:</span>
                            <span id="yourShare">ZMW 0.00</span>
                        </div>
                        <div class="calculation-row">
                            <span>Friend's Share:</span>
                            <span id="friendShare">ZMW 0.00</span>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmShareRideBtn">
                        <i class="fas fa-user-friends"></i>
                        Share Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="shareRide">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Share Ride Invitation Modal -->
    <div class="modal-overlay" id="shareRideInvitationModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-users"></i>
                    Share Ride Invitation
                </div>
                <button class="modal-close" data-modal="shareRideInvitation">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="invitation-details" id="invitationDetails">
                    <!-- Invitation details will be inserted here -->
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" id="acceptShareInvitationBtn">
                        <i class="fas fa-check"></i>
                        Accept Invitation
                    </button>
                    <button class="btn btn-secondary" id="rejectShareInvitationBtn">
                        <i class="fas fa-times"></i>
                        Decline
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Update Profile Modal -->
    <div class="modal-overlay" id="updateProfileModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-user-edit"></i>
                    Update Profile
                </div>
                <button class="modal-close" data-modal="updateProfile">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <input type="text" class="form-control" id="updateName" placeholder="Your full name">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Phone Number</label>
                    <input type="tel" class="form-control" id="updatePhone" placeholder="Your phone number">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" class="form-control" id="updateEmail" placeholder="Your email address" readonly>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Home Address (Optional)</label>
                    <input type="text" class="form-control" id="updateHomeAddress" placeholder="Your home address">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Work Address (Optional)</label>
                    <input type="text" class="form-control" id="updateWorkAddress" placeholder="Your work address">
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="saveProfileBtn">
                        <i class="fas fa-save"></i>
                        Save Changes
                    </button>
                    <button class="btn btn-secondary" data-modal="updateProfile">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Loading...</div>
    </div>
    
    <!-- Search Loading Overlay -->
    <div id="searchLoading" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); z-index: 10000;">
        <i class="fas fa-spinner fa-spin"></i> Searching...
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Real-time Indicator -->
    <div class="real-time-indicator" id="realTimeIndicator">
        <i class="fas fa-sync-alt"></i>
        <span>Real-time updates active</span>
    </div>
    
    <!-- Sync Indicator -->
    <div class="sync-indicator" id="syncIndicator">
        <i class="fas fa-sync-alt sync-icon"></i>
        <span>Syncing...</span>
    </div>
    
    <!-- Schedule Countdown -->
    <div id="scheduleCountdown" style="display: none;"></div>
    
    <!-- External JavaScript Libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>             
    <script>
// ============================================
// FIREBASE CONFIGURATION AND INITIALIZATION
// ============================================
const firebaseConfig = {
    apiKey: "AIzaSyDEACX_P4c5q7djJAcA0I7Lk7leO2TlQ74",
    authDomain: "jubel-13e1a.firebaseapp.com",
    databaseURL: "https://jubel-13e1a-default-rtdb.firebaseio.com",
    projectId: "jubel-13e1a",
    storageBucket: "jubel-13e1a.firebasestorage.app",
    messagingSenderId: "882241095445",
    appId: "1:882241095445:web:ee9ca40fddd008ca910b1c",
    measurementId: "G-J5JPKL6B5F"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const auth = firebase.auth();
const storage = firebase.storage();

// ============================================
// ENHANCED GLOBAL STATE MANAGEMENT
// ============================================
const AppState = {
    currentUser: null,
    userData: null,
    currentRide: null,
    activeScreen: 'home',
    activeService: 'car',
    walletBalance: 0,
    userLocation: null,
    currentCity: null,
    detectedCity: null,
    selectedRideType: 'standard',
    selectedVehicle: null,
    destination: null,
    pickup: null,
    rideFare: 0,
    driverLocation: null,
    chatMessages: [],
    scheduledRides: [],
    emergencyMode: false,
    sosConfig: null,
    searchCache: new Map(),
    lastSearchTime: 0,
    notifications: [],
    unreadNotifications: 0,
    searchHistory: [],
    broadcastRecipients: [],
    emergencyStations: {
        police: [],
        fire: [],
        medical: []
    },
    realtimeListeners: [],
    rideTypes: {
        economy: { base: 15, perKm: 2.5, multiplier: 0.8, min: 10, icon: 'fa-car-side' },
        standard: { base: 20, perKm: 3.0, multiplier: 1.0, min: 15, icon: 'fa-car' },
        premium: { base: 30, perKm: 4.0, multiplier: 1.5, min: 25, icon: 'fa-crown' }
    },
    emergencyServices: {
        police: { base: 150, perKm: 5.0, multiplier: 2.0, min: 100 },
        fire: { base: 200, perKm: 6.0, multiplier: 2.5, min: 150 },
        medical: { base: 180, perKm: 5.5, multiplier: 2.2, min: 120 }
    },
    deliveryTypes: {
        standard: { base: 25, perKm: 2.0, multiplier: 1.0 },
        express: { base: 40, perKm: 3.0, multiplier: 1.5 },
        sameDay: { base: 60, perKm: 4.0, multiplier: 2.0 }
    },
    truckTypes: {
        pickup: { base: 80, perKm: 5.0, multiplier: 1.0, capacity: '1.5 tons' },
        light: { base: 120, perKm: 6.0, multiplier: 1.2, capacity: '3 tons' },
        medium: { base: 200, perKm: 8.0, multiplier: 1.5, capacity: '7 tons' },
        heavy: { base: 350, perKm: 12.0, multiplier: 2.0, capacity: '15 tons' }
    },
    lastPriceUpdate: 0,
    cityDetectionAttempts: 0,
    maxCityDetectionAttempts: 5,
    isSyncing: false,
    syncInterval: null,
    emergencyReason: null,
    selectedEmergencyStation: null,
    activeBroadcast: null,
    typingTimeout: null,
    driverTyping: false,
    locationManagement: {
        isEditingPickup: false,
        currentPickupInputId: null,
        pickupSearchResults: [],
        cityBounds: null,
        cityPolygon: null,
        userDetectedAddress: null
    },
    activeScheduledTimer: null,
    rideRequestPulsingIcons: {
        car: null,
        bike: null,
        truck: null
    },
    shareRideFriends: [],
    maxShareFriends: 3, // Maximum 3 friends for split ride
    routeDirections: null,
    pendingRideData: null,
    referralDiscountApplied: false,
    referralCodeUsed: null,
    referralOwnerName: null,
    shareRideInvitations: new Map(),
    broadcastInvitations: new Map(),
    paymentPendingMembers: new Set(),
    rideSplitDetails: null,
    activeRoute: null,
    activeFilter: 'all',
    lastSearchQuery: null,
    chatOpen: false,
    notificationsOpen: false,
    mapInitialized: false,
    // New state for enhanced features
    rideStops: [],
    shoppingCategories: {
        restaurants: ['Pizza', 'Nando\'s', 'Hungry Lion'],
        pharmacies: [],
        supermarkets: [],
        shoppingMalls: []
    },
    selectedShoppingCategory: null,
    nearbyShoppingLocations: [],
    splitRideDetails: {
        totalFriends: 0,
        acceptedFriends: 0,
        declinedFriends: 0,
        pendingFriends: 0,
        paymentSelectedFriends: 0
    },
    broadcastMembers: [],
    notificationSystem: {
        lastNotificationId: 0,
        notificationQueue: [],
        maxNotifications: 50
    },
    walletTransactions: [],
    scheduledRideTimers: new Map()
};

// ============================================
// ENHANCED MAP MANAGEMENT
// ============================================
let map = null;
let currentLocationMarker = null;
let pickupMarker = null;
let destinationMarker = null;
let driverMarker = null;
let routeLayer = null;
let emergencyMarkers = [];
let emergencyStationMarkers = [];
let cityBoundaryLayer = null;
let routePolyline = null;
let pulsingIcon = null;
let stopMarkers = [];
let shoppingLocationMarkers = [];

// ============================================
// CITY DETECTION SYSTEM (LIVE LOCATION ONLY)
// ============================================
const CityDetector = {
    async detectCityFromLocation(latitude, longitude) {
        try {
            console.log('Detecting city from live location:', latitude, longitude);
            
            const response = await fetch(
                `https://nominatim.openstreetmap.org/reverse?lat=${latitude}&lon=${longitude}&format=json&addressdetails=1`
            );
            
            if (!response.ok) {
                throw new Error(`Geocoding failed: ${response.status}`);
            }
            
            const data = await response.json();
            const address = data.address;
            
            let detectedCity = address.city || address.town || address.village || 
                              address.municipality || address.county || address.state;
            
            if (detectedCity && !detectedCity.toLowerCase().includes('zambia')) {
                detectedCity = `${detectedCity}, Zambia`;
            }
            
            if (!detectedCity) {
                throw new Error('No city detected from location');
            }
            
            console.log('City detected:', detectedCity);
            return detectedCity;
            
        } catch (error) {
            console.error('City detection error:', error);
            throw new Error('Unable to detect city from live location');
        }
    },
    
    async getDetailedAddress(latitude, longitude) {
        try {
            const response = await fetch(
                `https://nominatim.openstreetmap.org/reverse?lat=${latitude}&lon=${longitude}&format=json&addressdetails=1`
            );
            
            if (!response.ok) throw new Error('Address lookup failed');
            
            const data = await response.json();
            const address = data.address;
            
            const street = address.road || '';
            const houseNumber = address.house_number || '';
            const suburb = address.suburb || address.neighbourhood || '';
            const city = address.city || address.town || '';
            
            let formattedAddress = '';
            if (houseNumber && street) {
                formattedAddress = `${houseNumber} ${street}`;
            } else if (street) {
                formattedAddress = street;
            }
            
            if (suburb && !formattedAddress.includes(suburb)) {
                formattedAddress += formattedAddress ? `, ${suburb}` : suburb;
            }
            
            if (city && !formattedAddress.includes(city)) {
                formattedAddress += formattedAddress ? `, ${city}` : city;
            }
            
            return {
                address: formattedAddress || 'Current Location',
                fullDisplay: data.display_name || 'Current Location',
                city: city,
                latitude: latitude,
                longitude: longitude
            };
            
        } catch (error) {
            console.error('Address lookup error:', error);
            return {
                address: 'Current Location',
                fullDisplay: 'Current Location',
                city: '',
                latitude: latitude,
                longitude: longitude
            };
        }
    }
};

// ============================================
// ENHANCED SEARCH ENGINE (SPLIT-SECOND RESULTS)
// ============================================
const EnhancedSearchEngine = {
    cache: new Map(),
    lastSearch: 0,
    debounceTimer: null,
    searchHistory: [],
    maxHistoryItems: 15,
    activeSearches: new Set(),
    searchQueue: [],
    isProcessingQueue: false,
    
    init() {
        this.loadSearchHistory();
        console.log('Enhanced Search Engine initialized');
    },
    
    async search(query, type = 'destination', location = null, forceCity = null) {
        const searchId = `${Date.now()}-${Math.random()}`;
        this.activeSearches.add(searchId);
        
        try {
            const city = forceCity || AppState.currentCity;
            if (!city) {
                console.warn('No city detected for search');
                return [];
            }
            
            const cacheKey = `${query.toLowerCase()}-${type}-${city}-${location ? `${location.lat.toFixed(4)},${location.lng.toFixed(4)}` : 'none'}`;
            
            if (this.cache.has(cacheKey)) {
                const cached = this.cache.get(cacheKey);
                if (Date.now() - cached.timestamp < 300000) {
                    return cached.results;
                }
            }
            
            const searchUrl = this.buildCityConstrainedSearchUrl(query, city, location);
            
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 3000);
            
            try {
                const response = await fetch(searchUrl, {
                    signal: controller.signal,
                    headers: {
                        'User-Agent': 'JubelRideApp/1.0',
                        'Accept': 'application/json'
                    }
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`Search failed: ${response.status}`);
                }
                
                const data = await response.json();
                const results = this.processAndFilterResults(data, location, city, type);
                
                this.cache.set(cacheKey, {
                    results: results,
                    timestamp: Date.now(),
                    query: query,
                    city: city
                });
                
                if (type === 'destination' && results.length > 0) {
                    this.addToHistory(query, results[0], type);
                }
                
                return results;
                
            } catch (fetchError) {
                console.warn('Primary search failed, trying fallback:', fetchError);
                return this.fallbackSearch(query, city, location, type);
            }
            
        } catch (error) {
            console.error('Search error:', error);
            return [];
        } finally {
            this.activeSearches.delete(searchId);
        }
    },
    
    async fallbackSearch(query, city, location, type) {
        try {
            const bounds = this.getCityBounds(city);
            const simpleUrl = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}+${encodeURIComponent(city)}&format=json&limit=10&countrycodes=zm`;
            
            const response = await fetch(simpleUrl, {
                headers: { 'User-Agent': 'JubelRideApp/1.0' }
            });
            
            if (response.ok) {
                const data = await response.json();
                return this.processAndFilterResults(data, location, city, type);
            }
        } catch (error) {
            console.error('Fallback search failed:', error);
        }
        
        return [];
    },
    
    buildCityConstrainedSearchUrl(query, city, location) {
        const bounds = this.getCityBounds(city);
        if (!bounds) {
            return `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}+${encodeURIComponent(city)}&format=json&limit=15&countrycodes=zm`;
        }
        
        const params = new URLSearchParams({
            q: `${query}, ${city}, Zambia`,
            format: 'json',
            limit: 20,
            countrycodes: 'zm',
            bounded: 1,
            viewbox: bounds.join(','),
            'accept-language': 'en',
            addressdetails: 1
        });
        
        return `https://nominatim.openstreetmap.org/search?${params}`;
    },
    
    getCityBounds(cityName) {
        const cityBounds = {
            'Lusaka': [27.8, -15.8, 28.8, -15.2],
            'Ndola': [28.5, -13.1, 28.8, -12.9],
            'Kitwe': [27.9, -13.1, 28.4, -12.7],
            'Kabwe': [28.3, -14.6, 28.6, -14.3],
            'Livingstone': [25.7, -18.0, 26.0, -17.7],
            'Chipata': [32.5, -13.8, 32.8, -13.6],
            'Chingola': [27.8, -12.8, 27.9, -12.4],
            'Mufulira': [28.1, -12.7, 28.3, -12.5],
            'Luanshya': [28.3, -13.2, 28.5, -13.0],
            'Kasama': [31.1, -10.3, 31.3, -10.1],
            'Solwezi': [26.3, -12.3, 26.5, -12.1],
            'Mazabuka': [27.7, -15.9, 27.9, -15.7]
        };
        
        return cityBounds[cityName] || null;
    },
    
    processAndFilterResults(data, location, city, type) {
        if (!data || data.length === 0) return [];
        
        const cityLower = city.toLowerCase();
        const processedResults = [];
        
        data.forEach(place => {
            try {
                const address = place.address || {};
                const placeCity = address.city || address.town || address.village || address.municipality;
                const placeCityLower = placeCity ? placeCity.toLowerCase() : '';
                
                if (city && !this.isInCity(place, cityLower, placeCityLower)) {
                    return;
                }
                
                let distance = 0;
                if (location) {
                    distance = this.calculateDistance(
                        location.lat, location.lng,
                        parseFloat(place.lat), parseFloat(place.lon)
                    );
                }
                
                const displayAddress = this.formatAddress(place, city);
                
                const result = {
                    id: place.place_id || `${place.lat}-${place.lon}`,
                    name: place.display_name.split(',')[0] || 'Unnamed Location',
                    address: displayAddress,
                    fullAddress: place.display_name,
                    lat: parseFloat(place.lat),
                    lng: parseFloat(place.lon),
                    type: place.type || place.class || 'unknown',
                    importance: place.importance || 0,
                    distance: distance,
                    city: placeCity || city,
                    placeType: place.type,
                    category: this.categorizePlace(place),
                    isVerified: this.isVerifiedLocation(place)
                };
                
                processedResults.push(result);
            } catch (error) {
                console.error('Error processing search result:', error);
            }
        });
        
        return processedResults
            .sort((a, b) => {
                if (a.isVerified !== b.isVerified) return b.isVerified - a.isVerified;
                if (location && a.distance !== b.distance) return a.distance - b.distance;
                return b.importance - a.importance;
            })
            .slice(0, 10);
    },
    
    isInCity(place, targetCity, placeCity) {
        if (!targetCity) return true;
        if (placeCity && placeCity.includes(targetCity)) return true;
        
        const address = place.address || {};
        const components = [
            address.city, address.town, address.village,
            address.municipality, address.county, address.state_district
        ].filter(Boolean);
        
        return components.some(component => 
            component.toLowerCase().includes(targetCity)
        );
    },
    
    formatAddress(place, currentCity) {
        const address = place.address || {};
        const parts = [];
        
        if (address.house_number) parts.push(address.house_number);
        if (address.road) parts.push(address.road);
        if (address.suburb) parts.push(address.suburb);
        
        if (address.city) {
            const cityName = address.city;
            if (cityName.toLowerCase() !== currentCity.toLowerCase()) {
                parts.push(cityName);
            }
        }
        
        return parts.join(', ') || place.display_name.split(',').slice(0, 2).join(',').trim();
    },
    
    categorizePlace(place) {
        const type = place.type || place.class || '';
        const name = place.display_name.toLowerCase();
        
        if (type.includes('restaurant') || name.includes('restaurant') || 
            name.includes('pizza') || name.includes('nando') || name.includes('hungry lion')) {
            return 'restaurant';
        } else if (type.includes('pharmacy') || name.includes('pharmacy')) {
            return 'pharmacy';
        } else if (type.includes('supermarket') || name.includes('supermarket') || name.includes('shoprite')) {
            return 'supermarket';
        } else if (type.includes('mall') || name.includes('mall') || name.includes('shopping')) {
            return 'shopping_mall';
        } else if (type.includes('hotel')) {
            return 'hotel';
        } else if (type.includes('bank')) {
            return 'bank';
        } else if (type.includes('hospital') || type.includes('clinic')) {
            return 'medical';
        } else {
            return 'other';
        }
    },
    
    isVerifiedLocation(place) {
        const verifiedTypes = ['restaurant', 'pharmacy', 'supermarket', 'mall', 'hotel', 'bank', 'hospital'];
        const type = place.type || place.class || '';
        return verifiedTypes.some(verifiedType => type.includes(verifiedType));
    },
    
    calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = this.toRad(lat2 - lat1);
        const dLon = this.toRad(lon2 - lon1);
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(this.toRad(lat1)) * Math.cos(this.toRad(lat2)) * 
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    },
    
    toRad(value) {
        return value * Math.PI / 180;
    },
    
    loadSearchHistory() {
        try {
            const history = localStorage.getItem('jubel_search_history');
            if (history) this.searchHistory = JSON.parse(history);
        } catch (error) {
            console.error('Error loading search history:', error);
            this.searchHistory = [];
        }
    },
    
    saveSearchHistory() {
        try {
            localStorage.setItem('jubel_search_history', JSON.stringify(this.searchHistory));
        } catch (error) {
            console.error('Error saving search history:', error);
        }
    },
    
    addToHistory(query, location, type) {
        const historyItem = {
            query: query,
            location: location,
            type: type,
            timestamp: Date.now(),
            city: AppState.currentCity
        };
        
        this.searchHistory = this.searchHistory.filter(item => 
            !(item.query === query && item.type === type && item.city === AppState.currentCity)
        );
        
        this.searchHistory.unshift(historyItem);
        
        if (this.searchHistory.length > this.maxHistoryItems) {
            this.searchHistory = this.searchHistory.slice(0, this.maxHistoryItems);
        }
        
        this.saveSearchHistory();
        return historyItem;
    }
};

// ============================================
// ENHANCED LOCATION MANAGEMENT
// ============================================
const EnhancedLocationManager = {
    currentPickupInput: null,
    pickupEditMode: false,
    searchTimeout: null,
    
    init() {
        console.log('Enhanced Location Manager initialized');
        this.setupLocationInputs();
    },
    
    setupLocationInputs() {
        // Setup all pickup inputs
        const pickupInputs = [
            'pickupLocation', 'deliveryPickup', 'shortDeliveryPickup',
            'truckPickup', 'schedulePickup', 'someonePickup',
            'sharePickup', 'broadcastPickup', 'emergencyPickup'
        ];
        
        pickupInputs.forEach(inputId => {
            const input = document.getElementById(inputId);
            if (input) this.setupPickupInput(input);
        });
        
        // Setup all destination inputs
        const destinationInputs = [
            'destinationLocation', 'deliveryDestination', 'shortDeliveryDestination',
            'truckDestination', 'scheduleDestination', 'someoneDestination',
            'shareDestination', 'broadcastDestination', 'shoppingDestination',
            'emergencyDestination'
        ];
        
        destinationInputs.forEach(inputId => {
            const input = document.getElementById(inputId);
            if (input) this.setupDestinationInput(input);
        });
    },
    
    setupPickupInput(inputElement) {
        const inputId = inputElement.id;
        
        // Add clear button if not exists
        if (!inputElement.parentNode.querySelector('.clear-pickup-btn')) {
            const clearBtn = document.createElement('button');
            clearBtn.type = 'button';
            clearBtn.className = 'clear-pickup-btn';
            clearBtn.innerHTML = '<i class="fas fa-times"></i>';
            clearBtn.title = 'Clear pickup location';
            clearBtn.style.cssText = `
                position: absolute;
                right: 10px;
                top: 50%;
                transform: translateY(-50%);
                background: none;
                border: none;
                color: var(--text-gray);
                font-size: 14px;
                cursor: pointer;
                display: none;
                z-index: 10;
            `;
            
            inputElement.parentNode.style.position = 'relative';
            inputElement.parentNode.appendChild(clearBtn);
            
            clearBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.clearPickupLocation(inputId);
            });
        }
        
        // Add edit button if not exists
        if (!inputElement.parentNode.querySelector('.edit-pickup-btn')) {
            const editBtn = document.createElement('button');
            editBtn.type = 'button';
            editBtn.className = 'edit-pickup-btn';
            editBtn.innerHTML = '<i class="fas fa-edit"></i>';
            editBtn.title = 'Edit pickup location';
            editBtn.style.cssText = `
                position: absolute;
                right: 40px;
                top: 50%;
                transform: translateY(-50%);
                background: none;
                border: none;
                color: var(--primary-orange);
                font-size: 14px;
                cursor: pointer;
                display: none;
                z-index: 10;
            `;
            
            inputElement.parentNode.appendChild(editBtn);
            
            editBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.enablePickupEditMode(inputId);
            });
        }
        
        // Event listeners
        inputElement.addEventListener('focus', () => {
            this.handlePickupInputFocus(inputId);
        });
        
        inputElement.addEventListener('input', (e) => {
            this.handlePickupInputChange(inputId, e.target.value);
        });
        
        inputElement.addEventListener('blur', () => {
            setTimeout(() => {
                this.handlePickupInputBlur(inputId);
            }, 200);
        });
    },
    
    setupDestinationInput(inputElement) {
        const inputId = inputElement.id;
        
        // Create suggestions container if not exists
        if (!document.getElementById(`${inputId}Suggestions`)) {
            const suggestionsContainer = document.createElement('div');
            suggestionsContainer.id = `${inputId}Suggestions`;
            suggestionsContainer.className = 'suggestion-list';
            suggestionsContainer.style.cssText = `
                position: absolute;
                background: white;
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                max-height: 300px;
                overflow-y: auto;
                z-index: 1000;
                display: none;
                margin-top: 5px;
                width: 100%;
            `;
            inputElement.parentNode.appendChild(suggestionsContainer);
        }
        
        // Event listeners
        inputElement.addEventListener('focus', () => {
            this.handleDestinationInputFocus(inputId);
        });
        
        inputElement.addEventListener('input', (e) => {
            this.handleDestinationInputChange(inputId, e.target.value);
        });
        
        inputElement.addEventListener('blur', () => {
            setTimeout(() => {
                this.handleDestinationInputBlur(inputId);
            }, 200);
        });
    },
    
    handlePickupInputFocus(inputId) {
        const input = document.getElementById(inputId);
        const parent = input.closest('.location-input');
        
        if (parent) {
            parent.classList.add('active');
            this.updatePickupInputButtons(inputId);
        }
    },
    
    async handlePickupInputChange(inputId, value) {
        if (!value.trim() || value.length < 2) {
            const suggestions = document.getElementById(`${inputId}Suggestions`);
            if (suggestions) suggestions.classList.remove('active');
            return;
        }
        
        clearTimeout(this.searchTimeout);
        this.searchTimeout = setTimeout(async () => {
            await this.searchPickupLocations(inputId, value);
        }, 300);
    },
    
    handlePickupInputBlur(inputId) {
        const input = document.getElementById(inputId);
        const parent = input.closest('.location-input');
        if (parent) parent.classList.remove('active');
    },
    
    handleDestinationInputFocus(inputId) {
        const input = document.getElementById(inputId);
        const parent = input.closest('.location-input');
        if (parent) parent.classList.add('active');
    },
    
    async handleDestinationInputChange(inputId, value) {
        if (!value.trim() || value.length < 2) {
            const suggestions = document.getElementById(`${inputId}Suggestions`);
            if (suggestions) suggestions.style.display = 'none';
            return;
        }
        
        clearTimeout(this.searchTimeout);
        this.searchTimeout = setTimeout(async () => {
            await this.searchDestinationLocations(inputId, value);
        }, 300);
    },
    
    handleDestinationInputBlur(inputId) {
        const input = document.getElementById(inputId);
        const parent = input.closest('.location-input');
        if (parent) parent.classList.remove('active');
    },
    
    async searchPickupLocations(inputId, query) {
        if (!AppState.currentCity) {
            EnhancedUIUpdater.showToast('Please wait while we detect your city', 'warning');
            return;
        }
        
        const input = document.getElementById(inputId);
        const parent = input.closest('.location-input');
        
        if (parent) parent.classList.add('searching');
        
        try {
            const results = await EnhancedSearchEngine.search(
                query, 'pickup', AppState.userLocation, AppState.currentCity
            );
            
            EnhancedUIUpdater.showSearchSuggestions(inputId, results, 'pickup');
            AppState.locationManagement.pickupSearchResults = results;
            
        } catch (error) {
            console.error('Pickup search error:', error);
        } finally {
            if (parent) parent.classList.remove('searching');
        }
    },
    
    async searchDestinationLocations(inputId, query) {
        if (!AppState.currentCity) {
            EnhancedUIUpdater.showToast('Please wait while we detect your city', 'warning');
            return;
        }
        
        const input = document.getElementById(inputId);
        const parent = input.closest('.location-input');
        
        if (parent) parent.classList.add('searching');
        
        try {
            const results = await EnhancedSearchEngine.search(
                query, 'destination', AppState.userLocation, AppState.currentCity
            );
            
            EnhancedUIUpdater.showSearchSuggestions(inputId, results, 'destination');
            
        } catch (error) {
            console.error('Destination search error:', error);
        } finally {
            if (parent) parent.classList.remove('searching');
        }
    },
    
    clearPickupLocation(inputId) {
        const input = document.getElementById(inputId);
        const clearBtn = input.parentNode.querySelector('.clear-pickup-btn');
        const editBtn = input.parentNode.querySelector('.edit-pickup-btn');
        
        input.value = '';
        
        if (clearBtn) clearBtn.style.display = 'none';
        if (editBtn) editBtn.style.display = 'none';
        
        AppState.pickup = null;
        
        if (pickupMarker) {
            if (map) map.removeLayer(pickupMarker);
            pickupMarker = null;
        }
        
        if (routeLayer) {
            if (map) map.removeLayer(routeLayer);
            routeLayer = null;
        }
        
        EnhancedUIUpdater.showToast('Pickup location cleared', 'info');
        this.pickupEditMode = false;
        this.currentPickupInput = null;
    },
    
    enablePickupEditMode(inputId) {
        const input = document.getElementById(inputId);
        
        if (!input.value.trim()) {
            EnhancedUIUpdater.showToast('No pickup location to edit', 'warning');
            return;
        }
        
        this.pickupEditMode = true;
        this.currentPickupInput = inputId;
        
        input.focus();
        input.select();
        
        this.searchPickupLocations(inputId, input.value);
        EnhancedUIUpdater.showToast('Pickup edit mode enabled', 'info');
    },
    
    updatePickupInputButtons(inputId) {
        const input = document.getElementById(inputId);
        const clearBtn = input.parentNode.querySelector('.clear-pickup-btn');
        const editBtn = input.parentNode.querySelector('.edit-pickup-btn');
        
        if (input.value.trim()) {
            if (clearBtn) clearBtn.style.display = 'block';
            if (editBtn) editBtn.style.display = 'block';
        } else {
            if (clearBtn) clearBtn.style.display = 'none';
            if (editBtn) editBtn.style.display = 'none';
        }
    },
    
    selectPickupLocation(inputId, location) {
        const input = document.getElementById(inputId);
        const clearBtn = input.parentNode.querySelector('.clear-pickup-btn');
        const editBtn = input.parentNode.querySelector('.edit-pickup-btn');
        
        input.value = location.address || location.name;
        
        if (clearBtn) clearBtn.style.display = 'block';
        if (editBtn) editBtn.style.display = 'block';
        
        AppState.pickup = location;
        
        EnhancedUIUpdater.updatePickupMarker(location);
        
        if (AppState.destination) {
            EnhancedUIUpdater.calculateAndUpdatePrices();
            EnhancedUIUpdater.drawRoute(location, AppState.destination);
        }
        
        const suggestions = document.getElementById(`${inputId}Suggestions`);
        if (suggestions) suggestions.style.display = 'none';
    },
    
    selectDestinationLocation(inputId, location) {
        const input = document.getElementById(inputId);
        
        input.value = location.address || location.name;
        
        AppState.destination = location;
        
        EnhancedUIUpdater.updateDestinationMarker(location);
        
        if (AppState.pickup) {
            EnhancedUIUpdater.calculateAndUpdatePrices();
            EnhancedUIUpdater.drawRoute(AppState.pickup, location);
        }
        
        const suggestions = document.getElementById(`${inputId}Suggestions`);
        if (suggestions) suggestions.style.display = 'none';
    }
};

// ============================================
// ENHANCED PRICE CALCULATOR WITH STOPS SUPPORT
// ============================================
const EnhancedPriceCalculator = {
    calculateRideFare(distanceKm, rideType = 'standard', surge = 1.0, stopsCount = 0) {
        const config = AppState.rideTypes[rideType] || AppState.rideTypes.standard;
        
        let fare = config.base + (distanceKm * config.perKm);
        fare *= config.multiplier;
        fare *= surge;
        
        // Add stop charges
        if (stopsCount > 0) {
            fare += stopsCount * 10; // ZMW 10 per stop
        }
        
        // Time-based pricing
        const hour = new Date().getHours();
        if (hour >= 22 || hour <= 5) fare *= 1.2;
        else if ((hour >= 7 && hour <= 9) || (hour >= 16 && hour <= 19)) fare *= 1.3;
        
        return Math.max(fare, config.min);
    },
    
    calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    },
    
    calculateRouteWithStops(pickup, stops, destination) {
        let totalDistance = 0;
        let routePoints = [pickup];
        
        // Add stops to route points
        stops.forEach(stop => {
            routePoints.push(stop);
        });
        
        routePoints.push(destination);
        
        // Calculate total distance
        for (let i = 0; i < routePoints.length - 1; i++) {
            const distance = this.calculateDistance(
                routePoints[i].lat, routePoints[i].lng,
                routePoints[i + 1].lat, routePoints[i + 1].lng
            );
            totalDistance += distance;
        }
        
        return {
            totalDistance: totalDistance,
            routePoints: routePoints
        };
    },
    
    calculateSplitRideFare(totalFare, splitType, participants) {
        const totalPeople = participants.length + 1; // Including requester
        
        switch(splitType) {
            case 'equal':
                return totalFare / totalPeople;
            case 'you_pay_more':
                return totalFare * 0.7;
            case 'you_pay_all':
                return totalFare;
            default:
                return totalFare / totalPeople;
        }
    },
    
    getSurgeMultiplier() {
        const hour = new Date().getHours();
        const day = new Date().getDay();
        
        if (day >= 1 && day <= 5) {
            if (hour >= 7 && hour <= 9) return 1.5;
            if (hour >= 16 && hour <= 19) return 1.8;
        }
        
        if (day === 5 || day === 6) {
            if (hour >= 20 && hour <= 23) return 2.0;
        }
        
        if (hour >= 22 || hour <= 5) return 1.8;
        
        return 1.0;
    },
    
    applyReferralDiscount(fare) {
        if (AppState.referralDiscountApplied) {
            const discount = fare * 0.5;
            return {
                originalFare: fare,
                discount: discount,
                finalFare: fare - discount,
                discountApplied: true
            };
        }
        return {
            originalFare: fare,
            discount: 0,
            finalFare: fare,
            discountApplied: false
        };
    }
};

// ============================================
// STOPS MANAGEMENT SYSTEM
// ============================================
const StopsManager = {
    stops: [],
    maxStops: 5,
    
    init() {
        console.log('Stops Manager initialized');
        this.setupEventListeners();
    },
    
    setupEventListeners() {
        const addStopBtn = document.getElementById('addStopBtn');
        if (addStopBtn) {
            addStopBtn.addEventListener('click', () => {
                this.addStop();
            });
        }
    },
    
    addStop() {
        if (this.stops.length >= this.maxStops) {
            EnhancedUIUpdater.showToast(`Maximum ${this.maxStops} stops allowed`, 'warning');
            return;
        }
        
        const stopId = `stop_${Date.now()}`;
        const stopContainer = document.createElement('div');
        stopContainer.className = 'stop-item';
        stopContainer.id = stopId;
        stopContainer.innerHTML = `
            <div class="stop-input-container">
                <div class="stop-input">
                    <i class="fas fa-map-pin"></i>
                    <input type="text" class="stop-location-input" placeholder="Add stop location" data-stop-id="${stopId}">
                    <div class="stop-suggestions"></div>
                </div>
                <button class="remove-stop-btn" data-stop-id="${stopId}">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        const stopsContainer = document.getElementById('stopsContainer');
        if (stopsContainer) {
            stopsContainer.appendChild(stopContainer);
            this.setupStopInput(stopId);
        }
        
        this.stops.push({
            id: stopId,
            location: null,
            address: ''
        });
    },
    
    setupStopInput(stopId) {
        const input = document.querySelector(`#${stopId} .stop-location-input`);
        const removeBtn = document.querySelector(`#${stopId} .remove-stop-btn`);
        const suggestionsContainer = document.querySelector(`#${stopId} .stop-suggestions`);
        
        if (input) {
            input.addEventListener('focus', () => {
                input.parentElement.classList.add('active');
            });
            
            input.addEventListener('blur', () => {
                setTimeout(() => {
                    input.parentElement.classList.remove('active');
                    if (suggestionsContainer) {
                        suggestionsContainer.style.display = 'none';
                    }
                }, 200);
            });
            
            input.addEventListener('input', (e) => {
                this.handleStopInputChange(stopId, e.target.value);
            });
        }
        
        if (removeBtn) {
            removeBtn.addEventListener('click', () => {
                this.removeStop(stopId);
            });
        }
    },
    
    async handleStopInputChange(stopId, query) {
        if (!query.trim() || query.length < 2) {
            const suggestions = document.querySelector(`#${stopId} .stop-suggestions`);
            if (suggestions) suggestions.style.display = 'none';
            return;
        }
        
        if (!AppState.currentCity) {
            EnhancedUIUpdater.showToast('Please wait while we detect your city', 'warning');
            return;
        }
        
        clearTimeout(this.searchTimeout);
        this.searchTimeout = setTimeout(async () => {
            try {
                const results = await EnhancedSearchEngine.search(
                    query, 'stop', AppState.userLocation, AppState.currentCity
                );
                
                this.showStopSuggestions(stopId, results);
                
            } catch (error) {
                console.error('Stop search error:', error);
            }
        }, 300);
    },
    
    showStopSuggestions(stopId, results) {
        const suggestionsContainer = document.querySelector(`#${stopId} .stop-suggestions`);
        if (!suggestionsContainer) return;
        
        suggestionsContainer.innerHTML = '';
        
        if (results.length === 0) {
            suggestionsContainer.innerHTML = '<div class="no-results">No results found</div>';
        } else {
            results.forEach(result => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.innerHTML = `
                    <div class="suggestion-icon">
                        <i class="fas fa-map-marker-alt"></i>
                    </div>
                    <div class="suggestion-details">
                        <div class="suggestion-name">${result.name}</div>
                        <div class="suggestion-address">${result.address}</div>
                    </div>
                `;
                
                item.addEventListener('click', () => {
                    this.selectStopLocation(stopId, result);
                });
                
                suggestionsContainer.appendChild(item);
            });
        }
        
        suggestionsContainer.style.display = 'block';
    },
    
    selectStopLocation(stopId, location) {
        const stop = this.stops.find(s => s.id === stopId);
        if (stop) {
            stop.location = location;
            stop.address = location.address;
            
            const input = document.querySelector(`#${stopId} .stop-location-input`);
            if (input) input.value = location.address;
            
            const suggestions = document.querySelector(`#${stopId} .stop-suggestions`);
            if (suggestions) suggestions.style.display = 'none';
            
            // Update route and prices
            this.updateRouteWithStops();
            EnhancedUIUpdater.updatePricesWithStops();
        }
    },
    
    removeStop(stopId) {
        // Remove from DOM
        const stopElement = document.getElementById(stopId);
        if (stopElement) stopElement.remove();
        
        // Remove from array
        this.stops = this.stops.filter(stop => stop.id !== stopId);
        
        // Update route and prices
        this.updateRouteWithStops();
        EnhancedUIUpdater.updatePricesWithStops();
    },
    
    updateRouteWithStops() {
        if (!AppState.pickup || !AppState.destination) return;
        
        const validStops = this.stops.filter(stop => stop.location);
        
        if (validStops.length === 0) {
            // No stops, draw direct route
            EnhancedUIUpdater.drawRoute(AppState.pickup, AppState.destination);
            return;
        }
        
        // Collect all points for routing
        const routePoints = [AppState.pickup];
        validStops.forEach(stop => routePoints.push(stop.location));
        routePoints.push(AppState.destination);
        
        // Draw multi-point route
        EnhancedUIUpdater.drawMultiPointRoute(routePoints);
    },
    
    getValidStops() {
        return this.stops.filter(stop => stop.location).map(stop => stop.location);
    },
    
    clearAllStops() {
        this.stops = [];
        const stopsContainer = document.getElementById('stopsContainer');
        if (stopsContainer) stopsContainer.innerHTML = '';
    }
};

// ============================================
// ENHANCED UI UPDATER WITH ALL NEW FEATURES
// ============================================
const EnhancedUIUpdater = {
    updateWalletBalance(balance) {
        const formatted = `ZMW ${balance.toFixed(2)}`;
        const elements = ['walletBalance', 'accountBalance', 'paymentBalance', 'transferBalance'];
        
        elements.forEach(id => {
            const element = document.getElementById(id);
            if (element) element.textContent = formatted;
        });
        
        AppState.walletBalance = balance;
    },
    
    updateUserInfo(userData) {
        if (userData.name) {
            const userFullName = document.getElementById('userFullName');
            const accountName = document.getElementById('accountName');
            if (userFullName) userFullName.textContent = userData.name;
            if (accountName) accountName.textContent = userData.name;
        }
        
        if (userData.phone) {
            const accountPhone = document.getElementById('accountPhone');
            if (accountPhone) accountPhone.textContent = userData.phone;
        }
        
        if (userData.referralCode) {
            const referralCode = document.getElementById('referralCode');
            if (referralCode) referralCode.textContent = userData.referralCode;
        }
    },
    
    showToast(message, type = 'info', duration = 5000) {
        const toastContainer = document.getElementById('toastContainer');
        if (!toastContainer) return;
        
        const toastId = 'toast-' + Date.now();
        const icons = {
            success: 'fa-check-circle',
            error: 'fa-exclamation-circle',
            warning: 'fa-exclamation-triangle',
            info: 'fa-info-circle'
        };
        
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.id = toastId;
        toast.innerHTML = `
            <div class="toast-icon">
                <i class="fas ${icons[type] || icons.info}"></i>
            </div>
            <div class="toast-content">
                <div class="toast-title">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
                <div class="toast-message">${message}</div>
            </div>
            <button class="toast-close" onclick="document.getElementById('${toastId}').remove()">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        toastContainer.appendChild(toast);
        
        setTimeout(() => {
            const toastElement = document.getElementById(toastId);
            if (toastElement) toastElement.remove();
        }, duration);
    },
    
    showLoading(message = 'Loading...') {
        const overlay = document.getElementById('loadingOverlay');
        const text = document.getElementById('loadingText');
        if (overlay && text) {
            text.textContent = message;
            overlay.style.display = 'flex';
        }
    },
    
    hideLoading() {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) overlay.style.display = 'none';
    },
    
    updateCityDisplay(city) {
        const display = document.getElementById('currentCityDisplay');
        if (display && city) {
            display.textContent = `City: ${city}`;
            display.parentElement.style.display = 'flex';
            
            setTimeout(() => {
                if (display.parentElement) {
                    display.parentElement.style.display = 'none';
                }
            }, 5000);
        }
    },
    
    updateRidePrices(distanceKm) {
        const types = ['economy', 'standard', 'premium'];
        const surge = EnhancedPriceCalculator.getSurgeMultiplier();
        const stopsCount = StopsManager.getValidStops().length;
        
        types.forEach(type => {
            const price = EnhancedPriceCalculator.calculateRideFare(distanceKm, type, surge, stopsCount);
            const element = document.getElementById(`${type}Price`);
            if (element) {
                element.textContent = `ZMW ${price.toFixed(2)}`;
            }
        });
        
        const selectedPrice = EnhancedPriceCalculator.calculateRideFare(distanceKm, AppState.selectedRideType, surge, stopsCount);
        const estimatedFare = document.getElementById('estimatedFare');
        if (estimatedFare) estimatedFare.textContent = `ZMW ${selectedPrice.toFixed(2)}`;
        
        const time = Math.ceil((distanceKm / 35) * 60) + (stopsCount * 5);
        const distanceDetail = document.getElementById('distanceDetail');
        const timeDetail = document.getElementById('timeDetail');
        
        if (distanceDetail) distanceDetail.textContent = `${distanceKm.toFixed(1)} km`;
        if (timeDetail) timeDetail.textContent = `ETA: ${time} min`;
        
        AppState.rideFare = selectedPrice;
        
        this.updatePriceCalculator(distanceKm, AppState.selectedRideType, surge, stopsCount);
    },
    
    updatePricesWithStops() {
        if (AppState.pickup && AppState.destination) {
            const validStops = StopsManager.getValidStops();
            const routeInfo = EnhancedPriceCalculator.calculateRouteWithStops(
                AppState.pickup, validStops, AppState.destination
            );
            
            this.updateRidePrices(routeInfo.totalDistance);
        }
    },
    
    updatePriceCalculator(distanceKm, rideType = 'standard', surge = 1.0, stopsCount = 0) {
        const calculator = document.getElementById('priceCalculator');
        const fareElement = document.getElementById('calculatedFare');
        const breakdownElement = document.getElementById('priceBreakdown');
        
        if (!calculator || !fareElement || !breakdownElement) return;
        
        calculator.style.display = 'block';
        const config = AppState.rideTypes[rideType];
        const baseFare = config.base;
        const distanceFare = distanceKm * config.perKm;
        const surgeMultiplier = surge;
        const surgeAmount = (baseFare + distanceFare) * (surgeMultiplier - 1);
        const stopCharges = stopsCount * 10;
        const total = baseFare + distanceFare + surgeAmount + stopCharges;
        
        fareElement.textContent = `ZMW ${total.toFixed(2)}`;
        
        let breakdownHTML = `
            <div class="price-breakdown-row">
                <span>Base Fare:</span>
                <span>ZMW ${baseFare.toFixed(2)}</span>
            </div>
            <div class="price-breakdown-row">
                <span>Distance (${distanceKm.toFixed(1)}km):</span>
                <span>ZMW ${distanceFare.toFixed(2)}</span>
            </div>
        `;
        
        if (surgeMultiplier !== 1) {
            breakdownHTML += `
                <div class="price-breakdown-row">
                    <span>Surge Pricing:</span>
                    <span>+ZMW ${surgeAmount.toFixed(2)}</span>
                </div>
            `;
        }
        
        if (stopsCount > 0) {
            breakdownHTML += `
                <div class="price-breakdown-row">
                    <span>Stops (${stopsCount}  ZMW 10):</span>
                    <span>+ZMW ${stopCharges.toFixed(2)}</span>
                </div>
            `;
        }
        
        breakdownHTML += `
            <div class="price-breakdown-row total">
                <span>Total:</span>
                <span>ZMW ${total.toFixed(2)}</span>
            </div>
        `;
        
        breakdownElement.innerHTML = breakdownHTML;
    },
    
    showSearchSuggestions(inputId, results, type = 'destination') {
        const container = document.getElementById(`${inputId}Suggestions`);
        if (!container) return;
        
        container.innerHTML = '';
        
        if (results.length === 0) {
            container.innerHTML = `
                <div class="no-results">
                    <i class="fas fa-search"></i>
                    <div>No results found in ${AppState.currentCity}</div>
                </div>
            `;
        } else {
            results.forEach(result => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.dataset.lat = result.lat;
                item.dataset.lng = result.lng;
                item.dataset.address = result.address;
                item.dataset.name = result.name;
                
                let icon = 'fa-map-marker-alt';
                if (result.category === 'restaurant') icon = 'fa-utensils';
                else if (result.category === 'pharmacy') icon = 'fa-prescription-bottle';
                else if (result.category === 'supermarket') icon = 'fa-shopping-cart';
                else if (result.category === 'shopping_mall') icon = 'fa-store';
                else if (result.category === 'medical') icon = 'fa-hospital';
                
                item.innerHTML = `
                    <div class="suggestion-icon">
                        <i class="fas ${icon}"></i>
                    </div>
                    <div class="suggestion-details">
                        <div class="suggestion-name">${result.name}</div>
                        <div class="suggestion-address">${result.address}</div>
                        ${result.distance ? `<div class="suggestion-distance">${result.distance.toFixed(1)} km away</div>` : ''}
                    </div>
                `;
                
                item.addEventListener('click', () => {
                    if (type === 'pickup') {
                        EnhancedLocationManager.selectPickupLocation(inputId, result);
                    } else {
                        EnhancedLocationManager.selectDestinationLocation(inputId, result);
                    }
                });
                
                container.appendChild(item);
            });
        }
        
        container.style.display = 'block';
        const input = document.getElementById(inputId);
        if (input) {
            const rect = input.getBoundingClientRect();
            container.style.top = `${rect.bottom + window.scrollY}px`;
            container.style.left = `${rect.left + window.scrollX}px`;
            container.style.width = `${rect.width}px`;
        }
    },
    
    updatePickupMarker(location) {
        if (!map) return;
        
        if (pickupMarker) {
            pickupMarker.setLatLng([location.lat, location.lng]);
        } else {
            pickupMarker = L.marker([location.lat, location.lng], {
                icon: L.divIcon({
                    className: 'pickup-marker',
                    html: '<i class="fas fa-map-marker-alt"></i>',
                    iconSize: [20, 20],
                    iconAnchor: [10, 20]
                })
            }).addTo(map).bindPopup('Pickup Location');
        }
        
        map.setView([location.lat, location.lng], 15);
        
        if (AppState.destination) {
            this.drawRoute(location, AppState.destination);
        }
    },
    
    updateDestinationMarker(location) {
        if (!map) return;
        
        if (destinationMarker) {
            destinationMarker.setLatLng([location.lat, location.lng]);
        } else {
            destinationMarker = L.marker([location.lat, location.lng], {
                icon: L.divIcon({
                    className: 'destination-marker',
                    html: '<i class="fas fa-flag"></i>',
                    iconSize: [20, 20],
                    iconAnchor: [10, 20]
                })
            }).addTo(map).bindPopup('Destination');
        }
        
        if (AppState.pickup) {
            this.drawRoute(AppState.pickup, location);
        }
    },
    
    async drawRoute(start, end) {
        if (!map) return;
        
        if (routeLayer) {
            map.removeLayer(routeLayer);
        }
        
        try {
            const response = await fetch(
                `https://router.project-osrm.org/route/v1/driving/${start.lng},${start.lat};${end.lng},${end.lat}?overview=full&geometries=geojson`
            );
            
            if (response.ok) {
                const data = await response.json();
                
                if (data.routes && data.routes.length > 0) {
                    const route = data.routes[0];
                    const routeCoordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                    
                    routeLayer = L.polyline(routeCoordinates, {
                        color: '#FF6B35',
                        weight: 4,
                        opacity: 0.7
                    }).addTo(map);
                    
                    const bounds = L.latLngBounds(routeCoordinates);
                    map.fitBounds(bounds, { padding: [50, 50] });
                    
                    const distance = route.distance / 1000;
                    const duration = route.duration / 60;
                    
                    return { distance, duration };
                }
            }
        } catch (error) {
            console.error('Routing error:', error);
            // Fallback: draw straight line
            routeLayer = L.polyline([
                [start.lat, start.lng],
                [end.lat, end.lng]
            ], {
                color: '#FF6B35',
                weight: 3,
                opacity: 0.7,
                dashArray: '10, 10'
            }).addTo(map);
            
            const bounds = L.latLngBounds(
                [start.lat, start.lng],
                [end.lat, end.lng]
            );
            map.fitBounds(bounds, { padding: [50, 50] });
        }
    },
    
    drawMultiPointRoute(points) {
        if (!map || points.length < 2) return;
        
        if (routeLayer) {
            map.removeLayer(routeLayer);
        }
        
        // Draw lines between consecutive points
        const latlngs = points.map(p => [p.lat, p.lng]);
        routeLayer = L.polyline(latlngs, {
            color: '#FF6B35',
            weight: 4,
            opacity: 0.7
        }).addTo(map);
        
        // Add markers for stops
        stopMarkers.forEach(marker => map.removeLayer(marker));
        stopMarkers = [];
        
        // Add markers for all points except first (pickup) and last (destination)
        for (let i = 1; i < points.length - 1; i++) {
            const marker = L.marker([points[i].lat, points[i].lng], {
                icon: L.divIcon({
                    className: 'stop-marker',
                    html: '<i class="fas fa-map-pin"></i>',
                    iconSize: [15, 15],
                    iconAnchor: [7.5, 15]
                })
            }).addTo(map).bindPopup(`Stop ${i}`);
            stopMarkers.push(marker);
        }
        
        const bounds = L.latLngBounds(latlngs);
        map.fitBounds(bounds, { padding: [50, 50] });
    },
    
    calculateAndUpdatePrices() {
        if (AppState.pickup && AppState.destination) {
            const distance = EnhancedPriceCalculator.calculateDistance(
                AppState.pickup.lat, AppState.pickup.lng,
                AppState.destination.lat, AppState.destination.lng
            );
            
            this.updateRidePrices(distance);
            
            const fareDisplay = document.getElementById('fareDisplay');
            const rideTypeSelection = document.getElementById('rideTypeSelection');
            if (fareDisplay) fareDisplay.classList.add('active');
            if (rideTypeSelection) rideTypeSelection.classList.add('active');
        }
    },
    
    showRideInfo(ride) {
        document.querySelectorAll('.ride-request-form, .service-form, #broadcastForm').forEach(form => {
            form.style.display = 'none';
        });
        
        const rideInfoPanel = document.getElementById('rideInfoPanel');
        if (rideInfoPanel) {
            rideInfoPanel.style.display = 'block';
            rideInfoPanel.classList.add('active');
        }
        
        this.updateRideStatus(ride.status);
    },
    
    updateRideStatus(status) {
        const statusBar = document.getElementById('rideStatusBar');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const etaText = document.getElementById('etaText');
        
        if (!statusBar || !statusDot || !statusText || !etaText) return;
        
        statusBar.classList.add('active');
        
        switch(status) {
            case 'requested':
                statusDot.className = 'status-dot searching';
                statusText.textContent = 'Searching for driver';
                etaText.textContent = '5-10 min';
                this.showPulsingRideIcon();
                break;
            case 'accepted':
                statusDot.className = 'status-dot arriving';
                statusText.textContent = 'Driver on the way';
                etaText.textContent = '5 min';
                break;
            case 'arrived':
                statusDot.className = 'status-dot riding';
                statusText.textContent = 'Driver arrived';
                etaText.textContent = '0 min';
                break;
            case 'started':
                statusDot.className = 'status-dot riding';
                statusText.textContent = 'Trip in progress';
                etaText.textContent = 'En route';
                break;
            case 'completed':
                statusBar.classList.remove('active');
                break;
            case 'cancelled':
                statusBar.classList.remove('active');
                break;
        }
    },
    
    showPulsingRideIcon() {
        this.removePulsingRideIcon();
        
        let iconClass = 'fa-car';
        if (AppState.activeService === 'truck') iconClass = 'fa-truck';
        else if (AppState.activeService === 'delivery' || AppState.activeService === 'short-delivery') iconClass = 'fa-shipping-fast';
        else if (AppState.activeService === 'express') iconClass = 'fa-shopping-bag';
        
        pulsingIcon = document.createElement('div');
        pulsingIcon.id = 'pulsingRideIcon';
        pulsingIcon.className = 'pulsing-ride-icon';
        pulsingIcon.innerHTML = `<i class="fas ${iconClass}"></i>`;
        pulsingIcon.style.cssText = `
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 60px;
            color: #FF6B35;
            z-index: 1000;
            animation: pulse 1.5s infinite;
            pointer-events: none;
        `;
        
        const mapContainer = document.getElementById('map');
        if (mapContainer) mapContainer.appendChild(pulsingIcon);
    },
    
    removePulsingRideIcon() {
        const pulsingIcon = document.getElementById('pulsingRideIcon');
        if (pulsingIcon) pulsingIcon.remove();
    },
    
    showPaymentModal(amount, rideData = null) {
        if (rideData) {
            window.pendingRideData = rideData;
        } else {
            const distance = EnhancedPriceCalculator.calculateDistance(
                AppState.pickup.lat, AppState.pickup.lng,
                AppState.destination.lat, AppState.destination.lng
            );
            
            window.pendingRideData = {
                pickup: AppState.pickup.address,
                pickupDisplay: AppState.pickup.name,
                destination: AppState.destination.address,
                destinationDisplay: AppState.destination.name,
                pickupLat: AppState.pickup.lat,
                pickupLng: AppState.pickup.lng,
                destLat: AppState.destination.lat,
                destLng: AppState.destination.lng,
                rideType: AppState.selectedRideType,
                fare: amount,
                distance: distance,
                stops: StopsManager.getValidStops()
            };
        }
        
        AppState.rideFare = amount;
        document.getElementById('paymentAmount').textContent = `ZMW ${amount.toFixed(2)}`;
        
        // Show referral discount section
        const referralSection = document.getElementById('referralDiscountSection');
        if (referralSection) referralSection.style.display = 'block';
        
        // Show modal
        const modal = document.getElementById('paymentModal');
        if (modal) modal.style.display = 'block';
    },
    
    showReferralDiscount() {
        const discountData = EnhancedPriceCalculator.applyReferralDiscount(AppState.rideFare);
        
        const originalFareAmount = document.getElementById('originalFareAmount');
        const discountAmount = document.getElementById('discountAmount');
        const finalFareAmount = document.getElementById('finalFareAmount');
        const paymentAmount = document.getElementById('paymentAmount');
        
        if (originalFareAmount) originalFareAmount.textContent = `ZMW ${discountData.originalFare.toFixed(2)}`;
        if (discountAmount) discountAmount.textContent = `-ZMW ${discountData.discount.toFixed(2)}`;
        if (finalFareAmount) finalFareAmount.textContent = `ZMW ${discountData.finalFare.toFixed(2)}`;
        if (paymentAmount) paymentAmount.textContent = `ZMW ${discountData.finalFare.toFixed(2)}`;
        
        AppState.rideFare = discountData.finalFare;
    },
    
    updateNotifications(notifications) {
        const container = document.getElementById('notificationsList');
        if (!container) return;
        
        container.innerHTML = '';
        
        if (notifications.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-bell-slash"></i>
                    </div>
                    <div class="empty-title">No notifications</div>
                </div>
            `;
            return;
        }
        
        notifications.forEach(notification => {
            const item = document.createElement('div');
            item.className = `notification-item ${notification.read ? '' : 'unread'}`;
            
            let icon = 'fa-info-circle';
            if (notification.type === 'ride') icon = 'fa-car';
            else if (notification.type === 'payment') icon = 'fa-money-bill-wave';
            else if (notification.type === 'referral') icon = 'fa-gift';
            else if (notification.type === 'split_ride') icon = 'fa-user-friends';
            else if (notification.type === 'broadcast') icon = 'fa-broadcast-tower';
            
            item.innerHTML = `
                <div class="notification-icon">
                    <i class="fas ${icon}"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">${notification.title || 'Notification'}</div>
                    <div class="notification-message">${notification.message}</div>
                    <div class="notification-time">${new Date(notification.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                </div>
            `;
            
            container.appendChild(item);
        });
    },
    
    showShoppingCategories() {
        const categories = [
            { id: 'restaurants', name: 'Restaurants', icon: 'fa-utensils', items: ['Pizza', 'Nando\'s', 'Hungry Lion'] },
            { id: 'pharmacies', name: 'Pharmacies', icon: 'fa-prescription-bottle', items: [] },
            { id: 'supermarkets', name: 'Supermarkets', icon: 'fa-shopping-cart', items: [] },
            { id: 'shopping_malls', name: 'Shopping Malls', icon: 'fa-store', items: [] }
        ];
        
        let html = '<div class="shopping-categories-grid">';
        categories.forEach(category => {
            html += `
                <div class="shopping-category" data-category="${category.id}">
                    <div class="category-icon">
                        <i class="fas ${category.icon}"></i>
                    </div>
                    <div class="category-name">${category.name}</div>
                    ${category.items.length > 0 ? `
                    <div class="category-items">
                        ${category.items.map(item => `<span class="category-item">${item}</span>`).join('')}
                    </div>
                    ` : ''}
                </div>
            `;
        });
        html += '</div>';
        
        const modalContent = document.querySelector('#shoppingModal .modal-content');
        if (modalContent) {
            modalContent.innerHTML = html;
            
            // Add event listeners
            document.querySelectorAll('.shopping-category').forEach(category => {
                category.addEventListener('click', () => {
                    const categoryId = category.dataset.category;
                    this.showNearbyShoppingLocations(categoryId);
                });
            });
        }
    },
    
    async showNearbyShoppingLocations(categoryId) {
        if (!AppState.currentCity || !AppState.userLocation) {
            this.showToast('Location required to find nearby shops', 'warning');
            return;
        }
        
        let query = '';
        switch(categoryId) {
            case 'restaurants': query = 'restaurant'; break;
            case 'pharmacies': query = 'pharmacy'; break;
            case 'supermarkets': query = 'supermarket'; break;
            case 'shopping_malls': query = 'mall shopping center'; break;
        }
        
        this.showLoading('Finding nearby locations...');
        
        try {
            const results = await EnhancedSearchEngine.search(
                query, 'shopping', AppState.userLocation, AppState.currentCity
            );
            
            AppState.nearbyShoppingLocations = results;
            
            let html = `
                <div class="shopping-locations-header">
                    <button class="back-to-categories-btn">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    <h3>Nearby ${categoryId}</h3>
                </div>
                <div class="shopping-locations-list">
            `;
            
            if (results.length === 0) {
                html += '<div class="no-results">No locations found nearby</div>';
            } else {
                results.forEach(location => {
                    html += `
                        <div class="shopping-location" data-lat="${location.lat}" data-lng="${location.lng}">
                            <div class="location-icon">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="location-details">
                                <div class="location-name">${location.name}</div>
                                <div class="location-address">${location.address}</div>
                                ${location.distance ? `<div class="location-distance">${location.distance.toFixed(1)} km away</div>` : ''}
                            </div>
                            <button class="select-location-btn">Select</button>
                        </div>
                    `;
                });
            }
            
            html += '</div>';
            
            const modalContent = document.querySelector('#shoppingModal .modal-content');
            if (modalContent) {
                modalContent.innerHTML = html;
                
                // Add event listeners
                document.querySelector('.back-to-categories-btn').addEventListener('click', () => {
                    this.showShoppingCategories();
                });
                
                document.querySelectorAll('.select-location-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const locationElement = e.target.closest('.shopping-location');
                        const lat = parseFloat(locationElement.dataset.lat);
                        const lng = parseFloat(locationElement.dataset.lng);
                        const name = locationElement.querySelector('.location-name').textContent;
                        const address = locationElement.querySelector('.location-address').textContent;
                        
                        this.selectShoppingLocation({
                            lat: lat,
                            lng: lng,
                            name: name,
                            address: address
                        });
                    });
                });
            }
            
        } catch (error) {
            console.error('Error loading shopping locations:', error);
            this.showToast('Error loading locations', 'error');
        } finally {
            this.hideLoading();
        }
    },
    
    selectShoppingLocation(location) {
        // Set as pickup location
        AppState.pickup = location;
        const pickupInput = document.getElementById('pickupLocation');
        if (pickupInput) pickupInput.value = location.name;
        
        // Update marker
        this.updatePickupMarker(location);
        
        // Close modal
        const modal = document.getElementById('shoppingModal');
        if (modal) modal.style.display = 'none';
        
        this.showToast(`${location.name} selected as pickup`, 'success');
    },
    
    showEmergencyStations(stations, emergencyType) {
        const container = document.getElementById('emergencyStations');
        if (!container) return;
        
        container.innerHTML = '';
        
        if (stations.length === 0) {
            container.innerHTML = '<div class="no-stations">No emergency stations found nearby</div>';
            return;
        }
        
        stations.forEach((station, index) => {
            const stationElement = document.createElement('div');
            stationElement.className = 'emergency-station';
            stationElement.dataset.index = index;
            
            let icon = 'fa-shield-alt';
            if (emergencyType === 'medical') icon = 'fa-ambulance';
            else if (emergencyType === 'fire') icon = 'fa-fire-extinguisher';
            
            stationElement.innerHTML = `
                <div class="station-icon">
                    <i class="fas ${icon}"></i>
                </div>
                <div class="station-details">
                    <div class="station-name">${station.name}</div>
                    <div class="station-address">${station.address}</div>
                    <div class="station-distance">${station.distance.toFixed(1)} km away</div>
                </div>
                <div class="station-select">
                    <button class="select-station-btn">Select</button>
                </div>
            `;
            
            stationElement.querySelector('.select-station-btn').addEventListener('click', () => {
                this.selectEmergencyStation(station, emergencyType);
            });
            
            container.appendChild(stationElement);
        });
    },
    
    selectEmergencyStation(station, emergencyType) {
        AppState.selectedEmergencyStation = station;
        
        // Calculate fare
        const distance = station.distance;
        const config = AppState.emergencyServices[emergencyType];
        const fare = config.base + (distance * config.perKm);
        
        // Update UI
        const emergencyDistance = document.getElementById('emergencyDistance');
        const emergencyTotalFare = document.getElementById('emergencyTotalFare');
        
        if (emergencyDistance) emergencyDistance.textContent = `${distance.toFixed(1)} km`;
        if (emergencyTotalFare) emergencyTotalFare.textContent = `ZMW ${fare.toFixed(2)}`;
        
        this.showToast(`${station.name} selected`, 'success');
    },
    
    showSplitRideInvitation(invitationData) {
        const modal = document.getElementById('splitRideInvitationModal');
        if (!modal) return;
        
        modal.innerHTML = `
            <div class="modal-header">
                <h3><i class="fas fa-user-friends"></i> Split Ride Invitation</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-content">
                <div class="invitation-details">
                    <p><strong>${invitationData.hostName}</strong> invited you to share a ride</p>
                    <div class="ride-details">
                        <div><i class="fas fa-map-marker-alt"></i> ${invitationData.pickup}</div>
                        <div><i class="fas fa-flag"></i> ${invitationData.destination}</div>
                        <div><i class="fas fa-road"></i> ${invitationData.distance.toFixed(1)} km</div>
                        <div><i class="fas fa-money-bill-wave"></i> Your share: ZMW ${invitationData.yourShare.toFixed(2)}</div>
                    </div>
                </div>
                <div class="invitation-actions">
                    <button id="acceptSplitRideBtn" class="btn btn-primary">
                        <i class="fas fa-check"></i> Accept & Pay
                    </button>
                    <button id="rejectSplitRideBtn" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Decline
                    </button>
                </div>
            </div>
        `;
        
        modal.style.display = 'block';
        
        modal.querySelector('.modal-close').addEventListener('click', () => {
            modal.style.display = 'none';
        });
        
        document.getElementById('acceptSplitRideBtn').addEventListener('click', () => {
            EnhancedFirebaseManager.acceptSplitRideInvitation(invitationData.invitationId);
            modal.style.display = 'none';
        });
        
        document.getElementById('rejectSplitRideBtn').addEventListener('click', () => {
            EnhancedFirebaseManager.rejectSplitRideInvitation(invitationData.invitationId);
            modal.style.display = 'none';
        });
    },
    
    showScheduleCountdown(scheduledTime) {
        const countdownContainer = document.createElement('div');
        countdownContainer.id = 'scheduleCountdown';
        countdownContainer.className = 'schedule-countdown';
        
        const updateCountdown = () => {
            const now = Date.now();
            const timeLeft = scheduledTime - now;
            
            if (timeLeft <= 0) {
                countdownContainer.remove();
                EnhancedFirebaseManager.requestScheduledRide();
                return;
            }
            
            const hours = Math.floor(timeLeft / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
            
            countdownContainer.innerHTML = `
                <div class="countdown-header">
                    <i class="fas fa-clock"></i>
                    <span>Scheduled Ride in:</span>
                </div>
                <div class="countdown-timer">
                    <div class="time-unit">
                        <div class="time-value">${hours.toString().padStart(2, '0')}</div>
                        <div class="time-label">Hours</div>
                    </div>
                    <div class="time-separator">:</div>
                    <div class="time-unit">
                        <div class="time-value">${minutes.toString().padStart(2, '0')}</div>
                        <div class="time-label">Minutes</div>
                    </div>
                    <div class="time-separator">:</div>
                    <div class="time-unit">
                        <div class="time-value">${seconds.toString().padStart(2, '0')}</div>
                        <div class="time-label">Seconds</div>
                    </div>
                </div>
                <button id="cancelScheduleBtn" class="btn btn-danger">
                    <i class="fas fa-times"></i> Cancel Schedule
                </button>
            `;
            
            countdownContainer.querySelector('#cancelScheduleBtn').addEventListener('click', () => {
                if (confirm('Cancel this scheduled ride?')) {
                    countdownContainer.remove();
                    clearInterval(countdownInterval);
                    EnhancedFirebaseManager.cancelScheduledRide();
                }
            });
        };
        
        updateCountdown();
        const countdownInterval = setInterval(updateCountdown, 1000);
        
        const mainPanel = document.getElementById('mainPanel');
        if (mainPanel) {
            mainPanel.appendChild(countdownContainer);
        }
        
        AppState.scheduledRideTimers.set(scheduledTime, countdownInterval);
    }
};

// ============================================
// ENHANCED FIREBASE MANAGER WITH NEW FEATURES
// ============================================
const EnhancedFirebaseManager = {
    async loadUserData(uid) {
        try {
            EnhancedUIUpdater.showLoading('Loading your profile...');
            
            const snapshot = await database.ref(`users/${uid}`).once('value');
            AppState.userData = snapshot.val();
            
            if (AppState.userData) {
                AppState.walletBalance = AppState.userData.walletBalance || 0;
                EnhancedUIUpdater.updateWalletBalance(AppState.walletBalance);
                EnhancedUIUpdater.updateUserInfo(AppState.userData);
                
                await this.loadSOSConfig(uid);
                await this.loadScheduledRides(uid);
                await this.checkActiveRide(uid);
                await this.loadRideHistory(uid);
                await this.loadNotifications(uid);
                await this.loadWalletTransactions(uid);
                
                this.startRealtimeSync(uid);
                
                EnhancedUIUpdater.hideLoading();
                return true;
            }
            
            EnhancedUIUpdater.hideLoading();
            return false;
        } catch (error) {
            console.error('Error loading user data:', error);
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Error loading user data', 'error');
            return false;
        }
    },
    
    startRealtimeSync(uid) {
        this.stopRealtimeSync();
        
        console.log('Starting real-time sync for user:', uid);
        
        // User data updates
        const userRef = database.ref(`users/${uid}`);
        AppState.realtimeListeners.push(
            userRef.on('value', (snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    AppState.userData = userData;
                    AppState.walletBalance = userData.walletBalance || 0;
                    EnhancedUIUpdater.updateWalletBalance(AppState.walletBalance);
                    EnhancedUIUpdater.updateUserInfo(userData);
                }
            })
        );
        
        // Active ride updates
        const activeRideRef = database.ref('rides')
            .orderByChild('passengerId')
            .equalTo(uid)
            .orderByChild('status')
            .startAt('requested')
            .endAt('started');
        
        AppState.realtimeListeners.push(
            activeRideRef.on('value', (snapshot) => {
                const rides = snapshot.val();
                if (rides) {
                    const rideId = Object.keys(rides)[0];
                    const ride = { id: rideId, ...rides[rideId] };
                    
                    if (!AppState.currentRide || AppState.currentRide.id !== rideId) {
                        AppState.currentRide = ride;
                        EnhancedUIUpdater.showRideInfo(ride);
                        
                        if (ride.driverId) {
                            this.listenToDriverLocation(ride.driverId);
                            this.loadDriverInfo(ride.driverId);
                        }
                        
                        this.listenToChatMessages(rideId);
                    } else {
                        AppState.currentRide = ride;
                        EnhancedUIUpdater.updateRideStatus(ride.status);
                    }
                } else if (AppState.currentRide) {
                    this.resetActiveRide();
                }
            })
        );
        
        // Notifications
        const notificationsRef = database.ref(`notifications/${uid}`)
            .orderByChild('timestamp')
            .limitToLast(50);
        
        AppState.realtimeListeners.push(
            notificationsRef.on('value', (snapshot) => {
                const notifications = snapshot.val();
                if (notifications) {
                    AppState.notifications = Object.values(notifications).reverse();
                    const unreadCount = AppState.notifications.filter(n => !n.read).length;
                    AppState.unreadNotifications = unreadCount;
                    EnhancedUIUpdater.updateNotifications(AppState.notifications);
                }
            })
        );
        
        // Split ride invitations
        const splitInvitationsRef = database.ref('splitRideInvitations')
            .orderByChild('recipientId')
            .equalTo(uid)
            .orderByChild('status')
            .equalTo('pending');
        
        AppState.realtimeListeners.push(
            splitInvitationsRef.on('value', (snapshot) => {
                const invitations = snapshot.val();
                if (invitations) {
                    Object.entries(invitations).forEach(([invitationId, invitation]) => {
                        if (!AppState.shareRideInvitations.has(invitationId)) {
                            AppState.shareRideInvitations.set(invitationId, invitation);
                            EnhancedUIUpdater.showSplitRideInvitation(invitation);
                        }
                    });
                }
            })
        );
        
        EnhancedUIUpdater.showToast('Real-time updates active', 'success');
    },
    
    stopRealtimeSync() {
        AppState.realtimeListeners.forEach(listener => {
            if (listener && typeof listener === 'function') {
                listener();
            }
        });
        AppState.realtimeListeners = [];
    },
    
    async loadSOSConfig(uid) {
        try {
            const snapshot = await database.ref(`sosConfig/${uid}`).once('value');
            AppState.sosConfig = snapshot.val();
        } catch (error) {
            console.error('Error loading SOS config:', error);
        }
    },
    
    async loadScheduledRides(uid) {
        try {
            const snapshot = await database.ref('scheduledRides')
                .orderByChild('passengerId')
                .equalTo(uid)
                .orderByChild('status')
                .equalTo('scheduled')
                .once('value');
            
            const rides = snapshot.val();
            if (rides) {
                const ridesArray = Object.values(rides);
                AppState.scheduledRides = ridesArray;
                
                // Setup countdown timers for upcoming rides
                ridesArray.forEach(ride => {
                    if (ride.scheduledTime > Date.now()) {
                        const timeUntilRide = ride.scheduledTime - Date.now();
                        if (timeUntilRide <= 3600000) { // Within 1 hour
                            EnhancedUIUpdater.showScheduleCountdown(ride.scheduledTime);
                        }
                    }
                });
            }
        } catch (error) {
            console.error('Error loading scheduled rides:', error);
        }
    },
    
    async checkActiveRide(uid) {
        try {
            const snapshot = await database.ref('rides')
                .orderByChild('passengerId')
                .equalTo(uid)
                .orderByChild('status')
                .startAt('requested')
                .endAt('started')
                .once('value');
            
            const rides = snapshot.val();
            if (rides) {
                const rideId = Object.keys(rides)[0];
                AppState.currentRide = { id: rideId, ...rides[rideId] };
                EnhancedUIUpdater.showRideInfo(AppState.currentRide);
                
                this.listenToRideUpdates(rideId);
                
                if (AppState.currentRide.driverId) {
                    this.listenToDriverLocation(AppState.currentRide.driverId);
                    this.loadDriverInfo(AppState.currentRide.driverId);
                }
                
                this.listenToChatMessages(rideId);
                
                return true;
            }
            return false;
        } catch (error) {
            console.error('Error checking active ride:', error);
            return false;
        }
    },
    
    async loadRideHistory(uid) {
        try {
            EnhancedUIUpdater.showLoading('Loading ride history...');
            
            const snapshot = await database.ref('rides')
                .orderByChild('passengerId')
                .equalTo(uid)
                .once('value');
            
            const rides = snapshot.val();
            if (rides) {
                const ridesArray = Object.keys(rides).map(id => ({
                    id,
                    ...rides[id]
                })).sort((a, b) => b.timestamp - a.timestamp);
                
                // Update UI with history
                this.updateHistoryUI(ridesArray);
                
                console.log(`Loaded ${ridesArray.length} ride history items`);
            }
            
            EnhancedUIUpdater.hideLoading();
        } catch (error) {
            console.error('Error loading ride history:', error);
            EnhancedUIUpdater.hideLoading();
        }
    },
    
    async loadNotifications(uid) {
        try {
            const snapshot = await database.ref(`notifications/${uid}`)
                .orderByChild('timestamp')
                .limitToLast(50)
                .once('value');
            
            const notifications = snapshot.val();
            if (notifications) {
                AppState.notifications = Object.values(notifications).reverse();
                EnhancedUIUpdater.updateNotifications(AppState.notifications);
            }
        } catch (error) {
            console.error('Error loading notifications:', error);
        }
    },
    
    async loadWalletTransactions(uid) {
        try {
            const snapshot = await database.ref(`walletTransactions/${uid}`)
                .orderByChild('timestamp')
                .limitToLast(100)
                .once('value');
            
            const transactions = snapshot.val();
            if (transactions) {
                AppState.walletTransactions = Object.values(transactions).reverse();
            }
        } catch (error) {
            console.error('Error loading wallet transactions:', error);
        }
    },
    
    listenToRideUpdates(rideId) {
        const rideRef = database.ref(`rides/${rideId}`);
        
        AppState.realtimeListeners.push(
            rideRef.on('value', (snapshot) => {
                const ride = snapshot.val();
                if (ride) {
                    AppState.currentRide = { id: rideId, ...ride };
                    EnhancedUIUpdater.updateRideStatus(ride.status);
                    
                    if (ride.status === 'completed') {
                        this.handleRideCompletion(ride);
                    }
                    
                    if (ride.status === 'cancelled') {
                        this.resetActiveRide();
                    }
                }
            })
        );
    },
    
    listenToDriverLocation(driverId) {
        const locationRef = database.ref(`driverLocations/${driverId}`);
        
        AppState.realtimeListeners.push(
            locationRef.on('value', (snapshot) => {
                const location = snapshot.val();
                if (location) {
                    AppState.driverLocation = {
                        lat: location.latitude,
                        lng: location.longitude
                    };
                    // Update driver marker on map
                    if (driverMarker) {
                        driverMarker.setLatLng([location.latitude, location.longitude]);
                    }
                }
            })
        );
    },
    
    listenToChatMessages(rideId) {
        const chatRef = database.ref(`chats/${rideId}/messages`).orderByChild('timestamp').limitToLast(50);
        
        AppState.realtimeListeners.push(
            chatRef.on('child_added', (snapshot) => {
                const message = snapshot.val();
                if (message) {
                    // Update chat UI
                    const chatMessages = document.getElementById('chatMessages');
                    if (chatMessages) {
                        const messageDiv = document.createElement('div');
                        messageDiv.className = `message ${message.senderId === AppState.currentUser.uid ? 'sent' : 'received'}`;
                        messageDiv.innerHTML = `
                            <div class="message-text">${message.text}</div>
                            <div class="message-time">${new Date(message.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                        `;
                        chatMessages.appendChild(messageDiv);
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }
                }
            })
        );
    },
    
    async requestRide(rideData) {
        try {
            EnhancedUIUpdater.showLoading('Requesting ride...');
            
            if (!rideData.pickup || !rideData.destination) {
                throw new Error('Pickup and destination required');
            }
            
            const rideId = database.ref().child('rides').push().key;
            
            // Apply referral discount if applicable
            if (AppState.referralDiscountApplied && AppState.referralCodeUsed) {
                rideData.referredBy = AppState.referralCodeUsed;
                rideData.referralOwnerName = AppState.referralOwnerName;
                rideData.referralDiscount = rideData.fare * 0.5;
                rideData.fare = rideData.fare * 0.5;
            }
            
            const ride = {
                id: rideId,
                ...rideData,
                status: 'requested',
                timestamp: Date.now(),
                passengerId: AppState.currentUser.uid,
                passengerName: AppState.userData.name,
                city: AppState.currentCity
            };
            
            await database.ref(`rides/${rideId}`).set(ride);
            
            AppState.currentRide = ride;
            EnhancedUIUpdater.showRideInfo(ride);
            
            // Send notification to available drivers
            await this.notifyAvailableDrivers(ride);
            
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Ride requested successfully', 'success');
            
            return rideId;
        } catch (error) {
            console.error('Error requesting ride:', error);
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Error requesting ride', 'error');
            throw error;
        }
    },
    
    async notifyAvailableDrivers(ride) {
        try {
            // Find available drivers in the same city
            const driversSnapshot = await database.ref('drivers')
                .orderByChild('status')
                .equalTo('available')
                .once('value');
            
            const drivers = driversSnapshot.val();
            if (drivers) {
                Object.entries(drivers).forEach(([driverId, driver]) => {
                    if (driver.city === AppState.currentCity) {
                        // Send notification to driver
                        database.ref(`driverNotifications/${driverId}/${ride.id}`).set({
                            rideId: ride.id,
                            passengerName: ride.passengerName,
                            pickup: ride.pickup,
                            destination: ride.destination,
                            fare: ride.fare,
                            timestamp: Date.now()
                        });
                    }
                });
            }
        } catch (error) {
            console.error('Error notifying drivers:', error);
        }
    },
    
    async cancelRide(rideId, reason) {
        try {
            EnhancedUIUpdater.showLoading('Cancelling ride...');
            
            await database.ref(`rides/${rideId}/status`).set('cancelled');
            await database.ref(`rides/${rideId}/cancellationReason`).set(reason);
            await database.ref(`rides/${rideId}/cancelledAt`).set(Date.now());
            
            // Refund if paid by wallet
            const rideSnapshot = await database.ref(`rides/${rideId}`).once('value');
            const ride = rideSnapshot.val();
            
            if (ride.paymentMethod === 'wallet') {
                await this.depositMoney(ride.fare, 'Ride cancellation refund');
            }
            
            this.resetActiveRide();
            
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Ride cancelled', 'success');
            
        } catch (error) {
            console.error('Error cancelling ride:', error);
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Error cancelling ride', 'error');
        }
    },
    
    async depositMoney(amount, description = 'Deposit') {
        try {
            const newBalance = AppState.walletBalance + amount;
            const transactionId = database.ref().child('walletTransactions').push().key;
            
            const transaction = {
                id: transactionId,
                userId: AppState.currentUser.uid,
                type: 'deposit',
                amount: amount,
                description: description,
                timestamp: Date.now(),
                newBalance: newBalance
            };
            
            // Update wallet balance
            await database.ref(`users/${AppState.currentUser.uid}/walletBalance`).set(newBalance);
            
            // Record transaction
            await database.ref(`walletTransactions/${AppState.currentUser.uid}/${transactionId}`).set(transaction);
            
            AppState.walletBalance = newBalance;
            EnhancedUIUpdater.updateWalletBalance(newBalance);
            
            // Send notification
            await this.sendNotification(
                'Wallet Deposit',
                `ZMW ${amount.toFixed(2)} deposited to your wallet`,
                'payment'
            );
            
            return transactionId;
        } catch (error) {
            console.error('Error depositing money:', error);
            throw error;
        }
    },
    
    async withdrawMoney(amount, description = 'Withdrawal') {
        try {
            if (AppState.walletBalance < amount) {
                throw new Error('Insufficient balance');
            }
            
            const newBalance = AppState.walletBalance - amount;
            const transactionId = database.ref().child('walletTransactions').push().key;
            
            const transaction = {
                id: transactionId,
                userId: AppState.currentUser.uid,
                type: 'withdrawal',
                amount: amount,
                description: description,
                timestamp: Date.now(),
                newBalance: newBalance
            };
            
            // Update wallet balance
            await database.ref(`users/${AppState.currentUser.uid}/walletBalance`).set(newBalance);
            
            // Record transaction
            await database.ref(`walletTransactions/${AppState.currentUser.uid}/${transactionId}`).set(transaction);
            
            AppState.walletBalance = newBalance;
            EnhancedUIUpdater.updateWalletBalance(newBalance);
            
            return transactionId;
        } catch (error) {
            console.error('Error withdrawing money:', error);
            throw error;
        }
    },
    
    async transferMoney(recipientReferralCode, amount, message = '') {
        try {
            if (AppState.walletBalance < amount) {
                throw new Error('Insufficient balance');
            }
            
            // Find recipient by referral code
            const usersSnapshot = await database.ref('users').orderByChild('referralCode').equalTo(recipientReferralCode).once('value');
            const users = usersSnapshot.val();
            
            if (!users) {
                throw new Error('Recipient not found');
            }
            
            const recipientId = Object.keys(users)[0];
            const recipient = users[recipientId];
            
            // Perform transfer
            const senderNewBalance = AppState.walletBalance - amount;
            const recipientNewBalance = (recipient.walletBalance || 0) + amount;
            
            const transactionId = database.ref().child('walletTransactions').push().key;
            
            // Sender transaction
            const senderTransaction = {
                id: transactionId,
                userId: AppState.currentUser.uid,
                type: 'transfer_out',
                amount: amount,
                description: `Transfer to ${recipient.name}`,
                recipientId: recipientId,
                recipientName: recipient.name,
                message: message,
                timestamp: Date.now(),
                newBalance: senderNewBalance
            };
            
            // Recipient transaction
            const recipientTransaction = {
                id: transactionId,
                userId: recipientId,
                type: 'transfer_in',
                amount: amount,
                description: `Transfer from ${AppState.userData.name}`,
                senderId: AppState.currentUser.uid,
                senderName: AppState.userData.name,
                message: message,
                timestamp: Date.now(),
                newBalance: recipientNewBalance
            };
            
            // Update balances
            await database.ref(`users/${AppState.currentUser.uid}/walletBalance`).set(senderNewBalance);
            await database.ref(`users/${recipientId}/walletBalance`).set(recipientNewBalance);
            
            // Record transactions
            await database.ref(`walletTransactions/${AppState.currentUser.uid}/${transactionId}`).set(senderTransaction);
            await database.ref(`walletTransactions/${recipientId}/${transactionId}`).set(recipientTransaction);
            
            AppState.walletBalance = senderNewBalance;
            EnhancedUIUpdater.updateWalletBalance(senderNewBalance);
            
            // Send notifications
            await this.sendNotification(
                'Money Sent',
                `ZMW ${amount.toFixed(2)} sent to ${recipient.name}`,
                'payment'
            );
            
            await this.sendNotificationToUser(
                recipientId,
                'Money Received',
                `ZMW ${amount.toFixed(2)} received from ${AppState.userData.name}`,
                'payment'
            );
            
            return transactionId;
        } catch (error) {
            console.error('Error transferring money:', error);
            throw error;
        }
    },
    
    async sendNotification(title, message, type = 'info', data = {}) {
        try {
            const notificationId = database.ref().child('notifications').push().key;
            const notification = {
                id: notificationId,
                title: title,
                message: message,
                type: type,
                data: data,
                read: false,
                timestamp: Date.now()
            };
            
            await database.ref(`notifications/${AppState.currentUser.uid}/${notificationId}`).set(notification);
            
        } catch (error) {
            console.error('Error sending notification:', error);
        }
    },
    
    async sendNotificationToUser(userId, title, message, type = 'info', data = {}) {
        try {
            const notificationId = database.ref().child('notifications').push().key;
            const notification = {
                id: notificationId,
                title: title,
                message: message,
                type: type,
                data: data,
                read: false,
                timestamp: Date.now()
            };
            
            await database.ref(`notifications/${userId}/${notificationId}`).set(notification);
            
        } catch (error) {
            console.error('Error sending notification to user:', error);
        }
    },
    
    async validateReferralCode(referralCode) {
        try {
            const snapshot = await database.ref('users').orderByChild('referralCode').equalTo(referralCode).once('value');
            const users = snapshot.val();
            
            if (users) {
                const userId = Object.keys(users)[0];
                const user = users[userId];
                return {
                    valid: true,
                    userId: userId,
                    userName: user.name,
                    userPhone: user.phone
                };
            }
            
            return { valid: false };
        } catch (error) {
            console.error('Error validating referral code:', error);
            return { valid: false };
        }
    },
    
    async createSplitRide(rideData, friends) {
        try {
            EnhancedUIUpdater.showLoading('Creating split ride...');
            
            // Create main ride
            const rideId = await this.requestRide(rideData);
            
            // Calculate each friend's share
            const totalPeople = friends.length + 1;
            const friendShare = rideData.fare / totalPeople;
            
            // Send invitations to friends
            for (const friend of friends) {
                const invitationId = database.ref().child('splitRideInvitations').push().key;
                
                const invitation = {
                    id: invitationId,
                    rideId: rideId,
                    hostId: AppState.currentUser.uid,
                    hostName: AppState.userData.name,
                    recipientId: friend.userId,
                    recipientName: friend.name,
                    pickup: rideData.pickup,
                    destination: rideData.destination,
                    distance: rideData.distance,
                    totalFare: rideData.fare,
                    yourShare: friendShare,
                    status: 'pending',
                    timestamp: Date.now()
                };
                
                await database.ref(`splitRideInvitations/${invitationId}`).set(invitation);
                
                // Send notification to friend
                await this.sendNotificationToUser(
                    friend.userId,
                    'Split Ride Invitation',
                    `${AppState.userData.name} invited you to share a ride`,
                    'split_ride',
                    { invitationId: invitationId }
                );
            }
            
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Split ride invitations sent', 'success');
            
            return rideId;
        } catch (error) {
            console.error('Error creating split ride:', error);
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Error creating split ride', 'error');
            throw error;
        }
    },
    
    async acceptSplitRideInvitation(invitationId) {
        try {
            const invitationSnapshot = await database.ref(`splitRideInvitations/${invitationId}`).once('value');
            const invitation = invitationSnapshot.val();
            
            if (!invitation) {
                throw new Error('Invitation not found');
            }
            
            // Update invitation status
            await database.ref(`splitRideInvitations/${invitationId}/status`).set('accepted');
            await database.ref(`splitRideInvitations/${invitationId}/acceptedAt`).set(Date.now());
            
            // Add participant to ride
            await database.ref(`rides/${invitation.rideId}/participants/${AppState.currentUser.uid}`).set({
                userId: AppState.currentUser.uid,
                userName: AppState.userData.name,
                status: 'accepted',
                shareAmount: invitation.yourShare,
                joinedAt: Date.now()
            });
            
            // Show payment modal for the user's share
            EnhancedUIUpdater.showPaymentModal(invitation.yourShare, {
                splitRideId: invitation.rideId,
                invitationId: invitationId
            });
            
            EnhancedUIUpdater.showToast('Split ride accepted', 'success');
            
        } catch (error) {
            console.error('Error accepting split ride:', error);
            EnhancedUIUpdater.showToast('Error accepting invitation', 'error');
        }
    },
    
    async rejectSplitRideInvitation(invitationId) {
        try {
            await database.ref(`splitRideInvitations/${invitationId}/status`).set('rejected');
            await database.ref(`splitRideInvitations/${invitationId}/rejectedAt`).set(Date.now());
            
            EnhancedUIUpdater.showToast('Split ride declined', 'info');
        } catch (error) {
            console.error('Error rejecting split ride:', error);
            EnhancedUIUpdater.showToast('Error declining invitation', 'error');
        }
    },
    
    async createBroadcastRide(rideData, broadcastMembers) {
        try {
            EnhancedUIUpdater.showLoading('Creating broadcast ride...');
            
            // Create main ride
            const rideId = await this.requestRide(rideData);
            
            // Create broadcast
            const broadcastId = database.ref().child('broadcasts').push().key;
            
            const broadcast = {
                id: broadcastId,
                rideId: rideId,
                hostId: AppState.currentUser.uid,
                hostName: AppState.userData.name,
                members: broadcastMembers.map(member => ({
                    userId: member.userId,
                    userName: member.name,
                    joinedAt: Date.now()
                })),
                status: 'active',
                createdAt: Date.now()
            };
            
            await database.ref(`broadcasts/${broadcastId}`).set(broadcast);
            
            // Send notifications to members
            for (const member of broadcastMembers) {
                await this.sendNotificationToUser(
                    member.userId,
                    'Broadcast Ride',
                    `${AppState.userData.name} is sharing their ride with you`,
                    'broadcast',
                    { broadcastId: broadcastId, rideId: rideId }
                );
            }
            
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Broadcast ride created', 'success');
            
            return { rideId, broadcastId };
        } catch (error) {
            console.error('Error creating broadcast ride:', error);
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Error creating broadcast ride', 'error');
            throw error;
        }
    },
    
    async requestEmergencyRide(emergencyData) {
        try {
            EnhancedUIUpdater.showLoading('Requesting emergency ride...');
            
            const rideId = database.ref().child('emergencyRides').push().key;
            
            const ride = {
                id: rideId,
                ...emergencyData,
                status: 'requested',
                timestamp: Date.now(),
                passengerId: AppState.currentUser.uid,
                passengerName: AppState.userData.name,
                city: AppState.currentCity,
                priority: 'high'
            };
            
            await database.ref(`emergencyRides/${rideId}`).set(ride);
            
            // Notify emergency services
            await this.notifyEmergencyServices(ride);
            
            // Send SOS alert if configured
            if (AppState.sosConfig) {
                await this.sendSOSAlert(ride);
            }
            
            AppState.currentRide = ride;
            EnhancedUIUpdater.showRideInfo(ride);
            
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Emergency ride requested', 'success');
            
            return rideId;
        } catch (error) {
            console.error('Error requesting emergency ride:', error);
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Error requesting emergency ride', 'error');
            throw error;
        }
    },
    
    async notifyEmergencyServices(ride) {
        try {
            // Notify emergency service based on type
            const serviceType = ride.emergencyType;
            const serviceRef = database.ref(`emergencyServices/${serviceType}/notifications`);
            
            await serviceRef.push().set({
                rideId: ride.id,
                passengerName: ride.passengerName,
                location: ride.pickup,
                emergencyReason: ride.emergencyReason,
                timestamp: Date.now(),
                status: 'pending'
            });
        } catch (error) {
            console.error('Error notifying emergency services:', error);
        }
    },
    
    async sendSOSAlert(ride) {
        try {
            if (!AppState.sosConfig) return;
            
            // Format SOS message
            const sosMessage = `SOS ALERT: ${AppState.userData.name} needs emergency assistance.
Location: ${ride.pickup}
Emergency: ${ride.emergencyReason}
Ride to: ${ride.destination}
Time: ${new Date().toLocaleString()}`;
            
            // Here you would integrate with SMS or calling service
            // For now, just log it
            console.log('SOS Alert:', sosMessage);
            
            // Send notification to emergency contacts (simulated)
            if (AppState.sosConfig.contact1Phone) {
                console.log('Alert sent to:', AppState.sosConfig.contact1Phone);
            }
            if (AppState.sosConfig.contact2Phone) {
                console.log('Alert sent to:', AppState.sosConfig.contact2Phone);
            }
            
        } catch (error) {
            console.error('Error sending SOS alert:', error);
        }
    },
    
    async requestScheduledRide() {
        try {
            const scheduledRides = AppState.scheduledRides.filter(ride => 
                ride.scheduledTime <= Date.now() && ride.status === 'scheduled'
            );
            
            if (scheduledRides.length === 0) return;
            
            const ride = scheduledRides[0];
            
            EnhancedUIUpdater.showLoading('Requesting scheduled ride...');
            
            // Convert scheduled ride to active ride
            const rideId = database.ref().child('rides').push().key;
            
            const activeRide = {
                id: rideId,
                pickup: ride.pickup,
                destination: ride.destination,
                pickupLat: ride.pickupLat,
                pickupLng: ride.pickupLng,
                destLat: ride.destLat,
                destLng: ride.destLng,
                fare: ride.fare,
                rideType: ride.rideType,
                status: 'requested',
                timestamp: Date.now(),
                passengerId: AppState.currentUser.uid,
                passengerName: AppState.userData.name,
                scheduled: true,
                scheduledTime: ride.scheduledTime
            };
            
            await database.ref(`rides/${rideId}`).set(activeRide);
            
            // Update scheduled ride status
            await database.ref(`scheduledRides/${ride.id}/status`).set('active');
            
            AppState.currentRide = activeRide;
            EnhancedUIUpdater.showRideInfo(activeRide);
            
            await this.notifyAvailableDrivers(activeRide);
            
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Scheduled ride requested', 'success');
            
        } catch (error) {
            console.error('Error requesting scheduled ride:', error);
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Error requesting scheduled ride', 'error');
        }
    },
    
    async cancelScheduledRide(scheduledRideId) {
        try {
            await database.ref(`scheduledRides/${scheduledRideId}/status`).set('cancelled');
            await database.ref(`scheduledRides/${scheduledRideId}/cancelledAt`).set(Date.now());
            
            EnhancedUIUpdater.showToast('Scheduled ride cancelled', 'success');
        } catch (error) {
            console.error('Error cancelling scheduled ride:', error);
            EnhancedUIUpdater.showToast('Error cancelling scheduled ride', 'error');
        }
    },
    
    async sendChatMessage(rideId, message, isDriver = false) {
        try {
            const messageId = database.ref().child('messages').push().key;
            const chatMessage = {
                id: messageId,
                rideId: rideId,
                senderId: AppState.currentUser.uid,
                senderName: isDriver ? 'Driver' : AppState.userData.name,
                text: message,
                timestamp: Date.now(),
                isDriver: isDriver
            };
            
            await database.ref(`chats/${rideId}/messages/${messageId}`).set(chatMessage);
            
        } catch (error) {
            console.error('Error sending chat message:', error);
            throw error;
        }
    },
    
    resetActiveRide() {
        AppState.currentRide = null;
        EnhancedUIUpdater.removePulsingRideIcon();
        
        // Reset UI to home screen
        const homeContent = document.getElementById('homeContent');
        const rideInfoPanel = document.getElementById('rideInfoPanel');
        
        if (homeContent) homeContent.style.display = 'block';
        if (rideInfoPanel) rideInfoPanel.style.display = 'none';
    },
    
    handleRideCompletion(ride) {
        // Handle referral earnings
        if (ride.referredBy && ride.referralOwnerName) {
            this.processReferralEarnings(ride);
        }
        
        // Reset active ride
        this.resetActiveRide();
        
        // Update ride history
        this.loadRideHistory(AppState.currentUser.uid);
    },
    
    async processReferralEarnings(ride) {
        try {
            // Find referral owner
            const usersSnapshot = await database.ref('users').orderByChild('referralCode').equalTo(ride.referredBy).once('value');
            const users = usersSnapshot.val();
            
            if (!users) return;
            
            const referralOwnerId = Object.keys(users)[0];
            const referralOwner = users[referralOwnerId];
            
            // Calculate referral earnings (K25 per referral)
            const referralEarnings = 25;
            const newBalance = (referralOwner.walletBalance || 0) + referralEarnings;
            
            // Update referral owner's balance
            await database.ref(`users/${referralOwnerId}/walletBalance`).set(newBalance);
            
            // Record referral transaction
            const transactionId = database.ref().child('walletTransactions').push().key;
            const transaction = {
                id: transactionId,
                userId: referralOwnerId,
                type: 'referral_earning',
                amount: referralEarnings,
                description: `Referral from ${ride.passengerName}`,
                referredUserId: AppState.currentUser.uid,
                referredUserName: ride.passengerName,
                rideId: ride.id,
                timestamp: Date.now(),
                newBalance: newBalance
            };
            
            await database.ref(`walletTransactions/${referralOwnerId}/${transactionId}`).set(transaction);
            
            // Send notification to referral owner
            await this.sendNotificationToUser(
                referralOwnerId,
                'Referral Earnings',
                `You earned K${referralEarnings} from ${ride.passengerName}'s ride`,
                'referral',
                { rideId: ride.id, amount: referralEarnings }
            );
            
        } catch (error) {
            console.error('Error processing referral earnings:', error);
        }
    },
    
    updateHistoryUI(rides) {
        const historyList = document.getElementById('historyList');
        if (!historyList) return;
        
        historyList.innerHTML = '';
        
        if (rides.length === 0) {
            historyList.innerHTML = '<div class="empty-history">No ride history found</div>';
            return;
        }
        
        rides.forEach(ride => {
            const rideElement = document.createElement('div');
            rideElement.className = 'history-item';
            
            const date = new Date(ride.timestamp);
            let typeIcon = 'fa-car';
            let typeColor = '#FF6B35';
            
            if (ride.emergency) {
                typeIcon = 'fa-ambulance';
                typeColor = '#F44336';
            } else if (ride.scheduled) {
                typeIcon = 'fa-calendar-alt';
                typeColor = '#2196F3';
            } else if (ride.splitRide) {
                typeIcon = 'fa-user-friends';
                typeColor = '#4CAF50';
            } else if (ride.broadcast) {
                typeIcon = 'fa-broadcast-tower';
                typeColor = '#FFC107';
            }
            
            rideElement.innerHTML = `
                <div class="history-header">
                    <div class="history-type" style="color: ${typeColor}">
                        <i class="fas ${typeIcon}"></i>
                        <span>${ride.emergency ? 'Emergency' : ride.scheduled ? 'Scheduled' : ride.splitRide ? 'Split' : ride.broadcast ? 'Broadcast' : 'Standard'} Ride</span>
                    </div>
                    <div class="history-date">${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                </div>
                <div class="history-details">
                    <div><i class="fas fa-map-marker-alt"></i> ${ride.pickup}</div>
                    <div><i class="fas fa-flag"></i> ${ride.destination}</div>
                    <div><i class="fas fa-road"></i> ${ride.distance ? ride.distance.toFixed(1) + ' km' : ''}</div>
                    <div><i class="fas fa-money-bill-wave"></i> ZMW ${ride.fare ? ride.fare.toFixed(2) : '0.00'}</div>
                </div>
                <div class="history-status ${ride.status}">
                    ${ride.status.charAt(0).toUpperCase() + ride.status.slice(1)}
                </div>
            `;
            
            historyList.appendChild(rideElement);
        });
    },
    
    async loadDriverInfo(driverId) {
        try {
            const snapshot = await database.ref(`users/${driverId}`).once('value');
            const driver = snapshot.val();
            
            if (driver) {
                AppState.selectedVehicle = driver;
                
                // Update driver info in UI
                const driverName = document.getElementById('driverName');
                const driverRating = document.getElementById('driverRating');
                const vehicleDetails = document.getElementById('vehicleDetails');
                
                if (driverName) driverName.textContent = driver.name || 'Driver';
                if (driverRating) driverRating.textContent = driver.rating ? driver.rating.toFixed(1) : '4.8';
                if (vehicleDetails) {
                    vehicleDetails.textContent = driver.vehicle ? 
                        `${driver.vehicle.model || 'Car'} - ${driver.vehicle.plate || 'ABC 123'}` : 
                        'Car details not available';
                }
            }
        } catch (error) {
            console.error('Error loading driver info:', error);
        }
    }
};

// ============================================
// SHOPPING MODULE
// ============================================
const ShoppingModule = {
    init() {
        console.log('Shopping Module initialized');
        this.setupEventListeners();
    },
    
    setupEventListeners() {
        // Shopping category buttons
        const categoryButtons = [
            { id: 'restaurantsBtn', category: 'restaurants' },
            { id: 'pharmaciesBtn', category: 'pharmacies' },
            { id: 'supermarketsBtn', category: 'supermarkets' },
            { id: 'shoppingMallsBtn', category: 'shopping_malls' }
        ];
        
        categoryButtons.forEach(btn => {
            const element = document.getElementById(btn.id);
            if (element) {
                element.addEventListener('click', () => {
                    this.showCategoryLocations(btn.category);
                });
            }
        });
    },
    
    async showCategoryLocations(category) {
        if (!AppState.currentCity || !AppState.userLocation) {
            EnhancedUIUpdater.showToast('Location required to find nearby shops', 'warning');
            return;
        }
        
        let query = '';
        switch(category) {
            case 'restaurants':
                query = 'restaurant Pizza Nando\'s "Hungry Lion"';
                break;
            case 'pharmacies':
                query = 'pharmacy';
                break;
            case 'supermarkets':
                query = 'supermarket Shoprite Pick n Pay';
                break;
            case 'shopping_malls':
                query = 'mall shopping center';
                break;
        }
        
        EnhancedUIUpdater.showLoading('Finding nearby locations...');
        
        try {
            const results = await EnhancedSearchEngine.search(
                query, 'shopping', AppState.userLocation, AppState.currentCity
            );
            
            this.displayShoppingLocations(results, category);
            
        } catch (error) {
            console.error('Error loading shopping locations:', error);
            EnhancedUIUpdater.showToast('Error loading locations', 'error');
        } finally {
            EnhancedUIUpdater.hideLoading();
        }
    },
    
    displayShoppingLocations(locations, category) {
        const container = document.getElementById('shoppingLocationsContainer');
        if (!container) return;
        
        container.innerHTML = '';
        
        if (locations.length === 0) {
            container.innerHTML = '<div class="no-locations">No locations found nearby</div>';
            return;
        }
        
        let categoryName = '';
        switch(category) {
            case 'restaurants': categoryName = 'Restaurants'; break;
            case 'pharmacies': categoryName = 'Pharmacies'; break;
            case 'supermarkets': categoryName = 'Supermarkets'; break;
            case 'shopping_malls': categoryName = 'Shopping Malls'; break;
        }
        
        container.innerHTML = `<h3>Nearby ${categoryName}</h3>`;
        
        locations.forEach(location => {
            const locationElement = document.createElement('div');
            locationElement.className = 'shopping-location-item';
            locationElement.innerHTML = `
                <div class="location-icon">
                    <i class="fas fa-map-marker-alt"></i>
                </div>
                <div class="location-details">
                    <div class="location-name">${location.name}</div>
                    <div class="location-address">${location.address}</div>
                    <div class="location-distance">${location.distance ? location.distance.toFixed(1) + ' km away' : ''}</div>
                </div>
                <button class="select-location-btn" data-lat="${location.lat}" data-lng="${location.lng}">
                    Select
                </button>
            `;
            
            locationElement.querySelector('.select-location-btn').addEventListener('click', (e) => {
                const lat = parseFloat(e.target.dataset.lat);
                const lng = parseFloat(e.target.dataset.lng);
                this.selectShoppingLocation(location);
            });
            
            container.appendChild(locationElement);
        });
        
        // Show the container
        container.style.display = 'block';
    },
    
    selectShoppingLocation(location) {
        // Set as pickup location
        AppState.pickup = location;
        
        // Update pickup input
        const pickupInput = document.getElementById('pickupLocation');
        if (pickupInput) {
            pickupInput.value = location.name;
        }
        
        // Update marker
        EnhancedUIUpdater.updatePickupMarker(location);
        
        // Hide shopping locations container
        const container = document.getElementById('shoppingLocationsContainer');
        if (container) {
            container.style.display = 'none';
        }
        
        EnhancedUIUpdater.showToast(`${location.name} selected as pickup`, 'success');
    }
};

// ============================================
// SPLIT RIDE MANAGER
// ============================================
const SplitRideManager = {
    friends: [],
    maxFriends: 3,
    
    init() {
        console.log('Split Ride Manager initialized');
        this.setupEventListeners();
    },
    
    setupEventListeners() {
        const addFriendBtn = document.getElementById('addSplitFriendBtn');
        if (addFriendBtn) {
            addFriendBtn.addEventListener('click', () => {
                this.addFriend();
            });
        }
    },
    
    async addFriend() {
        if (this.friends.length >= this.maxFriends) {
            EnhancedUIUpdater.showToast(`Maximum ${this.maxFriends} friends allowed for split ride`, 'warning');
            return;
        }
        
        const friendCodeInput = document.getElementById('splitFriendCodeInput');
        if (!friendCodeInput) return;
        
        const friendCode = friendCodeInput.value.trim();
        if (!friendCode) {
            EnhancedUIUpdater.showToast('Please enter a referral code', 'warning');
            return;
        }
        
        // Validate referral code
        const validation = await EnhancedFirebaseManager.validateReferralCode(friendCode);
        
        if (!validation.valid) {
            EnhancedUIUpdater.showToast('Invalid referral code', 'error');
            return;
        }
        
        // Check if already added
        if (this.friends.some(f => f.userId === validation.userId)) {
            EnhancedUIUpdater.showToast('Friend already added', 'warning');
            return;
        }
        
        // Add friend
        const friend = {
            userId: validation.userId,
            name: validation.userName,
            referralCode: friendCode,
            status: 'pending',
            shareAmount: 0
        };
        
        this.friends.push(friend);
        this.updateFriendsList();
        
        friendCodeInput.value = '';
        
        // Recalculate prices
        this.calculateSplitPrices();
        
        EnhancedUIUpdater.showToast(`${friend.name} added to split ride`, 'success');
    },
    
    removeFriend(userId) {
        this.friends = this.friends.filter(f => f.userId !== userId);
        this.updateFriendsList();
        this.calculateSplitPrices();
    },
    
    updateFriendsList() {
        const container = document.getElementById('splitFriendsList');
        if (!container) return;
        
        container.innerHTML = '';
        
        this.friends.forEach(friend => {
            const friendElement = document.createElement('div');
            friendElement.className = 'split-friend-item';
            friendElement.innerHTML = `
                <div class="friend-info">
                    <div class="friend-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="friend-details">
                        <div class="friend-name">${friend.name}</div>
                        <div class="friend-status ${friend.status}">${friend.status}</div>
                    </div>
                </div>
                <div class="friend-share">ZMW ${friend.shareAmount.toFixed(2)}</div>
                <button class="remove-friend-btn" data-user-id="${friend.userId}">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            friendElement.querySelector('.remove-friend-btn').addEventListener('click', () => {
                this.removeFriend(friend.userId);
            });
            
            container.appendChild(friendElement);
        });
    },
    
    calculateSplitPrices() {
        if (!AppState.pickup || !AppState.destination) return;
        
        const distance = EnhancedPriceCalculator.calculateDistance(
            AppState.pickup.lat, AppState.pickup.lng,
            AppState.destination.lat, AppState.destination.lng
        );
        
        const surge = EnhancedPriceCalculator.getSurgeMultiplier();
        const totalFare = EnhancedPriceCalculator.calculateRideFare(distance, AppState.selectedRideType, surge);
        
        const totalPeople = this.friends.length + 1;
        const sharePerPerson = totalFare / totalPeople;
        
        // Update friend shares
        this.friends.forEach(friend => {
            friend.shareAmount = sharePerPerson;
        });
        
        // Update UI
        this.updateFriendsList();
        
        const yourShareElement = document.getElementById('yourSplitShare');
        const totalFareElement = document.getElementById('totalSplitFare');
        
        if (yourShareElement) yourShareElement.textContent = `ZMW ${sharePerPerson.toFixed(2)}`;
        if (totalFareElement) totalFareElement.textContent = `ZMW ${totalFare.toFixed(2)}`;
        
        return {
            totalFare: totalFare,
            yourShare: sharePerPerson,
            friendShare: sharePerPerson,
            totalPeople: totalPeople
        };
    },
    
    async requestSplitRide() {
        if (this.friends.length === 0) {
            EnhancedUIUpdater.showToast('Add at least one friend for split ride', 'warning');
            return;
        }
        
        if (!AppState.pickup || !AppState.destination) {
            EnhancedUIUpdater.showToast('Select pickup and destination locations', 'warning');
            return;
        }
        
        const splitDetails = this.calculateSplitPrices();
        
        const rideData = {
            pickup: AppState.pickup.address,
            pickupDisplay: AppState.pickup.name,
            destination: AppState.destination.address,
            destinationDisplay: AppState.destination.name,
            pickupLat: AppState.pickup.lat,
            pickupLng: AppState.pickup.lng,
            destLat: AppState.destination.lat,
            destLng: AppState.destination.lng,
            rideType: AppState.selectedRideType,
            fare: splitDetails.totalFare,
            distance: EnhancedPriceCalculator.calculateDistance(
                AppState.pickup.lat, AppState.pickup.lng,
                AppState.destination.lat, AppState.destination.lng
            ),
            splitRide: true,
            participants: [
                {
                    userId: AppState.currentUser.uid,
                    userName: AppState.userData.name,
                    status: 'accepted',
                    shareAmount: splitDetails.yourShare
                },
                ...this.friends.map(friend => ({
                    userId: friend.userId,
                    userName: friend.name,
                    status: 'pending',
                    shareAmount: friend.shareAmount
                }))
            ]
        };
        
        // Show payment modal for your share
        EnhancedUIUpdater.showPaymentModal(splitDetails.yourShare, rideData);
    }
};

// ============================================
// BROADCAST RIDE MANAGER
// ============================================
const BroadcastRideManager = {
    members: [],
    
    init() {
        console.log('Broadcast Ride Manager initialized');
        this.setupEventListeners();
    },
    
    setupEventListeners() {
        const addMemberBtn = document.getElementById('addBroadcastMemberBtn');
        if (addMemberBtn) {
            addMemberBtn.addEventListener('click', () => {
                this.addMember();
            });
        }
    },
    
    async addMember() {
        const memberCodeInput = document.getElementById('broadcastMemberInput');
        if (!memberCodeInput) return;
        
        const memberCode = memberCodeInput.value.trim();
        if (!memberCode) {
            EnhancedUIUpdater.showToast('Please enter a referral code', 'warning');
            return;
        }
        
        // Validate referral code
        const validation = await EnhancedFirebaseManager.validateReferralCode(memberCode);
        
        if (!validation.valid) {
            EnhancedUIUpdater.showToast('Invalid referral code', 'error');
            return;
        }
        
        // Check if already added
        if (this.members.some(m => m.userId === validation.userId)) {
            EnhancedUIUpdater.showToast('Member already added', 'warning');
            return;
        }
        
        // Add member
        const member = {
            userId: validation.userId,
            name: validation.userName,
            referralCode: memberCode,
            joinedAt: Date.now()
        };
        
        this.members.push(member);
        this.updateMembersList();
        
        memberCodeInput.value = '';
        
        EnhancedUIUpdater.showToast(`${member.name} added to broadcast`, 'success');
    },
    
    removeMember(userId) {
        this.members = this.members.filter(m => m.userId !== userId);
        this.updateMembersList();
    },
    
    updateMembersList() {
        const container = document.getElementById('broadcastMembersContainer');
        if (!container) return;
        
        container.innerHTML = '';
        
        this.members.forEach(member => {
            const memberElement = document.createElement('div');
            memberElement.className = 'broadcast-member-item';
            memberElement.innerHTML = `
                <div class="member-info">
                    <div class="member-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="member-details">
                        <div class="member-name">${member.name}</div>
                        <div class="member-code">${member.referralCode}</div>
                    </div>
                </div>
                <button class="remove-member-btn" data-user-id="${member.userId}">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            memberElement.querySelector('.remove-member-btn').addEventListener('click', () => {
                this.removeMember(member.userId);
            });
            
            container.appendChild(memberElement);
        });
    },
    
    async requestBroadcastRide() {
        if (this.members.length === 0) {
            EnhancedUIUpdater.showToast('Add at least one member for broadcast ride', 'warning');
            return;
        }
        
        if (!AppState.pickup || !AppState.destination) {
            EnhancedUIUpdater.showToast('Select pickup and destination locations', 'warning');
            return;
        }
        
        const distance = EnhancedPriceCalculator.calculateDistance(
            AppState.pickup.lat, AppState.pickup.lng,
            AppState.destination.lat, AppState.destination.lng
        );
        
        const surge = EnhancedPriceCalculator.getSurgeMultiplier();
        const totalFare = EnhancedPriceCalculator.calculateRideFare(distance, AppState.selectedRideType, surge);
        
        const rideData = {
            pickup: AppState.pickup.address,
            pickupDisplay: AppState.pickup.name,
            destination: AppState.destination.address,
            destinationDisplay: AppState.destination.name,
            pickupLat: AppState.pickup.lat,
            pickupLng: AppState.pickup.lng,
            destLat: AppState.destination.lat,
            destLng: AppState.destination.lng,
            rideType: AppState.selectedRideType,
            fare: totalFare,
            distance: distance,
            broadcast: true
        };
        
        // Show payment modal
        EnhancedUIUpdater.showPaymentModal(totalFare, rideData);
    }
};

// ============================================
// EMERGENCY SYSTEM
// ============================================
const EmergencySystem = {
    init() {
        console.log('Emergency System initialized');
        this.setupEventListeners();
    },
    
    setupEventListeners() {
        // Emergency service buttons
        const emergencyServices = ['police', 'medical', 'fire'];
        
        emergencyServices.forEach(service => {
            const element = document.getElementById(`${service}EmergencyBtn`);
            if (element) {
                element.addEventListener('click', () => {
                    this.handleEmergencyService(service);
                });
            }
        });
        
        // Emergency reasons
        const emergencyReasons = document.querySelectorAll('.emergency-reason');
        emergencyReasons.forEach(reason => {
            reason.addEventListener('click', () => {
                this.selectEmergencyReason(reason.dataset.reason);
            });
        });
    },
    
    async handleEmergencyService(serviceType) {
        if (!AppState.currentCity || !AppState.userLocation) {
            EnhancedUIUpdater.showToast('Location required for emergency services', 'warning');
            return;
        }
        
        EnhancedUIUpdater.showLoading('Finding emergency stations...');
        
        try {
            // Search for emergency stations
            let query = '';
            switch(serviceType) {
                case 'police': query = 'police station'; break;
                case 'medical': query = 'hospital clinic'; break;
                case 'fire': query = 'fire station'; break;
            }
            
            const results = await EnhancedSearchEngine.search(
                query, 'emergency', AppState.userLocation, AppState.currentCity
            );
            
            // Calculate distances
            const stations = results.map(station => ({
                ...station,
                distance: EnhancedPriceCalculator.calculateDistance(
                    AppState.userLocation.lat, AppState.userLocation.lng,
                    station.lat, station.lng
                )
            })).sort((a, b) => a.distance - b.distance);
            
            AppState.emergencyStations[serviceType] = stations;
            
            // Show emergency modal
            this.showEmergencyModal(serviceType, stations);
            
        } catch (error) {
            console.error('Error finding emergency stations:', error);
            EnhancedUIUpdater.showToast('Error finding emergency stations', 'error');
        } finally {
            EnhancedUIUpdater.hideLoading();
        }
    },
    
    showEmergencyModal(serviceType, stations) {
        const modal = document.getElementById('emergencyModal');
        if (!modal) return;
        
        // Update emergency service type
        const serviceTypeElement = document.getElementById('emergencyServiceType');
        if (serviceTypeElement) {
            serviceTypeElement.textContent = serviceType.charAt(0).toUpperCase() + serviceType.slice(1) + ' Emergency';
            serviceTypeElement.dataset.type = serviceType;
        }
        
        // Show stations
        EnhancedUIUpdater.showEmergencyStations(stations, serviceType);
        
        // Show modal
        modal.style.display = 'block';
    },
    
    selectEmergencyReason(reason) {
        AppState.emergencyReason = reason;
        
        // Show/hide other reason input
        const otherReasonInput = document.getElementById('emergencyOtherReason');
        if (otherReasonInput) {
            otherReasonInput.style.display = reason === 'other' ? 'block' : 'none';
        }
    },
    
    async requestEmergencyRide() {
        const emergencyType = document.getElementById('emergencyServiceType')?.dataset.type;
        const selectedStation = AppState.selectedEmergencyStation;
        const emergencyReason = AppState.emergencyReason;
        
        if (!emergencyType || !selectedStation || !emergencyReason) {
            EnhancedUIUpdater.showToast('Please complete all emergency details', 'warning');
            return;
        }
        
        // If reason is 'other', get text input
        let finalReason = emergencyReason;
        if (emergencyReason === 'other') {
            const otherReasonInput = document.getElementById('emergencyOtherReason');
            if (otherReasonInput) {
                const otherReason = otherReasonInput.value.trim();
                if (!otherReason) {
                    EnhancedUIUpdater.showToast('Please describe the emergency', 'warning');
                    return;
                }
                finalReason = otherReason;
            }
        }
        
        const distance = selectedStation.distance;
        const config = AppState.emergencyServices[emergencyType];
        const fare = config.base + (distance * config.perKm);
        
        const emergencyData = {
            emergencyType: emergencyType,
            pickup: AppState.userLocation ? 'Current Location' : 'Location not available',
            pickupLat: AppState.userLocation?.lat,
            pickupLng: AppState.userLocation?.lng,
            destination: selectedStation.name,
            destLat: selectedStation.lat,
            destLng: selectedStation.lng,
            emergencyStation: selectedStation.name,
            emergencyReason: finalReason,
            fare: fare,
            distance: distance,
            priority: 'high'
        };
        
        await EnhancedFirebaseManager.requestEmergencyRide(emergencyData);
        
        // Close modal
        const modal = document.getElementById('emergencyModal');
        if (modal) modal.style.display = 'none';
    }
};

// ============================================
// RIDE TYPE MANAGER
// ============================================
const RideTypeManager = {
    init() {
        console.log('Ride Type Manager initialized');
        this.setupEventListeners();
    },
    
    setupEventListeners() {
        // Ride type selection
        document.querySelectorAll('.ride-type-card').forEach(card => {
            card.addEventListener('click', () => {
                this.selectRideType(card.dataset.type);
            });
        });
        
        // Ride type info
        const rideTypeInfo = document.getElementById('rideTypeInfo');
        if (rideTypeInfo) {
            rideTypeInfo.addEventListener('click', () => {
                this.showRideTypeInfo();
            });
        }
    },
    
    selectRideType(rideType) {
        AppState.selectedRideType = rideType;
        
        // Update UI
        document.querySelectorAll('.ride-type-card').forEach(card => {
            card.classList.remove('selected');
        });
        
        const selectedCard = document.querySelector(`.ride-type-card[data-type="${rideType}"]`);
        if (selectedCard) {
            selectedCard.classList.add('selected');
        }
        
        // Update prices
        if (AppState.pickup && AppState.destination) {
            EnhancedUIUpdater.calculateAndUpdatePrices();
        }
    },
    
    showRideTypeInfo() {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal">
                <div class="modal-header">
                    <h3><i class="fas fa-info-circle"></i> Ride Types</h3>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-content">
                    <div class="ride-type-info">
                        <div class="info-item">
                            <div class="info-icon economy">
                                <i class="fas fa-car-side"></i>
                            </div>
                            <div class="info-details">
                                <h4>Economy</h4>
                                <p>Budget-friendly option with standard vehicles</p>
                                <p><strong>Base: ZMW ${AppState.rideTypes.economy.base}</strong></p>
                            </div>
                        </div>
                        <div class="info-item">
                            <div class="info-icon standard">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="info-details">
                                <h4>Standard</h4>
                                <p>Comfortable ride with newer vehicles</p>
                                <p><strong>Base: ZMW ${AppState.rideTypes.standard.base}</strong></p>
                            </div>
                        </div>
                        <div class="info-item">
                            <div class="info-icon premium">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="info-details">
                                <h4>Premium</h4>
                                <p>Luxury vehicles with premium service</p>
                                <p><strong>Base: ZMW ${AppState.rideTypes.premium.base}</strong></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        modal.querySelector('.modal-close').addEventListener('click', () => {
            modal.remove();
        });
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
            }
        });
    }
};

// ============================================
// NOTIFICATION MANAGER
// ============================================
const NotificationManager = {
    init() {
        console.log('Notification Manager initialized');
        this.setupEventListeners();
    },
    
    setupEventListeners() {
        const notificationBell = document.getElementById('notificationBell');
        if (notificationBell) {
            notificationBell.addEventListener('click', () => {
                this.toggleNotificationsPanel();
            });
        }
        
        const notificationsClose = document.getElementById('notificationsClose');
        if (notificationsClose) {
            notificationsClose.addEventListener('click', () => {
                this.hideNotificationsPanel();
            });
        }
    },
    
    toggleNotificationsPanel() {
        const panel = document.getElementById('notificationsPanel');
        if (panel) {
            panel.classList.toggle('active');
            AppState.notificationsOpen = panel.classList.contains('active');
        }
    },
    
    hideNotificationsPanel() {
        const panel = document.getElementById('notificationsPanel');
        if (panel) {
            panel.classList.remove('active');
            AppState.notificationsOpen = false;
        }
    },
    
    async markAsRead(notificationId) {
        try {
            await database.ref(`notifications/${AppState.currentUser.uid}/${notificationId}/read`).set(true);
        } catch (error) {
            console.error('Error marking notification as read:', error);
        }
    },
    
    async clearAllNotifications() {
        try {
            await database.ref(`notifications/${AppState.currentUser.uid}`).remove();
            EnhancedUIUpdater.showToast('Notifications cleared', 'success');
        } catch (error) {
            console.error('Error clearing notifications:', error);
            EnhancedUIUpdater.showToast('Error clearing notifications', 'error');
        }
    }
};

// ============================================
// MAP INITIALIZATION AND LOCATION MANAGEMENT
// ============================================
function initializeMap() {
    console.log('Initializing map...');
    
    // Default to Lusaka coordinates
    const defaultLat = -15.4167;
    const defaultLng = 28.2833;
    
    map = L.map('map').setView([defaultLat, defaultLng], 13);
    
    // Add OpenStreetMap tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: ' OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(map);
    
    // Add scale control
    L.control.scale().addTo(map);
    
    console.log('Map initialized');
}

async function getCurrentLocation() {
    if (!navigator.geolocation) {
        EnhancedUIUpdater.showToast('Geolocation not supported by your browser', 'warning');
        return;
    }
    
    EnhancedUIUpdater.showLoading('Getting your location...');
    
    try {
        const position = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            });
        });
        
        const { latitude, longitude } = position.coords;
        AppState.userLocation = { lat: latitude, lng: longitude };
        
        // Center map on user location
        if (map) {
            map.setView([latitude, longitude], 15);
            
            // Add user location marker
            currentLocationMarker = L.marker([latitude, longitude], {
                icon: L.divIcon({
                    className: 'current-location-marker',
                    html: '<i class="fas fa-user"></i>',
                    iconSize: [18, 18],
                    iconAnchor: [9, 18]
                })
            }).addTo(map).bindPopup('Your Location');
        }
        
        // Detect city from location
        try {
            const city = await CityDetector.detectCityFromLocation(latitude, longitude);
            AppState.currentCity = city;
            EnhancedUIUpdater.updateCityDisplay(city);
            console.log('City detected:', city);
        } catch (cityError) {
            console.error('City detection failed:', cityError);
            EnhancedUIUpdater.showToast('Unable to detect city from location', 'warning');
        }
        
        // Get detailed address
        const address = await CityDetector.getDetailedAddress(latitude, longitude);
        
        // Update pickup input with current location
        const pickupInput = document.getElementById('pickupLocation');
        if (pickupInput) {
            pickupInput.value = address.address;
            AppState.pickup = {
                lat: latitude,
                lng: longitude,
                address: address.address,
                name: 'Current Location'
            };
        }
        
        EnhancedUIUpdater.hideLoading();
        EnhancedUIUpdater.showToast('Location detected successfully', 'success');
        
    } catch (error) {
        console.error('Geolocation error:', error);
        EnhancedUIUpdater.hideLoading();
        EnhancedUIUpdater.showToast('Unable to get your location', 'warning');
    }
}

// ============================================
// SCREEN AND SERVICE MANAGEMENT
// ============================================
function switchScreen(screen) {
    console.log(`Switching to screen: ${screen}`);
    
    // Hide all screens
    document.querySelectorAll('.history-screen, .account-screen, .emergency-screen').forEach(s => {
        s.style.display = 'none';
    });
    
    // Update navigation tabs
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Show selected screen
    if (screen === 'home') {
        document.getElementById('homeContent').style.display = 'block';
        document.querySelector('.nav-tab[data-screen="home"]').classList.add('active');
        AppState.activeScreen = 'home';
    } else {
        const screenElement = document.getElementById(`${screen}Screen`);
        if (screenElement) {
            screenElement.style.display = 'block';
            screenElement.classList.add('active');
            document.querySelector(`.nav-tab[data-screen="${screen}"]`).classList.add('active');
            AppState.activeScreen = screen;
            
            // Load data for specific screens
            if (screen === 'history') {
                EnhancedFirebaseManager.loadRideHistory(AppState.currentUser.uid);
            } else if (screen === 'account') {
                // Update account info
                const accountName = document.getElementById('accountName');
                const accountPhone = document.getElementById('accountPhone');
                const accountBalance = document.getElementById('accountBalance');
                
                if (accountName && AppState.userData) accountName.textContent = AppState.userData.name;
                if (accountPhone && AppState.userData) accountPhone.textContent = AppState.userData.phone;
                if (accountBalance) accountBalance.textContent = `ZMW ${AppState.walletBalance.toFixed(2)}`;
            }
        }
    }
}

function switchService(service) {
    console.log(`Switching to service: ${service}`);
    
    // Hide all forms
    document.querySelectorAll('.ride-request-form, .service-form, #broadcastForm').forEach(form => {
        form.style.display = 'none';
    });
    
    // Update service tabs
    document.querySelectorAll('.service-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    AppState.activeService = service;
    
    switch(service) {
        case 'car':
            document.querySelector('.service-tab.car').classList.add('active');
            document.getElementById('carForm').style.display = 'block';
            break;
        case 'delivery':
            document.querySelector('.service-tab.delivery').classList.add('active');
            document.getElementById('deliveryForm').style.display = 'block';
            break;
        case 'short-delivery':
            document.querySelector('.service-tab.short-delivery').classList.add('active');
            document.getElementById('shortDeliveryForm').style.display = 'block';
            break;
        case 'express':
            document.querySelector('.service-tab[data-service="express"]').classList.add('active');
            document.getElementById('expressForm').style.display = 'block';
            break;
        case 'truck':
            document.querySelector('.service-tab[data-service="truck"]').classList.add('active');
            document.getElementById('truckForm').style.display = 'block';
            break;
        case 'broadcast':
            document.getElementById('broadcastForm').style.display = 'block';
            break;
    }
}

// ============================================
// MODAL MANAGEMENT
// ============================================
function showModal(modalId) {
    const modal = document.getElementById(`${modalId}Modal`);
    if (modal) {
        modal.style.display = 'block';
    }
}

function hideModal(modalId) {
    const modal = document.getElementById(`${modalId}Modal`);
    if (modal) {
        modal.style.display = 'none';
    }
}

function hideAllModals() {
    document.querySelectorAll('.modal-overlay').forEach(modal => {
        modal.style.display = 'none';
    });
}

// ============================================
// PANEL MANAGEMENT
// ============================================
function togglePanel() {
    const panel = document.getElementById('mainPanel');
    panel.classList.toggle('collapsed');
}

// ============================================
// EVENT LISTENER SETUP
// ============================================
function setupEventListeners() {
    console.log('Setting up event listeners...');
    
    // Navigation tabs
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const screen = tab.dataset.screen;
            switchScreen(screen);
        });
    });
    
    // Back buttons
    document.querySelectorAll('.back-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            switchScreen('home');
        });
    });
    
    // Panel handle
    const panelHandle = document.getElementById('panelHandle');
    if (panelHandle) {
        panelHandle.addEventListener('click', togglePanel);
    }
    
    // Service tabs
    document.querySelectorAll('.service-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const service = tab.dataset.service;
            switchService(service);
        });
    });
    
    // Map controls
    const locateMeBtn = document.getElementById('locateMeBtn');
    if (locateMeBtn) {
        locateMeBtn.addEventListener('click', () => {
            if (AppState.userLocation) {
                map.setView([AppState.userLocation.lat, AppState.userLocation.lng], 15);
                EnhancedUIUpdater.showToast('Centered on your location', 'info');
            } else {
                getCurrentLocation();
            }
        });
    }
    
    const zoomInBtn = document.getElementById('zoomInBtn');
    if (zoomInBtn) {
        zoomInBtn.addEventListener('click', () => {
            if (map) map.zoomIn();
        });
    }
    
    const zoomOutBtn = document.getElementById('zoomOutBtn');
    if (zoomOutBtn) {
        zoomOutBtn.addEventListener('click', () => {
            if (map) map.zoomOut();
        });
    }
    
    const clearRouteBtn = document.getElementById('clearRouteBtn');
    if (clearRouteBtn) {
        clearRouteBtn.addEventListener('click', () => {
            if (routeLayer) {
                map.removeLayer(routeLayer);
                routeLayer = null;
            }
            
            if (destinationMarker) {
                map.removeLayer(destinationMarker);
                destinationMarker = null;
            }
            
            const destinationInput = document.getElementById('destinationLocation');
            if (destinationInput) destinationInput.value = '';
            
            AppState.destination = null;
            EnhancedUIUpdater.showToast('Route cleared', 'info');
        });
    }
    
    // Request Ride button
    const requestRideBtn = document.getElementById('requestRideBtn');
    if (requestRideBtn) {
        requestRideBtn.addEventListener('click', async () => {
            if (!AppState.pickup || !AppState.destination) {
                EnhancedUIUpdater.showToast('Please select pickup and destination locations', 'warning');
                return;
            }
            
            const distance = EnhancedPriceCalculator.calculateDistance(
                AppState.pickup.lat, AppState.pickup.lng,
                AppState.destination.lat, AppState.destination.lng
            );
            
            if (distance < 0.5) {
                EnhancedUIUpdater.showToast('Minimum ride distance is 0.5 km', 'warning');
                return;
            }
            
            const surge = EnhancedPriceCalculator.getSurgeMultiplier();
            const stopsCount = StopsManager.getValidStops().length;
            const fare = EnhancedPriceCalculator.calculateRideFare(distance, AppState.selectedRideType, surge, stopsCount);
            
            EnhancedUIUpdater.showPaymentModal(fare);
        });
    }
    
    // More options button
    const moreOptionsBtn = document.getElementById('moreOptionsBtn');
    if (moreOptionsBtn) {
        moreOptionsBtn.addEventListener('click', () => {
            const menu = document.getElementById('moreOptionsMenu');
            menu.classList.toggle('active');
        });
    }
    
    // More option items
    document.querySelectorAll('#moreOptionsMenu .dropdown-item').forEach(item => {
        item.addEventListener('click', () => {
            const option = item.dataset.option;
            handleMoreOptionSelection(option);
        });
    });
    
    // SOS button
    const sosButton = document.getElementById('sosButton');
    if (sosButton) {
        sosButton.addEventListener('click', () => {
            if (!AppState.sosConfig) {
                showModal('sos');
                return;
            }
            
            if (confirm('Send SOS alert to emergency contacts?')) {
                EnhancedFirebaseManager.sendSOSAlert(AppState.currentRide);
            }
        });
    }
    
    // Cancel Ride button
    const cancelRideBtn = document.getElementById('cancelRideBtn');
    if (cancelRideBtn) {
        cancelRideBtn.addEventListener('click', () => {
            if (AppState.currentRide) {
                showModal('cancel');
            } else {
                EnhancedUIUpdater.showToast('No active ride to cancel', 'warning');
            }
        });
    }
    
    // Contact Driver button
    const contactDriverBtn = document.getElementById('contactDriverBtn');
    if (contactDriverBtn) {
        contactDriverBtn.addEventListener('click', () => {
            if (AppState.currentRide?.driverId) {
                const driverPhone = AppState.selectedVehicle?.phone;
                if (driverPhone) {
                    window.open(`tel:${driverPhone}`, '_blank');
                } else {
                    EnhancedUIUpdater.showToast('Driver phone number not available', 'warning');
                }
            } else {
                EnhancedUIUpdater.showToast('No driver assigned yet', 'warning');
            }
        });
    }
    
    // Open Chat button
    const openChatBtn = document.getElementById('openChatBtn');
    if (openChatBtn) {
        openChatBtn.addEventListener('click', () => {
            const chatContainer = document.getElementById('chatContainer');
            if (chatContainer) {
                chatContainer.classList.add('active');
            }
        });
    }
    
    // Close Chat button
    const chatClose = document.getElementById('chatClose');
    if (chatClose) {
        chatClose.addEventListener('click', () => {
            const chatContainer = document.getElementById('chatContainer');
            if (chatContainer) {
                chatContainer.classList.remove('active');
            }
        });
    }
    
    // Send Chat message
    const chatSend = document.getElementById('chatSend');
    const chatInput = document.getElementById('chatInput');
    if (chatSend && chatInput) {
        chatSend.addEventListener('click', async () => {
            const message = chatInput.value.trim();
            if (message && AppState.currentRide) {
                try {
                    await EnhancedFirebaseManager.sendChatMessage(AppState.currentRide.id, message, false);
                    chatInput.value = '';
                } catch (error) {
                    EnhancedUIUpdater.showToast('Error sending message', 'error');
                }
            }
        });
        
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                chatSend.click();
            }
        });
    }
    
    // Close modals
    document.querySelectorAll('.modal-close').forEach(btn => {
        btn.addEventListener('click', () => {
            const modal = btn.dataset.modal;
            hideModal(modal);
        });
    });
    
    // Cancel reasons
    document.querySelectorAll('.cancel-reason').forEach(reason => {
        reason.addEventListener('click', () => {
            document.querySelectorAll('.cancel-reason').forEach(r => {
                r.classList.remove('selected');
            });
            reason.classList.add('selected');
            
            const reasonType = reason.dataset.reason;
            const otherReasonGroup = document.getElementById('otherReasonGroup');
            if (otherReasonGroup) {
                otherReasonGroup.style.display = reasonType === 'other' ? 'block' : 'none';
            }
        });
    });
    
    // Confirm Cancel button
    const confirmCancelBtn = document.getElementById('confirmCancelBtn');
    if (confirmCancelBtn) {
        confirmCancelBtn.addEventListener('click', async () => {
            const selectedReason = document.querySelector('.cancel-reason.selected');
            if (!selectedReason) {
                EnhancedUIUpdater.showToast('Please select a cancellation reason', 'warning');
                return;
            }
            
            let reason = selectedReason.dataset.reason;
            if (reason === 'other') {
                const otherReason = document.getElementById('otherReason')?.value.trim();
                if (!otherReason) {
                    EnhancedUIUpdater.showToast('Please specify your reason', 'warning');
                    return;
                }
                reason = `other: ${otherReason}`;
            }
            
            if (AppState.currentRide) {
                try {
                    await EnhancedFirebaseManager.cancelRide(AppState.currentRide.id, reason);
                    hideModal('cancel');
                } catch (error) {
                    EnhancedUIUpdater.showToast('Error cancelling ride', 'error');
                }
            }
        });
    }
    
    // Payment methods
    document.querySelectorAll('.payment-method').forEach(method => {
        method.addEventListener('click', () => {
            document.querySelectorAll('.payment-method').forEach(m => {
                m.classList.remove('selected');
            });
            method.classList.add('selected');
        });
    });
    
    // Confirm Payment button
    const confirmPaymentBtn = document.getElementById('confirmPaymentBtn');
    if (confirmPaymentBtn) {
        confirmPaymentBtn.addEventListener('click', async () => {
            const selectedMethod = document.querySelector('.payment-method.selected');
            if (!selectedMethod) {
                EnhancedUIUpdater.showToast('Please select a payment method', 'warning');
                return;
            }
            
            const paymentMethod = selectedMethod.dataset.payment;
            let amount = parseFloat(document.getElementById('paymentAmount').textContent.replace('ZMW ', ''));
            
            if (AppState.referralDiscountApplied) {
                amount = amount * 0.5; // Apply 50% discount
            }
            
            if (paymentMethod === 'wallet' && AppState.walletBalance < amount) {
                EnhancedUIUpdater.showToast('Insufficient wallet balance', 'error');
                return;
            }
            
            const rideData = window.pendingRideData;
            if (!rideData) {
                EnhancedUIUpdater.showToast('No ride data found', 'error');
                return;
            }
            
            rideData.paymentMethod = paymentMethod;
            rideData.fare = amount;
            
            if (AppState.referralDiscountApplied) {
                rideData.referredBy = AppState.referralCodeUsed;
                rideData.referralOwnerName = AppState.referralOwnerName;
                rideData.referralDiscount = amount * 2; // Original fare before discount
            }
            
            try {
                if (paymentMethod === 'wallet') {
                    await EnhancedFirebaseManager.withdrawMoney(amount, 'Ride payment');
                }
                
                if (rideData.splitRide) {
                    await SplitRideManager.requestSplitRide();
                } else if (rideData.broadcast) {
                    await BroadcastRideManager.requestBroadcastRide();
                } else if (rideData.emergencyType) {
                    await EmergencySystem.requestEmergencyRide();
                } else {
                    await EnhancedFirebaseManager.requestRide(rideData);
                }
                
                hideModal('payment');
                delete window.pendingRideData;
                
                // Reset referral discount
                AppState.referralDiscountApplied = false;
                AppState.referralCodeUsed = null;
                AppState.referralOwnerName = null;
                
            } catch (error) {
                console.error('Error processing payment:', error);
                EnhancedUIUpdater.showToast('Error processing payment', 'error');
                
                // Refund wallet payment if error
                if (paymentMethod === 'wallet') {
                    await EnhancedFirebaseManager.depositMoney(amount, 'Payment refund');
                }
            }
        });
    }
    
    // Apply Referral button
    const applyReferralBtn = document.getElementById('applyReferralBtn');
    if (applyReferralBtn) {
        applyReferralBtn.addEventListener('click', async () => {
            const referralCodeInput = document.getElementById('referralCodeInput');
            if (!referralCodeInput) return;
            
            const referralCode = referralCodeInput.value.trim();
            if (!referralCode) {
                EnhancedUIUpdater.showToast('Please enter a referral code', 'warning');
                return;
            }
            
            const validation = await EnhancedFirebaseManager.validateReferralCode(referralCode);
            
            if (validation.valid) {
                AppState.referralDiscountApplied = true;
                AppState.referralCodeUsed = referralCode;
                AppState.referralOwnerName = validation.userName;
                
                EnhancedUIUpdater.showReferralDiscount();
                EnhancedUIUpdater.showToast('50% discount applied!', 'success');
            } else {
                EnhancedUIUpdater.showToast('Invalid referral code', 'error');
            }
        });
    }
    
    // Emergency Confirm button
    const confirmEmergencyBtn = document.getElementById('confirmEmergencyBtn');
    if (confirmEmergencyBtn) {
        confirmEmergencyBtn.addEventListener('click', () => {
            EmergencySystem.requestEmergencyRide();
        });
    }
    
    // Save SOS button
    const saveSOSBtn = document.getElementById('saveSOSBtn');
    if (saveSOSBtn) {
        saveSOSBtn.addEventListener('click', async () => {
            const contact1Name = document.getElementById('sosContact1Name').value.trim();
            const contact1Phone = document.getElementById('sosContact1Phone').value.trim();
            const contact2Name = document.getElementById('sosContact2Name').value.trim();
            const contact2Phone = document.getElementById('sosContact2Phone').value.trim();
            const sosMessage = document.getElementById('sosMessage').value.trim();
            
            if (!contact1Name || !contact1Phone) {
                EnhancedUIUpdater.showToast('Primary contact details required', 'warning');
                return;
            }
            
            try {
                const sosConfig = {
                    contact1Name: contact1Name,
                    contact1Phone: contact1Phone,
                    contact2Name: contact2Name,
                    contact2Phone: contact2Phone,
                    message: sosMessage || 'I need emergency assistance. My location and ride details will be shared.',
                    updatedAt: Date.now()
                };
                
                await database.ref(`sosConfig/${AppState.currentUser.uid}`).set(sosConfig);
                AppState.sosConfig = sosConfig;
                
                hideModal('sos');
                EnhancedUIUpdater.showToast('SOS configuration saved', 'success');
                
            } catch (error) {
                console.error('Error saving SOS config:', error);
                EnhancedUIUpdater.showToast('Error saving SOS configuration', 'error');
            }
        });
    }
    
    // Wallet actions
    const depositBtn = document.getElementById('depositBtn');
    if (depositBtn) {
        depositBtn.addEventListener('click', () => {
            showModal('deposit');
        });
    }
    
    const withdrawBtn = document.getElementById('withdrawBtn');
    if (withdrawBtn) {
        withdrawBtn.addEventListener('click', () => {
            showModal('withdraw');
        });
    }
    
    const transferBtn = document.getElementById('transferBtn');
    if (transferBtn) {
        transferBtn.addEventListener('click', () => {
            showModal('transfer');
        });
    }
    
    const transactionsBtn = document.getElementById('transactionsBtn');
    if (transactionsBtn) {
        transactionsBtn.addEventListener('click', () => {
            showModal('transactions');
        });
    }
    
    // Schedule Ride button
    const scheduleRideBtn = document.getElementById('scheduleRideBtn');
    if (scheduleRideBtn) {
        scheduleRideBtn.addEventListener('click', () => {
            showModal('schedule');
        });
    }
    
    // Confirm Schedule button
    const confirmScheduleBtn = document.getElementById('confirmScheduleBtn');
    if (confirmScheduleBtn) {
        confirmScheduleBtn.addEventListener('click', async () => {
            const pickupInput = document.getElementById('schedulePickup');
            const destinationInput = document.getElementById('scheduleDestination');
            const scheduleDate = document.getElementById('scheduleDate').value;
            const scheduleTime = document.getElementById('scheduleTime').value;
            
            if (!pickupInput?.value || !destinationInput?.value || !scheduleDate || !scheduleTime) {
                EnhancedUIUpdater.showToast('Please complete all schedule details', 'warning');
                return;
            }
            
            const scheduledDateTime = new Date(`${scheduleDate}T${scheduleTime}`);
            const scheduledTime = scheduledDateTime.getTime();
            
            if (scheduledTime <= Date.now()) {
                EnhancedUIUpdater.showToast('Schedule time must be in the future', 'warning');
                return;
            }
            
            const distance = EnhancedPriceCalculator.calculateDistance(
                AppState.pickup.lat, AppState.pickup.lng,
                AppState.destination.lat, AppState.destination.lng
            );
            
            const surge = EnhancedPriceCalculator.getSurgeMultiplier();
            const fare = EnhancedPriceCalculator.calculateRideFare(distance, AppState.selectedRideType, surge);
            
            const scheduledRideId = database.ref().child('scheduledRides').push().key;
            
            const scheduledRide = {
                id: scheduledRideId,
                pickup: pickupInput.value,
                destination: destinationInput.value,
                pickupLat: AppState.pickup.lat,
                pickupLng: AppState.pickup.lng,
                destLat: AppState.destination.lat,
                destLng: AppState.destination.lng,
                fare: fare,
                rideType: AppState.selectedRideType,
                scheduledTime: scheduledTime,
                status: 'scheduled',
                passengerId: AppState.currentUser.uid,
                passengerName: AppState.userData.name,
                createdAt: Date.now()
            };
            
            try {
                await database.ref(`scheduledRides/${scheduledRideId}`).set(scheduledRide);
                
                AppState.scheduledRides.push(scheduledRide);
                
                // Show countdown timer
                EnhancedUIUpdater.showScheduleCountdown(scheduledTime);
                
                hideModal('schedule');
                EnhancedUIUpdater.showToast('Ride scheduled successfully', 'success');
                
            } catch (error) {
                console.error('Error scheduling ride:', error);
                EnhancedUIUpdater.showToast('Error scheduling ride', 'error');
            }
        });
    }
    
    // Share Referral button
    const shareReferralBtn = document.getElementById('shareReferralBtn');
    if (shareReferralBtn) {
        shareReferralBtn.addEventListener('click', () => {
            const referralCode = document.getElementById('referralCode').textContent;
            const shareText = `Join me on Jubel! Use my referral code ${referralCode} for 50% off your first ride. Download the app now!`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Join Jubel',
                    text: shareText,
                    url: window.location.href
                });
            } else {
                // Fallback: copy to clipboard
                navigator.clipboard.writeText(shareText);
                EnhancedUIUpdater.showToast('Referral link copied to clipboard', 'success');
            }
        });
    }
    
    // Logout button
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to logout?')) {
                auth.signOut().then(() => {
                    window.location.href = 'signup.html';
                });
            }
        });
    }
    
    // Update Profile button
    const updateProfileBtn = document.getElementById('updateProfileBtn');
    if (updateProfileBtn) {
        updateProfileBtn.addEventListener('click', () => {
            showModal('updateProfile');
        });
    }
    
    // Save Profile button
    const saveProfileBtn = document.getElementById('saveProfileBtn');
    if (saveProfileBtn) {
        saveProfileBtn.addEventListener('click', async () => {
            const updateName = document.getElementById('updateName').value.trim();
            const updatePhone = document.getElementById('updatePhone').value.trim();
            const updateHomeAddress = document.getElementById('updateHomeAddress').value.trim();
            const updateWorkAddress = document.getElementById('updateWorkAddress').value.trim();
            
            if (!updateName) {
                EnhancedUIUpdater.showToast('Name is required', 'warning');
                return;
            }
            
            try {
                const updates = {
                    name: updateName,
                    phone: updatePhone,
                    homeAddress: updateHomeAddress,
                    workAddress: updateWorkAddress,
                    updatedAt: Date.now()
                };
                
                await database.ref(`users/${AppState.currentUser.uid}`).update(updates);
                
                hideModal('updateProfile');
                EnhancedUIUpdater.showToast('Profile updated successfully', 'success');
                
            } catch (error) {
                console.error('Error updating profile:', error);
                EnhancedUIUpdater.showToast('Error updating profile', 'error');
            }
        });
    }
    
    // History filters
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.filter-btn').forEach(b => {
                b.classList.remove('active');
            });
            btn.classList.add('active');
            
            AppState.activeFilter = btn.dataset.filter;
            EnhancedFirebaseManager.loadRideHistory(AppState.currentUser.uid);
        });
    });
    
    console.log('Event listeners setup completed');
}

function handleMoreOptionSelection(option) {
    switch(option) {
        case 'schedule':
            showModal('schedule');
            break;
        case 'orderForSomeone':
            showModal('orderForSomeone');
            break;
        case 'shareRide':
            showModal('shareRide');
            break;
        case 'broadcast':
            switchService('broadcast');
            break;
    }
}

// ============================================
// INITIALIZE APPLICATION
// ============================================
async function initializeApp() {
    try {
        console.log('Initializing Jubel Passenger App...');
        
        EnhancedUIUpdater.showLoading('Initializing app...');
        
        // Initialize modules
        EnhancedSearchEngine.init();
        EnhancedLocationManager.init();
        StopsManager.init();
        RideTypeManager.init();
        ShoppingModule.init();
        SplitRideManager.init();
        BroadcastRideManager.init();
        EmergencySystem.init();
        NotificationManager.init();
        
        // Check authentication
        const urlParams = new URLSearchParams(window.location.search);
        const email = urlParams.get('email');
        const uid = urlParams.get('uid');
        
        if (email && uid) {
            console.log('Authenticated via URL parameters');
            AppState.currentUser = { uid, email };
            await EnhancedFirebaseManager.loadUserData(uid);
        } else {
            console.log('Checking Firebase auth state...');
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    console.log('User authenticated:', user.uid);
                    AppState.currentUser = user;
                    await EnhancedFirebaseManager.loadUserData(user.uid);
                } else {
                    console.log('No user logged in, redirecting to signup');
                    window.location.href = 'signup.html';
                }
            });
        }
        
        // Initialize map
        initializeMap();
        
        // Setup event listeners
        setupEventListeners();
        
        // Get current location
        getCurrentLocation();
        
        // Set minimum date for schedule
        const today = new Date().toISOString().split('T')[0];
        const scheduleDate = document.getElementById('scheduleDate');
        if (scheduleDate) scheduleDate.min = today;
        
        // Setup sync interval
        AppState.syncInterval = setInterval(() => {
            EnhancedFirebaseManager.syncUserData();
        }, 60000);
        
        EnhancedUIUpdater.hideLoading();
        EnhancedUIUpdater.showToast('Jubel Passenger App Ready', 'success');
        
        console.log('App initialization completed successfully');
        
    } catch (error) {
        console.error('Error initializing app:', error);
        EnhancedUIUpdater.hideLoading();
        EnhancedUIUpdater.showToast('Error initializing app', 'error');
    }
}

// Start the application when window loads
window.addEventListener('load', initializeApp);
</script>
</body>
</html>




