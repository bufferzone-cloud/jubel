<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jubel - Passenger</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ============================================
           ENHANCED ROOT VARIABLES WITH ADDITIONAL COLORS
           ============================================ */
        :root {
            --primary-orange: #FF6B35;
            --primary-red: #E74C3C;
            --primary-gradient: linear-gradient(135deg, #FF6B35, #E74C3C);
            --secondary-orange: #E55A28;
            --secondary-red: #C0392B;
            --light-orange: #FFF5F0;
            --light-red: #FCE8E6;
            --white: #FFFFFF;
            --off-white: #F9F9F9;
            --light-gray: #F5F5F5;
            --medium-gray: #E0E0E0;
            --dark-gray: #333333;
            --text-gray: #666666;
            --text-light: #888888;
            --success-green: #2ECC71;
            --warning-yellow: #F39C12;
            --info-blue: #3498DB;
            --error-red: #E74C3C;
            --border-color: #EEEEEE;
            --shadow-light: 0 1px 6px rgba(0, 0, 0, 0.08);
            --shadow-medium: 0 2px 12px rgba(0, 0, 0, 0.12);
            --shadow-heavy: 0 4px 20px rgba(0, 0, 0, 0.15);
            --app-padding: 12px;
            --element-radius: 12px;
            --button-radius: 20px;
            --card-radius: 16px;
            --transition-speed: 0.25s;
            --ambulance-blue: #2980B9;
            --fire-truck-red: #C0392B;
            --police-blue: #2C3E50;
            --premium-gold: #FFD700;
            --economy-green: #27AE60;
            --light-truck-brown: #8B4513;
            --delivery-purple: #8E44AD;
            --express-shop-green: #16A085;
            --broadcast-blue: #1E88E5;
            --broadcast-light-blue: #E3F2FD;
            --notification-purple: #8E44AD;
            --notification-light-purple: #F4E6FA;
            --sos-pulse-color: #FF4081;
            --sos-dark-red: #D32F2F;
            --emergency-dark-red: #B71C1C;
            --emergency-orange: #FF9800;
            --location-accent: #4CAF50;
            --driver-green: #2E7D32;
            --chat-bubble-sent: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            --chat-bubble-received: #F5F5F5;
            --rating-yellow: #FFB300;
            --promotion-gold: #FFC107;
            --referral-teal: #009688;
            --notification-badge-red: #F44336;
            --active-indicator-green: #4CAF50;
            --inactive-indicator-gray: #9E9E9E;
            --map-route-color: #FF6B35;
            --map-route-hover: #FF8A65;
            --search-highlight: #FFF9C4;
            --dropdown-hover: #F5F5F5;
            --dropdown-active: #FFECB3;
            --input-focus-glow: rgba(255, 107, 53, 0.2);
            --modal-backdrop: rgba(0, 0, 0, 0.7);
            --toast-success-bg: #E8F5E9;
            --toast-error-bg: #FFEBEE;
            --toast-warning-bg: #FFF3E0;
            --toast-info-bg: #E3F2FD;
            --progress-bar-bg: #E0E0E0;
            --progress-bar-fill: #4CAF50;
            --avatar-gradient-1: #FF6B35;
            --avatar-gradient-2: #FF8E53;
            --vehicle-icon-bg: #757575;
            --price-tag-bg: #FFF3E0;
            --distance-indicator: #2196F3;
            --time-estimate: #795548;
            --schedule-blue: #1976D2;
            --share-green: #388E3C;
            --broadcast-indicator: #7E57C2;
            --live-tracking-green: #00C853;
            --chat-notification-red: #F44336;
            --driver-status-online: #4CAF50;
            --driver-status-offline: #9E9E9E;
            --driver-status-busy: #FF9800;
            --payment-success: #00C853;
            --payment-pending: #FF9800;
            --payment-failed: #F44336;
            --wallet-balance-bg: #FFF3E0;
            --referral-badge: #FF9800;
            --promotion-banner: #FFECB3;
            --emergency-banner: #FFCDD2;
            --safety-indicator: #4CAF50;
            --accessibility-blue: #1565C0;
            --loading-gradient-1: #FF6B35;
            --loading-gradient-2: #FF8E53;
            --loading-gradient-3: #FFB74D;
            --map-controls-bg: rgba(255, 255, 255, 0.95);
            --map-controls-hover: rgba(255, 107, 53, 0.1);
            --map-controls-active: rgba(255, 107, 53, 0.2);
            --navigation-active: rgba(255, 107, 53, 0.15);
            --navigation-hover: rgba(255, 107, 53, 0.08);
            --section-divider: rgba(0, 0, 0, 0.08);
            --card-hover-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            --button-hover-transform: translateY(-2px);
            --button-active-transform: translateY(0);
            --input-transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --animation-bounce: cubic-bezier(0.68, -0.55, 0.265, 1.55);
            --animation-smooth: cubic-bezier(0.4, 0, 0.2, 1);
            --animation-elastic: cubic-bezier(0.68, -0.6, 0.32, 1.6);
            --animation-quick: cubic-bezier(0.4, 0, 0.6, 1);
            --font-primary: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            --font-secondary: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'SF Mono', 'Roboto Mono', monospace;
            --line-height-normal: 1.4;
            --line-height-relaxed: 1.6;
            --line-height-tight: 1.2;
            --letter-spacing-normal: 0;
            --letter-spacing-wide: 0.025em;
            --letter-spacing-wider: 0.05em;
            --font-weight-light: 300;
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 600;
            --font-weight-bold: 700;
            --font-weight-extrabold: 800;
            --font-size-xs: 10px;
            --font-size-sm: 11px;
            --font-size-base: 13px;
            --font-size-md: 14px;
            --font-size-lg: 16px;
            --font-size-xl: 18px;
            --font-size-2xl: 20px;
            --font-size-3xl: 24px;
            --font-size-4xl: 30px;
            --font-size-5xl: 36px;
            --spacing-0: 0;
            --spacing-1: 2px;
            --spacing-2: 4px;
            --spacing-3: 6px;
            --spacing-4: 8px;
            --spacing-5: 10px;
            --spacing-6: 12px;
            --spacing-7: 14px;
            --spacing-8: 16px;
            --spacing-9: 18px;
            --spacing-10: 20px;
            --spacing-11: 22px;
            --spacing-12: 24px;
            --spacing-14: 28px;
            --spacing-16: 32px;
            --spacing-20: 40px;
            --spacing-24: 48px;
            --spacing-32: 64px;
            --spacing-40: 80px;
            --spacing-48: 96px;
            --spacing-56: 112px;
            --spacing-64: 128px;
            --z-index-base: 1;
            --z-index-above: 10;
            --z-index-dropdown: 100;
            --z-index-sticky: 200;
            --z-index-fixed: 300;
            --z-index-modal: 400;
            --z-index-popover: 500;
            --z-index-tooltip: 600;
            --z-index-toast: 700;
            --z-index-loading: 800;
            --z-index-max: 9999;
        }
        
        /* ============================================
           RESET & BASE STYLES
           ============================================ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: var(--font-primary);
            -webkit-tap-highlight-color: transparent;
        }
        
        *:focus {
            outline: 2px solid var(--primary-orange);
            outline-offset: 2px;
        }
        
        *:focus:not(.focus-visible) {
            outline: none;
        }
        
        html {
            font-size: 16px;
            scroll-behavior: smooth;
            -webkit-text-size-adjust: 100%;
            -moz-text-size-adjust: 100%;
            text-size-adjust: 100%;
        }
        
        body {
            background-color: var(--off-white);
            color: var(--dark-gray);
            max-width: 100%;
            overflow-x: hidden;
            height: 100vh;
            height: 100dvh;
            font-size: var(--font-size-base);
            line-height: var(--line-height-normal);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            font-feature-settings: "kern" 1;
            font-kerning: normal;
            touch-action: manipulation;
        }
        
        /* ============================================
           MAP ENHANCEMENTS
           ============================================ */
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 55%;
            z-index: var(--z-index-base);
            background: #f8f9fa;
            transition: height 0.3s var(--animation-smooth);
        }
        
        #map.fullscreen {
            height: 100%;
            z-index: var(--z-index-modal);
        }
        
        .leaflet-control-container .leaflet-control {
            margin: 8px;
        }
        
        .leaflet-control-zoom {
            border: 2px solid var(--border-color) !important;
            border-radius: var(--element-radius) !important;
            overflow: hidden;
            box-shadow: var(--shadow-light) !important;
        }
        
        .leaflet-control-zoom a {
            background: var(--white) !important;
            color: var(--dark-gray) !important;
            border-bottom: 1px solid var(--border-color) !important;
            transition: all var(--transition-speed) ease !important;
        }
        
        .leaflet-control-zoom a:hover {
            background: var(--light-orange) !important;
            color: var(--primary-orange) !important;
        }
        
        .leaflet-control-zoom a:first-child {
            border-radius: var(--element-radius) var(--element-radius) 0 0 !important;
        }
        
        .leaflet-control-zoom a:last-child {
            border-radius: 0 0 var(--element-radius) var(--element-radius) !important;
            border-bottom: none !important;
        }
        
        .leaflet-routing-container {
            background: var(--white) !important;
            border-radius: var(--element-radius) !important;
            box-shadow: var(--shadow-heavy) !important;
            border: 2px solid var(--border-color) !important;
            max-height: 300px;
            overflow-y: auto;
            font-family: var(--font-primary) !important;
        }
        
        .leaflet-routing-alt {
            max-height: 250px !important;
            overflow-y: auto !important;
        }
        
        .leaflet-routing-alt h2 {
            font-size: var(--font-size-md) !important;
            font-weight: var(--font-weight-bold) !important;
            color: var(--dark-gray) !important;
            padding: var(--spacing-4) var(--spacing-6) !important;
            margin: 0 !important;
            border-bottom: 1px solid var(--border-color) !important;
        }
        
        .leaflet-routing-alt table {
            width: 100% !important;
            border-collapse: collapse !important;
        }
        
        .leaflet-routing-alt tr {
            border-bottom: 1px solid var(--border-color) !important;
            transition: background-color var(--transition-speed) ease !important;
        }
        
        .leaflet-routing-alt tr:hover {
            background-color: var(--light-orange) !important;
        }
        
        .leaflet-routing-alt td {
            padding: var(--spacing-4) var(--spacing-6) !important;
            font-size: var(--font-size-base) !important;
            color: var(--text-gray) !important;
        }
        
        .leaflet-routing-alt-minimized {
            display: none !important;
        }
        
        /* ============================================
           TOP BAR ENHANCEMENTS WITH LOGO AND USER INFO
           ============================================ */
        .top-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: var(--z-index-fixed);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-4) var(--app-padding);
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
            height: 60px;
            transition: all var(--transition-speed) var(--animation-smooth);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }
        
        .top-bar.scrolled {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12);
            background: rgba(255, 255, 255, 0.95);
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: var(--spacing-4);
            cursor: pointer;
            transition: transform var(--transition-speed) var(--animation-smooth);
        }
        
        .logo-container:hover {
            transform: translateX(-2px);
        }
        
        .logo-image-container {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 2px 8px rgba(255, 107, 53, 0.2);
        }
        
        .logo-image {
            width: 24px;
            height: 24px;
            object-fit: contain;
            filter: brightness(0) invert(1);
        }
        
        .logo-text-container {
            display: flex;
            flex-direction: column;
            gap: 1px;
        }
        
        .logo-brand {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-extrabold);
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.5px;
        }
        
        .user-name {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            color: var(--text-gray);
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .user-actions {
            display: flex;
            align-items: center;
            gap: var(--spacing-4);
        }
        
        .balance-badge {
            background: var(--white);
            padding: var(--spacing-3) var(--spacing-6);
            border-radius: var(--button-radius);
            box-shadow: var(--shadow-light);
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
            font-weight: var(--font-weight-semibold);
            color: var(--dark-gray);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) var(--animation-smooth);
            position: relative;
            overflow: hidden;
        }
        
        .balance-badge::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.6s ease;
        }
        
        .balance-badge:hover {
            transform: var(--button-hover-transform);
            box-shadow: var(--shadow-medium);
            border-color: var(--primary-orange);
        }
        
        .balance-badge:hover::before {
            left: 100%;
        }
        
        .balance-amount {
            color: var(--primary-orange);
            font-weight: var(--font-weight-bold);
            font-size: var(--font-size-base);
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .notification-container {
            position: relative;
        }
        
        .notification-bell {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
            cursor: pointer;
            position: relative;
            transition: all var(--transition-speed) var(--animation-smooth);
        }
        
        .notification-bell:hover {
            transform: var(--button-hover-transform);
            box-shadow: var(--shadow-medium);
            background: var(--light-orange);
            border-color: var(--primary-orange);
            color: var(--primary-orange);
        }
        
        .notification-bell.active {
            animation: bellRing 0.5s var(--animation-elastic);
            background: var(--light-orange);
            border-color: var(--primary-orange);
            color: var(--primary-orange);
        }
        
        @keyframes bellRing {
            0% { transform: rotate(0); }
            10% { transform: rotate(-15deg); }
            20% { transform: rotate(15deg); }
            30% { transform: rotate(-10deg); }
            40% { transform: rotate(10deg); }
            50% { transform: rotate(-5deg); }
            60% { transform: rotate(5deg); }
            70% { transform: rotate(-2deg); }
            80% { transform: rotate(2deg); }
            90% { transform: rotate(-1deg); }
            100% { transform: rotate(0); }
        }
        
        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 18px;
            height: 18px;
            background: var(--notification-badge-red);
            color: var(--white);
            border-radius: 50%;
            font-size: var(--font-size-xs);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: var(--font-weight-bold);
            border: 2px solid var(--white);
            animation: pulse 2s infinite;
            z-index: var(--z-index-above);
        }
        
        .notification-dropdown {
            position: absolute;
            top: 50px;
            right: 0;
            width: 320px;
            max-width: calc(100vw - 40px);
            background: var(--white);
            border-radius: var(--card-radius);
            box-shadow: var(--shadow-heavy);
            border: 1px solid var(--border-color);
            z-index: var(--z-index-dropdown);
            display: none;
            flex-direction: column;
            max-height: 400px;
            overflow: hidden;
        }
        
        .notification-dropdown.active {
            display: flex;
            animation: slideDown 0.3s var(--animation-smooth);
        }
        
        .notification-header {
            padding: var(--spacing-6);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .notification-title {
            font-weight: var(--font-weight-bold);
            font-size: var(--font-size-md);
            color: var(--dark-gray);
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
        }
        
        .notification-clear {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: var(--font-size-sm);
            cursor: pointer;
            padding: var(--spacing-2) var(--spacing-4);
            border-radius: var(--element-radius);
            transition: all var(--transition-speed) ease;
        }
        
        .notification-clear:hover {
            color: var(--error-red);
            background: var(--light-red);
        }
        
        .notification-list {
            flex: 1;
            overflow-y: auto;
            max-height: 300px;
        }
        
        .notification-item {
            padding: var(--spacing-6);
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: flex-start;
            gap: var(--spacing-4);
        }
        
        .notification-item:hover {
            background: var(--dropdown-hover);
        }
        
        .notification-item.unread {
            background: var(--notification-light-purple);
            border-left: 3px solid var(--notification-purple);
        }
        
        .notification-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: var(--font-size-md);
        }
        
        .notification-icon.ride {
            background: var(--light-orange);
            color: var(--primary-orange);
        }
        
        .notification-icon.wallet {
            background: #E8F5E9;
            color: var(--success-green);
        }
        
        .notification-icon.promotion {
            background: var(--promotion-banner);
            color: var(--promotion-gold);
        }
        
        .notification-icon.emergency {
            background: var(--light-red);
            color: var(--error-red);
        }
        
        .notification-icon.referral {
            background: #E0F2F1;
            color: var(--referral-teal);
        }
        
        .notification-content {
            flex: 1;
            min-width: 0;
        }
        
        .notification-message {
            font-size: var(--font-size-base);
            color: var(--dark-gray);
            margin-bottom: var(--spacing-2);
            line-height: var(--line-height-normal);
        }
        
        .notification-time {
            font-size: var(--font-size-xs);
            color: var(--text-light);
        }
        
        .notification-footer {
            padding: var(--spacing-4) var(--spacing-6);
            border-top: 1px solid var(--border-color);
            text-align: center;
        }
        
        .notification-view-all {
            color: var(--primary-orange);
            font-weight: var(--font-weight-semibold);
            text-decoration: none;
            font-size: var(--font-size-sm);
            transition: color var(--transition-speed) ease;
        }
        
        .notification-view-all:hover {
            color: var(--primary-red);
        }
        
        /* ============================================
           ENHANCED SEARCH FUNCTIONALITY
           ============================================ */
        .search-engine-container {
            position: relative;
            width: 100%;
        }
        
        .location-input {
            display: flex;
            align-items: center;
            gap: var(--spacing-5);
            padding: var(--spacing-6);
            background: var(--off-white);
            border: 2px solid transparent;
            border-radius: var(--element-radius);
            transition: all 0.3s var(--animation-smooth);
            position: relative;
            cursor: text;
        }
        
        .location-input.active {
            border-color: var(--primary-orange);
            background: var(--white);
            box-shadow: 0 0 0 4px var(--input-focus-glow);
            z-index: var(--z-index-dropdown);
        }
        
        .location-input i {
            color: var(--primary-orange);
            font-size: var(--font-size-md);
            width: 20px;
            text-align: center;
            flex-shrink: 0;
        }
        
        .location-input input {
            flex: 1;
            border: none;
            background: transparent;
            outline: none;
            font-size: var(--font-size-base);
            color: var(--dark-gray);
            font-weight: var(--font-weight-medium);
            min-width: 0;
        }
        
        .location-input input::placeholder {
            color: var(--text-light);
            font-weight: var(--font-weight-normal);
        }
        
        .search-loading {
            display: none;
            position: absolute;
            top: 50%;
            right: var(--spacing-6);
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            border: 2px solid var(--light-gray);
            border-radius: 50%;
            border-top-color: var(--primary-orange);
            animation: spin 0.6s linear infinite;
        }
        
        .location-input.searching .search-loading {
            display: block;
        }
        
        .suggestion-list {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            right: 0;
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: var(--z-index-dropdown);
            max-height: 300px;
            overflow-y: auto;
            display: none;
            animation: fadeIn 0.2s var(--animation-smooth);
        }
        
        .suggestion-list.active {
            display: block;
        }
        
        .suggestion-item {
            padding: var(--spacing-6);
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: flex-start;
            gap: var(--spacing-5);
            position: relative;
            overflow: hidden;
        }
        
        .suggestion-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 107, 53, 0.1), transparent);
            transition: left 0.6s ease;
        }
        
        .suggestion-item:hover {
            background: var(--light-orange);
        }
        
        .suggestion-item:hover::before {
            left: 100%;
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
        
        .suggestion-item.highlighted {
            background: var(--search-highlight);
            border-left: 3px solid var(--primary-orange);
        }
        
        .suggestion-icon {
            color: var(--primary-orange);
            font-size: var(--font-size-sm);
            margin-top: 2px;
            flex-shrink: 0;
        }
        
        .suggestion-details {
            flex: 1;
            min-width: 0;
        }
        
        .suggestion-name {
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-base);
            color: var(--dark-gray);
            margin-bottom: var(--spacing-2);
            line-height: var(--line-height-normal);
        }
        
        .suggestion-address {
            font-size: var(--font-size-sm);
            color: var(--text-gray);
            line-height: var(--line-height-relaxed);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .suggestion-distance {
            font-size: var(--font-size-xs);
            color: var(--primary-orange);
            font-weight: var(--font-weight-semibold);
            margin-top: var(--spacing-2);
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
        }
        
        .no-results {
            padding: var(--spacing-16) var(--spacing-8);
            text-align: center;
            color: var(--text-light);
        }
        
        .no-results i {
            font-size: 32px;
            margin-bottom: var(--spacing-6);
            opacity: 0.5;
        }
        
        .no-results-title {
            font-size: var(--font-size-md);
            font-weight: var(--font-weight-semibold);
            color: var(--text-gray);
            margin-bottom: var(--spacing-3);
        }
        
        .no-results-message {
            font-size: var(--font-size-base);
            line-height: var(--line-height-relaxed);
        }
        
        /* ============================================
           ENHANCED SERVICE TABS WITH MORE OPTIONS DROPDOWN
           ============================================ */
        .service-tabs-container {
            position: relative;
            margin-bottom: var(--spacing-6);
        }
        
        .service-tabs {
            display: flex;
            gap: var(--spacing-3);
            margin-bottom: var(--spacing-6);
            overflow-x: auto;
            padding-bottom: var(--spacing-2);
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .service-tabs::-webkit-scrollbar {
            display: none;
        }
        
        .service-tab {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-2);
            padding: var(--spacing-6) var(--spacing-8);
            background: var(--white);
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all 0.3s var(--animation-smooth);
            min-width: 100px;
            text-align: center;
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
        }
        
        .service-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.6s ease;
        }
        
        .service-tab:hover {
            transform: var(--button-hover-transform);
            box-shadow: var(--shadow-medium);
            border-color: var(--primary-orange);
        }
        
        .service-tab:hover::before {
            left: 100%;
        }
        
        .service-tab.active {
            border-color: var(--primary-orange);
            background: var(--light-orange);
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.15);
            transform: translateY(-2px);
        }
        
        .service-tab.active::before {
            display: none;
        }
        
        .service-tab.delivery.active {
            border-color: var(--delivery-purple);
            background: #F4E6FA;
        }
        
        .service-tab.short-delivery.active {
            border-color: var(--express-shop-green);
            background: #E1F5FE;
        }
        
        .service-icon {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-lg);
            color: var(--text-gray);
            transition: all 0.3s var(--animation-smooth);
            position: relative;
            overflow: hidden;
        }
        
        .service-icon::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), transparent);
            border-radius: 50%;
        }
        
        .service-tab.active .service-icon {
            background: var(--primary-orange);
            color: var(--white);
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
        }
        
        .service-tab.delivery.active .service-icon {
            background: var(--delivery-purple);
            box-shadow: 0 4px 12px rgba(142, 68, 173, 0.3);
        }
        
        .service-tab.short-delivery.active .service-icon {
            background: var(--express-shop-green);
            box-shadow: 0 4px 12px rgba(22, 160, 133, 0.3);
        }
        
        .service-name {
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-sm);
            color: var(--dark-gray);
            transition: color var(--transition-speed) ease;
        }
        
        .service-tab.active .service-name {
            color: var(--primary-orange);
            font-weight: var(--font-weight-bold);
        }
        
        .service-tab.delivery.active .service-name {
            color: var(--delivery-purple);
        }
        
        .service-tab.short-delivery.active .service-name {
            color: var(--express-shop-green);
        }
        
        .service-desc {
            font-size: var(--font-size-xs);
            color: var(--text-light);
            margin-top: var(--spacing-1);
            transition: color var(--transition-speed) ease;
        }
        
        .service-tab.active .service-desc {
            color: var(--primary-orange);
            opacity: 0.9;
        }
        
        .more-options-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--white);
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            border: 1px solid var(--border-color);
            z-index: var(--z-index-dropdown);
            display: none;
            flex-direction: column;
            overflow: hidden;
            animation: slideDown 0.3s var(--animation-smooth);
        }
        
        .more-options-dropdown.active {
            display: flex;
        }
        
        .more-options-header {
            padding: var(--spacing-6);
            border-bottom: 1px solid var(--border-color);
            font-weight: var(--font-weight-bold);
            font-size: var(--font-size-md);
            color: var(--dark-gray);
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
        }
        
        .more-options-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-3);
            padding: var(--spacing-6);
        }
        
        .more-option-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-3);
            padding: var(--spacing-6);
            background: var(--off-white);
            border: 2px solid transparent;
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all 0.3s var(--animation-smooth);
            text-align: center;
        }
        
        .more-option-item:hover {
            transform: var(--button-hover-transform);
            border-color: var(--primary-orange);
            background: var(--white);
            box-shadow: var(--shadow-medium);
        }
        
        .more-option-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: var(--light-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-orange);
            font-size: var(--font-size-lg);
            transition: all var(--transition-speed) ease;
        }
        
        .more-option-item:hover .more-option-icon {
            background: var(--primary-orange);
            color: var(--white);
            transform: scale(1.1);
        }
        
        .more-option-name {
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-sm);
            color: var(--dark-gray);
        }
        
        .more-option-item:hover .more-option-name {
            color: var(--primary-orange);
        }
        
        /* ============================================
           ENHANCED RIDE TYPE SELECTION
           ============================================ */
        .ride-type-selection-container {
            margin: var(--spacing-8) 0;
            position: relative;
        }
        
        .ride-type-title {
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-semibold);
            color: var(--dark-gray);
            margin-bottom: var(--spacing-5);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .ride-type-info {
            font-size: var(--font-size-sm);
            color: var(--text-light);
            cursor: pointer;
            transition: color var(--transition-speed) ease;
        }
        
        .ride-type-info:hover {
            color: var(--primary-orange);
        }
        
        .ride-type-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-4);
        }
        
        .ride-type-card {
            background: var(--white);
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            padding: var(--spacing-7) var(--spacing-5);
            cursor: pointer;
            transition: all 0.3s var(--animation-smooth);
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .ride-type-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s ease;
        }
        
        .ride-type-card:hover {
            transform: var(--button-hover-transform);
            box-shadow: var(--shadow-medium);
            border-color: var(--primary-orange);
        }
        
        .ride-type-card:hover::before {
            left: 100%;
        }
        
        .ride-type-card.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.15);
            transform: translateY(-2px);
        }
        
        .ride-type-card.selected::before {
            display: none;
        }
        
        .ride-type-card.economy.selected {
            border-color: var(--economy-green);
            background: #E8F6EF;
        }
        
        .ride-type-card.premium.selected {
            border-color: var(--premium-gold);
            background: #FFF9E6;
        }
        
        .ride-type-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto var(--spacing-4);
            font-size: var(--font-size-lg);
            color: var(--text-gray);
            transition: all 0.3s var(--animation-smooth);
            position: relative;
            overflow: hidden;
        }
        
        .ride-type-icon::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), transparent);
            border-radius: 12px;
        }
        
        .ride-type-card.selected .ride-type-icon {
            background: var(--primary-orange);
            color: var(--white);
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
        }
        
        .ride-type-card.economy.selected .ride-type-icon {
            background: var(--economy-green);
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
        }
        
        .ride-type-card.premium.selected .ride-type-icon {
            background: var(--premium-gold);
            color: var(--dark-gray);
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
        }
        
        .ride-type-name {
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-sm);
            color: var(--dark-gray);
            margin-bottom: var(--spacing-2);
            transition: color var(--transition-speed) ease;
        }
        
        .ride-type-card.selected .ride-type-name {
            color: var(--primary-orange);
            font-weight: var(--font-weight-bold);
        }
        
        .ride-type-card.economy.selected .ride-type-name {
            color: var(--economy-green);
        }
        
        .ride-type-card.premium.selected .ride-type-name {
            color: #B8860B;
        }
        
        .ride-type-price {
            font-size: var(--font-size-md);
            font-weight: var(--font-weight-bold);
            color: var(--primary-orange);
            margin-bottom: var(--spacing-2);
            transition: color var(--transition-speed) ease;
        }
        
        .ride-type-card.economy .ride-type-price {
            color: var(--economy-green);
        }
        
        .ride-type-card.premium .ride-type-price {
            color: #B8860B;
        }
        
        .ride-type-eta {
            font-size: var(--font-size-xs);
            color: var(--text-light);
        }
        
        /* ============================================
           ENHANCED EMERGENCY RIDE SYSTEM
           ============================================ */
        .emergency-reasons-modal {
            max-width: 500px;
        }
        
        .emergency-reasons-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-4);
            margin-bottom: var(--spacing-6);
        }
        
        .emergency-reason-card {
            padding: var(--spacing-6);
            background: var(--white);
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all 0.3s var(--animation-smooth);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-3);
        }
        
        .emergency-reason-card:hover {
            transform: var(--button-hover-transform);
            box-shadow: var(--shadow-medium);
            border-color: var(--error-red);
            background: var(--light-red);
        }
        
        .emergency-reason-card.selected {
            border-color: var(--error-red);
            background: var(--light-red);
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.15);
        }
        
        .emergency-reason-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: var(--light-red);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--error-red);
            font-size: var(--font-size-lg);
        }
        
        .emergency-reason-card.selected .emergency-reason-icon {
            background: var(--error-red);
            color: var(--white);
        }
        
        .emergency-reason-text {
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-sm);
            color: var(--dark-gray);
        }
        
        .emergency-reason-card.selected .emergency-reason-text {
            color: var(--error-red);
        }
        
        .emergency-services-list {
            max-height: 300px;
            overflow-y: auto;
            margin: var(--spacing-6) 0;
            border-radius: var(--element-radius);
            border: 1px solid var(--border-color);
        }
        
        .emergency-service-item {
            padding: var(--spacing-6);
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: var(--spacing-4);
        }
        
        .emergency-service-item:hover {
            background: var(--dropdown-hover);
        }
        
        .emergency-service-item.selected {
            background: var(--light-orange);
            border-left: 3px solid var(--primary-orange);
        }
        
        .emergency-service-item:last-child {
            border-bottom: none;
        }
        
        .emergency-service-distance {
            margin-left: auto;
            font-weight: var(--font-weight-semibold);
            color: var(--primary-orange);
            font-size: var(--font-size-sm);
        }
        
        .emergency-location-details {
            background: var(--off-white);
            border-radius: var(--element-radius);
            padding: var(--spacing-6);
            margin: var(--spacing-6) 0;
            border-left: 3px solid var(--primary-orange);
        }
        
        .emergency-location-title {
            font-weight: var(--font-weight-bold);
            font-size: var(--font-size-sm);
            color: var(--dark-gray);
            margin-bottom: var(--spacing-3);
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
        }
        
        .emergency-location-address {
            font-size: var(--font-size-base);
            color: var(--text-gray);
            line-height: var(--line-height-relaxed);
        }
        
        /* ============================================
           ENHANCED SOS SYSTEM
           ============================================ */
        .sos-button {
            position: absolute;
            bottom: 180px;
            right: var(--app-padding);
            z-index: var(--z-index-sticky);
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, var(--sos-dark-red), var(--error-red));
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-bold);
            box-shadow: var(--shadow-heavy);
            cursor: pointer;
            transition: all 0.3s var(--animation-smooth);
            border: 3px solid var(--white);
            animation: sosPulse 2s infinite;
        }
        
        .sos-button.active {
            display: flex;
        }
        
        @keyframes sosPulse {
            0% {
                box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.7);
                transform: scale(1);
            }
            70% {
                box-shadow: 0 0 0 15px rgba(244, 67, 54, 0);
                transform: scale(1.05);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(244, 67, 54, 0);
                transform: scale(1);
            }
        }
        
        .sos-button:hover {
            transform: scale(1.1);
            box-shadow: 0 0 30px rgba(244, 67, 54, 0.5);
            animation: none;
        }
        
        .sos-config-modal {
            max-width: 500px;
        }
        
        .sos-contact-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-4);
            margin-bottom: var(--spacing-6);
        }
        
        .sos-test-button {
            width: 100%;
            margin-top: var(--spacing-4);
            background: linear-gradient(135deg, var(--warning-yellow), #FF9800);
        }
        
        .sos-test-button:hover {
            transform: var(--button-hover-transform);
            box-shadow: 0 5px 20px rgba(255, 152, 0, 0.3);
        }
        
        /* ============================================
           BROADCAST RIDE SYSTEM
           ============================================ */
        .broadcast-ride-modal {
            max-width: 500px;
        }
        
        .broadcast-input-container {
            display: flex;
            gap: var(--spacing-3);
            margin-bottom: var(--spacing-6);
        }
        
        .broadcast-input {
            flex: 1;
            padding: var(--spacing-5) var(--spacing-6);
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: var(--font-size-base);
            transition: all var(--transition-speed) ease;
        }
        
        .broadcast-input:focus {
            border-color: var(--broadcast-blue);
            box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.1);
        }
        
        .broadcast-button {
            background: linear-gradient(135deg, var(--broadcast-blue), #1565C0);
            color: var(--white);
            border: none;
            border-radius: var(--element-radius);
            padding: var(--spacing-5) var(--spacing-8);
            font-weight: var(--font-weight-semibold);
            cursor: pointer;
            transition: all 0.3s var(--animation-smooth);
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
        }
        
        .broadcast-button:hover {
            transform: var(--button-hover-transform);
            box-shadow: 0 5px 20px rgba(30, 136, 229, 0.3);
        }
        
        .broadcast-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .broadcast-recipients-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: var(--spacing-6);
            border-radius: var(--element-radius);
            border: 1px solid var(--border-color);
        }
        
        .broadcast-recipient-item {
            padding: var(--spacing-4) var(--spacing-6);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .broadcast-recipient-item:last-child {
            border-bottom: none;
        }
        
        .broadcast-recipient-info {
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
        }
        
        .broadcast-recipient-status {
            font-size: var(--font-size-xs);
            padding: var(--spacing-1) var(--spacing-3);
            border-radius: 10px;
            font-weight: var(--font-weight-semibold);
        }
        
        .broadcast-recipient-status.pending {
            background: var(--toast-warning-bg);
            color: var(--warning-yellow);
        }
        
        .broadcast-recipient-status.accepted {
            background: var(--toast-success-bg);
            color: var(--success-green);
        }
        
        .broadcast-recipient-status.declined {
            background: var(--toast-error-bg);
            color: var(--error-red);
        }
        
        /* ============================================
           ENHANCED DRIVER INFO WITH IMAGES
           ============================================ */
        .driver-info-enhanced {
            display: flex;
            align-items: center;
            gap: var(--spacing-7);
            margin-bottom: var(--spacing-8);
            padding-bottom: var(--spacing-8);
            border-bottom: 1px solid var(--border-color);
        }
        
        .driver-avatar-container {
            position: relative;
        }
        
        .driver-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--avatar-gradient-1), var(--avatar-gradient-2));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-xl);
            color: var(--white);
            font-weight: var(--font-weight-bold);
            overflow: hidden;
            border: 3px solid var(--white);
            box-shadow: var(--shadow-medium);
        }
        
        .driver-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .driver-status-indicator {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--driver-status-online);
            border: 2px solid var(--white);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .driver-status-indicator.offline {
            background: var(--driver-status-offline);
        }
        
        .driver-status-indicator.busy {
            background: var(--driver-status-busy);
        }
        
        .driver-details-enhanced {
            flex: 1;
        }
        
        .driver-name-rating {
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
            margin-bottom: var(--spacing-2);
        }
        
        .driver-name {
            font-size: var(--font-size-md);
            font-weight: var(--font-weight-bold);
            color: var(--dark-gray);
        }
        
        .driver-rating-enhanced {
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
            background: rgba(255, 179, 0, 0.1);
            padding: var(--spacing-1) var(--spacing-3);
            border-radius: 12px;
            color: var(--rating-yellow);
            font-weight: var(--font-weight-bold);
            font-size: var(--font-size-sm);
        }
        
        .driver-vehicle-enhanced {
            display: flex;
            align-items: center;
            gap: var(--spacing-4);
            margin-top: var(--spacing-3);
        }
        
        .vehicle-image-container {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 2px solid var(--border-color);
        }
        
        .vehicle-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .vehicle-details {
            flex: 1;
        }
        
        .vehicle-model {
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-base);
            color: var(--dark-gray);
            margin-bottom: 2px;
        }
        
        .vehicle-plate {
            font-size: var(--font-size-sm);
            color: var(--text-gray);
            background: var(--off-white);
            padding: var(--spacing-1) var(--spacing-3);
            border-radius: 4px;
            display: inline-block;
            font-family: var(--font-mono);
            letter-spacing: var(--letter-spacing-wide);
        }
        
        /* ============================================
           ENHANCED IN-APP CHAT SYSTEM
           ============================================ */
        .chat-container-enhanced {
            position: absolute;
            bottom: 220px;
            right: var(--app-padding);
            z-index: var(--z-index-modal);
            width: 360px;
            max-width: calc(100vw - 40px);
            background: var(--white);
            border-radius: var(--card-radius);
            box-shadow: var(--shadow-heavy);
            display: none;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid var(--border-color);
            animation: chatSlideUp 0.3s var(--animation-smooth);
        }
        
        .chat-container-enhanced.active {
            display: flex;
        }
        
        .chat-header-enhanced {
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            padding: var(--spacing-6);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            overflow: hidden;
        }
        
        .chat-header-enhanced::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), transparent);
            pointer-events: none;
        }
        
        .chat-title-enhanced {
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-md);
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
        }
        
        .chat-driver-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--driver-status-online);
            animation: pulse 2s infinite;
        }
        
        .chat-close-enhanced {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: var(--white);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-speed) ease;
        }
        
        .chat-close-enhanced:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }
        
        .chat-messages-enhanced {
            flex: 1;
            padding: var(--spacing-6);
            max-height: 300px;
            overflow-y: auto;
            background: var(--off-white);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-4);
        }
        
        .chat-message {
            max-width: 85%;
            padding: var(--spacing-4) var(--spacing-6);
            border-radius: 18px;
            font-size: var(--font-size-base);
            line-height: var(--line-height-relaxed);
            position: relative;
            animation: messageAppear 0.3s var(--animation-smooth);
        }
        
        @keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .chat-message.sent {
            align-self: flex-end;
            background: var(--chat-bubble-sent);
            color: var(--white);
            border-bottom-right-radius: 4px;
        }
        
        .chat-message.received {
            align-self: flex-start;
            background: var(--chat-bubble-received);
            color: var(--dark-gray);
            border: 1px solid var(--border-color);
            border-bottom-left-radius: 4px;
        }
        
        .message-time-enhanced {
            font-size: var(--font-size-xs);
            color: rgba(255, 255, 255, 0.8);
            margin-top: var(--spacing-2);
            text-align: right;
            display: block;
        }
        
        .chat-message.received .message-time-enhanced {
            color: var(--text-light);
        }
        
        .message-status {
            position: absolute;
            bottom: 4px;
            right: 8px;
            font-size: 10px;
        }
        
        .chat-input-container-enhanced {
            padding: var(--spacing-6);
            background: var(--white);
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: var(--spacing-4);
        }
        
        .chat-input-enhanced {
            flex: 1;
            padding: var(--spacing-5) var(--spacing-6);
            border: 1px solid var(--border-color);
            border-radius: var(--button-radius);
            font-size: var(--font-size-base);
            outline: none;
            transition: all var(--transition-speed) ease;
            background: var(--off-white);
        }
        
        .chat-input-enhanced:focus {
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 3px var(--input-focus-glow);
            background: var(--white);
        }
        
        .chat-send-btn-enhanced {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s var(--animation-smooth);
        }
        
        .chat-send-btn-enhanced:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
        }
        
        .chat-send-btn-enhanced:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .chat-typing-indicator {
            display: none;
            align-items: center;
            gap: var(--spacing-2);
            padding: var(--spacing-3) var(--spacing-6);
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: 18px;
            align-self: flex-start;
            margin-bottom: var(--spacing-4);
        }
        
        .chat-typing-indicator.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        
        .typing-dots {
            display: flex;
            gap: 2px;
        }
        
        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--text-light);
            animation: typing 1.4s infinite;
        }
        
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }
        
        /* ============================================
           ENHANCED LIVE TRACKING SYSTEM
           ============================================ */
        .live-tracking-container {
            position: absolute;
            top: 70px;
            left: var(--app-padding);
            z-index: var(--z-index-sticky);
            background: var(--white);
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            border: 1px solid var(--border-color);
            padding: var(--spacing-4);
            display: none;
            align-items: center;
            gap: var(--spacing-4);
            animation: slideInLeft 0.3s var(--animation-smooth);
        }
        
        .live-tracking-container.active {
            display: flex;
        }
        
        .live-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--live-tracking-green);
            animation: pulse 1.5s infinite;
            position: relative;
        }
        
        .live-indicator::after {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            border-radius: 50%;
            border: 2px solid var(--live-tracking-green);
            animation: pulse-ring 1.5s infinite;
        }
        
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        
        .tracking-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .tracking-title {
            font-weight: var(--font-weight-bold);
            font-size: var(--font-size-sm);
            color: var(--dark-gray);
        }
        
        .tracking-distance {
            font-size: var(--font-size-xs);
            color: var(--text-light);
        }
        
        .tracking-close {
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            padding: var(--spacing-2);
            border-radius: 4px;
            transition: all var(--transition-speed) ease;
        }
        
        .tracking-close:hover {
            color: var(--error-red);
            background: var(--light-red);
        }
        
        /* ============================================
           ENHANCED ANIMATIONS
           ============================================ */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideDown {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes slideInLeft {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideInRight {
            from { transform: translateX(20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        @keyframes shimmer {
            0% { background-position: -200px 0; }
            100% { background-position: 200px 0; }
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        @keyframes ripple {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(4); opacity: 0; }
        }
        
        /* ============================================
           ENHANCED RESPONSIVE DESIGN
           ============================================ */
        @media (max-width: 768px) {
            :root {
                --app-padding: 10px;
                --element-radius: 10px;
                --button-radius: 16px;
                --spacing-6: 10px;
                --spacing-8: 14px;
            }
            
            .top-bar {
                padding: var(--spacing-3) var(--app-padding);
                height: 56px;
            }
            
            .logo-image-container {
                width: 36px;
                height: 36px;
            }
            
            .logo-brand {
                font-size: var(--font-size-md);
            }
            
            .user-name {
                font-size: var(--font-size-xs);
                max-width: 80px;
            }
            
            .balance-badge {
                padding: var(--spacing-2) var(--spacing-4);
                font-size: var(--font-size-sm);
            }
            
            .notification-bell {
                width: 36px;
                height: 36px;
            }
            
            .notification-dropdown {
                width: calc(100vw - 20px);
                right: 10px;
            }
            
            .service-tabs {
                gap: var(--spacing-2);
            }
            
            .service-tab {
                min-width: 90px;
                padding: var(--spacing-4) var(--spacing-6);
            }
            
            .ride-type-grid {
                grid-template-columns: 1fr;
                gap: var(--spacing-3);
            }
            
            .emergency-reasons-grid {
                grid-template-columns: 1fr;
            }
            
            .chat-container-enhanced {
                width: calc(100vw - 20px);
                right: 10px;
                bottom: 200px;
            }
            
            .broadcast-input-container {
                flex-direction: column;
            }
            
            .driver-info-enhanced {
                flex-direction: column;
                text-align: center;
                gap: var(--spacing-4);
            }
            
            .driver-vehicle-enhanced {
                flex-direction: column;
                text-align: center;
            }
        }
        
        @media (max-width: 480px) {
            .nav-tabs {
                gap: var(--spacing-2);
            }
            
            .nav-tab {
                padding: var(--spacing-4) var(--spacing-2);
                font-size: var(--font-size-xs);
            }
            
            .nav-tab i {
                font-size: var(--font-size-md);
            }
            
            .service-tab {
                min-width: 85px;
                padding: var(--spacing-4) var(--spacing-5);
            }
            
            .suggestion-list {
                max-height: 250px;
            }
            
            .chat-container-enhanced {
                max-height: 70vh;
            }
            
            .chat-messages-enhanced {
                max-height: 200px;
            }
        }
        
        @media (min-width: 1024px) {
            .main-panel {
                max-width: 500px;
                margin: 0 auto;
                left: 50%;
                transform: translateX(-50%);
            }
            
            .main-panel.collapsed {
                transform: translateX(-50%) translateY(calc(100% - 48px));
            }
        }
        
        /* ============================================
           ACCESSIBILITY ENHANCEMENTS
           ============================================ */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }
        
        @media (prefers-contrast: high) {
            :root {
                --primary-orange: #CC5500;
                --primary-red: #CC0000;
                --text-gray: #000000;
                --text-light: #333333;
            }
            
            .location-input.active {
                border-width: 3px;
            }
            
            .service-tab.active,
            .ride-type-card.selected {
                border-width: 3px;
            }
        }
        
        /* ============================================
           DARK MODE SUPPORT
           ============================================ */
        @media (prefers-color-scheme: dark) {
            :root {
                --primary-orange: #FF8A65;
                --primary-red: #EF5350;
                --light-orange: #4E342E;
                --white: #121212;
                --off-white: #1E1E1E;
                --light-gray: #2D2D2D;
                --medium-gray: #3D3D3D;
                --dark-gray: #E0E0E0;
                --text-gray: #B0B0B0;
                --text-light: #808080;
                --border-color: #3D3D3D;
                --shadow-light: 0 1px 6px rgba(0, 0, 0, 0.3);
                --shadow-medium: 0 2px 12px rgba(0, 0, 0, 0.4);
                --shadow-heavy: 0 4px 20px rgba(0, 0, 0, 0.5);
                --dropdown-hover: #2D2D2D;
                --dropdown-active: #4E342E;
                --chat-bubble-received: #2D2D2D;
            }
            
            .top-bar {
                background: rgba(30, 30, 30, 0.95);
            }
            
            .balance-badge {
                background: var(--light-gray);
            }
            
            .notification-bell {
                background: var(--light-gray);
            }
            
            .notification-dropdown {
                background: var(--off-white);
                border-color: var(--medium-gray);
            }
            
            .suggestion-list {
                background: var(--off-white);
                border-color: var(--medium-gray);
            }
            
            .service-tab {
                background: var(--light-gray);
            }
            
            .ride-type-card {
                background: var(--light-gray);
            }
            
            .form-control {
                background: var(--light-gray);
                border-color: var(--medium-gray);
                color: var(--dark-gray);
            }
            
            input, textarea {
                background: var(--light-gray);
                color: var(--dark-gray);
            }
            
            input::placeholder {
                color: var(--text-light);
            }
        }
        
        /* ============================================
           PRINT STYLES
           ============================================ */
        @media print {
            .main-panel,
            .top-bar,
            .chat-container,
            .modal-overlay,
            .sos-button,
            .ride-status-bar,
            .emergency-status,
            .notification-dropdown,
            .live-tracking-container,
            .more-options-dropdown {
                display: none !important;
            }
            
            #map {
                position: relative;
                height: 300px;
                page-break-inside: avoid;
            }
            
            body {
                background: white;
                color: black;
                font-size: 12pt;
            }
        }
        
        /* ============================================
           UTILITY CLASSES
           ============================================ */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        .text-truncate {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .text-gradient {
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .loading-shimmer {
            background: linear-gradient(90deg, var(--light-gray) 25%, var(--medium-gray) 50%, var(--light-gray) 75%);
            background-size: 200px 100%;
            animation: shimmer 1.5s infinite;
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease;
        }
        
        .slide-up {
            animation: slideUp 0.3s ease;
        }
        
        .slide-down {
            animation: slideDown 0.3s ease;
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        .rotate {
            animation: spin 1s linear infinite;
        }
        
        .bounce {
            animation: bounce 0.5s var(--animation-bounce);
        }
        
        /* ============================================
           CUSTOM MAP MARKERS
           ============================================ */
        .current-location-marker {
            background: var(--info-blue);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            border: 2px solid white;
        }
        
        .pickup-marker {
            background: var(--primary-orange);
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            border: 2px solid white;
            animation: pulse 2s infinite;
        }
        
        .destination-marker {
            background: var(--primary-red);
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            border: 2px solid white;
        }
        
        .driver-marker-enhanced {
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: white;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.3);
            border: 2px solid white;
            animation: float 3s ease-in-out infinite;
        }
        
        .emergency-vehicle-marker-enhanced {
            background: var(--error-red);
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.3);
            border: 2px solid white;
            animation: pulse 1s infinite;
        }
        
        .police-marker {
            background: var(--police-blue);
        }
        
        .fire-marker {
            background: var(--fire-truck-red);
        }
        
        .medical-marker {
            background: var(--ambulance-blue);
        }
        
        /* ============================================
           LOADING STATES
           ============================================ */
        .loading-overlay-enhanced {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: var(--z-index-loading);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-8);
        }
        
        .loading-overlay-enhanced.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        
        .loading-spinner-enhanced {
            width: 60px;
            height: 60px;
            position: relative;
        }
        
        .loading-spinner-enhanced::before,
        .loading-spinner-enhanced::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 4px solid transparent;
        }
        
        .loading-spinner-enhanced::before {
            border-top-color: var(--loading-gradient-1);
            animation: spin 1s linear infinite;
        }
        
        .loading-spinner-enhanced::after {
            border-top-color: var(--loading-gradient-2);
            animation: spin 1.5s linear infinite reverse;
        }
        
        .loading-text-enhanced {
            font-size: var(--font-size-md);
            font-weight: var(--font-weight-semibold);
            color: var(--white);
            text-align: center;
            max-width: 300px;
            line-height: var(--line-height-relaxed);
        }
        
        .loading-dots {
            display: flex;
            gap: 4px;
            margin-top: var(--spacing-4);
        }
        
        .loading-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--white);
            animation: bounce 1.4s infinite;
        }
        
        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }
        
        /* ============================================
           ENHANCED TOAST NOTIFICATIONS
           ============================================ */
        .toast-container-enhanced {
            position: fixed;
            top: 100px;
            right: var(--app-padding);
            z-index: var(--z-index-toast);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-4);
            max-width: 350px;
        }
        
        .toast-enhanced {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: var(--spacing-6);
            box-shadow: var(--shadow-heavy);
            border-left: 4px solid var(--primary-orange);
            display: flex;
            align-items: flex-start;
            gap: var(--spacing-4);
            animation: slideInRight 0.3s var(--animation-smooth);
            transform: translateX(0);
            transition: transform 0.3s var(--animation-smooth);
            position: relative;
            overflow: hidden;
        }
        
        .toast-enhanced::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-orange), var(--primary-red));
        }
        
        .toast-enhanced.hiding {
            transform: translateX(100%);
        }
        
        .toast-icon-enhanced {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--light-orange);
            color: var(--primary-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .toast-content-enhanced {
            flex: 1;
            min-width: 0;
        }
        
        .toast-title-enhanced {
            font-weight: var(--font-weight-bold);
            font-size: var(--font-size-base);
            color: var(--dark-gray);
            margin-bottom: var(--spacing-2);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .toast-message-enhanced {
            font-size: var(--font-size-sm);
            color: var(--text-gray);
            line-height: var(--line-height-relaxed);
        }
        
        .toast-close-enhanced {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: var(--font-size-base);
            cursor: pointer;
            padding: var(--spacing-1);
            border-radius: 4px;
            transition: all var(--transition-speed) ease;
            flex-shrink: 0;
        }
        
        .toast-close-enhanced:hover {
            color: var(--error-red);
            background: var(--light-red);
        }
        
        .toast-enhanced.success {
            border-left-color: var(--success-green);
            background: var(--toast-success-bg);
        }
        
        .toast-enhanced.success .toast-icon-enhanced {
            background: #E8F6EF;
            color: var(--success-green);
        }
        
        .toast-enhanced.error {
            border-left-color: var(--error-red);
            background: var(--toast-error-bg);
        }
        
        .toast-enhanced.error .toast-icon-enhanced {
            background: var(--light-red);
            color: var(--error-red);
        }
        
        .toast-enhanced.warning {
            border-left-color: var(--warning-yellow);
            background: var(--toast-warning-bg);
        }
        
        .toast-enhanced.warning .toast-icon-enhanced {
            background: #FFF3E0;
            color: var(--warning-yellow);
        }
        
        .toast-enhanced.info {
            border-left-color: var(--info-blue);
            background: var(--toast-info-bg);
        }
        
        .toast-enhanced.info .toast-icon-enhanced {
            background: #E3F2FD;
            color: var(--info-blue);
        }
        
        /* ============================================
           PROGRESS INDICATORS
           ============================================ */
        .progress-bar {
            height: 6px;
            background: var(--progress-bar-bg);
            border-radius: 3px;
            overflow: hidden;
            margin: var(--spacing-4) 0;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--progress-bar-fill);
            border-radius: 3px;
            transition: width 0.3s var(--animation-smooth);
        }
        
        /* ============================================
           SCROLLBAR STYLING
           ============================================ */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--light-gray);
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary-orange);
            border-radius: 3px;
            transition: background 0.3s ease;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-red);
        }
        
        /* Firefox scrollbar */
        * {
            scrollbar-width: thin;
            scrollbar-color: var(--primary-orange) var(--light-gray);
        }
        
        /* ============================================
           FORM VALIDATION STYLES
           ============================================ */
        .form-group {
            margin-bottom: var(--spacing-6);
            position: relative;
        }
        
        .form-label {
            display: block;
            margin-bottom: var(--spacing-3);
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-base);
            color: var(--dark-gray);
        }
        
        .form-control {
            width: 100%;
            padding: var(--spacing-5) var(--spacing-6);
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: var(--font-size-base);
            color: var(--dark-gray);
            background: var(--white);
            transition: var(--input-transition);
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 3px var(--input-focus-glow);
        }
        
        .form-control.error {
            border-color: var(--error-red);
        }
        
        .form-control.success {
            border-color: var(--success-green);
        }
        
        .form-validation {
            font-size: var(--font-size-sm);
            color: var(--error-red);
            margin-top: var(--spacing-2);
            display: none;
        }
        
        .form-validation.show {
            display: block;
            animation: slideDown 0.3s ease;
        }
        
        .form-textarea {
            min-height: 100px;
            resize: vertical;
            line-height: var(--line-height-relaxed);
        }
        
        /* ============================================
           CUSTOM CHECKBOXES AND RADIO BUTTONS
           ============================================ */
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
            cursor: pointer;
        }
        
        .checkbox-custom {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            position: relative;
            transition: all var(--transition-speed) ease;
            flex-shrink: 0;
        }
        
        .checkbox-container input[type="checkbox"] {
            display: none;
        }
        
        .checkbox-container input[type="checkbox"]:checked + .checkbox-custom {
            background: var(--primary-orange);
            border-color: var(--primary-orange);
        }
        
        .checkbox-container input[type="checkbox"]:checked + .checkbox-custom::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--white);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-bold);
        }
        
        .radio-container {
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
            cursor: pointer;
        }
        
        .radio-custom {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            position: relative;
            transition: all var(--transition-speed) ease;
            flex-shrink: 0;
        }
        
        .radio-container input[type="radio"] {
            display: none;
        }
        
        .radio-container input[type="radio"]:checked + .radio-custom {
            border-color: var(--primary-orange);
        }
        
        .radio-container input[type="radio"]:checked + .radio-custom::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 10px;
            background: var(--primary-orange);
            border-radius: 50%;
        }
        
        /* ============================================
           PRICE DISPLAY ENHANCEMENTS
           ============================================ */
        .price-breakdown {
            background: var(--off-white);
            border-radius: var(--element-radius);
            padding: var(--spacing-6);
            margin: var(--spacing-6) 0;
            border: 1px solid var(--border-color);
        }
        
        .price-breakdown-title {
            font-weight: var(--font-weight-bold);
            font-size: var(--font-size-base);
            color: var(--dark-gray);
            margin-bottom: var(--spacing-4);
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
        }
        
        .price-breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-3) 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .price-breakdown-item:last-child {
            border-bottom: none;
        }
        
        .price-breakdown-label {
            font-size: var(--font-size-base);
            color: var(--text-gray);
        }
        
        .price-breakdown-value {
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-semibold);
            color: var(--dark-gray);
        }
        
        .price-breakdown-total {
            margin-top: var(--spacing-4);
            padding-top: var(--spacing-4);
            border-top: 2px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .price-breakdown-total-label {
            font-size: var(--font-size-md);
            font-weight: var(--font-weight-bold);
            color: var(--dark-gray);
        }
        
        .price-breakdown-total-value {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-extrabold);
            color: var(--primary-orange);
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* ============================================
           TIME ESTIMATE DISPLAY
           ============================================ */
        .time-estimate-display {
            display: flex;
            align-items: center;
            gap: var(--spacing-4);
            background: var(--off-white);
            border-radius: var(--element-radius);
            padding: var(--spacing-5) var(--spacing-6);
            margin: var(--spacing-6) 0;
            border-left: 4px solid var(--primary-orange);
        }
        
        .time-estimate-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: var(--light-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-orange);
            font-size: var(--font-size-lg);
            flex-shrink: 0;
        }
        
        .time-estimate-content {
            flex: 1;
        }
        
        .time-estimate-label {
            font-size: var(--font-size-sm);
            color: var(--text-gray);
            margin-bottom: 2px;
        }
        
        .time-estimate-value {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-bold);
            color: var(--dark-gray);
        }
        
        .time-estimate-unit {
            font-size: var(--font-size-sm);
            color: var(--text-light);
            margin-left: 2px;
        }
        
        /* ============================================
           DISTANCE DISPLAY
           ============================================ */
        .distance-display {
            display: flex;
            align-items: center;
            gap: var(--spacing-4);
            background: var(--off-white);
            border-radius: var(--element-radius);
            padding: var(--spacing-5) var(--spacing-6);
            margin: var(--spacing-6) 0;
            border-left: 4px solid var(--distance-indicator);
        }
        
        .distance-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: #E3F2FD;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--distance-indicator);
            font-size: var(--font-size-lg);
            flex-shrink: 0;
        }
        
        .distance-content {
            flex: 1;
        }
        
        .distance-label {
            font-size: var(--font-size-sm);
            color: var(--text-gray);
            margin-bottom: 2px;
        }
        
        .distance-value {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-bold);
            color: var(--dark-gray);
        }
        
        .distance-unit {
            font-size: var(--font-size-sm);
            color: var(--text-light);
            margin-left: 2px;
        }
        
        /* ============================================
           SURGE PRICING INDICATOR
           ============================================ */
        .surge-pricing-indicator {
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
            background: linear-gradient(135deg, #FFF3E0, #FFECB3);
            border-radius: var(--element-radius);
            padding: var(--spacing-4) var(--spacing-6);
            margin: var(--spacing-6) 0;
            border: 1px solid rgba(255, 152, 0, 0.2);
        }
        
        .surge-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: rgba(255, 152, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--warning-yellow);
            font-size: var(--font-size-md);
            flex-shrink: 0;
        }
        
        .surge-content {
            flex: 1;
        }
        
        .surge-title {
            font-weight: var(--font-weight-bold);
            font-size: var(--font-size-sm);
            color: #E65100;
            margin-bottom: 2px;
        }
        
        .surge-message {
            font-size: var(--font-size-sm);
            color: #EF6C00;
        }
        
        .surge-multiplier {
            font-weight: var(--font-weight-bold);
            color: #D84315;
        }
        
        /* ============================================
           SAFETY FEATURES INDICATOR
           ============================================ */
        .safety-features {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-4);
            margin: var(--spacing-8) 0;
        }
        
        .safety-feature {
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
            padding: var(--spacing-4);
            background: var(--off-white);
            border-radius: var(--element-radius);
            border: 1px solid var(--border-color);
            transition: all var(--transition-speed) ease;
        }
        
        .safety-feature:hover {
            border-color: var(--safety-indicator);
            background: #E8F5E9;
            transform: translateY(-2px);
        }
        
        .safety-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: rgba(76, 175, 80, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--safety-indicator);
            font-size: var(--font-size-md);
            flex-shrink: 0;
        }
        
        .safety-text {
            font-size: var(--font-size-sm);
            color: var(--text-gray);
            font-weight: var(--font-weight-medium);
        }
        
        /* ============================================
           PROMOTION BANNER
           ============================================ */
        .promotion-banner {
            background: linear-gradient(135deg, var(--promotion-banner), #FFE082);
            border-radius: var(--element-radius);
            padding: var(--spacing-6);
            margin: var(--spacing-8) 0;
            border: 1px solid rgba(255, 193, 7, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .promotion-banner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.3) 50%, transparent 70%);
            animation: shimmer 3s infinite;
        }
        
        .promotion-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
            margin-bottom: var(--spacing-3);
        }
        
        .promotion-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: rgba(255, 193, 7, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--promotion-gold);
            font-size: var(--font-size-lg);
            flex-shrink: 0;
        }
        
        .promotion-title {
            font-weight: var(--font-weight-bold);
            font-size: var(--font-size-md);
            color: #5D4037;
        }
        
        .promotion-message {
            font-size: var(--font-size-base);
            color: #795548;
            line-height: var(--line-height-relaxed);
            margin-bottom: var(--spacing-4);
        }
        
        .promotion-code {
            background: var(--white);
            padding: var(--spacing-4) var(--spacing-6);
            border-radius: var(--element-radius);
            font-family: var(--font-mono);
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-bold);
            color: var(--primary-orange);
            letter-spacing: var(--letter-spacing-wide);
            text-align: center;
            border: 2px dashed rgba(255, 107, 53, 0.3);
            margin: var(--spacing-4) 0;
        }
        
        .promotion-cta {
            display: flex;
            gap: var(--spacing-4);
            margin-top: var(--spacing-4);
        }
        
        /* ============================================
           REFERRAL BADGE
           ============================================ */
        .referral-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-2);
            background: linear-gradient(135deg, #E0F2F1, #B2DFDB);
            color: var(--referral-teal);
            padding: var(--spacing-2) var(--spacing-4);
            border-radius: 20px;
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-bold);
            margin-left: var(--spacing-3);
        }
        
        /* ============================================
           VEHICLE CAPACITY INDICATOR
           ============================================ */
        .vehicle-capacity {
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
            background: var(--off-white);
            padding: var(--spacing-2) var(--spacing-3);
            border-radius: var(--element-radius);
            font-size: var(--font-size-xs);
            color: var(--text-gray);
        }
        
        .capacity-icon {
            color: var(--primary-orange);
        }
        
        /* ============================================
           RIDE STATUS INDICATORS
           ============================================ */
        .ride-status-indicator {
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
            padding: var(--spacing-3) var(--spacing-4);
            border-radius: var(--element-radius);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
        }
        
        .ride-status-indicator.requested {
            background: rgba(33, 150, 243, 0.1);
            color: var(--info-blue);
        }
        
        .ride-status-indicator.accepted {
            background: rgba(255, 193, 7, 0.1);
            color: var(--warning-yellow);
        }
        
        .ride-status-indicator.arrived {
            background: rgba(76, 175, 80, 0.1);
            color: var(--success-green);
        }
        
        .ride-status-indicator.started {
            background: rgba(103, 58, 183, 0.1);
            color: #673AB7;
        }
        
        .ride-status-indicator.completed {
            background: rgba(158, 158, 158, 0.1);
            color: var(--text-gray);
        }
        
        .ride-status-indicator.cancelled {
            background: rgba(244, 67, 54, 0.1);
            color: var(--error-red);
        }
        
        /* ============================================
           PAYMENT STATUS INDICATORS
           ============================================ */
        .payment-status {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-2);
            padding: var(--spacing-2) var(--spacing-3);
            border-radius: 12px;
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-semibold);
        }
        
        .payment-status.paid {
            background: rgba(0, 200, 83, 0.1);
            color: var(--payment-success);
        }
        
        .payment-status.pending {
            background: rgba(255, 152, 0, 0.1);
            color: var(--payment-pending);
        }
        
        .payment-status.failed {
            background: rgba(244, 67, 54, 0.1);
            color: var(--payment-failed);
        }
        
        /* ============================================
           WALLET BALANCE DISPLAY
           ============================================ */
        .wallet-balance-display {
            background: linear-gradient(135deg, var(--wallet-balance-bg), #FFECB3);
            border-radius: var(--card-radius);
            padding: var(--spacing-8);
            text-align: center;
            position: relative;
            overflow: hidden;
            margin: var(--spacing-6) 0;
        }
        
        .wallet-balance-display::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 40%, rgba(255, 255, 255, 0.3) 50%, transparent 60%);
            animation: shimmer 3s infinite;
        }
        
        .wallet-label {
            font-size: var(--font-size-base);
            color: var(--text-gray);
            margin-bottom: var(--spacing-3);
        }
        
        .wallet-amount {
            font-size: var(--font-size-4xl);
            font-weight: var(--font-weight-extrabold);
            color: var(--primary-orange);
            margin-bottom: var(--spacing-3);
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .wallet-currency {
            font-size: var(--font-size-lg);
            color: var(--text-light);
            margin-left: var(--spacing-2);
        }
        
        /* ============================================
           DRIVER ARRIVAL COUNTDOWN
           ============================================ */
        .driver-arrival-countdown {
            display: flex;
            align-items: center;
            gap: var(--spacing-4);
            background: linear-gradient(135deg, #E3F2FD, #BBDEFB);
            border-radius: var(--element-radius);
            padding: var(--spacing-6);
            margin: var(--spacing-6) 0;
            border-left: 4px solid var(--info-blue);
        }
        
        .countdown-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: rgba(33, 150, 243, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--info-blue);
            font-size: var(--font-size-lg);
            flex-shrink: 0;
        }
        
        .countdown-content {
            flex: 1;
        }
        
        .countdown-label {
            font-size: var(--font-size-sm);
            color: #1565C0;
            margin-bottom: 2px;
        }
        
        .countdown-timer {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            color: #0D47A1;
            font-family: var(--font-mono);
        }
        
        .countdown-unit {
            font-size: var(--font-size-sm);
            color: #1976D2;
            margin-left: 2px;
        }
        
        /* ============================================
           RIDE SHARING INDICATOR
           ============================================ */
        .ride-sharing-indicator {
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
            background: rgba(56, 142, 60, 0.1);
            border-radius: var(--element-radius);
            padding: var(--spacing-4) var(--spacing-6);
            margin: var(--spacing-6) 0;
            border: 1px solid rgba(56, 142, 60, 0.2);
        }
        
        .sharing-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: rgba(56, 142, 60, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--share-green);
            font-size: var(--font-size-md);
            flex-shrink: 0;
        }
        
        .sharing-content {
            flex: 1;
        }
        
        .sharing-title {
            font-weight: var(--font-weight-bold);
            font-size: var(--font-size-sm);
            color: var(--share-green);
            margin-bottom: 2px;
        }
        
        .sharing-details {
            font-size: var(--font-size-sm);
            color: #2E7D32;
        }
        
        /* ============================================
           BROADCAST INDICATOR
           ============================================ */
        .broadcast-indicator {
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
            background: rgba(126, 87, 194, 0.1);
            border-radius: var(--element-radius);
            padding: var(--spacing-4) var(--spacing-6);
            margin: var(--spacing-6) 0;
            border: 1px solid rgba(126, 87, 194, 0.2);
        }
        
        .broadcast-icon-indicator {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: rgba(126, 87, 194, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--broadcast-indicator);
            font-size: var(--font-size-md);
            flex-shrink: 0;
            animation: pulse 2s infinite;
        }
        
        .broadcast-content-indicator {
            flex: 1;
        }
        
        .broadcast-title-indicator {
            font-weight: var(--font-weight-bold);
            font-size: var(--font-size-sm);
            color: var(--broadcast-indicator);
            margin-bottom: 2px;
        }
        
        .broadcast-details {
            font-size: var(--font-size-sm);
            color: #5E35B1;
        }
        
        /* ============================================
           EMERGENCY BANNER
           ============================================ */
        .emergency-banner {
            background: linear-gradient(135deg, var(--emergency-banner), #FFCDD2);
            border-radius: var(--element-radius);
            padding: var(--spacing-6);
            margin: var(--spacing-8) 0;
            border: 2px solid var(--error-red);
            position: relative;
            overflow: hidden;
            animation: pulse 2s infinite;
        }
        
        .emergency-banner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 40%, rgba(255, 255, 255, 0.3) 50%, transparent 60%);
            animation: shimmer 2s infinite;
        }
        
        .emergency-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
            margin-bottom: var(--spacing-3);
        }
        
        .emergency-icon-banner {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: rgba(244, 67, 54, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--error-red);
            font-size: var(--font-size-lg);
            flex-shrink: 0;
            animation: pulse 1s infinite;
        }
        
        .emergency-title-banner {
            font-weight: var(--font-weight-bold);
            font-size: var(--font-size-md);
            color: var(--error-red);
        }
        
        .emergency-message {
            font-size: var(--font-size-base);
            color: #D32F2F;
            line-height: var(--line-height-relaxed);
            margin-bottom: var(--spacing-4);
        }
        
        /* ============================================
           ACCESSIBILITY FEATURES
           ============================================ */
        .accessibility-features {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-4);
            margin: var(--spacing-8) 0;
        }
        
        .accessibility-feature {
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
            padding: var(--spacing-4);
            background: var(--off-white);
            border-radius: var(--element-radius);
            border: 1px solid var(--border-color);
            transition: all var(--transition-speed) ease;
            cursor: pointer;
        }
        
        .accessibility-feature:hover {
            border-color: var(--accessibility-blue);
            background: #E3F2FD;
            transform: translateY(-2px);
        }
        
        .accessibility-feature.selected {
            border-color: var(--accessibility-blue);
            background: #BBDEFB;
        }
        
        .accessibility-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: rgba(21, 101, 192, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accessibility-blue);
            font-size: var(--font-size-md);
            flex-shrink: 0;
        }
        
        .accessibility-feature.selected .accessibility-icon {
            background: var(--accessibility-blue);
            color: var(--white);
        }
        
        .accessibility-text {
            font-size: var(--font-size-sm);
            color: var(--text-gray);
            font-weight: var(--font-weight-medium);
        }
        
        .accessibility-feature.selected .accessibility-text {
            color: var(--accessibility-blue);
            font-weight: var(--font-weight-bold);
        }
        
        /* ============================================
           MAP CONTROLS ENHANCEMENT
           ============================================ */
        .map-controls {
            position: absolute;
            bottom: calc(45% + 20px);
            right: var(--app-padding);
            z-index: var(--z-index-sticky);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-3);
        }
        
        .map-control-button {
            width: 44px;
            height: 44px;
            border-radius: var(--element-radius);
            background: var(--map-controls-bg);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--dark-gray);
            cursor: pointer;
            transition: all 0.3s var(--animation-smooth);
            box-shadow: var(--shadow-light);
        }
        
        .map-control-button:hover {
            background: var(--map-controls-hover);
            border-color: var(--primary-orange);
            color: var(--primary-orange);
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .map-control-button.active {
            background: var(--map-controls-active);
            border-color: var(--primary-orange);
            color: var(--primary-orange);
        }
        
        /* ============================================
           LOCATION ACCURACY INDICATOR
           ============================================ */
        .location-accuracy {
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
            background: var(--off-white);
            border-radius: var(--element-radius);
            padding: var(--spacing-3) var(--spacing-4);
            margin: var(--spacing-4) 0;
            font-size: var(--font-size-sm);
            color: var(--text-gray);
        }
        
        .accuracy-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--location-accent);
            animation: pulse 2s infinite;
        }
        
        .accuracy-dot.high {
            background: var(--success-green);
        }
        
        .accuracy-dot.medium {
            background: var(--warning-yellow);
        }
        
        .accuracy-dot.low {
            background: var(--error-red);
        }
        
        /* ============================================
           NETWORK STATUS INDICATOR
           ============================================ */
        .network-status {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: var(--z-index-toast);
            background: var(--error-red);
            color: var(--white);
            padding: var(--spacing-3) var(--spacing-6);
            border-radius: var(--button-radius);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            display: none;
            align-items: center;
            gap: var(--spacing-3);
            animation: slideDown 0.3s ease;
        }
        
        .network-status.online {
            background: var(--success-green);
            display: flex;
        }
        
        .network-status.offline {
            background: var(--error-red);
            display: flex;
        }
        
        /* ============================================
           BATTERY SAVER INDICATOR
           ============================================ */
        .battery-saver {
            position: fixed;
            bottom: calc(45% + 10px);
            left: var(--app-padding);
            z-index: var(--z-index-sticky);
            background: var(--warning-yellow);
            color: var(--white);
            padding: var(--spacing-3) var(--spacing-6);
            border-radius: var(--button-radius);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            display: none;
            align-items: center;
            gap: var(--spacing-3);
            animation: slideInLeft 0.3s ease;
        }
        
        .battery-saver.active {
            display: flex;
        }
        
        /* ============================================
           AUTO-COMPLETE ENHANCEMENTS
           ============================================ */
        .autocomplete-container {
            position: relative;
            width: 100%;
        }
        
        .autocomplete-items {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: var(--z-index-dropdown);
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            max-height: 250px;
            overflow-y: auto;
            display: none;
        }
        
        .autocomplete-items.active {
            display: block;
            animation: slideDown 0.2s ease;
        }
        
        .autocomplete-item {
            padding: var(--spacing-4) var(--spacing-6);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            border-bottom: 1px solid var(--border-color);
        }
        
        .autocomplete-item:last-child {
            border-bottom: none;
        }
        
        .autocomplete-item:hover {
            background: var(--light-orange);
        }
        
        .autocomplete-item.selected {
            background: var(--light-orange);
            border-left: 3px solid var(--primary-orange);
        }
        
        /* ============================================
           GEOCODING STATUS INDICATOR
           ============================================ */
        .geocoding-status {
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
            padding: var(--spacing-4) var(--spacing-6);
            background: var(--off-white);
            border-radius: var(--element-radius);
            margin: var(--spacing-4) 0;
            font-size: var(--font-size-sm);
            color: var(--text-gray);
        }
        
        .geocoding-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--light-gray);
            border-top-color: var(--primary-orange);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        /* ============================================
           ROUTE OPTIMIZATION INDICATOR
           ============================================ */
        .route-optimization {
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
            background: var(--off-white);
            border-radius: var(--element-radius);
            padding: var(--spacing-4) var(--spacing-6);
            margin: var(--spacing-4) 0;
            font-size: var(--font-size-sm);
            color: var(--text-gray);
        }
        
        .optimization-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: rgba(76, 175, 80, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--success-green);
            font-size: var(--font-size-md);
            flex-shrink: 0;
        }
        
        /* ============================================
           REAL-TIME TRAFFIC INDICATOR
           ============================================ */
        .traffic-indicator {
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
            background: var(--off-white);
            border-radius: var(--element-radius);
            padding: var(--spacing-4) var(--spacing-6);
            margin: var(--spacing-4) 0;
            font-size: var(--font-size-sm);
            color: var(--text-gray);
        }
        
        .traffic-light {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--success-green);
            animation: pulse 2s infinite;
        }
        
        .traffic-light.moderate {
            background: var(--warning-yellow);
            animation-duration: 1.5s;
        }
        
        .traffic-light.heavy {
            background: var(--error-red);
            animation-duration: 1s;
        }
        
        /* ============================================
           WEATHER INTEGRATION INDICATOR
           ============================================ */
        .weather-indicator {
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
            background: var(--off-white);
            border-radius: var(--element-radius);
            padding: var(--spacing-4) var(--spacing-6);
            margin: var(--spacing-4) 0;
            font-size: var(--font-size-sm);
            color: var(--text-gray);
        }
        
        .weather-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: rgba(33, 150, 243, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--info-blue);
            font-size: var(--font-size-md);
            flex-shrink: 0;
        }
        
        /* ============================================
           ENHANCED ERROR BOUNDARIES
           ============================================ */
        .error-boundary {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--white);
            z-index: var(--z-index-max);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-8);
            text-align: center;
        }
        
        .error-boundary.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        
        .error-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--light-red);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--error-red);
            font-size: 32px;
            margin-bottom: var(--spacing-8);
        }
        
        .error-title {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            color: var(--dark-gray);
            margin-bottom: var(--spacing-4);
        }
        
        .error-message {
            font-size: var(--font-size-base);
            color: var(--text-gray);
            line-height: var(--line-height-relaxed);
            margin-bottom: var(--spacing-8);
            max-width: 400px;
        }
        
        /* ============================================
           MAINTENANCE MODE INDICATOR
           ============================================ */
        .maintenance-mode {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--white);
            z-index: var(--z-index-max);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-8);
            text-align: center;
        }
        
        .maintenance-mode.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        
        .maintenance-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--light-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-orange);
            font-size: 32px;
            margin-bottom: var(--spacing-8);
        }
        
        .maintenance-title {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            color: var(--dark-gray);
            margin-bottom: var(--spacing-4);
        }
        
        .maintenance-message {
            font-size: var(--font-size-base);
            color: var(--text-gray);
            line-height: var(--line-height-relaxed);
            margin-bottom: var(--spacing-8);
            max-width: 400px;
        }
        
        /* ============================================
           UPDATE AVAILABLE INDICATOR
           ============================================ */
        .update-available {
            position: fixed;
            bottom: calc(45% + 60px);
            left: 50%;
            transform: translateX(-50%);
            z-index: var(--z-index-toast);
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            padding: var(--spacing-4) var(--spacing-8);
            border-radius: var(--button-radius);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            display: none;
            align-items: center;
            gap: var(--spacing-3);
            animation: slideUp 0.3s ease;
            box-shadow: var(--shadow-heavy);
        }
        
        .update-available.active {
            display: flex;
        }
        
        .update-button {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: var(--white);
            padding: var(--spacing-2) var(--spacing-4);
            border-radius: var(--element-radius);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-bold);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .update-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        /* ============================================
           OFFLINE MODE INDICATOR
           ============================================ */
        .offline-mode {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            z-index: var(--z-index-toast);
            background: var(--warning-yellow);
            color: var(--white);
            padding: var(--spacing-3) var(--spacing-6);
            border-radius: var(--button-radius);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            display: none;
            align-items: center;
            gap: var(--spacing-3);
            animation: slideDown 0.3s ease;
        }
        
        .offline-mode.active {
            display: flex;
        }
        
        /* ============================================
           DATA SAVER INDICATOR
           ============================================ */
        .data-saver {
            position: fixed;
            bottom: calc(45% + 100px);
            right: var(--app-padding);
            z-index: var(--z-index-sticky);
            background: var(--success-green);
            color: var(--white);
            padding: var(--spacing-3) var(--spacing-6);
            border-radius: var(--button-radius);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            display: none;
            align-items: center;
            gap: var(--spacing-3);
            animation: slideInLeft 0.3s ease;
        }
        
        .data-saver.active {
            display: flex;
        }
        
        /* ============================================
           PRIVACY MODE INDICATOR
           ============================================ */
        .privacy-mode {
            position: fixed;
            top: 70px;
            right: var(--app-padding);
            z-index: var(--z-index-sticky);
            background: var(--info-blue);
            color: var(--white);
            padding: var(--spacing-3) var(--spacing-6);
            border-radius: var(--button-radius);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            display: none;
            align-items: center;
            gap: var(--spacing-3);
            animation: slideInRight 0.3s ease;
        }
        
        .privacy-mode.active {
            display: flex;
        }
        
        /* ============================================
           HIGH CONTRAST MODE
           ============================================ */
        .high-contrast {
            --primary-orange: #CC5500;
            --primary-red: #CC0000;
            --white: #000000;
            --off-white: #111111;
            --light-gray: #222222;
            --dark-gray: #FFFFFF;
            --text-gray: #EEEEEE;
            --text-light: #CCCCCC;
            --border-color: #444444;
            --shadow-light: 0 1px 6px rgba(255, 255, 255, 0.1);
            --shadow-medium: 0 2px 12px rgba(255, 255, 255, 0.2);
            --shadow-heavy: 0 4px 20px rgba(255, 255, 255, 0.3);
        }
        
        /* ============================================
           REDUCED MOTION MODE
           ============================================ */
        .reduced-motion * {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
            scroll-behavior: auto !important;
        }
        
        /* ============================================
           LARGE TEXT MODE
           ============================================ */
        .large-text {
            --font-size-xs: 12px;
            --font-size-sm: 14px;
            --font-size-base: 16px;
            --font-size-md: 18px;
            --font-size-lg: 20px;
            --font-size-xl: 22px;
            --font-size-2xl: 24px;
            --font-size-3xl: 28px;
            --font-size-4xl: 32px;
            --font-size-5xl: 40px;
            --line-height-normal: 1.6;
            --line-height-relaxed: 1.8;
            --line-height-tight: 1.4;
        }
        
        /* ============================================
           PERFORMANCE OPTIMIZATIONS
           ============================================ */
        .will-change {
            will-change: transform, opacity;
        }
        
        .backface-hidden {
            backface-visibility: hidden;
        }
        
        .transform-gpu {
            transform: translateZ(0);
        }
        
        /* ============================================
           PRINT OPTIMIZATIONS
           ============================================ */
        @media print {
            .no-print {
                display: none !important;
            }
            
            .print-only {
                display: block !important;
            }
            
            body {
                font-size: 12pt !important;
                line-height: 1.6 !important;
                color: black !important;
                background: white !important;
            }
            
            a {
                color: black !important;
                text-decoration: underline !important;
            }
            
            .page-break {
                page-break-before: always;
            }
            
            .page-break-inside-avoid {
                page-break-inside: avoid;
            }
        }
        
        /* ============================================
           HOVER MEDIA QUERY FALLBACKS
           ============================================ */
        @media (hover: hover) and (pointer: fine) {
            .hover-effect:hover {
                transform: var(--button-hover-transform);
                box-shadow: var(--shadow-medium);
            }
        }
        
        @media (hover: none) and (pointer: coarse) {
            .hover-effect:active {
                transform: var(--button-active-transform);
                opacity: 0.8;
            }
        }
        
        /* ============================================
           ORIENTATION SPECIFIC STYLES
           ============================================ */
        @media (orientation: portrait) {
            .portrait-only {
                display: block;
            }
            
            .landscape-only {
                display: none;
            }
            
            #map {
                height: 50%;
            }
            
            .main-panel {
                max-height: 50vh;
            }
        }
        
        @media (orientation: landscape) {
            .portrait-only {
                display: none;
            }
            
            .landscape-only {
                display: block;
            }
            
            #map {
                height: 60%;
            }
            
            .main-panel {
                max-height: 40vh;
            }
        }
        
        /* ============================================
           DEVICE PIXEL RATIO OPTIMIZATIONS
           ============================================ */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .retina-optimized {
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            }
        }
        
        /* ============================================
           TOUCH TARGET SIZES FOR ACCESSIBILITY
           ============================================ */
        .touch-target {
            min-height: 44px;
            min-width: 44px;
        }
        
        /* ============================================
           REDUCED TRANSPARENCY MODE
           ============================================ */
        @media (prefers-reduced-transparency: reduce) {
            .top-bar,
            .modal-overlay,
            .notification-dropdown,
            .suggestion-list {
                backdrop-filter: none;
                -webkit-backdrop-filter: none;
                background: var(--white);
            }
        }
        
        /* ============================================
           FORCE COLOR SCHEME
           ============================================ */
        @media (forced-colors: active) {
            .forced-colors {
                border: 1px solid CanvasText;
                background-color: Canvas;
                color: CanvasText;
            }
            
            .forced-colors-button {
                border: 2px solid ButtonText;
                background-color: ButtonFace;
                color: ButtonText;
            }
        }
        
        /* ============================================
           CUSTOM PROPERTY FALLBACKS
           ============================================ */
        @supports not (backdrop-filter: blur(20px)) {
            .top-bar {
                background: var(--white);
            }
            
            .modal-overlay {
                background: var(--modal-backdrop);
            }
        }
        
        @supports not (display: grid) {
            .service-tabs {
                display: flex;
                flex-wrap: nowrap;
            }
            
            .ride-type-grid {
                display: flex;
                flex-wrap: wrap;
            }
            
            .ride-type-card {
                flex: 1;
                min-width: 100px;
            }
        }
    </style>
</head>
<body>
    <!-- Enhanced Map Container -->
    <div id="map" class="will-change"></div>
    
    <!-- Enhanced Top Navigation Bar with Logo and User Info -->
    <div class="top-bar will-change">
        <div class="logo-container" id="logoContainer">
            <div class="logo-image-container">
                <img src="jubel.png" alt="Jubel Logo" class="logo-image" id="logoImage" onerror="this.style.display='none'; this.parentNode.innerHTML='<i class=\'fas fa-car\'></i>';">
            </div>
            <div class="logo-text-container">
                <div class="logo-brand">Jubel</div>
                <div class="user-name" id="userName">Loading...</div>
            </div>
        </div>
        
        <div class="user-actions">
            <div class="balance-badge hover-effect" id="balanceBadge">
                <i class="fas fa-wallet"></i>
                <span>Balance: <span class="balance-amount" id="walletBalance">ZMW 0.00</span></span>
            </div>
            
            <div class="notification-container">
                <div class="notification-bell hover-effect" id="notificationBell">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge" id="notificationCount">0</span>
                </div>
                <div class="notification-dropdown" id="notificationDropdown">
                    <div class="notification-header">
                        <div class="notification-title">
                            <i class="fas fa-bell"></i>
                            Notifications
                        </div>
                        <button class="notification-clear" id="notificationClear">
                            Clear All
                        </button>
                    </div>
                    <div class="notification-list" id="notificationList">
                        <!-- Notifications will be inserted here -->
                        <div class="empty-state">
                            <i class="fas fa-bell-slash"></i>
                            <div class="empty-title">No notifications</div>
                            <div class="empty-message">Your notifications will appear here</div>
                        </div>
                    </div>
                    <div class="notification-footer">
                        <a href="#" class="notification-view-all" id="notificationViewAll">View All Notifications</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Enhanced Ride Status Bar -->
    <div class="ride-status-bar" id="rideStatusBar">
        <div class="status-indicator">
            <div class="status-dot searching" id="statusDot"></div>
            <span class="status-text" id="statusText">Searching for driver</span>
        </div>
        <div class="status-eta">
            <i class="fas fa-clock"></i>
            <span id="etaText">5 min</span>
        </div>
    </div>
    
    <!-- Enhanced Emergency Status -->
    <div class="emergency-status" id="emergencyStatus">
        <i class="fas fa-exclamation-triangle"></i>
        <span>EMERGENCY RIDE IN PROGRESS</span>
    </div>
    
    <!-- Enhanced SOS Button with Pulsing Animation -->
    <div class="sos-button" id="sosButton">
        SOS
    </div>
    
    <!-- Enhanced Chat Container -->
    <div class="chat-container-enhanced" id="chatContainer">
        <div class="chat-header-enhanced">
            <div class="chat-title-enhanced">
                <span>Chat with Driver</span>
                <div class="chat-driver-status" id="chatDriverStatus"></div>
            </div>
            <button class="chat-close-enhanced" id="chatClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="chat-messages-enhanced" id="chatMessages">
            <!-- Messages will be inserted here -->
        </div>
        <div class="chat-typing-indicator" id="chatTypingIndicator">
            <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
            <span>Driver is typing...</span>
        </div>
        <div class="chat-input-container-enhanced">
            <input type="text" class="chat-input-enhanced" id="chatInput" placeholder="Type your message...">
            <button class="chat-send-btn-enhanced" id="chatSend">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
    
    <!-- Enhanced Main Panel -->
    <div class="main-panel" id="mainPanel">
        <div class="panel-handle" id="panelHandle"></div>
        
        <!-- Enhanced Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active hover-effect" data-screen="home">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </button>
            <button class="nav-tab hover-effect" data-screen="history">
                <i class="fas fa-history"></i>
                <span>History</span>
            </button>
            <button class="nav-tab hover-effect" data-screen="account">
                <i class="fas fa-user"></i>
                <span>Account</span>
            </button>
            <button class="nav-tab hover-effect" data-screen="emergency">
                <i class="fas fa-ambulance"></i>
                <span>Emergency</span>
            </button>
        </div>
        
        <!-- Enhanced Home Screen Content -->
        <div id="homeContent">
            <!-- Enhanced Service Tabs with More Options Dropdown -->
            <div class="service-tabs-container">
                <div class="service-tabs" id="serviceTabs">
                    <div class="service-tab car active hover-effect" data-service="car">
                        <div class="service-icon">
                            <i class="fas fa-car"></i>
                        </div>
                        <div class="service-name">Car</div>
                        <div class="service-desc">Ride anywhere</div>
                    </div>
                    
                    <div class="service-tab delivery hover-effect" data-service="delivery">
                        <div class="service-icon">
                            <i class="fas fa-shipping-fast"></i>
                        </div>
                        <div class="service-name">Delivery</div>
                        <div class="service-desc">Send packages</div>
                    </div>
                    
                    <div class="service-tab short-delivery hover-effect" data-service="short-delivery">
                        <div class="service-icon">
                            <i class="fas fa-bicycle"></i>
                        </div>
                        <div class="service-name">Short Delivery</div>
                        <div class="service-desc">Quick deliveries</div>
                    </div>
                    
                    <div class="service-tab hover-effect" data-service="express">
                        <div class="service-icon">
                            <i class="fas fa-shopping-bag"></i>
                        </div>
                        <div class="service-name">Express Shopping</div>
                        <div class="service-desc">Shop for you</div>
                    </div>
                    
                    <div class="service-tab hover-effect" data-service="truck">
                        <div class="service-icon">
                            <i class="fas fa-truck"></i>
                        </div>
                        <div class="service-name">Truck</div>
                        <div class="service-desc">Move items</div>
                    </div>
                </div>
                
                <!-- More Options Dropdown -->
                <div class="more-options-dropdown" id="moreOptionsDropdown">
                    <div class="more-options-header">
                        <i class="fas fa-ellipsis-h"></i>
                        More Options
                    </div>
                    <div class="more-options-grid">
                        <div class="more-option-item hover-effect" data-option="schedule">
                            <div class="more-option-icon">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                            <div class="more-option-name">Schedule Ride</div>
                        </div>
                        <div class="more-option-item hover-effect" data-option="order-for-someone">
                            <div class="more-option-icon">
                                <i class="fas fa-user-friends"></i>
                            </div>
                            <div class="more-option-name">Order for Someone</div>
                        </div>
                        <div class="more-option-item hover-effect" data-option="share-ride">
                            <div class="more-option-icon">
                                <i class="fas fa-share-alt"></i>
                            </div>
                            <div class="more-option-name">Share Ride</div>
                        </div>
                        <div class="more-option-item hover-effect" data-option="broadcast-ride">
                            <div class="more-option-icon">
                                <i class="fas fa-broadcast-tower"></i>
                            </div>
                            <div class="more-option-name">Broadcast Ride</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Enhanced Quick Actions -->
            <div class="quick-actions">
                <button class="quick-action-btn hover-effect" id="scheduleRideBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">Schedule Ride</div>
                        <div class="quick-action-desc">Plan your ride in advance</div>
                    </div>
                </button>
                <button class="quick-action-btn hover-effect" id="orderForSomeoneBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-user-friends"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">Order for Someone</div>
                        <div class="quick-action-desc">Book a ride for others</div>
                    </div>
                </button>
                <button class="quick-action-btn hover-effect" id="shareRideBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-share-alt"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">Share Ride</div>
                        <div class="quick-action-desc">Split fare with friends</div>
                    </div>
                </button>
                <button class="quick-action-btn hover-effect" id="broadcastRideBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-broadcast-tower"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">Broadcast Ride</div>
                        <div class="quick-action-desc">Share ride with contacts</div>
                    </div>
                </button>
            </div>
            
            <!-- Enhanced Car Service Form (Default) -->
            <div class="ride-request-form active" id="carForm">
                <div class="form-title">
                    <i class="fas fa-car"></i>
                    Book a Ride
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="pickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="pickupLocation" placeholder="Current location" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="pickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="destinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="destinationLocation" placeholder="Where to?">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="destinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Enhanced Ride Type Selection -->
                <div class="ride-type-selection-container">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                        <span id="rideTypeInfo" class="ride-type-info hover-effect">
                            <i class="fas fa-info-circle"></i>
                        </span>
                    </div>
                    
                    <div class="ride-type-grid">
                        <div class="ride-type-card economy hover-effect" data-type="economy">
                            <div class="ride-type-icon">
                                <i class="fas fa-car-side"></i>
                            </div>
                            <div class="ride-type-name">Economy</div>
                            <div class="ride-type-price" id="economyPrice">ZMW 0.00</div>
                            <div class="ride-type-eta">ETA: 5-10 min</div>
                        </div>
                        
                        <div class="ride-type-card selected hover-effect" data-type="standard">
                            <div class="ride-type-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="ride-type-name">Standard</div>
                            <div class="ride-type-price" id="standardPrice">ZMW 0.00</div>
                            <div class="ride-type-eta">ETA: 3-7 min</div>
                        </div>
                        
                        <div class="ride-type-card premium hover-effect" data-type="premium">
                            <div class="ride-type-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="ride-type-name">Premium</div>
                            <div class="ride-type-price" id="premiumPrice">ZMW 0.00</div>
                            <div class="ride-type-eta">ETA: 2-5 min</div>
                        </div>
                    </div>
                </div>
                
                <!-- Enhanced Fare Display -->
                <div class="fare-display" id="fareDisplay">
                    <div class="fare-label">Estimated Fare</div>
                    <div class="fare-amount" id="estimatedFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="distanceDetail">0 km</span>
                        <span id="timeDetail">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Enhanced Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary hover-effect" id="requestRideBtn">
                        <i class="fas fa-search"></i>
                        Request Ride
                    </button>
                </div>
            </div>
            
            <!-- Enhanced Delivery Service Form -->
            <div class="service-form delivery-form" id="deliveryForm">
                <div class="form-title">
                    <i class="fas fa-shipping-fast"></i>
                    Package Delivery
                </div>
                
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="deliveryPickup" placeholder="Pickup location" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="deliveryPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="deliveryDestination" placeholder="Delivery address">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="deliveryDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Enhanced Delivery Details -->
                <div class="form-group">
                    <label class="form-label">Parcel Description</label>
                    <input type="text" class="form-control" id="parcelDescription" placeholder="What are you sending?">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Receiver's Details</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="receiverName" placeholder="Receiver name">
                        <input type="tel" class="form-control" id="receiverPhone" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Parcel Value (ZMW)</label>
                    <input type="number" class="form-control" id="parcelValue" placeholder="Value of parcel" min="0" step="0.01">
                </div>
                
                <!-- Enhanced Delivery Options -->
                <div class="form-group">
                    <label class="form-label">Delivery Type</label>
                    <div style="display: flex; gap: 10px;">
                        <button class="filter-btn active hover-effect" id="standardDelivery">Standard</button>
                        <button class="filter-btn hover-effect" id="expressDelivery">Express</button>
                        <button class="filter-btn hover-effect" id="sameDayDelivery">Same Day</button>
                    </div>
                </div>
                
                <!-- Enhanced Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary hover-effect" id="requestDeliveryBtn">
                        <i class="fas fa-shipping-fast"></i>
                        Request Delivery
                    </button>
                </div>
            </div>
            
            <!-- Enhanced Short Delivery Form -->
            <div class="service-form delivery-form" id="shortDeliveryForm">
                <div class="form-title">
                    <i class="fas fa-bicycle"></i>
                    Short Delivery
                </div>
                
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="shortDeliveryPickup" placeholder="Pickup location" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shortDeliveryPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="shortDeliveryDestination" placeholder="Delivery address">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shortDeliveryDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Enhanced Delivery Details -->
                <div class="form-group">
                    <label class="form-label">What are you sending?</label>
                    <input type="text" class="form-control" id="shortParcelDescription" placeholder="Food, documents, small items...">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Receiver's Phone</label>
                    <input type="tel" class="form-control" id="shortReceiverPhone" placeholder="Receiver phone number">
                </div>
                
                <!-- Enhanced Quick Options -->
                <div class="form-group">
                    <label class="form-label">Quick Options</label>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <span class="filter-btn hover-effect">Food</span>
                        <span class="filter-btn hover-effect">Documents</span>
                        <span class="filter-btn hover-effect">Medication</span>
                        <span class="filter-btn hover-effect">Small Package</span>
                    </div>
                </div>
                
                <!-- Enhanced Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary hover-effect" id="requestShortDeliveryBtn">
                        <i class="fas fa-bolt"></i>
                        Quick Delivery
                    </button>
                </div>
            </div>
            
            <!-- Enhanced Express Shopping Form -->
            <div class="service-form express-form" id="expressForm">
                <div class="form-title">
                    <i class="fas fa-shopping-bag"></i>
                    Express Shopping
                </div>
                
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-store"></i>
                        <input type="text" id="shopName" placeholder="Shop/Restaurant name">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shopSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="shopLocation" placeholder="Shop location" readonly>
                    </div>
                </div>
                
                <!-- Enhanced Items List -->
                <div class="form-group">
                    <label class="form-label">Shopping List</label>
                    <div class="item-list" id="shoppingItems">
                        <div class="item-entry">
                            <input type="text" class="item-input" placeholder="Item name">
                            <button class="remove-item hover-effect" type="button">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <button class="add-item hover-effect" type="button" id="addItemBtn">
                        <i class="fas fa-plus"></i>
                        Add Item
                    </button>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Special Instructions</label>
                    <textarea class="form-control form-textarea" id="shoppingInstructions" placeholder="Any specific requests or instructions..."></textarea>
                </div>
                
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="shoppingDestination" placeholder="Delivery address">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shoppingDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Enhanced Budget -->
                <div class="form-group">
                    <label class="form-label">Estimated Budget (ZMW)</label>
                    <input type="number" class="form-control" id="shoppingBudget" placeholder="Estimated cost of items">
                </div>
                
                <!-- Enhanced Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary hover-effect" id="requestShoppingBtn">
                        <i class="fas fa-shopping-cart"></i>
                        Request Shopping
                    </button>
                </div>
            </div>
            
            <!-- Enhanced Truck Delivery Form -->
            <div class="service-form truck-form" id="truckForm">
                <div class="form-title">
                    <i class="fas fa-truck"></i>
                    Truck Delivery
                </div>
                
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="truckPickup" placeholder="Pickup location (Current location)" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="truckPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="truckDestination" placeholder="Destination">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="truckDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Enhanced Truck Type Selection -->
                <div class="form-group">
                    <label class="form-label">Select Truck Type</label>
                    <div class="truck-types">
                        <div class="truck-type hover-effect" data-type="pickup">
                            <div class="truck-icon">
                                <i class="fas fa-truck-pickup"></i>
                            </div>
                            <div class="truck-name">Pickup Truck</div>
                            <div class="truck-capacity">Up to 1.5 tons</div>
                        </div>
                        
                        <div class="truck-type selected hover-effect" data-type="light">
                            <div class="truck-icon">
                                <i class="fas fa-truck-moving"></i>
                            </div>
                            <div class="truck-name">Light Truck</div>
                            <div class="truck-capacity">Up to 3 tons</div>
                        </div>
                        
                        <div class="truck-type hover-effect" data-type="medium">
                            <div class="truck-icon">
                                <i class="fas fa-truck"></i>
                            </div>
                            <div class="truck-name">Medium Truck</div>
                            <div class="truck-capacity">Up to 7 tons</div>
                        </div>
                        
                        <div class="truck-type hover-effect" data-type="heavy">
                            <div class="truck-icon">
                                <i class="fas fa-truck-loading"></i>
                            </div>
                            <div class="truck-name">Heavy Truck</div>
                            <div class="truck-capacity">Up to 15 tons</div>
                        </div>
                    </div>
                </div>
                
                <!-- Enhanced Item Details -->
                <div class="form-group">
                    <label class="form-label">What are you moving?</label>
                    <input type="text" class="form-control" id="truckItemDescription" placeholder="Furniture, boxes, equipment...">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Estimated Weight (kg)</label>
                    <input type="number" class="form-control" id="estimatedWeight" placeholder="Approximate weight">
                </div>
                
                <!-- Enhanced Additional Help -->
                <div class="form-group">
                    <label class="checkbox-container">
                        <input type="checkbox" id="needHelpers">
                        <span class="checkbox-custom"></span>
                        <span style="margin-left: 8px;">Need loading/unloading helpers (+ZMW 50)</span>
                    </label>
                </div>
                
                <!-- Enhanced Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary hover-effect" id="requestTruckBtn">
                        <i class="fas fa-truck"></i>
                        Request Truck
                    </button>
                </div>
            </div>
            
            <!-- Enhanced Ride Info Panel with Driver Images -->
            <div class="ride-info-panel" id="rideInfoPanel">
                <div class="driver-info-enhanced">
                    <div class="driver-avatar-container">
                        <div class="driver-avatar" id="driverAvatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="driver-status-indicator" id="driverStatusIndicator"></div>
                    </div>
                    <div class="driver-details-enhanced">
                        <div class="driver-name-rating">
                            <div class="driver-name" id="driverName">Driver Name</div>
                            <div class="driver-rating-enhanced">
                                <i class="fas fa-star"></i>
                                <span id="driverRating">4.8</span>
                            </div>
                        </div>
                        
                        <div class="driver-vehicle-enhanced">
                            <div class="vehicle-image-container" id="vehicleImageContainer">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="vehicle-details">
                                <div class="vehicle-model" id="vehicleModel">Toyota Corolla</div>
                                <div class="vehicle-plate" id="vehiclePlate">ABC 123</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Enhanced Timeline -->
                <div class="timeline" id="rideTimeline">
                    <div class="timeline-step">
                        <div class="step-dot active" id="stepRequested">
                            <i class="fas fa-search"></i>
                        </div>
                        <div class="step-label active">Requested</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepAccepted">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <div class="step-label">Accepted</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepArrived">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="step-label">Arrived</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepStarted">
                            <i class="fas fa-play"></i>
                        </div>
                        <div class="step-label">Started</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepCompleted">
                            <i class="fas fa-flag-checkered"></i>
                        </div>
                        <div class="step-label">Completed</div>
                    </div>
                </div>
                
                <!-- Enhanced Trip Details -->
                <div class="trip-details">
                    <div class="trip-locations">
                        <div class="location-point">
                            <div class="location-marker pickup">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="location-text">
                                <div class="location-label">Pickup</div>
                                <div class="location-address" id="currentPickup">Loading...</div>
                            </div>
                        </div>
                        
                        <div class="location-point">
                            <div class="location-marker destination">
                                <i class="fas fa-flag"></i>
                            </div>
                            <div class="location-text">
                                <div class="location-label">Destination</div>
                                <div class="location-address" id="currentDestination">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Enhanced Fare Breakdown -->
                <div class="fare-breakdown">
                    <div class="fare-row">
                        <span class="fare-label">Base Fare</span>
                        <span class="fare-value" id="baseFareValue">ZMW 15.00</span>
                    </div>
                    <div class="fare-row">
                        <span class="fare-label">Distance</span>
                        <span class="fare-value" id="distanceFareValue">ZMW 5.00</span>
                    </div>
                    <div class="fare-row">
                        <span class="fare-label">Ride Type</span>
                        <span class="fare-value" id="rideTypeValue">Standard</span>
                    </div>
                    <div class="fare-row total">
                        <span class="fare-label">Total Fare</span>
                        <span class="fare-value" id="totalFareValue">ZMW 20.00</span>
                    </div>
                </div>
                
                <!-- Enhanced Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-danger hover-effect" id="cancelRideBtn">
                        <i class="fas fa-times-circle"></i>
                        Cancel Ride
                    </button>
                    <button class="btn btn-secondary hover-effect" id="contactDriverBtn">
                        <i class="fas fa-phone"></i>
                        Call Driver
                    </button>
                    <button class="btn btn-secondary hover-effect" id="openChatBtn">
                        <i class="fas fa-comment"></i>
                        Chat
                    </button>
                </div>
            </div>
            
            <!-- Enhanced Schedule Ride Form -->
            <div class="schedule-form" id="scheduleForm">
                <div class="form-title">
                    <i class="fas fa-calendar-alt"></i>
                    Schedule a Ride
                </div>
                
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="schedulePickup" placeholder="Pickup location">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="schedulePickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="scheduleDestination" placeholder="Destination">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="scheduleDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Enhanced For Someone Else -->
                <div class="form-group">
                    <label class="checkbox-container">
                        <input type="checkbox" id="scheduleForSomeone">
                        <span class="checkbox-custom"></span>
                        <span style="margin-left: 8px;">Booking for someone else</span>
                    </label>
                </div>
                
                <div class="form-group" id="someoneElseDetails" style="display: none;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="recipientName" placeholder="Recipient name">
                        <input type="tel" class="form-control" id="recipientPhone" placeholder="Recipient phone">
                    </div>
                </div>
                
                <div class="schedule-grid">
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-control" id="scheduleDate" min="">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Time</label>
                        <input type="time" class="form-control" id="scheduleTime">
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary hover-effect" id="confirmScheduleBtn">
                        <i class="fas fa-calendar-check"></i>
                        Schedule Ride
                    </button>
                    <button class="btn btn-secondary hover-effect" id="cancelScheduleBtn">
                        Cancel
                    </button>
                </div>
            </div>
            
            <!-- Enhanced Order for Someone Else Form -->
            <div class="service-form someone-else-form" id="someoneElseForm">
                <div class="form-title">
                    <i class="fas fa-user-friends"></i>
                    Order for Someone Else
                </div>
                
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="someonePickup" placeholder="Pickup location">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="someonePickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="someoneDestination" placeholder="Destination">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="someoneDestinationSuggestions"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Recipient Details</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="someoneName" placeholder="Full name">
                        <input type="tel" class="form-control" id="someonePhone" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Special Instructions (Optional)</label>
                    <textarea class="form-control form-textarea" id="someoneInstructions" placeholder="Any instructions for the driver..."></textarea>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary hover-effect" id="requestSomeoneRideBtn">
                        <i class="fas fa-car"></i>
                        Request Ride
                    </button>
                </div>
            </div>
            
            <!-- Enhanced Ride Sharing Form -->
            <div class="service-form share-ride-form" id="shareRideForm">
                <div class="form-title">
                    <i class="fas fa-share-alt"></i>
                    Share Ride
                </div>
                
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="sharePickup" placeholder="Pickup location">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="sharePickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="shareDestination" placeholder="Destination">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shareDestinationSuggestions"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Friend's Referral Code</label>
                    <input type="text" class="form-control" id="friendReferralCode" placeholder="Enter friend's Jubel referral code">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Split Fare</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select class="form-control" id="splitPercentage" style="flex: 1;">
                            <option value="50">50/50 Split</option>
                            <option value="60">You pay 60%</option>
                            <option value="70">You pay 70%</option>
                            <option value="80">You pay 80%</option>
                            <option value="100">You pay full</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Estimated Fare: <span id="shareFareEstimate">ZMW 0.00</span></label>
                    <div class="price-calculation">
                        <div class="calculation-row">
                            <span>Your Share:</span>
                            <span id="yourShare">ZMW 0.00</span>
                        </div>
                        <div class="calculation-row">
                            <span>Friend's Share:</span>
                            <span id="friendShare">ZMW 0.00</span>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary hover-effect" id="requestShareRideBtn">
                        <i class="fas fa-user-friends"></i>
                        Share Ride
                    </button>
                </div>
            </div>
            
            <!-- Enhanced Broadcast Ride Form -->
            <div class="service-form broadcast-form" id="broadcastForm">
                <div class="form-title">
                    <i class="fas fa-broadcast-tower"></i>
                    Broadcast Ride
                </div>
                
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="broadcastPickup" placeholder="Pickup location" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="broadcastPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="broadcastDestination" placeholder="Destination">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="broadcastDestinationSuggestions"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Recipient Phone Numbers</label>
                    <div class="broadcast-input-container">
                        <input type="text" class="broadcast-input" id="broadcastPhoneInput" placeholder="Enter phone number">
                        <button class="broadcast-button" id="addBroadcastPhone">
                            <i class="fas fa-plus"></i>
                            Add
                        </button>
                    </div>
                    <div class="broadcast-recipients-list" id="broadcastRecipientsList">
                        <!-- Recipients will be added here -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Message (Optional)</label>
                    <textarea class="form-control form-textarea" id="broadcastMessage" placeholder="Add a message for recipients..."></textarea>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary hover-effect" id="broadcastRideRequestBtn">
                        <i class="fas fa-broadcast-tower"></i>
                        Broadcast Ride
                    </button>
                </div>
            </div>
            
            <!-- Enhanced More Options -->
            <div class="more-options" id="moreOptions">
                <div class="form-title">
                    <i class="fas fa-ellipsis-h"></i>
                    More Options
                </div>
                
                <div class="options-grid">
                    <button class="option-btn hover-effect" data-option="sos">
                        <div class="option-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="option-name">SOS Setup</div>
                    </button>
                    
                    <button class="option-btn hover-effect" data-option="transfer">
                        <div class="option-icon">
                            <i class="fas fa-exchange-alt"></i>
                        </div>
                        <div class="option-name">Transfer Money</div>
                    </button>
                    
                    <button class="option-btn hover-effect" data-option="settings">
                        <div class="option-icon">
                            <i class="fas fa-cog"></i>
                        </div>
                        <div class="option-name">Settings</div>
                    </button>
                    
                    <button class="option-btn hover-effect" data-option="help">
                        <div class="option-icon">
                            <i class="fas fa-question-circle"></i>
                        </div>
                        <div class="option-name">Help</div>
                    </button>
                </div>
                
                <div class="action-buttons" style="margin-top: 16px;">
                    <button class="btn btn-secondary hover-effect" id="closeOptionsBtn">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Enhanced History Screen -->
    <div class="history-screen" id="historyScreen">
        <div class="screen-header">
            <button class="back-btn hover-effect" data-screen="home">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="screen-title">Ride History</div>
        </div>
        
        <div class="history-filters">
            <button class="filter-btn active hover-effect" data-filter="all">All</button>
            <button class="filter-btn hover-effect" data-filter="completed">Completed</button>
            <button class="filter-btn hover-effect" data-filter="cancelled">Cancelled</button>
            <button class="filter-btn hover-effect" data-filter="scheduled">Scheduled</button>
            <button class="filter-btn hover-effect" data-filter="emergency">Emergency</button>
            <button class="filter-btn hover-effect" data-filter="delivery">Delivery</button>
            <button class="filter-btn hover-effect" data-filter="truck">Truck</button>
            <button class="filter-btn hover-effect" data-filter="shared">Shared</button>
        </div>
        
        <div class="history-list" id="historyList">
            <!-- History items will be inserted here -->
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="fas fa-history"></i>
                </div>
                <div class="empty-title">No ride history yet</div>
                <div class="empty-message">Your completed and scheduled rides will appear here</div>
            </div>
        </div>
    </div>
    
    <!-- Enhanced Account Screen -->
    <div class="account-screen" id="accountScreen">
        <div class="screen-header">
            <button class="back-btn hover-effect" data-screen="home">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="screen-title">My Account</div>
        </div>
        
        <div class="account-header">
            <div class="account-avatar" id="accountAvatar">
                <i class="fas fa-user"></i>
            </div>
            <div class="account-name" id="accountName">Loading...</div>
            <div class="account-phone" id="accountPhone">Loading...</div>
        </div>
        
        <div class="account-stats">
            <div class="stat-card">
                <div class="stat-value" id="completedRides">0</div>
                <div class="stat-label">Completed Rides</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="cancelledRides">0</div>
                <div class="stat-label">Cancelled Rides</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalSpent">ZMW 0</div>
                <div class="stat-label">Total Spent</div>
            </div>
        </div>
        
        <div class="account-section">
            <div class="section-title">
                <i class="fas fa-wallet"></i>
                Wallet Balance
            </div>
            
            <div class="wallet-balance">
                <div class="balance-label">Available Balance</div>
                <div class="balance-amount-large" id="accountBalance">ZMW 0.00</div>
            </div>
            
            <div class="wallet-actions">
                <button class="btn-wallet hover-effect" id="depositBtn">
                    <i class="fas fa-plus"></i>
                    Deposit
                </button>
                <button class="btn-wallet hover-effect" id="withdrawBtn">
                    <i class="fas fa-minus"></i>
                    Withdraw
                </button>
                <button class="btn-wallet hover-effect" id="transferBtn">
                    <i class="fas fa-exchange-alt"></i>
                    Transfer
                </button>
                <button class="btn-wallet hover-effect" id="transactionsBtn">
                    <i class="fas fa-history"></i>
                    History
                </button>
            </div>
        </div>
        
        <div class="account-section">
            <div class="section-title">
                <i class="fas fa-gift"></i>
                Referral Program
            </div>
            
            <div class="referral-card">
                <div>Share your referral code and earn ZMW 25 for each friend's first ride</div>
                <div class="referral-code" id="referralCode">JUBEL-XXXX</div>
                <button class="btn btn-primary hover-effect" id="shareReferralBtn">
                    <i class="fas fa-share"></i>
                    Share Code
                </button>
                <div class="referral-note">Your friend gets 50% off their first ride</div>
            </div>
        </div>
        
        <div class="account-section">
            <div class="section-title">
                <i class="fas fa-cog"></i>
                Settings
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-secondary hover-effect" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </button>
            </div>
        </div>
    </div>
    
    <!-- Enhanced Emergency Screen -->
    <div class="emergency-screen" id="emergencyScreen">
        <div class="screen-header">
            <button class="back-btn hover-effect" data-screen="home">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="screen-title">Emergency Services</div>
        </div>
        
        <div class="emergency-services">
            <div class="emergency-service police hover-effect" data-type="police">
                <div class="emergency-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <div class="emergency-name">Police Ride</div>
                <div class="emergency-description">Emergency transport with police escort</div>
            </div>
            
            <div class="emergency-service fire hover-effect" data-type="fire">
                <div class="emergency-icon">
                    <i class="fas fa-fire-extinguisher"></i>
                </div>
                <div class="emergency-name">Fire Brigade</div>
                <div class="emergency-description">Fire emergency response team</div>
            </div>
            
            <div class="emergency-service medical hover-effect" data-type="medical">
                <div class="emergency-icon">
                    <i class="fas fa-ambulance"></i>
                </div>
                <div class="emergency-name">Hospital Ride</div>
                <div class="emergency-description">Medical emergency transport</div>
            </div>
            
            <div class="emergency-service hover-effect" data-type="sos">
                <div class="emergency-icon" style="background: var(--error-red);">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="emergency-name">SOS Emergency</div>
                <div class="emergency-description">Immediate emergency assistance</div>
            </div>
        </div>
        
        <div class="emergency-note">
            <p><strong>Important:</strong> Only use emergency services for genuine emergencies. Misuse may result in penalties. In case of immediate danger, call 911 first.</p>
        </div>
    </div>
    
    <!-- Enhanced Modals -->
    
    <!-- Enhanced Payment Modal -->
    <div class="modal-overlay" id="paymentModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-credit-card"></i>
                    Select Payment Method
                </div>
                <button class="modal-close hover-effect" data-modal="payment">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <div class="form-label">Available Balance: <span id="paymentBalance">ZMW 0.00</span></div>
                    <div class="form-label">Total Amount: <span id="paymentAmount">ZMW 0.00</span></div>
                </div>
                
                <div class="payment-methods">
                    <div class="payment-method hover-effect" data-payment="wallet">
                        <div class="payment-icon">
                            <i class="fas fa-wallet"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Jubel Wallet</div>
                            <div class="payment-info">Pay with your wallet balance</div>
                        </div>
                    </div>
                    
                    <div class="payment-method hover-effect" data-payment="mobile">
                        <div class="payment-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Mobile Money</div>
                            <div class="payment-info">Pay via MTN/Zamtel/Airtel</div>
                        </div>
                    </div>
                    
                    <div class="payment-method hover-effect" data-payment="cash">
                        <div class="payment-icon">
                            <i class="fas fa-money-bill"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Cash</div>
                            <div class="payment-info">Pay driver directly</div>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary hover-effect" id="confirmPaymentBtn">
                        <i class="fas fa-check"></i>
                        Confirm Payment
                    </button>
                    <button class="btn btn-secondary hover-effect" data-modal="payment">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Enhanced Cancel Ride Modal -->
    <div class="modal-overlay" id="cancelModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-times-circle"></i>
                    Cancel Ride
                </div>
                <button class="modal-close hover-effect" data-modal="cancel">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <div class="form-label">Please select a reason for cancellation:</div>
                </div>
                
                <div class="cancel-reasons">
                    <div class="cancel-reason hover-effect" data-reason="driver_late">
                        <div class="reason-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="reason-text">Driver is taking too long</div>
                    </div>
                    
                    <div class="cancel-reason hover-effect" data-reason="change_plans">
                        <div class="reason-icon">
                            <i class="fas fa-calendar-times"></i>
                        </div>
                        <div class="reason-text">Change of plans</div>
                    </div>
                    
                    <div class="cancel-reason hover-effect" data-reason="found_alternative">
                        <div class="reason-icon">
                            <i class="fas fa-car"></i>
                        </div>
                        <div class="reason-text">Found alternative transport</div>
                    </div>
                    
                    <div class="cancel-reason hover-effect" data-reason="emergency">
                        <div class="reason-icon">
                            <i class="fas fa-exclamation"></i>
                        </div>
                        <div class="reason-text">Emergency situation</div>
                    </div>
                    
                    <div class="cancel-reason hover-effect" data-reason="other">
                        <div class="reason-icon">
                            <i class="fas fa-ellipsis-h"></i>
                        </div>
                        <div class="reason-text">Other reason</div>
                    </div>
                </div>
                
                <div class="form-group" id="otherReasonGroup" style="display: none;">
                    <label class="form-label">Please specify:</label>
                    <textarea class="form-control form-textarea" id="otherReason" placeholder="Enter your reason here..."></textarea>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-danger hover-effect" id="confirmCancelBtn">
                        <i class="fas fa-times"></i>
                        Cancel Ride
                    </button>
                    <button class="btn btn-secondary hover-effect" data-modal="cancel">
                        Go Back
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Enhanced Emergency Ride Modal -->
    <div class="modal-overlay emergency-reasons-modal" id="emergencyModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-ambulance"></i>
                    Emergency Ride Details
                </div>
                <button class="modal-close hover-effect" data-modal="emergency">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <div class="form-label">Select Emergency Type:</div>
                    <div class="emergency-reasons-grid" id="emergencyReasonsGrid">
                        <div class="emergency-reason-card hover-effect" data-reason="accident">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-car-crash"></i>
                            </div>
                            <div class="emergency-reason-text">Accident</div>
                        </div>
                        <div class="emergency-reason-card hover-effect" data-reason="medical">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-heartbeat"></i>
                            </div>
                            <div class="emergency-reason-text">Medical Emergency</div>
                        </div>
                        <div class="emergency-reason-card hover-effect" data-reason="crime">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="emergency-reason-text">Crime in Progress</div>
                        </div>
                        <div class="emergency-reason-card hover-effect" data-reason="fire">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-fire"></i>
                            </div>
                            <div class="emergency-reason-text">Fire Emergency</div>
                        </div>
                        <div class="emergency-reason-card hover-effect" data-reason="other">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-ellipsis-h"></i>
                            </div>
                            <div class="emergency-reason-text">Other Emergency</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group" id="otherEmergencyReasonGroup" style="display: none;">
                    <label class="form-label">Please describe the emergency:</label>
                    <textarea class="form-control form-textarea" id="otherEmergencyReason" placeholder="Describe the emergency situation..."></textarea>
                </div>
                
                <div class="form-group">
                    <div class="form-label" id="emergencyServiceType">Police Ride</div>
                    <div class="price-calculation">
                        <div class="calculation-row">
                            <span>Base Emergency Fare:</span>
                            <span id="emergencyBaseFare">ZMW 100.00</span>
                        </div>
                        <div class="calculation-row">
                            <span>Distance to Service:</span>
                            <span id="emergencyDistance">0 km</span>
                        </div>
                        <div class="calculation-row">
                            <span>Estimated Time:</span>
                            <span id="emergencyTime">5 min</span>
                        </div>
                        <div class="calculation-row">
                            <span>Total Fare:</span>
                            <span id="emergencyTotalFare">ZMW 100.00</span>
                        </div>
                    </div>
                </div>
                
                <div class="emergency-services-list" id="emergencyServicesList">
                    <!-- Emergency services will be inserted here -->
                </div>
                
                <div class="emergency-location-details">
                    <div class="emergency-location-title">
                        <i class="fas fa-map-marker-alt"></i>
                        Your Current Location
                    </div>
                    <div class="emergency-location-address" id="emergencyCurrentLocation">
                        Detecting your location...
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-danger hover-effect" id="confirmEmergencyBtn">
                        <i class="fas fa-exclamation-triangle"></i>
                        Request Emergency Ride
                    </button>
                    <button class="btn btn-secondary hover-effect" data-modal="emergency">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Enhanced SOS Setup Modal -->
    <div class="modal-overlay sos-config-modal" id="sosModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    SOS Emergency Setup
                </div>
                <button class="modal-close hover-effect" data-modal="sos">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <label class="form-label">Primary Emergency Contact</label>
                    <div class="sos-contact-grid">
                        <input type="text" class="form-control" id="sosContact1Name" placeholder="Contact name">
                        <input type="tel" class="form-control" id="sosContact1Phone" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Secondary Emergency Contact (Optional)</label>
                    <div class="sos-contact-grid">
                        <input type="text" class="form-control" id="sosContact2Name" placeholder="Contact name">
                        <input type="tel" class="form-control" id="sosContact2Phone" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Emergency Message</label>
                    <textarea class="form-control form-textarea" id="sosMessage">
I need help! My current location and ride details will be shared with you.
                    </textarea>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary hover-effect" id="saveSOSBtn">
                        <i class="fas fa-save"></i>
                        Save SOS Setup
                    </button>
                    <button class="btn btn-secondary hover-effect sos-test-button" id="testSOSBtn">
                        <i class="fas fa-bell"></i>
                        Test SOS
                    </button>
                    <button class="btn btn-secondary hover-effect" data-modal="sos">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Enhanced Transfer Money Modal -->
    <div class="modal-overlay" id="transferModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-exchange-alt"></i>
                    Transfer Money
                </div>
                <button class="modal-close hover-effect" data-modal="transfer">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <div class="form-label">Available Balance: <span id="transferBalance">ZMW 0.00</span></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Recipient's Referral Code</label>
                    <input type="text" class="form-control" id="recipientCode" placeholder="Enter recipient's Jubel referral code">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Amount (ZMW)</label>
                    <input type="number" class="form-control" id="transferAmount" placeholder="Enter amount" min="1" step="0.01">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Message (Optional)</label>
                    <input type="text" class="form-control" id="transferMessage" placeholder="Add a message">
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary hover-effect" id="confirmTransferBtn">
                        <i class="fas fa-paper-plane"></i>
                        Send Money
                    </button>
                    <button class="btn btn-secondary hover-effect" data-modal="transfer">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Enhanced Wallet Transactions Modal -->
    <div class="modal-overlay" id="transactionsModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-history"></i>
                    Wallet Transactions
                </div>
                <button class="modal-close hover-effect" data-modal="transactions">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div id="transactionsList">
                    <!-- Transactions will be inserted here -->
                    <div class="empty-state" style="padding: 30px 0;">
                        <div class="empty-icon">
                            <i class="fas fa-receipt"></i>
                        </div>
                        <div class="empty-title">No transactions yet</div>
                        <div class="empty-message">Your wallet transactions will appear here</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Enhanced Broadcast Ride Modal -->
    <div class="modal-overlay broadcast-ride-modal" id="broadcastModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-broadcast-tower"></i>
                    Broadcast Ride
                </div>
                <button class="modal-close hover-effect" data-modal="broadcast">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <label class="form-label">Enter Recipient Phone Numbers</label>
                    <div class="broadcast-input-container">
                        <input type="text" class="broadcast-input" id="broadcastRecipientPhone" placeholder="Enter phone number">
                        <button class="broadcast-button" id="addBroadcastRecipient">
                            <i class="fas fa-plus"></i>
                            Add
                        </button>
                    </div>
                </div>
                
                <div class="broadcast-recipients-list" id="broadcastRecipientsListModal">
                    <!-- Recipients will be inserted here -->
                </div>
                
                <div class="form-group">
                    <label class="form-label">Ride Details</label>
                    <div class="location-inputs">
                        <div class="location-input">
                            <i class="fas fa-map-marker-alt"></i>
                            <input type="text" id="broadcastModalPickup" placeholder="Pickup location" readonly>
                        </div>
                        <div class="location-input">
                            <i class="fas fa-flag"></i>
                            <input type="text" id="broadcastModalDestination" placeholder="Destination">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Message to Recipients</label>
                    <textarea class="form-control form-textarea" id="broadcastModalMessage" placeholder="Join my ride! I'm going to..."></textarea>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary hover-effect" id="confirmBroadcastBtn">
                        <i class="fas fa-broadcast-tower"></i>
                        Broadcast Ride
                    </button>
                    <button class="btn btn-secondary hover-effect" data-modal="broadcast">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Enhanced Loading Overlay -->
    <div class="loading-overlay-enhanced" id="loadingOverlay">
        <div class="loading-spinner-enhanced"></div>
        <div class="loading-text-enhanced" id="loadingText">Loading...</div>
        <div class="loading-dots">
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
        </div>
    </div>
    
    <!-- Enhanced Toast Container -->
    <div class="toast-container-enhanced" id="toastContainer"></div>
    
    <!-- Network Status Indicator -->
    <div class="network-status" id="networkStatus"></div>
    
    <!-- Live Tracking Container -->
    <div class="live-tracking-container" id="liveTrackingContainer">
        <div class="live-indicator"></div>
        <div class="tracking-info">
            <div class="tracking-title">Live Tracking</div>
            <div class="tracking-distance" id="trackingDistance">0.5 km away</div>
        </div>
        <button class="tracking-close" id="trackingClose">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <!-- Map Controls -->
    <div class="map-controls">
        <button class="map-control-button hover-effect" id="locateMeBtn" title="Locate Me">
            <i class="fas fa-location-arrow"></i>
        </button>
        <button class="map-control-button hover-effect" id="fullscreenMapBtn" title="Fullscreen Map">
            <i class="fas fa-expand"></i>
        </button>
        <button class="map-control-button hover-effect" id="toggleTrafficBtn" title="Toggle Traffic">
            <i class="fas fa-traffic-light"></i>
        </button>
    </div>
    
    <!-- Firebase and Enhanced Libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-messaging.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.heat@0.2.0/dist/leaflet-heat.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.fullscreen@2.0.0/dist/Leaflet.fullscreen.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-control-geocoder@1.13.0/dist/Control.Geocoder.min.js"></script>
    
    <script>
        // ============================================
        // ENHANCED FIREBASE CONFIGURATION WITH FALLBACKS
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyDEACX_P4c5q7djJAcA0I7Lk7leO2TlQ74",
            authDomain: "jubel-13e1a.firebaseapp.com",
            databaseURL: "https://jubel-13e1a-default-rtdb.firebaseio.com",
            projectId: "jubel-13e1a",
            storageBucket: "jubel-13e1a.firebasestorage.app",
            messagingSenderId: "882241095445",
            appId: "1:882241095445:web:ee9ca40fddd008ca910b1c",
            measurementId: "G-J5JPKL6B5F"
        };

        // Initialize Firebase with error handling
        let firebaseApp;
        let database;
        let auth;
        let messaging;
        
        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            auth = firebase.auth();
            messaging = firebase.messaging.isSupported() ? firebase.messaging() : null;
            
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.error('Firebase initialization error:', error);
            showError('Firebase initialization failed. Please refresh the page.');
        }

        // ============================================
        // ENHANCED APP STATE MANAGEMENT WITH PERSISTENCE
        // ============================================
        const AppState = {
            currentUser: null,
            userData: null,
            currentRide: null,
            activeScreen: 'home',
            activeService: 'car',
            walletBalance: 0,
            userLocation: null,
            currentCity: null,
            detectedCity: null,
            selectedRideType: 'standard',
            selectedVehicle: null,
            destination: null,
            pickup: null,
            rideFare: 0,
            driverLocation: null,
            chatMessages: [],
            scheduledRides: [],
            emergencyMode: false,
            sosConfig: null,
            searchCache: new Map(),
            lastSearchTime: 0,
            notifications: [],
            broadcastRecipients: [],
            liveTracking: false,
            networkStatus: 'online',
            rideTypes: {
                economy: { 
                    base: 15, 
                    perKm: 2.5, 
                    multiplier: 0.8, 
                    min: 10, 
                    icon: 'fa-car-side',
                    description: 'Affordable rides for everyday trips'
                },
                standard: { 
                    base: 20, 
                    perKm: 3.0, 
                    multiplier: 1.0, 
                    min: 15, 
                    icon: 'fa-car',
                    description: 'Comfortable rides with reliable drivers'
                },
                premium: { 
                    base: 30, 
                    perKm: 4.0, 
                    multiplier: 1.5, 
                    min: 25, 
                    icon: 'fa-crown',
                    description: 'Premium vehicles with top-rated drivers'
                }
            },
            emergencyServices: {
                police: { 
                    base: 150, 
                    perKm: 5.0, 
                    multiplier: 2.0, 
                    min: 100,
                    icon: 'fa-shield-alt',
                    description: 'Police escorted emergency transport'
                },
                fire: { 
                    base: 200, 
                    perKm: 6.0, 
                    multiplier: 2.5, 
                    min: 150,
                    icon: 'fa-fire-extinguisher',
                    description: 'Fire emergency response team'
                },
                medical: { 
                    base: 180, 
                    perKm: 5.5, 
                    multiplier: 2.2, 
                    min: 120,
                    icon: 'fa-ambulance',
                    description: 'Medical emergency transport'
                }
            },
            deliveryTypes: {
                standard: { 
                    base: 25, 
                    perKm: 2.0, 
                    multiplier: 1.0,
                    timeframe: '24-48 hours'
                },
                express: { 
                    base: 40, 
                    perKm: 3.0, 
                    multiplier: 1.5,
                    timeframe: '4-6 hours'
                },
                sameDay: { 
                    base: 60, 
                    perKm: 4.0, 
                    multiplier: 2.0,
                    timeframe: '2-4 hours'
                }
            },
            truckTypes: {
                pickup: { 
                    base: 80, 
                    perKm: 5.0, 
                    multiplier: 1.0, 
                    capacity: '1.5 tons',
                    icon: 'fa-truck-pickup'
                },
                light: { 
                    base: 120, 
                    perKm: 6.0, 
                    multiplier: 1.2, 
                    capacity: '3 tons',
                    icon: 'fa-truck-moving'
                },
                medium: { 
                    base: 200, 
                    perKm: 8.0, 
                    multiplier: 1.5, 
                    capacity: '7 tons',
                    icon: 'fa-truck'
                },
                heavy: { 
                    base: 350, 
                    perKm: 12.0, 
                    multiplier: 2.0, 
                    capacity: '15 tons',
                    icon: 'fa-truck-loading'
                }
            },
            broadcastStatuses: {
                pending: 'Pending',
                accepted: 'Accepted',
                declined: 'Declined',
                expired: 'Expired'
            },
            // Local storage keys for persistence
            storageKeys: {
            userData: 'jubel_user_data',
            sosConfig: 'jubel_sos_config',
            searchHistory: 'jubel_search_history',
            favorites: 'jubel_favorites',
            settings: 'jubel_settings'
            },
            // Performance metrics
            performance: {
                searchResponseTime: 0,
                geocodeResponseTime: 0,
                mapLoadTime: 0,
                appStartTime: Date.now()
            },
            // Real-time tracking
            realtime: {
                driverTrackingInterval: null,
                locationUpdateInterval: null,
                batterySaver: false,
                lastLocationUpdate: 0
            }
        };

        // ============================================
        // ENHANCED SEARCH ENGINE WITH CACHING AND PRIORITIZATION
        // ============================================
        const SearchEngine = {
            cache: new Map(),
            lastSearch: 0,
            debounceTimer: null,
            searchHistory: [],
            maxSearchHistory: 20,
            currentCityBounds: null,
            
            // Initialize search engine with user's city
            initialize: async function(userLocation) {
                if (userLocation) {
                    await this.setCityBounds(userLocation);
                }
                this.loadSearchHistory();
            },
            
            // Set city bounds for search limiting
            setCityBounds: async function(location) {
                try {
                    const response = await fetch(
                        `https://nominatim.openstreetmap.org/reverse?format=json&lat=${location.lat}&lon=${location.lng}&zoom=10`
                    );
                    const data = await response.json();
                    
                    if (data && data.address) {
                        const city = data.address.city || data.address.town || data.address.village;
                        if (city) {
                            AppState.detectedCity = city;
                            AppState.currentCity = city;
                            
                            // Get city bounds from Nominatim
                            const searchResponse = await fetch(
                                `https://nominatim.openstreetmap.org/search?city=${encodeURIComponent(city)}&country=Zambia&format=json&limit=1`
                            );
                            const searchData = await searchResponse.json();
                            
                            if (searchData && searchData[0]) {
                                const bounds = searchData[0].boundingbox;
                                this.currentCityBounds = [
                                    parseFloat(bounds[0]),
                                    parseFloat(bounds[2]),
                                    parseFloat(bounds[1]),
                                    parseFloat(bounds[3])
                                ];
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error setting city bounds:', error);
                }
            },
            
            // Enhanced search function with city restriction
            search: async function(query, type = 'destination', location = null, options = {}) {
                const startTime = Date.now();
                const cacheKey = `${query}-${type}-${location ? `${location.lat},${location.lng}` : 'none'}`;
                
                // Return cached results if available and recent (5 minutes)
                if (this.cache.has(cacheKey)) {
                    const cached = this.cache.get(cacheKey);
                    if (Date.now() - cached.timestamp < 300000) {
                        this.recordSearchTime(Date.now() - startTime);
                        return cached.results;
                    }
                }
                
                try {
                    // Show loading state
                    this.showSearchLoading(true);
                    
                    const searchUrl = this.buildSearchUrl(query, location, options);
                    const response = await fetch(searchUrl);
                    
                    if (!response.ok) throw new Error(`Search failed: ${response.status}`);
                    
                    const data = await response.json();
                    const results = this.processResults(data, location, options);
                    
                    // Cache the results
                    this.cache.set(cacheKey, {
                        results: results,
                        timestamp: Date.now()
                    });
                    
                    // Add to search history
                    this.addToSearchHistory(query, results.length > 0 ? results[0] : null);
                    
                    this.recordSearchTime(Date.now() - startTime);
                    return results;
                } catch (error) {
                    console.error('Search error:', error);
                    this.showSearchError(error.message);
                    return [];
                } finally {
                    this.showSearchLoading(false);
                }
            },
            
            // Build enhanced search URL with city restriction
            buildSearchUrl: function(query, location, options = {}) {
                const params = new URLSearchParams({
                    q: `${query}, ${AppState.currentCity}, Zambia`,
                    format: 'json',
                    limit: options.limit || 15,
                    countrycodes: 'zm',
                    'accept-language': 'en',
                    addressdetails: 1,
                    namedetails: 1,
                    polygon: 0,
                    bounded: this.currentCityBounds ? 1 : 0
                });
                
                if (this.currentCityBounds) {
                    params.append('viewbox', this.currentCityBounds.join(','));
                }
                
                if (options.priority) {
                    params.append('dedupe', 1);
                    params.append('layer', options.priority);
                }
                
                return `https://nominatim.openstreetmap.org/search?${params}`;
            },
            
            // Process results with enhanced filtering and ranking
            processResults: function(data, location, options = {}) {
                const now = Date.now();
                const results = data.map(place => {
                    const distance = location ? this.calculateDistance(
                        location.lat, location.lng,
                        parseFloat(place.lat), parseFloat(place.lon)
                    ) : 0;
                    
                    const importance = place.importance || 0;
                    const typePriority = this.getTypePriority(place.type || place.class);
                    
                    // Calculate relevance score
                    const relevanceScore = this.calculateRelevanceScore(
                        distance,
                        importance,
                        typePriority,
                        options.priority
                    );
                    
                    return {
                        id: place.place_id,
                        name: place.display_name.split(',')[0],
                        address: this.formatAddress(place),
                        fullAddress: place.display_name,
                        lat: parseFloat(place.lat),
                        lng: parseFloat(place.lon),
                        type: place.type || place.class,
                        category: place.category || 'other',
                        importance: importance,
                        distance: distance,
                        relevanceScore: relevanceScore,
                        timestamp: now
                    };
                });
                
                // Sort by relevance score (higher is better)
                return results.sort((a, b) => b.relevanceScore - a.relevanceScore);
            },
            
            // Calculate relevance score for ranking
            calculateRelevanceScore: function(distance, importance, typePriority, searchPriority) {
                let score = 0;
                
                // Distance factor (closer is better)
                if (distance > 0) {
                    score += (100 / Math.max(distance, 0.1)) * 0.4;
                }
                
                // Importance factor (from OSM)
                score += importance * 0.3;
                
                // Type priority factor
                score += typePriority * 0.2;
                
                // Search priority factor
                if (searchPriority) {
                    score += 0.1;
                }
                
                return score;
            },
            
            getTypePriority: function(type) {
                const priorities = {
                    'amenity': 1.0,
                    'shop': 0.9,
                    'tourism': 0.8,
                    'leisure': 0.7,
                    'historic': 0.6,
                    'natural': 0.5,
                    'waterway': 0.4,
                    'landuse': 0.3,
                    'place': 0.2,
                    'other': 0.1
                };
                return priorities[type] || 0.1;
            },
            
            formatAddress: function(place) {
                const address = place.address || {};
                const parts = [];
                
                // Add house number if available
                if (address.house_number || address.housenumber) {
                    parts.push(address.house_number || address.housenumber);
                }
                
                // Add road/street
                if (address.road) {
                    parts.push(address.road);
                }
                
                // Add suburb/neighbourhood
                if (address.suburb || address.neighbourhood) {
                    parts.push(address.suburb || address.neighbourhood);
                }
                
                // Add city/town
                if (address.city || address.town) {
                    parts.push(address.city || address.town);
                }
                
                // If we have a meaningful address, return it
                if (parts.length > 0) {
                    return parts.join(', ');
                }
                
                // Fallback to display name
                return place.display_name.split(',').slice(0, 3).join(',');
            },
            
            calculateDistance: function(lat1, lon1, lat2, lon2) {
                const R = 6371; // Earth's radius in km
                const dLat = this.toRad(lat2 - lat1);
                const dLon = this.toRad(lon2 - lon1);
                const a = 
                    Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(this.toRad(lat1)) * Math.cos(this.toRad(lat2)) * 
                    Math.sin(dLon/2) * Math.sin(dLon/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            },
            
            toRad: function(value) {
                return value * Math.PI / 180;
            },
            
            // Search history management
            loadSearchHistory: function() {
                try {
                    const saved = localStorage.getItem(AppState.storageKeys.searchHistory);
                    if (saved) {
                        this.searchHistory = JSON.parse(saved);
                    }
                } catch (error) {
                    console.error('Error loading search history:', error);
                }
            },
            
            saveSearchHistory: function() {
                try {
                    localStorage.setItem(
                        AppState.storageKeys.searchHistory,
                        JSON.stringify(this.searchHistory.slice(0, this.maxSearchHistory))
                    );
                } catch (error) {
                    console.error('Error saving search history:', error);
                }
            },
            
            addToSearchHistory: function(query, result) {
                const entry = {
                    query: query,
                    result: result,
                    timestamp: Date.now(),
                    count: 1
                };
                
                const existingIndex = this.searchHistory.findIndex(item => 
                    item.query.toLowerCase() === query.toLowerCase()
                );
                
                if (existingIndex >= 0) {
                    // Update existing entry
                    this.searchHistory[existingIndex].count++;
                    this.searchHistory[existingIndex].timestamp = Date.now();
                    if (result) {
                        this.searchHistory[existingIndex].result = result;
                    }
                    // Move to front
                    const [existing] = this.searchHistory.splice(existingIndex, 1);
                    this.searchHistory.unshift(existing);
                } else {
                    // Add new entry
                    this.searchHistory.unshift(entry);
                    
                    // Keep history within limits
                    if (this.searchHistory.length > this.maxSearchHistory) {
                        this.searchHistory.pop();
                    }
                }
                
                this.saveSearchHistory();
            },
            
            getSearchSuggestions: function(query) {
                if (!query || query.length < 1) {
                    return this.searchHistory.slice(0, 5);
                }
                
                const lowerQuery = query.toLowerCase();
                return this.searchHistory
                    .filter(item => item.query.toLowerCase().includes(lowerQuery))
                    .slice(0, 5);
            },
            
            clearCache: function() {
                this.cache.clear();
            },
            
            clearHistory: function() {
                this.searchHistory = [];
                this.saveSearchHistory();
            },
            
            // Performance tracking
            recordSearchTime: function(time) {
                AppState.performance.searchResponseTime = time;
            },
            
            // UI helpers
            showSearchLoading: function(show) {
                // Implement loading state UI
            },
            
            showSearchError: function(error) {
                console.error('Search error:', error);
                // Implement error UI
            }
        };

        // ============================================
        // ENHANCED EMERGENCY LOCATOR WITH REAL-TIME DATA
        // ============================================
        const EmergencyLocator = {
            services: {
                police: [],
                fire: [],
                medical: []
            },
            loaded: false,
            currentCityServices: null,
            
            // Initialize with current city
            initialize: async function(city) {
                if (!city) return;
                
                try {
                    // Load emergency services for the current city
                    await this.loadCityServices(city);
                    this.loaded = true;
                } catch (error) {
                    console.error('Error initializing emergency locator:', error);
                    // Load default services as fallback
                    this.loadDefaultServices(city);
                }
            },
            
            // Load emergency services for specific city
            loadCityServices: async function(city) {
                try {
                    // Query Overpass API for emergency services in the city
                    const overpassQuery = `
                        [out:json][timeout:30];
                        area["name"="${city}"]["admin_level"=8]->.searchArea;
                        (
                            node["amenity"="police"](area.searchArea);
                            node["amenity"="fire_station"](area.searchArea);
                            node["amenity"="hospital"](area.searchArea);
                            node["amenity"="clinic"](area.searchArea);
                        );
                        out body;
                        >;
                        out skel qt;
                    `;
                    
                    const response = await fetch('https://overpass-api.de/api/interpreter', {
                        method: 'POST',
                        body: overpassQuery
                    });
                    
                    if (!response.ok) throw new Error('Overpass API error');
                    
                    const data = await response.json();
                    
                    // Process the results
                    this.processOverpassData(data, city);
                    
                    // Store in Firebase for future reference
                    this.saveToFirebase(city);
                    
                } catch (error) {
                    console.error('Error loading city services:', error);
                    throw error;
                }
            },
            
            // Process Overpass API data
            processOverpassData: function(data, city) {
                this.services.police = [];
                this.services.fire = [];
                this.services.medical = [];
                
                data.elements.forEach(element => {
                    if (element.tags) {
                        const service = {
                            id: element.id,
                            lat: element.lat,
                            lng: element.lon,
                            name: element.tags.name || `${element.tags.amenity} Service`,
                            type: element.tags.amenity,
                            address: this.extractAddress(element.tags),
                            phone: element.tags.phone || '',
                            timestamp: Date.now()
                        };
                        
                        switch(element.tags.amenity) {
                            case 'police':
                                this.services.police.push(service);
                                break;
                            case 'fire_station':
                                this.services.fire.push(service);
                                break;
                            case 'hospital':
                            case 'clinic':
                                this.services.medical.push(service);
                                break;
                        }
                    }
                });
                
                // Sort by name
                this.sortServices();
                
                // Store for current city
                this.currentCityServices = {
                    city: city,
                    timestamp: Date.now(),
                    services: this.services
                };
            },
            
            // Extract address from OSM tags
            extractAddress: function(tags) {
                const parts = [];
                if (tags['addr:housenumber']) parts.push(tags['addr:housenumber']);
                if (tags['addr:street']) parts.push(tags['addr:street']);
                if (tags['addr:suburb']) parts.push(tags['addr:suburb']);
                if (tags['addr:city']) parts.push(tags['addr:city']);
                return parts.join(', ') || 'Address not specified';
            },
            
            // Load default services as fallback
            loadDefaultServices: function(city) {
                // Default coordinates for common Zambian cities
                const cityDefaults = {
                    'Lusaka': {
                        police: [
                            { name: 'Lusaka Central Police', lat: -15.4167, lng: 28.2833 },
                            { name: 'Kabulonga Police Station', lat: -15.4000, lng: 28.3000 },
                            { name: 'Woodlands Police Station', lat: -15.3900, lng: 28.3200 }
                        ],
                        fire: [
                            { name: 'Lusaka Fire Brigade', lat: -15.4100, lng: 28.2900 },
                            { name: 'Industrial Fire Station', lat: -15.4200, lng: 28.2700 }
                        ],
                        medical: [
                            { name: 'University Teaching Hospital', lat: -15.4050, lng: 28.2950 },
                            { name: 'Levy Mwanawasa Hospital', lat: -15.3950, lng: 28.3050 },
                            { name: 'Matero Hospital', lat: -15.4150, lng: 28.2750 }
                        ]
                    },
                    'Ndola': {
                        police: [
                            { name: 'Ndola Central Police', lat: -12.9667, lng: 28.6333 }
                        ],
                        fire: [
                            { name: 'Ndola Fire Station', lat: -12.9700, lng: 28.6400 }
                        ],
                        medical: [
                            { name: 'Ndola Central Hospital', lat: -12.9600, lng: 28.6300 }
                        ]
                    }
                };
                
                const defaults = cityDefaults[city] || cityDefaults['Lusaka'];
                
                this.services.police = defaults.police.map(s => ({
                    ...s,
                    type: 'police',
                    address: `${s.name}, ${city}`,
                    phone: ''
                }));
                
                this.services.fire = defaults.fire.map(s => ({
                    ...s,
                    type: 'fire',
                    address: `${s.name}, ${city}`,
                    phone: ''
                }));
                
                this.services.medical = defaults.medical.map(s => ({
                    ...s,
                    type: 'medical',
                    address: `${s.name}, ${city}`,
                    phone: ''
                }));
                
                this.currentCityServices = {
                    city: city,
                    timestamp: Date.now(),
                    services: this.services
                };
            },
            
            // Save services to Firebase
            saveToFirebase: async function(city) {
                try {
                    if (!database) return;
                    
                    await database.ref(`emergencyServices/${city.replace(/\s+/g, '_')}`).set({
                        city: city,
                        services: this.services,
                        lastUpdated: Date.now(),
                        source: 'overpass'
                    });
                } catch (error) {
                    console.error('Error saving to Firebase:', error);
                }
            },
            
            // Load from Firebase cache
            loadFromFirebase: async function(city) {
                try {
                    if (!database) return false;
                    
                    const snapshot = await database.ref(`emergencyServices/${city.replace(/\s+/g, '_')}`).once('value');
                    const data = snapshot.val();
                    
                    if (data && data.services) {
                        this.services = data.services;
                        this.currentCityServices = {
                            city: city,
                            timestamp: data.lastUpdated,
                            services: data.services
                        };
                        return true;
                    }
                } catch (error) {
                    console.error('Error loading from Firebase:', error);
                }
                return false;
            },
            
            // Find nearest service
            findNearestService: function(type, userLocation) {
                const services = this.services[type];
                if (!services || !userLocation) return null;
                
                let nearest = null;
                let minDistance = Infinity;
                
                services.forEach(service => {
                    const distance = SearchEngine.calculateDistance(
                        userLocation.lat, userLocation.lng,
                        service.lat, service.lng
                    );
                    
                    if (distance < minDistance) {
                        minDistance = distance;
                        nearest = { ...service, distance };
                    }
                });
                
                return nearest;
            },
            
            // Find all services sorted by distance
            findAllServices: function(type, userLocation, limit = 10) {
                const services = this.services[type];
                if (!services || !userLocation) return [];
                
                return services
                    .map(service => ({
                        ...service,
                        distance: SearchEngine.calculateDistance(
                            userLocation.lat, userLocation.lng,
                            service.lat, service.lng
                        )
                    }))
                    .sort((a, b) => a.distance - b.distance)
                    .slice(0, limit);
            },
            
            // Show emergency markers on map
            showEmergencyMarkers: function(type) {
                // Clear existing emergency markers
                if (window.emergencyMarkers) {
                    window.emergencyMarkers.forEach(marker => map.removeLayer(marker));
                }
                
                window.emergencyMarkers = [];
                const services = this.services[type];
                
                if (services && map) {
                    services.forEach(service => {
                        const iconClass = type === 'police' ? 'police-marker' : 
                                         type === 'fire' ? 'fire-marker' : 'medical-marker';
                        
                        const marker = L.marker([service.lat, service.lng], {
                            icon: L.divIcon({
                                className: 'emergency-vehicle-marker-enhanced ' + iconClass,
                                html: `<i class="fas fa-${type === 'police' ? 'shield-alt' : type === 'fire' ? 'fire-extinguisher' : 'ambulance'}"></i>`,
                                iconSize: [40, 40]
                            })
                        }).addTo(map).bindPopup(`
                            <strong>${service.name}</strong><br>
                            ${service.address}<br>
                            ${service.phone ? `Phone: ${service.phone}<br>` : ''}
                            Distance: ${service.distance ? service.distance.toFixed(1) + ' km' : 'Calculating...'}
                        `);
                        
                        window.emergencyMarkers.push(marker);
                    });
                    
                    // Fit bounds to show all markers
                    if (services.length > 0) {
                        const bounds = L.latLngBounds(services.map(s => [s.lat, s.lng]));
                        map.fitBounds(bounds, { padding: [50, 50] });
                    }
                }
            },
            
            // Sort services alphabetically
            sortServices: function() {
                const sortByName = (a, b) => a.name.localeCompare(b.name);
                this.services.police.sort(sortByName);
                this.services.fire.sort(sortByName);
                this.services.medical.sort(sortByName);
            },
            
            // Get service count
            getServiceCount: function() {
                return {
                    police: this.services.police.length,
                    fire: this.services.fire.length,
                    medical: this.services.medical.length,
                    total: this.services.police.length + this.services.fire.length + this.services.medical.length
                };
            }
        };

        // ============================================
        // ENHANCED PRICE CALCULATOR WITH REAL-TIME FACTORS
        // ============================================
        const PriceCalculator = {
            // Base rates (in ZMW)
            baseRates: {
                economy: 15,
                standard: 20,
                premium: 30,
                emergency: {
                    police: 150,
                    fire: 200,
                    medical: 180
                },
                delivery: {
                    standard: 25,
                    express: 40,
                    sameDay: 60
                },
                truck: {
                    pickup: 80,
                    light: 120,
                    medium: 200,
                    heavy: 350
                },
                shopping: 30
            },
            
            // Per kilometer rates
            perKmRates: {
                economy: 2.5,
                standard: 3.0,
                premium: 4.0,
                emergency: {
                    police: 5.0,
                    fire: 6.0,
                    medical: 5.5
                },
                delivery: {
                    standard: 2.0,
                    express: 3.0,
                    sameDay: 4.0
                },
                truck: {
                    pickup: 5.0,
                    light: 6.0,
                    medium: 8.0,
                    heavy: 12.0
                },
                shopping: 2.5
            },
            
            // Multipliers for different service types
            multipliers: {
                economy: 0.8,
                standard: 1.0,
                premium: 1.5,
                emergency: {
                    police: 2.0,
                    fire: 2.5,
                    medical: 2.2
                },
                delivery: {
                    standard: 1.0,
                    express: 1.5,
                    sameDay: 2.0
                },
                truck: {
                    pickup: 1.0,
                    light: 1.2,
                    medium: 1.5,
                    heavy: 2.0
                },
                shopping: 1.0
            },
            
            // Minimum fares
            minimumFares: {
                economy: 10,
                standard: 15,
                premium: 25,
                emergency: {
                    police: 100,
                    fire: 150,
                    medical: 120
                },
                delivery: {
                    standard: 20,
                    express: 30,
                    sameDay: 50
                },
                truck: {
                    pickup: 60,
                    light: 80,
                    medium: 150,
                    heavy: 250
                },
                shopping: 25
            },
            
            // Calculate ride fare with enhanced factors
            calculateRideFare: function(distanceKm, rideType = 'standard', options = {}) {
                const surge = this.getSurgeMultiplier(options.time, options.location);
                const trafficFactor = this.getTrafficFactor(options.time, options.location);
                const weatherFactor = this.getWeatherFactor();
                const demandFactor = this.getDemandFactor(options.location);
                
                const config = AppState.rideTypes[rideType] || AppState.rideTypes.standard;
                
                // Base calculation
                let fare = config.base + (distanceKm * config.perKm);
                
                // Apply ride type multiplier
                fare *= config.multiplier;
                
                // Apply dynamic factors
                fare *= surge;
                fare *= trafficFactor;
                fare *= weatherFactor;
                fare *= demandFactor;
                
                // Apply additional charges
                if (options.extraStops) {
                    fare += options.extraStops * 5; // ZMW 5 per extra stop
                }
                
                if (options.largeParty) {
                    fare *= 1.2; // 20% extra for large parties
                }
                
                if (options.extraLuggage) {
                    fare += options.extraLuggage * 3; // ZMW 3 per extra luggage
                }
                
                // Ensure minimum fare
                fare = Math.max(fare, config.min);
                
                // Round to nearest 0.50
                fare = Math.ceil(fare * 2) / 2;
                
                return {
                    baseFare: config.base,
                    distanceFare: distanceKm * config.perKm,
                    surgeMultiplier: surge,
                    trafficFactor: trafficFactor,
                    weatherFactor: weatherFactor,
                    demandFactor: demandFactor,
                    total: parseFloat(fare.toFixed(2))
                };
            },
            
            // Calculate emergency fare
            calculateEmergencyFare: function(distanceKm, serviceType, options = {}) {
                const config = AppState.emergencyServices[serviceType] || AppState.emergencyServices.police;
                const priorityMultiplier = options.priority === 'high' ? 1.5 : 1.0;
                
                let fare = config.base + (distanceKm * config.perKm);
                fare *= config.multiplier;
                fare *= priorityMultiplier;
                fare = Math.max(fare, config.min);
                
                return parseFloat(fare.toFixed(2));
            },
            
            // Calculate delivery fare
            calculateDeliveryFare: function(distanceKm, deliveryType = 'standard', options = {}) {
                const config = AppState.deliveryTypes[deliveryType] || AppState.deliveryTypes.standard;
                
                let fare = config.base + (distanceKm * config.perKm);
                fare *= config.multiplier;
                
                // Add insurance for valuable parcels (1% of parcel value)
                if (options.parcelValue && options.parcelValue > 500) {
                    fare += options.parcelValue * 0.01;
                }
                
                // Add fragile item surcharge
                if (options.fragile) {
                    fare += 10;
                }
                
                // Add heavy item surcharge
                if (options.weight && options.weight > 10) {
                    fare += (options.weight - 10) * 0.5;
                }
                
                return parseFloat(fare.toFixed(2));
            },
            
            // Calculate truck fare
            calculateTruckFare: function(distanceKm, truckType = 'light', options = {}) {
                const config = AppState.truckTypes[truckType] || AppState.truckTypes.light;
                
                let fare = config.base + (distanceKm * config.perKm);
                fare *= config.multiplier;
                
                // Add helper cost if needed
                if (options.helpers) {
                    fare += 50;
                }
                
                // Add fuel surcharge for long distances
                if (distanceKm > 50) {
                    fare += distanceKm * 0.1;
                }
                
                // Add toll fees if applicable
                if (options.tolls) {
                    fare += options.tolls;
                }
                
                return parseFloat(fare.toFixed(2));
            },
            
            // Calculate shopping fare
            calculateShoppingFare: function(distanceKm, options = {}) {
                // Base fare + distance + item count
                let fare = 30 + (distanceKm * 2.5) + (options.itemsCount || 1 * 5);
                
                // Add 5% of budget for shopping service
                if (options.budget && options.budget > 0) {
                    fare += options.budget * 0.05;
                }
                
                // Add waiting time charge
                if (options.waitingTime && options.waitingTime > 15) {
                    fare += Math.floor((options.waitingTime - 15) / 5) * 2;
                }
                
                return parseFloat(fare.toFixed(2));
            },
            
            // Calculate surge multiplier based on time and location
            getSurgeMultiplier: function(time, location) {
                const now = time || new Date();
                const hour = now.getHours();
                let surge = 1.0;
                
                // Time-based surge
                if (hour >= 7 && hour <= 9) surge = 1.3; // Morning rush
                if (hour >= 16 && hour <= 19) surge = 1.5; // Evening rush
                if (hour >= 22 || hour <= 5) surge = 1.8; // Late night
                
                // Location-based surge (simulated)
                if (location) {
                    // In a real app, this would check demand in specific areas
                    const highDemandAreas = ['CBD', 'Mall', 'Airport', 'Stadium'];
                    const locationName = location.name || '';
                    
                    if (highDemandAreas.some(area => locationName.includes(area))) {
                        surge *= 1.2;
                    }
                }
                
                // Special events/surges
                surge = this.applySpecialEvents(surge);
                
                return Math.min(surge, 3.0); // Cap at 3x
            },
            
            // Get traffic factor
            getTrafficFactor: function(time, location) {
                // In a real app, this would integrate with traffic data
                const now = time || new Date();
                const hour = now.getHours();
                const day = now.getDay();
                
                let factor = 1.0;
                
                // Peak hours
                if ((hour >= 7 && hour <= 9) || (hour >= 16 && hour <= 19)) {
                    factor = 1.3;
                }
                
                // Weekends
                if (day === 0 || day === 6) {
                    factor *= 1.1;
                }
                
                return factor;
            },
            
            // Get weather factor
            getWeatherFactor: function() {
                // In a real app, this would integrate with weather data
                // Simulating weather impact
                const weatherConditions = ['clear', 'rain', 'storm', 'fog'];
                const condition = weatherConditions[Math.floor(Math.random() * weatherConditions.length)];
                
                switch(condition) {
                    case 'rain': return 1.1;
                    case 'storm': return 1.3;
                    case 'fog': return 1.2;
                    default: return 1.0;
                }
            },
            
            // Get demand factor
            getDemandFactor: function(location) {
                // In a real app, this would use real-time demand data
                // Simulating demand based on time and location
                let factor = 1.0;
                
                // High demand during events
                const events = this.checkNearbyEvents(location);
                if (events.length > 0) {
                    factor = 1.2;
                }
                
                return factor;
            },
            
            // Apply special events
            applySpecialEvents: function(baseSurge) {
                const specialEvents = {
                    'New Year': 2.0,
                    'Christmas': 1.8,
                    'Easter': 1.5,
                    'Independence Day': 1.6
                };
                
                const today = new Date();
                const events = Object.entries(specialEvents);
                
                for (const [event, multiplier] of events) {
                    if (this.isEventToday(event, today)) {
                        return baseSurge * multiplier;
                    }
                }
                
                return baseSurge;
            },
            
            // Check if event is today
            isEventToday: function(event, date) {
                // Simplified event checking
                const eventDates = {
                    'New Year': '01-01',
                    'Christmas': '12-25',
                    'Easter': this.calculateEaster(date.getFullYear()),
                    'Independence Day': '10-24'
                };
                
                const today = `${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                return eventDates[event] === today;
            },
            
            // Calculate Easter date (simplified)
            calculateEaster: function(year) {
                // Simplified calculation
                return '04-07'; // Approximation
            },
            
            // Check nearby events
            checkNearbyEvents: function(location) {
                // In a real app, this would query an events database
                return [];
            },
            
            // Calculate distance
            calculateDistance: function(lat1, lon1, lat2, lon2) {
                return SearchEngine.calculateDistance(lat1, lon1, lat2, lon2);
            },
            
            // Estimate time
            estimateTime: function(distanceKm, rideType = 'standard', options = {}) {
                const baseSpeed = rideType === 'premium' ? 40 : 30; // km/h
                const trafficFactor = this.getTrafficFactor();
                const weatherFactor = this.getWeatherFactor();
                
                let baseTime = (distanceKm / baseSpeed) * 60; // minutes
                
                // Apply factors
                baseTime *= trafficFactor;
                baseTime *= weatherFactor;
                
                // Add pickup time
                baseTime += options.pickupTime || 5;
                
                // Add dropoff time
                baseTime += options.dropoffTime || 3;
                
                return Math.ceil(baseTime);
            },
            
            // Generate fare breakdown
            generateFareBreakdown: function(fareCalculation) {
                return {
                    baseFare: fareCalculation.baseFare,
                    distanceFare: fareCalculation.distanceFare,
                    surgeMultiplier: fareCalculation.surgeMultiplier,
                    trafficFactor: fareCalculation.trafficFactor,
                    weatherFactor: fareCalculation.weatherFactor,
                    demandFactor: fareCalculation.demandFactor,
                    subtotal: fareCalculation.baseFare + fareCalculation.distanceFare,
                    adjustments: [
                        {
                            name: 'Surge Pricing',
                            amount: (fareCalculation.surgeMultiplier - 1) * (fareCalculation.baseFare + fareCalculation.distanceFare)
                        },
                        {
                            name: 'Traffic Surcharge',
                            amount: (fareCalculation.trafficFactor - 1) * (fareCalculation.baseFare + fareCalculation.distanceFare)
                        }
                    ],
                    total: fareCalculation.total
                };
            }
        };

        // ============================================
        // ENHANCED UI UPDATER WITH REAL-TIME UPDATES
        // ============================================
        const UIUpdater = {
            // Update wallet balance with animation
            updateWalletBalance: function(balance) {
                const formatted = `ZMW ${balance.toFixed(2)}`;
                
                // Animate balance update
                const elements = [
                    document.getElementById('walletBalance'),
                    document.getElementById('accountBalance'),
                    document.getElementById('paymentBalance'),
                    document.getElementById('transferBalance')
                ];
                
                elements.forEach(element => {
                    if (element) {
                        const oldValue = parseFloat(element.textContent.replace('ZMW ', '') || 0);
                        const newValue = balance;
                        
                        if (oldValue !== newValue) {
                            // Add animation class
                            element.classList.add('balance-update');
                            
                            // Update value
                            element.textContent = formatted;
                            
                            // Remove animation class after animation completes
                            setTimeout(() => {
                                element.classList.remove('balance-update');
                            }, 500);
                            
                            // Show notification for significant changes
                            if (Math.abs(newValue - oldValue) > 10) {
                                this.showToast(
                                    `Wallet balance ${newValue > oldValue ? 'increased' : 'decreased'} by ZMW ${Math.abs(newValue - oldValue).toFixed(2)}`,
                                    newValue > oldValue ? 'success' : 'info'
                                );
                            }
                        }
                    }
                });
                
                AppState.walletBalance = balance;
            },
            
            // Show enhanced toast notification
            showToast: function(message, type = 'info', duration = 5000, options = {}) {
                const toastContainer = document.getElementById('toastContainer');
                const toastId = 'toast-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                
                const icons = {
                    success: 'fa-check-circle',
                    error: 'fa-exclamation-circle',
                    warning: 'fa-exclamation-triangle',
                    info: 'fa-info-circle'
                };
                
                const titles = {
                    success: 'Success',
                    error: 'Error',
                    warning: 'Warning',
                    info: 'Information'
                };
                
                const toast = document.createElement('div');
                toast.className = `toast-enhanced ${type}`;
                toast.id = toastId;
                toast.setAttribute('role', 'alert');
                toast.setAttribute('aria-live', 'assertive');
                toast.setAttribute('aria-atomic', 'true');
                
                toast.innerHTML = `
                    <div class="toast-icon-enhanced">
                        <i class="fas ${icons[type] || icons.info}"></i>
                    </div>
                    <div class="toast-content-enhanced">
                        <div class="toast-title-enhanced">
                            <span>${titles[type] || 'Notification'}</span>
                            ${options.action ? `
                            <button class="toast-action" onclick="${options.action.onclick}">
                                ${options.action.text}
                            </button>
                            ` : ''}
                        </div>
                        <div class="toast-message-enhanced">${message}</div>
                    </div>
                    <button class="toast-close-enhanced" onclick="UIUpdater.removeToast('${toastId}')" aria-label="Close notification">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                toastContainer.appendChild(toast);
                
                // Auto-remove after duration
                const removeTimer = setTimeout(() => {
                    this.removeToast(toastId);
                }, duration);
                
                // Store timer reference for manual removal
                toast.removeTimer = removeTimer;
                
                // Add click to dismiss
                toast.addEventListener('click', (e) => {
                    if (!e.target.closest('.toast-action')) {
                        this.removeToast(toastId);
                    }
                });
                
                // Announce to screen readers
                this.announceToScreenReader(message);
                
                return toastId;
            },
            
            // Remove toast with animation
            removeToast: function(toastId) {
                const toast = document.getElementById(toastId);
                if (toast) {
                    clearTimeout(toast.removeTimer);
                    toast.classList.add('hiding');
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, 300);
                }
            },
            
            // Announce message to screen readers
            announceToScreenReader: function(message) {
                const ariaLive = document.getElementById('aria-live-region') || (() => {
                    const region = document.createElement('div');
                    region.id = 'aria-live-region';
                    region.className = 'sr-only';
                    region.setAttribute('aria-live', 'polite');
                    region.setAttribute('aria-atomic', 'true');
                    document.body.appendChild(region);
                    return region;
                })();
                
                ariaLive.textContent = message;
                
                // Clear after announcement
                setTimeout(() => {
                    ariaLive.textContent = '';
                }, 1000);
            },
            
            // Show enhanced loading overlay
            showLoading: function(message = 'Loading...', options = {}) {
                const overlay = document.getElementById('loadingOverlay');
                const text = document.getElementById('loadingText');
                
                text.textContent = message;
                overlay.classList.add('active');
                
                // Set loading options
                if (options.progress) {
                    this.setLoadingProgress(options.progress);
                }
                
                if (options.cancelable) {
                    this.addLoadingCancelButton(options.onCancel);
                }
            },
            
            // Hide loading overlay
            hideLoading: function() {
                const overlay = document.getElementById('loadingOverlay');
                overlay.classList.remove('active');
                
                // Reset progress
                this.setLoadingProgress(0);
                
                // Remove cancel button if exists
                const cancelBtn = overlay.querySelector('.loading-cancel-btn');
                if (cancelBtn) {
                    cancelBtn.remove();
                }
            },
            
            // Set loading progress
            setLoadingProgress: function(progress) {
                const overlay = document.getElementById('loadingOverlay');
                let progressBar = overlay.querySelector('.loading-progress');
                
                if (!progressBar) {
                    progressBar = document.createElement('div');
                    progressBar.className = 'loading-progress';
                    progressBar.innerHTML = `
                        <div class="progress-bar">
                            <div class="progress-fill"></div>
                        </div>
                    `;
                    overlay.querySelector('.loading-text-enhanced').after(progressBar);
                }
                
                const progressFill = progressBar.querySelector('.progress-fill');
                progressFill.style.width = `${Math.min(100, Math.max(0, progress))}%`;
            },
            
            // Add cancel button to loading overlay
            addLoadingCancelButton: function(onCancel) {
                const overlay = document.getElementById('loadingOverlay');
                let cancelBtn = overlay.querySelector('.loading-cancel-btn');
                
                if (!cancelBtn) {
                    cancelBtn = document.createElement('button');
                    cancelBtn.className = 'loading-cancel-btn';
                    cancelBtn.innerHTML = '<i class="fas fa-times"></i> Cancel';
                    cancelBtn.onclick = onCancel;
                    overlay.appendChild(cancelBtn);
                }
            },
            
            // Update ride prices with real-time calculation
            updateRidePrices: function(distanceKm, options = {}) {
                const types = ['economy', 'standard', 'premium'];
                const surge = PriceCalculator.getSurgeMultiplier(options.time, options.location);
                
                types.forEach(type => {
                    const calculation = PriceCalculator.calculateRideFare(distanceKm, type, {
                        ...options,
                        surge: surge
                    });
                    
                    const priceElement = document.getElementById(`${type}Price`);
                    if (priceElement) {
                        // Animate price change
                        const oldPrice = parseFloat(priceElement.textContent.replace('ZMW ', '') || 0);
                        const newPrice = calculation.total;
                        
                        priceElement.textContent = `ZMW ${newPrice.toFixed(2)}`;
                        
                        if (oldPrice !== 0 && oldPrice !== newPrice) {
                            priceElement.classList.add('price-update');
                            setTimeout(() => {
                                priceElement.classList.remove('price-update');
                            }, 500);
                        }
                    }
                });
                
                // Update estimated fare display
                const selectedCalculation = PriceCalculator.calculateRideFare(
                    distanceKm, 
                    AppState.selectedRideType, 
                    { ...options, surge: surge }
                );
                
                const fareElement = document.getElementById('estimatedFare');
                if (fareElement) {
                    fareElement.textContent = `ZMW ${selectedCalculation.total.toFixed(2)}`;
                }
                
                // Update distance and time
                const time = PriceCalculator.estimateTime(distanceKm, AppState.selectedRideType, options);
                const distanceElement = document.getElementById('distanceDetail');
                const timeElement = document.getElementById('timeDetail');
                
                if (distanceElement) {
                    distanceElement.textContent = `${distanceKm.toFixed(1)} km`;
                }
                if (timeElement) {
                    timeElement.textContent = `ETA: ${time} min`;
                }
                
                AppState.rideFare = selectedCalculation.total;
                
                // Show surge indicator if surge > 1.2
                if (surge > 1.2) {
                    this.showSurgeIndicator(surge);
                }
            },
            
            // Show surge pricing indicator
            showSurgeIndicator: function(surgeMultiplier) {
                const existingIndicator = document.querySelector('.surge-pricing-indicator');
                if (existingIndicator) {
                    existingIndicator.remove();
                }
                
                const surgeText = surgeMultiplier >= 2.0 ? 'High' : 
                                surgeMultiplier >= 1.5 ? 'Moderate' : 'Low';
                
                const indicator = document.createElement('div');
                indicator.className = 'surge-pricing-indicator';
                indicator.innerHTML = `
                    <div class="surge-icon">
                        <i class="fas fa-bolt"></i>
                    </div>
                    <div class="surge-content">
                        <div class="surge-title">${surgeText} Demand</div>
                        <div class="surge-message">
                            Prices are <span class="surge-multiplier">${surgeMultiplier.toFixed(1)}x</span> higher due to high demand in your area
                        </div>
                    </div>
                `;
                
                const fareDisplay = document.getElementById('fareDisplay');
                if (fareDisplay) {
                    fareDisplay.parentNode.insertBefore(indicator, fareDisplay.nextSibling);
                    
                    // Auto-remove after 10 seconds
                    setTimeout(() => {
                        if (indicator.parentNode) {
                            indicator.remove();
                        }
                    }, 10000);
                }
            },
            
            // Show search suggestions with enhanced UI
            showSearchSuggestions: function(inputId, results) {
                const container = document.getElementById(`${inputId}Suggestions`);
                if (!container) return;
                
                container.innerHTML = '';
                
                if (results.length === 0) {
                    // Show recent searches if available
                    const recentSearches = SearchEngine.getSearchSuggestions('');
                    if (recentSearches.length > 0) {
                        container.innerHTML = `
                            <div class="suggestion-header">
                                <i class="fas fa-history"></i>
                                Recent Searches
                            </div>
                            ${recentSearches.map(item => `
                                <div class="suggestion-item recent-search" data-query="${item.query}">
                                    <div class="suggestion-icon">
                                        <i class="fas fa-history"></i>
                                    </div>
                                    <div class="suggestion-details">
                                        <div class="suggestion-name">${item.query}</div>
                                        <div class="suggestion-address">Searched ${this.formatTimeAgo(item.timestamp)}</div>
                                    </div>
                                </div>
                            `).join('')}
                        `;
                    } else {
                        container.innerHTML = `
                            <div class="no-results">
                                <i class="fas fa-search"></i>
                                <div class="no-results-title">No results found</div>
                                <div class="no-results-message">
                                    Try searching for a specific place, address, or landmark
                                </div>
                            </div>
                        `;
                    }
                } else {
                    // Group results by type/category
                    const groupedResults = this.groupSearchResults(results);
                    
                    let html = '';
                    
                    // Add current location option
                    if (AppState.userLocation && inputId.includes('destination')) {
                        html += `
                            <div class="suggestion-item current-location-option" data-type="current">
                                <div class="suggestion-icon">
                                    <i class="fas fa-location-arrow"></i>
                                </div>
                                <div class="suggestion-details">
                                    <div class="suggestion-name">Current Location</div>
                                    <div class="suggestion-address">Use your current location</div>
                                </div>
                            </div>
                        `;
                    }
                    
                    // Add results by group
                    Object.entries(groupedResults).forEach(([group, items]) => {
                        if (items.length > 0) {
                            html += `
                                <div class="suggestion-group">
                                    <div class="suggestion-group-title">
                                        <i class="fas fa-${this.getGroupIcon(group)}"></i>
                                        ${this.getGroupName(group)}
                                    </div>
                                    ${items.slice(0, 5).map(result => `
                                        <div class="suggestion-item" 
                                             data-lat="${result.lat}" 
                                             data-lng="${result.lng}"
                                             data-address="${result.address}"
                                             data-name="${result.name}">
                                            <div class="suggestion-icon">
                                                <i class="fas fa-${this.getResultIcon(result)}"></i>
                                            </div>
                                            <div class="suggestion-details">
                                                <div class="suggestion-name">${result.name}</div>
                                                <div class="suggestion-address">${result.address}</div>
                                                ${result.distance ? `
                                                <div class="suggestion-distance">
                                                    <i class="fas fa-road"></i>
                                                    ${result.distance.toFixed(1)} km away
                                                </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            `;
                        }
                    });
                    
                    container.innerHTML = html;
                }
                
                container.classList.add('active');
                
                // Add click handlers
                container.querySelectorAll('.suggestion-item').forEach(item => {
                    item.addEventListener('click', () => {
                        this.selectSearchResult(inputId, item);
                    });
                });
            },
            
            // Group search results by category
            groupSearchResults: function(results) {
                const groups = {
                    landmarks: [],
                    addresses: [],
                    businesses: [],
                    other: []
                };
                
                results.forEach(result => {
                    if (result.category === 'tourism' || result.type === 'historic') {
                        groups.landmarks.push(result);
                    } else if (result.type === 'place' || result.category === 'boundary') {
                        groups.addresses.push(result);
                    } else if (result.category === 'shop' || result.type === 'amenity') {
                        groups.businesses.push(result);
                    } else {
                        groups.other.push(result);
                    }
                });
                
                return groups;
            },
            
            // Get group icon
            getGroupIcon: function(group) {
                const icons = {
                    landmarks: 'landmark',
                    addresses: 'map-marker-alt',
                    businesses: 'store',
                    other: 'map-pin'
                };
                return icons[group] || 'map-pin';
            },
            
            // Get group name
            getGroupName: function(group) {
                const names = {
                    landmarks: 'Landmarks & Places',
                    addresses: 'Addresses & Areas',
                    businesses: 'Businesses & Services',
                    other: 'Other Results'
                };
                return names[group] || 'Results';
            },
            
            // Get result icon
            getResultIcon: function(result) {
                const iconMap = {
                    'amenity': 'building',
                    'shop': 'store',
                    'tourism': 'landmark',
                    'leisure': 'tree',
                    'historic': 'monument',
                    'natural': 'mountain',
                    'waterway': 'water',
                    'place': 'map-marker-alt'
                };
                return iconMap[result.type] || 'map-pin';
            },
            
            // Select search result
            selectSearchResult: function(inputId, item) {
                const input = document.getElementById(inputId);
                const container = document.getElementById(`${inputId}Suggestions`);
                
                if (item.classList.contains('current-location-option')) {
                    // Use current location
                    if (AppState.userLocation) {
                        input.value = 'Current Location';
                        
                        if (inputId.includes('destination') || inputId.includes('Destination')) {
                            AppState.destination = {
                                ...AppState.userLocation,
                                name: 'Current Location',
                                address: 'Your current location'
                            };
                            this.updateDestinationMarker(AppState.destination);
                            this.calculateAndUpdatePrices();
                        }
                    }
                } else if (item.classList.contains('recent-search')) {
                    // Handle recent search selection
                    const query = item.dataset.query;
                    input.value = query;
                    
                    // Trigger new search
                    this.triggerSearch(inputId, query);
                } else {
                    // Handle regular search result
                    const lat = parseFloat(item.dataset.lat);
                    const lng = parseFloat(item.dataset.lng);
                    const address = item.dataset.address;
                    const name = item.dataset.name;
                    
                    input.value = address;
                    
                    // Update AppState based on input type
                    const location = {
                        lat: lat,
                        lng: lng,
                        address: address,
                        name: name
                    };
                    
                    if (inputId.includes('destination') || inputId.includes('Destination')) {
                        AppState.destination = location;
                        this.updateDestinationMarker(location);
                        this.calculateAndUpdatePrices();
                    } else if (inputId.includes('pickup') || inputId.includes('Pickup')) {
                        AppState.pickup = location;
                        this.updatePickupMarker(location);
                        this.calculateAndUpdatePrices();
                    }
                }
                
                if (container) {
                    container.classList.remove('active');
                }
                
                // Save to search history
                if (input.value.trim()) {
                    SearchEngine.addToSearchHistory(input.value.trim(), {
                        lat: AppState.destination?.lat || AppState.pickup?.lat,
                        lng: AppState.destination?.lng || AppState.pickup?.lng,
                        address: input.value,
                        name: item.dataset.name || input.value.split(',')[0]
                    });
                }
            },
            
            // Trigger search
            triggerSearch: async function(inputId, query) {
                const input = document.getElementById(inputId);
                const parent = input.closest('.location-input');
                
                if (parent) {
                    parent.classList.add('searching');
                }
                
                try {
                    const results = await SearchEngine.search(query, 'destination', AppState.userLocation);
                    this.showSearchSuggestions(inputId, results);
                } catch (error) {
                    console.error('Search error:', error);
                    this.showToast('Search failed. Please try again.', 'error');
                } finally {
                    if (parent) {
                        parent.classList.remove('searching');
                    }
                }
            },
            
            // Update pickup marker
            updatePickupMarker: function(location) {
                if (!map) return;
                
                if (window.pickupMarker) {
                    window.pickupMarker.setLatLng([location.lat, location.lng]);
                } else {
                    window.pickupMarker = L.marker([location.lat, location.lng], {
                        icon: L.divIcon({
                            className: 'pickup-marker',
                            html: '<i class="fas fa-map-marker-alt"></i>',
                            iconSize: [22, 22]
                        })
                    }).addTo(map).bindPopup(`
                        <strong>Pickup Location</strong><br>
                        ${location.address}
                    `);
                }
                
                if (AppState.destination) {
                    this.drawRoute(location, AppState.destination);
                }
                
                // Center map on pickup
                map.setView([location.lat, location.lng], 15);
            },
            
            // Update destination marker
            updateDestinationMarker: function(location) {
                if (!map) return;
                
                if (window.destinationMarker) {
                    window.destinationMarker.setLatLng([location.lat, location.lng]);
                } else {
                    window.destinationMarker = L.marker([location.lat, location.lng], {
                        icon: L.divIcon({
                            className: 'destination-marker',
                            html: '<i class="fas fa-flag"></i>',
                            iconSize: [22, 22]
                        })
                    }).addTo(map).bindPopup(`
                        <strong>Destination</strong><br>
                        ${location.address}
                    `);
                }
                
                if (AppState.pickup) {
                    this.drawRoute(AppState.pickup, location);
                }
            },
            
            // Draw route between points
            drawRoute: function(start, end) {
                if (!map) return;
                
                // Remove existing route
                if (window.routeLayer) {
                    map.removeLayer(window.routeLayer);
                }
                
                // Create new route
                window.routeLayer = L.Routing.control({
                    waypoints: [
                        L.latLng(start.lat, start.lng),
                        L.latLng(end.lat, end.lng)
                    ],
                    routeWhileDragging: false,
                    showAlternatives: false,
                    lineOptions: {
                        styles: [{
                            color: 'var(--map-route-color)',
                            weight: 4,
                            opacity: 0.8
                        }]
                    },
                    createMarker: function() { return null; }
                }).addTo(map);
                
                // Fit bounds to show entire route
                const bounds = L.latLngBounds(
                    [start.lat, start.lng],
                    [end.lat, end.lng]
                );
                map.fitBounds(bounds, { padding: [50, 50] });
                
                // Calculate distance
                const distance = PriceCalculator.calculateDistance(
                    start.lat, start.lng,
                    end.lat, end.lng
                );
                
                // Update prices
                this.updateRidePrices(distance, {
                    location: start
                });
            },
            
            // Calculate and update prices
            calculateAndUpdatePrices: function() {
                if (AppState.pickup && AppState.destination) {
                    const distance = PriceCalculator.calculateDistance(
                        AppState.pickup.lat, AppState.pickup.lng,
                        AppState.destination.lat, AppState.destination.lng
                    );
                    
                    // Update prices based on active service
                    switch(AppState.activeService) {
                        case 'car':
                            this.updateRidePrices(distance, {
                                location: AppState.pickup
                            });
                            document.getElementById('fareDisplay').classList.add('active');
                            break;
                        case 'delivery':
                            this.updateDeliveryPrices(distance);
                            break;
                        case 'truck':
                            this.updateTruckPrices(distance);
                            break;
                        case 'shopping':
                            this.updateShoppingPrices(distance);
                            break;
                    }
                }
            },
            
            // Update delivery prices
            updateDeliveryPrices: function(distanceKm) {
                const deliveryType = document.querySelector('#deliveryForm .filter-btn.active')?.id?.replace('Delivery', '').toLowerCase() || 'standard';
                const parcelValue = parseFloat(document.getElementById('parcelValue').value) || 0;
                
                const fare = PriceCalculator.calculateDeliveryFare(distanceKm, deliveryType, {
                    parcelValue: parcelValue,
                    fragile: document.getElementById('fragileItem')?.checked || false,
                    weight: parseFloat(document.getElementById('parcelWeight').value) || 0
                });
                
                const time = PriceCalculator.estimateTime(distanceKm, 'standard');
                
                // Update UI
                const fareElement = document.getElementById('deliveryFare');
                if (fareElement) {
                    fareElement.textContent = `ZMW ${fare.toFixed(2)}`;
                }
                
                return { fare, time };
            },
            
            // Update truck prices
            updateTruckPrices: function(distanceKm) {
                const truckType = document.querySelector('.truck-type.selected')?.dataset.type || 'light';
                const helpers = document.getElementById('needHelpers')?.checked || false;
                
                const fare = PriceCalculator.calculateTruckFare(distanceKm, truckType, {
                    helpers: helpers,
                    weight: parseFloat(document.getElementById('estimatedWeight').value) || 0,
                    tolls: 0 // Would be calculated based on route
                });
                
                const time = PriceCalculator.estimateTime(distanceKm, 'standard');
                
                return { fare, time };
            },
            
            // Update shopping prices
            updateShoppingPrices: function(distanceKm) {
                const itemsCount = document.querySelectorAll('.item-input').length;
                const budget = parseFloat(document.getElementById('shoppingBudget').value) || 0;
                
                const fare = PriceCalculator.calculateShoppingFare(distanceKm, {
                    itemsCount: itemsCount,
                    budget: budget,
                    waitingTime: 0 // Would be estimated
                });
                
                const time = PriceCalculator.estimateTime(distanceKm, 'standard') + 30; // Add shopping time
                
                return { fare, time };
            },
            
            // Show driver info with enhanced details
            showDriverInfo: function(driver) {
                const avatar = document.getElementById('driverAvatar');
                const name = document.getElementById('driverName');
                const rating = document.getElementById('driverRating');
                const statusIndicator = document.getElementById('driverStatusIndicator');
                const vehicleModel = document.getElementById('vehicleModel');
                const vehiclePlate = document.getElementById('vehiclePlate');
                const vehicleImage = document.getElementById('vehicleImageContainer');
                
                // Update avatar
                if (driver.photoUrl) {
                    avatar.innerHTML = `<img src="${driver.photoUrl}" alt="${driver.name}" onerror="this.style.display='none'; this.parentNode.innerHTML='<i class=\\'fas fa-user\\'></i>';">`;
                } else {
                    avatar.innerHTML = `<i class="fas fa-user"></i>`;
                }
                
                // Update name and rating
                name.textContent = driver.name || 'Driver';
                rating.textContent = driver.rating?.toFixed(1) || '4.8';
                
                // Update status indicator
                if (statusIndicator) {
                    statusIndicator.className = 'driver-status-indicator ' + (driver.status || 'online');
                }
                
                // Update vehicle details
                vehicleModel.textContent = driver.vehicle?.model || 'Vehicle';
                vehiclePlate.textContent = driver.vehicle?.plate || 'ABC 123';
                
                // Update vehicle image
                if (driver.vehicle?.imageUrl) {
                    vehicleImage.innerHTML = `<img src="${driver.vehicle.imageUrl}" alt="${driver.vehicle.model}" onerror="this.style.display='none'; this.parentNode.innerHTML='<i class=\\'fas fa-car\\'></i>';">`;
                } else {
                    vehicleImage.innerHTML = `<i class="fas fa-car"></i>`;
                }
                
                // Add driver marker to map
                if (driver.location) {
                    this.updateDriverMarker(driver.location);
                }
                
                // Start live tracking
                this.startLiveTracking(driver.location);
            },
            
            // Update driver marker
            updateDriverMarker: function(location) {
                if (!map) return;
                
                if (window.driverMarker) {
                    window.driverMarker.setLatLng([location.lat, location.lng]);
                } else {
                    window.driverMarker = L.marker([location.lat, location.lng], {
                        icon: L.divIcon({
                            className: 'driver-marker-enhanced',
                            html: '<i class="fas fa-car"></i>',
                            iconSize: [36, 36]
                        })
                    }).addTo(map).bindPopup(`
                        <strong>Your Driver</strong><br>
                        ${AppState.selectedVehicle?.name || 'Driver'} is on the way
                    `);
                }
                
                // Center map on driver if they're far from view
                const mapBounds = map.getBounds();
                const driverLatLng = L.latLng(location.lat, location.lng);
                
                if (!mapBounds.contains(driverLatLng)) {
                    map.setView([location.lat, location.lng], 15);
                }
            },
            
            // Start live tracking
            startLiveTracking: function(driverLocation) {
                if (!driverLocation) return;
                
                // Show live tracking container
                const trackingContainer = document.getElementById('liveTrackingContainer');
                trackingContainer.classList.add('active');
                
                // Calculate initial distance
                if (AppState.userLocation) {
                    const distance = PriceCalculator.calculateDistance(
                        AppState.userLocation.lat, AppState.userLocation.lng,
                        driverLocation.lat, driverLocation.lng
                    );
                    
                    document.getElementById('trackingDistance').textContent = `${distance.toFixed(1)} km away`;
                }
                
                // Start tracking updates
                if (AppState.realtime.driverTrackingInterval) {
                    clearInterval(AppState.realtime.driverTrackingInterval);
                }
                
                AppState.realtime.driverTrackingInterval = setInterval(() => {
                    this.updateLiveTracking();
                }, 10000); // Update every 10 seconds
            },
            
            // Update live tracking display
            updateLiveTracking: function() {
                if (!AppState.driverLocation || !AppState.userLocation) return;
                
                const distance = PriceCalculator.calculateDistance(
                    AppState.userLocation.lat, AppState.userLocation.lng,
                    AppState.driverLocation.lat, AppState.driverLocation.lng
                );
                
                document.getElementById('trackingDistance').textContent = `${distance.toFixed(1)} km away`;
                
                // Update driver marker position
                if (window.driverMarker) {
                    window.driverMarker.setLatLng([
                        AppState.driverLocation.lat,
                        AppState.driverLocation.lng
                    ]);
                }
            },
            
            // Stop live tracking
            stopLiveTracking: function() {
                const trackingContainer = document.getElementById('liveTrackingContainer');
                trackingContainer.classList.remove('active');
                
                if (AppState.realtime.driverTrackingInterval) {
                    clearInterval(AppState.realtime.driverTrackingInterval);
                    AppState.realtime.driverTrackingInterval = null;
                }
                
                // Remove driver marker
                if (window.driverMarker) {
                    map.removeLayer(window.driverMarker);
                    window.driverMarker = null;
                }
            },
            
            // Show chat message with enhanced features
            showChatMessage: function(message, isSender = false) {
                const container = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                
                messageDiv.className = `chat-message ${isSender ? 'sent' : 'received'}`;
                messageDiv.innerHTML = `
                    <div>${this.escapeHtml(message.text)}</div>
                    <div class="message-time-enhanced">
                        ${new Date(message.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                        ${isSender ? `<span class="message-status"><i class="fas fa-${message.status === 'delivered' ? 'check-double' : 'check'}"></i></span>` : ''}
                    </div>
                `;
                
                container.appendChild(messageDiv);
                container.scrollTop = container.scrollHeight;
                
                // Show chat notification if not open
                if (!isSender && !document.getElementById('chatContainer').classList.contains('active')) {
                    this.showChatNotification();
                }
                
                // Announce new message to screen reader
                if (!isSender) {
                    this.announceToScreenReader(`New message from driver: ${message.text}`);
                }
            },
            
            // Escape HTML to prevent XSS
            escapeHtml: function(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },
            
            // Show chat notification
            showChatNotification: function() {
                const chatBtn = document.getElementById('openChatBtn');
                if (chatBtn) {
                    let badge = chatBtn.querySelector('.chat-notification');
                    if (!badge) {
                        badge = document.createElement('div');
                        badge.className = 'chat-notification';
                        chatBtn.appendChild(badge);
                    }
                    
                    const currentCount = parseInt(badge.textContent) || 0;
                    badge.textContent = currentCount + 1;
                    badge.style.display = 'flex';
                    
                    // Animate the badge
                    badge.classList.add('bounce');
                    setTimeout(() => {
                        badge.classList.remove('bounce');
                    }, 500);
                }
            },
            
            // Clear chat notification
            clearChatNotification: function() {
                const chatBtn = document.getElementById('openChatBtn');
                if (chatBtn) {
                    const badge = chatBtn.querySelector('.chat-notification');
                    if (badge) {
                        badge.textContent = '0';
                        badge.style.display = 'none';
                    }
                }
            },
            
            // Update typing indicator
            updateTypingIndicator: function(isTyping) {
                const indicator = document.getElementById('chatTypingIndicator');
                if (indicator) {
                    if (isTyping) {
                        indicator.classList.add('active');
                    } else {
                        indicator.classList.remove('active');
                    }
                }
            },
            
            // Update history list with enhanced items
            updateHistoryList: function(rides) {
                const container = document.getElementById('historyList');
                container.innerHTML = '';
                
                if (rides.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">
                                <i class="fas fa-history"></i>
                            </div>
                            <div class="empty-title">No rides found</div>
                            <div class="empty-message">${AppState.activeFilter === 'all' ? 'You haven\'t taken any rides yet' : 'No rides match your filter'}</div>
                        </div>
                    `;
                    return;
                }
                
                rides.forEach(ride => {
                    const item = this.createHistoryItem(ride);
                    container.appendChild(item);
                });
            },
            
            // Create enhanced history item
            createHistoryItem: function(ride) {
                const item = document.createElement('div');
                item.className = 'history-item hover-effect';
                item.dataset.rideId = ride.id;
                
                const date = new Date(ride.timestamp);
                const {
                    typeIcon,
                    typeColor,
                    typeName
                } = this.getRideTypeInfo(ride);
                
                const statusClass = this.getStatusClass(ride.status);
                const statusText = this.getStatusText(ride.status);
                
                item.innerHTML = `
                    <div class="history-header">
                        <div class="history-type">
                            <div class="history-icon" style="background: ${typeColor}">
                                <i class="fas ${typeIcon}"></i>
                            </div>
                            <div class="history-type-name">
                                ${typeName}
                            </div>
                        </div>
                        <div class="history-date">
                            ${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                        </div>
                    </div>
                    
                    <div class="history-locations">
                        <div class="history-location">
                            <i class="fas fa-map-marker-alt" style="color: ${typeColor}"></i>
                            <div class="history-location-text">${ride.pickupDisplay || ride.pickup}</div>
                        </div>
                        <div class="history-location">
                            <i class="fas fa-flag" style="color: ${typeColor}"></i>
                            <div class="history-location-text">${ride.destinationDisplay || ride.destination}</div>
                        </div>
                    </div>
                    
                    <div class="history-footer">
                        <div class="history-price">ZMW ${ride.fare?.toFixed(2) || '0.00'}</div>
                        <div class="history-status ${statusClass}">
                            ${statusText}
                        </div>
                    </div>
                    
                    <div class="history-details">
                        ${this.createHistoryDetails(ride)}
                    </div>
                `;
                
                // Add click event to expand/collapse details
                item.addEventListener('click', (e) => {
                    if (!e.target.closest('.history-details') && !e.target.closest('.history-actions')) {
                        item.classList.toggle('expanded');
                    }
                });
                
                return item;
            },
            
            // Get ride type information
            getRideTypeInfo: function(ride) {
                if (ride.emergency) {
                    return {
                        typeIcon: 'fa-ambulance',
                        typeColor: 'var(--error-red)',
                        typeName: 'Emergency Ride'
                    };
                } else if (ride.scheduled) {
                    return {
                        typeIcon: 'fa-calendar-alt',
                        typeColor: 'var(--schedule-blue)',
                        typeName: 'Scheduled Ride'
                    };
                } else if (ride.serviceType === 'delivery') {
                    return {
                        typeIcon: 'fa-shipping-fast',
                        typeColor: 'var(--delivery-purple)',
                        typeName: 'Delivery'
                    };
                } else if (ride.serviceType === 'truck') {
                    return {
                        typeIcon: 'fa-truck',
                        typeColor: 'var(--light-truck-brown)',
                        typeName: 'Truck Delivery'
                    };
                } else if (ride.serviceType === 'shopping') {
                    return {
                        typeIcon: 'fa-shopping-bag',
                        typeColor: 'var(--express-shop-green)',
                        typeName: 'Express Shopping'
                    };
                } else if (ride.sharedRide) {
                    return {
                        typeIcon: 'fa-share-alt',
                        typeColor: 'var(--share-green)',
                        typeName: 'Shared Ride'
                    };
                } else {
                    return {
                        typeIcon: 'fa-car',
                        typeColor: 'var(--primary-orange)',
                        typeName: 'Standard Ride'
                    };
                }
            },
            
            // Get status class
            getStatusClass: function(status) {
                const classes = {
                    completed: 'status-completed',
                    cancelled: 'status-cancelled',
                    requested: 'status-ongoing',
                    accepted: 'status-ongoing',
                    arrived: 'status-ongoing',
                    started: 'status-ongoing'
                };
                return classes[status] || 'status-ongoing';
            },
            
            // Get status text
            getStatusText: function(status) {
                const texts = {
                    completed: 'Completed',
                    cancelled: 'Cancelled',
                    requested: 'Requested',
                    accepted: 'Accepted',
                    arrived: 'Arrived',
                    started: 'In Progress'
                };
                return texts[status] || status.charAt(0).toUpperCase() + status.slice(1);
            },
            
            // Create history details
            createHistoryDetails: function(ride) {
                let details = `
                    <div class="detail-section">
                        <div class="detail-title">
                            <i class="fas fa-info-circle"></i>
                            Ride Details
                        </div>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <div class="detail-label">Distance</div>
                                <div class="detail-value">${ride.distance?.toFixed(1) || '0'} km</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Duration</div>
                                <div class="detail-value">${ride.duration || 'N/A'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Ride Type</div>
                                <div class="detail-value">${ride.rideType?.charAt(0).toUpperCase() + ride.rideType?.slice(1) || 'Standard'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Payment</div>
                                <div class="detail-value">${ride.paymentMethod?.charAt(0).toUpperCase() + ride.paymentMethod?.slice(1) || 'Wallet'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Driver</div>
                                <div class="detail-value">${ride.driverName || 'Not assigned'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Vehicle</div>
                                <div class="detail-value">${ride.vehicleDetails || 'N/A'}</div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add emergency details if applicable
                if (ride.emergency) {
                    details += `
                        <div class="detail-section">
                            <div class="detail-title">
                                <i class="fas fa-exclamation-triangle"></i>
                                Emergency Details
                            </div>
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <div class="detail-label">Service Type</div>
                                    <div class="detail-value">${ride.emergencyType?.charAt(0).toUpperCase() + ride.emergencyType?.slice(1)}</div>
                                                        <div class="detail-item">
                            <div class="detail-label">Priority</div>
                            <div class="detail-value">${ride.priority || 'High'}</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Add delivery details if applicable
        if (ride.serviceType === 'delivery') {
            details += `
                <div class="detail-section">
                    <div class="detail-title">
                        <i class="fas fa-box"></i>
                        Delivery Details
                    </div>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Parcel</div>
                            <div class="detail-value">${ride.parcelDescription || 'Not specified'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Receiver</div>
                            <div class="detail-value">${ride.receiverName || 'Not specified'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Parcel Value</div>
                            <div class="detail-value">ZMW ${ride.parcelValue?.toFixed(2) || '0.00'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Delivery Type</div>
                            <div class="detail-value">${ride.deliveryType?.charAt(0).toUpperCase() + ride.deliveryType?.slice(1) || 'Standard'}</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Add truck details if applicable
        if (ride.serviceType === 'truck') {
            details += `
                <div class="detail-section">
                    <div class="detail-title">
                        <i class="fas fa-truck"></i>
                        Truck Details
                    </div>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Truck Type</div>
                            <div class="detail-value">${ride.truckType?.charAt(0).toUpperCase() + ride.truckType?.slice(1) || 'Light'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Item</div>
                            <div class="detail-value">${ride.itemDescription || 'Not specified'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Weight</div>
                            <div class="detail-value">${ride.estimatedWeight || '0'} kg</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Helpers</div>
                            <div class="detail-value">${ride.needHelpers ? 'Yes' : 'No'}</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Add shopping details if applicable
        if (ride.serviceType === 'shopping') {
            details += `
                <div class="detail-section">
                    <div class="detail-title">
                        <i class="fas fa-shopping-bag"></i>
                        Shopping Details
                    </div>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Shop</div>
                            <div class="detail-value">${ride.shopName || 'Not specified'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Items Count</div>
                            <div class="detail-value">${ride.items?.length || 0}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Budget</div>
                            <div class="detail-value">ZMW ${ride.estimatedBudget?.toFixed(2) || '0.00'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Instructions</div>
                            <div class="detail-value">${ride.instructions || 'None'}</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Add shared ride details if applicable
        if (ride.sharedRide) {
            details += `
                <div class="detail-section">
                    <div class="detail-title">
                        <i class="fas fa-share-alt"></i>
                        Shared Ride Details
                    </div>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Shared With</div>
                            <div class="detail-value">${ride.friendReferralCode || 'Unknown'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Split Percentage</div>
                            <div class="detail-value">${ride.splitPercentage || 50}%</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Your Share</div>
                            <div class="detail-value">ZMW ${ride.yourShare?.toFixed(2) || '0.00'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Friend's Share</div>
                            <div class="detail-value">ZMW ${ride.friendShare?.toFixed(2) || '0.00'}</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Add broadcast ride details if applicable
        if (ride.broadcastRide) {
            details += `
                <div class="detail-section">
                    <div class="detail-title">
                        <i class="fas fa-broadcast-tower"></i>
                        Broadcast Details
                    </div>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Recipients</div>
                            <div class="detail-value">${ride.broadcastRecipients?.length || 0} people</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Accepted</div>
                            <div class="detail-value">${ride.broadcastAccepted?.length || 0} people</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Add ride actions (rate, receipt, reorder)
        details += `
            <div class="history-actions">
                <button class="btn-action hover-effect" onclick="UIUpdater.rateRide('${ride.id}')">
                    <i class="fas fa-star"></i>
                    Rate Ride
                </button>
                <button class="btn-action hover-effect" onclick="UIUpdater.viewReceipt('${ride.id}')">
                    <i class="fas fa-receipt"></i>
                    Receipt
                </button>
                <button class="btn-action hover-effect" onclick="UIUpdater.reorderRide('${ride.id}')">
                    <i class="fas fa-redo"></i>
                    Reorder
                </button>
                ${ride.driverId ? `
                <button class="btn-action hover-effect" onclick="UIUpdater.contactDriver('${ride.driverId}')">
                    <i class="fas fa-phone"></i>
                    Contact
                </button>
                ` : ''}
            </div>
        `;
        
        return details;
    },
    
    // Rate a completed ride
    rateRide: function(rideId) {
        showModal('rating');
        window.currentRatingRideId = rideId;
    },
    
    // View ride receipt
    viewReceipt: function(rideId) {
        // Find the ride in AppState
        const ride = AppState.currentRide || 
            (AppState.userData && AppState.userData.rides && AppState.userData.rides[rideId]);
        
        if (ride) {
            FirebaseManager.generateReceipt(ride);
        }
    },
    
    // Reorder a previous ride
    reorderRide: function(rideId) {
        // Find the ride in history
        const historyRide = AppState.userData?.rides?.[rideId];
        if (historyRide) {
            // Set pickup and destination from history
            AppState.pickup = {
                address: historyRide.pickup,
                name: historyRide.pickupDisplay || historyRide.pickup,
                lat: historyRide.pickupLat,
                lng: historyRide.pickupLng
            };
            
            AppState.destination = {
                address: historyRide.destination,
                name: historyRide.destinationDisplay || historyRide.destination,
                lat: historyRide.destLat,
                lng: historyRide.destLng
            };
            
            // Update UI
            document.getElementById('pickupLocation').value = historyRide.pickup;
            document.getElementById('destinationLocation').value = historyRide.destination;
            
            // Switch to home screen and car service
            switchScreen('home');
            switchService('car');
            
            // Calculate prices
            this.calculateAndUpdatePrices();
            
            this.showToast('Ride details loaded. Update if needed and request.', 'success');
        }
    },
    
    // Contact driver
    contactDriver: function(driverId) {
        // Load driver info and show contact options
        FirebaseManager.loadDriverInfo(driverId).then(driver => {
            if (driver && driver.phone) {
                if (confirm(`Call driver ${driver.name} at ${driver.phone}?`)) {
                    window.open(`tel:${driver.phone}`, '_blank');
                }
            } else {
                this.showToast('Driver contact information not available', 'warning');
            }
        });
    },
    
    // Format time ago
    formatTimeAgo: function(timestamp) {
        const now = Date.now();
        const diff = now - timestamp;
        
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);
        
        if (days > 0) {
            return `${days} day${days > 1 ? 's' : ''} ago`;
        } else if (hours > 0) {
            return `${hours} hour${hours > 1 ? 's' : ''} ago`;
        } else if (minutes > 0) {
            return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
        } else {
            return 'Just now';
        }
    },
    
    // Update share ride calculations
    updateShareRideCalculations: function(distanceKm, splitPercentage = 50) {
        const surge = PriceCalculator.getSurgeMultiplier();
        const totalFare = PriceCalculator.calculateRideFare(distanceKm, AppState.selectedRideType, { surge }).total;
        const yourShare = (totalFare * splitPercentage) / 100;
        const friendShare = totalFare - yourShare;
        
        document.getElementById('shareFareEstimate').textContent = `ZMW ${totalFare.toFixed(2)}`;
        document.getElementById('yourShare').textContent = `ZMW ${yourShare.toFixed(2)}`;
        document.getElementById('friendShare').textContent = `ZMW ${friendShare.toFixed(2)}`;
        
        return { totalFare, yourShare, friendShare };
    },
    
    // Show emergency reasons modal
    showEmergencyReasons: function(serviceType) {
        // Clear previous selections
        document.querySelectorAll('.emergency-reason-card').forEach(card => {
            card.classList.remove('selected');
        });
        
        // Show other reason field if needed
        document.getElementById('otherEmergencyReasonGroup').style.display = 'none';
        
        // Update service type
        const serviceElement = document.getElementById('emergencyServiceType');
        serviceElement.textContent = serviceType.charAt(0).toUpperCase() + serviceType.slice(1) + ' Ride';
        serviceElement.dataset.type = serviceType;
        
        // Calculate and show nearest service
        if (AppState.userLocation) {
            const nearestService = EmergencyLocator.findNearestService(serviceType, AppState.userLocation);
            if (nearestService) {
                document.getElementById('emergencyBaseFare').textContent = 
                    `ZMW ${AppState.emergencyServices[serviceType].base.toFixed(2)}`;
                document.getElementById('emergencyDistance').textContent = 
                    `${nearestService.distance.toFixed(1)} km`;
                
                // Calculate fare
                const fare = PriceCalculator.calculateEmergencyFare(nearestService.distance, serviceType);
                document.getElementById('emergencyTotalFare').textContent = `ZMW ${fare.toFixed(2)}`;
                
                // Update current location display
                this.updateEmergencyLocationDisplay();
                
                // Show all services
                this.showEmergencyServicesList(serviceType);
            }
        }
        
        // Show modal
        showModal('emergency');
    },
    
    // Update emergency location display
    updateEmergencyLocationDisplay: function() {
        const locationElement = document.getElementById('emergencyCurrentLocation');
        
        if (AppState.userLocation) {
            // Use reverse geocoding to get address
            reverseGeocode(AppState.userLocation.lat, AppState.userLocation.lng).then(address => {
                locationElement.textContent = address;
            }).catch(() => {
                locationElement.textContent = 
                    `${AppState.userLocation.lat.toFixed(4)}, ${AppState.userLocation.lng.toFixed(4)}`;
            });
        } else {
            locationElement.textContent = 'Location not available. Please enable location services.';
        }
    },
    
    // Show emergency services list
    showEmergencyServicesList: function(serviceType) {
        const container = document.getElementById('emergencyServicesList');
        
        if (!AppState.userLocation) {
            container.innerHTML = '<div class="empty-state">Location required to find services</div>';
            return;
        }
        
        const services = EmergencyLocator.findAllServices(serviceType, AppState.userLocation, 5);
        
        if (services.length === 0) {
            container.innerHTML = '<div class="empty-state">No services found in your area</div>';
            return;
        }
        
        let html = '<div class="emergency-services-header">Nearest Services:</div>';
        
        services.forEach((service, index) => {
            html += `
                <div class="emergency-service-item ${index === 0 ? 'selected' : ''}" 
                     data-lat="${service.lat}" 
                     data-lng="${service.lng}"
                     data-name="${service.name}">
                    <div class="emergency-service-icon">
                        <i class="fas fa-${serviceType === 'police' ? 'shield-alt' : serviceType === 'fire' ? 'fire-extinguisher' : 'ambulance'}"></i>
                    </div>
                    <div class="emergency-service-details">
                        <div class="emergency-service-name">${service.name}</div>
                        <div class="emergency-service-address">${service.address}</div>
                    </div>
                    <div class="emergency-service-distance">${service.distance.toFixed(1)} km</div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        
        // Add click handlers
        container.querySelectorAll('.emergency-service-item').forEach(item => {
            item.addEventListener('click', () => {
                container.querySelectorAll('.emergency-service-item').forEach(i => {
                    i.classList.remove('selected');
                });
                item.classList.add('selected');
            });
        });
    },
    
    // Show broadcast recipients list
    showBroadcastRecipients: function() {
        const container = document.getElementById('broadcastRecipientsList');
        container.innerHTML = '';
        
        AppState.broadcastRecipients.forEach((recipient, index) => {
            const item = document.createElement('div');
            item.className = 'broadcast-recipient-item';
            item.innerHTML = `
                <div class="broadcast-recipient-info">
                    <i class="fas fa-user"></i>
                    <span>${recipient.phone}</span>
                </div>
                <div class="broadcast-recipient-status ${recipient.status}">
                    ${AppState.broadcastStatuses[recipient.status]}
                </div>
                <button class="remove-recipient" data-index="${index}">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.appendChild(item);
        });
        
        // Add remove handlers
        container.querySelectorAll('.remove-recipient').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const index = parseInt(btn.dataset.index);
                AppState.broadcastRecipients.splice(index, 1);
                this.showBroadcastRecipients();
            });
        });
    },
    
    // Show notification list
    showNotifications: function() {
        const container = document.getElementById('notificationList');
        
        if (AppState.notifications.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-bell-slash"></i>
                    <div class="empty-title">No notifications</div>
                    <div class="empty-message">Your notifications will appear here</div>
                </div>
            `;
            return;
        }
        
        container.innerHTML = '';
        
        AppState.notifications.forEach(notification => {
            const item = document.createElement('div');
            item.className = `notification-item ${notification.read ? '' : 'unread'}`;
            item.dataset.id = notification.id;
            
            // Determine icon based on notification type
            let iconClass = 'ride';
            if (notification.type.includes('wallet') || notification.type.includes('payment')) {
                iconClass = 'wallet';
            } else if (notification.type.includes('promotion')) {
                iconClass = 'promotion';
            } else if (notification.type.includes('emergency')) {
                iconClass = 'emergency';
            } else if (notification.type.includes('referral')) {
                iconClass = 'referral';
            }
            
            item.innerHTML = `
                <div class="notification-icon ${iconClass}">
                    <i class="fas fa-${this.getNotificationIcon(notification.type)}"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-message">${notification.message}</div>
                    <div class="notification-time">${this.formatTimeAgo(notification.timestamp)}</div>
                </div>
            `;
            
            // Add click handler
            item.addEventListener('click', () => {
                this.handleNotificationClick(notification);
            });
            
            container.appendChild(item);
        });
    },
    
    // Get notification icon
    getNotificationIcon: function(type) {
        const iconMap = {
            'ride': 'car',
            'wallet': 'wallet',
            'payment': 'credit-card',
            'promotion': 'gift',
            'emergency': 'exclamation-triangle',
            'referral': 'users',
            'driver': 'user',
            'system': 'info-circle'
        };
        
        for (const [key, icon] of Object.entries(iconMap)) {
            if (type.includes(key)) {
                return icon;
            }
        }
        
        return 'bell';
    },
    
    // Handle notification click
    handleNotificationClick: function(notification) {
        // Mark as read
        if (!notification.read) {
            FirebaseManager.markNotificationAsRead(notification.id);
        }
        
        // Handle different notification types
        switch(notification.type) {
            case 'ride_accepted':
                // Show ride info
                if (AppState.currentRide) {
                    UIUpdater.showRideInfo(AppState.currentRide);
                }
                break;
                
            case 'ride_completed':
                // Show receipt
                if (notification.rideId) {
                    FirebaseManager.generateReceipt({ id: notification.rideId });
                }
                break;
                
            case 'wallet_deposit':
            case 'wallet_withdrawal':
                // Show wallet
                switchScreen('account');
                break;
                
            case 'referral_reward':
                // Show referral section
                switchScreen('account');
                // Scroll to referral section
                setTimeout(() => {
                    document.querySelector('.referral-card').scrollIntoView({ behavior: 'smooth' });
                }, 100);
                break;
                
            case 'promotion':
                // Show promotions
                this.showToast('Check out our latest promotions!', 'info');
                break;
                
            case 'broadcast_invite':
                // Handle broadcast invitation
                if (notification.rideId) {
                    this.handleBroadcastInvitation(notification);
                }
                break;
        }
        
        // Close notification dropdown
        document.getElementById('notificationDropdown').classList.remove('active');
    },
    
    // Handle broadcast invitation
    handleBroadcastInvitation: function(notification) {
        if (confirm(`${notification.senderName} invited you to join their ride. Accept invitation?`)) {
            // Accept broadcast invitation
            FirebaseManager.acceptBroadcastInvitation(notification.rideId, notification.invitationId).then(() => {
                this.showToast('You have joined the ride!', 'success');
                
                // Start tracking the shared ride
                if (notification.rideData) {
                    this.startSharedRideTracking(notification.rideData);
                }
            }).catch(error => {
                this.showToast('Failed to join ride: ' + error.message, 'error');
            });
        }
    },
    
    // Start shared ride tracking
    startSharedRideTracking: function(rideData) {
        // Show live tracking for shared ride
        const trackingContainer = document.getElementById('liveTrackingContainer');
        trackingContainer.classList.add('active');
        
        // Update tracking info
        document.querySelector('.tracking-title').textContent = 'Shared Ride Tracking';
        document.getElementById('trackingDistance').textContent = 'Tracking active';
        
        // Listen for ride updates
        if (rideData.rideId) {
            FirebaseManager.listenToRideUpdates(rideData.rideId);
        }
    },
    
    // Show network status
    showNetworkStatus: function(status) {
        const networkElement = document.getElementById('networkStatus');
        
        if (status === 'online') {
            networkElement.className = 'network-status online';
            networkElement.innerHTML = '<i class="fas fa-wifi"></i> Back online';
            
            setTimeout(() => {
                networkElement.style.display = 'none';
            }, 3000);
        } else {
            networkElement.className = 'network-status offline';
            networkElement.innerHTML = '<i class="fas fa-wifi-slash"></i> You are offline';
            networkElement.style.display = 'flex';
        }
    },
    
    // Show battery saver warning
    showBatterySaver: function() {
        const batteryElement = document.createElement('div');
        batteryElement.className = 'battery-saver active';
        batteryElement.innerHTML = '<i class="fas fa-battery-quarter"></i> Battery saver mode enabled';
        document.body.appendChild(batteryElement);
        
        setTimeout(() => {
            batteryElement.remove();
        }, 5000);
    }
};

// ============================================
// ENHANCED FIREBASE MANAGER WITH BROADCAST AND REAL-TIME FEATURES
// ============================================
const FirebaseManager = {
    // Load user data with enhanced features
    async loadUserData(uid) {
        try {
            UIUpdater.showLoading('Loading your account...');
            
            const snapshot = await database.ref(`users/${uid}`).once('value');
            AppState.userData = snapshot.val();
            
            if (AppState.userData) {
                // Update wallet balance
                AppState.walletBalance = AppState.userData.walletBalance || 0;
                UIUpdater.updateWalletBalance(AppState.walletBalance);
                
                // Update user info in top bar
                document.getElementById('userName').textContent = AppState.userData.name || 'Passenger';
                document.getElementById('accountName').textContent = AppState.userData.name || 'User';
                document.getElementById('accountPhone').textContent = AppState.userData.phone || 'Not set';
                document.getElementById('referralCode').textContent = AppState.userData.referralCode || 'JUBEL-XXXX';
                
                // Update avatar
                this.updateUserAvatar();
                
                // Load all data in parallel for better performance
                await Promise.all([
                    this.loadSOSConfig(uid),
                    this.loadScheduledRides(uid),
                    this.checkActiveRide(uid),
                    this.loadRideHistory(uid),
                    this.loadNotifications(uid),
                    this.loadFavoriteLocations(uid),
                    this.loadUserSettings(uid)
                ]);
                
                // Start listening to real-time updates
                this.startRealtimeListeners(uid);
                
                UIUpdater.hideLoading();
                return true;
            }
            
            UIUpdater.hideLoading();
            return false;
        } catch (error) {
            console.error('Error loading user data:', error);
            UIUpdater.showToast('Error loading user data. Please try again.', 'error');
            UIUpdater.hideLoading();
            return false;
        }
    },
    
    // Update user avatar
    updateUserAvatar: function() {
        const avatar = document.getElementById('accountAvatar');
        if (AppState.userData?.photoUrl) {
            avatar.innerHTML = `<img src="${AppState.userData.photoUrl}" alt="${AppState.userData.name}" 
                onerror="this.style.display='none'; this.parentNode.innerHTML='<i class=\\'fas fa-user\\'></i>';">`;
        } else {
            avatar.innerHTML = '<i class="fas fa-user"></i>';
        }
    },
    
    // Load SOS configuration
    async loadSOSConfig(uid) {
        try {
            const snapshot = await database.ref(`sosConfig/${uid}`).once('value');
            AppState.sosConfig = snapshot.val();
            
            if (AppState.sosConfig) {
                // Populate SOS modal fields
                document.getElementById('sosContact1Name').value = AppState.sosConfig.contact1Name || '';
                document.getElementById('sosContact1Phone').value = AppState.sosConfig.contact1Phone || '';
                document.getElementById('sosContact2Name').value = AppState.sosConfig.contact2Name || '';
                document.getElementById('sosContact2Phone').value = AppState.sosConfig.contact2Phone || '';
                document.getElementById('sosMessage').value = AppState.sosConfig.message || '';
                
                // Show SOS button
                document.getElementById('sosButton').style.display = 'flex';
            }
        } catch (error) {
            console.error('Error loading SOS config:', error);
        }
    },
    
    // Load scheduled rides
    async loadScheduledRides(uid) {
        try {
            const snapshot = await database.ref('scheduledRides')
                .orderByChild('passengerId')
                .equalTo(uid)
                .once('value');
            
            const rides = snapshot.val();
            if (rides) {
                AppState.scheduledRides = Object.values(rides).filter(ride => 
                    ride.status === 'scheduled' || ride.status === 'upcoming'
                );
                
                // Sort by scheduled time
                AppState.scheduledRides.sort((a, b) => a.scheduledTime - b.scheduledTime);
                
                // Set reminders for upcoming rides
                this.setScheduledRideReminders(AppState.scheduledRides);
            }
        } catch (error) {
            console.error('Error loading scheduled rides:', error);
        }
    },
    
    // Set reminders for scheduled rides
    setScheduledRideReminders: function(rides) {
        rides.forEach(ride => {
            const timeUntilRide = ride.scheduledTime - Date.now();
            
            // Set reminder 30 minutes before
            if (timeUntilRide > 30 * 60 * 1000) {
                setTimeout(() => {
                    UIUpdater.showToast(
                        `Your ride to ${ride.destinationDisplay} is in 30 minutes`,
                        'info',
                        10000,
                        {
                            action: {
                                text: 'View',
                                onclick: `showScheduledRide('${ride.id}')`
                            }
                        }
                    );
                }, timeUntilRide - 30 * 60 * 1000);
            }
            
            // Set reminder 10 minutes before
            if (timeUntilRide > 10 * 60 * 1000) {
                setTimeout(() => {
                    UIUpdater.showToast(
                        `Your ride to ${ride.destinationDisplay} is in 10 minutes`,
                        'warning',
                        10000,
                        {
                            action: {
                                text: 'Prepare',
                                onclick: `prepareScheduledRide('${ride.id}')`
                            }
                        }
                    );
                }, timeUntilRide - 10 * 60 * 1000);
            }
        });
    },
    
    // Check for active ride
    async checkActiveRide(uid) {
        try {
            const snapshot = await database.ref('rides')
                .orderByChild('passengerId')
                .equalTo(uid)
                .orderByChild('status')
                .startAt('requested')
                .endAt('started')
                .once('value');
            
            const rides = snapshot.val();
            if (rides) {
                const rideId = Object.keys(rides)[0];
                AppState.currentRide = { id: rideId, ...rides[rideId] };
                
                // Show ride info
                UIUpdater.showRideInfo(AppState.currentRide);
                UIUpdater.updateTimeline(AppState.currentRide.status);
                
                // Listen for ride updates
                this.listenToRideUpdates(rideId);
                
                // If driver assigned, listen to driver location
                if (AppState.currentRide.driverId) {
                    this.listenToDriverLocation(AppState.currentRide.driverId);
                    
                    // Load driver info
                    await this.loadDriverInfo(AppState.currentRide.driverId);
                }
                
                // Start chat if available
                if (AppState.currentRide.driverId) {
                    this.listenToChatMessages(rideId);
                }
                
                return true;
            }
            return false;
        } catch (error) {
            console.error('Error checking active ride:', error);
            return false;
        }
    },
    
    // Load ride history with filters
    async loadRideHistory(uid) {
        try {
            const snapshot = await database.ref('rides')
                .orderByChild('passengerId')
                .equalTo(uid)
                .once('value');
            
            const rides = snapshot.val();
            if (rides) {
                const ridesArray = Object.keys(rides).map(id => ({
                    id,
                    ...rides[id]
                }));
                
                // Sort by timestamp (newest first)
                ridesArray.sort((a, b) => b.timestamp - a.timestamp);
                
                // Store all rides
                if (!AppState.userData.rides) {
                    AppState.userData.rides = {};
                }
                
                ridesArray.forEach(ride => {
                    AppState.userData.rides[ride.id] = ride;
                });
                
                // Filter based on active filter
                const filtered = this.filterRides(ridesArray, AppState.activeFilter);
                
                // Update UI
                UIUpdater.updateHistoryList(filtered);
                
                // Update stats
                this.updateUserStats(ridesArray);
            }
        } catch (error) {
            console.error('Error loading ride history:', error);
        }
    },
    
    // Filter rides based on criteria
    filterRides: function(rides, filter) {
        switch(filter) {
            case 'completed':
                return rides.filter(ride => ride.status === 'completed');
            case 'cancelled':
                return rides.filter(ride => ride.status === 'cancelled');
            case 'scheduled':
                return rides.filter(ride => ride.scheduled);
            case 'emergency':
                return rides.filter(ride => ride.emergency);
            case 'delivery':
                return rides.filter(ride => ride.serviceType === 'delivery');
            case 'truck':
                return rides.filter(ride => ride.serviceType === 'truck');
            case 'shopping':
                return rides.filter(ride => ride.serviceType === 'shopping');
            case 'shared':
                return rides.filter(ride => ride.sharedRide);
            case 'broadcast':
                return rides.filter(ride => ride.broadcastRide);
            default:
                return rides;
        }
    },
    
    // Update user statistics
    updateUserStats: function(rides) {
        const completed = rides.filter(ride => ride.status === 'completed').length;
        const cancelled = rides.filter(ride => ride.status === 'cancelled').length;
        const totalSpent = rides
            .filter(ride => ride.status === 'completed')
            .reduce((sum, ride) => sum + (ride.fare || 0), 0);
        
        // Calculate average rating
        const ratedRides = rides.filter(ride => ride.passengerRating);
        const averageRating = ratedRides.length > 0 
            ? ratedRides.reduce((sum, ride) => sum + ride.passengerRating, 0) / ratedRides.length
            : 5.0;
        
        document.getElementById('completedRides').textContent = completed;
        document.getElementById('cancelledRides').textContent = cancelled;
        document.getElementById('totalSpent').textContent = `ZMW ${totalSpent.toFixed(2)}`;
        
        // Update user data
        if (AppState.userData) {
            AppState.userData.totalRides = completed + cancelled;
            AppState.userData.totalSpent = totalSpent;
            AppState.userData.averageRating = averageRating;
        }
    },
    
    // Load notifications
    async loadNotifications(uid) {
        try {
            const snapshot = await database.ref(`notifications/${uid}`)
                .orderByChild('timestamp')
                .limitToLast(50)
                .once('value');
            
            const notifications = snapshot.val();
            if (notifications) {
                AppState.notifications = Object.values(notifications)
                    .sort((a, b) => b.timestamp - a.timestamp);
                
                // Update notification badge
                this.updateNotificationBadge();
                
                // Show notification list
                UIUpdater.showNotifications();
            }
        } catch (error) {
            console.error('Error loading notifications:', error);
        }
    },
    
    // Update notification badge
    updateNotificationBadge: function() {
        const unreadCount = AppState.notifications.filter(n => !n.read).length;
        const badge = document.getElementById('notificationCount');
        
        if (unreadCount > 0) {
            badge.textContent = unreadCount > 99 ? '99+' : unreadCount.toString();
            badge.style.display = 'flex';
            
            // Animate for new notifications
            if (unreadCount > 0) {
                badge.classList.add('pulse');
                setTimeout(() => {
                    badge.classList.remove('pulse');
                }, 1000);
            }
        } else {
            badge.textContent = '0';
            badge.style.display = 'none';
        }
    },
    
    // Mark notification as read
    async markNotificationAsRead(notificationId) {
        try {
            await database.ref(`notifications/${AppState.currentUser.uid}/${notificationId}/read`).set(true);
            
            // Update local state
            const notification = AppState.notifications.find(n => n.id === notificationId);
            if (notification) {
                notification.read = true;
                this.updateNotificationBadge();
            }
        } catch (error) {
            console.error('Error marking notification as read:', error);
        }
    },
    
    // Load favorite locations
    async loadFavoriteLocations(uid) {
        try {
            const snapshot = await database.ref(`favorites/${uid}`).once('value');
            const favorites = snapshot.val();
            
            if (favorites) {
                AppState.favoriteLocations = favorites;
                
                // Update UI with favorites if needed
                this.updateFavoriteLocationsUI();
            }
        } catch (error) {
            console.error('Error loading favorite locations:', error);
        }
    },
    
    // Update favorite locations UI
    updateFavoriteLocationsUI: function() {
        // This would update the UI with favorite locations
        // For example, in search suggestions or a favorites section
    },
    
    // Load user settings
    async loadUserSettings(uid) {
        try {
            const snapshot = await database.ref(`settings/${uid}`).once('value');
            const settings = snapshot.val();
            
            if (settings) {
                AppState.userSettings = settings;
                
                // Apply settings
                this.applyUserSettings(settings);
            }
        } catch (error) {
            console.error('Error loading user settings:', error);
        }
    },
    
    // Apply user settings
    applyUserSettings: function(settings) {
        // Apply theme
        if (settings.theme === 'dark') {
            document.body.classList.add('dark-mode');
        }
        
        // Apply language
        if (settings.language) {
            // Set language preferences
        }
        
        // Apply notification preferences
        if (settings.notifications) {
            // Configure notification settings
        }
        
        // Apply accessibility settings
        if (settings.accessibility) {
            if (settings.accessibility.largeText) {
                document.body.classList.add('large-text');
            }
            if (settings.accessibility.highContrast) {
                document.body.classList.add('high-contrast');
            }
            if (settings.accessibility.reducedMotion) {
                document.body.classList.add('reduced-motion');
            }
        }
    },
    
    // Start real-time listeners
    startRealtimeListeners: function(uid) {
        // Listen for ride updates
        database.ref('rides')
            .orderByChild('passengerId')
            .equalTo(uid)
            .on('child_changed', (snapshot) => {
                const ride = snapshot.val();
                const rideId = snapshot.key;
                
                if (ride.status !== 'completed' && ride.status !== 'cancelled') {
                    AppState.currentRide = { id: rideId, ...ride };
                    this.handleRideUpdate(ride);
                }
            });
        
        // Listen for new notifications
        database.ref(`notifications/${uid}`)
            .orderByChild('timestamp')
            .limitToLast(1)
            .on('child_added', (snapshot) => {
                const notification = snapshot.val();
                notification.id = snapshot.key;
                
                // Add to notifications list
                AppState.notifications.unshift(notification);
                
                // Update UI
                this.updateNotificationBadge();
                UIUpdater.showNotifications();
                
                // Show toast for important notifications
                if (!notification.read && notification.priority === 'high') {
                    UIUpdater.showToast(notification.message, 'info', 5000, {
                        action: {
                            text: 'View',
                            onclick: `document.getElementById('notificationBell').click()`
                        }
                    });
                }
            });
        
        // Listen for wallet balance changes
        database.ref(`users/${uid}/walletBalance`).on('value', (snapshot) => {
            const newBalance = snapshot.val() || 0;
            if (newBalance !== AppState.walletBalance) {
                AppState.walletBalance = newBalance;
                UIUpdater.updateWalletBalance(newBalance);
            }
        });
        
        // Listen for broadcast invitations
        database.ref(`broadcastInvitations/${uid}`)
            .on('child_added', (snapshot) => {
                const invitation = snapshot.val();
                invitation.id = snapshot.key;
                
                this.handleBroadcastInvitation(invitation);
            });
    },
    
    // Handle ride update
    handleRideUpdate: function(ride) {
        // Update ride info UI
        UIUpdater.showRideInfo(ride);
        UIUpdater.updateTimeline(ride.status);
        
        // Handle specific status changes
        switch(ride.status) {
            case 'accepted':
                // Show driver info
                if (ride.driverId && !AppState.selectedVehicle) {
                    this.loadDriverInfo(ride.driverId);
                }
                
                // Show SOS button
                if (AppState.sosConfig) {
                    document.getElementById('sosButton').style.display = 'flex';
                }
                
                // Send notification
                this.sendNotification(
                    AppState.currentUser.uid,
                    'Driver Assigned',
                    `Your driver ${ride.driverName} is on the way`,
                    'ride'
                );
                break;
                
            case 'arrived':
                // Update driver status
                UIUpdater.showToast('Your driver has arrived', 'success');
                break;
                
            case 'started':
                // Start trip timer
                this.startTripTimer();
                break;
                
            case 'completed':
                this.handleRideCompletion(ride);
                break;
                
            case 'cancelled':
                this.handleRideCancellation(ride);
                break;
        }
    },
    
    // Start trip timer
    startTripTimer: function() {
        // Start counting trip duration
        if (AppState.currentRide) {
            AppState.currentRide.tripStartTime = Date.now();
            
            // Update ETA every minute
            AppState.tripTimer = setInterval(() => {
                if (AppState.currentRide && AppState.currentRide.status === 'started') {
                    const elapsed = Date.now() - AppState.currentRide.tripStartTime;
                    const minutes = Math.floor(elapsed / 60000);
                    
                    // Update ETA display
                    const etaElement = document.getElementById('etaText');
                    if (etaElement) {
                        etaElement.textContent = `${minutes} min elapsed`;
                    }
                } else {
                    clearInterval(AppState.tripTimer);
                }
            }, 60000);
        }
    },
    
    // Handle ride completion
    handleRideCompletion: function(ride) {
        // Clear trip timer
        if (AppState.tripTimer) {
            clearInterval(AppState.tripTimer);
        }
        
        // Hide ride status bar
        document.getElementById('rideStatusBar').classList.remove('active');
        
        // Hide SOS button
        document.getElementById('sosButton').style.display = 'none';
        
        // Update timeline to completed
        UIUpdater.updateTimeline('completed');
        
        // Add receipt button
        const actionButtons = document.querySelector('#rideInfoPanel .action-buttons');
        const existingReceiptBtn = document.querySelector('#receiptBtn');
        
        if (!existingReceiptBtn) {
            const receiptBtn = document.createElement('button');
            receiptBtn.id = 'receiptBtn';
            receiptBtn.className = 'btn btn-primary hover-effect';
            receiptBtn.innerHTML = '<i class="fas fa-receipt"></i> View Receipt';
            receiptBtn.addEventListener('click', () => {
                this.generateReceipt(ride);
            });
            
            actionButtons.appendChild(receiptBtn);
        }
        
        // Update wallet balance if paid with wallet
        if (ride.paymentMethod === 'wallet') {
            const newBalance = AppState.walletBalance - ride.fare;
            UIUpdater.updateWalletBalance(newBalance);
            
            // Update in database
            database.ref(`users/${AppState.currentUser.uid}/walletBalance`).set(newBalance);
        }
        
        // Handle referral reward if applicable
        if (ride.referredBy) {
            this.handleReferralReward(ride);
        }
        
        // Send completion notification
        this.sendNotification(
            AppState.currentUser.uid,
            'Ride Completed',
            `Your ride to ${ride.destinationDisplay} has been completed. ZMW ${ride.fare?.toFixed(2)} has been charged.`,
            'ride'
        );
        
        // Ask for rating after 5 seconds
        setTimeout(() => {
            this.askForRating(ride);
        }, 5000);
    },
    
    // Handle ride cancellation
    handleRideCancellation: function(ride) {
        // Clear trip timer
        if (AppState.tripTimer) {
            clearInterval(AppState.tripTimer);
        }
        
        // Stop live tracking
        UIUpdater.stopLiveTracking();
        
        // Hide ride status bar
        document.getElementById('rideStatusBar').classList.remove('active');
        
        // Hide SOS button
        document.getElementById('sosButton').style.display = 'none';
        
        // Reset UI
        resetUIAfterRide();
        
        // Send cancellation notification
        this.sendNotification(
            AppState.currentUser.uid,
            'Ride Cancelled',
            `Your ride to ${ride.destinationDisplay} has been cancelled.`,
            'ride'
        );
        
        // Show cancellation reason if available
        if (ride.cancelReason) {
            UIUpdater.showToast(`Ride cancelled: ${ride.cancelReason}`, 'info');
        }
    },
    
    // Ask for rating
    askForRating: function(ride) {
        if (!AppState.userSettings || AppState.userSettings.askForRating !== false) {
            showModal('rating');
            window.currentRatingRideId = ride.id;
        }
    },
    
    // Submit rating
    async submitRating(rideId, rating, comment = '') {
        try {
            await database.ref(`rides/${rideId}`).update({
                passengerRating: rating,
                passengerComment: comment,
                ratedAt: Date.now()
            });
            
            // Update user's average rating
            const userRef = database.ref(`users/${AppState.currentUser.uid}`);
            const snapshot = await userRef.once('value');
            const userData = snapshot.val();
            
            const totalRides = (userData.totalRides || 0) + 1;
            const currentRating = userData.averageRating || 5.0;
            const newAverage = ((currentRating * (totalRides - 1)) + rating) / totalRides;
            
            await userRef.update({
                averageRating: newAverage,
                totalRides: totalRides
            });
            
            UIUpdater.showToast('Thank you for your feedback!', 'success');
            hideModal('rating');
        } catch (error) {
            console.error('Error submitting rating:', error);
            UIUpdater.showToast('Error submitting rating', 'error');
        }
    },
    
    // Handle referral reward
    async handleReferralReward(ride) {
        try {
            // Find referrer by referral code
            const usersSnapshot = await database.ref('users').once('value');
            const users = usersSnapshot.val();
            let referrerId = null;
            
            for (const [userId, userData] of Object.entries(users)) {
                if (userData.referralCode === ride.referredBy) {
                    referrerId = userId;
                    break;
                }
            }
            
            if (referrerId) {
                // Add ZMW 25 reward to referrer
                const referrerSnapshot = await database.ref(`users/${referrerId}/walletBalance`).once('value');
                const referrerBalance = referrerSnapshot.val() || 0;
                const newReferrerBalance = referrerBalance + 25;
                
                await database.ref(`users/${referrerId}/walletBalance`).set(newReferrerBalance);
                
                // Record transaction
                const transactionId = database.ref().child('transactions').push().key;
                const transaction = {
                    id: transactionId,
                    senderId: 'system',
                    senderName: 'Jubel System',
                    recipientId: referrerId,
                    recipientName: users[referrerId].name,
                    amount: 25,
                    message: `Referral reward from ${AppState.userData.name}`,
                    timestamp: Date.now(),
                    type: 'referral'
                };
                
                await database.ref(`transactions/${transactionId}`).set(transaction);
                
                // Send notification to referrer
                await this.sendNotification(
                    referrerId,
                    'Referral Reward',
                    `You earned ZMW 25.00 because ${AppState.userData.name} used your referral code`,
                    'referral'
                );
                
                // Send notification to passenger
                await this.sendNotification(
                    AppState.currentUser.uid,
                    'Referral Applied',
                    'Your friend will receive ZMW 25.00 for your referral',
                    'referral'
                );
            }
        } catch (error) {
            console.error('Error handling referral reward:', error);
        }
    },
    
    // Listen to ride updates
    listenToRideUpdates: function(rideId) {
        database.ref(`rides/${rideId}`).on('value', (snapshot) => {
            const ride = snapshot.val();
            if (ride) {
                AppState.currentRide = { id: rideId, ...ride };
                this.handleRideUpdate(ride);
            }
        });
    },
    
    // Load driver info
    async loadDriverInfo(driverId) {
        try {
            const snapshot = await database.ref(`users/${driverId}`).once('value');
            const driver = snapshot.val();
            
            if (driver) {
                AppState.selectedVehicle = driver;
                UIUpdater.showDriverInfo(driver);
                
                // Start listening to driver location
                this.listenToDriverLocation(driverId);
                
                // Start listening to driver status
                this.listenToDriverStatus(driverId);
            }
        } catch (error) {
            console.error('Error loading driver info:', error);
        }
    },
    
    // Listen to driver location
    listenToDriverLocation(driverId) {
        database.ref(`driverLocations/${driverId}`).on('value', (snapshot) => {
            const location = snapshot.val();
            if (location) {
                AppState.driverLocation = {
                    lat: location.latitude,
                    lng: location.longitude,
                    heading: location.heading,
                    speed: location.speed,
                    timestamp: location.timestamp
                };
                
                // Update driver marker
                UIUpdater.updateDriverMarker({
                    lat: location.latitude,
                    lng: location.longitude
                });
                
                // Update live tracking
                UIUpdater.updateLiveTracking();
            }
        });
    },
    
    // Listen to driver status
    listenToDriverStatus(driverId) {
        database.ref(`driverStatus/${driverId}`).on('value', (snapshot) => {
            const status = snapshot.val();
            if (status) {
                // Update driver status indicator
                const statusIndicator = document.getElementById('driverStatusIndicator');
                if (statusIndicator) {
                    statusIndicator.className = 'driver-status-indicator ' + (status.status || 'online');
                }
                
                // Update chat status
                const chatStatus = document.getElementById('chatDriverStatus');
                if (chatStatus) {
                    chatStatus.className = 'chat-driver-status ' + (status.status || 'online');
                }
            }
        });
    },
    
    // Request a ride with enhanced features
    async requestRide(rideData) {
        try {
            UIUpdater.showLoading('Requesting your ride...');
            
            const rideId = database.ref().child('rides').push().key;
            const ride = {
                id: rideId,
                ...rideData,
                status: 'requested',
                timestamp: Date.now(),
                updatedAt: Date.now(),
                requestId: `REQ-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`
            };
            
            await database.ref(`rides/${rideId}`).set(ride);
            
            AppState.currentRide = ride;
            
            // Show ride info
            UIUpdater.showRideInfo(ride);
            UIUpdater.updateTimeline('requested');
            
            // Listen for updates
            this.listenToRideUpdates(rideId);
            
            // Send notification
            this.sendNotification(
                AppState.currentUser.uid,
                'Ride Requested',
                `Your ride to ${ride.destinationDisplay} has been requested`,
                'ride'
            );
            
            UIUpdater.hideLoading();
            UIUpdater.showToast('Ride requested successfully', 'success');
            
            return rideId;
        } catch (error) {
            console.error('Error requesting ride:', error);
            UIUpdater.hideLoading();
            UIUpdater.showToast('Error requesting ride', 'error');
            throw error;
        }
    },
    
    // Request delivery
    async requestDelivery(deliveryData) {
        try {
            UIUpdater.showLoading('Requesting delivery...');
            
            const rideId = database.ref().child('rides').push().key;
            const ride = {
                id: rideId,
                ...deliveryData,
                serviceType: 'delivery',
                status: 'requested',
                timestamp: Date.now(),
                updatedAt: Date.now()
            };
            
            await database.ref(`rides/${rideId}`).set(ride);
            
            AppState.currentRide = ride;
            UIUpdater.showRideInfo(ride);
            UIUpdater.updateTimeline('requested');
            
            this.listenToRideUpdates(rideId);
            
            UIUpdater.hideLoading();
            UIUpdater.showToast('Delivery requested successfully', 'success');
            
            return rideId;
        } catch (error) {
            console.error('Error requesting delivery:', error);
            UIUpdater.hideLoading();
            UIUpdater.showToast('Error requesting delivery', 'error');
            throw error;
        }
    },
    
    // Request truck
    async requestTruck(truckData) {
        try {
            UIUpdater.showLoading('Requesting truck...');
            
            const rideId = database.ref().child('rides').push().key;
            const ride = {
                id: rideId,
                ...truckData,
                serviceType: 'truck',
                status: 'requested',
                timestamp: Date.now(),
                updatedAt: Date.now()
            };
            
            await database.ref(`rides/${rideId}`).set(ride);
            
            AppState.currentRide = ride;
            UIUpdater.showRideInfo(ride);
            UIUpdater.updateTimeline('requested');
            
            this.listenToRideUpdates(rideId);
            
            UIUpdater.hideLoading();
            UIUpdater.showToast('Truck requested successfully', 'success');
            
            return rideId;
        } catch (error) {
            console.error('Error requesting truck:', error);
            UIUpdater.hideLoading();
            UIUpdater.showToast('Error requesting truck', 'error');
            throw error;
        }
    },
    
    // Request shopping
    async requestShopping(shoppingData) {
        try {
            UIUpdater.showLoading('Requesting shopping service...');
            
            const rideId = database.ref().child('rides').push().key;
            const ride = {
                id: rideId,
                ...shoppingData,
                serviceType: 'shopping',
                status: 'requested',
                timestamp: Date.now(),
                updatedAt: Date.now()
            };
            
            await database.ref(`rides/${rideId}`).set(ride);
            
            AppState.currentRide = ride;
            UIUpdater.showRideInfo(ride);
            UIUpdater.updateTimeline('requested');
            
            this.listenToRideUpdates(rideId);
            
            UIUpdater.hideLoading();
            UIUpdater.showToast('Shopping request submitted', 'success');
            
            return rideId;
        } catch (error) {
            console.error('Error requesting shopping:', error);
            UIUpdater.hideLoading();
            UIUpdater.showToast('Error requesting shopping', 'error');
            throw error;
        }
    },
    
    // Broadcast ride to multiple recipients
    async broadcastRide(broadcastData) {
        try {
            UIUpdater.showLoading('Broadcasting ride...');
            
            // Create the ride
            const rideId = database.ref().child('rides').push().key;
            const ride = {
                id: rideId,
                ...broadcastData,
                broadcastRide: true,
                broadcastRecipients: broadcastData.recipients,
                status: 'requested',
                timestamp: Date.now(),
                updatedAt: Date.now()
            };
            
            await database.ref(`rides/${rideId}`).set(ride);
            
            // Send invitations to each recipient
            const invitations = [];
            for (const recipient of broadcastData.recipients) {
                const invitationId = database.ref().child(`broadcastInvitations/${recipient.uid}`).push().key;
                const invitation = {
                    id: invitationId,
                    rideId: rideId,
                    senderId: AppState.currentUser.uid,
                    senderName: AppState.userData.name,
                    message: broadcastData.message,
                    rideData: {
                        pickup: broadcastData.pickup,
                        destination: broadcastData.destination,
                        fare: broadcastData.fare,
                        estimatedTime: broadcastData.estimatedTime
                    },
                    status: 'pending',
                    timestamp: Date.now()
                };
                
                await database.ref(`broadcastInvitations/${recipient.uid}/${invitationId}`).set(invitation);
                invitations.push(invitation);
                
                // Send notification to recipient
                await this.sendNotification(
                    recipient.uid,
                    'Ride Invitation',
                    `${AppState.userData.name} invited you to join their ride`,
                    'broadcast'
                );
            }
            
            AppState.currentRide = ride;
            UIUpdater.showRideInfo(ride);
            UIUpdater.updateTimeline('requested');
            
            this.listenToRideUpdates(rideId);
            
            UIUpdater.hideLoading();
            UIUpdater.showToast(`Ride broadcasted to ${broadcastData.recipients.length} people`, 'success');
            
            return { rideId, invitations };
        } catch (error) {
            console.error('Error broadcasting ride:', error);
            UIUpdater.hideLoading();
            UIUpdater.showToast('Error broadcasting ride', 'error');
            throw error;
        }
    },
    
    // Accept broadcast invitation
    async acceptBroadcastInvitation(rideId, invitationId) {
        try {
            const uid = AppState.currentUser.uid;
            
            // Update invitation status
            await database.ref(`broadcastInvitations/${uid}/${invitationId}/status`).set('accepted');
            
            // Add user to ride participants
            await database.ref(`rides/${rideId}/broadcastAccepted`).transaction((current) => {
                const accepted = current || [];
                if (!accepted.includes(uid)) {
                    accepted.push(uid);
                }
                return accepted;
            });
            
            // Send notification to ride creator
            const rideSnapshot = await database.ref(`rides/${rideId}`).once('value');
            const ride = rideSnapshot.val();
            
            if (ride && ride.passengerId) {
                await this.sendNotification(
                    ride.passengerId,
                    'Ride Joined',
                    `${AppState.userData.name} joined your ride`,
                    'broadcast'
                );
            }
            
            return true;
        } catch (error) {
            console.error('Error accepting broadcast invitation:', error);
            throw error;
        }
    },
    
    // Handle broadcast invitation
    handleBroadcastInvitation: function(invitation) {
        // Add to notifications
        AppState.notifications.unshift({
            id: invitation.id,
            type: 'broadcast_invite',
            title: 'Ride Invitation',
            message: invitation.message || `${invitation.senderName} invited you to join their ride`,
            read: false,
            timestamp: invitation.timestamp,
            invitationId: invitation.id,
            rideId: invitation.rideId,
            senderName: invitation.senderName,
            rideData: invitation.rideData
        });
        
        // Update notification UI
        this.updateNotificationBadge();
        UIUpdater.showNotifications();
        
        // Show toast notification
        UIUpdater.showToast(
            `${invitation.senderName} invited you to join their ride`,
            'info',
            10000,
            {
                action: {
                    text: 'View',
                    onclick: `document.getElementById('notificationBell').click()`
                }
            }
        );
    },
    
    // Cancel ride
    async cancelRide(rideId, reason) {
        try {
            UIUpdater.showLoading('Cancelling ride...');
            
            await database.ref(`rides/${rideId}`).update({
                status: 'cancelled',
                cancelReason: reason,
                cancelledAt: Date.now(),
                updatedAt: Date.now()
            });
            
            // Send notification to driver if assigned
            const rideSnapshot = await database.ref(`rides/${rideId}`).once('value');
            const ride = rideSnapshot.val();
            
            if (ride && ride.driverId) {
                await this.sendNotification(
                    ride.driverId,
                    'Ride Cancelled',
                    `Passenger cancelled the ride: ${reason}`,
                    'ride'
                );
            }
            
            // Send notification to passenger
            await this.sendNotification(
                AppState.currentUser.uid,
                'Ride Cancelled',
                'Your ride has been cancelled',
                'ride'
            );
            
            UIUpdater.hideLoading();
            UIUpdater.showToast('Ride cancelled', 'success');
            
            return true;
        } catch (error) {
            console.error('Error cancelling ride:', error);
            UIUpdater.hideLoading();
            UIUpdater.showToast('Error cancelling ride', 'error');
            return false;
        }
    },
    
    // Schedule ride
    async scheduleRide(rideData) {
        try {
            UIUpdater.showLoading('Scheduling ride...');
            
            const rideId = database.ref().child('scheduledRides').push().key;
            const ride = {
                id: rideId,
                ...rideData,
                status: 'scheduled',
                timestamp: Date.now()
            };
            
            await database.ref(`scheduledRides/${rideId}`).set(ride);
            
            AppState.scheduledRides.push(ride);
            
            // Set reminders
            this.setScheduledRideReminders([ride]);
            
            UIUpdater.hideLoading();
            UIUpdater.showToast('Ride scheduled successfully', 'success');
            
            return rideId;
        } catch (error) {
            console.error('Error scheduling ride:', error);
            UIUpdater.hideLoading();
            UIUpdater.showToast('Error scheduling ride', 'error');
            throw error;
        }
    },
    
    // Request emergency ride
    async requestEmergencyRide(rideData) {
        try {
            UIUpdater.showLoading('Requesting emergency ride...');
            
            const rideId = database.ref().child('rides').push().key;
            const ride = {
                id: rideId,
                ...rideData,
                status: 'requested',
                emergency: true,
                priority: 'high',
                timestamp: Date.now(),
                updatedAt: Date.now()
            };
            
            await database.ref(`rides/${rideId}`).set(ride);
            
            AppState.currentRide = ride;
            AppState.emergencyMode = true;
            
            UIUpdater.showRideInfo(ride);
            UIUpdater.updateTimeline('requested');
            
            // Show emergency status
            document.getElementById('emergencyStatus').style.display = 'flex';
            
            // Listen for updates
            this.listenToRideUpdates(rideId);
            
            // Send SOS alert to emergency contacts
            if (AppState.sosConfig) {
                await this.sendSOSAlert(rideId, {
                    ...rideData,
                    emergencyType: rideData.emergencyType,
                    message: `EMERGENCY: ${AppState.userData.name} requested ${rideData.emergencyType} ride`
                });
            }
            
            UIUpdater.hideLoading();
            UIUpdater.showToast('Emergency ride requested', 'success');
            
            return rideId;
        } catch (error) {
            console.error('Error requesting emergency ride:', error);
            UIUpdater.hideLoading();
            UIUpdater.showToast('Error requesting emergency ride', 'error');
            throw error;
        }
    },
    
    // Send chat message
    async sendChatMessage(rideId, message, isDriver = false) {
        try {
            const messageId = database.ref().child(`chats/${rideId}/messages`).push().key;
            const chatMessage = {
                id: messageId,
                text: message,
                senderId: isDriver ? AppState.currentRide?.driverId : AppState.currentUser.uid,
                senderName: isDriver ? AppState.selectedVehicle?.name : AppState.userData?.name,
                timestamp: Date.now(),
                isDriver: isDriver,
                status: 'sent'
            };
            
            await database.ref(`chats/${rideId}/messages/${messageId}`).set(chatMessage);
            
            // Update message status to delivered after a delay
            setTimeout(async () => {
                await database.ref(`chats/${rideId}/messages/${messageId}/status`).set('delivered');
            }, 1000);
            
            return messageId;
        } catch (error) {
            console.error('Error sending chat message:', error);
            throw error;
        }
    },
    
    // Listen to chat messages
    listenToChatMessages(rideId) {
        database.ref(`chats/${rideId}/messages`).on('child_added', (snapshot) => {
            const message = snapshot.val();
            if (message) {
                UIUpdater.showChatMessage(message, message.senderId === AppState.currentUser.uid);
                
                // Mark as read if it's from driver
                if (message.isDriver && !message.read) {
                    database.ref(`chats/${rideId}/messages/${message.id}/read`).set(true);
                }
            }
        });
        
        // Listen for typing indicators
        database.ref(`chats/${rideId}/typing`).on('value', (snapshot) => {
            const typingData = snapshot.val();
            if (typingData && typingData.driverTyping) {
                UIUpdater.updateTypingIndicator(true);
                
                // Auto-hide typing indicator after 3 seconds
                setTimeout(() => {
                    UIUpdater.updateTypingIndicator(false);
                }, 3000);
            }
        });
    },
    
    // Send typing indicator
    async sendTypingIndicator(rideId, isTyping) {
        try {
            await database.ref(`chats/${rideId}/typing/passengerTyping`).set(isTyping);
        } catch (error) {
            console.error('Error sending typing indicator:', error);
        }
    },
    
    // Save SOS configuration
    async saveSOSConfig(config) {
        try {
            await database.ref(`sosConfig/${AppState.currentUser.uid}`).set(config);
            
            AppState.sosConfig = config;
            
            // Show SOS button
            document.getElementById('sosButton').style.display = 'flex';
            
            UIUpdater.showToast('SOS configuration saved', 'success');
            return true;
        } catch (error) {
            console.error('Error saving SOS config:', error);
            UIUpdater.showToast('Error saving SOS config', 'error');
            return false;
        }
    },
    
    // Send SOS alert
    async sendSOSAlert(rideId, sosData) {
        try {
            const alertId = database.ref().child('sosAlerts').push().key;
            await database.ref(`sosAlerts/${alertId}`).set({
                ...sosData,
                alertId: alertId,
                timestamp: Date.now(),
                status: 'active'
            });
            
            // Send SMS to emergency contacts (simulated)
            if (sosData.emergencyContact1) {
                await this.sendEmergencySMS(sosData.emergencyContact1, sosData);
            }
            if (sosData.emergencyContact2) {
                await this.sendEmergencySMS(sosData.emergencyContact2, sosData);
            }
            
            // Send notification to emergency contacts via app
            const emergencyContacts = [];
            if (sosData.emergencyContact1) emergencyContacts.push(sosData.emergencyContact1);
            if (sosData.emergencyContact2) emergencyContacts.push(sosData.emergencyContact2);
            
            for (const contact of emergencyContacts) {
                // Find user by phone number
                const usersSnapshot = await database.ref('users').once('value');
                const users = usersSnapshot.val();
                
                for (const [userId, userData] of Object.entries(users)) {
                    if (userData.phone === contact) {
                        await this.sendNotification(
                            userId,
                            'SOS ALERT',
                            sosData.message,
                            'emergency'
                        );
                        break;
                    }
                }
            }
            
            UIUpdater.showToast('SOS alert sent to emergency contacts', 'success');
            return true;
        } catch (error) {
            console.error('Error sending SOS alert:', error);
            UIUpdater.showToast('Error sending SOS alert', 'error');
            return false;
        }
    },
    
    // Send emergency SMS (simulated)
    async sendEmergencySMS(phoneNumber, sosData) {
        // In a real implementation, this would call an SMS gateway API
        console.log(`Sending SMS to ${phoneNumber}: ${sosData.message}`);
        
        // Simulate SMS sending
        return new Promise(resolve => setTimeout(resolve, 1000));
    },
    
    // Send notification
    async sendNotification(userId, title, message, type = 'info') {
        try {
            const notificationId = database.ref().child(`notifications/${userId}`).push().key;
            const notification = {
                id: notificationId,
                title: title,
                message: message,
                type: type,
                read: false,
                timestamp: Date.now(),
                priority: type === 'emergency' ? 'high' : 'normal'
            };
            
            await database.ref(`notifications/${userId}/${notificationId}`).set(notification);
            return true;
        } catch (error) {
            console.error('Error sending notification:', error);
            return false;
        }
    },
    
    // Transfer money
    async transferMoney(recipientCode, amount, message = '') {
        try {
            // Find recipient by referral code
            const usersSnapshot = await database.ref('users').once('value');
            const users = usersSnapshot.val();
            let recipientId = null;
            let recipientName = '';
            
            for (const [userId, userData] of Object.entries(users)) {
                if (userData.referralCode === recipientCode) {
                    recipientId = userId;
                    recipientName = userData.name;
                    break;
                }
            }
            
            if (!recipientId) {
                throw new Error('Recipient not found. Please check the referral code.');
            }
            
            if (recipientId === AppState.currentUser.uid) {
                throw new Error('Cannot transfer money to yourself');
            }
            
            // Check sender balance
            if (AppState.walletBalance < amount) {
                throw new Error('Insufficient balance');
            }
            
            // Validate amount
            if (amount <= 0) {
                throw new Error('Amount must be greater than 0');
            }
            
            if (amount > 10000) {
                throw new Error('Maximum transfer amount is ZMW 10,000');
            }
            
            UIUpdater.showLoading('Processing transfer...');
            
            // Perform transfer in a transaction to ensure consistency
            const transactionResult = await database.ref().transaction(async (currentData) => {
                if (!currentData) return currentData;
                
                // Get current balances
                const senderBalance = currentData.users[AppState.currentUser.uid]?.walletBalance || 0;
                const recipientBalance = currentData.users[recipientId]?.walletBalance || 0;
                
                // Check sender balance again
                if (senderBalance < amount) {
                    throw new Error('Insufficient balance');
                }
                
                // Update balances
                currentData.users[AppState.currentUser.uid].walletBalance = senderBalance - amount;
                currentData.users[recipientId].walletBalance = recipientBalance + amount;
                
                // Record transaction
                const transactionId = database.ref().child('transactions').push().key;
                currentData.transactions[transactionId] = {
                    id: transactionId,
                    senderId: AppState.currentUser.uid,
                    senderName: AppState.userData.name,
                    recipientId: recipientId,
                    recipientName: recipientName,
                    amount: amount,
                    message: message,
                    timestamp: Date.now(),
                    type: 'transfer',
                    status: 'completed'
                };
                
                return currentData;
            });
            
            if (transactionResult.committed) {
                // Update local balance
                const newBalance = AppState.walletBalance - amount;
                UIUpdater.updateWalletBalance(newBalance);
                
                // Send notification to recipient
                await this.sendNotification(
                    recipientId,
                    'Money Received',
                    `You received ZMW ${amount.toFixed(2)} from ${AppState.userData.name}`,
                    'wallet'
                );
                
                // Send notification to sender
                await this.sendNotification(
                    AppState.currentUser.uid,
                    'Money Sent',
                    `You sent ZMW ${amount.toFixed(2)} to ${recipientName}`,
                    'wallet'
                );
                
                UIUpdater.hideLoading();
                UIUpdater.showToast(`ZMW ${amount.toFixed(2)} sent to ${recipientName}`, 'success');
                return true;
            } else {
                throw new Error('Transfer failed. Please try again.');
            }
        } catch (error) {
            console.error('Error transferring money:', error);
            UIUpdater.hideLoading();
            UIUpdater.showToast(error.message, 'error');
            return false;
        }
    },
    
    // Load transactions
    async loadTransactions(userId) {
        try {
            // Load sent transactions
            const sentSnapshot = await database.ref('transactions')
                .orderByChild('senderId')
                .equalTo(userId)
                .once('value');
            
            const sentTransactions = sentSnapshot.val() || {};
            
            // Load received transactions
            const receivedSnapshot = await database.ref('transactions')
                .orderByChild('recipientId')
                .equalTo(userId)
                .once('value');
            
            const receivedTransactions = receivedSnapshot.val() || {};
            
            // Combine and sort transactions
            const allTransactions = [
                ...Object.values(sentTransactions),
                ...Object.values(receivedTransactions)
            ].sort((a, b) => b.timestamp - a.timestamp);
            
            return allTransactions;
        } catch (error) {
            console.error('Error loading transactions:', error);
            return [];
        }
    },
    
    // Generate receipt
    generateReceipt: function(ride) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Add company header
        doc.setFillColor(255, 107, 53);
        doc.rect(0, 0, 210, 40, 'F');
        
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(24);
        doc.text('JUBEL', 105, 20, { align: 'center' });
        
        doc.setFontSize(12);
        doc.text('Ride Receipt', 105, 30, { align: 'center' });
        
        // Add receipt details
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(10);
        
        let yPos = 50;
        
        // Receipt number and date
        doc.text(`Receipt No: ${ride.id.substring(0, 8).toUpperCase()}`, 20, yPos);
        doc.text(`Date: ${new Date(ride.timestamp).toLocaleDateString()}`, 150, yPos);
        yPos += 10;
        
        doc.text(`Time: ${new Date(ride.timestamp).toLocaleTimeString()}`, 150, yPos);
        yPos += 15;
        
        // Passenger info
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.text('Passenger Information', 20, yPos);
        doc.setFont(undefined, 'normal');
        yPos += 7;
        
        doc.text(`Name: ${AppState.userData.name}`, 25, yPos);
        yPos += 5;
        doc.text(`Phone: ${AppState.userData.phone}`, 25, yPos);
        yPos += 5;
        doc.text(`Email: ${AppState.userData.email}`, 25, yPos);
        yPos += 10;
        
        // Ride details
        doc.setFont(undefined, 'bold');
        doc.text('Ride Details', 20, yPos);
        doc.setFont(undefined, 'normal');
        yPos += 7;
        
        doc.text(`Pickup: ${ride.pickupDisplay || ride.pickup}`, 25, yPos);
        yPos += 5;
        doc.text(`Destination: ${ride.destinationDisplay || ride.destination}`, 25, yPos);
        yPos += 5;
        
        if (ride.driverName) {
            doc.text(`Driver: ${ride.driverName}`, 25, yPos);
            yPos += 5;
        }
        
        if (ride.vehicleDetails) {
            doc.text(`Vehicle: ${ride.vehicleDetails}`, 25, yPos);
            yPos += 5;
        }
        
        doc.text(`Distance: ${ride.distance?.toFixed(1) || '0'} km`, 25, yPos);
        yPos += 5;
        
        if (ride.duration) {
            doc.text(`Duration: ${ride.duration}`, 25, yPos);
            yPos += 5;
        }
        
        // Service type
        let serviceType = 'Standard Ride';
        if (ride.emergency) serviceType = 'Emergency Ride';
        if (ride.serviceType === 'delivery') serviceType = 'Delivery';
        if (ride.serviceType === 'truck') serviceType = 'Truck Delivery';
        if (ride.serviceType === 'shopping') serviceType = 'Express Shopping';
        if (ride.sharedRide) serviceType = 'Shared Ride';
        
        doc.text(`Service: ${serviceType}`, 25, yPos);
        yPos += 5;
        
        if (ride.rideType) {
            doc.text(`Ride Type: ${ride.rideType.charAt(0).toUpperCase() + ride.rideType.slice(1)}`, 25, yPos);
            yPos += 5;
        }
        
        yPos += 5;
        
        // Fare breakdown
        doc.setFont(undefined, 'bold');
        doc.text('Fare Breakdown', 20, yPos);
        doc.setFont(undefined, 'normal');
        yPos += 7;
        
        // Calculate fare components
        const baseFare = AppState.rideTypes[ride.rideType]?.base || 20;
        const distanceFare = (ride.distance || 0) * (AppState.rideTypes[ride.rideType]?.perKm || 3);
        const surgeMultiplier = ride.surge || 1.0;
        const surgeAmount = (baseFare + distanceFare) * (surgeMultiplier - 1);
        
        doc.text(`Base Fare: ZMW ${baseFare.toFixed(2)}`, 25, yPos);
        doc.text(`ZMW ${baseFare.toFixed(2)}`, 180, yPos, { align: 'right' });
        yPos += 5;
        
        doc.text(`Distance Fare (${ride.distance?.toFixed(1) || '0'} km):`, 25, yPos);
        doc.text(`ZMW ${distanceFare.toFixed(2)}`, 180, yPos, { align: 'right' });
        yPos += 5;
        
        if (surgeMultiplier > 1) {
            doc.text(`Surge (${surgeMultiplier.toFixed(1)}x):`, 25, yPos);
            doc.text(`ZMW ${surgeAmount.toFixed(2)}`, 180, yPos, { align: 'right' });
            yPos += 5;
        }
        
        // Additional charges based on service type
        if (ride.serviceType === 'delivery' && ride.parcelValue && ride.parcelValue > 500) {
            const insurance = ride.parcelValue * 0.01;
            doc.text(`Parcel Insurance:`, 25, yPos);
            doc.text(`ZMW ${insurance.toFixed(2)}`, 180, yPos, { align: 'right' });
            yPos += 5;
        }
        
        if (ride.serviceType === 'truck' && ride.needHelpers) {
            doc.text(`Helpers Fee:`, 25, yPos);
            doc.text(`ZMW 50.00`, 180, yPos, { align: 'right' });
            yPos += 5;
        }
        
        yPos += 5;
        
        // Total
        doc.setFont(undefined, 'bold');
        doc.text('Total:', 25, yPos);
        doc.text(`ZMW ${ride.fare?.toFixed(2) || '0.00'}`, 180, yPos, { align: 'right' });
        yPos += 10;
        
        // Payment method
        doc.setFont(undefined, 'normal');
        doc.text(`Payment Method: ${ride.paymentMethod?.charAt(0).toUpperCase() + ride.paymentMethod?.slice(1)}`, 25, yPos);
        yPos += 5;
        
        doc.text(`Payment Status: Paid`, 25, yPos);
        yPos += 10;
        
        // Thank you message
        doc.setFontSize(10);
        doc.setTextColor(100, 100, 100);
        doc.text('Thank you for choosing Jubel!', 105, yPos, { align: 'center' });
        yPos += 5;
        doc.text('For any queries, contact support@jubel.co.zm', 105, yPos, { align: 'center' });
        
        // Save PDF
        doc.save(`Jubel_Receipt_${ride.id.substring(0, 8)}.pdf`);
        UIUpdater.showToast('Receipt downloaded', 'success');
    },
    
    // Get user by phone number
    async getUserByPhone(phoneNumber) {
        try {
            const usersSnapshot = await database.ref('users').once('value');
            const users = usersSnapshot.val();
            
            for (const [userId, userData] of Object.entries(users)) {
                if (userData.phone === phoneNumber) {
                    return { uid: userId, ...userData };
                }
            }
            
            return null;
        } catch (error) {
            console.error('Error getting user by phone:', error);
            return null;
        }
    },
    
    // Update user location
    async updateUserLocation(location) {
        try {
            if (!AppState.currentUser) return;
            
            await database.ref(`userLocations/${AppState.currentUser.uid}`).set({
                latitude: location.lat,
                longitude: location.lng,
                timestamp: Date.now(),
                accuracy: location.accuracy || 0
            });
            
            // Update last location update time
            AppState.realtime.lastLocationUpdate = Date.now();
        } catch (error) {
            console.error('Error updating user location:', error);
        }
    },
    
    // Start location tracking
    startLocationTracking: function() {
        if (AppState.realtime.locationUpdateInterval) {
            clearInterval(AppState.realtime.locationUpdateInterval);
        }
        
        // Update location every 30 seconds when in a ride
        AppState.realtime.locationUpdateInterval = setInterval(() => {
            if (AppState.currentRide && AppState.userLocation) {
                this.updateUserLocation(AppState.userLocation);
            }
        }, 30000);
    },
    
    // Stop location tracking
    stopLocationTracking: function() {
        if (AppState.realtime.locationUpdateInterval) {
            clearInterval(AppState.realtime.locationUpdateInterval);
            AppState.realtime.locationUpdateInterval = null;
        }
    }
};

// ============================================
// ENHANCED EVENT HANDLERS
// ============================================
function setupEventListeners() {
    // Logo click - go to home
    document.getElementById('logoContainer').addEventListener('click', () => {
        switchScreen('home');
        switchService('car');
    });
    
    // Balance badge click - go to account
    document.getElementById('balanceBadge').addEventListener('click', () => {
        switchScreen('account');
    });
    
    // Notification bell click
    document.getElementById('notificationBell').addEventListener('click', function(e) {
        e.stopPropagation();
        const dropdown = document.getElementById('notificationDropdown');
        dropdown.classList.toggle('active');
        
        // Add bell ring animation
        this.classList.add('active');
        setTimeout(() => {
            this.classList.remove('active');
        }, 500);
        
        // Mark all as read when opening
        if (dropdown.classList.contains('active')) {
            FirebaseManager.markAllNotificationsAsRead();
        }
    });
    
    // Clear all notifications
    document.getElementById('notificationClear').addEventListener('click', async function(e) {
        e.stopPropagation();
        if (confirm('Clear all notifications?')) {
            await FirebaseManager.clearAllNotifications();
            UIUpdater.showToast('Notifications cleared', 'success');
        }
    });
    
    // View all notifications
    document.getElementById('notificationViewAll').addEventListener('click', function(e) {
        e.preventDefault();
        // Could implement a full notifications screen
        UIUpdater.showToast('All notifications view coming soon', 'info');
    });
    
    // Click outside notification dropdown to close
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.notification-container')) {
            document.getElementById('notificationDropdown').classList.remove('active');
        }
    });
    
    // Navigation tabs
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const screen = this.dataset.screen;
            switchScreen(screen);
            
            // Add click animation
            this.style.transform = 'scale(0.95)';
            setTimeout(() => {
                this.style.transform = '';
            }, 100);
        });
    });
    
    // Back buttons
    document.querySelectorAll('.back-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            switchScreen('home');
        });
    });
    
    // Panel handle
    document.getElementById('panelHandle').addEventListener('click', togglePanel);
    
    // Service tabs
    document.querySelectorAll('.service-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const service = this.dataset.service;
            switchService(service);
            
            // Scroll to top of panel
            document.getElementById('mainPanel').scrollTop = 0;
        });
    });
    
    // More options dropdown
    document.getElementById('moreOptionsBtn')?.addEventListener('click', function() {
        const dropdown = document.getElementById('moreOptionsDropdown');
        dropdown.classList.toggle('active');
    });
    
    // More option items
    document.querySelectorAll('.more-option-item').forEach(item => {
        item.addEventListener('click', function() {
            const option = this.dataset.option;
            handleOptionSelection(option);
            document.getElementById('moreOptionsDropdown').classList.remove('active');
        });
    });
    
    // Click outside more options dropdown
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.service-tabs-container') && !e.target.closest('.more-options-dropdown')) {
            document.getElementById('moreOptionsDropdown').classList.remove('active');
        }
    });
    
    // Quick action buttons
    document.getElementById('scheduleRideBtn')?.addEventListener('click', () => {
        switchService('schedule');
    });
    
    document.getElementById('orderForSomeoneBtn')?.addEventListener('click', () => {
        switchService('someone');
    });
    
    document.getElementById('shareRideBtn')?.addEventListener('click', () => {
        switchService('share');
    });
    
    document.getElementById('broadcastRideBtn')?.addEventListener('click', () => {
        showModal('broadcast');
    });
    
    // Ride type selection
    document.querySelectorAll('.ride-type-card').forEach(card => {
        card.addEventListener('click', function() {
            // Remove selected class from all cards
            document.querySelectorAll('.ride-type-card').forEach(c => {
                c.classList.remove('selected');
            });
            
            // Add selected class to clicked card
            this.classList.add('selected');
            
            // Update selected ride type
            AppState.selectedRideType = this.dataset.type;
            
            // Update prices
            if (AppState.pickup && AppState.destination) {
                UIUpdater.calculateAndUpdatePrices();
            }
            
            // Add click animation
            this.style.transform = 'scale(0.98)';
            setTimeout(() => {
                this.style.transform = '';
            }, 100);
        });
    });
    
    // Ride type info
    document.getElementById('rideTypeInfo')?.addEventListener('click', function() {
        UIUpdater.showToast(
            'Economy: Affordable rides  Standard: Balanced comfort and price  Premium: Luxury experience',
            'info',
            5000
        );
    });
    
    // Truck type selection
    document.querySelectorAll('.truck-type').forEach(truck => {
        truck.addEventListener('click', function() {
            document.querySelectorAll('.truck-type').forEach(t => {
                t.classList.remove('selected');
            });
            this.classList.add('selected');
            
            // Update price calculation
            if (AppState.pickup && AppState.destination) {
                const distance = PriceCalculator.calculateDistance(
                    AppState.pickup.lat, AppState.pickup.lng,
                    AppState.destination.lat, AppState.destination.lng
                );
                const fare = UIUpdater.updateTruckPrices(distance, this.dataset.type);
                
                // Update fare display if exists
                const fareElement = document.getElementById('truckFare');
                if (fareElement) {
                    fareElement.textContent = `ZMW ${fare.fare.toFixed(2)}`;
                }
            }
        });
    });
    
    // Delivery type selection
    document.getElementById('standardDelivery')?.addEventListener('click', function() {
        document.querySelectorAll('#deliveryForm .filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        this.classList.add('active');
        
        // Update price
        if (AppState.pickup && AppState.destination) {
            UIUpdater.calculateAndUpdatePrices();
        }
    });
    
    document.getElementById('expressDelivery')?.addEventListener('click', function() {
        document.querySelectorAll('#deliveryForm .filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        this.classList.add('active');
        
        // Update price
        if (AppState.pickup && AppState.destination) {
            UIUpdater.calculateAndUpdatePrices();
        }
    });
    
    document.getElementById('sameDayDelivery')?.addEventListener('click', function() {
        document.querySelectorAll('#deliveryForm .filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        this.classList.add('active');
        
        // Update price
        if (AppState.pickup && AppState.destination) {
            UIUpdater.calculateAndUpdatePrices();
        }
    });
    
    // Location input focus
    document.querySelectorAll('input[type="text"]').forEach(input => {
        if (input.id.includes('destination') || input.id.includes('Location') || 
            input.id.includes('Pickup') || input.id.includes('pickup')) {
            
            input.addEventListener('focus', function() {
                const parent = this.closest('.location-input');
                if (parent) {
                    parent.classList.add('active');
                    
                    // Show recent searches for empty input
                    if (!this.value.trim()) {
                        const inputId = this.id;
                        const recentSearches = SearchEngine.getSearchSuggestions('');
                        UIUpdater.showSearchSuggestions(inputId, []);
                    }
                }
            });
            
            input.addEventListener('blur', function() {
                setTimeout(() => {
                    const parent = this.closest('.location-input');
                    if (parent) parent.classList.remove('active');
                }, 200);
            });
        }
    });
    
    // Enhanced search input with debounce and autocomplete
    document.querySelectorAll('input[type="text"]').forEach(input => {
        if (input.id.includes('destination') || input.id.includes('Pickup') || 
            input.id === 'shopName' || input.id.includes('Location')) {
            
            let searchTimer;
            
            input.addEventListener('input', function(e) {
                clearTimeout(searchTimer);
                
                const query = e.target.value.trim();
                if (query.length < 1) {
                    const suggestions = document.getElementById(`${this.id}Suggestions`);
                    if (suggestions) suggestions.classList.remove('active');
                    return;
                }
                
                // Show loading
                const parent = this.closest('.location-input');
                if (parent) {
                    parent.classList.add('searching');
                }
                
                searchTimer = setTimeout(async () => {
                    try {
                        // First show recent/search suggestions
                        const recentResults = SearchEngine.getSearchSuggestions(query);
                        if (recentResults.length > 0) {
                            UIUpdater.showSearchSuggestions(this.id, []);
                        } else {
                            // Then do actual search
                            const results = await SearchEngine.search(query, 'destination', AppState.userLocation);
                            UIUpdater.showSearchSuggestions(this.id, results);
                        }
                    } catch (error) {
                        console.error('Search error:', error);
                        UIUpdater.showToast('Search failed. Please try again.', 'error');
                    } finally {
                        if (parent) {
                            parent.classList.remove('searching');
                        }
                    }
                }, 300); // Reduced debounce for faster response
            });
            
            // Handle keyboard navigation
            input.addEventListener('keydown', function(e) {
                const suggestions = document.getElementById(`${this.id}Suggestions`);
                if (!suggestions || !suggestions.classList.contains('active')) return;
                
                const items = suggestions.querySelectorAll('.suggestion-item');
                if (items.length === 0) return;
                
                let currentIndex = -1;
                items.forEach((item, index) => {
                    if (item.classList.contains('highlighted')) {
                        currentIndex = index;
                        item.classList.remove('highlighted');
                    }
                });
                
                switch(e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        currentIndex = (currentIndex + 1) % items.length;
                        items[currentIndex].classList.add('highlighted');
                        items[currentIndex].scrollIntoView({ block: 'nearest' });
                        break;
                        
                    case 'ArrowUp':
                        e.preventDefault();
                        currentIndex = currentIndex <= 0 ? items.length - 1 : currentIndex - 1;
                        items[currentIndex].classList.add('highlighted');
                        items[currentIndex].scrollIntoView({ block: 'nearest' });
                        break;
                        
                    case 'Enter':
                        e.preventDefault();
                        const highlighted = suggestions.querySelector('.suggestion-item.highlighted');
                        if (highlighted) {
                            highlighted.click();
                        } else if (items.length > 0) {
                            items[0].click();
                        }
                        break;
                        
                    case 'Escape':
                        suggestions.classList.remove('active');
                        break;
                }
            });
        }
    });
    
    // Request ride button
    document.getElementById('requestRideBtn')?.addEventListener('click', async () => {
        if (!AppState.pickup || !AppState.destination) {
            UIUpdater.showToast('Please select pickup and destination locations', 'warning');
            return;
        }
        
        // Calculate distance
        const distance = PriceCalculator.calculateDistance(
            AppState.pickup.lat, AppState.pickup.lng,
            AppState.destination.lat, AppState.destination.lng
        );
        
        if (distance < 0.5) {
            UIUpdater.showToast('Minimum ride distance is 0.5 km', 'warning');
            return;
        }
        
        // Check if destination is in current city
        if (AppState.currentCity) {
            const destinationInCity = await isLocationInCity(AppState.destination, AppState.currentCity);
            if (!destinationInCity) {
                if (!confirm(`Your destination appears to be outside ${AppState.currentCity}. Continue anyway?`)) {
                    return;
                }
            }
        }
        
        // Show payment modal with ride details
        document.getElementById('paymentAmount').textContent = `ZMW ${AppState.rideFare.toFixed(2)}`;
        showModal('payment');
    });
    
    // Request delivery button
    document.getElementById('requestDeliveryBtn')?.addEventListener('click', async () => {
        const pickupInput = document.getElementById('deliveryPickup');
        const destinationInput = document.getElementById('deliveryDestination');
        const parcelDesc = document.getElementById('parcelDescription');
        const receiverName = document.getElementById('receiverName');
        const receiverPhone = document.getElementById('receiverPhone');
        const parcelValue = document.getElementById('parcelValue');
        
        if (!pickupInput.value || !destinationInput.value || !parcelDesc.value || 
            !receiverName.value || !receiverPhone.value) {
            UIUpdater.showToast('Please fill all required fields', 'warning');
            return;
        }
        
        if (!AppState.pickup || !AppState.destination) {
            UIUpdater.showToast('Please select valid pickup and delivery locations', 'warning');
            return;
        }
        
        // Validate phone number
        if (!isValidPhoneNumber(receiverPhone.value)) {
            UIUpdater.showToast('Please enter a valid phone number', 'warning');
            return;
        }
        
        const distance = PriceCalculator.calculateDistance(
            AppState.pickup.lat, AppState.pickup.lng,
            AppState.destination.lat, AppState.destination.lng
        );
        
        // Get delivery type
        let deliveryType = 'standard';
        if (document.getElementById('expressDelivery').classList.contains('active')) {
            deliveryType = 'express';
        } else if (document.getElementById('sameDayDelivery').classList.contains('active')) {
            deliveryType = 'sameDay';
        }
        
        // Calculate fare
        const fare = PriceCalculator.calculateDeliveryFare(
            distance, 
            deliveryType, 
            {
                parcelValue: parseFloat(parcelValue.value) || 0
            }
        );
        
        // Show payment modal
        document.getElementById('paymentAmount').textContent = `ZMW ${fare.toFixed(2)}`;
        showModal('payment');
        
        // Store delivery data for after payment
        window.pendingDeliveryData = {
            pickup: AppState.pickup.address,
            pickupDisplay: AppState.pickup.name,
            destination: AppState.destination.address,
            destinationDisplay: AppState.destination.name,
            pickupLat: AppState.pickup.lat,
            pickupLng: AppState.pickup.lng,
            destLat: AppState.destination.lat,
            destLng: AppState.destination.lng,
            parcelDescription: parcelDesc.value,
            receiverName: receiverName.value,
            receiverPhone: receiverPhone.value,
            parcelValue: parseFloat(parcelValue.value) || 0,
            deliveryType: deliveryType,
            fare: fare,
            distance: distance
        };
    });
    
    // Request truck button
    document.getElementById('requestTruckBtn')?.addEventListener('click', async () => {
        const pickupInput = document.getElementById('truckPickup');
        const destinationInput = document.getElementById('truckDestination');
        const itemDesc = document.getElementById('truckItemDescription');
        const estimatedWeight = document.getElementById('estimatedWeight');
        const needHelpers = document.getElementById('needHelpers')?.checked || false;
        
        if (!pickupInput.value || !destinationInput.value || !itemDesc.value || !estimatedWeight.value) {
            UIUpdater.showToast('Please fill all required fields', 'warning');
            return;
        }
        
        if (!AppState.pickup || !AppState.destination) {
            UIUpdater.showToast('Please select valid pickup and destination locations', 'warning');
            return;
        }
        
        const distance = PriceCalculator.calculateDistance(
            AppState.pickup.lat, AppState.pickup.lng,
            AppState.destination.lat, AppState.destination.lng
        );
        
        // Get selected truck type
        const selectedTruck = document.querySelector('.truck-type.selected');
        const truckType = selectedTruck ? selectedTruck.dataset.type : 'light';
        
        // Calculate fare
        const fare = PriceCalculator.calculateTruckFare(distance, truckType, {
            helpers: needHelpers,
            weight: parseFloat(estimatedWeight.value) || 0
        });
        
        // Show payment modal
        document.getElementById('paymentAmount').textContent = `ZMW ${fare.toFixed(2)}`;
        showModal('payment');
        
        // Store truck data for after payment
        window.pendingTruckData = {
            pickup: AppState.pickup.address,
            pickupDisplay: AppState.pickup.name,
            destination: AppState.destination.address,
            destinationDisplay: AppState.destination.name,
            pickupLat: AppState.pickup.lat,
            pickupLng: AppState.pickup.lng,
            destLat: AppState.destination.lat,
            destLng: AppState.destination.lng,
            truckType: truckType,
            itemDescription: itemDesc.value,
            estimatedWeight: parseFloat(estimatedWeight.value) || 0,
            needHelpers: needHelpers,
            fare: fare,
            distance: distance
        };
    });
    
    // Request shopping button
    document.getElementById('requestShoppingBtn')?.addEventListener('click', async () => {
        const shopName = document.getElementById('shopName');
        const shopLocation = document.getElementById('shopLocation');
        const destinationInput = document.getElementById('shoppingDestination');
        const instructions = document.getElementById('shoppingInstructions');
        const budget = document.getElementById('shoppingBudget');
        
        if (!shopName.value || !shopLocation.value || !destinationInput.value) {
            UIUpdater.showToast('Please fill all required fields', 'warning');
            return;
        }
        
        if (!AppState.destination) {
            UIUpdater.showToast('Please select a valid delivery location', 'warning');
            return;
        }
        
        // Calculate distance from shop to destination
        const distance = AppState.shopLocation ? 
            PriceCalculator.calculateDistance(
                AppState.shopLocation.lat, AppState.shopLocation.lng,
                AppState.destination.lat, AppState.destination.lng
            ) : 5; // Default 5km if shop location not set
        
        // Count items
        const items = Array.from(document.querySelectorAll('.item-input'))
            .map(input => input.value.trim())
            .filter(value => value.length > 0);
        
        if (items.length === 0) {
            UIUpdater.showToast('Please add at least one item to your shopping list', 'warning');
            return;
        }
        
        // Calculate fare
        const fare = PriceCalculator.calculateShoppingFare(distance, {
            itemsCount: items.length,
            budget: parseFloat(budget.value) || 0
        });
        
        // Show payment modal
        document.getElementById('paymentAmount').textContent = `ZMW ${fare.toFixed(2)}`;
        showModal('payment');
        
        // Store shopping data for after payment
        window.pendingShoppingData = {
            shopName: shopName.value,
            shopLocation: shopLocation.value,
            shopLat: AppState.shopLocation?.lat,
            shopLng: AppState.shopLocation?.lng,
            destination: AppState.destination.address,
            destinationDisplay: AppState.destination.name,
            destLat: AppState.destination.lat,
            destLng: AppState.destination.lng,
            items: items,
            instructions: instructions.value,
            estimatedBudget: parseFloat(budget.value) || 0,
            fare: fare,
            distance: distance
        };
    });
    
    // Short delivery button
    document.getElementById('requestShortDeliveryBtn')?.addEventListener('click', async () => {
        const pickupInput = document.getElementById('shortDeliveryPickup');
        const destinationInput = document.getElementById('shortDeliveryDestination');
        const parcelDesc = document.getElementById('shortParcelDescription');
        const receiverPhone = document.getElementById('shortReceiverPhone');
        
        if (!pickupInput.value || !destinationInput.value || !parcelDesc.value || !receiverPhone.value) {
            UIUpdater.showToast('Please fill all required fields', 'warning');
            return;
        }
        
        if (!AppState.pickup || !AppState.destination) {
            UIUpdater.showToast('Please select valid pickup and delivery locations', 'warning');
            return;
        }
        
        // Validate phone number
        if (!isValidPhoneNumber(receiverPhone.value)) {
            UIUpdater.showToast('Please enter a valid phone number', 'warning');
            return;
        }
        
        const distance = PriceCalculator.calculateDistance(
            AppState.pickup.lat, AppState.pickup.lng,
            AppState.destination.lat, AppState.destination.lng
        );
        
        // Calculate fare (short delivery has fixed pricing)
        const fare = Math.max(15, distance * 2.5);
        
        // Show payment modal
        document.getElementById('paymentAmount').textContent = `ZMW ${fare.toFixed(2)}`;
        showModal('payment');
        
        // Store delivery data for after payment
        window.pendingShortDeliveryData = {
            pickup: AppState.pickup.address,
            pickupDisplay: AppState.pickup.name,
            destination: AppState.destination.address,
            destinationDisplay: AppState.destination.name,
            pickupLat: AppState.pickup.lat,
            pickupLng: AppState.pickup.lng,
            destLat: AppState.destination.lat,
            destLng: AppState.destination.lng,
            parcelDescription: parcelDesc.value,
            receiverPhone: receiverPhone.value,
            fare: fare,
            distance: distance,
            serviceType: 'short-delivery'
        };
    });
    
    // Request someone else ride button
    document.getElementById('requestSomeoneRideBtn')?.addEventListener('click', async () => {
        const pickupInput = document.getElementById('someonePickup');
        const destinationInput = document.getElementById('someoneDestination');
        const recipientName = document.getElementById('someoneName');
        const recipientPhone = document.getElementById('someonePhone');
        
        if (!pickupInput.value || !destinationInput.value || !recipientName.value || !recipientPhone.value) {
            UIUpdater.showToast('Please fill all required fields', 'warning');
            return;
        }
        
        if (!AppState.pickup || !AppState.destination) {
            UIUpdater.showToast('Please select valid pickup and destination locations', 'warning');
            return;
        }
        
        // Validate phone number
        if (!isValidPhoneNumber(recipientPhone.value)) {
            UIUpdater.showToast('Please enter a valid phone number', 'warning');
            return;
        }
        
        const distance = PriceCalculator.calculateDistance(
            AppState.pickup.lat, AppState.pickup.lng,
            AppState.destination.lat, AppState.destination.lng
        );
        
        const surge = PriceCalculator.getSurgeMultiplier();
        const fare = PriceCalculator.calculateRideFare(distance, AppState.selectedRideType, { surge }).total;
        
        // Show payment modal
        document.getElementById('paymentAmount').textContent = `ZMW ${fare.toFixed(2)}`;
        showModal('payment');
        
        // Store someone else data for after payment
        window.pendingSomeoneData = {
            pickup: AppState.pickup.address,
            pickupDisplay: AppState.pickup.name,
            destination: AppState.destination.address,
            destinationDisplay: AppState.destination.name,
            pickupLat: AppState.pickup.lat,
            pickupLng: AppState.pickup.lng,
            destLat: AppState.destination.lat,
            destLng: AppState.destination.lng,
            rideType: AppState.selectedRideType,
            recipientName: recipientName.value,
            recipientPhone: recipientPhone.value,
            instructions: document.getElementById('someoneInstructions').value,
            fare: fare,
            distance: distance,
            forSomeoneElse: true
        };
    });
    
    // Request share ride button
    document.getElementById('requestShareRideBtn')?.addEventListener('click', async () => {
        const pickupInput = document.getElementById('sharePickup');
        const destinationInput = document.getElementById('shareDestination');
        const friendCode = document.getElementById('friendReferralCode');
        const splitPercentage = document.getElementById('splitPercentage').value;
        
        if (!pickupInput.value || !destinationInput.value || !friendCode.value) {
            UIUpdater.showToast('Please fill all required fields', 'warning');
            return;
        }
        
        if (!AppState.pickup || !AppState.destination) {
            UIUpdater.showToast('Please select valid pickup and destination locations', 'warning');
            return;
        }
        
        // Validate referral code format
        if (!isValidReferralCode(friendCode.value)) {
            UIUpdater.showToast('Please enter a valid Jubel referral code', 'warning');
            return;
        }
        
        const distance = PriceCalculator.calculateDistance(
            AppState.pickup.lat, AppState.pickup.lng,
            AppState.destination.lat, AppState.destination.lng
        );
        
        const calculations = UIUpdater.updateShareRideCalculations(distance, parseInt(splitPercentage));
        
        // Show payment modal for your share
        document.getElementById('paymentAmount').textContent = `ZMW ${calculations.yourShare.toFixed(2)}`;
        showModal('payment');
        
        // Store share ride data for after payment
        window.pendingShareData = {
            pickup: AppState.pickup.address,
            pickupDisplay: AppState.pickup.name,
            destination: AppState.destination.address,
            destinationDisplay: AppState.destination.name,
            pickupLat: AppState.pickup.lat,
            pickupLng: AppState.pickup.lng,
            destLat: AppState.destination.lat,
            destLng: AppState.destination.lng,
            rideType: AppState.selectedRideType,
            friendReferralCode: friendCode.value,
            splitPercentage: parseInt(splitPercentage),
            yourShare: calculations.yourShare,
            friendShare: calculations.friendShare,
            totalFare: calculations.totalFare,
            fare: calculations.yourShare, // You pay your share
            distance: distance,
            sharedRide: true
        };
    });
    
    // Confirm schedule button
    document.getElementById('confirmScheduleBtn')?.addEventListener('click', async () => {
        const pickup = document.getElementById('schedulePickup').value;
        const destination = document.getElementById('scheduleDestination').value;
        const date = document.getElementById('scheduleDate').value;
        const time = document.getElementById('scheduleTime').value;
        const forSomeone = document.getElementById('scheduleForSomeone').checked;
        const recipientName = document.getElementById('recipientName');
        const recipientPhone = document.getElementById('recipientPhone');
        
        if (!pickup || !destination || !date || !time) {
            UIUpdater.showToast('Please fill all schedule details', 'warning');
            return;
        }
        
        if (forSomeone && (!recipientName.value || !recipientPhone.value)) {
            UIUpdater.showToast('Please fill recipient details', 'warning');
            return;
        }
        
        if (forSomeone && !isValidPhoneNumber(recipientPhone.value)) {
            UIUpdater.showToast('Please enter a valid phone number for recipient', 'warning');
            return;
        }
        
        const scheduledTime = new Date(`${date}T${time}`);
        if (scheduledTime <= new Date()) {
            UIUpdater.showToast('Please select a future date and time', 'warning');
            return;
        }
        
        // Calculate fare
        const distance = AppState.pickup && AppState.destination ? 
            PriceCalculator.calculateDistance(
                AppState.pickup.lat, AppState.pickup.lng,
                AppState.destination.lat, AppState.destination.lng
            ) : 0;
        
        const surge = PriceCalculator.getSurgeMultiplier(scheduledTime);
        const fare = PriceCalculator.calculateRideFare(distance, AppState.selectedRideType, { surge, time: scheduledTime }).total;
        
        const rideData = {
    passengerId: AppState.currentUser.uid,
    passengerName: AppState.userData.name,
    pickup: AppState.pickup?.address || pickup,
    pickupDisplay: AppState.pickup?.name || pickup,
    destination: AppState.destination?.address || destination,
    destinationDisplay: AppState.destination?.name || destination,
    pickupLat: AppState.pickup?.lat,
    pickupLng: AppState.pickup?.lng,
    destLat: AppState.destination?.lat,
    destLng: AppState.destination?.lng,
    rideType: AppState.selectedRideType,
    fare: fare,
    distance: distance,
    scheduled: true,
    scheduledTime: scheduledTime.getTime(),
    status: 'scheduled'
};

if (forSomeone) {
    rideData.recipientName = recipientName.value;
    rideData.recipientPhone = recipientPhone.value;
    rideData.forSomeoneElse = true;
}

try {
    await FirebaseManager.scheduleRide(rideData);
    document.getElementById('scheduleForm').classList.remove('active');
    switchService(AppState.activeService);
    UIUpdater.showToast('Ride scheduled successfully', 'success');
} catch (error) {
    UIUpdater.showToast('Error scheduling ride', 'error');
}
});

// Emergency service selection
document.querySelectorAll('.emergency-service').forEach(service => {
    service.addEventListener('click', function() {
        const type = this.dataset.type;
        if (type === 'sos') {
            showModal('sos');
        } else {
            UIUpdater.showEmergencyReasons(type);
        }
    });
});

// Emergency reason selection
document.getElementById('emergencyReasonsGrid')?.addEventListener('click', function(e) {
    const reasonCard = e.target.closest('.emergency-reason-card');
    if (reasonCard) {
        // Remove selected class from all cards
        document.querySelectorAll('.emergency-reason-card').forEach(card => {
            card.classList.remove('selected');
        });
        
        // Add selected class to clicked card
        reasonCard.classList.add('selected');
        
        // Show other reason field if "other" is selected
        const reason = reasonCard.dataset.reason;
        document.getElementById('otherEmergencyReasonGroup').style.display = 
            reason === 'other' ? 'block' : 'none';
    }
});

// Confirm emergency button
document.getElementById('confirmEmergencyBtn')?.addEventListener('click', async () => {
    const selectedReason = document.querySelector('.emergency-reason-card.selected');
    if (!selectedReason) {
        UIUpdater.showToast('Please select an emergency reason', 'warning');
        return;
    }
    
    const serviceType = document.getElementById('emergencyServiceType').dataset.type;
    let description = selectedReason.dataset.reason;
    
    if (description === 'other') {
        const otherReason = document.getElementById('otherEmergencyReason').value.trim();
        if (!otherReason) {
            UIUpdater.showToast('Please describe the emergency', 'warning');
            return;
        }
        description = otherReason;
    }
    
    // Get selected emergency service
    const selectedService = document.querySelector('.emergency-service-item.selected');
    if (!selectedService) {
        UIUpdater.showToast('Please select an emergency service', 'warning');
        return;
    }
    
    const serviceLat = parseFloat(selectedService.dataset.lat);
    const serviceLng = parseFloat(selectedService.dataset.lng);
    const serviceName = selectedService.dataset.name;
    
    // Calculate distance
    const distance = PriceCalculator.calculateDistance(
        AppState.userLocation.lat, AppState.userLocation.lng,
        serviceLat, serviceLng
    );
    
    // Calculate fare
    const fare = PriceCalculator.calculateEmergencyFare(distance, serviceType);
    
    const rideData = {
        passengerId: AppState.currentUser.uid,
        passengerName: AppState.userData.name,
        passengerPhone: AppState.userData.phone,
        pickup: serviceName,
        pickupDisplay: serviceName,
        destination: 'Emergency Location',
        pickupLat: serviceLat,
        pickupLng: serviceLng,
        destLat: AppState.userLocation.lat,
        destLng: AppState.userLocation.lng,
        rideType: 'emergency',
        emergencyType: serviceType,
        emergencyReason: description,
        fare: fare,
        distance: distance,
        paymentMethod: 'emergency',
        priority: 'high'
    };
    
    try {
        await FirebaseManager.requestEmergencyRide(rideData);
        hideModal('emergency');
    } catch (error) {
        UIUpdater.showToast('Error requesting emergency ride', 'error');
    }
});

// SOS button
document.getElementById('sosButton').addEventListener('click', function() {
    if (!AppState.sosConfig) {
        showModal('sos');
        return;
    }
    
    if (!AppState.currentRide) {
        UIUpdater.showToast('No active ride to send SOS for', 'warning');
        return;
    }
    
    if (confirm('Send SOS alert to your emergency contacts?')) {
        const sosData = {
            passengerId: AppState.currentUser.uid,
            passengerName: AppState.userData.name,
            passengerPhone: AppState.userData.phone,
            emergencyContact1: AppState.sosConfig.contact1Phone,
            emergencyContact1Name: AppState.sosConfig.contact1Name,
            emergencyContact2: AppState.sosConfig.contact2Phone,
            emergencyContact2Name: AppState.sosConfig.contact2Name,
            message: AppState.sosConfig.message,
            rideId: AppState.currentRide.id,
            location: AppState.userLocation,
            timestamp: Date.now()
        };
        
        FirebaseManager.sendSOSAlert(AppState.currentRide.id, sosData);
    }
});

// Test SOS button
document.getElementById('testSOSBtn')?.addEventListener('click', function() {
    if (!AppState.sosConfig) {
        UIUpdater.showToast('Please save SOS configuration first', 'warning');
        return;
    }
    
    if (confirm('Send a test SOS alert?')) {
        const testData = {
            passengerId: AppState.currentUser.uid,
            passengerName: AppState.userData.name,
            passengerPhone: AppState.userData.phone,
            emergencyContact1: AppState.sosConfig.contact1Phone,
            emergencyContact1Name: AppState.sosConfig.contact1Name,
            message: 'TEST ALERT: This is a test of the SOS emergency system.',
            timestamp: Date.now(),
            test: true
        };
        
        UIUpdater.showToast('Test SOS sent (simulated)', 'success');
    }
});

// Save SOS button
document.getElementById('saveSOSBtn')?.addEventListener('click', async () => {
    const contact1Name = document.getElementById('sosContact1Name').value.trim();
    const contact1Phone = document.getElementById('sosContact1Phone').value.trim();
    const contact2Name = document.getElementById('sosContact2Name').value.trim();
    const contact2Phone = document.getElementById('sosContact2Phone').value.trim();
    const message = document.getElementById('sosMessage').value.trim();
    
    if (!contact1Name || !contact1Phone) {
        UIUpdater.showToast('Please provide primary emergency contact details', 'warning');
        return;
    }
    
    if (!isValidPhoneNumber(contact1Phone)) {
        UIUpdater.showToast('Please enter a valid primary phone number', 'warning');
        return;
    }
    
    if (contact2Phone && !isValidPhoneNumber(contact2Phone)) {
        UIUpdater.showToast('Please enter a valid secondary phone number', 'warning');
        return;
    }
    
    const config = {
        contact1Name,
        contact1Phone,
        contact2Name: contact2Name || '',
        contact2Phone: contact2Phone || '',
        message: message || 'I need help! My current location and ride details will be shared with you.'
    };
    
    await FirebaseManager.saveSOSConfig(config);
    hideModal('sos');
});

// Broadcast ride modal
document.getElementById('broadcastModal').addEventListener('click', function(e) {
    if (e.target.id === 'addBroadcastRecipient') {
        const phoneInput = document.getElementById('broadcastRecipientPhone');
        const phone = phoneInput.value.trim();
        
        if (!phone) {
            UIUpdater.showToast('Please enter a phone number', 'warning');
            return;
        }
        
        if (!isValidPhoneNumber(phone)) {
            UIUpdater.showToast('Please enter a valid phone number', 'warning');
            return;
        }
        
        // Check if already added
        if (AppState.broadcastRecipients.some(r => r.phone === phone)) {
            UIUpdater.showToast('Phone number already added', 'warning');
            return;
        }
        
        // Check if user exists
        FirebaseManager.getUserByPhone(phone).then(user => {
            if (user) {
                AppState.broadcastRecipients.push({
                    uid: user.uid,
                    phone: phone,
                    name: user.name,
                    status: 'pending'
                });
                UIUpdater.showBroadcastRecipients();
                phoneInput.value = '';
            } else {
                UIUpdater.showToast('User not found. Please enter a registered Jubel user phone number', 'warning');
            }
        });
    }
});

// Confirm broadcast button
document.getElementById('confirmBroadcastBtn')?.addEventListener('click', async () => {
    if (AppState.broadcastRecipients.length === 0) {
        UIUpdater.showToast('Please add at least one recipient', 'warning');
        return;
    }
    
    if (!AppState.pickup || !AppState.destination) {
        UIUpdater.showToast('Please select pickup and destination locations', 'warning');
        return;
    }
    
    const distance = PriceCalculator.calculateDistance(
        AppState.pickup.lat, AppState.pickup.lng,
        AppState.destination.lat, AppState.destination.lng
    );
    
    const surge = PriceCalculator.getSurgeMultiplier();
    const fare = PriceCalculator.calculateRideFare(distance, AppState.selectedRideType, { surge }).total;
    const estimatedTime = PriceCalculator.estimateTime(distance, AppState.selectedRideType);
    
    const broadcastData = {
        passengerId: AppState.currentUser.uid,
        passengerName: AppState.userData.name,
        pickup: AppState.pickup.address,
        pickupDisplay: AppState.pickup.name,
        destination: AppState.destination.address,
        destinationDisplay: AppState.destination.name,
        pickupLat: AppState.pickup.lat,
        pickupLng: AppState.pickup.lng,
        destLat: AppState.destination.lat,
        destLng: AppState.destination.lng,
        rideType: AppState.selectedRideType,
        fare: fare,
        distance: distance,
        estimatedTime: estimatedTime,
        recipients: AppState.broadcastRecipients,
        message: document.getElementById('broadcastModalMessage').value.trim() || 
                `${AppState.userData.name} invited you to join their ride to ${AppState.destination.name}`,
        timestamp: Date.now()
    };
    
    try {
        await FirebaseManager.broadcastRide(broadcastData);
        hideModal('broadcast');
        AppState.broadcastRecipients = [];
        UIUpdater.showToast('Ride broadcasted successfully', 'success');
    } catch (error) {
        UIUpdater.showToast('Error broadcasting ride', 'error');
    }
});

// Cancel ride button
document.getElementById('cancelRideBtn')?.addEventListener('click', () => {
    if (AppState.currentRide) {
        showModal('cancel');
    }
});

// Contact driver button
document.getElementById('contactDriverBtn')?.addEventListener('click', () => {
    if (AppState.currentRide?.driverId) {
        const driverPhone = AppState.selectedVehicle?.phone;
        if (driverPhone) {
            if (confirm(`Call driver ${AppState.selectedVehicle?.name} at ${driverPhone}?`)) {
                window.open(`tel:${driverPhone}`, '_blank');
            }
        } else {
            UIUpdater.showToast('Driver phone number not available', 'warning');
        }
    } else {
        UIUpdater.showToast('No driver assigned yet', 'warning');
    }
});

// Open chat button
document.getElementById('openChatBtn')?.addEventListener('click', () => {
    if (AppState.currentRide?.driverId) {
        document.getElementById('chatContainer').classList.add('active');
        UIUpdater.clearChatNotification();
        
        // Start listening to chat messages
        FirebaseManager.listenToChatMessages(AppState.currentRide.id);
    } else {
        UIUpdater.showToast('No driver assigned yet', 'warning');
    }
});

// Chat close button
document.getElementById('chatClose')?.addEventListener('click', () => {
    document.getElementById('chatContainer').classList.remove('active');
});

// Chat send button
document.getElementById('chatSend')?.addEventListener('click', async () => {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (message && AppState.currentRide) {
        try {
            await FirebaseManager.sendChatMessage(AppState.currentRide.id, message, false);
            input.value = '';
        } catch (error) {
            UIUpdater.showToast('Error sending message', 'error');
        }
    }
});

// Chat input typing indicator
document.getElementById('chatInput')?.addEventListener('input', function() {
    if (AppState.currentRide && this.value.trim()) {
        FirebaseManager.sendTypingIndicator(AppState.currentRide.id, true);
    }
});

// Chat input enter key
document.getElementById('chatInput')?.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        document.getElementById('chatSend').click();
    }
});

// Modal close buttons
document.querySelectorAll('.modal-close').forEach(btn => {
    btn.addEventListener('click', function() {
        const modal = this.dataset.modal;
        hideModal(modal);
    });
});

// Cancel reason selection
document.querySelectorAll('.cancel-reason[data-reason]').forEach(reason => {
    reason.addEventListener('click', function() {
        // Remove selected from all
        document.querySelectorAll('.cancel-reason').forEach(r => {
            r.classList.remove('selected');
        });
        
        // Add selected to clicked
        this.classList.add('selected');
        
        // Show other reason input if selected
        const reasonType = this.dataset.reason;
        document.getElementById('otherReasonGroup').style.display = 
            reasonType === 'other' ? 'block' : 'none';
    });
});

// Confirm cancel button
document.getElementById('confirmCancelBtn')?.addEventListener('click', async () => {
    const selectedReason = document.querySelector('.cancel-reason.selected');
    if (!selectedReason) {
        UIUpdater.showToast('Please select a cancellation reason', 'warning');
        return;
    }
    
    let reason = selectedReason.dataset.reason;
    if (reason === 'other') {
        const otherReason = document.getElementById('otherReason').value.trim();
        if (!otherReason) {
            UIUpdater.showToast('Please specify your reason', 'warning');
            return;
        }
        reason = `other: ${otherReason}`;
    }
    
    if (AppState.currentRide) {
        try {
            await FirebaseManager.cancelRide(AppState.currentRide.id, reason);
            hideModal('cancel');
            resetUIAfterRide();
        } catch (error) {
            UIUpdater.showToast('Error cancelling ride', 'error');
        }
    }
});

// Payment method selection
document.querySelectorAll('.payment-method').forEach(method => {
    method.addEventListener('click', function() {
        document.querySelectorAll('.payment-method').forEach(m => {
            m.classList.remove('selected');
        });
        this.classList.add('selected');
    });
});

// Confirm payment button
document.getElementById('confirmPaymentBtn')?.addEventListener('click', async () => {
    const selectedMethod = document.querySelector('.payment-method.selected');
    if (!selectedMethod) {
        UIUpdater.showToast('Please select a payment method', 'warning');
        return;
    }
    
    const paymentMethod = selectedMethod.dataset.payment;
    const amount = parseFloat(document.getElementById('paymentAmount').textContent.replace('ZMW ', ''));
    
    // Check wallet balance if paying with wallet
    if (paymentMethod === 'wallet' && AppState.walletBalance < amount) {
        UIUpdater.showToast('Insufficient wallet balance', 'error');
        return;
    }
    
    // Prepare ride data based on pending service
    let rideData = {};
    
    if (window.pendingDeliveryData) {
        rideData = {
            ...window.pendingDeliveryData,
            passengerId: AppState.currentUser.uid,
            passengerName: AppState.userData.name,
            passengerPhone: AppState.userData.phone,
            paymentMethod: paymentMethod,
            status: 'requested'
        };
        
        try {
            if (paymentMethod === 'wallet') {
                const newBalance = AppState.walletBalance - amount;
                await database.ref(`users/${AppState.currentUser.uid}/walletBalance`).set(newBalance);
                UIUpdater.updateWalletBalance(newBalance);
            }
            
            await FirebaseManager.requestDelivery(rideData);
            delete window.pendingDeliveryData;
            hideModal('payment');
            
        } catch (error) {
            UIUpdater.showToast('Error processing payment', 'error');
        }
        
    } else if (window.pendingTruckData) {
        rideData = {
            ...window.pendingTruckData,
            passengerId: AppState.currentUser.uid,
            passengerName: AppState.userData.name,
            passengerPhone: AppState.userData.phone,
            paymentMethod: paymentMethod,
            status: 'requested'
        };
        
        try {
            if (paymentMethod === 'wallet') {
                const newBalance = AppState.walletBalance - amount;
                await database.ref(`users/${AppState.currentUser.uid}/walletBalance`).set(newBalance);
                UIUpdater.updateWalletBalance(newBalance);
            }
            
            await FirebaseManager.requestTruck(rideData);
            delete window.pendingTruckData;
            hideModal('payment');
            
        } catch (error) {
            UIUpdater.showToast('Error processing payment', 'error');
        }
        
    } else if (window.pendingShoppingData) {
        rideData = {
            ...window.pendingShoppingData,
            passengerId: AppState.currentUser.uid,
            passengerName: AppState.userData.name,
            passengerPhone: AppState.userData.phone,
            paymentMethod: paymentMethod,
            status: 'requested'
        };
        
        try {
            if (paymentMethod === 'wallet') {
                const newBalance = AppState.walletBalance - amount;
                await database.ref(`users/${AppState.currentUser.uid}/walletBalance`).set(newBalance);
                UIUpdater.updateWalletBalance(newBalance);
            }
            
            await FirebaseManager.requestShopping(rideData);
            delete window.pendingShoppingData;
            hideModal('payment');
            
        } catch (error) {
            UIUpdater.showToast('Error processing payment', 'error');
        }
        
    } else if (window.pendingShortDeliveryData) {
        rideData = {
            ...window.pendingShortDeliveryData,
            passengerId: AppState.currentUser.uid,
            passengerName: AppState.userData.name,
            passengerPhone: AppState.userData.phone,
            paymentMethod: paymentMethod,
            status: 'requested'
        };
        
        try {
            if (paymentMethod === 'wallet') {
                const newBalance = AppState.walletBalance - amount;
                await database.ref(`users/${AppState.currentUser.uid}/walletBalance`).set(newBalance);
                UIUpdater.updateWalletBalance(newBalance);
            }
            
            await FirebaseManager.requestDelivery(rideData);
            delete window.pendingShortDeliveryData;
            hideModal('payment');
            
        } catch (error) {
            UIUpdater.showToast('Error processing payment', 'error');
        }
        
    } else if (window.pendingSomeoneData) {
        rideData = {
            ...window.pendingSomeoneData,
            passengerId: AppState.currentUser.uid,
            passengerName: AppState.userData.name,
            passengerPhone: AppState.userData.phone,
            paymentMethod: paymentMethod,
            status: 'requested'
        };
        
        try {
            if (paymentMethod === 'wallet') {
                const newBalance = AppState.walletBalance - amount;
                await database.ref(`users/${AppState.currentUser.uid}/walletBalance`).set(newBalance);
                UIUpdater.updateWalletBalance(newBalance);
            }
            
            await FirebaseManager.requestRide(rideData);
            delete window.pendingSomeoneData;
            hideModal('payment');
            
        } catch (error) {
            UIUpdater.showToast('Error processing payment', 'error');
        }
        
    } else if (window.pendingShareData) {
        rideData = {
            ...window.pendingShareData,
            passengerId: AppState.currentUser.uid,
            passengerName: AppState.userData.name,
            passengerPhone: AppState.userData.phone,
            paymentMethod: paymentMethod,
            status: 'requested'
        };
        
        try {
            if (paymentMethod === 'wallet') {
                const newBalance = AppState.walletBalance - amount;
                await database.ref(`users/${AppState.currentUser.uid}/walletBalance`).set(newBalance);
                UIUpdater.updateWalletBalance(newBalance);
            }
            
            await FirebaseManager.requestRide(rideData);
            delete window.pendingShareData;
            hideModal('payment');
            
        } catch (error) {
            UIUpdater.showToast('Error processing payment', 'error');
        }
        
    } else {
        // Regular car ride
        rideData = {
            passengerId: AppState.currentUser.uid,
            passengerName: AppState.userData.name,
            passengerPhone: AppState.userData.phone,
            pickup: AppState.pickup.address,
            pickupDisplay: AppState.pickup.name,
            destination: AppState.destination.address,
            destinationDisplay: AppState.destination.name,
            pickupLat: AppState.pickup.lat,
            pickupLng: AppState.pickup.lng,
            destLat: AppState.destination.lat,
            destLng: AppState.destination.lng,
            rideType: AppState.selectedRideType,
            fare: AppState.rideFare,
            distance: PriceCalculator.calculateDistance(
                AppState.pickup.lat, AppState.pickup.lng,
                AppState.destination.lat, AppState.destination.lng
            ),
            paymentMethod: paymentMethod,
            status: 'requested'
        };
        
        try {
            if (paymentMethod === 'wallet') {
                const newBalance = AppState.walletBalance - amount;
                await database.ref(`users/${AppState.currentUser.uid}/walletBalance`).set(newBalance);
                UIUpdater.updateWalletBalance(newBalance);
            }
            
            await FirebaseManager.requestRide(rideData);
            hideModal('payment');
            
        } catch (error) {
            UIUpdater.showToast('Error processing payment', 'error');
        }
    }
});

// Transfer money button
document.getElementById('transferBtn')?.addEventListener('click', () => {
    showModal('transfer');
});

// Confirm transfer button
document.getElementById('confirmTransferBtn')?.addEventListener('click', async () => {
    const recipientCode = document.getElementById('recipientCode').value.trim();
    const amount = parseFloat(document.getElementById('transferAmount').value);
    const message = document.getElementById('transferMessage').value.trim();
    
    if (!recipientCode || !amount || amount <= 0) {
        UIUpdater.showToast('Please enter valid transfer details', 'warning');
        return;
    }
    
    if (amount > AppState.walletBalance) {
        UIUpdater.showToast('Insufficient balance', 'error');
        return;
    }
    
    await FirebaseManager.transferMoney(recipientCode, amount, message);
    hideModal('transfer');
});

// Transactions button
document.getElementById('transactionsBtn')?.addEventListener('click', async () => {
    showModal('transactions');
    await loadTransactions();
});

// History filter buttons
document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        // Update active button
        document.querySelectorAll('.filter-btn').forEach(b => {
            b.classList.remove('active');
        });
        this.classList.add('active');
        
        // Update filter and reload history
        AppState.activeFilter = this.dataset.filter;
        FirebaseManager.loadRideHistory(AppState.currentUser.uid);
    });
});

// Account actions
document.getElementById('depositBtn')?.addEventListener('click', () => {
    const amount = prompt(`Enter deposit amount (ZMW). Minimum: ZMW 10`);
    if (amount && !isNaN(amount) && parseFloat(amount) >= 10) {
        const depositAmount = parseFloat(amount);
        const newBalance = AppState.walletBalance + depositAmount;
        
        database.ref(`users/${AppState.currentUser.uid}/walletBalance`).set(newBalance)
            .then(() => {
                UIUpdater.updateWalletBalance(newBalance);
                UIUpdater.showToast(`Deposited ZMW ${depositAmount.toFixed(2)}`, 'success');
                
                // Record transaction
                const transactionId = database.ref().child('transactions').push().key;
                const transaction = {
                    id: transactionId,
                    senderId: 'self',
                    senderName: 'Self',
                    recipientId: AppState.currentUser.uid,
                    recipientName: AppState.userData.name,
                    amount: depositAmount,
                    message: 'Wallet deposit',
                    timestamp: Date.now(),
                    type: 'deposit',
                    status: 'completed'
                };
                
                database.ref(`transactions/${transactionId}`).set(transaction);
            })
            .catch(error => {
                console.error('Deposit error:', error);
                UIUpdater.showToast('Error processing deposit', 'error');
            });
    } else if (amount) {
        UIUpdater.showToast('Minimum deposit amount is ZMW 10', 'warning');
    }
});

document.getElementById('withdrawBtn')?.addEventListener('click', () => {
    if (AppState.walletBalance <= 0) {
        UIUpdater.showToast('No balance to withdraw', 'warning');
        return;
    }
    
    const amount = prompt(`Enter withdrawal amount (ZMW). Available: ZMW ${AppState.walletBalance.toFixed(2)}. Minimum: ZMW 50`);
    if (amount && !isNaN(amount) && parseFloat(amount) >= 50) {
        const withdrawalAmount = parseFloat(amount);
        
        if (withdrawalAmount > AppState.walletBalance) {
            UIUpdater.showToast('Insufficient balance', 'error');
            return;
        }
        
        const newBalance = AppState.walletBalance - withdrawalAmount;
        
        database.ref(`users/${AppState.currentUser.uid}/walletBalance`).set(newBalance)
            .then(() => {
                UIUpdater.updateWalletBalance(newBalance);
                UIUpdater.showToast(`Withdrew ZMW ${withdrawalAmount.toFixed(2)}`, 'success');
                
                // Record transaction
                const transactionId = database.ref().child('transactions').push().key;
                const transaction = {
                    id: transactionId,
                    senderId: AppState.currentUser.uid,
                    senderName: AppState.userData.name,
                    recipientId: 'self',
                    recipientName: 'Self',
                    amount: withdrawalAmount,
                    message: 'Wallet withdrawal',
                    timestamp: Date.now(),
                    type: 'withdrawal',
                    status: 'completed'
                };
                
                database.ref(`transactions/${transactionId}`).set(transaction);
            })
            .catch(error => {
                console.error('Withdrawal error:', error);
                UIUpdater.showToast('Error processing withdrawal', 'error');
            });
    } else if (amount) {
        UIUpdater.showToast('Minimum withdrawal amount is ZMW 50', 'warning');
    }
});

document.getElementById('shareReferralBtn')?.addEventListener('click', () => {
    const code = document.getElementById('referralCode').textContent;
    const text = `Join me on Jubel! Use my referral code ${code} for 50% off your first ride. Download the app now!`;
    
    if (navigator.share) {
        navigator.share({
            title: 'Jubel Referral',
            text: text,
            url: window.location.href
        }).catch(() => {
            // Fallback to clipboard
            navigator.clipboard.writeText(text)
                .then(() => UIUpdater.showToast('Referral code copied to clipboard', 'success'))
                .catch(() => UIUpdater.showToast('Error copying code', 'error'));
        });
    } else {
        navigator.clipboard.writeText(text)
            .then(() => UIUpdater.showToast('Referral code copied to clipboard', 'success'))
            .catch(() => UIUpdater.showToast('Error copying code', 'error'));
    }
});

// Logout button
document.getElementById('logoutBtn')?.addEventListener('click', () => {
    if (confirm('Are you sure you want to logout?')) {
        auth.signOut().then(() => {
            window.location.href = 'signup.html';
        });
    }
});

// Map controls
document.getElementById('locateMeBtn')?.addEventListener('click', () => {
    if (AppState.userLocation) {
        map.setView([AppState.userLocation.lat, AppState.userLocation.lng], 15);
        UIUpdater.showToast('Centered on your location', 'info');
    } else {
        getCurrentLocation();
    }
});

document.getElementById('fullscreenMapBtn')?.addEventListener('click', () => {
    const mapElement = document.getElementById('map');
    mapElement.classList.toggle('fullscreen');
    
    if (mapElement.classList.contains('fullscreen')) {
        map.invalidateSize();
        UIUpdater.showToast('Fullscreen map enabled', 'info');
    } else {
        map.invalidateSize();
        UIUpdater.showToast('Fullscreen map disabled', 'info');
    }
});

document.getElementById('toggleTrafficBtn')?.addEventListener('click', function() {
    this.classList.toggle('active');
    UIUpdater.showToast('Traffic overlay ' + (this.classList.contains('active') ? 'enabled' : 'disabled'), 'info');
});

// Tracking close button
document.getElementById('trackingClose')?.addEventListener('click', () => {
    document.getElementById('liveTrackingContainer').classList.remove('active');
});

// Click outside suggestion lists to close them
document.addEventListener('click', (e) => {
    if (!e.target.closest('.location-input') && !e.target.closest('.suggestion-list')) {
        document.querySelectorAll('.suggestion-list').forEach(list => {
            list.classList.remove('active');
        });
    }
});

// Escape key to close modals and dropdowns
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        hideAllModals();
        document.getElementById('notificationDropdown').classList.remove('active');
        document.getElementById('moreOptionsDropdown').classList.remove('active');
        document.querySelectorAll('.suggestion-list').forEach(list => {
            list.classList.remove('active');
        });
    }
});

// Network status monitoring
window.addEventListener('online', () => {
    AppState.networkStatus = 'online';
    UIUpdater.showNetworkStatus('online');
    UIUpdater.showToast('You are back online', 'success');
});

window.addEventListener('offline', () => {
    AppState.networkStatus = 'offline';
    UIUpdater.showNetworkStatus('offline');
    UIUpdater.showToast('You are offline. Some features may not work.', 'warning');
});

// Battery saver detection
if ('getBattery' in navigator) {
    navigator.getBattery().then(battery => {
        battery.addEventListener('levelchange', () => {
            if (battery.level < 0.2 && !battery.charging) {
                UIUpdater.showBatterySaver();
            }
        });
    });
}

// Page visibility API for background updates
document.addEventListener('visibilitychange', () => {
    if (!document.hidden && AppState.currentUser) {
        // Refresh data when page becomes visible
        FirebaseManager.loadUserData(AppState.currentUser.uid);
    }
});

// Prevent pull-to-refresh on mobile
document.addEventListener('touchmove', function(e) {
    if (e.scale !== 1) {
        e.preventDefault();
    }
}, { passive: false });

// Service worker for PWA
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
            .then(registration => {
                console.log('ServiceWorker registration successful');
            })
            .catch(err => {
                console.log('ServiceWorker registration failed: ', err);
            });
    });
}
}

// ============================================
// HELPER FUNCTIONS
// ============================================

function switchScreen(screen) {
// Hide all screens
document.querySelectorAll('.history-screen, .account-screen, .emergency-screen').forEach(s => {
    s.classList.remove('active');
});

// Update navigation tabs
document.querySelectorAll('.nav-tab').forEach(tab => {
    tab.classList.remove('active');
});

// Show selected screen
if (screen === 'home') {
    AppState.activeScreen = 'home';
    document.querySelector(`.nav-tab[data-screen="home"]`).classList.add('active');
} else {
    document.getElementById(`${screen}Screen`).classList.add('active');
    document.querySelector(`.nav-tab[data-screen="${screen}"]`).classList.add('active');
    AppState.activeScreen = screen;
    
    // Load data for specific screens
    if (screen === 'history') {
        FirebaseManager.loadRideHistory(AppState.currentUser.uid);
    }
}
}

function switchService(service) {
// Hide all forms
document.querySelectorAll('.ride-request-form, .service-form, .schedule-form, .more-options').forEach(form => {
    form.style.display = 'none';
    form.classList.remove('active');
});

// Update service tabs
document.querySelectorAll('.service-tab').forEach(tab => {
    tab.classList.remove('active');
});

// Show selected service form
AppState.activeService = service;

switch(service) {
    case 'car':
        document.querySelector('.service-tab.car').classList.add('active');
        document.getElementById('carForm').style.display = 'block';
        break;
    case 'delivery':
        document.querySelector('.service-tab.delivery').classList.add('active');
        document.getElementById('deliveryForm').style.display = 'block';
        document.getElementById('deliveryForm').classList.add('active');
        break;
    case 'short-delivery':
        document.querySelector('.service-tab.short-delivery').classList.add('active');
        document.getElementById('shortDeliveryForm').style.display = 'block';
        document.getElementById('shortDeliveryForm').classList.add('active');
        break;
    case 'express':
        document.querySelector('.service-tab[data-service="express"]').classList.add('active');
        document.getElementById('expressForm').style.display = 'block';
        document.getElementById('expressForm').classList.add('active');
        break;
    case 'truck':
        document.querySelector('.service-tab[data-service="truck"]').classList.add('active');
        document.getElementById('truckForm').style.display = 'block';
        document.getElementById('truckForm').classList.add('active');
        break;
    case 'someone':
        document.getElementById('someoneElseForm').style.display = 'block';
        document.getElementById('someoneElseForm').classList.add('active');
        break;
    case 'share':
        document.getElementById('shareRideForm').style.display = 'block';
        document.getElementById('shareRideForm').classList.add('active');
        break;
    case 'broadcast':
        showModal('broadcast');
        break;
    case 'schedule':
        document.getElementById('scheduleForm').classList.add('active');
        break;
}
}

async function loadTransactions() {
const transactions = await FirebaseManager.loadTransactions(AppState.currentUser.uid);
const container = document.getElementById('transactionsList');

if (transactions.length === 0) {
    container.innerHTML = `
        <div class="empty-state" style="padding: 30px 0;">
            <div class="empty-icon">
                <i class="fas fa-receipt"></i>
            </div>
            <div class="empty-title">No transactions yet</div>
            <div class="empty-message">Your wallet transactions will appear here</div>
        </div>
    `;
    return;
}

let html = '';
transactions.forEach(transaction => {
    const isSent = transaction.senderId === AppState.currentUser.uid;
    const date = new Date(transaction.timestamp);
    
    html += `
        <div class="history-item" style="margin-bottom: 10px;">
            <div class="history-header">
                <div class="history-type">
                    <div class="history-icon" style="background: ${isSent ? 'var(--error-red)' : 'var(--success-green)'}">
                        <i class="fas fa-${isSent ?                        <i class="fas fa-${isSent ? 'arrow-up' : 'arrow-down'}"></i>
                    </div>
                    <div class="history-type-name">
                        ${isSent ? 'Money Sent' : 'Money Received'}
                    </div>
                </div>
                <div class="history-date">
                    ${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                </div>
            </div>
            
            <div class="history-locations">
                <div class="history-location">
                    <i class="fas fa-user"></i>
                    <div class="history-location-text">
                        ${isSent ? `To: ${transaction.recipientName}` : `From: ${transaction.senderName}`}
                    </div>
                </div>
                <div class="history-location">
                    <i class="fas fa-comment"></i>
                    <div class="history-location-text">${transaction.message || 'No message'}</div>
                </div>
            </div>
            
            <div class="history-footer">
                <div class="history-price" style="color: ${isSent ? 'var(--error-red)' : 'var(--success-green)'}">
                    ${isSent ? '-' : '+'}ZMW ${transaction.amount.toFixed(2)}
                </div>
                <div class="history-status status-completed">
                    Completed
                </div>
            </div>
        </div>
    `;
});

container.innerHTML = html;
}

function showModal(modalId) {
const modal = document.getElementById(modalId + 'Modal');
if (modal) {
    modal.style.display = 'flex';
    
    // Add animation
    setTimeout(() => {
        modal.querySelector('.modal').style.transform = 'translateY(0)';
        modal.querySelector('.modal').style.opacity = '1';
    }, 10);
    
    // Close modal on overlay click
    modal.addEventListener('click', function(e) {
        if (e.target === this) {
            hideModal(modalId);
        }
    }, { once: true });
    
    // Handle escape key
    const escapeHandler = (e) => {
        if (e.key === 'Escape') {
            hideModal(modalId);
            document.removeEventListener('keydown', escapeHandler);
        }
    };
    document.addEventListener('keydown', escapeHandler);
}
}

function hideModal(modalId) {
const modal = document.getElementById(modalId + 'Modal');
if (modal) {
    modal.querySelector('.modal').style.transform = 'translateY(-20px)';
    modal.querySelector('.modal').style.opacity = '0';
    
    setTimeout(() => {
        modal.style.display = 'none';
    }, 300);
    
    // Clear any pending data
    if (modalId === 'payment') {
        delete window.pendingDeliveryData;
        delete window.pendingTruckData;
        delete window.pendingShoppingData;
        delete window.pendingShortDeliveryData;
        delete window.pendingSomeoneData;
        delete window.pendingShareData;
    }
}
}

function hideAllModals() {
document.querySelectorAll('.modal-overlay').forEach(modal => {
    modal.style.display = 'none';
});
}

function togglePanel() {
const panel = document.getElementById('mainPanel');
panel.classList.toggle('collapsed');
}

function resetUIAfterRide() {
// Reset AppState
AppState.currentRide = null;
AppState.selectedVehicle = null;
AppState.driverLocation = null;
AppState.emergencyMode = false;

// Hide ride info panel
const rideInfoPanel = document.getElementById('rideInfoPanel');
if (rideInfoPanel) {
    rideInfoPanel.style.display = 'none';
}

// Hide emergency status
document.getElementById('emergencyStatus').style.display = 'none';

// Hide SOS button
document.getElementById('sosButton').style.display = 'none';

// Hide ride status bar
document.getElementById('rideStatusBar').classList.remove('active');

// Show home screen
switchService(AppState.activeService);

// Clear chat
document.getElementById('chatMessages').innerHTML = '';
document.getElementById('chatContainer').classList.remove('active');

// Stop location tracking
FirebaseManager.stopLocationTracking();

// Clear driver marker
if (window.driverMarker) {
    map.removeLayer(window.driverMarker);
    window.driverMarker = null;
}

// Clear route
if (window.routeLayer) {
    map.removeLayer(window.routeLayer);
    window.routeLayer = null;
}
}

async function isLocationInCity(location, cityName) {
try {
    const response = await fetch(
        `https://nominatim.openstreetmap.org/reverse?format=json&lat=${location.lat}&lon=${location.lng}&zoom=10`
    );
    const data = await response.json();
    
    if (data && data.address) {
        const city = data.address.city || data.address.town || data.address.village;
        return city && city.toLowerCase().includes(cityName.toLowerCase());
    }
    return false;
} catch (error) {
    console.error('Error checking city:', error);
    return false;
}
}

async function reverseGeocode(lat, lng) {
try {
    const response = await fetch(
        `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18`
    );
    const data = await response.json();
    
    if (data && data.display_name) {
        return data.display_name.split(',').slice(0, 3).join(',');
    }
    return `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
} catch (error) {
    console.error('Reverse geocode error:', error);
    return `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
}
}

function isValidPhoneNumber(phone) {
// Basic phone validation for Zambian numbers
const phoneRegex = /^\+?260?\d{9}$/;
return phoneRegex.test(phone.replace(/\s/g, ''));
}

function isValidReferralCode(code) {
// Jubel referral codes are like JUBEL-XXXX
const referralRegex = /^JUBEL-[A-Z0-9]{4}$/;
return referralRegex.test(code);
}

function handleOptionSelection(option) {
switch(option) {
    case 'sos':
        showModal('sos');
        break;
    case 'transfer':
        showModal('transfer');
        break;
    case 'settings':
        UIUpdater.showToast('Settings coming soon', 'info');
        break;
    case 'help':
        UIUpdater.showToast('Help center coming soon', 'info');
        break;
}
}

// Add item button for shopping list
document.getElementById('addItemBtn')?.addEventListener('click', function() {
const itemList = document.getElementById('shoppingItems');
const newItem = document.createElement('div');
newItem.className = 'item-entry';
newItem.innerHTML = `
    <input type="text" class="item-input" placeholder="Item name">
    <button class="remove-item hover-effect" type="button">
        <i class="fas fa-times"></i>
    </button>
`;

itemList.appendChild(newItem);

// Add remove functionality
newItem.querySelector('.remove-item').addEventListener('click', function() {
    itemList.removeChild(newItem);
});
});

// Schedule for someone checkbox
document.getElementById('scheduleForSomeone')?.addEventListener('change', function() {
const detailsDiv = document.getElementById('someoneElseDetails');
detailsDiv.style.display = this.checked ? 'block' : 'none';
});

// Set minimum date for schedule
const scheduleDate = document.getElementById('scheduleDate');
if (scheduleDate) {
const today = new Date();
const tomorrow = new Date(today);
tomorrow.setDate(tomorrow.getDate() + 1);
scheduleDate.min = tomorrow.toISOString().split('T')[0];
}

// ============================================
// ENHANCED MAP INITIALIZATION WITH MULTIPLE FEATURES
// ============================================
let map;
let userMarker;

async function initMap() {
try {
    // Initialize map centered on Zambia
    map = L.map('map').setView([-15.3875, 28.3228], 13);
    
    // Add tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: ' OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(map);
    
    // Add fullscreen control
    map.addControl(new L.Control.Fullscreen());
    
    // Add geocoder control
    L.Control.geocoder({
        defaultMarkGeocode: false,
        placeholder: 'Search locations...',
        errorMessage: 'Nothing found.',
        showResultIcons: true,
        collapsed: true,
        position: 'topright'
    }).on('markgeocode', function(e) {
        const { center, name } = e.geocode;
        map.setView(center, 15);
        
        // Add marker for searched location
        if (window.searchMarker) {
            map.removeLayer(window.searchMarker);
        }
        
        window.searchMarker = L.marker(center, {
            icon: L.divIcon({
                className: 'destination-marker',
                html: '<i class="fas fa-search"></i>',
                iconSize: [22, 22]
            })
        }).addTo(map).bindPopup(`<strong>${name}</strong>`).openPopup();
    }).addTo(map);
    
    // Get user's location
    await getCurrentLocation();
    
    // Initialize search engine with user's city
    SearchEngine.initialize(AppState.userLocation);
    
    // Initialize emergency locator
    EmergencyLocator.initialize(AppState.currentCity);
    
    // Set up periodic location updates
    setInterval(() => {
        if (AppState.userLocation) {
            FirebaseManager.updateUserLocation(AppState.userLocation);
        }
    }, 60000); // Update every minute
    
} catch (error) {
    console.error('Map initialization error:', error);
    UIUpdater.showToast('Error initializing map. Please refresh the page.', 'error');
}
}

async function getCurrentLocation() {
if (!navigator.geolocation) {
    UIUpdater.showToast('Geolocation is not supported by your browser', 'error');
    return;
}

try {
    const position = await new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(resolve, reject, {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        });
    });
    
    const { latitude, longitude, accuracy } = position.coords;
    
    AppState.userLocation = {
        lat: latitude,
        lng: longitude,
        accuracy: accuracy
    };
    
    // Reverse geocode to get address
    const address = await reverseGeocode(latitude, longitude);
    
    // Update pickup input
    const pickupInput = document.getElementById('pickupLocation');
    if (pickupInput) {
        pickupInput.value = address;
        
        // Update AppState
        AppState.pickup = {
            lat: latitude,
            lng: longitude,
            address: address,
            name: 'Current Location'
        };
    }
    
    // Set map view to user's location
    if (map) {
        map.setView([latitude, longitude], 15);
        
        // Add or update user marker
        if (userMarker) {
            userMarker.setLatLng([latitude, longitude]);
        } else {
            userMarker = L.marker([latitude, longitude], {
                icon: L.divIcon({
                    className: 'current-location-marker',
                    html: '<i class="fas fa-location-arrow"></i>',
                    iconSize: [20, 20]
                })
            }).addTo(map).bindPopup('<strong>Your Location</strong>');
        }
        
        // Add accuracy circle
        L.circle([latitude, longitude], {
            color: 'var(--info-blue)',
            fillColor: 'var(--info-blue)',
            fillOpacity: 0.2,
            radius: accuracy
        }).addTo(map);
    }
    
    // Get city name for search restrictions
    const cityResponse = await fetch(
        `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=10`
    );
    const cityData = await cityResponse.json();
    
    if (cityData && cityData.address) {
        AppState.currentCity = cityData.address.city || cityData.address.town || cityData.address.village || 'Lusaka';
        AppState.detectedCity = AppState.currentCity;
        
        // Update search engine with city
        SearchEngine.initialize(AppState.userLocation);
        
        // Show welcome message with city
        UIUpdater.showToast(`Welcome to Jubel in ${AppState.currentCity}!`, 'success');
    }
    
    // Update location accuracy indicator
    updateLocationAccuracy(accuracy);
    
} catch (error) {
    console.error('Error getting location:', error);
    
    // Fallback to Lusaka coordinates
    AppState.userLocation = {
        lat: -15.4167,
        lng: 28.2833,
        accuracy: 1000
    };
    
    if (map) {
        map.setView([-15.4167, 28.2833], 13);
    }
    
    UIUpdater.showToast('Using approximate location. Enable location for better accuracy.', 'warning');
}
}

function updateLocationAccuracy(accuracy) {
const accuracyElement = document.createElement('div');
accuracyElement.className = 'location-accuracy';
accuracyElement.innerHTML = `
    <div class="accuracy-dot ${accuracy < 50 ? 'high' : accuracy < 200 ? 'medium' : 'low'}"></div>
    <span>Location accuracy: ${accuracy < 50 ? 'High' : accuracy < 200 ? 'Medium' : 'Low'} (${Math.round(accuracy)}m)</span>
`;

// Remove existing accuracy indicator
const existing = document.querySelector('.location-accuracy');
if (existing) existing.remove();

// Add to top bar
document.querySelector('.top-bar').appendChild(accuracyElement);
}

// ============================================
// FIREBASE AUTHENTICATION & INITIALIZATION
// ============================================
async function initAuth() {
try {
    // Check if user is already signed in
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            AppState.currentUser = user;
            console.log('User signed in:', user.uid);
            
            // Load user data
            await FirebaseManager.loadUserData(user.uid);
            
            // Initialize map
            await initMap();
            
            // Setup event listeners
            setupEventListeners();
            
            // Start location tracking
            FirebaseManager.startLocationTracking();
            
            // Request notification permission
            requestNotificationPermission();
            
        } else {
            // No user signed in, redirect to signup
            window.location.href = 'signup.html';
        }
    });
    
} catch (error) {
    console.error('Auth initialization error:', error);
    UIUpdater.showToast('Authentication error. Please refresh.', 'error');
}
}

async function requestNotificationPermission() {
if ('Notification' in window && Notification.permission === 'default') {
    try {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
            console.log('Notification permission granted');
            
            // Initialize Firebase Cloud Messaging if available
            if (messaging) {
                try {
                    const token = await messaging.getToken({
                        vapidKey: 'YOUR_VAPID_KEY_HERE' // Add your VAPID key
                    });
                    console.log('FCM Token:', token);
                    
                    // Save token to Firebase
                    if (AppState.currentUser) {
                        await database.ref(`users/${AppState.currentUser.uid}/fcmToken`).set(token);
                    }
                } catch (fcmError) {
                    console.error('FCM Error:', fcmError);
                }
            }
        }
    } catch (error) {
        console.error('Notification permission error:', error);
    }
}
}

// ============================================
// ADDITIONAL ENHANCEMENTS
// ============================================

// Performance monitoring
function trackPerformance() {
const appLoadTime = Date.now() - AppState.performance.appStartTime;
console.log(`App loaded in ${appLoadTime}ms`);

// Log performance metrics
console.log('Performance metrics:', {
    searchResponseTime: AppState.performance.searchResponseTime,
    geocodeResponseTime: AppState.performance.geocodeResponseTime,
    mapLoadTime: AppState.performance.mapLoadTime
});

// Send to analytics if needed
if (appLoadTime > 3000) {
    console.warn('App load time is high');
}
}

// Offline capabilities
function setupOfflineCapabilities() {
// Cache important data
if ('caches' in window) {
    caches.open('jubel-cache').then(cache => {
        cache.addAll([
            '/',
            '/index.html',
            '/styles.css',
            '/app.js',
            'https://unpkg.com/leaflet@1.7.1/dist/leaflet.css',
            'https://unpkg.com/leaflet@1.7.1/dist/leaflet.js'
        ]);
    });
}

// Handle offline storage
if ('indexedDB' in window) {
    const dbRequest = indexedDB.open('jubelDB', 1);
    
    dbRequest.onupgradeneeded = function(event) {
        const db = event.target.result;
        
        // Create object stores
        if (!db.objectStoreNames.contains('rides')) {
            db.createObjectStore('rides', { keyPath: 'id' });
        }
        
        if (!db.objectStoreNames.contains('favorites')) {
            db.createObjectStore('favorites', { keyPath: 'id' });
        }
    };
}
}

// Accessibility enhancements
function setupAccessibility() {
// Add aria labels to interactive elements
document.querySelectorAll('button, [role="button"]').forEach(button => {
    if (!button.getAttribute('aria-label')) {
        const label = button.textContent || button.title || 'Button';
        button.setAttribute('aria-label', label);
    }
});

// Handle focus management
document.addEventListener('keydown', (e) => {
    if (e.key === 'Tab') {
        // Ensure focus is visible
        document.documentElement.classList.add('keyboard-nav');
    }
});

document.addEventListener('mousedown', () => {
    document.documentElement.classList.remove('keyboard-nav');
});

// Skip to main content link
const skipLink = document.createElement('a');
skipLink.href = '#mainPanel';
skipLink.className = 'skip-link';
skipLink.textContent = 'Skip to main content';
skipLink.addEventListener('click', (e) => {
    e.preventDefault();
    document.getElementById('mainPanel').focus();
});
document.body.insertBefore(skipLink, document.body.firstChild);
}

// Error handling
window.addEventListener('error', function(event) {
console.error('Global error:', event.error);
UIUpdater.showToast('An error occurred. Please try again.', 'error');
});

window.addEventListener('unhandledrejection', function(event) {
console.error('Unhandled promise rejection:', event.reason);
UIUpdater.showToast('An error occurred. Please try again.', 'error');
});

// Battery optimization
function setupBatteryOptimization() {
if ('getBattery' in navigator) {
    navigator.getBattery().then(battery => {
        battery.addEventListener('levelchange', () => {
            if (battery.level < 0.3 && !battery.charging) {
                // Reduce animation intensity
                document.body.classList.add('battery-saver-mode');
                UIUpdater.showBatterySaver();
            } else {
                document.body.classList.remove('battery-saver-mode');
            }
        });
        
        battery.addEventListener('chargingchange', () => {
            if (battery.charging) {
                document.body.classList.remove('battery-saver-mode');
            }
        });
    });
}
}

// Network optimization
function optimizeNetworkUsage() {
// Reduce update frequency when on slow connections
if ('connection' in navigator) {
    const connection = navigator.connection;
    
    if (connection.saveData || connection.effectiveType.includes('2g')) {
        // Reduce polling intervals
        AppState.realtime.batterySaver = true;
        
        // Reduce map tile quality
        if (map) {
            map.eachLayer(layer => {
                if (layer instanceof L.TileLayer) {
                    layer.setUrl(layer._url.replace('{s}.tile', '{s}-lite.tile'));
                }
            });
        }
    }
}
}

// ============================================
// INITIALIZE APPLICATION
// ============================================
document.addEventListener('DOMContentLoaded', async () => {
try {
    // Show loading overlay
    UIUpdater.showLoading('Initializing Jubel...');
    
    // Setup accessibility
    setupAccessibility();
    
    // Setup offline capabilities
    setupOfflineCapabilities();
    
    // Setup battery optimization
    setupBatteryOptimization();
    
    // Setup network optimization
    optimizeNetworkUsage();
    
    // Initialize authentication
    await initAuth();
    
    // Hide loading overlay
    setTimeout(() => {
        UIUpdater.hideLoading();
        
        // Track performance
        trackPerformance();
        
        // Show welcome message
        setTimeout(() => {
            UIUpdater.showToast('Jubel is ready! Start your journey.', 'success');
        }, 1000);
    }, 2000);
    
} catch (error) {
    console.error('Application initialization error:', error);
    UIUpdater.hideLoading();
    UIUpdater.showToast('Failed to initialize app. Please refresh.', 'error');
}
});

// Export for debugging
window.AppState = AppState;
window.FirebaseManager = FirebaseManager;
window.UIUpdater = UIUpdater;
window.PriceCalculator = PriceCalculator;
window.SearchEngine = SearchEngine;
window.EmergencyLocator = EmergencyLocator;

// Helper functions for global access
window.switchScreen = switchScreen;
window.switchService = switchService;
window.showModal = showModal;
window.hideModal = hideModal;
window.resetUIAfterRide = resetUIAfterRide;
</script>
</body>
</html>
