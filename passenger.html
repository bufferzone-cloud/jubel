<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jubel - Passenger</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-orange: #FF6B35;
            --primary-red: #E74C3C;
            --primary-gradient: linear-gradient(135deg, #FF6B35, #E74C3C);
            --secondary-orange: #E55A28;
            --secondary-red: #C0392B;
            --light-orange: #FFE8E0;
            --light-red: #FADBD8;
            --white: #FFFFFF;
            --light-gray: #F5F5F5;
            --dark-gray: #333333;
            --medium-gray: #777777;
            --success-green: #2ecc71;
            --warning-yellow: #f39c12;
            --info-blue: #3498db;
            --error-red: #e74c3c;
            --border-color: #E8E8E8;
            --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 4px 15px rgba(0, 0, 0, 0.15);
            --shadow-heavy: 0 6px 20px rgba(0, 0, 0, 0.2);
            --app-padding: 10px;
            --element-radius: 6px;
            --transition-speed: 0.3s;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--white);
            color: var(--dark-gray);
            max-width: 100%;
            overflow-x: hidden;
            height: 100vh;
            font-size: 13px;
        }
        
        /* Main App */
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        .floating-balance {
            position: fixed;
            top: 10px;
            right: 10px;
            background: var(--white);
            padding: 6px 10px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 700;
            color: var(--dark-gray);
            border: 2px solid var(--primary-orange);
            font-size: 0.75rem;
        }
        
        .balance-amount {
            color: var(--primary-orange);
            font-size: 0.8rem;
        }
        
        .passenger-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            border-radius: 15px 15px 0 0;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
            z-index: 100;
            padding: var(--app-padding);
            transform: translateY(0);
            transition: transform var(--transition-speed) ease;
            max-height: 45vh;
            overflow-y: auto;
        }
        
        .passenger-panel.collapsed {
            transform: translateY(calc(100% - 40px));
        }
        
        .panel-collapse-handle {
            width: 35px;
            height: 3px;
            background: var(--border-color);
            border-radius: 2px;
            margin: 0 auto 8px;
            cursor: pointer;
        }
        
        .nav-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            padding: 6px 3px;
            border-radius: var(--element-radius);
            background: var(--light-gray);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            border: none;
            font-size: 0.6rem;
            font-weight: 600;
        }
        
        .nav-btn.active {
            background: var(--primary-gradient);
            color: var(--white);
        }
        
        .nav-btn i {
            font-size: 0.8rem;
        }
        
        .ride-request-form {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .location-input {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--white);
            position: relative;
        }
        
        .location-input i {
            color: var(--primary-orange);
        }
        
        .location-input input {
            border: none;
            outline: none;
            width: 100%;
            font-size: 0.8rem;
        }
        
        .vehicle-selection {
            display: flex;
            gap: 6px;
            margin: 8px 0;
        }
        
        .vehicle-option {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 4px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .vehicle-option.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .vehicle-icon {
            font-size: 1rem;
            color: var(--medium-gray);
        }
        
        .vehicle-option.selected .vehicle-icon {
            color: var(--primary-orange);
        }
        
        .vehicle-name {
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .vehicle-price {
            font-size: 0.65rem;
            color: var(--medium-gray);
        }
        
        .promo-section {
            margin-top: 8px;
            padding: 8px;
            border: 1px dashed var(--border-color);
            border-radius: var(--element-radius);
            display: none;
        }
        
        .promo-section.active {
            display: block;
        }
        
        .promo-input {
            display: flex;
            gap: 6px;
        }
        
        .promo-input input {
            flex: 1;
            padding: 6px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 0.75rem;
        }
        
        .btn-promo {
            background: var(--primary-orange);
            color: var(--white);
            border: none;
            border-radius: var(--element-radius);
            padding: 6px 10px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .promo-toggle {
            width: 100%;
            padding: 6px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .fare-display {
            background: var(--primary-gradient);
            color: var(--white);
            padding: 10px;
            border-radius: var(--element-radius);
            text-align: center;
            margin: 8px 0;
            box-shadow: var(--shadow-medium);
        }
        
        .fare-amount {
            font-size: 1.5rem;
            font-weight: 800;
            margin: 4px 0;
        }
        
        .eta-display {
            font-size: 0.9rem;
            font-weight: 600;
            opacity: 0.9;
        }
        
        .request-ride-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: var(--element-radius);
            background: var(--primary-gradient);
            color: var(--white);
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            margin-top: 8px;
            box-shadow: var(--shadow-medium);
        }
        
        .request-ride-btn:disabled {
            background: var(--medium-gray);
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .ride-info-panel {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 10px;
            box-shadow: var(--shadow-medium);
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            display: none;
        }
        
        .driver-info {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .driver-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            color: var(--white);
            font-weight: 700;
        }
        
        .driver-details h2 {
            font-size: 0.85rem;
            margin-bottom: 2px;
        }
        
        .driver-details p {
            color: var(--medium-gray);
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 3px;
            font-size: 0.7rem;
        }
        
        .trip-details {
            margin-bottom: 10px;
        }
        
        .location-row {
            display: flex;
            align-items: flex-start;
            gap: 5px;
            margin-bottom: 8px;
        }
        
        .location-icon {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            flex-shrink: 0;
        }
        
        .pickup-icon {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .destination-icon {
            background: var(--primary-red);
            color: var(--white);
        }
        
        .location-text {
            flex: 1;
        }
        
        .location-text h4 {
            font-size: 0.8rem;
            margin-bottom: 2px;
        }
        
        .location-text p {
            color: var(--medium-gray);
            font-size: 0.7rem;
        }
        
        .fare-details {
            background: var(--light-orange);
            padding: 8px;
            border-radius: var(--element-radius);
            margin-bottom: 10px;
        }
        
        .fare-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 0.7rem;
        }
        
        .fare-row.total {
            font-weight: 700;
            font-size: 0.8rem;
            border-top: 1px solid var(--border-color);
            padding-top: 5px;
            margin-top: 5px;
        }
        
        .ride-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }
        
        .btn {
            padding: 8px;
            border: none;
            border-radius: var(--element-radius);
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .btn-cancel {
            background: var(--error-red);
            color: var(--white);
        }
        
        .btn-contact {
            background: var(--info-blue);
            color: var(--white);
        }
        
        .screen-content {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 50px;
            background: var(--white);
            z-index: 90;
            padding: var(--app-padding);
            overflow-y: auto;
            display: none;
        }
        
        .screen-content.active {
            display: block;
        }
        
        .screen-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .back-button {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            font-size: 0.9rem;
        }
        
        .screen-title {
            font-size: 1rem;
            font-weight: 700;
        }
        
        .account-section, .history-section, .payments-section {
            margin-bottom: 15px;
        }
        
        .section-title {
            font-size: 0.85rem;
            margin-bottom: 8px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .input-group {
            margin-bottom: 8px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 600;
            font-size: 0.75rem;
        }
        
        .input-field {
            width: 100%;
            padding: 8px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 0.75rem;
            transition: all var(--transition-speed) ease;
        }
        
        .input-field:focus {
            outline: none;
            border-color: var(--primary-orange);
        }
        
        .wallet-balance {
            background: var(--primary-gradient);
            color: var(--white);
            padding: 10px;
            border-radius: var(--element-radius);
            text-align: center;
            margin-bottom: 10px;
        }
        
        .balance-label {
            font-size: 0.7rem;
            margin-bottom: 2px;
        }
        
        .balance-amount-large {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 5px;
        }
        
        .wallet-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin-bottom: 10px;
        }
        
        .btn-wallet {
            background: var(--white);
            color: var(--primary-orange);
            border: 2px solid var(--primary-orange);
            padding: 6px;
            font-size: 0.7rem;
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .btn-wallet:hover {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .payment-methods {
            margin-top: 10px;
        }
        
        .payment-method {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            margin-bottom: 6px;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .payment-method.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .payment-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: var(--medium-gray);
        }
        
        .payment-details {
            flex: 1;
        }
        
        .payment-name {
            font-weight: 600;
            font-size: 0.75rem;
        }
        
        .payment-info {
            color: var(--medium-gray);
            font-size: 0.65rem;
        }
        
        .history-item {
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            font-size: 0.7rem;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-item:hover {
            background: var(--light-orange);
        }
        
        .history-locations {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .history-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.65rem;
            color: var(--medium-gray);
        }
        
        .status-badge {
            padding: 2px 5px;
            border-radius: 10px;
            font-size: 0.6rem;
            font-weight: 700;
        }
        
        .status-completed {
            background: #e6f7e9;
            color: #2e7d32;
        }
        
        .status-cancelled {
            background: #ffebee;
            color: #c62828;
        }
        
        .status-requested {
            background: #fff3e0;
            color: #ef6c00;
        }
        
        .status-accepted {
            background: #e3f2fd;
            color: #1565c0;
        }
        
        .notification {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-gradient);
            color: var(--white);
            padding: 8px 14px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 300;
            display: none;
            font-weight: 600;
            text-align: center;
            font-size: 0.75rem;
            max-width: 80%;
        }
        
        .driver-marker {
            background: var(--primary-gradient);
            color: white;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .driver-marker-label {
            background: white;
            padding: 2px 4px;
            border-radius: 6px;
            margin-top: 3px;
            font-size: 8px;
            font-weight: bold;
            box-shadow: 0 1px 5px rgba(0,0,0,0.2);
        }
        
        .pickup-marker {
            background: var(--primary-orange);
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .destination-marker {
            background: var(--primary-red);
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .current-location-marker {
            background: var(--info-blue);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .ride-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: var(--white);
            padding: 6px 10px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 700;
            color: var(--dark-gray);
            border: 2px solid var(--border-color);
            font-size: 0.75rem;
            display: none;
        }
        
        .status-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: var(--medium-gray);
        }
        
        .status-dot.searching {
            background: var(--warning-yellow);
            animation: pulse 2s infinite;
        }
        
        .status-dot.arriving {
            background: var(--info-blue);
            animation: pulse 1.5s infinite;
        }
        
        .status-dot.riding {
            background: var(--success-green);
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .estimated-time {
            position: fixed;
            top: 50px;
            right: 10px;
            background: var(--white);
            padding: 6px 10px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 700;
            color: var(--dark-gray);
            border: 2px solid var(--border-color);
            font-size: 0.75rem;
            display: none;
        }
        
        .saved-locations {
            display: flex;
            gap: 6px;
            margin: 8px 0;
        }
        
        .saved-location-btn {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
            cursor: pointer;
            font-size: 0.65rem;
            transition: all var(--transition-speed) ease;
        }
        
        .saved-location-btn:hover {
            background: var(--light-orange);
            border-color: var(--primary-orange);
        }
        
        .suggestion-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-medium);
            z-index: 200;
            max-height: 180px;
            overflow-y: auto;
            display: none;
        }
        
        .suggestion-item {
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .suggestion-item:hover {
            background: var(--light-orange);
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
        
        .suggestion-icon {
            font-size: 0.9rem;
            width: 18px;
            text-align: center;
        }
        
        .suggestion-details {
            flex: 1;
        }
        
        .suggestion-name {
            font-weight: 600;
            font-size: 0.75rem;
        }
        
        .suggestion-address {
            color: var(--medium-gray);
            font-size: 0.65rem;
        }
        
        .suggestion-distance {
            color: var(--medium-gray);
            font-size: 0.55rem;
            margin-top: 2px;
        }
        
        .loading-text {
            text-align: center;
            padding: 15px;
            color: var(--medium-gray);
        }
        
        .no-places {
            text-align: center;
            padding: 15px;
            color: var(--medium-gray);
        }
        
        .filter-options {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .filter-options select, .filter-options input {
            flex: 1;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .stat-card {
            background: var(--light-gray);
            padding: 10px;
            border-radius: var(--element-radius);
            text-align: center;
        }
        
        .stat-number {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        .stat-label {
            font-size: 0.65rem;
            color: var(--medium-gray);
        }
        
        .referral-section {
            background: var(--light-orange);
            padding: 12px;
            border-radius: var(--element-radius);
            margin-bottom: 12px;
        }
        
        .referral-code {
            background: var(--white);
            padding: 8px;
            border-radius: var(--element-radius);
            text-align: center;
            margin: 8px 0;
        }
        
        .code {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        .description {
            font-size: 0.65rem;
            color: var(--medium-gray);
            margin-top: 4px;
        }
        
        .contact-section {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .contact-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: var(--element-radius);
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .contact-btn.whatsapp {
            background: #25D366;
            color: white;
        }
        
        .contact-btn.phone {
            background: var(--info-blue);
            color: white;
        }
        
        .rating-stars {
            display: flex;
            gap: 4px;
            margin-top: 4px;
        }
        
        .star {
            font-size: 1.3rem;
            color: var(--light-gray);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .star.active {
            color: var(--warning-yellow);
        }
        
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
        }
        
        .popup-overlay.hidden {
            display: none;
        }
        
        .popup-form {
            background: var(--white);
            border-radius: var(--element-radius);
            width: 100%;
            max-width: 450px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: var(--shadow-heavy);
        }
        
        .large-popup {
            max-width: 700px;
        }
        
        .popup-header {
            display: flex;
            align-items: center;
            justify-content: between;
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .popup-title {
            font-size: 1.1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .close-popup {
            background: none;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            color: var(--medium-gray);
        }
        
        .popup-content {
            padding: 12px;
        }
        
        .popup-map-container {
            height: 180px;
            border-radius: var(--element-radius);
            overflow: hidden;
            margin-bottom: 12px;
        }
        
        .popup-details {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .detail-row:last-child {
            border-bottom: none;
        }
        
        .detail-label {
            font-weight: 600;
            font-size: 0.75rem;
        }
        
        .detail-value {
            font-size: 0.75rem;
            color: var(--medium-gray);
        }
        
        .driver-details-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }
        
        .popup-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 12px;
        }
        
        /* Payment Selection Popup Styles */
        .payment-selection-popup {
            max-width: 350px;
        }
        
        .payment-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            margin-bottom: 8px;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .payment-option.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .payment-option-icon {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            color: var(--medium-gray);
        }
        
        .payment-option.selected .payment-option-icon {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .payment-option-details {
            flex: 1;
        }
        
        .payment-option-name {
            font-weight: 600;
            font-size: 0.85rem;
        }
        
        .payment-option-description {
            color: var(--medium-gray);
            font-size: 0.7rem;
        }
        
        .payment-option-balance {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--primary-orange);
        }
        
        .confirm-payment-btn {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: var(--element-radius);
            background: var(--primary-gradient);
            color: var(--white);
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            margin-top: 12px;
        }
        
        .confirm-payment-btn:disabled {
            background: var(--medium-gray);
            cursor: not-allowed;
        }
        
        .insufficient-balance {
            color: var(--error-red);
            font-size: 0.75rem;
            margin-top: 4px;
            display: none;
        }
        
        /* Package Delivery Form Styles */
        .package-form {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
            display: none;
        }
        
        .package-form.active {
            display: block;
        }
        
        .form-row {
            display: flex;
            gap: 6px;
            margin-bottom: 6px;
        }
        
        .form-group {
            flex: 1;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 3px;
            font-weight: 600;
            font-size: 0.7rem;
        }
        
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 6px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 0.7rem;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 50px;
        }
        
        .package-toggle {
            width: 100%;
            padding: 6px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .driver-details-card {
            background: var(--light-orange);
            padding: 10px;
            border-radius: var(--element-radius);
            margin-bottom: 10px;
            border: 1px solid var(--primary-orange);
        }
        
        .driver-details-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 6px;
        }
        
        .driver-details-header h3 {
            font-size: 0.85rem;
            color: var(--primary-orange);
        }
        
        .driver-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }
        
        .driver-detail-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .driver-detail-label {
            font-size: 0.65rem;
            color: var(--medium-gray);
            font-weight: 600;
        }
        
        .driver-detail-value {
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .driver-vehicle-details {
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px dashed var(--border-color);
        }
        
        .vehicle-detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
            font-size: 0.65rem;
        }
        
        .vehicle-detail-label {
            color: var(--medium-gray);
        }
        
        .vehicle-detail-value {
            font-weight: 600;
        }
        
        /* Enhanced History Item Styles */
        .history-item-type {
            font-size: 0.65rem;
            font-weight: 600;
            padding: 2px 5px;
            border-radius: 8px;
            margin-bottom: 4px;
            display: inline-block;
        }
        
        .history-item-type.ride {
            background: var(--light-orange);
            color: var(--primary-orange);
        }
        
        .history-item-type.delivery {
            background: var(--light-red);
            color: var(--primary-red);
        }
        
        .history-package-details {
            background: var(--light-gray);
            padding: 6px;
            border-radius: var(--element-radius);
            margin: 6px 0;
            font-size: 0.65rem;
        }
        
        .package-detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
        }
        
        .package-detail-label {
            font-weight: 600;
            color: var(--medium-gray);
        }
        
        .package-detail-value {
            color: var(--dark-gray);
        }
        
        .history-driver-info {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px dashed var(--border-color);
        }
        
        .history-driver-avatar {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            color: var(--white);
            font-weight: 700;
        }
        
        .history-driver-details {
            flex: 1;
        }
        
        .history-driver-name {
            font-size: 0.65rem;
            font-weight: 600;
        }
        
        .history-driver-rating {
            font-size: 0.55rem;
            color: var(--medium-gray);
        }
        
        .history-fare {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        /* Driver Search Animation */
        .searching-animation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 200;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .searching-pulse {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(255, 107, 53, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse-ring 2s infinite;
            position: relative;
        }
        
        .searching-pulse-inner {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }
        
        .searching-text {
            margin-top: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 12px;
            border-radius: var(--element-radius);
            font-weight: 600;
            color: var(--primary-orange);
            box-shadow: var(--shadow-medium);
        }
        
        @keyframes pulse-ring {
            0% {
                transform: scale(0.8);
                opacity: 1;
            }
            80%, 100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }
        
        @media (max-width: 480px) {
            .floating-balance, .ride-status {
                padding: 5px 7px;
                font-size: 0.65rem;
            }
            
            .passenger-panel {
                padding: 8px;
            }
            
            .nav-buttons {
                gap: 3px;
            }
            
            .nav-btn {
                padding: 5px 2px;
                font-size: 0.55rem;
            }
        }
    </style>
</head>
<body>
    <!-- Main App -->
    <div id="mainApp">
        <!-- Main Map -->
        <div id="map"></div>
        
        <!-- Floating Balance (Only on Home Screen) -->
        <div class="floating-balance home-only">
            <i class="fas fa-wallet"></i>
            <span>Balance: <span class="balance-amount" id="walletBalance">K0.00</span></span>
        </div>
        
        <!-- Ride Status (Only on Home Screen) -->
        <div class="ride-status home-only" id="rideStatus">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Searching for driver</span>
        </div>
        
        <!-- Estimated Time (Only on Home Screen) -->
        <div class="estimated-time home-only" id="estimatedTime">
            <i class="fas fa-clock"></i>
            <span id="timeText">5 min</span>
        </div>
        
        <!-- Driver Search Animation -->
        <div class="searching-animation" id="searchingAnimation">
            <div class="searching-pulse">
                <div class="searching-pulse-inner">
                    <i class="fas fa-car"></i>
                </div>
            </div>
            <div class="searching-text">Searching for driver</div>
        </div>
        
        <!-- Passenger Panel -->
        <div class="passenger-panel" id="passengerPanel">
            <div class="panel-collapse-handle" id="panelCollapseHandle"></div>
            
            <div class="nav-buttons">
                <button class="nav-btn active" data-screen="home">
                    <i class="fas fa-home"></i>
                    <span>Home</span>
                </button>
                <button class="nav-btn" data-screen="account">
                    <i class="fas fa-user"></i>
                    <span>Account</span>
                </button>
                <button class="nav-btn" data-screen="history">
                    <i class="fas fa-history"></i>
                    <span>History</span>
                </button>
                <button class="nav-btn" data-screen="payments">
                    <i class="fas fa-credit-card"></i>
                    <span>Payments</span>
                </button>
            </div>
            
            <!-- Home Screen Content -->
            <div id="homeScreenContent">
                <!-- Ride Request Form -->
                <div class="ride-request-form" id="rideRequestForm">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="pickupLocation" placeholder="Current location" readonly>
                    </div>
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="destinationLocation" placeholder="Where to?">
                        <div class="suggestion-list" id="destinationSuggestions"></div>
                    </div>
                    
                    <div class="saved-locations">
                        <button class="saved-location-btn" data-address="home">
                            <i class="fas fa-home"></i>
                            Home
                        </button>
                        <button class="saved-location-btn" data-address="work">
                            <i class="fas fa-briefcase"></i>
                            Work
                        </button>
                    </div>
                    
                    <div class="vehicle-selection">
                        <div class="vehicle-option selected" data-type="car">
                            <i class="fas fa-car vehicle-icon"></i>
                            <span class="vehicle-name">Ride</span>
                            <span class="vehicle-price">Clean Cars</span>
                        </div>
                        <div class="vehicle-option" data-type="bike">
                            <i class="fas fa-motorcycle vehicle-icon"></i>
                            <span class="vehicle-name">Delivery</span>
                            <span class="vehicle-price">on time</span>
                        </div>
                        <div class="vehicle-option" data-type="bicycle">
                            <i class="fas fa-bicycle vehicle-icon"></i>
                            <span class="vehicle-name">Short Delivery</span>
                            <span class="vehicle-price">on time</span>
                        </div>
                    </div>
                    
                    <!-- Package Delivery Form -->
                    <button class="package-toggle" id="packageToggle" style="display: none;">
                        <i class="fas fa-box"></i>
                        Add Package Details
                    </button>
                    
                    <div class="package-form" id="packageForm">
                        <h4 class="section-title">Package Delivery Details</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="receiverName">Receiver Name</label>
                                <input type="text" id="receiverName" placeholder="Full name of receiver">
                            </div>
                            <div class="form-group">
                                <label for="receiverPhone">Receiver Phone</label>
                                <input type="tel" id="receiverPhone" placeholder="Phone number">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="packageDescription">Package Description</label>
                            <input type="text" id="packageDescription" placeholder="What is being delivered?">
                        </div>
                        <div class="form-group">
                            <label for="specialInstructions">Special Instructions</label>
                            <textarea id="specialInstructions" placeholder="Any special handling instructions?"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="packageValue">Package Value (K)</label>
                            <input type="number" id="packageValue" placeholder="Estimated value for insurance">
                        </div>
                    </div>
                    
                    <button class="promo-toggle" id="promoToggle">
                        <i class="fas fa-tag"></i>
                        Apply Promo Coupon
                    </button>
                    
                    <div class="promo-section" id="promoSection">
                        <div class="promo-input">
                            <input type="text" id="promoCode" placeholder="Promo code">
                            <button class="btn-promo" id="applyPromoBtn">Apply</button>
                        </div>
                    </div>
                    
                    <div class="fare-display">
                        <p>Estimated Fare</p>
                        <div class="fare-amount" id="estimatedFare">K0.00</div>
                        <p class="eta-display" id="etaDisplay">ETA: -- min</p>
                    </div>
                    
                    <button class="request-ride-btn" id="requestRideBtn">Request Ride</button>
                </div>
                
                <!-- Ride Info Panel (Hidden initially) -->
                <div class="ride-info-panel" id="rideInfoPanel">
                    <!-- Driver Details Card -->
                    <div class="driver-details-card" id="driverDetailsCard" style="display: none;">
                        <div class="driver-details-header">
                            <i class="fas fa-id-card"></i>
                            <h3>Driver Details</h3>
                        </div>
                        <div class="driver-details-grid">
                            <div class="driver-detail-item">
                                <span class="driver-detail-label">Driver Name</span>
                                <span class="driver-detail-value" id="driverFullName">John Doe</span>
                            </div>
                            <div class="driver-detail-item">
                                <span class="driver-detail-label">Phone</span>
                                <span class="driver-detail-value" id="driverContactPhone">+260 123 456 789</span>
                            </div>
                            <div class="driver-detail-item">
                                <span class="driver-detail-label">Rating</span>
                                <span class="driver-detail-value" id="driverRatingValue">4.8 </span>
                            </div>
                            <div class="driver-detail-item">
                                <span class="driver-detail-label">Experience</span>
                                <span class="driver-detail-value" id="driverExperience">2 years</span>
                            </div>
                        </div>
                        <div class="driver-vehicle-details">
                            <div class="vehicle-detail-row">
                                <span class="vehicle-detail-label">Vehicle Type</span>
                                <span class="vehicle-detail-value" id="vehicleType">Car</span>
                            </div>
                            <div class="vehicle-detail-row">
                                <span class="vehicle-detail-label">Vehicle Model</span>
                                <span class="vehicle-detail-value" id="vehicleModel">Toyota Corolla</span>
                            </div>
                            <div class="vehicle-detail-row">
                                <span class="vehicle-detail-label">License Plate</span>
                                <span class="vehicle-detail-value" id="vehicleLicense">ABC 123</span>
                            </div>
                            <div class="vehicle-detail-row">
                                <span class="vehicle-detail-label">Color</span>
                                <span class="vehicle-detail-value" id="vehicleColor">Blue</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="driver-info">
                        <div class="driver-avatar" id="driverAvatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="driver-details">
                            <h2 id="driverName">Driver Name</h2>
                            <p><i class="fas fa-phone"></i> <span id="driverPhone">000-000-0000</span></p>
                            <p><i class="fas fa-car"></i> <span id="vehicleDetails">Toyota Corolla - ABC123</span></p>
                            <p><i class="fas fa-star"></i> <span id="driverRating">4.5 </span></p>
                        </div>
                    </div>
                    
                    <div class="trip-details">
                        <div class="location-row">
                            <div class="location-icon pickup-icon">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="location-text">
                                <h4>Pickup Location</h4>
                                <p id="currentPickupLocation">123 Main Street, City</p>
                            </div>
                        </div>
                        <div class="location-row">
                            <div class="location-icon destination-icon">
                                <i class="fas fa-flag"></i>
                            </div>
                            <div class="location-text">
                                <h4>Destination</h4>
                                <p id="currentDestinationLocation">456 Oak Avenue, City</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="fare-details">
                        <div class="fare-row">
                            <span>Base Fare</span>
                            <span id="baseFare">K15.00</span>
                        </div>
                        <div class="fare-row">
                            <span>Distance</span>
                            <span id="distanceFare">K5.00</span>
                        </div>
                        <div class="fare-row">
                            <span>Discount</span>
                            <span id="discountFare">-K2.00</span>
                        </div>
                        <div class="fare-row total">
                            <span>Total Fare</span>
                            <span id="totalFare">K18.00</span>
                        </div>
                    </div>
                    
                    <div class="ride-actions">
                        <button class="btn btn-cancel" id="cancelRideBtn">
                            <i class="fas fa-times-circle"></i>
                            Cancel Ride
                        </button>
                        <button class="btn btn-contact" id="contactDriverBtn">
                            <i class="fas fa-phone"></i>
                            Contact Driver
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Screen Contents -->
        <div class="screen-content" id="homeScreen">
            <!-- Home screen is the map, so this is empty -->
        </div>
        
        <div class="screen-content" id="accountScreen">
            <div class="screen-header">
                <button class="back-button" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="screen-title">Account</h2>
            </div>
            
            <div class="account-section">
                <div class="account-header">
                    <div class="driver-avatar" id="accountAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="driver-details">
                        <h2 id="accountName">Passenger</h2>
                        <p><i class="fas fa-phone"></i> <span id="accountPhone">Not set</span></p>
                        <p><i class="fas fa-envelope"></i> <span id="accountEmail">Not set</span></p>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="ridesCompleted">0</div>
                        <div class="stat-label">Completed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="ridesCancelled">0</div>
                        <div class="stat-label">Cancelled</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="ridesPending">0</div>
                        <div class="stat-label">Pending</div>
                    </div>
                </div>
                
                <div class="referral-section">
                    <h3 class="section-title">
                        <i class="fas fa-share-alt"></i>
                        Refer & Earn
                    </h3>
                    <p>Share your code and get K25 when friends join</p>
                    <div class="referral-code">
                        <div class="code" id="referralCode">JUBEL-XXXX</div>
                        <div class="description">50% discount for new users</div>
                    </div>
                    <button class="btn btn-primary" id="shareReferralBtn">
                        <i class="fas fa-share"></i>
                        Share Referral Code
                    </button>
                </div>
                
                <div class="wallet-section">
                    <h3 class="section-title">
                        <i class="fas fa-wallet"></i>
                        Jubel Wallet
                    </h3>
                    <div class="wallet-balance">
                        <div class="balance-label">Current Balance</div>
                        <div class="balance-amount-large" id="accountBalance">K0.00</div>
                    </div>
                    <div class="wallet-actions">
                        <button class="btn-wallet" id="depositBtn">
                            <i class="fas fa-plus"></i>
                            Deposit
                        </button>
                        <button class="btn-wallet" id="withdrawBtn">
                            <i class="fas fa-minus"></i>
                            Withdraw
                        </button>
                    </div>
                </div>
                
                <div class="contact-section">
                    <button class="contact-btn whatsapp" id="whatsappBtn">
                        <i class="fab fa-whatsapp"></i>
                        WhatsApp
                    </button>
                    <button class="contact-btn phone" id="callBtn">
                        <i class="fas fa-phone"></i>
                        Call Us
                    </button>
                </div>
            </div>
        </div>
        
        <div class="screen-content" id="historyScreen">
            <div class="screen-header">
                <button class="back-button" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="screen-title">Ride History</h2>
            </div>
            
            <div class="filter-options">
                <select id="historyFilter" class="input-field">
                    <option value="all">All Rides</option>
                    <option value="requested">Awaiting Driver</option>
                    <option value="accepted">In Progress</option>
                    <option value="completed">Completed</option>
                    <option value="cancelled">Cancelled</option>
                </select>
                <input type="date" id="historyDate" class="input-field">
            </div>
            
            <div class="history-section">
                <div id="historyList">
                    <div class="loading-text">
                        <i class="fas fa-spinner fa-spin"></i>
                        Loading ride history...
                    </div>
                </div>
            </div>
        </div>
        
        <div class="screen-content" id="paymentsScreen">
            <div class="screen-header">
                <button class="back-button" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="screen-title">Payment Methods</h2>
            </div>
            
            <div class="payments-section">
                <h3 class="section-title">
                    <i class="fas fa-credit-card"></i>
                    Payment Methods
                </h3>
                
                <div class="payment-methods">
                    <div class="payment-method selected" data-method="airtel">
                        <div class="payment-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Airtel Money</div>
                            <div class="payment-info">Pay with Airtel Money</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-method="mtn">
                        <div class="payment-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">MTN Money</div>
                            <div class="payment-info">Pay with MTN Money</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-method="zamtel">
                        <div class="payment-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Zamtel Money</div>
                            <div class="payment-info">Pay with Zamtel Money</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-method="card">
                        <div class="payment-icon">
                            <i class="fas fa-credit-card"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Credit/Debit Card</div>
                            <div class="payment-info">Visa, Mastercard</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-method="cash">
                        <div class="payment-icon">
                            <i class="fas fa-money-bill"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Cash</div>
                            <div class="payment-info">Pay with cash</div>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-primary" id="addPaymentMethodBtn">
                    <i class="fas fa-plus"></i>
                    Add Payment Method
                </button>
            </div>
        </div>
    </div>
    
    <!-- Payment Selection Popup -->
    <div id="paymentSelectionPopup" class="popup-overlay hidden">
        <div class="popup-form payment-selection-popup">
            <div class="popup-header">
                <h2 class="popup-title">
                    <i class="fas fa-credit-card"></i>
                    Select Payment Method
                </h2>
                <button class="close-popup" id="closePaymentPopup">&times;</button>
            </div>
            <div class="popup-content">
                <div class="payment-options">
                    <div class="payment-option selected" data-payment-type="wallet">
                        <div class="payment-option-icon">
                            <i class="fas fa-wallet"></i>
                        </div>
                        <div class="payment-option-details">
                            <div class="payment-option-name">Jubel Wallet</div>
                            <div class="payment-option-description">Pay with your Jubel wallet balance</div>
                            <div class="payment-option-balance" id="paymentWalletBalance">Balance: K0.00</div>
                        </div>
                    </div>
                    
                    <div class="payment-option" data-payment-type="mobile">
                        <div class="payment-option-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="payment-option-details">
                            <div class="payment-option-name">Mobile Money</div>
                            <div class="payment-option-description">Pay with Airtel, MTN or Zamtel Money</div>
                        </div>
                    </div>
                    
                    <div class="payment-option" data-payment-type="cash">
                        <div class="payment-option-icon">
                            <i class="fas fa-money-bill"></i>
                        </div>
                        <div class="payment-option-details">
                            <div class="payment-option-name">Cash on Delivery</div>
                            <div class="payment-option-description">Pay with cash when you arrive</div>
                        </div>
                    </div>
                </div>
                
                <div class="insufficient-balance" id="insufficientBalance">
                    <i class="fas fa-exclamation-circle"></i>
                    Insufficient balance in your Jubel wallet
                </div>
                
                <button class="confirm-payment-btn" id="confirmPaymentBtn">
                    Confirm Payment & Request Ride
                </button>
            </div>
        </div>
    </div>
    
    <!-- Ride Details Popup -->
    <div id="rideDetailsPopup" class="popup-overlay hidden">
        <div class="popup-form large-popup">
            <div class="popup-header">
                <h2 class="popup-title">
                    <i class="fas fa-info-circle"></i>
                    Ride Details
                </h2>
                <button class="close-popup" id="closeRidePopupTop">&times;</button>
            </div>
            <div class="popup-content">
                <div class="popup-map-container" id="popupRideMap"></div>
                <div class="popup-details">
                    <div class="detail-row">
                        <span class="detail-label">Pickup:</span>
                        <span class="detail-value" id="popupRidePickup">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Destination:</span>
                        <span class="detail-value" id="popupRideDestination">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Fare:</span>
                        <span class="detail-value" id="popupRideFare">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Distance:</span>
                        <span class="detail-value" id="popupRideDistance">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Ride Type:</span>
                        <span class="detail-value" id="popupRideType">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Status:</span>
                        <span class="detail-value" id="popupRideStatus">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Date & Time:</span>
                        <span class="detail-value" id="popupRideDate">Loading...</span>
                    </div>
                    
                    <!-- Driver Details Section -->
                    <div id="popupDriverDetails" class="driver-details-section hidden">
                        <h3 class="section-title">Driver Information</h3>
                        <div class="detail-row">
                            <span class="detail-label">Driver Name:</span>
                            <span class="detail-value" id="popupDriverName">Loading...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Phone:</span>
                            <span class="detail-value" id="popupDriverPhone">Loading...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Vehicle:</span>
                            <span class="detail-value" id="popupDriverVehicle">Loading...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Rating:</span>
                            <span class="detail-value" id="popupDriverRating">Loading...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Progress:</span>
                            <span class="detail-value" id="popupDriverProgress">Loading...</span>
                        </div>
                    </div>
                    
                    <div class="popup-actions">
                        <button class="btn btn-primary" id="closeRidePopup">
                            <i class="fas fa-times"></i>
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification"></div>
    
    <!-- Firebase and Leaflet JS -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <script>
    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyDEACX_P4c5q7djJAcA0I7Lk7leO2TlQ74",
        authDomain: "jubel-13e1a.firebaseapp.com",
        databaseURL: "https://jubel-13e1a-default-rtdb.firebaseio.com",
        projectId: "jubel-13e1a",
        storageBucket: "jubel-13e1a.firebasestorage.app",
        messagingSenderId: "882241095445",
        appId: "1:882241095445:web:ee9ca40fddd008ca910b1c",
        measurementId: "G-J5JPKL6B5F"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const auth = firebase.auth();

    // App state
    let currentUser = null;
    let currentRide = null;
    let passengerMap;
    let popupRideMap;
    let locationWatchId = null;
    let currentLocationMarker = null;
    let pickupMarker = null;
    let destinationMarker = null;
    let driverMarker = null;
    let routePolyline = null;
    let selectedVehicleType = 'car';
    let walletBalance = 0;
    let userFullName = "Passenger";
    let driverAssignmentListener = null;
    let rideHistoryListener = null;
    let activeRideListener = null;
    let appliedPromoCode = null;
    let userStats = {
        completed: 0,
        cancelled: 0,
        pending: 0
    };
    let paymentMethod = 'airtel';
    let userRating = 0;
    let userLocation = null;
    let destinationSearchResults = [];
    let selectedDestination = null;
    let driverLocationListener = null;
    let userData = null;
    let selectedPaymentType = 'wallet';
    let rideFare = 0;
    let currentCity = null;
    let packageDetails = null;
    let walletBalanceListener = null;
    let currentScreen = 'home';
    let homeScreenRefreshRequired = false;

    // Zambian cities for search with common misspellings and variations
    const zambianCities = [
        'Lusaka', 'Kitwe', 'Ndola', 'Kabwe', 'Chipata', 'Chingola', 
        'Mufulira', 'Luanshya', 'Livingstone', 'Kasama', 'Solwezi', 
        'Kapiri Mposhi', 'Chililabombwe'
    ];

    // City aliases for handling spelling mistakes and variations
    const cityAliases = {
        'lusaka': 'Lusaka',
        'lsk': 'Lusaka',
        'lsk city': 'Lusaka',
        'kitwe': 'Kitwe',
        'ndola': 'Ndola',
        'kabwe': 'Kabwe',
        'chipata': 'Chipata',
        'chingola': 'Chingola',
        'mufulira': 'Mufulira',
        'luanshya': 'Luanshya',
        'livingstone': 'Livingstone',
        'kasama': 'Kasama',
        'solwezi': 'Solwezi',
        'kapiri': 'Kapiri Mposhi',
        'kapiri mposhi': 'Kapiri Mposhi',
        'chililabombwe': 'Chililabombwe',
        'chili': 'Chililabombwe'
    };

    // Enhanced city boundaries for more accurate detection
    const cityBoundaries = {
        'Lusaka': { lat: -15.4167, lng: 28.2833, radius: 25000 },
        'Kitwe': { lat: -12.8139, lng: 28.2136, radius: 20000 },
        'Ndola': { lat: -12.9667, lng: 28.6333, radius: 20000 },
        'Kabwe': { lat: -14.4333, lng: 28.4500, radius: 15000 },
        'Chipata': { lat: -13.6333, lng: 32.6500, radius: 15000 },
        'Chingola': { lat: -12.5333, lng: 27.8500, radius: 15000 },
        'Mufulira': { lat: -12.5500, lng: 28.2333, radius: 15000 },
        'Luanshya': { lat: -13.1333, lng: 28.4000, radius: 15000 },
        'Livingstone': { lat: -17.8500, lng: 25.8667, radius: 15000 },
        'Kasama': { lat: -10.2000, lng: 31.2000, radius: 15000 },
        'Solwezi': { lat: -12.1833, lng: 26.4000, radius: 15000 },
        'Kapiri Mposhi': { lat: -13.9667, lng: 28.6833, radius: 10000 },
        'Chililabombwe': { lat: -12.3667, lng: 27.8333, radius: 10000 }
    };

    // Initialize the app
    document.addEventListener('DOMContentLoaded', function() {
        initializeAuth();
    });

    // Authentication functions
    function initializeAuth() {
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const email = urlParams.get('email');
        const uid = urlParams.get('uid');
        
        if (email && uid) {
            // User is coming from signup page
            loadUserData(uid);
        } else {
            // Check if user is already logged in
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    loadUserData(user.uid);
                } else {
                    // Redirect to signup page
                    window.location.href = 'signup.html';
                }
            });
        }
    }

    // Load user data from Firebase
    function loadUserData(uid) {
        database.ref('users/' + uid).once('value')
            .then(snapshot => {
                userData = snapshot.val();
                if (userData) {
                    currentUser = {
                        uid: uid,
                        email: userData.email,
                        displayName: userData.name
                    };
                    
                    // Initialize the app with user data
                    initializeMap();
                    setupEventListeners();
                    loadPassengerData();
                    
                    // Update UI with user data
                    document.getElementById('accountName').textContent = userData.name || 'Passenger';
                    document.getElementById('accountEmail').textContent = userData.email || 'Not set';
                    document.getElementById('accountPhone').textContent = userData.phone || 'Not set';
                    document.getElementById('referralCode').textContent = userData.referralCode || 'JUBEL-XXXX';
                    
                    // Update wallet balance
                    walletBalance = userData.walletBalance || 0;
                    updateWalletBalanceUI();
                    
                    // Set up real-time wallet balance listener
                    setupWalletBalanceListener(uid);
                    
                    showNotification('Welcome back to Jubel!');
                } else {
                    showNotification('User data not found. Please sign up again.');
                    setTimeout(() => {
                        window.location.href = 'signup.html';
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('Error loading user data:', error);
                showNotification('Error loading user data. Please try again.');
            });
    }

    // Set up real-time wallet balance listener
    function setupWalletBalanceListener(uid) {
        // Remove existing listener if any
        if (walletBalanceListener) {
            walletBalanceListener();
        }
        
        // Set up real-time listener for wallet balance changes
        walletBalanceListener = database.ref('users/' + uid + '/walletBalance').on('value', snapshot => {
            const newBalance = snapshot.val() || 0;
            if (newBalance !== walletBalance) {
                walletBalance = newBalance;
                updateWalletBalanceUI();
                showNotification(`Wallet balance updated: K${walletBalance.toFixed(2)}`);
            }
        }, error => {
            console.error('Error listening to wallet balance:', error);
        });
    }

    // Update wallet balance across all UI elements
    function updateWalletBalanceUI() {
        document.getElementById('walletBalance').textContent = `K${walletBalance.toFixed(2)}`;
        document.getElementById('accountBalance').textContent = `K${walletBalance.toFixed(2)}`;
        document.getElementById('paymentWalletBalance').textContent = `Balance: K${walletBalance.toFixed(2)}`;
    }

    // Map initialization
    function initializeMap() {
        // Main passenger map
        passengerMap = L.map('map').setView([-15.4167, 28.2833], 13);
        
        // Use a clean map style
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: ' OpenStreetMap contributors'
        }).addTo(passengerMap);
        
        // Popup ride details map
        popupRideMap = L.map('popupRideMap').setView([-15.4167, 28.2833], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: ' OpenStreetMap contributors'
        }).addTo(popupRideMap);
        
        // Get passenger's current location
        refreshPassengerPosition();
    }

    // ENHANCED: Advanced city detection with multiple fallback methods
    function determineCurrentCity(lat, lng) {
        return new Promise((resolve, reject) => {
            console.log(`Starting city detection for coordinates: ${lat}, ${lng}`);
            
            // Method 1: Check if within known city boundaries first (fastest)
            const boundaryCity = checkCityBoundaries(lat, lng);
            if (boundaryCity) {
                console.log(`City detected via boundaries: ${boundaryCity}`);
                currentCity = boundaryCity;
                resolve(currentCity);
                return;
            }
            
            // Method 2: Use Nominatim reverse geocoding with enhanced parameters
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1&accept-language=en`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data && data.address) {
                        const detectedCity = extractCityFromAddress(data.address);
                        
                        if (detectedCity && detectedCity !== "Unknown Location") {
                            currentCity = detectedCity;
                            console.log(`City detected via Nominatim: ${currentCity}`);
                            resolve(currentCity);
                        } else {
                            // Method 3: Fallback to display name parsing
                            const fallbackCity = extractCityFromDisplayName(data.display_name);
                            currentCity = fallbackCity;
                            console.log(`City detected via fallback: ${currentCity}`);
                            resolve(currentCity);
                        }
                    } else {
                        // Method 4: Final fallback
                        currentCity = "Lusaka"; // Default to Lusaka
                        console.log(`Using default city: ${currentCity}`);
                        resolve(currentCity);
                    }
                })
                .catch(error => {
                    console.error('Error in city detection:', error);
                    // Method 5: Emergency fallback
                    currentCity = determineCityByProximity(lat, lng) || "Lusaka";
                    console.log(`City detected via proximity fallback: ${currentCity}`);
                    resolve(currentCity);
                });
        });
    }

    // NEW: Check if coordinates fall within known city boundaries
    function checkCityBoundaries(lat, lng) {
        for (const [city, boundary] of Object.entries(cityBoundaries)) {
            const distance = calculateDistance(lat, lng, boundary.lat, boundary.lng);
            if (distance <= boundary.radius) {
                return city;
            }
        }
        return null;
    }

    // NEW: Extract city from address object with priority handling
    function extractCityFromAddress(address) {
        // Priority order for city detection
        const priorityFields = [
            'city', 'town', 'village', 'municipality', 
            'suburb', 'county', 'state_district', 'state'
        ];
        
        for (const field of priorityFields) {
            if (address[field]) {
                const detectedName = address[field].toString().trim();
                // Normalize and validate against known cities
                const normalized = normalizeCityName(detectedName);
                if (zambianCities.includes(normalized)) {
                    return normalized;
                }
            }
        }
        
        return null;
    }

    // NEW: Extract city from display name with pattern matching
    function extractCityFromDisplayName(displayName) {
        if (!displayName) return "Unknown Location";
        
        const nameLower = displayName.toLowerCase();
        
        // Check for exact city matches first
        for (const city of zambianCities) {
            if (nameLower.includes(city.toLowerCase())) {
                return city;
            }
        }
        
        // Check for aliases and common misspellings
        for (const [alias, actualCity] of Object.entries(cityAliases)) {
            if (nameLower.includes(alias)) {
                return actualCity;
            }
        }
        
        return "Unknown Location";
    }

    // NEW: Normalize city names for consistent matching
    function normalizeCityName(cityName) {
        if (!cityName) return "";
        
        const normalized = cityName.toString().trim();
        
        // Handle common variations and misspellings
        const variations = {
            'lusaka city': 'Lusaka',
            'lska': 'Lusaka',
            'kitwe town': 'Kitwe',
            'ndola city': 'Ndola',
            'kabwe town': 'Kabwe',
            'chipata town': 'Chipata',
            'chingola town': 'Chingola',
            'mufulira town': 'Mufulira',
            'luanshya town': 'Luanshya',
            'livingstone town': 'Livingstone',
            'kasama town': 'Kasama',
            'solwezi town': 'Solwezi',
            'kapiri mposhi town': 'Kapiri Mposhi',
            'chililabombwe town': 'Chililabombwe'
        };
        
        return variations[normalized.toLowerCase()] || 
               zambianCities.find(city => city.toLowerCase() === normalized.toLowerCase()) || 
               normalized;
    }

    // NEW: Determine city by proximity to known city centers
    function determineCityByProximity(lat, lng) {
        let closestCity = null;
        let shortestDistance = Infinity;
        
        for (const [city, center] of Object.entries(cityBoundaries)) {
            const distance = calculateDistance(lat, lng, center.lat, center.lng);
            if (distance < shortestDistance) {
                shortestDistance = distance;
                closestCity = city;
            }
        }
        
        // Only return if within a reasonable distance (100km)
        return shortestDistance <= 100000 ? closestCity : "Unknown Location";
    }

    // ENHANCED: Update pickup location with precise address details only
    function updatePickupLocation(lat, lng) {
        // Update pickup marker
        if (pickupMarker) {
            passengerMap.removeLayer(pickupMarker);
        }
        
        pickupMarker = L.marker([lat, lng], {
            icon: L.divIcon({
                className: 'pickup-marker',
                html: '<div class="pickup-marker"><i class="fas fa-map-marker-alt"></i></div>',
                iconSize: [22, 22]
            })
        }).addTo(passengerMap)
            .bindPopup('Pickup Location');
            
        // Update pickup location input with precise address only (no city/province/country)
        getPreciseAddress(lat, lng, 'pickupLocation');
    }

    // ENHANCED: Get precise address without city, province, or country
    function getPreciseAddress(lat, lng, elementId) {
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1&accept-language=en`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Geocoding error: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data && data.address) {
                    const preciseAddress = buildPreciseAddress(data.address);
                    document.getElementById(elementId).value = preciseAddress || `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                } else {
                    document.getElementById(elementId).value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                }
            })
            .catch(error => {
                console.error('Reverse geocoding error:', error);
                document.getElementById(elementId).value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            });
    }

    // NEW: Build precise address without city, province, or country
    function buildPreciseAddress(address) {
        const addressParts = [];
        
        // Add house/plot number if available
        if (address.house_number || address.housenumber) {
            addressParts.push(address.house_number || address.housenumber);
        }
        
        // Add building name or amenity
        if (address.building) {
            addressParts.push(address.building);
        } else if (address.amenity) {
            addressParts.push(address.amenity);
        }
        
        // Add road name
        if (address.road) {
            addressParts.push(address.road);
        }
        
        // Add suburb or neighbourhood for more precise location
        if (address.suburb) {
            addressParts.push(address.suburb);
        } else if (address.neighbourhood) {
            addressParts.push(address.neighbourhood);
        }
        
        // Add residential area if available
        if (address.residential) {
            addressParts.push(address.residential);
        }
        
        // Add quarter if available
        if (address.quarter) {
            addressParts.push(address.quarter);
        }
        
        // Filter out any empty parts and join with commas
        const filteredParts = addressParts.filter(part => part && part.trim().length > 0);
        
        if (filteredParts.length > 0) {
            return filteredParts.join(', ');
        }
        
        // Fallback: Use display name but remove city/province/country
        return null;
    }

    // ENHANCED: Get full address for ride submission (includes city, province, country)
    function getFullAddress(lat, lng) {
        return new Promise((resolve, reject) => {
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=16&addressdetails=1&accept-language=en`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Full address geocoding error: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data && data.display_name) {
                        resolve(data.display_name);
                    } else {
                        resolve(`${lat.toFixed(6)}, ${lng.toFixed(6)}`);
                    }
                })
                .catch(error => {
                    console.error('Full address geocoding error:', error);
                    resolve(`${lat.toFixed(6)}, ${lng.toFixed(6)}`);
                });
        });
    }

    // IMPROVED: Stable search function without flickering
    function searchPlacesEnhanced(query) {
        if (!query || query.length < 2) {
            hideDestinationSuggestions();
            return;
        }
        
        const suggestionsContainer = document.getElementById('destinationSuggestions');
        
        // Clear any existing timeout to prevent multiple searches
        if (window.searchTimeout) {
            clearTimeout(window.searchTimeout);
        }
        
        // Show loading state immediately
        suggestionsContainer.innerHTML = '<div class="loading-text">Searching...</div>';
        suggestionsContainer.style.display = 'block';
        
        // Use a single timeout to prevent rapid firing
        window.searchTimeout = setTimeout(() => {
            const processedQuery = preprocessSearchQuery(query);
            
            // Track if we've found results to prevent empty states
            let hasResults = false;
            
            // Single search approach instead of multiple promises
            performUnifiedSearch(processedQuery)
                .then(results => {
                    if (results.length > 0) {
                        hasResults = true;
                        displaySearchResults(results);
                    } else {
                        showNoResultsMessage(processedQuery);
                    }
                })
                .catch(error => {
                    console.error('Search error:', error);
                    // Show cached results if available, otherwise show error
                    if (destinationSearchResults.length > 0) {
                        displaySearchResults(destinationSearchResults);
                    } else {
                        showNoResultsMessage(processedQuery);
                    }
                });
                
            // Fallback timeout to ensure UI updates
            setTimeout(() => {
                if (!hasResults && destinationSearchResults.length === 0) {
                    showNoResultsMessage(processedQuery);
                }
            }, 2000);
            
        }, 300); // Slightly increased delay for better UX
    }

    // NEW: Unified search function to replace multiple promise approach
    function performUnifiedSearch(query) {
        return new Promise((resolve, reject) => {
            // Build search query with current city priority
            let searchQuery = query;
            if (currentCity && currentCity !== "Unknown Location") {
                searchQuery = `${query}, ${currentCity}, Zambia`;
            } else {
                searchQuery = `${query}, Zambia`;
            }
            
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&limit=10&dedupe=1&countrycodes=zm`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Search API error: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data && data.length > 0) {
                        const enhancedResults = data
                            .filter(place => place.display_name && place.lat && place.lon)
                            .map(place => {
                                const distance = userLocation ? calculateDistance(
                                    userLocation.lat, userLocation.lng,
                                    parseFloat(place.lat), parseFloat(place.lon)
                                ) : 0;
                                
                                // Determine city for this place
                                const placeCity = extractCityFromPlace(place) || currentCity || "Unknown";
                                
                                return {
                                    ...place,
                                    displayLat: parseFloat(place.lat),
                                    displayLon: parseFloat(place.lon),
                                    distance,
                                    city: placeCity,
                                    isCurrentCity: placeCity === currentCity,
                                    priority: placeCity === currentCity ? 1 : 2,
                                    relevanceScore: calculateRelevanceScore(place, query, placeCity),
                                    displayName: formatDisplayName(place.display_name, placeCity)
                                };
                            })
                            .sort((a, b) => {
                                // Sort by relevance score first, then distance
                                if (b.relevanceScore !== a.relevanceScore) {
                                    return b.relevanceScore - a.relevanceScore;
                                }
                                return a.distance - b.distance;
                            });
                        
                        resolve(enhancedResults);
                    } else {
                        resolve([]);
                    }
                })
                .catch(error => {
                    console.error('Unified search error:', error);
                    reject(error);
                });
        });
    }

    // ENHANCED: Display search results with stable UI
    function displaySearchResults(results) {
        const suggestionsContainer = document.getElementById('destinationSuggestions');
        
        // Clear container
        suggestionsContainer.innerHTML = '';
        destinationSearchResults = [];
        
        if (results.length === 0) {
            showNoResultsMessage();
            return;
        }
        
        // Remove duplicates and limit results
        const uniqueResults = removeDuplicatePlaces(results).slice(0, 8);
        destinationSearchResults = uniqueResults;
        
        uniqueResults.forEach((result, index) => {
            const suggestionItem = document.createElement('div');
            suggestionItem.className = 'suggestion-item';
            if (index === 0) suggestionItem.classList.add('first-result');
            
            const placeType = getPlaceType(result);
            const placeIcon = getPlaceIcon(placeType);
            
            // Add city badge for non-current city results
            const cityBadge = result.isCurrentCity ? '' : 
                `<span class="city-badge">${result.city}</span>`;
            
            const distanceText = userLocation && result.distance > 0 ? 
                `${(result.distance / 1000).toFixed(1)} km away` : '';
            
            // Use formatted display name
            const displayName = result.displayName || result.display_name;
            
            suggestionItem.innerHTML = `
                <div class="suggestion-icon">${placeIcon}</div>
                <div class="suggestion-details">
                    <div class="suggestion-name">
                        ${displayName}
                        ${cityBadge}
                    </div>
                    <div class="suggestion-address">${getShortAddress(result.display_name)}</div>
                    <div class="suggestion-distance">${distanceText}</div>
                </div>
                ${result.isCurrentCity ? '<div class="current-city-indicator"> Current City</div>' : ''}
            `;
            
            suggestionItem.addEventListener('click', function() {
                document.getElementById('destinationLocation').value = result.display_name;
                suggestionsContainer.style.display = 'none';
                updateFareEstimate();
                
                // Update destination marker on map
                updateDestinationMarker(
                    result.displayLat, 
                    result.displayLon, 
                    result.display_name
                );
                
                // Draw route from user location to destination
                if (userLocation) {
                    drawRoute(userLocation.lat, userLocation.lng, result.displayLat, result.displayLon);
                }
                
                selectedDestination = result;
                
                // Enable request ride button
                document.getElementById('requestRideBtn').disabled = false;
                
                showNotification(`Destination set to ${displayName}`);
            });
            
            suggestionsContainer.appendChild(suggestionItem);
        });
        
        // Ensure container stays visible
        suggestionsContainer.style.display = 'block';
    }

    // ENHANCED: Setup destination input listener with better event handling
    function setupDestinationInputListener() {
        let lastQuery = '';
        const destinationInput = document.getElementById('destinationLocation');
        
        destinationInput.addEventListener('input', function() {
            const query = this.value.trim();
            
            // Clear any existing timeout
            if (window.searchTimeout) {
                clearTimeout(window.searchTimeout);
            }
            
            // Only search if query changed significantly
            if (query.length >= 2 && query !== lastQuery) {
                window.searchTimeout = setTimeout(() => {
                    lastQuery = query;
                    searchPlacesEnhanced(query);
                }, 300);
            } else if (query.length < 2) {
                hideDestinationSuggestions();
                lastQuery = '';
            }
        });
        
        destinationInput.addEventListener('focus', function() {
            const query = this.value.trim();
            if (query.length >= 2 && destinationSearchResults.length > 0) {
                // Show previous results if available
                displaySearchResults(destinationSearchResults);
            } else if (query.length >= 2) {
                searchPlacesEnhanced(query);
            }
        });
        
        // Handle key events for better UX
        destinationInput.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                hideDestinationSuggestions();
            } else if (e.key === 'Enter') {
                hideDestinationSuggestions();
                // If there are suggestions, select the first one
                if (destinationSearchResults.length > 0) {
                    const firstResult = destinationSearchResults[0];
                    this.value = firstResult.display_name;
                    updateFareEstimate();
                    updateDestinationMarker(
                        firstResult.displayLat,
                        firstResult.displayLon,
                        firstResult.display_name
                    );
                }
            }
        });
        
        // Click outside to close suggestions
        document.addEventListener('click', function(e) {
            if (!e.target.closest('#destinationLocation') && 
                !e.target.closest('#destinationSuggestions')) {
                hideDestinationSuggestions();
            }
        });
    }

    // IMPROVED: Hide suggestions function
    function hideDestinationSuggestions() {
        const suggestionsContainer = document.getElementById('destinationSuggestions');
        suggestionsContainer.style.display = 'none';
        
        // Clear any pending search timeouts
        if (window.searchTimeout) {
            clearTimeout(window.searchTimeout);
            window.searchTimeout = null;
        }
    }

    // ENHANCED: Show no results message (removed instructions)
    function showNoResultsMessage(query = '') {
        const suggestionsContainer = document.getElementById('destinationSuggestions');
        
        // Simple no results message without instructions
        suggestionsContainer.innerHTML = '<div class="no-places">No places found</div>';
    }

    // NEW: Preprocess search query for better matching
    function preprocessSearchQuery(query) {
        let processed = query.trim().toLowerCase();
        
        // Remove common stop words
        const stopWords = ['the', 'a', 'an', 'in', 'on', 'at', 'to', 'for', 'of', 'and', 'or', 'but'];
        stopWords.forEach(word => {
            processed = processed.replace(new RegExp(`\\b${word}\\b`, 'gi'), '');
        });
        
        // Normalize whitespace
        processed = processed.replace(/\s+/g, ' ').trim();
        
        // Handle common abbreviations
        const abbreviations = {
            'st': 'street',
            'ave': 'avenue',
            'rd': 'road',
            'blvd': 'boulevard',
            'hwy': 'highway',
            'ln': 'lane',
            'dr': 'drive'
        };
        
        Object.keys(abbreviations).forEach(abbr => {
            processed = processed.replace(new RegExp(`\\b${abbr}\\b`, 'gi'), abbreviations[abbr]);
        });
        
        return processed;
    }

    // NEW: Calculate relevance score for search results
    function calculateRelevanceScore(place, query, city) {
        let score = 0;
        const placeName = place.display_name.toLowerCase();
        const queryLower = query.toLowerCase();
        const cityLower = city.toLowerCase();
        
        // Exact match bonus
        if (placeName.includes(queryLower)) {
            score += 10;
        }
        
        // Word boundary matches
        const queryWords = queryLower.split(' ');
        queryWords.forEach(word => {
            if (word.length > 2 && placeName.includes(word)) {
                score += 5;
            }
        });
        
        // Current city bonus
        if (city === currentCity) {
            score += 8;
        }
        
        // Type relevance
        if (place.type === 'administrative' || place.class === 'boundary') {
            score -= 2; // Penalize administrative boundaries
        }
        
        // Importance score from Nominatim
        if (place.importance) {
            score += place.importance * 5;
        }
        
        // Distance penalty (if user location available)
        if (userLocation) {
            const distance = calculateDistance(
                userLocation.lat, userLocation.lng,
                parseFloat(place.lat), parseFloat(place.lon)
            );
            if (distance > 50000) { // 50km
                score -= 3;
            }
        }
        
        return Math.max(0, score);
    }

    // NEW: Extract city from place data
    function extractCityFromPlace(place) {
        if (place.address) {
            return extractCityFromAddress(place.address);
        }
        
        // Fallback: try to extract from display name
        return extractCityFromDisplayName(place.display_name);
    }

    // NEW: Format display name for better UX
    function formatDisplayName(fullName, city) {
        if (!fullName) return 'Unknown Location';
        
        // Remove the city and country from the end to avoid duplication
        const parts = fullName.split(',');
        const relevantParts = [];
        
        for (let i = 0; i < parts.length; i++) {
            const part = parts[i].trim();
            const partLower = part.toLowerCase();
            
            // Stop when we hit city or country information
            if (zambianCities.some(c => c.toLowerCase() === partLower) ||
                partLower === 'zambia' ||
                partLower.includes('province')) {
                break;
            }
            
            relevantParts.push(part);
        }
        
        return relevantParts.join(', ') || fullName;
    }

    // NEW: Get short address for display
    function getShortAddress(fullAddress) {
        if (!fullAddress) return '';
        
        const parts = fullAddress.split(',');
        // Return first 2-3 parts for concise display
        return parts.slice(0, Math.min(3, parts.length)).join(', ');
    }

    // ENHANCED: Remove duplicate places with improved logic
    function removeDuplicatePlaces(places) {
        const seen = new Set();
        return places.filter(place => {
            // Create a unique key based on coordinates and name
            const coordKey = `${place.lat}-${place.lon}`;
            const nameKey = place.display_name.substring(0, 50).toLowerCase();
            const uniqueKey = `${coordKey}-${nameKey}`;
            
            if (seen.has(uniqueKey)) {
                return false;
            }
            seen.add(uniqueKey);
            return true;
        });
    }

    // ENHANCED: Refresh passenger position with improved city detection
    function refreshPassengerPosition() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(position => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                userLocation = { lat, lng };
                
                passengerMap.setView([lat, lng], 16);
                
                if (currentLocationMarker) {
                    currentLocationMarker.setLatLng([lat, lng]);
                } else {
                    currentLocationMarker = L.marker([lat, lng], {
                        icon: L.divIcon({
                            className: 'current-location-marker',
                            html: '<div class="current-location-marker"><i class="fas fa-user"></i></div>',
                            iconSize: [18, 18]
                        })
                    }).addTo(passengerMap)
                        .bindPopup('Your location');
                }
                
                updatePickupLocation(lat, lng);
                
                // Enhanced city detection with progress indication
                showNotification('Detecting your location...');
                determineCurrentCity(lat, lng).then(city => {
                    console.log("Final detected city:", city);
                    if (currentScreen === 'home') {
                        showNotification(`Location detected in ${city}`);
                        // Update any city-specific UI elements
                        updateCitySpecificUI(city);
                    }
                }).catch(error => {
                    console.error('City detection failed:', error);
                    currentCity = "Lusaka";
                    if (currentScreen === 'home') {
                        showNotification('Using default location: Lusaka');
                    }
                });
                
                if (!locationWatchId) {
                    startLocationTracking();
                }
                
                if (currentScreen === 'home') {
                    showNotification('Location refreshed');
                }
            }, error => {
                console.error('Geolocation error:', error);
                handleGeolocationError(error);
            }, {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 30000
            });
        } else {
            showNotification('Geolocation is not supported by this browser.');
            currentCity = "Lusaka";
        }
    }

    // NEW: Handle geolocation errors gracefully
    function handleGeolocationError(error) {
        let errorMessage = 'Unable to refresh location. ';
        
        switch(error.code) {
            case error.PERMISSION_DENIED:
                errorMessage += 'Please enable location services in your browser settings.';
                break;
            case error.POSITION_UNAVAILABLE:
                errorMessage += 'Location information is unavailable.';
                break;
            case error.TIMEOUT:
                errorMessage += 'Location request timed out. Please try again.';
                break;
            default:
                errorMessage += 'Please enable location services.';
        }
        
        if (currentScreen === 'home') {
            showNotification(errorMessage);
        }
        
        // Set a default city based on last known location or fallback
        currentCity = currentCity || "Lusaka";
    }

    // NEW: Update city-specific UI elements
    function updateCitySpecificUI(city) {
        // Update any UI elements that should change based on city
        const cityElement = document.getElementById('currentCity');
        if (cityElement) {
            cityElement.textContent = city;
        }
        
        // You can add more city-specific UI updates here
        console.log(`UI updated for city: ${city}`);
    }

    // ENHANCED: Popup map update function with proper zoom and bounds
    function updatePopupRideMap(ride) {
        // Clear existing map
        popupRideMap.eachLayer(layer => {
            if (layer instanceof L.Marker || layer instanceof L.Polyline) {
                popupRideMap.removeLayer(layer);
            }
        });
        
        // Add pickup marker
        const pickupMarkerPopup = L.marker([ride.pickupLat, ride.pickupLng], {
            icon: L.divIcon({
                className: 'pickup-marker',
                html: '<div class="pickup-marker"><i class="fas fa-map-marker-alt"></i></div>',
                iconSize: [22, 22]
            })
        }).addTo(popupRideMap).bindPopup('Pickup Location');
        
        // Add destination marker
        const destMarkerPopup = L.marker([ride.destLat, ride.destLng], {
            icon: L.divIcon({
                className: 'destination-marker',
                html: '<div class="destination-marker"><i class="fas fa-flag"></i></div>',
                iconSize: [22, 22]
            })
        }).addTo(popupRideMap).bindPopup('Destination');
        
        // Draw route with enhanced visualization
        drawEnhancedRouteOnPopupMap(ride.pickupLat, ride.pickupLng, ride.destLat, ride.destLng);
        
        // Calculate optimal bounds with padding
        const bounds = L.latLngBounds(
            [ride.pickupLat, ride.pickupLng],
            [ride.destLat, ride.destLng]
        );
        
        // Expand bounds slightly for better visibility
        const expandedBounds = bounds.pad(0.1);
        
        // Fit map to show both locations with optimal zoom
        popupRideMap.fitBounds(expandedBounds, { 
            padding: [15, 15],
            maxZoom: 15
        });
        
        // Add a slight zoom out for better context
        setTimeout(() => {
            popupRideMap.setZoom(popupRideMap.getZoom() - 0.5);
        }, 100);
    }

    // ENHANCED: Route drawing for popup map
    function drawEnhancedRouteOnPopupMap(startLat, startLng, endLat, endLng) {
        fetch(`https://router.project-osrm.org/route/v1/driving/${startLng},${startLat};${endLng},${endLat}?overview=full&geometries=geojson`)
            .then(response => response.json())
            .then(data => {
                if (data.routes && data.routes.length > 0) {
                    const route = data.routes[0];
                    const routeCoordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                    
                    // Draw the route on the map with enhanced styling
                    L.polyline(routeCoordinates, {
                        color: '#FF6B35',
                        weight: 5,
                        opacity: 0.8,
                        lineJoin: 'round',
                        lineCap: 'round'
                    }).addTo(popupRideMap);
                    
                    // Add start and end points with custom styling
                    L.circleMarker([startLat, startLng], {
                        color: '#FF6B35',
                        fillColor: '#FF6B35',
                        fillOpacity: 1,
                        radius: 5
                    }).addTo(popupRideMap);
                    
                    L.circleMarker([endLat, endLng], {
                        color: '#E74C3C',
                        fillColor: '#E74C3C',
                        fillOpacity: 1,
                        radius: 5
                    }).addTo(popupRideMap);
                }
            })
            .catch(error => {
                console.error('Error fetching route:', error);
                // Fallback: draw a straight line with enhanced styling
                L.polyline([
                    [startLat, startLng],
                    [endLat, endLng]
                ], {
                    color: '#FF6B35',
                    weight: 4,
                    opacity: 0.7,
                    dashArray: '10, 10'
                }).addTo(popupRideMap);
            });
    }

    // ORIGINAL FUNCTIONS (preserved with minor enhancements)

    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3;
        const 1 = lat1 * Math.PI / 180;
        const 2 = lat2 * Math.PI / 180;
        const  = (lat2 - lat1) * Math.PI / 180;
        const  = (lon2 - lon1) * Math.PI / 180;

        const a = Math.sin(/2) * Math.sin(/2) +
                  Math.cos(1) * Math.cos(2) *
                  Math.sin(/2) * Math.sin(/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

        return R * c;
    }

    function forwardGeocode(query) {
        return new Promise(resolve => {
            if (!userLocation) {
                resolve([]);
                return;
            }
            
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=10&countrycodes=zm`)
                .then(response => response.json())
                .then(data => {
                    const filteredResults = data.filter(result => {
                        const distance = calculateDistance(
                            userLocation.lat, userLocation.lng,
                            parseFloat(result.lat), parseFloat(result.lon)
                        );
                        return distance <= 50000;
                    });
                    
                    resolve(filteredResults);
                })
                .catch(error => {
                    console.error('Forward geocoding error:', error);
                    resolve([]);
                });
        });
    }

    function updateFareEstimate() {
        const destination = document.getElementById('destinationLocation').value;
        
        if (destination.length > 3 && userLocation) {
            forwardGeocode(destination).then(results => {
                if (results.length > 0) {
                    const destLat = parseFloat(results[0].lat);
                    const destLng = parseFloat(results[0].lon);
                    
                    const distance = calculateDistance(
                        userLocation.lat, userLocation.lng,
                        destLat, destLng
                    );
                    
                    // K23 base fare for all rides
                    let baseFare = 23;
                    
                    // Add distance-based fare (K1 per 90 meters after base fare)
                    if (distance > 0) {
                        baseFare += Math.ceil(distance / 90);
                    }
                    
                    switch(selectedVehicleType) {
                        case 'car':
                            baseFare = baseFare;
                            break;
                        case 'bike':
                            baseFare = baseFare * 0.7;
                            break;
                        case 'bicycle':
                            baseFare = baseFare * 0.5;
                            break;
                    }
                    
                    if (appliedPromoCode) {
                        baseFare = baseFare * 0.8;
                    }
                    
                    document.getElementById('estimatedFare').textContent = `K${baseFare.toFixed(2)}`;
                    
                    const etaMinutes = Math.ceil((distance / 1000) / 30 * 60);
                    document.getElementById('etaDisplay').textContent = `ETA: ${etaMinutes} min`;
                    
                    document.getElementById('requestRideBtn').disabled = false;
                    
                    rideFare = baseFare;
                }
            });
        } else {
            document.getElementById('estimatedFare').textContent = 'K0.00';
            document.getElementById('etaDisplay').textContent = 'ETA: -- min';
            document.getElementById('requestRideBtn').disabled = true;
        }
    }

    function updateDestinationMarker(lat, lng, name) {
        if (destinationMarker) {
            passengerMap.removeLayer(destinationMarker);
        }
        
        destinationMarker = L.marker([lat, lng], {
            icon: L.divIcon({
                className: 'destination-marker',
                html: '<div class="destination-marker"><i class="fas fa-flag"></i></div>',
                iconSize: [22, 22]
            })
        }).addTo(passengerMap)
            .bindPopup(`<strong>${name}</strong><br>Your destination`)
            .openPopup();
        
        if (userLocation) {
            const bounds = L.latLngBounds(
                [userLocation.lat, userLocation.lng],
                [lat, lng]
            );
            passengerMap.fitBounds(bounds, { padding: [12, 12] });
        }
    }

    function drawRoute(startLat, startLng, endLat, endLng) {
        if (routePolyline) {
            passengerMap.removeLayer(routePolyline);
        }
        
        fetch(`https://router.project-osrm.org/route/v1/driving/${startLng},${startLat};${endLng},${endLat}?overview=full&geometries=geojson`)
            .then(response => response.json())
            .then(data => {
                if (data.routes && data.routes.length > 0) {
                    const route = data.routes[0];
                    const routeCoordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                    
                    routePolyline = L.polyline(routeCoordinates, {
                        color: '#FF6B35',
                        weight: 4,
                        opacity: 0.7,
                        dashArray: '8, 8'
                    }).addTo(passengerMap);
                    
                    passengerMap.fitBounds(routePolyline.getBounds(), { padding: [12, 12] });
                }
            })
            .catch(error => {
                console.error('Error fetching route:', error);
                routePolyline = L.polyline([
                    [startLat, startLng],
                    [endLat, endLng]
                ], {
                    color: '#FF6B35',
                    weight: 4,
                    opacity: 0.7,
                    dashArray: '8, 8'
                }).addTo(passengerMap);
            });
    }

    // ENHANCED: Ride request function with improved address handling and search animation
    function requestRide() {
        const pickupLocation = document.getElementById('pickupLocation').value;
        const destinationLocation = document.getElementById('destinationLocation').value;
        
        if (!destinationLocation) {
            showNotification('Please enter a destination');
            return;
        }
        
        if (!currentLocationMarker) {
            showNotification('Unable to determine your location. Please try again.');
            return;
        }
        
        const pickupLatLng = currentLocationMarker.getLatLng();
        
        // Collect package details if form is active
        if (document.getElementById('packageForm').classList.contains('active')) {
            packageDetails = {
                receiverName: document.getElementById('receiverName').value,
                receiverPhone: document.getElementById('receiverPhone').value,
                packageDescription: document.getElementById('packageDescription').value,
                specialInstructions: document.getElementById('specialInstructions').value,
                packageValue: document.getElementById('packageValue').value
            };
        } else {
            packageDetails = null;
        }
        
        // Get full address for submission while showing precise address in UI
        Promise.all([
            getFullAddress(userLocation.lat, userLocation.lng),
            forwardGeocode(destinationLocation)
        ]).then(([fullPickupAddress, destinationResults]) => {
            if (destinationResults.length === 0) {
                showNotification('Invalid destination address. Please select a valid destination.');
                return;
            }
            
            const destLat = parseFloat(destinationResults[0].lat);
            const destLng = parseFloat(destinationResults[0].lon);
            
            const distance = calculateDistance(
                userLocation.lat, userLocation.lng,
                destLat, destLng
            );
            
            // K23 base fare for all rides
            let baseFare = 23;
            
            // Add distance-based fare (K1 per 90 meters after base fare)
            if (distance > 0) {
                baseFare += Math.ceil(distance / 90);
            }
            
            // Apply ride type multiplier
            switch(selectedVehicleType) {
                case 'car':
                    baseFare = baseFare;
                    break;
                case 'bike':
                    baseFare = baseFare * 0.7;
                    break;
                case 'bicycle':
                    baseFare = baseFare * 0.5;
                    break;
            }
            
            // Apply promo code discount if applicable
            if (appliedPromoCode) {
                baseFare = baseFare * 0.8;
            }
            
            // Generate a unique ride ID
            const rideId = database.ref().child('rides').push().key;
            
        // Create ride request with full address for backend and precise address for display
        const rideRequest = {
            id: rideId,
            passengerId: currentUser.uid,
            passengerName: userData.name || 'Passenger',
            passengerPhone: userData.phone || 'Not provided',
            pickupLocation: fullPickupAddress, // Full address with city, province, country for backend
            pickupDisplayLocation: pickupLocation, // Precise address without city/province/country for display
            destination: destinationLocation,
            pickupLat: pickupLatLng.lat,
            pickupLng: pickupLatLng.lng,
            destLat: destLat,
            destLng: destLng,
            rideType: selectedVehicleType,
            fare: baseFare,
            distance: (distance / 1000).toFixed(2) + ' km',
            status: 'requested',
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            updatedAt: firebase.database.ServerValue.TIMESTAMP,
            promoCode: appliedPromoCode,
            paymentMethod: selectedPaymentType,
            packageDetails: packageDetails,
            currentCity: currentCity // Store detected city for analytics
        };
        
        // If payment is via wallet, deduct fare from wallet
        if (selectedPaymentType === 'wallet') {
            const newBalance = walletBalance - baseFare;
            
            database.ref('users/' + currentUser.uid).update({
                walletBalance: newBalance
            })
            .then(() => {
                walletBalance = newBalance;
                updateWalletBalanceUI();
                
                return database.ref('rides/' + rideId).set(rideRequest);
            })
            .then(() => {
                currentRide = rideRequest;
                
                closePaymentSelection();
                
                updateUIForActiveRide();
                
                // Show searching animation
                document.getElementById('searchingAnimation').style.display = 'flex';
                
                document.getElementById('rideStatus').style.display = 'flex';
                document.getElementById('statusDot').className = 'status-dot searching';
                document.getElementById('statusText').textContent = 'Searching for driver';
                
                showNotification('Ride requested. Searching for a driver...');
                
                listenForDriverAssignment(rideId);
            })
            .catch(error => {
                console.error('Error requesting ride:', error);
                showNotification('Error requesting ride. Please try again.');
            });
        } else {
            database.ref('rides/' + rideId).set(rideRequest)
                .then(() => {
                    currentRide = rideRequest;
                    
                    closePaymentSelection();
                    
                    updateUIForActiveRide();
                    
                    // Show searching animation
                    document.getElementById('searchingAnimation').style.display = 'flex';
                    
                    document.getElementById('rideStatus').style.display = 'flex';
                    document.getElementById('statusDot').className = 'status-dot searching';
                    document.getElementById('statusText').textContent = 'Searching for driver';
                    
                    showNotification('Ride requested. Searching for a driver...');
                    
                    listenForDriverAssignment(rideId);
                })
                .catch(error => {
                    console.error('Error requesting ride:', error);
                    showNotification('Error requesting ride. Please try again.');
                });
        }
        }).catch(error => {
            console.error('Error in ride request process:', error);
            showNotification('Error calculating route. Please try again.');
        });
    }

    function showPaymentSelection() {
        const pickupLocation = document.getElementById('pickupLocation').value;
        const destinationLocation = document.getElementById('destinationLocation').value;
        
        if (!destinationLocation) {
            showNotification('Please enter a destination');
            return;
        }
        
        if (!currentLocationMarker) {
            showNotification('Unable to determine your location. Please try again.');
            return;
        }
        
        document.getElementById('paymentWalletBalance').textContent = `Balance: K${walletBalance.toFixed(2)}`;
        
        if (walletBalance < rideFare) {
            document.getElementById('insufficientBalance').style.display = 'block';
            document.getElementById('confirmPaymentBtn').disabled = true;
        } else {
            document.getElementById('insufficientBalance').style.display = 'none';
            document.getElementById('confirmPaymentBtn').disabled = false;
        }
        
        document.getElementById('paymentSelectionPopup').classList.remove('hidden');
    }

    function closePaymentSelection() {
        document.getElementById('paymentSelectionPopup').classList.add('hidden');
    }

    function updateUIForActiveRide() {
        document.getElementById('rideRequestForm').style.display = 'none';
        
        document.getElementById('rideInfoPanel').style.display = 'block';
        
        document.getElementById('currentPickupLocation').textContent = currentRide.pickupDisplayLocation || currentRide.pickupLocation;
        document.getElementById('currentDestinationLocation').textContent = currentRide.destination;
        
        const baseFare = currentRide.fare;
        const discount = appliedPromoCode ? baseFare * 0.2 : 0;
        const totalFare = baseFare - discount;
        
        document.getElementById('baseFare').textContent = `K${baseFare.toFixed(2)}`;
        document.getElementById('discountFare').textContent = `-K${discount.toFixed(2)}`;
        document.getElementById('totalFare').textContent = `K${totalFare.toFixed(2)}`;
    }

    function listenForDriverAssignment(rideId) {
        if (driverAssignmentListener) {
            driverAssignmentListener();
        }
        
        driverAssignmentListener = database.ref('rides/' + rideId).on('value', snapshot => {
            const ride = snapshot.val();
            if (!ride) {
                showNotification('Ride not found. Please try again.');
                return;
            }
            
            console.log('Ride status update:', ride.status, ride.driverId);
            
            if (ride.driverId && ride.status === 'accepted') {
                handleDriverAssignment(ride);
            } else if (ride.status === 'completed') {
                showRideCompletion(ride);
            } else if (ride.status === 'cancelled') {
                handleRideCancellation(ride);
            } else if (ride.status === 'arrived') {
                showNotification('Your driver has arrived at the pickup location.');
            } else if (ride.status === 'picked_up') {
                showNotification('You have been picked up. Enjoy your ride!');
            } else if (ride.status === 'started') {
                showNotification('Your trip has started.');
            }
        }, error => {
            console.error('Error listening for driver assignment:', error);
            showNotification('Connection error. Please check your internet connection.');
        });
    }

    function handleDriverAssignment(ride) {
        // Hide searching animation
        document.getElementById('searchingAnimation').style.display = 'none';
        
        document.getElementById('statusDot').className = 'status-dot arriving';
        document.getElementById('statusText').textContent = 'Driver arriving';
        
        document.getElementById('estimatedTime').style.display = 'flex';
        document.getElementById('timeText').textContent = '5 min';
        
        database.ref('users/' + ride.driverId).once('value')
            .then(driverSnapshot => {
                const driver = driverSnapshot.val();
                if (driver) {
                    document.getElementById('driverName').textContent = driver.name || 'Driver';
                    document.getElementById('driverPhone').textContent = driver.phone || 'N/A';
                    document.getElementById('driverRating').textContent = driver.rating || '4.5';
                    
                    if (driver.vehicle) {
                        document.getElementById('vehicleDetails').textContent = 
                            `${driver.vehicle.type || 'Vehicle'} - ${driver.vehicle.licensePlate || 'ABC123'}`;
                    }
                    
                    const driverAvatar = document.getElementById('driverAvatar');
                    if (driver.name) {
                        driverAvatar.innerHTML = driver.name.charAt(0).toUpperCase();
                    }
                    
                    updateDriverDetailsCard(driver);
                    
                    addDriverMarker(ride.driverLat, ride.driverLng);
                    
                    drawRoute(ride.driverLat, ride.driverLng, ride.pickupLat, ride.pickupLng);
                    
                    trackDriverLocation(ride.driverId);
                    
                    showNotification(`Driver ${driver.name} is on the way!`);
                }
            });
        
        listenForRideStatusUpdates(ride.id);
    }

    function updateDriverDetailsCard(driver) {
        const driverDetailsCard = document.getElementById('driverDetailsCard');
        driverDetailsCard.style.display = 'block';
        
        document.getElementById('driverFullName').textContent = driver.name || 'Driver';
        document.getElementById('driverContactPhone').textContent = driver.phone || 'Not available';
        document.getElementById('driverRatingValue').textContent = driver.rating ? `${driver.rating} ` : '4.5 ';
        document.getElementById('driverExperience').textContent = driver.experience || '2 years';
        
        if (driver.vehicle) {
            document.getElementById('vehicleType').textContent = driver.vehicle.type || 'Car';
            document.getElementById('vehicleModel').textContent = driver.vehicle.model || 'Not specified';
            document.getElementById('vehicleLicense').textContent = driver.vehicle.licensePlate || 'Not available';
            document.getElementById('vehicleColor').textContent = driver.vehicle.color || 'Not specified';
        }
    }

    function trackDriverLocation(driverId) {
        if (driverLocationListener) {
            driverLocationListener();
        }
        
        driverLocationListener = database.ref('driverLocations/' + driverId).on('value', snapshot => {
            const location = snapshot.val();
            if (location && driverMarker) {
                driverMarker.setLatLng([location.latitude, location.longitude]);
                
                updateDriverETA(location.latitude, location.longitude);
            }
        });
    }

    function updateDriverETA(driverLat, driverLng) {
        if (userLocation) {
            const distance = calculateDistance(
                driverLat, driverLng,
                userLocation.lat, userLocation.lng
            );
            
            const etaMinutes = Math.ceil((distance / 1000) / 30 * 60);
            document.getElementById('timeText').textContent = `${etaMinutes} min`;
        }
    }

    function listenForRideStatusUpdates(rideId) {
        database.ref('rides/' + rideId).on('value', snapshot => {
            const ride = snapshot.val();
            if (ride) {
                currentRide = ride;
                
                switch(ride.status) {
                    case 'accepted':
                        document.getElementById('statusText').textContent = 'Driver on the way';
                        break;
                    case 'arrived':
                        document.getElementById('statusText').textContent = 'Driver arrived';
                        document.getElementById('statusDot').className = 'status-dot riding';
                        showNotification('Your driver has arrived!');
                        break;
                    case 'started':
                        document.getElementById('statusText').textContent = 'Trip in progress';
                        addDestinationMarker(ride.destLat, ride.destLng);
                        drawRoute(ride.pickupLat, ride.pickupLng, ride.destLat, ride.destLng);
                        break;
                    case 'completed':
                        document.getElementById('statusText').textContent = 'Trip completed';
                        document.getElementById('rideStatus').style.display = 'none';
                        document.getElementById('estimatedTime').style.display = 'none';
                        resetUIAfterRide();
                        showNotification('Trip completed. Thank you for using Jubel!');
                        break;
                    case 'cancelled':
                        document.getElementById('rideStatus').style.display = 'none';
                        document.getElementById('estimatedTime').style.display = 'none';
                        resetUIAfterRide();
                        showNotification('Ride cancelled');
                        break;
                }
            }
        });
    }

    function addDriverMarker(lat, lng) {
        if (driverMarker) {
            passengerMap.removeLayer(driverMarker);
        }
        
        driverMarker = L.marker([lat, lng], {
            icon: L.divIcon({
                className: 'driver-marker',
                html: '<div class="driver-marker"></div><div class="driver-marker-label">Driver</div>',
                iconSize: [32, 45]
            })
        }).addTo(passengerMap)
            .bindPopup('Your driver');
    }

    function addDestinationMarker(lat, lng) {
        if (destinationMarker) {
            passengerMap.removeLayer(destinationMarker);
        }
        
        destinationMarker = L.marker([lat, lng], {
            icon: L.divIcon({
                className: 'destination-marker',
                html: '<div class="destination-marker"><i class="fas fa-flag"></i></div>',
                iconSize: [22, 22]
            })
        }).addTo(passengerMap)
            .bindPopup('Destination');
    }

    function handleRideCancellation(ride) {
        // Hide searching animation if still showing
        document.getElementById('searchingAnimation').style.display = 'none';
        
        showNotification('Ride has been cancelled.');
        resetUIAfterRide();
        currentRide = null;
        
        if (driverMarker) {
            passengerMap.removeLayer(driverMarker);
            driverMarker = null;
        }
        
        if (driverAssignmentListener) {
            driverAssignmentListener();
            driverAssignmentListener = null;
        }
        
        if (driverLocationListener) {
            driverLocationListener();
            driverLocationListener = null;
        }
    }

    function cancelRide() {
        if (currentRide) {
            if (confirm('Are you sure you want to cancel this ride?')) {
                database.ref('rides/' + currentRide.id).update({
                    status: 'cancelled',
                    cancelledAt: firebase.database.ServerValue.TIMESTAMP,
                    updatedAt: firebase.database.ServerValue.TIMESTAMP
                })
                .then(() => {
                    resetUIAfterRide();
                    showNotification('Ride cancelled');
                })
                .catch(error => {
                    console.error('Error cancelling ride:', error);
                    showNotification('Error cancelling ride. Please try again.');
                });
            }
        }
    }

    function contactDriver() {
        if (currentRide && currentRide.driverId) {
            database.ref('users/' + currentRide.driverId).once('value')
                .then(snapshot => {
                    const driver = snapshot.val();
                    if (driver && driver.phone) {
                        showNotification(`Calling driver: ${driver.phone}`);
                        window.open(`tel:${driver.phone}`, '_self');
                    } else {
                        showNotification('Driver phone number not available.');
                    }
                });
        }
    }

    function applyPromoCode() {
        const promoCode = document.getElementById('promoCode').value.trim();
        
        if (!promoCode) {
            showNotification('Please enter a promo code.');
            return;
        }
        
        if (promoCode.startsWith('JUBEL')) {
            applyReferralCode(promoCode);
        } else {
            if (promoCode.startsWith('JUBEL-')) {
                appliedPromoCode = promoCode;
                showNotification('Promo code applied! 20% discount will be applied to your ride.');
                updateFareEstimate();
                
                document.getElementById('promoCode').style.borderColor = 'var(--success-green)';
                document.getElementById('applyPromoBtn').innerHTML = '<i class="fas fa-check"></i> Applied';
                document.getElementById('applyPromoBtn').classList.remove('btn-promo');
                document.getElementById('applyPromoBtn').classList.add('btn-success');
            } else {
                showNotification('Invalid promo code. Please check and try again.');
                document.getElementById('promoCode').style.borderColor = 'var(--error-red)';
            }
        }
    }

    function applyReferralCode(referralCode) {
        database.ref('users').orderByChild('referralCode').equalTo(referralCode).once('value')
            .then(snapshot => {
                if (snapshot.exists()) {
                    const referrerData = snapshot.val();
                    const referrerId = Object.keys(referrerData)[0];
                    const referrer = referrerData[referrerId];
                    
                    appliedPromoCode = referralCode;
                    showNotification('Referral code applied! 50% discount will be applied to your ride.');
                updateFareEstimate();
                
                document.getElementById('promoCode').style.borderColor = 'var(--success-green)';
                document.getElementById('applyPromoBtn').innerHTML = '<i class="fas fa-check"></i> Applied';
                document.getElementById('applyPromoBtn').classList.remove('btn-promo');
                document.getElementById('applyPromoBtn').classList.add('btn-success');
                
                const newBalance = (referrer.walletBalance || 0) + 25;
                database.ref('users/' + referrerId).update({
                    walletBalance: newBalance
                })
                .then(() => {
                    console.log(`Rewarded ${referrer.name} with K25 for referral`);
                });
                
                database.ref('referrals').push().set({
                    referrerId: referrerId,
                    referredUserId: currentUser.uid,
                    referralCode: referralCode,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    rewardAmount: 25
                });
            } else {
                showNotification('Invalid referral code. Please check and try again.');
                document.getElementById('promoCode').style.borderColor = 'var(--error-red)';
            }
        })
        .catch(error => {
            console.error('Error applying referral code:', error);
            showNotification('Error applying referral code. Please try again.');
        });
    }

    function resetUIAfterRide() {
        document.getElementById('rideRequestForm').style.display = 'flex';
        
        document.getElementById('rideInfoPanel').style.display = 'none';
        
        document.getElementById('driverDetailsCard').style.display = 'none';
        
        document.getElementById('destinationLocation').value = '';
        
        document.getElementById('packageForm').classList.remove('active');
        document.getElementById('receiverName').value = '';
        document.getElementById('receiverPhone').value = '';
        document.getElementById('packageDescription').value = '';
        document.getElementById('specialInstructions').value = '';
        document.getElementById('packageValue').value = '';
        
        document.getElementById('promoCode').value = '';
        appliedPromoCode = null;
        document.getElementById('promoCode').style.borderColor = '';
        document.getElementById('applyPromoBtn').innerHTML = 'Apply';
        document.getElementById('applyPromoBtn').classList.remove('btn-success');
        document.getElementById('applyPromoBtn').classList.add('btn-promo');
        document.getElementById('promoSection').classList.remove('active');
        
        if (driverMarker) {
            passengerMap.removeLayer(driverMarker);
            driverMarker = null;
        }
        
        if (destinationMarker) {
            passengerMap.removeLayer(destinationMarker);
            destinationMarker = null;
        }
        
        if (routePolyline) {
            passengerMap.removeLayer(routePolyline);
            routePolyline = null;
        }
        
        if (driverLocationListener) {
            driverLocationListener();
            driverLocationListener = null;
        }
        
        currentRide = null;
    }

    function loadPassengerData() {
        if (currentUser) {
            updateUserStats();
        }
    }

    function loadAccountData() {
        if (currentUser && userData) {
            document.getElementById('accountName').textContent = userData.name || 'Passenger';
            document.getElementById('accountPhone').textContent = userData.phone || 'Not set';
            document.getElementById('accountEmail').textContent = userData.email || 'Not set';
            document.getElementById('referralCode').textContent = userData.referralCode || 'JUBEL-XXXX';
            
            walletBalance = userData.walletBalance || 0;
            document.getElementById('accountBalance').textContent = `K${walletBalance.toFixed(2)}`;
            
            const accountAvatar = document.getElementById('accountAvatar');
            if (userData.name) {
                accountAvatar.textContent = userData.name.charAt(0).toUpperCase();
            } else {
                accountAvatar.innerHTML = '<i class="fas fa-user"></i>';
            }
            
            updateUserStats();
        }
    }

    function updateUserStats() {
        if (!currentUser) return;
        
        database.ref('rides').orderByChild('passengerId').equalTo(currentUser.uid).once('value')
            .then(snapshot => {
                const rides = snapshot.val();
                if (rides) {
                    const ridesArray = Object.values(rides);
                    
                    userStats = {
                        completed: ridesArray.filter(ride => ride.status === 'completed' || ride.status === 'paid').length,
                        cancelled: ridesArray.filter(ride => ride.status === 'cancelled').length,
                        pending: ridesArray.filter(ride => ride.status === 'requested' || ride.status === 'accepted').length
                    };
                    
                    document.getElementById('ridesCompleted').textContent = userStats.completed;
                    document.getElementById('ridesCancelled').textContent = userStats.cancelled;
                    document.getElementById('ridesPending').textContent = userStats.pending;
                }
            });
    }

    function shareReferralCode() {
        const referralCode = document.getElementById('referralCode').textContent;
        const shareText = `Join me on Jubel! Use my referral code ${referralCode} for 50% off your first ride. Download the app now!`;
        
        if (navigator.share) {
            navigator.share({
                title: 'Jubel Referral',
                text: shareText,
                url: window.location.href
            })
            .then(() => showNotification('Referral code shared successfully!'))
            .catch(error => console.error('Error sharing:', error));
        } else {
            navigator.clipboard.writeText(shareText)
                .then(() => showNotification('Referral code copied to clipboard!'));
        }
    }

    function depositToWallet() {
        const amount = prompt('Enter deposit amount (K):');
        if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
            const depositAmount = parseFloat(amount);
            const newBalance = walletBalance + depositAmount;
            
            database.ref('users/' + currentUser.uid).update({
                walletBalance: newBalance
            })
            .then(() => {
                walletBalance = newBalance;
                updateWalletBalanceUI();
                showNotification(`Successfully deposited K${depositAmount.toFixed(2)} to your wallet.`);
            })
            .catch(error => {
                console.error('Error depositing to wallet:', error);
                showNotification('Error processing deposit. Please try again.');
            });
        } else if (amount) {
            showNotification('Please enter a valid amount.');
        }
    }

    function withdrawFromWallet() {
        if (walletBalance <= 0) {
            showNotification('Your wallet balance is zero.');
            return;
        }
        
        const amount = prompt(`Enter withdrawal amount (K). Available: K${walletBalance.toFixed(2)}:`);
        if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
            const withdrawalAmount = parseFloat(amount);
            
            if (withdrawalAmount > walletBalance) {
                showNotification('Insufficient balance for this withdrawal.');
                return;
            }
            
            const newBalance = walletBalance - withdrawalAmount;
            
            database.ref('users/' + currentUser.uid).update({
                walletBalance: newBalance
            })
            .then(() => {
                walletBalance = newBalance;
                updateWalletBalanceUI();
                showNotification(`Successfully withdrew K${withdrawalAmount.toFixed(2)} from your wallet.`);
            })
            .catch(error => {
                console.error('Error withdrawing from wallet:', error);
                showNotification('Error processing withdrawal. Please try again.');
            });
        } else if (amount) {
            showNotification('Please enter a valid amount.');
        }
    }

    function contactWhatsApp() {
        const phoneNumber = '0768658484';
        const message = 'Hello, I need assistance with Jubel rides.';
        const url = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
        window.open(url, '_blank');
    }

    function contactPhone() {
        const phoneNumber = '0768658484';
        window.open(`tel:${phoneNumber}`, '_self');
    }

    function addPaymentMethod() {
        showNotification('Payment method feature coming soon!');
    }

    function loadRideHistory() {
        if (currentUser) {
            const filter = document.getElementById('historyFilter').value;
            const dateFilter = document.getElementById('historyDate').value;
            
            if (rideHistoryListener) {
                rideHistoryListener();
            }
            
            rideHistoryListener = database.ref('rides').orderByChild('passengerId').equalTo(currentUser.uid).on('value', snapshot => {
                const historyList = document.getElementById('historyList');
                historyList.innerHTML = '';
                
                const rides = snapshot.val();
                if (rides) {
                    let ridesArray = Object.keys(rides).map(rideId => ({
                        id: rideId,
                        ...rides[rideId]
                    }));
                    
                    if (filter !== 'all') {
                        ridesArray = ridesArray.filter(ride => ride.status === filter);
                    }
                    
                    if (dateFilter) {
                        const filterDate = new Date(dateFilter);
                        ridesArray = ridesArray.filter(ride => {
                            const rideDate = new Date(ride.timestamp);
                            return rideDate.toDateString() === filterDate.toDateString();
                        });
                    }
                    
                    ridesArray.sort((a, b) => b.timestamp - a.timestamp);
                    
                    if (ridesArray.length === 0) {
                        historyList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--medium-gray);">No rides found matching your criteria.</p>';
                        return;
                    }
                    
                    ridesArray.forEach(ride => {
                        const historyItem = document.createElement('div');
                        historyItem.className = 'history-item';
                        historyItem.setAttribute('data-ride-id', ride.id);
                        
                        const date = new Date(ride.timestamp);
                        const formattedDate = date.toLocaleDateString();
                        const formattedTime = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        
                        const isDelivery = ride.rideType === 'bike' || ride.rideType === 'bicycle';
                        const typeClass = isDelivery ? 'delivery' : 'ride';
                        const typeText = isDelivery ? 'Delivery' : 'Ride';
                        
                        let statusClass = 'status-requested';
                        let statusText = getStatusText(ride.status);
                        
                        if (ride.status === 'accepted') {
                            statusClass = 'status-accepted';
                        } else if (ride.status === 'completed' || ride.status === 'paid') {
                            statusClass = 'status-completed';
                        } else if (ride.status === 'cancelled') {
                            statusClass = 'status-cancelled';
                        } else if (ride.status === 'requested') {
                            statusClass = 'status-pending';
                            statusText = 'Pending';
                        }
                        
                        let historyContent = '';
                        
                        if (isDelivery) {
                            historyContent = `
                                <div class="history-item-type ${typeClass}">${typeText}</div>
                                <div class="history-locations">
                                    <div>
                                        <strong>Pickup:</strong> ${ride.pickupDisplayLocation || ride.pickupLocation}
                                    </div>
                                    <div>
                                        <strong>Delivery:</strong> ${ride.destination}
                                    </div>
                                </div>
                                ${ride.packageDetails ? `
                                <div class="history-package-details">
                                    <div class="package-detail-row">
                                        <span class="package-detail-label">Receiver:</span>
                                        <span class="package-detail-value">${ride.packageDetails.receiverName || 'N/A'}</span>
                                    </div>
                                    <div class="package-detail-row">
                                        <span class="package-detail-label">Package:</span>
                                        <span class="package-detail-value">${ride.packageDetails.packageDescription || 'N/A'}</span>
                                    </div>
                                    <div class="package-detail-row">
                                        <span class="package-detail-label">Value:</span>
                                        <span class="package-detail-value">K${ride.packageDetails.packageValue || '0.00'}</span>
                                    </div>
                                </div>
                                ` : ''}
                                <div class="history-info">
                                    <div class="history-fare">K${ride.fare ? ride.fare.toFixed(2) : '0.00'}</div>
                                    <div>${formattedDate} ${formattedTime}</div>
                                    <div class="status-badge ${statusClass}">
                                        ${statusText}
                                    </div>
                                </div>
                            `;
                        } else {
                            historyContent = `
                                <div class="history-item-type ${typeClass}">${typeText}</div>
                                <div class="history-locations">
                                    <div>
                                        <strong>From:</strong> ${ride.pickupDisplayLocation || ride.pickupLocation}
                                    </div>
                                    <div>
                                        <strong>To:</strong> ${ride.destination}
                                    </div>
                                </div>
                                <div class="history-info">
                                    <div class="history-fare">K${ride.fare ? ride.fare.toFixed(2) : '0.00'}</div>
                                    <div>${formattedDate} ${formattedTime}</div>
                                    <div class="status-badge ${statusClass}">
                                        ${statusText}
                                    </div>
                                </div>
                            `;
                        }
                        
                        if (ride.driverId) {
                            database.ref('users/' + ride.driverId).once('value')
                                .then(driverSnapshot => {
                                    const driver = driverSnapshot.val();
                                    if (driver) {
                                        const driverInfo = document.createElement('div');
                                        driverInfo.className = 'history-driver-info';
                                        driverInfo.innerHTML = `
                                            <div class="history-driver-avatar">
                                                ${driver.name ? driver.name.charAt(0).toUpperCase() : 'D'}
                                            </div>
                                            <div class="history-driver-details">
                                                <div class="history-driver-name">${driver.name || 'Driver'}</div>
                                                <div class="history-driver-rating">${driver.rating || '4.5'} </div>
                                            </div>
                                        `;
                                        historyItem.appendChild(driverInfo);
                                    }
                                });
                        }
                        
                        historyItem.innerHTML = historyContent;
                        historyList.appendChild(historyItem);
                    });
                } else {
                    historyList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--medium-gray);">No ride history found.</p>';
                }
            }, error => {
                console.error('Error loading ride history:', error);
                historyList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--error-red);">Error loading ride history.</p>';
            });
        }
    }

    function getStatusText(status) {
        const statusMap = {
            'requested': 'Awaiting Driver',
            'accepted': 'In Progress',
            'completed': 'Completed',
            'paid': 'Completed',
            'cancelled': 'Cancelled',
            'arrived': 'Driver Arrived',
            'picked_up': 'Picked Up',
            'started': 'Trip Started'
        };
        
        return statusMap[status] || status;
    }

    function showRideDetailsPopup(rideId) {
        database.ref('rides/' + rideId).once('value')
            .then(snapshot => {
                const ride = snapshot.val();
                if (ride) {
                    document.getElementById('popupRidePickup').textContent = ride.pickupDisplayLocation || ride.pickupLocation;
                    document.getElementById('popupRideDestination').textContent = ride.destination;
                    document.getElementById('popupRideFare').textContent = `K${ride.fare ? ride.fare.toFixed(2) : '0.00'}`;
                    document.getElementById('popupRideDistance').textContent = ride.distance || 'Calculating...';
                    document.getElementById('popupRideStatus').textContent = getStatusText(ride.status);
                    document.getElementById('popupRideType').textContent = ride.rideType ? ride.rideType.charAt(0).toUpperCase() + ride.rideType.slice(1) : 'Standard';
                    
                    const date = new Date(ride.timestamp);
                    document.getElementById('popupRideDate').textContent = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    updatePopupRideMap(ride);
                    
                    if (ride.driverId) {
                        database.ref('users/' + ride.driverId).once('value')
                            .then(driverSnapshot => {
                                const driver = driverSnapshot.val();
                                if (driver) {
                                    document.getElementById('popupDriverName').textContent = driver.name || 'Driver';
                                    document.getElementById('popupDriverPhone').textContent = driver.phone || 'N/A';
                                    document.getElementById('popupDriverVehicle').textContent = `${driver.vehicleType || 'Car'} (${driver.licensePlate || 'N/A'})`;
                                    document.getElementById('popupDriverRating').textContent = driver.rating || '4.5';
                                    
                                    updateDriverProgress(ride.status);
                                    
                                    document.getElementById('popupDriverDetails').classList.remove('hidden');
                                }
                            });
                    } else {
                        document.getElementById('popupDriverDetails').classList.add('hidden');
                    }
                    
                    document.getElementById('rideDetailsPopup').classList.remove('hidden');
                }
            })
            .catch(error => {
                console.error('Error loading ride details:', error);
                showNotification('Error loading ride details.');
            });
    }

    function updateDriverProgress(status) {
        const progressElement = document.getElementById('popupDriverProgress');
        
        switch(status) {
            case 'requested':
                progressElement.textContent = 'Waiting for driver to accept';
                break;
            case 'accepted':
                progressElement.textContent = 'Driver on the way to pickup';
                break;
            case 'arrived':
                progressElement.textContent = 'Driver arrived at pickup location';
                break;
            case 'picked_up':
                progressElement.textContent = 'Passenger picked up';
                break;
            case 'started':
                progressElement.textContent = 'Trip in progress';
                break;
            case 'completed':
                progressElement.textContent = 'Trip completed';
                break;
            case 'paid':
                progressElement.textContent = 'Payment completed';
                break;
            default:
                progressElement.textContent = 'Status: ' + status;
        }
    }

    function closeRideDetailsPopup() {
        document.getElementById('rideDetailsPopup').classList.add('hidden');
    }

    function setRating(rating) {
        userRating = rating;
        document.querySelectorAll('.star').forEach(star => {
            const starRating = parseInt(star.getAttribute('data-rating'));
            if (starRating <= rating) {
                star.classList.add('active');
            } else {
                star.classList.remove('active');
            }
        });
    }

    function showRideCompletion(ride) {
        document.getElementById('finalFare').textContent = `K${ride.fare.toFixed(2)}`;
        
        switchScreen('rideCompletionScreen');
        showNotification('Ride completed. Please complete payment and rating.');
        
        if (driverMarker) {
            passengerMap.removeLayer(driverMarker);
            driverMarker = null;
        }
        
        if (driverAssignmentListener) {
            driverAssignmentListener();
            driverAssignmentListener = null;
        }
        
        if (driverLocationListener) {
            driverLocationListener();
            driverLocationListener = null;
        }
    }

    function centerMap() {
        if (currentLocationMarker) {
            const passengerLatLng = currentLocationMarker.getLatLng();
            passengerMap.setView(passengerLatLng, 16);
            showNotification('Map centered on your location');
        }
    }

    function togglePanelCollapse() {
        const panel = document.getElementById('passengerPanel');
        panel.classList.toggle('collapsed');
    }

    function useSavedLocation(addressType) {
        if (userData) {
            const address = userData[addressType + 'Address'];
            
            if (address) {
                document.getElementById('destinationLocation').value = address;
                updateFareEstimate();
                showNotification(`${addressType.charAt(0).toUpperCase() + addressType.slice(1)} address set as destination.`);
                
                forwardGeocode(address).then(results => {
                    if (results.length > 0) {
                        updateDestinationMarker(
                            parseFloat(results[0].lat),
                            parseFloat(results[0].lon),
                            address
                        );
                        
                        drawRoute(userLocation.lat, userLocation.lng, parseFloat(results[0].lat), parseFloat(results[0].lon));
                        
                        document.getElementById('requestRideBtn').disabled = false;
                    }
                });
            } else {
                showNotification(`No ${addressType} address saved. Please add it in settings.`);
            }
        }
    }

    function hideDestinationSuggestions() {
        const suggestionsContainer = document.getElementById('destinationSuggestions');
        suggestionsContainer.style.display = 'none';
        
        // Clear any pending search timeouts
        if (window.searchTimeout) {
            clearTimeout(window.searchTimeout);
            window.searchTimeout = null;
        }
    }

    function getPlaceType(place) {
        if (place.type === 'restaurant' || place.class === 'amenity' && place.type === 'restaurant') {
            return 'restaurant';
        } else if (place.type === 'cafe' || place.class === 'amenity' && place.type === 'cafe') {
            return 'cafe';
        } else if (place.type === 'bar' || place.class === 'amenity' && place.type === 'bar') {
            return 'bar';
        } else if (place.type === 'pub' || place.class === 'amenity' && place.type === 'pub') {
            return 'pub';
        } else if (place.type === 'fast_food' || place.class === 'amenity' && place.type === 'fast_food') {
            return 'fast_food';
        } else if (place.type === 'bank' || place.class === 'amenity' && place.type === 'bank') {
            return 'bank';
        } else if (place.type === 'atm' || place.class === 'amenity' && place.type === 'atm') {
            return 'atm';
        } else if (place.type === 'hospital' || place.class === 'amenity' && place.type === 'hospital') {
            return 'hospital';
        } else if (place.type === 'pharmacy' || place.class === 'amenity' && place.type === 'pharmacy') {
            return 'pharmacy';
        } else if (place.type === 'school' || place.class === 'amenity' && place.type === 'school') {
            return 'school';
        } else if (place.type === 'university' || place.class === 'amenity' && place.type === 'university') {
            return 'university';
        } else if (place.type === 'library' || place.class === 'amenity' && place.type === 'library') {
            return 'library';
        } else if (place.type === 'cinema' || place.class === 'amenity' && place.type === 'cinema') {
            return 'cinema';
        } else if (place.type === 'theatre' || place.class === 'amenity' && place.type === 'theatre') {
            return 'theatre';
        } else if (place.type === 'museum' || place.class === 'amenity' && place.type === 'museum') {
            return 'museum';
        } else if (place.type === 'hotel' || place.class === 'tourism' && place.type === 'hotel') {
            return 'hotel';
        } else if (place.type === 'supermarket' || place.class === 'shop' && place.type === 'supermarket') {
            return 'supermarket';
        } else if (place.type === 'mall' || place.class === 'shop' && place.type === 'mall') {
            return 'mall';
        } else if (place.type === 'clothes' || place.class === 'shop' && place.type === 'clothes') {
            return 'clothes';
        } else if (place.type === 'fuel' || place.class === 'amenity' && place.type === 'fuel') {
            return 'fuel';
        } else if (place.type === 'parking' || place.class === 'amenity' && place.type === 'parking') {
            return 'parking';
        } else if (place.type === 'bus_station' || place.class === 'amenity' && place.type === 'bus_station') {
            return 'bus_station';
        } else if (place.type === 'taxi' || place.class === 'amenity' && place.type === 'taxi') {
            return 'taxi';
        } else if (place.type === 'police' || place.class === 'amenity' && place.type === 'police') {
            return 'police';
        } else if (place.type === 'market' || place.class === 'amenity' && place.type === 'marketplace') {
            return 'market';
        } else if (place.type === 'post_office' || place.class === 'amenity' && place.type === 'post_office') {
            return 'post_office';
        } else if (place.type === 'place_of_worship' || place.class === 'amenity' && place.type === 'place_of_worship') {
            return 'place_of_worship';
        } else if (place.type === 'stadium' || place.class === 'leisure' && place.type === 'stadium') {
            return 'stadium';
        } else if (place.type === 'park' || place.class === 'leisure' && place.type === 'park') {
            return 'park';
        } else if (place.type === 'monument' || place.class === 'historic' && place.type === 'monument') {
            return 'monument';
        } else if (place.type === 'castle' || place.class === 'historic' && place.type === 'castle') {
            return 'castle';
        } else {
            return 'place';
        }
    }

    function getPlaceIcon(placeType) {
        const icons = {
            'restaurant': '',
            'cafe': '',
            'bar': '',
            'pub': '',
            'fast_food': '',
            'bank': '',
            'atm': '',
            'hospital': '',
            'pharmacy': '',
            'school': '',
            'university': '',
            'library': '',
            'cinema': '',
            'theatre': '',
            'museum': '',
            'hotel': '',
            'supermarket': '',
            'mall': '',
            'clothes': '',
            'fuel': '',
            'parking': '',
            'bus_station': '',
            'taxi': '',
            'police': '',
            'market': '',
            'post_office': '',
            'place_of_worship': '',
            'stadium': '',
            'park': '',
            'monument': '',
            'castle': ''
        };
        
        return icons[placeType] || '';
    }

    function startLocationTracking() {
        if (navigator.geolocation && currentUser) {
            navigator.geolocation.watchPosition(position => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                userLocation = { lat, lng };
                
                database.ref('passengerLocations/' + currentUser.uid).set({
                    latitude: lat,
                    longitude: lng,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                
                if (currentLocationMarker) {
                    currentLocationMarker.setLatLng([lat, lng]);
                }
                
                if (destinationMarker) {
                    const destination = document.getElementById('destinationLocation').value;
                    if (destination) {
                        updateFareEstimate();
                    }
                }
            }, error => {
                console.error('Location tracking error:', error);
            }, {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 30000
            });
        }
    }

    function showNotification(message) {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.style.display = 'block';
        
        setTimeout(() => {
            notification.style.display = 'none';
        }, 4000);
    }

    // Enhanced switch screen function with home screen refresh capability
    function switchScreen(screenId) {
        // Store current screen for refresh logic
        const previousScreen = currentScreen;
        currentScreen = screenId;
        
        // Hide all screens
        document.querySelectorAll('.screen-content').forEach(screen => {
            screen.classList.remove('active');
        });
        
        // Show selected screen
        document.getElementById(screenId + 'Screen').classList.add('active');
        
        // Update active nav button
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`.nav-btn[data-screen="${screenId}"]`).classList.add('active');
        
        // Show/hide floating elements based on screen
        if (screenId === 'home') {
            document.querySelectorAll('.home-only').forEach(el => {
                el.style.display = 'flex';
            });
            
            // Refresh home screen if coming from another screen
            if (previousScreen !== 'home' && homeScreenRefreshRequired) {
                refreshHomeScreen();
            }
        } else {
            document.querySelectorAll('.home-only').forEach(el => {
                el.style.display = 'none';
            });
            
            // Mark that home screen needs refresh when returning
            homeScreenRefreshRequired = true;
        }
        
        // Load data for specific screens
        if (screenId === 'history') {
            loadRideHistory();
        } else if (screenId === 'account') {
            loadAccountData();
        } else if (screenId === 'payments') {
            // Payments screen data loading if needed
        }
    }

    // Enhanced home screen refresh function
    function refreshHomeScreen() {
        console.log("Refreshing home screen...");
        
        // Refresh passenger position and map
        refreshPassengerPosition();
        
        // Clear any existing destination
        document.getElementById('destinationLocation').value = '';
        
        // Clear any existing markers and routes
        if (destinationMarker) {
            passengerMap.removeLayer(destinationMarker);
            destinationMarker = null;
        }
        
        if (routePolyline) {
            passengerMap.removeLayer(routePolyline);
            routePolyline = null;
        }
        
        // Reset fare estimate
        document.getElementById('estimatedFare').textContent = 'K0.00';
        document.getElementById('etaDisplay').textContent = 'ETA: -- min';
        document.getElementById('requestRideBtn').disabled = true;
        
        // Reset promo section
        document.getElementById('promoSection').classList.remove('active');
        document.getElementById('promoCode').value = '';
        appliedPromoCode = null;
        
        // Reset package form
        document.getElementById('packageForm').classList.remove('active');
        document.getElementById('packageToggle').style.display = 'none';
        
        // Ensure ride request form is visible
        document.getElementById('rideRequestForm').style.display = 'flex';
        document.getElementById('rideInfoPanel').style.display = 'none';
        
        homeScreenRefreshRequired = false;
        
        showNotification('Home screen refreshed');
    }

    // Event listeners setup
    function setupEventListeners() {
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const screen = this.getAttribute('data-screen');
                switchScreen(screen);
            });
        });
        
        document.querySelectorAll('.back-button').forEach(btn => {
            btn.addEventListener('click', function() {
                const screen = this.getAttribute('data-screen');
                switchScreen(screen);
            });
        });
        
        document.querySelectorAll('.vehicle-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.vehicle-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                
                this.classList.add('selected');
                
                selectedVehicleType = this.getAttribute('data-type');
                
                if (selectedVehicleType === 'bike' || selectedVehicleType === 'bicycle') {
                    document.getElementById('packageToggle').style.display = 'flex';
                } else {
                    document.getElementById('packageToggle').style.display = 'none';
                    document.getElementById('packageForm').classList.remove('active');
                }
                
                updateFareEstimate();
            });
        });
        
        document.getElementById('packageToggle').addEventListener('click', function() {
            document.getElementById('packageForm').classList.toggle('active');
        });
        
        document.querySelectorAll('.payment-method').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.payment-method').forEach(opt => {
                    opt.classList.remove('selected');
                });
                this.classList.add('selected');
                paymentMethod = this.getAttribute('data-method');
            });
        });
        
        document.querySelectorAll('.payment-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.payment-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                this.classList.add('selected');
                selectedPaymentType = this.getAttribute('data-payment-type');
                
                if (selectedPaymentType === 'wallet') {
                    if (walletBalance < rideFare) {
                        document.getElementById('insufficientBalance').style.display = 'block';
                        document.getElementById('confirmPaymentBtn').disabled = true;
                    } else {
                        document.getElementById('insufficientBalance').style.display = 'none';
                        document.getElementById('confirmPaymentBtn').disabled = false;
                    }
                } else {
                    document.getElementById('insufficientBalance').style.display = 'none';
                    document.getElementById('confirmPaymentBtn').disabled = false;
                }
            });
        });
        
        document.getElementById('requestRideBtn').addEventListener('click', showPaymentSelection);
        
        document.getElementById('confirmPaymentBtn').addEventListener('click', requestRide);
        
        document.getElementById('closePaymentPopup').addEventListener('click', closePaymentSelection);
        
        document.getElementById('cancelRideBtn').addEventListener('click', cancelRide);
        
        document.getElementById('contactDriverBtn').addEventListener('click', contactDriver);
        
        document.getElementById('promoToggle').addEventListener('click', function() {
            document.getElementById('promoSection').classList.toggle('active');
        });
        
        document.getElementById('applyPromoBtn').addEventListener('click', applyPromoCode);
        
        document.getElementById('shareReferralBtn').addEventListener('click', shareReferralCode);
        document.getElementById('depositBtn').addEventListener('click', depositToWallet);
        document.getElementById('withdrawBtn').addEventListener('click', withdrawFromWallet);
        document.getElementById('whatsappBtn').addEventListener('click', contactWhatsApp);
        document.getElementById('callBtn').addEventListener('click', contactPhone);
        
        document.getElementById('addPaymentMethodBtn').addEventListener('click', addPaymentMethod);
        
        document.getElementById('panelCollapseHandle').addEventListener('click', togglePanelCollapse);
        
        setupDestinationInputListener();
        
        document.addEventListener('click', function(e) {
            if (!e.target.closest('#destinationLocation') && 
                !e.target.closest('#destinationSuggestions')) {
                hideDestinationSuggestions();
            }
        });
        
        document.querySelectorAll('.saved-location-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const addressType = this.getAttribute('data-address');
                useSavedLocation(addressType);
            });
        });
        
        document.getElementById('historyFilter').addEventListener('change', loadRideHistory);
        document.getElementById('historyDate').addEventListener('change', loadRideHistory);
        
        document.addEventListener('click', function(e) {
            if (e.target.closest('.history-item')) {
                const historyItem = e.target.closest('.history-item');
                const rideId = historyItem.getAttribute('data-ride-id');
                if (rideId) {
                    showRideDetailsPopup(rideId);
                }
            }
        });
        
        document.getElementById('closeRidePopup').addEventListener('click', closeRideDetailsPopup);
        document.getElementById('closeRidePopupTop').addEventListener('click', closeRideDetailsPopup);
        
        document.querySelectorAll('.star').forEach(star => {
            star.addEventListener('click', function() {
                const rating = parseInt(this.getAttribute('data-rating'));
                setRating(rating);
            });
        });
    }

    // Enhanced initialization to ensure all functionality works together
    function initializeApp() {
        console.log("Jubel Passenger App Initialized with Enhanced Features");
        
        // Periodic city detection updates
        setInterval(() => {
            if (userLocation && currentScreen === 'home') {
                determineCurrentCity(userLocation.lat, userLocation.lng)
                    .then(city => {
                        console.log("Periodic city update:", city);
                    })
                    .catch(error => {
                        console.error("Periodic city detection failed:", error);
                    });
            }
        }, 60000); // Update every minute
        
        // Handle app visibility changes
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && currentScreen === 'home') {
                setTimeout(refreshHomeScreen, 1000);
            }
        });
        
        // Handle page load completion
        window.addEventListener('load', function() {
            console.log("Jubel Passenger App fully loaded with enhanced city detection and search");
            showNotification('Jubel Passenger App Ready');
        });
    }

    // Handle offline/online status
    window.addEventListener('online', function() {
        showNotification('Connection restored.');
        // Refresh location and city detection when coming back online
        if (currentScreen === 'home') {
            setTimeout(refreshPassengerPosition, 1000);
        }
    });

    window.addEventListener('offline', function() {
        showNotification('You are currently offline. Some features may not work.');
    });

    // Initialize enhanced app features
    initializeApp();
    </script>
</body>
</html>
