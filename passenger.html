<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jubel - Passenger</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
    --primary-orange: #FF6B35;
    --primary-red: #E74C3C;
    --primary-gradient: linear-gradient(135deg, #FF6B35, #E74C3C);
    --secondary-orange: #E55A28;
    --secondary-red: #C0392B;
    --light-orange: #FFF5F0;
    --light-red: #FCE8E6;
    --white: #FFFFFF;
    --off-white: #F9F9F9;
    --light-gray: #F5F5F5;
    --medium-gray: #E0E0E0;
    --dark-gray: #333333;
    --text-gray: #666666;
    --text-light: #888888;
    --success-green: #2ECC71;
    --warning-yellow: #F39C12;
    --info-blue: #3498DB;
    --error-red: #E74C3C;
    --border-color: #EEEEEE;
    --shadow-light: 0 1px 3px rgba(0, 0, 0, 0.05);
    --shadow-medium: 0 2px 6px rgba(0, 0, 0, 0.08);
    --shadow-heavy: 0 3px 8px rgba(0, 0, 0, 0.1);
    --app-padding: 8px;
    --element-radius: 8px;
    --button-radius: 12px;
    --card-radius: 10px;
    --transition-speed: 0.2s;
    --ambulance-blue: #2980B9;
    --fire-truck-red: #C0392B;
    --police-blue: #2C3E50;
    --premium-gold: #FFD700;
    --economy-green: #27AE60;
    --light-truck-brown: #8B4513;
    --delivery-purple: #8E44AD;
    --express-shop-green: #16A085;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
}

body {
    background-color: var(--off-white);
    color: var(--dark-gray);
    max-width: 100%;
    overflow-x: hidden;
    height: 100vh;
    font-size: 13px;
    line-height: 1.3;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    position: relative;
}

/* Map Styles */
#map {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 50%;
    z-index: 1;
    background: #f8f9fa;
}

.map-loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.95);
    z-index: 2;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 8px;
    backdrop-filter: blur(5px);
}

.loading-spinner {
    width: 36px;
    height: 36px;
    border: 3px solid var(--light-gray);
    border-radius: 50%;
    border-top-color: var(--primary-orange);
    animation: spin 1s linear infinite;
}

.map-loading-text {
    font-size: 12px;
    font-weight: 600;
    color: var(--dark-gray);
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Top Bar */
.top-bar {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    z-index: 200;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px var(--app-padding);
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border-color);
    height: 50px;
}

.logo-container {
    display: flex;
    align-items: center;
    gap: 6px;
}

.logo-icon {
    width: 28px;
    height: 28px;
    background: var(--primary-gradient);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--white);
    font-weight: 700;
    font-size: 12px;
    overflow: hidden;
    box-shadow: var(--shadow-medium);
}

.logo-icon img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.logo-text {
    font-size: 14px;
    font-weight: 700;
    color: var(--dark-gray);
    line-height: 1.2;
}

.user-actions {
    display: flex;
    align-items: center;
    gap: 6px;
}

.balance-badge {
    background: var(--white);
    padding: 4px 8px;
    border-radius: var(--button-radius);
    box-shadow: var(--shadow-light);
    display: flex;
    align-items: center;
    gap: 4px;
    font-weight: 600;
    color: var(--dark-gray);
    border: 1px solid var(--border-color);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    font-size: 11px;
}

.balance-badge:hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow-medium);
}

.balance-amount {
    color: var(--primary-orange);
    font-weight: 700;
    font-size: 11px;
}

.notification-bell {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--white);
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: var(--shadow-light);
    border: 1px solid var(--border-color);
    cursor: pointer;
    position: relative;
    transition: all var(--transition-speed) ease;
}

.notification-bell:hover {
    transform: scale(1.1);
}

.notification-badge {
    position: absolute;
    top: -2px;
    right: -2px;
    width: 14px;
    height: 14px;
    background: var(--error-red);
    color: var(--white);
    border-radius: 50%;
    font-size: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    border: 2px solid var(--white);
}

/* Status Indicators */
.ride-status-bar {
    position: absolute;
    top: 54px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 150;
    display: none;
    background: var(--white);
    padding: 6px 12px;
    border-radius: var(--button-radius);
    box-shadow: var(--shadow-heavy);
    border: 1px solid var(--border-color);
    align-items: center;
    gap: 8px;
    min-width: 240px;
    max-width: 85%;
    font-size: 11px;
}

.ride-status-bar.active {
    display: flex;
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from {
        transform: translateX(-50%) translateY(-20px);
        opacity: 0;
    }
    to {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
    }
}

.status-indicator {
    display: flex;
    align-items: center;
    gap: 4px;
}

.status-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--warning-yellow);
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(1.1); }
    100% { opacity: 1; transform: scale(1); }
}

.status-dot.searching { background: var(--warning-yellow); }
.status-dot.arriving { background: var(--info-blue); }
.status-dot.riding { background: var(--success-green); animation: none; }

.status-text {
    font-weight: 600;
    font-size: 11px;
    color: var(--dark-gray);
}

.status-eta {
    margin-left: auto;
    display: flex;
    align-items: center;
    gap: 3px;
    color: var(--text-gray);
    font-size: 10px;
    font-weight: 500;
}

.emergency-status {
    position: absolute;
    top: 54px;
    right: var(--app-padding);
    z-index: 150;
    background: linear-gradient(135deg, var(--error-red), #C0392B);
    color: var(--white);
    padding: 6px 10px;
    border-radius: var(--button-radius);
    box-shadow: var(--shadow-heavy);
    display: none;
    align-items: center;
    gap: 4px;
    font-weight: 700;
    font-size: 11px;
    animation: emergencyPulse 1s infinite;
}

@keyframes emergencyPulse {
    0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
    70% { transform: scale(1.02); box-shadow: 0 0 0 6px rgba(231, 76, 60, 0); }
    100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
}

.city-detection {
    position: absolute;
    top: 54px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 150;
    background: var(--white);
    padding: 6px 12px;
    border-radius: var(--button-radius);
    box-shadow: var(--shadow-heavy);
    border: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    font-weight: 500;
    color: var(--dark-gray);
}

/* SOS Button */
.sos-button {
    position: absolute;
    bottom: 150px;
    right: var(--app-padding);
    z-index: 150;
    width: 50px;
    height: 50px;
    background: linear-gradient(135deg, var(--error-red), #C0392B);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--white);
    font-size: 14px;
    font-weight: 700;
    box-shadow: var(--shadow-heavy);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    animation: sosPulse 2s infinite;
    border: 2px solid var(--white);
}

.sos-button:hover {
    transform: scale(1.1);
    box-shadow: 0 0 15px rgba(231, 76, 60, 0.4);
}

@keyframes sosPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

/* Map Controls */
.map-controls {
    position: absolute;
    top: 90px;
    right: var(--app-padding);
    z-index: 100;
    display: flex;
    flex-direction: column;
    gap: 6px;
    background: var(--white);
    padding: 6px;
    border-radius: var(--element-radius);
    box-shadow: var(--shadow-heavy);
    border: 1px solid var(--border-color);
}

.map-control-btn {
    width: 34px;
    height: 34px;
    border-radius: var(--element-radius);
    background: var(--white);
    border: 1px solid var(--border-color);
    box-shadow: var(--shadow-light);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--dark-gray);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
}

.map-control-btn:hover {
    background: var(--primary-orange);
    color: var(--white);
    transform: scale(1.1);
}

/* Main Panel */
.main-panel {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--white);
    border-radius: var(--card-radius) var(--card-radius) 0 0;
    box-shadow: 0 -3px 20px rgba(0, 0, 0, 0.1);
    z-index: 100;
    padding: var(--app-padding);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    max-height: 50vh;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: var(--primary-orange) var(--light-gray);
}

.main-panel::-webkit-scrollbar {
    width: 3px;
}

.main-panel::-webkit-scrollbar-track {
    background: var(--light-gray);
    border-radius: 2px;
}

.main-panel::-webkit-scrollbar-thumb {
    background: var(--primary-orange);
    border-radius: 2px;
}

.main-panel.collapsed {
    transform: translateY(calc(100% - 40px));
}

.panel-handle {
    width: 30px;
    height: 3px;
    background: var(--medium-gray);
    border-radius: 2px;
    margin: 0 auto 8px;
    cursor: pointer;
    transition: all var(--transition-speed) ease;
}

.panel-handle:hover {
    background: var(--primary-orange);
    width: 36px;
}

/* Navigation Tabs */
.nav-tabs {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 6px;
    margin-bottom: 12px;
    padding: 3px;
    background: var(--light-gray);
    border-radius: var(--button-radius);
}

.nav-tab {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 3px;
    padding: 8px 6px;
    border-radius: calc(var(--button-radius) - 4px);
    background: transparent;
    border: none;
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    color: var(--text-gray);
    font-size: 10px;
    font-weight: 600;
}

.nav-tab i {
    font-size: 14px;
    transition: all var(--transition-speed) ease;
}

.nav-tab.active {
    background: var(--white);
    color: var(--primary-orange);
    box-shadow: var(--shadow-light);
}

.nav-tab.active i {
    color: var(--primary-orange);
    transform: translateY(-1px);
}

.nav-tab:hover:not(.active) {
    background: rgba(255, 107, 53, 0.1);
    color: var(--primary-orange);
}

/* Quick Actions */
.quick-actions {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
    margin-bottom: 12px;
}

.quick-action-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px;
    background: var(--white);
    border: 1px solid var(--border-color);
    border-radius: var(--element-radius);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    text-align: left;
    border: none;
    width: 100%;
}

.quick-action-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
    border-color: var(--primary-orange);
}

.quick-action-icon {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    background: var(--light-orange);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary-orange);
    font-size: 14px;
}

.quick-action-text {
    flex: 1;
}

.quick-action-title {
    font-weight: 600;
    font-size: 12px;
    color: var(--dark-gray);
    margin-bottom: 2px;
}

.quick-action-desc {
    font-size: 10px;
    color: var(--text-light);
}

/* Service Tabs */
.service-tabs {
    display: flex;
    gap: 6px;
    margin-bottom: 12px;
    overflow-x: auto;
    padding-bottom: 3px;
}

.service-tabs::-webkit-scrollbar {
    display: none;
}

.service-tab {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 3px;
    padding: 10px 12px;
    background: var(--white);
    border: 2px solid var(--border-color);
    border-radius: var(--element-radius);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    min-width: 90px;
    text-align: center;
    flex-shrink: 0;
    border: none;
}

.service-tab:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
}

.service-tab.active {
    border-color: var(--primary-orange);
    background: var(--light-orange);
    box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
}

.service-tab.car.active { border-color: var(--primary-orange); }
.service-tab.delivery.active { border-color: var(--delivery-purple); background: #F4E6FA; }
.service-tab.short-delivery.active { border-color: var(--express-shop-green); background: #E1F5FE; }

.service-icon {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: var(--light-gray);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    color: var(--text-gray);
    transition: all var(--transition-speed) ease;
}

.service-tab.active .service-icon {
    background: var(--primary-orange);
    color: var(--white);
}

.service-tab.delivery.active .service-icon {
    background: var(--delivery-purple);
}

.service-tab.short-delivery.active .service-icon {
    background: var(--express-shop-green);
}

.service-name {
    font-weight: 600;
    font-size: 11px;
    color: var(--dark-gray);
}

.service-desc {
    font-size: 9px;
    color: var(--text-light);
    margin-top: 2px;
}

/* Ride Request Form */
.ride-request-form {
    background: var(--white);
    border-radius: var(--element-radius);
    padding: 12px;
    margin-bottom: 8px;
    box-shadow: var(--shadow-light);
    border: 1px solid var(--border-color);
}

.form-title {
    font-size: 13px;
    font-weight: 700;
    margin-bottom: 12px;
    color: var(--dark-gray);
    display: flex;
    align-items: center;
    gap: 6px;
}

.location-inputs {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 12px;
}

.location-input {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px;
    background: var(--off-white);
    border: 2px solid transparent;
    border-radius: var(--element-radius);
    transition: all var(--transition-speed) ease;
    position: relative;
}

.location-input.active {
    border-color: var(--primary-orange);
    background: var(--white);
    box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
}

.location-input i {
    color: var(--primary-orange);
    font-size: 12px;
    width: 16px;
    text-align: center;
}

.location-input input {
    flex: 1;
    border: none;
    background: transparent;
    outline: none;
    font-size: 12px;
    color: var(--dark-gray);
    font-weight: 500;
}

.location-input input::placeholder {
    color: var(--text-light);
}

/* Search Results Dropdown */
.search-results-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--white);
    border: 1px solid var(--border-color);
    border-radius: var(--element-radius);
    box-shadow: var(--shadow-heavy);
    z-index: 1001;
    max-height: 250px;
    overflow-y: auto;
    display: none;
    margin-top: 4px;
    animation: slideDown 0.2s ease;
}

.search-results-dropdown.active {
    display: block;
}

.search-result-item {
    padding: 10px 12px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    display: flex;
    align-items: flex-start;
    gap: 10px;
    background: var(--white);
}

.search-result-item:hover {
    background: var(--light-orange);
    transform: translateX(2px);
}

.search-result-item:last-child {
    border-bottom: none;
}

.search-result-icon {
    width: 28px;
    height: 28px;
    border-radius: 6px;
    background: var(--light-orange);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary-orange);
    font-size: 12px;
    flex-shrink: 0;
    margin-top: 2px;
}

.search-result-content {
    flex: 1;
    min-width: 0;
}

.search-result-title {
    font-weight: 600;
    font-size: 12px;
    color: var(--dark-gray);
    margin-bottom: 3px;
    line-height: 1.2;
    display: flex;
    align-items: center;
    gap: 4px;
}

.search-result-verified {
    color: var(--success-green);
    font-size: 9px;
}

.search-result-address {
    font-size: 11px;
    color: var(--text-gray);
    line-height: 1.3;
    margin-bottom: 4px;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.search-result-details {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 9px;
}

.search-result-distance {
    color: var(--primary-orange);
    font-weight: 600;
    background: rgba(255, 107, 53, 0.1);
    padding: 2px 6px;
    border-radius: 8px;
}

.search-result-type {
    color: var(--text-light);
    text-transform: capitalize;
}

.search-header {
    padding: 10px 12px;
    border-bottom: 1px solid var(--border-color);
    background: var(--off-white);
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 10px;
    color: var(--text-gray);
}

.search-count {
    font-weight: 600;
    color: var(--primary-orange);
}

.search-no-results {
    padding: 25px 15px;
    text-align: center;
    color: var(--text-light);
}

.search-no-results-icon {
    font-size: 28px;
    margin-bottom: 8px;
    color: var(--medium-gray);
}

.search-no-results-title {
    font-weight: 600;
    font-size: 12px;
    color: var(--text-gray);
    margin-bottom: 4px;
}

.search-no-results-message {
    font-size: 11px;
    line-height: 1.4;
}

.recent-searches-section {
    padding: 10px 0;
    border-bottom: 1px solid var(--border-color);
}

.recent-searches-title {
    padding: 0 12px 6px;
    font-size: 10px;
    color: var(--text-light);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.recent-search-item {
    padding: 8px 12px;
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    transition: all var(--transition-speed) ease;
}

.recent-search-item:hover {
    background: var(--light-orange);
}

.recent-search-icon {
    width: 24px;
    height: 24px;
    border-radius: 5px;
    background: var(--light-gray);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-gray);
    font-size: 10px;
}

.recent-search-content {
    flex: 1;
}

.recent-search-name {
    font-weight: 500;
    font-size: 11px;
    color: var(--dark-gray);
    margin-bottom: 2px;
}

.recent-search-address {
    font-size: 10px;
    color: var(--text-gray);
    line-height: 1.2;
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.recent-search-time {
    font-size: 9px;
    color: var(--text-light);
}

/* Ride Type Selection */
.ride-type-selection {
    margin: 12px 0;
    display: none;
}

.ride-type-selection.active {
    display: block;
    animation: fadeInUp 0.3s ease;
}

@keyframes fadeInUp {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.ride-type-title {
    font-size: 12px;
    font-weight: 600;
    color: var(--dark-gray);
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.ride-type-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 6px;
}

.ride-type-card {
    background: var(--white);
    border: 2px solid var(--border-color);
    border-radius: var(--element-radius);
    padding: 12px 8px;
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    text-align: center;
    position: relative;
    overflow: hidden;
}

.ride-type-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
}

.ride-type-card.selected {
    border-color: var(--primary-orange);
    background: var(--light-orange);
    box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
}

.ride-type-card.economy.selected {
    border-color: var(--economy-green);
    background: #E8F6EF;
}

.ride-type-card.premium.selected {
    border-color: var(--premium-gold);
    background: #FFF9E6;
}

.ride-type-icon {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    background: var(--light-gray);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 6px;
    font-size: 16px;
    color: var(--text-gray);
    transition: all var(--transition-speed) ease;
}

.ride-type-card.selected .ride-type-icon {
    background: var(--primary-orange);
    color: var(--white);
}

.ride-type-card.economy.selected .ride-type-icon {
    background: var(--economy-green);
}

.ride-type-card.premium.selected .ride-type-icon {
    background: var(--premium-gold);
    color: var(--dark-gray);
}

.ride-type-name {
    font-weight: 600;
    font-size: 11px;
    color: var(--dark-gray);
    margin-bottom: 2px;
}

.ride-type-price {
    font-size: 12px;
    font-weight: 700;
    color: var(--primary-orange);
    margin-bottom: 2px;
}

.ride-type-card.economy .ride-type-price {
    color: var(--economy-green);
}

.ride-type-card.premium .ride-type-price {
    color: #B8860B;
}

.ride-type-eta {
    font-size: 9px;
    color: var(--text-light);
}

/* Fare Display */
.fare-display {
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
    color: var(--white);
    padding: 12px;
    border-radius: var(--element-radius);
    margin: 12px 0;
    text-align: center;
    box-shadow: var(--shadow-medium);
    display: none;
}

.fare-display.active {
    display: block;
    animation: slideUp 0.3s ease;
}

@keyframes slideUp {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
}

.fare-label {
    font-size: 11px;
    opacity: 0.9;
    margin-bottom: 2px;
}

.fare-amount {
    font-size: 20px;
    font-weight: 800;
    margin: 4px 0;
}

.fare-details {
    display: flex;
    justify-content: space-between;
    margin-top: 8px;
    font-size: 10px;
    opacity: 0.9;
}

/* Action Buttons */
.action-buttons {
    display: grid;
    grid-template-columns: 1fr;
    gap: 8px;
    margin-top: 12px;
}

.btn {
    padding: 12px;
    border: none;
    border-radius: var(--button-radius);
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.btn-primary {
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
    color: var(--white);
    box-shadow: 0 2px 6px rgba(255, 107, 53, 0.3);
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255, 107, 53, 0.4);
}

.btn-secondary {
    background: var(--white);
    color: var(--primary-orange);
    border: 2px solid var(--primary-orange);
}

.btn-secondary:hover {
    background: var(--light-orange);
    transform: translateY(-2px);
}

.btn-danger {
    background: linear-gradient(135deg, var(--error-red), #C0392B);
    color: var(--white);
    box-shadow: 0 2px 6px rgba(231, 76, 60, 0.3);
}

.btn-danger:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4);
}

/* Ride Info Panel */
.ride-info-panel {
    background: var(--white);
    border-radius: var(--element-radius);
    padding: 12px;
    margin-bottom: 8px;
    box-shadow: var(--shadow-medium);
    border: 1px solid var(--border-color);
    display: none;
}

.ride-info-panel.active {
    display: block;
    animation: fadeInUp 0.3s ease;
}

.driver-info {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--border-color);
}

.driver-avatar {
    width: 46px;
    height: 46px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    color: var(--white);
    font-weight: 700;
    overflow: hidden;
    box-shadow: var(--shadow-medium);
}

.driver-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.driver-details {
    flex: 1;
}

.driver-name {
    font-size: 13px;
    font-weight: 700;
    color: var(--dark-gray);
    margin-bottom: 3px;
}

.driver-rating {
    display: flex;
    align-items: center;
    gap: 3px;
    color: var(--warning-yellow);
    font-weight: 600;
    margin-bottom: 3px;
    font-size: 11px;
}

.driver-vehicle {
    font-size: 11px;
    color: var(--text-gray);
    display: flex;
    align-items: center;
    gap: 3px;
}

/* Driver Media Display */
.driver-media {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
}

.media-container {
    flex: 1;
    border-radius: var(--element-radius);
    overflow: hidden;
    background: var(--light-gray);
    min-height: 80px;
    position: relative;
}

.media-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--text-light);
    font-size: 12px;
}

.media-placeholder i {
    font-size: 24px;
    margin-bottom: 5px;
}

.media-container img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.tracking-info {
    background: var(--white);
    border-radius: var(--element-radius);
    padding: 10px;
    margin: 8px 0;
    box-shadow: var(--shadow-light);
    border: 1px solid var(--border-color);
}

.tracking-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 6px;
}

.tracking-title {
    font-weight: 600;
    font-size: 11px;
    color: var(--dark-gray);
}

.tracking-distance {
    font-size: 12px;
    color: var(--primary-orange);
    font-weight: 700;
}

.tracking-progress {
    height: 3px;
    background: var(--light-gray);
    border-radius: 2px;
    overflow: hidden;
    margin-bottom: 6px;
}

.tracking-progress-bar {
    height: 100%;
    background: var(--primary-orange);
    border-radius: 2px;
    transition: width 0.3s ease;
}

.tracking-details {
    display: flex;
    justify-content: space-between;
    font-size: 10px;
    color: var(--text-gray);
}

.timeline {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin: 12px 0;
    padding: 0 15px;
    position: relative;
}

.timeline::before {
    content: '';
    position: absolute;
    top: 10px;
    left: 10%;
    right: 10%;
    height: 2px;
    background: var(--border-color);
    z-index: 1;
}

.timeline-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    position: relative;
    z-index: 2;
    flex: 1;
}

.step-dot {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--light-gray);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-light);
    font-size: 8px;
    border: 2px solid var(--white);
    transition: all var(--transition-speed) ease;
}

.step-dot.active {
    background: var(--primary-orange);
    color: var(--white);
    transform: scale(1.1);
}

.step-dot.completed {
    background: var(--success-green);
    color: var(--white);
}

.step-label {
    font-size: 9px;
    color: var(--text-light);
    text-align: center;
}

.step-label.active {
    color: var(--primary-orange);
    font-weight: 600;
}

.trip-details {
    margin-bottom: 12px;
}

.trip-locations {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.location-point {
    display: flex;
    align-items: flex-start;
    gap: 8px;
}

.location-marker {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    color: var(--white);
    font-size: 9px;
}

.location-marker.pickup {
    background: var(--primary-orange);
}

.location-marker.destination {
    background: var(--primary-red);
}

.location-text {
    flex: 1;
}

.location-label {
    font-size: 10px;
    color: var(--text-light);
    margin-bottom: 2px;
    font-weight: 600;
}

.location-address {
    font-size: 12px;
    color: var(--dark-gray);
    font-weight: 500;
    line-height: 1.3;
}

.fare-breakdown {
    background: var(--off-white);
    border-radius: var(--element-radius);
    padding: 12px;
    margin-bottom: 12px;
}

.fare-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 4px 0;
    border-bottom: 1px solid var(--border-color);
}

.fare-row:last-child {
    border-bottom: none;
}

.fare-label {
    font-size: 12px;
    color: var(--text-gray);
}

.fare-value {
    font-size: 12px;
    font-weight: 600;
    color: var(--dark-gray);
}

.fare-row.total {
    margin-top: 6px;
    padding-top: 8px;
    border-top: 2px solid var(--border-color);
}

.fare-row.total .fare-label {
    font-size: 13px;
    font-weight: 700;
    color: var(--dark-gray);
}

.fare-row.total .fare-value {
    font-size: 16px;
    font-weight: 800;
    color: var(--primary-orange);
}

/* Chat Container */
.chat-container {
    position: absolute;
    bottom: 160px;
    right: var(--app-padding);
    z-index: 300;
    width: 280px;
    max-width: calc(100vw - 40px);
    background: var(--white);
    border-radius: var(--card-radius);
    box-shadow: var(--shadow-heavy);
    display: none;
    flex-direction: column;
    overflow: hidden;
    border: 1px solid var(--border-color);
}

.chat-container.active {
    display: flex;
    animation: chatSlideUp 0.3s ease;
}

@keyframes chatSlideUp {
    from { transform: translateY(15px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.chat-header {
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
    color: var(--white);
    padding: 12px;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.chat-title {
    font-weight: 600;
    font-size: 12px;
}

.chat-close {
    background: none;
    border: none;
    color: var(--white);
    font-size: 14px;
    cursor: pointer;
    padding: 3px;
    border-radius: 4px;
    transition: all var(--transition-speed) ease;
}

.chat-close:hover {
    background: rgba(255, 255, 255, 0.2);
}

.chat-messages {
    flex: 1;
    padding: 12px;
    max-height: 200px;
    overflow-y: auto;
    background: var(--off-white);
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.message {
    max-width: 80%;
    padding: 6px 10px;
    border-radius: 15px;
    font-size: 12px;
    line-height: 1.4;
}

.message.sent {
    align-self: flex-end;
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
    color: var(--white);
    border-bottom-right-radius: 4px;
}

.message.received {
    align-self: flex-start;
    background: var(--white);
    color: var(--dark-gray);
    border: 1px solid var(--border-color);
    border-bottom-left-radius: 4px;
}

.message-time {
    font-size: 9px;
    color: var(--text-light);
    margin-top: 2px;
    text-align: right;
}

.message.received .message-time {
    color: var(--text-gray);
}

.chat-typing-indicator {
    padding: 5px 12px;
    font-style: italic;
    color: var(--text-light);
    font-size: 11px;
    display: none;
    background: var(--off-white);
}

.chat-typing-indicator.active {
    display: block;
}

.chat-input-container {
    padding: 12px;
    background: var(--white);
    border-top: 1px solid var(--border-color);
    display: flex;
    gap: 6px;
}

.chat-attachment-btn {
    background: none;
    border: none;
    color: var(--text-gray);
    font-size: 16px;
    cursor: pointer;
    padding: 8px;
    border-radius: 50%;
    transition: all var(--transition-speed) ease;
}

.chat-attachment-btn:hover {
    background: var(--light-gray);
}

.chat-input {
    flex: 1;
    padding: 8px 12px;
    border: 1px solid var(--border-color);
    border-radius: var(--button-radius);
    font-size: 12px;
    outline: none;
    transition: all var(--transition-speed) ease;
}

.chat-input:focus {
    border-color: var(--primary-orange);
    box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
}

.chat-send-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
    color: var(--white);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-speed) ease;
}

.chat-send-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 2px 6px rgba(255, 107, 53, 0.3);
}

.chat-notification {
    position: absolute;
    top: -4px;
    right: -4px;
    width: 16px;
    height: 16px;
    background: var(--error-red);
    color: var(--white);
    border-radius: 50%;
    font-size: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    animation: bounce 1s infinite;
}

@keyframes bounce {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.2); }
}

/* Notifications Panel */
.notifications-panel {
    position: absolute;
    top: 50px;
    right: var(--app-padding);
    z-index: 250;
    width: 280px;
    max-width: calc(100vw - 40px);
    background: var(--white);
    border-radius: var(--card-radius);
    box-shadow: var(--shadow-heavy);
    display: none;
    flex-direction: column;
    overflow: hidden;
    border: 1px solid var(--border-color);
}

.notifications-panel.active {
    display: flex;
    animation: slideDown 0.3s ease;
}

.notifications-header {
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
    color: var(--white);
    padding: 12px;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.notifications-title {
    font-weight: 600;
    font-size: 12px;
}

.notifications-close {
    background: none;
    border: none;
    color: var(--white);
    font-size: 14px;
    cursor: pointer;
    padding: 3px;
    border-radius: 4px;
    transition: all var(--transition-speed) ease;
}

.notifications-close:hover {
    background: rgba(255, 255, 255, 0.2);
}

.notifications-list {
    flex: 1;
    max-height: 280px;
    overflow-y: auto;
    background: var(--off-white);
}

.notification-item {
    padding: 12px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
}

.notification-item:hover {
    background: var(--white);
}

.notification-item.unread {
    background: var(--light-orange);
}

.notification-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 4px;
}

.notification-title {
    font-weight: 600;
    font-size: 11px;
    color: var(--dark-gray);
    display: flex;
    align-items: center;
    gap: 4px;
}

.notification-time {
    font-size: 9px;
    color: var(--text-light);
}

.notification-message {
    font-size: 11px;
    color: var(--text-gray);
    line-height: 1.3;
}

.notification-actions {
    margin-top: 6px;
    display: flex;
    gap: 6px;
}

.notification-action-btn {
    padding: 3px 6px;
    font-size: 9px;
    border-radius: 10px;
    border: 1px solid var(--border-color);
    background: var(--white);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
}

.notification-action-btn:hover {
    background: var(--primary-orange);
    color: var(--white);
    border-color: var(--primary-orange);
}

/* Dropdown Menus */
.dropdown-menu {
    position: absolute;
    top: 54px;
    right: var(--app-padding);
    z-index: 250;
    width: 180px;
    background: var(--white);
    border-radius: var(--element-radius);
    box-shadow: var(--shadow-heavy);
    display: none;
    flex-direction: column;
    overflow: hidden;
    border: 1px solid var(--border-color);
}

.dropdown-menu.active {
    display: flex;
    animation: slideDown 0.3s ease;
}

.dropdown-item {
    padding: 10px 12px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    color: var(--dark-gray);
    background: none;
    border: none;
    width: 100%;
    text-align: left;
}

.dropdown-item:hover {
    background: var(--light-orange);
    color: var(--primary-orange);
}

.dropdown-item:last-child {
    border-bottom: none;
}

.dropdown-item i {
    width: 16px;
    text-align: center;
}

.more-options-menu {
    position: absolute;
    bottom: 160px;
    left: var(--app-padding);
    z-index: 250;
    width: 180px;
    background: var(--white);
    border-radius: var(--element-radius);
    box-shadow: var(--shadow-heavy);
    display: none;
    flex-direction: column;
    overflow: hidden;
    border: 1px solid var(--border-color);
}

.more-options-menu.active {
    display: flex;
    animation: slideUp 0.3s ease;
}

/* Service Forms */
.service-form {
    display: none;
    background: var(--white);
    border-radius: var(--element-radius);
    padding: 12px;
    margin-bottom: 8px;
    box-shadow: var(--shadow-light);
    border: 1px solid var(--border-color);
}

.service-form.active {
    display: block;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.form-group {
    margin-bottom: 12px;
}

.form-label {
    display: block;
    margin-bottom: 4px;
    font-weight: 600;
    font-size: 12px;
    color: var(--dark-gray);
}

.form-control {
    width: 100%;
    padding: 10px;
    border: 2px solid var(--border-color);
    border-radius: var(--element-radius);
    font-size: 12px;
    color: var(--dark-gray);
    background: var(--white);
    transition: all var(--transition-speed) ease;
}

.form-control:focus {
    outline: none;
    border-color: var(--primary-orange);
    box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
}

.form-textarea {
    min-height: 70px;
    resize: vertical;
}

.price-calculator-display {
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
    color: var(--white);
    padding: 12px;
    border-radius: var(--element-radius);
    margin: 12px 0;
    box-shadow: var(--shadow-medium);
}

.price-breakdown {
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
}

.price-breakdown-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 3px;
    font-size: 11px;
    opacity: 0.9;
}

.price-breakdown-row.total {
    margin-top: 6px;
    padding-top: 6px;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    font-weight: 700;
    font-size: 12px;
}

/* Modals */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 12px;
    backdrop-filter: blur(4px);
}

.modal-overlay.active {
    display: flex;
    animation: fadeIn 0.3s ease;
}

.modal {
    background: var(--white);
    border-radius: var(--card-radius);
    box-shadow: var(--shadow-heavy);
    max-width: 360px;
    width: 100%;
    max-height: 70vh;
    overflow-y: auto;
    animation: modalSlideUp 0.3s ease;
}

@keyframes modalSlideUp {
    from { transform: translateY(25px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.modal-header {
    padding: 15px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.modal-title {
    font-size: 14px;
    font-weight: 700;
    color: var(--dark-gray);
    display: flex;
    align-items: center;
    gap: 6px;
}

.modal-close {
    background: none;
    border: none;
    font-size: 18px;
    color: var(--text-light);
    cursor: pointer;
    padding: 3px;
    border-radius: 4px;
    transition: all var(--transition-speed) ease;
}

.modal-close:hover {
    color: var(--error-red);
    background: var(--light-red);
}

.modal-content {
    padding: 15px;
}

.payment-methods {
    display: grid;
    grid-template-columns: 1fr;
    gap: 8px;
    margin: 12px 0;
}

.payment-method {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px;
    border: 2px solid var(--border-color);
    border-radius: var(--element-radius);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
}

.payment-method:hover {
    border-color: var(--primary-orange);
    background: var(--light-orange);
}

.payment-method.selected {
    border-color: var(--primary-orange);
    background: var(--light-orange);
}

.payment-icon {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    background: var(--light-gray);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-gray);
}

.payment-method.selected .payment-icon {
    background: var(--primary-orange);
    color: var(--white);
}

.payment-details {
    flex: 1;
}

.payment-name {
    font-weight: 600;
    font-size: 12px;
    color: var(--dark-gray);
}

.payment-info {
    font-size: 10px;
    color: var(--text-gray);
    margin-top: 2px;
}

.cancel-reasons {
    display: grid;
    grid-template-columns: 1fr;
    gap: 8px;
    margin-bottom: 12px;
}

.cancel-reason {
    padding: 12px;
    border: 2px solid var(--border-color);
    border-radius: var(--element-radius);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    display: flex;
    align-items: center;
    gap: 8px;
}

.cancel-reason:hover {
    border-color: var(--primary-orange);
    background: var(--light-orange);
}

.cancel-reason.selected {
    border-color: var(--primary-orange);
    background: var(--light-orange);
}

.reason-icon {
    width: 24px;
    height: 24px;
    border-radius: 6px;
    background: var(--light-gray);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-gray);
}

.cancel-reason.selected .reason-icon {
    background: var(--primary-orange);
    color: var(--white);
}

.reason-text {
    flex: 1;
    font-weight: 500;
    color: var(--dark-gray);
}

.emergency-services {
    padding: 12px var(--app-padding);
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
}

.emergency-service {
    background: var(--white);
    border: 2px solid var(--border-color);
    border-radius: var(--element-radius);
    padding: 12px;
    text-align: center;
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    border: none;
}

.emergency-service:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
}

.emergency-service.police {
    border-color: var(--police-blue);
}

.emergency-service.police:hover {
    border-color: var(--police-blue);
    box-shadow: 0 4px 12px rgba(44, 62, 80, 0.2);
}

.emergency-service.fire {
    border-color: var(--fire-truck-red);
}

.emergency-service.fire:hover {
    border-color: var(--fire-truck-red);
    box-shadow: 0 4px 12px rgba(192, 57, 43, 0.2);
}

.emergency-service.medical {
    border-color: var(--ambulance-blue);
}

.emergency-service.medical:hover {
    border-color: var(--ambulance-blue);
    box-shadow: 0 4px 12px rgba(41, 128, 185, 0.2);
}

.emergency-icon {
    width: 46px;
    height: 46px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    margin: 0 auto 8px;
    color: var(--white);
}

.emergency-service.police .emergency-icon {
    background: var(--police-blue);
}

.emergency-service.fire .emergency-icon {
    background: var(--fire-truck-red);
}

.emergency-service.medical .emergency-icon {
    background: var(--ambulance-blue);
}

.emergency-name {
    font-size: 13px;
    font-weight: 700;
    color: var(--dark-gray);
    margin-bottom: 3px;
}

.emergency-description {
    font-size: 11px;
    color: var(--text-gray);
    line-height: 1.3;
}

/* Screen Transitions */
.history-screen,
.account-screen,
.emergency-screen {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--white);
    z-index: 200;
    display: none;
    flex-direction: column;
    padding-top: 50px;
}

.history-screen.active,
.account-screen.active,
.emergency-screen.active {
    display: flex;
    animation: slideInRight 0.3s ease;
}

@keyframes slideInRight {
    from { transform: translateX(100%); }
    to { transform: translateX(0); }
}

.screen-header {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    background: var(--white);
    padding: 12px var(--app-padding);
    border-bottom: 1px solid var(--border-color);
    z-index: 10;
    display: flex;
    align-items: center;
    gap: 12px;
}

.back-btn {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--light-gray);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--dark-gray);
    border: none;
    cursor: pointer;
    transition: all var(--transition-speed) ease;
}

.back-btn:hover {
    background: var(--medium-gray);
    transform: translateX(-2px);
}

.screen-title {
    font-size: 14px;
    font-weight: 700;
    color: var(--dark-gray);
}

.history-filters {
    padding: 12px var(--app-padding);
    background: var(--off-white);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    gap: 6px;
    overflow-x: auto;
    scrollbar-width: none;
}

.history-filters::-webkit-scrollbar {
    display: none;
}

.filter-btn {
    padding: 5px 12px;
    background: var(--white);
    border: 1px solid var(--border-color);
    border-radius: var(--button-radius);
    font-size: 11px;
    font-weight: 600;
    color: var(--text-gray);
    cursor: pointer;
    white-space: nowrap;
    transition: all var(--transition-speed) ease;
    border: none;
}

.filter-btn.active {
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
    color: var(--white);
    border-color: transparent;
}

.filter-btn:hover:not(.active) {
    border-color: var(--primary-orange);
    color: var(--primary-orange);
}

.history-list {
    flex: 1;
    overflow-y: auto;
    padding: 12px var(--app-padding);
}

.history-item {
    background: var(--white);
    border-radius: var(--element-radius);
    padding: 12px;
    margin-bottom: 8px;
    box-shadow: var(--shadow-light);
    border: 1px solid var(--border-color);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
}

.history-item:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
    border-color: var(--primary-orange);
}

.history-item.expanded {
    margin-bottom: 12px;
}

.history-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 8px;
}

.history-type {
    display: flex;
    align-items: center;
    gap: 4px;
}

.history-icon {
    width: 24px;
    height: 24px;
    border-radius: 6px;
    background: var(--light-orange);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary-orange);
}

.history-type-name {
    font-weight: 600;
    font-size: 12px;
    color: var(--dark-gray);
}

.history-date {
    font-size: 11px;
    color: var(--text-light);
}

.history-status {
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 9px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.status-completed {
    background: #E8F6EF;
    color: var(--economy-green);
}

.status-cancelled {
    background: var(--light-red);
    color: var(--error-red);
}

.status-ongoing {
    background: #E3F2FD;
    color: var(--info-blue);
}

.history-locations {
    margin-bottom: 8px;
}

.history-location {
    display: flex;
    align-items: flex-start;
    gap: 4px;
    margin-bottom: 4px;
}

.history-location i {
    color: var(--text-light);
    margin-top: 2px;
}

.history-location-text {
    font-size: 11px;
    color: var(--text-gray);
    line-height: 1.3;
}

.history-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid var(--border-color);
}

.history-price {
    font-size: 13px;
    font-weight: 700;
    color: var(--primary-orange);
}

.history-driver {
    font-size: 11px;
    color: var(--text-gray);
}

/* Account Screen */
.account-header {
    padding: 15px var(--app-padding);
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
    color: var(--white);
    text-align: center;
}

.account-avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    margin: 0 auto 12px;
    border: 2px solid rgba(255, 255, 255, 0.3);
}

.account-name {
    font-size: 16px;
    font-weight: 700;
    margin-bottom: 3px;
}

.account-phone {
    font-size: 12px;
    opacity: 0.9;
}

.account-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    padding: 12px var(--app-padding);
    background: var(--white);
}

.stat-card {
    background: var(--off-white);
    border-radius: var(--element-radius);
    padding: 10px;
    text-align: center;
}

.stat-value {
    font-size: 18px;
    font-weight: 700;
    color: var(--primary-orange);
    margin-bottom: 3px;
}

.stat-label {
    font-size: 10px;
    color: var(--text-gray);
    font-weight: 500;
}

.account-section {
    padding: 12px var(--app-padding);
    border-bottom: 1px solid var(--border-color);
}

.section-title {
    font-size: 13px;
    font-weight: 700;
    color: var(--dark-gray);
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.wallet-balance {
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
    color: var(--white);
    padding: 15px;
    border-radius: var(--element-radius);
    text-align: center;
    margin-bottom: 12px;
}

.balance-label {
    font-size: 12px;
    opacity: 0.9;
    margin-bottom: 4px;
}

.balance-amount-large {
    font-size: 26px;
    font-weight: 800;
    margin-bottom: 3px;
}

.wallet-actions {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-top: 10px;
}

.btn-wallet {
    padding: 8px;
    border: 2px solid var(--primary-orange);
    background: var(--white);
    color: var(--primary-orange);
    border-radius: var(--button-radius);
    font-weight: 600;
    font-size: 12px;
    cursor: pointer;
    transition: all var(--transition-speed) ease;
}

.btn-wallet:hover {
    background: var(--primary-orange);
    color: var(--white);
    transform: translateY(-2px);
}

.referral-card {
    background: var(--light-orange);
    border-radius: var(--element-radius);
    padding: 12px;
    text-align: center;
    margin-top: 10px;
}

.referral-code {
    background: var(--white);
    padding: 12px;
    border-radius: var(--element-radius);
    margin: 10px 0;
    font-family: monospace;
    font-size: 16px;
    font-weight: 700;
    color: var(--primary-orange);
    letter-spacing: 1px;
}

.referral-note {
    font-size: 10px;
    color: var(--text-gray);
    margin-top: 4px;
}

/* Loading Overlay */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.95);
    z-index: 10000;
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 12px;
    backdrop-filter: blur(5px);
}

.loading-overlay.active {
    display: flex;
    animation: fadeIn 0.3s ease;
}

.loading-text {
    font-size: 13px;
    font-weight: 600;
    color: var(--dark-gray);
}

/* Toast Notifications */
.toast-container {
    position: fixed;
    top: 70px;
    right: var(--app-padding);
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: 6px;
    max-width: 300px;
}

.toast {
    background: var(--white);
    border-radius: var(--element-radius);
    padding: 12px;
    box-shadow: var(--shadow-heavy);
    border-left: 3px solid var(--primary-orange);
    display: flex;
    align-items: flex-start;
    gap: 8px;
    animation: slideInRight 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    transform: translateX(0);
    transition: transform 0.3s ease, opacity 0.3s ease;
    opacity: 1;
}

.toast.hiding {
    transform: translateX(120%);
    opacity: 0;
}

.toast.success {
    border-left-color: var(--success-green);
}

.toast.error {
    border-left-color: var(--error-red);
}

.toast.warning {
    border-left-color: var(--warning-yellow);
}

.toast.info {
    border-left-color: var(--info-blue);
}

.toast-icon {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: var(--light-orange);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary-orange);
    font-size: 8px;
    flex-shrink: 0;
}

.toast.success .toast-icon {
    background: #E8F6EF;
    color: var(--success-green);
}

.toast.error .toast-icon {
    background: var(--light-red);
    color: var(--error-red);
}

.toast.warning .toast-icon {
    background: #FFF3E0;
    color: var(--warning-yellow);
}

.toast.info .toast-icon {
    background: #E3F2FD;
    color: var(--info-blue);
}

.toast-content {
    flex: 1;
    min-width: 0;
}

.toast-title {
    font-weight: 700;
    font-size: 12px;
    color: var(--dark-gray);
    margin-bottom: 3px;
}

.toast-message {
    font-size: 11px;
    color: var(--text-gray);
    line-height: 1.3;
}

.toast-close {
    background: none;
    border: none;
    color: var(--text-light);
    font-size: 14px;
    cursor: pointer;
    padding: 2px;
    border-radius: 4px;
    transition: all var(--transition-speed) ease;
    flex-shrink: 0;
}

.toast-close:hover {
    color: var(--error-red);
    background: var(--light-red);
}

.toast-progress-bar {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: var(--light-gray);
    border-radius: 0 0 var(--element-radius) var(--element-radius);
    overflow: hidden;
}

.toast-progress {
    height: 100%;
    background: var(--primary-orange);
    width: 100%;
    animation: progressBar linear forwards;
}

.toast.success .toast-progress {
    background: var(--success-green);
}

.toast.error .toast-progress {
    background: var(--error-red);
}

.toast.warning .toast-progress {
    background: var(--warning-yellow);
}

.toast.info .toast-progress {
    background: var(--info-blue);
}

@keyframes progressBar {
    from { width: 100%; }
    to { width: 0%; }
}

/* Sync Indicators */
.real-time-indicator {
    position: fixed;
    bottom: 8px;
    right: 8px;
    z-index: 1000;
    background: var(--success-green);
    color: var(--white);
    padding: 4px 8px;
    border-radius: var(--button-radius);
    font-size: 10px;
    font-weight: 600;
    display: none;
    align-items: center;
    gap: 4px;
    box-shadow: var(--shadow-medium);
}

.real-time-indicator.active {
    display: flex;
    animation: fadeIn 0.3s ease;
}

.sync-indicator {
    position: fixed;
    bottom: 8px;
    left: 8px;
    z-index: 1000;
    background: var(--info-blue);
    color: var(--white);
    padding: 4px 8px;
    border-radius: var(--button-radius);
    font-size: 10px;
    font-weight: 600;
    display: none;
    align-items: center;
    gap: 4px;
    box-shadow: var(--shadow-medium);
}

.sync-indicator.active {
    display: flex;
    animation: fadeIn 0.3s ease;
}

.sync-indicator.syncing .sync-icon {
    animation: spin 1s linear infinite;
}

/* Map Markers */
.current-location-marker {
    background: var(--info-blue);
    color: white;
    border-radius: 50%;
    width: 16px;
    height: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 8px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.3);
    border: 2px solid white;
}

.pickup-marker {
    background: var(--primary-orange);
    color: white;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 9px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.3);
    border: 2px solid white;
}

.destination-marker {
    background: var(--primary-red);
    color: white;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 9px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.3);
    border: 2px solid white;
}

.driver-marker {
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
    color: white;
    border-radius: 50%;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.3);
    border: 2px solid white;
    animation: pulse 2s infinite;
}

.emergency-vehicle-marker {
    background: var(--error-red);
    color: white;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.3);
    border: 2px solid white;
    animation: emergencyPulse 1s infinite;
}

.price-calculation {
    background: var(--off-white);
    border-radius: var(--element-radius);
    padding: 12px;
    margin: 10px 0;
    font-size: 11px;
    color: var(--text-gray);
}

.calculation-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 4px;
}

.calculation-row:last-child {
    margin-bottom: 0;
    padding-top: 4px;
    border-top: 1px solid var(--border-color);
    font-weight: 600;
    color: var(--dark-gray);
}

.emergency-reasons {
    display: grid;
    grid-template-columns: 1fr;
    gap: 8px;
    margin: 12px 0;
}

.emergency-reason {
    padding: 12px;
    border: 2px solid var(--border-color);
    border-radius: var(--element-radius);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    display: flex;
    align-items: center;
    gap: 8px;
}

.emergency-reason:hover {
    border-color: var(--error-red);
    background: var(--light-red);
}

.emergency-reason.selected {
    border-color: var(--error-red);
    background: var(--light-red);
}

.emergency-reason-icon {
    width: 24px;
    height: 24px;
    border-radius: 6px;
    background: var(--light-red);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--error-red);
}

.emergency-reason.selected .emergency-reason-icon {
    background: var(--error-red);
    color: var(--white);
}

.emergency-reason-text {
    flex: 1;
    font-weight: 500;
    color: var(--dark-gray);
}

.emergency-stations {
    margin: 12px 0;
    max-height: 180px;
    overflow-y: auto;
}

.emergency-station {
    padding: 10px;
    border: 2px solid var(--border-color);
    border-radius: var(--element-radius);
    margin-bottom: 6px;
    cursor: pointer;
    transition: all var(--transition-speed) ease;
}

.emergency-station:hover {
    border-color: var(--primary-orange);
    background: var(--light-orange);
}

.emergency-station.selected {
    border-color: var(--primary-orange);
    background: var(--light-orange);
}

.station-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 3px;
}

.station-name {
    font-weight: 600;
    font-size: 12px;
    color: var(--dark-gray);
}

.station-distance {
    font-size: 10px;
    color: var(--text-gray);
}

.station-address {
    font-size: 11px;
    color: var(--text-gray);
    line-height: 1.3;
}

.station-details {
    margin-top: 4px;
    font-size: 10px;
    color: var(--text-light);
    display: flex;
    gap: 8px;
}

/* Broadcast Feature */
.broadcast-feature {
    background: var(--white);
    border-radius: var(--element-radius);
    padding: 12px;
    margin: 12px 0;
    box-shadow: var(--shadow-medium);
    border: 1px solid var(--border-color);
}

.broadcast-feature-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 10px;
}

.broadcast-feature-title {
    font-size: 13px;
    font-weight: 700;
    color: var(--dark-gray);
    display: flex;
    align-items: center;
    gap: 6px;
}

.broadcast-status-indicator {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--success-green);
    animation: pulse 1.5s infinite;
}

.broadcast-status-indicator.inactive {
    background: var(--text-light);
    animation: none;
}

.broadcast-form {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.broadcast-input-group {
    display: flex;
    gap: 5px;
}

.broadcast-input-group input {
    flex: 1;
    padding: 8px;
    border: 1px solid var(--border-color);
    border-radius: var(--element-radius);
}

.broadcast-btn {
    padding: 8px 15px;
    background: var(--primary-orange);
    color: white;
    border: none;
    border-radius: var(--element-radius);
    cursor: pointer;
}

.broadcast-recipients {
    max-height: 130px;
    overflow-y: auto;
    margin-bottom: 10px;
}

.broadcast-recipient {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 6px;
    border-bottom: 1px solid var(--border-color);
}

.broadcast-recipient:last-child {
    border-bottom: none;
}

.recipient-info {
    display: flex;
    align-items: center;
    gap: 6px;
}

.recipient-avatar {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: var(--light-orange);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary-orange);
    font-weight: 600;
    font-size: 11px;
}

.recipient-name {
    font-weight: 600;
    font-size: 12px;
    color: var(--dark-gray);
}

.recipient-status {
    font-size: 9px;
    padding: 2px 6px;
    border-radius: 10px;
}

.status-joined {
    background: #E8F6EF;
    color: var(--success-green);
}

.status-pending {
    background: #FFF3E0;
    color: var(--warning-yellow);
}

.location-details {
    background: var(--off-white);
    border-radius: var(--element-radius);
    padding: 12px;
    margin: 10px 0;
}

.location-detail-item {
    display: flex;
    align-items: flex-start;
    gap: 8px;
    margin-bottom: 8px;
}

.location-detail-item:last-child {
    margin-bottom: 0;
}

.location-detail-icon {
    color: var(--primary-orange);
    font-size: 12px;
    margin-top: 2px;
}

.location-detail-content {
    flex: 1;
}

.location-detail-label {
    font-size: 10px;
    color: var(--text-light);
    margin-bottom: 2px;
}

.location-detail-value {
    font-size: 12px;
    color: var(--dark-gray);
    font-weight: 500;
    line-height: 1.3;
}

.emergency-contact-display {
    background: var(--light-red);
    border-radius: var(--element-radius);
    padding: 12px;
    margin: 10px 0;
    border-left: 3px solid var(--error-red);
}

.emergency-contact-header {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 6px;
}

.emergency-contact-title {
    font-weight: 600;
    font-size: 12px;
    color: var(--dark-gray);
}

.emergency-contact-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 0;
    border-bottom: 1px solid rgba(231, 76, 60, 0.1);
}

.emergency-contact-item:last-child {
    border-bottom: none;
}

.contact-info {
    display: flex;
    align-items: center;
    gap: 6px;
}

.contact-name {
    font-weight: 600;
    font-size: 12px;
    color: var(--dark-gray);
}

.contact-phone {
    font-size: 11px;
    color: var(--text-gray);
}

.contact-action-btn {
    padding: 3px 6px;
    font-size: 9px;
    border-radius: 10px;
    background: var(--white);
    border: 1px solid var(--error-red);
    color: var(--error-red);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    border: none;
}

.contact-action-btn:hover {
    background: var(--error-red);
    color: var(--white);
}

/* Service Type Indicators */
.service-type-indicator {
    display: inline-flex;
    align-items: center;
    gap: 3px;
    padding: 3px 6px;
    border-radius: 10px;
    font-size: 9px;
    font-weight: 600;
    text-transform: uppercase;
}

.indicator-car {
    background: var(--light-orange);
    color: var(--primary-orange);
}

.indicator-delivery {
    background: #F4E6FA;
    color: var(--delivery-purple);
}

.indicator-truck {
    background: rgba(139, 69, 19, 0.1);
    color: var(--light-truck-brown);
}

.indicator-emergency {
    background: var(--light-red);
    color: var(--error-red);
}

.indicator-shopping {
    background: #E1F5FE;
    color: var(--express-shop-green);
}

.price-update-animation {
    animation: priceUpdate 0.5s ease;
}

@keyframes priceUpdate {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.search-loading {
    display: none;
    position: absolute;
    top: 50%;
    right: 10px;
    transform: translateY(-50%);
    width: 12px;
    height: 12px;
    border: 2px solid var(--light-gray);
    border-radius: 50%;
    border-top-color: var(--primary-orange);
    animation: spin 0.6s linear infinite;
}

.location-input.searching .search-loading {
    display: block;
}

.no-results {
    padding: 25px 12px;
    text-align: center;
    color: var(--text-light);
    font-size: 12px;
}

.no-results i {
    font-size: 24px;
    margin-bottom: 8px;
    opacity: 0.5;
}

/* Truck Types */
.truck-types {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
    margin: 10px 0;
}

.truck-type {
    padding: 10px;
    border: 2px solid var(--border-color);
    border-radius: var(--element-radius);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    text-align: center;
}

.truck-type:hover {
    border-color: var(--light-truck-brown);
    transform: translateY(-2px);
}

.truck-type.selected {
    border-color: var(--light-truck-brown);
    background: rgba(139, 69, 19, 0.05);
}

.truck-icon {
    font-size: 18px;
    color: var(--light-truck-brown);
    margin-bottom: 4px;
}

.truck-name {
    font-weight: 600;
    font-size: 11px;
    color: var(--dark-gray);
    margin-bottom: 2px;
}

.truck-capacity {
    font-size: 9px;
    color: var(--text-gray);
}

/* Item List */
.item-list {
    margin: 10px 0;
}

.item-entry {
    display: flex;
    gap: 6px;
    margin-bottom: 6px;
}

.item-entry input {
    flex: 1;
    padding: 8px;
    border: 1px solid var(--border-color);
    border-radius: var(--element-radius);
    font-size: 12px;
}

.remove-item {
    width: 32px;
    height: 32px;
    border-radius: var(--element-radius);
    background: var(--light-red);
    border: none;
    color: var(--error-red);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

.add-item {
    width: 100%;
    padding: 8px;
    background: var(--light-orange);
    border: 2px dashed var(--primary-orange);
    border-radius: var(--element-radius);
    color: var(--primary-orange);
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    transition: all var(--transition-speed) ease;
    border: none;
}

.add-item:hover {
    background: var(--primary-orange);
    color: var(--white);
}

.schedule-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-bottom: 12px;
}

/* Empty State */
.empty-state {
    padding: 40px 12px;
    text-align: center;
    color: var(--text-light);
}

.empty-icon {
    font-size: 36px;
    margin-bottom: 12px;
    opacity: 0.3;
}

.empty-title {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 4px;
    color: var(--text-gray);
}

.empty-message {
    font-size: 12px;
    margin-bottom: 12px;
    line-height: 1.4;
}

/* Ride Stops */
.ride-stops {
    background: var(--off-white);
    border-radius: var(--element-radius);
    padding: 10px;
    margin-top: 10px;
}

/* Share Ride Status */
.share-ride-status {
    padding: 10px;
    background: var(--light-orange);
    border-radius: var(--element-radius);
    margin-bottom: 10px;
    font-size: 12px;
}

/* Invitation Details */
.invitation-details {
    padding: 15px;
    background: var(--off-white);
    border-radius: var(--element-radius);
    margin-bottom: 15px;
}

/* Share Friends List */
.share-friends-list {
    max-height: 150px;
    overflow-y: auto;
    background: var(--off-white);
    border-radius: var(--element-radius);
    padding: 10px;
}

/* Emergency Note */
.emergency-note {
    padding: 15px;
    background: var(--light-red);
    border-radius: var(--element-radius);
    margin: 15px;
    font-size: 12px;
    color: var(--dark-gray);
    border-left: 3px solid var(--error-red);
}

/* Enhanced Scrollbar */
.enhanced-scrollbar {
    scrollbar-width: thin;
    scrollbar-color: var(--primary-orange) var(--light-gray);
}

.enhanced-scrollbar::-webkit-scrollbar {
    width: 4px;
    height: 4px;
}

.enhanced-scrollbar::-webkit-scrollbar-track {
    background: var(--light-gray);
    border-radius: 2px;
}

.enhanced-scrollbar::-webkit-scrollbar-thumb {
    background: var(--primary-orange);
    border-radius: 2px;
}

.enhanced-scrollbar::-webkit-scrollbar-thumb:hover {
    background: var(--secondary-orange);
}

/* Hover Effects */
.card-hover {
    transition: all var(--transition-speed) ease;
}

.card-hover:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-heavy);
}

.selection-glow {
    transition: all var(--transition-speed) ease;
}

.selection-glow.selected {
    box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.3), var(--shadow-medium);
    animation: selectionPulse 2s infinite;
}

@keyframes selectionPulse {
    0%, 100% {
        box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.3), var(--shadow-medium);
    }
    50% {
        box-shadow: 0 0 0 4px rgba(255, 107, 53, 0.1), var(--shadow-medium);
    }
}

/* Utility Classes */
.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}

*:focus {
    outline: 2px solid var(--primary-orange);
    outline-offset: 2px;
}

*:focus:not(.focus-visible) {
    outline: none;
}

/* Responsive Design */
@media (max-width: 768px) {
    :root {
        --app-padding: 6px;
        --element-radius: 6px;
        --button-radius: 10px;
    }
    
    .quick-actions {
        grid-template-columns: 1fr;
    }
    
    .ride-type-grid {
        grid-template-columns: 1fr;
    }
    
    .emergency-services {
        grid-template-columns: 1fr;
    }
    
    .chat-container {
        width: calc(100vw - 16px);
        right: 8px;
    }
    
    .notifications-panel {
        width: calc(100vw - 16px);
        right: 8px;
    }
    
    .dropdown-menu {
        width: 160px;
        right: 8px;
    }
    
    .more-options-menu {
        width: 160px;
        left: 8px;
    }
    
    .truck-types {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 480px) {
    :root {
        --app-padding: 4px;
    }
    
    .nav-tabs {
        gap: 3px;
    }
    
    .nav-tab {
        padding: 6px 3px;
        font-size: 9px;
    }
    
    .nav-tab i {
        font-size: 12px;
    }
    
    .balance-badge {
        padding: 3px 6px;
        font-size: 10px;
    }
    
    .service-tab {
        min-width: 80px;
        padding: 8px 10px;
    }
    
    .sos-button {
        bottom: 140px;
        right: 6px;
        width: 46px;
        height: 46px;
    }
    
    .map-controls {
        top: 100px;
        right: 6px;
    }
    
    .driver-media {
        flex-direction: column;
    }
}

@media (prefers-contrast: high) {
    .search-result-item:hover {
        outline: 2px solid var(--primary-orange);
    }
    
    .map-control-btn {
        border: 2px solid var(--dark-gray);
    }
    
    .toast {
        border: 2px solid currentColor;
    }
}

@media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
    
    .search-results-dropdown {
        animation: none !important;
    }
    
    .toast {
        animation: none !important;
    }
    
    .sos-button,
    .step-dot.active::after,
    .broadcast-status-indicator,
    .notification-badge {
        animation: none !important;
    }
}

@media print {
    .main-panel,
    .top-bar,
    .chat-container,
    .modal-overlay,
    .sos-button,
    .ride-status-bar,
    .emergency-status,
    .map-controls {
        display: none !important;
    }
    
    #map {
        position: relative;
        height: 250px;
    }
}
    </style>
</head>
<body>
    <!-- Map Container -->
    <div id="map">
        <div class="map-loading-overlay" id="mapLoadingOverlay">
            <div class="loading-spinner"></div>
            <div class="map-loading-text">Loading map...</div>
        </div>
    </div>
    
    <!-- Top Navigation Bar -->
    <div class="top-bar">
        <div class="logo-container">
            <div class="logo-icon">
                <img src="jubel.png" alt="Jubel Logo" id="jubelLogo">
            </div>
            <div class="logo-text" id="userFullName">Loading...</div>
        </div>
        
        <div class="user-actions">
            <div class="balance-badge" id="balanceBadge">
                <i class="fas fa-wallet"></i>
                <span>Balance: <span class="balance-amount" id="walletBalance">ZMW 0.00</span></span>
            </div>
            <div class="notification-bell" id="notificationBell" onclick="toggleNotifications()">
                <i class="fas fa-bell"></i>
                <span class="notification-badge" id="notificationCount">0</span>
            </div>
        </div>
    </div>
    
    <!-- City Detection Indicator -->
    <div class="city-detection" id="cityDetection">
        <i class="fas fa-map-marker-alt"></i>
        <span id="currentCityDisplay">Detecting your city...</span>
    </div>
    
    <!-- Ride Status Bar -->
    <div class="ride-status-bar" id="rideStatusBar">
        <div class="status-indicator">
            <div class="status-dot searching" id="statusDot"></div>
            <span class="status-text" id="statusText">Searching for driver</span>
        </div>
        <div class="status-eta">
            <i class="fas fa-clock"></i>
            <span id="etaText">5 min</span>
        </div>
    </div>
    
    <!-- Emergency Status -->
    <div class="emergency-status" id="emergencyStatus">
        <i class="fas fa-exclamation-triangle"></i>
        <span>EMERGENCY RIDE IN PROGRESS</span>
    </div>
    
    <!-- SOS Button -->
    <div class="sos-button" id="sosButton" onclick="triggerSOS()">
        <i class="fas fa-exclamation-triangle"></i>
    </div>
    
    <!-- Map Controls -->
    <div class="map-controls">
        <button class="map-control-btn" id="locateMeBtn" title="Locate Me" onclick="centerMapOnUser()">
            <i class="fas fa-location-arrow"></i>
        </button>
        <button class="map-control-btn" id="zoomInBtn" title="Zoom In" onclick="zoomIn()">
            <i class="fas fa-plus"></i>
        </button>
        <button class="map-control-btn" id="zoomOutBtn" title="Zoom Out" onclick="zoomOut()">
            <i class="fas fa-minus"></i>
        </button>
        <button class="map-control-btn" id="clearRouteBtn" title="Clear Route" onclick="clearRoute()">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <!-- Chat Container -->
    <div class="chat-container" id="chatContainer">
        <div class="chat-header">
            <div class="chat-title">Chat with Driver</div>
            <button class="chat-close" id="chatClose" onclick="closeChat()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <!-- Messages will be inserted here -->
        </div>
        <div class="chat-typing-indicator" id="typingIndicator">
            Driver is typing...
        </div>
        <div class="chat-input-container">
            <button class="chat-attachment-btn" id="attachmentBtn" onclick="attachFile()">
                <i class="fas fa-paperclip"></i>
            </button>
            <input type="text" class="chat-input" id="chatInput" placeholder="Type your message...">
            <button class="chat-send-btn" id="chatSend" onclick="sendChatMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
    
    <!-- Notifications Panel -->
    <div class="notifications-panel" id="notificationsPanel">
        <div class="notifications-header">
            <div class="notifications-title">Notifications</div>
            <button class="notifications-close" id="notificationsClose" onclick="closeNotifications()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="notifications-list" id="notificationsList">
            <!-- Notifications will be inserted here -->
        </div>
    </div>
    
    <!-- Dropdown Menu -->
    <div class="dropdown-menu" id="dropdownMenu">
        <div class="dropdown-item" data-action="profile" onclick="switchScreen('account')">
            <i class="fas fa-user"></i>
            <span>Profile</span>
        </div>
        <div class="dropdown-item" data-action="settings" onclick="openSettings()">
            <i class="fas fa-cog"></i>
            <span>Settings</span>
        </div>
        <div class="dropdown-item" data-action="help" onclick="openHelp()">
            <i class="fas fa-question-circle"></i>
            <span>Help & Support</span>
        </div>
        <div class="dropdown-item" data-action="logout" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i>
            <span>Logout</span>
        </div>
    </div>
    
    <!-- More Options Menu -->
    <div class="more-options-menu" id="moreOptionsMenu">
        <div class="dropdown-item" data-option="schedule" onclick="openScheduleModal()">
            <i class="fas fa-calendar-alt"></i>
            <span>Schedule Ride</span>
        </div>
        <div class="dropdown-item" data-option="orderForSomeone" onclick="openOrderForSomeoneModal()">
            <i class="fas fa-user-friends"></i>
            <span>Order for Someone</span>
        </div>
        <div class="dropdown-item" data-option="shareRide" onclick="openShareRideModal()">
            <i class="fas fa-share-alt"></i>
            <span>Share Ride</span>
        </div>
        <div class="dropdown-item" data-option="broadcast" onclick="switchService('broadcast')">
            <i class="fas fa-broadcast-tower"></i>
            <span>Broadcast Ride</span>
        </div>
    </div>
    
    <!-- Main Panel -->
    <div class="main-panel" id="mainPanel">
        <div class="panel-handle" id="panelHandle" onclick="togglePanel()"></div>
        
        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" data-screen="home" onclick="switchScreen('home')">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </button>
            <button class="nav-tab" data-screen="history" onclick="switchScreen('history')">
                <i class="fas fa-history"></i>
                <span>History</span>
            </button>
            <button class="nav-tab" data-screen="account" onclick="switchScreen('account')">
                <i class="fas fa-user"></i>
                <span>Account</span>
            </button>
            <button class="nav-tab" data-screen="emergency" onclick="switchScreen('emergency')">
                <i class="fas fa-ambulance"></i>
                <span>Emergency</span>
            </button>
        </div>
        
        <!-- Home Screen Content -->
        <div id="homeContent">
            <!-- Service Tabs -->
            <div class="service-tabs" id="serviceTabs">
                <div class="service-tab car active" data-service="car" onclick="switchService('car')">
                    <div class="service-icon">
                        <i class="fas fa-car"></i>
                    </div>
                    <div class="service-name">Car</div>
                    <div class="service-desc">Ride anywhere</div>
                </div>
                
                <div class="service-tab delivery" data-service="delivery" onclick="switchService('delivery')">
                    <div class="service-icon">
                        <i class="fas fa-shipping-fast"></i>
                    </div>
                    <div class="service-name">Delivery</div>
                    <div class="service-desc">Send packages</div>
                </div>
                
                <div class="service-tab short-delivery" data-service="short-delivery" onclick="switchService('short-delivery')">
                    <div class="service-icon">
                        <i class="fas fa-bicycle"></i>
                    </div>
                    <div class="service-name">Short Delivery</div>
                    <div class="service-desc">Quick deliveries</div>
                </div>
                
                <div class="service-tab" data-service="express" onclick="switchService('express')">
                    <div class="service-icon">
                        <i class="fas fa-shopping-bag"></i>
                    </div>
                    <div class="service-name">Express Shopping</div>
                    <div class="service-desc">Shop for you</div>
                </div>
                
                <div class="service-tab" data-service="truck" onclick="switchService('truck')">
                    <div class="service-icon">
                        <i class="fas fa-truck"></i>
                    </div>
                    <div class="service-name">Truck</div>
                    <div class="service-desc">Move items</div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="quick-actions">
                <button class="quick-action-btn" id="moreOptionsBtn" onclick="toggleMoreOptions()">
                    <div class="quick-action-icon">
                        <i class="fas fa-ellipsis-h"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">More Options</div>
                        <div class="quick-action-desc">Schedule, share, broadcast</div>
                    </div>
                </button>
                <button class="quick-action-btn" id="broadcastRideBtn" onclick="switchService('broadcast')">
                    <div class="quick-action-icon">
                        <i class="fas fa-broadcast-tower"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">Broadcast Ride</div>
                        <div class="quick-action-desc">Share with friends</div>
                    </div>
                </button>
                <button class="quick-action-btn" id="sosSetupBtn" onclick="openSOSModal()">
                    <div class="quick-action-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">SOS Setup</div>
                        <div class="quick-action-desc">Emergency contacts</div>
                    </div>
                </button>
                <button class="quick-action-btn" id="recentDestinationsBtn" onclick="showRecentDestinations()">
                    <div class="quick-action-icon">
                        <i class="fas fa-history"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">Recent Destinations</div>
                        <div class="quick-action-desc">Quick access</div>
                    </div>
                </button>
            </div>
            
            <!-- Car Service Form (Default) -->
            <div class="ride-request-form active" id="carForm">
                <div class="form-title">
                    <i class="fas fa-car"></i>
                    Book a Ride
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="pickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="pickupLocation" placeholder="Current location" readonly>
                        <div class="search-loading" id="searchLoading"></div>
                        <div class="suggestion-list" id="pickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="destinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="destinationLocation" placeholder="Where to?" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="destinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Stops Container -->
                <div id="stopsContainer" style="margin: 10px 0;"></div>
                <button type="button" class="btn btn-secondary" id="addStopBtn" style="width: 100%; margin-bottom: 15px;" onclick="addStop()">
                    <i class="fas fa-plus"></i> Add Stop
                </button>
                
                <!-- Search History -->
                <div class="search-history" id="searchHistory" style="display: none;"></div>
                
                <!-- Ride Type Selection -->
                <div class="ride-type-selection" id="rideTypeSelection">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                        <span id="rideTypeInfo" style="font-size: 11px; color: var(--text-light); cursor: pointer;">
                            <i class="fas fa-info-circle"></i>
                        </span>
                    </div>
                    
                    <!-- Ride Type Cards will be inserted here by JavaScript -->
                    <div class="ride-type-cards" id="rideTypeCardsContainer"></div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="fareDisplay">
                    <div class="fare-label">Estimated Fare</div>
                    <div class="fare-amount" id="estimatedFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="distanceDetail">0 km</span>
                        <span id="timeDetail">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Price Calculator Display -->
                <div class="price-calculator-display" id="priceCalculator" style="display: none;">
                    <div class="fare-label">Fare Breakdown</div>
                    <div class="fare-amount" id="calculatedFare">ZMW 0.00</div>
                    <div class="price-breakdown" id="priceBreakdown">
                        <!-- Breakdown will be inserted here -->
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestRideBtn" onclick="requestRide()">
                        <i class="fas fa-search"></i>
                        Request Ride
                    </button>
                </div>
            </div>
            
            <!-- Delivery Service Form -->
            <div class="service-form delivery-form" id="deliveryForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-shipping-fast"></i>
                    Package Delivery
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="deliveryPickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="deliveryPickup" placeholder="Pickup location" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="deliveryPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="deliveryDestinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="deliveryDestination" placeholder="Delivery address" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="deliveryDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Delivery Details -->
                <div class="form-group">
                    <label class="form-label">Parcel Description</label>
                    <input type="text" class="form-control" id="parcelDescription" placeholder="What are you sending?">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Receiver's Details</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="receiverName" placeholder="Receiver name">
                        <input type="tel" class="form-control" id="receiverPhone" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Parcel Value (ZMW)</label>
                    <input type="number" class="form-control" id="parcelValue" placeholder="Value of parcel" min="0" step="0.01">
                </div>
                
                <!-- Delivery Options -->
                <div class="form-group">
                    <label class="form-label">Delivery Type</label>
                    <div style="display: flex; gap: 10px;">
                        <button class="filter-btn active" id="standardDelivery" onclick="selectDeliveryType('standard')">Standard</button>
                        <button class="filter-btn" id="expressDelivery" onclick="selectDeliveryType('express')">Express</button>
                        <button class="filter-btn" id="sameDayDelivery" onclick="selectDeliveryType('sameDay')">Same Day</button>
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="deliveryFareDisplay" style="display: none;">
                    <div class="fare-label">Delivery Fare</div>
                    <div class="fare-amount" id="deliveryFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="deliveryDistance">0 km</span>
                        <span id="deliveryTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestDeliveryBtn" onclick="requestDelivery()">
                        <i class="fas fa-shipping-fast"></i>
                        Request Delivery
                    </button>
                </div>
            </div>
            
            <!-- Short Delivery Form -->
            <div class="service-form delivery-form" id="shortDeliveryForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-bicycle"></i>
                    Short Delivery
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="shortDeliveryPickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="shortDeliveryPickup" placeholder="Pickup location" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shortDeliveryPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="shortDeliveryDestinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="shortDeliveryDestination" placeholder="Delivery address" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shortDeliveryDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Delivery Details -->
                <div class="form-group">
                    <label class="form-label">What are you sending?</label>
                    <input type="text" class="form-control" id="shortParcelDescription" placeholder="Food, documents, small items...">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Receiver's Phone</label>
                    <input type="tel" class="form-control" id="shortReceiverPhone" placeholder="Receiver phone number">
                </div>
                
                <!-- Quick Options -->
                <div class="form-group">
                    <label class="form-label">Quick Options</label>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <span class="filter-btn">Food</span>
                        <span class="filter-btn">Documents</span>
                        <span class="filter-btn">Medication</span>
                        <span class="filter-btn">Small Package</span>
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="shortDeliveryFareDisplay" style="display: none;">
                    <div class="fare-label">Delivery Fare</div>
                    <div class="fare-amount" id="shortDeliveryFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="shortDeliveryDistance">0 km</span>
                        <span id="shortDeliveryTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestShortDeliveryBtn" onclick="requestShortDelivery()">
                        <i class="fas fa-bolt"></i>
                        Quick Delivery
                    </button>
                </div>
            </div>
            
            <!-- Express Shopping Form -->
            <div class="service-form express-form" id="expressForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-shopping-bag"></i>
                    Express Shopping
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="shopNameInput">
                        <i class="fas fa-store"></i>
                        <input type="text" id="shopName" placeholder="Shop/Restaurant name" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shopSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="shopLocation" placeholder="Shop location" readonly>
                    </div>
                </div>
                
                <!-- Items List -->
                <div class="form-group">
                    <label class="form-label">Shopping List</label>
                    <div class="item-list" id="shoppingItems">
                        <div class="item-entry">
                            <input type="text" class="item-input" placeholder="Item name">
                            <button class="remove-item" type="button">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <button class="add-item" type="button" id="addItemBtn" onclick="addShoppingItem()">
                        <i class="fas fa-plus"></i>
                        Add Item
                    </button>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Special Instructions</label>
                    <textarea class="form-control form-textarea" id="shoppingInstructions" placeholder="Any specific requests or instructions..."></textarea>
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="shoppingDestinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="shoppingDestination" placeholder="Delivery address" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shoppingDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Budget -->
                <div class="form-group">
                    <label class="form-label">Estimated Budget (ZMW)</label>
                    <input type="number" class="form-control" id="shoppingBudget" placeholder="Estimated cost of items">
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="shoppingFareDisplay" style="display: none;">
                    <div class="fare-label">Shopping Service Fare</div>
                    <div class="fare-amount" id="shoppingFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="shoppingDistance">0 km</span>
                        <span id="shoppingTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestShoppingBtn" onclick="requestShopping()">
                        <i class="fas fa-shopping-cart"></i>
                        Request Shopping
                    </button>
                </div>
            </div>
            
            <!-- Truck Delivery Form -->
            <div class="service-form truck-form" id="truckForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-truck"></i>
                    Truck Delivery
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="truckPickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="truckPickup" placeholder="Pickup location (Current location)" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="truckPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="truckDestinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="truckDestination" placeholder="Destination" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="truckDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Truck Type Selection -->
                <div class="form-group">
                    <label class="form-label">Select Truck Type</label>
                    <div class="truck-types">
                        <div class="truck-type" data-type="pickup" onclick="selectTruckType('pickup')">
                            <div class="truck-icon">
                                <i class="fas fa-truck-pickup"></i>
                            </div>
                            <div class="truck-name">Pickup Truck</div>
                            <div class="truck-capacity">Up to 1.5 tons</div>
                        </div>
                        
                        <div class="truck-type selected" data-type="light" onclick="selectTruckType('light')">
                            <div class="truck-icon">
                                <i class="fas fa-truck-moving"></i>
                            </div>
                            <div class="truck-name">Light Truck</div>
                            <div class="truck-capacity">Up to 3 tons</div>
                        </div>
                        
                        <div class="truck-type" data-type="medium" onclick="selectTruckType('medium')">
                            <div class="truck-icon">
                                <i class="fas fa-truck"></i>
                            </div>
                            <div class="truck-name">Medium Truck</div>
                            <div class="truck-capacity">Up to 7 tons</div>
                        </div>
                        
                        <div class="truck-type" data-type="heavy" onclick="selectTruckType('heavy')">
                            <div class="truck-icon">
                                <i class="fas fa-truck-loading"></i>
                            </div>
                            <div class="truck-name">Heavy Truck</div>
                            <div class="truck-capacity">Up to 15 tons</div>
                        </div>
                    </div>
                </div>
                
                <!-- Item Details -->
                <div class="form-group">
                    <label class="form-label">What are you moving?</label>
                    <input type="text" class="form-control" id="truckItemDescription" placeholder="Furniture, boxes, equipment...">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Estimated Weight (kg)</label>
                    <input type="number" class="form-control" id="estimatedWeight" placeholder="Approximate weight">
                </div>
                
                <!-- Additional Help -->
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="needHelpers">
                        <span style="margin-left: 8px;">Need loading/unloading helpers (+ZMW 50)</span>
                    </label>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="truckFareDisplay" style="display: none;">
                    <div class="fare-label">Truck Fare</div>
                    <div class="fare-amount" id="truckFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="truckDistance">0 km</span>
                        <span id="truckTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestTruckBtn" onclick="requestTruck()">
                        <i class="fas fa-truck"></i>
                        Request Truck
                    </button>
                </div>
            </div>
            
            <!-- Ride Info Panel -->
            <div class="ride-info-panel" id="rideInfoPanel" style="display: none;">
                <div class="driver-info">
                    <div class="driver-avatar" id="driverAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="driver-details">
                        <div class="driver-name" id="driverName">Driver Name</div>
                        <div class="driver-rating">
                            <i class="fas fa-star"></i>
                            <span id="driverRating">4.8</span>
                        </div>
                        <div class="driver-vehicle">
                            <i class="fas fa-car"></i>
                            <span id="vehicleDetails">Toyota Corolla - ABC 123</span>
                        </div>
                    </div>
                </div>
                
                <!-- Driver Media Display -->
                <div class="driver-media" id="driverMedia">
                    <div class="media-container">
                        <div class="media-placeholder" id="driverImagePlaceholder">
                            <i class="fas fa-user"></i>
                            <span>Driver Image</span>
                        </div>
                        <img id="driverImage" style="display: none;">
                    </div>
                    <div class="media-container">
                        <div class="media-placeholder" id="vehicleImagePlaceholder">
                            <i class="fas fa-car"></i>
                            <span>Vehicle Image</span>
                        </div>
                        <img id="vehicleImage" style="display: none;">
                    </div>
                </div>
                
                <!-- Tracking Info -->
                <div class="tracking-info" id="trackingInfo">
                    <div class="tracking-header">
                        <div class="tracking-title">Driver Distance</div>
                        <div class="tracking-distance" id="driverDistance">0 km</div>
                    </div>
                    <div class="tracking-progress">
                        <div class="tracking-progress-bar" id="trackingProgress" style="width: 0%"></div>
                    </div>
                    <div class="tracking-details">
                        <span id="pickupDistance">0 km to pickup</span>
                        <span id="etaToPickup">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Timeline -->
                <div class="timeline" id="rideTimeline">
                    <div class="timeline-step">
                        <div class="step-dot active" id="stepRequested">
                            <i class="fas fa-search"></i>
                        </div>
                        <div class="step-label active">Requested</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepAccepted">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <div class="step-label">Accepted</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepArrived">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="step-label">Arrived</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepStarted">
                            <i class="fas fa-play"></i>
                        </div>
                        <div class="step-label">Started</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepCompleted">
                            <i class="fas fa-flag-checkered"></i>
                        </div>
                        <div class="step-label">Completed</div>
                    </div>
                </div>
                
                <!-- Ride Stops -->
                <div class="ride-stops" id="rideStopsContainer" style="display: none; margin-top: 15px;">
                    <div class="section-title" style="font-size: 14px; color: var(--text-gray); margin-bottom: 10px;">
                        <i class="fas fa-map-pin"></i> Stops
                    </div>
                    <div id="rideStopsList"></div>
                </div>
                
                <div class="trip-details">
                    <div class="trip-locations">
                        <div class="location-point">
                            <div class="location-marker pickup">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="location-text">
                                <div class="location-label">Pickup</div>
                                <div class="location-address" id="currentPickup">Loading...</div>
                            </div>
                        </div>
                        
                        <div class="location-point">
                            <div class="location-marker destination">
                                <i class="fas fa-flag"></i>
                            </div>
                            <div class="location-text">
                                <div class="location-label">Destination</div>
                                <div class="location-address" id="currentDestination">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Location Details -->
                <div class="location-details">
                    <div class="location-detail-item">
                        <div class="location-detail-icon">
                            <i class="fas fa-road"></i>
                        </div>
                        <div class="location-detail-content">
                            <div class="location-detail-label">Distance</div>
                            <div class="location-detail-value" id="rideDistance">0 km</div>
                        </div>
                    </div>
                    <div class="location-detail-item">
                        <div class="location-detail-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="location-detail-content">
                            <div class="location-detail-label">Estimated Time</div>
                            <div class="location-detail-value" id="rideTime">0 min</div>
                        </div>
                    </div>
                </div>
                
                <div class="fare-breakdown">
                    <div class="fare-row">
                        <span class="fare-label">Base Fare</span>
                        <span class="fare-value" id="baseFareValue">ZMW 15.00</span>
                    </div>
                    <div class="fare-row">
                        <span class="fare-label">Distance</span>
                        <span class="fare-value" id="distanceFareValue">ZMW 5.00</span>
                    </div>
                    <div class="fare-row">
                        <span class="fare-label">Ride Type</span>
                        <span class="fare-value" id="rideTypeValue">Standard</span>
                    </div>
                    <div class="fare-row total">
                        <span class="fare-label">Total Fare</span>
                        <span class="fare-value" id="totalFareValue">ZMW 20.00</span>
                    </div>
                </div>
                
                <!-- Emergency Contact Display -->
                <div class="emergency-contact-display" id="emergencyContactDisplay" style="display: none;">
                    <div class="emergency-contact-header">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div class="emergency-contact-title">Emergency Contacts</div>
                    </div>
                    <div class="emergency-contact-item">
                        <div class="contact-info">
                            <div class="contact-name" id="emergencyContact1Name">Contact 1</div>
                            <div class="contact-phone" id="emergencyContact1Phone">000-000-0000</div>
                        </div>
                        <button class="contact-action-btn" id="emergencyContact1Btn">
                            <i class="fas fa-phone"></i>
                        </button>
                    </div>
                    <div class="emergency-contact-item">
                        <div class="contact-info">
                            <div class="contact-name" id="emergencyContact2Name">Contact 2</div>
                            <div class="contact-phone" id="emergencyContact2Phone">000-000-0000</div>
                        </div>
                        <button class="contact-action-btn" id="emergencyContact2Btn">
                            <i class="fas fa-phone"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Broadcast Feature -->
                <div class="broadcast-feature" id="broadcastFeature" style="display: none;">
                    <div class="broadcast-feature-header">
                        <div class="broadcast-feature-title">
                            <i class="fas fa-broadcast-tower"></i>
                            <span>Broadcast Ride</span>
                        </div>
                        <div class="broadcast-status-indicator inactive" id="broadcastStatusIndicator"></div>
                    </div>
                    <div class="broadcast-form">
                        <div class="broadcast-input-group">
                            <input type="text" id="broadcastMemberInput" placeholder="Enter friend's referral code">
                            <button class="broadcast-btn" id="addBroadcastMemberBtn">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div class="broadcast-recipients" id="broadcastMembersContainer">
                            <!-- Recipients will be inserted here -->
                        </div>
                        <button class="btn btn-secondary" id="startBroadcastBtn">
                            <i class="fas fa-play"></i>
                            Start Broadcasting
                        </button>
                    </div>
                </div>

                <!-- Share Ride Status -->
                <div class="share-ride-status" id="shareRideStatus" style="display: none;"></div>
                
                <div class="action-buttons">
                    <button class="btn btn-danger" id="cancelRideBtn" onclick="cancelRide()">
                        <i class="fas fa-times-circle"></i>
                        Cancel Ride
                    </button>
                    <button class="btn btn-secondary" id="contactDriverBtn" onclick="contactDriver()">
                        <i class="fas fa-phone"></i>
                        Call Driver
                    </button>
                    <button class="btn btn-secondary" id="openChatBtn" onclick="openChat()">
                        <i class="fas fa-comment"></i>
                        Chat
                    </button>
                </div>
            </div>
            
            <!-- Broadcast Ride Form -->
            <div class="service-form" id="broadcastForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-broadcast-tower"></i>
                    Broadcast Ride
                </div>
                
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="broadcastPickup" placeholder="Pickup location" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="broadcastPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="broadcastDestination" placeholder="Destination" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="broadcastDestinationSuggestions"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Passenger Phone Numbers (comma separated)</label>
                    <textarea class="form-control form-textarea" id="broadcastPassengers" placeholder="Enter phone numbers of passengers to share this ride with..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Ride Type</label>
                    <select class="form-control" id="broadcastRideType">
                        <option value="standard">Standard</option>
                        <option value="economy">Economy</option>
                        <option value="premium">Premium</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Split Fare</label>
                    <select class="form-control" id="broadcastSplitType">
                        <option value="equal">Equal Split</option>
                        <option value="you_pay_more">You Pay 70%</option>
                        <option value="you_pay_all">You Pay All</option>
                    </select>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="broadcastFareDisplay" style="display: none;">
                    <div class="fare-label">Broadcast Fare</div>
                    <div class="fare-amount" id="broadcastFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="broadcastDistance">0 km</span>
                        <span id="broadcastTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="startBroadcastRideBtn" onclick="startBroadcastRide()">
                        <i class="fas fa-broadcast-tower"></i>
                        Start Broadcast
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- History Screen -->
    <div class="history-screen" id="historyScreen" style="display: none;">
        <div class="screen-header">
            <button class="back-btn" data-screen="home" onclick="switchScreen('home')">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="screen-title">Ride History</div>
        </div>
        
        <div class="history-filters">
            <button class="filter-btn active" data-filter="all" onclick="filterHistory('all')">All</button>
            <button class="filter-btn" data-filter="completed" onclick="filterHistory('completed')">Completed</button>
            <button class="filter-btn" data-filter="cancelled" onclick="filterHistory('cancelled')">Cancelled</button>
            <button class="filter-btn" data-filter="scheduled" onclick="filterHistory('scheduled')">Scheduled</button>
            <button class="filter-btn" data-filter="emergency" onclick="filterHistory('emergency')">Emergency</button>
            <button class="filter-btn" data-filter="delivery" onclick="filterHistory('delivery')">Delivery</button>
            <button class="filter-btn" data-filter="truck" onclick="filterHistory('truck')">Truck</button>
            <button class="filter-btn" data-filter="broadcast" onclick="filterHistory('broadcast')">Broadcast</button>
        </div>
        
        <div class="history-list" id="historyList">
            <!-- History items will be inserted here -->
        </div>
    </div>
    
    <!-- Account Screen -->
    <div class="account-screen" id="accountScreen" style="display: none;">
        <div class="screen-header">
            <button class="back-btn" data-screen="home" onclick="switchScreen('home')">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="screen-title">My Account</div>
        </div>
        
        <div class="account-header">
            <div class="account-avatar" id="accountAvatar">
                <i class="fas fa-user"></i>
            </div>
            <div class="account-name" id="accountName">Loading...</div>
            <div class="account-phone" id="accountPhone">Loading...</div>
        </div>
        
        <div class="account-stats">
            <div class="stat-card">
                <div class="stat-value" id="completedRides">0</div>
                <div class="stat-label">Completed Rides</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="cancelledRides">0</div>
                <div class="stat-label">Cancelled Rides</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalSpent">ZMW 0</div>
                <div class="stat-label">Total Spent</div>
            </div>
        </div>
        
        <div class="account-section">
            <div class="section-title">
                <i class="fas fa-wallet"></i>
                Wallet Balance
            </div>
            
            <div class="wallet-balance">
                <div class="balance-label">Available Balance</div>
                <div class="balance-amount-large" id="accountBalance">ZMW 0.00</div>
            </div>
            
            <div class="wallet-actions">
                <button class="btn-wallet" id="depositBtn" onclick="openDepositModal()">
                    <i class="fas fa-plus"></i>
                    Deposit
                </button>
                <button class="btn-wallet" id="withdrawBtn" onclick="openWithdrawModal()">
                    <i class="fas fa-minus"></i>
                    Withdraw
                </button>
                <button class="btn-wallet" id="transferBtn" onclick="openTransferModal()">
                    <i class="fas fa-exchange-alt"></i>
                    Transfer
                </button>
                <button class="btn-wallet" id="transactionsBtn" onclick="openTransactionsModal()">
                    <i class="fas fa-history"></i>
                    History
                </button>
            </div>
        </div>
        
        <div class="account-section">
            <div class="section-title">
                <i class="fas fa-gift"></i>
                Referral Program
            </div>
            
            <div class="referral-card">
                <div>Share your referral code and earn ZMW 25 for each friend's first ride</div>
                <div class="referral-code" id="referralCode">JUBEL-XXXX</div>
                <button class="btn btn-primary" id="shareReferralBtn" onclick="shareReferral()">
                    <i class="fas fa-share"></i>
                    Share Code
                </button>
                <div class="referral-note">Your friend gets 50% off their first ride</div>
            </div>
        </div>
        
        <div class="account-section">
            <div class="section-title">
                <i class="fas fa-cog"></i>
                Settings
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-secondary" id="updateProfileBtn" onclick="openUpdateProfileModal()">
                    <i class="fas fa-user-edit"></i>
                    Update Profile
                </button>
                <button class="btn btn-secondary" id="logoutBtn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </button>
            </div>
        </div>
    </div>
    
    <!-- Emergency Screen -->
    <div class="emergency-screen" id="emergencyScreen" style="display: none;">
        <div class="screen-header">
            <button class="back-btn" data-screen="home" onclick="switchScreen('home')">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="screen-title">Emergency Services</div>
        </div>
        
        <div class="emergency-services">
            <div class="emergency-service police" data-type="police" onclick="openEmergencyModal('police')">
                <div class="emergency-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <div class="emergency-name">Police Ride</div>
                <div class="emergency-description">Emergency transport with police escort</div>
            </div>
            
            <div class="emergency-service fire" data-type="fire" onclick="openEmergencyModal('fire')">
                <div class="emergency-icon">
                    <i class="fas fa-fire-extinguisher"></i>
                </div>
                <div class="emergency-name">Fire Brigade</div>
                <div class="emergency-description">Fire emergency response team</div>
            </div>
            
            <div class="emergency-service medical" data-type="medical" onclick="openEmergencyModal('medical')">
                <div class="emergency-icon">
                    <i class="fas fa-ambulance"></i>
                </div>
                <div class="emergency-name">Hospital Ride</div>
                <div class="emergency-description">Medical emergency transport</div>
            </div>
            
            <div class="emergency-service" data-type="sos" onclick="openSOSModal()">
                <div class="emergency-icon" style="background: var(--error-red);">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="emergency-name">SOS Emergency</div>
                <div class="emergency-description">Immediate emergency assistance</div>
            </div>
        </div>
        
        <div class="emergency-note">
            <p><strong>Important:</strong> Only use emergency services for genuine emergencies. Misuse may result in penalties. In case of immediate danger, call 911 first.</p>
        </div>
    </div>
    
    <!-- Modals -->
    
    <!-- Payment Modal -->
    <div class="modal-overlay" id="paymentModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-credit-card"></i>
                    Select Payment Method
                </div>
                <button class="modal-close" data-modal="payment" onclick="closeModal('payment')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <div class="form-label">Available Balance: <span id="paymentBalance">ZMW 0.00</span></div>
                    <div class="form-label">Total Amount: <span id="paymentAmount">ZMW 0.00</span></div>
                </div>
                
                <!-- Referral Discount Section -->
                <div class="referral-discount-section" id="referralDiscountSection" style="display: none;">
                    <div class="section-header">
                        <i class="fas fa-gift"></i>
                        <span>Referral Discount (50% off)</span>
                    </div>
                    <div class="referral-input-group">
                        <input type="text" id="referralCodeInput" placeholder="Enter referral code">
                        <button id="applyReferralBtn" class="btn btn-orange" onclick="applyReferral()">
                            <i class="fas fa-check"></i> Apply
                        </button>
                    </div>
                    <div id="referrerInfo" style="display: none; font-size: 12px; color: var(--success-green); margin-top: 5px;"></div>
                    <div class="discount-breakdown" style="margin-top: 10px;">
                        <div class="price-row">
                            <span>Original Fare:</span>
                            <span id="originalFareAmount">ZMW 0.00</span>
                        </div>
                        <div class="price-row">
                            <span>Discount:</span>
                            <span id="discountAmount" style="color: var(--success-green);">-ZMW 0.00</span>
                        </div>
                        <div class="price-row total">
                            <span>Final Fare:</span>
                            <span id="finalFareAmount" style="font-weight: bold;">ZMW 0.00</span>
                        </div>
                    </div>
                </div>
                
                <div class="payment-methods">
                    <div class="payment-method" data-payment="wallet" onclick="selectPaymentMethod('wallet')">
                        <div class="payment-icon">
                            <i class="fas fa-wallet"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Jubel Wallet</div>
                            <div class="payment-info">Pay with your wallet balance</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-payment="mobile" onclick="selectPaymentMethod('mobile')">
                        <div class="payment-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Mobile Money</div>
                            <div class="payment-info">Pay via MTN/Zamtel/Airtel</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-payment="cash" onclick="selectPaymentMethod('cash')">
                        <div class="payment-icon">
                            <i class="fas fa-money-bill"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Cash</div>
                            <div class="payment-info">Pay driver directly</div>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmPaymentBtn" onclick="confirmPayment()">
                        <i class="fas fa-check"></i>
                        Confirm Payment
                    </button>
                    <button class="btn btn-secondary" data-modal="payment" onclick="closeModal('payment')">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Cancel Ride Modal -->
    <div class="modal-overlay" id="cancelModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-times-circle"></i>
                    Cancel Ride
                </div>
                <button class="modal-close" data-modal="cancel" onclick="closeModal('cancel')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <div class="form-label">Please select a reason for cancellation:</div>
                </div>
                
                <div class="cancel-reasons">
                    <div class="cancel-reason" data-reason="driver_late" onclick="selectCancelReason('driver_late')">
                        <div class="reason-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="reason-text">Driver is taking too long</div>
                    </div>
                    
                    <div class="cancel-reason" data-reason="change_plans" onclick="selectCancelReason('change_plans')">
                        <div class="reason-icon">
                            <i class="fas fa-calendar-times"></i>
                        </div>
                        <div class="reason-text">Change of plans</div>
                    </div>
                    
                    <div class="cancel-reason" data-reason="found_alternative" onclick="selectCancelReason('found_alternative')">
                        <div class="reason-icon">
                            <i class="fas fa-car"></i>
                        </div>
                        <div class="reason-text">Found alternative transport</div>
                    </div>
                    
                    <div class="cancel-reason" data-reason="emergency" onclick="selectCancelReason('emergency')">
                        <div class="reason-icon">
                            <i class="fas fa-exclamation"></i>
                        </div>
                        <div class="reason-text">Emergency situation</div>
                    </div>
                    
                    <div class="cancel-reason" data-reason="other" onclick="selectCancelReason('other')">
                        <div class="reason-icon">
                            <i class="fas fa-ellipsis-h"></i>
                        </div>
                        <div class="reason-text">Other reason</div>
                    </div>
                </div>
                
                <div class="form-group" id="otherReasonGroup" style="display: none;">
                    <label class="form-label">Please specify:</label>
                    <textarea class="form-control form-textarea" id="otherReason" placeholder="Enter your reason here..."></textarea>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-danger" id="confirmCancelBtn" onclick="confirmCancelRide()">
                        <i class="fas fa-times"></i>
                        Cancel Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="cancel" onclick="closeModal('cancel')">
                        Go Back
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Emergency Ride Modal -->
    <div class="modal-overlay" id="emergencyModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-ambulance"></i>
                    Emergency Ride Details
                </div>
                <button class="modal-close" data-modal="emergency" onclick="closeModal('emergency')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content emergency-modal-content">
                <div class="form-group">
                    <div class="form-label" id="emergencyServiceType">Police Ride</div>
                </div>
                
                <!-- Emergency Reasons -->
                <div class="form-group">
                    <label class="form-label">Select Emergency Reason</label>
                    <div class="emergency-reasons">
                        <div class="emergency-reason" data-reason="accident" onclick="selectEmergencyReason('accident')">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-car-crash"></i>
                            </div>
                            <div class="emergency-reason-text">Accident</div>
                        </div>
                        
                        <div class="emergency-reason" data-reason="medical" onclick="selectEmergencyReason('medical')">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-heartbeat"></i>
                            </div>
                            <div class="emergency-reason-text">Medical Emergency</div>
                        </div>
                        
                        <div class="emergency-reason" data-reason="crime" onclick="selectEmergencyReason('crime')">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="emergency-reason-text">Crime/Assault</div>
                        </div>
                        
                        <div class="emergency-reason" data-reason="fire" onclick="selectEmergencyReason('fire')">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-fire"></i>
                            </div>
                            <div class="emergency-reason-text">Fire Emergency</div>
                        </div>
                        
                        <div class="emergency-reason" data-reason="other" onclick="selectEmergencyReason('other')">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="emergency-reason-text">Other Emergency</div>
                        </div>
                    </div>
                    
                    <div class="emergency-reason-input" id="emergencyReasonOther" style="display: none;">
                        <label class="form-label">Please describe the emergency:</label>
                        <textarea class="form-control form-textarea" id="emergencyOtherReason" placeholder="Describe the emergency situation..."></textarea>
                    </div>
                </div>
                
                <!-- Location Inputs -->
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="emergencyPickup" placeholder="Pickup location" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="emergencyPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="emergencyDestination" placeholder="Destination" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="emergencyDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Emergency Stations -->
                <div class="form-group">
                    <label class="form-label">Select Nearest Emergency Station</label>
                    <div class="emergency-stations" id="emergencyStations">
                        <!-- Stations will be inserted here -->
                    </div>
                </div>
                
                <!-- User Location Details -->
                <div class="location-details">
                    <div class="location-detail-item">
                        <div class="location-detail-icon">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="location-detail-content">
                            <div class="location-detail-label">Your Location</div>
                            <div class="location-detail-value" id="emergencyUserLocation">Detecting location...</div>
                        </div>
                    </div>
                </div>
                
                <!-- Price Calculation -->
                <div class="price-calculation">
                    <div class="calculation-row">
                        <span>Base Emergency Fare:</span>
                        <span id="emergencyBaseFare">ZMW 100.00</span>
                    </div>
                    <div class="calculation-row">
                        <span>Distance to Service:</span>
                        <span id="emergencyDistance">0 km</span>
                    </div>
                    <div class="calculation-row">
                        <span>Estimated Time:</span>
                        <span id="emergencyTime">5 min</span>
                    </div>
                    <div class="calculation-row total">
                        <span>Total Fare:</span>
                        <span id="emergencyTotalFare">ZMW 100.00</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-danger" id="confirmEmergencyBtn" onclick="confirmEmergencyRide()">
                        <i class="fas fa-exclamation-triangle"></i>
                        Request Emergency Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="emergency" onclick="closeModal('emergency')">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- SOS Setup Modal -->
    <div class="modal-overlay" id="sosModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    SOS Emergency Setup
                </div>
                <button class="modal-close" data-modal="sos" onclick="closeModal('sos')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <label class="form-label">Primary Emergency Contact</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="sosContact1Name" placeholder="Contact name">
                        <input type="tel" class="form-control" id="sosContact1Phone" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Secondary Emergency Contact (Optional)</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="sosContact2Name" placeholder="Contact name">
                        <input type="tel" class="form-control" id="sosContact2Phone" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Emergency Message</label>
                    <textarea class="form-control form-textarea" id="sosMessage">
I need help! My current location and ride details will be shared with you.
                    </textarea>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="saveSOSBtn" onclick="saveSOSConfig()">
                        <i class="fas fa-save"></i>
                        Save SOS Setup
                    </button>
                    <button class="btn btn-secondary" data-modal="sos" onclick="closeModal('sos')">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Transfer Money Modal -->
    <div class="modal-overlay" id="transferModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-exchange-alt"></i>
                    Transfer Money
                </div>
                <button class="modal-close" data-modal="transfer" onclick="closeModal('transfer')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <div class="form-label">Available Balance: <span id="transferBalance">ZMW 0.00</span></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Recipient's Referral Code</label>
                    <input type="text" class="form-control" id="recipientCode" placeholder="Enter recipient's Jubel referral code">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Amount (ZMW)</label>
                    <input type="number" class="form-control" id="transferAmount" placeholder="Enter amount" min="1" step="0.01">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Message (Optional)</label>
                    <input type="text" class="form-control" id="transferMessage" placeholder="Add a message">
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmTransferBtn" onclick="confirmTransfer()">
                        <i class="fas fa-paper-plane"></i>
                        Send Money
                    </button>
                    <button class="btn btn-secondary" data-modal="transfer" onclick="closeModal('transfer')">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Wallet Transactions Modal -->
    <div class="modal-overlay" id="transactionsModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-history"></i>
                    Wallet Transactions
                </div>
                <button class="modal-close" data-modal="transactions" onclick="closeModal('transactions')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div id="transactionsList">
                    <!-- Transactions will be inserted here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Schedule Ride Modal -->
    <div class="modal-overlay" id="scheduleModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-calendar-alt"></i>
                    Schedule a Ride
                </div>
                <button class="modal-close" data-modal="schedule" onclick="closeModal('schedule')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="schedulePickup" placeholder="Pickup location">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="schedulePickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="scheduleDestination" placeholder="Destination">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="scheduleDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- For Someone Else -->
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="scheduleForSomeone">
                        <span style="margin-left: 8px;">Booking for someone else</span>
                    </label>
                </div>
                
                <div class="form-group" id="someoneElseDetails" style="display: none;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="recipientName" placeholder="Recipient name">
                        <input type="tel" class="form-control" id="recipientPhone" placeholder="Recipient phone">
                    </div>
                </div>
                
                <div class="schedule-grid">
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-control" id="scheduleDate" min="">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Time</label>
                        <input type="time" class="form-control" id="scheduleTime">
                    </div>
                </div>
                
                <!-- Ride Type Selection for Schedule -->
                <div class="ride-type-selection" style="margin: 0 0 16px 0;">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                    </div>
                    <div class="ride-type-grid" id="scheduleRideTypeGrid">
                        <div class="ride-type-card economy" data-type="economy" onclick="selectRideType('economy')">
                            <div class="ride-type-icon">
                                <i class="fas fa-car-side"></i>
                            </div>
                            <div class="ride-type-name">Economy</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card selected" data-type="standard" onclick="selectRideType('standard')">
                            <div class="ride-type-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="ride-type-name">Standard</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card premium" data-type="premium" onclick="selectRideType('premium')">
                            <div class="ride-type-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="ride-type-name">Premium</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="scheduleFareDisplay" style="display: none;">
                    <div class="fare-label">Scheduled Ride Fare</div>
                    <div class="fare-amount" id="scheduleFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="scheduleDistance">0 km</span>
                        <span id="scheduleTimeEstimate">ETA: 0 min</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmScheduleBtn" onclick="confirmScheduleRide()">
                        <i class="fas fa-calendar-check"></i>
                        Schedule Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="schedule" onclick="closeModal('schedule')">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Order for Someone Modal -->
    <div class="modal-overlay" id="orderForSomeoneModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-user-friends"></i>
                    Order for Someone Else
                </div>
                <button class="modal-close" data-modal="orderForSomeone" onclick="closeModal('orderForSomeone')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="someonePickup" placeholder="Pickup location">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="someonePickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="someoneDestination" placeholder="Destination">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="someoneDestinationSuggestions"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Recipient Details</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="someoneName" placeholder="Full name">
                        <input type="tel" class="form-control" id="someonePhone" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Special Instructions (Optional)</label>
                    <textarea class="form-control form-textarea" id="someoneInstructions" placeholder="Any instructions for the driver..."></textarea>
                </div>
                
                <!-- Ride Type Selection -->
                <div class="ride-type-selection" style="margin: 0 0 16px 0;">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                    </div>
                    <div class="ride-type-grid" id="someoneRideTypeGrid">
                        <div class="ride-type-card economy" data-type="economy" onclick="selectRideType('economy')">
                            <div class="ride-type-icon">
                                <i class="fas fa-car-side"></i>
                            </div>
                            <div class="ride-type-name">Economy</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card selected" data-type="standard" onclick="selectRideType('standard')">
                            <div class="ride-type-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="ride-type-name">Standard</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card premium" data-type="premium" onclick="selectRideType('premium')">
                            <div class="ride-type-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="ride-type-name">Premium</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="someoneFareDisplay" style="display: none;">
                    <div class="fare-label">Estimated Fare</div>
                    <div class="fare-amount" id="someoneFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="someoneDistance">0 km</span>
                        <span id="someoneTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmSomeoneRideBtn" onclick="confirmSomeoneRide()">
                        <i class="fas fa-car"></i>
                        Request Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="orderForSomeone" onclick="closeModal('orderForSomeone')">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Share Ride Modal -->
    <div class="modal-overlay" id="shareRideModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-share-alt"></i>
                    Share Ride
                </div>
                <button class="modal-close" data-modal="shareRide" onclick="closeModal('shareRide')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="sharePickup" placeholder="Pickup location">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="sharePickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="shareDestination" placeholder="Destination">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shareDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Share Members Input -->
                <div class="form-group">
                    <label class="form-label">Add Friends by Referral Code</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" class="form-control" id="shareMemberInput" placeholder="Enter friend's referral code">
                        <button class="btn btn-secondary" id="addShareMemberBtn" onclick="addShareMember()">
                            <i class="fas fa-plus"></i> Add
                        </button>
                    </div>
                </div>
                
                <!-- Share Members List -->
                <div class="form-group">
                    <div id="shareFriendsList" class="share-friends-list">
                        <!-- Share members will be inserted here -->
                    </div>
                </div>
                
                <!-- Share Calculations -->
                <div class="form-group" id="shareCalculations" style="display: none;">
                    <!-- Calculations will be inserted here -->
                </div>
                
                <!-- Ride Type Selection -->
                <div class="ride-type-selection" style="margin: 0 0 16px 0;">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                    </div>
                    <div class="ride-type-grid" id="shareRideTypeGrid">
                        <div class="ride-type-card economy" data-type="economy" onclick="selectRideType('economy')">
                            <div class="ride-type-icon">
                                <i class="fas fa-car-side"></i>
                            </div>
                            <div class="ride-type-name">Economy</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card selected" data-type="standard" onclick="selectRideType('standard')">
                            <div class="ride-type-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="ride-type-name">Standard</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card premium" data-type="premium" onclick="selectRideType('premium')">
                            <div class="ride-type-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="ride-type-name">Premium</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Estimated Fare: <span id="shareFareEstimate">ZMW 0.00</span></label>
                    <div class="price-calculation">
                        <div class="calculation-row">
                            <span>Your Share:</span>
                            <span id="yourShare">ZMW 0.00</span>
                        </div>
                        <div class="calculation-row">
                            <span>Friend's Share:</span>
                            <span id="friendShare">ZMW 0.00</span>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmShareRideBtn" onclick="confirmShareRide()">
                        <i class="fas fa-user-friends"></i>
                        Share Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="shareRide" onclick="closeModal('shareRide')">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Share Ride Invitation Modal -->
    <div class="modal-overlay" id="shareRideInvitationModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-users"></i>
                    Share Ride Invitation
                </div>
                <button class="modal-close" data-modal="shareRideInvitation" onclick="closeModal('shareRideInvitation')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="invitation-details" id="invitationDetails">
                    <!-- Invitation details will be inserted here -->
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" id="acceptShareInvitationBtn" onclick="acceptShareInvitation()">
                        <i class="fas fa-check"></i>
                        Accept Invitation
                    </button>
                    <button class="btn btn-secondary" id="rejectShareInvitationBtn" onclick="rejectShareInvitation()">
                        <i class="fas fa-times"></i>
                        Decline
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Update Profile Modal -->
    <div class="modal-overlay" id="updateProfileModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-user-edit"></i>
                    Update Profile
                </div>
                <button class="modal-close" data-modal="updateProfile" onclick="closeModal('updateProfile')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <input type="text" class="form-control" id="updateName" placeholder="Your full name">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Phone Number</label>
                    <input type="tel" class="form-control" id="updatePhone" placeholder="Your phone number">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" class="form-control" id="updateEmail" placeholder="Your email address" readonly>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Home Address (Optional)</label>
                    <input type="text" class="form-control" id="updateHomeAddress" placeholder="Your home address">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Work Address (Optional)</label>
                    <input type="text" class="form-control" id="updateWorkAddress" placeholder="Your work address">
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="saveProfileBtn" onclick="saveProfile()">
                        <i class="fas fa-save"></i>
                        Save Changes
                    </button>
                    <button class="btn btn-secondary" data-modal="updateProfile" onclick="closeModal('updateProfile')">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Loading...</div>
    </div>
    
    <!-- Search Loading Overlay -->
    <div id="searchLoading" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); z-index: 10000;">
        <i class="fas fa-spinner fa-spin"></i> Searching...
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Real-time Indicator -->
    <div class="real-time-indicator" id="realTimeIndicator">
        <i class="fas fa-sync-alt"></i>
        <span>Real-time updates active</span>
    </div>
    
    <!-- Sync Indicator -->
    <div class="sync-indicator" id="syncIndicator">
        <i class="fas fa-sync-alt sync-icon"></i>
        <span>Syncing...</span>
    </div>
    
    <!-- Schedule Countdown -->
    <div id="scheduleCountdown" style="display: none;"></div>
    
    <!-- Firebase and Leaflet JS -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
// ============================================
// FIREBASE CONFIGURATION
// ============================================
const firebaseConfig = {
    apiKey: "AIzaSyDEACX_P4c5q7djJAcA0I7Lk7leO2TlQ74",
    authDomain: "jubel-13e1a.firebaseapp.com",
    databaseURL: "https://jubel-13e1a-default-rtdb.firebaseio.com",
    projectId: "jubel-13e1a",
    storageBucket: "jubel-13e1a.firebasestorage.app",
    messagingSenderId: "882241095445",
    appId: "1:882241095445:web:ee9ca40fddd008ca910b1c",
    measurementId: "G-J5JPKL6B5F"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const auth = firebase.auth();
const storage = firebase.storage();

// ============================================
// ENHANCED APP STATE MANAGEMENT
// ============================================
const AppState = {
    currentUser: null,
    userData: null,
    currentRide: null,
    activeScreen: 'home',
    activeService: 'car',
    walletBalance: 0,
    userLocation: null,
    currentCity: null,
    detectedCity: null,
    selectedRideType: 'standard',
    selectedVehicle: null,
    destination: null,
    pickup: null,
    rideFare: 0,
    driverLocation: null,
    chatMessages: [],
    scheduledRides: [],
    emergencyMode: false,
    sosConfig: null,
    searchCache: new Map(),
    lastSearchTime: 0,
    notifications: [],
    unreadNotifications: 0,
    searchHistory: [],
    broadcastRecipients: [],
    emergencyStations: {
        police: [],
        fire: [],
        medical: []
    },
    realtimeListeners: [],
    rideTypes: {
        bicycle: { base: 8, perKm: 1.5, multiplier: 0.6, min: 5, icon: 'fa-bicycle' },
        economy: { base: 15, perKm: 2.5, multiplier: 0.8, min: 10, icon: 'fa-car-side' },
        standard: { base: 20, perKm: 3.0, multiplier: 1.0, min: 15, icon: 'fa-car' },
        premium: { base: 30, perKm: 4.0, multiplier: 1.5, min: 25, icon: 'fa-crown' }
    },
    emergencyServices: {
        police: { base: 150, perKm: 5.0, multiplier: 2.0, min: 100 },
        fire: { base: 200, perKm: 6.0, multiplier: 2.5, min: 150 },
        medical: { base: 180, perKm: 5.5, multiplier: 2.2, min: 120 }
    },
    deliveryTypes: {
        standard: { base: 25, perKm: 2.0, multiplier: 1.0 },
        express: { base: 40, perKm: 3.0, multiplier: 1.5 },
        sameDay: { base: 60, perKm: 4.0, multiplier: 2.0 }
    },
    truckTypes: {
        pickup: { base: 80, perKm: 5.0, multiplier: 1.0, capacity: '1.5 tons' },
        light: { base: 120, perKm: 6.0, multiplier: 1.2, capacity: '3 tons' },
        medium: { base: 200, perKm: 8.0, multiplier: 1.5, capacity: '7 tons' },
        heavy: { base: 350, perKm: 12.0, multiplier: 2.0, capacity: '15 tons' }
    },
    lastPriceUpdate: 0,
    cityDetectionAttempts: 0,
    maxCityDetectionAttempts: 5,
    isSyncing: false,
    syncInterval: null,
    emergencyReason: null,
    selectedEmergencyStation: null,
    activeBroadcast: null,
    typingTimeout: null,
    driverTyping: false,
    locationManagement: {
        isEditingPickup: false,
        currentPickupInputId: null,
        pickupSearchResults: [],
        cityBounds: null,
        cityPolygon: null,
        userDetectedAddress: null
    },
    activeScheduledTimer: null,
    rideRequestPulsingIcons: {
        bicycle: null,
        car: null,
        bike: null,
        truck: null
    },
    shareRideFriends: [],
    maxShareFriends: 4,
    routeDirections: null,
    pendingPaymentRide: null,
    referralDiscountApplied: false,
    referralDiscountAmount: 0,
    referralUsed: null,
    splitRideParticipants: [],
    shareRideInvitations: [],
    stops: [],
    maxStops: 3,
    rideStops: [],
    stopMarkers: [],
    routePolyline: null
};

// ============================================
// MAP MANAGEMENT
// ============================================
let map = null;
let currentLocationMarker = null;
let pickupMarker = null;
let destinationMarker = null;
let driverMarker = null;
let routeLayer = null;
let emergencyMarkers = [];
let emergencyStationMarkers = [];
let cityBoundaryLayer = null;
let routePolyline = null;

// ============================================
// ENHANCED LOCATION SEARCH ENGINE
// ============================================
const EnhancedSearchEngine = {
    cache: new Map(),
    lastSearch: 0,
    debounceTimer: null,
    searchHistory: [],
    maxHistoryItems: 15,
    activeSearches: new Set(),
    
    init: function() {
        this.loadSearchHistory();
        console.log('Enhanced Search Engine initialized');
    },
    
    loadSearchHistory: function() {
        try {
            const history = localStorage.getItem('jubel_search_history');
            if (history) {
                this.searchHistory = JSON.parse(history);
                console.log(`Loaded ${this.searchHistory.length} search history items`);
            }
        } catch (error) {
            console.error('Error loading search history:', error);
            this.searchHistory = [];
        }
    },
    
    saveSearchHistory: function() {
        try {
            localStorage.setItem('jubel_search_history', JSON.stringify(this.searchHistory));
        } catch (error) {
            console.error('Error saving search history:', error);
        }
    },
    
    addToHistory: function(query, location, type) {
        const historyItem = {
            query: query,
            location: location,
            type: type,
            timestamp: Date.now(),
            city: AppState.currentCity
        };
        
        // Remove duplicates
        this.searchHistory = this.searchHistory.filter(item => 
            !(item.query === query && item.type === type && item.city === AppState.currentCity)
        );
        
        // Add to beginning
        this.searchHistory.unshift(historyItem);
        
        // Keep only max items
        if (this.searchHistory.length > this.maxHistoryItems) {
            this.searchHistory = this.searchHistory.slice(0, this.maxHistoryItems);
        }
        
        this.saveSearchHistory();
        return historyItem;
    },
    
    search: async function(query, type = 'destination', location = null, forceCity = null) {
        const searchId = `${Date.now()}-${Math.random()}`;
        this.activeSearches.add(searchId);
        
        try {
            const city = forceCity || AppState.currentCity;
            if (!city) {
                console.warn('No city detected for search');
                return [];
            }
            
            const cacheKey = `${query.toLowerCase()}-${type}-${city}-${location ? `${location.lat.toFixed(4)},${location.lng.toFixed(4)}` : 'none'}`;
            
            // Return cached results if available and recent (5 minutes)
            if (this.cache.has(cacheKey)) {
                const cached = this.cache.get(cacheKey);
                if (Date.now() - cached.timestamp < 300000) {
                    console.log('Returning cached search results');
                    return cached.results;
                }
            }
            
            console.log(`Searching for "${query}" in ${city}, type: ${type}`);
            
            // Build search URL with city constraints
            const searchUrl = this.buildCityConstrainedSearchUrl(query, city, location);
            
            // Show search loading indicator
            this.showSearchLoading(true);
            
            const response = await fetch(searchUrl, {
                headers: {
                    'User-Agent': 'JubelRideApp/1.0',
                    'Accept': 'application/json'
                }
            });
            
            if (!response.ok) {
                throw new Error(`Search failed: ${response.status} ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log(`Received ${data.length} results for "${query}"`);
            
            // Process and filter results
            const results = this.processAndFilterResults(data, location, city, type);
            
            // Cache the results
            this.cache.set(cacheKey, {
                results: results,
                timestamp: Date.now(),
                query: query,
                city: city
            });
            
            // Add to search history if it's a destination search
            if (type === 'destination' && results.length > 0) {
                this.addToHistory(query, results[0], type);
            }
            
            // Update last search time
            this.lastSearch = Date.now();
            
            return results;
        } catch (error) {
            console.error('Search error:', error);
            
            EnhancedUIUpdater.showToast('Search service temporarily unavailable. Please try again.', 'warning');
            return [];
        } finally {
            this.activeSearches.delete(searchId);
            this.showSearchLoading(false);
        }
    },
    
    buildCityConstrainedSearchUrl: function(query, city, location) {
        const bounds = this.getCityBounds(city);
        if (!bounds) {
            console.warn(`No bounds found for city: ${city}, using wider search`);
            return this.buildSearchUrl(query, location, city);
        }
        
        // Use bounded search for better accuracy
        const params = new URLSearchParams({
            q: `${query}, ${city}, Zambia`,
            format: 'json',
            limit: 20,
            countrycodes: 'zm',
            bounded: 1,
            viewbox: bounds.join(','),
            'accept-language': 'en',
            addressdetails: 1,
            polygon: 0,
            extratags: 0,
            namedetails: 0
        });
        
        return `https://nominatim.openstreetmap.org/search?${params}`;
    },
    
    buildSearchUrl: function(query, location, city) {
        const params = new URLSearchParams({
            q: `${query}${city ? `, ${city}, Zambia` : ', Zambia'}`,
            format: 'json',
            limit: 15,
            countrycodes: 'zm',
            'accept-language': 'en',
            addressdetails: 1
        });
        
        return `https://nominatim.openstreetmap.org/search?${params}`;
    },
    
    getCityBounds: function(cityName) {
        const cityBounds = {
            'Lusaka': [27.8, -15.8, 28.8, -15.2],
            'Ndola': [28.5, -13.1, 28.8, -12.9],
            'Kitwe': [27.9, -13.1, 28.4, -12.7],
            'Kabwe': [28.3, -14.6, 28.6, -14.3],
            'Livingstone': [25.7, -18.0, 26.0, -17.7],
            'Chipata': [32.5, -13.8, 32.8, -13.6],
            'Chingola': [27.8, -12.8, 27.9, -12.4],
            'Mufulira': [28.1, -12.7, 28.3, -12.5],
            'Luanshya': [28.3, -13.2, 28.5, -13.0],
            'Kasama': [31.1, -10.3, 31.3, -10.1],
            'Solwezi': [26.3, -12.3, 26.5, -12.1],
            'Mazabuka': [27.7, -15.9, 27.9, -15.7]
        };
        
        const bounds = cityBounds[cityName];
        if (bounds) {
            AppState.locationManagement.cityBounds = bounds;
            console.log(`City bounds for ${cityName}: ${bounds}`);
        }
        
        return bounds || null;
    },
    
    processAndFilterResults: function(data, location, city, type) {
        if (!data || data.length === 0) return [];
        
        const cityLower = city.toLowerCase();
        const processedResults = [];
        
        data.forEach(place => {
            try {
                const address = place.address || {};
                const placeCity = address.city || address.town || address.village || address.municipality;
                const placeCityLower = placeCity ? placeCity.toLowerCase() : '';
                
                // Strict city filtering - only include places in the current city
                if (city && !this.isInCity(place, cityLower, placeCityLower)) {
                    return; // Skip this result
                }
                
                // Calculate distance if location provided
                let distance = 0;
                if (location) {
                    distance = this.calculateDistance(
                        location.lat, location.lng,
                        parseFloat(place.lat), parseFloat(place.lon)
                    );
                }
                
                // Format address for display
                const displayAddress = this.formatAddress(place, city);
                
                const result = {
                    id: place.place_id || `${place.lat}-${place.lon}`,
                    name: place.display_name.split(',')[0] || 'Unnamed Location',
                    address: displayAddress,
                    fullAddress: place.display_name,
                    lat: parseFloat(place.lat),
                    lng: parseFloat(place.lon),
                    type: place.type || place.class || 'unknown',
                    importance: place.importance || 0,
                    distance: distance,
                    city: placeCity || city,
                    placeType: place.type,
                    category: this.categorizePlace(place),
                    relevance: this.calculateRelevance(place, location, city, type),
                    boundingbox: place.boundingbox,
                    isVerified: this.isVerifiedLocation(place)
                };
                
                processedResults.push(result);
            } catch (error) {
                console.error('Error processing search result:', error, place);
            }
        });
        
        // Sort by relevance and distance
        return processedResults
            .sort((a, b) => {
                // Sort by verified status first
                if (a.isVerified !== b.isVerified) {
                    return b.isVerified - a.isVerified;
                }
                
                // Then by relevance score
                if (a.relevance !== b.relevance) {
                    return b.relevance - a.relevance;
                }
                
                // Then by distance if location is available
                if (location && a.distance !== b.distance) {
                    return a.distance - b.distance;
                }
                
                // Finally by importance
                return b.importance - a.importance;
            })
            .slice(0, 10); // Limit to 10 most relevant results
    },
    
    isInCity: function(place, targetCity, placeCity) {
        if (!targetCity) return true;
        
        // Check if place city matches target city
        if (placeCity && placeCity.includes(targetCity)) {
            return true;
        }
        
        // Check address components
        const address = place.address || {};
        const components = [
            address.city,
            address.town,
            address.village,
            address.municipality,
            address.county,
            address.state_district
        ].filter(Boolean);
        
        return components.some(component => 
            component.toLowerCase().includes(targetCity)
        );
    },
    
    calculateRelevance: function(place, location, city, type) {
        let score = place.importance || 0;
        
        // Boost if in current city
        if (city) {
            const address = place.address || {};
            const placeCity = address.city || address.town || address.village;
            if (placeCity && placeCity.toLowerCase().includes(city.toLowerCase())) {
                score += 0.4;
            }
        }
        
        // Boost by proximity if location is available
        if (location) {
            const distance = this.calculateDistance(
                location.lat, location.lng,
                parseFloat(place.lat), parseFloat(place.lon)
            );
            
            // Higher boost for closer locations
            if (distance < 1) score += 0.3;
            else if (distance < 3) score += 0.2;
            else if (distance < 5) score += 0.1;
            else if (distance < 10) score += 0.05;
        }
        
        // Boost for exact name matches
        if (place.display_name.split(',')[0].toLowerCase() === 
            AppState.lastSearchQuery?.toLowerCase()) {
            score += 0.5;
        }
        
        // Boost for specific types based on search type
        if (type === 'destination') {
            if (place.type === 'restaurant' || place.type === 'hotel' || 
                place.type === 'mall' || place.type === 'supermarket') {
                score += 0.2;
            }
        }
        
        return Math.min(score, 1.0);
    },
    
    formatAddress: function(place, currentCity) {
        const address = place.address || {};
        const parts = [];
        
        if (address.house_number || address.housenumber) {
            parts.push(address.house_number || address.housenumber);
        }
        
        if (address.road) {
            parts.push(address.road);
        }
        
        if (address.suburb || address.neighbourhood) {
            parts.push(address.suburb || address.neighbourhood);
        }
        
        if (address.city || address.town) {
            const cityName = address.city || address.town;
            if (cityName.toLowerCase() !== currentCity.toLowerCase()) {
                parts.push(cityName);
            }
        }
        
        if (parts.length === 0) {
            return place.display_name.split(',').slice(0, 2).join(',').trim();
        }
        
        return parts.join(', ');
    },
    
    categorizePlace: function(place) {
        const type = place.type || place.class || '';
        
        if (type.includes('restaurant') || type.includes('cafe') || type.includes('fast_food')) {
            return 'restaurant';
        } else if (type.includes('hotel') || type.includes('motel') || type.includes('guest_house')) {
            return 'hotel';
        } else if (type.includes('mall') || type.includes('supermarket') || type.includes('shop')) {
            return 'shopping';
        } else if (type.includes('bank') || type.includes('atm')) {
            return 'bank';
        } else if (type.includes('hospital') || type.includes('clinic') || type.includes('pharmacy')) {
            return 'medical';
        } else if (type.includes('school') || type.includes('university') || type.includes('college')) {
            return 'education';
        } else if (type.includes('government') || type.includes('office')) {
            return 'government';
        } else {
            return 'other';
        }
    },
    
    isVerifiedLocation: function(place) {
        const verifiedTypes = [
            'restaurant', 'hotel', 'mall', 'supermarket', 'bank', 'hospital',
            'clinic', 'school', 'university', 'government'
        ];
        
        const type = place.type || place.class || '';
        return verifiedTypes.some(verifiedType => type.includes(verifiedType));
    },
    
    calculateDistance: function(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = this.toRad(lat2 - lat1);
        const dLon = this.toRad(lon2 - lon1);
        const a = 
            Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(this.toRad(lat1)) * Math.cos(this.toRad(lat2)) * 
            Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    },
    
    toRad: function(value) {
        return value * Math.PI / 180;
    },
    
    searchEmergencyStations: async function(type, city) {
        const cacheKey = `emergency-${type}-${city}`;
        
        if (this.cache.has(cacheKey)) {
            const cached = this.cache.get(cacheKey);
            if (Date.now() - cached.timestamp < 3600000) {
                return cached.results;
            }
        }
        
        try {
            let query = '';
            switch(type) {
                case 'police':
                    query = `police station ${city} Zambia`;
                    break;
                case 'fire':
                    query = `fire station ${city} Zambia`;
                    break;
                case 'medical':
                    query = `hospital ${city} Zambia clinic ${city} Zambia`;
                    break;
            }
            
            const bounds = this.getCityBounds(city);
            const params = new URLSearchParams({
                q: query,
                format: 'json',
                limit: 20,
                countrycodes: 'zm',
                bounded: bounds ? 1 : 0,
                'accept-language': 'en',
                addressdetails: 1
            });
            
            if (bounds) {
                params.append('viewbox', bounds.join(','));
            }
            
            const searchUrl = `https://nominatim.openstreetmap.org/search?${params}`;
            const response = await fetch(searchUrl);
            
            if (!response.ok) throw new Error(`Emergency search failed: ${response.status}`);
            
            const data = await response.json();
            const results = data.map(place => ({
                id: place.place_id,
                name: place.display_name.split(',')[0],
                address: this.formatAddress(place, city),
                fullAddress: place.display_name,
                lat: parseFloat(place.lat),
                lng: parseFloat(place.lon),
                type: type,
                distance: AppState.userLocation ? 
                    this.calculateDistance(
                        AppState.userLocation.lat, AppState.userLocation.lng,
                        parseFloat(place.lat), parseFloat(place.lon)
                    ) : 0,
                verified: true
            })).sort((a, b) => a.distance - b.distance);
            
            this.cache.set(cacheKey, {
                results: results,
                timestamp: Date.now()
            });
            
            AppState.emergencyStations[type] = results;
            return results;
        } catch (error) {
            console.error('Emergency station search error:', error);
            return this.getDefaultEmergencyStations(type, city);
        }
    },
    
    getDefaultEmergencyStations: function(type, city) {
        const defaultStations = {
            'Lusaka': {
                police: [
                    { name: 'Lusaka Central Police', address: 'Cairo Road, Lusaka', lat: -15.4167, lng: 28.2833, distance: 0, verified: true },
                    { name: 'Kabulonga Police Station', address: 'Kabulonga, Lusaka', lat: -15.4000, lng: 28.3000, distance: 0, verified: true }
                ],
                fire: [
                    { name: 'Lusaka Fire Brigade', address: 'Cairo Road, Lusaka', lat: -15.4100, lng: 28.2900, distance: 0, verified: true }
                ],
                medical: [
                    { name: 'University Teaching Hospital', address: 'Ridgeway, Lusaka', lat: -15.4050, lng: 28.2950, distance: 0, verified: true },
                    { name: 'Levy Mwanawasa Hospital', address: 'Great North Road, Lusaka', lat: -15.3950, lng: 28.3050, distance: 0, verified: true }
                ]
            },
            'Ndola': {
                police: [
                    { name: 'Ndola Central Police', address: 'Ndola Central', lat: -12.9700, lng: 28.6300, distance: 0, verified: true }
                ],
                fire: [
                    { name: 'Ndola Fire Station', address: 'Ndola Central', lat: -12.9750, lng: 28.6350, distance: 0, verified: true }
                ],
                medical: [
                    { name: 'Ndola Central Hospital', address: 'Ndola Central', lat: -12.9750, lng: 28.6350, distance: 0, verified: true }
                ]
            }
        };
        
        const stations = defaultStations[city]?.[type] || [];
        
        if (AppState.userLocation) {
            stations.forEach(station => {
                station.distance = this.calculateDistance(
                    AppState.userLocation.lat, AppState.userLocation.lng,
                    station.lat, station.lng
                );
            });
            
            stations.sort((a, b) => a.distance - b.distance);
        }
        
        AppState.emergencyStations[type] = stations;
        return stations;
    },
    
    showSearchLoading: function(show) {
        const loadingElement = document.getElementById('searchLoading');
        if (loadingElement) {
            loadingElement.style.display = show ? 'flex' : 'none';
        }
    },
    
    clearCache: function() {
        this.cache.clear();
        console.log('Search cache cleared');
    },
    
    getSearchHistory: function(type = null, city = null) {
        let history = this.searchHistory;
        
        if (type) {
            history = history.filter(item => item.type === type);
        }
        
        if (city) {
            history = history.filter(item => item.city === city);
        }
        
        return history;
    },
    
    clearSearchHistory: function() {
        this.searchHistory = [];
        this.saveSearchHistory();
        EnhancedUIUpdater.showToast('Search history cleared', 'success');
    },
    
    validateCoordinatesInCity: function(lat, lng, city) {
        const bounds = this.getCityBounds(city);
        if (!bounds) return true;
        
        const [west, south, east, north] = bounds;
        return lng >= west && lng <= east && lat >= south && lat <= north;
    }
};

// ============================================
// ENHANCED LOCATION MANAGEMENT
// ============================================
const EnhancedLocationManager = {
    currentPickupInput: null,
    pickupEditMode: false,
    searchTimeout: null,
    
    init: function() {
        console.log('Enhanced Location Manager initialized');
        this.setupLocationInputs();
        this.setupStopsFeature();
    },
    
    setupLocationInputs: function() {
        const pickupInputs = [
            'pickupLocation', 'deliveryPickup', 'shortDeliveryPickup',
            'truckPickup', 'schedulePickup', 'someonePickup',
            'sharePickup', 'broadcastPickup', 'emergencyPickup'
        ];
        
        pickupInputs.forEach(inputId => {
            const input = document.getElementById(inputId);
            if (input) {
                this.setupPickupInput(input);
            }
        });
        
        const destinationInputs = [
            'destinationLocation', 'deliveryDestination', 'shortDeliveryDestination',
            'truckDestination', 'scheduleDestination', 'someoneDestination',
            'shareDestination', 'broadcastDestination', 'shoppingDestination',
            'emergencyDestination'
        ];
        
        destinationInputs.forEach(inputId => {
            const input = document.getElementById(inputId);
            if (input) {
                this.setupDestinationInput(input);
            }
        });
    },
    
    setupStopsFeature: function() {
        const addStopBtn = document.getElementById('addStopBtn');
        if (addStopBtn) {
            addStopBtn.addEventListener('click', () => {
                this.addStop();
            });
        }
        
        // Initialize stops container
        const stopsContainer = document.getElementById('stopsContainer');
        if (stopsContainer) {
            stopsContainer.innerHTML = '';
        }
    },
    
    addStop: function() {
        if (AppState.stops.length >= AppState.maxStops) {
            EnhancedUIUpdater.showToast(`Maximum ${AppState.maxStops} stops allowed`, 'warning');
            return;
        }
        
        const stopId = `stop_${Date.now()}`;
        const stopNumber = AppState.stops.length + 1;
        
        const stopElement = document.createElement('div');
        stopElement.className = 'stop-entry';
        stopElement.id = stopId;
        stopElement.innerHTML = `
            <div class="stop-header">
                <div class="stop-number">Stop ${stopNumber}</div>
                <button type="button" class="remove-stop-btn" onclick="EnhancedLocationManager.removeStop('${stopId}')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="location-input">
                <i class="fas fa-map-marker-alt"></i>
                <input type="text" class="stop-location-input" 
                       id="${stopId}_input" 
                       placeholder="Add stop location" 
                       autocomplete="off">
                <div class="stop-suggestions" id="${stopId}_suggestions"></div>
            </div>
        `;
        
        document.getElementById('stopsContainer').appendChild(stopElement);
        
        // Setup stop input
        const stopInput = document.getElementById(`${stopId}_input`);
        this.setupStopInput(stopInput, stopId);
        
        AppState.stops.push({
            id: stopId,
            location: null,
            address: '',
            index: stopNumber - 1
        });
        
        console.log(`Stop ${stopNumber} added`);
    },
    
    removeStop: function(stopId) {
        const stopElement = document.getElementById(stopId);
        if (stopElement) {
            stopElement.remove();
            
            // Remove from AppState
            AppState.stops = AppState.stops.filter(stop => stop.id !== stopId);
            
            // Update stop numbers
            this.updateStopNumbers();
            
            // Remove marker from map
            this.removeStopMarker(stopId);
            
            // Recalculate route
            if (AppState.pickup && AppState.destination) {
                this.calculateRouteWithStops();
            }
            
            console.log('Stop removed:', stopId);
        }
    },
    
    updateStopNumbers: function() {
        const stopElements = document.querySelectorAll('.stop-entry');
        stopElements.forEach((element, index) => {
            const stopNumber = element.querySelector('.stop-number');
            if (stopNumber) {
                stopNumber.textContent = `Stop ${index + 1}`;
            }
            
            // Update AppState
            const stopId = element.id;
            const stopIndex = AppState.stops.findIndex(stop => stop.id === stopId);
            if (stopIndex !== -1) {
                AppState.stops[stopIndex].index = index;
            }
        });
    },
    
    setupStopInput: function(inputElement, stopId) {
        inputElement.addEventListener('focus', () => {
            this.handleStopInputFocus(stopId, inputElement);
        });
        
        inputElement.addEventListener('input', (e) => {
            this.handleStopInputChange(stopId, e.target.value);
        });
        
        inputElement.addEventListener('blur', () => {
            setTimeout(() => {
                this.handleStopInputBlur(stopId);
            }, 200);
        });
    },
    
    handleStopInputFocus: function(stopId, inputElement) {
        const parent = inputElement.closest('.location-input');
        if (parent) {
            parent.classList.add('active');
        }
    },
    
    handleStopInputChange: function(stopId, value) {
        if (!value.trim() || value.length < 2) {
            const suggestions = document.getElementById(`${stopId}_suggestions`);
            if (suggestions) {
                suggestions.style.display = 'none';
            }
            return;
        }
        
        clearTimeout(this.searchTimeout);
        this.searchTimeout = setTimeout(async () => {
            await this.searchStopLocation(stopId, value);
        }, 300);
    },
    
    handleStopInputBlur: function(stopId) {
        const input = document.getElementById(`${stopId}_input`);
        const parent = input?.closest('.location-input');
        if (parent) {
            parent.classList.remove('active');
            
            setTimeout(() => {
                const suggestions = document.getElementById(`${stopId}_suggestions`);
                if (suggestions) {
                    suggestions.style.display = 'none';
                }
            }, 200);
        }
    },
    
    async searchStopLocation(stopId, query) {
        if (!AppState.currentCity) {
            EnhancedUIUpdater.showToast('Please wait while we detect your city', 'warning');
            return;
        }
        
        try {
            const results = await EnhancedSearchEngine.search(
                query,
                'stop',
                AppState.userLocation,
                AppState.currentCity
            );
            
            this.showStopSuggestions(stopId, results);
            
        } catch (error) {
            console.error('Stop search error:', error);
        }
    },
    
    showStopSuggestions: function(stopId, results) {
        const container = document.getElementById(`${stopId}_suggestions`);
        if (!container) return;
        
        container.innerHTML = '';
        
        if (results.length === 0) {
            container.innerHTML = `
                <div class="no-results">
                    <i class="fas fa-search"></i>
                    <div>No results found in ${AppState.currentCity}</div>
                </div>
            `;
        } else {
            results.forEach(result => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.dataset.lat = result.lat;
                item.dataset.lng = result.lng;
                item.dataset.address = result.address;
                item.dataset.name = result.name;
                
                item.innerHTML = `
                    <div class="suggestion-icon">
                        <i class="fas fa-map-marker-alt"></i>
                    </div>
                    <div class="suggestion-details">
                        <div class="suggestion-name">${result.name}</div>
                        <div class="suggestion-address">${result.address}</div>
                    </div>
                `;
                
                item.addEventListener('click', () => {
                    this.selectStopLocation(stopId, result);
                });
                
                container.appendChild(item);
            });
        }
        
        container.style.display = 'block';
    },
    
    selectStopLocation: function(stopId, location) {
        const input = document.getElementById(`${stopId}_input`);
        const suggestions = document.getElementById(`${stopId}_suggestions`);
        
        if (!input) return;
        
        // Validate location is within city
        if (!EnhancedSearchEngine.validateCoordinatesInCity(location.lat, location.lng, AppState.currentCity)) {
            EnhancedUIUpdater.showToast(`Location must be within ${AppState.currentCity}`, 'warning');
            return;
        }
        
        input.value = location.address || location.name;
        
        // Update AppState
        const stopIndex = AppState.stops.findIndex(stop => stop.id === stopId);
        if (stopIndex !== -1) {
            AppState.stops[stopIndex].location = location;
            AppState.stops[stopIndex].address = location.address;
            
            // Add marker to map
            this.addStopMarker(stopId, location);
            
            // Recalculate route if pickup and destination are set
            if (AppState.pickup && AppState.destination) {
                this.calculateRouteWithStops();
                EnhancedUIUpdater.calculateAndUpdatePrices();
            }
        }
        
        if (suggestions) {
            suggestions.style.display = 'none';
        }
        
        console.log(`Stop location selected: ${location.address}`);
    },
    
    addStopMarker: function(stopId, location) {
        // Remove existing marker for this stop
        this.removeStopMarker(stopId);
        
        const stopIndex = AppState.stops.findIndex(stop => stop.id === stopId);
        if (stopIndex === -1) return;
        
        const marker = L.marker([location.lat, location.lng], {
            icon: L.divIcon({
                className: 'stop-marker',
                html: `<div class="stop-marker-content">${stopIndex + 1}</div>`,
                iconSize: [30, 30],
                iconAnchor: [15, 30]
            })
        }).addTo(map).bindPopup(`Stop ${stopIndex + 1}: ${location.address}`);
        
        AppState.stopMarkers.push({
            id: stopId,
            marker: marker
        });
    },
    
    removeStopMarker: function(stopId) {
        const markerIndex = AppState.stopMarkers.findIndex(m => m.id === stopId);
        if (markerIndex !== -1) {
            map.removeLayer(AppState.stopMarkers[markerIndex].marker);
            AppState.stopMarkers.splice(markerIndex, 1);
        }
    },
    
    calculateRouteWithStops: async function() {
        if (!AppState.pickup || !AppState.destination) return;
        
        // Clear existing route
        if (routeLayer) {
            map.removeLayer(routeLayer);
            routeLayer = null;
        }
        
        // Get all waypoints including stops
        const waypoints = [];
        
        // Start with pickup
        waypoints.push([AppState.pickup.lat, AppState.pickup.lng]);
        
        // Add stops in order
        const sortedStops = [...AppState.stops]
            .filter(stop => stop.location)
            .sort((a, b) => a.index - b.index);
        
        sortedStops.forEach(stop => {
            if (stop.location) {
                waypoints.push([stop.location.lat, stop.location.lng]);
            }
        });
        
        // End with destination
        waypoints.push([AppState.destination.lat, AppState.destination.lng]);
        
        // Calculate route with multiple waypoints
        try {
            const routeCoordinates = await this.calculateMultiPointRoute(waypoints);
            
            if (routeCoordinates.length > 1) {
                routeLayer = L.polyline(routeCoordinates, {
                    color: '#FF6B35',
                    weight: 4,
                    opacity: 0.7,
                    lineJoin: 'round',
                    lineCap: 'round'
                }).addTo(map);
                
                // Fit map to route bounds
                const bounds = L.latLngBounds(routeCoordinates);
                map.fitBounds(bounds, { padding: [50, 50] });
                
                // Calculate total distance
                const totalDistance = this.calculateRouteDistance(routeCoordinates);
                console.log(`Route distance with stops: ${totalDistance.toFixed(2)} km`);
                
                // Update prices
                EnhancedUIUpdater.calculateAndUpdatePrices();
                
                return totalDistance;
            }
        } catch (error) {
            console.error('Error calculating route with stops:', error);
            
            // Fallback to direct route
            routeLayer = L.polyline([
                [AppState.pickup.lat, AppState.pickup.lng],
                [AppState.destination.lat, AppState.destination.lng]
            ], {
                color: '#FF6B35',
                weight: 3,
                opacity: 0.7,
                dashArray: '10, 10'
            }).addTo(map);
        }
    },
    
    calculateMultiPointRoute: async function(waypoints) {
        if (waypoints.length < 2) return [];
        
        let allCoordinates = [];
        
        // Calculate route segments between each waypoint
        for (let i = 0; i < waypoints.length - 1; i++) {
            const start = waypoints[i];
            const end = waypoints[i + 1];
            
            try {
                const response = await fetch(
                    `https://router.project-osrm.org/route/v1/driving/${start[1]},${start[0]};${end[1]},${end[0]}?overview=full&geometries=geojson`
                );
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.routes && data.routes.length > 0) {
                        const segmentCoords = data.routes[0].geometry.coordinates.map(coord => [coord[1], coord[0]]);
                        allCoordinates = allCoordinates.concat(segmentCoords);
                    }
                }
            } catch (error) {
                console.error(`Error calculating segment ${i}:`, error);
                // Add straight line for this segment
                allCoordinates.push(start, end);
            }
        }
        
        return allCoordinates;
    },
    
    calculateRouteDistance: function(routeCoordinates) {
        let totalDistance = 0;
        
        for (let i = 0; i < routeCoordinates.length - 1; i++) {
            const lat1 = routeCoordinates[i][0];
            const lon1 = routeCoordinates[i][1];
            const lat2 = routeCoordinates[i + 1][0];
            const lon2 = routeCoordinates[i + 1][1];
            
            totalDistance += EnhancedSearchEngine.calculateDistance(lat1, lon1, lat2, lon2);
        }
        
        return totalDistance;
    },
    
    clearAllStops: function() {
        // Remove all stop markers from map
        AppState.stopMarkers.forEach(stopMarker => {
            map.removeLayer(stopMarker.marker);
        });
        AppState.stopMarkers = [];
        
        // Clear stops container
        const stopsContainer = document.getElementById('stopsContainer');
        if (stopsContainer) {
            stopsContainer.innerHTML = '';
        }
        
        // Clear AppState stops
        AppState.stops = [];
        
        // Recalculate route without stops
        if (AppState.pickup && AppState.destination) {
            EnhancedUIUpdater.drawRoute(AppState.pickup, AppState.destination);
        }
    },
    
    setupPickupInput: function(inputElement) {
        const inputId = inputElement.id;
        
        if (!inputElement.parentNode.querySelector('.clear-pickup-btn')) {
            const clearBtn = document.createElement('button');
            clearBtn.type = 'button';
            clearBtn.className = 'clear-pickup-btn';
            clearBtn.innerHTML = '<i class="fas fa-times"></i>';
            clearBtn.title = 'Clear pickup location';
            clearBtn.style.cssText = `
                position: absolute;
                right: 10px;
                top: 50%;
                transform: translateY(-50%);
                background: none;
                border: none;
                color: var(--text-gray);
                font-size: 14px;
                cursor: pointer;
                display: none;
                z-index: 10;
            `;
            
            inputElement.parentNode.style.position = 'relative';
            inputElement.parentNode.appendChild(clearBtn);
            
            clearBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.clearPickupLocation(inputId);
            });
        }
        
        if (!inputElement.parentNode.querySelector('.edit-pickup-btn')) {
            const editBtn = document.createElement('button');
            editBtn.type = 'button';
            editBtn.className = 'edit-pickup-btn';
            editBtn.innerHTML = '<i class="fas fa-edit"></i>';
            editBtn.title = 'Edit pickup location';
            editBtn.style.cssText = `
                position: absolute;
                right: 40px;
                top: 50%;
                transform: translateY(-50%);
                background: none;
                border: none;
                color: var(--primary-orange);
                font-size: 14px;
                cursor: pointer;
                display: none;
                z-index: 10;
            `;
            
            inputElement.parentNode.appendChild(editBtn);
            
            editBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.enablePickupEditMode(inputId);
            });
        }
        
        inputElement.addEventListener('focus', () => {
            this.handlePickupInputFocus(inputId);
        });
        
        inputElement.addEventListener('input', (e) => {
            this.handlePickupInputChange(inputId, e.target.value);
        });
        
        inputElement.addEventListener('blur', () => {
            setTimeout(() => {
                this.handlePickupInputBlur(inputId);
            }, 200);
        });
        
        inputElement.addEventListener('input', () => {
            this.updatePickupInputButtons(inputId);
        });
    },
    
    setupDestinationInput: function(inputElement) {
        const inputId = inputElement.id;
        
        if (!document.getElementById(`${inputId}Suggestions`)) {
            const suggestionsContainer = document.createElement('div');
            suggestionsContainer.id = `${inputId}Suggestions`;
            suggestionsContainer.className = 'suggestion-list';
            suggestionsContainer.style.cssText = `
                position: absolute;
                background: white;
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                max-height: 300px;
                overflow-y: auto;
                z-index: 1000;
                display: none;
                margin-top: 5px;
                width: 100%;
            `;
            inputElement.parentNode.appendChild(suggestionsContainer);
        }
        
        inputElement.addEventListener('focus', () => {
            this.handleDestinationInputFocus(inputId);
        });
        
        inputElement.addEventListener('input', (e) => {
            this.handleDestinationInputChange(inputId, e.target.value);
        });
        
        inputElement.addEventListener('blur', () => {
            setTimeout(() => {
                this.handleDestinationInputBlur(inputId);
            }, 200);
        });
    },
    
    handlePickupInputFocus: function(inputId) {
        const input = document.getElementById(inputId);
        const parent = input.closest('.location-input');
        
        if (parent) {
            parent.classList.add('active');
            
            if (!input.value.trim() && inputId.includes('pickup')) {
                EnhancedUIUpdater.showSearchHistory(inputId);
            }
            
            this.updatePickupInputButtons(inputId);
        }
    },
    
    handlePickupInputChange: function(inputId, value) {
        if (!value.trim() || value.length < 2) {
            const suggestions = document.getElementById(`${inputId}Suggestions`);
            if (suggestions) {
                suggestions.classList.remove('active');
            }
            return;
        }
        
        clearTimeout(this.searchTimeout);
        this.searchTimeout = setTimeout(async () => {
            await this.searchPickupLocations(inputId, value);
        }, 300);
    },
    
    handlePickupInputBlur: function(inputId) {
        const input = document.getElementById(inputId);
        const parent = input.closest('.location-input');
        
        if (parent) {
            parent.classList.remove('active');
        }
    },
    
    handleDestinationInputFocus: function(inputId) {
        const input = document.getElementById(inputId);
        const parent = input.closest('.location-input');
        
        if (parent) {
            parent.classList.add('active');
            
            if (!input.value.trim()) {
                EnhancedUIUpdater.showSearchHistory(inputId);
            }
        }
    },
    
    handleDestinationInputChange: function(inputId, value) {
        if (!value.trim() || value.length < 2) {
            const suggestions = document.getElementById(`${inputId}Suggestions`);
            if (suggestions) {
                suggestions.style.display = 'none';
            }
            return;
        }
        
        clearTimeout(this.searchTimeout);
        this.searchTimeout = setTimeout(async () => {
            await this.searchDestinationLocations(inputId, value);
        }, 300);
    },
    
    handleDestinationInputBlur: function(inputId) {
        const input = document.getElementById(inputId);
        const parent = input.closest('.location-input');
        
        if (parent) {
            parent.classList.remove('active');
            
            setTimeout(() => {
                const suggestions = document.getElementById(`${inputId}Suggestions`);
                if (suggestions) {
                    suggestions.style.display = 'none';
                }
            }, 200);
        }
    },
    
    async searchPickupLocations(inputId, query) {
        if (!AppState.currentCity) {
            EnhancedUIUpdater.showToast('Please wait while we detect your city', 'warning');
            return;
        }
        
        const input = document.getElementById(inputId);
        const parent = input.closest('.location-input');
        
        if (parent) {
            parent.classList.add('searching');
        }
        
        try {
            const results = await EnhancedSearchEngine.search(
                query,
                'pickup',
                AppState.userLocation,
                AppState.currentCity
            );
            
            EnhancedUIUpdater.showSearchSuggestions(inputId, results, 'pickup');
            
            AppState.locationManagement.pickupSearchResults = results;
            
        } catch (error) {
            console.error('Pickup search error:', error);
        } finally {
            if (parent) {
                parent.classList.remove('searching');
            }
        }
    },
    
    async searchDestinationLocations(inputId, query) {
        if (!AppState.currentCity) {
            EnhancedUIUpdater.showToast('Please wait while we detect your city', 'warning');
            return;
        }
        
        const input = document.getElementById(inputId);
        const parent = input.closest('.location-input');
        
        if (parent) {
            parent.classList.add('searching');
        }
        
        try {
            const results = await EnhancedSearchEngine.search(
                query,
                'destination',
                AppState.userLocation,
                AppState.currentCity
            );
            
            EnhancedUIUpdater.showSearchSuggestions(inputId, results, 'destination');
            
        } catch (error) {
            console.error('Destination search error:', error);
        } finally {
            if (parent) {
                parent.classList.remove('searching');
            }
        }
    },
    
    clearPickupLocation: function(inputId) {
        const input = document.getElementById(inputId);
        const clearBtn = input.parentNode.querySelector('.clear-pickup-btn');
        const editBtn = input.parentNode.querySelector('.edit-pickup-btn');
        
        input.value = '';
        
        if (clearBtn) clearBtn.style.display = 'none';
        if (editBtn) editBtn.style.display = 'none';
        
        AppState.pickup = null;
        
        if (pickupMarker) {
            map.removeLayer(pickupMarker);
            pickupMarker = null;
        }
        
        if (routeLayer) {
            map.removeLayer(routeLayer);
            routeLayer = null;
        }
        
        document.getElementById('fareDisplay').classList.remove('active');
        document.getElementById('rideTypeSelection').classList.remove('active');
        
        EnhancedUIUpdater.showToast('Pickup location cleared', 'info');
        
        this.pickupEditMode = false;
        this.currentPickupInput = null;
    },
    
    enablePickupEditMode: function(inputId) {
        const input = document.getElementById(inputId);
        
        if (!input.value.trim()) {
            EnhancedUIUpdater.showToast('No pickup location to edit', 'warning');
            return;
        }
        
        this.pickupEditMode = true;
        this.currentPickupInput = inputId;
        
        input.focus();
        input.select();
        
        this.searchPickupLocations(inputId, input.value);
        
        EnhancedUIUpdater.showToast('Pickup edit mode enabled. Search for a new location.', 'info');
    },
    
    updatePickupInputButtons: function(inputId) {
        const input = document.getElementById(inputId);
        const clearBtn = input.parentNode.querySelector('.clear-pickup-btn');
        const editBtn = input.parentNode.querySelector('.edit-pickup-btn');
        
        if (input.value.trim()) {
            if (clearBtn) clearBtn.style.display = 'block';
            if (editBtn) editBtn.style.display = 'block';
        } else {
            if (clearBtn) clearBtn.style.display = 'none';
            if (editBtn) editBtn.style.display = 'none';
        }
    },
    
    selectPickupLocation: function(inputId, location) {
        const input = document.getElementById(inputId);
        const clearBtn = input.parentNode.querySelector('.clear-pickup-btn');
        const editBtn = input.parentNode.querySelector('.edit-pickup-btn');
        
        if (!EnhancedSearchEngine.validateCoordinatesInCity(location.lat, location.lng, AppState.currentCity)) {
            EnhancedUIUpdater.showToast(`Location must be within ${AppState.currentCity}`, 'warning');
            return;
        }
        
        input.value = location.address || location.name;
        
        if (clearBtn) clearBtn.style.display = 'block';
        if (editBtn) editBtn.style.display = 'block';
        
        AppState.pickup = location;
        
        EnhancedUIUpdater.updatePickupMarker(location);
        
        if (AppState.destination) {
            this.calculateRouteWithStops();
            RideTypeManager.updateRideTypeDisplay();
        }
        
        const suggestions = document.getElementById(`${inputId}Suggestions`);
        if (suggestions) {
            suggestions.style.display = 'none';
        }
        
        document.getElementById('searchHistory').style.display = 'none';
        
        if (this.pickupEditMode) {
            this.pickupEditMode = false;
            this.currentPickupInput = null;
            EnhancedUIUpdater.showToast('Pickup location updated', 'success');
        }
    },
    
    selectDestinationLocation: function(inputId, location) {
        const input = document.getElementById(inputId);
        
        if (!EnhancedSearchEngine.validateCoordinatesInCity(location.lat, location.lng, AppState.currentCity)) {
            EnhancedUIUpdater.showToast(`Location must be within ${AppState.currentCity}`, 'warning');
            return;
        }
        
        input.value = location.address || location.name;
        
        AppState.destination = location;
        
        EnhancedUIUpdater.updateDestinationMarker(location);
        
        if (AppState.pickup) {
            this.calculateRouteWithStops();
            RideTypeManager.updateRideTypeDisplay();
        }
        
        const suggestions = document.getElementById(`${inputId}Suggestions`);
        if (suggestions) {
            suggestions.style.display = 'none';
        }
        
        document.getElementById('searchHistory').style.display = 'none';
    },
    
    resetPickupEditMode: function() {
        this.pickupEditMode = false;
        this.currentPickupInput = null;
    },
    
    isPickupEditModeActive: function() {
        return this.pickupEditMode;
    },
    
    getCurrentPickupInput: function() {
        return this.currentPickupInput;
    }
};

// ============================================
// ENHANCED PRICE CALCULATOR
// ============================================
const EnhancedPriceCalculator = {
    calculateRideFare: function(distanceKm, rideType = 'standard', surge = 1.0, timeOfDay = null) {
        const config = AppState.rideTypes[rideType] || AppState.rideTypes.standard;
        
        let fare = config.base + (distanceKm * config.perKm);
        
        fare *= config.multiplier;
        fare *= surge;
        
        if (!timeOfDay) {
            timeOfDay = new Date().getHours();
        }
        
        if (timeOfDay >= 22 || timeOfDay <= 5) {
            fare *= 1.2;
        } else if (timeOfDay >= 7 && timeOfDay <= 9) {
            fare *= 1.3;
        } else if (timeOfDay >= 16 && timeOfDay <= 19) {
            fare *= 1.4;
        }
        
        fare = Math.max(fare, config.min);
        
        return Math.round(fare * 100) / 100;
    },
    
    calculateEmergencyFare: function(distanceKm, serviceType, surge = 1.0) {
        const config = AppState.emergencyServices[serviceType] || AppState.emergencyServices.police;
        
        let fare = config.base + (distanceKm * config.perKm);
        fare *= config.multiplier;
        fare *= surge;
        fare = Math.max(fare, config.min);
        
        return Math.round(fare * 100) / 100;
    },
    
    calculateDeliveryFare: function(distanceKm, deliveryType = 'standard', parcelValue = 0) {
        const config = AppState.deliveryTypes[deliveryType] || AppState.deliveryTypes.standard;
        
        let fare = config.base + (distanceKm * config.perKm);
        fare *= config.multiplier;
        
        if (parcelValue > 500) {
            fare += parcelValue * 0.01;
        }
        
        return Math.round(fare * 100) / 100;
    },
    
    calculateTruckFare: function(distanceKm, truckType = 'light', helpers = false) {
        const config = AppState.truckTypes[truckType] || AppState.truckTypes.light;
        
        let fare = config.base + (distanceKm * config.perKm);
        fare *= config.multiplier;
        
        if (helpers) {
            fare += 50;
        }
        
        return Math.round(fare * 100) / 100;
    },
    
    calculateShoppingFare: function(distanceKm, itemsCount = 1, budget = 0) {
        let fare = 30 + (distanceKm * 2.5) + (itemsCount * 5);
        
        if (budget > 0) {
            fare += budget * 0.05;
        }
        
        return Math.round(fare * 100) / 100;
    },
    
    calculateDistance: function(lat1, lon1, lat2, lon2) {
        return EnhancedSearchEngine.calculateDistance(lat1, lon1, lat2, lon2);
    },
    
    calculateDistanceWithStops: function(pickup, stops, destination) {
        let totalDistance = 0;
        
        // Add distance from pickup to first stop
        if (stops.length > 0) {
            totalDistance += this.calculateDistance(
                pickup.lat, pickup.lng,
                stops[0].location.lat, stops[0].location.lng
            );
        } else {
            totalDistance += this.calculateDistance(
                pickup.lat, pickup.lng,
                destination.lat, destination.lng
            );
        }
        
        // Add distances between stops
        for (let i = 0; i < stops.length - 1; i++) {
            totalDistance += this.calculateDistance(
                stops[i].location.lat, stops[i].location.lng,
                stops[i + 1].location.lat, stops[i + 1].location.lng
            );
        }
        
        // Add distance from last stop to destination
        if (stops.length > 0) {
            totalDistance += this.calculateDistance(
                stops[stops.length - 1].location.lat, stops[stops.length - 1].location.lng,
                destination.lat, destination.lng
            );
        }
        
        return totalDistance;
    },
    
    estimateTime: function(distanceKm, rideType = 'standard', traffic = null) {
        let baseSpeed;
        switch(rideType) {
            case 'bicycle':
                baseSpeed = 15;
                break;
            case 'premium':
                baseSpeed = 45;
                break;
            default:
                baseSpeed = 35;
        }
        
        let baseTime = (distanceKm / baseSpeed) * 60;
        
        if (!traffic) {
            traffic = this.getTrafficFactor();
        }
        
        baseTime *= traffic;
        
        if (rideType === 'premium') {
            baseTime += 2;
        } else if (rideType === 'bicycle') {
            baseTime += 10; // Extra time for bicycle
        } else {
            baseTime += 5;
        }
        
        return Math.ceil(baseTime);
    },
    
    getTrafficFactor: function() {
        const hour = new Date().getHours();
        const day = new Date().getDay();
        
        if (day >= 1 && day <= 5) {
            if ((hour >= 7 && hour <= 9) || (hour >= 16 && hour <= 19)) {
                return 1.5;
            }
        }
        
        if (day === 6 || day === 0) {
            if (hour >= 12 && hour <= 16) {
                return 1.3;
            }
        }
        
        return 1.0;
    },
    
    getSurgeMultiplier: function() {
        const hour = new Date().getHours();
        const day = new Date().getDay();
        
        if (day >= 1 && day <= 5) {
            if (hour >= 7 && hour <= 9) return 1.5;
            if (hour >= 16 && hour <= 19) return 1.8;
        }
        
        if (day === 5 || day === 6) {
            if (hour >= 20 && hour <= 23) return 2.0;
        }
        
        if (hour >= 22 || hour <= 5) return 1.8;
        
        return 1.0;
    },
    
    getFareBreakdown: function(distanceKm, rideType = 'standard', surge = 1.0) {
        const config = AppState.rideTypes[rideType] || AppState.rideTypes.standard;
        const baseFare = config.base;
        const distanceFare = distanceKm * config.perKm;
        const rideTypeMultiplier = config.multiplier;
        const surgeMultiplier = surge;
        const timeMultiplier = this.getTimeMultiplier();
        
        const subtotal = (baseFare + distanceFare) * rideTypeMultiplier;
        const surgeAmount = subtotal * (surgeMultiplier - 1);
        const timeAmount = subtotal * (timeMultiplier - 1);
        const total = subtotal * surgeMultiplier * timeMultiplier;
        
        return {
            baseFare: baseFare,
            distanceFare: distanceFare,
            rideTypeMultiplier: rideTypeMultiplier,
            surgeMultiplier: surgeMultiplier,
            timeMultiplier: timeMultiplier,
            surgeAmount: surgeAmount,
            timeAmount: timeAmount,
            subtotal: subtotal,
            total: Math.max(total, config.min)
        };
    },
    
    getTimeMultiplier: function() {
        const hour = new Date().getHours();
        if (hour >= 22 || hour <= 5) return 1.2;
        return 1.0;
    },
    
    calculateBroadcastFare: function(distanceKm, rideType = 'standard', splitType = 'equal', passengerCount = 2) {
        const totalFare = this.calculateRideFare(distanceKm, rideType);
        let yourShare = totalFare;
        let passengerShare = 0;
        
        switch(splitType) {
            case 'equal':
                yourShare = totalFare / passengerCount;
                passengerShare = totalFare / passengerCount;
                break;
            case 'you_pay_more':
                yourShare = totalFare * 0.7;
                passengerShare = totalFare * 0.3;
                break;
            case 'you_pay_all':
                yourShare = totalFare;
                passengerShare = 0;
                break;
        }
        
        return {
            total: totalFare,
            yourShare: yourShare,
            passengerShare: passengerShare,
            splitType: splitType
        };
    },
    
    validateDistanceWithinCity: function(startLat, startLng, endLat, endLng, city) {
        const distance = this.calculateDistance(startLat, startLng, endLat, endLng);
        
        const maxCityDistance = {
            'Lusaka': 50,
            'Ndola': 30,
            'Kitwe': 25,
            'Livingstone': 20,
            'Kabwe': 20,
            'Chipata': 15,
            'default': 25
        };
        
        const maxDistance = maxCityDistance[city] || maxCityDistance.default;
        
        if (distance > maxDistance) {
            return {
                valid: false,
                distance: distance,
                maxAllowed: maxDistance,
                message: `Distance exceeds maximum allowed for ${city} (${maxDistance}km)`
            };
        }
        
        return {
            valid: true,
            distance: distance
        };
    },
    
    applyReferralDiscount: function(originalFare) {
        const discountAmount = originalFare * 0.5;
        const finalFare = originalFare - discountAmount;
        
        return {
            originalFare: originalFare,
            discountAmount: discountAmount,
            finalFare: Math.max(finalFare, 5),
            discountApplied: true
        };
    }
};

// ============================================
// ENHANCED UI UPDATER
// ============================================
const EnhancedUIUpdater = {
    updateWalletBalance: function(balance) {
        const formatted = `ZMW ${balance.toFixed(2)}`;
        document.getElementById('walletBalance').textContent = formatted;
        document.getElementById('accountBalance').textContent = formatted;
        document.getElementById('paymentBalance').textContent = formatted;
        document.getElementById('transferBalance').textContent = formatted;
        AppState.walletBalance = balance;
    },
    
    updateUserInfo: function(userData) {
        if (userData.name) {
            document.getElementById('userFullName').textContent = userData.name;
            document.getElementById('accountName').textContent = userData.name;
        }
        
        if (userData.phone) {
            document.getElementById('accountPhone').textContent = userData.phone;
        }
        
        if (userData.email) {
            document.getElementById('updateEmail').value = userData.email;
        }
        
        if (userData.referralCode) {
            document.getElementById('referralCode').textContent = userData.referralCode;
        }
    },
    
    showToast: function(message, type = 'info', duration = 5000) {
        const toastContainer = document.getElementById('toastContainer');
        const toastId = 'toast-' + Date.now();
        
        const icons = {
            success: 'fa-check-circle',
            error: 'fa-exclamation-circle',
            warning: 'fa-exclamation-triangle',
            info: 'fa-info-circle'
        };
        
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.id = toastId;
        toast.innerHTML = `
            <div class="toast-icon">
                <i class="fas ${icons[type] || icons.info}"></i>
            </div>
            <div class="toast-content">
                <div class="toast-title">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
                <div class="toast-message">${message}</div>
            </div>
            <button class="toast-close" onclick="EnhancedUIUpdater.removeToast('${toastId}')">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        toastContainer.appendChild(toast);
        
        setTimeout(() => {
            this.removeToast(toastId);
        }, duration);
        
        return toastId;
    },
    
    removeToast: function(toastId) {
        const toast = document.getElementById(toastId);
        if (toast) {
            toast.classList.add('hiding');
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300);
        }
    },
    
    showLoading: function(message = 'Loading...') {
        const overlay = document.getElementById('loadingOverlay');
        const text = document.getElementById('loadingText');
        text.textContent = message;
        overlay.classList.add('active');
    },
    
    hideLoading: function() {
        const overlay = document.getElementById('loadingOverlay');
        overlay.classList.remove('active');
    },
    
    showMapLoading: function() {
        document.getElementById('mapLoadingOverlay').style.display = 'flex';
    },
    
    hideMapLoading: function() {
        document.getElementById('mapLoadingOverlay').style.display = 'none';
    },
    
    updateCityDisplay: function(city) {
        const display = document.getElementById('currentCityDisplay');
        if (city) {
            display.textContent = `City: ${city}`;
            display.parentElement.style.display = 'flex';
            
            document.querySelectorAll('.current-city-label').forEach(element => {
                element.textContent = city;
            });
            
            setTimeout(() => {
                display.parentElement.style.display = 'none';
            }, 5000);
        }
    },
    
    updateRidePrices: function(distanceKm) {
        const types = ['bicycle', 'economy', 'standard', 'premium'];
        const surge = EnhancedPriceCalculator.getSurgeMultiplier();
        
        types.forEach(type => {
            const price = EnhancedPriceCalculator.calculateRideFare(distanceKm, type, surge);
            const element = document.getElementById(`${type}Price`);
            if (element) {
                element.textContent = `ZMW ${price.toFixed(2)}`;
            }
        });
        
        const selectedPrice = EnhancedPriceCalculator.calculateRideFare(distanceKm, AppState.selectedRideType, surge);
        document.getElementById('estimatedFare').textContent = `ZMW ${selectedPrice.toFixed(2)}`;
        
        const time = EnhancedPriceCalculator.estimateTime(distanceKm, AppState.selectedRideType);
        document.getElementById('distanceDetail').textContent = `${distanceKm.toFixed(1)} km`;
        document.getElementById('timeDetail').textContent = `ETA: ${time} min`;
        
        AppState.rideFare = selectedPrice;
        
        this.updatePriceCalculator(distanceKm, AppState.selectedRideType, surge);
    },
    
    updatePriceCalculator: function(distanceKm, rideType = 'standard', surge = 1.0) {
        const breakdown = EnhancedPriceCalculator.getFareBreakdown(distanceKm, rideType, surge);
        const calculator = document.getElementById('priceCalculator');
        const fareElement = document.getElementById('calculatedFare');
        const breakdownElement = document.getElementById('priceBreakdown');
        
        calculator.style.display = 'block';
        fareElement.textContent = `ZMW ${breakdown.total.toFixed(2)}`;
        
        let breakdownHTML = `
            <div class="price-breakdown-row">
                <span>Base Fare:</span>
                <span>ZMW ${breakdown.baseFare.toFixed(2)}</span>
            </div>
            <div class="price-breakdown-row">
                <span>Distance (${distanceKm.toFixed(1)}km):</span>
                <span>ZMW ${breakdown.distanceFare.toFixed(2)}</span>
            </div>
        `;
        
        if (breakdown.rideTypeMultiplier !== 1) {
            breakdownHTML += `
                <div class="price-breakdown-row">
                    <span>${rideType.charAt(0).toUpperCase() + rideType.slice(1)} Multiplier:</span>
                    <span>${breakdown.rideTypeMultiplier.toFixed(1)}x</span>
                </div>
            `;
        }
        
        if (breakdown.surgeMultiplier !== 1) {
            breakdownHTML += `
                <div class="price-breakdown-row">
                    <span>Surge Pricing:</span>
                    <span>+ZMW ${breakdown.surgeAmount.toFixed(2)}</span>
                </div>
            `;
        }
        
        if (breakdown.timeMultiplier !== 1) {
            breakdownHTML += `
                <div class="price-breakdown-row">
                    <span>Time of Day:</span>
                    <span>+ZMW ${breakdown.timeAmount.toFixed(2)}</span>
                </div>
            `;
        }
        
        // Add stops cost if any
        if (AppState.stops.length > 0) {
            const stopsCost = AppState.stops.length * 5;
            breakdownHTML += `
                <div class="price-breakdown-row">
                    <span>Stops (${AppState.stops.length}):</span>
                    <span>+ZMW ${stopsCost.toFixed(2)}</span>
                </div>
            `;
        }
        
        breakdownHTML += `
            <div class="price-breakdown-row total">
                <span>Total:</span>
                <span>ZMW ${breakdown.total.toFixed(2)}</span>
            </div>
        `;
        
        breakdownElement.innerHTML = breakdownHTML;
        
        calculator.classList.add('price-update-animation');
        setTimeout(() => {
            calculator.classList.remove('price-update-animation');
        }, 500);
    },
    
    updateDeliveryPrices: function(distanceKm, deliveryType = 'standard', parcelValue = 0) {
        const fare = EnhancedPriceCalculator.calculateDeliveryFare(distanceKm, deliveryType, parcelValue);
        const time = EnhancedPriceCalculator.estimateTime(distanceKm, 'standard');
        
        const display = document.getElementById('deliveryFareDisplay');
        const fareElement = document.getElementById('deliveryFare');
        const distanceElement = document.getElementById('deliveryDistance');
        const timeElement = document.getElementById('deliveryTime');
        
        display.style.display = 'block';
        fareElement.textContent = `ZMW ${fare.toFixed(2)}`;
        distanceElement.textContent = `${distanceKm.toFixed(1)} km`;
        timeElement.textContent = `ETA: ${time} min`;
        
        return { fare, time };
    },
    
    updateTruckPrices: function(distanceKm, truckType = 'light', helpers = false) {
        const fare = EnhancedPriceCalculator.calculateTruckFare(distanceKm, truckType, helpers);
        const time = EnhancedPriceCalculator.estimateTime(distanceKm, 'standard');
        
        const display = document.getElementById('truckFareDisplay');
        const fareElement = document.getElementById('truckFare');
        const distanceElement = document.getElementById('truckDistance');
        const timeElement = document.getElementById('truckTime');
        
        display.style.display = 'block';
        fareElement.textContent = `ZMW ${fare.toFixed(2)}`;
        distanceElement.textContent = `${distanceKm.toFixed(1)} km`;
        timeElement.textContent = `ETA: ${time} min`;
        
        return { fare, time };
    },
    
    updateShoppingPrices: function(distanceKm, itemsCount = 1, budget = 0) {
        const fare = EnhancedPriceCalculator.calculateShoppingFare(distanceKm, itemsCount, budget);
        const time = EnhancedPriceCalculator.estimateTime(distanceKm, 'standard') + 30;
        
        const display = document.getElementById('shoppingFareDisplay');
        const fareElement = document.getElementById('shoppingFare');
        const distanceElement = document.getElementById('shoppingDistance');
        const timeElement = document.getElementById('shoppingTime');
        
        display.style.display = 'block';
        fareElement.textContent = `ZMW ${fare.toFixed(2)}`;
        distanceElement.textContent = `${distanceKm.toFixed(1)} km`;
        timeElement.textContent = `ETA: ${time} min`;
        
        return { fare, time };
    },
    
    updateShortDeliveryPrices: function(distanceKm) {
        const fare = Math.max(15, distanceKm * 2.5);
        const time = EnhancedPriceCalculator.estimateTime(distanceKm, 'standard');
        
        const display = document.getElementById('shortDeliveryFareDisplay');
        const fareElement = document.getElementById('shortDeliveryFare');
        const distanceElement = document.getElementById('shortDeliveryDistance');
        const timeElement = document.getElementById('shortDeliveryTime');
        
        display.style.display = 'block';
        fareElement.textContent = `ZMW ${fare.toFixed(2)}`;
        distanceElement.textContent = `${distanceKm.toFixed(1)} km`;
        timeElement.textContent = `ETA: ${time} min`;
        
        return { fare, time };
    },
    
    updateBroadcastPrices: function(distanceKm, rideType = 'standard', splitType = 'equal', passengerCount = 2) {
        const calculation = EnhancedPriceCalculator.calculateBroadcastFare(distanceKm, rideType, splitType, passengerCount);
        
        const display = document.getElementById('broadcastFareDisplay');
        const fareElement = document.getElementById('broadcastFare');
        const distanceElement = document.getElementById('broadcastDistance');
        const timeElement = document.getElementById('broadcastTime');
        
        if (display) {
            display.style.display = 'block';
            fareElement.textContent = `ZMW ${calculation.total.toFixed(2)}`;
            distanceElement.textContent = `${distanceKm.toFixed(1)} km`;
            timeElement.textContent = `ETA: ${EnhancedPriceCalculator.estimateTime(distanceKm, rideType)} min`;
        }
        
        return calculation;
    },
    
    showRideInfo: function(ride) {
        document.querySelectorAll('.ride-request-form, .service-form, #broadcastForm').forEach(form => {
            form.style.display = 'none';
        });
        
        document.getElementById('rideInfoPanel').classList.add('active');
        
        document.getElementById('currentPickup').textContent = ride.pickupDisplay || ride.pickup;
        document.getElementById('currentDestination').textContent = ride.destinationDisplay || ride.destination;
        document.getElementById('rideDistance').textContent = ride.distance ? `${ride.distance.toFixed(1)} km` : '0 km';
        document.getElementById('rideTime').textContent = ride.estimatedTime ? `${ride.estimatedTime} min` : '0 min';
        
        const distance = ride.distance || 0;
        let baseFare, distanceFare, total;
        
        if (ride.serviceType === 'truck') {
            const config = AppState.truckTypes[ride.truckType] || AppState.truckTypes.light;
            baseFare = config.base;
            distanceFare = distance * config.perKm;
            total = ride.fare || baseFare + distanceFare;
        } else if (ride.serviceType === 'delivery') {
            const config = AppState.deliveryTypes[ride.deliveryType] || AppState.deliveryTypes.standard;
            baseFare = config.base;
            distanceFare = distance * config.perKm;
            total = ride.fare || baseFare + distanceFare;
        } else if (ride.serviceType === 'shopping') {
            baseFare = 30;
            distanceFare = distance * 2.5;
            total = ride.fare || baseFare + distanceFare + (ride.itemsCount || 1) * 5;
        } else {
            const config = AppState.rideTypes[ride.rideType] || AppState.rideTypes.standard;
            baseFare = config.base;
            distanceFare = distance * config.perKm;
            total = ride.fare || baseFare + distanceFare;
        }
        
        document.getElementById('baseFareValue').textContent = `ZMW ${baseFare.toFixed(2)}`;
        document.getElementById('distanceFareValue').textContent = `ZMW ${distanceFare.toFixed(2)}`;
        
        if (ride.serviceType) {
            document.getElementById('rideTypeValue').textContent = 
                ride.serviceType.charAt(0).toUpperCase() + ride.serviceType.slice(1);
        } else {
            document.getElementById('rideTypeValue').textContent = 
                ride.rideType?.charAt(0).toUpperCase() + ride.rideType?.slice(1) || 'Standard';
        }
        
        document.getElementById('totalFareValue').textContent = `ZMW ${total.toFixed(2)}`;
        
        this.updateRideStatus(ride.status);
        
        this.updateTimeline(ride.status);
        
        if (ride.status === 'accepted' && AppState.sosConfig) {
            document.getElementById('sosButton').style.display = 'flex';
        }
        
        if (ride.emergency && AppState.sosConfig) {
            document.getElementById('emergencyContactDisplay').style.display = 'block';
        }
        
        if (ride.broadcast) {
            document.getElementById('broadcastFeature').style.display = 'block';
        }
        
        // Show stops if any
        if (ride.stops && ride.stops.length > 0) {
            this.showRideStops(ride.stops);
        }
    },
    
    updateRideStatus: function(status) {
        const statusBar = document.getElementById('rideStatusBar');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const etaText = document.getElementById('etaText');
        
        statusBar.classList.add('active');
        
        switch(status) {
            case 'requested':
                statusDot.className = 'status-dot searching';
                statusText.textContent = 'Searching for driver';
                etaText.textContent = '5-10 min';
                
                this.showPulsingRideIcon();
                break;
            case 'accepted':
                statusDot.className = 'status-dot arriving';
                statusText.textContent = 'Driver on the way';
                etaText.textContent = '5 min';
                break;
            case 'arrived':
                statusDot.className = 'status-dot riding';
                statusText.textContent = 'Driver arrived';
                etaText.textContent = '0 min';
                break;
            case 'started':
                statusDot.className = 'status-dot riding';
                statusText.textContent = 'Trip in progress';
                etaText.textContent = 'En route';
                break;
            case 'completed':
                statusBar.classList.remove('active');
                break;
            case 'cancelled':
                statusBar.classList.remove('active');
                break;
        }
    },
    
    showPulsingRideIcon: function() {
        this.removePulsingRideIcon();
        
        let iconClass = 'fa-car';
        let iconType = 'car';
        
        if (AppState.selectedRideType === 'bicycle') {
            iconClass = 'fa-bicycle';
            iconType = 'bicycle';
        } else if (AppState.activeService === 'truck' || AppState.currentRide?.serviceType === 'truck') {
            iconClass = 'fa-truck';
            iconType = 'truck';
        } else if (AppState.activeService === 'delivery' || AppState.activeService === 'short-delivery' || 
                  AppState.currentRide?.serviceType === 'delivery') {
            iconClass = 'fa-shipping-fast';
            iconType = 'delivery';
        } else if (AppState.activeService === 'express' || AppState.currentRide?.serviceType === 'shopping') {
            iconClass = 'fa-shopping-bag';
            iconType = 'shopping';
        }
        
        const pulsingIcon = document.createElement('div');
        pulsingIcon.id = 'pulsingRideIcon';
        pulsingIcon.className = 'pulsing-ride-icon';
        pulsingIcon.innerHTML = `<i class="fas ${iconClass}"></i>`;
        pulsingIcon.style.cssText = `
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 60px;
            color: var(--primary-orange);
            z-index: 1000;
            animation: pulse 1.5s infinite;
            pointer-events: none;
        `;
        
        const mapContainer = document.getElementById('map');
        if (mapContainer) {
            mapContainer.appendChild(pulsingIcon);
            AppState.rideRequestPulsingIcons[iconType] = pulsingIcon;
        }
    },
    
    removePulsingRideIcon: function() {
        const pulsingIcon = document.getElementById('pulsingRideIcon');
        if (pulsingIcon) {
            pulsingIcon.remove();
        }
    },
    
    updateTimeline: function(status) {
        const steps = ['stepRequested', 'stepAccepted', 'stepArrived', 'stepStarted', 'stepCompleted'];
        const stepLabels = ['Requested', 'Accepted', 'Arrived', 'Started', 'Completed'];
        let currentIndex = stepLabels.indexOf(status);
        
        if (currentIndex === -1) {
            currentIndex = 0;
        }
        
        steps.forEach((stepId, index) => {
            const step = document.getElementById(stepId);
            const label = step.parentNode.querySelector('.step-label');
            
            if (index < currentIndex) {
                step.className = 'step-dot completed';
                label.className = 'step-label';
            } else if (index === currentIndex) {
                step.className = 'step-dot active';
                label.className = 'step-label active';
            } else {
                step.className = 'step-dot';
                label.className = 'step-label';
            }
        });
    },
    
    showSearchSuggestions: function(inputId, results, type = 'destination') {
        const container = document.getElementById(`${inputId}Suggestions`);
        if (!container) {
            console.error(`Suggestions container not found for ${inputId}`);
            return;
        }
        
        container.innerHTML = '';
        
        if (results.length === 0) {
            container.innerHTML = `
                <div class="no-results">
                    <i class="fas fa-search"></i>
                    <div>No results found in ${AppState.currentCity}</div>
                    <div style="font-size: 11px; color: var(--text-light); margin-top: 5px;">
                        Try a different search term
                    </div>
                </div>
            `;
        } else {
            results.forEach(result => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.dataset.lat = result.lat;
                item.dataset.lng = result.lng;
                item.dataset.address = result.address;
                item.dataset.name = result.name;
                
                let icon = 'fa-map-marker-alt';
                let iconColor = 'var(--primary-orange)';
                
                if (result.category === 'restaurant') {
                    icon = 'fa-utensils';
                    iconColor = 'var(--warning-yellow)';
                } else if (result.category === 'hotel') {
                    icon = 'fa-hotel';
                    iconColor = 'var(--info-blue)';
                } else if (result.category === 'shopping') {
                    icon = 'fa-shopping-cart';
                    iconColor = 'var(--delivery-purple)';
                } else if (result.category === 'medical') {
                    icon = 'fa-hospital';
                    iconColor = 'var(--error-red)';
                } else if (result.category === 'education') {
                    icon = 'fa-graduation-cap';
                    iconColor = 'var(--success-green)';
                } else if (result.isVerified) {
                    icon = 'fa-check-circle';
                    iconColor = 'var(--success-green)';
                }
                
                item.innerHTML = `
                    <div class="suggestion-icon" style="color: ${iconColor}">
                        <i class="fas ${icon}"></i>
                    </div>
                    <div class="suggestion-details">
                        <div class="suggestion-name">${result.name}</div>
                        <div class="suggestion-address">${result.address}</div>
                        ${result.distance ? `<div class="suggestion-distance">${result.distance.toFixed(1)} km away</div>` : ''}
                        ${result.isVerified ? `<div class="suggestion-verified"><i class="fas fa-check-circle"></i> Verified</div>` : ''}
                    </div>
                `;
                
                item.addEventListener('click', () => {
                    if (type === 'pickup') {
                        EnhancedLocationManager.selectPickupLocation(inputId, result);
                    } else {
                        EnhancedLocationManager.selectDestinationLocation(inputId, result);
                    }
                });
                
                container.appendChild(item);
            });
            
            const cityNote = document.createElement('div');
            cityNote.className = 'city-search-note';
            cityNote.innerHTML = `
                <i class="fas fa-city"></i>
                <span>Searching within ${AppState.currentCity}</span>
            `;
            container.appendChild(cityNote);
        }
        
        container.style.display = 'block';
        
        const input = document.getElementById(inputId);
        if (input) {
            const rect = input.getBoundingClientRect();
            container.style.top = `${rect.bottom + window.scrollY}px`;
            container.style.left = `${rect.left + window.scrollX}px`;
            container.style.width = `${rect.width}px`;
        }
    },
    
    showSearchHistory: function(inputId) {
        const container = document.getElementById('searchHistory');
        const history = EnhancedSearchEngine.getSearchHistory(
            inputId.includes('destination') ? 'destination' : 'pickup',
            AppState.currentCity
        );
        
        if (history.length === 0) {
            container.style.display = 'none';
            return;
        }
        
        let html = `
            <div class="search-history-header">
                <div><i class="fas fa-history"></i> Recent in ${AppState.currentCity}</div>
                <button class="clear-history-btn" onclick="EnhancedSearchEngine.clearSearchHistory()">
                    Clear
                </button>
            </div>
        `;
        
        history.forEach(item => {
            html += `
                <div class="search-history-item" data-lat="${item.location.lat}" data-lng="${item.location.lng}">
                    <div class="search-history-icon">
                        <i class="fas fa-${item.type === 'destination' ? 'flag' : 'map-marker-alt'}"></i>
                    </div>
                    <div class="search-history-text">
                        <div>${item.location.name}</div>
                        <div style="font-size: 11px; color: var(--text-light);">${item.location.address}</div>
                    </div>
                    <div class="search-history-time">
                        ${this.formatTimeAgo(item.timestamp)}
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        container.style.display = 'block';
        
        const input = document.getElementById(inputId);
        if (input) {
            const rect = input.getBoundingClientRect();
            container.style.top = `${rect.bottom + window.scrollY}px`;
            container.style.left = `${rect.left + window.scrollX}px`;
            container.style.width = `${rect.width}px`;
        }
        
        container.querySelectorAll('.search-history-item').forEach(item => {
            item.addEventListener('click', () => {
                const lat = parseFloat(item.dataset.lat);
                const lng = parseFloat(item.dataset.lng);
                const location = {
                    lat: lat,
                    lng: lng,
                    name: item.querySelector('.search-history-text div').textContent,
                    address: item.querySelector('.search-history-text div:nth-child(2)').textContent
                };
                
                if (inputId.includes('pickup')) {
                    EnhancedLocationManager.selectPickupLocation(inputId, location);
                } else {
                    EnhancedLocationManager.selectDestinationLocation(inputId, location);
                }
                container.style.display = 'none';
            });
        });
    },
    
    formatTimeAgo: function(timestamp) {
        const now = Date.now();
        const diff = now - timestamp;
        
        if (diff < 60000) return 'Just now';
        if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
        if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
        return `${Math.floor(diff / 86400000)}d ago`;
    },
    
    updatePickupMarker: function(location) {
        if (!map) {
            console.error('Map not initialized');
            return;
        }
        
        if (pickupMarker) {
            pickupMarker.setLatLng([location.lat, location.lng]);
        } else {
            pickupMarker = L.marker([location.lat, location.lng], {
                icon: L.divIcon({
                    className: 'pickup-marker',
                    html: '<i class="fas fa-map-marker-alt"></i>',
                    iconSize: [20, 20],
                    iconAnchor: [10, 20]
                })
            }).addTo(map).bindPopup('Pickup Location');
        }
        
        map.setView([location.lat, location.lng], 15);
        
        if (AppState.destination) {
            EnhancedLocationManager.calculateRouteWithStops();
        }
    },
    
    updateDestinationMarker: function(location) {
        if (!map) {
            console.error('Map not initialized');
            return;
        }
        
        if (destinationMarker) {
            destinationMarker.setLatLng([location.lat, location.lng]);
        } else {
            destinationMarker = L.marker([location.lat, location.lng], {
                icon: L.divIcon({
                    className: 'destination-marker',
                    html: '<i class="fas fa-flag"></i>',
                    iconSize: [20, 20],
                    iconAnchor: [10, 20]
                })
            }).addTo(map).bindPopup('Destination');
        }
        
        if (AppState.pickup) {
            EnhancedLocationManager.calculateRouteWithStops();
        }
    },
    
    drawRoute: async function(start, end) {
        if (!map) {
            console.error('Map not initialized');
            return;
        }
        
        if (routeLayer) {
            map.removeLayer(routeLayer);
        }
        
        const startValid = EnhancedSearchEngine.validateCoordinatesInCity(
            start.lat, start.lng, AppState.currentCity
        );
        const endValid = EnhancedSearchEngine.validateCoordinatesInCity(
            end.lat, end.lng, AppState.currentCity
        );
        
        if (!startValid || !endValid) {
            console.warn('Route points outside city bounds');
            return;
        }
        
        try {
            const response = await fetch(
                `https://router.project-osrm.org/route/v1/driving/${start.lng},${start.lat};${end.lng},${end.lat}?overview=full&geometries=geojson`
            );
            
            if (response.ok) {
                const data = await response.json();
                
                if (data.routes && data.routes.length > 0) {
                    const route = data.routes[0];
                    const routeCoordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                    
                    routeLayer = L.polyline(routeCoordinates, {
                        color: '#FF6B35',
                        weight: 4,
                        opacity: 0.7,
                        lineJoin: 'round',
                        lineCap: 'round'
                    }).addTo(map);
                    
                    const bounds = L.latLngBounds(routeCoordinates);
                    map.fitBounds(bounds, { padding: [50, 50] });
                    
                    const distance = route.distance / 1000;
                    const duration = route.duration / 60;
                    
                    console.log(`Route distance: ${distance.toFixed(2)} km, Duration: ${duration.toFixed(0)} min`);
                    
                    if (AppState.pickup && AppState.destination) {
                        EnhancedUIUpdater.calculateAndUpdatePrices();
                    }
                    
                    return { distance, duration };
                }
            }
        } catch (error) {
            console.error('Routing service error:', error);
            
            routeLayer = L.polyline([
                [start.lat, start.lng],
                [end.lat, end.lng]
            ], {
                color: '#FF6B35',
                weight: 3,
                opacity: 0.7,
                dashArray: '10, 10'
            }).addTo(map);
            
            const bounds = L.latLngBounds(
                [start.lat, start.lng],
                [end.lat, end.lng]
            );
            map.fitBounds(bounds, { padding: [50, 50] });
        }
    },
    
    calculateAndUpdatePrices: function() {
        if (AppState.pickup && AppState.destination) {
            // Calculate distance with stops if any
            let distance;
            if (AppState.stops.length > 0) {
                const validStops = AppState.stops.filter(stop => stop.location);
                distance = EnhancedPriceCalculator.calculateDistanceWithStops(
                    AppState.pickup,
                    validStops,
                    AppState.destination
                );
            } else {
                distance = EnhancedPriceCalculator.calculateDistance(
                    AppState.pickup.lat, AppState.pickup.lng,
                    AppState.destination.lat, AppState.destination.lng
                );
            }
            
            const validation = EnhancedPriceCalculator.validateDistanceWithinCity(
                AppState.pickup.lat, AppState.pickup.lng,
                AppState.destination.lat, AppState.destination.lng,
                AppState.currentCity
            );
            
            if (!validation.valid) {
                EnhancedUIUpdater.showToast(validation.message, 'warning');
                return;
            }
            
            switch(AppState.activeService) {
                case 'car':
                    this.updateRidePrices(distance);
                    document.getElementById('fareDisplay').classList.add('active');
                    document.getElementById('rideTypeSelection').classList.add('active');
                    break;
                case 'delivery':
                    this.updateDeliveryPrices(distance);
                    break;
                case 'short-delivery':
                    this.updateShortDeliveryPrices(distance);
                    break;
                case 'truck':
                    this.updateTruckPrices(distance);
                    break;
                case 'express':
                    this.updateShoppingPrices(distance);
                    break;
            }
        }
    },
    
    showDriverInfo: function(driver) {
        const avatar = document.getElementById('driverAvatar');
        const name = document.getElementById('driverName');
        const rating = document.getElementById('driverRating');
        const vehicle = document.getElementById('vehicleDetails');
        
        if (driver.photoUrl) {
            avatar.innerHTML = `<img src="${driver.photoUrl}" alt="${driver.name}">`;
        } else {
            avatar.innerHTML = `<i class="fas fa-user"></i>`;
        }
        
        name.textContent = driver.name || 'Driver';
        rating.textContent = driver.rating?.toFixed(1) || '4.8';
        vehicle.textContent = `${driver.vehicle?.model || 'Car'} - ${driver.vehicle?.plate || 'ABC 123'}`;
        
        this.loadDriverImages(driver);
        
        if (driver.location) {
            this.updateDriverMarker(driver.location);
        }
    },
    
    loadDriverImages: function(driver) {
        if (driver.photoUrl) {
            const driverImg = document.getElementById('driverImage');
            const driverPlaceholder = document.getElementById('driverImagePlaceholder');
            
            driverImg.src = driver.photoUrl;
            driverImg.onload = function() {
                driverImg.style.display = 'block';
                driverPlaceholder.style.display = 'none';
            };
            driverImg.onerror = function() {
                driverImg.style.display = 'none';
                driverPlaceholder.style.display = 'flex';
            };
        }
        
        if (driver.vehicle?.photoUrl) {
            const vehicleImg = document.getElementById('vehicleImage');
            const vehiclePlaceholder = document.getElementById('vehicleImagePlaceholder');
            
            vehicleImg.src = driver.vehicle.photoUrl;
            vehicleImg.onload = function() {
                vehicleImg.style.display = 'block';
                vehiclePlaceholder.style.display = 'none';
            };
            vehicleImg.onerror = function() {
                vehicleImg.style.display = 'none';
                vehiclePlaceholder.style.display = 'flex';
            };
        }
    },
    
    updateDriverMarker: function(location) {
        if (!map) return;
        
        if (driverMarker) {
            driverMarker.setLatLng([location.lat, location.lng]);
        } else {
            driverMarker = L.marker([location.lat, location.lng], {
                icon: L.divIcon({
                    className: 'driver-marker',
                    html: '<i class="fas fa-car"></i>',
                    iconSize: [32, 32],
                    iconAnchor: [16, 32]
                })
            }).addTo(map).bindPopup('Your Driver');
        }
    },
    
    updateDriverTracking: function(driverLocation, pickupLocation) {
        if (!driverLocation || !pickupLocation) return;
        
        const distance = EnhancedPriceCalculator.calculateDistance(
            driverLocation.lat, driverLocation.lng,
            pickupLocation.lat, pickupLocation.lng
        );
        
        const progress = document.getElementById('trackingProgress');
        const distanceElement = document.getElementById('driverDistance');
        const pickupDistanceElement = document.getElementById('pickupDistance');
        const etaElement = document.getElementById('etaToPickup');
        
        distanceElement.textContent = `${distance.toFixed(1)} km`;
        pickupDistanceElement.textContent = `${distance.toFixed(1)} km to pickup`;
        
        const eta = Math.ceil((distance / 40) * 60);
        etaElement.textContent = `ETA: ${eta} min`;
        
        const maxDistance = 10;
        const progressPercent = Math.max(0, 100 - (distance / maxDistance) * 100);
        progress.style.width = `${Math.min(progressPercent, 100)}%`;
    },
    
    showChatMessage: function(message, isSender = false) {
        const container = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        
        messageDiv.className = `message ${isSender ? 'sent' : 'received'}`;
        messageDiv.innerHTML = `
            <div>${message.text}</div>
            <div class="message-time">${new Date(message.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
        `;
        
        container.appendChild(messageDiv);
        container.scrollTop = container.scrollHeight;
        
        if (!isSender && !document.getElementById('chatContainer').classList.contains('active')) {
            this.showChatNotification();
        }
    },
    
    showChatNotification: function() {
        const chatBtn = document.getElementById('openChatBtn');
        if (chatBtn) {
            let badge = chatBtn.querySelector('.chat-notification');
            if (!badge) {
                badge = document.createElement('div');
                badge.className = 'chat-notification';
                chatBtn.appendChild(badge);
            }
            badge.textContent = '1';
        }
    },
    
    updateTypingIndicator: function(isTyping) {
        const indicator = document.getElementById('typingIndicator');
        if (isTyping) {
            indicator.classList.add('active');
        } else {
            indicator.classList.remove('active');
        }
    },
    
    updateHistoryList: function(rides) {
        const container = document.getElementById('historyList');
        container.innerHTML = '';
        
        if (rides.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-history"></i>
                    </div>
                    <div class="empty-title">No rides found</div>
                    <div class="empty-message">${AppState.activeFilter === 'all' ? 'You haven\'t taken any rides yet' : 'No rides match your filter'}</div>
                </div>
            `;
            return;
        }
        
        rides.forEach(ride => {
            const item = this.createHistoryItem(ride);
            container.appendChild(item);
        });
    },
    
    createHistoryItem: function(ride) {
        const item = document.createElement('div');
        item.className = 'history-item';
        item.dataset.rideId = ride.id;
        
        const date = new Date(ride.timestamp);
        let typeIcon, typeColor, typeName;
        
        if (ride.emergency) {
            typeIcon = 'fa-ambulance';
            typeColor = 'var(--error-red)';
            typeName = 'Emergency Ride';
        } else if (ride.scheduled) {
            typeIcon = 'fa-calendar-alt';
            typeColor = 'var(--info-blue)';
            typeName = 'Scheduled Ride';
        } else if (ride.broadcast) {
            typeIcon = 'fa-broadcast-tower';
            typeColor = 'var(--warning-yellow)';
            typeName = 'Broadcast Ride';
        } else if (ride.serviceType === 'delivery') {
            typeIcon = 'fa-shipping-fast';
            typeColor = 'var(--delivery-purple)';
            typeName = 'Delivery';
        } else if (ride.serviceType === 'truck') {
            typeIcon = 'fa-truck';
            typeColor = 'var(--light-truck-brown)';
            typeName = 'Truck Delivery';
        } else if (ride.serviceType === 'shopping') {
            typeIcon = 'fa-shopping-bag';
            typeColor = 'var(--express-shop-green)';
            typeName = 'Express Shopping';
        } else if (ride.rideType === 'bicycle') {
            typeIcon = 'fa-bicycle';
            typeColor = '#4CAF50';
            typeName = 'Bicycle Ride';
        } else {
            typeIcon = 'fa-car';
            typeColor = 'var(--primary-orange)';
            typeName = 'Standard Ride';
        }
        
        const statusClass = ride.status === 'completed' ? 'status-completed' :
                         ride.status === 'cancelled' ? 'status-cancelled' :
                         'status-ongoing';
        
        item.innerHTML = `
            <div class="history-header">
                <div class="history-type">
                    <div class="history-icon" style="background: ${typeColor}">
                        <i class="fas ${typeIcon}"></i>
                    </div>
                    <div class="history-type-name">
                        ${typeName}
                    </div>
                </div>
                <div class="history-date">
                    ${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                </div>
            </div>
            
            <div class="history-locations">
                <div class="history-location">
                    <i class="fas fa-map-marker-alt"></i>
                    <div class="history-location-text">${ride.pickupDisplay || ride.pickup || 'Not specified'}</div>
                </div>
                <div class="history-location">
                    <i class="fas fa-flag"></i>
                    <div class="history-location-text">${ride.destinationDisplay || ride.destination || 'Not specified'}</div>
                </div>
            </div>
            
            <div class="history-footer">
                <div class="history-price">ZMW ${ride.fare?.toFixed(2) || '0.00'}</div>
                <div class="history-status ${statusClass}">
                    ${ride.status?.charAt(0).toUpperCase() + ride.status?.slice(1) || 'Unknown'}
                </div>
            </div>
            
            <div class="history-details">
                <div class="detail-section">
                    <div class="detail-title">
                        <i class="fas fa-info-circle"></i>
                        Ride Details
                    </div>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Distance</div>
                            <div class="detail-value">${ride.distance?.toFixed(1) || '0'} km</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Ride Type</div>
                            <div class="detail-value">${ride.rideType?.charAt(0).toUpperCase() + ride.rideType?.slice(1) || ride.serviceType?.charAt(0).toUpperCase() + ride.serviceType?.slice(1) || 'Standard'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Payment</div>
                            <div class="detail-value">${ride.paymentMethod?.charAt(0).toUpperCase() + ride.paymentMethod?.slice(1) || 'Wallet'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Driver</div>
                            <div class="detail-value">${ride.driverName || 'Not assigned'}</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        item.addEventListener('click', (e) => {
            if (!e.target.closest('.history-details')) {
                item.classList.toggle('expanded');
            }
        });
        
        return item;
    },
    
    updateShareRideCalculations: function(distanceKm, splitPercentage = 50) {
        const surge = EnhancedPriceCalculator.getSurgeMultiplier();
        const totalFare = EnhancedPriceCalculator.calculateRideFare(distanceKm, AppState.selectedRideType, surge);
        const yourShare = (totalFare * splitPercentage) / 100;
        const friendShare = totalFare - yourShare;
        
        document.getElementById('shareFareEstimate').textContent = `ZMW ${totalFare.toFixed(2)}`;
        document.getElementById('yourShare').textContent = `ZMW ${yourShare.toFixed(2)}`;
        document.getElementById('friendShare').textContent = `ZMW ${friendShare.toFixed(2)}`;
        
        return { totalFare, yourShare, friendShare };
    },
    
    updateNotifications: function(notifications) {
        const container = document.getElementById('notificationsList');
        if (!container) return;
        
        container.innerHTML = '';
        
        if (notifications.length === 0) {
            container.innerHTML = `
                <div class="empty-state" style="padding: 30px 20px;">
                    <div class="empty-icon">
                        <i class="fas fa-bell-slash"></i>
                    </div>
                    <div class="empty-title">No notifications</div>
                    <div class="empty-message">You're all caught up!</div>
                </div>
            `;
            return;
        }
        
        notifications.forEach(notification => {
            const item = document.createElement('div');
            item.className = `notification-item ${notification.read ? '' : 'unread'}`;
            item.dataset.notificationId = notification.id;
            
            const time = new Date(notification.timestamp);
            let icon = 'fa-info-circle';
            let iconColor = 'var(--info-blue)';
            
            if (notification.type === 'success') {
                icon = 'fa-check-circle';
                iconColor = 'var(--success-green)';
            } else if (notification.type === 'error') {
                icon = 'fa-exclamation-circle';
                iconColor = 'var(--error-red)';
            } else if (notification.type === 'warning') {
                icon = 'fa-exclamation-triangle';
                iconColor = 'var(--warning-yellow)';
            } else if (notification.type === 'ride') {
                icon = 'fa-car';
                iconColor = 'var(--primary-orange)';
            } else if (notification.type === 'payment') {
                icon = 'fa-money-bill-wave';
                iconColor = 'var(--success-green)';
            } else if (notification.type === 'referral') {
                icon = 'fa-gift';
                iconColor = 'var(--primary-orange)';
            } else if (notification.type === 'broadcast') {
                icon = 'fa-broadcast-tower';
                iconColor = 'var(--warning-yellow)';
            }
            
            item.innerHTML = `
                <div class="notification-header">
                    <div class="notification-title">
                        <i class="fas ${icon}" style="color: ${iconColor}"></i>
                        ${notification.title || 'Notification'}
                    </div>
                    <div class="notification-time">
                        ${time.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                    </div>
                </div>
                <div class="notification-message">
                    ${notification.message}
                </div>
                ${notification.actions ? `
                <div class="notification-actions">
                    ${notification.actions.map(action => `
                        <button class="notification-action-btn" data-action="${action.action}">
                            ${action.label}
                        </button>
                    `).join('')}
                </div>
                ` : ''}
            `;
            
            container.appendChild(item);
            
            item.addEventListener('click', () => {
                if (!notification.read) {
                    EnhancedFirebaseManager.markNotificationAsRead(notification.id);
                }
                
                if (notification.action) {
                    this.handleNotificationAction(notification.action, notification.data);
                }
            });
        });
    },
    
    handleNotificationAction: function(action, data) {
        switch(action) {
            case 'view_ride':
                if (data.rideId) {
                    EnhancedFirebaseManager.loadRideDetails(data.rideId);
                }
                break;
            case 'accept_broadcast':
                if (data.broadcastId) {
                    EnhancedFirebaseManager.acceptBroadcastInvitation(data.broadcastId);
                }
                break;
            case 'view_payment':
                break;
        }
    },
    
    updateNotificationBadge: function(count) {
        const badge = document.getElementById('notificationCount');
        if (badge) {
            badge.textContent = count;
            if (count > 0) {
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }
    },
    
    showEmergencyStations: function(stations) {
        const container = document.getElementById('emergencyStations');
        if (!container) return;
        
        container.innerHTML = '';
        
        if (stations.length === 0) {
            container.innerHTML = '<div class="no-results">No emergency stations found in your city</div>';
            return;
        }
        
        stations.forEach(station => {
            const stationElement = document.createElement('div');
            stationElement.className = 'emergency-station';
            stationElement.dataset.stationId = station.id;
            stationElement.dataset.lat = station.lat;
            stationElement.dataset.lng = station.lng;
            stationElement.dataset.distance = station.distance;
            
            stationElement.innerHTML = `
                <div class="station-header">
                    <div class="station-name">${station.name}</div>
                    <div class="station-distance">${station.distance.toFixed(1)} km</div>
                </div>
                <div class="station-address">${station.address}</div>
                <div class="station-details">
                    <span><i class="fas fa-phone"></i> Emergency</span>
                    <span><i class="fas fa-clock"></i> 24/7</span>
                </div>
            `;
            
            stationElement.addEventListener('click', () => {
                container.querySelectorAll('.emergency-station').forEach(s => {
                    s.classList.remove('selected');
                });
                
                stationElement.classList.add('selected');
                
                AppState.selectedEmergencyStation = station;
                
                this.updateEmergencyStationDetails(station);
            });
            
            container.appendChild(stationElement);
        });
        
        if (stations.length > 0) {
            const firstStation = container.querySelector('.emergency-station');
            if (firstStation) {
                firstStation.classList.add('selected');
                AppState.selectedEmergencyStation = stations[0];
                this.updateEmergencyStationDetails(stations[0]);
            }
        }
    },
    
    updateEmergencyStationDetails: function(station) {
        if (!station || !AppState.userLocation) return;
        
        const distance = EnhancedPriceCalculator.calculateDistance(
            AppState.userLocation.lat, AppState.userLocation.lng,
            station.lat, station.lng
        );
        
        const emergencyType = document.getElementById('emergencyServiceType').dataset.type;
        const fare = EnhancedPriceCalculator.calculateEmergencyFare(distance, emergencyType);
        const time = EnhancedPriceCalculator.estimateTime(distance, 'standard');
        
        document.getElementById('emergencyDistance').textContent = `${distance.toFixed(1)} km`;
        document.getElementById('emergencyTime').textContent = `${time} min`;
        document.getElementById('emergencyTotalFare').textContent = `ZMW ${fare.toFixed(2)}`;
        
        const config = AppState.emergencyServices[emergencyType];
        if (config) {
            document.getElementById('emergencyBaseFare').textContent = `ZMW ${config.base.toFixed(2)}`;
        }
        
        this.addEmergencyStationMarker(station);
    },
    
    addEmergencyStationMarker: function(station) {
        emergencyStationMarkers.forEach(marker => map.removeLayer(marker));
        emergencyStationMarkers = [];
        
        const marker = L.marker([station.lat, station.lng], {
            icon: L.divIcon({
                className: 'emergency-vehicle-marker',
                html: `<i class="fas fa-${station.type === 'police' ? 'shield-alt' : station.type === 'fire' ? 'fire-extinguisher' : 'ambulance'}"></i>`,
                iconSize: [36, 36],
                iconAnchor: [18, 36]
            })
        }).addTo(map).bindPopup(station.name);
        
        emergencyStationMarkers.push(marker);
        
        if (AppState.userLocation) {
            const bounds = L.latLngBounds(
                [AppState.userLocation.lat, AppState.userLocation.lng],
                [station.lat, station.lng]
            );
            map.fitBounds(bounds, { padding: [50, 50] });
        }
    },
    
    updateEmergencyReason: function(reason) {
        AppState.emergencyReason = reason;
        
        const otherInput = document.getElementById('emergencyReasonOther');
        if (reason === 'other') {
            otherInput.style.display = 'block';
        } else {
            otherInput.style.display = 'none';
        }
    },
    
    updateBroadcastRecipients: function(recipients) {
        const container = document.getElementById('broadcastRecipients');
        if (!container) return;
        
        container.innerHTML = '';
        
        if (recipients.length === 0) {
            container.innerHTML = '<div style="text-align: center; color: var(--text-light); padding: 10px;">No recipients added</div>';
            return;
        }
        
        recipients.forEach(recipient => {
            const recipientElement = document.createElement('div');
            recipientElement.className = 'broadcast-recipient';
            recipientElement.dataset.phone = recipient.phone;
            
            recipientElement.innerHTML = `
                <div class="recipient-info">
                    <div class="recipient-avatar">
                        ${recipient.name ? recipient.name.charAt(0).toUpperCase() : '?'}
                    </div>
                    <div>
                        <div class="recipient-name">${recipient.name || 'Unknown'}</div>
                        <div style="font-size: 11px; color: var(--text-light);">${recipient.phone}</div>
                    </div>
                </div>
                <div class="recipient-status ${recipient.status === 'joined' ? 'status-joined' : 'status-pending'}">
                    ${recipient.status === 'joined' ? 'Joined' : 'Pending'}
                </div>
            `;
            
            container.appendChild(recipientElement);
        });
    },
    
    updateBroadcastStatus: function(isActive) {
        const indicator = document.getElementById('broadcastStatusIndicator');
        if (indicator) {
            if (isActive) {
                indicator.classList.remove('inactive');
                indicator.classList.add('active');
            } else {
                indicator.classList.remove('active');
                indicator.classList.add('inactive');
            }
        }
    },
    
    showSyncIndicator: function(isSyncing) {
        const indicator = document.getElementById('syncIndicator');
        if (indicator) {
            if (isSyncing) {
                indicator.classList.add('active', 'syncing');
            } else {
                indicator.classList.remove('active', 'syncing');
            }
        }
    },
    
    showRealTimeIndicator: function() {
        const indicator = document.getElementById('realTimeIndicator');
        if (indicator) {
            indicator.classList.add('active');
            setTimeout(() => {
                indicator.classList.remove('active');
            }, 3000);
        }
    },
    
    showCityBoundaryOnMap: function(city) {
        if (!map || !city) return;
        
        if (cityBoundaryLayer) {
            map.removeLayer(cityBoundaryLayer);
        }
        
        const bounds = EnhancedSearchEngine.getCityBounds(city);
        if (bounds) {
            const [west, south, east, north] = bounds;
            
            cityBoundaryLayer = L.rectangle([
                [south, west],
                [north, east]
            ], {
                color: '#FF6B35',
                weight: 2,
                opacity: 0.3,
                fillOpacity: 0.1,
                fillColor: '#FF6B35',
                dashArray: '10, 10'
            }).addTo(map);
            
            cityBoundaryLayer.bindTooltip(`City: ${city}`, {
                permanent: false,
                direction: 'center'
            });
            
            console.log(`City boundary displayed for ${city}`);
        }
    },
    
    showScheduleCountdown: function(scheduledTime) {
        const now = Date.now();
        const timeUntilRide = scheduledTime - now;
        
        if (timeUntilRide <= 0) {
            this.requestScheduledRide();
            return;
        }
        
        let countdownContainer = document.getElementById('scheduleCountdown');
        if (!countdownContainer) {
            countdownContainer = document.createElement('div');
            countdownContainer.id = 'scheduleCountdown';
            countdownContainer.className = 'schedule-countdown';
            countdownContainer.innerHTML = `
                <div class="countdown-header">
                    <i class="fas fa-clock"></i>
                    <span>Scheduled Ride Countdown</span>
                </div>
                <div class="countdown-timer">
                    <div class="time-unit">
                        <div class="time-value" id="countdownHours">00</div>
                        <div class="time-label">Hours</div>
                    </div>
                    <div class="time-separator">:</div>
                    <div class="time-unit">
                        <div class="time-value" id="countdownMinutes">00</div>
                        <div class="time-label">Minutes</div>
                    </div>
                    <div class="time-separator">:</div>
                    <div class="time-unit">
                        <div class="time-value" id="countdownSeconds">00</div>
                        <div class="time-label">Seconds</div>
                    </div>
                </div>
                <div class="countdown-actions">
                    <button id="cancelScheduleBtn" class="btn btn-danger">
                        <i class="fas fa-times"></i> Cancel Schedule
                    </button>
                </div>
            `;
            
            document.getElementById('mainPanel').appendChild(countdownContainer);
            
            document.getElementById('cancelScheduleBtn').addEventListener('click', () => {
                this.cancelScheduledRide();
            });
        }
        
        this.updateCountdownTimer(timeUntilRide);
        
        if (AppState.activeScheduledTimer) {
            clearInterval(AppState.activeScheduledTimer);
        }
        
        AppState.activeScheduledTimer = setInterval(() => {
            const timeLeft = scheduledTime - Date.now();
            if (timeLeft <= 0) {
                clearInterval(AppState.activeScheduledTimer);
                this.requestScheduledRide();
            } else {
                this.updateCountdownTimer(timeLeft);
            }
        }, 1000);
    },
    
    updateCountdownTimer: function(timeUntilRide) {
        const hours = Math.floor(timeUntilRide / (1000 * 60 * 60));
        const minutes = Math.floor((timeUntilRide % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((timeUntilRide % (1000 * 60)) / 1000);
        
        const hoursElement = document.getElementById('countdownHours');
        const minutesElement = document.getElementById('countdownMinutes');
        const secondsElement = document.getElementById('countdownSeconds');
        
        if (hoursElement) hoursElement.textContent = hours.toString().padStart(2, '0');
        if (minutesElement) minutesElement.textContent = minutes.toString().padStart(2, '0');
        if (secondsElement) secondsElement.textContent = seconds.toString().padStart(2, '0');
    },
    
    requestScheduledRide: function() {
        EnhancedUIUpdater.showToast('Scheduled ride is now being requested', 'success');
        
        this.hideScheduleCountdown();
        
        // Get the scheduled ride data
        const scheduledRide = AppState.pendingPaymentRide;
        if (scheduledRide) {
            // Remove scheduled property and request the ride
            delete scheduledRide.scheduled;
            delete scheduledRide.scheduledTime;
            
            // Show payment modal
            showPaymentModal('car', scheduledRide.fare, scheduledRide);
        }
    },
    
    cancelScheduledRide: function() {
        if (confirm('Are you sure you want to cancel this scheduled ride?')) {
            if (AppState.activeScheduledTimer) {
                clearInterval(AppState.activeScheduledTimer);
                AppState.activeScheduledTimer = null;
            }
            
            this.hideScheduleCountdown();
            
            // Remove from Firebase if it exists
            if (AppState.pendingPaymentRide?.scheduledRideId) {
                EnhancedFirebaseManager.cancelScheduledRide(AppState.pendingPaymentRide.scheduledRideId);
            }
            
            EnhancedUIUpdater.showToast('Scheduled ride cancelled', 'success');
        }
    },
    
    hideScheduleCountdown: function() {
        const countdownContainer = document.getElementById('scheduleCountdown');
        if (countdownContainer) {
            countdownContainer.remove();
        }
    },
    
    addShareFriend: function(friendCode) {
        if (AppState.shareRideFriends.length >= AppState.maxShareFriends) {
            EnhancedUIUpdater.showToast(`Maximum ${AppState.maxShareFriends} friends allowed`, 'warning');
            return false;
        }
        
        if (AppState.shareRideFriends.some(friend => friend.code === friendCode)) {
            EnhancedUIUpdater.showToast('Friend already added', 'warning');
            return false;
        }
        
        EnhancedFirebaseManager.findUserByReferralCode(friendCode)
            .then(friendData => {
                if (friendData) {
                    const friend = {
                        code: friendCode,
                        name: friendData.name,
                        phone: friendData.phone,
                        avatar: friendData.avatar,
                        status: 'pending',
                        userId: friendData.id
                    };
                    
                    AppState.shareRideFriends.push(friend);
                    this.updateShareFriendsList();
                    EnhancedUIUpdater.showToast(`${friend.name} added to ride`, 'success');
                } else {
                    EnhancedUIUpdater.showToast('Friend not found. Please check the referral code.', 'error');
                }
            })
            .catch(error => {
                console.error('Error fetching friend:', error);
                EnhancedUIUpdater.showToast('Error adding friend', 'error');
            });
        
        return true;
    },
    
    removeShareFriend: function(friendCode) {
        AppState.shareRideFriends = AppState.shareRideFriends.filter(friend => friend.code !== friendCode);
        this.updateShareFriendsList();
    },
    
    updateShareFriendsList: function() {
        const container = document.getElementById('shareFriendsList');
        if (!container) return;
        
        container.innerHTML = '';
        
        if (AppState.shareRideFriends.length === 0) {
            container.innerHTML = '<div class="empty-share">No friends added yet</div>';
            return;
        }
        
        AppState.shareRideFriends.forEach(friend => {
            const friendElement = document.createElement('div');
            friendElement.className = 'share-friend-item';
            friendElement.innerHTML = `
                <div class="friend-avatar">
                    ${friend.avatar ? `<img src="${friend.avatar}" alt="${friend.name}">` : `<i class="fas fa-user"></i>`}
                </div>
                <div class="friend-info">
                    <div class="friend-name">${friend.name}</div>
                    <div class="friend-phone">${friend.phone}</div>
                </div>
                <div class="friend-status ${friend.status}">
                    ${friend.status === 'accepted' ? 'Accepted' : friend.status === 'rejected' ? 'Rejected' : 'Pending'}
                </div>
                <button class="remove-friend-btn" onclick="EnhancedUIUpdater.removeShareFriend('${friend.code}')">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.appendChild(friendElement);
        });
        
        // Update price calculations
        if (AppState.pickup && AppState.destination) {
            const distance = EnhancedPriceCalculator.calculateDistance(
                AppState.pickup.lat, AppState.pickup.lng,
                AppState.destination.lat, AppState.destination.lng
            );
            
            const totalPeople = AppState.shareRideFriends.length + 1;
            const calculation = EnhancedPriceCalculator.calculateBroadcastFare(
                distance, 
                AppState.selectedRideType, 
                'equal', 
                totalPeople
            );
            
            document.getElementById('shareFareEstimate').textContent = `ZMW ${calculation.total.toFixed(2)}`;
            document.getElementById('yourShare').textContent = `ZMW ${calculation.yourShare.toFixed(2)}`;
            document.getElementById('friendShare').textContent = `ZMW ${calculation.passengerShare.toFixed(2)}`;
        }
    },
    
    showReferralDiscountSection: function() {
        const referralSection = document.getElementById('referralDiscountSection');
        if (referralSection) {
            referralSection.style.display = 'block';
        }
    },
    
    hideReferralDiscountSection: function() {
        const referralSection = document.getElementById('referralDiscountSection');
        if (referralSection) {
            referralSection.style.display = 'none';
        }
    },
    
    updateReferralDiscount: function(referralCode, discountAmount, finalFare, referrerName) {
        document.getElementById('referralCodeInput').value = referralCode;
        document.getElementById('discountAmount').textContent = `-ZMW ${discountAmount.toFixed(2)}`;
        document.getElementById('finalFareAmount').textContent = `ZMW ${finalFare.toFixed(2)}`;
        
        // Show referrer name if available
        if (referrerName) {
            const referrerInfo = document.getElementById('referrerInfo');
            if (referrerInfo) {
                referrerInfo.textContent = `Using ${referrerName}'s referral`;
                referrerInfo.style.display = 'block';
            }
        }
        
        const applyBtn = document.getElementById('applyReferralBtn');
        if (applyBtn) {
            applyBtn.disabled = true;
            applyBtn.innerHTML = '<i class="fas fa-check"></i> Applied';
        }
    },
    
    showShareRideInvitation: function(invitationData) {
        const invitationModal = document.createElement('div');
        invitationModal.className = 'modal-overlay active';
        invitationModal.innerHTML = `
            <div class="modal-content" style="max-width: 400px;">
                <div class="modal-header">
                    <h3>Ride Invitation</h3>
                    <button class="modal-close" onclick="this.parentElement.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 48px; color: var(--primary-orange); margin-bottom: 10px;">
                            <i class="fas fa-car"></i>
                        </div>
                        <h4>${invitationData.hostName} invited you to share a ride</h4>
                    </div>
                    
                    <div style="background: var(--card-bg); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: var(--text-gray);">From:</span>
                            <span>${invitationData.pickup}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: var(--text-gray);">To:</span>
                            <span>${invitationData.destination}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: var(--text-gray);">Distance:</span>
                            <span>${invitationData.distance.toFixed(1)} km</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--text-gray);">Your Share:</span>
                            <span style="font-weight: bold; color: var(--primary-orange);">ZMW ${invitationData.yourShare.toFixed(2)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 8px;">
                            <span style="color: var(--text-gray);">Ride Type:</span>
                            <span>${invitationData.rideType?.charAt(0).toUpperCase() + invitationData.rideType?.slice(1)}</span>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="btn btn-danger" style="flex: 1;" onclick="EnhancedFirebaseManager.rejectShareRideInvitation('${invitationData.invitationId}')">
                            <i class="fas fa-times"></i> Reject
                        </button>
                        <button class="btn btn-success" style="flex: 1;" onclick="EnhancedFirebaseManager.acceptShareRideInvitation('${invitationData.invitationId}')">
                            <i class="fas fa-check"></i> Accept
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(invitationModal);
    },
    
    showBroadcastInvitation: function(invitationData) {
        const invitationModal = document.createElement('div');
        invitationModal.className = 'modal-overlay active';
        invitationModal.innerHTML = `
            <div class="modal-content" style="max-width: 400px;">
                <div class="modal-header">
                    <h3>Broadcast Ride Invitation</h3>
                    <button class="modal-close" onclick="this.parentElement.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 48px; color: var(--warning-yellow); margin-bottom: 10px;">
                            <i class="fas fa-broadcast-tower"></i>
                        </div>
                        <h4>${invitationData.hostName} is going to ${invitationData.destination}</h4>
                    </div>
                    
                    <div style="background: var(--card-bg); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: var(--text-gray);">From:</span>
                            <span>${invitationData.pickup}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: var(--text-gray);">To:</span>
                            <span>${invitationData.destination}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: var(--text-gray);">Distance:</span>
                            <span>${invitationData.distance.toFixed(1)} km</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--text-gray);">ETA:</span>
                            <span>${invitationData.eta} min</span>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="btn btn-primary" style="flex: 1;" onclick="EnhancedFirebaseManager.joinBroadcastRide('${invitationData.broadcastId}')">
                            <i class="fas fa-eye"></i> View Ride
                        </button>
                        <button class="btn btn-success" style="flex: 1;" onclick="EnhancedFirebaseManager.acceptBroadcastInvitation('${invitationData.broadcastId}')">
                            <i class="fas fa-check"></i> Join Ride
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(invitationModal);
    },
    
    showRideStops: function(stops) {
        const stopsContainer = document.getElementById('rideStopsContainer');
        if (!stopsContainer) return;
        
        stopsContainer.innerHTML = '';
        
        if (stops.length === 0) {
            stopsContainer.style.display = 'none';
            return;
        }
        
        stopsContainer.style.display = 'block';
        
        stops.forEach((stop, index) => {
            const stopElement = document.createElement('div');
            stopElement.className = 'ride-stop-item';
            stopElement.innerHTML = `
                <div class="stop-number">${index + 1}</div>
                <div class="stop-details">
                    <div class="stop-name">${stop.name || 'Stop'}</div>
                    <div class="stop-address">${stop.address}</div>
                </div>
            `;
            stopsContainer.appendChild(stopElement);
        });
    },
    
    showPaymentRequiredModal: function(amount, rideData, friendName = null) {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay active';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 400px;">
                <div class="modal-header">
                    <h3>${friendName ? `Payment for ${friendName}'s Ride` : 'Payment Required'}</h3>
                    <button class="modal-close" onclick="this.parentElement.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 48px; color: var(--primary-orange); margin-bottom: 10px;">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <h4>Amount to Pay: ZMW ${amount.toFixed(2)}</h4>
                        ${friendName ? `<p style="color: var(--text-gray);">For your share of ${friendName}'s ride</p>` : ''}
                    </div>
                    
                    <div class="payment-options">
                        <div class="payment-method wallet selected" data-payment="wallet">
                            <i class="fas fa-wallet"></i>
                            <span>Wallet (ZMW ${AppState.walletBalance.toFixed(2)})</span>
                        </div>
                        <div class="payment-method cash" data-payment="cash">
                            <i class="fas fa-money-bill"></i>
                            <span>Cash</span>
                        </div>
                    </div>
                    
                    <button id="confirmFriendPaymentBtn" class="btn btn-primary" style="width: 100%; margin-top: 20px;">
                        <i class="fas fa-check"></i> Confirm Payment
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Setup payment method selection
        modal.querySelectorAll('.payment-method').forEach(method => {
            method.addEventListener('click', () => {
                modal.querySelectorAll('.payment-method').forEach(m => {
                    m.classList.remove('selected');
                });
                method.classList.add('selected');
            });
        });
        
        // Setup payment confirmation
        modal.querySelector('#confirmFriendPaymentBtn').addEventListener('click', () => {
            const selectedMethod = modal.querySelector('.payment-method.selected');
            if (!selectedMethod) {
                EnhancedUIUpdater.showToast('Please select a payment method', 'warning');
                return;
            }
            
            const paymentMethod = selectedMethod.dataset.payment;
            
            if (paymentMethod === 'wallet' && AppState.walletBalance < amount) {
                EnhancedUIUpdater.showToast('Insufficient wallet balance', 'error');
                return;
            }
            
            EnhancedFirebaseManager.processFriendPayment(rideData, amount, paymentMethod)
                .then(() => {
                    modal.remove();
                    EnhancedUIUpdater.showToast('Payment processed successfully', 'success');
                })
                .catch(error => {
                    EnhancedUIUpdater.showToast('Error processing payment', 'error');
                });
        });
    }
};

// ============================================
// RIDE TYPE MANAGER
// ============================================
const RideTypeManager = {
    init: function() {
        this.setupRideTypeCards();
        this.updateRideTypeDisplay();
    },
    
    setupRideTypeCards: function() {
        const container = document.createElement('div');
        container.id = 'rideTypeCardsContainer';
        container.className = 'ride-type-cards';
        container.style.cssText = `
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
            gap: 10px;
            padding: 0 15px;
            overflow-x: auto;
            scrollbar-width: none;
        `;
        
        const rideTypes = [
            { id: 'bicycle', name: 'Bicycle', icon: 'fa-bicycle', color: '#4CAF50' },
            { id: 'economy', name: 'Economy', icon: 'fa-car-side', color: '#2196F3' },
            { id: 'standard', name: 'Standard', icon: 'fa-car', color: '#FF9800' },
            { id: 'premium', name: 'Premium', icon: 'fa-crown', color: '#9C27B0' }
        ];
        
        rideTypes.forEach(rideType => {
            const card = document.createElement('div');
            card.className = 'ride-type-card';
            card.dataset.type = rideType.id;
            card.style.cssText = `
                min-width: 100px;
                padding: 15px;
                background: white;
                border-radius: 10px;
                text-align: center;
                cursor: pointer;
                border: 2px solid #e0e0e0;
                transition: all 0.3s ease;
                min-height: 80px;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                flex-shrink: 0;
            `;
            
            card.innerHTML = `
                <div class="ride-type-icon" style="font-size: 20px; color: ${rideType.color}; margin-bottom: 5px;">
                    <i class="fas ${rideType.icon}"></i>
                </div>
                <div class="ride-type-name" style="font-weight: 600; color: #333; margin-bottom: 5px; font-size: 12px;">
                    ${rideType.name}
                </div>
                <div class="ride-type-price" id="${rideType.id}Price" style="font-size: 12px; color: #666; font-weight: bold;">
                    ZMW 0.00
                </div>
            `;
            
            if (rideType.id === AppState.selectedRideType) {
                card.style.borderColor = rideType.color;
                card.style.boxShadow = `0 2px 8px rgba(${parseInt(rideType.color.slice(1, 3), 16)}, ${parseInt(rideType.color.slice(3, 5), 16)}, ${parseInt(rideType.color.slice(5, 7), 16)}, 0.2)`;
            }
            
            card.addEventListener('click', () => {
                document.querySelectorAll('.ride-type-card').forEach(c => {
                    c.style.borderColor = '#e0e0e0';
                    c.style.boxShadow = 'none';
                });
                
                card.style.borderColor = rideType.color;
                card.style.boxShadow = `0 2px 8px rgba(${parseInt(rideType.color.slice(1, 3), 16)}, ${parseInt(rideType.color.slice(3, 5), 16)}, ${parseInt(rideType.color.slice(5, 7), 16)}, 0.2)`;
                
                AppState.selectedRideType = rideType.id;
                
                if (AppState.pickup && AppState.destination) {
                    EnhancedUIUpdater.calculateAndUpdatePrices();
                }
            });
            
            container.appendChild(card);
        });
        
        const carForm = document.getElementById('carForm');
        if (carForm) {
            const destinationInput = carForm.querySelector('#destinationLocation');
            if (destinationInput) {
                destinationInput.parentNode.parentNode.insertBefore(container, destinationInput.parentNode.nextSibling);
            } else {
                carForm.appendChild(container);
            }
        }
        
        // Also add to schedule and share modals
        const modals = ['scheduleModal', 'shareRideModal', 'orderForSomeoneModal'];
        modals.forEach(modalId => {
            const modal = document.getElementById(modalId);
            if (modal) {
                const modalContainer = container.cloneNode(true);
                modalContainer.id = `${modalId}RideTypeCards`;
                const destinationInput = modal.querySelector('input[type="text"]');
                if (destinationInput) {
                    destinationInput.parentNode.parentNode.insertBefore(modalContainer, destinationInput.parentNode.nextSibling);
                }
            }
        });
    },
    
    updateRideTypeDisplay: function() {
        if (AppState.pickup && AppState.destination) {
            // Calculate distance with stops if any
            let distance;
            if (AppState.stops.length > 0) {
                const validStops = AppState.stops.filter(stop => stop.location);
                distance = EnhancedPriceCalculator.calculateDistanceWithStops(
                    AppState.pickup,
                    validStops,
                    AppState.destination
                );
            } else {
                distance = EnhancedPriceCalculator.calculateDistance(
                    AppState.pickup.lat, AppState.pickup.lng,
                    AppState.destination.lat, AppState.destination.lng
                );
            }
            
            const surge = EnhancedPriceCalculator.getSurgeMultiplier();
            const rideTypes = ['bicycle', 'economy', 'standard', 'premium'];
            
            rideTypes.forEach(type => {
                const price = EnhancedPriceCalculator.calculateRideFare(distance, type, surge);
                const element = document.getElementById(`${type}Price`);
                if (element) {
                    element.textContent = `ZMW ${price.toFixed(2)}`;
                }
            });
        }
    }
};

// ============================================
// ENHANCED FIREBASE MANAGER
// ============================================
const EnhancedFirebaseManager = {
    async loadUserData(uid) {
        try {
            console.log(`Loading user data for UID: ${uid}`);
            EnhancedUIUpdater.showLoading('Loading your profile...');
            
            const snapshot = await database.ref(`users/${uid}`).once('value');
            AppState.userData = snapshot.val();
            
            if (AppState.userData) {
                console.log('User data loaded successfully:', AppState.userData);
                
                AppState.walletBalance = AppState.userData.walletBalance || 0;
                EnhancedUIUpdater.updateWalletBalance(AppState.walletBalance);
                EnhancedUIUpdater.updateUserInfo(AppState.userData);
                
                await this.loadSOSConfig(uid);
                
                await this.loadScheduledRides(uid);
                
                await this.checkActiveRide(uid);
                
                await this.loadRideHistory(uid);
                
                await this.loadNotifications(uid);
                
                await this.loadWalletTransactions(uid);
                
                EnhancedSearchEngine.loadSearchHistory();
                
                this.startRealtimeSync(uid);
                
                EnhancedUIUpdater.hideLoading();
                return true;
            } else {
                console.warn('No user data found');
                EnhancedUIUpdater.hideLoading();
                return false;
            }
        } catch (error) {
            console.error('Error loading user data:', error);
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Error loading user data', 'error');
            return false;
        }
    },
    
    startRealtimeSync: function(uid) {
        this.stopRealtimeSync();
        
        console.log('Starting real-time sync for user:', uid);
        
        const userRef = database.ref(`users/${uid}`);
        AppState.realtimeListeners.push(
            userRef.on('value', (snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    console.log('User data updated in real-time');
                    AppState.userData = userData;
                    AppState.walletBalance = userData.walletBalance || 0;
                    EnhancedUIUpdater.updateWalletBalance(AppState.walletBalance);
                    EnhancedUIUpdater.updateUserInfo(userData);
                }
            })
        );
        
        const activeRideRef = database.ref('rides')
            .orderByChild('passengerId')
            .equalTo(uid)
            .orderByChild('status')
            .startAt('requested')
            .endAt('started');
        
        AppState.realtimeListeners.push(
            activeRideRef.on('value', (snapshot) => {
                const rides = snapshot.val();
                if (rides) {
                    const rideId = Object.keys(rides)[0];
                    const ride = { id: rideId, ...rides[rideId] };
                    
                    if (!AppState.currentRide || AppState.currentRide.id !== rideId) {
                        console.log('New active ride detected:', rideId);
                        AppState.currentRide = ride;
                        EnhancedUIUpdater.showRideInfo(ride);
                        
                        if (ride.driverId) {
                            this.listenToDriverLocation(ride.driverId);
                            this.loadDriverInfo(ride.driverId);
                        }
                        
                        this.listenToChatMessages(rideId);
                    } else {
                        AppState.currentRide = ride;
                        EnhancedUIUpdater.updateRideStatus(ride.status);
                        EnhancedUIUpdater.updateTimeline(ride.status);
                        
                        if (ride.status === 'accepted' && AppState.sosConfig) {
                            document.getElementById('sosButton').style.display = 'flex';
                        }
                        
                        if (ride.status === 'completed') {
                            this.handleRideCompletion(ride);
                        }
                    }
                } else if (AppState.currentRide) {
                    console.log('Active ride ended');
                    this.resetActiveRide();
                }
            })
        );
        
        const notificationsRef = database.ref(`notifications/${uid}`)
            .orderByChild('timestamp')
            .limitToLast(20);
        
        AppState.realtimeListeners.push(
            notificationsRef.on('value', (snapshot) => {
                const notifications = snapshot.val();
                if (notifications) {
                    console.log('New notifications received');
                    AppState.notifications = Object.values(notifications).reverse();
                    const unreadCount = AppState.notifications.filter(n => !n.read).length;
                    AppState.unreadNotifications = unreadCount;
                    EnhancedUIUpdater.updateNotificationBadge(unreadCount);
                    EnhancedUIUpdater.updateNotifications(AppState.notifications);
                }
            })
        );
        
        const scheduledRidesRef = database.ref('scheduledRides')
            .orderByChild('passengerId')
            .equalTo(uid)
            .orderByChild('status')
            .equalTo('scheduled');
        
        AppState.realtimeListeners.push(
            scheduledRidesRef.on('value', (snapshot) => {
                const scheduledRides = snapshot.val();
                if (scheduledRides) {
                    const ridesArray = Object.values(scheduledRides);
                    AppState.scheduledRides = ridesArray;
                    
                    const now = Date.now();
                    ridesArray.forEach(ride => {
                        if (ride.scheduledTime && ride.scheduledTime > now) {
                            const timeUntilRide = ride.scheduledTime - now;
                            if (timeUntilRide <= 3600000) {
                                EnhancedUIUpdater.showScheduleCountdown(ride.scheduledTime);
                                AppState.pendingPaymentRide = ride;
                            }
                        }
                    });
                }
            })
        );
        
        const shareInvitationsRef = database.ref('shareInvitations')
            .orderByChild('recipientId')
            .equalTo(uid)
            .orderByChild('status')
            .equalTo('pending');
        
        AppState.realtimeListeners.push(
            shareInvitationsRef.on('child_added', (snapshot) => {
                const invitation = snapshot.val();
                if (invitation) {
                    EnhancedUIUpdater.showShareRideInvitation({
                        invitationId: snapshot.key,
                        hostName: invitation.hostName,
                        pickup: invitation.pickup,
                        destination: invitation.destination,
                        distance: invitation.distance,
                        yourShare: invitation.yourShare,
                        rideType: invitation.rideType
                    });
                }
            })
        );
        
        const broadcastInvitationsRef = database.ref('broadcastInvitations')
            .orderByChild('recipientId')
            .equalTo(uid)
            .orderByChild('status')
            .equalTo('pending');
        
        AppState.realtimeListeners.push(
            broadcastInvitationsRef.on('child_added', (snapshot) => {
                const invitation = snapshot.val();
                if (invitation) {
                    EnhancedUIUpdater.showBroadcastInvitation({
                        broadcastId: invitation.broadcastId,
                        hostName: invitation.hostName,
                        pickup: invitation.pickup,
                        destination: invitation.destination,
                        distance: invitation.distance,
                        eta: invitation.eta
                    });
                }
            })
        );
        
        const broadcastRidesRef = database.ref('broadcasts')
            .orderByChild('recipients')
            .startAt({phone: AppState.userData?.phone})
            .endAt({phone: AppState.userData?.phone});
        
        AppState.realtimeListeners.push(
            broadcastRidesRef.on('child_added', (snapshot) => {
                const broadcast = snapshot.val();
                if (broadcast && broadcast.status === 'active') {
                    console.log('New broadcast ride available:', broadcast.id);
                    
                    // Load the associated ride
                    this.loadRideDetails(broadcast.rideId)
                        .then(ride => {
                            if (ride) {
                                // Show broadcast ride info
                                this.showBroadcastRideInfo(ride, broadcast);
                            }
                        });
                }
            })
        );
        
        EnhancedUIUpdater.showRealTimeIndicator();
        
        console.log('Real-time sync started successfully');
    },
    
    stopRealtimeSync: function() {
        console.log('Stopping real-time sync');
        AppState.realtimeListeners.forEach(listener => {
            if (listener && typeof listener === 'function') {
                listener();
            }
        });
        AppState.realtimeListeners = [];
    },
    
    async loadSOSConfig(uid) {
        try {
            const snapshot = await database.ref(`sosConfig/${uid}`).once('value');
            AppState.sosConfig = snapshot.val();
            
            if (AppState.sosConfig) {
                console.log('SOS config loaded');
                
                document.getElementById('emergencyContact1Name').textContent = AppState.sosConfig.contact1Name || 'Contact 1';
                document.getElementById('emergencyContact1Phone').textContent = AppState.sosConfig.contact1Phone || '';
                document.getElementById('emergencyContact2Name').textContent = AppState.sosConfig.contact2Name || 'Contact 2';
                document.getElementById('emergencyContact2Phone').textContent = AppState.sosConfig.contact2Phone || '';
                
                document.getElementById('sosButton').style.display = 'none';
            }
        } catch (error) {
            console.error('Error loading SOS config:', error);
        }
    },
    
    async loadScheduledRides(uid) {
        try {
            const snapshot = await database.ref('scheduledRides')
                .orderByChild('passengerId')
                .equalTo(uid)
                .once('value');
            
            const rides = snapshot.val();
            if (rides) {
                AppState.scheduledRides = Object.values(rides).filter(ride => 
                    ride.status === 'scheduled' || ride.status === 'upcoming'
                );
                console.log(`Loaded ${AppState.scheduledRides.length} scheduled rides`);
            }
        } catch (error) {
            console.error('Error loading scheduled rides:', error);
        }
    },
    
    async checkActiveRide(uid) {
        try {
            const snapshot = await database.ref('rides')
                .orderByChild('passengerId')
                .equalTo(uid)
                .orderByChild('status')
                .startAt('requested')
                .endAt('started')
                .once('value');
            
            const rides = snapshot.val();
            if (rides) {
                const rideId = Object.keys(rides)[0];
                AppState.currentRide = { id: rideId, ...rides[rideId] };
                console.log('Active ride found:', rideId);
                EnhancedUIUpdater.showRideInfo(AppState.currentRide);
                
                this.listenToRideUpdates(rideId);
                
                if (AppState.currentRide.driverId) {
                    this.listenToDriverLocation(AppState.currentRide.driverId);
                    this.loadDriverInfo(AppState.currentRide.driverId);
                }
                
                this.listenToChatMessages(rideId);
                
                return true;
            }
            console.log('No active ride found');
            return false;
        } catch (error) {
            console.error('Error checking active ride:', error);
            return false;
        }
    },
    
    async loadRideHistory(uid) {
        try {
            EnhancedUIUpdater.showLoading('Loading ride history...');
            
            const snapshot = await database.ref('rides')
                .orderByChild('passengerId')
                .equalTo(uid)
                .once('value');
            
            const rides = snapshot.val();
            if (rides) {
                const ridesArray = Object.keys(rides).map(id => ({
                    id,
                    ...rides[id]
                })).sort((a, b) => b.timestamp - a.timestamp);
                
                const filtered = this.filterRides(ridesArray, AppState.activeFilter);
                
                EnhancedUIUpdater.updateHistoryList(filtered);
                
                this.updateUserStats(ridesArray);
                
                console.log(`Loaded ${ridesArray.length} ride history items`);
            }
            
            EnhancedUIUpdater.hideLoading();
        } catch (error) {
            console.error('Error loading ride history:', error);
            EnhancedUIUpdater.hideLoading();
        }
    },
    
    async loadWalletTransactions(uid) {
        try {
            const snapshot = await database.ref('transactions')
                .orderByChild('userId')
                .equalTo(uid)
                .once('value');
            
            const transactions = snapshot.val();
            if (transactions) {
                const transactionsArray = Object.values(transactions)
                    .sort((a, b) => b.timestamp - a.timestamp);
                
                console.log(`Loaded ${transactionsArray.length} wallet transactions`);
                return transactionsArray;
            }
            return [];
        } catch (error) {
            console.error('Error loading wallet transactions:', error);
            return [];
        }
    },
    
    async loadNotifications(uid) {
        try {
            const snapshot = await database.ref(`notifications/${uid}`)
                .orderByChild('timestamp')
                .limitToLast(20)
                .once('value');
            
            const notifications = snapshot.val();
            if (notifications) {
                AppState.notifications = Object.values(notifications).reverse();
                const unreadCount = AppState.notifications.filter(n => !n.read).length;
                AppState.unreadNotifications = unreadCount;
                EnhancedUIUpdater.updateNotificationBadge(unreadCount);
                EnhancedUIUpdater.updateNotifications(AppState.notifications);
                
                console.log(`Loaded ${AppState.notifications.length} notifications`);
            }
        } catch (error) {
            console.error('Error loading notifications:', error);
        }
    },
    
    async markNotificationAsRead(notificationId) {
        try {
            await database.ref(`notifications/${AppState.currentUser.uid}/${notificationId}/read`).set(true);
        } catch (error) {
            console.error('Error marking notification as read:', error);
        }
    },
    
    filterRides: function(rides, filter) {
        switch(filter) {
            case 'completed':
                return rides.filter(ride => ride.status === 'completed');
            case 'cancelled':
                return rides.filter(ride => ride.status === 'cancelled');
            case 'scheduled':
                return rides.filter(ride => ride.scheduled);
            case 'emergency':
                return rides.filter(ride => ride.emergency);
            case 'delivery':
                return rides.filter(ride => ride.serviceType === 'delivery');
            case 'truck':
                return rides.filter(ride => ride.serviceType === 'truck');
            case 'broadcast':
                return rides.filter(ride => ride.broadcast);
            case 'share':
                return rides.filter(ride => ride.sharedRide);
            case 'bicycle':
                return rides.filter(ride => ride.rideType === 'bicycle');
            default:
                return rides;
        }
    },
    
    updateUserStats: function(rides) {
        const completed = rides.filter(ride => ride.status === 'completed').length;
        const cancelled = rides.filter(ride => ride.status === 'cancelled').length;
        const totalSpent = rides
            .filter(ride => ride.status === 'completed')
            .reduce((sum, ride) => sum + (ride.fare || 0), 0);
        
        document.getElementById('completedRides').textContent = completed;
        document.getElementById('cancelledRides').textContent = cancelled;
        document.getElementById('totalSpent').textContent = `ZMW ${totalSpent.toFixed(2)}`;
    },
    
    listenToRideUpdates: function(rideId) {
        const rideRef = database.ref(`rides/${rideId}`);
        
        AppState.realtimeListeners.push(
            rideRef.on('value', (snapshot) => {
                const ride = snapshot.val();
                if (ride) {
                    console.log('Ride updated:', rideId, ride.status);
                    AppState.currentRide = { id: rideId, ...ride };
                    EnhancedUIUpdater.updateRideStatus(ride.status);
                    EnhancedUIUpdater.updateTimeline(ride.status);
                    
                    if (ride.driverId && !AppState.selectedVehicle) {
                        this.loadDriverInfo(ride.driverId);
                    }
                    
                    if (ride.status === 'accepted' && AppState.sosConfig) {
                        document.getElementById('sosButton').style.display = 'flex';
                    }
                    
                    if (ride.status === 'completed') {
                        this.handleRideCompletion(ride);
                    }
                    
                    if (ride.status === 'cancelled') {
                        this.resetActiveRide();
                    }
                }
            })
        );
    },
    
    async loadDriverInfo(driverId) {
        try {
            const snapshot = await database.ref(`users/${driverId}`).once('value');
            const driver = snapshot.val();
            if (driver) {
                AppState.selectedVehicle = driver;
                EnhancedUIUpdater.showDriverInfo(driver);
                
                this.loadDriverImages(driverId);
                
                console.log('Driver info loaded:', driverId);
            }
        } catch (error) {
            console.error('Error loading driver info:', error);
        }
    },
    
    async loadDriverImages(driverId) {
        try {
            const driverPhotoRef = storage.ref(`driver_photos/${driverId}.jpg`);
            driverPhotoRef.getDownloadURL().then(url => {
                const driverImg = document.getElementById('driverImage');
                const driverPlaceholder = document.getElementById('driverImagePlaceholder');
                
                driverImg.src = url;
                driverImg.onload = function() {
                    driverImg.style.display = 'block';
                    driverPlaceholder.style.display = 'none';
                };
            }).catch(() => {
                console.log('Driver photo not found, using placeholder');
            });
            
            const vehiclePhotoRef = storage.ref(`vehicle_photos/${driverId}.jpg`);
            vehiclePhotoRef.getDownloadURL().then(url => {
                const vehicleImg = document.getElementById('vehicleImage');
                const vehiclePlaceholder = document.getElementById('vehicleImagePlaceholder');
                
                vehicleImg.src = url;
                vehicleImg.onload = function() {
                    vehicleImg.style.display = 'block';
                    vehiclePlaceholder.style.display = 'none';
                };
            }).catch(() => {
                console.log('Vehicle photo not found, using placeholder');
            });
        } catch (error) {
            console.error('Error loading driver images:', error);
        }
    },
    
    listenToDriverLocation(driverId) {
        const locationRef = database.ref(`driverLocations/${driverId}`);
        
        AppState.realtimeListeners.push(
            locationRef.on('value', (snapshot) => {
                const location = snapshot.val();
                if (location) {
                    AppState.driverLocation = {
                        lat: location.latitude,
                        lng: location.longitude
                    };
                    EnhancedUIUpdater.updateDriverMarker(AppState.driverLocation);
                    
                    if (AppState.currentRide && AppState.currentRide.pickupLat) {
                        const pickupLocation = {
                            lat: AppState.currentRide.pickupLat,
                            lng: AppState.currentRide.pickupLng
                        };
                        EnhancedUIUpdater.updateDriverTracking(AppState.driverLocation, pickupLocation);
                    }
                }
            })
        );
    },
    
    listenToChatMessages(rideId) {
        const chatRef = database.ref(`chats/${rideId}/messages`).orderByChild('timestamp').limitToLast(50);
        
        AppState.realtimeListeners.push(
            chatRef.on('child_added', (snapshot) => {
                const message = snapshot.val();
                if (message) {
                    EnhancedUIUpdater.showChatMessage(message, message.senderId === AppState.currentUser.uid);
                }
            })
        );
        
        const typingRef = database.ref(`chats/${rideId}/typing`);
        AppState.realtimeListeners.push(
            typingRef.on('value', (snapshot) => {
                const typingData = snapshot.val();
                if (typingData && typingData.driverTyping) {
                    EnhancedUIUpdater.updateTypingIndicator(true);
                    
                    clearTimeout(AppState.typingTimeout);
                    AppState.typingTimeout = setTimeout(() => {
                        EnhancedUIUpdater.updateTypingIndicator(false);
                    }, 3000);
                } else {
                    EnhancedUIUpdater.updateTypingIndicator(false);
                }
            })
        );
    },
    
    async requestRide(rideData) {
        try {
            EnhancedUIUpdater.showLoading('Requesting ride...');
            
            if (!rideData.pickup || !rideData.destination) {
                throw new Error('Pickup and destination locations are required');
            }
            
            if (!EnhancedSearchEngine.validateCoordinatesInCity(
                rideData.pickupLat, rideData.pickupLng, AppState.currentCity
            ) || !EnhancedSearchEngine.validateCoordinatesInCity(
                rideData.destLat, rideData.destLng, AppState.currentCity
            )) {
                throw new Error('Locations must be within city boundaries');
            }
            
            // Prepare stops data
            const stopsData = AppState.stops
                .filter(stop => stop.location)
                .map(stop => ({
                    address: stop.address,
                    name: stop.location.name,
                    lat: stop.location.lat,
                    lng: stop.location.lng,
                    index: stop.index
                }));
            
            const rideId = database.ref().child('rides').push().key;
            const ride = {
                id: rideId,
                ...rideData,
                status: 'requested',
                timestamp: Date.now(),
                updatedAt: Date.now(),
                passengerId: AppState.currentUser.uid,
                passengerName: AppState.userData.name,
                passengerPhone: AppState.userData.phone,
                city: AppState.currentCity,
                stops: stopsData,
                stopsCount: stopsData.length
            };
            
            console.log('Creating ride:', rideId);
            await database.ref(`rides/${rideId}`).set(ride);
            
            AppState.currentRide = ride;
            EnhancedUIUpdater.showRideInfo(ride);
            EnhancedUIUpdater.updateTimeline('requested');
            
            EnhancedUIUpdater.showPulsingRideIcon();
            
            this.listenToRideUpdates(rideId);
            
            await this.notifyAvailableDrivers(ride);
            
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Ride requested successfully', 'success');
            
            if (rideData.broadcast && rideData.broadcastRecipients) {
                await this.startBroadcast(rideId, rideData.broadcastRecipients);
            }
            
            console.log('Ride request completed:', rideId);
            return rideId;
        } catch (error) {
            console.error('Error requesting ride:', error);
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast(error.message, 'error');
            throw error;
        }
    },
    
    async notifyAvailableDrivers(ride) {
        try {
            console.log('Notifying available drivers for ride:', ride.id);
            
            const driversSnapshot = await database.ref('drivers')
                .orderByChild('status')
                .equalTo('available')
                .once('value');
            
            const drivers = driversSnapshot.val();
            if (drivers) {
                Object.keys(drivers).forEach(driverId => {
                    const driver = drivers[driverId];
                    
                    this.sendNotification(driverId, 'New Ride Request', 
                        `New ride request from ${ride.passengerName} to ${ride.destinationDisplay || ride.destination}`, 
                        'ride',
                        { rideId: ride.id, action: 'view_ride' }
                    );
                });
                
                console.log(`Notified ${Object.keys(drivers).length} drivers`);
            } else {
                console.log('No available drivers found');
            }
        } catch (error) {
            console.error('Error notifying drivers:', error);
        }
    },
    
    async requestDelivery(deliveryData) {
        try {
            EnhancedUIUpdater.showLoading('Requesting delivery...');
            
            if (!deliveryData.pickup || !deliveryData.destination) {
                throw new Error('Pickup and destination locations are required');
            }
            
            const rideId = database.ref().child('rides').push().key;
            const ride = {
                id: rideId,
                ...deliveryData,
                serviceType: 'delivery',
                status: 'requested',
                timestamp: Date.now(),
                updatedAt: Date.now(),
                passengerId: AppState.currentUser.uid,
                passengerName: AppState.userData.name,
                passengerPhone: AppState.userData.phone,
                city: AppState.currentCity
            };
            
            await database.ref(`rides/${rideId}`).set(ride);
            
            AppState.currentRide = ride;
            EnhancedUIUpdater.showRideInfo(ride);
            EnhancedUIUpdater.updateTimeline('requested');
            
            EnhancedUIUpdater.showPulsingRideIcon();
            
            this.listenToRideUpdates(rideId);
            
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Delivery requested successfully', 'success');
            console.log('Delivery request completed:', rideId);
            return rideId;
        } catch (error) {
            console.error('Error requesting delivery:', error);
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast(error.message, 'error');
            throw error;
        }
    },
    
    async requestTruck(truckData) {
        try {
            EnhancedUIUpdater.showLoading('Requesting truck...');
            
            if (!truckData.pickup || !truckData.destination) {
                throw new Error('Pickup and destination locations are required');
            }
            
            const rideId = database.ref().child('rides').push().key;
            const ride = {
                id: rideId,
                ...truckData,
                serviceType: 'truck',
                status: 'requested',
                timestamp: Date.now(),
                updatedAt: Date.now(),
                passengerId: AppState.currentUser.uid,
                passengerName: AppState.userData.name,
                passengerPhone: AppState.userData.phone,
                city: AppState.currentCity
            };
            
            await database.ref(`rides/${rideId}`).set(ride);
            
            AppState.currentRide = ride;
            EnhancedUIUpdater.showRideInfo(ride);
            EnhancedUIUpdater.updateTimeline('requested');
            
            EnhancedUIUpdater.showPulsingRideIcon();
            
            this.listenToRideUpdates(rideId);
            
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Truck requested successfully', 'success');
            console.log('Truck request completed:', rideId);
            return rideId;
        } catch (error) {
            console.error('Error requesting truck:', error);
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast(error.message, 'error');
            throw error;
        }
    },
    
    async requestShopping(shoppingData) {
        try {
            EnhancedUIUpdater.showLoading('Submitting shopping request...');
            
            if (!shoppingData.destination) {
                throw new Error('Delivery location is required');
            }
            
            const rideId = database.ref().child('rides').push().key;
            const ride = {
                id: rideId,
                ...shoppingData,
                serviceType: 'shopping',
                status: 'requested',
                timestamp: Date.now(),
                updatedAt: Date.now(),
                passengerId: AppState.currentUser.uid,
                passengerName: AppState.userData.name,
                passengerPhone: AppState.userData.phone,
                city: AppState.currentCity
            };
            
            await database.ref(`rides/${rideId}`).set(ride);
            
            AppState.currentRide = ride;
            EnhancedUIUpdater.showRideInfo(ride);
            EnhancedUIUpdater.updateTimeline('requested');
            
            EnhancedUIUpdater.showPulsingRideIcon();
            
            this.listenToRideUpdates(rideId);
            
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Shopping request submitted', 'success');
            console.log('Shopping request completed:', rideId);
            return rideId;
        } catch (error) {
            console.error('Error requesting shopping:', error);
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast(error.message, 'error');
            throw error;
        }
    },
    
    async requestEmergencyRide(emergencyData) {
        try {
            EnhancedUIUpdater.showLoading('Requesting emergency ride...');
            
            if (!emergencyData.pickup || !emergencyData.destination) {
                throw new Error('Pickup and destination locations are required');
            }
            
            const rideId = database.ref().child('rides').push().key;
            const ride = {
                id: rideId,
                ...emergencyData,
                emergency: true,
                status: 'requested',
                timestamp: Date.now(),
                updatedAt: Date.now(),
                passengerId: AppState.currentUser.uid,
                passengerName: AppState.userData.name,
                passengerPhone: AppState.userData.phone,
                priority: 'high',
                city: AppState.currentCity
            };
            
            await database.ref(`rides/${rideId}`).set(ride);
            
            AppState.currentRide = ride;
            AppState.emergencyMode = true;
            EnhancedUIUpdater.showRideInfo(ride);
            EnhancedUIUpdater.updateTimeline('requested');
            
            document.getElementById('emergencyStatus').style.display = 'flex';
            
            EnhancedUIUpdater.showPulsingRideIcon();
            
            this.listenToRideUpdates(rideId);
            
            await this.sendEmergencyNotifications(ride);
            
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Emergency ride requested', 'success');
            console.log('Emergency ride request completed:', rideId);
            return rideId;
        } catch (error) {
            console.error('Error requesting emergency ride:', error);
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast(error.message, 'error');
            throw error;
        }
    },
    
    async sendEmergencyNotifications(ride) {
        try {
            console.log('Sending emergency notifications for ride:', ride.id);
            
            const emergencyServicesRef = database.ref('emergencyServices').push();
            await emergencyServicesRef.set({
                rideId: ride.id,
                emergencyType: ride.emergencyType,
                location: {
                    lat: ride.pickupLat,
                    lng: ride.pickupLng
                },
                timestamp: Date.now(),
                status: 'pending',
                city: AppState.currentCity
            });
            
            if (AppState.sosConfig) {
                await this.sendSOSAlert(ride.id, {
                    emergencyContact1: AppState.sosConfig.contact1Phone,
                    emergencyContact1Name: AppState.sosConfig.contact1Name,
                    emergencyContact2: AppState.sosConfig.contact2Phone,
                    emergencyContact2Name: AppState.sosConfig.contact2Name,
                    message: AppState.sosConfig.message || 'Emergency ride requested',
                    location: {
                        lat: ride.pickupLat,
                        lng: ride.pickupLng
                    },
                    rideDetails: {
                        pickup: ride.pickupDisplay,
                        destination: ride.destinationDisplay,
                        emergencyType: ride.emergencyType
                    },
                    city: AppState.currentCity
                });
            }
            
            console.log('Emergency notifications sent');
        } catch (error) {
            console.error('Error sending emergency notifications:', error);
        }
    },
    
    async cancelRide(rideId, reason) {
        try {
            EnhancedUIUpdater.showLoading('Cancelling ride...');
            
            await database.ref(`rides/${rideId}`).update({
                status: 'cancelled',
                cancelReason: reason,
                cancelledAt: Date.now(),
                updatedAt: Date.now()
            });
            
            if (AppState.currentRide?.driverId) {
                await this.sendNotification(
                    AppState.currentRide.driverId,
                    'Ride Cancelled',
                    `Ride cancelled by passenger. Reason: ${reason}`,
                    'warning'
                );
            }
            
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Ride cancelled successfully', 'success');
            console.log('Ride cancelled:', rideId);
            return true;
        } catch (error) {
            console.error('Error cancelling ride:', error);
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Error cancelling ride', 'error');
            return false;
        }
    },
    
    async cancelScheduledRide(scheduledRideId) {
        try {
            await database.ref(`scheduledRides/${scheduledRideId}`).update({
                status: 'cancelled',
                cancelledAt: Date.now()
            });
            
            console.log('Scheduled ride cancelled:', scheduledRideId);
            return true;
        } catch (error) {
            console.error('Error cancelling scheduled ride:', error);
            return false;
        }
    },
    
    async scheduleRide(rideData) {
        try {
            EnhancedUIUpdater.showLoading('Scheduling ride...');
            
            if (!rideData.pickup || !rideData.destination) {
                throw new Error('Pickup and destination locations are required');
            }
            
            const rideId = database.ref().child('scheduledRides').push().key;
            const ride = {
                id: rideId,
                ...rideData,
                status: 'scheduled',
                timestamp: Date.now(),
                passengerId: AppState.currentUser.uid,
                passengerName: AppState.userData.name,
                city: AppState.currentCity
            };
            
            await database.ref(`scheduledRides/${rideId}`).set(ride);
            
            AppState.scheduledRides.push(ride);
            
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Ride scheduled successfully', 'success');
            
            const now = Date.now();
            const timeUntilRide = rideData.scheduledTime - now;
            if (timeUntilRide <= 3600000) {
                EnhancedUIUpdater.showScheduleCountdown(rideData.scheduledTime);
            }
            
            const scheduleTime = new Date(rideData.scheduledTime);
            const notificationTime = new Date(scheduleTime.getTime() - 30 * 60000);
            
            this.scheduleNotification(
                rideId,
                'Scheduled Ride Reminder',
                `Your ride is scheduled for ${scheduleTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`,
                notificationTime.getTime()
            );
            
            console.log('Ride scheduled:', rideId);
            return rideId;
        } catch (error) {
            console.error('Error scheduling ride:', error);
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Error scheduling ride', 'error');
            throw error;
        }
    },
    
    async scheduleNotification(notificationId, title, message, timestamp) {
        try {
            await database.ref(`scheduledNotifications/${notificationId}`).set({
                userId: AppState.currentUser.uid,
                title: title,
                message: message,
                timestamp: timestamp,
                status: 'pending'
            });
        } catch (error) {
            console.error('Error scheduling notification:', error);
        }
    },
    
    async sendChatMessage(rideId, message, isDriver = false) {
        try {
            const messageId = database.ref().child(`chats/${rideId}/messages`).push().key;
            const chatMessage = {
                id: messageId,
                text: message,
                senderId: isDriver ? AppState.currentRide?.driverId : AppState.currentUser.uid,
                senderName: isDriver ? AppState.selectedVehicle?.name : AppState.userData?.name,
                timestamp: Date.now(),
                isDriver: isDriver
            };
            
            await database.ref(`chats/${rideId}/messages/${messageId}`).set(chatMessage);
            
            await database.ref(`chats/${rideId}/typing/${isDriver ? 'driverTyping' : 'passengerTyping'}`).set(false);
            
            console.log('Chat message sent:', messageId);
            return messageId;
        } catch (error) {
            console.error('Error sending chat message:', error);
            throw error;
        }
    },
    
    async updateTypingStatus(rideId, isTyping, isDriver = false) {
        try {
            await database.ref(`chats/${rideId}/typing/${isDriver ? 'driverTyping' : 'passengerTyping'}`).set(isTyping);
        } catch (error) {
            console.error('Error updating typing status:', error);
        }
    },
    
    async saveSOSConfig(config) {
        try {
            await database.ref(`sosConfig/${AppState.currentUser.uid}`).set(config);
            AppState.sosConfig = config;
            
            document.getElementById('emergencyContact1Name').textContent = config.contact1Name || 'Contact 1';
            document.getElementById('emergencyContact1Phone').textContent = config.contact1Phone || '';
            document.getElementById('emergencyContact2Name').textContent = config.contact2Name || 'Contact 2';
            document.getElementById('emergencyContact2Phone').textContent = config.contact2Phone || '';
            
            EnhancedUIUpdater.showToast('SOS configuration saved', 'success');
            console.log('SOS config saved');
            return true;
        } catch (error) {
            console.error('Error saving SOS config:', error);
            EnhancedUIUpdater.showToast('Error saving SOS config', 'error');
            return false;
        }
    },
    
    async sendSOSAlert(rideId, sosData) {
        try {
            const alertId = database.ref().child('sosAlerts').push().key;
            await database.ref(`sosAlerts/${alertId}`).set({
                ...sosData,
                rideId: rideId,
                timestamp: Date.now(),
                status: 'active'
            });
            
            if (sosData.emergencyContact1) {
                await this.sendSMSNotification(
                    sosData.emergencyContact1,
                    'SOS Alert',
                    `EMERGENCY: ${sosData.message}. Location: ${sosData.location?.lat},${sosData.location?.lng}. Ride Details: ${sosData.rideDetails?.pickup} to ${sosData.rideDetails?.destination} in ${sosData.city}`
                );
            }
            if (sosData.emergencyContact2) {
                await this.sendSMSNotification(
                    sosData.emergencyContact2,
                    'SOS Alert',
                    `EMERGENCY: ${sosData.message}. Location: ${sosData.location?.lat},${sosData.location?.lng}. Ride Details: ${sosData.rideDetails?.pickup} to ${sosData.rideDetails?.destination} in ${sosData.city}`
                );
            }
            
            EnhancedUIUpdater.showToast('SOS alert sent to emergency contacts', 'success');
            console.log('SOS alert sent:', alertId);
            return true;
        } catch (error) {
            console.error('Error sending SOS alert:', error);
            EnhancedUIUpdater.showToast('Error sending SOS alert', 'error');
            return false;
        }
    },
    
    async sendSMSNotification(phoneNumber, title, message) {
        try {
            console.log(`SMS to ${phoneNumber}: ${title} - ${message}`);
            
            const smsId = database.ref().child('smsNotifications').push().key;
            await database.ref(`smsNotifications/${smsId}`).set({
                phoneNumber: phoneNumber,
                title: title,
                message: message,
                timestamp: Date.now(),
                status: 'sent'
            });
            
            return true;
        } catch (error) {
            console.error('Error sending SMS:', error);
            return false;
        }
    },
    
    async sendNotification(userId, title, message, type = 'info', data = null) {
        try {
            const notificationId = database.ref().child(`notifications/${userId}`).push().key;
            const notification = {
                id: notificationId,
                title: title,
                message: message,
                type: type,
                read: false,
                timestamp: Date.now(),
                data: data
            };
            
            await database.ref(`notifications/${userId}/${notificationId}`).set(notification);
            console.log('Notification sent:', notificationId);
            return true;
        } catch (error) {
            console.error('Error sending notification:', error);
            return false;
        }
    },
    
    async transferMoney(recipientCode, amount, message = '') {
        try {
            EnhancedUIUpdater.showLoading('Processing transfer...');
            
            const usersSnapshot = await database.ref('users').once('value');
            const users = usersSnapshot.val();
            let recipientId = null;
            let recipientName = '';
            
            for (const [userId, userData] of Object.entries(users)) {
                if (userData.referralCode === recipientCode) {
                    recipientId = userId;
                    recipientName = userData.name;
                    break;
                }
            }
            
            if (!recipientId) {
                throw new Error('Recipient not found. Please check the referral code.');
            }
            
            if (recipientId === AppState.currentUser.uid) {
                throw new Error('Cannot transfer money to yourself.');
            }
            
            if (AppState.walletBalance < amount) {
                throw new Error('Insufficient balance');
            }
            
            const senderNewBalance = AppState.walletBalance - amount;
            const recipientSnapshot = await database.ref(`users/${recipientId}/walletBalance`).once('value');
            const recipientBalance = recipientSnapshot.val() || 0;
            const recipientNewBalance = recipientBalance + amount;
            
            await database.ref().update({
                [`users/${AppState.currentUser.uid}/walletBalance`]: senderNewBalance,
                [`users/${recipientId}/walletBalance`]: recipientNewBalance
            });
            
            const transactionId = database.ref().child('transactions').push().key;
            const transaction = {
                id: transactionId,
                senderId: AppState.currentUser.uid,
                senderName: AppState.userData.name,
                recipientId: recipientId,
                recipientName: recipientName,
                amount: amount,
                message: message,
                timestamp: Date.now(),
                type: 'transfer',
                status: 'completed',
                userId: AppState.currentUser.uid
            };
            
            await database.ref(`transactions/${transactionId}`).set(transaction);
            
            EnhancedUIUpdater.updateWalletBalance(senderNewBalance);
            
            await this.sendNotification(
                recipientId,
                'Money Received',
                `You received ZMW ${amount.toFixed(2)} from ${AppState.userData.name}`,
                'success',
                { transactionId: transactionId, action: 'view_payment' }
            );
            
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast(`ZMW ${amount.toFixed(2)} sent to ${recipientName}`, 'success');
            console.log('Money transferred:', transactionId);
            return true;
        } catch (error) {
            console.error('Error transferring money:', error);
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast(error.message, 'error');
            return false;
        }
    },
    
    async loadTransactions(userId) {
        try {
            EnhancedUIUpdater.showLoading('Loading transactions...');
            
            const snapshot = await database.ref('transactions')
                .orderByChild('senderId')
                .equalTo(userId)
                .once('value');
            
            const sentTransactions = snapshot.val() || {};
            
            const receivedSnapshot = await database.ref('transactions')
                .orderByChild('recipientId')
                .equalTo(userId)
                .once('value');
            
            const receivedTransactions = receivedSnapshot.val() || {};
            
            const allTransactions = [
                ...Object.values(sentTransactions),
                ...Object.values(receivedTransactions)
            ].sort((a, b) => b.timestamp - a.timestamp);
            
            EnhancedUIUpdater.hideLoading();
            console.log(`Loaded ${allTransactions.length} transactions`);
            return allTransactions;
        } catch (error) {
            console.error('Error loading transactions:', error);
            EnhancedUIUpdater.hideLoading();
            return [];
        }
    },
    
    async loadRideDetails(rideId) {
        try {
            const snapshot = await database.ref(`rides/${rideId}`).once('value');
            const ride = snapshot.val();
            if (ride) {
                return { id: rideId, ...ride };
            }
            return null;
        } catch (error) {
            console.error('Error loading ride details:', error);
            return null;
        }
    },
    
    handleRideCompletion: function(ride) {
        console.log('Handling ride completion:', ride.id);
        
        document.getElementById('rideStatusBar').classList.remove('active');
        
        document.getElementById('sosButton').style.display = 'none';
        
        document.getElementById('emergencyStatus').style.display = 'none';
        
        EnhancedUIUpdater.updateTimeline('completed');
        
        EnhancedUIUpdater.removePulsingRideIcon();
        
        const actionButtons = document.querySelector('#rideInfoPanel .action-buttons');
        const existingReceiptBtn = document.querySelector('#receiptBtn');
        
        if (!existingReceiptBtn) {
            const receiptBtn = document.createElement('button');
            receiptBtn.id = 'receiptBtn';
            receiptBtn.className = 'btn btn-primary';
            receiptBtn.innerHTML = '<i class="fas fa-receipt"></i> View Receipt';
            receiptBtn.addEventListener('click', () => {
                this.generateReceipt(ride);
            });
            
            actionButtons.appendChild(receiptBtn);
        }
        
        // Handle wallet payment
        if (ride.paymentMethod === 'wallet') {
            const newBalance = AppState.walletBalance - ride.fare;
            EnhancedUIUpdater.updateWalletBalance(newBalance);
            
            // Record transaction
            this.recordRidePaymentTransaction(ride);
        }
        
        // Handle referral reward
        if (ride.referredBy) {
            this.handleReferralReward(ride);
        }
        
        // Handle share ride payments
        if (ride.sharedRide && ride.shareParticipants) {
            this.handleShareRideCompletion(ride);
        }
        
        this.sendNotification(
            AppState.currentUser.uid,
            'Ride Completed',
            `Your ride to ${ride.destinationDisplay || ride.destination} has been completed. Fare: ZMW ${ride.fare?.toFixed(2)}`,
            'success',
            { rideId: ride.id, action: 'view_ride' }
        );
        
        setTimeout(() => {
            this.resetActiveRide();
        }, 5000);
    },
    
    recordRidePaymentTransaction: function(ride) {
        try {
            const transactionId = database.ref().child('transactions').push().key;
            const transaction = {
                id: transactionId,
                type: 'ride_payment',
                amount: ride.fare,
                description: `Ride from ${ride.pickupDisplay} to ${ride.destinationDisplay}`,
                rideId: ride.id,
                rideType: ride.rideType || ride.serviceType,
                timestamp: Date.now(),
                status: 'completed',
                userId: AppState.currentUser.uid
            };
            
            database.ref(`transactions/${transactionId}`).set(transaction);
            console.log('Ride payment transaction recorded:', transactionId);
        } catch (error) {
            console.error('Error recording ride payment transaction:', error);
        }
    },
    
    async handleReferralReward(ride) {
        try {
            const usersSnapshot = await database.ref('users').once('value');
            const users = usersSnapshot.val();
            let referrerId = null;
            let referrerName = '';
            
            for (const [userId, userData] of Object.entries(users)) {
                if (userData.referralCode === ride.referredBy) {
                    referrerId = userId;
                    referrerName = userData.name;
                    break;
                }
            }
            
            if (referrerId) {
                const referrerSnapshot = await database.ref(`users/${referrerId}/walletBalance`).once('value');
                const referrerBalance = referrerSnapshot.val() || 0;
                const newReferrerBalance = referrerBalance + 25;
                
                await database.ref(`users/${referrerId}/walletBalance`).set(newReferrerBalance);
                
                const transactionId = database.ref().child('transactions').push().key;
                const transaction = {
                    id: transactionId,
                    type: 'referral_reward',
                    amount: 25,
                    description: `Referral reward from ${AppState.userData.name}`,
                    referredUserId: AppState.currentUser.uid,
                    referredUserName: AppState.userData.name,
                    timestamp: Date.now(),
                    status: 'completed',
                    userId: referrerId
                };
                
                await database.ref(`transactions/${transactionId}`).set(transaction);
                
                await this.sendNotification(
                    referrerId,
                    'Referral Reward',
                    `You earned ZMW 25.00 because ${AppState.userData.name} used your referral code`,
                    'success',
                    { transactionId: transactionId, action: 'view_payment' }
                );
                
                console.log('Referral reward processed:', transactionId);
            }
        } catch (error) {
            console.error('Error handling referral reward:', error);
        }
    },
    
    async handleShareRideCompletion(ride) {
        try {
            // Process payments for all share participants
            if (ride.shareParticipantsData) {
                for (const participant of ride.shareParticipantsData) {
                    if (participant.userId !== AppState.currentUser.uid && participant.paymentStatus === 'pending') {
                        // Record transaction for friend's payment
                        const transactionId = database.ref().child('transactions').push().key;
                        const transaction = {
                            id: transactionId,
                            type: 'share_ride_payment',
                            amount: participant.amount,
                            description: `Share ride payment for ${ride.pickupDisplay} to ${ride.destinationDisplay}`,
                            rideId: ride.id,
                            friendId: participant.userId,
                            friendName: participant.name,
                            timestamp: Date.now(),
                            status: 'completed',
                            userId: AppState.currentUser.uid
                        };
                        
                        await database.ref(`transactions/${transactionId}`).set(transaction);
                    }
                }
            }
        } catch (error) {
            console.error('Error handling share ride completion:', error);
        }
    },
    
    generateReceipt: function(ride) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFontSize(18);
        doc.setTextColor(255, 107, 53);
        doc.text('JUBEL RIDE RECEIPT', 105, 20, { align: 'center' });
        
        doc.setFontSize(10);
        doc.setTextColor(0, 0, 0);
        doc.text(`Receipt No: ${ride.id.substring(0, 8)}`, 20, 40);
        doc.text(`Date: ${new Date(ride.timestamp).toLocaleString()}`, 20, 45);
        doc.text(`City: ${ride.city || AppState.currentCity}`, 20, 50);
        
        doc.text(`Passenger: ${AppState.userData.name}`, 20, 60);
        doc.text(`Driver: ${ride.driverName || 'Not assigned'}`, 20, 65);
        doc.text(`Pickup: ${ride.pickupDisplay || ride.pickup}`, 20, 70);
        doc.text(`Destination: ${ride.destinationDisplay || ride.destination}`, 20, 75);
        doc.text(`Distance: ${ride.distance?.toFixed(1) || '0'} km`, 20, 80);
        
        if (ride.serviceType) {
            doc.text(`Service Type: ${ride.serviceType.charAt(0).toUpperCase() + ride.serviceType.slice(1)}`, 20, 85);
        } else {
            doc.text(`Ride Type: ${ride.rideType?.charAt(0).toUpperCase() + ride.rideType?.slice(1)}`, 20, 85);
        }
        
        // Add stops if any
        if (ride.stops && ride.stops.length > 0) {
            doc.text(`Stops: ${ride.stops.length}`, 20, 90);
            ride.stops.forEach((stop, index) => {
                doc.text(`  ${index + 1}. ${stop.address}`, 25, 95 + (index * 5));
            });
        }
        
        doc.text('Fare Breakdown:', 20, ride.stops && ride.stops.length > 0 ? 100 + (ride.stops.length * 5) : 95);
        
        let yPos = ride.stops && ride.stops.length > 0 ? 105 + (ride.stops.length * 5) : 100;
        if (ride.serviceType === 'truck') {
            const config = AppState.truckTypes[ride.truckType] || AppState.truckTypes.light;
            doc.text(`Base Fare: ZMW ${config.base.toFixed(2)}`, 30, yPos);
            yPos += 5;
            doc.text(`Distance Fare: ZMW ${((ride.distance || 0) * config.perKm).toFixed(2)}`, 30, yPos);
        } else if (ride.serviceType === 'delivery') {
            const config = AppState.deliveryTypes[ride.deliveryType] || AppState.deliveryTypes.standard;
            doc.text(`Base Fare: ZMW ${config.base.toFixed(2)}`, 30, yPos);
            yPos += 5;
            doc.text(`Distance Fare: ZMW ${((ride.distance || 0) * config.perKm).toFixed(2)}`, 30, yPos);
        } else {
            doc.text(`Base Fare: ZMW ${(AppState.rideTypes[ride.rideType]?.base || 20).toFixed(2)}`, 30, yPos);
            yPos += 5;
            doc.text(`Distance Fare: ZMW ${((ride.distance || 0) * (AppState.rideTypes[ride.rideType]?.perKm || 3)).toFixed(2)}`, 30, yPos);
        }
        
        // Add stops cost
        if (ride.stops && ride.stops.length > 0) {
            yPos += 5;
            doc.text(`Stops Cost: ZMW ${(ride.stops.length * 5).toFixed(2)}`, 30, yPos);
        }
        
        // Add referral discount if applied
        if (ride.discountAmount) {
            yPos += 5;
            doc.text(`Referral Discount: -ZMW ${ride.discountAmount.toFixed(2)}`, 30, yPos);
        }
        
        yPos += 5;
        doc.text(`Total: ZMW ${ride.fare?.toFixed(2) || '0.00'}`, 30, yPos);
        
        yPos += 10;
        doc.text(`Payment Method: ${ride.paymentMethod?.charAt(0).toUpperCase() + ride.paymentMethod?.slice(1)}`, 20, yPos);
        
        doc.text('Scan for verification:', 20, yPos + 10);
        
        doc.save(`Jubel_Receipt_${ride.id.substring(0, 8)}.pdf`);
        EnhancedUIUpdater.showToast('Receipt downloaded', 'success');
        console.log('Receipt generated for ride:', ride.id);
    },
    
    resetActiveRide: function() {
        console.log('Resetting active ride state');
        
        document.getElementById('rideInfoPanel').classList.remove('active');
        
        switchService(AppState.activeService);
        
        document.getElementById('fareDisplay').classList.remove('active');
        
        document.getElementById('rideTypeSelection').classList.remove('active');
        
        document.getElementById('priceCalculator').style.display = 'none';
        
        document.getElementById('emergencyStatus').style.display = 'none';
        
        document.getElementById('sosButton').style.display = 'none';
        
        document.getElementById('rideStatusBar').classList.remove('active');
        
        document.getElementById('emergencyContactDisplay').style.display = 'none';
        
        document.getElementById('broadcastFeature').style.display = 'none';
        
        document.getElementById('rideStopsContainer').style.display = 'none';
        
        AppState.currentRide = null;
        AppState.emergencyMode = false;
        AppState.selectedVehicle = null;
        AppState.driverLocation = null;
        AppState.stops = [];
        EnhancedLocationManager.clearAllStops();
        
        if (driverMarker) {
            map.removeLayer(driverMarker);
            driverMarker = null;
        }
        
        if (routeLayer) {
            map.removeLayer(routeLayer);
            routeLayer = null;
        }
        
        document.getElementById('destinationLocation').value = '';
        
        if (destinationMarker) {
            map.removeLayer(destinationMarker);
            destinationMarker = null;
        }
        
        emergencyStationMarkers.forEach(marker => map.removeLayer(marker));
        emergencyStationMarkers = [];
        
        emergencyMarkers.forEach(marker => map.removeLayer(marker));
        emergencyMarkers = [];
        
        document.getElementById('chatMessages').innerHTML = '';
        
        EnhancedUIUpdater.updateTypingIndicator(false);
        
        EnhancedUIUpdater.showToast('Ride completed', 'success');
    },
    
    async startBroadcast(rideId, recipients) {
        try {
            const broadcastId = database.ref().child('broadcasts').push().key;
            const broadcast = {
                id: broadcastId,
                rideId: rideId,
                hostId: AppState.currentUser.uid,
                hostName: AppState.userData.name,
                recipients: recipients,
                status: 'active',
                timestamp: Date.now(),
                city: AppState.currentCity
            };
            
            await database.ref(`broadcasts/${broadcastId}`).set(broadcast);
            
            AppState.activeBroadcast = broadcast;
            EnhancedUIUpdater.updateBroadcastStatus(true);
            EnhancedUIUpdater.updateBroadcastRecipients(recipients);
            
            recipients.forEach(async (recipient) => {
                const usersSnapshot = await database.ref('users').once('value');
                const users = usersSnapshot.val();
                
                let recipientUserId = null;
                for (const [userId, userData] of Object.entries(users)) {
                    if (userData.phone === recipient.phone) {
                        recipientUserId = userId;
                        break;
                    }
                }
                
                if (recipientUserId) {
                    await this.sendNotification(
                        recipientUserId,
                        'Ride Broadcast Invitation',
                        `${AppState.userData.name} has invited you to join their ride in ${AppState.currentCity}`,
                        'broadcast',
                        { 
                            broadcastId: broadcastId,
                            rideId: rideId,
                            action: 'accept_broadcast'
                        }
                    );
                    
                    const broadcastInvitationId = database.ref().child('broadcastInvitations').push().key;
                    await database.ref(`broadcastInvitations/${broadcastInvitationId}`).set({
                        id: broadcastInvitationId,
                        broadcastId: broadcastId,
                        recipientId: recipientUserId,
                        hostName: AppState.userData.name,
                        pickup: AppState.pickup?.address || 'Current Location',
                        destination: AppState.destination?.address || 'Destination',
                        distance: AppState.currentRide?.distance || 0,
                        eta: EnhancedPriceCalculator.estimateTime(AppState.currentRide?.distance || 0, AppState.selectedRideType),
                        status: 'pending',
                        timestamp: Date.now()
                    });
                }
            });
            
            EnhancedUIUpdater.showToast('Broadcast started', 'success');
            console.log('Broadcast started:', broadcastId);
            return broadcastId;
        } catch (error) {
            console.error('Error starting broadcast:', error);
            EnhancedUIUpdater.showToast('Error starting broadcast', 'error');
            throw error;
        }
    },
    
    async acceptBroadcastInvitation(broadcastId) {
        try {
            const snapshot = await database.ref(`broadcasts/${broadcastId}`).once('value');
            const broadcast = snapshot.val();
            
            if (broadcast && broadcast.status === 'active') {
                const updatedRecipients = broadcast.recipients.map(recipient => {
                    if (recipient.phone === AppState.userData.phone) {
                        return { ...recipient, status: 'joined' };
                    }
                    return recipient;
                });
                
                await database.ref(`broadcasts/${broadcastId}/recipients`).set(updatedRecipients);
                
                const ride = await this.loadRideDetails(broadcast.rideId);
                if (ride) {
                    AppState.currentRide = ride;
                    EnhancedUIUpdater.showRideInfo(ride);
                    
                    await this.sendNotification(
                        broadcast.hostId,
                        'Broadcast Ride Joined',
                        `${AppState.userData.name} has joined your broadcast ride`,
                        'info'
                    );
                    
                    EnhancedUIUpdater.showToast('You have joined the broadcast ride', 'success');
                    console.log('Broadcast invitation accepted:', broadcastId);
                }
            }
        } catch (error) {
            console.error('Error accepting broadcast invitation:', error);
            EnhancedUIUpdater.showToast('Error joining broadcast ride', 'error');
        }
    },
    
    async joinBroadcastRide(broadcastId) {
        try {
            const snapshot = await database.ref(`broadcasts/${broadcastId}`).once('value');
            const broadcast = snapshot.val();
            
            if (broadcast) {
                const ride = await this.loadRideDetails(broadcast.rideId);
                if (ride) {
                    // Show broadcast ride info without joining
                    this.showBroadcastRideInfo(ride, broadcast);
                    EnhancedUIUpdater.showToast('You are now viewing the broadcast ride', 'success');
                }
            }
        } catch (error) {
            console.error('Error joining broadcast ride:', error);
            EnhancedUIUpdater.showToast('Error joining broadcast ride', 'error');
        }
    },
    
    showBroadcastRideInfo: function(ride, broadcast) {
        // Create a special view for broadcast rides
        const broadcastPanel = document.createElement('div');
        broadcastPanel.className = 'broadcast-ride-panel active';
        broadcastPanel.innerHTML = `
            <div class="broadcast-header">
                <h3>${broadcast.hostName}'s Ride</h3>
                <button class="close-broadcast" onclick="this.parentElement.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="broadcast-content">
                <div class="broadcast-info">
                    <div class="info-row">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>${ride.pickupDisplay}</span>
                    </div>
                    <div class="info-row">
                        <i class="fas fa-flag"></i>
                        <span>${ride.destinationDisplay}</span>
                    </div>
                    <div class="info-row">
                        <i class="fas fa-road"></i>
                        <span>${ride.distance?.toFixed(1) || '0'} km</span>
                    </div>
                    <div class="info-row">
                        <i class="fas fa-clock"></i>
                        <span>ETA: ${EnhancedPriceCalculator.estimateTime(ride.distance || 0, ride.rideType)} min</span>
                    </div>
                </div>
                
                <div class="broadcast-status">
                    <div class="status-indicator active">
                        <i class="fas fa-broadcast-tower"></i>
                        <span>Live Tracking</span>
                    </div>
                </div>
                
                <div class="broadcast-map" id="broadcastMap" style="height: 200px; margin: 15px 0; border-radius: 10px;"></div>
                
                <button class="btn btn-primary" onclick="EnhancedFirebaseManager.acceptBroadcastInvitation('${broadcast.id}')">
                    <i class="fas fa-check"></i> Join Ride
                </button>
            </div>
        `;
        
        document.body.appendChild(broadcastPanel);
        
        // Initialize map for broadcast
        setTimeout(() => {
            const broadcastMap = L.map('broadcastMap').setView([ride.pickupLat || -15.4167, ride.pickupLng || 28.2833], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: ' OpenStreetMap contributors'
            }).addTo(broadcastMap);
            
            // Add pickup and destination markers
            if (ride.pickupLat && ride.pickupLng) {
                L.marker([ride.pickupLat, ride.pickupLng], {
                    icon: L.divIcon({
                        className: 'pickup-marker',
                        html: '<i class="fas fa-map-marker-alt"></i>',
                        iconSize: [20, 20]
                    })
                }).addTo(broadcastMap).bindPopup('Pickup');
            }
            
            if (ride.destLat && ride.destLng) {
                L.marker([ride.destLat, ride.destLng], {
                    icon: L.divIcon({
                        className: 'destination-marker',
                        html: '<i class="fas fa-flag"></i>',
                        iconSize: [20, 20]
                    })
                }).addTo(broadcastMap).bindPopup('Destination');
            }
            
            // Draw route
            if (ride.pickupLat && ride.pickupLng && ride.destLat && ride.destLng) {
                const routeCoordinates = [
                    [ride.pickupLat, ride.pickupLng],
                    [ride.destLat, ride.destLng]
                ];
                L.polyline(routeCoordinates, {
                    color: '#FF6B35',
                    weight: 3
                }).addTo(broadcastMap);
                
                broadcastMap.fitBounds(routeCoordinates);
            }
        }, 100);
    },
    
    async updateProfile(profileData) {
        try {
            EnhancedUIUpdater.showLoading('Updating profile...');
            
            await database.ref(`users/${AppState.currentUser.uid}`).update({
                name: profileData.name,
                phone: profileData.phone,
                homeAddress: profileData.homeAddress,
                workAddress: profileData.workAddress,
                updatedAt: Date.now()
            });
            
            AppState.userData = {
                ...AppState.userData,
                ...profileData
            };
            
            EnhancedUIUpdater.updateUserInfo(AppState.userData);
            
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Profile updated successfully', 'success');
            console.log('Profile updated');
            return true;
        } catch (error) {
            console.error('Error updating profile:', error);
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Error updating profile', 'error');
            return false;
        }
    },
    
    async depositMoney(amount) {
        try {
            EnhancedUIUpdater.showLoading('Processing deposit...');
            
            const newBalance = AppState.walletBalance + amount;
            
            await database.ref(`users/${AppState.currentUser.uid}/walletBalance`).set(newBalance);
            
            const transactionId = database.ref().child('transactions').push().key;
            const transaction = {
                id: transactionId,
                type: 'deposit',
                amount: amount,
                description: 'Wallet deposit',
                timestamp: Date.now(),
                status: 'completed',
                userId: AppState.currentUser.uid
            };
            
            await database.ref(`transactions/${transactionId}`).set(transaction);
            
            EnhancedUIUpdater.updateWalletBalance(newBalance);
            
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast(`ZMW ${amount.toFixed(2)} deposited successfully`, 'success');
            console.log('Money deposited:', transactionId);
            return true;
        } catch (error) {
            console.error('Error depositing money:', error);
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Error processing deposit', 'error');
            return false;
        }
    },
    
    async withdrawMoney(amount) {
        try {
            EnhancedUIUpdater.showLoading('Processing withdrawal...');
            
            if (AppState.walletBalance < amount) {
                throw new Error('Insufficient balance');
            }
            
            const newBalance = AppState.walletBalance - amount;
            
            await database.ref(`users/${AppState.currentUser.uid}/walletBalance`).set(newBalance);
            
            const transactionId = database.ref().child('transactions').push().key;
            const transaction = {
                id: transactionId,
                type: 'withdrawal',
                amount: amount,
                description: 'Wallet withdrawal',
                timestamp: Date.now(),
                status: 'completed',
                userId: AppState.currentUser.uid
            };
            
            await database.ref(`transactions/${transactionId}`).set(transaction);
            
            EnhancedUIUpdater.updateWalletBalance(newBalance);
            
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast(`ZMW ${amount.toFixed(2)} withdrawn successfully`, 'success');
            console.log('Money withdrawn:', transactionId);
            return true;
        } catch (error) {
            console.error('Error withdrawing money:', error);
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast(error.message, 'error');
            return false;
        }
    },
    
    async loadEmergencyStations(city, type) {
        try {
            EnhancedUIUpdater.showLoading('Loading emergency stations...');
            
            const stations = await EnhancedSearchEngine.searchEmergencyStations(type, city);
            
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showEmergencyStations(stations);
            
            console.log(`Loaded ${stations.length} ${type} stations for ${city}`);
            return stations;
        } catch (error) {
            console.error('Error loading emergency stations:', error);
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Error loading emergency stations', 'error');
            return [];
        }
    },
    
    syncUserData: async function() {
        if (AppState.isSyncing) return;
        
        try {
            AppState.isSyncing = true;
            EnhancedUIUpdater.showSyncIndicator(true);
            
            console.log('Syncing user data...');
            
            if (AppState.currentUser) {
                await this.loadUserData(AppState.currentUser.uid);
            }
            
            if (AppState.currentRide) {
                const ride = await this.loadRideDetails(AppState.currentRide.id);
                if (ride) {
                    AppState.currentRide = ride;
                    EnhancedUIUpdater.showRideInfo(ride);
                }
            }
            
            EnhancedUIUpdater.showToast('Data synced successfully', 'success');
            console.log('User data sync completed');
        } catch (error) {
            console.error('Error syncing data:', error);
            EnhancedUIUpdater.showToast('Error syncing data', 'error');
        } finally {
            AppState.isSyncing = false;
            EnhancedUIUpdater.showSyncIndicator(false);
        }
    },
    
    async findUserByReferralCode(referralCode) {
        try {
            const usersSnapshot = await database.ref('users').once('value');
            const users = usersSnapshot.val();
            
            for (const [userId, userData] of Object.entries(users)) {
                if (userData.referralCode === referralCode) {
                    return { id: userId, ...userData };
                }
            }
            
            return null;
        } catch (error) {
            console.error('Error finding user by referral code:', error);
            return null;
        }
    },
    
    async checkReferralCode(referralCode) {
        try {
            const userData = await this.findUserByReferralCode(referralCode);
            if (userData) {
                return {
                    valid: true,
                    userData: userData,
                    message: `Referral code valid. User: ${userData.name}`
                };
            } else {
                return {
                    valid: false,
                    message: 'Invalid referral code'
                };
            }
        } catch (error) {
            console.error('Error checking referral code:', error);
            return {
                valid: false,
                message: 'Error checking referral code'
            };
        }
    },
    
    async applyReferralDiscount(rideData, referralCode) {
        try {
            const checkResult = await this.checkReferralCode(referralCode);
            if (!checkResult.valid) {
                return {
                    success: false,
                    message: checkResult.message
                };
            }
            
            if (referralCode === AppState.userData.referralCode) {
                return {
                    success: false,
                    message: 'Cannot use your own referral code'
                };
            }
            
            const discountCalculation = EnhancedPriceCalculator.applyReferralDiscount(rideData.fare);
            
            AppState.referralDiscountApplied = true;
            AppState.referralDiscountAmount = discountCalculation.discountAmount;
            AppState.referralUsed = referralCode;
            
            EnhancedUIUpdater.updateReferralDiscount(
                referralCode,
                discountCalculation.discountAmount,
                discountCalculation.finalFare,
                checkResult.userData.name
            );
            
            return {
                success: true,
                message: `50% discount applied! New fare: ZMW ${discountCalculation.finalFare.toFixed(2)}`,
                discountAmount: discountCalculation.discountAmount,
                finalFare: discountCalculation.finalFare,
                referrerName: checkResult.userData.name
            };
        } catch (error) {
            console.error('Error applying referral discount:', error);
            return {
                success: false,
                message: 'Error applying referral discount'
            };
        }
    },
    
    async createShareRide(rideData) {
        try {
            EnhancedUIUpdater.showLoading('Creating share ride...');
            
            if (!rideData.pickup || !rideData.destination) {
                throw new Error('Pickup and destination locations are required');
            }
            
            if (AppState.shareRideFriends.length === 0) {
                throw new Error('Please add at least one friend to share the ride');
            }
            
            const distance = EnhancedPriceCalculator.calculateDistance(
                rideData.pickupLat, rideData.pickupLng,
                rideData.destLat, rideData.destLng
            );
            
            const totalPeople = AppState.shareRideFriends.length + 1;
            const calculation = EnhancedPriceCalculator.calculateBroadcastFare(
                distance, 
                rideData.rideType, 
                'equal', 
                totalPeople
            );
            
            const rideId = database.ref().child('rides').push().key;
            
            // Prepare share participants data
            const shareParticipantsData = [
                {
                    userId: AppState.currentUser.uid,
                    name: AppState.userData.name,
                    amount: calculation.yourShare,
                    paymentStatus: rideData.paymentMethod ? 'paid' : 'pending',
                    paymentMethod: rideData.paymentMethod
                },
                ...AppState.shareRideFriends.map(friend => ({
                    userId: friend.userId,
                    name: friend.name,
                    amount: calculation.passengerShare,
                    paymentStatus: 'pending',
                    paymentMethod: null
                }))
            ];
            
            const ride = {
                id: rideId,
                ...rideData,
                status: 'pending_share_payments',
                timestamp: Date.now(),
                updatedAt: Date.now(),
                passengerId: AppState.currentUser.uid,
                passengerName: AppState.userData.name,
                passengerPhone: AppState.userData.phone,
                city: AppState.currentCity,
                sharedRide: true,
                shareParticipants: totalPeople,
                shareParticipantsData: shareParticipantsData,
                totalFare: calculation.total,
                yourShare: calculation.yourShare,
                friendShare: calculation.passengerShare
            };
            
            await database.ref(`rides/${rideId}`).set(ride);
            
            // Send invitations to all friends
            const invitationPromises = AppState.shareRideFriends.map(async (friend) => {
                const invitationId = database.ref().child('shareInvitations').push().key;
                await database.ref(`shareInvitations/${invitationId}`).set({
                    id: invitationId,
                    rideId: rideId,
                    hostId: AppState.currentUser.uid,
                    hostName: AppState.userData.name,
                    recipientId: friend.userId,
                    recipientPhone: friend.phone,
                    pickup: rideData.pickup,
                    destination: rideData.destination,
                    distance: distance,
                    yourShare: calculation.passengerShare,
                    rideType: rideData.rideType,
                    status: 'pending',
                    timestamp: Date.now()
                });
                
                await this.sendNotification(
                    friend.userId,
                    'Share Ride Invitation',
                    `${AppState.userData.name} invited you to share a ride to ${rideData.destination}. Your share: ZMW ${calculation.passengerShare.toFixed(2)}`,
                    'share',
                    {
                        invitationId: invitationId,
                        rideId: rideId,
                        action: 'view_share_invitation'
                    }
                );
            });
            
            await Promise.all(invitationPromises);
            
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Share ride invitations sent', 'success');
            console.log('Share ride created:', rideId);
            return rideId;
        } catch (error) {
            console.error('Error creating share ride:', error);
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast(error.message, 'error');
            throw error;
        }
    },
    
    async acceptShareRideInvitation(invitationId) {
        try {
            const snapshot = await database.ref(`shareInvitations/${invitationId}`).once('value');
            const invitation = snapshot.val();
            
            if (!invitation || invitation.status !== 'pending') {
                throw new Error('Invitation not found or already processed');
            }
            
            await database.ref(`shareInvitations/${invitationId}/status`).set('accepted');
            
            const rideSnapshot = await database.ref(`rides/${invitation.rideId}`).once('value');
            const ride = rideSnapshot.val();
            
            if (ride) {
                // Update participant status
                const updatedParticipants = ride.shareParticipantsData.map(participant => {
                    if (participant.userId === AppState.currentUser.uid) {
                        return { ...participant, status: 'accepted' };
                    }
                    return participant;
                });
                
                await database.ref(`rides/${invitation.rideId}/shareParticipantsData`).set(updatedParticipants);
                
                await this.sendNotification(
                    invitation.hostId,
                    'Share Ride Accepted',
                    `${AppState.userData.name} accepted your share ride invitation`,
                    'success'
                );
                
                EnhancedUIUpdater.showToast('You have accepted the share ride invitation', 'success');
                
                // Show payment modal for the friend's share
                EnhancedUIUpdater.showPaymentRequiredModal(
                    invitation.yourShare,
                    {
                        ...ride,
                        invitationId: invitationId
                    },
                    invitation.hostName
                );
            }
        } catch (error) {
            console.error('Error accepting share ride invitation:', error);
            EnhancedUIUpdater.showToast('Error accepting invitation', 'error');
        }
    },
    
    async processFriendPayment(rideData, amount, paymentMethod) {
        try {
            // Update ride with friend's payment
            const rideSnapshot = await database.ref(`rides/${rideData.id}`).once('value');
            const ride = rideSnapshot.val();
            
            if (ride) {
                const updatedParticipants = ride.shareParticipantsData.map(participant => {
                    if (participant.userId === AppState.currentUser.uid) {
                        return {
                            ...participant,
                            paymentStatus: 'paid',
                            paymentMethod: paymentMethod,
                            paidAt: Date.now()
                        };
                    }
                    return participant;
                });
                
                await database.ref(`rides/${rideData.id}/shareParticipantsData`).set(updatedParticipants);
                
                // Check if all payments are complete
                const allPaid = updatedParticipants.every(p => p.paymentStatus === 'paid');
                if (allPaid) {
                    // Update ride status to requested
                    await database.ref(`rides/${rideData.id}/status`).set('requested');
                    await database.ref(`rides/${rideData.id}/updatedAt`).set(Date.now());
                    
                    // Notify host
                    await this.sendNotification(
                        ride.passengerId,
                        'All Payments Received',
                        'All participants have paid their shares. Your ride is now being requested.',
                        'success'
                    );
                }
                
                // Record transaction
                const transactionId = database.ref().child('transactions').push().key;
                const transaction = {
                    id: transactionId,
                    type: 'share_ride_payment',
                    amount: amount,
                    description: `Share ride payment for ${ride.pickupDisplay} to ${ride.destinationDisplay}`,
                    rideId: rideData.id,
                    hostId: ride.passengerId,
                    hostName: ride.passengerName,
                    timestamp: Date.now(),
                    status: 'completed',
                    userId: AppState.currentUser.uid
                };
                
                await database.ref(`transactions/${transactionId}`).set(transaction);
                
                return true;
            }
            
            return false;
        } catch (error) {
            console.error('Error processing friend payment:', error);
            throw error;
        }
    },
    
    async rejectShareRideInvitation(invitationId) {
        try {
            await database.ref(`shareInvitations/${invitationId}/status`).set('rejected');
            
            const snapshot = await database.ref(`shareInvitations/${invitationId}`).once('value');
            const invitation = snapshot.val();
            
            if (invitation) {
                // Update ride to remove participant
                const rideSnapshot = await database.ref(`rides/${invitation.rideId}`).once('value');
                const ride = rideSnapshot.val();
                
                if (ride) {
                    const updatedParticipants = ride.shareParticipantsData.filter(
                        p => p.userId !== AppState.currentUser.uid
                    );
                    
                    await database.ref(`rides/${invitation.rideId}/shareParticipantsData`).set(updatedParticipants);
                    await database.ref(`rides/${invitation.rideId}/shareParticipants`).set(updatedParticipants.length);
                    
                    await this.sendNotification(
                        invitation.hostId,
                        'Share Ride Rejected',
                        `${AppState.userData.name} rejected your share ride invitation`,
                        'warning'
                    );
                }
                
                EnhancedUIUpdater.showToast('You have rejected the share ride invitation', 'info');
            }
        } catch (error) {
            console.error('Error rejecting share ride invitation:', error);
            EnhancedUIUpdater.showToast('Error rejecting invitation', 'error');
        }
    }
};

// ============================================
// ENHANCED EMERGENCY SERVICE LOCATOR
// ============================================
const EnhancedEmergencyLocator = {
    async loadEmergencyStationsForCity(city) {
        try {
            EnhancedUIUpdater.showLoading('Loading emergency services...');
            
            const types = ['police', 'fire', 'medical'];
            const promises = types.map(type => 
                EnhancedSearchEngine.searchEmergencyStations(type, city)
            );
            
            const results = await Promise.all(promises);
            
            types.forEach((type, index) => {
                AppState.emergencyStations[type] = results[index];
            });
            
            EnhancedUIUpdater.hideLoading();
            console.log(`Loaded emergency stations for ${city}`);
            return AppState.emergencyStations;
        } catch (error) {
            console.error('Error loading emergency stations:', error);
            EnhancedUIUpdater.hideLoading();
            return AppState.emergencyStations;
        }
    },
    
    showEmergencyStationsOnMap: function(type) {
        emergencyMarkers.forEach(marker => map.removeLayer(marker));
        emergencyMarkers = [];
        
        const stations = AppState.emergencyStations[type];
        if (stations && stations.length > 0) {
            stations.forEach(station => {
                let iconClass = '';
                switch(type) {
                    case 'police':
                        iconClass = 'shield-alt';
                        break;
                    case 'fire':
                        iconClass = 'fire-extinguisher';
                        break;
                    case 'medical':
                        iconClass = 'ambulance';
                        break;
                }
                
                const marker = L.marker([station.lat, station.lng], {
                    icon: L.divIcon({
                        className: 'emergency-vehicle-marker',
                        html: `<i class="fas fa-${iconClass}"></i>`,
                        iconSize: [36, 36],
                        iconAnchor: [18, 36]
                    })
                }).addTo(map).bindPopup(`
                    <strong>${station.name}</strong><br>
                    ${station.address}<br>
                    Distance: ${station.distance?.toFixed(1) || '0'} km
                `);
                
                emergencyMarkers.push(marker);
            });
            
            if (emergencyMarkers.length > 0) {
                const group = new L.featureGroup(emergencyMarkers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
            
            console.log(`Displayed ${stations.length} ${type} stations on map`);
        }
    },
    
    findNearestEmergencyStation: function(type, location) {
        const stations = AppState.emergencyStations[type];
        if (!stations || !location) return null;
        
        let nearest = null;
        let minDistance = Infinity;
        
        stations.forEach(station => {
            const distance = EnhancedPriceCalculator.calculateDistance(
                location.lat, location.lng,
                station.lat, station.lng
            );
            
            if (distance < minDistance) {
                minDistance = distance;
                nearest = { ...station, distance };
            }
        });
        
        return nearest;
    },
    
    getEmergencyContactInfo: function(type) {
        const contacts = {
            'police': {
                name: 'Police Emergency',
                phone: '991',
                description: 'Police emergency services'
            },
            'fire': {
                name: 'Fire Brigade',
                phone: '992',
                description: 'Fire and rescue services'
            },
            'medical': {
                name: 'Medical Emergency',
                phone: '993',
                description: 'Ambulance and medical services'
            }
        };
        
        return contacts[type] || contacts.police;
    }
};

// ============================================
// ADVANCED CITY DETECTION AND LOCATION SERVICES
// ============================================
const CityDetector = {
    async detectCityFromLocation(lat, lng) {
        try {
            console.log(`Detecting city from location: ${lat}, ${lng}`);
            EnhancedUIUpdater.showLoading('Detecting your city...');
            
            const response = await fetch(
                `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=10&addressdetails=1`
            );
            
            if (!response.ok) {
                throw new Error('Reverse geocoding failed');
            }
            
            const data = await response.json();
            
            if (data && data.address) {
                const city = data.address.city || data.address.town || data.address.village || data.address.municipality;
                const state = data.address.state;
                
                if (city) {
                    if (this.validateCity(city)) {
                        AppState.currentCity = city;
                        AppState.detectedCity = city;
                        
                        console.log(`City detected: ${city}`);
                        
                        EnhancedUIUpdater.updateCityDisplay(city);
                        
                        EnhancedUIUpdater.showCityBoundaryOnMap(city);
                        
                        EnhancedEmergencyLocator.loadEmergencyStationsForCity(city);
                        
                        EnhancedSearchEngine.clearCache();
                        
                        this.updateCityInUI(city);
                        
                        EnhancedUIUpdater.hideLoading();
                        EnhancedUIUpdater.showToast(`Detected city: ${city}`, 'success');
                        return city;
                    } else {
                        console.log(`City ${city} not in Zambian cities list`);
                    }
                }
            }
            
            return this.useDefaultCity();
            
        } catch (error) {
            console.error('City detection error:', error);
            AppState.cityDetectionAttempts++;
            
            if (AppState.cityDetectionAttempts < AppState.maxCityDetectionAttempts) {
                setTimeout(() => {
                    this.detectCityFromLocation(lat, lng);
                }, 2000);
            } else {
                return this.useDefaultCity();
            }
            
            return null;
        }
    },
    
    validateCity: function(cityName) {
        const validCities = [
            'Lusaka', 'Ndola', 'Kitwe', 'Kabwe', 'Livingstone', 'Chipata',
            'Chingola', 'Mufulira', 'Luanshya', 'Kasama', 'Solwezi', 'Mazabuka',
            'Mongu', 'Kafue', 'Choma', 'Mumbwa', 'Kapiri Mposhi', 'Nchelenge',
            'Samfya', 'Katima Mulilo', 'Kalulushi', 'Chililabombwe'
        ];
        
        return validCities.some(validCity => 
            cityName.toLowerCase().includes(validCity.toLowerCase())
        );
    },
    
    useDefaultCity: function() {
        AppState.currentCity = 'Lusaka';
        AppState.detectedCity = 'Lusaka';
        
        console.log('Using default city: Lusaka');
        
        EnhancedUIUpdater.updateCityDisplay('Lusaka (Default)');
        EnhancedUIUpdater.showCityBoundaryOnMap('Lusaka');
        
        EnhancedEmergencyLocator.loadEmergencyStationsForCity('Lusaka');
        
        this.updateCityInUI('Lusaka');
        
        EnhancedUIUpdater.showToast('Using default city: Lusaka', 'warning');
        return 'Lusaka';
    },
    
    updateCityInUI: function(city) {
        document.querySelectorAll('.current-city').forEach(element => {
            element.textContent = city;
        });
        
        document.querySelectorAll('input[placeholder*="city"]').forEach(input => {
            input.placeholder = input.placeholder.replace(/city/i, city);
        });
        
        document.title = `Jubel Passenger - ${city}`;
    },
    
    async getDetailedAddress(lat, lng) {
        try {
            const response = await fetch(
                `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`
            );
            
            if (!response.ok) {
                throw new Error('Detailed reverse geocoding failed');
            }
            
            const data = await response.json();
            
            if (data && data.address) {
                const address = data.address;
                const parts = [];
                
                if (address.house_number || address.housenumber) {
                    parts.push(address.house_number || address.housenumber);
                }
                
                if (address.road) {
                    parts.push(address.road);
                }
                
                if (address.suburb || address.neighbourhood) {
                    parts.push(address.suburb || address.neighbourhood);
                }
                
                if (address.city || address.town) {
                    parts.push(address.city || address.town);
                }
                
                const fullAddress = parts.join(', ') || data.display_name;
                
                AppState.locationManagement.userDetectedAddress = {
                    address: fullAddress,
                    houseNumber: address.house_number || address.housenumber,
                    road: address.road,
                    suburb: address.suburb || address.neighbourhood,
                    city: address.city || address.town,
                    state: address.state,
                    fullDisplay: data.display_name,
                    lat: lat,
                    lng: lng
                };
                
                return AppState.locationManagement.userDetectedAddress;
            }
            
            return {
                address: `${lat.toFixed(6)}, ${lng.toFixed(6)}`,
                fullDisplay: `${lat.toFixed(6)}, ${lng.toFixed(6)}`,
                lat: lat,
                lng: lng
            };
        } catch (error) {
            console.error('Detailed address error:', error);
            return {
                address: `${lat.toFixed(6)}, ${lng.toFixed(6)}`,
                fullDisplay: `${lat.toFixed(6)}, ${lng.toFixed(6)}`,
                lat: lat,
                lng: lng
            };
        }
    },
    
    async detectCityFromIP() {
        try {
            console.log('Detecting city from IP address...');
            const response = await fetch('https://ipapi.co/json/');
            
            if (!response.ok) {
                throw new Error('IP geolocation failed');
            }
            
            const data = await response.json();
            
            if (data && data.city) {
                const city = data.city;
                if (this.validateCity(city)) {
                    console.log(`City detected from IP: ${city}`);
                    return city;
                }
            }
            
            return null;
        } catch (error) {
            console.error('IP city detection error:', error);
            return null;
        }
    },
    
    ensureCityDetection: async function(lat, lng) {
        let city = await this.detectCityFromLocation(lat, lng);
        
        if (!city) {
            city = await this.detectCityFromIP();
        }
        
        if (!city) {
            city = this.useDefaultCity();
        }
        
        return city;
    }
};

// ============================================
// BROADCAST RIDE MANAGER
// ============================================
const BroadcastManager = {
    async createBroadcast(rideData, recipients) {
        try {
            EnhancedUIUpdater.showLoading('Creating broadcast...');
            
            const rideId = await EnhancedFirebaseManager.requestRide({
                ...rideData,
                broadcast: true,
                broadcastRecipients: recipients
            });
            
            const broadcastId = await EnhancedFirebaseManager.startBroadcast(rideId, recipients);
            
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Broadcast ride created successfully', 'success');
            
            console.log('Broadcast created:', { rideId, broadcastId });
            return { rideId, broadcastId };
        } catch (error) {
            console.error('Error creating broadcast:', error);
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Error creating broadcast', 'error');
            throw error;
        }
    },
    
    async addRecipientToBroadcast(broadcastId, recipientPhone, recipientName = '') {
        try {
            const snapshot = await database.ref(`broadcasts/${broadcastId}`).once('value');
            const broadcast = snapshot.val();
            
            if (!broadcast) {
                throw new Error('Broadcast not found');
            }
            
            const existingRecipient = broadcast.recipients.find(r => r.phone === recipientPhone);
            if (existingRecipient) {
                throw new Error('Recipient already added');
            }
            
            const updatedRecipients = [
                ...broadcast.recipients,
                {
                    phone: recipientPhone,
                    name: recipientName,
                    status: 'pending'
                }
            ];
            
            await database.ref(`broadcasts/${broadcastId}/recipients`).set(updatedRecipients);
            
            const recipient = await this.findUserByPhone(recipientPhone);
            if (recipient) {
                await EnhancedFirebaseManager.sendNotification(
                    recipient.id,
                    'Ride Broadcast Invitation',
                    `${broadcast.hostName} has invited you to join their ride`,
                    'broadcast',
                    { 
                        broadcastId: broadcastId,
                        rideId: broadcast.rideId,
                        action: 'accept_broadcast'
                    }
                );
            }
            
            EnhancedUIUpdater.showToast('Recipient added to broadcast', 'success');
            return true;
        } catch (error) {
            console.error('Error adding recipient:', error);
            EnhancedUIUpdater.showToast(error.message, 'error');
            return false;
        }
    },
    
    async findUserByPhone(phoneNumber) {
        try {
            const usersSnapshot = await database.ref('users').once('value');
            const users = usersSnapshot.val();
            
            for (const [userId, userData] of Object.entries(users)) {
                if (userData.phone === phoneNumber) {
                    return { id: userId, ...userData };
                }
            }
            
            return null;
        } catch (error) {
            console.error('Error finding user by phone:', error);
            return null;
        }
    },
    
    async joinBroadcast(broadcastId) {
        try {
            EnhancedUIUpdater.showLoading('Joining broadcast...');
            
            await EnhancedFirebaseManager.acceptBroadcastInvitation(broadcastId);
            
            EnhancedUIUpdater.hideLoading();
            return true;
        } catch (error) {
            console.error('Error joining broadcast:', error);
            EnhancedUIUpdater.hideLoading();
            return false;
        }
    },
    
    async leaveBroadcast(broadcastId) {
        try {
            const snapshot = await database.ref(`broadcasts/${broadcastId}`).once('value');
            const broadcast = snapshot.val();
            
            if (!broadcast) return;
            
            const updatedRecipients = broadcast.recipients.map(recipient => {
                if (recipient.phone === AppState.userData.phone) {
                    return { ...recipient, status: 'left' };
                }
                return recipient;
            });
            
            await database.ref(`broadcasts/${broadcastId}/recipients`).set(updatedRecipients);
            
            await EnhancedFirebaseManager.sendNotification(
                broadcast.hostId,
                'Broadcast Ride Left',
                `${AppState.userData.name} has left your broadcast ride`,
                'info'
            );
            
            EnhancedUIUpdater.showToast('You have left the broadcast ride', 'success');
            return true;
        } catch (error) {
            console.error('Error leaving broadcast:', error);
            EnhancedUIUpdater.showToast('Error leaving broadcast', 'error');
            return false;
        }
    },
    
    async endBroadcast(broadcastId) {
        try {
            await database.ref(`broadcasts/${broadcastId}/status`).set('ended');
            
            AppState.activeBroadcast = null;
            EnhancedUIUpdater.updateBroadcastStatus(false);
            
            EnhancedUIUpdater.showToast('Broadcast ended', 'success');
            return true;
        } catch (error) {
            console.error('Error ending broadcast:', error);
            EnhancedUIUpdater.showToast('Error ending broadcast', 'error');
            return false;
        }
    },
    
    updateBroadcastUI: function(broadcast) {
        if (!broadcast) return;
        
        document.getElementById('broadcastFeature').style.display = 'block';
        EnhancedUIUpdater.updateBroadcastStatus(broadcast.status === 'active');
        EnhancedUIUpdater.updateBroadcastRecipients(broadcast.recipients);
    }
};

// ============================================
// ENHANCED NOTIFICATION MANAGER
// ============================================
const NotificationManager = {
    async checkForScheduledNotifications() {
        try {
            const snapshot = await database.ref('scheduledNotifications')
                .orderByChild('timestamp')
                .startAt(Date.now() - 60000)
                .endAt(Date.now() + 60000)
                .once('value');
            
            const notifications = snapshot.val();
            if (notifications) {
                Object.entries(notifications).forEach(([id, notification]) => {
                    if (notification.userId === AppState.currentUser?.uid && notification.status === 'pending') {
                        EnhancedFirebaseManager.sendNotification(
                            notification.userId,
                            notification.title,
                            notification.message,
                            'info'
                        );
                        
                        database.ref(`scheduledNotifications/${id}/status`).set('sent');
                        
                        console.log('Scheduled notification sent:', id);
                    }
                });
            }
        } catch (error) {
            console.error('Error checking scheduled notifications:', error);
        }
    },
    
    requestNotificationPermission: async function() {
        if (!("Notification" in window)) {
            console.log("This browser does not support desktop notification");
            return false;
        }
        
        if (Notification.permission === "granted") {
            console.log('Notification permission already granted');
            return true;
        } else if (Notification.permission !== "denied") {
            const permission = await Notification.requestPermission();
            console.log('Notification permission:', permission);
            return permission === "granted";
        }
        
        return false;
    },
    
    showDesktopNotification: function(title, message) {
        if (Notification.permission === "granted") {
            new Notification(title, {
                body: message,
                icon: 'jubel.png'
            });
            console.log('Desktop notification shown:', title);
        }
    },
    
    schedulePeriodicChecks: function() {
        setInterval(() => {
            this.checkForScheduledNotifications();
        }, 60000);
        
        setInterval(() => {
            if (AppState.currentRide) {
                EnhancedFirebaseManager.syncUserData();
            }
        }, 30000);
        
        console.log('Periodic checks scheduled');
    }
};

// ============================================
// INITIALIZATION
// ============================================
async function initializeApp() {
    try {
        console.log('Initializing Jubel Passenger App...');
        EnhancedUIUpdater.showLoading('Initializing app...');
        
        EnhancedSearchEngine.init();
        
        EnhancedLocationManager.init();
        
        RideTypeManager.init();
        
        const urlParams = new URLSearchParams(window.location.search);
        const email = urlParams.get('email');
        const uid = urlParams.get('uid');
        
        if (email && uid) {
            console.log('Authenticated via URL parameters');
            AppState.currentUser = { uid, email };
            await EnhancedFirebaseManager.loadUserData(uid);
        } else {
            console.log('Checking Firebase auth state...');
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    console.log('User authenticated:', user.uid);
                    AppState.currentUser = user;
                    await EnhancedFirebaseManager.loadUserData(user.uid);
                } else {
                    console.log('No user logged in, redirecting to signup');
                    window.location.href = 'signup.html';
                }
            });
        }
        
        initializeMap();
        
        setupEventListeners();
        
        getCurrentLocation();
        
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('scheduleDate').min = today;
        
        initializeShoppingItems();
        
        await NotificationManager.requestNotificationPermission();
        
        NotificationManager.schedulePeriodicChecks();
        
        AppState.syncInterval = setInterval(() => {
            EnhancedFirebaseManager.syncUserData();
        }, 60000);
        
        EnhancedUIUpdater.hideLoading();
        EnhancedUIUpdater.showToast('Jubel Passenger App Ready', 'success');
        console.log('App initialization completed successfully');
        
    } catch (error) {
        console.error('Error initializing app:', error);
        EnhancedUIUpdater.hideLoading();
        EnhancedUIUpdater.showToast('Error initializing app', 'error');
    }
}

function initializeMap() {
    console.log('Initializing map...');
    const defaultLat = -15.4167;
    const defaultLng = 28.2833;
    
    map = L.map('map').setView([defaultLat, defaultLng], 13);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: ' OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(map);
    
    L.control.scale().addTo(map);
    
    EnhancedUIUpdater.hideMapLoading();
    console.log('Map initialized');
}

function initializeShoppingItems() {
    console.log('Initializing shopping items...');
    const itemsContainer = document.getElementById('shoppingItems');
    const addItemBtn = document.getElementById('addItemBtn');
    
    if (!itemsContainer || !addItemBtn) {
        console.warn('Shopping items elements not found');
        return;
    }
    
    const firstItem = itemsContainer.querySelector('.item-entry');
    if (firstItem) {
        const removeBtn = firstItem.querySelector('.remove-item');
        if (removeBtn) {
            removeBtn.addEventListener('click', function() {
                if (itemsContainer.children.length > 1) {
                    firstItem.remove();
                }
            });
        }
    }
    
    addItemBtn.addEventListener('click', function() {
        const itemEntry = document.createElement('div');
        itemEntry.className = 'item-entry';
        itemEntry.innerHTML = `
            <input type="text" class="item-input" placeholder="Item name">
            <button class="remove-item" type="button">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        itemsContainer.appendChild(itemEntry);
        
        const removeBtn = itemEntry.querySelector('.remove-item');
        removeBtn.addEventListener('click', function() {
            itemEntry.remove();
        });
    });
    
    console.log('Shopping items initialized');
}

async function getCurrentLocation() {
    if (!navigator.geolocation) {
        console.warn('Geolocation is not supported by your browser');
        EnhancedUIUpdater.showToast('Geolocation is not supported by your browser', 'warning');
        return;
    }
    
    console.log('Getting current location...');
    EnhancedUIUpdater.showLoading('Getting your location...');
    
    try {
        const position = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            });
        });
        
        const { latitude, longitude } = position.coords;
        console.log(`Location obtained: ${latitude}, ${longitude}`);
        
        AppState.userLocation = { lat: latitude, lng: longitude };
        
        map.setView([latitude, longitude], 15);
        
        currentLocationMarker = L.marker([latitude, longitude], {
            icon: L.divIcon({
                className: 'current-location-marker',
                html: '<i class="fas fa-user"></i>',
                iconSize: [18, 18],
                iconAnchor: [9, 18]
            })
        }).addTo(map).bindPopup('Your Location');
        
        const detailedAddress = await CityDetector.getDetailedAddress(latitude, longitude);
        console.log('Detailed address:', detailedAddress);
        
        const addressInputs = [
            'pickupLocation', 'deliveryPickup', 'shortDeliveryPickup', 
            'truckPickup', 'schedulePickup', 'someonePickup',
            'sharePickup', 'broadcastPickup'
        ];
        
        addressInputs.forEach(inputId => {
            const input = document.getElementById(inputId);
            if (input) {
                input.value = detailedAddress.address;
                input.dataset.lat = latitude;
                input.dataset.lng = longitude;
                
                EnhancedLocationManager.updatePickupInputButtons(inputId);
            }
        });
        
        document.getElementById('emergencyUserLocation').textContent = detailedAddress.fullDisplay;
        
        AppState.pickup = {
            lat: latitude,
            lng: longitude,
            address: detailedAddress.address,
            name: 'Current Location',
            fullDisplay: detailedAddress.fullDisplay
        };
        
        const city = await CityDetector.detectCityFromLocation(latitude, longitude);
        console.log(`City detected: ${city}`);
        
        EnhancedUIUpdater.hideLoading();
        EnhancedUIUpdater.showToast('Location detected successfully', 'success');
        
    } catch (error) {
        console.error('Geolocation error:', error);
        EnhancedUIUpdater.hideLoading();
        EnhancedUIUpdater.showToast('Unable to get your location. Using default location.', 'warning');
        
        AppState.userLocation = { lat: -15.4167, lng: 28.2833 };
        map.setView([-15.4167, 28.2833], 13);
        
        CityDetector.useDefaultCity();
    }
}

// ============================================
// EVENT HANDLERS SETUP
// ============================================
function setupEventListeners() {
    console.log('Setting up event listeners...');
    
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const screen = tab.dataset.screen;
            switchScreen(screen);
        });
    });
    
    document.querySelectorAll('.back-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            switchScreen('home');
        });
    });
    
    document.getElementById('panelHandle').addEventListener('click', togglePanel);
    
    document.querySelectorAll('.service-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const service = tab.dataset.service;
            switchService(service);
        });
    });
    
    document.getElementById('locateMeBtn')?.addEventListener('click', () => {
        if (AppState.userLocation) {
            map.setView([AppState.userLocation.lat, AppState.userLocation.lng], 15);
            EnhancedUIUpdater.showToast('Centered on your location', 'info');
        } else {
            getCurrentLocation();
        }
    });
    
    document.getElementById('zoomInBtn')?.addEventListener('click', () => {
        map.zoomIn();
    });
    
    document.getElementById('zoomOutBtn')?.addEventListener('click', () => {
        map.zoomOut();
    });
    
    document.getElementById('clearRouteBtn')?.addEventListener('click', () => {
        if (routeLayer) {
            map.removeLayer(routeLayer);
            routeLayer = null;
        }
        
        if (destinationMarker) {
            map.removeLayer(destinationMarker);
            destinationMarker = null;
        }
        
        const destinationInput = document.getElementById('destinationLocation');
        if (destinationInput) {
            destinationInput.value = '';
        }
        AppState.destination = null;
        
        EnhancedLocationManager.clearAllStops();
        
        EnhancedUIUpdater.showToast('Route cleared', 'info');
    });
    
    document.getElementById('requestRideBtn')?.addEventListener('click', async () => {
        if (!AppState.pickup || !AppState.destination) {
            EnhancedUIUpdater.showToast('Please select pickup and destination locations', 'warning');
            return;
        }
        
        if (!EnhancedSearchEngine.validateCoordinatesInCity(
            AppState.pickup.lat, AppState.pickup.lng, AppState.currentCity
        ) || !EnhancedSearchEngine.validateCoordinatesInCity(
            AppState.destination.lat, AppState.destination.lng, AppState.currentCity
        )) {
            EnhancedUIUpdater.showToast('Locations must be within city boundaries', 'warning');
            return;
        }
        
        // Calculate distance with stops
        let distance;
        if (AppState.stops.length > 0) {
            const validStops = AppState.stops.filter(stop => stop.location);
            distance = EnhancedPriceCalculator.calculateDistanceWithStops(
                AppState.pickup,
                validStops,
                AppState.destination
            );
        } else {
            distance = EnhancedPriceCalculator.calculateDistance(
                AppState.pickup.lat, AppState.pickup.lng,
                AppState.destination.lat, AppState.destination.lng
            );
        }
        
        if (distance < 0.5) {
            EnhancedUIUpdater.showToast('Minimum ride distance is 0.5 km', 'warning');
            return;
        }
        
        const validation = EnhancedPriceCalculator.validateDistanceWithinCity(
            AppState.pickup.lat, AppState.pickup.lng,
            AppState.destination.lat, AppState.destination.lng,
            AppState.currentCity
        );
        
        if (!validation.valid) {
            EnhancedUIUpdater.showToast(validation.message, 'warning');
            return;
        }
        
        const surge = EnhancedPriceCalculator.getSurgeMultiplier();
        const fare = EnhancedPriceCalculator.calculateRideFare(distance, AppState.selectedRideType, surge);
        
        // Prepare ride data with stops
        const rideData = {
            pickup: AppState.pickup.address,
            pickupDisplay: AppState.pickup.fullDisplay || AppState.pickup.name,
            destination: AppState.destination.address,
            destinationDisplay: AppState.destination.fullAddress || AppState.destination.name,
            pickupLat: AppState.pickup.lat,
            pickupLng: AppState.pickup.lng,
            destLat: AppState.destination.lat,
            destLng: AppState.destination.lng,
            rideType: AppState.selectedRideType,
            fare: fare,
            distance: distance,
            stops: AppState.stops
                .filter(stop => stop.location)
                .map(stop => ({
                    address: stop.address,
                    name: stop.location.name,
                    lat: stop.location.lat,
                    lng: stop.location.lng
                }))
        };
        
        showPaymentModal('car', fare, rideData);
    });
    
    document.getElementById('requestDeliveryBtn')?.addEventListener('click', async () => {
        const pickupInput = document.getElementById('deliveryPickup');
        const destinationInput = document.getElementById('deliveryDestination');
        const parcelDesc = document.getElementById('parcelDescription');
        const receiverName = document.getElementById('receiverName');
        const receiverPhone = document.getElementById('receiverPhone');
        const parcelValue = document.getElementById('parcelValue');
        
        if (!pickupInput?.value || !destinationInput?.value || !parcelDesc?.value || 
            !receiverName?.value || !receiverPhone?.value) {
            EnhancedUIUpdater.showToast('Please fill all required fields', 'warning');
            return;
        }
        
        if (!AppState.pickup || !AppState.destination) {
            EnhancedUIUpdater.showToast('Please select valid pickup and delivery locations', 'warning');
            return;
        }
        
        if (!EnhancedSearchEngine.validateCoordinatesInCity(
            AppState.pickup.lat, AppState.pickup.lng, AppState.currentCity
        ) || !EnhancedSearchEngine.validateCoordinatesInCity(
            AppState.destination.lat, AppState.destination.lng, AppState.currentCity
        )) {
            EnhancedUIUpdater.showToast('Locations must be within city boundaries', 'warning');
            return;
        }
        
        const distance = EnhancedPriceCalculator.calculateDistance(
            AppState.pickup.lat, AppState.pickup.lng,
            AppState.destination.lat, AppState.destination.lng
        );
        
        let deliveryType = 'standard';
        if (document.getElementById('expressDelivery')?.classList.contains('active')) {
            deliveryType = 'express';
        } else if (document.getElementById('sameDayDelivery')?.classList.contains('active')) {
            deliveryType = 'sameDay';
        }
        
        const fare = EnhancedPriceCalculator.calculateDeliveryFare(
            distance, 
            deliveryType, 
            parseFloat(parcelValue?.value) || 0
        );
        
        showPaymentModal('delivery', fare, {
            pickup: AppState.pickup.address,
            pickupDisplay: AppState.pickup.fullDisplay || AppState.pickup.name,
            destination: AppState.destination.address,
            destinationDisplay: AppState.destination.fullAddress || AppState.destination.name,
            pickupLat: AppState.pickup.lat,
            pickupLng: AppState.pickup.lng,
            destLat: AppState.destination.lat,
            destLng: AppState.destination.lng,
            parcelDescription: parcelDesc.value,
            receiverName: receiverName.value,
            receiverPhone: receiverPhone.value,
            parcelValue: parseFloat(parcelValue?.value) || 0,
            deliveryType: deliveryType,
            fare: fare,
            distance: distance,
            serviceType: 'delivery'
        });
    });
    
    document.getElementById('requestTruckBtn')?.addEventListener('click', async () => {
        const pickupInput = document.getElementById('truckPickup');
        const destinationInput = document.getElementById('truckDestination');
        const itemDesc = document.getElementById('truckItemDescription');
        const estimatedWeight = document.getElementById('estimatedWeight');
        const needHelpers = document.getElementById('needHelpers')?.checked;
        
        if (!pickupInput?.value || !destinationInput?.value || !itemDesc?.value || !estimatedWeight?.value) {
            EnhancedUIUpdater.showToast('Please fill all required fields', 'warning');
            return;
        }
        
        if (!AppState.pickup || !AppState.destination) {
            EnhancedUIUpdater.showToast('Please select valid pickup and destination locations', 'warning');
            return;
        }
        
        if (!EnhancedSearchEngine.validateCoordinatesInCity(
            AppState.pickup.lat, AppState.pickup.lng, AppState.currentCity
        ) || !EnhancedSearchEngine.validateCoordinatesInCity(
            AppState.destination.lat, AppState.destination.lng, AppState.currentCity
        )) {
            EnhancedUIUpdater.showToast('Locations must be within city boundaries', 'warning');
            return;
        }
        
        const distance = EnhancedPriceCalculator.calculateDistance(
            AppState.pickup.lat, AppState.pickup.lng,
            AppState.destination.lat, AppState.destination.lng
        );
        
        const selectedTruck = document.querySelector('.truck-type.selected');
        const truckType = selectedTruck ? selectedTruck.dataset.type : 'light';
        
        const fare = EnhancedPriceCalculator.calculateTruckFare(distance, truckType, needHelpers);
        
        showPaymentModal('truck', fare, {
            pickup: AppState.pickup.address,
            pickupDisplay: AppState.pickup.fullDisplay || AppState.pickup.name,
            destination: AppState.destination.address,
            destinationDisplay: AppState.destination.fullAddress || AppState.destination.name,
            pickupLat: AppState.pickup.lat,
            pickupLng: AppState.pickup.lng,
            destLat: AppState.destination.lat,
            destLng: AppState.destination.lng,
            truckType: truckType,
            itemDescription: itemDesc.value,
            estimatedWeight: parseFloat(estimatedWeight.value) || 0,
            needHelpers: needHelpers,
            fare: fare,
            distance: distance,
            serviceType: 'truck'
        });
    });
    
    document.getElementById('requestShoppingBtn')?.addEventListener('click', async () => {
        const shopName = document.getElementById('shopName');
        const shopLocation = document.getElementById('shopLocation');
        const destinationInput = document.getElementById('shoppingDestination');
        const instructions = document.getElementById('shoppingInstructions');
        const budget = document.getElementById('shoppingBudget');
        
        if (!shopName?.value || !shopLocation?.value || !destinationInput?.value) {
            EnhancedUIUpdater.showToast('Please fill all required fields', 'warning');
            return;
        }
        
        if (!AppState.destination) {
            EnhancedUIUpdater.showToast('Please select a valid delivery location', 'warning');
            return;
        }
        
        if (!EnhancedSearchEngine.validateCoordinatesInCity(
            AppState.destination.lat, AppState.destination.lng, AppState.currentCity
        )) {
            EnhancedUIUpdater.showToast('Delivery location must be within city boundaries', 'warning');
            return;
        }
        
        const distance = AppState.shopLocation ? 
            EnhancedPriceCalculator.calculateDistance(
                AppState.shopLocation.lat, AppState.shopLocation.lng,
                AppState.destination.lat, AppState.destination.lng
            ) : 5;
        
        const itemsCount = document.querySelectorAll('.item-input').length;
        
        const fare = EnhancedPriceCalculator.calculateShoppingFare(
            distance, 
            itemsCount, 
            parseFloat(budget?.value) || 0
        );
        
        showPaymentModal('shopping', fare, {
            shopName: shopName.value,
            shopLocation: shopLocation.value,
            shopLat: AppState.shopLocation?.lat,
            shopLng: AppState.shopLocation?.lng,
            destination: AppState.destination.address,
            destinationDisplay: AppState.destination.fullAddress || AppState.destination.name,
            destLat: AppState.destination.lat,
            destLng: AppState.destination.lng,
            items: Array.from(document.querySelectorAll('.item-input')).map(input => input.value),
            itemsCount: itemsCount,
            instructions: instructions?.value || '',
            estimatedBudget: parseFloat(budget?.value) || 0,
            fare: fare,
            distance: distance,
            serviceType: 'shopping'
        });
    });
    
    document.getElementById('requestShortDeliveryBtn')?.addEventListener('click', async () => {
        const pickupInput = document.getElementById('shortDeliveryPickup');
        const destinationInput = document.getElementById('shortDeliveryDestination');
        const parcelDesc = document.getElementById('shortParcelDescription');
        const receiverPhone = document.getElementById('shortReceiverPhone');
        
        if (!pickupInput?.value || !destinationInput?.value || !parcelDesc?.value || !receiverPhone?.value) {
            EnhancedUIUpdater.showToast('Please fill all required fields', 'warning');
            return;
        }
        
        if (!AppState.pickup || !AppState.destination) {
            EnhancedUIUpdater.showToast('Please select valid pickup and delivery locations', 'warning');
            return;
        }
        
        if (!EnhancedSearchEngine.validateCoordinatesInCity(
            AppState.pickup.lat, AppState.pickup.lng, AppState.currentCity
        ) || !EnhancedSearchEngine.validateCoordinatesInCity(
            AppState.destination.lat, AppState.destination.lng, AppState.currentCity
        )) {
            EnhancedUIUpdater.showToast('Locations must be within city boundaries', 'warning');
            return;
        }
        
        const distance = EnhancedPriceCalculator.calculateDistance(
            AppState.pickup.lat, AppState.pickup.lng,
            AppState.destination.lat, AppState.destination.lng
        );
        
        const fare = Math.max(15, distance * 2.5);
        
        showPaymentModal('short-delivery', fare, {
            pickup: AppState.pickup.address,
            pickupDisplay: AppState.pickup.fullDisplay || AppState.pickup.name,
            destination: AppState.destination.address,
            destinationDisplay: AppState.destination.fullAddress || AppState.destination.name,
            pickupLat: AppState.pickup.lat,
            pickupLng: AppState.pickup.lng,
            destLat: AppState.destination.lat,
            destLng: AppState.destination.lng,
            parcelDescription: parcelDesc.value,
            receiverPhone: receiverPhone.value,
            fare: fare,
            distance: distance,
            serviceType: 'short-delivery'
        });
    });
    
    document.getElementById('moreOptionsBtn')?.addEventListener('click', () => {
        const menu = document.getElementById('moreOptionsMenu');
        menu.classList.toggle('active');
    });
    
    document.getElementById('broadcastRideBtn')?.addEventListener('click', () => {
        switchService('broadcast');
        document.getElementById('moreOptionsMenu').classList.remove('active');
    });
    
    document.getElementById('sosSetupBtn')?.addEventListener('click', () => {
        showModal('sos');
        document.getElementById('moreOptionsMenu').classList.remove('active');
    });
    
    document.getElementById('recentDestinationsBtn')?.addEventListener('click', () => {
        EnhancedUIUpdater.showSearchHistory('destinationLocation');
        document.getElementById('moreOptionsMenu').classList.remove('active');
    });
    
    document.querySelectorAll('#moreOptionsMenu .dropdown-item').forEach(item => {
        item.addEventListener('click', () => {
            const option = item.dataset.option;
            handleMoreOptionSelection(option);
        });
    });
    
    document.getElementById('cancelRideBtn')?.addEventListener('click', () => {
        if (AppState.currentRide) {
            showModal('cancel');
        } else {
            EnhancedUIUpdater.showToast('No active ride to cancel', 'warning');
        }
    });
    
    document.getElementById('contactDriverBtn')?.addEventListener('click', () => {
        if (AppState.currentRide?.driverId) {
            const driverPhone = AppState.selectedVehicle?.phone;
            if (driverPhone) {
                window.open(`tel:${driverPhone}`, '_blank');
            } else {
                EnhancedUIUpdater.showToast('Driver phone number not available', 'warning');
            }
        } else {
            EnhancedUIUpdater.showToast('No driver assigned yet', 'warning');
        }
    });
    
    document.getElementById('openChatBtn')?.addEventListener('click', () => {
        if (AppState.currentRide?.driverId) {
            document.getElementById('chatContainer').classList.add('active');
        } else {
            EnhancedUIUpdater.showToast('No driver assigned yet', 'warning');
        }
    });
    
    document.getElementById('sosButton')?.addEventListener('click', () => {
        triggerSOS();
    });
    
    document.getElementById('chatClose')?.addEventListener('click', () => {
        document.getElementById('chatContainer').classList.remove('active');
    });
    
    document.getElementById('chatSend')?.addEventListener('click', async () => {
        const input = document.getElementById('chatInput');
        const message = input?.value.trim();
        
        if (message && AppState.currentRide) {
            try {
                await EnhancedFirebaseManager.sendChatMessage(AppState.currentRide.id, message, false);
                input.value = '';
            } catch (error) {
                EnhancedUIUpdater.showToast('Error sending message', 'error');
            }
        }
    });
    
    const chatInput = document.getElementById('chatInput');
    if (chatInput) {
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('chatSend').click();
            }
        });
        
        chatInput.addEventListener('input', () => {
            if (AppState.currentRide) {
                EnhancedFirebaseManager.updateTypingStatus(AppState.currentRide.id, true, false);
                
                clearTimeout(AppState.typingTimeout);
                
                AppState.typingTimeout = setTimeout(() => {
                    EnhancedFirebaseManager.updateTypingStatus(AppState.currentRide.id, false, false);
                }, 2000);
            }
        });
    }
    
    document.querySelectorAll('.emergency-service').forEach(service => {
        service.addEventListener('click', () => {
            const type = service.dataset.type;
            
            if (type === 'sos') {
                showModal('sos');
            } else {
                handleEmergencyService(type);
            }
        });
    });
    
    document.querySelectorAll('.emergency-reason').forEach(reason => {
        reason.addEventListener('click', () => {
            document.querySelectorAll('.emergency-reason').forEach(r => {
                r.classList.remove('selected');
            });
            
            reason.classList.add('selected');
            
            EnhancedUIUpdater.updateEmergencyReason(reason.dataset.reason);
        });
    });
    
    document.querySelectorAll('.modal-close').forEach(btn => {
        btn.addEventListener('click', () => {
            const modal = btn.dataset.modal;
            hideModal(modal);
        });
    });
    
    document.querySelectorAll('.cancel-reason[data-reason]').forEach(reason => {
        reason.addEventListener('click', () => {
            document.querySelectorAll('.cancel-reason').forEach(r => {
                r.classList.remove('selected');
            });
            
            reason.classList.add('selected');
            
            const reasonType = reason.dataset.reason;
            const otherReasonGroup = document.getElementById('otherReasonGroup');
            if (otherReasonGroup) {
                otherReasonGroup.style.display = 
                    reasonType === 'other' ? 'block' : 'none';
            }
        });
    });
    
    document.getElementById('confirmCancelBtn')?.addEventListener('click', async () => {
        const selectedReason = document.querySelector('.cancel-reason.selected');
        if (!selectedReason) {
            EnhancedUIUpdater.showToast('Please select a cancellation reason', 'warning');
            return;
        }
        
        let reason = selectedReason.dataset.reason;
        if (reason === 'other') {
            const otherReason = document.getElementById('otherReason')?.value.trim();
            if (!otherReason) {
                EnhancedUIUpdater.showToast('Please specify your reason', 'warning');
                return;
            }
            reason = `other: ${otherReason}`;
        }
        
        if (AppState.currentRide) {
            try {
                await EnhancedFirebaseManager.cancelRide(AppState.currentRide.id, reason);
                hideModal('cancel');
            } catch (error) {
                EnhancedUIUpdater.showToast('Error cancelling ride', 'error');
            }
        }
    });
    
    document.querySelectorAll('.payment-method').forEach(method => {
        method.addEventListener('click', () => {
            document.querySelectorAll('.payment-method').forEach(m => {
                m.classList.remove('selected');
            });
            method.classList.add('selected');
        });
    });
    
    document.getElementById('applyReferralBtn')?.addEventListener('click', async () => {
        const referralCode = document.getElementById('referralCodeInput').value.trim();
        if (!referralCode) {
            EnhancedUIUpdater.showToast('Please enter a referral code', 'warning');
            return;
        }
        
        const selectedMethod = document.querySelector('.payment-method.selected');
        if (!selectedMethod) {
            EnhancedUIUpdater.showToast('Please select a payment method first', 'warning');
            return;
        }
        
        const amount = parseFloat(document.getElementById('paymentAmount').textContent.replace('ZMW ', ''));
        const rideData = window.pendingRideData;
        
        if (!rideData) {
            EnhancedUIUpdater.showToast('No ride data found', 'error');
            return;
        }
        
        EnhancedUIUpdater.showLoading('Applying referral discount...');
        
        const result = await EnhancedFirebaseManager.applyReferralDiscount(rideData, referralCode);
        
        EnhancedUIUpdater.hideLoading();
        
        if (result.success) {
            EnhancedUIUpdater.showToast(result.message, 'success');
            document.getElementById('paymentAmount').textContent = `ZMW ${result.finalFare.toFixed(2)}`;
            rideData.fare = result.finalFare;
            rideData.referredBy = referralCode;
            rideData.referrerName = result.referrerName;
            rideData.discountAmount = result.discountAmount;
            window.pendingRideData = rideData;
        } else {
            EnhancedUIUpdater.showToast(result.message, 'error');
        }
    });
    
    document.getElementById('confirmPaymentBtn')?.addEventListener('click', async () => {
        const selectedMethod = document.querySelector('.payment-method.selected');
        if (!selectedMethod) {
            EnhancedUIUpdater.showToast('Please select a payment method', 'warning');
            return;
        }
        
        const paymentMethod = selectedMethod.dataset.payment;
        let amount = parseFloat(document.getElementById('paymentAmount').textContent.replace('ZMW ', ''));
        
        const rideData = window.pendingRideData;
        if (!rideData) {
            EnhancedUIUpdater.showToast('No ride data found', 'error');
            return;
        }
        
        if (paymentMethod === 'wallet' && AppState.walletBalance < amount) {
            EnhancedUIUpdater.showToast('Insufficient wallet balance', 'error');
            return;
        }
        
        rideData.paymentMethod = paymentMethod;
        rideData.fare = amount;
        
        try {
            if (paymentMethod === 'wallet') {
                const transactionId = database.ref().child('transactions').push().key;
                const transaction = {
                    id: transactionId,
                    senderId: AppState.currentUser.uid,
                    senderName: AppState.userData.name,
                    recipientId: 'system',
                    recipientName: 'Ride Payment',
                    amount: amount,
                    message: `Payment for ${rideData.serviceType || 'ride'} to ${rideData.destination}`,
                    timestamp: Date.now(),
                    type: 'ride_payment',
                    status: 'completed',
                    rideId: 'pending',
                    userId: AppState.currentUser.uid
                };
                
                await database.ref(`transactions/${transactionId}`).set(transaction);
                
                await EnhancedFirebaseManager.withdrawMoney(amount);
            }
            
            let rideId;
            if (rideData.serviceType === 'delivery' || rideData.serviceType === 'short-delivery') {
                rideId = await EnhancedFirebaseManager.requestDelivery(rideData);
            } else if (rideData.serviceType === 'truck') {
                rideId = await EnhancedFirebaseManager.requestTruck(rideData);
            } else if (rideData.serviceType === 'shopping') {
                rideId = await EnhancedFirebaseManager.requestShopping(rideData);
            } else if (rideData.sharedRide) {
                rideId = await EnhancedFirebaseManager.createShareRide(rideData);
            } else if (rideData.broadcast) {
                const result = await BroadcastManager.createBroadcast(rideData, rideData.broadcastRecipients);
                rideId = result.rideId;
            } else if (rideData.scheduled) {
                rideId = await EnhancedFirebaseManager.scheduleRide(rideData);
                AppState.pendingPaymentRide = rideData;
                AppState.pendingPaymentRide.scheduledRideId = rideId;
            } else {
                rideId = await EnhancedFirebaseManager.requestRide(rideData);
            }
            
            if (rideId && paymentMethod === 'wallet') {
                await database.ref(`transactions`).orderByChild('rideId').equalTo('pending').once('value', (snapshot) => {
                    snapshot.forEach(child => {
                        database.ref(`transactions/${child.key}/rideId`).set(rideId);
                    });
                });
            }
            
            hideModal('payment');
            delete window.pendingRideData;
            
            if (rideData.scheduled) {
                EnhancedUIUpdater.showToast('Ride scheduled successfully', 'success');
            } else {
                EnhancedUIUpdater.showToast('Ride requested successfully', 'success');
            }
            
        } catch (error) {
            console.error('Error processing payment:', error);
            EnhancedUIUpdater.showToast('Error processing payment', 'error');
            
            if (paymentMethod === 'wallet') {
                await EnhancedFirebaseManager.depositMoney(amount);
            }
        }
    });
    
    document.getElementById('confirmEmergencyBtn')?.addEventListener('click', async () => {
        if (!AppState.selectedEmergencyStation) {
            EnhancedUIUpdater.showToast('Please select an emergency station', 'warning');
            return;
        }
        
        const emergencyType = document.getElementById('emergencyServiceType')?.dataset.type;
        const selectedReason = document.querySelector('.emergency-reason.selected');
        
        if (!selectedReason) {
            EnhancedUIUpdater.showToast('Please select an emergency reason', 'warning');
            return;
        }
        
        let reason = selectedReason.dataset.reason;
        if (reason === 'other') {
            const otherReason = document.getElementById('emergencyOtherReason')?.value.trim();
            if (!otherReason) {
                EnhancedUIUpdater.showToast('Please describe the emergency', 'warning');
                return;
            }
            reason = otherReason;
        }
        
        if (!EnhancedSearchEngine.validateCoordinatesInCity(
            AppState.selectedEmergencyStation.lat, 
            AppState.selectedEmergencyStation.lng, 
            AppState.currentCity
        )) {
            EnhancedUIUpdater.showToast('Selected station is not within city boundaries', 'warning');
            return;
        }
        
        const distance = EnhancedPriceCalculator.calculateDistance(
            AppState.userLocation.lat, AppState.userLocation.lng,
            AppState.selectedEmergencyStation.lat, AppState.selectedEmergencyStation.lng
        );
        
        const fare = EnhancedPriceCalculator.calculateEmergencyFare(distance, emergencyType);
        
        const rideData = {
            pickup: AppState.selectedEmergencyStation.name,
            pickupDisplay: AppState.selectedEmergencyStation.name,
            destination: AppState.userLocation.fullDisplay || 'Your Location',
            destinationDisplay: 'Emergency Location',
            pickupLat: AppState.selectedEmergencyStation.lat,
            pickupLng: AppState.selectedEmergencyStation.lng,
            destLat: AppState.userLocation.lat,
            destLng: AppState.userLocation.lng,
            emergencyType: emergencyType,
            emergencyReason: reason,
            fare: fare,
            distance: distance,
            paymentMethod: 'emergency'
        };
        
        try {
            await EnhancedFirebaseManager.requestEmergencyRide(rideData);
            hideModal('emergency');
        } catch (error) {
            EnhancedUIUpdater.showToast('Error requesting emergency ride', 'error');
        }
    });
    
    document.getElementById('saveSOSBtn')?.addEventListener('click', async () => {
        const contact1Name = document.getElementById('emergencyContact1Name').value.trim();
        const contact1Phone = document.getElementById('emergencyContact1Phone').value.trim();
        const contact2Name = document.getElementById('emergencyContact2Name').value.trim();
        const contact2Phone = document.getElementById('emergencyContact2Phone').value.trim();
        
        if (!contact1Name || !contact1Phone) {
            EnhancedUIUpdater.showToast('Primary emergency contact is required', 'warning');
            return;
        }
        
        if (contact2Name && !contact2Phone) {
            EnhancedUIUpdater.showToast('Secondary contact phone is required if name is provided', 'warning');
            return;
        }
        
        if (contact1Phone && !/^\d{10}$/.test(contact1Phone.replace(/\D/g, ''))) {
            EnhancedUIUpdater.showToast('Primary contact phone number must be 10 digits', 'warning');
            return;
        }
        
        if (contact2Phone && !/^\d{10}$/.test(contact2Phone.replace(/\D/g, ''))) {
            EnhancedUIUpdater.showToast('Secondary contact phone number must be 10 digits', 'warning');
            return;
        }
        
        const sosConfig = {
            contact1Name: contact1Name,
            contact1Phone: contact1Phone.replace(/\D/g, ''),
            contact2Name: contact2Name || '',
            contact2Phone: contact2Phone ? contact2Phone.replace(/\D/g, '') : '',
            message: document.getElementById('sosMessage').value.trim() || 'I need emergency assistance',
            updatedAt: Date.now()
        };
        
        try {
            await EnhancedFirebaseManager.saveSOSConfig(sosConfig);
            hideModal('sos');
        } catch (error) {
            EnhancedUIUpdater.showToast('Error saving SOS configuration', 'error');
        }
    });
    
    document.querySelectorAll('.emergency-service-type').forEach(btn => {
        btn.addEventListener('click', () => {
            const type = btn.dataset.type;
            document.querySelectorAll('.emergency-service-type').forEach(b => {
                b.classList.remove('active');
            });
            btn.classList.add('active');
            
            document.getElementById('emergencyServiceType').dataset.type = type;
            document.getElementById('emergencyServiceType').textContent = type.charAt(0).toUpperCase() + type.slice(1);
            
            EnhancedFirebaseManager.loadEmergencyStations(AppState.currentCity, type);
        });
    });
    
    document.getElementById('shareRideBtn')?.addEventListener('click', () => {
        showModal('share');
    });
    
    document.getElementById('addShareFriendBtn')?.addEventListener('click', () => {
        const friendCode = document.getElementById('shareFriendCode').value.trim();
        if (friendCode) {
            const added = EnhancedUIUpdater.addShareFriend(friendCode);
            if (added) {
                document.getElementById('shareFriendCode').value = '';
            }
        } else {
            EnhancedUIUpdater.showToast('Please enter a referral code', 'warning');
        }
    });
    
    document.getElementById('requestShareRideBtn')?.addEventListener('click', async () => {
        if (AppState.shareRideFriends.length === 0) {
            EnhancedUIUpdater.showToast('Please add at least one friend to share the ride', 'warning');
            return;
        }
        
        if (!AppState.pickup || !AppState.destination) {
            EnhancedUIUpdater.showToast('Please select pickup and destination locations', 'warning');
            return;
        }
        
        const distance = EnhancedPriceCalculator.calculateDistance(
            AppState.pickup.lat, AppState.pickup.lng,
            AppState.destination.lat, AppState.destination.lng
        );
        
        const surge = EnhancedPriceCalculator.getSurgeMultiplier();
        const totalPeople = AppState.shareRideFriends.length + 1;
        const calculation = EnhancedPriceCalculator.calculateBroadcastFare(distance, AppState.selectedRideType, 'equal', totalPeople);
        
        showPaymentModal('share', calculation.total, {
            pickup: AppState.pickup.address,
            pickupDisplay: AppState.pickup.fullDisplay || AppState.pickup.name,
            destination: AppState.destination.address,
            destinationDisplay: AppState.destination.fullAddress || AppState.destination.name,
            pickupLat: AppState.pickup.lat,
            pickupLng: AppState.pickup.lng,
            destLat: AppState.destination.lat,
            destLng: AppState.destination.lng,
            rideType: AppState.selectedRideType,
            fare: calculation.total,
            distance: distance,
            sharedRide: true,
            shareParticipants: totalPeople,
            shareParticipantsData: [
                {
                    userId: AppState.currentUser.uid,
                    name: AppState.userData.name,
                    amount: calculation.yourShare,
                    paymentStatus: 'pending'
                },
                ...AppState.shareRideFriends.map(friend => ({
                    userId: friend.userId,
                    name: friend.name,
                    amount: calculation.passengerShare,
                    paymentStatus: 'pending'
                }))
            ]
        });
    });
    
    document.getElementById('broadcastRideRequestBtn')?.addEventListener('click', async () => {
        if (!AppState.broadcastRecipients.length) {
            EnhancedUIUpdater.showToast('Please add recipients for broadcast', 'warning');
            return;
        }
        
        if (!AppState.pickup || !AppState.destination) {
            EnhancedUIUpdater.showToast('Please select pickup and destination locations', 'warning');
            return;
        }
        
        const distance = EnhancedPriceCalculator.calculateDistance(
            AppState.pickup.lat, AppState.pickup.lng,
            AppState.destination.lat, AppState.destination.lng
        );
        
        const surge = EnhancedPriceCalculator.getSurgeMultiplier();
        const fare = EnhancedPriceCalculator.calculateRideFare(distance, AppState.selectedRideType, surge);
        
        showPaymentModal('broadcast', fare, {
            pickup: AppState.pickup.address,
            pickupDisplay: AppState.pickup.fullDisplay || AppState.pickup.name,
            destination: AppState.destination.address,
            destinationDisplay: AppState.destination.fullAddress || AppState.destination.name,
            pickupLat: AppState.pickup.lat,
            pickupLng: AppState.pickup.lng,
            destLat: AppState.destination.lat,
            destLng: AppState.destination.lng,
            rideType: AppState.selectedRideType,
            fare: fare,
            distance: distance,
            broadcast: true,
            broadcastRecipients: AppState.broadcastRecipients
        });
    });
    
    document.getElementById('addBroadcastRecipientBtn')?.addEventListener('click', () => {
        const phoneInput = document.getElementById('broadcastRecipientPhone');
        const nameInput = document.getElementById('broadcastRecipientName');
        const phone = phoneInput.value.trim();
        const name = nameInput.value.trim();
        
        if (!phone) {
            EnhancedUIUpdater.showToast('Please enter a phone number', 'warning');
            return;
        }
        
        if (!/^\d{10}$/.test(phone.replace(/\D/g, ''))) {
            EnhancedUIUpdater.showToast('Phone number must be 10 digits', 'warning');
            return;
        }
        
        const existingRecipient = AppState.broadcastRecipients.find(r => r.phone === phone);
        if (existingRecipient) {
            EnhancedUIUpdater.showToast('Recipient already added', 'warning');
            return;
        }
        
        AppState.broadcastRecipients.push({
            phone: phone.replace(/\D/g, ''),
            name: name || 'Unknown',
            status: 'pending'
        });
        
        phoneInput.value = '';
        nameInput.value = '';
        
        EnhancedUIUpdater.updateBroadcastRecipients(AppState.broadcastRecipients);
        EnhancedUIUpdater.showToast('Recipient added', 'success');
    });
    
    document.getElementById('scheduleRideBtn')?.addEventListener('click', () => {
        const scheduleDate = document.getElementById('scheduleDate').value;
        const scheduleTime = document.getElementById('scheduleTime').value;
        
        if (!scheduleDate || !scheduleTime) {
            EnhancedUIUpdater.showToast('Please select date and time', 'warning');
            return;
        }
        
        if (!AppState.pickup || !AppState.destination) {
            EnhancedUIUpdater.showToast('Please select pickup and destination locations', 'warning');
            return;
        }
        
        const scheduledTime = new Date(`${scheduleDate}T${scheduleTime}`).getTime();
        const now = Date.now();
        
        if (scheduledTime <= now) {
            EnhancedUIUpdater.showToast('Scheduled time must be in the future', 'warning');
            return;
        }
        
        if (scheduledTime - now > 7 * 24 * 60 * 60 * 1000) {
            EnhancedUIUpdater.showToast('Maximum scheduling is 7 days in advance', 'warning');
            return;
        }
        
        const distance = EnhancedPriceCalculator.calculateDistance(
            AppState.pickup.lat, AppState.pickup.lng,
            AppState.destination.lat, AppState.destination.lng
        );
        
        const surge = EnhancedPriceCalculator.getSurgeMultiplier();
        const fare = EnhancedPriceCalculator.calculateRideFare(distance, AppState.selectedRideType, surge);
        
        showPaymentModal('schedule', fare, {
            pickup: AppState.pickup.address,
            pickupDisplay: AppState.pickup.fullDisplay || AppState.pickup.name,
            destination: AppState.destination.address,
            destinationDisplay: AppState.destination.fullAddress || AppState.destination.name,
            pickupLat: AppState.pickup.lat,
            pickupLng: AppState.pickup.lng,
            destLat: AppState.destination.lat,
            destLng: AppState.destination.lng,
            rideType: AppState.selectedRideType,
            fare: fare,
            distance: distance,
            scheduled: true,
            scheduledTime: scheduledTime,
            paymentMethod: 'wallet'
        });
    });
    
    document.getElementById('someoneElseRideBtn')?.addEventListener('click', async () => {
        const someoneName = document.getElementById('someoneName').value.trim();
        const someonePhone = document.getElementById('someonePhone').value.trim();
        
        if (!someoneName || !someonePhone) {
            EnhancedUIUpdater.showToast('Please enter name and phone for the rider', 'warning');
            return;
        }
        
        if (!AppState.pickup || !AppState.destination) {
            EnhancedUIUpdater.showToast('Please select pickup and destination locations', 'warning');
            return;
        }
        
        const distance = EnhancedPriceCalculator.calculateDistance(
            AppState.pickup.lat, AppState.pickup.lng,
            AppState.destination.lat, AppState.destination.lng
        );
        
        const surge = EnhancedPriceCalculator.getSurgeMultiplier();
        const fare = EnhancedPriceCalculator.calculateRideFare(distance, AppState.selectedRideType, surge);
        
        showPaymentModal('someone', fare, {
            pickup: AppState.pickup.address,
            pickupDisplay: AppState.pickup.fullDisplay || AppState.pickup.name,
            destination: AppState.destination.address,
            destinationDisplay: AppState.destination.fullAddress || AppState.destination.name,
            pickupLat: AppState.pickup.lat,
            pickupLng: AppState.pickup.lng,
            destLat: AppState.destination.lat,
            destLng: AppState.destination.lng,
            rideType: AppState.selectedRideType,
            fare: fare,
            distance: distance,
            riderName: someoneName,
            riderPhone: someonePhone,
            forSomeoneElse: true
        });
    });
    
    document.getElementById('updateProfileBtn')?.addEventListener('click', async () => {
        const name = document.getElementById('updateName').value.trim();
        const phone = document.getElementById('updatePhone').value.trim();
        const homeAddress = document.getElementById('homeAddress').value.trim();
        const workAddress = document.getElementById('workAddress').value.trim();
        
        if (!name || !phone) {
            EnhancedUIUpdater.showToast('Name and phone are required', 'warning');
            return;
        }
        
        if (!/^\d{10}$/.test(phone.replace(/\D/g, ''))) {
            EnhancedUIUpdater.showToast('Phone number must be 10 digits', 'warning');
            return;
        }
        
        const profileData = {
            name: name,
            phone: phone.replace(/\D/g, ''),
            homeAddress: homeAddress,
            workAddress: workAddress
        };
        
        try {
            await EnhancedFirebaseManager.updateProfile(profileData);
            hideModal('profile');
        } catch (error) {
            EnhancedUIUpdater.showToast('Error updating profile', 'error');
        }
    });
    
    document.getElementById('depositBtn')?.addEventListener('click', async () => {
        const amount = parseFloat(document.getElementById('depositAmount').value);
        if (!amount || amount <= 0) {
            EnhancedUIUpdater.showToast('Please enter a valid deposit amount', 'warning');
            return;
        }
        
        if (amount > 10000) {
            EnhancedUIUpdater.showToast('Maximum deposit amount is ZMW 10,000', 'warning');
            return;
        }
        
        try {
            await EnhancedFirebaseManager.depositMoney(amount);
            hideModal('wallet');
        } catch (error) {
            EnhancedUIUpdater.showToast('Error processing deposit', 'error');
        }
    });
    
    document.getElementById('withdrawBtn')?.addEventListener('click', async () => {
        const amount = parseFloat(document.getElementById('withdrawAmount').value);
        if (!amount || amount <= 0) {
            EnhancedUIUpdater.showToast('Please enter a valid withdrawal amount', 'warning');
            return;
        }
        
        try {
            await EnhancedFirebaseManager.withdrawMoney(amount);
            hideModal('wallet');
        } catch (error) {
            EnhancedUIUpdater.showToast('Error processing withdrawal', 'error');
        }
    });
    
    document.getElementById('transferBtn')?.addEventListener('click', async () => {
        const amount = parseFloat(document.getElementById('transferAmount').value);
        const recipientCode = document.getElementById('recipientCode').value.trim();
        const message = document.getElementById('transferMessage').value.trim();
        
        if (!amount || amount <= 0) {
            EnhancedUIUpdater.showToast('Please enter a valid transfer amount', 'warning');
            return;
        }
        
        if (!recipientCode) {
            EnhancedUIUpdater.showToast('Please enter recipient referral code', 'warning');
            return;
        }
        
        try {
            await EnhancedFirebaseManager.transferMoney(recipientCode, amount, message);
            hideModal('transfer');
        } catch (error) {
            EnhancedUIUpdater.showToast('Error processing transfer', 'error');
        }
    });
    
    document.querySelectorAll('.history-filter').forEach(filter => {
        filter.addEventListener('click', () => {
            const filterType = filter.dataset.filter;
            AppState.activeFilter = filterType;
            
            document.querySelectorAll('.history-filter').forEach(f => {
                f.classList.remove('active');
            });
            filter.classList.add('active');
            
            EnhancedFirebaseManager.loadRideHistory(AppState.currentUser.uid);
        });
    });
    
    document.getElementById('refreshHistoryBtn')?.addEventListener('click', () => {
        EnhancedFirebaseManager.loadRideHistory(AppState.currentUser.uid);
        EnhancedUIUpdater.showToast('History refreshed', 'success');
    });
    
    document.getElementById('clearNotificationsBtn')?.addEventListener('click', async () => {
        try {
            if (AppState.currentUser) {
                await database.ref(`notifications/${AppState.currentUser.uid}`).remove();
                AppState.notifications = [];
                AppState.unreadNotifications = 0;
                EnhancedUIUpdater.updateNotificationBadge(0);
                EnhancedUIUpdater.updateNotifications([]);
                EnhancedUIUpdater.showToast('Notifications cleared', 'success');
            }
        } catch (error) {
            console.error('Error clearing notifications:', error);
            EnhancedUIUpdater.showToast('Error clearing notifications', 'error');
        }
    });
    
    document.getElementById('syncDataBtn')?.addEventListener('click', () => {
        EnhancedFirebaseManager.syncUserData();
    });
    
    document.getElementById('logoutBtn')?.addEventListener('click', async () => {
        try {
            EnhancedUIUpdater.showLoading('Logging out...');
            
            EnhancedFirebaseManager.stopRealtimeSync();
            
            if (AppState.syncInterval) {
                clearInterval(AppState.syncInterval);
            }
            
            await auth.signOut();
            
            window.location.href = 'signup.html';
        } catch (error) {
            console.error('Error logging out:', error);
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Error logging out', 'error');
        }
    });
    
    document.addEventListener('click', (e) => {
        const moreOptionsMenu = document.getElementById('moreOptionsMenu');
        if (moreOptionsMenu && !moreOptionsMenu.contains(e.target) && 
            !document.getElementById('moreOptionsBtn').contains(e.target)) {
            moreOptionsMenu.classList.remove('active');
        }
        
        const searchHistory = document.getElementById('searchHistory');
        if (searchHistory && !searchHistory.contains(e.target)) {
            const allInputs = Array.from(document.querySelectorAll('input[type="text"]'));
            if (!allInputs.some(input => input.contains(e.target))) {
                searchHistory.style.display = 'none';
            }
        }
    });
    
    console.log('Event listeners setup completed');
}

// ============================================
// UTILITY FUNCTIONS
// ============================================
function switchScreen(screen) {
    console.log(`Switching to screen: ${screen}`);
    
    document.querySelectorAll('.screen').forEach(s => {
        s.classList.remove('active');
    });
    
    const targetScreen = document.getElementById(`${screen}Screen`);
    if (targetScreen) {
        targetScreen.classList.add('active');
        AppState.activeScreen = screen;
        
        if (screen === 'home') {
            switchService(AppState.activeService);
        } else if (screen === 'ride') {
            if (AppState.currentRide) {
                EnhancedUIUpdater.showRideInfo(AppState.currentRide);
            }
        } else if (screen === 'wallet') {
            EnhancedFirebaseManager.loadWalletTransactions(AppState.currentUser.uid)
                .then(transactions => {
                    updateWalletTransactions(transactions);
                });
        } else if (screen === 'history') {
            EnhancedFirebaseManager.loadRideHistory(AppState.currentUser.uid);
        } else if (screen === 'notifications') {
            EnhancedUIUpdater.updateNotifications(AppState.notifications);
        } else if (screen === 'profile') {
            loadProfileData();
        }
        
        document.getElementById('panelHandle').classList.remove('active');
    }
}

function switchService(service) {
    console.log(`Switching service to: ${service}`);
    
    document.querySelectorAll('.service-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    document.querySelector(`.service-tab[data-service="${service}"]`)?.classList.add('active');
    
    document.querySelectorAll('.service-form, .ride-request-form').forEach(form => {
        form.style.display = 'none';
    });
    
    const targetForm = document.getElementById(`${service}Form`);
    if (targetForm) {
        targetForm.style.display = 'block';
        AppState.activeService = service;
        
        if (service === 'car') {
            document.getElementById('fareDisplay').classList.remove('active');
            document.getElementById('rideTypeSelection').classList.remove('active');
        }
    }
}

function togglePanel() {
    const panelHandle = document.getElementById('panelHandle');
    panelHandle.classList.toggle('active');
    
    const mainPanel = document.getElementById('mainPanel');
    const mapOverlay = document.getElementById('mapOverlay');
    
    if (panelHandle.classList.contains('active')) {
        mainPanel.style.transform = 'translateY(0)';
        mapOverlay.style.display = 'block';
    } else {
        mainPanel.style.transform = 'translateY(100%)';
        mapOverlay.style.display = 'none';
    }
}

function showModal(modalId) {
    console.log(`Showing modal: ${modalId}`);
    const modal = document.getElementById(`${modalId}Modal`);
    if (modal) {
        modal.classList.add('active');
    }
    
    if (modalId === 'payment') {
        const amount = window.pendingRideData?.fare || 0;
        document.getElementById('paymentAmount').textContent = `ZMW ${amount.toFixed(2)}`;
        
        if (window.pendingRideData?.referredBy) {
            EnhancedUIUpdater.showReferralDiscountSection();
        } else {
            EnhancedUIUpdater.hideReferralDiscountSection();
        }
    }
}

function hideModal(modalId) {
    console.log(`Hiding modal: ${modalId}`);
    const modal = document.getElementById(`${modalId}Modal`);
    if (modal) {
        modal.classList.remove('active');
    }
    
    if (modalId === 'share') {
        document.getElementById('shareFriendCode').value = '';
    } else if (modalId === 'broadcast') {
        document.getElementById('broadcastRecipientPhone').value = '';
        document.getElementById('broadcastRecipientName').value = '';
    }
}

function handleMoreOptionSelection(option) {
    console.log(`Handling more option: ${option}`);
    
    switch(option) {
        case 'share':
            showModal('share');
            break;
        case 'schedule':
            switchService('schedule');
            break;
        case 'someone':
            showModal('someone');
            break;
        case 'broadcast':
            switchService('broadcast');
            break;
        case 'emergency':
            switchService('emergency');
            break;
        case 'sos':
            showModal('sos');
            break;
        case 'profile':
            switchScreen('profile');
            break;
        case 'wallet':
            switchScreen('wallet');
            break;
        case 'history':
            switchScreen('history');
            break;
        case 'notifications':
            switchScreen('notifications');
            break;
        case 'logout':
            document.getElementById('logoutBtn').click();
            break;
    }
}

function handleEmergencyService(type) {
    console.log(`Handling emergency service: ${type}`);
    
    document.getElementById('emergencyServiceType').dataset.type = type;
    document.getElementById('emergencyServiceType').textContent = type.charAt(0).toUpperCase() + type.slice(1);
    
    EnhancedFirebaseManager.loadEmergencyStations(AppState.currentCity, type);
    
    showModal('emergency');
}

function triggerSOS() {
    if (!AppState.currentRide || !AppState.sosConfig) {
        EnhancedUIUpdater.showToast('No active ride or SOS configuration', 'warning');
        return;
    }
    
    if (confirm('Send SOS emergency alert to your contacts?')) {
        EnhancedFirebaseManager.sendSOSAlert(AppState.currentRide.id, {
            emergencyContact1: AppState.sosConfig.contact1Phone,
            emergencyContact1Name: AppState.sosConfig.contact1Name,
            emergencyContact2: AppState.sosConfig.contact2Phone,
            emergencyContact2Name: AppState.sosConfig.contact2Name,
            message: AppState.sosConfig.message || 'Emergency SOS triggered',
            location: {
                lat: AppState.currentRide.pickupLat || AppState.userLocation.lat,
                lng: AppState.currentRide.pickupLng || AppState.userLocation.lng
            },
            rideDetails: {
                pickup: AppState.currentRide.pickupDisplay,
                destination: AppState.currentRide.destinationDisplay,
                driver: AppState.selectedVehicle?.name || 'Unknown'
            },
            city: AppState.currentCity
        });
    }
}

function showPaymentModal(serviceType, amount, rideData) {
    console.log(`Showing payment modal for ${serviceType}: ZMW ${amount}`);
    
    window.pendingRideData = rideData;
    
    document.getElementById('paymentAmount').textContent = `ZMW ${amount.toFixed(2)}`;
    document.getElementById('paymentTitle').textContent = `Payment for ${serviceType.charAt(0).toUpperCase() + serviceType.slice(1)}`;
    
    const paymentMethod = document.querySelector('.payment-method.selected');
    if (paymentMethod) {
        paymentMethod.classList.remove('selected');
    }
    
    if (AppState.walletBalance >= amount) {
        document.querySelector('.payment-method.wallet').classList.add('selected');
    } else {
        document.querySelector('.payment-method.cash').classList.add('selected');
    }
    
    showModal('payment');
}

function updateWalletTransactions(transactions) {
    const container = document.getElementById('transactionsList');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (transactions.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="fas fa-exchange-alt"></i>
                </div>
                <div class="empty-title">No transactions</div>
                <div class="empty-message">Your transaction history is empty</div>
            </div>
        `;
        return;
    }
    
    transactions.forEach(transaction => {
        const transactionElement = document.createElement('div');
        transactionElement.className = 'transaction-item';
        
        let icon = 'fa-exchange-alt';
        let iconColor = 'var(--info-blue)';
        let amountColor = '';
        let amountSign = '';
        let description = '';
        
        switch(transaction.type) {
            case 'deposit':
                icon = 'fa-plus-circle';
                iconColor = 'var(--success-green)';
                amountColor = 'success';
                amountSign = '+';
                description = 'Wallet deposit';
                break;
            case 'withdrawal':
                icon = 'fa-minus-circle';
                iconColor = 'var(--error-red)';
                amountColor = 'error';
                amountSign = '-';
                description = 'Wallet withdrawal';
                break;
            case 'transfer':
                icon = 'fa-share-alt';
                iconColor = 'var(--warning-yellow)';
                amountColor = 'error';
                amountSign = '-';
                description = transaction.message || 'Money transfer';
                break;
            case 'ride_payment':
                icon = 'fa-car';
                iconColor = 'var(--primary-orange)';
                amountColor = 'error';
                amountSign = '-';
                description = `Ride payment: ${transaction.description || 'Ride service'}`;
                break;
            case 'referral_reward':
                icon = 'fa-gift';
                iconColor = 'var(--primary-orange)';
                amountColor = 'success';
                amountSign = '+';
                description = 'Referral reward';
                break;
            case 'share_ride_payment':
                icon = 'fa-users';
                iconColor = 'var(--info-blue)';
                amountColor = 'error';
                amountSign = '-';
                description = transaction.description || 'Share ride payment';
                break;
        }
        
        const date = new Date(transaction.timestamp);
        
        transactionElement.innerHTML = `
            <div class="transaction-icon" style="background: ${iconColor}">
                <i class="fas ${icon}"></i>
            </div>
            <div class="transaction-details">
                <div class="transaction-title">${description}</div>
                <div class="transaction-meta">
                    <span>${date.toLocaleDateString()}</span>
                    <span>${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                </div>
            </div>
            <div class="transaction-amount ${amountColor}">
                ${amountSign}ZMW ${transaction.amount.toFixed(2)}
            </div>
        `;
        
        container.appendChild(transactionElement);
    });
}

function loadProfileData() {
    if (AppState.userData) {
        document.getElementById('updateName').value = AppState.userData.name || '';
        document.getElementById('updatePhone').value = AppState.userData.phone || '';
        document.getElementById('homeAddress').value = AppState.userData.homeAddress || '';
        document.getElementById('workAddress').value = AppState.userData.workAddress || '';
        document.getElementById('userEmail').textContent = AppState.currentUser.email || '';
        
        document.getElementById('referralCode').textContent = AppState.userData.referralCode || 'Not available';
    }
}

// ============================================
// BICYCLE RIDE TYPE IMPLEMENTATION
// ============================================
function initializeBicycleRide() {
    // Add bicycle to service tabs
    const servicesContainer = document.querySelector('.service-tabs');
    if (servicesContainer && !document.querySelector('.service-tab[data-service="bicycle"]')) {
        const bicycleTab = document.createElement('div');
        bicycleTab.className = 'service-tab';
        bicycleTab.dataset.service = 'bicycle';
        bicycleTab.innerHTML = `
            <i class="fas fa-bicycle"></i>
            <span>Bicycle</span>
        `;
        
        bicycleTab.addEventListener('click', () => {
            switchService('bicycle');
        });
        
        servicesContainer.appendChild(bicycleTab);
    }
    
    // Create bicycle form
    const formsContainer = document.querySelector('.service-forms');
    if (formsContainer && !document.getElementById('bicycleForm')) {
        const bicycleForm = document.createElement('div');
        bicycleForm.className = 'service-form';
        bicycleForm.id = 'bicycleForm';
        bicycleForm.style.display = 'none';
        bicycleForm.innerHTML = `
            <div class="ride-request-form">
                <div class="form-group">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="bicyclePickup" placeholder="Pickup location" value="Current Location" readonly>
                    </div>
                </div>
                
                <div class="form-group">
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="bicycleDestination" placeholder="Where to?" autocomplete="off">
                    </div>
                </div>
                
                <div id="bicycleStopsContainer" style="margin: 10px 0;"></div>
                
                <div class="form-group" style="text-align: center;">
                    <button class="btn btn-orange" id="addBicycleStopBtn" type="button">
                        <i class="fas fa-plus"></i> Add Stop
                    </button>
                </div>
                
                <div class="form-group" style="text-align: center;">
                    <button class="btn btn-primary" id="requestBicycleBtn">
                        <i class="fas fa-bicycle"></i> Request Bicycle
                    </button>
                </div>
            </div>
        `;
        
        formsContainer.appendChild(bicycleForm);
        
        // Setup bicycle specific event listeners
        setupBicycleEventListeners();
    }
}

function setupBicycleEventListeners() {
    // Setup pickup and destination inputs
    const pickupInput = document.getElementById('bicyclePickup');
    const destinationInput = document.getElementById('bicycleDestination');
    
    if (pickupInput) {
        EnhancedLocationManager.setupPickupInput(pickupInput);
    }
    
    if (destinationInput) {
        EnhancedLocationManager.setupDestinationInput(destinationInput);
        destinationInput.addEventListener('input', () => {
            EnhancedLocationManager.handleDestinationInputChange('bicycleDestination', destinationInput.value);
        });
    }
    
    // Setup stops for bicycle
    const addStopBtn = document.getElementById('addBicycleStopBtn');
    if (addStopBtn) {
        addStopBtn.addEventListener('click', () => {
            EnhancedLocationManager.addStop();
        });
    }
    
    // Setup request bicycle button
    const requestBicycleBtn = document.getElementById('requestBicycleBtn');
    if (requestBicycleBtn) {
        requestBicycleBtn.addEventListener('click', async () => {
            if (!AppState.pickup || !AppState.destination) {
                EnhancedUIUpdater.showToast('Please select pickup and destination locations', 'warning');
                return;
            }
            
            // Calculate distance with stops
            let distance;
            if (AppState.stops.length > 0) {
                const validStops = AppState.stops.filter(stop => stop.location);
                distance = EnhancedPriceCalculator.calculateDistanceWithStops(
                    AppState.pickup,
                    validStops,
                    AppState.destination
                );
            } else {
                distance = EnhancedPriceCalculator.calculateDistance(
                    AppState.pickup.lat, AppState.pickup.lng,
                    AppState.destination.lat, AppState.destination.lng
                );
            }
            
            if (distance < 0.5) {
                EnhancedUIUpdater.showToast('Minimum bicycle ride distance is 0.5 km', 'warning');
                return;
            }
            
            const validation = EnhancedPriceCalculator.validateDistanceWithinCity(
                AppState.pickup.lat, AppState.pickup.lng,
                AppState.destination.lat, AppState.destination.lng,
                AppState.currentCity
            );
            
            if (!validation.valid) {
                EnhancedUIUpdater.showToast(validation.message, 'warning');
                return;
            }
            
            const surge = EnhancedPriceCalculator.getSurgeMultiplier();
            const fare = EnhancedPriceCalculator.calculateRideFare(distance, 'bicycle', surge);
            
            // Prepare ride data with stops
            const rideData = {
                pickup: AppState.pickup.address,
                pickupDisplay: AppState.pickup.fullDisplay || AppState.pickup.name,
                destination: AppState.destination.address,
                destinationDisplay: AppState.destination.fullAddress || AppState.destination.name,
                pickupLat: AppState.pickup.lat,
                pickupLng: AppState.pickup.lng,
                destLat: AppState.destination.lat,
                destLng: AppState.destination.lng,
                rideType: 'bicycle',
                fare: fare,
                distance: distance,
                stops: AppState.stops
                    .filter(stop => stop.location)
                    .map(stop => ({
                        address: stop.address,
                        name: stop.location.name,
                        lat: stop.location.lat,
                        lng: stop.location.lng
                    }))
            };
            
            showPaymentModal('bicycle', fare, rideData);
        });
    }
}

// ============================================
// AUTO-PRICE CALCULATION IMPLEMENTATION
// ============================================
function setupAutoPriceCalculation() {
    // Observe destination input changes for all services
    const destinationInputs = [
        'destinationLocation', 'deliveryDestination', 'shortDeliveryDestination',
        'truckDestination', 'scheduleDestination', 'someoneDestination',
        'shareDestination', 'broadcastDestination', 'shoppingDestination',
        'bicycleDestination', 'emergencyDestination'
    ];
    
    destinationInputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
            input.addEventListener('change', () => {
                if (AppState.pickup && AppState.destination) {
                    setTimeout(() => {
                        EnhancedUIUpdater.calculateAndUpdatePrices();
                    }, 500);
                }
            });
        }
    });
    
    // Setup ride type selection price updates
    document.addEventListener('click', (e) => {
        if (e.target.closest('.ride-type-card')) {
            if (AppState.pickup && AppState.destination) {
                setTimeout(() => {
                    EnhancedUIUpdater.calculateAndUpdatePrices();
                }, 300);
            }
        }
    });
}

// ============================================
// REFERRAL SYSTEM ENHANCEMENTS
// ============================================
function setupEnhancedReferralSystem() {
    // Add referral input to payment modal if not exists
    const paymentModal = document.getElementById('paymentModal');
    if (paymentModal && !paymentModal.querySelector('#referralDiscountSection')) {
        const paymentBody = paymentModal.querySelector('.modal-body');
        const paymentMethods = paymentBody.querySelector('.payment-methods');
        
        if (paymentMethods) {
            const referralSection = document.createElement('div');
            referralSection.id = 'referralDiscountSection';
            referralSection.style.display = 'none';
            referralSection.innerHTML = `
                <div class="referral-discount-section">
                    <div class="section-header">
                        <i class="fas fa-gift"></i>
                        <span>Referral Discount (50% off)</span>
                    </div>
                    <div class="referral-input-group">
                        <input type="text" id="referralCodeInput" placeholder="Enter referral code">
                        <button id="applyReferralBtn" class="btn btn-orange">
                            <i class="fas fa-check"></i> Apply
                        </button>
                    </div>
                    <div id="referrerInfo" style="display: none; font-size: 12px; color: var(--success-green); margin-top: 5px;"></div>
                    <div class="discount-breakdown" style="margin-top: 10px;">
                        <div class="price-row">
                            <span>Original Fare:</span>
                            <span id="originalFareAmount">ZMW 0.00</span>
                        </div>
                        <div class="price-row">
                            <span>Discount:</span>
                            <span id="discountAmount" style="color: var(--success-green);">-ZMW 0.00</span>
                        </div>
                        <div class="price-row total">
                            <span>Final Fare:</span>
                            <span id="finalFareAmount" style="font-weight: bold;">ZMW 0.00</span>
                        </div>
                    </div>
                </div>
            `;
            
            paymentMethods.parentNode.insertBefore(referralSection, paymentMethods.nextSibling);
            
            // Setup apply referral button
            document.getElementById('applyReferralBtn')?.addEventListener('click', async () => {
                const referralCode = document.getElementById('referralCodeInput').value.trim();
                if (!referralCode) {
                    EnhancedUIUpdater.showToast('Please enter a referral code', 'warning');
                    return;
                }
                
                const selectedMethod = document.querySelector('.payment-method.selected');
                if (!selectedMethod) {
                    EnhancedUIUpdater.showToast('Please select a payment method first', 'warning');
                    return;
                }
                
                const amount = parseFloat(document.getElementById('paymentAmount').textContent.replace('ZMW ', ''));
                const rideData = window.pendingRideData;
                
                if (!rideData) {
                    EnhancedUIUpdater.showToast('No ride data found', 'error');
                    return;
                }
                
                EnhancedUIUpdater.showLoading('Applying referral discount...');
                
                const result = await EnhancedFirebaseManager.applyReferralDiscount(rideData, referralCode);
                
                EnhancedUIUpdater.hideLoading();
                
                if (result.success) {
                    EnhancedUIUpdater.showToast(result.message, 'success');
                    
                    // Update payment amount
                    document.getElementById('paymentAmount').textContent = `ZMW ${result.finalFare.toFixed(2)}`;
                    document.getElementById('originalFareAmount').textContent = `ZMW ${result.originalFare.toFixed(2)}`;
                    
                    // Update ride data
                    rideData.fare = result.finalFare;
                    rideData.referredBy = referralCode;
                    rideData.referrerName = result.referrerName;
                    rideData.discountAmount = result.discountAmount;
                    rideData.originalFare = result.originalFare;
                    window.pendingRideData = rideData;
                } else {
                    EnhancedUIUpdater.showToast(result.message, 'error');
                }
            });
        }
    }
    
    // Show referral section when payment modal opens
    const paymentModalElement = document.getElementById('paymentModal');
    if (paymentModalElement) {
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    if (paymentModalElement.classList.contains('active')) {
                        const rideData = window.pendingRideData;
                        if (rideData && !rideData.referredBy) {
                            EnhancedUIUpdater.showReferralDiscountSection();
                            document.getElementById('originalFareAmount').textContent = `ZMW ${rideData.fare?.toFixed(2) || '0.00'}`;
                        } else {
                            EnhancedUIUpdater.hideReferralDiscountSection();
                        }
                    }
                }
            });
        });
        
        observer.observe(paymentModalElement, {
            attributes: true,
            attributeFilter: ['class']
        });
    }
}

// ============================================
// REAL-TIME SYNC ENHANCEMENTS
// ============================================
function setupRealTimeSync() {
    // Setup periodic sync
    AppState.syncInterval = setInterval(() => {
        if (!AppState.isSyncing && AppState.currentUser) {
            EnhancedFirebaseManager.syncUserData();
        }
    }, 30000);
    
    // Setup visibility change detection
    document.addEventListener('visibilitychange', () => {
        if (!document.hidden && AppState.currentUser) {
            EnhancedFirebaseManager.syncUserData();
        }
    });
    
    // Setup online/offline detection
    window.addEventListener('online', () => {
        EnhancedUIUpdater.showToast('Back online', 'success');
        if (AppState.currentUser) {
            EnhancedFirebaseManager.syncUserData();
        }
    });
    
    window.addEventListener('offline', () => {
        EnhancedUIUpdater.showToast('You are offline', 'warning');
    });
}

// ============================================
// INITIALIZATION ENHANCEMENTS
// ============================================
function setupEnhancedInitialization() {
    // Initialize bicycle ride type
    initializeBicycleRide();
    
    // Setup auto-price calculation
    setupAutoPriceCalculation();
    
    // Setup enhanced referral system
    setupEnhancedReferralSystem();
    
    // Setup real-time sync
    setupRealTimeSync();
    
    // Add CSS for new components
    addEnhancedStyles();
}

function addEnhancedStyles() {
    const style = document.createElement('style');
    style.textContent = `
        .ride-type-cards {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
            gap: 10px;
            padding: 0 15px;
            overflow-x: auto;
            scrollbar-width: none;
        }
        
        .ride-type-card {
            min-width: 100px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            border: 2px solid #e0e0e0;
            transition: all 0.3s ease;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
        }
        
        .ride-type-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .stop-entry {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #e0e0e0;
        }
        
        .stop-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .stop-number {
            font-weight: 600;
            color: var(--primary-orange);
        }
        
        .remove-stop-btn {
            background: none;
            border: none;
            color: var(--error-red);
            cursor: pointer;
            font-size: 14px;
        }
        
        .stop-suggestions {
            position: absolute;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            margin-top: 5px;
            width: 100%;
        }
        
        .pulsing-ride-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 60px;
            color: var(--primary-orange);
            z-index: 1000;
            animation: pulse 1.5s infinite;
            pointer-events: none;
        }
        
        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 0.7; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        
        .schedule-countdown {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            margin: 20px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .countdown-timer {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
            gap: 10px;
        }
        
        .time-unit {
            background: white;
            padding: 15px;
            border-radius: 8px;
            min-width: 80px;
        }
        
        .time-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-orange);
        }
        
        .time-label {
            font-size: 12px;
            color: var(--text-gray);
            margin-top: 5px;
        }
        
        .time-separator {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-orange);
        }
        
        .share-friend-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: var(--card-bg);
            border-radius: 8px;
            margin: 5px 0;
            gap: 10px;
        }
        
        .friend-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .friend-info {
            flex: 1;
        }
        
        .friend-name {
            font-weight: 600;
        }
        
        .friend-phone {
            font-size: 12px;
            color: var(--text-gray);
        }
        
        .friend-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .friend-status.pending {
            background: var(--warning-yellow-light);
            color: var(--warning-yellow-dark);
        }
        
        .friend-status.accepted {
            background: var(--success-green-light);
            color: var(--success-green-dark);
        }
        
        .friend-status.rejected {
            background: var(--error-red-light);
            color: var(--error-red-dark);
        }
        
        .remove-friend-btn {
            background: none;
            border: none;
            color: var(--error-red);
            cursor: pointer;
        }
        
        .referral-discount-section {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            border: 2px solid var(--primary-orange);
        }
        
        .referral-input-group {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }
        
        .referral-input-group input {
            flex: 1;
        }
        
        .broadcast-ride-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
            z-index: 2000;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }
        
        .broadcast-ride-panel.active {
            transform: translateY(0);
        }
        
        .broadcast-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .close-broadcast {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--text-gray);
            cursor: pointer;
        }
        
        .stop-marker {
            background: #4CAF50;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
        }
        
        .city-search-note {
            padding: 10px;
            background: var(--info-blue-light);
            color: var(--info-blue-dark);
            font-size: 12px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .city-search-note i {
            font-size: 14px;
        }
    `;
    
    document.head.appendChild(style);
}

// ============================================
// MAIN INITIALIZATION
// ============================================
document.addEventListener('DOMContentLoaded', () => {
    initializeApp();
    setupEnhancedInitialization();
});

// ============================================
// EXPORT FUNCTIONS FOR GLOBAL ACCESS
// ============================================
window.EnhancedUIUpdater = EnhancedUIUpdater;
window.EnhancedLocationManager = EnhancedLocationManager;
window.EnhancedFirebaseManager = EnhancedFirebaseManager;
window.EnhancedSearchEngine = EnhancedSearchEngine;
window.EnhancedPriceCalculator = EnhancedPriceCalculator;
window.RideTypeManager = RideTypeManager;
window.BroadcastManager = BroadcastManager;
window.NotificationManager = NotificationManager;
window.CityDetector = CityDetector;

console.log('Jubel Passenger App JavaScript loaded successfully');
</script>
</body>
</html>












