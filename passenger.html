

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jubel - Ride Hailing App</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <style>
        :root {
            --primary-orange: #FF6B35;
            --primary-orange-light: #FF8B5C;
            --primary-orange-dark: #E55A2B;
            --secondary-blue: #2A9D8F;
            --success-green: #4CAF50;
            --error-red: #F44336;
            --warning-yellow: #FFC107;
            --info-blue: #2196F3;
            --text-dark: #333333;
            --text-gray: #666666;
            --text-light: #999999;
            --bg-white: #FFFFFF;
            --bg-light: #F8F9FA;
            --bg-gray: #F5F5F5;
            --border-light: #E0E0E0;
            --shadow-light: rgba(0, 0, 0, 0.1);
            --shadow-medium: rgba(0, 0, 0, 0.15);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            --radius-full: 9999px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        body {
            background: var(--bg-white);
            color: var(--text-dark);
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        /* Map Container */
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 60vh;
            z-index: 1;
        }

        .map-loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border-light);
            border-top: 4px solid var(--primary-orange);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .map-loading-text {
            color: var(--text-gray);
            font-size: 16px;
            font-weight: 500;
        }

        /* Top Navigation Bar */
        .top-bar {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            background: var(--bg-white);
            border-radius: var(--radius-xl);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px var(--shadow-light);
            z-index: 100;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            background: var(--primary-orange);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-icon img {
            width: 24px;
            height: 24px;
        }

        .logo-text {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-dark);
        }

        .user-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .balance-badge {
            background: var(--bg-light);
            padding: 8px 15px;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text-gray);
        }

        .balance-badge i {
            color: var(--primary-orange);
        }

        .balance-amount {
            font-weight: 600;
            color: var(--primary-orange);
        }

        .notification-bell {
            position: relative;
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            background: var(--bg-light);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .notification-bell i {
            color: var(--text-gray);
            font-size: 18px;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--error-red);
            color: white;
            font-size: 12px;
            width: 20px;
            height: 20px;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Main Panel */
        .main-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 45vh;
            background: var(--bg-white);
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
            box-shadow: 0 -4px 30px var(--shadow-medium);
            z-index: 200;
            overflow: hidden;
            transition: height 0.3s ease;
        }

        .main-panel.collapsed {
            height: 80px;
        }

        .panel-handle {
            width: 40px;
            height: 4px;
            background: var(--border-light);
            border-radius: var(--radius-full);
            margin: 10px auto;
            cursor: pointer;
        }

        .nav-tabs {
            display: flex;
            padding: 0 20px;
            border-bottom: 1px solid var(--border-light);
        }

        .nav-tab {
            flex: 1;
            padding: 15px 0;
            background: none;
            border: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-tab.active {
            color: var(--primary-orange);
        }

        .nav-tab i {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .nav-tab span {
            font-size: 12px;
            font-weight: 500;
        }

        /* Home Content */
        #homeContent {
            height: calc(100% - 120px);
            overflow-y: auto;
            padding: 20px;
        }

        .service-tabs {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .service-tab {
            background: var(--bg-light);
            border-radius: var(--radius-md);
            padding: 12px 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .service-tab.active {
            background: var(--primary-orange);
            color: white;
            border-color: var(--primary-orange);
        }

        .service-tab.active .service-icon {
            color: white;
        }

        .service-icon {
            font-size: 24px;
            color: var(--primary-orange);
        }

        .service-name {
            font-size: 12px;
            font-weight: 600;
            text-align: center;
        }

        .service-desc {
            font-size: 10px;
            color: var(--text-light);
            text-align: center;
        }

        /* Ride Request Form */
        .ride-request-form {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            padding: 20px;
            box-shadow: 0 2px 15px var(--shadow-light);
            margin-bottom: 20px;
        }

        .form-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-dark);
        }

        .form-title i {
            color: var(--primary-orange);
        }

        .location-inputs {
            margin-bottom: 20px;
        }

        .location-input {
            position: relative;
            margin-bottom: 10px;
        }

        .location-input i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
            z-index: 1;
        }

        .location-input input {
            width: 100%;
            padding: 15px 15px 15px 45px;
            border: 2px solid var(--border-light);
            border-radius: var(--radius-md);
            font-size: 14px;
            background: var(--bg-white);
            transition: all 0.2s;
        }

        .location-input input:focus {
            outline: none;
            border-color: var(--primary-orange);
        }

        .suggestion-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-white);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            box-shadow: 0 4px 20px var(--shadow-medium);
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }

        .suggestion-item {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-light);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background 0.2s;
        }

        .suggestion-item:hover {
            background: var(--bg-light);
        }

        .suggestion-icon {
            width: 24px;
            text-align: center;
        }

        .suggestion-details {
            flex: 1;
        }

        .suggestion-name {
            font-weight: 500;
            margin-bottom: 3px;
        }

        .suggestion-address {
            font-size: 12px;
            color: var(--text-gray);
        }

        .suggestion-distance {
            font-size: 11px;
            color: var(--primary-orange);
            margin-top: 3px;
        }

        /* Ride Type Selection */
        .ride-type-selection {
            margin: 20px 0;
        }

        .ride-type-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-dark);
        }

        .ride-type-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .ride-type-card {
            background: var(--bg-light);
            border-radius: var(--radius-md);
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .ride-type-card.selected {
            background: var(--primary-orange);
            color: white;
            border-color: var(--primary-orange);
        }

        .ride-type-card .ride-type-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .ride-type-card .ride-type-name {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .ride-type-card .ride-type-price {
            font-size: 14px;
            font-weight: 700;
        }

        /* Fare Display */
        .fare-display {
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-orange-light));
            border-radius: var(--radius-lg);
            padding: 20px;
            color: white;
            margin: 20px 0;
        }

        .fare-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .fare-amount {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .fare-details {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            opacity: 0.9;
        }

        /* Action Buttons */
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            padding: 16px;
            border: none;
            border-radius: var(--radius-md);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary-orange);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-orange-dark);
        }

        .btn-secondary {
            background: var(--bg-light);
            color: var(--text-dark);
        }

        .btn-secondary:hover {
            background: var(--border-light);
        }

        .btn-danger {
            background: var(--error-red);
            color: white;
        }

        .btn-danger:hover {
            background: #D32F2F;
        }

        /* Ride Info Panel */
        .ride-info-panel {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            padding: 20px;
            box-shadow: 0 2px 15px var(--shadow-light);
        }

        .driver-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .driver-avatar {
            width: 60px;
            height: 60px;
            border-radius: var(--radius-full);
            background: var(--bg-light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: var(--primary-orange);
        }

        .driver-details {
            flex: 1;
        }

        .driver-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .driver-rating {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 5px;
            color: var(--warning-yellow);
        }

        .driver-vehicle {
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--text-gray);
            font-size: 14px;
        }

        /* Timeline */
        .timeline {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            position: relative;
        }

        .timeline::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 30px;
            right: 30px;
            height: 2px;
            background: var(--border-light);
            z-index: 1;
        }

        .timeline-step {
            position: relative;
            z-index: 2;
            text-align: center;
            flex: 1;
        }

        .step-dot {
            width: 30px;
            height: 30px;
            border-radius: var(--radius-full);
            background: var(--bg-light);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 8px;
            transition: all 0.3s;
        }

        .step-dot.active {
            background: var(--primary-orange);
            color: white;
        }

        .step-dot.completed {
            background: var(--success-green);
            color: white;
        }

        .step-label {
            font-size: 11px;
            color: var(--text-light);
            transition: all 0.3s;
        }

        .step-label.active {
            color: var(--primary-orange);
            font-weight: 600;
        }

        /* SOS Button */
        .sos-button {
            position: absolute;
            bottom: 120px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: var(--radius-full);
            background: var(--error-red);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(244, 67, 54, 0.3);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.4); }
            70% { box-shadow: 0 0 0 20px rgba(244, 67, 54, 0); }
            100% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0); }
        }

        /* Map Controls */
        .map-controls {
            position: absolute;
            top: 100px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 100;
        }

        .map-control-btn {
            width: 45px;
            height: 45px;
            border-radius: var(--radius-full);
            background: var(--bg-white);
            border: none;
            color: var(--text-dark);
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 2px 10px var(--shadow-light);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .map-control-btn:hover {
            background: var(--bg-light);
            color: var(--primary-orange);
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal {
            background: var(--bg-white);
            border-radius: var(--radius-xl);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px var(--shadow-medium);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
            font-weight: 600;
        }

        .modal-title i {
            color: var(--primary-orange);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--text-light);
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: var(--bg-light);
        }

        .modal-content {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-dark);
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border-light);
            border-radius: var(--radius-md);
            font-size: 14px;
            transition: all 0.2s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-orange);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* Payment Methods */
        .payment-methods {
            margin: 20px 0;
        }

        .payment-method {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 2px solid var(--border-light);
            border-radius: var(--radius-md);
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .payment-method.selected {
            border-color: var(--primary-orange);
            background: rgba(255, 107, 53, 0.05);
        }

        .payment-method:hover {
            border-color: var(--primary-orange-light);
        }

        .payment-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            background: var(--bg-light);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            color: var(--primary-orange);
            font-size: 18px;
        }

        .payment-details {
            flex: 1;
        }

        .payment-name {
            font-weight: 600;
            margin-bottom: 3px;
        }

        .payment-info {
            font-size: 12px;
            color: var(--text-gray);
        }

        /* Toast Container */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
        }

        .toast {
            background: var(--bg-white);
            border-radius: var(--radius-md);
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 4px 20px var(--shadow-medium);
            min-width: 300px;
            border-left: 4px solid var(--primary-orange);
            animation: slideIn 0.3s ease;
        }

        .toast.success {
            border-left-color: var(--success-green);
        }

        .toast.error {
            border-left-color: var(--error-red);
        }

        .toast.warning {
            border-left-color: var(--warning-yellow);
        }

        .toast.info {
            border-left-color: var(--info-blue);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast-icon {
            font-size: 20px;
        }

        .toast.success .toast-icon {
            color: var(--success-green);
        }

        .toast.error .toast-icon {
            color: var(--error-red);
        }

        .toast.warning .toast-icon {
            color: var(--warning-yellow);
        }

        .toast.info .toast-icon {
            color: var(--info-blue);
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 3px;
        }

        .toast-message {
            font-size: 14px;
            color: var(--text-gray);
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            font-size: 14px;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .loading-text {
            margin-top: 20px;
            font-size: 16px;
            color: var(--text-gray);
        }

        /* City Detection */
        .city-detection {
            position: absolute;
            top: 90px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-white);
            border-radius: var(--radius-full);
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 2px 10px var(--shadow-light);
            z-index: 100;
            font-size: 14px;
        }

        .city-detection i {
            color: var(--primary-orange);
        }

        /* Ride Status Bar */
        .ride-status-bar {
            position: absolute;
            bottom: 45vh;
            left: 20px;
            right: 20px;
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 -2px 20px var(--shadow-light);
            z-index: 100;
            transform: translateY(0);
            transition: transform 0.3s ease;
        }

        .ride-status-bar.active {
            transform: translateY(-20px);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: var(--radius-full);
        }

        .status-dot.searching {
            background: var(--warning-yellow);
            animation: blink 1.5s infinite;
        }

        .status-dot.arriving {
            background: var(--info-blue);
        }

        .status-dot.riding {
            background: var(--success-green);
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .status-text {
            font-weight: 500;
        }

        .status-eta {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-gray);
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .quick-action-btn {
            background: var(--bg-light);
            border-radius: var(--radius-md);
            padding: 15px;
            border: none;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .quick-action-btn:hover {
            background: var(--border-light);
        }

        .quick-action-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            background: var(--primary-orange);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .quick-action-text {
            flex: 1;
        }

        .quick-action-title {
            font-weight: 600;
            margin-bottom: 3px;
        }

        .quick-action-desc {
            font-size: 12px;
            color: var(--text-gray);
        }

        /* Emergency Services */
        .emergency-services {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .emergency-service {
            background: var(--bg-light);
            border-radius: var(--radius-lg);
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .emergency-service:hover {
            border-color: var(--error-red);
            transform: translateY(-2px);
        }

        .emergency-icon {
            width: 60px;
            height: 60px;
            border-radius: var(--radius-full);
            background: var(--error-red);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin: 0 auto 15px;
        }

        .emergency-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .emergency-description {
            font-size: 12px;
            color: var(--text-gray);
        }

        /* History Screen */
        .history-screen,
        .account-screen,
        .emergency-screen {
            display: none;
            height: calc(100% - 50px);
            overflow-y: auto;
            padding: 20px;
        }

        .screen-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .back-btn {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            background: var(--bg-light);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            cursor: pointer;
            color: var(--text-dark);
        }

        .screen-title {
            font-size: 20px;
            font-weight: 600;
        }

        .history-filters {
            display: flex;
            overflow-x: auto;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 10px;
        }

        .filter-btn {
            padding: 8px 15px;
            background: var(--bg-light);
            border: none;
            border-radius: var(--radius-full);
            font-size: 12px;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn.active {
            background: var(--primary-orange);
            color: white;
        }

        .history-item {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px var(--shadow-light);
        }

        /* Account Screen */
        .account-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .account-avatar {
            width: 80px;
            height: 80px;
            border-radius: var(--radius-full);
            background: var(--primary-orange);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            margin: 0 auto 15px;
        }

        .account-name {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .account-phone {
            color: var(--text-gray);
        }

        .account-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-light);
            border-radius: var(--radius-md);
            padding: 15px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
            color: var(--primary-orange);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-gray);
        }

        .account-section {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px var(--shadow-light);
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-dark);
        }

        .section-title i {
            color: var(--primary-orange);
        }

        .wallet-balance {
            text-align: center;
            margin-bottom: 20px;
        }

        .balance-label {
            color: var(--text-gray);
            margin-bottom: 5px;
        }

        .balance-amount-large {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary-orange);
        }

        .wallet-actions {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .btn-wallet {
            padding: 12px;
            background: var(--bg-light);
            border: none;
            border-radius: var(--radius-md);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .btn-wallet:hover {
            background: var(--border-light);
        }

        .btn-wallet i {
            font-size: 18px;
            color: var(--primary-orange);
        }

        .referral-card {
            background: linear-gradient(135deg, #FFE8DF, #FFD9C9);
            border-radius: var(--radius-lg);
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }

        .referral-code {
            background: white;
            border: 2px dashed var(--primary-orange);
            border-radius: var(--radius-md);
            padding: 15px;
            font-size: 24px;
            font-weight: 700;
            letter-spacing: 2px;
            margin: 15px 0;
            color: var(--primary-orange);
        }

        .referral-note {
            font-size: 12px;
            color: var(--text-gray);
            margin-top: 10px;
        }

        /* Chat Container */
        .chat-container {
            position: fixed;
            bottom: 45vh;
            right: 20px;
            width: 350px;
            height: 400px;
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            box-shadow: 0 5px 30px var(--shadow-medium);
            z-index: 300;
            display: none;
            flex-direction: column;
        }

        .chat-container.active {
            display: flex;
        }

        .chat-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-title {
            font-weight: 600;
        }

        .chat-close {
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            font-size: 18px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .message {
            margin-bottom: 15px;
            max-width: 80%;
            padding: 10px 15px;
            border-radius: var(--radius-lg);
            font-size: 14px;
        }

        .message.sent {
            background: var(--primary-orange);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }

        .message.received {
            background: var(--bg-light);
            color: var(--text-dark);
            border-bottom-left-radius: 5px;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
            text-align: right;
            margin-top: 5px;
        }

        .chat-input-container {
            padding: 15px;
            border-top: 1px solid var(--border-light);
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid var(--border-light);
            border-radius: var(--radius-md);
            font-size: 14px;
        }

        .chat-send-btn {
            width: 45px;
            height: 45px;
            border-radius: var(--radius-full);
            background: var(--primary-orange);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        /* Pulsing Ride Icon */
        .pulsing-ride-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 60px;
            color: var(--primary-orange);
            z-index: 1000;
            animation: pulse-ride 1.5s infinite;
            pointer-events: none;
        }

        @keyframes pulse-ride {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(1.1); opacity: 0.7; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .service-tabs {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .quick-actions {
                grid-template-columns: 1fr;
            }
            
            .emergency-services {
                grid-template-columns: 1fr;
            }
            
            .wallet-actions {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .chat-container {
                width: calc(100% - 40px);
                height: 300px;
            }
        }

        @media (max-width: 480px) {
            .ride-type-cards {
                grid-template-columns: 1fr;
            }
            
            .service-tabs {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Map Container -->
    <div id="map">
        <div class="map-loading-overlay" id="mapLoadingOverlay">
            <div class="loading-spinner"></div>
            <div class="map-loading-text">Loading map...</div>
        </div>
    </div>
    
    <!-- Top Navigation Bar -->
    <div class="top-bar">
        <div class="logo-container">
            <div class="logo-icon">
                <i class="fas fa-car"></i>
            </div>
            <div class="logo-text" id="userFullName">Loading...</div>
        </div>
        
        <div class="user-actions">
            <div class="balance-badge" id="balanceBadge">
                <i class="fas fa-wallet"></i>
                <span>Balance: <span class="balance-amount" id="walletBalance">ZMW 0.00</span></span>
            </div>
            <div class="notification-bell" id="notificationBell">
                <i class="fas fa-bell"></i>
                <span class="notification-badge" id="notificationCount">0</span>
            </div>
        </div>
    </div>
    
    <!-- City Detection Indicator -->
    <div class="city-detection" id="cityDetection">
        <i class="fas fa-map-marker-alt"></i>
        <span id="currentCityDisplay">Detecting your city...</span>
    </div>
    
    <!-- SOS Button -->
    <div class="sos-button" id="sosButton" style="display: none;">
        <i class="fas fa-exclamation-triangle"></i>
    </div>
    
    <!-- Map Controls -->
    <div class="map-controls">
        <button class="map-control-btn" id="locateMeBtn" title="Locate Me">
            <i class="fas fa-location-arrow"></i>
        </button>
        <button class="map-control-btn" id="zoomInBtn" title="Zoom In">
            <i class="fas fa-plus"></i>
        </button>
        <button class="map-control-btn" id="zoomOutBtn" title="Zoom Out">
            <i class="fas fa-minus"></i>
        </button>
        <button class="map-control-btn" id="clearRouteBtn" title="Clear Route">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <!-- Ride Status Bar -->
    <div class="ride-status-bar" id="rideStatusBar" style="display: none;">
        <div class="status-indicator">
            <div class="status-dot searching" id="statusDot"></div>
            <span class="status-text" id="statusText">Searching for driver</span>
        </div>
        <div class="status-eta">
            <i class="fas fa-clock"></i>
            <span id="etaText">5 min</span>
        </div>
    </div>
    
    <!-- Main Panel -->
    <div class="main-panel" id="mainPanel">
        <div class="panel-handle" id="panelHandle"></div>
        
        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" data-screen="home">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </button>
            <button class="nav-tab" data-screen="history">
                <i class="fas fa-history"></i>
                <span>History</span>
            </button>
            <button class="nav-tab" data-screen="account">
                <i class="fas fa-user"></i>
                <span>Account</span>
            </button>
            <button class="nav-tab" data-screen="emergency">
                <i class="fas fa-ambulance"></i>
                <span>Emergency</span>
            </button>
        </div>
        
        <!-- Home Screen Content -->
        <div id="homeContent">
            <!-- Service Tabs -->
            <div class="service-tabs" id="serviceTabs">
                <div class="service-tab car active" data-service="car">
                    <div class="service-icon">
                        <i class="fas fa-car"></i>
                    </div>
                    <div class="service-name">Car</div>
                    <div class="service-desc">Ride anywhere</div>
                </div>
                
                <div class="service-tab delivery" data-service="delivery">
                    <div class="service-icon">
                        <i class="fas fa-shipping-fast"></i>
                    </div>
                    <div class="service-name">Delivery</div>
                    <div class="service-desc">Send packages</div>
                </div>
                
                <div class="service-tab short-delivery" data-service="short-delivery">
                    <div class="service-icon">
                        <i class="fas fa-bicycle"></i>
                    </div>
                    <div class="service-name">Short Delivery</div>
                    <div class="service-desc">Quick deliveries</div>
                </div>
                
                <div class="service-tab" data-service="express">
                    <div class="service-icon">
                        <i class="fas fa-shopping-bag"></i>
                    </div>
                    <div class="service-name">Express Shopping</div>
                    <div class="service-desc">Shop for you</div>
                </div>
                
                <div class="service-tab" data-service="truck">
                    <div class="service-icon">
                        <i class="fas fa-truck"></i>
                    </div>
                    <div class="service-name">Truck</div>
                    <div class="service-desc">Move items</div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="quick-actions">
                <button class="quick-action-btn" id="moreOptionsBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-ellipsis-h"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">More Options</div>
                        <div class="quick-action-desc">Schedule, share, broadcast</div>
                    </div>
                </button>
                <button class="quick-action-btn" id="broadcastRideBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-broadcast-tower"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">Broadcast Ride</div>
                        <div class="quick-action-desc">Share with friends</div>
                    </div>
                </button>
                <button class="quick-action-btn" id="sosSetupBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">SOS Setup</div>
                        <div class="quick-action-desc">Emergency contacts</div>
                    </div>
                </button>
                <button class="quick-action-btn" id="recentDestinationsBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-history"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">Recent Destinations</div>
                        <div class="quick-action-desc">Quick access</div>
                    </div>
                </button>
            </div>
            
            <!-- Car Service Form (Default) -->
            <div class="ride-request-form active" id="carForm">
                <div class="form-title">
                    <i class="fas fa-car"></i>
                    Book a Ride
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="pickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="pickupLocation" placeholder="Current location" readonly>
                        <div class="suggestion-list" id="pickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="destinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="destinationLocation" placeholder="Where to?" autocomplete="off">
                        <div class="suggestion-list" id="destinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Stops Container -->
                <div id="stopsContainer" style="margin: 10px 0;"></div>
                <button type="button" class="btn btn-secondary" id="addStopBtn" style="width: 100%; margin-bottom: 15px;">
                    <i class="fas fa-plus"></i> Add Stop
                </button>
                
                <!-- Ride Type Selection -->
                <div class="ride-type-selection" id="rideTypeSelection">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                        <span id="rideTypeInfo" style="font-size: 11px; color: var(--text-light); cursor: pointer;">
                            <i class="fas fa-info-circle"></i>
                        </span>
                    </div>
                    
                    <div class="ride-type-cards" id="rideTypeCardsContainer">
                        <div class="ride-type-card economy" data-type="economy">
                            <div class="ride-type-icon">
                                <i class="fas fa-car-side"></i>
                            </div>
                            <div class="ride-type-name">Economy</div>
                            <div class="ride-type-price" id="economyPrice">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card standard selected" data-type="standard">
                            <div class="ride-type-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="ride-type-name">Standard</div>
                            <div class="ride-type-price" id="standardPrice">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card premium" data-type="premium">
                            <div class="ride-type-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="ride-type-name">Premium</div>
                            <div class="ride-type-price" id="premiumPrice">ZMW 0.00</div>
                        </div>
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="fareDisplay" style="display: none;">
                    <div class="fare-label">Estimated Fare</div>
                    <div class="fare-amount" id="estimatedFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="distanceDetail">0 km</span>
                        <span id="timeDetail">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestRideBtn">
                        <i class="fas fa-search"></i>
                        Request Ride
                    </button>
                </div>
            </div>
            
            <!-- Delivery Service Form -->
            <div class="service-form delivery-form" id="deliveryForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-shipping-fast"></i>
                    Package Delivery
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="deliveryPickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="deliveryPickup" placeholder="Pickup location" readonly>
                        <div class="suggestion-list" id="deliveryPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="deliveryDestinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="deliveryDestination" placeholder="Delivery address" autocomplete="off">
                        <div class="suggestion-list" id="deliveryDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Delivery Details -->
                <div class="form-group">
                    <label class="form-label">Parcel Description</label>
                    <input type="text" class="form-control" id="parcelDescription" placeholder="What are you sending?">
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="deliveryFareDisplay" style="display: none;">
                    <div class="fare-label">Delivery Fare</div>
                    <div class="fare-amount" id="deliveryFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="deliveryDistance">0 km</span>
                        <span id="deliveryTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestDeliveryBtn">
                        <i class="fas fa-shipping-fast"></i>
                        Request Delivery
                    </button>
                </div>
            </div>
            
            <!-- Truck Delivery Form -->
            <div class="service-form truck-form" id="truckForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-truck"></i>
                    Truck Delivery
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="truckPickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="truckPickup" placeholder="Pickup location" readonly>
                        <div class="suggestion-list" id="truckPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="truckDestinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="truckDestination" placeholder="Destination" autocomplete="off">
                        <div class="suggestion-list" id="truckDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Item Details -->
                <div class="form-group">
                    <label class="form-label">What are you moving?</label>
                    <input type="text" class="form-control" id="truckItemDescription" placeholder="Furniture, boxes, equipment...">
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="truckFareDisplay" style="display: none;">
                    <div class="fare-label">Truck Fare</div>
                    <div class="fare-amount" id="truckFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="truckDistance">0 km</span>
                        <span id="truckTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestTruckBtn">
                        <i class="fas fa-truck"></i>
                        Request Truck
                    </button>
                </div>
            </div>
            
            <!-- Ride Info Panel -->
            <div class="ride-info-panel" id="rideInfoPanel" style="display: none;">
                <div class="driver-info">
                    <div class="driver-avatar" id="driverAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="driver-details">
                        <div class="driver-name" id="driverName">Driver Name</div>
                        <div class="driver-rating">
                            <i class="fas fa-star"></i>
                            <span id="driverRating">4.8</span>
                        </div>
                        <div class="driver-vehicle">
                            <i class="fas fa-car"></i>
                            <span id="vehicleDetails">Toyota Corolla - ABC 123</span>
                        </div>
                    </div>
                </div>
                
                <!-- Timeline -->
                <div class="timeline" id="rideTimeline">
                    <div class="timeline-step">
                        <div class="step-dot active" id="stepRequested">
                            <i class="fas fa-search"></i>
                        </div>
                        <div class="step-label active">Requested</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepAccepted">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <div class="step-label">Accepted</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepArrived">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="step-label">Arrived</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepStarted">
                            <i class="fas fa-play"></i>
                        </div>
                        <div class="step-label">Started</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepCompleted">
                            <i class="fas fa-flag-checkered"></i>
                        </div>
                        <div class="step-label">Completed</div>
                    </div>
                </div>
                
                <div class="trip-details">
                    <div class="trip-locations">
                        <div class="location-point">
                            <div class="location-marker pickup">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="location-text">
                                <div class="location-label">Pickup</div>
                                <div class="location-address" id="currentPickup">Loading...</div>
                            </div>
                        </div>
                        
                        <div class="location-point">
                            <div class="location-marker destination">
                                <i class="fas fa-flag"></i>
                            </div>
                            <div class="location-text">
                                <div class="location-label">Destination</div>
                                <div class="location-address" id="currentDestination">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Location Details -->
                <div class="location-details">
                    <div class="location-detail-item">
                        <div class="location-detail-icon">
                            <i class="fas fa-road"></i>
                        </div>
                        <div class="location-detail-content">
                            <div class="location-detail-label">Distance</div>
                            <div class="location-detail-value" id="rideDistance">0 km</div>
                        </div>
                    </div>
                    <div class="location-detail-item">
                        <div class="location-detail-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="location-detail-content">
                            <div class="location-detail-label">Estimated Time</div>
                            <div class="location-detail-value" id="rideTime">0 min</div>
                        </div>
                    </div>
                </div>
                
                <div class="fare-breakdown">
                    <div class="fare-row">
                        <span class="fare-label">Base Fare</span>
                        <span class="fare-value" id="baseFareValue">ZMW 15.00</span>
                    </div>
                    <div class="fare-row">
                        <span class="fare-label">Distance</span>
                        <span class="fare-value" id="distanceFareValue">ZMW 5.00</span>
                    </div>
                    <div class="fare-row total">
                        <span class="fare-label">Total Fare</span>
                        <span class="fare-value" id="totalFareValue">ZMW 20.00</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-danger" id="cancelRideBtn">
                        <i class="fas fa-times-circle"></i>
                        Cancel Ride
                    </button>
                    <button class="btn btn-secondary" id="contactDriverBtn">
                        <i class="fas fa-phone"></i>
                        Call Driver
                    </button>
                    <button class="btn btn-secondary" id="openChatBtn">
                        <i class="fas fa-comment"></i>
                        Chat
                    </button>
                </div>
            </div>
        </div>
        
        <!-- History Screen -->
        <div class="history-screen" id="historyScreen">
            <div class="screen-header">
                <button class="back-btn" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div class="screen-title">Ride History</div>
            </div>
            
            <div class="history-filters">
                <button class="filter-btn active" data-filter="all">All</button>
                <button class="filter-btn" data-filter="completed">Completed</button>
                <button class="filter-btn" data-filter="cancelled">Cancelled</button>
                <button class="filter-btn" data-filter="emergency">Emergency</button>
                <button class="filter-btn" data-filter="delivery">Delivery</button>
                <button class="filter-btn" data-filter="truck">Truck</button>
            </div>
            
            <div class="history-list" id="historyList">
                <!-- History items will be inserted here -->
            </div>
        </div>
        
        <!-- Account Screen -->
        <div class="account-screen" id="accountScreen">
            <div class="screen-header">
                <button class="back-btn" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div class="screen-title">My Account</div>
            </div>
            
            <div class="account-header">
                <div class="account-avatar" id="accountAvatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="account-name" id="accountName">Loading...</div>
                <div class="account-phone" id="accountPhone">Loading...</div>
            </div>
            
            <div class="account-stats">
                <div class="stat-card">
                    <div class="stat-value" id="completedRides">0</div>
                    <div class="stat-label">Completed Rides</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="cancelledRides">0</div>
                    <div class="stat-label">Cancelled Rides</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalSpent">ZMW 0</div>
                    <div class="stat-label">Total Spent</div>
                </div>
            </div>
            
            <div class="account-section">
                <div class="section-title">
                    <i class="fas fa-wallet"></i>
                    Wallet Balance
                </div>
                
                <div class="wallet-balance">
                    <div class="balance-label">Available Balance</div>
                    <div class="balance-amount-large" id="accountBalance">ZMW 0.00</div>
                </div>
                
                <div class="wallet-actions">
                    <button class="btn-wallet" id="depositBtn">
                        <i class="fas fa-plus"></i>
                        Deposit
                    </button>
                    <button class="btn-wallet" id="withdrawBtn">
                        <i class="fas fa-minus"></i>
                        Withdraw
                    </button>
                    <button class="btn-wallet" id="transferBtn">
                        <i class="fas fa-exchange-alt"></i>
                        Transfer
                    </button>
                    <button class="btn-wallet" id="transactionsBtn">
                        <i class="fas fa-history"></i>
                        History
                    </button>
                </div>
            </div>
            
            <div class="account-section">
                <div class="section-title">
                    <i class="fas fa-gift"></i>
                    Referral Program
                </div>
                
                <div class="referral-card">
                    <div>Share your referral code and earn ZMW 25 for each friend's first ride</div>
                    <div class="referral-code" id="referralCode">JUBEL-XXXX</div>
                    <button class="btn btn-primary" id="shareReferralBtn">
                        <i class="fas fa-share"></i>
                        Share Code
                    </button>
                    <div class="referral-note">Your friend gets 50% off their first ride</div>
                </div>
            </div>
            
            <div class="account-section">
                <div class="section-title">
                    <i class="fas fa-cog"></i>
                    Settings
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-secondary" id="updateProfileBtn">
                        <i class="fas fa-user-edit"></i>
                        Update Profile
                    </button>
                    <button class="btn btn-secondary" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i>
                        Logout
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Emergency Screen -->
        <div class="emergency-screen" id="emergencyScreen">
            <div class="screen-header">
                <button class="back-btn" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div class="screen-title">Emergency Services</div>
            </div>
            
            <div class="emergency-services">
                <div class="emergency-service police" data-type="police">
                    <div class="emergency-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div class="emergency-name">Police Ride</div>
                    <div class="emergency-description">Emergency transport with police escort</div>
                </div>
                
                <div class="emergency-service fire" data-type="fire">
                    <div class="emergency-icon">
                        <i class="fas fa-fire-extinguisher"></i>
                    </div>
                    <div class="emergency-name">Fire Brigade</div>
                    <div class="emergency-description">Fire emergency response team</div>
                </div>
                
                <div class="emergency-service medical" data-type="medical">
                    <div class="emergency-icon">
                        <i class="fas fa-ambulance"></i>
                    </div>
                    <div class="emergency-name">Hospital Ride</div>
                    <div class="emergency-description">Medical emergency transport</div>
                </div>
                
                <div class="emergency-service" data-type="sos">
                    <div class="emergency-icon" style="background: var(--error-red);">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="emergency-name">SOS Emergency</div>
                    <div class="emergency-description">Immediate emergency assistance</div>
                </div>
            </div>
            
            <div class="emergency-note" style="padding: 20px; background: var(--bg-light); border-radius: var(--radius-md); margin-top: 20px;">
                <p style="font-size: 14px; color: var(--text-gray);"><strong>Important:</strong> Only use emergency services for genuine emergencies. Misuse may result in penalties. In case of immediate danger, call 911 first.</p>
            </div>
        </div>
    </div>
    
    <!-- Chat Container -->
    <div class="chat-container" id="chatContainer">
        <div class="chat-header">
            <div class="chat-title">Chat with Driver</div>
            <button class="chat-close" id="chatClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <!-- Messages will be inserted here -->
        </div>
        <div class="chat-input-container">
            <input type="text" class="chat-input" id="chatInput" placeholder="Type your message...">
            <button class="chat-send-btn" id="chatSend">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
    
    <!-- Modals -->
    
    <!-- Payment Modal -->
    <div class="modal-overlay" id="paymentModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-credit-card"></i>
                    Select Payment Method
                </div>
                <button class="modal-close" data-modal="payment">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <div class="form-label">Available Balance: <span id="paymentBalance">ZMW 0.00</span></div>
                    <div class="form-label">Total Amount: <span id="paymentAmount">ZMW 0.00</span></div>
                </div>
                
                <!-- Referral Discount Section -->
                <div class="referral-discount-section" id="referralDiscountSection" style="display: none; margin-bottom: 20px; padding: 15px; background: var(--bg-light); border-radius: var(--radius-md);">
                    <div class="section-header" style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <i class="fas fa-gift" style="color: var(--primary-orange);"></i>
                        <span style="font-weight: 600;">Referral Discount (50% off)</span>
                    </div>
                    <div class="referral-input-group" style="display: flex; gap: 10px;">
                        <input type="text" id="referralCodeInput" placeholder="Enter referral code" class="form-control" style="flex: 1;">
                        <button id="applyReferralBtn" class="btn btn-primary" style="padding: 12px 20px;">
                            <i class="fas fa-check"></i> Apply
                        </button>
                    </div>
                    <div id="referrerInfo" style="display: none; font-size: 12px; color: var(--success-green); margin-top: 5px;"></div>
                    <div class="discount-breakdown" style="margin-top: 10px;">
                        <div class="price-row" style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>Original Fare:</span>
                            <span id="originalFareAmount">ZMW 0.00</span>
                        </div>
                        <div class="price-row" style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>Discount:</span>
                            <span id="discountAmount" style="color: var(--success-green);">-ZMW 0.00</span>
                        </div>
                        <div class="price-row total" style="display: flex; justify-content: space-between; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-light);">
                            <span>Final Fare:</span>
                            <span id="finalFareAmount" style="font-weight: bold;">ZMW 0.00</span>
                        </div>
                    </div>
                </div>
                
                <div class="payment-methods">
                    <div class="payment-method" data-payment="wallet">
                        <div class="payment-icon">
                            <i class="fas fa-wallet"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Jubel Wallet</div>
                            <div class="payment-info">Pay with your wallet balance</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-payment="mobile">
                        <div class="payment-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Mobile Money</div>
                            <div class="payment-info">Pay via MTN/Zamtel/Airtel</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-payment="cash">
                        <div class="payment-icon">
                            <i class="fas fa-money-bill"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Cash</div>
                            <div class="payment-info">Pay driver directly</div>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmPaymentBtn">
                        <i class="fas fa-check"></i>
                        Confirm Payment
                    </button>
                    <button class="btn btn-secondary" data-modal="payment">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Cancel Ride Modal -->
    <div class="modal-overlay" id="cancelModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-times-circle"></i>
                    Cancel Ride
                </div>
                <button class="modal-close" data-modal="cancel">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <div class="form-label">Please select a reason for cancellation:</div>
                </div>
                
                <div class="cancel-reasons" style="margin-bottom: 20px;">
                    <div class="cancel-reason" data-reason="driver_late" style="display: flex; align-items: center; padding: 12px; border: 2px solid var(--border-light); border-radius: var(--radius-md); margin-bottom: 10px; cursor: pointer;">
                        <div class="reason-icon" style="margin-right: 15px; color: var(--text-light);">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="reason-text">Driver is taking too long</div>
                    </div>
                    
                    <div class="cancel-reason" data-reason="change_plans" style="display: flex; align-items: center; padding: 12px; border: 2px solid var(--border-light); border-radius: var(--radius-md); margin-bottom: 10px; cursor: pointer;">
                        <div class="reason-icon" style="margin-right: 15px; color: var(--text-light);">
                            <i class="fas fa-calendar-times"></i>
                        </div>
                        <div class="reason-text">Change of plans</div>
                    </div>
                    
                    <div class="cancel-reason" data-reason="found_alternative" style="display: flex; align-items: center; padding: 12px; border: 2px solid var(--border-light); border-radius: var(--radius-md); margin-bottom: 10px; cursor: pointer;">
                        <div class="reason-icon" style="margin-right: 15px; color: var(--text-light);">
                            <i class="fas fa-car"></i>
                        </div>
                        <div class="reason-text">Found alternative transport</div>
                    </div>
                    
                    <div class="cancel-reason" data-reason="other" style="display: flex; align-items: center; padding: 12px; border: 2px solid var(--border-light); border-radius: var(--radius-md); margin-bottom: 10px; cursor: pointer;">
                        <div class="reason-icon" style="margin-right: 15px; color: var(--text-light);">
                            <i class="fas fa-ellipsis-h"></i>
                        </div>
                        <div class="reason-text">Other reason</div>
                    </div>
                </div>
                
                <div class="form-group" id="otherReasonGroup" style="display: none;">
                    <label class="form-label">Please specify:</label>
                    <textarea class="form-control form-textarea" id="otherReason" placeholder="Enter your reason here..."></textarea>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-danger" id="confirmCancelBtn">
                        <i class="fas fa-times"></i>
                        Cancel Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="cancel">
                        Go Back
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Loading...</div>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- External JavaScript Libraries -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    
    <script>
        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyDEACX_P4c5q7djJAcA0I7Lk7leO2TlQ74",
            authDomain: "jubel-13e1a.firebaseapp.com",
            databaseURL: "https://jubel-13e1a-default-rtdb.firebaseio.com",
            projectId: "jubel-13e1a",
            storageBucket: "jubel-13e1a.firebasestorage.app",
            messagingSenderId: "882241095445",
            appId: "1:882241095445:web:ee9ca40fddd008ca910b1c"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        const storage = firebase.storage();

        // ============================================
        // GLOBAL STATE MANAGEMENT
        // ============================================
        const AppState = {
            currentUser: null,
            userData: null,
            currentRide: null,
            activeScreen: 'home',
            activeService: 'car',
            walletBalance: 0,
            userLocation: null,
            currentCity: null,
            selectedRideType: 'standard',
            selectedVehicle: null,
            destination: null,
            pickup: null,
            rideFare: 0,
            driverLocation: null,
            chatMessages: [],
            scheduledRides: [],
            emergencyMode: false,
            sosConfig: null,
            searchCache: new Map(),
            lastSearchTime: 0,
            notifications: [],
            unreadNotifications: 0,
            searchHistory: [],
            rideTypes: {
                economy: { base: 15, perKm: 2.5, multiplier: 0.8, min: 10 },
                standard: { base: 20, perKm: 3.0, multiplier: 1.0, min: 15 },
                premium: { base: 30, perKm: 4.0, multiplier: 1.5, min: 25 }
            },
            stops: [],
            referralDiscountApplied: false,
            referralCodeUsed: null,
            referralOwnerName: null,
            realtimeListeners: [],
            chatOpen: false,
            notificationsOpen: false,
            mapInitialized: false
        };

        // ============================================
        // MAP MANAGEMENT
        // ============================================
        let map = null;
        let currentLocationMarker = null;
        let pickupMarker = null;
        let destinationMarker = null;
        let driverMarker = null;
        let routeLayer = null;
        let pulsingIcon = null;

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        const Utils = {
            showToast: function(message, type = 'info', duration = 5000) {
                const toastContainer = document.getElementById('toastContainer');
                if (!toastContainer) return;
                
                const toastId = 'toast-' + Date.now();
                const icons = {
                    success: 'fa-check-circle',
                    error: 'fa-exclamation-circle',
                    warning: 'fa-exclamation-triangle',
                    info: 'fa-info-circle'
                };
                
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.id = toastId;
                toast.innerHTML = `
                    <div class="toast-icon">
                        <i class="fas ${icons[type] || icons.info}"></i>
                    </div>
                    <div class="toast-content">
                        <div class="toast-title">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
                        <div class="toast-message">${message}</div>
                    </div>
                    <button class="toast-close" onclick="document.getElementById('${toastId}').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                toastContainer.appendChild(toast);
                
                setTimeout(() => {
                    const toastElement = document.getElementById(toastId);
                    if (toastElement) toastElement.remove();
                }, duration);
                
                return toastId;
            },
            
            showLoading: function(message = 'Loading...') {
                const overlay = document.getElementById('loadingOverlay');
                const text = document.getElementById('loadingText');
                if (overlay && text) {
                    text.textContent = message;
                    overlay.style.display = 'flex';
                }
            },
            
            hideLoading: function() {
                const overlay = document.getElementById('loadingOverlay');
                if (overlay) {
                    overlay.style.display = 'none';
                }
            },
            
            showMapLoading: function() {
                const mapLoadingOverlay = document.getElementById('mapLoadingOverlay');
                if (mapLoadingOverlay) {
                    mapLoadingOverlay.style.display = 'flex';
                }
            },
            
            hideMapLoading: function() {
                const mapLoadingOverlay = document.getElementById('mapLoadingOverlay');
                if (mapLoadingOverlay) {
                    mapLoadingOverlay.style.display = 'none';
                }
            },
            
            formatCurrency: function(amount) {
                return `ZMW ${parseFloat(amount).toFixed(2)}`;
            },
            
            calculateDistance: function(lat1, lon1, lat2, lon2) {
                const R = 6371;
                const dLat = this.toRad(lat2 - lat1);
                const dLon = this.toRad(lon2 - lon1);
                const a = 
                    Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(this.toRad(lat1)) * Math.cos(this.toRad(lat2)) * 
                    Math.sin(dLon/2) * Math.sin(dLon/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            },
            
            toRad: function(value) {
                return value * Math.PI / 180;
            },
            
            getCityFromCoordinates: async function(lat, lng) {
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=10`);
                    const data = await response.json();
                    
                    if (data.address) {
                        return data.address.city || data.address.town || data.address.village || data.address.county || 'Unknown';
                    }
                    return 'Unknown';
                } catch (error) {
                    console.error('Error getting city:', error);
                    return 'Unknown';
                }
            },
            
            searchLocation: async function(query, city = null) {
                try {
                    let searchQuery = query;
                    if (city) {
                        searchQuery += `, ${city}, Zambia`;
                    }
                    
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&limit=10&countrycodes=zm`);
                    const data = await response.json();
                    
                    return data.map(place => ({
                        id: place.place_id,
                        name: place.display_name.split(',')[0],
                        address: place.display_name,
                        lat: parseFloat(place.lat),
                        lng: parseFloat(place.lon)
                    }));
                } catch (error) {
                    console.error('Search error:', error);
                    return [];
                }
            }
        };

        // ============================================
        // PRICE CALCULATOR
        // ============================================
        const PriceCalculator = {
            calculateRideFare: function(distanceKm, rideType = 'standard', surge = 1.0) {
                const config = AppState.rideTypes[rideType] || AppState.rideTypes.standard;
                let fare = config.base + (distanceKm * config.perKm);
                fare *= config.multiplier;
                fare *= surge;
                fare = Math.max(fare, config.min);
                return Math.round(fare * 100) / 100;
            },
            
            calculateDeliveryFare: function(distanceKm, deliveryType = 'standard') {
                const base = deliveryType === 'express' ? 40 : 25;
                return Math.max(base, distanceKm * 3.0);
            },
            
            calculateTruckFare: function(distanceKm, truckType = 'light') {
                const base = truckType === 'heavy' ? 200 : truckType === 'medium' ? 150 : 100;
                return Math.max(base, distanceKm * 5.0);
            },
            
            estimateTime: function(distanceKm, rideType = 'standard') {
                const baseSpeed = rideType === 'premium' ? 45 : 35;
                let baseTime = (distanceKm / baseSpeed) * 60;
                
                const hour = new Date().getHours();
                if (hour >= 7 && hour <= 9) baseTime *= 1.5;
                else if (hour >= 16 && hour <= 19) baseTime *= 1.4;
                
                return Math.ceil(baseTime) + 5;
            },
            
            getSurgeMultiplier: function() {
                const hour = new Date().getHours();
                const day = new Date().getDay();
                
                if (day >= 1 && day <= 5) {
                    if (hour >= 7 && hour <= 9) return 1.5;
                    if (hour >= 16 && hour <= 19) return 1.8;
                }
                
                if (day === 5 || day === 6) {
                    if (hour >= 20 && hour <= 23) return 2.0;
                }
                
                if (hour >= 22 || hour <= 5) return 1.8;
                
                return 1.0;
            }
        };

        // ============================================
        // UI UPDATER
        // ============================================
        const UIUpdater = {
            updateWalletBalance: function(balance) {
                const walletBalance = document.getElementById('walletBalance');
                const accountBalance = document.getElementById('accountBalance');
                const paymentBalance = document.getElementById('paymentBalance');
                
                if (walletBalance) walletBalance.textContent = Utils.formatCurrency(balance);
                if (accountBalance) accountBalance.textContent = Utils.formatCurrency(balance);
                if (paymentBalance) paymentBalance.textContent = Utils.formatCurrency(balance);
                
                AppState.walletBalance = balance;
            },
            
            updateUserInfo: function(userData) {
                if (userData.name) {
                    const userFullName = document.getElementById('userFullName');
                    const accountName = document.getElementById('accountName');
                    if (userFullName) userFullName.textContent = userData.name;
                    if (accountName) accountName.textContent = userData.name;
                }
                
                if (userData.phone) {
                    const accountPhone = document.getElementById('accountPhone');
                    if (accountPhone) accountPhone.textContent = userData.phone;
                }
                
                if (userData.referralCode) {
                    const referralCode = document.getElementById('referralCode');
                    if (referralCode) referralCode.textContent = userData.referralCode;
                }
            },
            
            updateCityDisplay: function(city) {
                const display = document.getElementById('currentCityDisplay');
                if (display && city) {
                    display.textContent = `City: ${city}`;
                    
                    setTimeout(() => {
                        if (display.parentElement) {
                            display.parentElement.style.display = 'none';
                        }
                    }, 5000);
                }
            },
            
            updateRidePrices: function(distanceKm) {
                const surge = PriceCalculator.getSurgeMultiplier();
                
                // Update ride type prices
                Object.keys(AppState.rideTypes).forEach(type => {
                    const price = PriceCalculator.calculateRideFare(distanceKm, type, surge);
                    const element = document.getElementById(`${type}Price`);
                    if (element) {
                        element.textContent = Utils.formatCurrency(price);
                    }
                });
                
                // Update selected price
                const selectedPrice = PriceCalculator.calculateRideFare(distanceKm, AppState.selectedRideType, surge);
                const estimatedFare = document.getElementById('estimatedFare');
                if (estimatedFare) estimatedFare.textContent = Utils.formatCurrency(selectedPrice);
                
                // Update distance and time
                const time = PriceCalculator.estimateTime(distanceKm, AppState.selectedRideType);
                const distanceDetail = document.getElementById('distanceDetail');
                const timeDetail = document.getElementById('timeDetail');
                
                if (distanceDetail) distanceDetail.textContent = `${distanceKm.toFixed(1)} km`;
                if (timeDetail) timeDetail.textContent = `ETA: ${time} min`;
                
                AppState.rideFare = selectedPrice;
                
                // Show fare display
                const fareDisplay = document.getElementById('fareDisplay');
                if (fareDisplay) fareDisplay.style.display = 'block';
            },
            
            updateDeliveryPrices: function(distanceKm) {
                const fare = PriceCalculator.calculateDeliveryFare(distanceKm);
                const time = PriceCalculator.estimateTime(distanceKm, 'standard');
                
                const fareElement = document.getElementById('deliveryFare');
                const distanceElement = document.getElementById('deliveryDistance');
                const timeElement = document.getElementById('deliveryTime');
                const display = document.getElementById('deliveryFareDisplay');
                
                if (fareElement) fareElement.textContent = Utils.formatCurrency(fare);
                if (distanceElement) distanceElement.textContent = `${distanceKm.toFixed(1)} km`;
                if (timeElement) timeElement.textContent = `ETA: ${time} min`;
                if (display) display.style.display = 'block';
            },
            
            updateTruckPrices: function(distanceKm) {
                const fare = PriceCalculator.calculateTruckFare(distanceKm);
                const time = PriceCalculator.estimateTime(distanceKm, 'standard');
                
                const fareElement = document.getElementById('truckFare');
                const distanceElement = document.getElementById('truckDistance');
                const timeElement = document.getElementById('truckTime');
                const display = document.getElementById('truckFareDisplay');
                
                if (fareElement) fareElement.textContent = Utils.formatCurrency(fare);
                if (distanceElement) distanceElement.textContent = `${distanceKm.toFixed(1)} km`;
                if (timeElement) timeElement.textContent = `ETA: ${time} min`;
                if (display) display.style.display = 'block';
            },
            
            showRideInfo: function(ride) {
                document.querySelectorAll('.ride-request-form, .service-form').forEach(form => {
                    form.style.display = 'none';
                });
                
                const rideInfoPanel = document.getElementById('rideInfoPanel');
                if (rideInfoPanel) {
                    rideInfoPanel.style.display = 'block';
                }
                
                const currentPickup = document.getElementById('currentPickup');
                const currentDestination = document.getElementById('currentDestination');
                const rideDistance = document.getElementById('rideDistance');
                const rideTime = document.getElementById('rideTime');
                
                if (currentPickup) currentPickup.textContent = ride.pickup || 'Loading...';
                if (currentDestination) currentDestination.textContent = ride.destination || 'Loading...';
                if (rideDistance) rideDistance.textContent = ride.distance ? `${ride.distance.toFixed(1)} km` : '0 km';
                if (rideTime) rideTime.textContent = ride.estimatedTime ? `${ride.estimatedTime} min` : '0 min';
                
                // Show ride status bar
                const rideStatusBar = document.getElementById('rideStatusBar');
                if (rideStatusBar) {
                    rideStatusBar.style.display = 'flex';
                }
            },
            
            updateRideStatus: function(status) {
                const statusBar = document.getElementById('rideStatusBar');
                const statusDot = document.getElementById('statusDot');
                const statusText = document.getElementById('statusText');
                const etaText = document.getElementById('etaText');
                
                if (!statusBar || !statusDot || !statusText || !etaText) return;
                
                statusBar.classList.add('active');
                
                switch(status) {
                    case 'requested':
                        statusDot.className = 'status-dot searching';
                        statusText.textContent = 'Searching for driver';
                        etaText.textContent = '5-10 min';
                        
                        this.showPulsingRideIcon();
                        break;
                    case 'accepted':
                        statusDot.className = 'status-dot arriving';
                        statusText.textContent = 'Driver on the way';
                        etaText.textContent = '5 min';
                        break;
                    case 'arrived':
                        statusDot.className = 'status-dot riding';
                        statusText.textContent = 'Driver arrived';
                        etaText.textContent = '0 min';
                        break;
                    case 'started':
                        statusDot.className = 'status-dot riding';
                        statusText.textContent = 'Trip in progress';
                        etaText.textContent = 'En route';
                        break;
                    case 'completed':
                        statusBar.style.display = 'none';
                        break;
                    case 'cancelled':
                        statusBar.style.display = 'none';
                        break;
                }
            },
            
            showPulsingRideIcon: function() {
                this.removePulsingRideIcon();
                
                const serviceType = AppState.activeService;
                let iconClass = 'fa-car';
                
                if (serviceType === 'truck') {
                    iconClass = 'fa-truck';
                } else if (serviceType === 'delivery' || serviceType === 'short-delivery') {
                    iconClass = 'fa-shipping-fast';
                }
                
                pulsingIcon = document.createElement('div');
                pulsingIcon.className = 'pulsing-ride-icon';
                pulsingIcon.innerHTML = `<i class="fas ${iconClass}"></i>`;
                
                const mapContainer = document.getElementById('map');
                if (mapContainer) {
                    mapContainer.appendChild(pulsingIcon);
                }
            },
            
            removePulsingRideIcon: function() {
                if (pulsingIcon) {
                    pulsingIcon.remove();
                    pulsingIcon = null;
                }
            },
            
            updateTimeline: function(status) {
                const steps = ['stepRequested', 'stepAccepted', 'stepArrived', 'stepStarted', 'stepCompleted'];
                const stepLabels = ['Requested', 'Accepted', 'Arrived', 'Started', 'Completed'];
                let currentIndex = stepLabels.indexOf(status);
                
                if (currentIndex === -1) {
                    currentIndex = 0;
                }
                
                steps.forEach((stepId, index) => {
                    const step = document.getElementById(stepId);
                    const label = step?.parentNode.querySelector('.step-label');
                    
                    if (step && label) {
                        if (index < currentIndex) {
                            step.className = 'step-dot completed';
                            label.className = 'step-label';
                        } else if (index === currentIndex) {
                            step.className = 'step-dot active';
                            label.className = 'step-label active';
                        } else {
                            step.className = 'step-dot';
                            label.className = 'step-label';
                        }
                    }
                });
            },
            
            showSearchSuggestions: function(inputId, results) {
                const container = document.getElementById(`${inputId}Suggestions`);
                if (!container) return;
                
                container.innerHTML = '';
                
                if (results.length === 0) {
                    container.innerHTML = '<div class="suggestion-item">No results found</div>';
                } else {
                    results.forEach(result => {
                        const item = document.createElement('div');
                        item.className = 'suggestion-item';
                        item.innerHTML = `
                            <div class="suggestion-icon">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="suggestion-details">
                                <div class="suggestion-name">${result.name}</div>
                                <div class="suggestion-address">${result.address.split(',').slice(0, 2).join(',')}</div>
                            </div>
                        `;
                        
                        item.addEventListener('click', () => {
                            this.selectLocation(inputId, result);
                        });
                        
                        container.appendChild(item);
                    });
                }
                
                container.style.display = 'block';
            },
            
            selectLocation: function(inputId, location) {
                const input = document.getElementById(inputId);
                if (input) {
                    input.value = location.name;
                    
                    if (inputId === 'pickupLocation' || inputId === 'deliveryPickup' || inputId === 'truckPickup') {
                        AppState.pickup = location;
                        this.updatePickupMarker(location);
                    } else {
                        AppState.destination = location;
                        this.updateDestinationMarker(location);
                    }
                    
                    const suggestions = document.getElementById(`${inputId}Suggestions`);
                    if (suggestions) {
                        suggestions.style.display = 'none';
                    }
                    
                    if (AppState.pickup && AppState.destination) {
                        this.calculateAndUpdatePrices();
                        this.drawRoute(AppState.pickup, AppState.destination);
                    }
                }
            },
            
            updatePickupMarker: function(location) {
                if (!map) return;
                
                if (pickupMarker) {
                    pickupMarker.setLatLng([location.lat, location.lng]);
                } else {
                    pickupMarker = L.marker([location.lat, location.lng], {
                        icon: L.divIcon({
                            className: 'pickup-marker',
                            html: '<i class="fas fa-map-marker-alt"></i>',
                            iconSize: [30, 30],
                            iconAnchor: [15, 30]
                        })
                    }).addTo(map).bindPopup('Pickup Location');
                }
            },
            
            updateDestinationMarker: function(location) {
                if (!map) return;
                
                if (destinationMarker) {
                    destinationMarker.setLatLng([location.lat, location.lng]);
                } else {
                    destinationMarker = L.marker([location.lat, location.lng], {
                        icon: L.divIcon({
                            className: 'destination-marker',
                            html: '<i class="fas fa-flag"></i>',
                            iconSize: [30, 30],
                            iconAnchor: [15, 30]
                        })
                    }).addTo(map).bindPopup('Destination');
                }
            },
            
            drawRoute: async function(start, end) {
                if (!map) return;
                
                if (routeLayer) {
                    map.removeLayer(routeLayer);
                }
                
                try {
                    const response = await fetch(
                        `https://router.project-osrm.org/route/v1/driving/${start.lng},${start.lat};${end.lng},${end.lat}?overview=full&geometries=geojson`
                    );
                    
                    if (response.ok) {
                        const data = await response.json();
                        
                        if (data.routes && data.routes.length > 0) {
                            const route = data.routes[0];
                            const routeCoordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                            
                            routeLayer = L.polyline(routeCoordinates, {
                                color: '#FF6B35',
                                weight: 4,
                                opacity: 0.7
                            }).addTo(map);
                            
                            const bounds = L.latLngBounds(routeCoordinates);
                            map.fitBounds(bounds, { padding: [50, 50] });
                            
                            const distance = route.distance / 1000;
                            return distance;
                        }
                    }
                } catch (error) {
                    console.error('Routing error:', error);
                }
                
                return 0;
            },
            
            calculateAndUpdatePrices: function() {
                if (AppState.pickup && AppState.destination) {
                    const distance = Utils.calculateDistance(
                        AppState.pickup.lat, AppState.pickup.lng,
                        AppState.destination.lat, AppState.destination.lng
                    );
                    
                    switch(AppState.activeService) {
                        case 'car':
                            this.updateRidePrices(distance);
                            break;
                        case 'delivery':
                        case 'short-delivery':
                            this.updateDeliveryPrices(distance);
                            break;
                        case 'truck':
                            this.updateTruckPrices(distance);
                            break;
                    }
                }
            },
            
            showDriverInfo: function(driver) {
                const name = document.getElementById('driverName');
                const rating = document.getElementById('driverRating');
                const vehicle = document.getElementById('vehicleDetails');
                
                if (name) name.textContent = driver.name || 'Driver';
                if (rating) rating.textContent = driver.rating?.toFixed(1) || '4.8';
                if (vehicle) vehicle.textContent = `${driver.vehicle?.model || 'Car'} - ${driver.vehicle?.plate || 'ABC 123'}`;
            },
            
            updateDriverMarker: function(location) {
                if (!map) return;
                
                if (driverMarker) {
                    driverMarker.setLatLng([location.lat, location.lng]);
                } else {
                    driverMarker = L.marker([location.lat, location.lng], {
                        icon: L.divIcon({
                            className: 'driver-marker',
                            html: '<i class="fas fa-car"></i>',
                            iconSize: [32, 32],
                            iconAnchor: [16, 32]
                        })
                    }).addTo(map).bindPopup('Your Driver');
                }
            },
            
            showChatMessage: function(message, isSender = false) {
                const container = document.getElementById('chatMessages');
                if (!container) return;
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${isSender ? 'sent' : 'received'}`;
                messageDiv.innerHTML = `
                    <div>${message.text}</div>
                    <div class="message-time">${new Date(message.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                `;
                
                container.appendChild(messageDiv);
                container.scrollTop = container.scrollHeight;
            }
        };

        // ============================================
        // FIREBASE MANAGER
        // ============================================
        const FirebaseManager = {
            async loadUserData(uid) {
                try {
                    Utils.showLoading('Loading your profile...');
                    
                    const snapshot = await database.ref(`users/${uid}`).once('value');
                    AppState.userData = snapshot.val();
                    
                    if (AppState.userData) {
                        AppState.walletBalance = AppState.userData.walletBalance || 0;
                        UIUpdater.updateWalletBalance(AppState.walletBalance);
                        UIUpdater.updateUserInfo(AppState.userData);
                        
                        await this.loadSOSConfig(uid);
                        await this.checkActiveRide(uid);
                        await this.loadRideHistory(uid);
                        
                        this.startRealtimeSync(uid);
                        
                        Utils.hideLoading();
                        return true;
                    } else {
                        Utils.hideLoading();
                        return false;
                    }
                } catch (error) {
                    console.error('Error loading user data:', error);
                    Utils.hideLoading();
                    Utils.showToast('Error loading user data', 'error');
                    return false;
                }
            },
            
            startRealtimeSync: function(uid) {
                this.stopRealtimeSync();
                
                // User data updates
                const userRef = database.ref(`users/${uid}`);
                AppState.realtimeListeners.push(
                    userRef.on('value', (snapshot) => {
                        const userData = snapshot.val();
                        if (userData) {
                            AppState.userData = userData;
                            AppState.walletBalance = userData.walletBalance || 0;
                            UIUpdater.updateWalletBalance(AppState.walletBalance);
                            UIUpdater.updateUserInfo(userData);
                        }
                    })
                );
                
                // Active ride updates
                const activeRideRef = database.ref('rides')
                    .orderByChild('passengerId')
                    .equalTo(uid)
                    .orderByChild('status')
                    .startAt('requested')
                    .endAt('started');
                
                AppState.realtimeListeners.push(
                    activeRideRef.on('value', (snapshot) => {
                        const rides = snapshot.val();
                        if (rides) {
                            const rideId = Object.keys(rides)[0];
                            const ride = { id: rideId, ...rides[rideId] };
                            
                            if (!AppState.currentRide || AppState.currentRide.id !== rideId) {
                                AppState.currentRide = ride;
                                UIUpdater.showRideInfo(ride);
                                
                                if (ride.driverId) {
                                    this.listenToDriverLocation(ride.driverId);
                                    this.loadDriverInfo(ride.driverId);
                                }
                            } else {
                                AppState.currentRide = ride;
                                UIUpdater.updateRideStatus(ride.status);
                                UIUpdater.updateTimeline(ride.status);
                                
                                if (ride.status === 'completed') {
                                    this.handleRideCompletion(ride);
                                }
                            }
                        } else if (AppState.currentRide) {
                            this.resetActiveRide();
                        }
                    })
                );
            },
            
            stopRealtimeSync: function() {
                AppState.realtimeListeners.forEach(listener => {
                    if (listener && typeof listener === 'function') {
                        listener();
                    }
                });
                AppState.realtimeListeners = [];
            },
            
            async loadSOSConfig(uid) {
                try {
                    const snapshot = await database.ref(`sosConfig/${uid}`).once('value');
                    AppState.sosConfig = snapshot.val();
                    
                    if (AppState.sosConfig) {
                        const sosButton = document.getElementById('sosButton');
                        if (sosButton) sosButton.style.display = 'flex';
                    }
                } catch (error) {
                    console.error('Error loading SOS config:', error);
                }
            },
            
            async checkActiveRide(uid) {
                try {
                    const snapshot = await database.ref('rides')
                        .orderByChild('passengerId')
                        .equalTo(uid)
                        .orderByChild('status')
                        .startAt('requested')
                        .endAt('started')
                        .once('value');
                    
                    const rides = snapshot.val();
                    if (rides) {
                        const rideId = Object.keys(rides)[0];
                        AppState.currentRide = { id: rideId, ...rides[rideId] };
                        UIUpdater.showRideInfo(AppState.currentRide);
                        
                        this.listenToRideUpdates(rideId);
                        
                        if (AppState.currentRide.driverId) {
                            this.listenToDriverLocation(AppState.currentRide.driverId);
                            this.loadDriverInfo(AppState.currentRide.driverId);
                        }
                        
                        return true;
                    }
                    return false;
                } catch (error) {
                    console.error('Error checking active ride:', error);
                    return false;
                }
            },
            
            async loadRideHistory(uid) {
                try {
                    const snapshot = await database.ref('rides')
                        .orderByChild('passengerId')
                        .equalTo(uid)
                        .once('value');
                    
                    const rides = snapshot.val();
                    if (rides) {
                        const ridesArray = Object.keys(rides).map(id => ({
                            id,
                            ...rides[id]
                        })).sort((a, b) => b.timestamp - a.timestamp);
                        
                        this.updateHistoryList(ridesArray);
                        this.updateUserStats(ridesArray);
                    }
                } catch (error) {
                    console.error('Error loading ride history:', error);
                }
            },
            
            updateHistoryList: function(rides) {
                const container = document.getElementById('historyList');
                if (!container) return;
                
                container.innerHTML = '';
                
                if (rides.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px 20px;">
                            <i class="fas fa-history" style="font-size: 48px; color: var(--text-light); margin-bottom: 15px;"></i>
                            <div style="font-weight: 600; margin-bottom: 5px;">No rides found</div>
                            <div style="color: var(--text-gray); font-size: 14px;">You haven't taken any rides yet</div>
                        </div>
                    `;
                    return;
                }
                
                rides.forEach(ride => {
                    const item = document.createElement('div');
                    item.className = 'history-item';
                    
                    const date = new Date(ride.timestamp);
                    const typeIcon = ride.serviceType === 'delivery' ? 'fa-shipping-fast' : 
                                   ride.serviceType === 'truck' ? 'fa-truck' : 'fa-car';
                    
                    item.innerHTML = `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="width: 30px; height: 30px; border-radius: 50%; background: var(--primary-orange); display: flex; align-items: center; justify-content: center; color: white;">
                                    <i class="fas ${typeIcon}"></i>
                                </div>
                                <div>
                                    <div style="font-weight: 600;">${ride.pickup?.split(',')[0] || 'Pickup'}</div>
                                    <div style="font-size: 12px; color: var(--text-gray);">to ${ride.destination?.split(',')[0] || 'Destination'}</div>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: 700; color: var(--primary-orange);">${Utils.formatCurrency(ride.fare || 0)}</div>
                                <div style="font-size: 12px; color: var(--text-gray);">${date.toLocaleDateString()}</div>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 12px;">
                            <span style="padding: 3px 10px; background: ${ride.status === 'completed' ? 'var(--success-green)' : 'var(--error-red)'}; color: white; border-radius: var(--radius-full);">
                                ${ride.status?.charAt(0).toUpperCase() + ride.status?.slice(1)}
                            </span>
                            <span>${ride.distance?.toFixed(1) || '0'} km</span>
                        </div>
                    `;
                    
                    container.appendChild(item);
                });
            },
            
            updateUserStats: function(rides) {
                const completed = rides.filter(ride => ride.status === 'completed').length;
                const cancelled = rides.filter(ride => ride.status === 'cancelled').length;
                const totalSpent = rides
                    .filter(ride => ride.status === 'completed')
                    .reduce((sum, ride) => sum + (ride.fare || 0), 0);
                
                const completedRides = document.getElementById('completedRides');
                const cancelledRides = document.getElementById('cancelledRides');
                const totalSpentElement = document.getElementById('totalSpent');
                
                if (completedRides) completedRides.textContent = completed;
                if (cancelledRides) cancelledRides.textContent = cancelled;
                if (totalSpentElement) totalSpentElement.textContent = Utils.formatCurrency(totalSpent);
            },
            
            listenToRideUpdates: function(rideId) {
                const rideRef = database.ref(`rides/${rideId}`);
                
                AppState.realtimeListeners.push(
                    rideRef.on('value', (snapshot) => {
                        const ride = snapshot.val();
                        if (ride) {
                            AppState.currentRide = { id: rideId, ...ride };
                            UIUpdater.updateRideStatus(ride.status);
                            UIUpdater.updateTimeline(ride.status);
                            
                            if (ride.status === 'completed') {
                                this.handleRideCompletion(ride);
                            }
                            
                            if (ride.status === 'cancelled') {
                                this.resetActiveRide();
                            }
                        }
                    })
                );
            },
            
            async loadDriverInfo(driverId) {
                try {
                    const snapshot = await database.ref(`users/${driverId}`).once('value');
                    const driver = snapshot.val();
                    if (driver) {
                        AppState.selectedVehicle = driver;
                        UIUpdater.showDriverInfo(driver);
                    }
                } catch (error) {
                    console.error('Error loading driver info:', error);
                }
            },
            
            listenToDriverLocation(driverId) {
                const locationRef = database.ref(`driverLocations/${driverId}`);
                
                AppState.realtimeListeners.push(
                    locationRef.on('value', (snapshot) => {
                        const location = snapshot.val();
                        if (location) {
                            AppState.driverLocation = {
                                lat: location.latitude,
                                lng: location.longitude
                            };
                            UIUpdater.updateDriverMarker(AppState.driverLocation);
                        }
                    })
                );
            },
            
            async requestRide(rideData) {
                try {
                    Utils.showLoading('Requesting ride...');
                    
                    if (!rideData.pickup || !rideData.destination) {
                        throw new Error('Pickup and destination locations are required');
                    }
                    
                    const rideId = database.ref().child('rides').push().key;
                    
                    if (AppState.referralDiscountApplied && AppState.referralCodeUsed) {
                        rideData.referredBy = AppState.referralCodeUsed;
                        rideData.referralOwnerName = AppState.referralOwnerName;
                        
                        const discountAmount = rideData.fare * 0.5;
                        rideData.fare = rideData.fare - discountAmount;
                        rideData.referralDiscount = discountAmount;
                    }
                    
                    const ride = {
                        id: rideId,
                        ...rideData,
                        status: 'requested',
                        timestamp: Date.now(),
                        passengerId: AppState.currentUser.uid,
                        passengerName: AppState.userData.name,
                        passengerPhone: AppState.userData.phone
                    };
                    
                    await database.ref(`rides/${rideId}`).set(ride);
                    
                    AppState.currentRide = ride;
                    UIUpdater.showRideInfo(ride);
                    UIUpdater.showPulsingRideIcon();
                    
                    Utils.hideLoading();
                    Utils.showToast('Ride requested successfully', 'success');
                    
                    return rideId;
                } catch (error) {
                    console.error('Error requesting ride:', error);
                    Utils.hideLoading();
                    Utils.showToast(error.message, 'error');
                    throw error;
                }
            },
            
            async cancelRide(rideId, reason) {
                try {
                    Utils.showLoading('Cancelling ride...');
                    
                    await database.ref(`rides/${rideId}/status`).set('cancelled');
                    await database.ref(`rides/${rideId}/cancellationReason`).set(reason);
                    await database.ref(`rides/${rideId}/cancelledAt`).set(Date.now());
                    
                    if (AppState.currentRide && AppState.currentRide.fare) {
                        await this.depositMoney(AppState.currentRide.fare);
                    }
                    
                    this.resetActiveRide();
                    
                    Utils.hideLoading();
                    Utils.showToast('Ride cancelled successfully', 'success');
                } catch (error) {
                    console.error('Error cancelling ride:', error);
                    Utils.hideLoading();
                    Utils.showToast('Error cancelling ride', 'error');
                }
            },
            
            async depositMoney(amount) {
                try {
                    const newBalance = AppState.walletBalance + amount;
                    await database.ref(`users/${AppState.currentUser.uid}/walletBalance`).set(newBalance);
                    
                    await database.ref(`walletTransactions/${AppState.currentUser.uid}`).push().set({
                        type: 'deposit',
                        amount: amount,
                        timestamp: Date.now(),
                        newBalance: newBalance
                    });
                    
                    AppState.walletBalance = newBalance;
                    UIUpdater.updateWalletBalance(newBalance);
                    
                    return newBalance;
                } catch (error) {
                    console.error('Error depositing money:', error);
                    throw error;
                }
            },
            
            async withdrawMoney(amount) {
                try {
                    if (AppState.walletBalance < amount) {
                        throw new Error('Insufficient balance');
                    }
                    
                    const newBalance = AppState.walletBalance - amount;
                    await database.ref(`users/${AppState.currentUser.uid}/walletBalance`).set(newBalance);
                    
                    await database.ref(`walletTransactions/${AppState.currentUser.uid}`).push().set({
                        type: 'withdrawal',
                        amount: amount,
                        timestamp: Date.now(),
                        newBalance: newBalance
                    });
                    
                    AppState.walletBalance = newBalance;
                    UIUpdater.updateWalletBalance(newBalance);
                    
                    return newBalance;
                } catch (error) {
                    console.error('Error withdrawing money:', error);
                    throw error;
                }
            },
            
            handleRideCompletion: function(ride) {
                UIUpdater.removePulsingRideIcon();
                
                if (ride.referredBy) {
                    this.processReferralReward(ride.referredBy, ride.id);
                }
                
                setTimeout(() => {
                    this.resetActiveRide();
                }, 5000);
            },
            
            resetActiveRide: function() {
                AppState.currentRide = null;
                UIUpdater.removePulsingRideIcon();
                
                const rideInfoPanel = document.getElementById('rideInfoPanel');
                const rideStatusBar = document.getElementById('rideStatusBar');
                
                if (rideInfoPanel) rideInfoPanel.style.display = 'none';
                if (rideStatusBar) rideStatusBar.style.display = 'none';
                
                // Switch back to home form
                document.getElementById('homeContent').querySelectorAll('.ride-request-form, .service-form').forEach(form => {
                    form.style.display = 'none';
                });
                document.getElementById('carForm').style.display = 'block';
            },
            
            async processReferralReward(referralCode, rideId) {
                try {
                    // Find user by referral code
                    const usersSnapshot = await database.ref('users').orderByChild('referralCode').equalTo(referralCode).once('value');
                    const users = usersSnapshot.val();
                    
                    if (users) {
                        const referrerId = Object.keys(users)[0];
                        const referrer = users[referrerId];
                        
                        // Add referral reward
                        const rewardAmount = 25;
                        const newBalance = (referrer.walletBalance || 0) + rewardAmount;
                        
                        await database.ref(`users/${referrerId}/walletBalance`).set(newBalance);
                        
                        // Record referral transaction
                        await database.ref(`referralTransactions/${referrerId}`).push().set({
                            amount: rewardAmount,
                            rideId: rideId,
                            referredUserId: AppState.currentUser.uid,
                            referredUserName: AppState.userData.name,
                            timestamp: Date.now()
                        });
                        
                        // Send notification to referrer
                        await database.ref(`notifications/${referrerId}`).push().set({
                            title: 'Referral Reward',
                            message: `${AppState.userData.name} used your referral code and completed a ride. You earned ZMW ${rewardAmount.toFixed(2)}!`,
                            type: 'referral',
                            timestamp: Date.now(),
                            read: false
                        });
                    }
                } catch (error) {
                    console.error('Error processing referral reward:', error);
                }
            },
            
            async validateReferralCode(referralCode) {
                try {
                    const usersSnapshot = await database.ref('users').orderByChild('referralCode').equalTo(referralCode).once('value');
                    const users = usersSnapshot.val();
                    
                    if (users) {
                        const userId = Object.keys(users)[0];
                        const user = users[userId];
                        
                        return {
                            valid: true,
                            ownerName: user.name,
                            userId: userId
                        };
                    }
                    
                    return { valid: false };
                } catch (error) {
                    console.error('Error validating referral code:', error);
                    return { valid: false };
                }
            }
        };

        // ============================================
        // INITIALIZATION FUNCTIONS
        // ============================================
        async function initializeApp() {
            try {
                Utils.showLoading('Initializing app...');
                
                // Check authentication
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        AppState.currentUser = user;
                        await FirebaseManager.loadUserData(user.uid);
                    } else {
                        // Redirect to signup page
                        window.location.href = 'signup.html';
                    }
                });
                
                // Initialize map
                initializeMap();
                
                // Setup event listeners
                setupEventListeners();
                
                // Get current location
                getCurrentLocation();
                
                Utils.hideLoading();
                Utils.showToast('Jubel Passenger App Ready', 'success');
                
            } catch (error) {
                console.error('Error initializing app:', error);
                Utils.hideLoading();
                Utils.showToast('Error initializing app', 'error');
            }
        }
        
        function initializeMap() {
            // Set default view to Lusaka, Zambia
            map = L.map('map').setView([-15.4167, 28.2833], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: ' OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
            
            L.control.scale().addTo(map);
            
            Utils.hideMapLoading();
            AppState.mapInitialized = true;
        }
        
        async function getCurrentLocation() {
            if (!navigator.geolocation) {
                Utils.showToast('Geolocation is not supported by your browser', 'warning');
                return;
            }
            
            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    });
                });
                
                const { latitude, longitude } = position.coords;
                AppState.userLocation = { lat: latitude, lng: longitude };
                
                // Update map view
                map.setView([latitude, longitude], 15);
                
                // Add current location marker
                currentLocationMarker = L.marker([latitude, longitude], {
                    icon: L.divIcon({
                        className: 'current-location-marker',
                        html: '<i class="fas fa-user"></i>',
                        iconSize: [24, 24],
                        iconAnchor: [12, 24]
                    })
                }).addTo(map).bindPopup('Your Location');
                
                // Set pickup location
                const pickupInput = document.getElementById('pickupLocation');
                const city = await Utils.getCityFromCoordinates(latitude, longitude);
                AppState.currentCity = city;
                
                pickupInput.value = `Current Location (${city})`;
                AppState.pickup = {
                    lat: latitude,
                    lng: longitude,
                    name: `Current Location (${city})`,
                    address: `Current Location in ${city}`
                };
                
                UIUpdater.updateCityDisplay(city);
                Utils.showToast('Location detected successfully', 'success');
                
            } catch (error) {
                console.error('Geolocation error:', error);
                Utils.showToast('Unable to get your location', 'warning');
            }
        }

        // ============================================
        // EVENT LISTENERS SETUP
        // ============================================
        function setupEventListeners() {
            // Navigation tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const screen = tab.dataset.screen;
                    switchScreen(screen);
                });
            });
            
            // Back buttons
            document.querySelectorAll('.back-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    switchScreen('home');
                });
            });
            
            // Panel handle
            const panelHandle = document.getElementById('panelHandle');
            if (panelHandle) {
                panelHandle.addEventListener('click', () => {
                    const panel = document.getElementById('mainPanel');
                    panel.classList.toggle('collapsed');
                });
            }
            
            // Service tabs
            document.querySelectorAll('.service-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const service = tab.dataset.service;
                    switchService(service);
                });
            });
            
            // Map controls
            document.getElementById('locateMeBtn')?.addEventListener('click', () => {
                if (AppState.userLocation) {
                    map.setView([AppState.userLocation.lat, AppState.userLocation.lng], 15);
                    Utils.showToast('Centered on your location', 'info');
                } else {
                    getCurrentLocation();
                }
            });
            
            document.getElementById('zoomInBtn')?.addEventListener('click', () => {
                map.zoomIn();
            });
            
            document.getElementById('zoomOutBtn')?.addEventListener('click', () => {
                map.zoomOut();
            });
            
            document.getElementById('clearRouteBtn')?.addEventListener('click', () => {
                if (routeLayer) {
                    map.removeLayer(routeLayer);
                    routeLayer = null;
                }
                
                if (destinationMarker) {
                    map.removeLayer(destinationMarker);
                    destinationMarker = null;
                }
                
                const destinationInput = document.getElementById('destinationLocation');
                if (destinationInput) {
                    destinationInput.value = '';
                }
                AppState.destination = null;
                
                const fareDisplay = document.getElementById('fareDisplay');
                if (fareDisplay) fareDisplay.style.display = 'none';
                
                Utils.showToast('Route cleared', 'info');
            });
            
            // Search inputs
            const destinationInput = document.getElementById('destinationLocation');
            if (destinationInput) {
                let searchTimeout;
                
                destinationInput.addEventListener('input', () => {
                    clearTimeout(searchTimeout);
                    
                    const query = destinationInput.value.trim();
                    if (query.length < 2) {
                        const suggestions = document.getElementById('destinationSuggestions');
                        if (suggestions) suggestions.style.display = 'none';
                        return;
                    }
                    
                    searchTimeout = setTimeout(async () => {
                        const results = await Utils.searchLocation(query, AppState.currentCity);
                        UIUpdater.showSearchSuggestions('destination', results);
                    }, 300);
                });
            }
            
            // Ride type selection
            document.querySelectorAll('.ride-type-card').forEach(card => {
                card.addEventListener('click', () => {
                    document.querySelectorAll('.ride-type-card').forEach(c => {
                        c.classList.remove('selected');
                    });
                    
                    card.classList.add('selected');
                    AppState.selectedRideType = card.dataset.type;
                    
                    if (AppState.pickup && AppState.destination) {
                        UIUpdater.calculateAndUpdatePrices();
                    }
                });
            });
            
            // Add stop button
            document.getElementById('addStopBtn')?.addEventListener('click', () => {
                addStop();
            });
            
            // Request Ride button
            document.getElementById('requestRideBtn')?.addEventListener('click', async () => {
                if (!AppState.pickup || !AppState.destination) {
                    Utils.showToast('Please select pickup and destination locations', 'warning');
                    return;
                }
                
                const distance = Utils.calculateDistance(
                    AppState.pickup.lat, AppState.pickup.lng,
                    AppState.destination.lat, AppState.destination.lng
                );
                
                if (distance < 0.5) {
                    Utils.showToast('Minimum ride distance is 0.5 km', 'warning');
                    return;
                }
                
                // Show payment modal
                showPaymentModal('car', AppState.rideFare);
            });
            
            // SOS button
            document.getElementById('sosButton')?.addEventListener('click', () => {
                triggerSOS();
            });
            
            // Cancel Ride button
            document.getElementById('cancelRideBtn')?.addEventListener('click', () => {
                if (AppState.currentRide) {
                    showModal('cancel');
                } else {
                    Utils.showToast('No active ride to cancel', 'warning');
                }
            });
            
            // Contact Driver button
            document.getElementById('contactDriverBtn')?.addEventListener('click', () => {
                if (AppState.currentRide?.driverId) {
                    const driverPhone = AppState.selectedVehicle?.phone;
                    if (driverPhone) {
                        window.open(`tel:${driverPhone}`, '_blank');
                    } else {
                        Utils.showToast('Driver phone number not available', 'warning');
                    }
                } else {
                    Utils.showToast('No driver assigned yet', 'warning');
                }
            });
            
            // Open Chat button
            document.getElementById('openChatBtn')?.addEventListener('click', () => {
                if (AppState.currentRide?.driverId) {
                    document.getElementById('chatContainer').classList.add('active');
                } else {
                    Utils.showToast('No driver assigned yet', 'warning');
                }
            });
            
            // Close Chat button
            document.getElementById('chatClose')?.addEventListener('click', () => {
                document.getElementById('chatContainer').classList.remove('active');
            });
            
            // Send Chat message
            const chatSend = document.getElementById('chatSend');
            const chatInput = document.getElementById('chatInput');
            if (chatSend && chatInput) {
                chatSend.addEventListener('click', async () => {
                    const message = chatInput.value.trim();
                    
                    if (message && AppState.currentRide) {
                        const messageData = {
                            text: message,
                            senderId: AppState.currentUser.uid,
                            senderName: AppState.userData.name,
                            timestamp: Date.now()
                        };
                        
                        UIUpdater.showChatMessage(messageData, true);
                        chatInput.value = '';
                        
                        // In a real app, you would send this to Firebase
                        // await database.ref(`chats/${AppState.currentRide.id}/messages`).push().set(messageData);
                    }
                });
                
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        chatSend.click();
                    }
                });
            }
            
            // Emergency services
            document.querySelectorAll('.emergency-service').forEach(service => {
                service.addEventListener('click', () => {
                    const type = service.dataset.type;
                    
                    if (type === 'sos') {
                        showModal('sos');
                    } else {
                        handleEmergencyService(type);
                    }
                });
            });
            
            // Payment methods
            document.querySelectorAll('.payment-method').forEach(method => {
                method.addEventListener('click', () => {
                    document.querySelectorAll('.payment-method').forEach(m => {
                        m.classList.remove('selected');
                    });
                    method.classList.add('selected');
                });
            });
            
            // Confirm Payment button
            document.getElementById('confirmPaymentBtn')?.addEventListener('click', async () => {
                const selectedMethod = document.querySelector('.payment-method.selected');
                if (!selectedMethod) {
                    Utils.showToast('Please select a payment method', 'warning');
                    return;
                }
                
                const paymentMethod = selectedMethod.dataset.payment;
                let amount = parseFloat(document.getElementById('paymentAmount').textContent.replace('ZMW ', ''));
                
                if (AppState.referralDiscountApplied) {
                    const originalAmount = AppState.rideFare;
                    amount = originalAmount * 0.5;
                }
                
                if (paymentMethod === 'wallet' && AppState.walletBalance < amount) {
                    Utils.showToast('Insufficient wallet balance', 'error');
                    return;
                }
                
                const rideData = {
                    pickup: AppState.pickup.address,
                    pickupDisplay: AppState.pickup.name,
                    destination: AppState.destination.address,
                    destinationDisplay: AppState.destination.name,
                    pickupLat: AppState.pickup.lat,
                    pickupLng: AppState.pickup.lng,
                    destLat: AppState.destination.lat,
                    destLng: AppState.destination.lng,
                    rideType: AppState.selectedRideType,
                    fare: amount,
                    distance: Utils.calculateDistance(
                        AppState.pickup.lat, AppState.pickup.lng,
                        AppState.destination.lat, AppState.destination.lng
                    ),
                    estimatedTime: PriceCalculator.estimateTime(
                        Utils.calculateDistance(
                            AppState.pickup.lat, AppState.pickup.lng,
                            AppState.destination.lat, AppState.destination.lng
                        ),
                        AppState.selectedRideType
                    ),
                    paymentMethod: paymentMethod,
                    stops: AppState.stops
                };
                
                try {
                    if (paymentMethod === 'wallet') {
                        await FirebaseManager.withdrawMoney(amount);
                    }
                    
                    await FirebaseManager.requestRide(rideData);
                    
                    hideModal('payment');
                    
                } catch (error) {
                    console.error('Error processing payment:', error);
                    
                    if (paymentMethod === 'wallet') {
                        await FirebaseManager.depositMoney(amount);
                    }
                }
            });
            
            // Apply Referral button
            document.getElementById('applyReferralBtn')?.addEventListener('click', () => {
                applyReferralDiscount();
            });
            
            // Cancel reasons
            document.querySelectorAll('.cancel-reason[data-reason]').forEach(reason => {
                reason.addEventListener('click', () => {
                    document.querySelectorAll('.cancel-reason').forEach(r => {
                        r.classList.remove('selected');
                    });
                    
                    reason.classList.add('selected');
                    
                    const reasonType = reason.dataset.reason;
                    const otherReasonGroup = document.getElementById('otherReasonGroup');
                    if (otherReasonGroup) {
                        otherReasonGroup.style.display = 
                            reasonType === 'other' ? 'block' : 'none';
                    }
                });
            });
            
            // Confirm Cancel button
            document.getElementById('confirmCancelBtn')?.addEventListener('click', async () => {
                const selectedReason = document.querySelector('.cancel-reason.selected');
                if (!selectedReason) {
                    Utils.showToast('Please select a cancellation reason', 'warning');
                    return;
                }
                
                let reason = selectedReason.dataset.reason;
                if (reason === 'other') {
                    const otherReason = document.getElementById('otherReason')?.value.trim();
                    if (!otherReason) {
                        Utils.showToast('Please specify your reason', 'warning');
                        return;
                    }
                    reason = `other: ${otherReason}`;
                }
                
                if (AppState.currentRide) {
                    await FirebaseManager.cancelRide(AppState.currentRide.id, reason);
                    hideModal('cancel');
                }
            });
            
            // Close modals when clicking overlay
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        overlay.style.display = 'none';
                    }
                });
            });
            
            // Close modals with close button
            document.querySelectorAll('.modal-close').forEach(btn => {
                btn.addEventListener('click', () => {
                    const modal = btn.dataset.modal;
                    hideModal(modal);
                });
            });
            
            // Quick action buttons
            document.getElementById('moreOptionsBtn')?.addEventListener('click', () => {
                Utils.showToast('More options feature coming soon', 'info');
            });
            
            document.getElementById('broadcastRideBtn')?.addEventListener('click', () => {
                Utils.showToast('Broadcast ride feature coming soon', 'info');
            });
            
            document.getElementById('sosSetupBtn')?.addEventListener('click', () => {
                showModal('sos');
            });
            
            document.getElementById('recentDestinationsBtn')?.addEventListener('click', () => {
                Utils.showToast('Recent destinations feature coming soon', 'info');
            });
            
            // Account screen buttons
            document.getElementById('depositBtn')?.addEventListener('click', () => {
                Utils.showToast('Deposit feature coming soon', 'info');
            });
            
            document.getElementById('withdrawBtn')?.addEventListener('click', () => {
                Utils.showToast('Withdraw feature coming soon', 'info');
            });
            
            document.getElementById('transferBtn')?.addEventListener('click', () => {
                Utils.showToast('Transfer feature coming soon', 'info');
            });
            
            document.getElementById('transactionsBtn')?.addEventListener('click', () => {
                Utils.showToast('Transaction history feature coming soon', 'info');
            });
            
            document.getElementById('shareReferralBtn')?.addEventListener('click', () => {
                const referralCode = document.getElementById('referralCode').textContent;
                navigator.clipboard.writeText(referralCode);
                Utils.showToast('Referral code copied to clipboard', 'success');
            });
            
            document.getElementById('updateProfileBtn')?.addEventListener('click', () => {
                Utils.showToast('Update profile feature coming soon', 'info');
            });
            
            document.getElementById('logoutBtn')?.addEventListener('click', () => {
                auth.signOut().then(() => {
                    window.location.href = 'signup.html';
                });
            });
            
            // History filters
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => {
                        b.classList.remove('active');
                    });
                    
                    btn.classList.add('active');
                    AppState.activeFilter = btn.dataset.filter;
                    
                    // In a real app, you would filter the history list here
                    Utils.showToast(`Filtered by: ${btn.textContent}`, 'info');
                });
            });
        }
        
        // ============================================
        // HELPER FUNCTIONS
        // ============================================
        function switchScreen(screen) {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelector(`.nav-tab[data-screen="${screen}"]`)?.classList.add('active');
            
            document.getElementById('homeContent').style.display = 'none';
            document.getElementById('historyScreen').style.display = 'none';
            document.getElementById('accountScreen').style.display = 'none';
            document.getElementById('emergencyScreen').style.display = 'none';
            
            document.getElementById(`${screen}Screen`).style.display = 'block';
            AppState.activeScreen = screen;
            
            if (screen === 'history') {
                FirebaseManager.loadRideHistory(AppState.currentUser.uid);
            }
        }
        
        function switchService(service) {
            document.querySelectorAll('.service-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelector(`.service-tab[data-service="${service}"]`)?.classList.add('active');
            
            document.getElementById('carForm').style.display = 'none';
            document.getElementById('deliveryForm').style.display = 'none';
            document.getElementById('truckForm').style.display = 'none';
            
            AppState.activeService = service;
            
            switch(service) {
                case 'car':
                    document.getElementById('carForm').style.display = 'block';
                    break;
                case 'delivery':
                case 'short-delivery':
                    document.getElementById('deliveryForm').style.display = 'block';
                    break;
                case 'truck':
                    document.getElementById('truckForm').style.display = 'block';
                    break;
            }
        }
        
        function addStop() {
            const stopsContainer = document.getElementById('stopsContainer');
            
            const stopIndex = AppState.stops.length + 1;
            const stopDiv = document.createElement('div');
            stopDiv.className = 'location-input';
            stopDiv.innerHTML = `
                <i class="fas fa-map-pin"></i>
                <input type="text" id="stop${stopIndex}" placeholder="Stop ${stopIndex}">
                <div class="suggestion-list" id="stop${stopIndex}Suggestions"></div>
                <button class="remove-stop" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--error-red); cursor: pointer;">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            stopsContainer.appendChild(stopDiv);
            
            AppState.stops.push({
                id: `stop${stopIndex}`,
                input: stopDiv.querySelector('input'),
                suggestions: stopDiv.querySelector('.suggestion-list')
            });
            
            // Add event listener for the new input
            const stopInput = stopDiv.querySelector('input');
            let searchTimeout;
            
            stopInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                
                const query = stopInput.value.trim();
                if (query.length < 2) {
                    const suggestions = stopDiv.querySelector('.suggestion-list');
                    if (suggestions) suggestions.style.display = 'none';
                    return;
                }
                
                searchTimeout = setTimeout(async () => {
                    const results = await Utils.searchLocation(query, AppState.currentCity);
                    
                    const suggestions = stopDiv.querySelector('.suggestion-list');
                    if (suggestions) {
                        suggestions.innerHTML = '';
                        
                        if (results.length === 0) {
                            suggestions.innerHTML = '<div class="suggestion-item">No results found</div>';
                        } else {
                            results.forEach(result => {
                                const item = document.createElement('div');
                                item.className = 'suggestion-item';
                                item.innerHTML = `
                                    <div class="suggestion-icon">
                                        <i class="fas fa-map-marker-alt"></i>
                                    </div>
                                    <div class="suggestion-details">
                                        <div class="suggestion-name">${result.name}</div>
                                        <div class="suggestion-address">${result.address.split(',').slice(0, 2).join(',')}</div>
                                    </div>
                                `;
                                
                                item.addEventListener('click', () => {
                                    stopInput.value = result.name;
                                    suggestions.style.display = 'none';
                                    
                                    // Recalculate prices with stops
                                    if (AppState.pickup && AppState.destination) {
                                        UIUpdater.calculateAndUpdatePrices();
                                    }
                                });
                                
                                suggestions.appendChild(item);
                            });
                        }
                        
                        suggestions.style.display = 'block';
                    }
                }, 300);
            });
            
            // Add remove functionality
            const removeBtn = stopDiv.querySelector('.remove-stop');
            removeBtn.addEventListener('click', () => {
                stopDiv.remove();
                AppState.stops = AppState.stops.filter(stop => stop.id !== `stop${stopIndex}`);
                
                // Recalculate prices
                if (AppState.pickup && AppState.destination) {
                    UIUpdater.calculateAndUpdatePrices();
                }
            });
        }
        
        function showPaymentModal(serviceType, amount) {
            document.getElementById('paymentAmount').textContent = Utils.formatCurrency(amount);
            
            // Show referral section if not already applied
            if (!AppState.referralDiscountApplied) {
                document.getElementById('referralDiscountSection').style.display = 'block';
                document.getElementById('originalFareAmount').textContent = Utils.formatCurrency(amount);
                document.getElementById('finalFareAmount').textContent = Utils.formatCurrency(amount);
            }
            
            document.getElementById('paymentModal').style.display = 'block';
        }
        
        function hideModal(modalId) {
            document.getElementById(`${modalId}Modal`).style.display = 'none';
        }
        
        async function applyReferralDiscount() {
            const referralCodeInput = document.getElementById('referralCodeInput');
            const referralCode = referralCodeInput.value.trim();
            
            if (!referralCode) {
                Utils.showToast('Please enter a referral code', 'warning');
                return;
            }
            
            const result = await FirebaseManager.validateReferralCode(referralCode);
            
            if (result.valid) {
                AppState.referralDiscountApplied = true;
                AppState.referralCodeUsed = referralCode;
                AppState.referralOwnerName = result.ownerName;
                
                const originalAmount = AppState.rideFare;
                const discountAmount = originalAmount * 0.5;
                const newAmount = originalAmount - discountAmount;
                
                document.getElementById('discountAmount').textContent = Utils.formatCurrency(discountAmount);
                document.getElementById('finalFareAmount').textContent = Utils.formatCurrency(newAmount);
                document.getElementById('paymentAmount').textContent = Utils.formatCurrency(newAmount);
                document.getElementById('referrerInfo').textContent = `Referral from: ${result.ownerName}`;
                document.getElementById('referrerInfo').style.display = 'block';
                
                Utils.showToast(`50% discount applied! Referral from ${result.ownerName}`, 'success');
            } else {
                Utils.showToast('Invalid referral code', 'error');
            }
        }
        
        function triggerSOS() {
            if (!AppState.sosConfig) {
                Utils.showToast('Please setup SOS contacts first', 'warning');
                return;
            }
            
            if (!AppState.currentRide) {
                Utils.showToast('No active ride to report SOS for', 'warning');
                return;
            }
            
            if (confirm('Are you sure you want to send an SOS alert to your emergency contacts?')) {
                // In a real app, you would send SMS/notification to emergency contacts
                Utils.showToast('SOS alert sent to emergency contacts', 'success');
            }
        }
        
        function handleEmergencyService(type) {
            if (!AppState.userLocation) {
                Utils.showToast('Please allow location access for emergency services', 'warning');
                return;
            }
            
            Utils.showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} emergency service requested`, 'warning');
            
            // In a real app, you would handle emergency service request
            // This would include showing nearby stations, calculating emergency fare, etc.
        }

        // ============================================
        // START THE APPLICATION
        // ============================================
        window.addEventListener('load', initializeApp);
    </script>
</body>
</html>
