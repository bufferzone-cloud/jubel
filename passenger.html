<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jubel - Passenger</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* EXTENSIVE CSS - Over 2000 lines of styling */
        :root {
            --primary-orange: #FF6B35;
            --primary-red: #E74C3C;
            --primary-gradient: linear-gradient(135deg, #FF6B35, #E74C3C);
            --secondary-orange: #E55A28;
            --secondary-red: #C0392B;
            --light-orange: #FFF5F0;
            --light-red: #FCE8E6;
            --white: #FFFFFF;
            --off-white: #F9F9F9;
            --light-gray: #F5F5F5;
            --medium-gray: #E0E0E0;
            --dark-gray: #333333;
            --text-gray: #666666;
            --text-light: #888888;
            --success-green: #2ECC71;
            --warning-yellow: #F39C12;
            --info-blue: #3498DB;
            --error-red: #E74C3C;
            --border-color: #EEEEEE;
            --shadow-light: 0 1px 6px rgba(0, 0, 0, 0.08);
            --shadow-medium: 0 2px 12px rgba(0, 0, 0, 0.12);
            --shadow-heavy: 0 4px 20px rgba(0, 0, 0, 0.15);
            --app-padding: 12px;
            --element-radius: 12px;
            --button-radius: 20px;
            --card-radius: 16px;
            --transition-speed: 0.25s;
            --ambulance-blue: #2980B9;
            --fire-truck-red: #C0392B;
            --police-blue: #2C3E50;
            --premium-gold: #FFD700;
            --economy-green: #27AE60;
            --light-truck-brown: #8B4513;
            --delivery-purple: #8E44AD;
            --express-shop-green: #16A085;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }
        
        body {
            background-color: var(--off-white);
            color: var(--dark-gray);
            max-width: 100%;
            overflow-x: hidden;
            height: 100vh;
            font-size: 13px;
            line-height: 1.4;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Map Container */
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 55%;
            z-index: 1;
            background: #f8f9fa;
        }
        
        /* Top Bar Components */
        .top-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 200;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px var(--app-padding);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            height: 56px;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .logo-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-weight: 700;
            font-size: 14px;
            overflow: hidden;
        }
        
        .logo-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .logo-text {
            font-size: 16px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .user-name-display {
            font-size: 14px;
            font-weight: 600;
            color: var(--dark-gray);
            margin-left: 8px;
        }
        
        .user-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .balance-badge {
            background: var(--white);
            padding: 6px 12px;
            border-radius: var(--button-radius);
            box-shadow: var(--shadow-light);
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 600;
            color: var(--dark-gray);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .balance-badge:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }
        
        .balance-amount {
            color: var(--primary-orange);
            font-weight: 700;
            font-size: 13px;
        }
        
        .notification-bell {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
            cursor: pointer;
            position: relative;
            transition: all var(--transition-speed) ease;
        }
        
        .notification-bell:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }
        
        .notification-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            width: 16px;
            height: 16px;
            background: var(--error-red);
            color: var(--white);
            border-radius: 50%;
            font-size: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            border: 2px solid var(--white);
        }
        
        /* Enhanced Notification Panel */
        .notification-panel {
            position: absolute;
            top: 56px;
            right: var(--app-padding);
            width: 320px;
            max-width: 90vw;
            background: var(--white);
            border-radius: var(--card-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 1000;
            display: none;
            flex-direction: column;
            max-height: 70vh;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        
        .notification-panel.active {
            display: flex;
            animation: slideDown 0.3s ease;
        }
        
        .notification-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .notification-title {
            font-weight: 700;
            font-size: 14px;
            color: var(--dark-gray);
        }
        
        .mark-all-read {
            font-size: 12px;
            color: var(--primary-orange);
            cursor: pointer;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all var(--transition-speed) ease;
        }
        
        .mark-all-read:hover {
            background: var(--light-orange);
        }
        
        .notification-list {
            flex: 1;
            overflow-y: auto;
            max-height: 60vh;
        }
        
        .notification-item {
            padding: 14px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }
        
        .notification-item:hover {
            background: var(--light-orange);
        }
        
        .notification-item.unread {
            background: var(--off-white);
        }
        
        .notification-item.unread:hover {
            background: var(--light-orange);
        }
        
        .notification-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .notification-icon.wallet {
            background: var(--success-green);
        }
        
        .notification-icon.ride {
            background: var(--primary-orange);
        }
        
        .notification-icon.promo {
            background: var(--info-blue);
        }
        
        .notification-icon.emergency {
            background: var(--error-red);
        }
        
        .notification-content {
            flex: 1;
        }
        
        .notification-message {
            font-size: 13px;
            color: var(--dark-gray);
            margin-bottom: 4px;
            line-height: 1.4;
        }
        
        .notification-time {
            font-size: 11px;
            color: var(--text-light);
        }
        
        .notification-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        
        .notification-action-btn {
            padding: 4px 8px;
            font-size: 11px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }
        
        .notification-action-btn.view {
            background: var(--light-orange);
            color: var(--primary-orange);
        }
        
        .notification-action-btn.claim {
            background: var(--success-green);
            color: var(--white);
        }
        
        .notification-empty {
            padding: 40px 20px;
            text-align: center;
            color: var(--text-light);
        }
        
        .notification-empty i {
            font-size: 32px;
            margin-bottom: 12px;
            opacity: 0.3;
        }
        
        .notification-empty p {
            font-size: 13px;
        }
        
        /* Ride Status Bar */
        .ride-status-bar {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 150;
            display: none;
            background: var(--white);
            padding: 8px 16px;
            border-radius: var(--button-radius);
            box-shadow: var(--shadow-heavy);
            border: 1px solid var(--border-color);
            align-items: center;
            gap: 10px;
            min-width: 280px;
            max-width: 90%;
        }
        
        .ride-status-bar.active {
            display: flex;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                transform: translateX(-50%) translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--warning-yellow);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.1); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        .status-dot.searching { background: var(--warning-yellow); }
        .status-dot.arriving { background: var(--info-blue); }
        .status-dot.riding { background: var(--success-green); animation: none; }
        
        .status-text {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
        }
        
        .status-eta {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--text-gray);
            font-size: 12px;
            font-weight: 500;
        }
        
        /* Emergency Status */
        .emergency-status {
            position: absolute;
            top: 60px;
            right: var(--app-padding);
            z-index: 150;
            background: linear-gradient(135deg, var(--error-red), #C0392B);
            color: var(--white);
            padding: 8px 14px;
            border-radius: var(--button-radius);
            box-shadow: var(--shadow-heavy);
            display: none;
            align-items: center;
            gap: 6px;
            font-weight: 700;
            font-size: 12px;
            animation: emergencyPulse 1s infinite;
        }
        
        @keyframes emergencyPulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
            70% { transform: scale(1.02); box-shadow: 0 0 0 8px rgba(231, 76, 60, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
        }
        
        /* SOS Button with Pulse Animation */
        .sos-button {
            position: absolute;
            bottom: 160px;
            right: var(--app-padding);
            z-index: 150;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--error-red), #C0392B);
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 14px;
            font-weight: 700;
            box-shadow: var(--shadow-heavy);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            animation: sosPulse 2s infinite;
        }
        
        @keyframes sosPulse {
            0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); }
            100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
        }
        
        .sos-button:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(231, 76, 60, 0.4);
            animation: none;
        }
        
        /* Main Panel */
        .main-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            border-radius: var(--card-radius) var(--card-radius) 0 0;
            box-shadow: 0 -4px 30px rgba(0, 0, 0, 0.1);
            z-index: 100;
            padding: var(--app-padding);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 45vh;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-orange) var(--light-gray);
        }
        
        .main-panel::-webkit-scrollbar {
            width: 4px;
        }
        
        .main-panel::-webkit-scrollbar-track {
            background: var(--light-gray);
            border-radius: 2px;
        }
        
        .main-panel::-webkit-scrollbar-thumb {
            background: var(--primary-orange);
            border-radius: 2px;
        }
        
        .main-panel.collapsed {
            transform: translateY(calc(100% - 48px));
        }
        
        .panel-handle {
            width: 36px;
            height: 3px;
            background: var(--medium-gray);
            border-radius: 2px;
            margin: 0 auto 12px;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .panel-handle:hover {
            background: var(--primary-orange);
            width: 48px;
        }
        
        /* Navigation Tabs */
        .nav-tabs {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            margin-bottom: 12px;
            padding: 4px;
            background: var(--light-gray);
            border-radius: var(--button-radius);
        }
        
        .nav-tab {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 10px 6px;
            border-radius: calc(var(--button-radius) - 4px);
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            color: var(--text-gray);
            font-size: 11px;
            font-weight: 600;
        }
        
        .nav-tab i {
            font-size: 16px;
            transition: all var(--transition-speed) ease;
        }
        
        .nav-tab.active {
            background: var(--white);
            color: var(--primary-orange);
            box-shadow: var(--shadow-light);
        }
        
        .nav-tab.active i {
            color: var(--primary-orange);
            transform: translateY(-2px);
        }
        
        .nav-tab:hover:not(.active) {
            background: rgba(255, 107, 53, 0.1);
            color: var(--primary-orange);
        }
        
        /* Enhanced Quick Actions with Dropdown */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 16px;
            position: relative;
        }
        
        .quick-action-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            text-align: left;
            position: relative;
        }
        
        .quick-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
            border-color: var(--primary-orange);
        }
        
        .quick-action-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: var(--light-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-orange);
            font-size: 16px;
        }
        
        .quick-action-text {
            flex: 1;
        }
        
        .quick-action-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
            margin-bottom: 2px;
        }
        
        .quick-action-desc {
            font-size: 11px;
            color: var(--text-light);
        }
        
        /* More Options Dropdown */
        .more-options-dropdown {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            background: var(--white);
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 200;
            display: none;
            flex-direction: column;
            padding: 8px;
            margin-bottom: 8px;
            border: 1px solid var(--border-color);
        }
        
        .more-options-dropdown.active {
            display: flex;
            animation: fadeInUp 0.2s ease;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .dropdown-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .dropdown-option:hover {
            background: var(--light-orange);
        }
        
        .dropdown-option i {
            width: 24px;
            color: var(--primary-orange);
            font-size: 14px;
        }
        
        .dropdown-option span {
            font-size: 13px;
            font-weight: 600;
            color: var(--dark-gray);
        }
        
        /* Ride Type Selection Tabs */
        .service-tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 16px;
            overflow-x: auto;
            padding-bottom: 4px;
        }
        
        .service-tab {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 12px 16px;
            background: var(--white);
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            min-width: 100px;
            text-align: center;
        }
        
        .service-tab:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .service-tab.active {
            border-color: var(--primary-orange);
            background: var(--light-orange);
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
        }
        
        .service-tab.car.active { border-color: var(--primary-orange); }
        .service-tab.delivery.active { border-color: var(--delivery-purple); background: #F4E6FA; }
        .service-tab.short-delivery.active { border-color: var(--express-shop-green); background: #E1F5FE; }
        
        .service-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--text-gray);
            transition: all var(--transition-speed) ease;
        }
        
        .service-tab.active .service-icon {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .service-tab.delivery.active .service-icon {
            background: var(--delivery-purple);
        }
        
        .service-tab.short-delivery.active .service-icon {
            background: var(--express-shop-green);
        }
        
        .service-name {
            font-weight: 600;
            font-size: 12px;
            color: var(--dark-gray);
        }
        
        .service-desc {
            font-size: 10px;
            color: var(--text-light);
            margin-top: 2px;
        }
        
        /* Ride Request Form */
        .ride-request-form {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }
        
        .form-title {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--dark-gray);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        /* Enhanced Location Inputs with Fast Search */
        .location-inputs {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .location-input {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: var(--off-white);
            border: 2px solid transparent;
            border-radius: var(--element-radius);
            transition: all var(--transition-speed) ease;
            position: relative;
        }
        
        .location-input.active {
            border-color: var(--primary-orange);
            background: var(--white);
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
        }
        
        .location-input i {
            color: var(--primary-orange);
            font-size: 14px;
            width: 18px;
            text-align: center;
        }
        
        .location-input input {
            flex: 1;
            border: none;
            background: transparent;
            outline: none;
            font-size: 13px;
            color: var(--dark-gray);
            font-weight: 500;
            transition: all var(--transition-speed) ease;
        }
        
        .location-input input::placeholder {
            color: var(--text-light);
        }
        
        .location-input input:focus {
            color: var(--dark-gray);
        }
        
        /* Enhanced Suggestion List with Fast Loading */
        .suggestion-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 1000;
            max-height: 250px;
            overflow-y: auto;
            display: none;
            margin-top: 4px;
            animation: fadeIn 0.15s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .suggestion-list.active {
            display: block;
        }
        
        .suggestion-item {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            animation: fadeInItem 0.2s ease;
        }
        
        @keyframes fadeInItem {
            from { opacity: 0; transform: translateY(-2px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .suggestion-item:hover {
            background: var(--light-orange);
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
        
        .suggestion-item.selected {
            background: var(--light-orange);
            border-left: 3px solid var(--primary-orange);
        }
        
        .suggestion-icon {
            color: var(--primary-orange);
            font-size: 12px;
            margin-top: 2px;
        }
        
        .suggestion-details {
            flex: 1;
        }
        
        .suggestion-name {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
            margin-bottom: 2px;
        }
        
        .suggestion-address {
            font-size: 11px;
            color: var(--text-gray);
            line-height: 1.3;
        }
        
        .suggestion-distance {
            font-size: 10px;
            color: var(--text-light);
            margin-top: 2px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .suggestion-loading {
            padding: 20px;
            text-align: center;
            color: var(--text-light);
        }
        
        .suggestion-loading i {
            font-size: 16px;
            margin-bottom: 8px;
            animation: spin 1s linear infinite;
        }
        
        /* Search Loading Indicator */
        .search-loading {
            display: none;
            position: absolute;
            top: 50%;
            right: 12px;
            transform: translateY(-50%);
            width: 14px;
            height: 14px;
            border: 2px solid var(--light-gray);
            border-radius: 50%;
            border-top-color: var(--primary-orange);
            animation: spin 0.6s linear infinite;
        }
        
        .location-input.searching .search-loading {
            display: block;
        }
        
        /* Enhanced Ride Type Selection - Only shows for Car */
        .ride-type-selection {
            margin: 16px 0;
            display: none;
        }
        
        .ride-type-selection.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        .ride-type-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--dark-gray);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .ride-type-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        
        .ride-type-card {
            background: var(--white);
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            padding: 14px 10px;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .ride-type-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .ride-type-card.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
        }
        
        .ride-type-card.economy.selected {
            border-color: var(--economy-green);
            background: #E8F6EF;
        }
        
        .ride-type-card.premium.selected {
            border-color: var(--premium-gold);
            background: #FFF9E6;
        }
        
        .ride-type-icon {
            width: 42px;
            height: 42px;
            border-radius: 10px;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 8px;
            font-size: 18px;
            color: var(--text-gray);
            transition: all var(--transition-speed) ease;
        }
        
        .ride-type-card.selected .ride-type-icon {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .ride-type-card.economy.selected .ride-type-icon {
            background: var(--economy-green);
        }
        
        .ride-type-card.premium.selected .ride-type-icon {
            background: var(--premium-gold);
            color: var(--dark-gray);
        }
        
        .ride-type-name {
            font-weight: 600;
            font-size: 12px;
            color: var(--dark-gray);
            margin-bottom: 2px;
        }
        
        .ride-type-price {
            font-size: 14px;
            font-weight: 700;
            color: var(--primary-orange);
            margin-bottom: 2px;
        }
        
        .ride-type-card.economy .ride-type-price {
            color: var(--economy-green);
        }
        
        .ride-type-card.premium .ride-type-price {
            color: #B8860B;
        }
        
        .ride-type-eta {
            font-size: 10px;
            color: var(--text-light);
        }
        
        /* Fare Display */
        .fare-display {
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            padding: 16px;
            border-radius: var(--element-radius);
            margin: 16px 0;
            text-align: center;
            box-shadow: var(--shadow-medium);
            display: none;
        }
        
        .fare-display.active {
            display: block;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fare-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 2px;
        }
        
        .fare-amount {
            font-size: 26px;
            font-weight: 800;
            margin: 6px 0;
        }
        
        .fare-details {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 11px;
            opacity: 0.9;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-top: 16px;
        }
        
        .btn {
            padding: 14px;
            border: none;
            border-radius: var(--button-radius);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            box-shadow: 0 3px 12px rgba(255, 107, 53, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 16px rgba(255, 107, 53, 0.4);
        }
        
        .btn-secondary {
            background: var(--white);
            color: var(--primary-orange);
            border: 2px solid var(--primary-orange);
        }
        
        .btn-secondary:hover {
            background: var(--light-orange);
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--error-red), #C0392B);
            color: var(--white);
            box-shadow: 0 3px 12px rgba(231, 76, 60, 0.3);
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 16px rgba(231, 76, 60, 0.4);
        }
        
        /* Enhanced Ride Info Panel with Driver Images */
        .ride-info-panel {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-medium);
            border: 1px solid var(--border-color);
            display: none;
        }
        
        .ride-info-panel.active {
            display: block;
            animation: fadeInUp 0.3s ease;
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .driver-info {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .driver-avatar {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--white);
            font-weight: 700;
            overflow: hidden;
            position: relative;
        }
        
        .driver-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .driver-details {
            flex: 1;
        }
        
        .driver-name {
            font-size: 14px;
            font-weight: 700;
            color: var(--dark-gray);
            margin-bottom: 2px;
        }
        
        .driver-rating {
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--warning-yellow);
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 12px;
        }
        
        .driver-vehicle {
            font-size: 12px;
            color: var(--text-gray);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .vehicle-image-container {
            position: relative;
            margin: 12px 0;
            border-radius: var(--element-radius);
            overflow: hidden;
            height: 120px;
            background: var(--off-white);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .vehicle-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        
        .vehicle-image-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--light-orange), var(--white));
            color: var(--primary-orange);
        }
        
        .vehicle-image-placeholder i {
            font-size: 40px;
            margin-bottom: 8px;
        }
        
        .vehicle-image-placeholder span {
            font-size: 12px;
            font-weight: 600;
        }
        
        .trip-details {
            margin-bottom: 16px;
        }
        
        .trip-locations {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .location-point {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        .location-marker {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            color: var(--white);
            font-size: 11px;
        }
        
        .location-marker.pickup {
            background: var(--primary-orange);
        }
        
        .location-marker.destination {
            background: var(--primary-red);
        }
        
        .location-text {
            flex: 1;
        }
        
        .location-label {
            font-size: 11px;
            color: var(--text-light);
            margin-bottom: 2px;
            font-weight: 600;
        }
        
        .location-address {
            font-size: 13px;
            color: var(--dark-gray);
            font-weight: 500;
            line-height: 1.3;
        }
        
        .fare-breakdown {
            background: var(--off-white);
            border-radius: var(--element-radius);
            padding: 14px;
            margin-bottom: 16px;
        }
        
        .fare-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .fare-row:last-child {
            border-bottom: none;
        }
        
        .fare-label {
            font-size: 13px;
            color: var(--text-gray);
        }
        
        .fare-value {
            font-size: 13px;
            font-weight: 600;
            color: var(--dark-gray);
        }
        
        .fare-row.total {
            margin-top: 6px;
            padding-top: 10px;
            border-top: 2px solid var(--border-color);
        }
        
        .fare-row.total .fare-label {
            font-size: 14px;
            font-weight: 700;
            color: var(--dark-gray);
        }
        
        .fare-row.total .fare-value {
            font-size: 18px;
            font-weight: 800;
            color: var(--primary-orange);
        }
        
        /* Enhanced Chat System with Driver Info */
        .chat-container {
            position: absolute;
            bottom: 200px;
            right: var(--app-padding);
            z-index: 300;
            width: 320px;
            max-width: calc(100vw - 40px);
            background: var(--white);
            border-radius: var(--card-radius);
            box-shadow: var(--shadow-heavy);
            display: none;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        
        .chat-container.active {
            display: flex;
            animation: chatSlideUp 0.3s ease;
        }
        
        @keyframes chatSlideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .chat-header {
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            padding: 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .chat-title {
            font-weight: 600;
            font-size: 13px;
        }
        
        .chat-close {
            background: none;
            border: none;
            color: var(--white);
            font-size: 16px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all var(--transition-speed) ease;
        }
        
        .chat-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .chat-messages {
            flex: 1;
            padding: 14px;
            max-height: 250px;
            overflow-y: auto;
            background: var(--off-white);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .message {
            max-width: 80%;
            padding: 8px 12px;
            border-radius: 16px;
            font-size: 13px;
            line-height: 1.3;
            animation: messageIn 0.2s ease;
        }
        
        @keyframes messageIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.sent {
            align-self: flex-end;
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            border-bottom-right-radius: 4px;
        }
        
        .message.received {
            align-self: flex-start;
            background: var(--white);
            color: var(--dark-gray);
            border: 1px solid var(--border-color);
            border-bottom-left-radius: 4px;
        }
        
        .message-time {
            font-size: 10px;
            color: var(--text-light);
            margin-top: 2px;
            text-align: right;
        }
        
        .message.received .message-time {
            color: var(--text-gray);
        }
        
        .chat-input-container {
            padding: 14px;
            background: var(--white);
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 8px;
        }
        
        .chat-input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid var(--border-color);
            border-radius: var(--button-radius);
            font-size: 13px;
            outline: none;
            transition: all var(--transition-speed) ease;
        }
        
        .chat-input:focus {
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
        }
        
        .chat-send-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-speed) ease;
        }
        
        .chat-send-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 3px 10px rgba(255, 107, 53, 0.3);
        }
        
        .chat-notification {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 18px;
            height: 18px;
            background: var(--error-red);
            color: var(--white);
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            animation: bounce 1s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        
        /* Broadcast Ride Modal */
        .broadcast-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
            backdrop-filter: blur(4px);
        }
        
        .broadcast-modal.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        
        .broadcast-container {
            background: var(--white);
            border-radius: var(--card-radius);
            box-shadow: var(--shadow-heavy);
            max-width: 450px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            animation: modalSlideUp 0.3s ease;
        }
        
        .broadcast-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .broadcast-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--dark-gray);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .broadcast-close {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--text-light);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all var(--transition-speed) ease;
        }
        
        .broadcast-close:hover {
            color: var(--error-red);
            background: var(--light-red);
        }
        
        .broadcast-content {
            padding: 20px;
        }
        
        .broadcast-info {
            background: var(--light-orange);
            border-radius: var(--element-radius);
            padding: 16px;
            margin-bottom: 20px;
            border-left: 3px solid var(--primary-orange);
        }
        
        .broadcast-info h4 {
            font-size: 14px;
            margin-bottom: 8px;
            color: var(--dark-gray);
        }
        
        .broadcast-info p {
            font-size: 12px;
            color: var(--text-gray);
            line-height: 1.4;
        }
        
        .broadcast-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .broadcast-input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .broadcast-label {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
        }
        
        .broadcast-input {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 13px;
            transition: all var(--transition-speed) ease;
        }
        
        .broadcast-input:focus {
            outline: none;
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
        }
        
        .broadcast-phone-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 150px;
            overflow-y: auto;
            padding: 8px;
            background: var(--off-white);
            border-radius: var(--element-radius);
        }
        
        .broadcast-phone-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: var(--white);
            border-radius: var(--element-radius);
            border: 1px solid var(--border-color);
        }
        
        .broadcast-phone-item span {
            font-size: 13px;
            color: var(--dark-gray);
        }
        
        .broadcast-remove-phone {
            background: none;
            border: none;
            color: var(--error-red);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all var(--transition-speed) ease;
        }
        
        .broadcast-remove-phone:hover {
            background: var(--light-red);
        }
        
        .broadcast-add-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px;
            background: var(--light-orange);
            border: 2px dashed var(--primary-orange);
            border-radius: var(--element-radius);
            color: var(--primary-orange);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .broadcast-add-btn:hover {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .broadcast-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        /* Modal System */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
            backdrop-filter: blur(4px);
        }
        
        .modal-overlay.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        
        .modal {
            background: var(--white);
            border-radius: var(--card-radius);
            box-shadow: var(--shadow-heavy);
            max-width: 450px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            animation: modalSlideUp 0.3s ease;
        }
        
        @keyframes modalSlideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--dark-gray);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--text-light);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all var(--transition-speed) ease;
        }
        
        .modal-close:hover {
            color: var(--error-red);
            background: var(--light-red);
        }
        
        .modal-content {
            padding: 20px;
        }
        
        /* Enhanced Emergency Modal with Emergency Reasons */
        .emergency-reasons {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin: 16px 0;
        }
        
        .emergency-reason {
            padding: 14px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .emergency-reason:hover {
            border-color: var(--error-red);
            background: var(--light-red);
        }
        
        .emergency-reason.selected {
            border-color: var(--error-red);
            background: var(--light-red);
        }
        
        .emergency-reason-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--light-red);
            color: var(--error-red);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        
        .emergency-reason.selected .emergency-reason-icon {
            background: var(--error-red);
            color: var(--white);
        }
        
        .emergency-reason-text {
            flex: 1;
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
        }
        
        .emergency-other-input {
            margin-top: 16px;
            display: none;
        }
        
        .emergency-other-input.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        .emergency-stations {
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
        }
        
        .emergency-station {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .emergency-station:hover {
            background: var(--light-orange);
        }
        
        .emergency-station.selected {
            background: var(--light-orange);
            border-left: 3px solid var(--primary-orange);
        }
        
        .emergency-station:last-child {
            border-bottom: none;
        }
        
        .emergency-station-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--light-red);
            color: var(--error-red);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        
        .emergency-station-info {
            flex: 1;
        }
        
        .emergency-station-name {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
            margin-bottom: 2px;
        }
        
        .emergency-station-address {
            font-size: 11px;
            color: var(--text-gray);
            margin-bottom: 2px;
        }
        
        .emergency-station-distance {
            font-size: 10px;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .emergency-pickup-details {
            background: var(--off-white);
            border-radius: var(--element-radius);
            padding: 14px;
            margin-top: 16px;
            border-left: 3px solid var(--primary-orange);
        }
        
        .emergency-pickup-title {
            font-weight: 600;
            font-size: 12px;
            color: var(--dark-gray);
            margin-bottom: 6px;
        }
        
        .emergency-pickup-address {
            font-size: 13px;
            color: var(--text-gray);
            line-height: 1.4;
        }
        
        /* Enhanced SOS Setup Modal */
        .sos-contacts {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .sos-contact {
            background: var(--off-white);
            border-radius: var(--element-radius);
            padding: 16px;
            border: 2px solid transparent;
            transition: all var(--transition-speed) ease;
        }
        
        .sos-contact.active {
            border-color: var(--primary-orange);
            background: var(--white);
        }
        
        .sos-contact-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .sos-contact-title {
            font-weight: 600;
            font-size: 14px;
            color: var(--dark-gray);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .sos-contact-badge {
            padding: 2px 8px;
            background: var(--primary-orange);
            color: var(--white);
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
        }
        
        .sos-contact-fields {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .sos-test-btn {
            margin-top: 12px;
            padding: 8px 12px;
            background: var(--light-orange);
            border: 1px solid var(--primary-orange);
            border-radius: var(--element-radius);
            color: var(--primary-orange);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all var(--transition-speed) ease;
        }
        
        .sos-test-btn:hover {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        /* History Screen */
        .history-screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--white);
            z-index: 200;
            display: none;
            flex-direction: column;
            padding-top: 56px;
        }
        
        .history-screen.active {
            display: flex;
            animation: slideInRight 0.3s ease;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        .screen-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: var(--white);
            padding: 14px var(--app-padding);
            border-bottom: 1px solid var(--border-color);
            z-index: 10;
            display: flex;
            align-items: center;
            gap: 14px;
        }
        
        .back-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--dark-gray);
            border: none;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .back-btn:hover {
            background: var(--medium-gray);
            transform: translateX(-2px);
        }
        
        .screen-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--dark-gray);
        }
        
        .history-filters {
            padding: 14px var(--app-padding);
            background: var(--off-white);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 8px;
            overflow-x: auto;
            scrollbar-width: none;
        }
        
        .history-filters::-webkit-scrollbar {
            display: none;
        }
        
        .filter-btn {
            padding: 6px 14px;
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--button-radius);
            font-size: 12px;
            font-weight: 600;
            color: var(--text-gray);
            cursor: pointer;
            white-space: nowrap;
            transition: all var(--transition-speed) ease;
        }
        
        .filter-btn.active {
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            border-color: transparent;
        }
        
        .filter-btn:hover:not(.active) {
            border-color: var(--primary-orange);
            color: var(--primary-orange);
        }
        
        .history-list {
            flex: 1;
            overflow-y: auto;
            padding: 14px var(--app-padding);
        }
        
        .history-item {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 16px;
            margin-bottom: 10px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .history-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
            border-color: var(--primary-orange);
        }
        
        .history-item.expanded {
            margin-bottom: 16px;
        }
        
        .history-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .history-type {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .history-icon {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            background: var(--light-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-orange);
        }
        
        .history-type-name {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
        }
        
        .history-date {
            font-size: 12px;
            color: var(--text-light);
        }
        
        .history-status {
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-completed {
            background: #E8F6EF;
            color: var(--economy-green);
        }
        
        .status-cancelled {
            background: var(--light-red);
            color: var(--error-red);
        }
        
        .status-ongoing {
            background: #E3F2FD;
            color: var(--info-blue);
        }
        
        .history-locations {
            margin-bottom: 10px;
        }
        
        .history-location {
            display: flex;
            align-items: flex-start;
            gap: 6px;
            margin-bottom: 6px;
        }
        
        .history-location i {
            color: var(--text-light);
            margin-top: 2px;
        }
        
        .history-location-text {
            font-size: 12px;
            color: var(--text-gray);
            line-height: 1.3;
        }
        
        .history-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
        }
        
        .history-price {
            font-size: 14px;
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        .history-driver {
            font-size: 12px;
            color: var(--text-gray);
        }
        
        .history-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .history-item.expanded .history-details {
            max-height: 400px;
            margin-top: 14px;
            padding-top: 14px;
            border-top: 1px solid var(--border-color);
        }
        
        .detail-section {
            margin-bottom: 14px;
        }
        
        .detail-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--dark-gray);
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .detail-label {
            font-size: 11px;
            color: var(--text-light);
            font-weight: 500;
        }
        
        .detail-value {
            font-size: 13px;
            color: var(--dark-gray);
            font-weight: 500;
        }
        
        /* Account Screen - Remove Edit Profile Button */
        .account-screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--white);
            z-index: 200;
            display: none;
            flex-direction: column;
            padding-top: 56px;
        }
        
        .account-screen.active {
            display: flex;
        }
        
        .account-header {
            padding: 20px var(--app-padding);
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            text-align: center;
        }
        
        .account-avatar {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            margin: 0 auto 14px;
            border: 3px solid rgba(255, 255, 255, 0.3);
        }
        
        .account-name {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 2px;
        }
        
        .account-phone {
            font-size: 13px;
            opacity: 0.9;
        }
        
        .account-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            padding: 16px var(--app-padding);
            background: var(--white);
        }
        
        .stat-card {
            background: var(--off-white);
            border-radius: var(--element-radius);
            padding: 14px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary-orange);
            margin-bottom: 2px;
        }
        
        .stat-label {
            font-size: 11px;
            color: var(--text-gray);
            font-weight: 500;
        }
        
        .account-section {
            padding: 16px var(--app-padding);
            border-bottom: 1px solid var(--border-color);
        }
        
        .section-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--dark-gray);
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .wallet-balance {
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            padding: 20px;
            border-radius: var(--element-radius);
            text-align: center;
            margin-bottom: 16px;
        }
        
        .balance-label {
            font-size: 13px;
            opacity: 0.9;
            margin-bottom: 6px;
        }
        
        .balance-amount-large {
            font-size: 30px;
            font-weight: 800;
            margin-bottom: 2px;
        }
        
        .wallet-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 14px;
        }
        
        .btn-wallet {
            padding: 10px;
            border: 2px solid var(--primary-orange);
            background: var(--white);
            color: var(--primary-orange);
            border-radius: var(--button-radius);
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .btn-wallet:hover {
            background: var(--primary-orange);
            color: var(--white);
            transform: translateY(-2px);
        }
        
        .referral-card {
            background: var(--light-orange);
            border-radius: var(--element-radius);
            padding: 16px;
            text-align: center;
            margin-top: 14px;
        }
        
        .referral-code {
            background: var(--white);
            padding: 14px;
            border-radius: var(--element-radius);
            margin: 14px 0;
            font-family: monospace;
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-orange);
            letter-spacing: 2px;
        }
        
        .referral-note {
            font-size: 11px;
            color: var(--text-gray);
            margin-top: 6px;
        }
        
        /* Emergency Screen */
        .emergency-screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--white);
            z-index: 200;
            display: none;
            flex-direction: column;
            padding-top: 56px;
        }
        
        .emergency-screen.active {
            display: flex;
        }
        
        .emergency-services {
            padding: 16px var(--app-padding);
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .emergency-service {
            background: var(--white);
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .emergency-service:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-medium);
        }
        
        .emergency-service.police {
            border-color: var(--police-blue);
        }
        
        .emergency-service.police:hover {
            border-color: var(--police-blue);
            box-shadow: 0 6px 20px rgba(44, 62, 80, 0.2);
        }
        
        .emergency-service.fire {
            border-color: var(--fire-truck-red);
        }
        
        .emergency-service.fire:hover {
            border-color: var(--fire-truck-red);
            box-shadow: 0 6px 20px rgba(192, 57, 43, 0.2);
        }
        
        .emergency-service.medical {
            border-color: var(--ambulance-blue);
        }
        
        .emergency-service.medical:hover {
            border-color: var(--ambulance-blue);
            box-shadow: 0 6px 20px rgba(41, 128, 185, 0.2);
        }
        
        .emergency-icon {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin: 0 auto 10px;
            color: var(--white);
        }
        
        .emergency-service.police .emergency-icon {
            background: var(--police-blue);
        }
        
        .emergency-service.fire .emergency-icon {
            background: var(--fire-truck-red);
        }
        
        .emergency-service.medical .emergency-icon {
            background: var(--ambulance-blue);
        }
        
        .emergency-name {
            font-size: 14px;
            font-weight: 700;
            color: var(--dark-gray);
            margin-bottom: 6px;
        }
        
        .emergency-description {
            font-size: 12px;
            color: var(--text-gray);
            line-height: 1.3;
        }
        
        .emergency-note {
            padding: 16px var(--app-padding);
            background: var(--light-red);
            margin: 16px var(--app-padding);
            border-radius: var(--element-radius);
            border-left: 3px solid var(--error-red);
        }
        
        .emergency-note p {
            font-size: 12px;
            color: var(--dark-gray);
            line-height: 1.4;
        }
        
        /* Loading States */
        .loading {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid var(--light-gray);
            border-radius: 50%;
            border-top-color: var(--primary-orange);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            z-index: 10000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
        }
        
        .loading-overlay.active {
            display: flex;
        }
        
        .loading-spinner {
            width: 52px;
            height: 52px;
            border: 4px solid var(--light-gray);
            border-radius: 50%;
            border-top-color: var(--primary-orange);
            animation: spin 1s linear infinite;
        }
        
        .loading-text {
            font-size: 14px;
            font-weight: 600;
            color: var(--dark-gray);
        }
        
        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 90px;
            right: var(--app-padding);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-width: 350px;
        }
        
        .toast {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 14px;
            box-shadow: var(--shadow-heavy);
            border-left: 3px solid var(--primary-orange);
            display: flex;
            align-items: flex-start;
            gap: 10px;
            animation: slideInRight 0.3s ease;
            transform: translateX(0);
            transition: transform 0.3s ease;
        }
        
        .toast.hiding {
            transform: translateX(100%);
        }
        
        .toast-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--light-orange);
            color: var(--primary-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
            margin-bottom: 2px;
        }
        
        .toast-message {
            font-size: 12px;
            color: var(--text-gray);
            line-height: 1.3;
        }
        
        .toast-close {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 16px;
            cursor: pointer;
            padding: 2px;
            border-radius: 4px;
            transition: all var(--transition-speed) ease;
        }
        
        .toast-close:hover {
            color: var(--error-red);
            background: var(--light-red);
        }
        
        .toast.success {
            border-left-color: var(--success-green);
        }
        
        .toast.success .toast-icon {
            background: #E8F6EF;
            color: var(--success-green);
        }
        
        .toast.error {
            border-left-color: var(--error-red);
        }
        
        .toast.error .toast-icon {
            background: var(--light-red);
            color: var(--error-red);
        }
        
        .toast.warning {
            border-left-color: var(--warning-yellow);
        }
        
        .toast.warning .toast-icon {
            background: #FFF3E0;
            color: var(--warning-yellow);
        }
        
        /* Price Calculation Display */
        .price-calculation {
            background: var(--off-white);
            border-radius: var(--element-radius);
            padding: 14px;
            margin: 14px 0;
            font-size: 12px;
            color: var(--text-gray);
        }
        
        .calculation-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }
        
        .calculation-row:last-child {
            margin-bottom: 0;
            padding-top: 6px;
            border-top: 1px solid var(--border-color);
            font-weight: 600;
            color: var(--dark-gray);
        }
        
        /* Cancel Reasons Modal */
        .cancel-reasons {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-bottom: 16px;
        }
        
        .cancel-reason {
            padding: 14px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .cancel-reason:hover {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .cancel-reason.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .reason-icon {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-gray);
        }
        
        .cancel-reason.selected .reason-icon {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .reason-text {
            flex: 1;
            font-weight: 500;
            color: var(--dark-gray);
        }
        
        /* Schedule Ride Form */
        .schedule-form {
            display: none;
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }
        
        .schedule-form.active {
            display: block;
        }
        
        .schedule-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 14px;
        }
        
        /* More Options */
        .more-options {
            display: none;
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }
        
        .more-options.active {
            display: block;
        }
        
        .options-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .option-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 14px;
            background: var(--off-white);
            border: 2px solid transparent;
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .option-btn:hover {
            border-color: var(--primary-orange);
            background: var(--white);
            transform: translateY(-2px);
        }
        
        .option-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: var(--light-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-orange);
            font-size: 16px;
        }
        
        .option-name {
            font-weight: 600;
            font-size: 12px;
            color: var(--dark-gray);
            text-align: center;
        }
        
        /* Empty States */
        .empty-state {
            padding: 50px 16px;
            text-align: center;
            color: var(--text-light);
        }
        
        .empty-icon {
            font-size: 40px;
            margin-bottom: 14px;
            opacity: 0.3;
        }
        
        .empty-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text-gray);
        }
        
        .empty-message {
            font-size: 13px;
            margin-bottom: 16px;
            line-height: 1.4;
        }
        
        /* Service Forms */
        .service-form {
            display: none;
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }
        
        .service-form.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        /* Payment Selection Styles */
        .payment-methods {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin: 16px 0;
        }
        
        .payment-method {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .payment-method:hover {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .payment-method.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .payment-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-gray);
        }
        
        .payment-method.selected .payment-icon {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .payment-details {
            flex: 1;
        }
        
        .payment-name {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
        }
        
        .payment-info {
            font-size: 11px;
            color: var(--text-gray);
            margin-top: 2px;
        }
        
        /* Wallet Transfer Form */
        .transfer-form {
            display: none;
        }
        
        .transfer-form.active {
            display: block;
        }
        
        /* Timeline */
        .timeline {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 16px 0;
            padding: 0 20px;
            position: relative;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            top: 12px;
            left: 10%;
            right: 10%;
            height: 2px;
            background: var(--border-color);
            z-index: 1;
        }
        
        .timeline-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            position: relative;
            z-index: 2;
            flex: 1;
        }
        
        .step-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            font-size: 10px;
            border: 2px solid var(--white);
            transition: all var(--transition-speed) ease;
        }
        
        .step-dot.active {
            background: var(--primary-orange);
            color: var(--white);
            transform: scale(1.1);
        }
        
        .step-dot.completed {
            background: var(--success-green);
            color: var(--white);
        }
        
        .step-label {
            font-size: 11px;
            color: var(--text-light);
            text-align: center;
        }
        
        .step-label.active {
            color: var(--primary-orange);
            font-weight: 600;
        }
        
        /* Parcel Details */
        .parcel-details {
            background: var(--off-white);
            border-radius: var(--element-radius);
            padding: 14px;
            margin: 12px 0;
        }
        
        .parcel-value-input {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .parcel-value-input span {
            font-weight: 600;
            color: var(--text-gray);
        }
        
        .parcel-value-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 13px;
        }
        
        /* Truck Types */
        .truck-types {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 12px 0;
        }
        
        .truck-type {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            text-align: center;
        }
        
        .truck-type:hover {
            border-color: var(--light-truck-brown);
            transform: translateY(-2px);
        }
        
        .truck-type.selected {
            border-color: var(--light-truck-brown);
            background: rgba(139, 69, 19, 0.05);
        }
        
        .truck-icon {
            font-size: 20px;
            color: var(--light-truck-brown);
            margin-bottom: 6px;
        }
        
        .truck-name {
            font-weight: 600;
            font-size: 12px;
            color: var(--dark-gray);
            margin-bottom: 2px;
        }
        
        .truck-capacity {
            font-size: 10px;
            color: var(--text-gray);
        }
        
        /* Item List for Express Shopping */
        .item-list {
            margin: 12px 0;
        }
        
        .item-entry {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .item-entry input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 13px;
        }
        
        .remove-item {
            width: 36px;
            height: 36px;
            border-radius: var(--element-radius);
            background: var(--light-red);
            border: none;
            color: var(--error-red);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .add-item {
            width: 100%;
            padding: 10px;
            background: var(--light-orange);
            border: 2px dashed var(--primary-orange);
            border-radius: var(--element-radius);
            color: var(--primary-orange);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all var(--transition-speed) ease;
        }
        
        .add-item:hover {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        /* Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* Focus Styles */
        *:focus {
            outline: 2px solid var(--primary-orange);
            outline-offset: 2px;
        }
        
        *:focus:not(.focus-visible) {
            outline: none;
        }
        
        /* Print Styles */
        @media print {
            .main-panel,
            .top-bar,
            .chat-container,
            .modal-overlay,
            .sos-button,
            .ride-status-bar,
            .emergency-status {
                display: none !important;
            }
            
            #map {
                position: relative;
                height: 300px;
            }
        }
        
        /* Custom Markers */
        .current-location-marker {
            background: var(--info-blue);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            box-shadow: 0 1px 8px rgba(0,0,0,0.3);
            border: 2px solid white;
        }
        
        .pickup-marker {
            background: var(--primary-orange);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            box-shadow: 0 1px 8px rgba(0,0,0,0.3);
            border: 2px solid white;
        }
        
        .destination-marker {
            background: var(--primary-red);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            box-shadow: 0 1px 8px rgba(0,0,0,0.3);
            border: 2px solid white;
        }
        
        .driver-marker {
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: white;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            box-shadow: 0 1px 8px rgba(0,0,0,0.3);
            border: 2px solid white;
            animation: pulse 2s infinite;
        }
        
        .emergency-vehicle-marker {
            background: var(--error-red);
            color: white;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            box-shadow: 0 1px 8px rgba(0,0,0,0.3);
            border: 2px solid white;
            animation: emergencyPulse 1s infinite;
        }
        
        /* No Results Message */
        .no-results {
            padding: 30px 16px;
            text-align: center;
            color: var(--text-light);
            font-size: 13px;
        }
        
        .no-results i {
            font-size: 28px;
            margin-bottom: 10px;
            opacity: 0.5;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            :root {
                --app-padding: 10px;
                --element-radius: 10px;
                --button-radius: 16px;
            }
            
            .quick-actions {
                grid-template-columns: 1fr;
            }
            
            .ride-type-grid {
                grid-template-columns: 1fr;
            }
            
            .emergency-services {
                grid-template-columns: 1fr;
            }
            
            .chat-container {
                width: calc(100vw - 20px);
                right: 10px;
            }
            
            .detail-grid {
                grid-template-columns: 1fr;
            }
            
            .notification-panel {
                width: calc(100vw - 20px);
                right: 10px;
            }
        }
        
        @media (max-width: 480px) {
            .nav-tabs {
                gap: 4px;
            }
            
            .nav-tab {
                padding: 8px 4px;
                font-size: 10px;
            }
            
            .nav-tab i {
                font-size: 14px;
            }
            
            .balance-badge {
                padding: 5px 8px;
                font-size: 12px;
            }
            
            .service-tab {
                min-width: 85px;
                padding: 10px 12px;
            }
            
            .user-name-display {
                display: none;
            }
        }
        
        /* Broadcast Ride Button */
        .broadcast-ride-btn {
            position: absolute;
            bottom: 230px;
            right: var(--app-padding);
            z-index: 150;
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--info-blue), #2980B9);
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 16px;
            font-weight: 700;
            box-shadow: var(--shadow-heavy);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .broadcast-ride-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(52, 152, 219, 0.4);
        }
        
        .broadcast-ride-btn.active {
            display: flex;
            animation: bounceIn 0.3s ease;
        }
        
        @keyframes bounceIn {
            from { opacity: 0; transform: scale(0.5); }
            to { opacity: 1; transform: scale(1); }
        }
        
        /* Broadcast Tracking Screen */
        .broadcast-tracking {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--white);
            z-index: 250;
            display: none;
            flex-direction: column;
            padding-top: 56px;
        }
        
        .broadcast-tracking.active {
            display: flex;
        }
        
        .broadcast-tracking-header {
            padding: 16px var(--app-padding);
            background: linear-gradient(135deg, var(--info-blue), #2980B9);
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .broadcast-tracking-title {
            font-size: 16px;
            font-weight: 700;
        }
        
        .broadcast-tracking-code {
            font-family: monospace;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .broadcast-tracking-content {
            flex: 1;
            padding: 16px var(--app-padding);
            overflow-y: auto;
        }
        
        .broadcast-participants {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .broadcast-participant {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 16px;
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: var(--shadow-light);
        }
        
        .broadcast-participant-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-gray);
            font-weight: 600;
            overflow: hidden;
        }
        
        .broadcast-participant-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .broadcast-participant-info {
            flex: 1;
        }
        
        .broadcast-participant-name {
            font-weight: 600;
            font-size: 14px;
            color: var(--dark-gray);
            margin-bottom: 2px;
        }
        
        .broadcast-participant-status {
            font-size: 12px;
            color: var(--text-gray);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .status-dot.online {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success-green);
        }
        
        .status-dot.offline {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-light);
        }
        
        .broadcast-tracking-map {
            height: 200px;
            border-radius: var(--element-radius);
            overflow: hidden;
            margin: 16px 0;
            border: 1px solid var(--border-color);
        }
        
        .broadcast-actions-tracking {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        /* Enhanced Form Elements */
        .form-group {
            margin-bottom: 14px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 13px;
            color: var(--dark-gray);
            background: var(--white);
            transition: all var(--transition-speed) ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
        }
        
        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }
    </style>
</head>
<body>
    <!-- Map Container -->
    <div id="map"></div>
    
    <!-- Top Navigation Bar with Logo and User Name -->
    <div class="top-bar">
        <div class="logo-container">
            <div class="logo-icon" id="logoIcon">
                <!-- Jubel Logo will be inserted here -->
            </div>
            <div class="logo-text">Jubel</div>
            <div class="user-name-display" id="userNameDisplay"></div>
        </div>
        
        <div class="user-actions">
            <div class="balance-badge" id="balanceBadge">
                <i class="fas fa-wallet"></i>
                <span>Balance: <span class="balance-amount" id="walletBalance">ZMW 0.00</span></span>
            </div>
            <div class="notification-bell" id="notificationBell">
                <i class="fas fa-bell"></i>
                <span class="notification-badge" id="notificationCount">0</span>
            </div>
        </div>
    </div>
    
    <!-- Notification Panel -->
    <div class="notification-panel" id="notificationPanel">
        <div class="notification-header">
            <div class="notification-title">Notifications</div>
            <div class="mark-all-read" id="markAllRead">Mark all as read</div>
        </div>
        <div class="notification-list" id="notificationList">
            <!-- Notifications will be inserted here -->
        </div>
    </div>
    
    <!-- Ride Status Bar -->
    <div class="ride-status-bar" id="rideStatusBar">
        <div class="status-indicator">
            <div class="status-dot searching" id="statusDot"></div>
            <span class="status-text" id="statusText">Searching for driver</span>
        </div>
        <div class="status-eta">
            <i class="fas fa-clock"></i>
            <span id="etaText">5 min</span>
        </div>
    </div>
    
    <!-- Emergency Status -->
    <div class="emergency-status" id="emergencyStatus">
        <i class="fas fa-exclamation-triangle"></i>
        <span>EMERGENCY RIDE IN PROGRESS</span>
    </div>
    
    <!-- SOS Button -->
    <div class="sos-button" id="sosButton">
        SOS
    </div>
    
    <!-- Broadcast Ride Button -->
    <div class="broadcast-ride-btn" id="broadcastRideBtn">
        <i class="fas fa-share-alt"></i>
    </div>
    
    <!-- Chat Container -->
    <div class="chat-container" id="chatContainer">
        <div class="chat-header">
            <div class="chat-title">Chat with Driver</div>
            <button class="chat-close" id="chatClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <!-- Messages will be inserted here -->
        </div>
        <div class="chat-input-container">
            <input type="text" class="chat-input" id="chatInput" placeholder="Type your message...">
            <button class="chat-send-btn" id="chatSend">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
    
    <!-- Main Panel -->
    <div class="main-panel" id="mainPanel">
        <div class="panel-handle" id="panelHandle"></div>
        
        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" data-screen="home">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </button>
            <button class="nav-tab" data-screen="history">
                <i class="fas fa-history"></i>
                <span>History</span>
            </button>
            <button class="nav-tab" data-screen="account">
                <i class="fas fa-user"></i>
                <span>Account</span>
            </button>
            <button class="nav-tab" data-screen="emergency">
                <i class="fas fa-ambulance"></i>
                <span>Emergency</span>
            </button>
        </div>
        
        <!-- Home Screen Content -->
        <div id="homeContent">
            <!-- Service Tabs -->
            <div class="service-tabs" id="serviceTabs">
                <div class="service-tab car active" data-service="car">
                    <div class="service-icon">
                        <i class="fas fa-car"></i>
                    </div>
                    <div class="service-name">Car</div>
                    <div class="service-desc">Ride anywhere</div>
                </div>
                
                <div class="service-tab delivery" data-service="delivery">
                    <div class="service-icon">
                        <i class="fas fa-shipping-fast"></i>
                    </div>
                    <div class="service-name">Delivery</div>
                    <div class="service-desc">Send packages</div>
                </div>
                
                <div class="service-tab short-delivery" data-service="short-delivery">
                    <div class="service-icon">
                        <i class="fas fa-bicycle"></i>
                    </div>
                    <div class="service-name">Short Delivery</div>
                    <div class="service-desc">Quick deliveries</div>
                </div>
                
                <div class="service-tab" data-service="express">
                    <div class="service-icon">
                        <i class="fas fa-shopping-bag"></i>
                    </div>
                    <div class="service-name">Express Shopping</div>
                    <div class="service-desc">Shop for you</div>
                </div>
                
                <div class="service-tab" data-service="truck">
                    <div class="service-icon">
                        <i class="fas fa-truck"></i>
                    </div>
                    <div class="service-name">Truck</div>
                    <div class="service-desc">Move items</div>
                </div>
            </div>
            
            <!-- Quick Actions with More Options Dropdown -->
            <div class="quick-actions">
                <div class="more-options-dropdown" id="moreOptionsDropdown">
                    <div class="dropdown-option" data-option="schedule">
                        <i class="fas fa-calendar-alt"></i>
                        <span>Schedule Ride</span>
                    </div>
                    <div class="dropdown-option" data-option="order-for-someone">
                        <i class="fas fa-user-friends"></i>
                        <span>Order for Someone</span>
                    </div>
                    <div class="dropdown-option" data-option="share">
                        <i class="fas fa-share-alt"></i>
                        <span>Share Ride</span>
                    </div>
                </div>
                
                <button class="quick-action-btn" id="moreOptionsBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-ellipsis-h"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">More Options</div>
                        <div class="quick-action-desc">Schedule, Order for Someone, Share</div>
                    </div>
                </button>
                
                <button class="quick-action-btn" id="broadcastRideOptionBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-broadcast-tower"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">Broadcast Ride</div>
                        <div class="quick-action-desc">Share ride with friends</div>
                    </div>
                </button>
            </div>
            
            <!-- Car Service Form (Default) -->
            <div class="ride-request-form active" id="carForm">
                <div class="form-title">
                    <i class="fas fa-car"></i>
                    Book a Ride
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="pickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="pickupLocation" placeholder="Current location" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="pickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="destinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="destinationLocation" placeholder="Where to?">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="destinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Ride Type Selection - Only shows for Car -->
                <div class="ride-type-selection" id="rideTypeSelection">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                        <span id="rideTypeInfo" style="font-size: 11px; color: var(--text-light); cursor: pointer;">
                            <i class="fas fa-info-circle"></i>
                        </span>
                    </div>
                    
                    <div class="ride-type-grid">
                        <div class="ride-type-card economy" data-type="economy">
                            <div class="ride-type-icon">
                                <i class="fas fa-car-side"></i>
                            </div>
                            <div class="ride-type-name">Economy</div>
                            <div class="ride-type-price" id="economyPrice">ZMW 0.00</div>
                            <div class="ride-type-eta">ETA: 5-10 min</div>
                        </div>
                        
                        <div class="ride-type-card selected" data-type="standard">
                            <div class="ride-type-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="ride-type-name">Standard</div>
                            <div class="ride-type-price" id="standardPrice">ZMW 0.00</div>
                            <div class="ride-type-eta">ETA: 3-7 min</div>
                        </div>
                        
                        <div class="ride-type-card premium" data-type="premium">
                            <div class="ride-type-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="ride-type-name">Premium</div>
                            <div class="ride-type-price" id="premiumPrice">ZMW 0.00</div>
                            <div class="ride-type-eta">ETA: 2-5 min</div>
                        </div>
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="fareDisplay">
                    <div class="fare-label">Estimated Fare</div>
                    <div class="fare-amount" id="estimatedFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="distanceDetail">0 km</span>
                        <span id="timeDetail">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestRideBtn">
                        <i class="fas fa-search"></i>
                        Request Ride
                    </button>
                </div>
            </div>
            
            <!-- All other forms remain the same as original -->
            <!-- Delivery Service Form -->
            <div class="service-form delivery-form" id="deliveryForm">
                <!-- ... same as original ... -->
            </div>
            
            <!-- Short Delivery Form -->
            <div class="service-form delivery-form" id="shortDeliveryForm">
                <!-- ... same as original ... -->
            </div>
            
            <!-- Express Shopping Form -->
            <div class="service-form express-form" id="expressForm">
                <!-- ... same as original ... -->
            </div>
            
            <!-- Truck Delivery Form -->
            <div class="service-form truck-form" id="truckForm">
                <!-- ... same as original ... -->
            </div>
            
            <!-- Ride Info Panel with Enhanced Driver Info -->
            <div class="ride-info-panel" id="rideInfoPanel">
                <div class="driver-info">
                    <div class="driver-avatar" id="driverAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="driver-details">
                        <div class="driver-name" id="driverName">Driver Name</div>
                        <div class="driver-rating">
                            <i class="fas fa-star"></i>
                            <span id="driverRating">4.8</span>
                        </div>
                        <div class="driver-vehicle">
                            <i class="fas fa-car"></i>
                            <span id="vehicleDetails">Toyota Corolla - ABC 123</span>
                        </div>
                    </div>
                </div>
                
                <!-- Vehicle Image Container -->
                <div class="vehicle-image-container" id="vehicleImageContainer">
                    <div class="vehicle-image-placeholder">
                        <i class="fas fa-car"></i>
                        <span>Vehicle Image</span>
                    </div>
                </div>
                
                <!-- Timeline -->
                <div class="timeline" id="rideTimeline">
                    <div class="timeline-step">
                        <div class="step-dot active" id="stepRequested">
                            <i class="fas fa-search"></i>
                        </div>
                        <div class="step-label active">Requested</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepAccepted">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <div class="step-label">Accepted</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepArrived">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="step-label">Arrived</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepStarted">
                            <i class="fas fa-play"></i>
                        </div>
                        <div class="step-label">Started</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepCompleted">
                            <i class="fas fa-flag-checkered"></i>
                        </div>
                        <div class="step-label">Completed</div>
                    </div>
                </div>
                
                <div class="trip-details">
                    <div class="trip-locations">
                        <div class="location-point">
                            <div class="location-marker pickup">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="location-text">
                                <div class="location-label">Pickup</div>
                                <div class="location-address" id="currentPickup">Loading...</div>
                            </div>
                        </div>
                        
                        <div class="location-point">
                            <div class="location-marker destination">
                                <i class="fas fa-flag"></i>
                            </div>
                            <div class="location-text">
                                <div class="location-label">Destination</div>
                                <div class="location-address" id="currentDestination">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="fare-breakdown">
                    <div class="fare-row">
                        <span class="fare-label">Base Fare</span>
                        <span class="fare-value" id="baseFareValue">ZMW 15.00</span>
                    </div>
                    <div class="fare-row">
                        <span class="fare-label">Distance</span>
                        <span class="fare-value" id="distanceFareValue">ZMW 5.00</span>
                    </div>
                    <div class="fare-row">
                        <span class="fare-label">Ride Type</span>
                        <span class="fare-value" id="rideTypeValue">Standard</span>
                    </div>
                    <div class="fare-row total">
                        <span class="fare-label">Total Fare</span>
                        <span class="fare-value" id="totalFareValue">ZMW 20.00</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-danger" id="cancelRideBtn">
                        <i class="fas fa-times-circle"></i>
                        Cancel Ride
                    </button>
                    <button class="btn btn-secondary" id="contactDriverBtn">
                        <i class="fas fa-phone"></i>
                        Call Driver
                    </button>
                    <button class="btn btn-secondary" id="openChatBtn">
                        <i class="fas fa-comment"></i>
                        Chat
                    </button>
                    <button class="btn btn-primary" id="broadcastRideBtnPanel">
                        <i class="fas fa-broadcast-tower"></i>
                        Broadcast Ride
                    </button>
                </div>
            </div>
            
            <!-- All other forms remain the same as original -->
            <!-- Schedule Ride Form -->
            <div class="schedule-form" id="scheduleForm">
                <!-- ... same as original ... -->
            </div>
            
            <!-- Order for Someone Else Form -->
            <div class="service-form someone-else-form" id="someoneElseForm">
                <!-- ... same as original ... -->
            </div>
            
            <!-- Ride Sharing Form -->
            <div class="service-form share-ride-form" id="shareRideForm">
                <!-- ... same as original ... -->
            </div>
            
            <!-- More Options -->
            <div class="more-options" id="moreOptions">
                <!-- ... same as original ... -->
            </div>
        </div>
    </div>
    
    <!-- All other screens remain the same as original -->
    <!-- History Screen -->
    <div class="history-screen" id="historyScreen">
        <!-- ... same as original ... -->
    </div>
    
    <!-- Account Screen - Removed Edit Profile Button -->
    <div class="account-screen" id="accountScreen">
        <div class="screen-header">
            <button class="back-btn" data-screen="home">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="screen-title">My Account</div>
        </div>
        
        <div class="account-header">
            <div class="account-avatar" id="accountAvatar">
                <i class="fas fa-user"></i>
            </div>
            <div class="account-name" id="accountName">Loading...</div>
            <div class="account-phone" id="accountPhone">Loading...</div>
        </div>
        
        <div class="account-stats">
            <div class="stat-card">
                <div class="stat-value" id="completedRides">0</div>
                <div class="stat-label">Completed Rides</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="cancelledRides">0</div>
                <div class="stat-label">Cancelled Rides</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalSpent">ZMW 0</div>
                <div class="stat-label">Total Spent</div>
            </div>
        </div>
        
        <div class="account-section">
            <div class="section-title">
                <i class="fas fa-wallet"></i>
                Wallet Balance
            </div>
            
            <div class="wallet-balance">
                <div class="balance-label">Available Balance</div>
                <div class="balance-amount-large" id="accountBalance">ZMW 0.00</div>
            </div>
            
            <div class="wallet-actions">
                <button class="btn-wallet" id="depositBtn">
                    <i class="fas fa-plus"></i>
                    Deposit
                </button>
                <button class="btn-wallet" id="withdrawBtn">
                    <i class="fas fa-minus"></i>
                    Withdraw
                </button>
                <button class="btn-wallet" id="transferBtn">
                    <i class="fas fa-exchange-alt"></i>
                    Transfer
                </button>
                <button class="btn-wallet" id="transactionsBtn">
                    <i class="fas fa-history"></i>
                    History
                </button>
            </div>
        </div>
        
        <div class="account-section">
            <div class="section-title">
                <i class="fas fa-gift"></i>
                Referral Program
            </div>
            
            <div class="referral-card">
                <div>Share your referral code and earn ZMW 25 for each friend's first ride</div>
                <div class="referral-code" id="referralCode">JUBEL-XXXX</div>
                <button class="btn btn-primary" id="shareReferralBtn">
                    <i class="fas fa-share"></i>
                    Share Code
                </button>
                <div class="referral-note">Your friend gets 50% off their first ride</div>
            </div>
        </div>
        
        <div class="account-section">
            <div class="section-title">
                <i class="fas fa-cog"></i>
                Settings
            </div>
            
            <div class="action-buttons">
                <!-- Removed Edit Profile Button -->
                <button class="btn btn-secondary" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </button>
            </div>
        </div>
    </div>
    
    <!-- Emergency Screen -->
    <div class="emergency-screen" id="emergencyScreen">
        <!-- ... same as original ... -->
    </div>
    
    <!-- Broadcast Tracking Screen -->
    <div class="broadcast-tracking" id="broadcastTracking">
        <div class="screen-header">
            <button class="back-btn" id="backFromBroadcast">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="screen-title">Ride Broadcast</div>
        </div>
        
        <div class="broadcast-tracking-header">
            <div class="broadcast-tracking-title">Live Tracking</div>
            <div class="broadcast-tracking-code" id="broadcastCode">BC-XXXXXX</div>
        </div>
        
        <div class="broadcast-tracking-content">
            <div class="broadcast-participants" id="broadcastParticipants">
                <!-- Participants will be inserted here -->
            </div>
            
            <div class="broadcast-tracking-map" id="broadcastMap">
                <!-- Map for broadcast tracking -->
            </div>
            
            <div class="broadcast-actions-tracking">
                <button class="btn btn-secondary" id="endBroadcastBtn">
                    <i class="fas fa-stop"></i>
                    End Broadcast
                </button>
                <button class="btn btn-primary" id="inviteMoreBtn">
                    <i class="fas fa-user-plus"></i>
                    Invite More
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    
    <!-- Enhanced Emergency Modal with Reasons -->
    <div class="modal-overlay" id="emergencyModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-ambulance"></i>
                    Emergency Ride Details
                </div>
                <button class="modal-close" data-modal="emergency">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <div class="form-label" id="emergencyServiceType">Select Emergency Service</div>
                    
                    <!-- Emergency Reasons -->
                    <div class="emergency-reasons" id="emergencyReasons">
                        <div class="emergency-reason" data-reason="accident">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-car-crash"></i>
                            </div>
                            <div class="emergency-reason-text">Accident / Collision</div>
                        </div>
                        
                        <div class="emergency-reason" data-reason="medical">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-heartbeat"></i>
                            </div>
                            <div class="emergency-reason-text">Medical Emergency</div>
                        </div>
                        
                        <div class="emergency-reason" data-reason="crime">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="emergency-reason-text">Crime / Safety Threat</div>
                        </div>
                        
                        <div class="emergency-reason" data-reason="fire">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-fire"></i>
                            </div>
                            <div class="emergency-reason-text">Fire Emergency</div>
                        </div>
                        
                        <div class="emergency-reason" data-reason="other">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-ellipsis-h"></i>
                            </div>
                            <div class="emergency-reason-text">Other Emergency</div>
                        </div>
                    </div>
                    
                    <!-- Other Reason Input -->
                    <div class="emergency-other-input" id="emergencyOtherInput">
                        <label class="form-label">Please describe the emergency:</label>
                        <textarea class="form-control form-textarea" id="emergencyOtherDescription" placeholder="Describe the emergency situation..."></textarea>
                    </div>
                </div>
                
                <!-- Emergency Stations -->
                <div class="form-group">
                    <div class="form-label">Select Nearest Emergency Station</div>
                    <div class="emergency-stations" id="emergencyStations">
                        <!-- Emergency stations will be inserted here -->
                    </div>
                </div>
                
                <!-- Pickup Details -->
                <div class="emergency-pickup-details">
                    <div class="emergency-pickup-title">Your Location:</div>
                    <div class="emergency-pickup-address" id="emergencyPickupAddress">Loading your location...</div>
                </div>
                
                <!-- Fare Calculation -->
                <div class="price-calculation">
                    <div class="calculation-row">
                        <span>Emergency Service Fee:</span>
                        <span id="emergencyBaseFare">ZMW 100.00</span>
                    </div>
                    <div class="calculation-row">
                        <span>Distance to Station:</span>
                        <span id="emergencyDistance">0 km</span>
                    </div>
                    <div class="calculation-row">
                        <span>Estimated Time:</span>
                        <span id="emergencyTime">5 min</span>
                    </div>
                    <div class="calculation-row">
                        <span>Total Emergency Fare:</span>
                        <span id="emergencyTotalFare">ZMW 100.00</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-danger" id="confirmEmergencyBtn">
                        <i class="fas fa-exclamation-triangle"></i>
                        Request Emergency Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="emergency">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Enhanced SOS Setup Modal -->
    <div class="modal-overlay" id="sosModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    SOS Emergency Setup
                </div>
                <button class="modal-close" data-modal="sos">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="sos-contacts">
                    <div class="sos-contact active" id="primaryContact">
                        <div class="sos-contact-header">
                            <div class="sos-contact-title">
                                <i class="fas fa-user"></i>
                                Primary Emergency Contact
                                <span class="sos-contact-badge">Required</span>
                            </div>
                        </div>
                        <div class="sos-contact-fields">
                            <div class="form-group">
                                <label class="form-label">Contact Name</label>
                                <input type="text" class="form-control" id="sosContact1Name" placeholder="Full name">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Phone Number</label>
                                <input type="tel" class="form-control" id="sosContact1Phone" placeholder="Phone number">
                            </div>
                        </div>
                        <button class="sos-test-btn" id="testPrimaryContact">
                            <i class="fas fa-bell"></i>
                            Test Notification
                        </button>
                    </div>
                    
                    <div class="sos-contact" id="secondaryContact">
                        <div class="sos-contact-header">
                            <div class="sos-contact-title">
                                <i class="fas fa-user-friends"></i>
                                Secondary Emergency Contact
                                <span class="sos-contact-badge">Optional</span>
                            </div>
                        </div>
                        <div class="sos-contact-fields">
                            <div class="form-group">
                                <label class="form-label">Contact Name</label>
                                <input type="text" class="form-control" id="sosContact2Name" placeholder="Full name">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Phone Number</label>
                                <input type="tel" class="form-control" id="sosContact2Phone" placeholder="Phone number">
                            </div>
                        </div>
                        <button class="sos-test-btn" id="testSecondaryContact">
                            <i class="fas fa-bell"></i>
                            Test Notification
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Emergency Message</label>
                    <textarea class="form-control form-textarea" id="sosMessage" rows="3">
I need help! My current location and ride details will be shared with you.
                    </textarea>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="saveSOSBtn">
                        <i class="fas fa-save"></i>
                        Save SOS Setup
                    </button>
                    <button class="btn btn-secondary" data-modal="sos">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Broadcast Ride Modal -->
    <div class="broadcast-modal" id="broadcastModal">
        <div class="broadcast-container">
            <div class="broadcast-header">
                <div class="broadcast-title">
                    <i class="fas fa-broadcast-tower"></i>
                    Broadcast Ride
                </div>
                <button class="broadcast-close" id="closeBroadcastModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="broadcast-content">
                <div class="broadcast-info">
                    <h4>Share Your Ride</h4>
                    <p>Share your ride details with friends and family so they can track your journey in real-time. They'll receive notifications and can see your location and ETA.</p>
                </div>
                
                <div class="broadcast-form">
                    <div class="broadcast-input-group">
                        <label class="broadcast-label">Add Phone Numbers</label>
                        <div class="broadcast-phone-list" id="broadcastPhoneList">
                            <!-- Phone numbers will be added here -->
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <input type="tel" class="broadcast-input" id="broadcastPhoneInput" placeholder="Enter phone number">
                            <button class="btn btn-secondary" id="addPhoneBtn">
                                <i class="fas fa-plus"></i>
                                Add
                            </button>
                        </div>
                    </div>
                    
                    <div class="broadcast-input-group">
                        <label class="broadcast-label">Custom Message (Optional)</label>
                        <input type="text" class="broadcast-input" id="broadcastMessage" placeholder="Hey! I'm sharing my ride with you">
                    </div>
                    
                    <div class="broadcast-actions">
                        <button class="btn btn-primary" id="startBroadcastBtn">
                            <i class="fas fa-broadcast-tower"></i>
                            Start Broadcast
                        </button>
                        <button class="btn btn-secondary" id="cancelBroadcastBtn">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- All other modals remain the same as original -->
    <!-- Payment Modal -->
    <div class="modal-overlay" id="paymentModal">
        <!-- ... same as original ... -->
    </div>
    
    <!-- Cancel Ride Modal -->
    <div class="modal-overlay" id="cancelModal">
        <!-- ... same as original ... -->
    </div>
    
    <!-- Transfer Money Modal -->
    <div class="modal-overlay" id="transferModal">
        <!-- ... same as original ... -->
    </div>
    
    <!-- Wallet Transactions Modal -->
    <div class="modal-overlay" id="transactionsModal">
        <!-- ... same as original ... -->
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Loading...</div>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Firebase and Leaflet JS -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-messaging.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script>
       // ============================================
// ENHANCED JUBEL PASSENGER APP - COMPLETE REWRITE
// Over 6000 lines of comprehensive functionality
// ============================================

// FIREBASE CONFIGURATION
const firebaseConfig = {
    apiKey: "AIzaSyDEACX_P4c5q7djJAcA0I7Lk7leO2TlQ74",
    authDomain: "jubel-13e1a.firebaseapp.com",
    databaseURL: "https://jubel-13e1a-default-rtdb.firebaseio.com",
    projectId: "jubel-13e1a",
    storageBucket: "jubel-13e1a.firebasestorage.app",
    messagingSenderId: "882241095445",
    appId: "1:882241095445:web:ee9ca40fddd008ca910b1c",
    measurementId: "G-J5JPKL6B5F"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const auth = firebase.auth();

// ============================================
// ENHANCED APP STATE MANAGEMENT
// ============================================
const AppState = {
    currentUser: null,
    userData: null,
    currentRide: null,
    activeScreen: 'home',
    activeService: 'car',
    walletBalance: 0,
    userLocation: null,
    currentCity: 'Lusaka',
    selectedRideType: 'standard',
    selectedVehicle: null,
    destination: null,
    pickup: null,
    stops: [],
    rideFare: 0,
    driverLocation: null,
    chatMessages: [],
    scheduledRides: [],
    emergencyMode: false,
    sosConfig: null,
    searchCache: new Map(),
    lastSearchTime: 0,
    notifications: [],
    unreadNotifications: 0,
    broadcastData: null,
    broadcastParticipants: [],
    isBroadcasting: false,
    broadcastCode: null,
    broadcastPhones: [],
    emergencyReasons: [
        { id: 'accident', name: 'Accident / Collision', icon: 'fa-car-crash' },
        { id: 'medical', name: 'Medical Emergency', icon: 'fa-heartbeat' },
        { id: 'crime', name: 'Crime / Safety Threat', icon: 'fa-shield-alt' },
        { id: 'fire', name: 'Fire Emergency', icon: 'fa-fire' },
        { id: 'other', name: 'Other Emergency', icon: 'fa-ellipsis-h' }
    ],
    rideTypes: {
        economy: { base: 15, perKm: 2.5, multiplier: 0.8, min: 10, icon: 'fa-car-side', name: 'Economy' },
        standard: { base: 20, perKm: 3.0, multiplier: 1.0, min: 15, icon: 'fa-car', name: 'Standard' },
        premium: { base: 30, perKm: 4.0, multiplier: 1.5, min: 25, icon: 'fa-crown', name: 'Premium' }
    },
    serviceTypes: {
        car: { icon: 'fa-car', name: 'Car', color: 'var(--primary-orange)', form: 'carForm' },
        delivery: { icon: 'fa-shipping-fast', name: 'Delivery', color: 'var(--delivery-purple)', form: 'deliveryForm' },
        'short-delivery': { icon: 'fa-bicycle', name: 'Short Delivery', color: 'var(--express-shop-green)', form: 'shortDeliveryForm' },
        bicycle: { icon: 'fa-bicycle', name: 'Bicycle', color: 'var(--info-blue)', form: 'bicycleForm' },
        express: { icon: 'fa-shopping-bag', name: 'Express Shopping', color: 'var(--express-shop-green)', form: 'expressForm' },
        truck: { icon: 'fa-truck', name: 'Truck', color: 'var(--light-truck-brown)', form: 'truckForm' }
    },
    deliveryTypes: {
        standard: { base: 25, perKm: 2.0, multiplier: 1.0, name: 'Standard Delivery' },
        express: { base: 40, perKm: 3.0, multiplier: 1.5, name: 'Express Delivery' },
        sameDay: { base: 60, perKm: 4.0, multiplier: 2.0, name: 'Same Day Delivery' }
    },
    bicycleTypes: {
        standard: { base: 10, perKm: 1.5, multiplier: 1.0, min: 5, name: 'Standard' },
        fast: { base: 15, perKm: 2.0, multiplier: 1.2, min: 8, name: 'Fast' }
    },
    truckTypes: {
        pickup: { base: 80, perKm: 5.0, multiplier: 1.0, capacity: '1.5 tons', name: 'Pickup Truck' },
        light: { base: 120, perKm: 6.0, multiplier: 1.2, capacity: '3 tons', name: 'Light Truck' },
        medium: { base: 200, perKm: 8.0, multiplier: 1.5, capacity: '7 tons', name: 'Medium Truck' },
        heavy: { base: 350, perKm: 12.0, multiplier: 2.0, capacity: '15 tons', name: 'Heavy Truck' }
    },
    emergencyServices: {
        police: { base: 150, perKm: 5.0, multiplier: 2.0, min: 100, name: 'Police', icon: 'fa-shield-alt' },
        fire: { base: 200, perKm: 6.0, multiplier: 2.5, min: 150, name: 'Fire Brigade', icon: 'fa-fire-extinguisher' },
        medical: { base: 180, perKm: 5.5, multiplier: 2.2, min: 120, name: 'Medical', icon: 'fa-ambulance' }
    },
    notificationTypes: {
        ride: { icon: 'fa-car', color: 'var(--primary-orange)', bg: 'var(--light-orange)' },
        wallet: { icon: 'fa-wallet', color: 'var(--success-green)', bg: '#E8F6EF' },
        promo: { icon: 'fa-gift', color: 'var(--info-blue)', bg: '#E3F2FD' },
        emergency: { icon: 'fa-exclamation-triangle', color: 'var(--error-red)', bg: 'var(--light-red)' },
        broadcast: { icon: 'fa-broadcast-tower', color: 'var(--info-blue)', bg: '#E3F2FD' }
    },
    moreOptions: {
        'schedule': { icon: 'fa-calendar-alt', name: 'Schedule Ride', form: 'scheduleForm' },
        'order-for-someone': { icon: 'fa-user-friends', name: 'Order for Someone', form: 'someoneElseForm' },
        'share': { icon: 'fa-share-alt', name: 'Share Ride', form: 'shareRideForm' }
    },
    currentCityBounds: null,
    geocoder: null,
    activeFilters: {
        history: 'all',
        rides: 'all'
    },
    rideHistory: [],
    userStats: {
        completedRides: 0,
        cancelledRides: 0,
        totalSpent: 0,
        totalDistance: 0
    }
};

// ============================================
// MAP MANAGEMENT
// ============================================
let map = null;
let currentLocationMarker = null;
let pickupMarker = null;
let destinationMarker = null;
let driverMarker = null;
let routeLayer = null;
let emergencyMarkers = [];
let stopMarkers = [];
let broadcastMap = null;

// ============================================
// ULTRA-FAST SEARCH ENGINE WITH GEOCODING
// ============================================
const SearchEngine = {
    cache: new Map(),
    lastSearch: 0,
    debounceTimer: null,
    searchTimeout: 50, // Ultra-fast 50ms response
    minChars: 2,
    maxResults: 8,
    activeSearches: new Map(),
    
    // Fast search with multiple fallbacks
    search: async function(query, type = 'destination', location = null, bounds = null) {
        const cacheKey = `${query}-${type}-${location ? `${location.lat},${location.lng}` : 'none'}-${bounds ? 'bounded' : 'unbounded'}`;
        
        // Return cached results if available (1 minute cache)
        if (this.cache.has(cacheKey)) {
            const cached = this.cache.get(cacheKey);
            if (Date.now() - cached.timestamp < 60000) {
                return cached.results;
            }
        }
        
        // Abort any previous search for this input
        if (this.activeSearches.has(cacheKey)) {
            this.activeSearches.get(cacheKey).abort();
        }
        
        const controller = new AbortController();
        this.activeSearches.set(cacheKey, controller);
        
        try {
            // Show loading indicator immediately
            this.showLoadingIndicator(type);
            
            // Try multiple search strategies in parallel
            const searchPromises = [
                this.searchNominatim(query, location, bounds, controller),
                this.searchPhoton(query, location, bounds, controller),
                this.searchLocalCache(query, location)
            ];
            
            // Get the fastest result
            const fastestResult = await Promise.race(searchPromises);
            
            // Cache the results
            this.cache.set(cacheKey, {
                results: fastestResult,
                timestamp: Date.now()
            });
            
            return fastestResult;
        } catch (error) {
            console.error('Search error:', error);
            if (error.name !== 'AbortError') {
                this.showError('Search service temporarily unavailable. Trying fallback...');
                // Try fallback search
                return this.searchFallback(query, location);
            }
            return [];
        } finally {
            this.activeSearches.delete(cacheKey);
            this.hideLoadingIndicator(type);
        }
    },
    
    // Primary search using Nominatim with city restriction
    searchNominatim: async function(query, location, bounds, controller) {
        const timeoutId = setTimeout(() => controller.abort(), 2000);
        
        try {
            // Add city restriction for more relevant results
            const cityQuery = AppState.currentCity ? `${query}, ${AppState.currentCity}, Zambia` : `${query}, Zambia`;
            
            const params = new URLSearchParams({
                q: cityQuery,
                format: 'json',
                limit: this.maxResults,
                countrycodes: 'zm',
                'accept-language': 'en',
                addressdetails: 1,
                bounded: bounds ? 1 : 0,
                polygon_geojson: 0
            });
            
            if (bounds) {
                params.append('viewbox', bounds);
            } else if (location) {
                // 10km radius around current location
                const radius = 0.09; // ~10km in degrees
                params.append('viewbox', [
                    location.lng - radius,
                    location.lat - radius,
                    location.lng + radius,
                    location.lat + radius
                ].join(','));
            }
            
            const response = await fetch(`https://nominatim.openstreetmap.org/search?${params}`, {
                signal: controller.signal
            });
            
            clearTimeout(timeoutId);
            
            if (!response.ok) throw new Error(`Nominatim search failed: ${response.status}`);
            
            const data = await response.json();
            return this.processResults(data, location, 'nominatim');
        } catch (error) {
            throw error;
        }
    },
    
    // Secondary search using Photon API (faster alternative)
    searchPhoton: async function(query, location, bounds, controller) {
        const timeoutId = setTimeout(() => controller.abort(), 1500);
        
        try {
            let url = `https://photon.komoot.io/api/?q=${encodeURIComponent(query)}&limit=${this.maxResults}&lang=en`;
            
            if (location) {
                url += `&lat=${location.lat}&lon=${location.lng}`;
            }
            
            if (AppState.currentCity) {
                url += `&city=${encodeURIComponent(AppState.currentCity)}`;
            }
            
            url += '&country=Zambia';
            
            const response = await fetch(url, {
                signal: controller.signal
            });
            
            clearTimeout(timeoutId);
            
            if (!response.ok) throw new Error(`Photon search failed: ${response.status}`);
            
            const data = await response.json();
            return this.processPhotonResults(data, location);
        } catch (error) {
            throw error;
        }
    },
    
    // Local cache search for recent queries
    searchLocalCache: function(query, location) {
        const results = [];
        const queryLower = query.toLowerCase();
        
        // Search in recent cache
        for (const [key, cached] of this.cache.entries()) {
            if (Date.now() - cached.timestamp < 300000) { // 5 minutes
                const cachedQuery = key.split('-')[0].toLowerCase();
                if (cachedQuery.includes(queryLower) || queryLower.includes(cachedQuery)) {
                    // Filter by distance if location provided
                    if (location) {
                        const filteredResults = cached.results.filter(result => {
                            const distance = this.calculateDistance(
                                location.lat, location.lng,
                                result.lat, result.lng
                            );
                            return distance < 20; // Within 20km
                        });
                        results.push(...filteredResults);
                    } else {
                        results.push(...cached.results);
                    }
                }
            }
        }
        
        // Remove duplicates and limit results
        return this.removeDuplicates(results).slice(0, this.maxResults);
    },
    
    // Fallback search using local database
    searchFallback: async function(query, location) {
        try {
            // Search in Firebase for saved locations
            if (AppState.currentUser) {
                const snapshot = await database.ref(`userLocations/${AppState.currentUser.uid}`)
                    .orderByChild('name')
                    .startAt(query)
                    .endAt(query + '\uf8ff')
                    .limitToFirst(this.maxResults)
                    .once('value');
                
                const locations = snapshot.val();
                if (locations) {
                    const results = Object.values(locations).map(loc => ({
                        id: `local-${loc.id}`,
                        name: loc.name,
                        address: loc.address,
                        fullAddress: loc.address,
                        lat: loc.lat,
                        lng: loc.lng,
                        type: 'local',
                        distance: location ? this.calculateDistance(
                            location.lat, location.lng,
                            loc.lat, loc.lng
                        ) : 0,
                        relevance: 0.5
                    }));
                    
                    return results.sort((a, b) => a.distance - b.distance);
                }
            }
        } catch (error) {
            console.error('Fallback search error:', error);
        }
        
        return [];
    },
    
    // Process Nominatim results
    processResults: function(data, location, source) {
        return data.map(place => ({
            id: `${source}-${place.place_id || place.osm_id}`,
            name: place.display_name.split(',')[0],
            address: this.formatAddress(place),
            fullAddress: place.display_name,
            lat: parseFloat(place.lat),
            lng: parseFloat(place.lon),
            type: place.type || place.class,
            importance: place.importance || 0,
            distance: location ? this.calculateDistance(
                location.lat, location.lng,
                parseFloat(place.lat), parseFloat(place.lon)
            ) : 0,
            relevance: this.calculateRelevance(place, location),
            source: source
        })).sort((a, b) => {
            // Sort by relevance and distance
            if (location) {
                return a.distance - b.distance;
            }
            return b.relevance - a.relevance;
        }).slice(0, this.maxResults);
    },
    
    // Process Photon results
    processPhotonResults: function(data, location) {
        if (!data.features) return [];
        
        return data.features.map(feature => {
            const props = feature.properties;
            const coords = feature.geometry.coordinates;
            
            return {
                id: `photon-${feature.properties.osm_id}`,
                name: props.name || props.street || props.city || 'Unknown',
                address: this.formatPhotonAddress(props),
                fullAddress: props.name ? `${props.name}, ${props.street}, ${props.city}, ${props.country}` : props.label,
                lat: coords[1],
                lng: coords[0],
                type: props.type,
                importance: props.importance || 0,
                distance: location ? this.calculateDistance(
                    location.lat, location.lng,
                    coords[1], coords[0]
                ) : 0,
                relevance: props.importance || 0.5,
                source: 'photon'
            };
        }).sort((a, b) => a.distance - b.distance).slice(0, this.maxResults);
    },
    
    formatPhotonAddress: function(props) {
        const parts = [];
        
        if (props.housenumber) parts.push(props.housenumber);
        if (props.street) parts.push(props.street);
        if (props.city) parts.push(props.city);
        
        return parts.join(', ') || props.label || '';
    },
    
    formatAddress: function(place) {
        const address = place.address || {};
        const parts = [];
        
        // Start with the most specific details
        if (address.house_number || address.housenumber) {
            parts.push(address.house_number || address.housenumber);
        }
        
        if (address.road) {
            parts.push(address.road);
        }
        
        if (address.suburb || address.neighbourhood) {
            parts.push(address.suburb || address.neighbourhood);
        }
        
        // Always include city
        if (address.city || address.town || address.village) {
            parts.push(address.city || address.town || address.village);
        }
        
        return parts.join(', ') || place.display_name.split(',').slice(0, 2).join(',');
    },
    
    calculateRelevance: function(place, location) {
        let relevance = place.importance || 0;
        
        if (location) {
            const distance = this.calculateDistance(
                location.lat, location.lng,
                parseFloat(place.lat), parseFloat(place.lon)
            );
            // Closer locations get higher relevance
            const distanceScore = Math.max(0, 1 - (distance / 20));
            relevance += distanceScore * 0.5;
        }
        
        return relevance;
    },
    
    calculateDistance: function(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = this.toRad(lat2 - lat1);
        const dLon = this.toRad(lon2 - lon1);
        const a = 
            Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(this.toRad(lat1)) * Math.cos(this.toRad(lat2)) * 
            Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    },
    
    toRad: function(value) {
        return value * Math.PI / 180;
    },
    
    removeDuplicates: function(results) {
        const seen = new Set();
        return results.filter(result => {
            const key = `${result.lat.toFixed(4)},${result.lng.toFixed(4)}`;
            if (seen.has(key)) return false;
            seen.add(key);
            return true;
        });
    },
    
    showLoadingIndicator: function(type) {
        const inputId = type === 'pickup' ? 'pickupLocation' : 'destinationLocation';
        const input = document.getElementById(inputId);
        if (input) {
            const parent = input.closest('.location-input');
            if (parent) {
                parent.classList.add('searching');
            }
        }
    },
    
    hideLoadingIndicator: function(type) {
        const inputId = type === 'pickup' ? 'pickupLocation' : 'destinationLocation';
        const input = document.getElementById(inputId);
        if (input) {
            const parent = input.closest('.location-input');
            if (parent) {
                parent.classList.remove('searching');
            }
        }
    },
    
    showError: function(message) {
        UIUpdater.showToast(message, 'error');
    },
    
    // Fast search for emergency services
    searchEmergencyServices: async function(type, location) {
        const cacheKey = `emergency-${type}-${location.lat},${location.lng}`;
        
        if (this.cache.has(cacheKey)) {
            const cached = this.cache.get(cacheKey);
            if (Date.now() - cached.timestamp < 300000) {
                return cached.results;
            }
        }
        
        try {
            let searchTerms = [];
            switch(type) {
                case 'police':
                    searchTerms = ['police station', 'police', 'police post'];
                    break;
                case 'fire':
                    searchTerms = ['fire station', 'fire brigade', 'fire department'];
                    break;
                case 'medical':
                    searchTerms = ['hospital', 'clinic', 'medical center', 'health center', 'health post'];
                    break;
            }
            
            const allResults = [];
            for (const term of searchTerms) {
                const results = await this.search(term, 'emergency', location);
                allResults.push(...results);
            }
            
            const uniqueResults = this.removeDuplicates(allResults);
            uniqueResults.sort((a, b) => a.distance - b.distance);
            
            this.cache.set(cacheKey, {
                results: uniqueResults.slice(0, 5),
                timestamp: Date.now()
            });
            
            return uniqueResults.slice(0, 5);
        } catch (error) {
            console.error('Emergency search error:', error);
            return [];
        }
    },
    
    // Reverse geocoding for address lookup
    reverseGeocode: async function(lat, lng) {
        const cacheKey = `reverse-${lat},${lng}`;
        
        if (this.cache.has(cacheKey)) {
            const cached = this.cache.get(cacheKey);
            if (Date.now() - cached.timestamp < 300000) {
                return cached.result;
            }
        }
        
        try {
            const response = await fetch(
                `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`
            );
            
            const data = await response.json();
            if (data && data.address) {
                const address = this.formatAddress({ address: data.address, display_name: data.display_name });
                const result = {
                    address: address,
                    fullAddress: data.display_name,
                    lat: lat,
                    lng: lng
                };
                
                this.cache.set(cacheKey, {
                    result: result,
                    timestamp: Date.now()
                });
                
                return result;
            }
        } catch (error) {
            console.error('Reverse geocode error:', error);
        }
        
        return {
            address: `${lat.toFixed(4)}, ${lng.toFixed(4)}`,
            fullAddress: `${lat.toFixed(4)}, ${lng.toFixed(4)}`,
            lat: lat,
            lng: lng
        };
    },
    
    // Save location to user's saved places
    saveLocation: async function(userId, location, name) {
        try {
            const locationId = database.ref().child(`userLocations/${userId}`).push().key;
            const locationData = {
                id: locationId,
                name: name,
                address: location.address,
                fullAddress: location.fullAddress,
                lat: location.lat,
                lng: location.lng,
                type: 'saved',
                timestamp: Date.now()
            };
            
            await database.ref(`userLocations/${userId}/${locationId}`).set(locationData);
            return locationId;
        } catch (error) {
            console.error('Error saving location:', error);
            return null;
        }
    },
    
    // Get city bounds for search restriction
    getCityBounds: async function(cityName) {
        const cacheKey = `bounds-${cityName}`;
        
        if (this.cache.has(cacheKey)) {
            return this.cache.get(cacheKey);
        }
        
        try {
            const response = await fetch(
                `https://nominatim.openstreetmap.org/search?city=${encodeURIComponent(cityName)}&country=Zambia&format=json&limit=1`
            );
            
            const data = await response.json();
            if (data && data.length > 0) {
                // Get bounding box
                const bounds = data[0].boundingbox;
                const result = {
                    minLat: parseFloat(bounds[0]),
                    maxLat: parseFloat(bounds[1]),
                    minLng: parseFloat(bounds[2]),
                    maxLng: parseFloat(bounds[3]),
                    viewbox: `${bounds[2]},${bounds[0]},${bounds[3]},${bounds[1]}`
                };
                
                this.cache.set(cacheKey, result);
                return result;
            }
        } catch (error) {
            console.error('Error getting city bounds:', error);
        }
        
        return null;
    }
};

// ============================================
// ENHANCED PRICE CALCULATOR WITH FAST UPDATES
// ============================================
const PriceCalculator = {
    lastCalculation: 0,
    calculationCache: new Map(),
    
    calculateRideFare: function(distanceKm, rideType = 'standard', surge = 1.0, timeMinutes = 0) {
        const cacheKey = `ride-${distanceKm}-${rideType}-${surge}`;
        
        if (this.calculationCache.has(cacheKey)) {
            return this.calculationCache.get(cacheKey);
        }
        
        const config = AppState.rideTypes[rideType] || AppState.rideTypes.standard;
        
        // Base fare + distance fare + time fare
        let fare = config.base + (distanceKm * config.perKm) + (timeMinutes * 0.1);
        
        // Apply ride type multiplier
        fare *= config.multiplier;
        
        // Apply surge pricing
        fare *= surge;
        
        // Ensure minimum fare
        fare = Math.max(fare, config.min);
        
        // Round to 2 decimal places
        fare = Math.round(fare * 100) / 100;
        
        this.calculationCache.set(cacheKey, fare);
        return fare;
    },
    
    calculateBicycleFare: function(distanceKm, bicycleType = 'standard', surge = 1.0) {
        const config = AppState.bicycleTypes[bicycleType] || AppState.bicycleTypes.standard;
        
        let fare = config.base + (distanceKm * config.perKm);
        fare *= config.multiplier;
        fare *= surge;
        fare = Math.max(fare, config.min);
        
        return Math.round(fare * 100) / 100;
    },
    
    calculateEmergencyFare: function(distanceKm, serviceType, surge = 1.0) {
        const config = AppState.emergencyServices[serviceType] || AppState.emergencyServices.police;
        
        let fare = config.base + (distanceKm * config.perKm);
        fare *= config.multiplier;
        fare *= surge;
        fare = Math.max(fare, config.min);
        
        return Math.round(fare * 100) / 100;
    },
    
    calculateDeliveryFare: function(distanceKm, deliveryType = 'standard', parcelValue = 0, weight = 0) {
        const config = AppState.deliveryTypes[deliveryType] || AppState.deliveryTypes.standard;
        
        let fare = config.base + (distanceKm * config.perKm);
        fare *= config.multiplier;
        
        // Add insurance for valuable parcels (1% of parcel value)
        if (parcelValue > 500) {
            fare += parcelValue * 0.01;
        }
        
        // Add weight charge (ZMW 0.5 per kg after 5kg)
        if (weight > 5) {
            fare += (weight - 5) * 0.5;
        }
        
        return Math.round(fare * 100) / 100;
    },
    
    calculateTruckFare: function(distanceKm, truckType = 'light', helpers = false, extraStops = 0) {
        const config = AppState.truckTypes[truckType] || AppState.truckTypes.light;
        
        let fare = config.base + (distanceKm * config.perKm);
        fare *= config.multiplier;
        
        // Add helper cost if needed
        if (helpers) {
            fare += 50;
        }
        
        // Add extra stop charges
        if (extraStops > 0) {
            fare += extraStops * 20;
        }
        
        return Math.round(fare * 100) / 100;
    },
    
    calculateShoppingFare: function(distanceKm, itemsCount = 1, budget = 0, shoppingTime = 0) {
        // Base fare + distance + item count + shopping time
        let fare = 30 + (distanceKm * 2.5) + (itemsCount * 5) + (shoppingTime * 0.2);
        
        // Add 5% of budget for shopping service
        if (budget > 0) {
            fare += budget * 0.05;
        }
        
        return Math.round(fare * 100) / 100;
    },
    
    calculateShortDeliveryFare: function(distanceKm, urgency = 'standard', weight = 0) {
        let fare = 15 + (distanceKm * 2.0);
        
        // Urgency multiplier
        if (urgency === 'express') {
            fare *= 1.5;
        } else if (urgency === 'urgent') {
            fare *= 2.0;
        }
        
        // Weight charge
        if (weight > 2) {
            fare += (weight - 2) * 0.3;
        }
        
        return Math.round(fare * 100) / 100;
    },
    
    calculateDistance: function(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = this.toRad(lat2 - lat1);
        const dLon = this.toRad(lon2 - lon1);
        const a = 
            Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(this.toRad(lat1)) * Math.cos(this.toRad(lat2)) * 
            Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    },
    
    toRad: function(value) {
        return value * Math.PI / 180;
    },
    
    estimateTime: function(distanceKm, serviceType = 'standard', trafficFactor = 1.0) {
        let baseSpeed;
        
        switch(serviceType) {
            case 'bicycle':
                baseSpeed = 12; // km/h
                break;
            case 'premium':
                baseSpeed = 40;
                break;
            case 'express':
                baseSpeed = 35;
                break;
            default:
                baseSpeed = 30;
        }
        
        const baseTime = (distanceKm / baseSpeed) * 60;
        const estimatedTime = Math.ceil(baseTime * trafficFactor);
        
        return Math.max(estimatedTime, 3); // Minimum 3 minutes
    },
    
    getSurgeMultiplier: function() {
        // Real-time surge pricing
        const now = new Date();
        const hour = now.getHours();
        const day = now.getDay();
        
        let surge = 1.0;
        
        // Time-based surge
        if (hour >= 7 && hour <= 9) surge *= 1.3; // Morning rush
        if (hour >= 16 && hour <= 19) surge *= 1.5; // Evening rush
        if (hour >= 22 || hour <= 5) surge *= 1.8; // Late night
        
        // Day-based surge
        if (day === 0 || day === 6) surge *= 1.2; // Weekend
        
        // Weather factor (simulated)
        const weatherFactor = 0.9 + Math.random() * 0.3;
        surge *= weatherFactor;
        
        // Event factor (simulated)
        const eventFactor = 1.0 + (Math.random() * 0.2);
        surge *= eventFactor;
        
        return Math.min(Math.max(surge, 1.0), 3.0); // Between 1.0x and 3.0x
    },
    
    getTrafficFactor: function() {
        // Simulate traffic conditions
        const now = new Date();
        const hour = now.getHours();
        
        if (hour >= 7 && hour <= 9) return 1.5; // Morning rush
        if (hour >= 16 && hour <= 19) return 1.7; // Evening rush
        if (hour >= 12 && hour <= 14) return 1.3; // Lunch time
        
        return 1.0; // Normal traffic
    },
    
    // Calculate fare with multiple stops
    calculateMultiStopFare: function(routePoints, rideType = 'standard') {
        if (routePoints.length < 2) return 0;
        
        let totalDistance = 0;
        let totalTime = 0;
        
        // Calculate total distance
        for (let i = 0; i < routePoints.length - 1; i++) {
            const distance = this.calculateDistance(
                routePoints[i].lat, routePoints[i].lng,
                routePoints[i + 1].lat, routePoints[i + 1].lng
            );
            totalDistance += distance;
            
            const time = this.estimateTime(distance, rideType);
            totalTime += time;
        }
        
        // Calculate base fare
        const surge = this.getSurgeMultiplier();
        let fare = this.calculateRideFare(totalDistance, rideType, surge, totalTime);
        
        // Add stop charges (ZMW 5 per additional stop)
        if (routePoints.length > 2) {
            fare += (routePoints.length - 2) * 5;
        }
        
        return {
            fare: fare,
            distance: totalDistance,
            time: totalTime,
            stops: routePoints.length - 2
        };
    },
    
    // Clear calculation cache
    clearCache: function() {
        this.calculationCache.clear();
    }
};

// ============================================
// COMPREHENSIVE UI UPDATER
// ============================================
const UIUpdater = {
    // Update user name in top bar
    updateUserName: function(name) {
        const display = document.getElementById('userNameDisplay');
        if (display) {
            display.textContent = name;
        }
        
        // Update logo with user initials
        const logoIcon = document.getElementById('logoIcon');
        if (logoIcon) {
            const initials = name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
            logoIcon.innerHTML = `<span style="color: white; font-weight: 700; font-size: 14px;">${initials}</span>`;
        }
    },
    
    // Update wallet balance
    updateWalletBalance: function(balance) {
        const formatted = `ZMW ${balance.toFixed(2)}`;
        
        // Update all balance displays
        const balanceElements = [
            'walletBalance',
            'accountBalance',
            'paymentBalance',
            'transferBalance'
        ];
        
        balanceElements.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = formatted;
            }
        });
        
        AppState.walletBalance = balance;
    },
    
    // Show toast notification
    showToast: function(message, type = 'info', duration = 5000) {
        const toastContainer = document.getElementById('toastContainer');
        if (!toastContainer) return;
        
        const toastId = 'toast-' + Date.now();
        
        const icons = {
            success: 'fa-check-circle',
            error: 'fa-exclamation-circle',
            warning: 'fa-exclamation-triangle',
            info: 'fa-info-circle'
        };
        
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.id = toastId;
        toast.innerHTML = `
            <div class="toast-icon">
                <i class="fas ${icons[type] || icons.info}"></i>
            </div>
            <div class="toast-content">
                <div class="toast-title">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
                <div class="toast-message">${message}</div>
            </div>
            <button class="toast-close" onclick="UIUpdater.removeToast('${toastId}')">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        toastContainer.appendChild(toast);
        
        // Auto-remove after duration
        setTimeout(() => {
            this.removeToast(toastId);
        }, duration);
        
        return toastId;
    },
    
    removeToast: function(toastId) {
        const toast = document.getElementById(toastId);
        if (toast) {
            toast.classList.add('hiding');
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300);
        }
    },
    
    // Loading overlay
    showLoading: function(message = 'Loading...') {
        const overlay = document.getElementById('loadingOverlay');
        const text = document.getElementById('loadingText');
        if (overlay && text) {
            text.textContent = message;
            overlay.classList.add('active');
        }
    },
    
    hideLoading: function() {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
            overlay.classList.remove('active');
        }
    },
    
    // Switch between screens
    switchScreen: function(screen) {
        // Hide all screens
        const screens = ['home', 'history', 'account', 'emergency', 'broadcastTracking'];
        screens.forEach(s => {
            const screenElement = document.getElementById(`${s}Screen`);
            if (screenElement) {
                screenElement.classList.remove('active');
            }
        });
        
        // Update navigation tabs
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Activate selected screen
        AppState.activeScreen = screen;
        
        if (screen === 'home') {
            document.querySelector('.nav-tab[data-screen="home"]').classList.add('active');
        } else {
            const screenElement = document.getElementById(`${screen}Screen`);
            if (screenElement) {
                screenElement.classList.add('active');
                document.querySelector(`.nav-tab[data-screen="${screen}"]`).classList.add('active');
            }
            
            // Load screen-specific data
            switch(screen) {
                case 'history':
                    this.loadHistoryScreen();
                    break;
                case 'account':
                    this.loadAccountScreen();
                    break;
                case 'emergency':
                    this.loadEmergencyScreen();
                    break;
            }
        }
    },
    
    // Switch between services
    switchService: function(service) {
        // Hide all forms
        document.querySelectorAll('.ride-request-form, .service-form, .schedule-form, .more-options').forEach(form => {
            form.style.display = 'none';
            form.classList.remove('active');
        });
        
        // Update service tabs
        document.querySelectorAll('.service-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Activate selected service
        AppState.activeService = service;
        const serviceTab = document.querySelector(`.service-tab[data-service="${service}"]`);
        if (serviceTab) {
            serviceTab.classList.add('active');
        }
        
        // Show corresponding form
        const serviceConfig = AppState.serviceTypes[service];
        if (serviceConfig && serviceConfig.form) {
            const form = document.getElementById(serviceConfig.form);
            if (form) {
                form.style.display = 'block';
                form.classList.add('active');
                
                // Initialize form specific settings
                this.initializeServiceForm(service);
            }
        }
        
        // Clear previous search results
        this.clearSearchSuggestions();
    },
    
    initializeServiceForm: function(service) {
        switch(service) {
            case 'car':
                this.initializeCarForm();
                break;
            case 'delivery':
                this.initializeDeliveryForm();
                break;
            case 'short-delivery':
                this.initializeShortDeliveryForm();
                break;
            case 'bicycle':
                this.initializeBicycleForm();
                break;
            case 'express':
                this.initializeExpressForm();
                break;
            case 'truck':
                this.initializeTruckForm();
                break;
        }
    },
    
    initializeCarForm: function() {
        // Show ride type selection
        document.getElementById('rideTypeSelection').style.display = 'block';
        
        // Initialize price display
        if (AppState.pickup && AppState.destination) {
            this.updateCarPrices();
        }
    },
    
    initializeDeliveryForm: function() {
        // Set default delivery type
        const deliveryTypeSelect = document.getElementById('deliveryType');
        if (deliveryTypeSelect) {
            deliveryTypeSelect.value = 'standard';
        }
    },
    
    initializeShortDeliveryForm: function() {
        // Set default urgency
        const urgencySelect = document.getElementById('deliveryUrgency');
        if (urgencySelect) {
            urgencySelect.value = 'standard';
        }
    },
    
    initializeBicycleForm: function() {
        // Show bicycle type selection
        const bicycleTypeContainer = document.getElementById('bicycleTypeSelection');
        if (bicycleTypeContainer) {
            bicycleTypeContainer.style.display = 'block';
        }
    },
    
    initializeExpressForm: function() {
        // Initialize shopping items
        this.initializeShoppingItems();
    },
    
    initializeTruckForm: function() {
        // Set default truck type
        const truckTypeSelect = document.getElementById('truckType');
        if (truckTypeSelect) {
            truckTypeSelect.value = 'light';
        }
    },
    
    initializeShoppingItems: function() {
        const itemsContainer = document.getElementById('shoppingItems');
        if (!itemsContainer) return;
        
        // Clear existing items except first
        const items = itemsContainer.querySelectorAll('.item-entry');
        for (let i = 1; i < items.length; i++) {
            items[i].remove();
        }
        
        // Initialize first item
        const firstItem = items[0];
        if (firstItem) {
            const input = firstItem.querySelector('.item-input');
            if (input) input.value = '';
        }
        
        // Add event listener to add button
        const addBtn = document.getElementById('addItemBtn');
        if (addBtn) {
            addBtn.onclick = this.addShoppingItem;
        }
    },
    
    addShoppingItem: function() {
        const itemsContainer = document.getElementById('shoppingItems');
        if (!itemsContainer) return;
        
        const itemEntry = document.createElement('div');
        itemEntry.className = 'item-entry';
        itemEntry.innerHTML = `
            <input type="text" class="item-input" placeholder="Item name">
            <button type="button" class="remove-item">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        itemsContainer.appendChild(itemEntry);
        
        // Add remove functionality
        const removeBtn = itemEntry.querySelector('.remove-item');
        removeBtn.addEventListener('click', function() {
            if (itemsContainer.children.length > 1) {
                itemEntry.remove();
            }
        });
    },
    
    // Fast search suggestions
    showSearchSuggestions: function(inputId, results) {
        const container = document.getElementById(`${inputId}Suggestions`);
        if (!container) return;
        
        container.innerHTML = '';
        
        if (results.length === 0) {
            container.innerHTML = `
                <div class="no-results">
                    <i class="fas fa-search"></i>
                    <div>No results found in ${AppState.currentCity}</div>
                    <div style="font-size: 11px; margin-top: 4px; color: var(--text-light);">
                        Try a different location or check spelling
                    </div>
                </div>
            `;
        } else {
            results.forEach((result, index) => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                if (index === 0) item.classList.add('selected');
                
                item.innerHTML = `
                    <div class="suggestion-icon">
                        <i class="fas fa-map-marker-alt"></i>
                    </div>
                    <div class="suggestion-details">
                        <div class="suggestion-name">${result.name}</div>
                        <div class="suggestion-address">${result.address}</div>
                        ${result.distance ? `
                        <div class="suggestion-distance">
                            <i class="fas fa-ruler"></i>
                            ${result.distance.toFixed(1)} km away
                        </div>
                        ` : ''}
                    </div>
                `;
                
                item.addEventListener('click', () => {
                    this.selectLocation(inputId, result);
                });
                
                item.addEventListener('mouseenter', () => {
                    this.highlightSuggestionItem(item);
                });
                
                container.appendChild(item);
            });
        }
        
        container.classList.add('active');
        SearchEngine.hideLoadingIndicator(inputId.includes('pickup') ? 'pickup' : 'destination');
    },
    
    clearSearchSuggestions: function() {
        document.querySelectorAll('.suggestion-list').forEach(list => {
            list.classList.remove('active');
            list.innerHTML = '';
        });
    },
    
    highlightSuggestionItem: function(item) {
        document.querySelectorAll('.suggestion-item').forEach(i => {
            i.classList.remove('selected');
        });
        item.classList.add('selected');
    },
    
    selectLocation: function(inputId, location) {
        const input = document.getElementById(inputId);
        const container = document.getElementById(`${inputId}Suggestions`);
        
        if (input && location) {
            input.value = location.address;
            
            // Update AppState based on input type
            if (inputId.includes('destination') || inputId.includes('Destination')) {
                AppState.destination = location;
                this.updateDestinationMarker(location);
                this.calculateAndUpdatePrices();
            } else if (inputId.includes('pickup') || inputId.includes('Pickup')) {
                AppState.pickup = location;
                this.updatePickupMarker(location);
                this.calculateAndUpdatePrices();
            }
            
            if (container) {
                container.classList.remove('active');
            }
            
            // Save location to user's recent places
            if (AppState.currentUser && location.source !== 'local') {
                SearchEngine.saveLocation(AppState.currentUser.uid, location, location.name);
            }
        }
    },
    
    // Map functions
    updatePickupMarker: function(location) {
        if (pickupMarker) {
            pickupMarker.setLatLng([location.lat, location.lng]);
        } else {
            pickupMarker = L.marker([location.lat, location.lng], {
                icon: L.divIcon({
                    className: 'pickup-marker',
                    html: '<i class="fas fa-map-marker-alt"></i>',
                    iconSize: [20, 20]
                })
            }).addTo(map).bindPopup('Pickup Location');
        }
        
        // Draw route if destination exists
        if (AppState.destination) {
            this.drawRoute([location], [AppState.destination]);
        }
    },
    
    updateDestinationMarker: function(location) {
        if (destinationMarker) {
            destinationMarker.setLatLng([location.lat, location.lng]);
        } else {
            destinationMarker = L.marker([location.lat, location.lng], {
                icon: L.divIcon({
                    className: 'destination-marker',
                    html: '<i class="fas fa-flag"></i>',
                    iconSize: [20, 20]
                })
            }).addTo(map).bindPopup('Destination');
        }
        
        // Draw route if pickup exists
        if (AppState.pickup) {
            this.drawRoute([AppState.pickup], [location]);
        }
    },
    
    drawRoute: function(startPoints, endPoints, waypoints = []) {
        if (routeLayer) {
            map.removeLayer(routeLayer);
        }
        
        const allPoints = [...startPoints, ...waypoints, ...endPoints];
        
        routeLayer = L.Routing.control({
            waypoints: allPoints.map(point => L.latLng(point.lat, point.lng)),
            routeWhileDragging: false,
            showAlternatives: false,
            lineOptions: {
                styles: [{color: '#FF6B35', weight: 3, opacity: 0.7}]
            },
            createMarker: function() { return null; }
        }).addTo(map);
        
        // Fit bounds to show entire route
        const bounds = L.latLngBounds(allPoints.map(point => [point.lat, point.lng]));
        map.fitBounds(bounds, { padding: [30, 30] });
    },
    
    // Price calculations
    calculateAndUpdatePrices: function() {
        if (!AppState.pickup || !AppState.destination) return;
        
        const distance = PriceCalculator.calculateDistance(
            AppState.pickup.lat, AppState.pickup.lng,
            AppState.destination.lat, AppState.destination.lng
        );
        
        switch(AppState.activeService) {
            case 'car':
                this.updateCarPrices(distance);
                break;
            case 'delivery':
                this.updateDeliveryPrices(distance);
                break;
            case 'short-delivery':
                this.updateShortDeliveryPrices(distance);
                break;
            case 'bicycle':
                this.updateBicyclePrices(distance);
                break;
            case 'express':
                this.updateExpressPrices(distance);
                break;
            case 'truck':
                this.updateTruckPrices(distance);
                break;
        }
    },
    
    updateCarPrices: function(distance = null) {
        if (!distance && AppState.pickup && AppState.destination) {
            distance = PriceCalculator.calculateDistance(
                AppState.pickup.lat, AppState.pickup.lng,
                AppState.destination.lat, AppState.destination.lng
            );
        }
        
        if (!distance) return;
        
        const surge = PriceCalculator.getSurgeMultiplier();
        const time = PriceCalculator.estimateTime(distance, AppState.selectedRideType);
        
        // Update prices for all ride types
        Object.keys(AppState.rideTypes).forEach(type => {
            const price = PriceCalculator.calculateRideFare(distance, type, surge, time);
            const element = document.getElementById(`${type}Price`);
            if (element) {
                element.textContent = `ZMW ${price.toFixed(2)}`;
            }
        });
        
        // Update estimated fare
        const selectedPrice = PriceCalculator.calculateRideFare(distance, AppState.selectedRideType, surge, time);
        AppState.rideFare = selectedPrice;
        
        const fareDisplay = document.getElementById('fareDisplay');
        if (fareDisplay) {
            document.getElementById('estimatedFare').textContent = `ZMW ${selectedPrice.toFixed(2)}`;
            document.getElementById('distanceDetail').textContent = `${distance.toFixed(1)} km`;
            document.getElementById('timeDetail').textContent = `ETA: ${time} min`;
            fareDisplay.classList.add('active');
        }
    },
    
    updateDeliveryPrices: function(distance = null) {
        if (!distance && AppState.pickup && AppState.destination) {
            distance = PriceCalculator.calculateDistance(
                AppState.pickup.lat, AppState.pickup.lng,
                AppState.destination.lat, AppState.destination.lng
            );
        }
        
        if (!distance) return;
        
        const deliveryType = document.getElementById('deliveryType')?.value || 'standard';
        const parcelValue = parseFloat(document.getElementById('parcelValue')?.value) || 0;
        const weight = parseFloat(document.getElementById('parcelWeight')?.value) || 0;
        
        const fare = PriceCalculator.calculateDeliveryFare(distance, deliveryType, parcelValue, weight);
        const time = PriceCalculator.estimateTime(distance, 'standard');
        
        // Update display
        const fareElement = document.getElementById('deliveryFare');
        if (fareElement) {
            fareElement.textContent = `ZMW ${fare.toFixed(2)}`;
        }
        
        const timeElement = document.getElementById('deliveryTime');
        if (timeElement) {
            timeElement.textContent = `${time} min`;
        }
        
        AppState.rideFare = fare;
    },
    
    updateShortDeliveryPrices: function(distance = null) {
        if (!distance && AppState.pickup && AppState.destination) {
            distance = PriceCalculator.calculateDistance(
                AppState.pickup.lat, AppState.pickup.lng,
                AppState.destination.lat, AppState.destination.lng
            );
        }
        
        if (!distance) return;
        
        const urgency = document.getElementById('deliveryUrgency')?.value || 'standard';
        const weight = parseFloat(document.getElementById('shortDeliveryWeight')?.value) || 0;
        
        const fare = PriceCalculator.calculateShortDeliveryFare(distance, urgency, weight);
        const time = PriceCalculator.estimateTime(distance, urgency === 'urgent' ? 'express' : 'standard');
        
        // Update display
        const fareElement = document.getElementById('shortDeliveryFare');
        if (fareElement) {
            fareElement.textContent = `ZMW ${fare.toFixed(2)}`;
        }
        
        AppState.rideFare = fare;
    },
    
    updateBicyclePrices: function(distance = null) {
        if (!distance && AppState.pickup && AppState.destination) {
            distance = PriceCalculator.calculateDistance(
                AppState.pickup.lat, AppState.pickup.lng,
                AppState.destination.lat, AppState.destination.lng
            );
        }
        
        if (!distance) return;
        
        const bicycleType = document.querySelector('.bicycle-type-card.selected')?.dataset.type || 'standard';
        const surge = PriceCalculator.getSurgeMultiplier();
        
        const fare = PriceCalculator.calculateBicycleFare(distance, bicycleType, surge);
        const time = PriceCalculator.estimateTime(distance, 'bicycle');
        
        // Update display
        const fareElement = document.getElementById('bicycleFare');
        if (fareElement) {
            fareElement.textContent = `ZMW ${fare.toFixed(2)}`;
        }
        
        AppState.rideFare = fare;
    },
    
    updateExpressPrices: function(distance = null) {
        if (!distance && AppState.pickup && AppState.destination) {
            distance = PriceCalculator.calculateDistance(
                AppState.pickup.lat, AppState.pickup.lng,
                AppState.destination.lat, AppState.destination.lng
            );
        }
        
        if (!distance) return;
        
        const itemsCount = document.querySelectorAll('.item-entry').length;
        const budget = parseFloat(document.getElementById('shoppingBudget')?.value) || 0;
        const shoppingTime = parseInt(document.getElementById('shoppingTime')?.value) || 30;
        
        const fare = PriceCalculator.calculateShoppingFare(distance, itemsCount, budget, shoppingTime);
        const time = PriceCalculator.estimateTime(distance, 'express') + shoppingTime;
        
        // Update display
        const fareElement = document.getElementById('expressFare');
        if (fareElement) {
            fareElement.textContent = `ZMW ${fare.toFixed(2)}`;
        }
        
        AppState.rideFare = fare;
    },
    
    updateTruckPrices: function(distance = null) {
        if (!distance && AppState.pickup && AppState.destination) {
            distance = PriceCalculator.calculateDistance(
                AppState.pickup.lat, AppState.pickup.lng,
                AppState.destination.lat, AppState.destination.lng
            );
        }
        
        if (!distance) return;
        
        const truckType = document.getElementById('truckType')?.value || 'light';
        const helpers = document.getElementById('needHelpers')?.checked || false;
        const extraStops = AppState.stops.length;
        
        const fare = PriceCalculator.calculateTruckFare(distance, truckType, helpers, extraStops);
        const time = PriceCalculator.estimateTime(distance, 'standard');
        
        // Update display
        const fareElement = document.getElementById('truckFare');
        if (fareElement) {
            fareElement.textContent = `ZMW ${fare.toFixed(2)}`;
        }
        
        AppState.rideFare = fare;
    },
    
    // History screen
    loadHistoryScreen: function() {
        this.showLoading('Loading ride history...');
        
        // Load ride history from Firebase
        FirebaseManager.loadRideHistory(AppState.currentUser.uid)
            .then(rides => {
                AppState.rideHistory = rides;
                this.updateHistoryList(rides);
                this.updateHistoryFilters();
                this.hideLoading();
            })
            .catch(error => {
                console.error('Error loading history:', error);
                this.showToast('Error loading ride history', 'error');
                this.hideLoading();
            });
    },
    
    updateHistoryList: function(rides) {
        const container = document.getElementById('historyList');
        if (!container) return;
        
        container.innerHTML = '';
        
        if (rides.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-history"></i>
                    </div>
                    <div class="empty-title">No rides found</div>
                    <div class="empty-message">${AppState.activeFilters.history === 'all' ? 'You haven\'t taken any rides yet' : 'No rides match your filter'}</div>
                </div>
            `;
            return;
        }
        
        rides.forEach(ride => {
            const item = this.createHistoryItem(ride);
            container.appendChild(item);
        });
    },
    
    createHistoryItem: function(ride) {
        const item = document.createElement('div');
        item.className = 'history-item';
        item.dataset.rideId = ride.id;
        
        const date = new Date(ride.timestamp);
        const serviceConfig = AppState.serviceTypes[ride.serviceType] || AppState.serviceTypes.car;
        
        const statusClass = ride.status === 'completed' ? 'status-completed' :
                           ride.status === 'cancelled' ? 'status-cancelled' :
                           'status-ongoing';
        
        item.innerHTML = `
            <div class="history-header">
                <div class="history-type">
                    <div class="history-icon" style="background: ${serviceConfig.color}">
                        <i class="fas ${serviceConfig.icon}"></i>
                    </div>
                    <div class="history-type-name">
                        ${ride.serviceType ? ride.serviceType.charAt(0).toUpperCase() + ride.serviceType.slice(1) : 'Ride'}
                        ${ride.emergency ? ' (Emergency)' : ''}
                        ${ride.broadcast ? ' (Shared)' : ''}
                    </div>
                </div>
                <div class="history-date">
                    ${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                </div>
            </div>
            
            <div class="history-locations">
                <div class="history-location">
                    <i class="fas fa-map-marker-alt"></i>
                    <div class="history-location-text">${ride.pickupDisplay || ride.pickup || 'Pickup location'}</div>
                </div>
                <div class="history-location">
                    <i class="fas fa-flag"></i>
                    <div class="history-location-text">${ride.destinationDisplay || ride.destination || 'Destination'}</div>
                </div>
            </div>
            
            <div class="history-footer">
                <div class="history-price">ZMW ${ride.fare?.toFixed(2) || '0.00'}</div>
                <div class="history-status ${statusClass}">
                    ${ride.status.charAt(0).toUpperCase() + ride.status.slice(1)}
                </div>
            </div>
            
            <div class="history-details">
                ${this.createHistoryDetails(ride)}
            </div>
        `;
        
        // Add click event to expand/collapse details
        item.addEventListener('click', (e) => {
            if (!e.target.closest('.history-details')) {
                item.classList.toggle('expanded');
            }
        });
        
        return item;
    },
    
    createHistoryDetails: function(ride) {
        let details = `
            <div class="detail-section">
                <div class="detail-title">
                    <i class="fas fa-info-circle"></i>
                    Ride Details
                </div>
                <div class="detail-grid">
                    <div class="detail-item">
                        <div class="detail-label">Distance</div>
                        <div class="detail-value">${ride.distance?.toFixed(1) || '0'} km</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Duration</div>
                        <div class="detail-value">${ride.duration || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Ride Type</div>
                        <div class="detail-value">${ride.rideType?.charAt(0).toUpperCase() + ride.rideType?.slice(1) || 'Standard'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Payment</div>
                        <div class="detail-value">${ride.paymentMethod?.charAt(0).toUpperCase() + ride.paymentMethod?.slice(1) || 'Wallet'}</div>
                    </div>
                </div>
            </div>
        `;
        
        if (ride.driverName) {
            details += `
                <div class="detail-section">
                    <div class="detail-title">
                        <i class="fas fa-user"></i>
                        Driver Details
                    </div>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Driver Name</div>
                            <div class="detail-value">${ride.driverName}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Vehicle</div>
                            <div class="detail-value">${ride.vehicleDetails || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Rating</div>
                            <div class="detail-value">${ride.driverRating || 'N/A'}</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        if (ride.emergency) {
            details += `
                <div class="detail-section">
                    <div class="detail-title">
                        <i class="fas fa-exclamation-triangle"></i>
                        Emergency Details
                    </div>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Service Type</div>
                            <div class="detail-value">${ride.emergencyType?.charAt(0).toUpperCase() + ride.emergencyType?.slice(1)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Priority</div>
                            <div class="detail-value">${ride.priority || 'High'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Reason</div>
                            <div class="detail-value">${ride.emergencyReason || 'N/A'}</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        if (ride.broadcast) {
            details += `
                <div class="detail-section">
                    <div class="detail-title">
                        <i class="fas fa-broadcast-tower"></i>
                        Broadcast Details
                    </div>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Participants</div>
                            <div class="detail-value">${ride.participants?.length || 0} people</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Broadcast Code</div>
                            <div class="detail-value">${ride.broadcastCode || 'N/A'}</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        if (ride.serviceType === 'delivery' || ride.serviceType === 'short-delivery') {
            details += `
                <div class="detail-section">
                    <div class="detail-title">
                        <i class="fas fa-box"></i>
                        Delivery Details
                    </div>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Delivery Type</div>
                            <div class="detail-value">${ride.deliveryType?.charAt(0).toUpperCase() + ride.deliveryType?.slice(1) || 'Standard'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Parcel Value</div>
                            <div class="detail-value">ZMW ${ride.parcelValue?.toFixed(2) || '0.00'}</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        if (ride.serviceType === 'truck') {
            details += `
                <div class="detail-section">
                    <div class="detail-title">
                        <i class="fas fa-truck"></i>
                        Truck Details
                    </div>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Truck Type</div>
                            <div class="detail-value">${ride.truckType?.charAt(0).toUpperCase() + ride.truckType?.slice(1) || 'Light'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Helpers</div>
                            <div class="detail-value">${ride.helpers ? 'Yes' : 'No'}</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        return details;
    },
    
    updateHistoryFilters: function() {
        const filtersContainer = document.getElementById('historyFilters');
        if (!filtersContainer) return;
        
        const filters = [
            { id: 'all', name: 'All Rides' },
            { id: 'completed', name: 'Completed' },
            { id: 'cancelled', name: 'Cancelled' },
            { id: 'scheduled', name: 'Scheduled' },
            { id: 'emergency', name: 'Emergency' },
            { id: 'delivery', name: 'Delivery' },
            { id: 'truck', name: 'Truck' },
            { id: 'broadcast', name: 'Shared' }
        ];
        
        filtersContainer.innerHTML = '';
        
        filters.forEach(filter => {
            const button = document.createElement('button');
            button.className = `filter-btn ${filter.id === AppState.activeFilters.history ? 'active' : ''}`;
            button.textContent = filter.name;
            button.dataset.filter = filter.id;
            
            button.addEventListener('click', () => {
                AppState.activeFilters.history = filter.id;
                this.filterHistory();
                
                // Update active state
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                button.classList.add('active');
            });
            
            filtersContainer.appendChild(button);
        });
    },
    
    filterHistory: function() {
        const filter = AppState.activeFilters.history;
        let filteredRides = [...AppState.rideHistory];
        
        switch(filter) {
            case 'completed':
                filteredRides = filteredRides.filter(ride => ride.status === 'completed');
                break;
            case 'cancelled':
                filteredRides = filteredRides.filter(ride => ride.status === 'cancelled');
                break;
            case 'scheduled':
                filteredRides = filteredRides.filter(ride => ride.scheduled);
                break;
            case 'emergency':
                filteredRides = filteredRides.filter(ride => ride.emergency);
                break;
            case 'delivery':
                filteredRides = filteredRides.filter(ride => ride.serviceType === 'delivery' || ride.serviceType === 'short-delivery');
                break;
            case 'truck':
                filteredRides = filteredRides.filter(ride => ride.serviceType === 'truck');
                break;
            case 'broadcast':
                filteredRides = filteredRides.filter(ride => ride.broadcast);
                break;
            // 'all' shows all rides
        }
        
        this.updateHistoryList(filteredRides);
    },
    
    // Account screen
    loadAccountScreen: function() {
        if (!AppState.userData) return;
        
        // Update user info
        document.getElementById('accountName').textContent = AppState.userData.name || 'User';
        document.getElementById('accountPhone').textContent = AppState.userData.phone || 'Not set';
        
        // Update avatar
        const avatar = document.getElementById('accountAvatar');
        if (avatar && AppState.userData.name) {
            const initials = AppState.userData.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
            avatar.innerHTML = `<span style="font-size: 24px; font-weight: 700;">${initials}</span>`;
        }
        
        // Update stats
        this.updateUserStats();
        
        // Update referral code
        const referralCode = document.getElementById('referralCode');
        if (referralCode) {
            referralCode.textContent = AppState.userData.referralCode || `JUBEL-${AppState.currentUser.uid.substring(0, 8).toUpperCase()}`;
        }
    },
    
    updateUserStats: function() {
        // Calculate stats from ride history
        const completedRides = AppState.rideHistory.filter(ride => ride.status === 'completed').length;
        const cancelledRides = AppState.rideHistory.filter(ride => ride.status === 'cancelled').length;
        const totalSpent = AppState.rideHistory
            .filter(ride => ride.status === 'completed')
            .reduce((sum, ride) => sum + (ride.fare || 0), 0);
        
        document.getElementById('completedRides').textContent = completedRides;
        document.getElementById('cancelledRides').textContent = cancelledRides;
        document.getElementById('totalSpent').textContent = `ZMW ${totalSpent.toFixed(2)}`;
        
        AppState.userStats = {
            completedRides,
            cancelledRides,
            totalSpent
        };
    },
    
    // Emergency screen
    loadEmergencyScreen: function() {
        // Nothing special needed here
    },
    
    // More options
    showMoreOptions: function() {
        const dropdown = document.getElementById('moreOptionsDropdown');
        dropdown.classList.toggle('active');
    },
    
    handleMoreOption: function(option) {
        const optionConfig = AppState.moreOptions[option];
        if (!optionConfig) return;
        
        // Hide all forms
        document.querySelectorAll('.ride-request-form, .service-form').forEach(form => {
            form.style.display = 'none';
        });
        
        // Show selected option form
        const form = document.getElementById(optionConfig.form);
        if (form) {
            form.style.display = 'block';
            form.classList.add('active');
            
            // Initialize form
            this.initializeMoreOptionForm(option);
        }
        
        // Hide dropdown
        document.getElementById('moreOptionsDropdown').classList.remove('active');
    },
    
    initializeMoreOptionForm: function(option) {
        switch(option) {
            case 'schedule':
                this.initializeScheduleForm();
                break;
            case 'order-for-someone':
                this.initializeOrderForSomeoneForm();
                break;
            case 'share':
                this.initializeShareRideForm();
                break;
        }
    },
    
    initializeScheduleForm: function() {
        // Set minimum date to today
        const today = new Date().toISOString().split('T')[0];
        const dateInput = document.getElementById('scheduleDate');
        if (dateInput) {
            dateInput.min = today;
            
            // Set default to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            dateInput.value = tomorrow.toISOString().split('T')[0];
        }
        
        // Set default time to next hour
        const timeInput = document.getElementById('scheduleTime');
        if (timeInput) {
            const nextHour = new Date();
            nextHour.setHours(nextHour.getHours() + 1);
            timeInput.value = `${nextHour.getHours().toString().padStart(2, '0')}:00`;
        }
    },
    
    initializeOrderForSomeoneForm: function() {
        // Pre-fill recipient phone if available
        const recipientPhone = document.getElementById('recipientPhone');
        if (recipientPhone && AppState.userData?.phone) {
            recipientPhone.value = AppState.userData.phone;
        }
    },
    
    initializeShareRideForm: function() {
        // Initialize share calculations
        if (AppState.pickup && AppState.destination) {
            this.updateShareCalculations();
        }
    },
    
    updateShareCalculations: function() {
        const distance = PriceCalculator.calculateDistance(
            AppState.pickup.lat, AppState.pickup.lng,
            AppState.destination.lat, AppState.destination.lng
        );
        
        const surge = PriceCalculator.getSurgeMultiplier();
        const totalFare = PriceCalculator.calculateRideFare(distance, AppState.selectedRideType, surge);
        
        const splitSlider = document.getElementById('splitPercentage');
        const splitPercentage = splitSlider ? parseInt(splitSlider.value) : 50;
        
        const yourShare = (totalFare * splitPercentage) / 100;
        const friendShare = totalFare - yourShare;
        
        document.getElementById('shareFareEstimate').textContent = `ZMW ${totalFare.toFixed(2)}`;
        document.getElementById('yourShare').textContent = `ZMW ${yourShare.toFixed(2)}`;
        document.getElementById('friendShare').textContent = `ZMW ${friendShare.toFixed(2)}`;
    },
    
    // Broadcast ride
    showBroadcastModal: function() {
        document.getElementById('broadcastModal').classList.add('active');
        
        // Clear previous phone numbers
        AppState.broadcastPhones = [];
        this.updateBroadcastPhoneList();
    },
    
    updateBroadcastPhoneList: function() {
        const container = document.getElementById('broadcastPhoneList');
        if (!container) return;
        
        container.innerHTML = '';
        
        AppState.broadcastPhones.forEach((phone, index) => {
            const item = document.createElement('div');
            item.className = 'broadcast-phone-item';
            item.innerHTML = `
                <span>${phone.number} ${phone.name ? `(${phone.name})` : ''}</span>
                <button class="broadcast-remove-phone" data-index="${index}">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.appendChild(item);
        });
    },
    
    async lookupPhoneNumber: function(phoneNumber) {
        try {
            // Search in Firebase for user with this phone number
            const snapshot = await database.ref('users')
                .orderByChild('phone')
                .equalTo(phoneNumber)
                .once('value');
            
            const users = snapshot.val();
            if (users) {
                const userId = Object.keys(users)[0];
                const user = users[userId];
                return {
                    number: phoneNumber,
                    name: user.name,
                    userId: userId
                };
            }
            
            return {
                number: phoneNumber,
                name: null
            };
        } catch (error) {
            console.error('Error looking up phone number:', error);
            return {
                number: phoneNumber,
                name: null
            };
        }
    },
    
    // Emergency services
    showEmergencyStations: function(stations, serviceType) {
        const container = document.getElementById('emergencyStations');
        if (!container) return;
        
        container.innerHTML = '';
        
        if (stations.length === 0) {
            container.innerHTML = `
                <div class="no-results" style="padding: 20px;">
                    <i class="fas fa-exclamation-circle"></i>
                    <div>No ${serviceType} stations found nearby</div>
                </div>
            `;
            return;
        }
        
        stations.forEach((station, index) => {
            const stationElement = document.createElement('div');
            stationElement.className = 'emergency-station';
            if (index === 0) stationElement.classList.add('selected');
            
            const icon = serviceType === 'police' ? 'fa-shield-alt' :
                        serviceType === 'fire' ? 'fa-fire-extinguisher' : 'fa-ambulance';
            
            stationElement.innerHTML = `
                <div class="emergency-station-icon">
                    <i class="fas ${icon}"></i>
                </div>
                <div class="emergency-station-info">
                    <div class="emergency-station-name">${station.name}</div>
                    <div class="emergency-station-address">${station.address}</div>
                    <div class="emergency-station-distance">
                        <i class="fas fa-ruler"></i>
                        ${station.distance.toFixed(1)} km away
                    </div>
                </div>
            `;
            
            stationElement.addEventListener('click', () => {
                document.querySelectorAll('.emergency-station').forEach(s => {
                    s.classList.remove('selected');
                });
                stationElement.classList.add('selected');
                AppState.selectedEmergencyStation = station;
            });
            
            container.appendChild(stationElement);
        });
    },
    
    // Add stop functionality
    addStop: function() {
        const stopInput = document.getElementById('stopInput');
        if (!stopInput) return;
        
        // Create stop input field
        const stopsContainer = document.getElementById('stopsContainer');
        if (!stopsContainer) return;
        
        const stopIndex = stopsContainer.children.length;
        const stopDiv = document.createElement('div');
        stopDiv.className = 'location-input stop-input';
        stopDiv.innerHTML = `
            <i class="fas fa-dot-circle" style="color: var(--info-blue);"></i>
            <input type="text" class="stop-location" placeholder="Add stop ${stopIndex + 1}" data-index="${stopIndex}">
            <div class="search-loading"></div>
            <div class="suggestion-list stop-suggestions" data-index="${stopIndex}"></div>
            <button type="button" class="remove-stop" data-index="${stopIndex}">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        stopsContainer.appendChild(stopDiv);
        
        // Add event listeners
        const input = stopDiv.querySelector('.stop-location');
        const removeBtn = stopDiv.querySelector('.remove-stop');
        
        input.addEventListener('input', this.handleStopSearch.bind(this));
        removeBtn.addEventListener('click', this.removeStop.bind(this));
    },
    
    handleStopSearch: async function(e) {
        const input = e.target;
        const stopIndex = parseInt(input.dataset.index);
        const query = input.value.trim();
        
        if (query.length < 2) {
            const suggestions = document.querySelector(`.stop-suggestions[data-index="${stopIndex}"]`);
            if (suggestions) suggestions.classList.remove('active');
            return;
        }
        
        const parent = input.closest('.location-input');
        if (parent) parent.classList.add('searching');
        
        try {
            const results = await SearchEngine.search(query, 'stop', AppState.userLocation);
            this.showStopSuggestions(stopIndex, results);
        } catch (error) {
            console.error('Stop search error:', error);
        }
    },
    
    showStopSuggestions: function(stopIndex, results) {
        const container = document.querySelector(`.stop-suggestions[data-index="${stopIndex}"]`);
        if (!container) return;
        
        container.innerHTML = '';
        
        if (results.length === 0) {
            container.innerHTML = `
                <div class="no-results">
                    <i class="fas fa-search"></i>
                    <div>No results found</div>
                </div>
            `;
        } else {
            results.forEach((result, index) => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                if (index === 0) item.classList.add('selected');
                
                item.innerHTML = `
                    <div class="suggestion-icon">
                        <i class="fas fa-dot-circle"></i>
                    </div>
                    <div class="suggestion-details">
                        <div class="suggestion-name">${result.name}</div>
                        <div class="suggestion-address">${result.address}</div>
                        ${result.distance ? `
                        <div class="suggestion-distance">
                            <i class="fas fa-ruler"></i>
                            ${result.distance.toFixed(1)} km away
                        </div>
                        ` : ''}
                    </div>
                `;
                
                item.addEventListener('click', () => {
                    this.selectStop(stopIndex, result);
                });
                
                container.appendChild(item);
            });
        }
        
        container.classList.add('active');
        
        const parent = container.closest('.location-input');
        if (parent) parent.classList.remove('searching');
    },
    
    selectStop: function(stopIndex, location) {
        const input = document.querySelector(`.stop-location[data-index="${stopIndex}"]`);
        const container = document.querySelector(`.stop-suggestions[data-index="${stopIndex}"]`);
        
        if (input && location) {
            input.value = location.address;
            
            // Add stop to AppState
            AppState.stops[stopIndex] = location;
            
            // Update map and route
            this.updateStopMarker(stopIndex, location);
            this.updateRouteWithStops();
            
            if (container) {
                container.classList.remove('active');
            }
        }
    },
    
    updateStopMarker: function(stopIndex, location) {
        // Remove existing marker for this stop
        if (stopMarkers[stopIndex]) {
            map.removeLayer(stopMarkers[stopIndex]);
        }
        
        // Add new marker
        stopMarkers[stopIndex] = L.marker([location.lat, location.lng], {
            icon: L.divIcon({
                className: 'stop-marker',
                html: '<i class="fas fa-dot-circle"></i>',
                iconSize: [18, 18],
                iconAnchor: [9, 9]
            })
        }).addTo(map).bindPopup(`Stop ${stopIndex + 1}`);
    },
    
    updateRouteWithStops: function() {
        if (!AppState.pickup || !AppState.destination) return;
        
        const allPoints = [AppState.pickup, ...AppState.stops.filter(s => s), AppState.destination];
        this.drawRoute([AppState.pickup], [AppState.destination], AppState.stops.filter(s => s));
        
        // Recalculate prices with stops
        this.calculateAndUpdatePrices();
    },
    
    removeStop: function(e) {
        const stopIndex = parseInt(e.target.closest('.remove-stop').dataset.index);
        
        // Remove from AppState
        AppState.stops.splice(stopIndex, 1);
        
        // Remove marker
        if (stopMarkers[stopIndex]) {
            map.removeLayer(stopMarkers[stopIndex]);
            stopMarkers.splice(stopIndex, 1);
        }
        
        // Remove input
        const stopDiv = document.querySelector(`.stop-input[data-index="${stopIndex}"]`);
        if (stopDiv) {
            stopDiv.remove();
        }
        
        // Renumber remaining stops
        this.renumberStops();
        
        // Update route
        this.updateRouteWithStops();
    },
    
    renumberStops: function() {
        const stopsContainer = document.getElementById('stopsContainer');
        if (!stopsContainer) return;
        
        const stopInputs = stopsContainer.querySelectorAll('.stop-input');
        stopInputs.forEach((inputDiv, index) => {
            inputDiv.dataset.index = index;
            const input = inputDiv.querySelector('.stop-location');
            const removeBtn = inputDiv.querySelector('.remove-stop');
            const suggestions = inputDiv.querySelector('.stop-suggestions');
            
            if (input) {
                input.dataset.index = index;
                input.placeholder = `Add stop ${index + 1}`;
            }
            
            if (removeBtn) {
                removeBtn.dataset.index = index;
            }
            
            if (suggestions) {
                suggestions.dataset.index = index;
            }
        });
    },
    
    // Ride info panel
    showRideInfo: function(ride) {
        document.querySelectorAll('.ride-request-form, .service-form').forEach(form => {
            form.style.display = 'none';
        });
        
        const rideInfoPanel = document.getElementById('rideInfoPanel');
        if (rideInfoPanel) {
            rideInfoPanel.style.display = 'block';
            rideInfoPanel.classList.add('active');
        }
        
        // Update ride details
        this.updateRideDetails(ride);
        
        // Show ride status bar
        this.updateRideStatus(ride.status);
    },
    
    updateRideDetails: function(ride) {
        // Update pickup and destination
        document.getElementById('currentPickup').textContent = ride.pickupDisplay || ride.pickup;
        document.getElementById('currentDestination').textContent = ride.destinationDisplay || ride.destination;
        
        // Calculate fare breakdown
        const distance = ride.distance || 0;
        let baseFare, distanceFare, totalFare;
        
        switch(ride.serviceType) {
            case 'truck':
                const truckConfig = AppState.truckTypes[ride.truckType] || AppState.truckTypes.light;
                baseFare = truckConfig.base;
                distanceFare = distance * truckConfig.perKm;
                totalFare = ride.fare || baseFare + distanceFare;
                break;
            case 'delivery':
            case 'short-delivery':
                const deliveryConfig = AppState.deliveryTypes[ride.deliveryType] || AppState.deliveryTypes.standard;
                baseFare = deliveryConfig.base;
                distanceFare = distance * deliveryConfig.perKm;
                totalFare = ride.fare || baseFare + distanceFare;
                break;
            case 'bicycle':
                const bicycleConfig = AppState.bicycleTypes[ride.bicycleType] || AppState.bicycleTypes.standard;
                baseFare = bicycleConfig.base;
                distanceFare = distance * bicycleConfig.perKm;
                totalFare = ride.fare || baseFare + distanceFare;
                break;
            default:
                const rideConfig = AppState.rideTypes[ride.rideType] || AppState.rideTypes.standard;
                baseFare = rideConfig.base;
                distanceFare = distance * rideConfig.perKm;
                totalFare = ride.fare || baseFare + distanceFare;
        }
        
        // Update fare breakdown
        document.getElementById('baseFareValue').textContent = `ZMW ${baseFare.toFixed(2)}`;
        document.getElementById('distanceFareValue').textContent = `ZMW ${distanceFare.toFixed(2)}`;
        
        if (ride.serviceType) {
            document.getElementById('rideTypeValue').textContent = 
                ride.serviceType.charAt(0).toUpperCase() + ride.serviceType.slice(1);
        } else {
            document.getElementById('rideTypeValue').textContent = 
                ride.rideType.charAt(0).toUpperCase() + ride.rideType.slice(1);
        }
        
        document.getElementById('totalFareValue').textContent = `ZMW ${totalFare.toFixed(2)}`;
    },
    
    updateRideStatus: function(status) {
        const statusBar = document.getElementById('rideStatusBar');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const etaText = document.getElementById('etaText');
        
        if (statusBar) {
            statusBar.classList.add('active');
        }
        
        if (statusDot && statusText && etaText) {
            switch(status) {
                case 'requested':
                    statusDot.className = 'status-dot searching';
                    statusText.textContent = 'Searching for driver';
                    etaText.textContent = '5-10 min';
                    break;
                case 'accepted':
                    statusDot.className = 'status-dot arriving';
                    statusText.textContent = 'Driver on the way';
                    etaText.textContent = '5 min';
                    // Show SOS button
                    if (AppState.sosConfig) {
                        document.getElementById('sosButton').style.display = 'flex';
                    }
                    break;
                case 'arrived':
                    statusDot.className = 'status-dot riding';
                    statusText.textContent = 'Driver arrived';
                    etaText.textContent = '0 min';
                    break;
                case 'started':
                    statusDot.className = 'status-dot riding';
                    statusText.textContent = 'Trip in progress';
                    etaText.textContent = 'En route';
                    break;
                case 'completed':
                    if (statusBar) {
                        statusBar.classList.remove('active');
                    }
                    break;
            }
        }
    },
    
    // Update timeline
    updateTimeline: function(status) {
        const steps = ['stepRequested', 'stepAccepted', 'stepArrived', 'stepStarted', 'stepCompleted'];
        const stepLabels = ['Requested', 'Accepted', 'Arrived', 'Started', 'Completed'];
        const currentIndex = stepLabels.indexOf(status);
        
        steps.forEach((stepId, index) => {
            const step = document.getElementById(stepId);
            const label = step?.parentNode.querySelector('.step-label');
            
            if (step && label) {
                if (index < currentIndex) {
                    step.className = 'step-dot completed';
                    label.className = 'step-label';
                } else if (index === currentIndex) {
                    step.className = 'step-dot active';
                    label.className = 'step-label active';
                } else {
                    step.className = 'step-dot';
                    label.className = 'step-label';
                }
            }
        });
    }
};

// ============================================
// ENHANCED FIREBASE MANAGER
// ============================================
const FirebaseManager = {
    // Load user data
    async loadUserData(uid) {
        try {
            const snapshot = await database.ref(`users/${uid}`).once('value');
            AppState.userData = snapshot.val();
            
            if (AppState.userData) {
                // Update wallet balance
                AppState.walletBalance = AppState.userData.walletBalance || 0;
                UIUpdater.updateWalletBalance(AppState.walletBalance);
                
                // Update user name in top bar
                UIUpdater.updateUserName(AppState.userData.name || 'User');
                
                // Load additional data
                await Promise.all([
                    this.loadSOSConfig(uid),
                    this.loadScheduledRides(uid),
                    this.loadRideHistory(uid),
                    this.loadNotifications(uid),
                    this.checkActiveRide(uid)
                ]);
                
                // Set up real-time listeners
                this.setupRealtimeListeners(uid);
                
                return true;
            }
            return false;
        } catch (error) {
            console.error('Error loading user data:', error);
            UIUpdater.showToast('Error loading user data', 'error');
            return false;
        }
    },
    
    // Set up real-time listeners
    setupRealtimeListeners: function(uid) {
        // Wallet balance updates
        database.ref(`users/${uid}/walletBalance`).on('value', (snapshot) => {
            const balance = snapshot.val() || 0;
            AppState.walletBalance = balance;
            UIUpdater.updateWalletBalance(balance);
        });
        
        // Active ride updates
        database.ref('rides')
            .orderByChild('passengerId')
            .equalTo(uid)
            .orderByChild('status')
            .startAt('requested')
            .endAt('started')
            .on('child_changed', (snapshot) => {
                const ride = snapshot.val();
                if (ride) {
                    AppState.currentRide = { id: snapshot.key, ...ride };
                    UIUpdater.updateRideStatus(ride.status);
                    UIUpdater.updateTimeline(ride.status);
                    
                    if (ride.driverId) {
                        this.loadDriverInfo(ride.driverId);
                    }
                }
            });
        
        // Notifications
        database.ref(`notifications/${uid}`)
            .orderByChild('timestamp')
            .limitToLast(20)
            .on('value', (snapshot) => {
                const notifications = snapshot.val();
                if (notifications) {
                    AppState.notifications = Object.values(notifications).reverse();
                    const unreadCount = AppState.notifications.filter(n => !n.read).length;
                    UIUpdater.updateNotificationBadge(unreadCount);
                }
            });
        
        // Driver location updates
        database.ref('driverLocations').on('child_changed', (snapshot) => {
            const driverId = snapshot.key;
            const location = snapshot.val();
            
            if (AppState.currentRide && AppState.currentRide.driverId === driverId) {
                AppState.driverLocation = location;
                // Update driver marker on map
            }
        });
    },
    
    // Load SOS configuration
    async loadSOSConfig(uid) {
        try {
            const snapshot = await database.ref(`sosConfig/${uid}`).once('value');
            AppState.sosConfig = snapshot.val();
            
            if (AppState.sosConfig) {
                // Pre-fill SOS form
                document.getElementById('sosContact1Name').value = AppState.sosConfig.contact1Name || '';
                document.getElementById('sosContact1Phone').value = AppState.sosConfig.contact1Phone || '';
                document.getElementById('sosContact2Name').value = AppState.sosConfig.contact2Name || '';
                document.getElementById('sosContact2Phone').value = AppState.sosConfig.contact2Phone || '';
                document.getElementById('sosMessage').value = AppState.sosConfig.message || '';
            }
        } catch (error) {
            console.error('Error loading SOS config:', error);
        }
    },
    
    // Load scheduled rides
    async loadScheduledRides(uid) {
        try {
            const snapshot = await database.ref('scheduledRides')
                .orderByChild('passengerId')
                .equalTo(uid)
                .once('value');
            
            const rides = snapshot.val();
            if (rides) {
                AppState.scheduledRides = Object.values(rides).filter(ride => 
                    ride.status === 'scheduled' || ride.status === 'upcoming'
                );
            }
        } catch (error) {
            console.error('Error loading scheduled rides:', error);
        }
    },
    
    // Check for active ride
    async checkActiveRide(uid) {
        try {
            const snapshot = await database.ref('rides')
                .orderByChild('passengerId')
                .equalTo(uid)
                .orderByChild('status')
                .startAt('requested')
                .endAt('started')
                .once('value');
            
            const rides = snapshot.val();
            if (rides) {
                const rideId = Object.keys(rides)[0];
                AppState.currentRide = { id: rideId, ...rides[rideId] };
                UIUpdater.showRideInfo(AppState.currentRide);
                UIUpdater.updateTimeline(AppState.currentRide.status);
                
                if (AppState.currentRide.driverId) {
                    await this.loadDriverInfo(AppState.currentRide.driverId);
                }
                
                return true;
            }
            return false;
        } catch (error) {
            console.error('Error checking active ride:', error);
            return false;
        }
    },
    
    // Load driver info
    async loadDriverInfo(driverId) {
        try {
            const snapshot = await database.ref(`users/${driverId}`).once('value');
            const driver = snapshot.val();
            if (driver) {
                AppState.selectedVehicle = driver;
                
                // Load vehicle info if available
                if (driver.vehicleId) {
                    const vehicleSnapshot = await database.ref(`vehicles/${driver.vehicleId}`).once('value');
                    const vehicle = vehicleSnapshot.val();
                    if (vehicle) {
                        AppState.selectedVehicle.vehicle = vehicle;
                    }
                }
            }
        } catch (error) {
            console.error('Error loading driver info:', error);
        }
    },
    
    // Load ride history
    async loadRideHistory(uid) {
        try {
            const snapshot = await database.ref('rides')
                .orderByChild('passengerId')
                .equalTo(uid)
                .once('value');
            
            const rides = snapshot.val();
            if (rides) {
                const ridesArray = Object.keys(rides).map(id => ({
                    id,
                    ...rides[id]
                }));
                
                // Sort by timestamp (newest first)
                ridesArray.sort((a, b) => b.timestamp - a.timestamp);
                
                AppState.rideHistory = ridesArray;
                return ridesArray;
            }
            return [];
        } catch (error) {
            console.error('Error loading ride history:', error);
            return [];
        }
    },
    
    // Load notifications
    async loadNotifications(uid) {
        try {
            const snapshot = await database.ref(`notifications/${uid}`)
                .orderByChild('timestamp')
                .limitToLast(20)
                .once('value');
            
            const notifications = snapshot.val();
            if (notifications) {
                AppState.notifications = Object.values(notifications).reverse();
                const unreadCount = AppState.notifications.filter(n => !n.read).length;
                UIUpdater.updateNotificationBadge(unreadCount);
            }
        } catch (error) {
            console.error('Error loading notifications:', error);
        }
    },
    
    // Mark notification as read
    async markNotificationAsRead(notificationId) {
        try {
            await database.ref(`notifications/${AppState.currentUser.uid}/${notificationId}/read`).set(true);
            return true;
        } catch (error) {
            console.error('Error marking notification as read:', error);
            return false;
        }
    },
    
    // Mark all notifications as read
    async markAllNotificationsAsRead() {
        try {
            const updates = {};
            AppState.notifications.forEach(notification => {
                if (!notification.read) {
                    updates[`notifications/${AppState.currentUser.uid}/${notification.id}/read`] = true;
                }
            });
            
            await database.ref().update(updates);
            UIUpdater.updateNotificationBadge(0);
            return true;
        } catch (error) {
            console.error('Error marking all notifications as read:', error);
            return false;
        }
    },
    
    // Request a ride
    async requestRide(rideData) {
        try {
            const rideId = database.ref().child('rides').push().key;
            const ride = {
                id: rideId,
                ...rideData,
                status: 'requested',
                timestamp: Date.now(),
                updatedAt: Date.now()
            };
            
            await database.ref(`rides/${rideId}`).set(ride);
            
            AppState.currentRide = ride;
            UIUpdater.showRideInfo(ride);
            UIUpdater.updateTimeline('requested');
            
            // Send notification
            await this.sendNotification(
                AppState.currentUser.uid,
                'Ride Requested',
                `Your ${rideData.serviceType || 'ride'} has been requested. Searching for driver...`,
                'ride',
                { rideId: rideId }
            );
            
            UIUpdater.showToast('Ride requested successfully', 'success');
            return rideId;
        } catch (error) {
            console.error('Error requesting ride:', error);
            UIUpdater.showToast('Error requesting ride', 'error');
            throw error;
        }
    },
    
    // Request emergency ride
    async requestEmergencyRide(rideData) {
        try {
            const rideId = database.ref().child('rides').push().key;
            const ride = {
                id: rideId,
                ...rideData,
                status: 'requested',
                emergency: true,
                priority: 'high',
                timestamp: Date.now(),
                updatedAt: Date.now()
            };
            
            await database.ref(`rides/${rideId}`).set(ride);
            
            AppState.currentRide = ride;
            AppState.emergencyMode = true;
            UIUpdater.showRideInfo(ride);
            UIUpdater.updateTimeline('requested');
            
            // Show emergency status
            document.getElementById('emergencyStatus').style.display = 'flex';
            
            // Send notification
            await this.sendNotification(
                AppState.currentUser.uid,
                'Emergency Ride Requested',
                `Emergency ${rideData.emergencyType} ride has been requested.`,
                'emergency',
                { rideId: rideId }
            );
            
            // Send SOS alert if configured
            if (AppState.sosConfig) {
                await this.sendSOSAlert(rideId, rideData);
            }
            
            UIUpdater.showToast('Emergency ride requested', 'success');
            return rideId;
        } catch (error) {
            console.error('Error requesting emergency ride:', error);
            UIUpdater.showToast('Error requesting emergency ride', 'error');
            throw error;
        }
    },
    
    // Send SOS alert
    async sendSOSAlert(rideId, rideData) {
        try {
            const sosData = {
                passengerId: AppState.currentUser.uid,
                passengerName: AppState.userData.name,
                passengerPhone: AppState.userData.phone,
                emergencyContact1: AppState.sosConfig.contact1Phone,
                emergencyContact1Name: AppState.sosConfig.contact1Name,
                emergencyContact2: AppState.sosConfig.contact2Phone,
                emergencyContact2Name: AppState.sosConfig.contact2Name,
                message: AppState.sosConfig.message,
                rideId: rideId,
                location: AppState.userLocation,
                timestamp: Date.now()
            };
            
            const alertId = database.ref().child('sosAlerts').push().key;
            await database.ref(`sosAlerts/${alertId}`).set(sosData);
            
            UIUpdater.showToast('SOS alert sent to emergency contacts', 'success');
            return true;
        } catch (error) {
            console.error('Error sending SOS alert:', error);
            return false;
        }
    },
    
    // Save SOS configuration
    async saveSOSConfig(config) {
        try {
            await database.ref(`sosConfig/${AppState.currentUser.uid}`).set(config);
            AppState.sosConfig = config;
            UIUpdater.showToast('SOS configuration saved', 'success');
            return true;
        } catch (error) {
            console.error('Error saving SOS config:', error);
            UIUpdater.showToast('Error saving SOS config', 'error');
            return false;
        }
    },
    
    // Send notification
    async sendNotification(userId, title, message, type = 'info', data = {}) {
        try {
            const notificationId = database.ref().child(`notifications/${userId}`).push().key;
            const notification = {
                id: notificationId,
                title,
                message,
                type,
                read: false,
                timestamp: Date.now(),
                ...data
            };
            
            await database.ref(`notifications/${userId}/${notificationId}`).set(notification);
            return true;
        } catch (error) {
            console.error('Error sending notification:', error);
            return false;
        }
    },
    
    // Start broadcast
    async startBroadcast(phoneNumbers, message = '') {
        try {
            if (!AppState.currentRide) {
                throw new Error('No active ride to broadcast');
            }
            
            const broadcastId = database.ref().child('broadcasts').push().key;
            const broadcastCode = `BC-${Math.random().toString(36).substr(2, 6).toUpperCase()}`;
            
            const broadcastData = {
                id: broadcastId,
                rideId: AppState.currentRide.id,
                passengerId: AppState.currentUser.uid,
                passengerName: AppState.userData.name,
                code: broadcastCode,
                phoneNumbers: phoneNumbers.map(p => p.number),
                participants: phoneNumbers.map(p => ({
                    phone: p.number,
                    name: p.name,
                    status: 'invited'
                })),
                message: message,
                status: 'active',
                createdAt: Date.now(),
                updatedAt: Date.now()
            };
            
            await database.ref(`broadcasts/${broadcastId}`).set(broadcastData);
            
            // Update ride with broadcast info
            await database.ref(`rides/${AppState.currentRide.id}/broadcast`).set({
                id: broadcastId,
                code: broadcastCode,
                participants: phoneNumbers.length
            });
            
            AppState.broadcastData = broadcastData;
            AppState.isBroadcasting = true;
            AppState.broadcastCode = broadcastCode;
            
            // Send invitations
            for (const phoneNumber of phoneNumbers) {
                await this.sendBroadcastInvitation(phoneNumber, broadcastCode, message);
            }
            
            // Set up listeners
            this.setupBroadcastListeners(broadcastId);
            
            UIUpdater.showToast(`Broadcast started. Code: ${broadcastCode}`, 'success');
            return broadcastData;
        } catch (error) {
            console.error('Error starting broadcast:', error);
            UIUpdater.showToast('Error starting broadcast', 'error');
            throw error;
        }
    },
    
    // Send broadcast invitation
    async sendBroadcastInvitation(phoneNumber, code, message) {
        try {
            // Find user by phone number
            const snapshot = await database.ref('users')
                .orderByChild('phone')
                .equalTo(phoneNumber.number)
                .once('value');
            
            const users = snapshot.val();
            if (users) {
                const userId = Object.keys(users)[0];
                await this.sendNotification(
                    userId,
                    'Ride Broadcast Invitation',
                    `${AppState.userData.name} has invited you to track their ride. Code: ${code}`,
                    'broadcast',
                    { broadcastCode: code, message }
                );
            }
            
            return true;
        } catch (error) {
            console.error('Error sending broadcast invitation:', error);
            return false;
        }
    },
    
    // Set up broadcast listeners
    setupBroadcastListeners: function(broadcastId) {
        // Listen for participant updates
        database.ref(`broadcasts/${broadcastId}/participants`).on('child_changed', (snapshot) => {
            const participant = snapshot.val();
            const index = AppState.broadcastParticipants.findIndex(p => p.phone === participant.phone);
            
            if (index !== -1) {
                AppState.broadcastParticipants[index] = participant;
            } else {
                AppState.broadcastParticipants.push(participant);
            }
            
            // Update UI
            UIUpdater.updateBroadcastParticipants(AppState.broadcastParticipants);
        });
        
        // Listen for broadcast status
        database.ref(`broadcasts/${broadcastId}/status`).on('value', (snapshot) => {
            const status = snapshot.val();
            if (status === 'ended') {
                this.endBroadcast();
            }
        });
    },
    
    // End broadcast
    async endBroadcast() {
        try {
            if (!AppState.broadcastData) return;
            
            await database.ref(`broadcasts/${AppState.broadcastData.id}/status`).set('ended');
            
            // Clear broadcast data
            AppState.broadcastData = null;
            AppState.isBroadcasting = false;
            AppState.broadcastCode = null;
            AppState.broadcastParticipants = [];
            
            // Hide broadcast tracking
            document.getElementById('broadcastTracking').classList.remove('active');
            
            UIUpdater.showToast('Broadcast ended', 'success');
            return true;
        } catch (error) {
            console.error('Error ending broadcast:', error);
            return false;
        }
    },
    
    // Test SOS contact
    async testSOSContact(phoneNumber, name) {
        try {
            // Find user by phone number
            const snapshot = await database.ref('users')
                .orderByChild('phone')
                .equalTo(phoneNumber)
                .once('value');
            
            const users = snapshot.val();
            if (users) {
                const userId = Object.keys(users)[0];
                await this.sendNotification(
                    userId,
                    'SOS Test Notification',
                    `${AppState.userData.name} is testing their SOS setup. This is a test notification.`,
                    'emergency'
                );
            }
            
            UIUpdater.showToast(`Test notification sent to ${name}`, 'success');
            return true;
        } catch (error) {
            console.error('Error testing SOS contact:', error);
            UIUpdater.showToast('Error sending test notification', 'error');
            return false;
        }
    },
    
    // Search emergency services
    async searchEmergencyServices(type, location) {
        try {
            const results = await SearchEngine.searchEmergencyServices(type, location);
            return results;
        } catch (error) {
            console.error('Error searching emergency services:', error);
            return [];
        }
    },
    
    // Save user location
    async saveUserLocation(location, name) {
        try {
            const locationId = await SearchEngine.saveLocation(
                AppState.currentUser.uid,
                location,
                name
            );
            return locationId;
        } catch (error) {
            console.error('Error saving user location:', error);
            return null;
        }
    }
};

// ============================================
// EMERGENCY SERVICE LOCATOR
// ============================================
const EmergencyLocator = {
    services: {
        police: [
            { name: 'Lusaka Central Police', lat: -15.4167, lng: 28.2833, address: 'Cairo Road, Lusaka' },
            { name: 'Kabulonga Police Station', lat: -15.4000, lng: 28.3000, address: 'Kabulonga, Lusaka' },
            { name: 'Woodlands Police Station', lat: -15.3900, lng: 28.3200, address: 'Woodlands, Lusaka' }
        ],
        fire: [
            { name: 'Lusaka Fire Brigade', lat: -15.4100, lng: 28.2900, address: 'Independence Avenue, Lusaka' },
            { name: 'Industrial Fire Station', lat: -15.4200, lng: 28.2700, address: 'Industrial Area, Lusaka' }
        ],
        medical: [
            { name: 'University Teaching Hospital', lat: -15.4050, lng: 28.2950, address: 'Nationalist Road, Lusaka' },
            { name: 'Levy Mwanawasa Hospital', lat: -15.3950, lng: 28.3050, address: 'Great East Road, Lusaka' },
            { name: 'Matero Hospital', lat: -15.4150, lng: 28.2750, address: 'Matero, Lusaka' }
        ]
    },
    
    findNearestService: function(type, userLocation) {
        const services = this.services[type];
        if (!services || !userLocation) return null;
        
        let nearest = null;
        let minDistance = Infinity;
        
        services.forEach(service => {
            const distance = PriceCalculator.calculateDistance(
                userLocation.lat, userLocation.lng,
                service.lat, service.lng
            );
            
            if (distance < minDistance) {
                minDistance = distance;
                nearest = { ...service, distance };
            }
        });
        
        return nearest;
    },
    
    showEmergencyMarkers: function(type) {
        // Clear existing markers
        emergencyMarkers.forEach(marker => map.removeLayer(marker));
        emergencyMarkers = [];
        
        const services = this.services[type];
        if (services) {
            services.forEach(service => {
                const marker = L.marker([service.lat, service.lng], {
                    icon: L.divIcon({
                        className: 'emergency-vehicle-marker',
                        html: `<i class="fas fa-${type === 'police' ? 'shield-alt' : type === 'fire' ? 'fire-extinguisher' : 'ambulance'}"></i>`,
                        iconSize: [36, 36]
                    })
                }).addTo(map).bindPopup(service.name);
                
                emergencyMarkers.push(marker);
            });
        }
    },
    
    getEmergencyServices: async function(type, location) {
        try {
            // Try online search first
            const onlineResults = await FirebaseManager.searchEmergencyServices(type, location);
            if (onlineResults.length > 0) {
                return onlineResults;
            }
            
            // Fallback to local data
            const localServices = this.services[type] || [];
            return localServices.map(service => ({
                ...service,
                distance: PriceCalculator.calculateDistance(
                    location.lat, location.lng,
                    service.lat, service.lng
                )
            })).sort((a, b) => a.distance - b.distance);
        } catch (error) {
            console.error('Error getting emergency services:', error);
            return [];
        }
    }
};

// ============================================
// INITIALIZATION AND EVENT HANDLERS
// ============================================
async function initializeApp() {
    try {
        UIUpdater.showLoading('Initializing app...');
        
        // Check authentication
        const urlParams = new URLSearchParams(window.location.search);
        const email = urlParams.get('email');
        const uid = urlParams.get('uid');
        
        if (email && uid) {
            AppState.currentUser = { uid, email };
            await FirebaseManager.loadUserData(uid);
        } else {
            // Listen for auth state changes
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    AppState.currentUser = user;
                    await FirebaseManager.loadUserData(user.uid);
                } else {
                    window.location.href = 'signup.html';
                }
            });
        }
        
        // Initialize map
        initializeMap();
        
        // Set up event listeners
        setupEventListeners();
        
        // Get current location
        getCurrentLocation();
        
        // Initialize service forms
        initializeServiceForms();
        
        UIUpdater.hideLoading();
        UIUpdater.showToast('Jubel Passenger App Ready', 'success');
        
    } catch (error) {
        console.error('Error initializing app:', error);
        UIUpdater.showToast('Error initializing app', 'error');
        UIUpdater.hideLoading();
    }
}

function initializeMap() {
    map = L.map('map').setView([-15.4167, 28.2833], 13);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: ' OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(map);
}

function initializeServiceForms() {
    // Add bicycle service tab if not exists
    const serviceTabs = document.getElementById('serviceTabs');
    if (serviceTabs && !document.querySelector('.service-tab[data-service="bicycle"]')) {
        const bicycleTab = document.createElement('div');
        bicycleTab.className = 'service-tab';
        bicycleTab.dataset.service = 'bicycle';
        bicycleTab.innerHTML = `
            <div class="service-icon">
                <i class="fas fa-bicycle"></i>
            </div>
            <div class="service-name">Bicycle</div>
            <div class="service-desc">Eco-friendly rides</div>
        `;
        
        // Insert after short delivery tab
        const shortDeliveryTab = serviceTabs.querySelector('.service-tab[data-service="short-delivery"]');
        if (shortDeliveryTab) {
            shortDeliveryTab.parentNode.insertBefore(bicycleTab, shortDeliveryTab.nextSibling);
        }
        
        // Add event listener
        bicycleTab.addEventListener('click', () => {
            UIUpdater.switchService('bicycle');
        });
    }
    
    // Create bicycle form if not exists
    if (!document.getElementById('bicycleForm')) {
        const bicycleForm = document.createElement('div');
        bicycleForm.className = 'service-form';
        bicycleForm.id = 'bicycleForm';
        bicycleForm.innerHTML = `
            <div class="form-title">
                <i class="fas fa-bicycle"></i>
                Book a Bicycle Ride
            </div>
            
            <div class="location-inputs">
                <div class="location-input" id="bicyclePickupInput">
                    <i class="fas fa-map-marker-alt"></i>
                    <input type="text" id="bicyclePickupLocation" placeholder="Current location" readonly>
                    <div class="search-loading"></div>
                    <div class="suggestion-list" id="bicyclePickupSuggestions"></div>
                </div>
                
                <div class="location-input" id="bicycleDestinationInput">
                    <i class="fas fa-flag"></i>
                    <input type="text" id="bicycleDestinationLocation" placeholder="Where to?">
                    <div class="search-loading"></div>
                    <div class="suggestion-list" id="bicycleDestinationSuggestions"></div>
                </div>
            </div>
            
            <div class="ride-type-selection" id="bicycleTypeSelection">
                <div class="ride-type-title">
                    <span>Select Bicycle Type</span>
                </div>
                
                <div class="ride-type-grid">
                    <div class="ride-type-card economy" data-type="standard">
                        <div class="ride-type-icon">
                            <i class="fas fa-bicycle"></i>
                        </div>
                        <div class="ride-type-name">Standard</div>
                        <div class="ride-type-price" id="standardBicyclePrice">ZMW 0.00</div>
                        <div class="ride-type-eta">ETA: 15-25 min</div>
                    </div>
                    
                    <div class="ride-type-card selected" data-type="fast">
                        <div class="ride-type-icon">
                            <i class="fas fa-bolt"></i>
                        </div>
                        <div class="ride-type-name">Fast</div>
                        <div class="ride-type-price" id="fastBicyclePrice">ZMW 0.00</div>
                        <div class="ride-type-eta">ETA: 10-20 min</div>
                    </div>
                </div>
            </div>
            
            <div class="fare-display" id="bicycleFareDisplay">
                <div class="fare-label">Estimated Fare</div>
                <div class="fare-amount" id="bicycleFare">ZMW 0.00</div>
                <div class="fare-details">
                    <span id="bicycleDistanceDetail">0 km</span>
                    <span id="bicycleTimeDetail">ETA: 0 min</span>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-primary" id="requestBicycleBtn">
                    <i class="fas fa-search"></i>
                    Request Bicycle
                </button>
            </div>
        `;
        
        // Add to home content
        const homeContent = document.getElementById('homeContent');
        if (homeContent) {
            homeContent.appendChild(bicycleForm);
        }
    }
}

async function getCurrentLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            async (position) => {
                const { latitude, longitude } = position.coords;
                AppState.userLocation = { lat: latitude, lng: longitude };
                
                // Center map
                map.setView([latitude, longitude], 15);
                
                // Add marker
                currentLocationMarker = L.marker([latitude, longitude], {
                    icon: L.divIcon({
                        className: 'current-location-marker',
                        html: '<i class="fas fa-user"></i>',
                        iconSize: [18, 18]
                    })
                }).addTo(map).bindPopup('Your Location');
                
                // Get address
                const address = await SearchEngine.reverseGeocode(latitude, longitude);
                updatePickupLocations(address);
                AppState.pickup = {
                    lat: latitude,
                    lng: longitude,
                    address: address.address,
                    name: 'Current Location'
                };
                
                // Detect city
                await detectCity(latitude, longitude);
                
            },
            (error) => {
                console.error('Geolocation error:', error);
                UIUpdater.showToast('Using default location', 'warning');
                AppState.userLocation = { lat: -15.4167, lng: 28.2833 };
                AppState.currentCity = 'Lusaka';
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            }
        );
    } else {
        UIUpdater.showToast('Geolocation not supported', 'warning');
        AppState.userLocation = { lat: -15.4167, lng: 28.2833 };
        AppState.currentCity = 'Lusaka';
    }
}

function updatePickupLocations(address) {
    const pickupInputs = [
        'pickupLocation',
        'destinationLocation',
        'deliveryPickup',
        'deliveryDestination',
        'shortDeliveryPickup',
        'shortDeliveryDestination',
        'bicyclePickupLocation',
        'bicycleDestinationLocation',
        'truckPickup',
        'truckDestination',
        'schedulePickup',
        'someonePickup',
        'sharePickup'
    ];
    
    pickupInputs.forEach(id => {
        const input = document.getElementById(id);
        if (input && input.placeholder?.includes('Current location')) {
            input.value = address.address || address;
        }
    });
    
    // Update emergency pickup
    const emergencyPickup = document.getElementById('emergencyPickupAddress');
    if (emergencyPickup) {
        emergencyPickup.textContent = address.address || address;
    }
}

async function detectCity(lat, lng) {
    try {
        const address = await SearchEngine.reverseGeocode(lat, lng);
        const addressString = address.fullAddress || '';
        
        // Extract city from address
        const cityMatch = addressString.match(/(Lusaka|Ndola|Kitwe|Kabwe|Livingstone|Chipata|Solwezi)/i);
        if (cityMatch) {
            AppState.currentCity = cityMatch[0];
        } else {
            AppState.currentCity = 'Lusaka';
        }
        
        // Get city bounds for search restriction
        const bounds = await SearchEngine.getCityBounds(AppState.currentCity);
        if (bounds) {
            AppState.currentCityBounds = bounds.viewbox;
        }
        
        UIUpdater.showToast(`Location set to ${AppState.currentCity}`, 'info');
    } catch (error) {
        console.error('City detection error:', error);
        AppState.currentCity = 'Lusaka';
    }
}

function setupEventListeners() {
    // Navigation tabs
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const screen = tab.dataset.screen;
            UIUpdater.switchScreen(screen);
        });
    });
    
    // Back buttons
    document.querySelectorAll('.back-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            UIUpdater.switchScreen('home');
        });
    });
    
    // Panel handle
    document.getElementById('panelHandle')?.addEventListener('click', () => {
        const panel = document.getElementById('mainPanel');
        panel.classList.toggle('collapsed');
    });
    
    // Service tabs
    document.querySelectorAll('.service-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const service = tab.dataset.service;
            UIUpdater.switchService(service);
        });
    });
    
    // More options
    document.getElementById('moreOptionsBtn')?.addEventListener('click', (e) => {
        e.stopPropagation();
        UIUpdater.showMoreOptions();
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', () => {
        document.getElementById('moreOptionsDropdown')?.classList.remove('active');
    });
    
    // More options dropdown items
    document.querySelectorAll('.dropdown-option').forEach(option => {
        option.addEventListener('click', () => {
            const optionType = option.dataset.option;
            UIUpdater.handleMoreOption(optionType);
        });
    });
    
    // Ride type selection for car
    document.querySelectorAll('.ride-type-card[data-type]').forEach(card => {
        card.addEventListener('click', () => {
            document.querySelectorAll('.ride-type-card').forEach(c => {
                c.classList.remove('selected');
            });
            card.classList.add('selected');
            AppState.selectedRideType = card.dataset.type;
            UIUpdater.updateCarPrices();
        });
    });
    
    // Bicycle type selection
    document.querySelectorAll('.bicycle-type-card').forEach(card => {
        card.addEventListener('click', () => {
            document.querySelectorAll('.bicycle-type-card').forEach(c => {
                c.classList.remove('selected');
            });
            card.classList.add('selected');
            UIUpdater.updateBicyclePrices();
        });
    });
    
    // Fast search listeners
    setupSearchListeners();
    
    // Request ride buttons
    document.getElementById('requestRideBtn')?.addEventListener('click', requestCarRide);
    document.getElementById('requestBicycleBtn')?.addEventListener('click', requestBicycleRide);
    document.getElementById('requestDeliveryBtn')?.addEventListener('click', requestDelivery);
    document.getElementById('requestShortDeliveryBtn')?.addEventListener('click', requestShortDelivery);
    document.getElementById('requestExpressBtn')?.addEventListener('click', requestExpressShopping);
    document.getElementById('requestTruckBtn')?.addEventListener('click', requestTruck);
    
    // Schedule ride
    document.getElementById('scheduleRideBtn')?.addEventListener('click', scheduleRide);
    
    // Order for someone
    document.getElementById('orderForSomeoneBtn')?.addEventListener('click', orderForSomeone);
    
    // Share ride
    document.getElementById('shareRideBtn')?.addEventListener('click', shareRide);
    
    // Add stop
    document.getElementById('addStopBtn')?.addEventListener('click', () => {
        UIUpdater.addStop();
    });
    
    // SOS button
    document.getElementById('sosButton')?.addEventListener('click', triggerSOS);
    
    // Notification bell
    document.getElementById('notificationBell')?.addEventListener('click', () => {
        const panel = document.getElementById('notificationPanel');
        panel.classList.toggle('active');
    });
    
    // Mark all notifications as read
    document.getElementById('markAllRead')?.addEventListener('click', () => {
        FirebaseManager.markAllNotificationsAsRead();
    });
    
    // Broadcast ride
    document.getElementById('broadcastRideBtn')?.addEventListener('click', () => {
        document.getElementById('broadcastModal').classList.add('active');
    });
    
    document.getElementById('broadcastRideOptionBtn')?.addEventListener('click', () => {
        document.getElementById('broadcastModal').classList.add('active');
    });
    
    document.getElementById('broadcastRideBtnPanel')?.addEventListener('click', () => {
        document.getElementById('broadcastModal').classList.add('active');
    });
    
    // Broadcast modal
    document.getElementById('closeBroadcastModal')?.addEventListener('click', () => {
        document.getElementById('broadcastModal').classList.remove('active');
    });
    
    document.getElementById('cancelBroadcastBtn')?.addEventListener('click', () => {
        document.getElementById('broadcastModal').classList.remove('active');
    });
    
    document.getElementById('addPhoneBtn')?.addEventListener('click', async () => {
        const input = document.getElementById('broadcastPhoneInput');
        const phone = input.value.trim();
        
        if (!phone) {
            UIUpdater.showToast('Please enter a phone number', 'warning');
            return;
        }
        
        // Validate phone number
        if (!isValidPhone(phone)) {
            UIUpdater.showToast('Please enter a valid Zambian phone number', 'error');
            return;
        }
        
        // Look up user information
        const phoneInfo = await UIUpdater.lookupPhoneNumber(phone);
        
        // Check if already added
        if (AppState.broadcastPhones.some(p => p.number === phone)) {
            UIUpdater.showToast('Phone number already added', 'warning');
            return;
        }
        
        // Add to list
        AppState.broadcastPhones.push(phoneInfo);
        UIUpdater.updateBroadcastPhoneList();
        input.value = '';
        
        UIUpdater.showToast(`Added ${phoneInfo.name || phoneInfo.number}`, 'success');
    });
    
    // Remove phone from broadcast list
    document.addEventListener('click', (e) => {
        if (e.target.closest('.broadcast-remove-phone')) {
            const index = parseInt(e.target.closest('.broadcast-remove-phone').dataset.index);
            AppState.broadcastPhones.splice(index, 1);
            UIUpdater.updateBroadcastPhoneList();
        }
    });
    
    // Start broadcast
    document.getElementById('startBroadcastBtn')?.addEventListener('click', async () => {
        if (AppState.broadcastPhones.length === 0) {
            UIUpdater.showToast('Please add at least one phone number', 'warning');
            return;
        }
        
        const message = document.getElementById('broadcastMessage').value.trim();
        
        try {
            await FirebaseManager.startBroadcast(AppState.broadcastPhones, message);
            document.getElementById('broadcastModal').classList.remove('active');
            
            // Show broadcast tracking
            document.getElementById('broadcastTracking').classList.add('active');
        } catch (error) {
            console.error('Error starting broadcast:', error);
        }
    });
    
    // Emergency services
    document.querySelectorAll('.emergency-service').forEach(service => {
        service.addEventListener('click', () => {
            const type = service.dataset.type;
            handleEmergencyService(type);
        });
    });
    
    // Emergency reasons
    document.querySelectorAll('.emergency-reason').forEach(reason => {
        reason.addEventListener('click', () => {
            document.querySelectorAll('.emergency-reason').forEach(r => {
                r.classList.remove('selected');
            });
            reason.classList.add('selected');
            
            const reasonType = reason.dataset.reason;
            document.getElementById('emergencyOtherInput').classList.toggle('active', reasonType === 'other');
        });
    });
    
    // Confirm emergency ride
    document.getElementById('confirmEmergencyBtn')?.addEventListener('click', requestEmergencyRide);
    
    // SOS test buttons
    document.getElementById('testPrimaryContact')?.addEventListener('click', async () => {
        const name = document.getElementById('sosContact1Name').value;
        const phone = document.getElementById('sosContact1Phone').value;
        
        if (!name || !phone) {
            UIUpdater.showToast('Please fill in primary contact details', 'warning');
            return;
        }
        
        await FirebaseManager.testSOSContact(phone, name);
    });
    
    document.getElementById('testSecondaryContact')?.addEventListener('click', async () => {
        const name = document.getElementById('sosContact2Name').value;
        const phone = document.getElementById('sosContact2Phone').value;
        
        if (!name || !phone) {
            UIUpdater.showToast('Please fill in secondary contact details', 'warning');
            return;
        }
        
        await FirebaseManager.testSOSContact(phone, name);
    });
    
    // Save SOS config
    document.getElementById('saveSOSBtn')?.addEventListener('click', saveSOSConfig);
    
    // Account actions
    document.getElementById('logoutBtn')?.addEventListener('click', logout);
    document.getElementById('depositBtn')?.addEventListener('click', () => showModal('payment'));
    document.getElementById('withdrawBtn')?.addEventListener('click', () => showModal('payment'));
    document.getElementById('transferBtn')?.addEventListener('click', () => showModal('transfer'));
    document.getElementById('transactionsBtn')?.addEventListener('click', () => showModal('transactions'));
    document.getElementById('shareReferralBtn')?.addEventListener('click', shareReferralCode);
    
    // Modal close buttons
    document.querySelectorAll('.modal-close, .broadcast-close').forEach(btn => {
        btn.addEventListener('click', () => {
            const modalId = btn.dataset.modal || 'broadcast';
            hideModal(modalId);
        });
    });
    
    // Close modals when clicking outside
    document.querySelectorAll('.modal-overlay, .broadcast-modal').forEach(overlay => {
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
                overlay.classList.remove('active');
            }
        });
    });
    
    // Real-time price updates
    setupRealTimePriceUpdates();
}

function setupSearchListeners() {
    // Fast search for all location inputs
    document.querySelectorAll('input[type="text"]').forEach(input => {
        if (input.id.includes('Location') || input.id.includes('Pickup') || 
            input.id.includes('Destination') || input.classList.contains('stop-location')) {
            
            let searchTimeout;
            let lastQuery = '';
            
            input.addEventListener('input', async function(e) {
                clearTimeout(searchTimeout);
                
                const query = e.target.value.trim();
                if (query === lastQuery) return;
                
                lastQuery = query;
                
                if (query.length < 2) {
                    const suggestions = document.getElementById(`${this.id}Suggestions`) ||
                                      document.querySelector(`.stop-suggestions[data-index="${this.dataset.index}"]`);
                    if (suggestions) suggestions.classList.remove('active');
                    return;
                }
                
                // Show loading
                const parent = this.closest('.location-input');
                if (parent) parent.classList.add('searching');
                
                searchTimeout = setTimeout(async () => {
                    try {
                        const type = this.id.includes('pickup') || this.id.includes('Pickup') ? 'pickup' : 'destination';
                        const bounds = AppState.currentCityBounds;
                        const results = await SearchEngine.search(query, type, AppState.userLocation, bounds);
                        
                        if (this.classList.contains('stop-location')) {
                            UIUpdater.showStopSuggestions(parseInt(this.dataset.index), results);
                        } else {
                            UIUpdater.showSearchSuggestions(this.id, results);
                        }
                    } catch (error) {
                        console.error('Search error:', error);
                    }
                }, 50); // Ultra-fast 50ms
            });
            
            // Keyboard navigation
            input.addEventListener('keydown', function(e) {
                let suggestions;
                
                if (this.classList.contains('stop-location')) {
                    suggestions = document.querySelector(`.stop-suggestions[data-index="${this.dataset.index}"]`);
                } else {
                    suggestions = document.getElementById(`${this.id}Suggestions`);
                }
                
                if (!suggestions || !suggestions.classList.contains('active')) return;
                
                const items = suggestions.querySelectorAll('.suggestion-item');
                if (items.length === 0) return;
                
                const selected = suggestions.querySelector('.suggestion-item.selected');
                let currentIndex = selected ? Array.from(items).indexOf(selected) : -1;
                
                switch(e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        currentIndex = (currentIndex + 1) % items.length;
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        currentIndex = currentIndex <= 0 ? items.length - 1 : currentIndex - 1;
                        break;
                    case 'Enter':
                        e.preventDefault();
                        if (selected) {
                            selected.click();
                        }
                        return;
                    case 'Escape':
                        suggestions.classList.remove('active');
                        return;
                }
                
                items.forEach(item => item.classList.remove('selected'));
                if (currentIndex >= 0) {
                    items[currentIndex].classList.add('selected');
                    items[currentIndex].scrollIntoView({ block: 'nearest' });
                }
            });
        }
    });
    
    // Click outside to close suggestions
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.location-input') && !e.target.closest('.suggestion-list')) {
            document.querySelectorAll('.suggestion-list').forEach(list => {
                list.classList.remove('active');
            });
        }
    });
}

function setupRealTimePriceUpdates() {
    // Update prices when inputs change
    document.querySelectorAll('input, select').forEach(element => {
        if (element.id.includes('Type') || element.id.includes('Value') || 
            element.id.includes('Weight') || element.id.includes('Budget') ||
            element.id.includes('Time') || element.id.includes('Urgency')) {
            
            element.addEventListener('change', () => {
                UIUpdater.calculateAndUpdatePrices();
            });
            
            element.addEventListener('input', () => {
                UIUpdater.calculateAndUpdatePrices();
            });
        }
    });
    
    // Share ride split slider
    const splitSlider = document.getElementById('splitPercentage');
    if (splitSlider) {
        splitSlider.addEventListener('input', () => {
            UIUpdater.updateShareCalculations();
        });
    }
}

// ============================================
// RIDE REQUEST HANDLERS
// ============================================
async function requestCarRide() {
    if (!AppState.pickup || !AppState.destination) {
        UIUpdater.showToast('Please select pickup and destination locations', 'warning');
        return;
    }
    
    const distance = PriceCalculator.calculateDistance(
        AppState.pickup.lat, AppState.pickup.lng,
        AppState.destination.lat, AppState.destination.lng
    );
    
    if (distance < 0.5) {
        UIUpdater.showToast('Minimum ride distance is 0.5 km', 'warning');
        return;
    }
    
    const rideData = {
        passengerId: AppState.currentUser.uid,
        passengerName: AppState.userData.name,
        passengerPhone: AppState.userData.phone,
        pickup: AppState.pickup.address,
        pickupDisplay: AppState.pickup.name || AppState.pickup.address,
        pickupLat: AppState.pickup.lat,
        pickupLng: AppState.pickup.lng,
        destination: AppState.destination.address,
        destinationDisplay: AppState.destination.name || AppState.destination.address,
        destLat: AppState.destination.lat,
        destLng: AppState.destination.lng,
        rideType: AppState.selectedRideType,
        fare: AppState.rideFare,
        distance: distance,
        serviceType: 'car',
        paymentMethod: 'wallet',
        stops: AppState.stops.map((stop, index) => ({
            index: index + 1,
            address: stop.address,
            lat: stop.lat,
            lng: stop.lng
        }))
    };
    
    // Check wallet balance
    if (AppState.walletBalance < AppState.rideFare) {
        showModal('payment');
        return;
    }
    
    try {
        await FirebaseManager.requestRide(rideData);
    } catch (error) {
        console.error('Error requesting ride:', error);
    }
}

async function requestBicycleRide() {
    if (!AppState.pickup || !AppState.destination) {
        UIUpdater.showToast('Please select pickup and destination locations', 'warning');
        return;
    }
    
    const distance = PriceCalculator.calculateDistance(
        AppState.pickup.lat, AppState.pickup.lng,
        AppState.destination.lat, AppState.destination.lng
    );
    
    if (distance < 0.3) {
        UIUpdater.showToast('Minimum bicycle ride distance is 0.3 km', 'warning');
        return;
    }
    
    if (distance > 10) {
        UIUpdater.showToast('Maximum bicycle ride distance is 10 km', 'warning');
        return;
    }
    
    const bicycleType = document.querySelector('.bicycle-type-card.selected')?.dataset.type || 'standard';
    
    const rideData = {
        passengerId: AppState.currentUser.uid,
        passengerName: AppState.userData.name,
        passengerPhone: AppState.userData.phone,
        pickup: AppState.pickup.address,
        pickupDisplay: AppState.pickup.name || AppState.pickup.address,
        pickupLat: AppState.pickup.lat,
        pickupLng: AppState.pickup.lng,
        destination: AppState.destination.address,
        destinationDisplay: AppState.destination.name || AppState.destination.address,
        destLat: AppState.destination.lat,
        destLng: AppState.destination.lng,
        bicycleType: bicycleType,
        fare: AppState.rideFare,
        distance: distance,
        serviceType: 'bicycle',
        paymentMethod: 'wallet'
    };
    
    // Check wallet balance
    if (AppState.walletBalance < AppState.rideFare) {
        showModal('payment');
        return;
    }
    
    try {
        await FirebaseManager.requestRide(rideData);
    } catch (error) {
        console.error('Error requesting bicycle ride:', error);
    }
}

async function requestDelivery() {
    if (!AppState.pickup || !AppState.destination) {
        UIUpdater.showToast('Please select pickup and destination locations', 'warning');
        return;
    }
    
    const distance = PriceCalculator.calculateDistance(
        AppState.pickup.lat, AppState.pickup.lng,
        AppState.destination.lat, AppState.destination.lng
    );
    
    const deliveryType = document.getElementById('deliveryType')?.value || 'standard';
    const parcelValue = parseFloat(document.getElementById('parcelValue')?.value) || 0;
    const parcelWeight = parseFloat(document.getElementById('parcelWeight')?.value) || 0;
    const instructions = document.getElementById('deliveryInstructions')?.value || '';
    
    const rideData = {
        passengerId: AppState.currentUser.uid,
        passengerName: AppState.userData.name,
        passengerPhone: AppState.userData.phone,
        pickup: AppState.pickup.address,
        pickupDisplay: AppState.pickup.name || AppState.pickup.address,
        pickupLat: AppState.pickup.lat,
        pickupLng: AppState.pickup.lng,
        destination: AppState.destination.address,
        destinationDisplay: AppState.destination.name || AppState.destination.address,
        destLat: AppState.destination.lat,
        destLng: AppState.destination.lng,
        deliveryType: deliveryType,
        parcelValue: parcelValue,
        parcelWeight: parcelWeight,
        instructions: instructions,
        fare: AppState.rideFare,
        distance: distance,
        serviceType: 'delivery',
        paymentMethod: 'wallet'
    };
    
    // Check wallet balance
    if (AppState.walletBalance < AppState.rideFare) {
        showModal('payment');
        return;
    }
    
    try {
        await FirebaseManager.requestRide(rideData);
    } catch (error) {
        console.error('Error requesting delivery:', error);
    }
}

async function requestShortDelivery() {
    if (!AppState.pickup || !AppState.destination) {
        UIUpdater.showToast('Please select pickup and destination locations', 'warning');
        return;
    }
    
    const distance = PriceCalculator.calculateDistance(
        AppState.pickup.lat, AppState.pickup.lng,
        AppState.destination.lat, AppState.destination.lng
    );
    
    if (distance > 5) {
        UIUpdater.showToast('Maximum short delivery distance is 5 km', 'warning');
        return;
    }
    
    const urgency = document.getElementById('deliveryUrgency')?.value || 'standard';
    const weight = parseFloat(document.getElementById('shortDeliveryWeight')?.value) || 0;
    const instructions = document.getElementById('shortDeliveryInstructions')?.value || '';
    
    const rideData = {
        passengerId: AppState.currentUser.uid,
        passengerName: AppState.userData.name,
        passengerPhone: AppState.userData.phone,
        pickup: AppState.pickup.address,
        pickupDisplay: AppState.pickup.name || AppState.pickup.address,
        pickupLat: AppState.pickup.lat,
        pickupLng: AppState.pickup.lng,
        destination: AppState.destination.address,
        destinationDisplay: AppState.destination.name || AppState.destination.address,
        destLat: AppState.destination.lat,
        destLng: AppState.destination.lng,
        urgency: urgency,
        parcelWeight: weight,
        instructions: instructions,
        fare: AppState.rideFare,
        distance: distance,
        serviceType: 'short-delivery',
        paymentMethod: 'wallet'
    };
    
    // Check wallet balance
    if (AppState.walletBalance < AppState.rideFare) {
        showModal('payment');
        return;
    }
    
    try {
        await FirebaseManager.requestRide(rideData);
    } catch (error) {
        console.error('Error requesting short delivery:', error);
    }
}

async function requestExpressShopping() {
    if (!AppState.pickup || !AppState.destination) {
        UIUpdater.showToast('Please select pickup and destination locations', 'warning');
        return;
    }
    
    const distance = PriceCalculator.calculateDistance(
        AppState.pickup.lat, AppState.pickup.lng,
        AppState.destination.lat, AppState.destination.lng
    );
    
    const items = Array.from(document.querySelectorAll('.item-input'))
        .map(input => input.value.trim())
        .filter(value => value.length > 0);
    
    if (items.length === 0) {
        UIUpdater.showToast('Please add at least one shopping item', 'warning');
        return;
    }
    
    const budget = parseFloat(document.getElementById('shoppingBudget')?.value) || 0;
    const shopName = document.getElementById('shopName')?.value || '';
    const shoppingTime = parseInt(document.getElementById('shoppingTime')?.value) || 30;
    const instructions = document.getElementById('shoppingInstructions')?.value || '';
    
    const rideData = {
        passengerId: AppState.currentUser.uid,
        passengerName: AppState.userData.name,
        passengerPhone: AppState.userData.phone,
        pickup: AppState.pickup.address,
        pickupDisplay: AppState.pickup.name || AppState.pickup.address,
        pickupLat: AppState.pickup.lat,
        pickupLng: AppState.pickup.lng,
        destination: AppState.destination.address,
        destinationDisplay: AppState.destination.name || AppState.destination.address,
        destLat: AppState.destination.lat,
        destLng: AppState.destination.lng,
        shopName: shopName,
        items: items,
        budget: budget,
        shoppingTime: shoppingTime,
        instructions: instructions,
        fare: AppState.rideFare,
        distance: distance,
        serviceType: 'express',
        paymentMethod: 'wallet'
    };
    
    // Check wallet balance
    if (AppState.walletBalance < AppState.rideFare) {
        showModal('payment');
        return;
    }
    
    try {
        await FirebaseManager.requestRide(rideData);
    } catch (error) {
        console.error('Error requesting express shopping:', error);
    }
}

async function requestTruck() {
    if (!AppState.pickup || !AppState.destination) {
        UIUpdater.showToast('Please select pickup and destination locations', 'warning');
        return;
    }
    
    const distance = PriceCalculator.calculateDistance(
        AppState.pickup.lat, AppState.pickup.lng,
        AppState.destination.lat, AppState.destination.lng
    );
    
    const truckType = document.getElementById('truckType')?.value || 'light';
    const needHelpers = document.getElementById('needHelpers')?.checked || false;
    const instructions = document.getElementById('truckInstructions')?.value || '';
    
    const rideData = {
        passengerId: AppState.currentUser.uid,
        passengerName: AppState.userData.name,
        passengerPhone: AppState.userData.phone,
        pickup: AppState.pickup.address,
        pickupDisplay: AppState.pickup.name || AppState.pickup.address,
        pickupLat: AppState.pickup.lat,
        pickupLng: AppState.pickup.lng,
        destination: AppState.destination.address,
        destinationDisplay: AppState.destination.name || AppState.destination.address,
        destLat: AppState.destination.lat,
        destLng: AppState.destination.lng,
        truckType: truckType,
        helpers: needHelpers,
        instructions: instructions,
        fare: AppState.rideFare,
        distance: distance,
        serviceType: 'truck',
        paymentMethod: 'wallet',
        stops: AppState.stops.map((stop, index) => ({
            index: index + 1,
            address: stop.address,
            lat: stop.lat,
            lng: stop.lng
        }))
    };
    
    // Check wallet balance
    if (AppState.walletBalance < AppState.rideFare) {
        showModal('payment');
        return;
    }
    
    try {
        await FirebaseManager.requestRide(rideData);
    } catch (error) {
        console.error('Error requesting truck:', error);
    }
}

async function scheduleRide() {
    if (!AppState.pickup || !AppState.destination) {
        UIUpdater.showToast('Please select pickup and destination locations', 'warning');
        return;
    }
    
    const distance = PriceCalculator.calculateDistance(
        AppState.pickup.lat, AppState.pickup.lng,
        AppState.destination.lat, AppState.destination.lng
    );
    
    const date = document.getElementById('scheduleDate')?.value;
    const time = document.getElementById('scheduleTime')?.value;
    const instructions = document.getElementById('scheduleInstructions')?.value || '';
    
    if (!date || !time) {
        UIUpdater.showToast('Please select date and time', 'warning');
        return;
    }
    
    const scheduledTime = new Date(`${date}T${time}`);
    const now = new Date();
    
    if (scheduledTime <= now) {
        UIUpdater.showToast('Please select a future date and time', 'warning');
        return;
    }
    
    const rideData = {
        passengerId: AppState.currentUser.uid,
        passengerName: AppState.userData.name,
        passengerPhone: AppState.userData.phone,
        pickup: AppState.pickup.address,
        pickupDisplay: AppState.pickup.name || AppState.pickup.address,
        pickupLat: AppState.pickup.lat,
        pickupLng: AppState.pickup.lng,
        destination: AppState.destination.address,
        destinationDisplay: AppState.destination.name || AppState.destination.address,
        destLat: AppState.destination.lat,
        destLng: AppState.destination.lng,
        rideType: AppState.selectedRideType,
        fare: AppState.rideFare,
        distance: distance,
        serviceType: 'car',
        paymentMethod: 'wallet',
        scheduled: true,
        scheduledTime: scheduledTime.getTime(),
        instructions: instructions
    };
    
    try {
        const rideId = database.ref().child('scheduledRides').push().key;
        await database.ref(`scheduledRides/${rideId}`).set(rideData);
        
        UIUpdater.showToast('Ride scheduled successfully', 'success');
        UIUpdater.switchScreen('home');
    } catch (error) {
        console.error('Error scheduling ride:', error);
        UIUpdater.showToast('Error scheduling ride', 'error');
    }
}

async function orderForSomeone() {
    if (!AppState.pickup || !AppState.destination) {
        UIUpdater.showToast('Please select pickup and destination locations', 'warning');
        return;
    }
    
    const distance = PriceCalculator.calculateDistance(
        AppState.pickup.lat, AppState.pickup.lng,
        AppState.destination.lat, AppState.destination.lng
    );
    
    const recipientName = document.getElementById('recipientName')?.value;
    const recipientPhone = document.getElementById('recipientPhone')?.value;
    const instructions = document.getElementById('someoneInstructions')?.value || '';
    
    if (!recipientName || !recipientPhone) {
        UIUpdater.showToast('Please enter recipient name and phone number', 'warning');
        return;
    }
    
    if (!isValidPhone(recipientPhone)) {
        UIUpdater.showToast('Please enter a valid phone number', 'error');
        return;
    }
    
    const rideData = {
        passengerId: AppState.currentUser.uid,
        passengerName: AppState.userData.name,
        passengerPhone: AppState.userData.phone,
        recipientName: recipientName,
        recipientPhone: recipientPhone,
        pickup: AppState.pickup.address,
        pickupDisplay: AppState.pickup.name || AppState.pickup.address,
        pickupLat: AppState.pickup.lat,
        pickupLng: AppState.pickup.lng,
        destination: AppState.destination.address,
        destinationDisplay: AppState.destination.name || AppState.destination.address,
        destLat: AppState.destination.lat,
        destLng: AppState.destination.lng,
        rideType: AppState.selectedRideType,
        fare: AppState.rideFare,
        distance: distance,
        serviceType: 'car',
        paymentMethod: 'wallet',
        orderForSomeone: true,
        instructions: instructions
    };
    
    // Check wallet balance
    if (AppState.walletBalance < AppState.rideFare) {
        showModal('payment');
        return;
    }
    
    try {
        await FirebaseManager.requestRide(rideData);
    } catch (error) {
        console.error('Error ordering for someone:', error);
    }
}

async function shareRide() {
    if (!AppState.pickup || !AppState.destination) {
        UIUpdater.showToast('Please select pickup and destination locations', 'warning');
        return;
    }
    
    const distance = PriceCalculator.calculateDistance(
        AppState.pickup.lat, AppState.pickup.lng,
        AppState.destination.lat, AppState.destination.lng
    );
    
    const splitPercentage = parseInt(document.getElementById('splitPercentage')?.value) || 50;
    const friendPhone = document.getElementById('friendPhone')?.value;
    const instructions = document.getElementById('shareInstructions')?.value || '';
    
    if (!friendPhone) {
        UIUpdater.showToast('Please enter friend\'s phone number', 'warning');
        return;
    }
    
    if (!isValidPhone(friendPhone)) {
        UIUpdater.showToast('Please enter a valid phone number', 'error');
        return;
    }
    
    const surge = PriceCalculator.getSurgeMultiplier();
    const totalFare = PriceCalculator.calculateRideFare(distance, AppState.selectedRideType, surge);
    const yourShare = (totalFare * splitPercentage) / 100;
    
    const rideData = {
        passengerId: AppState.currentUser.uid,
        passengerName: AppState.userData.name,
        passengerPhone: AppState.userData.phone,
        friendPhone: friendPhone,
        splitPercentage: splitPercentage,
        pickup: AppState.pickup.address,
        pickupDisplay: AppState.pickup.name || AppState.pickup.address,
        pickupLat: AppState.pickup.lat,
        pickupLng: AppState.pickup.lng,
        destination: AppState.destination.address,
        destinationDisplay: AppState.destination.name || AppState.destination.address,
        destLat: AppState.destination.lat,
        destLng: AppState.destination.lng,
        rideType: AppState.selectedRideType,
        fare: yourShare,
        totalFare: totalFare,
        distance: distance,
        serviceType: 'car',
        paymentMethod: 'wallet',
        shareRide: true,
        instructions: instructions
    };
    
    // Check wallet balance
    if (AppState.walletBalance < yourShare) {
        showModal('payment');
        return;
    }
    
    try {
        await FirebaseManager.requestRide(rideData);
        
        // Notify friend
        const friendInfo = await UIUpdater.lookupPhoneNumber(friendPhone);
        if (friendInfo.userId) {
            await FirebaseManager.sendNotification(
                friendInfo.userId,
                'Ride Share Invitation',
                `${AppState.userData.name} has invited you to share a ride. Your share: ZMW ${(totalFare - yourShare).toFixed(2)}`,
                'ride',
                { rideId: AppState.currentRide?.id }
            );
        }
    } catch (error) {
        console.error('Error sharing ride:', error);
    }
}

async function handleEmergencyService(type) {
    if (!AppState.userLocation) {
        UIUpdater.showToast('Please allow location access for emergency services', 'warning');
        return;
    }
    
    // Update modal title
    document.getElementById('emergencyServiceType').textContent = 
        AppState.emergencyServices[type].name;
    document.getElementById('emergencyServiceType').dataset.type = type;
    
    // Show emergency markers
    EmergencyLocator.showEmergencyMarkers(type);
    
    // Load emergency stations
    UIUpdater.showLoading('Finding emergency stations...');
    const stations = await EmergencyLocator.getEmergencyServices(type, AppState.userLocation);
    UIUpdater.hideLoading();
    
    UIUpdater.showEmergencyStations(stations, type);
    
    // Calculate fare for nearest station
    if (stations.length > 0) {
        const nearest = stations[0];
        const fare = PriceCalculator.calculateEmergencyFare(nearest.distance, type);
        
        document.getElementById('emergencyBaseFare').textContent = 
            `ZMW ${AppState.emergencyServices[type].base.toFixed(2)}`;
        document.getElementById('emergencyDistance').textContent = 
            `${nearest.distance.toFixed(1)} km`;
        document.getElementById('emergencyTime').textContent = 
            `${PriceCalculator.estimateTime(nearest.distance, 'standard')} min`;
        document.getElementById('emergencyTotalFare').textContent = `ZMW ${fare.toFixed(2)}`;
        
        AppState.selectedEmergencyStation = nearest;
    }
    
    // Show modal
    showModal('emergency');
}

async function requestEmergencyRide() {
    const selectedReason = document.querySelector('.emergency-reason.selected');
    if (!selectedReason) {
        UIUpdater.showToast('Please select an emergency reason', 'warning');
        return;
    }
    
    const reason = selectedReason.dataset.reason;
    let description = '';
    
    if (reason === 'other') {
        description = document.getElementById('emergencyOtherDescription').value.trim();
        if (!description) {
            UIUpdater.showToast('Please describe the emergency', 'warning');
            return;
        }
    }
    
    if (!AppState.selectedEmergencyStation) {
        UIUpdater.showToast('Please select an emergency station', 'warning');
        return;
    }
    
    const serviceType = document.getElementById('emergencyServiceType').dataset.type;
    const fare = parseFloat(document.getElementById('emergencyTotalFare').textContent.replace('ZMW ', ''));
    
    const rideData = {
        passengerId: AppState.currentUser.uid,
        passengerName: AppState.userData.name,
        passengerPhone: AppState.userData.phone,
        pickup: AppState.selectedEmergencyStation.address,
        pickupDisplay: AppState.selectedEmergencyStation.name,
        pickupLat: AppState.selectedEmergencyStation.lat,
        pickupLng: AppState.selectedEmergencyStation.lng,
        destination: 'Emergency Location',
        destinationDisplay: 'Your Location',
        destLat: AppState.userLocation.lat,
        destLng: AppState.userLocation.lng,
        emergencyType: serviceType,
        emergencyReason: reason,
        emergencyDescription: description,
        fare: fare,
        distance: AppState.selectedEmergencyStation.distance,
        serviceType: 'emergency',
        paymentMethod: 'emergency',
        priority: 'high'
    };
    
    try {
        await FirebaseManager.requestEmergencyRide(rideData);
        hideModal('emergency');
    } catch (error) {
        console.error('Error requesting emergency ride:', error);
        UIUpdater.showToast('Error requesting emergency ride', 'error');
    }
}

async function saveSOSConfig() {
    const contact1Name = document.getElementById('sosContact1Name').value.trim();
    const contact1Phone = document.getElementById('sosContact1Phone').value.trim();
    const contact2Name = document.getElementById('sosContact2Name').value.trim();
    const contact2Phone = document.getElementById('sosContact2Phone').value.trim();
    const message = document.getElementById('sosMessage').value.trim();
    
    if (!contact1Name || !contact1Phone) {
        UIUpdater.showToast('Please provide primary emergency contact details', 'warning');
        return;
    }
    
    if (!isValidPhone(contact1Phone) || (contact2Phone && !isValidPhone(contact2Phone))) {
        UIUpdater.showToast('Please enter valid phone numbers', 'error');
        return;
    }
    
    const config = {
        contact1Name,
        contact1Phone,
        contact2Name: contact2Name || '',
        contact2Phone: contact2Phone || '',
        message: message || 'I need help! My current location and ride details will be shared with you.'
    };
    
    await FirebaseManager.saveSOSConfig(config);
    hideModal('sos');
}

function triggerSOS() {
    if (!AppState.sosConfig) {
        UIUpdater.showToast('Please setup SOS contacts first', 'warning');
        showModal('sos');
        return;
    }
    
    if (!AppState.currentRide) {
        UIUpdater.showToast('No active ride to report SOS for', 'warning');
        return;
    }
    
    if (!confirm('Are you sure you want to send an SOS alert to your emergency contacts?')) {
        return;
    }
    
    const sosData = {
        passengerId: AppState.currentUser.uid,
        passengerName: AppState.userData.name,
        passengerPhone: AppState.userData.phone,
        emergencyContact1: AppState.sosConfig.contact1Phone,
        emergencyContact1Name: AppState.sosConfig.contact1Name,
        emergencyContact2: AppState.sosConfig.contact2Phone,
        emergencyContact2Name: AppState.sosConfig.contact2Name,
        message: AppState.sosConfig.message,
        rideId: AppState.currentRide.id,
        location: AppState.userLocation,
        timestamp: Date.now()
    };
    
    FirebaseManager.sendSOSAlert(AppState.currentRide.id, sosData)
        .then(() => {
            UIUpdater.showToast('SOS alert sent to emergency contacts', 'success');
        })
        .catch(error => {
            console.error('SOS error:', error);
            UIUpdater.showToast('Error sending SOS alert', 'error');
        });
}

function logout() {
    auth.signOut()
        .then(() => {
            window.location.href = 'signup.html';
        })
        .catch(error => {
            console.error('Logout error:', error);
            UIUpdater.showToast('Error logging out', 'error');
        });
}

function shareReferralCode() {
    const referralCode = document.getElementById('referralCode')?.textContent;
    if (!referralCode) return;
    
    const shareText = `Join me on Jubel! Use my referral code ${referralCode} to get 50% off your first ride. Download the app at jubel.com`;
    
    if (navigator.share) {
        navigator.share({
            title: 'Join Jubel',
            text: shareText,
            url: 'https://jubel.com'
        });
    } else {
        // Fallback: copy to clipboard
        navigator.clipboard.writeText(shareText)
            .then(() => {
                UIUpdater.showToast('Referral code copied to clipboard', 'success');
            })
            .catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = shareText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                UIUpdater.showToast('Referral code copied to clipboard', 'success');
            });
    }
}

function showModal(modalId) {
    document.getElementById(`${modalId}Modal`).classList.add('active');
}

function hideModal(modalId) {
    document.getElementById(`${modalId}Modal`).classList.remove('active');
}

function isValidPhone(phone) {
    // Zambian phone number validation
    const phoneRegex = /^(\+260|0)?(96|97|76|77|95|91|92|93|94)\d{7}$/;
    return phoneRegex.test(phone.replace(/\s+/g, ''));
}

// ============================================
// START THE APPLICATION
// ============================================
window.addEventListener('load', initializeApp);

// Export functions for HTML event handlers
window.UIUpdater = UIUpdater;
window.FirebaseManager = FirebaseManager;
window.AppState = AppState;
window.SearchEngine = SearchEngine;
window.PriceCalculator = PriceCalculator;
window.EmergencyLocator = EmergencyLocator;
window.requestCarRide = requestCarRide;
window.requestBicycleRide = requestBicycleRide;
window.requestDelivery = requestDelivery;
window.requestShortDelivery = requestShortDelivery;
window.requestExpressShopping = requestExpressShopping;
window.requestTruck = requestTruck;
window.scheduleRide = scheduleRide;
window.orderForSomeone = orderForSomeone;
window.shareRide = shareRide;
window.handleEmergencyService = handleEmergencyService;
window.requestEmergencyRide = requestEmergencyRide;
window.saveSOSConfig = saveSOSConfig;
window.triggerSOS = triggerSOS;
window.logout = logout;
window.shareReferralCode = shareReferralCode;
window.showModal = showModal;
window.hideModal = hideModal;
window.isValidPhone = isValidPhone;
    </script>
</body>
</html>



