<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jubel - Passenger</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
    --primary-orange: #FF6B35;
    --primary-red: #E74C3C;
    --primary-gradient: linear-gradient(135deg, #FF6B35, #E74C3C);
    --secondary-orange: #E55A28;
    --secondary-red: #C0392B;
    --light-orange: #FFF5F0;
    --light-red: #FCE8E6;
    --white: #FFFFFF;
    --off-white: #F9F9F9;
    --light-gray: #F5F5F5;
    --medium-gray: #E0E0E0;
    --dark-gray: #333333;
    --text-gray: #666666;
    --text-light: #888888;
    --success-green: #2ECC71;
    --warning-yellow: #F39C12;
    --info-blue: #3498DB;
    --error-red: #E74C3C;
    --border-color: #EEEEEE;
    --shadow-light: 0 1px 3px rgba(0, 0, 0, 0.08);
    --shadow-medium: 0 2px 8px rgba(0, 0, 0, 0.12);
    --shadow-heavy: 0 3px 10px rgba(0, 0, 0, 0.15);
    --app-padding: 10px;
    --element-radius: 14px;
    --button-radius: 24px;
    --card-radius: 18px;
    --transition-speed: 0.2s;
    --ambulance-blue: #2980B9;
    --fire-truck-red: #C0392B;
    --police-blue: #2C3E50;
    --premium-gold: #FFD700;
    --economy-green: #27AE60;
    --light-truck-brown: #8B4513;
    --delivery-purple: #8E44AD;
    --express-shop-green: #16A085;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
}

body {
    background-color: var(--off-white);
    color: var(--dark-gray);
    max-width: 100%;
    overflow-x: hidden;
    height: 100vh;
    font-size: 12px;
    line-height: 1.3;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

#map {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 50%;
    z-index: 1;
    background: #f8f9fa;
}

.top-bar {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    z-index: 200;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px var(--app-padding);
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border-color);
    height: 52px;
}

.logo-container {
    display: flex;
    align-items: center;
    gap: 8px;
}

.logo-icon {
    width: 28px;
    height: 28px;
    background: var(--primary-gradient);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--white);
    font-weight: 700;
    font-size: 12px;
    overflow: hidden;
}

.logo-icon img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.logo-text {
    font-size: 13px;
    font-weight: 700;
    color: var(--dark-gray);
    line-height: 1.2;
}

.user-actions {
    display: flex;
    align-items: center;
    gap: 8px;
}

.balance-badge {
    background: var(--white);
    padding: 5px 10px;
    border-radius: var(--button-radius);
    box-shadow: var(--shadow-light);
    display: flex;
    align-items: center;
    gap: 4px;
    font-weight: 600;
    color: var(--dark-gray);
    border: 1px solid var(--border-color);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    font-size: 11px;
}

.balance-badge:hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow-medium);
}

.balance-amount {
    color: var(--primary-orange);
    font-weight: 700;
    font-size: 11px;
}

.notification-bell {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--white);
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: var(--shadow-light);
    border: 1px solid var(--border-color);
    cursor: pointer;
    position: relative;
    transition: all var(--transition-speed) ease;
}

.notification-bell:hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow-medium);
}

.notification-badge {
    position: absolute;
    top: -2px;
    right: -2px;
    width: 14px;
    height: 14px;
    background: var(--error-red);
    color: var(--white);
    border-radius: 50%;
    font-size: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    border: 2px solid var(--white);
}

.ride-status-bar {
    position: absolute;
    top: 56px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 150;
    display: none;
    background: var(--white);
    padding: 6px 14px;
    border-radius: var(--button-radius);
    box-shadow: var(--shadow-heavy);
    border: 1px solid var(--border-color);
    align-items: center;
    gap: 8px;
    min-width: 250px;
    max-width: 85%;
    font-size: 11px;
}

.ride-status-bar.active {
    display: flex;
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from {
        transform: translateX(-50%) translateY(-20px);
        opacity: 0;
    }
    to {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
    }
}

.status-indicator {
    display: flex;
    align-items: center;
    gap: 5px;
}

.status-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--warning-yellow);
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(1.1); }
    100% { opacity: 1; transform: scale(1); }
}

.status-dot.searching { background: var(--warning-yellow); }
.status-dot.arriving { background: var(--info-blue); }
.status-dot.riding { background: var(--success-green); animation: none; }

.status-text {
    font-weight: 600;
    font-size: 11px;
    color: var(--dark-gray);
}

.status-eta {
    margin-left: auto;
    display: flex;
    align-items: center;
    gap: 3px;
    color: var(--text-gray);
    font-size: 10px;
    font-weight: 500;
}

.emergency-status {
    position: absolute;
    top: 56px;
    right: var(--app-padding);
    z-index: 150;
    background: linear-gradient(135deg, var(--error-red), #C0392B);
    color: var(--white);
    padding: 6px 12px;
    border-radius: var(--button-radius);
    box-shadow: var(--shadow-heavy);
    display: none;
    align-items: center;
    gap: 5px;
    font-weight: 700;
    font-size: 11px;
    animation: emergencyPulse 1s infinite;
}

@keyframes emergencyPulse {
    0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
    70% { transform: scale(1.02); box-shadow: 0 0 0 8px rgba(231, 76, 60, 0); }
    100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
}

.sos-button {
    position: absolute;
    bottom: 150px;
    right: var(--app-padding);
    z-index: 150;
    width: 52px;
    height: 52px;
    background: linear-gradient(135deg, var(--error-red), #C0392B);
    border-radius: 50%;
    display: none;
    align-items: center;
    justify-content: center;
    color: var(--white);
    font-size: 13px;
    font-weight: 700;
    box-shadow: var(--shadow-heavy);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    animation: sosPulse 2s infinite;
}

.sos-button:hover {
    transform: scale(1.1);
    box-shadow: 0 0 20px rgba(231, 76, 60, 0.4);
}

@keyframes sosPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.main-panel {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--white);
    border-radius: var(--card-radius) var(--card-radius) 0 0;
    box-shadow: 0 -3px 20px rgba(0, 0, 0, 0.1);
    z-index: 100;
    padding: var(--app-padding);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    max-height: 50vh;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: var(--primary-orange) var(--light-gray);
}

.main-panel::-webkit-scrollbar {
    width: 3px;
}

.main-panel::-webkit-scrollbar-track {
    background: var(--light-gray);
    border-radius: 2px;
}

.main-panel::-webkit-scrollbar-thumb {
    background: var(--primary-orange);
    border-radius: 2px;
}

.main-panel.collapsed {
    transform: translateY(calc(100% - 44px));
}

.panel-handle {
    width: 32px;
    height: 3px;
    background: var(--medium-gray);
    border-radius: 2px;
    margin: 0 auto 10px;
    cursor: pointer;
    transition: all var(--transition-speed) ease;
}

.panel-handle:hover {
    background: var(--primary-orange);
    width: 40px;
}

.nav-tabs {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 6px;
    margin-bottom: 12px;
    padding: 3px;
    background: var(--light-gray);
    border-radius: var(--button-radius);
}

.nav-tab {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 3px;
    padding: 8px 5px;
    border-radius: calc(var(--button-radius) - 4px);
    background: transparent;
    border: none;
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    color: var(--text-gray);
    font-size: 10px;
    font-weight: 600;
}

.nav-tab i {
    font-size: 14px;
    transition: all var(--transition-speed) ease;
}

.nav-tab.active {
    background: var(--white);
    color: var(--primary-orange);
    box-shadow: var(--shadow-light);
}

.nav-tab.active i {
    color: var(--primary-orange);
    transform: translateY(-1px);
}

.nav-tab:hover:not(.active) {
    background: rgba(255, 107, 53, 0.1);
    color: var(--primary-orange);
}

.quick-actions {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
    margin-bottom: 14px;
}

.quick-action-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px;
    background: var(--white);
    border: 1px solid var(--border-color);
    border-radius: var(--element-radius);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    text-align: left;
}

.quick-action-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
    border-color: var(--primary-orange);
}

.quick-action-icon {
    width: 32px;
    height: 32px;
    border-radius: 10px;
    background: var(--light-orange);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary-orange);
    font-size: 14px;
}

.quick-action-text {
    flex: 1;
}

.quick-action-title {
    font-weight: 600;
    font-size: 12px;
    color: var(--dark-gray);
    margin-bottom: 2px;
}

.quick-action-desc {
    font-size: 10px;
    color: var(--text-light);
}

.service-tabs {
    display: flex;
    gap: 6px;
    margin-bottom: 14px;
    overflow-x: auto;
    padding-bottom: 3px;
}

.service-tabs::-webkit-scrollbar {
    display: none;
}

.service-tab {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 3px;
    padding: 10px 12px;
    background: var(--white);
    border: 2px solid var(--border-color);
    border-radius: var(--element-radius);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    min-width: 90px;
    text-align: center;
    flex-shrink: 0;
}

.service-tab:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
}

.service-tab.active {
    border-color: var(--primary-orange);
    background: var(--light-orange);
    box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
}

.service-tab.car.active { border-color: var(--primary-orange); }
.service-tab.delivery.active { border-color: var(--delivery-purple); background: #F4E6FA; }
.service-tab.short-delivery.active { border-color: var(--express-shop-green); background: #E1F5FE; }

.service-icon {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: var(--light-gray);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    color: var(--text-gray);
    transition: all var(--transition-speed) ease;
}

.service-tab.active .service-icon {
    background: var(--primary-orange);
    color: var(--white);
}

.service-tab.delivery.active .service-icon {
    background: var(--delivery-purple);
}

.service-tab.short-delivery.active .service-icon {
    background: var(--express-shop-green);
}

.service-name {
    font-weight: 600;
    font-size: 11px;
    color: var(--dark-gray);
}

.service-desc {
    font-size: 9px;
    color: var(--text-light);
    margin-top: 1px;
}

.ride-request-form {
    background: var(--white);
    border-radius: var(--element-radius);
    padding: 14px;
    margin-bottom: 10px;
    box-shadow: var(--shadow-light);
    border: 1px solid var(--border-color);
}

.form-title {
    font-size: 13px;
    font-weight: 700;
    margin-bottom: 12px;
    color: var(--dark-gray);
    display: flex;
    align-items: center;
    gap: 6px;
}

.location-inputs {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 12px;
}

.location-input {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px;
    background: var(--off-white);
    border: 2px solid transparent;
    border-radius: var(--element-radius);
    transition: all var(--transition-speed) ease;
    position: relative;
}

.location-input.active {
    border-color: var(--primary-orange);
    background: var(--white);
    box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
}

.location-input i {
    color: var(--primary-orange);
    font-size: 13px;
    width: 16px;
    text-align: center;
}

.location-input input {
    flex: 1;
    border: none;
    background: transparent;
    outline: none;
    font-size: 12px;
    color: var(--dark-gray);
    font-weight: 500;
}

.location-input input::placeholder {
    color: var(--text-light);
}

.suggestion-list {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--white);
    border: 1px solid var(--border-color);
    border-radius: var(--element-radius);
    box-shadow: var(--shadow-heavy);
    z-index: 1000;
    max-height: 200px;
    overflow-y: auto;
    display: none;
    margin-top: 3px;
}

.suggestion-list.active {
    display: block;
    animation: fadeIn 0.2s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-8px); }
    to { opacity: 1; transform: translateY(0); }
}

.suggestion-item {
    padding: 10px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    display: flex;
    align-items: flex-start;
    gap: 8px;
}

.suggestion-item:hover {
    background: var(--light-orange);
}

.suggestion-item:last-child {
    border-bottom: none;
}

.suggestion-icon {
    color: var(--primary-orange);
    font-size: 11px;
    margin-top: 2px;
}

.suggestion-details {
    flex: 1;
}

.suggestion-name {
    font-weight: 600;
    font-size: 12px;
    color: var(--dark-gray);
    margin-bottom: 2px;
}

.suggestion-address {
    font-size: 10px;
    color: var(--text-gray);
    line-height: 1.2;
}

.suggestion-distance {
    font-size: 9px;
    color: var(--text-light);
    margin-top: 1px;
}

.ride-type-selection {
    margin: 14px 0;
    display: none;
}

.ride-type-selection.active {
    display: block;
    animation: fadeInUp 0.3s ease;
}

@keyframes fadeInUp {
    from { opacity: 0; transform: translateY(15px); }
    to { opacity: 1; transform: translateY(0); }
}

.ride-type-title {
    font-size: 12px;
    font-weight: 600;
    color: var(--dark-gray);
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.ride-type-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 6px;
}

.ride-type-card {
    background: var(--white);
    border: 2px solid var(--border-color);
    border-radius: var(--element-radius);
    padding: 12px 8px;
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    text-align: center;
    position: relative;
    overflow: hidden;
}

.ride-type-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
}

.ride-type-card.selected {
    border-color: var(--primary-orange);
    background: var(--light-orange);
    box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
}

.ride-type-card.economy.selected {
    border-color: var(--economy-green);
    background: #E8F6EF;
}

.ride-type-card.premium.selected {
    border-color: var(--premium-gold);
    background: #FFF9E6;
}

.ride-type-icon {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    background: var(--light-gray);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 6px;
    font-size: 16px;
    color: var(--text-gray);
    transition: all var(--transition-speed) ease;
}

.ride-type-card.selected .ride-type-icon {
    background: var(--primary-orange);
    color: var(--white);
}

.ride-type-card.economy.selected .ride-type-icon {
    background: var(--economy-green);
}

.ride-type-card.premium.selected .ride-type-icon {
    background: var(--premium-gold);
    color: var(--dark-gray);
}

.ride-type-name {
    font-weight: 600;
    font-size: 11px;
    color: var(--dark-gray);
    margin-bottom: 1px;
}

.ride-type-price {
    font-size: 12px;
    font-weight: 700;
    color: var(--primary-orange);
    margin-bottom: 1px;
}

.ride-type-card.economy .ride-type-price {
    color: var(--economy-green);
}

.ride-type-card.premium .ride-type-price {
    color: #B8860B;
}

.ride-type-eta {
    font-size: 9px;
    color: var(--text-light);
}

.fare-display {
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
    color: var(--white);
    padding: 14px;
    border-radius: var(--element-radius);
    margin: 14px 0;
    text-align: center;
    box-shadow: var(--shadow-medium);
    display: none;
}

.fare-display.active {
    display: block;
    animation: slideUp 0.3s ease;
}

@keyframes slideUp {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
}

.fare-label {
    font-size: 11px;
    opacity: 0.9;
    margin-bottom: 1px;
}

.fare-amount {
    font-size: 22px;
    font-weight: 800;
    margin: 4px 0;
}

.fare-details {
    display: flex;
    justify-content: space-between;
    margin-top: 8px;
    font-size: 10px;
    opacity: 0.9;
}

.action-buttons {
    display: grid;
    grid-template-columns: 1fr;
    gap: 8px;
    margin-top: 14px;
}

.btn {
    padding: 12px;
    border: none;
    border-radius: var(--button-radius);
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.btn-primary {
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
    color: var(--white);
    box-shadow: 0 2px 8px rgba(255, 107, 53, 0.3);
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 3px 12px rgba(255, 107, 53, 0.4);
}

.btn-secondary {
    background: var(--white);
    color: var(--primary-orange);
    border: 2px solid var(--primary-orange);
}

.btn-secondary:hover {
    background: var(--light-orange);
    transform: translateY(-2px);
}

.btn-danger {
    background: linear-gradient(135deg, var(--error-red), #C0392B);
    color: var(--white);
    box-shadow: 0 2px 8px rgba(231, 76, 60, 0.3);
}

.btn-danger:hover {
    transform: translateY(-2px);
    box-shadow: 0 3px 12px rgba(231, 76, 60, 0.4);
}

.ride-info-panel {
    background: var(--white);
    border-radius: var(--element-radius);
    padding: 14px;
    margin-bottom: 10px;
    box-shadow: var(--shadow-medium);
    border: 1px solid var(--border-color);
    display: none;
}

.ride-info-panel.active {
    display: block;
    animation: fadeInUp 0.3s ease;
}

.driver-info {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 14px;
    padding-bottom: 14px;
    border-bottom: 1px solid var(--border-color);
}

.driver-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    color: var(--white);
    font-weight: 700;
    overflow: hidden;
}

.driver-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.driver-details {
    flex: 1;
}

.driver-name {
    font-size: 13px;
    font-weight: 700;
    color: var(--dark-gray);
    margin-bottom: 2px;
}

.driver-rating {
    display: flex;
    align-items: center;
    gap: 3px;
    color: var(--warning-yellow);
    font-weight: 600;
    margin-bottom: 3px;
    font-size: 11px;
}

.driver-vehicle {
    font-size: 11px;
    color: var(--text-gray);
    display: flex;
    align-items: center;
    gap: 3px;
}

.vehicle-image {
    width: 56px;
    height: 56px;
    border-radius: 8px;
    overflow: hidden;
    background: var(--light-gray);
    display: flex;
    align-items: center;
    justify-content: center;
}

.vehicle-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.trip-details {
    margin-bottom: 14px;
}

.trip-locations {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.location-point {
    display: flex;
    align-items: flex-start;
    gap: 8px;
}

.location-marker {
    width: 26px;
    height: 26px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    color: var(--white);
    font-size: 10px;
}

.location-marker.pickup {
    background: var(--primary-orange);
}

.location-marker.destination {
    background: var(--primary-red);
}

.location-text {
    flex: 1;
}

.location-label {
    font-size: 10px;
    color: var(--text-light);
    margin-bottom: 1px;
    font-weight: 600;
}

.location-address {
    font-size: 12px;
    color: var(--dark-gray);
    font-weight: 500;
    line-height: 1.2;
}

.fare-breakdown {
    background: var(--off-white);
    border-radius: var(--element-radius);
    padding: 12px;
    margin-bottom: 14px;
}

.fare-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 5px 0;
    border-bottom: 1px solid var(--border-color);
}

.fare-row:last-child {
    border-bottom: none;
}

.fare-label {
    font-size: 12px;
    color: var(--text-gray);
}

.fare-value {
    font-size: 12px;
    font-weight: 600;
    color: var(--dark-gray);
}

.fare-row.total {
    margin-top: 5px;
    padding-top: 8px;
    border-top: 2px solid var(--border-color);
}

.fare-row.total .fare-label {
    font-size: 13px;
    font-weight: 700;
    color: var(--dark-gray);
}

.fare-row.total .fare-value {
    font-size: 16px;
    font-weight: 800;
    color: var(--primary-orange);
}

.chat-container {
    position: absolute;
    bottom: 180px;
    right: var(--app-padding);
    z-index: 300;
    width: 280px;
    max-width: calc(100vw - 40px);
    background: var(--white);
    border-radius: var(--card-radius);
    box-shadow: var(--shadow-heavy);
    display: none;
    flex-direction: column;
    overflow: hidden;
    border: 1px solid var(--border-color);
}

.chat-container.active {
    display: flex;
    animation: chatSlideUp 0.3s ease;
}

@keyframes chatSlideUp {
    from { transform: translateY(15px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.chat-header {
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
    color: var(--white);
    padding: 12px;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.chat-title {
    font-weight: 600;
    font-size: 12px;
}

.chat-close {
    background: none;
    border: none;
    color: var(--white);
    font-size: 14px;
    cursor: pointer;
    padding: 3px;
    border-radius: 4px;
    transition: all var(--transition-speed) ease;
}

.chat-close:hover {
    background: rgba(255, 255, 255, 0.2);
}

.chat-messages {
    flex: 1;
    padding: 12px;
    max-height: 200px;
    overflow-y: auto;
    background: var(--off-white);
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.message {
    max-width: 75%;
    padding: 6px 10px;
    border-radius: 14px;
    font-size: 12px;
    line-height: 1.2;
}

.message.sent {
    align-self: flex-end;
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
    color: var(--white);
    border-bottom-right-radius: 3px;
}

.message.received {
    align-self: flex-start;
    background: var(--white);
    color: var(--dark-gray);
    border: 1px solid var(--border-color);
    border-bottom-left-radius: 3px;
}

.message-time {
    font-size: 9px;
    color: var(--text-light);
    margin-top: 1px;
    text-align: right;
}

.message.received .message-time {
    color: var(--text-gray);
}

.chat-input-container {
    padding: 12px;
    background: var(--white);
    border-top: 1px solid var(--border-color);
    display: flex;
    gap: 6px;
}

.chat-input {
    flex: 1;
    padding: 8px 12px;
    border: 1px solid var(--border-color);
    border-radius: var(--button-radius);
    font-size: 12px;
    outline: none;
    transition: all var(--transition-speed) ease;
}

.chat-input:focus {
    border-color: var(--primary-orange);
    box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
}

.chat-send-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
    color: var(--white);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-speed) ease;
}

.chat-send-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 2px 8px rgba(255, 107, 53, 0.3);
}

.chat-notification {
    position: absolute;
    top: -5px;
    right: -5px;
    width: 16px;
    height: 16px;
    background: var(--error-red);
    color: var(--white);
    border-radius: 50%;
    font-size: 9px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    animation: bounce 1s infinite;
}

@keyframes bounce {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.2); }
}

.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 14px;
    backdrop-filter: blur(4px);
}

.modal-overlay.active {
    display: flex;
    animation: fadeIn 0.3s ease;
}

.modal {
    background: var(--white);
    border-radius: var(--card-radius);
    box-shadow: var(--shadow-heavy);
    max-width: 400px;
    width: 100%;
    max-height: 80vh;
    overflow-y: auto;
    animation: modalSlideUp 0.3s ease;
}

@keyframes modalSlideUp {
    from { transform: translateY(25px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.modal-header {
    padding: 16px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.modal-title {
    font-size: 14px;
    font-weight: 700;
    color: var(--dark-gray);
    display: flex;
    align-items: center;
    gap: 6px;
}

.modal-close {
    background: none;
    border: none;
    font-size: 18px;
    color: var(--text-light);
    cursor: pointer;
    padding: 3px;
    border-radius: 4px;
    transition: all var(--transition-speed) ease;
}

.modal-close:hover {
    color: var(--error-red);
    background: var(--light-red);
}

.modal-content {
    padding: 16px;
}

.history-screen {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--white);
    z-index: 200;
    display: none;
    flex-direction: column;
    padding-top: 52px;
}

.history-screen.active {
    display: flex;
    animation: slideInRight 0.3s ease;
}

@keyframes slideInRight {
    from { transform: translateX(100%); }
    to { transform: translateX(0); }
}

.screen-header {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    background: var(--white);
    padding: 12px var(--app-padding);
    border-bottom: 1px solid var(--border-color);
    z-index: 10;
    display: flex;
    align-items: center;
    gap: 12px;
}

.back-btn {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--light-gray);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--dark-gray);
    border: none;
    cursor: pointer;
    transition: all var(--transition-speed) ease;
}

.back-btn:hover {
    background: var(--medium-gray);
    transform: translateX(-2px);
}

.screen-title {
    font-size: 14px;
    font-weight: 700;
    color: var(--dark-gray);
}

.history-filters {
    padding: 12px var(--app-padding);
    background: var(--off-white);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    gap: 6px;
    overflow-x: auto;
    scrollbar-width: none;
}

.history-filters::-webkit-scrollbar {
    display: none;
}

.filter-btn {
    padding: 5px 12px;
    background: var(--white);
    border: 1px solid var(--border-color);
    border-radius: var(--button-radius);
    font-size: 11px;
    font-weight: 600;
    color: var(--text-gray);
    cursor: pointer;
    white-space: nowrap;
    transition: all var(--transition-speed) ease;
}

.filter-btn.active {
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
    color: var(--white);
    border-color: transparent;
}

.filter-btn:hover:not(.active) {
    border-color: var(--primary-orange);
    color: var(--primary-orange);
}

.history-list {
    flex: 1;
    overflow-y: auto;
    padding: 12px var(--app-padding);
}

.history-item {
    background: var(--white);
    border-radius: var(--element-radius);
    padding: 14px;
    margin-bottom: 8px;
    box-shadow: var(--shadow-light);
    border: 1px solid var(--border-color);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
}

.history-item:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
    border-color: var(--primary-orange);
}

.history-item.expanded {
    margin-bottom: 14px;
}

.history-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 8px;
}

.history-type {
    display: flex;
    align-items: center;
    gap: 5px;
}

.history-icon {
    width: 26px;
    height: 26px;
    border-radius: 6px;
    background: var(--light-orange);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary-orange);
}

.history-type-name {
    font-weight: 600;
    font-size: 12px;
    color: var(--dark-gray);
}

.history-date {
    font-size: 11px;
    color: var(--text-light);
}

.history-status {
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.status-completed {
    background: #E8F6EF;
    color: var(--economy-green);
}

.status-cancelled {
    background: var(--light-red);
    color: var(--error-red);
}

.status-ongoing {
    background: #E3F2FD;
    color: var(--info-blue);
}

.history-locations {
    margin-bottom: 8px;
}

.history-location {
    display: flex;
    align-items: flex-start;
    gap: 5px;
    margin-bottom: 5px;
}

.history-location i {
    color: var(--text-light);
    margin-top: 2px;
}

.history-location-text {
    font-size: 11px;
    color: var(--text-gray);
    line-height: 1.2;
}

.history-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid var(--border-color);
}

.history-price {
    font-size: 13px;
    font-weight: 700;
    color: var(--primary-orange);
}

.history-driver {
    font-size: 11px;
    color: var(--text-gray);
}

.history-details {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
}

.history-item.expanded .history-details {
    max-height: 350px;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid var(--border-color);
}

.detail-section {
    margin-bottom: 12px;
}

.detail-title {
    font-size: 12px;
    font-weight: 600;
    color: var(--dark-gray);
    margin-bottom: 5px;
    display: flex;
    align-items: center;
    gap: 5px;
}

.detail-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
}

.detail-item {
    display: flex;
    flex-direction: column;
    gap: 1px;
}

.detail-label {
    font-size: 10px;
    color: var(--text-light);
    font-weight: 500;
}

.detail-value {
    font-size: 12px;
    color: var(--dark-gray);
    font-weight: 500;
}

.account-screen {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--white);
    z-index: 200;
    display: none;
    flex-direction: column;
    padding-top: 52px;
}

.account-screen.active {
    display: flex;
}

.account-header {
    padding: 16px var(--app-padding);
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
    color: var(--white);
    text-align: center;
}

.account-avatar {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    margin: 0 auto 12px;
    border: 3px solid rgba(255, 255, 255, 0.3);
}

.account-name {
    font-size: 16px;
    font-weight: 700;
    margin-bottom: 2px;
}

.account-phone {
    font-size: 12px;
    opacity: 0.9;
}

.account-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    padding: 14px var(--app-padding);
    background: var(--white);
}

.stat-card {
    background: var(--off-white);
    border-radius: var(--element-radius);
    padding: 12px;
    text-align: center;
}

.stat-value {
    font-size: 18px;
    font-weight: 700;
    color: var(--primary-orange);
    margin-bottom: 2px;
}

.stat-label {
    font-size: 10px;
    color: var(--text-gray);
    font-weight: 500;
}

.account-section {
    padding: 14px var(--app-padding);
    border-bottom: 1px solid var(--border-color);
}

.section-title {
    font-size: 13px;
    font-weight: 700;
    color: var(--dark-gray);
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.wallet-balance {
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
    color: var(--white);
    padding: 16px;
    border-radius: var(--element-radius);
    text-align: center;
    margin-bottom: 14px;
}

.balance-label {
    font-size: 12px;
    opacity: 0.9;
    margin-bottom: 4px;
}

.balance-amount-large {
    font-size: 26px;
    font-weight: 800;
    margin-bottom: 2px;
}

.wallet-actions {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-top: 12px;
}

.btn-wallet {
    padding: 8px;
    border: 2px solid var(--primary-orange);
    background: var(--white);
    color: var(--primary-orange);
    border-radius: var(--button-radius);
    font-weight: 600;
    font-size: 12px;
    cursor: pointer;
    transition: all var(--transition-speed) ease;
}

.btn-wallet:hover {
    background: var(--primary-orange);
    color: var(--white);
    transform: translateY(-2px);
}

.referral-card {
    background: var(--light-orange);
    border-radius: var(--element-radius);
    padding: 14px;
    text-align: center;
    margin-top: 12px;
}

.referral-code {
    background: var(--white);
    padding: 12px;
    border-radius: var(--element-radius);
    margin: 12px 0;
    font-family: monospace;
    font-size: 16px;
    font-weight: 700;
    color: var(--primary-orange);
    letter-spacing: 1px;
}

.referral-note {
    font-size: 10px;
    color: var(--text-gray);
    margin-top: 5px;
}

.emergency-screen {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--white);
    z-index: 200;
    display: none;
    flex-direction: column;
    padding-top: 52px;
}

.emergency-screen.active {
    display: flex;
}

.emergency-services {
    padding: 14px var(--app-padding);
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
}

.emergency-service {
    background: var(--white);
    border: 2px solid var(--border-color);
    border-radius: var(--element-radius);
    padding: 14px;
    text-align: center;
    cursor: pointer;
    transition: all var(--transition-speed) ease;
}

.emergency-service:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-medium);
}

.emergency-service.police {
    border-color: var(--police-blue);
}

.emergency-service.police:hover {
    border-color: var(--police-blue);
    box-shadow: 0 4px 15px rgba(44, 62, 80, 0.2);
}

.emergency-service.fire {
    border-color: var(--fire-truck-red);
}

.emergency-service.fire:hover {
    border-color: var(--fire-truck-red);
    box-shadow: 0 4px 15px rgba(192, 57, 43, 0.2);
}

.emergency-service.medical {
    border-color: var(--ambulance-blue);
}

.emergency-service.medical:hover {
    border-color: var(--ambulance-blue);
    box-shadow: 0 4px 15px rgba(41, 128, 185, 0.2);
}

.emergency-icon {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    margin: 0 auto 8px;
    color: var(--white);
}

.emergency-service.police .emergency-icon {
    background: var(--police-blue);
}

.emergency-service.fire .emergency-icon {
    background: var(--fire-truck-red);
}

.emergency-service.medical .emergency-icon {
    background: var(--ambulance-blue);
}

.emergency-name {
    font-size: 13px;
    font-weight: 700;
    color: var(--dark-gray);
    margin-bottom: 4px;
}

.emergency-description {
    font-size: 11px;
    color: var(--text-gray);
    line-height: 1.2;
}

.emergency-note {
    padding: 14px var(--app-padding);
    background: var(--light-red);
    margin: 14px var(--app-padding);
    border-radius: var(--element-radius);
    border-left: 3px solid var(--error-red);
}

.emergency-note p {
    font-size: 11px;
    color: var(--dark-gray);
    line-height: 1.3;
}

.loading {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid var(--light-gray);
    border-radius: 50%;
    border-top-color: var(--primary-orange);
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.9);
    z-index: 10000;
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 14px;
}

.loading-overlay.active {
    display: flex;
}

.loading-spinner {
    width: 48px;
    height: 48px;
    border: 3px solid var(--light-gray);
    border-radius: 50%;
    border-top-color: var(--primary-orange);
    animation: spin 1s linear infinite;
}

.loading-text {
    font-size: 13px;
    font-weight: 600;
    color: var(--dark-gray);
}

.toast-container {
    position: fixed;
    top: 80px;
    right: var(--app-padding);
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: 6px;
    max-width: 300px;
}

.toast {
    background: var(--white);
    border-radius: var(--element-radius);
    padding: 12px;
    box-shadow: var(--shadow-heavy);
    border-left: 3px solid var(--primary-orange);
    display: flex;
    align-items: flex-start;
    gap: 8px;
    animation: slideInRight 0.3s ease;
    transform: translateX(0);
    transition: transform 0.3s ease;
}

.toast.hiding {
    transform: translateX(100%);
}

.toast-icon {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: var(--light-orange);
    color: var(--primary-orange);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.toast-content {
    flex: 1;
}

.toast-title {
    font-weight: 600;
    font-size: 12px;
    color: var(--dark-gray);
    margin-bottom: 1px;
}

.toast-message {
    font-size: 11px;
    color: var(--text-gray);
    line-height: 1.2;
}

.toast-close {
    background: none;
    border: none;
    color: var(--text-light);
    font-size: 14px;
    cursor: pointer;
    padding: 2px;
    border-radius: 4px;
    transition: all var(--transition-speed) ease;
}

.toast-close:hover {
    color: var(--error-red);
    background: var(--light-red);
}

.toast.success {
    border-left-color: var(--success-green);
}

.toast.success .toast-icon {
    background: #E8F6EF;
    color: var(--success-green);
}

.toast.error {
    border-left-color: var(--error-red);
}

.toast.error .toast-icon {
    background: var(--light-red);
    color: var(--error-red);
}

.toast.warning {
    border-left-color: var(--warning-yellow);
}

.toast.warning .toast-icon {
    background: #FFF3E0;
    color: var(--warning-yellow);
}

@media (max-width: 768px) {
    :root {
        --app-padding: 8px;
        --element-radius: 12px;
        --button-radius: 20px;
    }
    
    .quick-actions {
        grid-template-columns: 1fr;
    }
    
    .ride-type-grid {
        grid-template-columns: 1fr;
    }
    
    .emergency-services {
        grid-template-columns: 1fr;
    }
    
    .chat-container {
        width: calc(100vw - 20px);
        right: 8px;
    }
    
    .detail-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 480px) {
    .nav-tabs {
        gap: 3px;
    }
    
    .nav-tab {
        padding: 6px 3px;
        font-size: 9px;
    }
    
    .nav-tab i {
        font-size: 12px;
    }
    
    .balance-badge {
        padding: 4px 6px;
        font-size: 10px;
    }
    
    .service-tab {
        min-width: 80px;
        padding: 8px 10px;
    }
}

.current-location-marker {
    background: var(--info-blue);
    color: white;
    border-radius: 50%;
    width: 16px;
    height: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 8px;
    box-shadow: 0 1px 6px rgba(0,0,0,0.3);
    border: 2px solid white;
}

.pickup-marker {
    background: var(--primary-orange);
    color: white;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 9px;
    box-shadow: 0 1px 6px rgba(0,0,0,0.3);
    border: 2px solid white;
}

.destination-marker {
    background: var(--primary-red);
    color: white;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 9px;
    box-shadow: 0 1px 6px rgba(0,0,0,0.3);
    border: 2px solid white;
}

.driver-marker {
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
    color: white;
    border-radius: 50%;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    box-shadow: 0 1px 6px rgba(0,0,0,0.3);
    border: 2px solid white;
    animation: pulse 2s infinite;
}

.emergency-vehicle-marker {
    background: var(--error-red);
    color: white;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    box-shadow: 0 1px 6px rgba(0,0,0,0.3);
    border: 2px solid white;
    animation: emergencyPulse 1s infinite;
}

.form-group {
    margin-bottom: 12px;
}

.form-label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    font-size: 12px;
    color: var(--dark-gray);
}

.form-control {
    width: 100%;
    padding: 10px;
    border: 2px solid var(--border-color);
    border-radius: var(--element-radius);
    font-size: 12px;
    color: var(--dark-gray);
    background: var(--white);
    transition: all var(--transition-speed) ease;
}

.form-control:focus {
    outline: none;
    border-color: var(--primary-orange);
    box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
}

.form-textarea {
    min-height: 70px;
    resize: vertical;
}

.search-loading {
    display: none;
    position: absolute;
    top: 50%;
    right: 10px;
    transform: translateY(-50%);
    width: 12px;
    height: 12px;
    border: 2px solid var(--light-gray);
    border-radius: 50%;
    border-top-color: var(--primary-orange);
    animation: spin 0.6s linear infinite;
}

.location-input.searching .search-loading {
    display: block;
}

.no-results {
    padding: 25px 12px;
    text-align: center;
    color: var(--text-light);
    font-size: 12px;
}

.no-results i {
    font-size: 24px;
    margin-bottom: 8px;
    opacity: 0.5;
}

.price-calculation {
    background: var(--off-white);
    border-radius: var(--element-radius);
    padding: 12px;
    margin: 12px 0;
    font-size: 11px;
    color: var(--text-gray);
}

.calculation-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 4px;
}

.calculation-row:last-child {
    margin-bottom: 0;
    padding-top: 4px;
    border-top: 1px solid var(--border-color);
    font-weight: 600;
    color: var(--dark-gray);
}

.cancel-reasons {
    display: grid;
    grid-template-columns: 1fr;
    gap: 8px;
    margin-bottom: 14px;
}

.cancel-reason {
    padding: 12px;
    border: 2px solid var(--border-color);
    border-radius: var(--element-radius);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    display: flex;
    align-items: center;
    gap: 8px;
}

.cancel-reason:hover {
    border-color: var(--primary-orange);
    background: var(--light-orange);
}

.cancel-reason.selected {
    border-color: var(--primary-orange);
    background: var(--light-orange);
}

.reason-icon {
    width: 26px;
    height: 26px;
    border-radius: 6px;
    background: var(--light-gray);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-gray);
}

.cancel-reason.selected .reason-icon {
    background: var(--primary-orange);
    color: var(--white);
}

.reason-text {
    flex: 1;
    font-weight: 500;
    color: var(--dark-gray);
}

.schedule-form {
    display: none;
    background: var(--white);
    border-radius: var(--element-radius);
    padding: 14px;
    margin-bottom: 10px;
    box-shadow: var(--shadow-light);
    border: 1px solid var(--border-color);
}

.schedule-form.active {
    display: block;
}

.schedule-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-bottom: 12px;
}

.more-options {
    display: none;
    background: var(--white);
    border-radius: var(--element-radius);
    padding: 14px;
    margin-bottom: 10px;
    box-shadow: var(--shadow-light);
    border: 1px solid var(--border-color);
}

.more-options.active {
    display: block;
}

.options-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
}

.option-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
    padding: 12px;
    background: var(--off-white);
    border: 2px solid transparent;
    border-radius: var(--element-radius);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
}

.option-btn:hover {
    border-color: var(--primary-orange);
    background: var(--white);
    transform: translateY(-2px);
}

.option-icon {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    background: var(--light-orange);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary-orange);
    font-size: 14px;
}

.option-name {
    font-weight: 600;
    font-size: 11px;
    color: var(--dark-gray);
    text-align: center;
}

.empty-state {
    padding: 40px 12px;
    text-align: center;
    color: var(--text-light);
}

.empty-icon {
    font-size: 36px;
    margin-bottom: 12px;
    opacity: 0.3;
}

.empty-title {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 4px;
    color: var(--text-gray);
}

.empty-message {
    font-size: 12px;
    margin-bottom: 14px;
    line-height: 1.3;
}

.service-form {
    display: none;
    background: var(--white);
    border-radius: var(--element-radius);
    padding: 14px;
    margin-bottom: 10px;
    box-shadow: var(--shadow-light);
    border: 1px solid var(--border-color);
}

.service-form.active {
    display: block;
    animation: fadeIn 0.3s ease;
}

.truck-form {
    border-color: var(--light-truck-brown);
}

.truck-form .form-title {
    color: var(--light-truck-brown);
}

.delivery-form {
    border-color: var(--delivery-purple);
}

.delivery-form .form-title {
    color: var(--delivery-purple);
}

.express-form {
    border-color: var(--express-shop-green);
}

.express-form .form-title {
    color: var(--express-shop-green);
}

.someone-else-form {
    border-color: var(--info-blue);
}

.someone-else-form .form-title {
    color: var(--info-blue);
}

.share-ride-form {
    border-color: var(--warning-yellow);
}

.share-ride-form .form-title {
    color: var(--warning-yellow);
}

.payment-methods {
    display: grid;
    grid-template-columns: 1fr;
    gap: 8px;
    margin: 14px 0;
}

.payment-method {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px;
    border: 2px solid var(--border-color);
    border-radius: var(--element-radius);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
}

.payment-method:hover {
    border-color: var(--primary-orange);
    background: var(--light-orange);
}

.payment-method.selected {
    border-color: var(--primary-orange);
    background: var(--light-orange);
}

.payment-icon {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    background: var(--light-gray);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-gray);
}

.payment-method.selected .payment-icon {
    background: var(--primary-orange);
    color: var(--white);
}

.payment-details {
    flex: 1;
}

.payment-name {
    font-weight: 600;
    font-size: 12px;
    color: var(--dark-gray);
}

.payment-info {
    font-size: 10px;
    color: var(--text-gray);
    margin-top: 1px;
}

.transfer-form {
    display: none;
}

.transfer-form.active {
    display: block;
}

.timeline {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin: 14px 0;
    padding: 0 16px;
    position: relative;
}

.timeline::before {
    content: '';
    position: absolute;
    top: 10px;
    left: 10%;
    right: 10%;
    height: 2px;
    background: var(--border-color);
    z-index: 1;
}

.timeline-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    position: relative;
    z-index: 2;
    flex: 1;
}

.step-dot {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--light-gray);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-light);
    font-size: 9px;
    border: 2px solid var(--white);
    transition: all var(--transition-speed) ease;
}

.step-dot.active {
    background: var(--primary-orange);
    color: var(--white);
    transform: scale(1.1);
}

.step-dot.completed {
    background: var(--success-green);
    color: var(--white);
}

.step-label {
    font-size: 10px;
    color: var(--text-light);
    text-align: center;
}

.step-label.active {
    color: var(--primary-orange);
    font-weight: 600;
}

.parcel-details {
    background: var(--off-white);
    border-radius: var(--element-radius);
    padding: 12px;
    margin: 10px 0;
}

.parcel-value-input {
    display: flex;
    align-items: center;
    gap: 6px;
}

.parcel-value-input span {
    font-weight: 600;
    color: var(--text-gray);
}

.parcel-value-input input {
    flex: 1;
    padding: 8px;
    border: 1px solid var(--border-color);
    border-radius: var(--element-radius);
    font-size: 12px;
}

.truck-types {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
    margin: 10px 0;
}

.truck-type {
    padding: 10px;
    border: 2px solid var(--border-color);
    border-radius: var(--element-radius);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    text-align: center;
}

.truck-type:hover {
    border-color: var(--light-truck-brown);
    transform: translateY(-2px);
}

.truck-type.selected {
    border-color: var(--light-truck-brown);
    background: rgba(139, 69, 19, 0.05);
}

.truck-icon {
    font-size: 18px;
    color: var(--light-truck-brown);
    margin-bottom: 4px;
}

.truck-name {
    font-weight: 600;
    font-size: 11px;
    color: var(--dark-gray);
    margin-bottom: 1px;
}

.truck-capacity {
    font-size: 9px;
    color: var(--text-gray);
}

.item-list {
    margin: 10px 0;
}

.item-entry {
    display: flex;
    gap: 6px;
    margin-bottom: 6px;
}

.item-entry input {
    flex: 1;
    padding: 8px;
    border: 1px solid var(--border-color);
    border-radius: var(--element-radius);
    font-size: 12px;
}

.remove-item {
    width: 32px;
    height: 32px;
    border-radius: var(--element-radius);
    background: var(--light-red);
    border: none;
    color: var(--error-red);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

.add-item {
    width: 100%;
    padding: 8px;
    background: var(--light-orange);
    border: 2px dashed var(--primary-orange);
    border-radius: var(--element-radius);
    color: var(--primary-orange);
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    transition: all var(--transition-speed) ease;
}

.add-item:hover {
    background: var(--primary-orange);
    color: var(--white);
}

.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}

*:focus {
    outline: 2px solid var(--primary-orange);
    outline-offset: 2px;
}

*:focus:not(.focus-visible) {
    outline: none;
}

@media print {
    .main-panel,
    .top-bar,
    .chat-container,
    .modal-overlay,
    .sos-button,
    .ride-status-bar,
    .emergency-status {
        display: none !important;
    }
    
    #map {
        position: relative;
        height: 250px;
    }
}

.broadcast-section {
    background: var(--white);
    border-radius: var(--element-radius);
    padding: 14px;
    margin: 10px 0;
    box-shadow: var(--shadow-light);
    border: 1px solid var(--border-color);
}

.broadcast-form {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.broadcast-input-group {
    display: flex;
    gap: 6px;
}

.broadcast-input-group input {
    flex: 1;
    padding: 8px 12px;
    border: 1px solid var(--border-color);
    border-radius: var(--element-radius);
    font-size: 12px;
}

.broadcast-btn {
    padding: 8px 14px;
    background: var(--primary-orange);
    color: var(--white);
    border: none;
    border-radius: var(--element-radius);
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-speed) ease;
}

.broadcast-btn:hover {
    background: var(--secondary-orange);
    transform: translateY(-2px);
}

.broadcast-list {
    margin-top: 10px;
    max-height: 180px;
    overflow-y: auto;
}

.broadcast-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px;
    border-bottom: 1px solid var(--border-color);
}

.broadcast-item:last-child {
    border-bottom: none;
}

.broadcast-name {
    font-weight: 600;
    font-size: 12px;
}

.broadcast-status {
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 10px;
    background: var(--light-orange);
    color: var(--primary-orange);
}

.broadcast-status.pending {
    background: #FFF3E0;
    color: var(--warning-yellow);
}

.broadcast-status.accepted {
    background: #E8F6EF;
    color: var(--success-green);
}

.driver-media {
    display: flex;
    gap: 10px;
    margin-top: 8px;
}

.media-container {
    flex: 1;
    border-radius: var(--element-radius);
    overflow: hidden;
    background: var(--light-gray);
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 70px;
}

.media-container img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.media-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: var(--text-light);
    font-size: 11px;
}

.media-placeholder i {
    font-size: 20px;
    margin-bottom: 3px;
}

.emergency-reasons {
    display: grid;
    grid-template-columns: 1fr;
    gap: 8px;
    margin: 14px 0;
}

.emergency-reason {
    padding: 12px;
    border: 2px solid var(--border-color);
    border-radius: var(--element-radius);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    display: flex;
    align-items: center;
    gap: 8px;
}

.emergency-reason:hover {
    border-color: var(--error-red);
    background: var(--light-red);
}

.emergency-reason.selected {
    border-color: var(--error-red);
    background: var(--light-red);
}

.emergency-reason-icon {
    width: 26px;
    height: 26px;
    border-radius: 6px;
    background: var(--light-red);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--error-red);
}

.emergency-reason.selected .emergency-reason-icon {
    background: var(--error-red);
    color: var(--white);
}

.emergency-reason-text {
    flex: 1;
    font-weight: 500;
    color: var(--dark-gray);
}

.emergency-stations {
    margin: 14px 0;
    max-height: 180px;
    overflow-y: auto;
}

.emergency-station {
    padding: 10px;
    border: 2px solid var(--border-color);
    border-radius: var(--element-radius);
    margin-bottom: 6px;
    cursor: pointer;
    transition: all var(--transition-speed) ease;
}

.emergency-station:hover {
    border-color: var(--primary-orange);
    background: var(--light-orange);
}

.emergency-station.selected {
    border-color: var(--primary-orange);
    background: var(--light-orange);
}

.station-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 3px;
}

.station-name {
    font-weight: 600;
    font-size: 12px;
    color: var(--dark-gray);
}

.station-distance {
    font-size: 10px;
    color: var(--text-gray);
}

.station-address {
    font-size: 11px;
    color: var(--text-gray);
    line-height: 1.2;
}

.station-details {
    margin-top: 4px;
    font-size: 10px;
    color: var(--text-light);
    display: flex;
    gap: 8px;
}

.search-results-container {
    position: relative;
    z-index: 1001;
}

.search-result-item {
    padding: 10px 14px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    display: flex;
    align-items: flex-start;
    gap: 10px;
}

.search-result-item:hover {
    background: var(--light-orange);
}

.search-result-icon {
    color: var(--primary-orange);
    font-size: 14px;
    margin-top: 2px;
}

.search-result-content {
    flex: 1;
}

.search-result-title {
    font-weight: 600;
    font-size: 12px;
    color: var(--dark-gray);
    margin-bottom: 1px;
}

.search-result-subtitle {
    font-size: 11px;
    color: var(--text-gray);
    margin-bottom: 1px;
}

.search-result-details {
    display: flex;
    justify-content: space-between;
    font-size: 10px;
    color: var(--text-light);
}

.city-detection {
    position: absolute;
    top: 56px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 150;
    background: var(--white);
    padding: 6px 14px;
    border-radius: var(--button-radius);
    box-shadow: var(--shadow-heavy);
    border: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    font-weight: 500;
    color: var(--dark-gray);
}

.city-detection i {
    color: var(--primary-orange);
}

.notifications-panel {
    position: absolute;
    top: 52px;
    right: var(--app-padding);
    z-index: 250;
    width: 280px;
    max-width: calc(100vw - 40px);
    background: var(--white);
    border-radius: var(--card-radius);
    box-shadow: var(--shadow-heavy);
    display: none;
    flex-direction: column;
    overflow: hidden;
    border: 1px solid var(--border-color);
}

.notifications-panel.active {
    display: flex;
    animation: slideDown 0.3s ease;
}

.notifications-header {
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
    color: var(--white);
    padding: 12px;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.notifications-title {
    font-weight: 600;
    font-size: 12px;
}

.notifications-close {
    background: none;
    border: none;
    color: var(--white);
    font-size: 14px;
    cursor: pointer;
    padding: 3px;
    border-radius: 4px;
    transition: all var(--transition-speed) ease;
}

.notifications-close:hover {
    background: rgba(255, 255, 255, 0.2);
}

.notifications-list {
    flex: 1;
    max-height: 250px;
    overflow-y: auto;
    background: var(--off-white);
}

.notification-item {
    padding: 12px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
}

.notification-item:hover {
    background: var(--white);
}

.notification-item.unread {
    background: var(--light-orange);
}

.notification-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 4px;
}

.notification-title {
    font-weight: 600;
    font-size: 12px;
    color: var(--dark-gray);
    display: flex;
    align-items: center;
    gap: 5px;
}

.notification-time {
    font-size: 10px;
    color: var(--text-light);
}

.notification-message {
    font-size: 11px;
    color: var(--text-gray);
    line-height: 1.2;
}

.notification-actions {
    margin-top: 6px;
    display: flex;
    gap: 6px;
}

.notification-action-btn {
    padding: 3px 6px;
    font-size: 10px;
    border-radius: 10px;
    border: 1px solid var(--border-color);
    background: var(--white);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
}

.notification-action-btn:hover {
    background: var(--primary-orange);
    color: var(--white);
    border-color: var(--primary-orange);
}

.dropdown-menu {
    position: absolute;
    top: 56px;
    right: var(--app-padding);
    z-index: 250;
    width: 180px;
    background: var(--white);
    border-radius: var(--element-radius);
    box-shadow: var(--shadow-heavy);
    display: none;
    flex-direction: column;
    overflow: hidden;
    border: 1px solid var(--border-color);
}

.dropdown-menu.active {
    display: flex;
    animation: slideDown 0.3s ease;
}

.dropdown-item {
    padding: 10px 14px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    color: var(--dark-gray);
}

.dropdown-item:hover {
    background: var(--light-orange);
    color: var(--primary-orange);
}

.dropdown-item:last-child {
    border-bottom: none;
}

.dropdown-item i {
    width: 16px;
    text-align: center;
}

.more-options-menu {
    position: absolute;
    bottom: 180px;
    left: var(--app-padding);
    z-index: 250;
    width: 180px;
    background: var(--white);
    border-radius: var(--element-radius);
    box-shadow: var(--shadow-heavy);
    display: none;
    flex-direction: column;
    overflow: hidden;
    border: 1px solid var(--border-color);
}

.more-options-menu.active {
    display: flex;
    animation: slideUp 0.3s ease;
}

.emergency-modal-content {
    max-height: 65vh;
    overflow-y: auto;
}

.emergency-reason-input {
    margin-top: 8px;
}

.emergency-reason-input textarea {
    width: 100%;
    padding: 8px;
    border: 1px solid var(--border-color);
    border-radius: var(--element-radius);
    font-size: 12px;
    resize: vertical;
    min-height: 70px;
}

.real-time-indicator {
    position: fixed;
    bottom: 8px;
    right: 8px;
    z-index: 1000;
    background: var(--success-green);
    color: var(--white);
    padding: 4px 10px;
    border-radius: var(--button-radius);
    font-size: 10px;
    font-weight: 600;
    display: none;
    align-items: center;
    gap: 5px;
    box-shadow: var(--shadow-medium);
}

.real-time-indicator.active {
    display: flex;
    animation: fadeIn 0.3s ease;
}

.chat-typing-indicator {
    font-size: 10px;
    color: var(--text-light);
    font-style: italic;
    padding: 3px 10px;
    display: none;
}

.chat-typing-indicator.active {
    display: block;
}

.chat-attachment-btn {
    background: none;
    border: none;
    color: var(--text-light);
    font-size: 14px;
    cursor: pointer;
    padding: 3px;
    border-radius: 4px;
    transition: all var(--transition-speed) ease;
}

.chat-attachment-btn:hover {
    color: var(--primary-orange);
    background: var(--light-orange);
}

.search-bar-container {
    position: relative;
    margin-bottom: 10px;
}

.search-bar {
    width: 100%;
    padding: 10px 14px 10px 36px;
    border: 2px solid var(--border-color);
    border-radius: var(--button-radius);
    font-size: 12px;
    transition: all var(--transition-speed) ease;
}

.search-bar:focus {
    border-color: var(--primary-orange);
    box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
}

.search-bar-icon {
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-light);
}

.price-calculator-display {
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
    color: var(--white);
    padding: 14px;
    border-radius: var(--element-radius);
    margin: 14px 0;
    box-shadow: var(--shadow-medium);
}

.price-breakdown {
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
}

.price-breakdown-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 3px;
    font-size: 11px;
    opacity: 0.9;
}

.price-breakdown-row.total {
    margin-top: 6px;
    padding-top: 6px;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    font-weight: 700;
    font-size: 12px;
}

.map-controls {
    position: absolute;
    top: 90px;
    right: var(--app-padding);
    z-index: 100;
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.map-control-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: var(--white);
    border: 1px solid var(--border-color);
    box-shadow: var(--shadow-medium);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--dark-gray);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
}

.map-control-btn:hover {
    background: var(--primary-orange);
    color: var(--white);
    transform: scale(1.1);
}

.tracking-info {
    background: var(--white);
    border-radius: var(--element-radius);
    padding: 10px;
    margin: 10px 0;
    box-shadow: var(--shadow-light);
    border: 1px solid var(--border-color);
}

.tracking-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 6px;
}

.tracking-title {
    font-weight: 600;
    font-size: 12px;
    color: var(--dark-gray);
}

.tracking-distance {
    font-size: 11px;
    color: var(--primary-orange);
    font-weight: 600;
}

.tracking-progress {
    height: 4px;
    background: var(--light-gray);
    border-radius: 2px;
    overflow: hidden;
    margin-bottom: 6px;
}

.tracking-progress-bar {
    height: 100%;
    background: var(--primary-orange);
    border-radius: 2px;
    transition: width 0.3s ease;
}

.tracking-details {
    display: flex;
    justify-content: space-between;
    font-size: 10px;
    color: var(--text-gray);
}

.broadcast-feature {
    background: var(--white);
    border-radius: var(--element-radius);
    padding: 14px;
    margin: 14px 0;
    box-shadow: var(--shadow-medium);
    border: 1px solid var(--border-color);
}

.broadcast-feature-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 10px;
}

.broadcast-feature-title {
    font-size: 13px;
    font-weight: 700;
    color: var(--dark-gray);
    display: flex;
    align-items: center;
    gap: 6px;
}

.broadcast-status-indicator {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--success-green);
    animation: pulse 1.5s infinite;
}

.broadcast-status-indicator.inactive {
    background: var(--text-light);
    animation: none;
}

.broadcast-recipients {
    max-height: 130px;
    overflow-y: auto;
    margin-bottom: 10px;
}

.broadcast-recipient {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 6px;
    border-bottom: 1px solid var(--border-color);
}

.broadcast-recipient:last-child {
    border-bottom: none;
}

.recipient-info {
    display: flex;
    align-items: center;
    gap: 6px;
}

.recipient-avatar {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: var(--light-orange);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary-orange);
    font-weight: 600;
    font-size: 11px;
}

.recipient-name {
    font-weight: 600;
    font-size: 12px;
    color: var(--dark-gray);
}

.recipient-status {
    font-size: 10px;
    padding: 2px 5px;
    border-radius: 10px;
}

.status-joined {
    background: #E8F6EF;
    color: var(--success-green);
}

.status-pending {
    background: #FFF3E0;
    color: var(--warning-yellow);
}

.location-details {
    background: var(--off-white);
    border-radius: var(--element-radius);
    padding: 12px;
    margin: 10px 0;
}

.location-detail-item {
    display: flex;
    align-items: flex-start;
    gap: 8px;
    margin-bottom: 8px;
}

.location-detail-item:last-child {
    margin-bottom: 0;
}

.location-detail-icon {
    color: var(--primary-orange);
    font-size: 13px;
    margin-top: 2px;
}

.location-detail-content {
    flex: 1;
}

.location-detail-label {
    font-size: 10px;
    color: var(--text-light);
    margin-bottom: 1px;
}

.location-detail-value {
    font-size: 12px;
    color: var(--dark-gray);
    font-weight: 500;
    line-height: 1.2;
}

.emergency-contact-display {
    background: var(--light-red);
    border-radius: var(--element-radius);
    padding: 12px;
    margin: 10px 0;
    border-left: 3px solid var(--error-red);
}

.emergency-contact-header {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 6px;
}

.emergency-contact-title {
    font-weight: 600;
    font-size: 12px;
    color: var(--dark-gray);
}

.emergency-contact-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 0;
    border-bottom: 1px solid rgba(231, 76, 60, 0.1);
}

.emergency-contact-item:last-child {
    border-bottom: none;
}

.contact-info {
    display: flex;
    align-items: center;
    gap: 6px;
}

.contact-name {
    font-weight: 600;
    font-size: 12px;
    color: var(--dark-gray);
}

.contact-phone {
    font-size: 11px;
    color: var(--text-gray);
}

.contact-action-btn {
    padding: 3px 6px;
    font-size: 10px;
    border-radius: 10px;
    background: var(--white);
    border: 1px solid var(--error-red);
    color: var(--error-red);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
}

.contact-action-btn:hover {
    background: var(--error-red);
    color: var(--white);
}

.service-type-indicator {
    display: inline-flex;
    align-items: center;
    gap: 3px;
    padding: 3px 6px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
}

.indicator-car {
    background: var(--light-orange);
    color: var(--primary-orange);
}

.indicator-delivery {
    background: #F4E6FA;
    color: var(--delivery-purple);
}

.indicator-truck {
    background: rgba(139, 69, 19, 0.1);
    color: var(--light-truck-brown);
}

.indicator-emergency {
    background: var(--light-red);
    color: var(--error-red);
}

.indicator-shopping {
    background: #E1F5FE;
    color: var(--express-shop-green);
}

.price-update-animation {
    animation: priceUpdate 0.5s ease;
}

@keyframes priceUpdate {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.sync-indicator {
    position: fixed;
    bottom: 8px;
    left: 8px;
    z-index: 1000;
    background: var(--info-blue);
    color: var(--white);
    padding: 4px 10px;
    border-radius: var(--button-radius);
    font-size: 10px;
    font-weight: 600;
    display: none;
    align-items: center;
    gap: 5px;
    box-shadow: var(--shadow-medium);
}

.sync-indicator.active {
    display: flex;
    animation: fadeIn 0.3s ease;
}

.sync-indicator.syncing .sync-icon {
    animation: spin 1s linear infinite;
}

.distance-display {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    background: var(--light-orange);
    border-radius: var(--element-radius);
    font-size: 11px;
    color: var(--dark-gray);
}

.distance-value {
    font-weight: 700;
    color: var(--primary-orange);
}

.eta-display {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    background: var(--light-gray);
    border-radius: var(--element-radius);
    font-size: 11px;
    color: var(--dark-gray);
}

.eta-value {
    font-weight: 700;
    color: var(--info-blue);
}

.search-history {
    margin-top: 6px;
    max-height: 130px;
    overflow-y: auto;
}

.search-history-item {
    padding: 8px 10px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    display: flex;
    align-items: center;
    gap: 6px;
}

.search-history-item:hover {
    background: var(--light-orange);
}

.search-history-icon {
    color: var(--text-light);
    font-size: 11px;
}

.search-history-text {
    flex: 1;
    font-size: 12px;
    color: var(--dark-gray);
}

.search-history-time {
    font-size: 10px;
    color: var(--text-light);
}

.broadcast-notification {
    background: var(--info-blue);
    color: var(--white);
    padding: 10px;
    border-radius: var(--element-radius);
    margin: 10px 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.broadcast-notification-content {
    flex: 1;
}

.broadcast-notification-title {
    font-weight: 600;
    font-size: 12px;
    margin-bottom: 3px;
}

.broadcast-notification-message {
    font-size: 11px;
    opacity: 0.9;
}

.broadcast-notification-actions {
    display: flex;
    gap: 6px;
}

.map-loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.9);
    z-index: 2;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 10px;
}

.map-loading-text {
    font-size: 13px;
    font-weight: 600;
    color: var(--dark-gray);
}

.error-display {
    background: var(--light-red);
    border-radius: var(--element-radius);
    padding: 12px;
    margin: 10px 0;
    border-left: 3px solid var(--error-red);
}

.error-title {
    font-weight: 600;
    font-size: 12px;
    color: var(--error-red);
    margin-bottom: 4px;
    display: flex;
    align-items: center;
    gap: 5px;
}

.error-message {
    font-size: 11px;
    color: var(--dark-gray);
    line-height: 1.2;
}

.success-display {
    background: #E8F6EF;
    border-radius: var(--element-radius);
    padding: 12px;
    margin: 10px 0;
    border-left: 3px solid var(--success-green);
}

.success-title {
    font-weight: 600;
    font-size: 12px;
    color: var(--success-green);
    margin-bottom: 4px;
    display: flex;
    align-items: center;
    gap: 5px;
}

.success-message {
    font-size: 11px;
    color: var(--dark-gray);
    line-height: 1.2;
}

.warning-display {
    background: #FFF3E0;
    border-radius: var(--element-radius);
    padding: 12px;
    margin: 10px 0;
    border-left: 3px solid var(--warning-yellow);
}

.warning-title {
    font-weight: 600;
    font-size: 12px;
    color: var(--warning-yellow);
    margin-bottom: 4px;
    display: flex;
    align-items: center;
    gap: 5px;
}

.warning-message {
    font-size: 11px;
    color: var(--dark-gray);
    line-height: 1.2;
}

.route-instructions-panel {
    position: absolute;
    top: 110px;
    right: var(--app-padding);
    z-index: 150;
    background: var(--white);
    border-radius: var(--element-radius);
    padding: 10px;
    box-shadow: var(--shadow-heavy);
    border: 1px solid var(--border-color);
    max-width: 200px;
    display: none;
    animation: slideInRight 0.3s ease;
}

.route-instructions-panel.active {
    display: block;
}

.route-instruction {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px;
    border-bottom: 1px solid var(--border-color);
    font-size: 11px;
}

.route-instruction:last-child {
    border-bottom: none;
}

.route-instruction-icon {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: var(--light-orange);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary-orange);
    font-size: 10px;
}

.route-instruction-text {
    flex: 1;
    color: var(--dark-gray);
}

.route-instruction-distance {
    font-size: 10px;
    color: var(--text-gray);
    font-weight: 600;
}

/* ENHANCED SEARCH SUGGESTIONS STYLES */
.search-results-dropdown {
    position: absolute !important;
    top: 100% !important;
    left: 0 !important;
    right: 0 !important;
    background: var(--white) !important;
    border: 1px solid var(--border-color) !important;
    border-radius: var(--element-radius) !important;
    box-shadow: var(--shadow-heavy) !important;
    z-index: 1001 !important;
    max-height: 300px !important;
    overflow-y: auto !important;
    display: none !important;
    margin-top: 5px !important;
    animation: slideDown 0.2s ease !important;
}

.search-results-dropdown.active {
    display: block !important;
}

.search-result-item {
    padding: 12px 16px !important;
    border-bottom: 1px solid var(--border-color) !important;
    cursor: pointer !important;
    transition: all var(--transition-speed) ease !important;
    display: flex !important;
    align-items: flex-start !important;
    gap: 12px !important;
    background: var(--white) !important;
}

.search-result-item:hover {
    background: var(--light-orange) !important;
    transform: translateX(2px) !important;
}

.search-result-item:last-child {
    border-bottom: none !important;
}

.search-result-icon {
    width: 32px !important;
    height: 32px !important;
    border-radius: 8px !important;
    background: var(--light-orange) !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    color: var(--primary-orange) !important;
    font-size: 14px !important;
    flex-shrink: 0 !important;
    margin-top: 2px !important;
}

.search-result-icon.pickup {
    background: var(--light-orange) !important;
    color: var(--primary-orange) !important;
}

.search-result-icon.destination {
    background: var(--light-red) !important;
    color: var(--primary-red) !important;
}

.search-result-content {
    flex: 1 !important;
    min-width: 0 !important;
}

.search-result-title {
    font-weight: 600 !important;
    font-size: 13px !important;
    color: var(--dark-gray) !important;
    margin-bottom: 3px !important;
    line-height: 1.2 !important;
    display: flex !important;
    align-items: center !important;
    gap: 5px !important;
}

.search-result-verified {
    color: var(--success-green) !important;
    font-size: 10px !important;
}

.search-result-address {
    font-size: 11px !important;
    color: var(--text-gray) !important;
    line-height: 1.3 !important;
    margin-bottom: 4px !important;
    display: -webkit-box !important;
    -webkit-line-clamp: 2 !important;
    -webkit-box-orient: vertical !important;
    overflow: hidden !important;
}

.search-result-details {
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    font-size: 10px !important;
}

.search-result-distance {
    color: var(--primary-orange) !important;
    font-weight: 600 !important;
    background: rgba(255, 107, 53, 0.1) !important;
    padding: 2px 6px !important;
    border-radius: 8px !important;
}

.search-result-type {
    color: var(--text-light) !important;
    text-transform: capitalize !important;
}

.search-result-category {
    display: inline-flex !important;
    align-items: center !important;
    gap: 3px !important;
    padding: 2px 6px !important;
    border-radius: 8px !important;
    font-size: 9px !important;
    font-weight: 600 !important;
    text-transform: uppercase !important;
    letter-spacing: 0.3px !important;
}

.search-result-category.restaurant {
    background: #FFF3E0 !important;
    color: #E67E22 !important;
}

.search-result-category.hotel {
    background: #E3F2FD !important;
    color: #2980B9 !important;
}

.search-result-category.shopping {
    background: #F3E5F5 !important;
    color: #8E44AD !important;
}

.search-result-category.medical {
    background: #FFEBEE !important;
    color: #C0392B !important;
}

.search-result-category.education {
    background: #E8F5E9 !important;
    color: #27AE60 !important;
}

.search-result-category.government {
    background: #F5F5F5 !important;
    color: #2C3E50 !important;
}

/* Search Header */
.search-header {
    padding: 12px 16px !important;
    border-bottom: 1px solid var(--border-color) !important;
    background: var(--off-white) !important;
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    font-size: 11px !important;
    color: var(--text-gray) !important;
}

.search-count {
    font-weight: 600 !important;
    color: var(--primary-orange) !important;
}

.search-city {
    display: flex !important;
    align-items: center !important;
    gap: 4px !important;
}

/* No Results */
.search-no-results {
    padding: 30px 20px !important;
    text-align: center !important;
    color: var(--text-light) !important;
}

.search-no-results-icon {
    font-size: 32px !important;
    margin-bottom: 10px !important;
    color: var(--medium-gray) !important;
}

.search-no-results-title {
    font-weight: 600 !important;
    font-size: 13px !important;
    color: var(--text-gray) !important;
    margin-bottom: 5px !important;
}

.search-no-results-message {
    font-size: 11px !important;
    line-height: 1.4 !important;
}

/* Search Loading */
.search-loading-overlay {
    padding: 20px !important;
    text-align: center !important;
    color: var(--text-light) !important;
}

.search-loading-spinner {
    width: 20px !important;
    height: 20px !important;
    border: 2px solid var(--light-gray) !important;
    border-radius: 50% !important;
    border-top-color: var(--primary-orange) !important;
    animation: spin 0.8s linear infinite !important;
    margin: 0 auto 10px !important;
}

/* Recent Searches */
.recent-searches-section {
    padding: 12px 0 !important;
    border-bottom: 1px solid var(--border-color) !important;
}

.recent-searches-title {
    padding: 0 16px 8px !important;
    font-size: 11px !important;
    color: var(--text-light) !important;
    font-weight: 600 !important;
    text-transform: uppercase !important;
    letter-spacing: 0.5px !important;
}

.recent-search-item {
    padding: 10px 16px !important;
    display: flex !important;
    align-items: center !important;
    gap: 10px !important;
    cursor: pointer !important;
    transition: all var(--transition-speed) ease !important;
}

.recent-search-item:hover {
    background: var(--light-orange) !important;
}

.recent-search-icon {
    width: 28px !important;
    height: 28px !important;
    border-radius: 6px !important;
    background: var(--light-gray) !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    color: var(--text-gray) !important;
    font-size: 12px !important;
}

.recent-search-content {
    flex: 1 !important;
}

.recent-search-name {
    font-weight: 500 !important;
    font-size: 12px !important;
    color: var(--dark-gray) !important;
    margin-bottom: 2px !important;
}

.recent-search-address {
    font-size: 10px !important;
    color: var(--text-gray) !important;
    line-height: 1.2 !important;
    display: -webkit-box !important;
    -webkit-line-clamp: 1 !important;
    -webkit-box-orient: vertical !important;
    overflow: hidden !important;
}

.recent-search-time {
    font-size: 9px !important;
    color: var(--text-light) !important;
}

/* Search Input Enhancements */
.location-input.with-suggestions {
    position: relative !important;
}

.location-input.with-suggestions input {
    padding-right: 40px !important;
}

.location-clear-btn {
    position: absolute !important;
    right: 35px !important;
    top: 50% !important;
    transform: translateY(-50%) !important;
    background: none !important;
    border: none !important;
    color: var(--text-light) !important;
    font-size: 14px !important;
    cursor: pointer !important;
    padding: 4px !important;
    border-radius: 4px !important;
    display: none !important;
    transition: all var(--transition-speed) ease !important;
}

.location-input input:not(:placeholder-shown) ~ .location-clear-btn {
    display: block !important;
}

.location-clear-btn:hover {
    color: var(--error-red) !important;
    background: var(--light-red) !important;
}

/* Enhanced Map Controls */
.map-controls-enhanced {
    position: absolute !important;
    top: 100px !important;
    right: var(--app-padding) !important;
    z-index: 100 !important;
    display: flex !important;
    flex-direction: column !important;
    gap: 8px !important;
    background: var(--white) !important;
    padding: 8px !important;
    border-radius: var(--element-radius) !important;
    box-shadow: var(--shadow-heavy) !important;
    border: 1px solid var(--border-color) !important;
}

.map-control-btn-enhanced {
    width: 40px !important;
    height: 40px !important;
    border-radius: var(--element-radius) !important;
    background: var(--white) !important;
    border: 1px solid var(--border-color) !important;
    box-shadow: var(--shadow-light) !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    color: var(--dark-gray) !important;
    cursor: pointer !important;
    transition: all var(--transition-speed) ease !important;
    position: relative !important;
}

.map-control-btn-enhanced:hover {
    background: var(--primary-orange) !important;
    color: var(--white) !important;
    transform: translateY(-2px) !important;
    box-shadow: var(--shadow-medium) !important;
}

.map-control-btn-enhanced.active {
    background: var(--primary-orange) !important;
    color: var(--white) !important;
    border-color: var(--primary-orange) !important;
}

.map-control-tooltip {
    position: absolute !important;
    right: 120% !important;
    top: 50% !important;
    transform: translateY(-50%) !important;
    background: var(--dark-gray) !important;
    color: var(--white) !important;
    padding: 6px 10px !important;
    border-radius: var(--element-radius) !important;
    font-size: 11px !important;
    font-weight: 500 !important;
    white-space: nowrap !important;
    opacity: 0 !important;
    pointer-events: none !important;
    transition: opacity var(--transition-speed) ease !important;
}

.map-control-btn-enhanced:hover .map-control-tooltip {
    opacity: 1 !important;
}

/* Enhanced Toast Notifications */
.toast-container-enhanced {
    position: fixed !important;
    top: 80px !important;
    right: var(--app-padding) !important;
    z-index: 10000 !important;
    display: flex !important;
    flex-direction: column !important;
    gap: 8px !important;
    max-width: 320px !important;
}

.toast-enhanced {
    background: var(--white) !important;
    border-radius: var(--element-radius) !important;
    padding: 14px !important;
    box-shadow: var(--shadow-heavy) !important;
    border-left: 4px solid var(--primary-orange) !important;
    display: flex !important;
    align-items: flex-start !important;
    gap: 10px !important;
    animation: slideInRight 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55) !important;
    transform: translateX(0) !important;
    transition: transform 0.3s ease, opacity 0.3s ease !important;
    opacity: 1 !important;
}

.toast-enhanced.hiding {
    transform: translateX(120%) !important;
    opacity: 0 !important;
}

.toast-enhanced.success {
    border-left-color: var(--success-green) !important;
}

.toast-enhanced.error {
    border-left-color: var(--error-red) !important;
}

.toast-enhanced.warning {
    border-left-color: var(--warning-yellow) !important;
}

.toast-enhanced.info {
    border-left-color: var(--info-blue) !important;
}

.toast-icon-enhanced {
    width: 20px !important;
    height: 20px !important;
    border-radius: 50% !important;
    background: var(--light-orange) !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    color: var(--primary-orange) !important;
    font-size: 10px !important;
    flex-shrink: 0 !important;
}

.toast-enhanced.success .toast-icon-enhanced {
    background: #E8F6EF !important;
    color: var(--success-green) !important;
}

.toast-enhanced.error .toast-icon-enhanced {
    background: var(--light-red) !important;
    color: var(--error-red) !important;
}

.toast-enhanced.warning .toast-icon-enhanced {
    background: #FFF3E0 !important;
    color: var(--warning-yellow) !important;
}

.toast-enhanced.info .toast-icon-enhanced {
    background: #E3F2FD !important;
    color: var(--info-blue) !important;
}

.toast-content-enhanced {
    flex: 1 !important;
    min-width: 0 !important;
}

.toast-title-enhanced {
    font-weight: 700 !important;
    font-size: 12px !important;
    color: var(--dark-gray) !important;
    margin-bottom: 3px !important;
}

.toast-message-enhanced {
    font-size: 11px !important;
    color: var(--text-gray) !important;
    line-height: 1.3 !important;
}

.toast-close-enhanced {
    background: none !important;
    border: none !important;
    color: var(--text-light) !important;
    font-size: 14px !important;
    cursor: pointer !important;
    padding: 2px !important;
    border-radius: 4px !important;
    transition: all var(--transition-speed) ease !important;
    flex-shrink: 0 !important;
}

.toast-close-enhanced:hover {
    color: var(--error-red) !important;
    background: var(--light-red) !important;
}

.toast-progress-bar {
    position: absolute !important;
    bottom: 0 !important;
    left: 0 !important;
    right: 0 !important;
    height: 3px !important;
    background: var(--light-gray) !important;
    border-radius: 0 0 var(--element-radius) var(--element-radius) !important;
    overflow: hidden !important;
}

.toast-progress {
    height: 100% !important;
    background: var(--primary-orange) !important;
    width: 100% !important;
    animation: progressBar linear forwards !important;
}

.toast-enhanced.success .toast-progress {
    background: var(--success-green) !important;
}

.toast-enhanced.error .toast-progress {
    background: var(--error-red) !important;
}

.toast-enhanced.warning .toast-progress {
    background: var(--warning-yellow) !important;
}

.toast-enhanced.info .toast-progress {
    background: var(--info-blue) !important;
}

@keyframes progressBar {
    from { width: 100%; }
    to { width: 0%; }
}

/* Enhanced Loading States */
.loading-overlay-enhanced {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    background: rgba(255, 255, 255, 0.95) !important;
    z-index: 10000 !important;
    display: none !important;
    flex-direction: column !important;
    align-items: center !important;
    justify-content: center !important;
    gap: 16px !important;
    backdrop-filter: blur(5px) !important;
}

.loading-overlay-enhanced.active {
    display: flex !important;
    animation: fadeIn 0.3s ease !important;
}

.loading-spinner-enhanced {
    width: 56px !important;
    height: 56px !important;
    border: 3px solid var(--light-gray) !important;
    border-radius: 50% !important;
    border-top-color: var(--primary-orange) !important;
    animation: spin 1s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite !important;
}

.loading-text-enhanced {
    font-size: 14px !important;
    font-weight: 600 !important;
    color: var(--dark-gray) !important;
    text-align: center !important;
}

.loading-subtext {
    font-size: 12px !important;
    color: var(--text-gray) !important;
    text-align: center !important;
    max-width: 250px !important;
    line-height: 1.4 !important;
}

/* Enhanced Ride Request Animation */
.ride-request-pulsing {
    animation: rideRequestPulse 2s infinite !important;
}

@keyframes rideRequestPulse {
    0% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(255, 107, 53, 0.7);
    }
    70% {
        transform: scale(1.05);
        box-shadow: 0 0 0 15px rgba(255, 107, 53, 0);
    }
    100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(255, 107, 53, 0);
    }
}

.ride-type-card.pulsing {
    animation: cardPulse 1.5s infinite !important;
}

@keyframes cardPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.02); }
    100% { transform: scale(1); }
}

/* Enhanced Driver Tracking */
.driver-tracking-container {
    background: var(--white) !important;
    border-radius: var(--element-radius) !important;
    padding: 12px !important;
    margin-bottom: 12px !important;
    box-shadow: var(--shadow-medium) !important;
    border: 1px solid var(--border-color) !important;
}

.driver-tracking-header {
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    margin-bottom: 10px !important;
}

.driver-tracking-title {
    font-weight: 700 !important;
    font-size: 12px !important;
    color: var(--dark-gray) !important;
    display: flex !important;
    align-items: center !important;
    gap: 6px !important;
}

.driver-tracking-distance {
    font-size: 13px !important;
    font-weight: 800 !important;
    color: var(--primary-orange) !important;
}

.driver-tracking-progress-container {
    height: 6px !important;
    background: var(--light-gray) !important;
    border-radius: 3px !important;
    overflow: hidden !important;
    margin-bottom: 8px !important;
    position: relative !important;
}

.driver-tracking-progress {
    height: 100% !important;
    background: linear-gradient(90deg, var(--primary-orange), var(--primary-red)) !important;
    border-radius: 3px !important;
    transition: width 0.5s ease !important;
    position: relative !important;
    overflow: hidden !important;
}

.driver-tracking-progress::after {
    content: '' !important;
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    background: linear-gradient(90deg, 
        transparent, 
        rgba(255, 255, 255, 0.4), 
        transparent
    ) !important;
    animation: shimmer 2s infinite !important;
}

@keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

.driver-tracking-details {
    display: flex !important;
    justify-content: space-between !important;
    font-size: 11px !important;
    color: var(--text-gray) !important;
}

.driver-tracking-eta {
    font-weight: 600 !important;
    color: var(--info-blue) !important;
}

/* Enhanced Chat Interface */
.chat-messages-enhanced {
    flex: 1 !important;
    padding: 12px !important;
    max-height: 250px !important;
    overflow-y: auto !important;
    background: var(--off-white) !important;
    display: flex !important;
    flex-direction: column !important;
    gap: 10px !important;
    scroll-behavior: smooth !important;
}

.message-enhanced {
    max-width: 80% !important;
    padding: 10px 14px !important;
    border-radius: 18px !important;
    font-size: 13px !important;
    line-height: 1.4 !important;
    position: relative !important;
    word-wrap: break-word !important;
    animation: messageSlide 0.3s ease !important;
}

@keyframes messageSlide {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.message-enhanced.sent {
    align-self: flex-end !important;
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-red)) !important;
    color: var(--white) !important;
    border-bottom-right-radius: 5px !important;
}

.message-enhanced.received {
    align-self: flex-start !important;
    background: var(--white) !important;
    color: var(--dark-gray) !important;
    border: 1px solid var(--border-color) !important;
    border-bottom-left-radius: 5px !important;
}

.message-sender {
    font-weight: 600 !important;
    font-size: 11px !important;
    margin-bottom: 3px !important;
    opacity: 0.8 !important;
}

.message-time-enhanced {
    font-size: 10px !important;
    color: rgba(255, 255, 255, 0.8) !important;
    margin-top: 4px !important;
    text-align: right !important;
}

.message-enhanced.received .message-time-enhanced {
    color: var(--text-light) !important;
}

.message-status {
    position: absolute !important;
    bottom: -12px !important;
    right: 5px !important;
    font-size: 10px !important;
    color: var(--text-light) !important;
}

.message-enhanced.sent .message-status {
    color: var(--primary-orange) !important;
}

.typing-indicator-enhanced {
    display: flex !important;
    align-items: center !important;
    gap: 4px !important;
    padding: 8px 12px !important;
    background: var(--white) !important;
    border-radius: 18px !important;
    align-self: flex-start !important;
    border: 1px solid var(--border-color) !important;
    animation: typingPulse 1.5s infinite !important;
}

@keyframes typingPulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

.typing-dots {
    display: flex !important;
    gap: 3px !important;
}

.typing-dot {
    width: 6px !important;
    height: 6px !important;
    background: var(--text-light) !important;
    border-radius: 50% !important;
    animation: typingDot 1.4s infinite !important;
}

.typing-dot:nth-child(1) { animation-delay: 0s; }
.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }

@keyframes typingDot {
    0%, 60%, 100% { transform: translateY(0); }
    30% { transform: translateY(-4px); }
}

/* Enhanced Notifications */
.notification-item-enhanced {
    padding: 14px !important;
    border-bottom: 1px solid var(--border-color) !important;
    cursor: pointer !important;
    transition: all var(--transition-speed) ease !important;
    position: relative !important;
}

.notification-item-enhanced:hover {
    background: var(--light-orange) !important;
    transform: translateX(2px) !important;
}

.notification-item-enhanced.unread {
    background: rgba(255, 107, 53, 0.05) !important;
    border-left: 3px solid var(--primary-orange) !important;
}

.notification-header-enhanced {
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    margin-bottom: 6px !important;
}

.notification-title-enhanced {
    font-weight: 700 !important;
    font-size: 12px !important;
    color: var(--dark-gray) !important;
    display: flex !important;
    align-items: center !important;
    gap: 6px !important;
}

.notification-time-enhanced {
    font-size: 10px !important;
    color: var(--text-light) !important;
}

.notification-message-enhanced {
    font-size: 11px !important;
    color: var(--text-gray) !important;
    line-height: 1.4 !important;
    margin-bottom: 6px !important;
}

.notification-actions-enhanced {
    display: flex !important;
    gap: 6px !important;
    margin-top: 8px !important;
}

.notification-action-btn-enhanced {
    padding: 5px 10px !important;
    font-size: 10px !important;
    border-radius: 12px !important;
    border: 1px solid var(--border-color) !important;
    background: var(--white) !important;
    cursor: pointer !important;
    transition: all var(--transition-speed) ease !important;
    font-weight: 600 !important;
}

.notification-action-btn-enhanced:hover {
    background: var(--primary-orange) !important;
    color: var(--white) !important;
    border-color: var(--primary-orange) !important;
    transform: translateY(-1px) !important;
}

.notification-unread-dot {
    position: absolute !important;
    top: 14px !important;
    left: -8px !important;
    width: 8px !important;
    height: 8px !important;
    background: var(--primary-orange) !important;
    border-radius: 50% !important;
    animation: pulse 2s infinite !important;
}

/* Enhanced Price Calculator */
.price-calculator-enhanced {
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-red)) !important;
    color: var(--white) !important;
    padding: 16px !important;
    border-radius: var(--element-radius) !important;
    margin: 16px 0 !important;
    box-shadow: var(--shadow-heavy) !important;
    animation: slideUp 0.3s ease !important;
}

.price-header {
    text-align: center !important;
    margin-bottom: 12px !important;
}

.price-label {
    font-size: 12px !important;
    opacity: 0.9 !important;
    margin-bottom: 2px !important;
}

.price-amount-enhanced {
    font-size: 28px !important;
    font-weight: 900 !important;
    margin: 4px 0 !important;
    letter-spacing: 0.5px !important;
}

.price-breakdown-enhanced {
    margin-top: 12px !important;
    padding-top: 12px !important;
    border-top: 1px solid rgba(255, 255, 255, 0.2) !important;
}

.price-row-enhanced {
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    padding: 6px 0 !important;
    font-size: 12px !important;
    opacity: 0.9 !important;
}

.price-row-enhanced:last-child {
    border-bottom: none !important;
}

.price-row-total {
    margin-top: 8px !important;
    padding-top: 8px !important;
    border-top: 2px solid rgba(255, 255, 255, 0.3) !important;
    font-weight: 700 !important;
    font-size: 14px !important;
    opacity: 1 !important;
}

.price-update {
    animation: priceUpdate 0.5s ease !important;
}

@keyframes priceUpdate {
    0% { transform: scale(1); }
    50% { transform: scale(1.02); }
    100% { transform: scale(1); }
}

/* Enhanced Emergency Services */
.emergency-service-enhanced {
    background: var(--white) !important;
    border: 2px solid transparent !important;
    border-radius: var(--element-radius) !important;
    padding: 16px !important;
    text-align: center !important;
    cursor: pointer !important;
    transition: all var(--transition-speed) ease !important;
    position: relative !important;
    overflow: hidden !important;
}

.emergency-service-enhanced::before {
    content: '' !important;
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    background: linear-gradient(135deg, transparent, rgba(255, 255, 255, 0.1), transparent) !important;
    transform: translateX(-100%) !important;
    transition: transform 0.6s ease !important;
}

.emergency-service-enhanced:hover::before {
    transform: translateX(100%) !important;
}

.emergency-service-enhanced:hover {
    transform: translateY(-4px) !important;
    box-shadow: var(--shadow-heavy) !important;
}

.emergency-service-enhanced.police {
    border-color: var(--police-blue) !important;
}

.emergency-service-enhanced.police:hover {
    background: linear-gradient(135deg, rgba(44, 62, 80, 0.1), rgba(44, 62, 80, 0.05)) !important;
}

.emergency-service-enhanced.fire {
    border-color: var(--fire-truck-red) !important;
}

.emergency-service-enhanced.fire:hover {
    background: linear-gradient(135deg, rgba(192, 57, 43, 0.1), rgba(192, 57, 43, 0.05)) !important;
}

.emergency-service-enhanced.medical {
    border-color: var(--ambulance-blue) !important;
}

.emergency-service-enhanced.medical:hover {
    background: linear-gradient(135deg, rgba(41, 128, 185, 0.1), rgba(41, 128, 185, 0.05)) !important;
}

.emergency-service-enhanced.sos {
    border-color: var(--error-red) !important;
}

.emergency-service-enhanced.sos:hover {
    background: linear-gradient(135deg, rgba(231, 76, 60, 0.1), rgba(231, 76, 60, 0.05)) !important;
}

.emergency-icon-enhanced {
    width: 56px !important;
    height: 56px !important;
    border-radius: 50% !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    font-size: 20px !important;
    margin: 0 auto 10px !important;
    color: var(--white) !important;
    position: relative !important;
    z-index: 1 !important;
    box-shadow: var(--shadow-medium) !important;
}

.emergency-service-enhanced.police .emergency-icon-enhanced {
    background: linear-gradient(135deg, var(--police-blue), #1a2530) !important;
}

.emergency-service-enhanced.fire .emergency-icon-enhanced {
    background: linear-gradient(135deg, var(--fire-truck-red), #922B21) !important;
}

.emergency-service-enhanced.medical .emergency-icon-enhanced {
    background: linear-gradient(135deg, var(--ambulance-blue), #1B4F72) !important;
}

.emergency-service-enhanced.sos .emergency-icon-enhanced {
    background: linear-gradient(135deg, var(--error-red), #C0392B) !important;
}

.emergency-name-enhanced {
    font-size: 14px !important;
    font-weight: 800 !important;
    color: var(--dark-gray) !important;
    margin-bottom: 6px !important;
    position: relative !important;
    z-index: 1 !important;
}

.emergency-description-enhanced {
    font-size: 12px !important;
    color: var(--text-gray) !important;
    line-height: 1.3 !important;
    position: relative !important;
    z-index: 1 !important;
}

/* Enhanced SOS Button */
.sos-button-enhanced {
    position: absolute !important;
    bottom: 160px !important;
    right: var(--app-padding) !important;
    z-index: 200 !important;
    width: 60px !important;
    height: 60px !important;
    background: linear-gradient(135deg, var(--error-red), #C0392B) !important;
    border-radius: 50% !important;
    display: none !important;
    align-items: center !important;
    justify-content: center !important;
    color: var(--white) !important;
    font-size: 16px !important;
    font-weight: 800 !important;
    box-shadow: 0 4px 20px rgba(231, 76, 60, 0.4) !important;
    cursor: pointer !important;
    transition: all var(--transition-speed) ease !important;
    animation: sosPulseEnhanced 2s infinite !important;
    border: 3px solid var(--white) !important;
}

.sos-button-enhanced.active {
    display: flex !important;
    animation: sosEmergency 1s infinite !important;
}

.sos-button-enhanced:hover {
    transform: scale(1.1) !important;
    box-shadow: 0 6px 25px rgba(231, 76, 60, 0.6) !important;
}

@keyframes sosPulseEnhanced {
    0%, 100% { 
        transform: scale(1);
        box-shadow: 0 4px 20px rgba(231, 76, 60, 0.4);
    }
    50% { 
        transform: scale(1.08);
        box-shadow: 0 6px 25px rgba(231, 76, 60, 0.6);
    }
}

@keyframes sosEmergency {
    0%, 100% { 
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7);
    }
    50% { 
        transform: scale(1.1);
        box-shadow: 0 0 0 20px rgba(231, 76, 60, 0);
    }
}

/* Enhanced Broadcast Feature */
.broadcast-feature-enhanced {
    background: var(--white) !important;
    border-radius: var(--element-radius) !important;
    padding: 16px !important;
    margin: 16px 0 !important;
    box-shadow: var(--shadow-heavy) !important;
    border: 2px solid var(--info-blue) !important;
    animation: slideUp 0.3s ease !important;
}

.broadcast-header-enhanced {
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important;
    margin-bottom: 12px !important;
}

.broadcast-title-enhanced {
    font-size: 14px !important;
    font-weight: 800 !important;
    color: var(--dark-gray) !important;
    display: flex !important;
    align-items: center !important;
    gap: 8px !important;
}

.broadcast-status-indicator-enhanced {
    width: 8px !important;
    height: 8px !important;
    border-radius: 50% !important;
    background: var(--success-green) !important;
    animation: broadcastPulse 1.5s infinite !important;
}

.broadcast-status-indicator-enhanced.inactive {
    background: var(--text-light) !important;
    animation: none !important;
}

@keyframes broadcastPulse {
    0% { 
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7);
    }
    70% { 
        transform: scale(1.2);
        box-shadow: 0 0 0 8px rgba(46, 204, 113, 0);
    }
    100% { 
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(46, 204, 113, 0);
    }
}

.broadcast-recipients-enhanced {
    max-height: 150px !important;
    overflow-y: auto !important;
    margin-bottom: 12px !important;
    border: 1px solid var(--border-color) !important;
    border-radius: var(--element-radius) !important;
    padding: 8px !important;
}

.broadcast-recipient-enhanced {
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important;
    padding: 10px !important;
    border-radius: var(--element-radius) !important;
    margin-bottom: 6px !important;
    background: var(--off-white) !important;
    transition: all var(--transition-speed) ease !important;
}

.broadcast-recipient-enhanced:hover {
    background: var(--light-orange) !important;
    transform: translateX(2px) !important;
}

.broadcast-recipient-enhanced:last-child {
    margin-bottom: 0 !important;
}

.recipient-info-enhanced {
    display: flex !important;
    align-items: center !important;
    gap: 10px !important;
}

.recipient-avatar-enhanced {
    width: 36px !important;
    height: 36px !important;
    border-radius: 50% !important;
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-red)) !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    color: var(--white) !important;
    font-weight: 700 !important;
    font-size: 14px !important;
    box-shadow: var(--shadow-light) !important;
}

.recipient-name-enhanced {
    font-weight: 700 !important;
    font-size: 13px !important;
    color: var(--dark-gray) !important;
}

.recipient-status-enhanced {
    font-size: 11px !important;
    padding: 4px 8px !important;
    border-radius: 12px !important;
    font-weight: 600 !important;
    text-transform: uppercase !important;
    letter-spacing: 0.5px !important;
}

.status-joined-enhanced {
    background: #E8F6EF !important;
    color: var(--success-green) !important;
}

.status-pending-enhanced {
    background: #FFF3E0 !important;
    color: var(--warning-yellow) !important;
    animation: statusPulse 2s infinite !important;
}

@keyframes statusPulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

/* Enhanced Ride Timeline */
.ride-timeline-enhanced {
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important;
    margin: 20px 0 !important;
    padding: 0 20px !important;
    position: relative !important;
}

.ride-timeline-enhanced::before {
    content: '' !important;
    position: absolute !important;
    top: 15px !important;
    left: 10% !important;
    right: 10% !important;
    height: 3px !important;
    background: var(--border-color) !important;
    z-index: 1 !important;
    border-radius: 2px !important;
}

.timeline-step-enhanced {
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    gap: 6px !important;
    position: relative !important;
    z-index: 2 !important;
    flex: 1 !important;
}

.step-dot-enhanced {
    width: 28px !important;
    height: 28px !important;
    border-radius: 50% !important;
    background: var(--light-gray) !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    color: var(--text-light) !important;
    font-size: 11px !important;
    border: 3px solid var(--white) !important;
    transition: all var(--transition-speed) ease !important;
    position: relative !important;
    box-shadow: var(--shadow-light) !important;
}

.step-dot-enhanced.active {
    background: var(--primary-orange) !important;
    color: var(--white) !important;
    transform: scale(1.2) !important;
    box-shadow: 0 4px 12px rgba(255, 107, 53, 0.4) !important;
}

.step-dot-enhanced.completed {
    background: var(--success-green) !important;
    color: var(--white) !important;
    transform: scale(1.1) !important;
}

.step-dot-enhanced.active::after {
    content: '' !important;
    position: absolute !important;
    top: -4px !important;
    left: -4px !important;
    right: -4px !important;
    bottom: -4px !important;
    border: 2px solid var(--primary-orange) !important;
    border-radius: 50% !important;
    animation: ripple 1.5s infinite !important;
}

@keyframes ripple {
    0% {
        transform: scale(1);
        opacity: 1;
    }
    100% {
        transform: scale(1.5);
        opacity: 0;
    }
}

.step-label-enhanced {
    font-size: 11px !important;
    color: var(--text-light) !important;
    text-align: center !important;
    font-weight: 500 !important;
    max-width: 60px !important;
    line-height: 1.2 !important;
}

.step-label-enhanced.active {
    color: var(--primary-orange) !important;
    font-weight: 700 !important;
}

/* Enhanced Map Markers */
.marker-pulse {
    position: relative !important;
}

.marker-pulse::before {
    content: '' !important;
    position: absolute !important;
    width: 100% !important;
    height: 100% !important;
    border-radius: 50% !important;
    background: inherit !important;
    animation: markerPulse 2s infinite !important;
    z-index: -1 !important;
}

@keyframes markerPulse {
    0% {
        transform: scale(1);
        opacity: 0.8;
    }
    100% {
        transform: scale(2);
        opacity: 0;
    }
}

.driver-marker-enhanced {
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-red)) !important;
    color: white !important;
    border-radius: 50% !important;
    width: 36px !important;
    height: 36px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    font-size: 14px !important;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3) !important;
    border: 3px solid white !important;
    animation: driverMove 3s infinite alternate !important;
}

@keyframes driverMove {
    0% {
        transform: translateY(0) rotate(0deg);
    }
    100% {
        transform: translateY(-5px) rotate(5deg);
    }
}

/* Enhanced Button Styles */
.btn-pulsing {
    animation: btnPulse 2s infinite !important;
}

@keyframes btnPulse {
    0%, 100% {
        transform: scale(1);
        box-shadow: 0 2px 8px rgba(255, 107, 53, 0.3);
    }
    50% {
        transform: scale(1.02);
        box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4);
    }
}

.btn-shimmer {
    position: relative !important;
    overflow: hidden !important;
}

.btn-shimmer::after {
    content: '' !important;
    position: absolute !important;
    top: -50% !important;
    left: -60% !important;
    width: 20% !important;
    height: 200% !important;
    background: linear-gradient(
        to right,
        transparent,
        rgba(255, 255, 255, 0.4),
        transparent
    ) !important;
    transform: rotate(30deg) !important;
    transition: left 0.7s ease !important;
}

.btn-shimmer:hover::after {
    left: 140% !important;
}

/* Enhanced Scrollbars */
.enhanced-scrollbar {
    scrollbar-width: thin !important;
    scrollbar-color: var(--primary-orange) var(--light-gray) !important;
}

.enhanced-scrollbar::-webkit-scrollbar {
    width: 6px !important;
    height: 6px !important;
}

.enhanced-scrollbar::-webkit-scrollbar-track {
    background: var(--light-gray) !important;
    border-radius: 3px !important;
}

.enhanced-scrollbar::-webkit-scrollbar-thumb {
    background: var(--primary-orange) !important;
    border-radius: 3px !important;
}

.enhanced-scrollbar::-webkit-scrollbar-thumb:hover {
    background: var(--secondary-orange) !important;
}

/* Enhanced Form Elements */
.form-control-enhanced {
    border: 2px solid var(--border-color) !important;
    border-radius: var(--element-radius) !important;
    padding: 12px !important;
    font-size: 13px !important;
    color: var(--dark-gray) !important;
    background: var(--white) !important;
    transition: all var(--transition-speed) ease !important;
    width: 100% !important;
}

.form-control-enhanced:focus {
    outline: none !important;
    border-color: var(--primary-orange) !important;
    box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1) !important;
    transform: translateY(-1px) !important;
}

.form-control-enhanced.error {
    border-color: var(--error-red) !important;
    animation: shake 0.5s ease !important;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
}

/* Enhanced Card Hover Effects */
.card-hover {
    transition: all var(--transition-speed) ease !important;
}

.card-hover:hover {
    transform: translateY(-4px) !important;
    box-shadow: var(--shadow-heavy) !important;
}

.card-hover-lift {
    transition: transform var(--transition-speed) ease, box-shadow var(--transition-speed) ease !important;
}

.card-hover-lift:hover {
    transform: translateY(-6px) scale(1.01) !important;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15) !important;
}

/* Enhanced Selection States */
.selection-glow {
    transition: all var(--transition-speed) ease !important;
}

.selection-glow.selected {
    box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.3), var(--shadow-medium) !important;
    animation: selectionPulse 2s infinite !important;
}

@keyframes selectionPulse {
    0%, 100% {
        box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.3), var(--shadow-medium);
    }
    50% {
        box-shadow: 0 0 0 6px rgba(255, 107, 53, 0.1), var(--shadow-medium);
    }
}

/* Enhanced Background Patterns */
.bg-pattern-orange {
    background-image: 
        radial-gradient(circle at 25% 25%, rgba(255, 107, 53, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 75% 75%, rgba(231, 76, 60, 0.1) 0%, transparent 50%) !important;
}

.bg-pattern-grid {
    background-image: 
        linear-gradient(rgba(255, 107, 53, 0.1) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255, 107, 53, 0.1) 1px, transparent 1px) !important;
    background-size: 20px 20px !important;
}

/* Enhanced Text Effects */
.text-gradient-orange {
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-red)) !important;
    -webkit-background-clip: text !important;
    -webkit-text-fill-color: transparent !important;
    background-clip: text !important;
}

.text-shadow-light {
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1) !important;
}

/* Enhanced Responsive Design */
@media (max-width: 768px) {
    .search-results-dropdown {
        max-height: 250px !important;
    }
    
    .search-result-item {
        padding: 10px 12px !important;
    }
    
    .map-controls-enhanced {
        top: 120px !important;
        right: 8px !important;
    }
    
    .toast-container-enhanced {
        max-width: 280px !important;
        right: 8px !important;
    }
    
    .emergency-service-enhanced {
        padding: 14px !important;
    }
    
    .emergency-icon-enhanced {
        width: 48px !important;
        height: 48px !important;
        font-size: 18px !important;
    }
    
    .sos-button-enhanced {
        width: 56px !important;
        height: 56px !important;
        bottom: 140px !important;
        right: 8px !important;
    }
}

@media (max-width: 480px) {
    .search-results-dropdown {
        max-height: 200px !important;
    }
    
    .search-result-item {
        padding: 8px 10px !important;
        gap: 8px !important;
    }
    
    .search-result-icon {
        width: 28px !important;
        height: 28px !important;
        font-size: 12px !important;
    }
    
    .search-result-title {
        font-size: 12px !important;
    }
    
    .map-controls-enhanced {
        top: 140px !important;
    }
    
    .map-control-btn-enhanced {
        width: 36px !important;
        height: 36px !important;
    }
    
    .toast-container-enhanced {
        max-width: 240px !important;
    }
    
    .toast-enhanced {
        padding: 12px !important;
    }
}

/* Print Styles */
@media print {
    .search-results-dropdown,
    .map-controls-enhanced,
    .sos-button-enhanced,
    .toast-container-enhanced {
        display: none !important;
    }
}

/* High Contrast Mode Support */
@media (prefers-contrast: high) {
    .search-result-item:hover {
        outline: 2px solid var(--primary-orange) !important;
    }
    
    .map-control-btn-enhanced {
        border: 2px solid var(--dark-gray) !important;
    }
    
    .toast-enhanced {
        border: 2px solid currentColor !important;
    }
}

/* Reduced Motion Support */
@media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
    
    .search-results-dropdown {
        animation: none !important;
    }
    
    .toast-enhanced {
        animation: none !important;
    }
    
    .driver-tracking-progress::after {
        animation: none !important;
    }
    
    .sos-button-enhanced,
    .step-dot-enhanced.active::after,
    .broadcast-status-indicator-enhanced,
    .notification-unread-dot {
        animation: none !important;
    }
}

/* Dark Mode Support (Optional) */
@media (prefers-color-scheme: dark) {
    .search-results-dropdown {
        background: #2c3e50 !important;
        border-color: #34495e !important;
    }
    
    .search-result-item {
        background: #2c3e50 !important;
        border-color: #34495e !important;
    }
    
    .search-result-item:hover {
        background: #34495e !important;
    }
    
    .search-result-title {
        color: #ecf0f1 !important;
    }
    
    .search-result-address {
        color: #bdc3c7 !important;
    }
}
    </style>
</head>
<body>
    <!-- Map Container -->
    <div id="map">
        <div class="map-loading-overlay" id="mapLoadingOverlay">
            <div class="loading-spinner"></div>
            <div class="map-loading-text">Loading map...</div>
        </div>
    </div>
    
    <!-- Top Navigation Bar -->
    <div class="top-bar">
        <div class="logo-container">
            <div class="logo-icon">
                <img src="jubel.png" alt="Jubel Logo" id="jubelLogo">
            </div>
            <div class="logo-text" id="userFullName">Loading...</div>
        </div>
        
        <div class="user-actions">
            <div class="balance-badge" id="balanceBadge">
                <i class="fas fa-wallet"></i>
                <span>Balance: <span class="balance-amount" id="walletBalance">ZMW 0.00</span></span>
            </div>
            <div class="notification-bell" id="notificationBell">
                <i class="fas fa-bell"></i>
                <span class="notification-badge" id="notificationCount">0</span>
            </div>
        </div>
    </div>
    
    <!-- City Detection Indicator -->
    <div class="city-detection" id="cityDetection">
        <i class="fas fa-map-marker-alt"></i>
        <span id="currentCityDisplay">Detecting your city...</span>
    </div>
    
    <!-- Ride Status Bar -->
    <div class="ride-status-bar" id="rideStatusBar">
        <div class="status-indicator">
            <div class="status-dot searching" id="statusDot"></div>
            <span class="status-text" id="statusText">Searching for driver</span>
        </div>
        <div class="status-eta">
            <i class="fas fa-clock"></i>
            <span id="etaText">5 min</span>
        </div>
    </div>
    
    <!-- Emergency Status -->
    <div class="emergency-status" id="emergencyStatus">
        <i class="fas fa-exclamation-triangle"></i>
        <span>EMERGENCY RIDE IN PROGRESS</span>
    </div>
    
    <!-- SOS Button -->
    <div class="sos-button" id="sosButton">
        <i class="fas fa-exclamation-triangle"></i>
    </div>
    
    <!-- Map Controls -->
    <div class="map-controls">
        <button class="map-control-btn" id="locateMeBtn" title="Locate Me">
            <i class="fas fa-location-arrow"></i>
        </button>
        <button class="map-control-btn" id="zoomInBtn" title="Zoom In">
            <i class="fas fa-plus"></i>
        </button>
        <button class="map-control-btn" id="zoomOutBtn" title="Zoom Out">
            <i class="fas fa-minus"></i>
        </button>
        <button class="map-control-btn" id="clearRouteBtn" title="Clear Route">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <!-- Chat Container -->
    <div class="chat-container" id="chatContainer">
        <div class="chat-header">
            <div class="chat-title">Chat with Driver</div>
            <button class="chat-close" id="chatClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <!-- Messages will be inserted here -->
        </div>
        <div class="chat-typing-indicator" id="typingIndicator">
            Driver is typing...
        </div>
        <div class="chat-input-container">
            <button class="chat-attachment-btn" id="attachmentBtn">
                <i class="fas fa-paperclip"></i>
            </button>
            <input type="text" class="chat-input" id="chatInput" placeholder="Type your message...">
            <button class="chat-send-btn" id="chatSend">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
    
    <!-- Notifications Panel -->
    <div class="notifications-panel" id="notificationsPanel">
        <div class="notifications-header">
            <div class="notifications-title">Notifications</div>
            <button class="notifications-close" id="notificationsClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="notifications-list" id="notificationsList">
            <!-- Notifications will be inserted here -->
        </div>
    </div>
    
    <!-- Dropdown Menu -->
    <div class="dropdown-menu" id="dropdownMenu">
        <div class="dropdown-item" data-action="profile">
            <i class="fas fa-user"></i>
            <span>Profile</span>
        </div>
        <div class="dropdown-item" data-action="settings">
            <i class="fas fa-cog"></i>
            <span>Settings</span>
        </div>
        <div class="dropdown-item" data-action="help">
            <i class="fas fa-question-circle"></i>
            <span>Help & Support</span>
        </div>
        <div class="dropdown-item" data-action="logout">
            <i class="fas fa-sign-out-alt"></i>
            <span>Logout</span>
        </div>
    </div>
    
    <!-- More Options Menu -->
    <div class="more-options-menu" id="moreOptionsMenu">
        <div class="dropdown-item" data-option="schedule">
            <i class="fas fa-calendar-alt"></i>
            <span>Schedule Ride</span>
        </div>
        <div class="dropdown-item" data-option="orderForSomeone">
            <i class="fas fa-user-friends"></i>
            <span>Order for Someone</span>
        </div>
        <div class="dropdown-item" data-option="shareRide">
            <i class="fas fa-share-alt"></i>
            <span>Share Ride</span>
        </div>
        <div class="dropdown-item" data-option="broadcast">
            <i class="fas fa-broadcast-tower"></i>
            <span>Broadcast Ride</span>
        </div>
    </div>
    
    <!-- Main Panel -->
    <div class="main-panel" id="mainPanel">
        <div class="panel-handle" id="panelHandle"></div>
        
        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" data-screen="home">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </button>
            <button class="nav-tab" data-screen="history">
                <i class="fas fa-history"></i>
                <span>History</span>
            </button>
            <button class="nav-tab" data-screen="account">
                <i class="fas fa-user"></i>
                <span>Account</span>
            </button>
            <button class="nav-tab" data-screen="emergency">
                <i class="fas fa-ambulance"></i>
                <span>Emergency</span>
            </button>
        </div>
        
        <!-- Home Screen Content -->
        <div id="homeContent">
            <!-- Service Tabs -->
            <div class="service-tabs" id="serviceTabs">
                <div class="service-tab car active" data-service="car">
                    <div class="service-icon">
                        <i class="fas fa-car"></i>
                    </div>
                    <div class="service-name">Car</div>
                    <div class="service-desc">Ride anywhere</div>
                </div>
                
                <div class="service-tab delivery" data-service="delivery">
                    <div class="service-icon">
                        <i class="fas fa-shipping-fast"></i>
                    </div>
                    <div class="service-name">Delivery</div>
                    <div class="service-desc">Send packages</div>
                </div>
                
                <div class="service-tab short-delivery" data-service="short-delivery">
                    <div class="service-icon">
                        <i class="fas fa-bicycle"></i>
                    </div>
                    <div class="service-name">Short Delivery</div>
                    <div class="service-desc">Quick deliveries</div>
                </div>
                
                <div class="service-tab" data-service="express">
                    <div class="service-icon">
                        <i class="fas fa-shopping-bag"></i>
                    </div>
                    <div class="service-name">Express Shopping</div>
                    <div class="service-desc">Shop for you</div>
                </div>
                
                <div class="service-tab" data-service="truck">
                    <div class="service-icon">
                        <i class="fas fa-truck"></i>
                    </div>
                    <div class="service-name">Truck</div>
                    <div class="service-desc">Move items</div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="quick-actions">
                <button class="quick-action-btn" id="moreOptionsBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-ellipsis-h"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">More Options</div>
                        <div class="quick-action-desc">Schedule, share, broadcast</div>
                    </div>
                </button>
                <button class="quick-action-btn" id="broadcastRideBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-broadcast-tower"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">Broadcast Ride</div>
                        <div class="quick-action-desc">Share with friends</div>
                    </div>
                </button>
                <button class="quick-action-btn" id="sosSetupBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">SOS Setup</div>
                        <div class="quick-action-desc">Emergency contacts</div>
                    </div>
                </button>
                <button class="quick-action-btn" id="recentDestinationsBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-history"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">Recent Destinations</div>
                        <div class="quick-action-desc">Quick access</div>
                    </div>
                </button>
            </div>
            
            <!-- Car Service Form (Default) -->
            <div class="ride-request-form active" id="carForm">
                <div class="form-title">
                    <i class="fas fa-car"></i>
                    Book a Ride
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="pickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="pickupLocation" placeholder="Current location" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="pickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="destinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="destinationLocation" placeholder="Where to?" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="destinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Search History -->
                <div class="search-history" id="searchHistory" style="display: none;"></div>
                
                <!-- Ride Type Selection -->
                <div class="ride-type-selection" id="rideTypeSelection">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                        <span id="rideTypeInfo" style="font-size: 11px; color: var(--text-light); cursor: pointer;">
                            <i class="fas fa-info-circle"></i>
                        </span>
                    </div>
                    
                    <div class="ride-type-grid">
                        <div class="ride-type-card economy" data-type="economy">
                            <div class="ride-type-icon">
                                <i class="fas fa-car-side"></i>
                            </div>
                            <div class="ride-type-name">Economy</div>
                            <div class="ride-type-price" id="economyPrice">ZMW 0.00</div>
                            <div class="ride-type-eta">ETA: 5-10 min</div>
                        </div>
                        
                        <div class="ride-type-card selected" data-type="standard">
                            <div class="ride-type-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="ride-type-name">Standard</div>
                            <div class="ride-type-price" id="standardPrice">ZMW 0.00</div>
                            <div class="ride-type-eta">ETA: 3-7 min</div>
                        </div>
                        
                        <div class="ride-type-card premium" data-type="premium">
                            <div class="ride-type-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="ride-type-name">Premium</div>
                            <div class="ride-type-price" id="premiumPrice">ZMW 0.00</div>
                            <div class="ride-type-eta">ETA: 2-5 min</div>
                        </div>
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="fareDisplay">
                    <div class="fare-label">Estimated Fare</div>
                    <div class="fare-amount" id="estimatedFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="distanceDetail">0 km</span>
                        <span id="timeDetail">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Price Calculator Display -->
                <div class="price-calculator-display" id="priceCalculator" style="display: none;">
                    <div class="fare-label">Fare Breakdown</div>
                    <div class="fare-amount" id="calculatedFare">ZMW 0.00</div>
                    <div class="price-breakdown" id="priceBreakdown">
                        <!-- Breakdown will be inserted here -->
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestRideBtn">
                        <i class="fas fa-search"></i>
                        Request Ride
                    </button>
                </div>
            </div>
            
            <!-- Delivery Service Form -->
            <div class="service-form delivery-form" id="deliveryForm">
                <div class="form-title">
                    <i class="fas fa-shipping-fast"></i>
                    Package Delivery
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="deliveryPickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="deliveryPickup" placeholder="Pickup location" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="deliveryPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="deliveryDestinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="deliveryDestination" placeholder="Delivery address" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="deliveryDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Delivery Details -->
                <div class="form-group">
                    <label class="form-label">Parcel Description</label>
                    <input type="text" class="form-control" id="parcelDescription" placeholder="What are you sending?">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Receiver's Details</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="receiverName" placeholder="Receiver name">
                        <input type="tel" class="form-control" id="receiverPhone" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Parcel Value (ZMW)</label>
                    <input type="number" class="form-control" id="parcelValue" placeholder="Value of parcel" min="0" step="0.01">
                </div>
                
                <!-- Delivery Options -->
                <div class="form-group">
                    <label class="form-label">Delivery Type</label>
                    <div style="display: flex; gap: 10px;">
                        <button class="filter-btn active" id="standardDelivery">Standard</button>
                        <button class="filter-btn" id="expressDelivery">Express</button>
                        <button class="filter-btn" id="sameDayDelivery">Same Day</button>
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="deliveryFareDisplay" style="display: none;">
                    <div class="fare-label">Delivery Fare</div>
                    <div class="fare-amount" id="deliveryFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="deliveryDistance">0 km</span>
                        <span id="deliveryTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestDeliveryBtn">
                        <i class="fas fa-shipping-fast"></i>
                        Request Delivery
                    </button>
                </div>
            </div>
            
            <!-- Short Delivery Form -->
            <div class="service-form delivery-form" id="shortDeliveryForm">
                <div class="form-title">
                    <i class="fas fa-bicycle"></i>
                    Short Delivery
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="shortDeliveryPickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="shortDeliveryPickup" placeholder="Pickup location" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shortDeliveryPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="shortDeliveryDestinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="shortDeliveryDestination" placeholder="Delivery address" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shortDeliveryDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Delivery Details -->
                <div class="form-group">
                    <label class="form-label">What are you sending?</label>
                    <input type="text" class="form-control" id="shortParcelDescription" placeholder="Food, documents, small items...">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Receiver's Phone</label>
                    <input type="tel" class="form-control" id="shortReceiverPhone" placeholder="Receiver phone number">
                </div>
                
                <!-- Quick Options -->
                <div class="form-group">
                    <label class="form-label">Quick Options</label>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <span class="filter-btn">Food</span>
                        <span class="filter-btn">Documents</span>
                        <span class="filter-btn">Medication</span>
                        <span class="filter-btn">Small Package</span>
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="shortDeliveryFareDisplay" style="display: none;">
                    <div class="fare-label">Delivery Fare</div>
                    <div class="fare-amount" id="shortDeliveryFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="shortDeliveryDistance">0 km</span>
                        <span id="shortDeliveryTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestShortDeliveryBtn">
                        <i class="fas fa-bolt"></i>
                        Quick Delivery
                    </button>
                </div>
            </div>
            
            <!-- Express Shopping Form -->
            <div class="service-form express-form" id="expressForm">
                <div class="form-title">
                    <i class="fas fa-shopping-bag"></i>
                    Express Shopping
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="shopNameInput">
                        <i class="fas fa-store"></i>
                        <input type="text" id="shopName" placeholder="Shop/Restaurant name" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shopSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="shopLocation" placeholder="Shop location" readonly>
                    </div>
                </div>
                
                <!-- Items List -->
                <div class="form-group">
                    <label class="form-label">Shopping List</label>
                    <div class="item-list" id="shoppingItems">
                        <div class="item-entry">
                            <input type="text" class="item-input" placeholder="Item name">
                            <button class="remove-item" type="button">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <button class="add-item" type="button" id="addItemBtn">
                        <i class="fas fa-plus"></i>
                        Add Item
                    </button>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Special Instructions</label>
                    <textarea class="form-control form-textarea" id="shoppingInstructions" placeholder="Any specific requests or instructions..."></textarea>
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="shoppingDestinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="shoppingDestination" placeholder="Delivery address" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shoppingDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Budget -->
                <div class="form-group">
                    <label class="form-label">Estimated Budget (ZMW)</label>
                    <input type="number" class="form-control" id="shoppingBudget" placeholder="Estimated cost of items">
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="shoppingFareDisplay" style="display: none;">
                    <div class="fare-label">Shopping Service Fare</div>
                    <div class="fare-amount" id="shoppingFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="shoppingDistance">0 km</span>
                        <span id="shoppingTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestShoppingBtn">
                        <i class="fas fa-shopping-cart"></i>
                        Request Shopping
                    </button>
                </div>
            </div>
            
            <!-- Truck Delivery Form -->
            <div class="service-form truck-form" id="truckForm">
                <div class="form-title">
                    <i class="fas fa-truck"></i>
                    Truck Delivery
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="truckPickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="truckPickup" placeholder="Pickup location (Current location)" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="truckPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="truckDestinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="truckDestination" placeholder="Destination" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="truckDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Truck Type Selection -->
                <div class="form-group">
                    <label class="form-label">Select Truck Type</label>
                    <div class="truck-types">
                        <div class="truck-type" data-type="pickup">
                            <div class="truck-icon">
                                <i class="fas fa-truck-pickup"></i>
                            </div>
                            <div class="truck-name">Pickup Truck</div>
                            <div class="truck-capacity">Up to 1.5 tons</div>
                        </div>
                        
                        <div class="truck-type selected" data-type="light">
                            <div class="truck-icon">
                                <i class="fas fa-truck-moving"></i>
                            </div>
                            <div class="truck-name">Light Truck</div>
                            <div class="truck-capacity">Up to 3 tons</div>
                        </div>
                        
                        <div class="truck-type" data-type="medium">
                            <div class="truck-icon">
                                <i class="fas fa-truck"></i>
                            </div>
                            <div class="truck-name">Medium Truck</div>
                            <div class="truck-capacity">Up to 7 tons</div>
                        </div>
                        
                        <div class="truck-type" data-type="heavy">
                            <div class="truck-icon">
                                <i class="fas fa-truck-loading"></i>
                            </div>
                            <div class="truck-name">Heavy Truck</div>
                            <div class="truck-capacity">Up to 15 tons</div>
                        </div>
                    </div>
                </div>
                
                <!-- Item Details -->
                <div class="form-group">
                    <label class="form-label">What are you moving?</label>
                    <input type="text" class="form-control" id="truckItemDescription" placeholder="Furniture, boxes, equipment...">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Estimated Weight (kg)</label>
                    <input type="number" class="form-control" id="estimatedWeight" placeholder="Approximate weight">
                </div>
                
                <!-- Additional Help -->
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="needHelpers">
                        <span style="margin-left: 8px;">Need loading/unloading helpers (+ZMW 50)</span>
                    </label>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="truckFareDisplay" style="display: none;">
                    <div class="fare-label">Truck Fare</div>
                    <div class="fare-amount" id="truckFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="truckDistance">0 km</span>
                        <span id="truckTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestTruckBtn">
                        <i class="fas fa-truck"></i>
                        Request Truck
                    </button>
                </div>
            </div>
            
            <!-- Ride Info Panel -->
            <div class="ride-info-panel" id="rideInfoPanel">
                <div class="driver-info">
                    <div class="driver-avatar" id="driverAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="driver-details">
                        <div class="driver-name" id="driverName">Driver Name</div>
                        <div class="driver-rating">
                            <i class="fas fa-star"></i>
                            <span id="driverRating">4.8</span>
                        </div>
                        <div class="driver-vehicle">
                            <i class="fas fa-car"></i>
                            <span id="vehicleDetails">Toyota Corolla - ABC 123</span>
                        </div>
                    </div>
                </div>
                
                <!-- Driver Media Display -->
                <div class="driver-media" id="driverMedia">
                    <div class="media-container">
                        <div class="media-placeholder" id="driverImagePlaceholder">
                            <i class="fas fa-user"></i>
                            <span>Driver Image</span>
                        </div>
                        <img id="driverImage" style="display: none;">
                    </div>
                    <div class="media-container">
                        <div class="media-placeholder" id="vehicleImagePlaceholder">
                            <i class="fas fa-car"></i>
                            <span>Vehicle Image</span>
                        </div>
                        <img id="vehicleImage" style="display: none;">
                    </div>
                </div>
                
                <!-- Tracking Info -->
                <div class="tracking-info" id="trackingInfo">
                    <div class="tracking-header">
                        <div class="tracking-title">Driver Distance</div>
                        <div class="tracking-distance" id="driverDistance">0 km</div>
                    </div>
                    <div class="tracking-progress">
                        <div class="tracking-progress-bar" id="trackingProgress" style="width: 0%"></div>
                    </div>
                    <div class="tracking-details">
                        <span id="pickupDistance">0 km to pickup</span>
                        <span id="etaToPickup">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Timeline -->
                <div class="timeline" id="rideTimeline">
                    <div class="timeline-step">
                        <div class="step-dot active" id="stepRequested">
                            <i class="fas fa-search"></i>
                        </div>
                        <div class="step-label active">Requested</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepAccepted">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <div class="step-label">Accepted</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepArrived">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="step-label">Arrived</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepStarted">
                            <i class="fas fa-play"></i>
                        </div>
                        <div class="step-label">Started</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepCompleted">
                            <i class="fas fa-flag-checkered"></i>
                        </div>
                        <div class="step-label">Completed</div>
                    </div>
                </div>
                
                <div class="trip-details">
                    <div class="trip-locations">
                        <div class="location-point">
                            <div class="location-marker pickup">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="location-text">
                                <div class="location-label">Pickup</div>
                                <div class="location-address" id="currentPickup">Loading...</div>
                            </div>
                        </div>
                        
                        <div class="location-point">
                            <div class="location-marker destination">
                                <i class="fas fa-flag"></i>
                            </div>
                            <div class="location-text">
                                <div class="location-label">Destination</div>
                                <div class="location-address" id="currentDestination">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Location Details -->
                <div class="location-details">
                    <div class="location-detail-item">
                        <div class="location-detail-icon">
                            <i class="fas fa-road"></i>
                        </div>
                        <div class="location-detail-content">
                            <div class="location-detail-label">Distance</div>
                            <div class="location-detail-value" id="rideDistance">0 km</div>
                        </div>
                    </div>
                    <div class="location-detail-item">
                        <div class="location-detail-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="location-detail-content">
                            <div class="location-detail-label">Estimated Time</div>
                            <div class="location-detail-value" id="rideTime">0 min</div>
                        </div>
                    </div>
                </div>
                
                <div class="fare-breakdown">
                    <div class="fare-row">
                        <span class="fare-label">Base Fare</span>
                        <span class="fare-value" id="baseFareValue">ZMW 15.00</span>
                    </div>
                    <div class="fare-row">
                        <span class="fare-label">Distance</span>
                        <span class="fare-value" id="distanceFareValue">ZMW 5.00</span>
                    </div>
                    <div class="fare-row">
                        <span class="fare-label">Ride Type</span>
                        <span class="fare-value" id="rideTypeValue">Standard</span>
                    </div>
                    <div class="fare-row total">
                        <span class="fare-label">Total Fare</span>
                        <span class="fare-value" id="totalFareValue">ZMW 20.00</span>
                    </div>
                </div>
                
                <!-- Emergency Contact Display -->
                <div class="emergency-contact-display" id="emergencyContactDisplay" style="display: none;">
                    <div class="emergency-contact-header">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div class="emergency-contact-title">Emergency Contacts</div>
                    </div>
                    <div class="emergency-contact-item">
                        <div class="contact-info">
                            <div class="contact-name" id="emergencyContact1Name">Contact 1</div>
                            <div class="contact-phone" id="emergencyContact1Phone">000-000-0000</div>
                        </div>
                        <button class="contact-action-btn" onclick="callEmergencyContact('contact1')">
                            <i class="fas fa-phone"></i>
                        </button>
                    </div>
                    <div class="emergency-contact-item">
                        <div class="contact-info">
                            <div class="contact-name" id="emergencyContact2Name">Contact 2</div>
                            <div class="contact-phone" id="emergencyContact2Phone">000-000-0000</div>
                        </div>
                        <button class="contact-action-btn" onclick="callEmergencyContact('contact2')">
                            <i class="fas fa-phone"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Broadcast Feature -->
                <div class="broadcast-feature" id="broadcastFeature" style="display: none;">
                    <div class="broadcast-feature-header">
                        <div class="broadcast-feature-title">
                            <i class="fas fa-broadcast-tower"></i>
                            <span>Broadcast Ride</span>
                        </div>
                        <div class="broadcast-status-indicator inactive" id="broadcastStatusIndicator"></div>
                    </div>
                    <div class="broadcast-form">
                        <div class="broadcast-input-group">
                            <input type="text" id="broadcastPhone" placeholder="Enter passenger phone number">
                            <button class="broadcast-btn" id="addBroadcastRecipient">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div class="broadcast-recipients" id="broadcastRecipients">
                            <!-- Recipients will be inserted here -->
                        </div>
                        <button class="btn btn-secondary" id="startBroadcastBtn">
                            <i class="fas fa-play"></i>
                            Start Broadcasting
                        </button>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-danger" id="cancelRideBtn">
                        <i class="fas fa-times-circle"></i>
                        Cancel Ride
                    </button>
                    <button class="btn btn-secondary" id="contactDriverBtn">
                        <i class="fas fa-phone"></i>
                        Call Driver
                    </button>
                    <button class="btn btn-secondary" id="openChatBtn">
                        <i class="fas fa-comment"></i>
                        Chat
                    </button>
                </div>
            </div>
            
            <!-- Broadcast Ride Form -->
            <div class="service-form" id="broadcastForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-broadcast-tower"></i>
                    Broadcast Ride
                </div>
                
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="broadcastPickup" placeholder="Pickup location" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="broadcastPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="broadcastDestination" placeholder="Destination" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="broadcastDestinationSuggestions"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Passenger Phone Numbers (comma separated)</label>
                    <textarea class="form-control form-textarea" id="broadcastPassengers" placeholder="Enter phone numbers of passengers to share this ride with..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Ride Type</label>
                    <select class="form-control" id="broadcastRideType">
                        <option value="standard">Standard</option>
                        <option value="economy">Economy</option>
                        <option value="premium">Premium</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Split Fare</label>
                    <select class="form-control" id="broadcastSplitType">
                        <option value="equal">Equal Split</option>
                        <option value="you_pay_more">You Pay 70%</option>
                        <option value="you_pay_all">You Pay All</option>
                    </select>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="broadcastFareDisplay" style="display: none;">
                    <div class="fare-label">Broadcast Fare</div>
                    <div class="fare-amount" id="broadcastFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="broadcastDistance">0 km</span>
                        <span id="broadcastTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="startBroadcastRideBtn">
                        <i class="fas fa-broadcast-tower"></i>
                        Start Broadcast
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- History Screen -->
    <div class="history-screen" id="historyScreen">
        <div class="screen-header">
            <button class="back-btn" data-screen="home">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="screen-title">Ride History</div>
        </div>
        
        <div class="history-filters">
            <button class="filter-btn active" data-filter="all">All</button>
            <button class="filter-btn" data-filter="completed">Completed</button>
            <button class="filter-btn" data-filter="cancelled">Cancelled</button>
            <button class="filter-btn" data-filter="scheduled">Scheduled</button>
            <button class="filter-btn" data-filter="emergency">Emergency</button>
            <button class="filter-btn" data-filter="delivery">Delivery</button>
            <button class="filter-btn" data-filter="truck">Truck</button>
            <button class="filter-btn" data-filter="broadcast">Broadcast</button>
        </div>
        
        <div class="history-list" id="historyList">
            <!-- History items will be inserted here -->
        </div>
    </div>
    
    <!-- Account Screen -->
    <div class="account-screen" id="accountScreen">
        <div class="screen-header">
            <button class="back-btn" data-screen="home">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="screen-title">My Account</div>
        </div>
        
        <div class="account-header">
            <div class="account-avatar" id="accountAvatar">
                <i class="fas fa-user"></i>
            </div>
            <div class="account-name" id="accountName">Loading...</div>
            <div class="account-phone" id="accountPhone">Loading...</div>
        </div>
        
        <div class="account-stats">
            <div class="stat-card">
                <div class="stat-value" id="completedRides">0</div>
                <div class="stat-label">Completed Rides</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="cancelledRides">0</div>
                <div class="stat-label">Cancelled Rides</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalSpent">ZMW 0</div>
                <div class="stat-label">Total Spent</div>
            </div>
        </div>
        
        <div class="account-section">
            <div class="section-title">
                <i class="fas fa-wallet"></i>
                Wallet Balance
            </div>
            
            <div class="wallet-balance">
                <div class="balance-label">Available Balance</div>
                <div class="balance-amount-large" id="accountBalance">ZMW 0.00</div>
            </div>
            
            <div class="wallet-actions">
                <button class="btn-wallet" id="depositBtn">
                    <i class="fas fa-plus"></i>
                    Deposit
                </button>
                <button class="btn-wallet" id="withdrawBtn">
                    <i class="fas fa-minus"></i>
                    Withdraw
                </button>
                <button class="btn-wallet" id="transferBtn">
                    <i class="fas fa-exchange-alt"></i>
                    Transfer
                </button>
                <button class="btn-wallet" id="transactionsBtn">
                    <i class="fas fa-history"></i>
                    History
                </button>
            </div>
        </div>
        
        <div class="account-section">
            <div class="section-title">
                <i class="fas fa-gift"></i>
                Referral Program
            </div>
            
            <div class="referral-card">
                <div>Share your referral code and earn ZMW 25 for each friend's first ride</div>
                <div class="referral-code" id="referralCode">JUBEL-XXXX</div>
                <button class="btn btn-primary" id="shareReferralBtn">
                    <i class="fas fa-share"></i>
                    Share Code
                </button>
                <div class="referral-note">Your friend gets 50% off their first ride</div>
            </div>
        </div>
        
        <div class="account-section">
            <div class="section-title">
                <i class="fas fa-cog"></i>
                Settings
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-secondary" id="updateProfileBtn">
                    <i class="fas fa-user-edit"></i>
                    Update Profile
                </button>
                <button class="btn btn-secondary" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </button>
            </div>
        </div>
    </div>
    
    <!-- Emergency Screen -->
    <div class="emergency-screen" id="emergencyScreen">
        <div class="screen-header">
            <button class="back-btn" data-screen="home">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="screen-title">Emergency Services</div>
        </div>
        
        <div class="emergency-services">
            <div class="emergency-service police" data-type="police">
                <div class="emergency-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <div class="emergency-name">Police Ride</div>
                <div class="emergency-description">Emergency transport with police escort</div>
            </div>
            
            <div class="emergency-service fire" data-type="fire">
                <div class="emergency-icon">
                    <i class="fas fa-fire-extinguisher"></i>
                </div>
                <div class="emergency-name">Fire Brigade</div>
                <div class="emergency-description">Fire emergency response team</div>
            </div>
            
            <div class="emergency-service medical" data-type="medical">
                <div class="emergency-icon">
                    <i class="fas fa-ambulance"></i>
                </div>
                <div class="emergency-name">Hospital Ride</div>
                <div class="emergency-description">Medical emergency transport</div>
            </div>
            
            <div class="emergency-service" data-type="sos">
                <div class="emergency-icon" style="background: var(--error-red);">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="emergency-name">SOS Emergency</div>
                <div class="emergency-description">Immediate emergency assistance</div>
            </div>
        </div>
        
        <div class="emergency-note">
            <p><strong>Important:</strong> Only use emergency services for genuine emergencies. Misuse may result in penalties. In case of immediate danger, call 911 first.</p>
        </div>
    </div>
    
    <!-- Modals -->
    
    <!-- Payment Modal -->
    <div class="modal-overlay" id="paymentModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-credit-card"></i>
                    Select Payment Method
                </div>
                <button class="modal-close" data-modal="payment">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <div class="form-label">Available Balance: <span id="paymentBalance">ZMW 0.00</span></div>
                    <div class="form-label">Total Amount: <span id="paymentAmount">ZMW 0.00</span></div>
                </div>
                
                <div class="payment-methods">
                    <div class="payment-method" data-payment="wallet">
                        <div class="payment-icon">
                            <i class="fas fa-wallet"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Jubel Wallet</div>
                            <div class="payment-info">Pay with your wallet balance</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-payment="mobile">
                        <div class="payment-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Mobile Money</div>
                            <div class="payment-info">Pay via MTN/Zamtel/Airtel</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-payment="cash">
                        <div class="payment-icon">
                            <i class="fas fa-money-bill"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Cash</div>
                            <div class="payment-info">Pay driver directly</div>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmPaymentBtn">
                        <i class="fas fa-check"></i>
                        Confirm Payment
                    </button>
                    <button class="btn btn-secondary" data-modal="payment">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Cancel Ride Modal -->
    <div class="modal-overlay" id="cancelModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-times-circle"></i>
                    Cancel Ride
                </div>
                <button class="modal-close" data-modal="cancel">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <div class="form-label">Please select a reason for cancellation:</div>
                </div>
                
                <div class="cancel-reasons">
                    <div class="cancel-reason" data-reason="driver_late">
                        <div class="reason-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="reason-text">Driver is taking too long</div>
                    </div>
                    
                    <div class="cancel-reason" data-reason="change_plans">
                        <div class="reason-icon">
                            <i class="fas fa-calendar-times"></i>
                        </div>
                        <div class="reason-text">Change of plans</div>
                    </div>
                    
                    <div class="cancel-reason" data-reason="found_alternative">
                        <div class="reason-icon">
                            <i class="fas fa-car"></i>
                        </div>
                        <div class="reason-text">Found alternative transport</div>
                    </div>
                    
                    <div class="cancel-reason" data-reason="emergency">
                        <div class="reason-icon">
                            <i class="fas fa-exclamation"></i>
                        </div>
                        <div class="reason-text">Emergency situation</div>
                    </div>
                    
                    <div class="cancel-reason" data-reason="other">
                        <div class="reason-icon">
                            <i class="fas fa-ellipsis-h"></i>
                        </div>
                        <div class="reason-text">Other reason</div>
                    </div>
                </div>
                
                <div class="form-group" id="otherReasonGroup" style="display: none;">
                    <label class="form-label">Please specify:</label>
                    <textarea class="form-control form-textarea" id="otherReason" placeholder="Enter your reason here..."></textarea>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-danger" id="confirmCancelBtn">
                        <i class="fas fa-times"></i>
                        Cancel Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="cancel">
                        Go Back
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Emergency Ride Modal -->
    <div class="modal-overlay" id="emergencyModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-ambulance"></i>
                    Emergency Ride Details
                </div>
                <button class="modal-close" data-modal="emergency">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content emergency-modal-content">
                <div class="form-group">
                    <div class="form-label" id="emergencyServiceType">Police Ride</div>
                </div>
                
                <!-- Emergency Reasons -->
                <div class="form-group">
                    <label class="form-label">Select Emergency Reason</label>
                    <div class="emergency-reasons">
                        <div class="emergency-reason" data-reason="accident">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-car-crash"></i>
                            </div>
                            <div class="emergency-reason-text">Accident</div>
                        </div>
                        
                        <div class="emergency-reason" data-reason="medical">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-heartbeat"></i>
                            </div>
                            <div class="emergency-reason-text">Medical Emergency</div>
                        </div>
                        
                        <div class="emergency-reason" data-reason="crime">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="emergency-reason-text">Crime/Assault</div>
                        </div>
                        
                        <div class="emergency-reason" data-reason="fire">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-fire"></i>
                            </div>
                            <div class="emergency-reason-text">Fire Emergency</div>
                        </div>
                        
                        <div class="emergency-reason" data-reason="other">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="emergency-reason-text">Other Emergency</div>
                        </div>
                    </div>
                    
                    <div class="emergency-reason-input" id="emergencyReasonOther" style="display: none;">
                        <label class="form-label">Please describe the emergency:</label>
                        <textarea class="form-control form-textarea" id="emergencyOtherReason" placeholder="Describe the emergency situation..."></textarea>
                    </div>
                </div>
                
                <!-- Emergency Stations -->
                <div class="form-group">
                    <label class="form-label">Select Nearest Emergency Station</label>
                    <div class="emergency-stations" id="emergencyStations">
                        <!-- Stations will be inserted here -->
                    </div>
                </div>
                
                <!-- User Location Details -->
                <div class="location-details">
                    <div class="location-detail-item">
                        <div class="location-detail-icon">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="location-detail-content">
                            <div class="location-detail-label">Your Location</div>
                            <div class="location-detail-value" id="emergencyUserLocation">Detecting location...</div>
                        </div>
                    </div>
                </div>
                
                <!-- Price Calculation -->
                <div class="price-calculation">
                    <div class="calculation-row">
                        <span>Base Emergency Fare:</span>
                        <span id="emergencyBaseFare">ZMW 100.00</span>
                    </div>
                    <div class="calculation-row">
                        <span>Distance to Service:</span>
                        <span id="emergencyDistance">0 km</span>
                    </div>
                    <div class="calculation-row">
                        <span>Estimated Time:</span>
                        <span id="emergencyTime">5 min</span>
                    </div>
                    <div class="calculation-row total">
                        <span>Total Fare:</span>
                        <span id="emergencyTotalFare">ZMW 100.00</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-danger" id="confirmEmergencyBtn">
                        <i class="fas fa-exclamation-triangle"></i>
                        Request Emergency Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="emergency">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- SOS Setup Modal -->
    <div class="modal-overlay" id="sosModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    SOS Emergency Setup
                </div>
                <button class="modal-close" data-modal="sos">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <label class="form-label">Primary Emergency Contact</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="sosContact1Name" placeholder="Contact name">
                        <input type="tel" class="form-control" id="sosContact1Phone" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Secondary Emergency Contact (Optional)</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="sosContact2Name" placeholder="Contact name">
                        <input type="tel" class="form-control" id="sosContact2Phone" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Emergency Message</label>
                    <textarea class="form-control form-textarea" id="sosMessage">
I need help! My current location and ride details will be shared with you.
                    </textarea>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="saveSOSBtn">
                        <i class="fas fa-save"></i>
                        Save SOS Setup
                    </button>
                    <button class="btn btn-secondary" data-modal="sos">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Transfer Money Modal -->
    <div class="modal-overlay" id="transferModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-exchange-alt"></i>
                    Transfer Money
                </div>
                <button class="modal-close" data-modal="transfer">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <div class="form-label">Available Balance: <span id="transferBalance">ZMW 0.00</span></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Recipient's Referral Code</label>
                    <input type="text" class="form-control" id="recipientCode" placeholder="Enter recipient's Jubel referral code">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Amount (ZMW)</label>
                    <input type="number" class="form-control" id="transferAmount" placeholder="Enter amount" min="1" step="0.01">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Message (Optional)</label>
                    <input type="text" class="form-control" id="transferMessage" placeholder="Add a message">
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmTransferBtn">
                        <i class="fas fa-paper-plane"></i>
                        Send Money
                    </button>
                    <button class="btn btn-secondary" data-modal="transfer">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Wallet Transactions Modal -->
    <div class="modal-overlay" id="transactionsModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-history"></i>
                    Wallet Transactions
                </div>
                <button class="modal-close" data-modal="transactions">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div id="transactionsList">
                    <!-- Transactions will be inserted here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Schedule Ride Modal -->
    <div class="modal-overlay" id="scheduleModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-calendar-alt"></i>
                    Schedule a Ride
                </div>
                <button class="modal-close" data-modal="schedule">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="schedulePickup" placeholder="Pickup location">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="schedulePickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="scheduleDestination" placeholder="Destination">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="scheduleDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- For Someone Else -->
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="scheduleForSomeone">
                        <span style="margin-left: 8px;">Booking for someone else</span>
                    </label>
                </div>
                
                <div class="form-group" id="someoneElseDetails" style="display: none;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="recipientName" placeholder="Recipient name">
                        <input type="tel" class="form-control" id="recipientPhone" placeholder="Recipient phone">
                    </div>
                </div>
                
                <div class="schedule-grid">
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-control" id="scheduleDate" min="">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Time</label>
                        <input type="time" class="form-control" id="scheduleTime">
                    </div>
                </div>
                
                <!-- Ride Type Selection for Schedule -->
                <div class="ride-type-selection active" style="margin: 0 0 16px 0;">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                    </div>
                    <div class="ride-type-grid">
                        <div class="ride-type-card economy" data-type="economy">
                            <div class="ride-type-icon">
                                <i class="fas fa-car-side"></i>
                            </div>
                            <div class="ride-type-name">Economy</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card selected" data-type="standard">
                            <div class="ride-type-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="ride-type-name">Standard</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card premium" data-type="premium">
                            <div class="ride-type-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="ride-type-name">Premium</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="scheduleFareDisplay" style="display: none;">
                    <div class="fare-label">Scheduled Ride Fare</div>
                    <div class="fare-amount" id="scheduleFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="scheduleDistance">0 km</span>
                        <span id="scheduleTimeEstimate">ETA: 0 min</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmScheduleBtn">
                        <i class="fas fa-calendar-check"></i>
                        Schedule Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="schedule">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Order for Someone Modal -->
    <div class="modal-overlay" id="orderForSomeoneModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-user-friends"></i>
                    Order for Someone Else
                </div>
                <button class="modal-close" data-modal="orderForSomeone">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="someonePickup" placeholder="Pickup location">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="someonePickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="someoneDestination" placeholder="Destination">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="someoneDestinationSuggestions"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Recipient Details</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="someoneName" placeholder="Full name">
                        <input type="tel" class="form-control" id="someonePhone" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Special Instructions (Optional)</label>
                    <textarea class="form-control form-textarea" id="someoneInstructions" placeholder="Any instructions for the driver..."></textarea>
                </div>
                
                <!-- Ride Type Selection -->
                <div class="ride-type-selection active" style="margin: 0 0 16px 0;">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                    </div>
                    <div class="ride-type-grid">
                        <div class="ride-type-card economy" data-type="economy">
                            <div class="ride-type-icon">
                                <i class="fas fa-car-side"></i>
                            </div>
                            <div class="ride-type-name">Economy</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card selected" data-type="standard">
                            <div class="ride-type-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="ride-type-name">Standard</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card premium" data-type="premium">
                            <div class="ride-type-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="ride-type-name">Premium</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="someoneFareDisplay" style="display: none;">
                    <div class="fare-label">Estimated Fare</div>
                    <div class="fare-amount" id="someoneFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="someoneDistance">0 km</span>
                        <span id="someoneTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmSomeoneRideBtn">
                        <i class="fas fa-car"></i>
                        Request Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="orderForSomeone">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Share Ride Modal -->
    <div class="modal-overlay" id="shareRideModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-share-alt"></i>
                    Share Ride
                </div>
                <button class="modal-close" data-modal="shareRide">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="sharePickup" placeholder="Pickup location">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="sharePickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="shareDestination" placeholder="Destination">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shareDestinationSuggestions"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Friend's Referral Code</label>
                    <input type="text" class="form-control" id="friendReferralCode" placeholder="Enter friend's Jubel referral code">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Split Fare</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select class="form-control" id="splitPercentage" style="flex: 1;">
                            <option value="50">50/50 Split</option>
                            <option value="60">You pay 60%</option>
                            <option value="70">You pay 70%</option>
                            <option value="80">You pay 80%</option>
                            <option value="100">You pay full</option>
                        </select>
                    </div>
                </div>
                
                <!-- Ride Type Selection -->
                <div class="ride-type-selection active" style="margin: 0 0 16px 0;">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                    </div>
                    <div class="ride-type-grid">
                        <div class="ride-type-card economy" data-type="economy">
                            <div class="ride-type-icon">
                                <i class="fas fa-car-side"></i>
                            </div>
                            <div class="ride-type-name">Economy</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card selected" data-type="standard">
                            <div class="ride-type-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="ride-type-name">Standard</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card premium" data-type="premium">
                            <div class="ride-type-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="ride-type-name">Premium</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Estimated Fare: <span id="shareFareEstimate">ZMW 0.00</span></label>
                    <div class="price-calculation">
                        <div class="calculation-row">
                            <span>Your Share:</span>
                            <span id="yourShare">ZMW 0.00</span>
                        </div>
                        <div class="calculation-row">
                            <span>Friend's Share:</span>
                            <span id="friendShare">ZMW 0.00</span>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmShareRideBtn">
                        <i class="fas fa-user-friends"></i>
                        Share Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="shareRide">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Update Profile Modal -->
    <div class="modal-overlay" id="updateProfileModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-user-edit"></i>
                    Update Profile
                </div>
                <button class="modal-close" data-modal="updateProfile">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <input type="text" class="form-control" id="updateName" placeholder="Your full name">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Phone Number</label>
                    <input type="tel" class="form-control" id="updatePhone" placeholder="Your phone number">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" class="form-control" id="updateEmail" placeholder="Your email address" readonly>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Home Address (Optional)</label>
                    <input type="text" class="form-control" id="updateHomeAddress" placeholder="Your home address">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Work Address (Optional)</label>
                    <input type="text" class="form-control" id="updateWorkAddress" placeholder="Your work address">
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="saveProfileBtn">
                        <i class="fas fa-save"></i>
                        Save Changes
                    </button>
                    <button class="btn btn-secondary" data-modal="updateProfile">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Loading...</div>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Real-time Indicator -->
    <div class="real-time-indicator" id="realTimeIndicator">
        <i class="fas fa-sync-alt"></i>
        <span>Real-time updates active</span>
    </div>
    
    <!-- Sync Indicator -->
    <div class="sync-indicator" id="syncIndicator">
        <i class="fas fa-sync-alt sync-icon"></i>
        <span>Syncing...</span>
    </div>
    
    <!-- Firebase and Leaflet JS -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
    // ============================================
    // FIREBASE CONFIGURATION
    // ============================================
    const firebaseConfig = {
        apiKey: "AIzaSyDEACX_P4c5q7djJAcA0I7Lk7leO2TlQ74",
        authDomain: "jubel-13e1a.firebaseapp.com",
        databaseURL: "https://jubel-13e1a-default-rtdb.firebaseio.com",
        projectId: "jubel-13e1a",
        storageBucket: "jubel-13e1a.firebasestorage.app",
        messagingSenderId: "882241095445",
        appId: "1:882241095445:web:ee9ca40fddd008ca910b1c",
        measurementId: "G-J5JPKL6B5F"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const auth = firebase.auth();
    const storage = firebase.storage();

    // ============================================
    // ENHANCED APP STATE MANAGEMENT
    // ============================================
    const AppState = {
        currentUser: null,
        userData: null,
        currentRide: null,
        activeScreen: 'home',
        activeService: 'car',
        walletBalance: 0,
        userLocation: null,
        currentCity: null,
        detectedCity: null,
        selectedRideType: 'standard',
        selectedVehicle: null,
        destination: null,
        pickup: null,
        rideFare: 0,
        driverLocation: null,
        chatMessages: [],
        scheduledRides: [],
        scheduledTimers: [],
        emergencyMode: false,
        sosConfig: null,
        searchCache: new Map(),
        lastSearchTime: 0,
        notifications: [],
        unreadNotifications: 0,
        searchHistory: [],
        broadcastRecipients: [],
        emergencyStations: {
            police: [],
            fire: [],
            medical: []
        },
        realtimeListeners: [],
        rideTypes: {
            economy: { base: 15, perKm: 2.5, multiplier: 0.8, min: 10, icon: 'fa-car-side', vehicleIcon: 'car' },
            standard: { base: 20, perKm: 3.0, multiplier: 1.0, min: 15, icon: 'fa-car', vehicleIcon: 'car' },
            premium: { base: 30, perKm: 4.0, multiplier: 1.5, min: 25, icon: 'fa-crown', vehicleIcon: 'car' }
        },
        emergencyServices: {
            police: { base: 150, perKm: 5.0, multiplier: 2.0, min: 100 },
            fire: { base: 200, perKm: 6.0, multiplier: 2.5, min: 150 },
            medical: { base: 180, perKm: 5.5, multiplier: 2.2, min: 120 }
        },
        deliveryTypes: {
            standard: { base: 25, perKm: 2.0, multiplier: 1.0, vehicleIcon: 'shipping-fast' },
            express: { base: 40, perKm: 3.0, multiplier: 1.5, vehicleIcon: 'shipping-fast' },
            sameDay: { base: 60, perKm: 4.0, multiplier: 2.0, vehicleIcon: 'shipping-fast' }
        },
        truckTypes: {
            pickup: { base: 80, perKm: 5.0, multiplier: 1.0, capacity: '1.5 tons', vehicleIcon: 'truck-pickup' },
            light: { base: 120, perKm: 6.0, multiplier: 1.2, capacity: '3 tons', vehicleIcon: 'truck' },
            medium: { base: 200, perKm: 8.0, multiplier: 1.5, capacity: '7 tons', vehicleIcon: 'truck-moving' },
            heavy: { base: 350, perKm: 12.0, multiplier: 2.0, capacity: '15 tons', vehicleIcon: 'truck-loading' }
        },
        lastPriceUpdate: 0,
        cityDetectionAttempts: 0,
        maxCityDetectionAttempts: 5,
        isSyncing: false,
        syncInterval: null,
        emergencyReason: null,
        selectedEmergencyStation: null,
        activeBroadcast: null,
        typingTimeout: null,
        driverTyping: false,
        searchingAnimation: null,
        currentReferralCode: null,
        referralOwnerName: null,
        sharedRideMembers: [],
        maxSharedRideMembers: 4,
        broadcastTrackingUsers: [],
        routePolyline: null,
        isDrawingRoute: false,
        locationManagement: {
            isEditingPickup: false,
            currentPickupInputId: null,
            pickupSearchResults: [],
            cityBounds: null,
            cityPolygon: null,
            userDetectedAddress: null
        }
    };

    // ============================================
    // MAP MANAGEMENT
    // ============================================
    let map = null;
    let currentLocationMarker = null;
    let pickupMarker = null;
    let destinationMarker = null;
    let driverMarker = null;
    let routeLayer = null;
    let emergencyMarkers = [];
    let emergencyStationMarkers = [];
    let cityBoundaryLayer = null;
    let searchPulsingIcon = null;

    // ============================================
    // ENHANCED LOCATION SEARCH ENGINE
    // ============================================
    const EnhancedSearchEngine = {
        cache: new Map(),
        lastSearch: 0,
        debounceTimer: null,
        searchHistory: [],
        maxHistoryItems: 15,
        activeSearches: new Set(),
        
        init: function() {
            this.loadSearchHistory();
            console.log('Enhanced Search Engine initialized');
        },
        
        loadSearchHistory: function() {
            try {
                const history = localStorage.getItem('jubel_search_history');
                if (history) {
                    this.searchHistory = JSON.parse(history);
                    console.log(`Loaded ${this.searchHistory.length} search history items`);
                }
            } catch (error) {
                console.error('Error loading search history:', error);
                this.searchHistory = [];
            }
        },
        
        saveSearchHistory: function() {
            try {
                localStorage.setItem('jubel_search_history', JSON.stringify(this.searchHistory));
            } catch (error) {
                console.error('Error saving search history:', error);
            }
        },
        
        addToHistory: function(query, location, type) {
            const historyItem = {
                query: query,
                location: location,
                type: type,
                timestamp: Date.now(),
                city: AppState.currentCity
            };
            
            // Remove duplicates
            this.searchHistory = this.searchHistory.filter(item => 
                !(item.query === query && item.type === type && item.city === AppState.currentCity)
            );
            
            // Add to beginning
            this.searchHistory.unshift(historyItem);
            
            // Keep only max items
            if (this.searchHistory.length > this.maxHistoryItems) {
                this.searchHistory = this.searchHistory.slice(0, this.maxHistoryItems);
            }
            
            this.saveSearchHistory();
            return historyItem;
        },
        
        search: async function(query, type = 'destination', location = null, forceCity = null) {
            const searchId = `${Date.now()}-${Math.random()}`;
            this.activeSearches.add(searchId);
            
            try {
                const city = forceCity || AppState.currentCity;
                if (!city) {
                    console.warn('No city detected for search');
                    return [];
                }
                
                const cacheKey = `${query.toLowerCase()}-${type}-${city}-${location ? `${location.lat.toFixed(4)},${location.lng.toFixed(4)}` : 'none'}`;
                
                // Return cached results if available and recent (5 minutes)
                if (this.cache.has(cacheKey)) {
                    const cached = this.cache.get(cacheKey);
                    if (Date.now() - cached.timestamp < 300000) {
                        console.log('Returning cached search results');
                        return cached.results;
                    }
                }
                
                console.log(`Searching for "${query}" in ${city}, type: ${type}`);
                
                // Build search URL with city constraints
                const searchUrl = this.buildCityConstrainedSearchUrl(query, city, location);
                
                // Show search loading indicator
                this.showSearchLoading(true);
                
                const response = await fetch(searchUrl, {
                    headers: {
                        'User-Agent': 'JubelRideApp/1.0',
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Search failed: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log(`Received ${data.length} results for "${query}"`);
                
                // Process and filter results
                const results = this.processAndFilterResults(data, location, city, type);
                
                // Cache the results
                this.cache.set(cacheKey, {
                    results: results,
                    timestamp: Date.now(),
                    query: query,
                    city: city
                });
                
                // Add to search history if it's a destination search
                if (type === 'destination' && results.length > 0) {
                    this.addToHistory(query, results[0], type);
                }
                
                // Update last search time
                this.lastSearch = Date.now();
                
                return results;
            } catch (error) {
                console.error('Search error:', error);
                
                // Fallback to local search within city
                if (AppState.currentCity) {
                    const fallbackResults = this.localCitySearch(query, AppState.currentCity, location);
                    if (fallbackResults.length > 0) {
                        console.log(`Using fallback local search: ${fallbackResults.length} results`);
                        return fallbackResults;
                    }
                }
                
                EnhancedUIUpdater.showToast('Search service temporarily unavailable. Please try again.', 'warning');
                return [];
            } finally {
                this.activeSearches.delete(searchId);
                this.showSearchLoading(false);
            }
        },
        
        buildCityConstrainedSearchUrl: function(query, city, location) {
            const bounds = this.getCityBounds(city);
            if (!bounds) {
                console.warn(`No bounds found for city: ${city}, using wider search`);
                return this.buildSearchUrl(query, location, city);
            }
            
            // Use bounded search for better accuracy
            const params = new URLSearchParams({
                q: `${query}, ${city}, Zambia`,
                format: 'json',
                limit: 20,
                countrycodes: 'zm',
                bounded: 1,
                viewbox: bounds.join(','),
                'accept-language': 'en',
                addressdetails: 1,
                polygon: 0,
                extratags: 0,
                namedetails: 0
            });
            
            return `https://nominatim.openstreetmap.org/search?${params}`;
        },
        
        buildSearchUrl: function(query, location, city) {
            const params = new URLSearchParams({
                q: `${query}${city ? `, ${city}, Zambia` : ', Zambia'}`,
                format: 'json',
                limit: 15,
                countrycodes: 'zm',
                'accept-language': 'en',
                addressdetails: 1
            });
            
            return `https://nominatim.openstreetmap.org/search?${params}`;
        },
        
        getCityBounds: function(cityName) {
            const cityBounds = {
                'Lusaka': [27.8, -15.8, 28.8, -15.2],
                'Ndola': [28.5, -13.1, 28.8, -12.9],
                'Kitwe': [27.9, -13.1, 28.4, -12.7],
                'Kabwe': [28.3, -14.6, 28.6, -14.3],
                'Livingstone': [25.7, -18.0, 26.0, -17.7],
                'Chipata': [32.5, -13.8, 32.8, -13.6],
                'Chingola': [27.8, -12.8, 27.9, -12.4],
                'Mufulira': [28.1, -12.7, 28.3, -12.5],
                'Luanshya': [28.3, -13.2, 28.5, -13.0],
                'Kasama': [31.1, -10.3, 31.3, -10.1],
                'Solwezi': [26.3, -12.3, 26.5, -12.1],
                'Mazabuka': [27.7, -15.9, 27.9, -15.7]
            };
            
            const bounds = cityBounds[cityName];
            if (bounds) {
                AppState.locationManagement.cityBounds = bounds;
                console.log(`City bounds for ${cityName}: ${bounds}`);
            }
            
            return bounds || null;
        },
        
        processAndFilterResults: function(data, location, city, type) {
            if (!data || data.length === 0) return [];
            
            const cityLower = city.toLowerCase();
            const processedResults = [];
            
            data.forEach(place => {
                try {
                    const address = place.address || {};
                    const placeCity = address.city || address.town || address.village || address.municipality;
                    const placeCityLower = placeCity ? placeCity.toLowerCase() : '';
                    
                    // Strict city filtering - only include places in the current city
                    if (city && !this.isInCity(place, cityLower, placeCityLower)) {
                        return; // Skip this result
                    }
                    
                    // Calculate distance if location provided
                    let distance = 0;
                    if (location) {
                        distance = this.calculateDistance(
                            location.lat, location.lng,
                            parseFloat(place.lat), parseFloat(place.lon)
                        );
                    }
                    
                    // Format address for display
                    const displayAddress = this.formatAddress(place, city);
                    
                    const result = {
                        id: place.place_id || `${place.lat}-${place.lon}`,
                        name: place.display_name.split(',')[0] || 'Unnamed Location',
                        address: displayAddress,
                        fullAddress: place.display_name,
                        lat: parseFloat(place.lat),
                        lng: parseFloat(place.lon),
                        type: place.type || place.class || 'unknown',
                        importance: place.importance || 0,
                        distance: distance,
                        city: placeCity || city,
                        placeType: place.type,
                        category: this.categorizePlace(place),
                        relevance: this.calculateRelevance(place, location, city, type),
                        boundingbox: place.boundingbox,
                        isVerified: this.isVerifiedLocation(place)
                    };
                    
                    processedResults.push(result);
                } catch (error) {
                    console.error('Error processing search result:', error, place);
                }
            });
            
            // Sort by relevance and distance
            return processedResults
                .sort((a, b) => {
                    // Sort by verified status first
                    if (a.isVerified !== b.isVerified) {
                        return b.isVerified - a.isVerified;
                    }
                    
                    // Then by relevance score
                    if (a.relevance !== b.relevance) {
                        return b.relevance - a.relevance;
                    }
                    
                    // Then by distance if location is available
                    if (location && a.distance !== b.distance) {
                        return a.distance - b.distance;
                    }
                    
                    // Finally by importance
                    return b.importance - a.importance;
                })
                .slice(0, 10); // Limit to 10 most relevant results
        },
        
        isInCity: function(place, targetCity, placeCity) {
            if (!targetCity) return true;
            
            // Check if place city matches target city
            if (placeCity && placeCity.includes(targetCity)) {
                return true;
            }
            
            // Check address components
            const address = place.address || {};
            const components = [
                address.city,
                address.town,
                address.village,
                address.municipality,
                address.county,
                address.state_district
            ].filter(Boolean);
            
            return components.some(component => 
                component.toLowerCase().includes(targetCity)
            );
        },
        
        calculateRelevance: function(place, location, city, type) {
            let score = place.importance || 0;
            
            // Boost if in current city
            if (city) {
                const address = place.address || {};
                const placeCity = address.city || address.town || address.village;
                if (placeCity && placeCity.toLowerCase().includes(city.toLowerCase())) {
                    score += 0.4; // Strong boost for being in correct city
                }
            }
            
            // Boost by proximity if location is available
            if (location) {
                const distance = this.calculateDistance(
                    location.lat, location.lng,
                    parseFloat(place.lat), parseFloat(place.lon)
                );
                
                // Higher boost for closer locations
                if (distance < 1) score += 0.3;
                else if (distance < 3) score += 0.2;
                else if (distance < 5) score += 0.1;
                else if (distance < 10) score += 0.05;
            }
            
            // Boost for exact name matches
            if (place.display_name.split(',')[0].toLowerCase() === 
                AppState.lastSearchQuery?.toLowerCase()) {
                score += 0.5;
            }
            
            // Boost for specific types based on search type
            if (type === 'destination') {
                if (place.type === 'restaurant' || place.type === 'hotel' || 
                    place.type === 'mall' || place.type === 'supermarket') {
                    score += 0.2;
                }
            }
            
            // Ensure score doesn't exceed 1.0
            return Math.min(score, 1.0);
        },
        
        formatAddress: function(place, currentCity) {
            const address = place.address || {};
            const parts = [];
            
            // Add house number if available
            if (address.house_number || address.housenumber) {
                parts.push(address.house_number || address.housenumber);
            }
            
            // Add road
            if (address.road) {
                parts.push(address.road);
            }
            
            // Add suburb/neighbourhood
            if (address.suburb || address.neighbourhood) {
                parts.push(address.suburb || address.neighbourhood);
            }
            
            // Add city/town (but not if it's the current city we're searching in)
            if (address.city || address.town) {
                const cityName = address.city || address.town;
                if (cityName.toLowerCase() !== currentCity.toLowerCase()) {
                    parts.push(cityName);
                }
            }
            
            // If we have no specific address parts, use a shortened version of display_name
            if (parts.length === 0) {
                return place.display_name.split(',').slice(0, 2).join(',').trim();
            }
            
            return parts.join(', ');
        },
        
        categorizePlace: function(place) {
            const type = place.type || place.class || '';
            
            if (type.includes('restaurant') || type.includes('cafe') || type.includes('fast_food')) {
                return 'restaurant';
            } else if (type.includes('hotel') || type.includes('motel') || type.includes('guest_house')) {
                return 'hotel';
            } else if (type.includes('mall') || type.includes('supermarket') || type.includes('shop')) {
                return 'shopping';
            } else if (type.includes('bank') || type.includes('atm')) {
                return 'bank';
            } else if (type.includes('hospital') || type.includes('clinic') || type.includes('pharmacy')) {
                return 'medical';
            } else if (type.includes('school') || type.includes('university') || type.includes('college')) {
                return 'education';
            } else if (type.includes('government') || type.includes('office')) {
                return 'government';
            } else {
                return 'other';
            }
        },
        
        isVerifiedLocation: function(place) {
            // Mark certain types as verified
            const verifiedTypes = [
                'restaurant', 'hotel', 'mall', 'supermarket', 'bank', 'hospital',
                'clinic', 'school', 'university', 'government'
            ];
            
            const type = place.type || place.class || '';
            return verifiedTypes.some(verifiedType => type.includes(verifiedType));
        },
        
        calculateDistance: function(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = this.toRad(lat2 - lat1);
            const dLon = this.toRad(lon2 - lon1);
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(this.toRad(lat1)) * Math.cos(this.toRad(lat2)) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        },
        
        toRad: function(value) {
            return value * Math.PI / 180;
        },
        
        localCitySearch: function(query, city, location) {
            console.log(`Performing local search for "${query}" in ${city}`);
            
            const localPlaces = this.getLocalPlaces(city);
            if (!localPlaces || localPlaces.length === 0) {
                console.log(`No local places found for city: ${city}`);
                return [];
            }
            
            const searchTerm = query.toLowerCase();
            const results = localPlaces
                .filter(place => {
                    const nameMatch = place.name.toLowerCase().includes(searchTerm);
                    const addressMatch = place.address.toLowerCase().includes(searchTerm);
                    const categoryMatch = place.category?.toLowerCase().includes(searchTerm);
                    return nameMatch || addressMatch || categoryMatch;
                })
                .map(place => ({
                    ...place,
                    distance: location ? 
                        this.calculateDistance(
                            location.lat, location.lng,
                            place.lat, place.lng
                        ) : 0,
                    relevance: this.calculateLocalRelevance(place, searchTerm, location)
                }))
                .sort((a, b) => {
                    if (a.relevance !== b.relevance) {
                        return b.relevance - a.relevance;
                    }
                    return a.distance - b.distance;
                })
                .slice(0, 10);
            
            console.log(`Local search found ${results.length} results`);
            return results;
        },
        
        calculateLocalRelevance: function(place, searchTerm, location) {
            let score = 0;
            
            // Name match
            if (place.name.toLowerCase().includes(searchTerm)) {
                score += 0.5;
            }
            
            // Address match
            if (place.address.toLowerCase().includes(searchTerm)) {
                score += 0.3;
            }
            
            // Category match
            if (place.category?.toLowerCase().includes(searchTerm)) {
                score += 0.2;
            }
            
            // Distance boost
            if (location && place.distance < 5) {
                score += 0.3;
            } else if (location && place.distance < 10) {
                score += 0.1;
            }
            
            return Math.min(score, 1.0);
        },
        
        getLocalPlaces: function(city) {
            // Comprehensive local places database for Zambian cities
            const cityPlaces = {
                'Lusaka': [
                    { name: 'Manda Hill Mall', address: 'Manda Hill, Lusaka', lat: -15.4167, lng: 28.2833, category: 'shopping' },
                    { name: 'East Park Mall', address: 'Great East Road, Lusaka', lat: -15.4000, lng: 28.3000, category: 'shopping' },
                    { name: 'University of Zambia', address: 'Great East Road, Lusaka', lat: -15.3900, lng: 28.3200, category: 'education' },
                    { name: 'Kamwala Market', address: 'Kamwala, Lusaka', lat: -15.4200, lng: 28.2700, category: 'shopping' },
                    { name: 'Kenneth Kaunda International Airport', address: 'Airport Road, Lusaka', lat: -15.3308, lng: 28.4526, category: 'transport' },
                    { name: 'Levy Mwanawasa Hospital', address: 'Great North Road, Lusaka', lat: -15.3950, lng: 28.3050, category: 'medical' },
                    { name: 'University Teaching Hospital', address: 'Ridgeway, Lusaka', lat: -15.4050, lng: 28.2950, category: 'medical' },
                    { name: 'Lusaka Central Police', address: 'Cairo Road, Lusaka', lat: -15.4167, lng: 28.2833, category: 'government' },
                    { name: 'Arcades Shopping Centre', address: 'Kasangula Road, Lusaka', lat: -15.4100, lng: 28.2900, category: 'shopping' },
                    { name: 'Zambia National Assembly', address: 'Lusaka City Centre', lat: -15.4180, lng: 28.2850, category: 'government' },
                    { name: 'Lusaka City Market', address: 'City Centre, Lusaka', lat: -15.4190, lng: 28.2820, category: 'shopping' },
                    { name: 'Lusaka Playhouse', address: 'Freedom Way, Lusaka', lat: -15.4150, lng: 28.2800, category: 'entertainment' },
                    { name: 'State House', address: 'Independence Avenue, Lusaka', lat: -15.4120, lng: 28.2880, category: 'government' },
                    { name: 'Lusaka National Museum', address: 'Independence Avenue, Lusaka', lat: -15.4140, lng: 28.2860, category: 'cultural' },
                    { name: 'Lusaka Golf Club', address: 'United Nations Avenue, Lusaka', lat: -15.4080, lng: 28.2920, category: 'sports' }
                ],
                'Ndola': [
                    { name: 'Northrise Mall', address: 'Northrise, Ndola', lat: -13.0000, lng: 28.6500, category: 'shopping' },
                    { name: 'Mukuba Mall', address: 'Ndola Central', lat: -12.9700, lng: 28.6300, category: 'shopping' },
                    { name: 'Ndola Central Hospital', address: 'Ndola Central', lat: -12.9750, lng: 28.6350, category: 'medical' },
                    { name: 'Simon Mwansa Kapwepwe International Airport', address: 'Airport Road, Ndola', lat: -12.9980, lng: 28.6640, category: 'transport' },
                    { name: 'Ndola Teaching Hospital', address: 'Masala, Ndola', lat: -12.9900, lng: 28.6400, category: 'medical' }
                ],
                'Kitwe': [
                    { name: 'Mukuba Mall', address: 'Kitwe Central', lat: -12.8200, lng: 28.2000, category: 'shopping' },
                    { name: 'Kitwe Central Hospital', address: 'Kitwe Central', lat: -12.8150, lng: 28.2050, category: 'medical' },
                    { name: 'South Downs Mall', address: 'Parklands, Kitwe', lat: -12.8300, lng: 28.2100, category: 'shopping' },
                    { name: 'Copperbelt University', address: 'Jambo Drive, Kitwe', lat: -12.8400, lng: 28.2200, category: 'education' }
                ],
                'Livingstone': [
                    { name: 'Victoria Falls', address: 'Livingstone', lat: -17.9240, lng: 25.8570, category: 'tourist' },
                    { name: 'Livingstone Museum', address: 'Mosi-o-tunya Road, Livingstone', lat: -17.8500, lng: 25.8600, category: 'cultural' },
                    { name: 'Harry Mwanga Nkumbula International Airport', address: 'Airport Road, Livingstone', lat: -17.8210, lng: 25.8220, category: 'transport' },
                    { name: 'Livingstone Central Hospital', address: 'Katongo, Livingstone', lat: -17.8550, lng: 25.8650, category: 'medical' }
                ],
                'Kabwe': [
                    { name: 'Mukobeko Maximum Security Prison', address: 'Kabwe Central', lat: -14.4500, lng: 28.4500, category: 'government' },
                    { name: 'Kabwe Central Hospital', address: 'Kabwe Central', lat: -14.4400, lng: 28.4450, category: 'medical' },
                    { name: 'Kabwe Museum', address: 'Independence Avenue, Kabwe', lat: -14.4350, lng: 28.4550, category: 'cultural' }
                ],
                'Chipata': [
                    { name: 'Chipata Central Hospital', address: 'Chipata Central', lat: -13.6500, lng: 32.6500, category: 'medical' },
                    { name: 'Chipata Airport', address: 'Airport Road, Chipata', lat: -13.5580, lng: 32.5870, category: 'transport' }
                ]
            };
            
            return cityPlaces[city] || [];
        },
        
        searchEmergencyStations: async function(type, city) {
            const cacheKey = `emergency-${type}-${city}`;
            
            if (this.cache.has(cacheKey)) {
                const cached = this.cache.get(cacheKey);
                if (Date.now() - cached.timestamp < 3600000) { // 1 hour cache
                    return cached.results;
                }
            }
            
            try {
                let query = '';
                switch(type) {
                    case 'police':
                        query = `police station ${city} Zambia`;
                        break;
                    case 'fire':
                        query = `fire station ${city} Zambia`;
                        break;
                    case 'medical':
                        query = `hospital ${city} Zambia clinic ${city} Zambia`;
                        break;
                }
                
                const bounds = this.getCityBounds(city);
                const params = new URLSearchParams({
                    q: query,
                    format: 'json',
                    limit: 20,
                    countrycodes: 'zm',
                    bounded: bounds ? 1 : 0,
                    'accept-language': 'en',
                    addressdetails: 1
                });
                
                if (bounds) {
                    params.append('viewbox', bounds.join(','));
                }
                
                const searchUrl = `https://nominatim.openstreetmap.org/search?${params}`;
                const response = await fetch(searchUrl);
                
                if (!response.ok) throw new Error(`Emergency search failed: ${response.status}`);
                
                const data = await response.json();
                const results = data.map(place => ({
                    id: place.place_id,
                    name: place.display_name.split(',')[0],
                    address: this.formatAddress(place, city),
                    fullAddress: place.display_name,
                    lat: parseFloat(place.lat),
                    lng: parseFloat(place.lon),
                    type: type,
                    distance: AppState.userLocation ? 
                        this.calculateDistance(
                            AppState.userLocation.lat, AppState.userLocation.lng,
                            parseFloat(place.lat), parseFloat(place.lon)
                        ) : 0,
                    verified: true
                })).sort((a, b) => a.distance - b.distance);
                
                // Cache the results
                this.cache.set(cacheKey, {
                    results: results,
                    timestamp: Date.now()
                });
                
                AppState.emergencyStations[type] = results;
                return results;
            } catch (error) {
                console.error('Emergency station search error:', error);
                return this.getDefaultEmergencyStations(type, city);
            }
        },
        
        getDefaultEmergencyStations: function(type, city) {
            const defaultStations = {
                'Lusaka': {
                    police: [
                        { name: 'Lusaka Central Police', address: 'Cairo Road, Lusaka', lat: -15.4167, lng: 28.2833, distance: 0, verified: true },
                        { name: 'Kabulonga Police Station', address: 'Kabulonga, Lusaka', lat: -15.4000, lng: 28.3000, distance: 0, verified: true },
                        { name: 'Woodlands Police Station', address: 'Woodlands, Lusaka', lat: -15.3900, lng: 28.3200, distance: 0, verified: true },
                        { name: 'Matero Police Station', address: 'Matero, Lusaka', lat: -15.4150, lng: 28.2750, distance: 0, verified: true }
                    ],
                    fire: [
                        { name: 'Lusaka Fire Brigade', address: 'Cairo Road, Lusaka', lat: -15.4100, lng: 28.2900, distance: 0, verified: true },
                        { name: 'Industrial Fire Station', address: 'Industrial Area, Lusaka', lat: -15.4200, lng: 28.2700, distance: 0, verified: true }
                    ],
                    medical: [
                        { name: 'University Teaching Hospital', address: 'Ridgeway, Lusaka', lat: -15.4050, lng: 28.2950, distance: 0, verified: true },
                        { name: 'Levy Mwanawasa Hospital', address: 'Great North Road, Lusaka', lat: -15.3950, lng: 28.3050, distance: 0, verified: true },
                        { name: 'Matero Hospital', address: 'Matero, Lusaka', lat: -15.4150, lng: 28.2750, distance: 0, verified: true },
                        { name: 'Chipata Level 1 Hospital', address: 'Chipata Compound, Lusaka', lat: -15.4250, lng: 28.2650, distance: 0, verified: true }
                    ]
                },
                'Ndola': {
                    police: [
                        { name: 'Ndola Central Police', address: 'Ndola Central', lat: -12.9700, lng: 28.6300, distance: 0, verified: true },
                        { name: 'Masala Police Station', address: 'Masala, Ndola', lat: -12.9900, lng: 28.6400, distance: 0, verified: true }
                    ],
                    fire: [
                        { name: 'Ndola Fire Station', address: 'Ndola Central', lat: -12.9750, lng: 28.6350, distance: 0, verified: true }
                    ],
                    medical: [
                        { name: 'Ndola Central Hospital', address: 'Ndola Central', lat: -12.9750, lng: 28.6350, distance: 0, verified: true },
                        { name: 'Ndola Teaching Hospital', address: 'Masala, Ndola', lat: -12.9900, lng: 28.6400, distance: 0, verified: true }
                    ]
                }
            };
            
            const stations = defaultStations[city]?.[type] || [];
            
            // Calculate distances if user location is available
            if (AppState.userLocation) {
                stations.forEach(station => {
                    station.distance = this.calculateDistance(
                        AppState.userLocation.lat, AppState.userLocation.lng,
                        station.lat, station.lng
                    );
                });
                
                stations.sort((a, b) => a.distance - b.distance);
            }
            
            AppState.emergencyStations[type] = stations;
            return stations;
        },
        
        showSearchLoading: function(show) {
            const loadingElement = document.getElementById('searchLoading');
            if (loadingElement) {
                loadingElement.style.display = show ? 'flex' : 'none';
            }
        },
        
        clearCache: function() {
            this.cache.clear();
            console.log('Search cache cleared');
        },
        
        getSearchHistory: function(type = null, city = null) {
            let history = this.searchHistory;
            
            if (type) {
                history = history.filter(item => item.type === type);
            }
            
            if (city) {
                history = history.filter(item => item.city === city);
            }
            
            return history;
        },
        
        clearSearchHistory: function() {
            this.searchHistory = [];
            this.saveSearchHistory();
            EnhancedUIUpdater.showToast('Search history cleared', 'success');
        },
        
        validateCoordinatesInCity: function(lat, lng, city) {
            const bounds = this.getCityBounds(city);
            if (!bounds) return true; // If no bounds, assume valid
            
            const [west, south, east, north] = bounds;
            return lng >= west && lng <= east && lat >= south && lat <= north;
        }
    };

    // ============================================
    // ENHANCED LOCATION MANAGEMENT
    // ============================================
    const EnhancedLocationManager = {
        currentPickupInput: null,
        pickupEditMode: false,
        
        init: function() {
            console.log('Enhanced Location Manager initialized');
            this.setupLocationInputs();
        },
        
        setupLocationInputs: function() {
            // Setup all pickup inputs with enhanced functionality
            const pickupInputs = [
                'pickupLocation', 'deliveryPickup', 'shortDeliveryPickup',
                'truckPickup', 'schedulePickup', 'someonePickup',
                'sharePickup', 'broadcastPickup', 'emergencyPickup'
            ];
            
            pickupInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    this.setupPickupInput(input);
                }
            });
            
            // Setup all destination inputs
            const destinationInputs = [
                'destinationLocation', 'deliveryDestination', 'shortDeliveryDestination',
                'truckDestination', 'scheduleDestination', 'someoneDestination',
                'shareDestination', 'broadcastDestination', 'shoppingDestination',
                'emergencyDestination'
            ];
            
            destinationInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    this.setupDestinationInput(input);
                }
            });
        },
        
        setupPickupInput: function(inputElement) {
            const inputId = inputElement.id;
            
            // Add clear button if not present
            if (!inputElement.parentNode.querySelector('.clear-pickup-btn')) {
                const clearBtn = document.createElement('button');
                clearBtn.type = 'button';
                clearBtn.className = 'clear-pickup-btn';
                clearBtn.innerHTML = '<i class="fas fa-times"></i>';
                clearBtn.title = 'Clear pickup location';
                clearBtn.style.cssText = `
                    position: absolute;
                    right: 10px;
                    top: 50%;
                    transform: translateY(-50%);
                    background: none;
                    border: none;
                    color: var(--text-gray);
                    font-size: 14px;
                    cursor: pointer;
                    display: none;
                    z-index: 10;
                `;
                
                inputElement.parentNode.style.position = 'relative';
                inputElement.parentNode.appendChild(clearBtn);
                
                clearBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.clearPickupLocation(inputId);
                });
            }
            
            // Add edit button if not present
            if (!inputElement.parentNode.querySelector('.edit-pickup-btn')) {
                const editBtn = document.createElement('button');
                editBtn.type = 'button';
                editBtn.className = 'edit-pickup-btn';
                editBtn.innerHTML = '<i class="fas fa-edit"></i>';
                editBtn.title = 'Edit pickup location';
                editBtn.style.cssText = `
                    position: absolute;
                    right: 40px;
                    top: 50%;
                    transform: translateY(-50%);
                    background: none;
                    border: none;
                    color: var(--primary-orange);
                    font-size: 14px;
                    cursor: pointer;
                    display: none;
                    z-index: 10;
                `;
                
                inputElement.parentNode.appendChild(editBtn);
                
                editBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.enablePickupEditMode(inputId);
                });
            }
            
            // Input event listeners
            inputElement.addEventListener('focus', () => {
                this.handlePickupInputFocus(inputId);
            });
            
            inputElement.addEventListener('input', (e) => {
                this.handlePickupInputChange(inputId, e.target.value);
            });
            
            inputElement.addEventListener('blur', () => {
                setTimeout(() => {
                    this.handlePickupInputBlur(inputId);
                }, 200);
            });
            
            // Show/hide buttons based on content
            inputElement.addEventListener('input', () => {
                this.updatePickupInputButtons(inputId);
            });
        },
        
        setupDestinationInput: function(inputElement) {
            const inputId = inputElement.id;
            
            inputElement.addEventListener('focus', () => {
                this.handleDestinationInputFocus(inputId);
            });
            
            inputElement.addEventListener('input', (e) => {
                this.handleDestinationInputChange(inputId, e.target.value);
            });
            
            inputElement.addEventListener('blur', () => {
                setTimeout(() => {
                    this.handleDestinationInputBlur(inputId);
                }, 200);
            });
        },
        
        handlePickupInputFocus: function(inputId) {
            const input = document.getElementById(inputId);
            const parent = input.closest('.location-input');
            
            if (parent) {
                parent.classList.add('active');
                
                // Show search history if input is empty
                if (!input.value.trim() && inputId.includes('pickup')) {
                    EnhancedUIUpdater.showSearchHistory(inputId);
                }
                
                // Show clear/edit buttons if there's a value
                this.updatePickupInputButtons(inputId);
            }
        },
        
        handlePickupInputChange: function(inputId, value) {
            if (!value.trim() || value.length < 2) {
                const suggestions = document.getElementById(`${inputId}Suggestions`);
                if (suggestions) {
                    suggestions.classList.remove('active');
                }
                return;
            }
            
            // Debounced search
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(async () => {
                await this.searchPickupLocations(inputId, value);
            }, 300);
        },
        
        handlePickupInputBlur: function(inputId) {
            const input = document.getElementById(inputId);
            const parent = input.closest('.location-input');
            
            if (parent) {
                parent.classList.remove('active');
            }
        },
        
        handleDestinationInputFocus: function(inputId) {
            const input = document.getElementById(inputId);
            const parent = input.closest('.location-input');
            
            if (parent) {
                parent.classList.add('active');
                
                // Show search history if input is empty
                if (!input.value.trim()) {
                    EnhancedUIUpdater.showSearchHistory(inputId);
                }
            }
        },
        
        handleDestinationInputChange: function(inputId, value) {
            if (!value.trim() || value.length < 2) {
                const suggestions = document.getElementById(`${inputId}Suggestions`);
                if (suggestions) {
                    suggestions.classList.remove('active');
                }
                return;
            }
            
            // Debounced search
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(async () => {
                await this.searchDestinationLocations(inputId, value);
            }, 300);
        },
        
        handleDestinationInputBlur: function(inputId) {
            const input = document.getElementById(inputId);
            const parent = input.closest('.location-input');
            
            if (parent) {
                parent.classList.remove('active');
            }
        },
        
        async searchPickupLocations(inputId, query) {
            if (!AppState.currentCity) {
                EnhancedUIUpdater.showToast('Please wait while we detect your city', 'warning');
                return;
            }
            
            const input = document.getElementById(inputId);
            const parent = input.closest('.location-input');
            
            if (parent) {
                parent.classList.add('searching');
            }
            
            try {
                const results = await EnhancedSearchEngine.search(
                    query,
                    'pickup',
                    AppState.userLocation,
                    AppState.currentCity
                );
                
                EnhancedUIUpdater.showSearchSuggestions(inputId, results, 'pickup');
                
                // Store results for pickup selection
                AppState.locationManagement.pickupSearchResults = results;
                
            } catch (error) {
                console.error('Pickup search error:', error);
            } finally {
                if (parent) {
                    parent.classList.remove('searching');
                }
            }
        },
        
        async searchDestinationLocations(inputId, query) {
            if (!AppState.currentCity) {
                EnhancedUIUpdater.showToast('Please wait while we detect your city', 'warning');
                return;
            }
            
            const input = document.getElementById(inputId);
            const parent = input.closest('.location-input');
            
            if (parent) {
                parent.classList.add('searching');
            }
            
            try {
                const results = await EnhancedSearchEngine.search(
                    query,
                    'destination',
                    AppState.userLocation,
                    AppState.currentCity
                );
                
                EnhancedUIUpdater.showSearchSuggestions(inputId, results, 'destination');
                
            } catch (error) {
                console.error('Destination search error:', error);
            } finally {
                if (parent) {
                    parent.classList.remove('searching');
                }
            }
        },
        
        clearPickupLocation: function(inputId) {
            const input = document.getElementById(inputId);
            const clearBtn = input.parentNode.querySelector('.clear-pickup-btn');
            const editBtn = input.parentNode.querySelector('.edit-pickup-btn');
            
            // Clear input value
            input.value = '';
            
            // Hide buttons
            if (clearBtn) clearBtn.style.display = 'none';
            if (editBtn) editBtn.style.display = 'none';
            
            // Clear AppState pickup
            AppState.pickup = null;
            
            // Remove pickup marker from map
            if (pickupMarker) {
                map.removeLayer(pickupMarker);
                pickupMarker = null;
            }
            
            // Remove route if exists
            if (routeLayer) {
                map.removeLayer(routeLayer);
                routeLayer = null;
            }
            
            // Reset price display
            document.getElementById('fareDisplay').classList.remove('active');
            document.getElementById('rideTypeSelection').classList.remove('active');
            
            EnhancedUIUpdater.showToast('Pickup location cleared', 'info');
            
            // Reset edit mode
            this.pickupEditMode = false;
            this.currentPickupInput = null;
        },
        
        enablePickupEditMode: function(inputId) {
            const input = document.getElementById(inputId);
            
            if (!input.value.trim()) {
                EnhancedUIUpdater.showToast('No pickup location to edit', 'warning');
                return;
            }
            
            this.pickupEditMode = true;
            this.currentPickupInput = inputId;
            
            // Highlight the input
            input.focus();
            input.select();
            
            // Show search suggestions for current value
            this.searchPickupLocations(inputId, input.value);
            
            EnhancedUIUpdater.showToast('Pickup edit mode enabled. Search for a new location.', 'info');
        },
        
        updatePickupInputButtons: function(inputId) {
            const input = document.getElementById(inputId);
            const clearBtn = input.parentNode.querySelector('.clear-pickup-btn');
            const editBtn = input.parentNode.querySelector('.edit-pickup-btn');
            
            if (input.value.trim()) {
                if (clearBtn) clearBtn.style.display = 'block';
                if (editBtn) editBtn.style.display = 'block';
            } else {
                if (clearBtn) clearBtn.style.display = 'none';
            }
        },
        
        selectPickupLocation: function(inputId, location) {
            const input = document.getElementById(inputId);
            const clearBtn = input.parentNode.querySelector('.clear-pickup-btn');
            const editBtn = input.parentNode.querySelector('.edit-pickup-btn');
            
            // Validate location is within city
            if (!EnhancedSearchEngine.validateCoordinatesInCity(location.lat, location.lng, AppState.currentCity)) {
                EnhancedUIUpdater.showToast(`Location must be within ${AppState.currentCity}`, 'warning');
                return;
            }
            
            // Update input value
            input.value = location.address || location.name;
            
            // Show buttons
            if (clearBtn) clearBtn.style.display = 'block';
            if (editBtn) editBtn.style.display = 'block';
            
            // Update AppState
            AppState.pickup = location;
            
            // Update pickup marker on map
            EnhancedUIUpdater.updatePickupMarker(location);
            
            // Calculate price if destination exists
            if (AppState.destination) {
                EnhancedUIUpdater.calculateAndUpdatePrices();
            }
            
            // Hide suggestions
            const suggestions = document.getElementById(`${inputId}Suggestions`);
            if (suggestions) {
                suggestions.classList.remove('active');
            }
            
            // Hide search history
            document.getElementById('searchHistory').style.display = 'none';
            
            // Exit edit mode if active
            if (this.pickupEditMode) {
                this.pickupEditMode = false;
                this.currentPickupInput = null;
                EnhancedUIUpdater.showToast('Pickup location updated', 'success');
            }
        },
        
        selectDestinationLocation: function(inputId, location) {
            const input = document.getElementById(inputId);
            
            // Validate location is within city
            if (!EnhancedSearchEngine.validateCoordinatesInCity(location.lat, location.lng, AppState.currentCity)) {
                EnhancedUIUpdater.showToast(`Location must be within ${AppState.currentCity}`, 'warning');
                return;
            }
            
            // Update input value
            input.value = location.address || location.name;
            
            // Update AppState
            AppState.destination = location;
            
            // Update destination marker on map
            EnhancedUIUpdater.updateDestinationMarker(location);
            
            // Calculate price if pickup exists
            if (AppState.pickup) {
                EnhancedUIUpdater.calculateAndUpdatePrices();
            }
            
            // Hide suggestions
            const suggestions = document.getElementById(`${inputId}Suggestions`);
            if (suggestions) {
                suggestions.classList.remove('active');
            }
            
            // Hide search history
            document.getElementById('searchHistory').style.display = 'none';
        },
        
        resetPickupEditMode: function() {
            this.pickupEditMode = false;
            this.currentPickupInput = null;
        },
        
        isPickupEditModeActive: function() {
            return this.pickupEditMode;
        },
        
        getCurrentPickupInput: function() {
            return this.currentPickupInput;
        }
    };

    // ============================================
    // ENHANCED PRICE CALCULATOR
    // ============================================
    const EnhancedPriceCalculator = {
        calculateRideFare: function(distanceKm, rideType = 'standard', surge = 1.0, timeOfDay = null) {
            const config = AppState.rideTypes[rideType] || AppState.rideTypes.standard;
            
            // Base fare + distance fare
            let fare = config.base + (distanceKm * config.perKm);
            
            // Apply ride type multiplier
            fare *= config.multiplier;
            
            // Apply surge pricing
            fare *= surge;
            
            // Apply time of day multiplier
            if (!timeOfDay) {
                timeOfDay = new Date().getHours();
            }
            
            if (timeOfDay >= 22 || timeOfDay <= 5) {
                fare *= 1.2; // 20% extra for late night
            } else if (timeOfDay >= 7 && timeOfDay <= 9) {
                fare *= 1.3; // 30% extra for morning rush
            } else if (timeOfDay >= 16 && timeOfDay <= 19) {
                fare *= 1.4; // 40% extra for evening rush
            }
            
            // Ensure minimum fare
            fare = Math.max(fare, config.min);
            
            // Round to 2 decimal places
            return Math.round(fare * 100) / 100;
        },
        
        calculateEmergencyFare: function(distanceKm, serviceType, surge = 1.0) {
            const config = AppState.emergencyServices[serviceType] || AppState.emergencyServices.police;
            
            let fare = config.base + (distanceKm * config.perKm);
            fare *= config.multiplier;
            fare *= surge;
            fare = Math.max(fare, config.min);
            
            return Math.round(fare * 100) / 100;
        },
        
        calculateDeliveryFare: function(distanceKm, deliveryType = 'standard', parcelValue = 0) {
            const config = AppState.deliveryTypes[deliveryType] || AppState.deliveryTypes.standard;
            
            let fare = config.base + (distanceKm * config.perKm);
            fare *= config.multiplier;
            
            // Add insurance for valuable parcels (1% of parcel value)
            if (parcelValue > 500) {
                fare += parcelValue * 0.01;
            }
            
            return Math.round(fare * 100) / 100;
        },
        
        calculateTruckFare: function(distanceKm, truckType = 'light', helpers = false) {
            const config = AppState.truckTypes[truckType] || AppState.truckTypes.light;
            
            let fare = config.base + (distanceKm * config.perKm);
            fare *= config.multiplier;
            
            // Add helper cost if needed
            if (helpers) {
                fare += 50;
            }
            
            return Math.round(fare * 100) / 100;
        },
        
        calculateShoppingFare: function(distanceKm, itemsCount = 1, budget = 0) {
            // Base fare + distance + item count
            let fare = 30 + (distanceKm * 2.5) + (itemsCount * 5);
            
            // Add 5% of budget for shopping service
            if (budget > 0) {
                fare += budget * 0.05;
            }
            
            return Math.round(fare * 100) / 100;
        },
        
        calculateDistance: function(lat1, lon1, lat2, lon2) {
            return EnhancedSearchEngine.calculateDistance(lat1, lon1, lat2, lon2);
        },
        
        estimateTime: function(distanceKm, rideType = 'standard', traffic = null) {
            // Base time + traffic factor
            const baseSpeed = rideType === 'premium' ? 45 : 35; // km/h
            let baseTime = (distanceKm / baseSpeed) * 60; // minutes
            
            // Apply traffic factor
            if (!traffic) {
                traffic = this.getTrafficFactor();
            }
            
            baseTime *= traffic;
            
            // Add pickup time
            if (rideType === 'premium') {
                baseTime += 2; // Premium cars are faster
            } else {
                baseTime += 5; // Standard pickup time
            }
            
            return Math.ceil(baseTime);
        },
        
        getTrafficFactor: function() {
            const hour = new Date().getHours();
            const day = new Date().getDay();
            
            // Weekday traffic patterns
            if (day >= 1 && day <= 5) { // Monday to Friday
                if ((hour >= 7 && hour <= 9) || (hour >= 16 && hour <= 19)) {
                    return 1.5; // Rush hour
                }
            }
            
            // Weekend traffic
            if (day === 6 || day === 0) { // Saturday or Sunday
                if (hour >= 12 && hour <= 16) {
                    return 1.3; // Weekend afternoon
                }
            }
            
            return 1.0; // Normal traffic
        },
        
        getSurgeMultiplier: function() {
            const hour = new Date().getHours();
            const day = new Date().getDay();
            
            // High demand times
            if (day >= 1 && day <= 5) { // Weekdays
                if (hour >= 7 && hour <= 9) return 1.5; // Morning rush
                if (hour >= 16 && hour <= 19) return 1.8; // Evening rush
            }
            
            if (day === 5 || day === 6) { // Friday or Saturday
                if (hour >= 20 && hour <= 23) return 2.0; // Weekend night
            }
            
            if (hour >= 22 || hour <= 5) return 1.8; // Late night
            
            return 1.0; // Normal demand
        },
        
        getFareBreakdown: function(distanceKm, rideType = 'standard', surge = 1.0) {
            const config = AppState.rideTypes[rideType] || AppState.rideTypes.standard;
            const baseFare = config.base;
            const distanceFare = distanceKm * config.perKm;
            const rideTypeMultiplier = config.multiplier;
            const surgeMultiplier = surge;
            const timeMultiplier = this.getTimeMultiplier();
            
            const subtotal = (baseFare + distanceFare) * rideTypeMultiplier;
            const surgeAmount = subtotal * (surgeMultiplier - 1);
            const timeAmount = subtotal * (timeMultiplier - 1);
            const total = subtotal * surgeMultiplier * timeMultiplier;
            
            return {
                baseFare: baseFare,
                distanceFare: distanceFare,
                rideTypeMultiplier: rideTypeMultiplier,
                surgeMultiplier: surgeMultiplier,
                timeMultiplier: timeMultiplier,
                surgeAmount: surgeAmount,
                timeAmount: timeAmount,
                subtotal: subtotal,
                total: Math.max(total, config.min)
            };
        },
        
        getTimeMultiplier: function() {
            const hour = new Date().getHours();
            if (hour >= 22 || hour <= 5) return 1.2; // Late night
            return 1.0;
        },
        
        calculateSharedRideFare: function(distanceKm, rideType = 'standard', passengerCount = 2, splitType = 'equal') {
            const totalFare = this.calculateRideFare(distanceKm, rideType);
            
            let shares = [];
            let yourShare = totalFare;
            
            if (passengerCount > 1) {
                switch(splitType) {
                    case 'equal':
                        const equalShare = totalFare / passengerCount;
                        yourShare = equalShare;
                        for (let i = 0; i < passengerCount - 1; i++) {
                            shares.push(equalShare);
                        }
                        break;
                        
                    case 'you_pay_more':
                        yourShare = totalFare * 0.7;
                        const otherShare = totalFare * 0.3 / (passengerCount - 1);
                        for (let i = 0; i < passengerCount - 1; i++) {
                            shares.push(otherShare);
                        }
                        break;
                        
                    case 'you_pay_all':
                        yourShare = totalFare;
                        for (let i = 0; i < passengerCount - 1; i++) {
                            shares.push(0);
                        }
                        break;
                }
            }
            
            return {
                total: totalFare,
                yourShare: yourShare,
                passengerShares: shares,
                splitType: splitType
            };
        },
        
        applyReferralDiscount: function(fare) {
            // Apply 50% discount for referral code
            return fare * 0.5;
        },
        
        validateDistanceWithinCity: function(startLat, startLng, endLat, endLng, city) {
            const distance = this.calculateDistance(startLat, startLng, endLat, endLng);
            
            // Maximum allowed distance within city (adjust based on city size)
            const maxCityDistance = {
                'Lusaka': 50,
                'Ndola': 30,
                'Kitwe': 25,
                'Livingstone': 20,
                'Kabwe': 20,
                'Chipata': 15,
                'default': 25
            };
            
            const maxDistance = maxCityDistance[city] || maxCityDistance.default;
            
            if (distance > maxDistance) {
                return {
                    valid: false,
                    distance: distance,
                    maxAllowed: maxDistance,
                    message: `Distance exceeds maximum allowed for ${city} (${maxDistance}km)`
                };
            }
            
            return {
                valid: true,
                distance: distance
            };
        }
    };

    // ============================================
    // ENHANCED UI UPDATER
    // ============================================
    const EnhancedUIUpdater = {
        updateWalletBalance: function(balance) {
            const formatted = `ZMW ${balance.toFixed(2)}`;
            document.getElementById('walletBalance').textContent = formatted;
            document.getElementById('accountBalance').textContent = formatted;
            document.getElementById('paymentBalance').textContent = formatted;
            document.getElementById('transferBalance').textContent = formatted;
            AppState.walletBalance = balance;
        },
        
        updateUserInfo: function(userData) {
            if (userData.name) {
                document.getElementById('userFullName').textContent = userData.name;
                document.getElementById('accountName').textContent = userData.name;
            }
            
            if (userData.phone) {
                document.getElementById('accountPhone').textContent = userData.phone;
            }
            
            if (userData.email) {
                document.getElementById('updateEmail').value = userData.email;
            }
            
            if (userData.referralCode) {
                document.getElementById('referralCode').textContent = userData.referralCode;
            }
        },
        
        showToast: function(message, type = 'info', duration = 5000) {
            const toastContainer = document.getElementById('toastContainer');
            const toastId = 'toast-' + Date.now();
            
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.id = toastId;
            toast.innerHTML = `
                <div class="toast-icon">
                    <i class="fas ${icons[type] || icons.info}"></i>
                </div>
                <div class="toast-content">
                    <div class="toast-title">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="EnhancedUIUpdater.removeToast('${toastId}')">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            toastContainer.appendChild(toast);
            
            // Auto-remove after duration
            setTimeout(() => {
                this.removeToast(toastId);
            }, duration);
            
            return toastId;
        },
        
        removeToast: function(toastId) {
            const toast = document.getElementById(toastId);
            if (toast) {
                toast.classList.add('hiding');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }
        },
        
        showLoading: function(message = 'Loading...') {
            const overlay = document.getElementById('loadingOverlay');
            const text = document.getElementById('loadingText');
            text.textContent = message;
            overlay.classList.add('active');
        },
        
        hideLoading: function() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.remove('active');
        },
        
        showMapLoading: function() {
            document.getElementById('mapLoadingOverlay').style.display = 'flex';
        },
        
        hideMapLoading: function() {
            document.getElementById('mapLoadingOverlay').style.display = 'none';
        },
        
        updateCityDisplay: function(city) {
            const display = document.getElementById('currentCityDisplay');
            if (city) {
                display.textContent = `City: ${city}`;
                display.parentElement.style.display = 'flex';
                
                // Update city in all relevant UI elements
                document.querySelectorAll('.current-city-label').forEach(element => {
                    element.textContent = city;
                });
                
                // Hide after 5 seconds
                setTimeout(() => {
                    display.parentElement.style.display = 'none';
                }, 5000);
            }
        },
        
        updateRidePrices: function(distanceKm) {
            const types = ['economy', 'standard', 'premium'];
            const surge = EnhancedPriceCalculator.getSurgeMultiplier();
            
            // Update ride type cards
            types.forEach(type => {
                const price = EnhancedPriceCalculator.calculateRideFare(distanceKm, type, surge);
                const element = document.getElementById(`${type}Price`);
                if (element) {
                    element.textContent = `ZMW ${price.toFixed(2)}`;
                }
                
                // Update ride type card display
                const card = document.querySelector(`.ride-type-card[data-type="${type}"]`);
                if (card) {
                    const priceElement = card.querySelector('.ride-type-price');
                    if (priceElement) {
                        priceElement.textContent = `ZMW ${price.toFixed(2)}`;
                    }
                }
            });
            
            // Update estimated fare display
            const selectedPrice = EnhancedPriceCalculator.calculateRideFare(distanceKm, AppState.selectedRideType, surge);
            document.getElementById('estimatedFare').textContent = `ZMW ${selectedPrice.toFixed(2)}`;
            
            // Update distance and time
            const time = EnhancedPriceCalculator.estimateTime(distanceKm, AppState.selectedRideType);
            document.getElementById('distanceDetail').textContent = `${distanceKm.toFixed(1)} km`;
            document.getElementById('timeDetail').textContent = `ETA: ${time} min`;
            
            AppState.rideFare = selectedPrice;
            
            // Update price calculator display
            this.updatePriceCalculator(distanceKm, AppState.selectedRideType, surge);
            
            // Show ride type selection horizontally
            this.showRideTypeSelection();
        },
        
        showRideTypeSelection: function() {
            const rideTypeSelection = document.getElementById('rideTypeSelection');
            if (rideTypeSelection) {
                rideTypeSelection.classList.add('active');
                rideTypeSelection.style.display = 'flex';
                rideTypeSelection.style.flexDirection = 'row';
                rideTypeSelection.style.justifyContent = 'space-around';
                rideTypeSelection.style.margin = '15px 0';
            }
        },
        
        updatePriceCalculator: function(distanceKm, rideType = 'standard', surge = 1.0) {
            const breakdown = EnhancedPriceCalculator.getFareBreakdown(distanceKm, rideType, surge);
            const calculator = document.getElementById('priceCalculator');
            const fareElement = document.getElementById('calculatedFare');
            const breakdownElement = document.getElementById('priceBreakdown');
            
            calculator.style.display = 'block';
            fareElement.textContent = `ZMW ${breakdown.total.toFixed(2)}`;
            
            let breakdownHTML = `
                <div class="price-breakdown-row">
                    <span>Base Fare:</span>
                    <span>ZMW ${breakdown.baseFare.toFixed(2)}</span>
                </div>
                <div class="price-breakdown-row">
                    <span>Distance (${distanceKm.toFixed(1)}km):</span>
                    <span>ZMW ${breakdown.distanceFare.toFixed(2)}</span>
                </div>
            `;
            
            if (breakdown.rideTypeMultiplier !== 1) {
                breakdownHTML += `
                    <div class="price-breakdown-row">
                        <span>${rideType.charAt(0).toUpperCase() + rideType.slice(1)} Multiplier:</span>
                        <span>${breakdown.rideTypeMultiplier.toFixed(1)}x</span>
                    </div>
                `;
            }
            
            if (breakdown.surgeMultiplier !== 1) {
                breakdownHTML += `
                    <div class="price-breakdown-row">
                        <span>Surge Pricing:</span>
                        <span>+ZMW ${breakdown.surgeAmount.toFixed(2)}</span>
                    </div>
                `;
            }
            
            if (breakdown.timeMultiplier !== 1) {
                breakdownHTML += `
                    <div class="price-breakdown-row">
                        <span>Time of Day:</span>
                        <span>+ZMW ${breakdown.timeAmount.toFixed(2)}</span>
                    </div>
                `;
            }
            
            breakdownHTML += `
                <div class="price-breakdown-row total">
                    <span>Total:</span>
                    <span>ZMW ${breakdown.total.toFixed(2)}</span>
                </div>
            `;
            
            breakdownElement.innerHTML = breakdownHTML;
            
            // Add animation
            calculator.classList.add('price-update-animation');
            setTimeout(() => {
                calculator.classList.remove('price-update-animation');
            }, 500);
        },
        
        updateDeliveryPrices: function(distanceKm, deliveryType = 'standard', parcelValue = 0) {
            const fare = EnhancedPriceCalculator.calculateDeliveryFare(distanceKm, deliveryType, parcelValue);
            const time = EnhancedPriceCalculator.estimateTime(distanceKm, 'standard');
            
            const display = document.getElementById('deliveryFareDisplay');
            const fareElement = document.getElementById('deliveryFare');
            const distanceElement = document.getElementById('deliveryDistance');
            const timeElement = document.getElementById('deliveryTime');
            
            display.style.display = 'block';
            fareElement.textContent = `ZMW ${fare.toFixed(2)}`;
            distanceElement.textContent = `${distanceKm.toFixed(1)} km`;
            timeElement.textContent = `ETA: ${time} min`;
            
            return { fare, time };
        },
        
        updateTruckPrices: function(distanceKm, truckType = 'light', helpers = false) {
            const fare = EnhancedPriceCalculator.calculateTruckFare(distanceKm, truckType, helpers);
            const time = EnhancedPriceCalculator.estimateTime(distanceKm, 'standard');
            
            const display = document.getElementById('truckFareDisplay');
            const fareElement = document.getElementById('truckFare');
            const distanceElement = document.getElementById('truckDistance');
            const timeElement = document.getElementById('truckTime');
            
            display.style.display = 'block';
            fareElement.textContent = `ZMW ${fare.toFixed(2)}`;
            distanceElement.textContent = `${distanceKm.toFixed(1)} km`;
            timeElement.textContent = `ETA: ${time} min`;
            
            return { fare, time };
        },
        
        updateShoppingPrices: function(distanceKm, itemsCount = 1, budget = 0) {
            const fare = EnhancedPriceCalculator.calculateShoppingFare(distanceKm, itemsCount, budget);
            const time = EnhancedPriceCalculator.estimateTime(distanceKm, 'standard') + 30; // Add shopping time
            
            const display = document.getElementById('shoppingFareDisplay');
            const fareElement = document.getElementById('shoppingFare');
            const distanceElement = document.getElementById('shoppingDistance');
            const timeElement = document.getElementById('shoppingTime');
            
            display.style.display = 'block';
            fareElement.textContent = `ZMW ${fare.toFixed(2)}`;
            distanceElement.textContent = `${distanceKm.toFixed(1)} km`;
            timeElement.textContent = `ETA: ${time} min`;
            
            return { fare, time };
        },
        
        updateShortDeliveryPrices: function(distanceKm) {
            const fare = Math.max(15, distanceKm * 2.5);
            const time = EnhancedPriceCalculator.estimateTime(distanceKm, 'standard');
            
            const display = document.getElementById('shortDeliveryFareDisplay');
            const fareElement = document.getElementById('shortDeliveryFare');
            const distanceElement = document.getElementById('shortDeliveryDistance');
            const timeElement = document.getElementById('shortDeliveryTime');
            
            display.style.display = 'block';
            fareElement.textContent = `ZMW ${fare.toFixed(2)}`;
            distanceElement.textContent = `${distanceKm.toFixed(1)} km`;
            timeElement.textContent = `ETA: ${time} min`;
            
            return { fare, time };
        },
        
        updateBroadcastPrices: function(distanceKm, rideType = 'standard', recipients = []) {
            const totalPassengers = recipients.length + 1;
            const calculation = EnhancedPriceCalculator.calculateSharedRideFare(distanceKm, rideType, totalPassengers, 'equal');
            
            const display = document.getElementById('broadcastFareDisplay');
            const fareElement = document.getElementById('broadcastFare');
            const distanceElement = document.getElementById('broadcastDistance');
            const timeElement = document.getElementById('broadcastTime');
            
            if (display) {
                display.style.display = 'block';
                fareElement.textContent = `ZMW ${calculation.total.toFixed(2)}`;
                distanceElement.textContent = `${distanceKm.toFixed(1)} km`;
                timeElement.textContent = `ETA: ${EnhancedPriceCalculator.estimateTime(distanceKm, rideType)} min`;
            }
            
            return calculation;
        },
        
        updateSharedRidePrices: function(distanceKm, rideType = 'standard', passengerCount = 2, splitType = 'equal') {
            const calculation = EnhancedPriceCalculator.calculateSharedRideFare(distanceKm, rideType, passengerCount, splitType);
            
            // Update UI with shared ride calculations
            const shareDisplay = document.getElementById('sharedRideBreakdown');
            if (shareDisplay) {
                let html = `
                    <div class="shared-ride-summary">
                        <div class="shared-item">
                            <span>Total Fare:</span>
                            <span class="shared-price">ZMW ${calculation.total.toFixed(2)}</span>
                        </div>
                        <div class="shared-item">
                            <span>Your Share:</span>
                            <span class="shared-price your-share">ZMW ${calculation.yourShare.toFixed(2)}</span>
                        </div>
                        <div class="shared-item">
                            <span>Each Friend:</span>
                            <span class="shared-price friend-share">ZMW ${calculation.passengerShares.length > 0 ? calculation.passengerShares[0].toFixed(2) : '0.00'}</span>
                        </div>
                    </div>
                `;
                
                shareDisplay.innerHTML = html;
                shareDisplay.style.display = 'block';
            }
            
            return calculation;
        },
        
        showSearchSuggestions: function(inputId, results, type = 'destination') {
            const container = document.getElementById(`${inputId}Suggestions`);
            if (!container) {
                // Create suggestions container if it doesn't exist
                const input = document.getElementById(inputId);
                if (input) {
                    const newContainer = document.createElement('div');
                    newContainer.id = `${inputId}Suggestions`;
                    newContainer.className = 'suggestion-list';
                    newContainer.style.cssText = `
                        position: absolute;
                        top: 100%;
                        left: 0;
                        width: 100%;
                        background: white;
                        border: 1px solid #ddd;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                        max-height: 300px;
                        overflow-y: auto;
                        z-index: 1000;
                        display: none;
                    `;
                    input.parentNode.style.position = 'relative';
                    input.parentNode.appendChild(newContainer);
                    return this.showSearchSuggestions(inputId, results, type);
                }
                return;
            }
            
            container.innerHTML = '';
            
            if (results.length === 0) {
                container.innerHTML = `
                    <div class="no-results">
                        <i class="fas fa-search"></i>
                        <div>No results found in ${AppState.currentCity}</div>
                        <div style="font-size: 11px; color: var(--text-light); margin-top: 5px;">
                            Try a different search term
                        </div>
                    </div>
                `;
            } else {
                results.forEach(result => {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item';
                    item.dataset.lat = result.lat;
                    item.dataset.lng = result.lng;
                    item.dataset.address = result.address;
                    item.dataset.name = result.name;
                    
                    let icon = 'fa-map-marker-alt';
                    let iconColor = 'var(--primary-orange)';
                    
                    if (result.category === 'restaurant') {
                        icon = 'fa-utensils';
                        iconColor = 'var(--warning-yellow)';
                    } else if (result.category === 'hotel') {
                        icon = 'fa-hotel';
                        iconColor = 'var(--info-blue)';
                    } else if (result.category === 'shopping') {
                        icon = 'fa-shopping-cart';
                        iconColor = 'var(--delivery-purple)';
                    } else if (result.category === 'medical') {
                        icon = 'fa-hospital';
                        iconColor = 'var(--error-red)';
                    } else if (result.category === 'education') {
                        icon = 'fa-graduation-cap';
                        iconColor = 'var(--success-green)';
                    } else if (result.isVerified) {
                        icon = 'fa-check-circle';
                        iconColor = 'var(--success-green)';
                    }
                    
                    item.innerHTML = `
                        <div class="suggestion-icon" style="color: ${iconColor}">
                            <i class="fas ${icon}"></i>
                        </div>
                        <div class="suggestion-details">
                            <div class="suggestion-name">${result.name}</div>
                            <div class="suggestion-address">${result.address}</div>
                            ${result.distance ? `<div class="suggestion-distance">${result.distance.toFixed(1)} km away</div>` : ''}
                            ${result.isVerified ? `<div class="suggestion-verified"><i class="fas fa-check-circle"></i> Verified</div>` : ''}
                        </div>
                    `;
                    
                    item.addEventListener('click', () => {
                        if (type === 'pickup') {
                            EnhancedLocationManager.selectPickupLocation(inputId, result);
                        } else {
                            EnhancedLocationManager.selectDestinationLocation(inputId, result);
                        }
                    });
                    
                    container.appendChild(item);
                });
                
                // Add current city note
                const cityNote = document.createElement('div');
                cityNote.className = 'city-search-note';
                cityNote.innerHTML = `
                    <i class="fas fa-city"></i>
                    <span>Searching within ${AppState.currentCity}</span>
                `;
                container.appendChild(cityNote);
            }
            
            container.style.display = 'block';
            
            // Position the suggestions container
            const input = document.getElementById(inputId);
            if (input) {
                const rect = input.getBoundingClientRect();
                container.style.top = `${rect.bottom + window.scrollY}px`;
                container.style.left = `${rect.left + window.scrollX}px`;
                container.style.width = `${rect.width}px`;
            }
        },
        
        showSearchHistory: function(inputId) {
            const container = document.getElementById('searchHistory');
            if (!container) {
                // Create search history container
                const newContainer = document.createElement('div');
                newContainer.id = 'searchHistory';
                newContainer.className = 'search-history';
                newContainer.style.cssText = `
                    position: absolute;
                    top: 100%;
                    left: 0;
                    width: 100%;
                    background: white;
                    border: 1px solid #ddd;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                    max-height: 300px;
                    overflow-y: auto;
                    z-index: 1000;
                    display: none;
                `;
                document.body.appendChild(newContainer);
                return this.showSearchHistory(inputId);
            }
            
            const history = EnhancedSearchEngine.getSearchHistory(
                inputId.includes('destination') ? 'destination' : 'pickup',
                AppState.currentCity
            );
            
            if (history.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            let html = `
                <div class="search-history-header">
                    <div><i class="fas fa-history"></i> Recent in ${AppState.currentCity}</div>
                    <button class="clear-history-btn" onclick="EnhancedSearchEngine.clearSearchHistory()">
                        Clear
                    </button>
                </div>
            `;
            
            history.forEach(item => {
                html += `
                    <div class="search-history-item" data-lat="${item.location.lat}" data-lng="${item.location.lng}">
                        <div class="search-history-icon">
                            <i class="fas fa-${item.type === 'destination' ? 'flag' : 'map-marker-alt'}"></i>
                        </div>
                        <div class="search-history-text">
                            <div>${item.location.name}</div>
                            <div style="font-size: 11px; color: var(--text-light);">${item.location.address}</div>
                        </div>
                        <div class="search-history-time">
                            ${this.formatTimeAgo(item.timestamp)}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            container.style.display = 'block';
            
            // Position the history container
            const input = document.getElementById(inputId);
            if (input) {
                const rect = input.getBoundingClientRect();
                container.style.top = `${rect.bottom + window.scrollY}px`;
                container.style.left = `${rect.left + window.scrollX}px`;
                container.style.width = `${rect.width}px`;
            }
            
            // Add click events
            container.querySelectorAll('.search-history-item').forEach(item => {
                item.addEventListener('click', () => {
                    const lat = parseFloat(item.dataset.lat);
                    const lng = parseFloat(item.dataset.lng);
                    const location = {
                        lat: lat,
                        lng: lng,
                        name: item.querySelector('.search-history-text div').textContent,
                        address: item.querySelector('.search-history-text div:nth-child(2)').textContent
                    };
                    
                    if (inputId.includes('pickup')) {
                        EnhancedLocationManager.selectPickupLocation(inputId, location);
                    } else {
                        EnhancedLocationManager.selectDestinationLocation(inputId, location);
                    }
                    container.style.display = 'none';
                });
            });
        },
        
        formatTimeAgo: function(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            
            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
            return `${Math.floor(diff / 86400000)}d ago`;
        },
        
        updatePickupMarker: function(location) {
            if (!map) {
                console.error('Map not initialized');
                return;
            }
            
            if (pickupMarker) {
                pickupMarker.setLatLng([location.lat, location.lng]);
            } else {
                pickupMarker = L.marker([location.lat, location.lng], {
                    icon: L.divIcon({
                        className: 'pickup-marker',
                        html: '<i class="fas fa-map-marker-alt"></i>',
                        iconSize: [20, 20],
                        iconAnchor: [10, 20]
                    })
                }).addTo(map).bindPopup('Pickup Location');
            }
            
            // Center map on pickup location
            map.setView([location.lat, location.lng], 15);
            
            if (AppState.destination) {
                this.drawRoute(location, AppState.destination);
            }
        },
        
        updateDestinationMarker: function(location) {
            if (!map) {
                console.error('Map not initialized');
                return;
            }
            
            if (destinationMarker) {
                destinationMarker.setLatLng([location.lat, location.lng]);
            } else {
                destinationMarker = L.marker([location.lat, location.lng], {
                    icon: L.divIcon({
                        className: 'destination-marker',
                        html: '<i class="fas fa-flag"></i>',
                        iconSize: [20, 20],
                        iconAnchor: [10, 20]
                    })
                }).addTo(map).bindPopup('Destination');
            }
            
            if (AppState.pickup) {
                this.drawRoute(AppState.pickup, location);
            }
        },
        
        drawRoute: async function(start, end) {
            if (!map) {
                console.error('Map not initialized');
                return;
            }
            
            // Remove existing route
            if (routeLayer) {
                map.removeLayer(routeLayer);
                routeLayer = null;
            }
            
            if (AppState.routePolyline) {
                map.removeLayer(AppState.routePolyline);
                AppState.routePolyline = null;
            }
            
            // Validate both points are within city
            const startValid = EnhancedSearchEngine.validateCoordinatesInCity(
                start.lat, start.lng, AppState.currentCity
            );
            const endValid = EnhancedSearchEngine.validateCoordinatesInCity(
                end.lat, end.lng, AppState.currentCity
            );
            
            if (!startValid || !endValid) {
                console.warn('Route points outside city bounds');
                return;
            }
            
            try {
                // Use OSRM routing engine for better routes
                const response = await fetch(
                    `https://router.project-osrm.org/route/v1/driving/${start.lng},${start.lat};${end.lng},${end.lat}?overview=full&geometries=geojson`
                );
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.routes && data.routes.length > 0) {
                        const route = data.routes[0];
                        const routeCoordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                        
                        // Create a proper route polyline
                        AppState.routePolyline = L.polyline(routeCoordinates, {
                            color: '#FF6B35',
                            weight: 4,
                            opacity: 0.8,
                            lineJoin: 'round',
                            lineCap: 'round'
                        }).addTo(map);
                        
                        // Add start and end markers
                        this.updatePickupMarker(start);
                        this.updateDestinationMarker(end);
                        
                        // Fit bounds to show entire route
                        const bounds = L.latLngBounds(routeCoordinates);
                        map.fitBounds(bounds, { padding: [50, 50] });
                        
                        console.log('Route drawn successfully');
                        return route.distance / 1000; // Return distance in km
                    }
                }
            } catch (error) {
                console.warn('OSRM routing failed, using straight line:', error);
            }
            
            // Fallback to straight line if routing fails
            routeLayer = L.polyline([
                [start.lat, start.lng],
                [end.lat, end.lng]
            ], {
                color: '#FF6B35',
                weight: 3,
                opacity: 0.7,
                dashArray: '10, 10'
            }).addTo(map);
            
            // Fit bounds to show entire route
            const bounds = L.latLngBounds(
                [start.lat, start.lng],
                [end.lat, end.lng]
            );
            map.fitBounds(bounds, { padding: [50, 50] });
            
            return EnhancedPriceCalculator.calculateDistance(start.lat, start.lng, end.lat, end.lng);
        },
        
        calculateAndUpdatePrices: function() {
            if (AppState.pickup && AppState.destination) {
                // Validate distance within city
                const validation = EnhancedPriceCalculator.validateDistanceWithinCity(
                    AppState.pickup.lat, AppState.pickup.lng,
                    AppState.destination.lat, AppState.destination.lng,
                    AppState.currentCity
                );
                
                if (!validation.valid) {
                    EnhancedUIUpdater.showToast(validation.message, 'warning');
                    return;
                }
                
                const distance = EnhancedPriceCalculator.calculateDistance(
                    AppState.pickup.lat, AppState.pickup.lng,
                    AppState.destination.lat, AppState.destination.lng
                );
                
                // Update prices based on active service
                switch(AppState.activeService) {
                    case 'car':
                        this.updateRidePrices(distance);
                        document.getElementById('fareDisplay').classList.add('active');
                        document.getElementById('rideTypeSelection').classList.add('active');
                        break;
                    case 'delivery':
                        this.updateDeliveryPrices(distance);
                        break;
                    case 'short-delivery':
                        this.updateShortDeliveryPrices(distance);
                        break;
                    case 'truck':
                        this.updateTruckPrices(distance);
                        break;
                    case 'express':
                        this.updateShoppingPrices(distance);
                        break;
                }
            }
        },
        
        showSearchingAnimation: function(serviceType) {
            // Stop any existing animation
            this.stopSearchingAnimation();
            
            // Determine vehicle icon based on service type
            let vehicleIcon = 'car';
            let vehicleColor = '#FF6B35';
            
            switch(serviceType) {
                case 'delivery':
                case 'short-delivery':
                    vehicleIcon = 'shipping-fast';
                    vehicleColor = '#8A2BE2';
                    break;
                case 'truck':
                    vehicleIcon = 'truck';
                    vehicleColor = '#8B4513';
                    break;
                case 'express':
                    vehicleIcon = 'shopping-bag';
                    vehicleColor = '#2E8B57';
                    break;
            }
            
            // Create pulsing icon
            const iconHtml = `
                <div class="searching-pulse-icon">
                    <i class="fas fa-${vehicleIcon}" style="color: ${vehicleColor}; font-size: 48px;"></i>
                </div>
            `;
            
            searchPulsingIcon = L.divIcon({
                className: 'searching-vehicle-icon',
                html: iconHtml,
                iconSize: [60, 60],
                iconAnchor: [30, 30]
            });
            
            // Add to map at pickup location
            if (AppState.pickup) {
                const marker = L.marker([AppState.pickup.lat, AppState.pickup.lng], {
                    icon: searchPulsingIcon
                }).addTo(map);
                
                // Start pulsing animation
                const iconElement = marker.getElement();
                if (iconElement) {
                    iconElement.classList.add('pulsing');
                }
                
                AppState.searchingAnimation = marker;
            }
        },
        
        stopSearchingAnimation: function() {
            if (AppState.searchingAnimation) {
                map.removeLayer(AppState.searchingAnimation);
                AppState.searchingAnimation = null;
            }
        },
        
        updatePaymentModalWithReferral: function(originalFare) {
            const modal = document.getElementById('paymentModal');
            if (!modal) return;
            
            // Add referral code input if not present
            let referralSection = modal.querySelector('.referral-section');
            if (!referralSection) {
                referralSection = document.createElement('div');
                referralSection.className = 'referral-section';
                referralSection.innerHTML = `
                    <div class="payment-section">
                        <label for="referralCodeInput" style="display: block; margin-bottom: 8px; font-weight: 500;">
                            <i class="fas fa-gift"></i> Referral Code (Optional - 50% Discount)
                        </label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="referralCodeInput" placeholder="Enter referral code" 
                                   style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                            <button id="applyReferralBtn" class="btn btn-secondary" 
                                    style="padding: 10px 15px; white-space: nowrap;">
                                Apply
                            </button>
                        </div>
                        <div id="referralFeedback" style="margin-top: 8px; font-size: 12px; display: none;"></div>
                        <div id="referralOwnerInfo" style="margin-top: 8px; font-size: 12px; color: var(--success-green); display: none;"></div>
                    </div>
                `;
                
                // Insert before payment methods
                const paymentMethods = modal.querySelector('.payment-section');
                if (paymentMethods) {
                    paymentMethods.parentNode.insertBefore(referralSection, paymentMethods);
                }
                
                // Add event listener for apply button
                document.getElementById('applyReferralBtn').addEventListener('click', () => {
                    this.applyReferralCode(originalFare);
                });
                
                // Add enter key support
                document.getElementById('referralCodeInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.applyReferralCode(originalFare);
                    }
                });
            }
        },
        
        applyReferralCode: async function(originalFare) {
            const referralCodeInput = document.getElementById('referralCodeInput');
            const feedback = document.getElementById('referralFeedback');
            const ownerInfo = document.getElementById('referralOwnerInfo');
            const paymentAmount = document.getElementById('paymentAmount');
            
            if (!referralCodeInput || !feedback || !ownerInfo || !paymentAmount) return;
            
            const referralCode = referralCodeInput.value.trim();
            
            if (!referralCode) {
                feedback.textContent = 'Please enter a referral code';
                feedback.style.color = 'var(--error-red)';
                feedback.style.display = 'block';
                ownerInfo.style.display = 'none';
                return;
            }
            
            // Check if it's user's own referral code
            if (referralCode === AppState.userData?.referralCode) {
                feedback.textContent = 'Cannot use your own referral code';
                feedback.style.color = 'var(--error-red)';
                feedback.style.display = 'block';
                ownerInfo.style.display = 'none';
                return;
            }
            
            try {
                // Find user by referral code
                const usersSnapshot = await database.ref('users').once('value');
                const users = usersSnapshot.val();
                let referralOwner = null;
                let ownerId = null;
                
                for (const [userId, userData] of Object.entries(users)) {
                    if (userData.referralCode === referralCode) {
                        referralOwner = userData;
                        ownerId = userId;
                        break;
                    }
                }
                
                if (!referralOwner) {
                    feedback.textContent = 'Invalid referral code';
                    feedback.style.color = 'var(--error-red)';
                    feedback.style.display = 'block';
                    ownerInfo.style.display = 'none';
                    return;
                }
                
                // Apply discount
                const discountedFare = EnhancedPriceCalculator.applyReferralDiscount(originalFare);
                AppState.currentReferralCode = referralCode;
                AppState.referralOwnerName = referralOwner.name;
                
                // Update UI
                paymentAmount.textContent = `ZMW ${discountedFare.toFixed(2)}`;
                feedback.textContent = '50% discount applied successfully!';
                feedback.style.color = 'var(--success-green)';
                feedback.style.display = 'block';
                
                ownerInfo.innerHTML = `
                    <i class="fas fa-user-check"></i> Referral from: ${referralOwner.name}
                `;
                ownerInfo.style.display = 'block';
                
                // Store referral info for later use
                AppState.rideFare = discountedFare;
                
                EnhancedUIUpdater.showToast('50% discount applied!', 'success');
                
            } catch (error) {
                console.error('Error applying referral code:', error);
                feedback.textContent = 'Error applying referral code';
                feedback.style.color = 'var(--error-red)';
                feedback.style.display = 'block';
                ownerInfo.style.display = 'none';
            }
        },
        
        showScheduledRideTimer: function(scheduledTime) {
            const timerContainer = document.getElementById('scheduledTimerContainer');
            if (!timerContainer) {
                // Create timer container
                const container = document.createElement('div');
                container.id = 'scheduledTimerContainer';
                container.className = 'scheduled-timer';
                container.style.cssText = `
                    position: fixed;
                    top: 80px;
                    right: 20px;
                    background: white;
                    border-radius: 12px;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                    padding: 15px;
                    z-index: 1000;
                    min-width: 250px;
                    border: 2px solid var(--primary-orange);
                `;
                
                document.body.appendChild(container);
                return this.showScheduledRideTimer(scheduledTime);
            }
            
            const now = Date.now();
            const timeUntilRide = scheduledTime - now;
            
            if (timeUntilRide <= 0) {
                timerContainer.innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-weight: bold; color: var(--primary-orange); margin-bottom: 10px;">
                            <i class="fas fa-clock"></i> Ride Time!
                        </div>
                        <div style="margin-bottom: 10px;">Your scheduled ride is ready</div>
                        <button id="requestScheduledRideBtn" class="btn btn-primary" style="width: 100%;">
                            Request Ride Now
                        </button>
                        <button id="cancelScheduledRideBtn" class="btn btn-secondary" style="width: 100%; margin-top: 10px;">
                            Cancel Schedule
                        </button>
                    </div>
                `;
                
                // Add event listeners
                document.getElementById('requestScheduledRideBtn')?.addEventListener('click', () => {
                    EnhancedFirebaseManager.requestScheduledRide();
                });
                
                document.getElementById('cancelScheduledRideBtn')?.addEventListener('click', () => {
                    EnhancedFirebaseManager.cancelScheduledRide();
                });
                
            } else {
                const hours = Math.floor(timeUntilRide / (1000 * 60 * 60));
                const minutes = Math.floor((timeUntilRide % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeUntilRide % (1000 * 60)) / 1000);
                
                timerContainer.innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-weight: bold; color: var(--primary-orange); margin-bottom: 10px;">
                            <i class="fas fa-clock"></i> Scheduled Ride
                        </div>
                        <div style="font-size: 24px; font-weight: bold; margin-bottom: 10px;">
                            ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}
                        </div>
                        <div style="margin-bottom: 10px;">Ride will be requested automatically</div>
                        <button id="cancelScheduledRideBtn" class="btn btn-secondary" style="width: 100%;">
                            <i class="fas fa-times"></i> Cancel Schedule
                        </button>
                    </div>
                `;
                
                // Add event listener for cancel button
                document.getElementById('cancelScheduledRideBtn')?.addEventListener('click', () => {
                    EnhancedFirebaseManager.cancelScheduledRide();
                });
                
                // Update timer every second
                setTimeout(() => {
                    this.showScheduledRideTimer(scheduledTime);
                }, 1000);
            }
        },
        
        hideScheduledRideTimer: function() {
            const timerContainer = document.getElementById('scheduledTimerContainer');
            if (timerContainer) {
                timerContainer.remove();
            }
        },
        
        showSharedRideInvitation: function(sharedRideData) {
            // Create invitation modal
            const modalId = 'sharedRideInvitationModal';
            let modal = document.getElementById(modalId);
            
            if (!modal) {
                modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 500px;">
                        <div class="modal-header">
                            <h3><i class="fas fa-users"></i> Ride Share Invitation</h3>
                            <button class="modal-close" data-modal="${modalId}">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div id="sharedRideInvitationContent">
                                Loading invitation details...
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Add close event
                modal.querySelector('.modal-close').addEventListener('click', () => {
                    modal.classList.remove('active');
                });
            }
            
            // Update content
            const content = modal.querySelector('#sharedRideInvitationContent');
            content.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 48px; color: var(--primary-orange); margin-bottom: 10px;">
                        <i class="fas fa-car"></i>
                    </div>
                    <div style="font-weight: bold; font-size: 18px; margin-bottom: 5px;">
                        ${sharedRideData.hostName} invited you to share a ride
                    </div>
                    <div style="color: var(--text-gray); font-size: 14px;">
                        ${sharedRideData.rideType}  ${sharedRideData.distance?.toFixed(1)} km
                    </div>
                </div>
                
                <div style="background: #f8f9fa; border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <div style="color: var(--primary-orange); margin-right: 10px;">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div>
                            <div style="font-weight: 500;">From</div>
                            <div>${sharedRideData.pickupDisplay}</div>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: center;">
                        <div style="color: var(--primary-orange); margin-right: 10px;">
                            <i class="fas fa-flag"></i>
                        </div>
                        <div>
                            <div style="font-weight: 500;">To</div>
                            <div>${sharedRideData.destinationDisplay}</div>
                        </div>
                    </div>
                </div>
                
                <div style="background: #fff3e0; border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span>Total Fare:</span>
                        <span style="font-weight: bold;">ZMW ${sharedRideData.totalFare?.toFixed(2)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span>Your Share (${sharedRideData.splitType}):</span>
                        <span style="font-weight: bold; color: var(--primary-orange);">ZMW ${sharedRideData.yourShare?.toFixed(2)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Passengers:</span>
                        <span>${sharedRideData.passengerCount || 1}</span>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button id="acceptSharedRideBtn" class="btn btn-primary" style="flex: 1;">
                        <i class="fas fa-check"></i> Accept & Pay
                    </button>
                    <button id="rejectSharedRideBtn" class="btn btn-secondary" style="flex: 1;">
                        <i class="fas fa-times"></i> Decline
                    </button>
                </div>
            `;
            
            // Add event listeners
            content.querySelector('#acceptSharedRideBtn').addEventListener('click', () => {
                modal.classList.remove('active');
                this.showPaymentModalForSharedRide(sharedRideData);
            });
            
            content.querySelector('#rejectSharedRideBtn').addEventListener('click', () => {
                modal.classList.remove('active');
                EnhancedFirebaseManager.rejectSharedRideInvitation(sharedRideData.invitationId);
            });
            
            // Show modal
            modal.classList.add('active');
        },
        
        showPaymentModalForSharedRide: function(sharedRideData) {
            // Update payment modal for shared ride
            const paymentAmount = document.getElementById('paymentAmount');
            if (paymentAmount) {
                paymentAmount.textContent = `ZMW ${sharedRideData.yourShare?.toFixed(2)}`;
            }
            
            // Store shared ride data
            window.pendingSharedRideData = sharedRideData;
            
            // Show payment modal
            showModal('payment');
        },
        
        showBroadcastTracking: function(broadcastData) {
            // Create broadcast tracking interface
            const trackingId = 'broadcastTrackingPanel';
            let trackingPanel = document.getElementById(trackingId);
            
            if (!trackingPanel) {
                trackingPanel = document.createElement('div');
                trackingPanel.id = trackingId;
                trackingPanel.className = 'broadcast-tracking-panel';
                trackingPanel.style.cssText = `
                    position: fixed;
                    top: 80px;
                    left: 20px;
                    background: white;
                    border-radius: 12px;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                    padding: 15px;
                    z-index: 1000;
                    width: 300px;
                    max-height: 80vh;
                    overflow-y: auto;
                `;
                
                document.body.appendChild(trackingPanel);
            }
            
            trackingPanel.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="margin: 0; color: var(--primary-orange);">
                            <i class="fas fa-broadcast-tower"></i> Tracking ${broadcastData.hostName}
                        </h4>
                        <button id="closeBroadcastTracking" style="background: none; border: none; color: var(--text-gray); cursor: pointer;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div style="background: #f8f9fa; border-radius: 8px; padding: 10px; margin-bottom: 10px;">
                        <div style="display: flex; align-items: center; margin-bottom: 5px;">
                            <i class="fas fa-map-marker-alt" style="color: var(--primary-orange); margin-right: 8px;"></i>
                            <div>
                                <div style="font-size: 12px; color: var(--text-gray);">From</div>
                                <div style="font-weight: 500;">${broadcastData.pickupDisplay}</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center;">
                            <i class="fas fa-flag" style="color: var(--primary-orange); margin-right: 8px;"></i>
                            <div>
                                <div style="font-size: 12px; color: var(--text-gray);">To</div>
                                <div style="font-weight: 500;">${broadcastData.destinationDisplay}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <div>
                            <div style="font-size: 12px; color: var(--text-gray);">Distance</div>
                            <div style="font-weight: 500;">${broadcastData.distance?.toFixed(1)} km</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: var(--text-gray);">Ride Type</div>
                            <div style="font-weight: 500;">${broadcastData.rideType}</div>
                        </div>
                    </div>
                </div>
                
                <div id="broadcastDriverInfo" style="margin-bottom: 15px; display: none;">
                    <div style="font-weight: 500; margin-bottom: 8px; color: var(--text-gray);">
                        <i class="fas fa-car"></i> Driver
                    </div>
                    <div style="display: flex; align-items: center; background: #f8f9fa; border-radius: 8px; padding: 10px;">
                        <div style="width: 40px; height: 40px; background: var(--primary-orange); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; margin-right: 10px;">
                            <i class="fas fa-user"></i>
                        </div>
                        <div>
                            <div style="font-weight: 500;" id="broadcastDriverName">Loading...</div>
                            <div style="font-size: 12px; color: var(--text-gray);" id="broadcastDriverVehicle">Vehicle details</div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <div style="font-weight: 500; margin-bottom: 8px; color: var(--text-gray);">
                        <i class="fas fa-users"></i> Tracking Users (${broadcastData.trackingUsers?.length || 0})
                    </div>
                    <div id="broadcastTrackingUsers" style="max-height: 200px; overflow-y: auto;">
                        ${broadcastData.trackingUsers?.map(user => `
                            <div style="display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #eee;">
                                <div style="width: 30px; height: 30px; background: var(--info-blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; margin-right: 10px; font-size: 12px;">
                                    ${user.name?.charAt(0) || '?'}
                                </div>
                                <div>
                                    <div style="font-weight: 500; font-size: 14px;">${user.name}</div>
                                    <div style="font-size: 11px; color: var(--text-gray);">Tracking live</div>
                                </div>
                            </div>
                        `).join('') || '<div style="text-align: center; color: var(--text-gray); padding: 10px;">No one else is tracking</div>'}
                    </div>
                </div>
                
                <div style="background: #e8f5e9; border-radius: 8px; padding: 10px; margin-top: 10px;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <div style="font-weight: 500; color: var(--success-green);">
                                <i class="fas fa-map-marker-alt"></i> Live Tracking
                            </div>
                            <div style="font-size: 12px; color: var(--text-gray);">Updated every 10 seconds</div>
                        </div>
                        <div id="broadcastTrackingStatus" style="color: var(--success-green);">
                            <i class="fas fa-circle" style="font-size: 10px;"></i> Active
                        </div>
                    </div>
                </div>
            `;
            
            // Add close event
            trackingPanel.querySelector('#closeBroadcastTracking').addEventListener('click', () => {
                trackingPanel.style.display = 'none';
                EnhancedFirebaseManager.stopBroadcastTracking(broadcastData.broadcastId);
            });
            
            // Show panel
            trackingPanel.style.display = 'block';
            
            // Start live updates
            EnhancedFirebaseManager.startBroadcastTracking(broadcastData.broadcastId);
        },
        
        updateBroadcastDriverInfo: function(driverInfo) {
            const driverInfoDiv = document.getElementById('broadcastDriverInfo');
            const driverName = document.getElementById('broadcastDriverName');
            const driverVehicle = document.getElementById('broadcastDriverVehicle');
            
            if (driverInfoDiv && driverName && driverVehicle) {
                driverInfoDiv.style.display = 'block';
                driverName.textContent = driverInfo.name || 'Driver';
                driverVehicle.textContent = `${driverInfo.vehicle?.model || 'Car'} - ${driverInfo.vehicle?.plate || 'ABC 123'}`;
            }
        },
        
        updateBroadcastTrackingUsers: function(users) {
            const usersContainer = document.getElementById('broadcastTrackingUsers');
            if (usersContainer) {
                usersContainer.innerHTML = users.map(user => `
                    <div style="display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #eee;">
                        <div style="width: 30px; height: 30px; background: var(--info-blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; margin-right: 10px; font-size: 12px;">
                            ${user.name?.charAt(0) || '?'}
                        </div>
                        <div>
                            <div style="font-weight: 500; font-size: 14px;">${user.name}</div>
                            <div style="font-size: 11px; color: var(--text-gray);">Tracking live</div>
                        </div>
                    </div>
                `).join('') || '<div style="text-align: center; color: var(--text-gray); padding: 10px;">No one else is tracking</div>';
            }
        }
    };

    // ============================================
    // ENHANCED FIREBASE MANAGER
    // ============================================
    const EnhancedFirebaseManager = {
        async loadUserData(uid) {
            try {
                console.log(`Loading user data for UID: ${uid}`);
                EnhancedUIUpdater.showLoading('Loading your profile...');
                
                const snapshot = await database.ref(`users/${uid}`).once('value');
                AppState.userData = snapshot.val();
                
                if (AppState.userData) {
                    console.log('User data loaded successfully:', AppState.userData);
                    
                    AppState.walletBalance = AppState.userData.walletBalance || 0;
                    EnhancedUIUpdater.updateWalletBalance(AppState.walletBalance);
                    EnhancedUIUpdater.updateUserInfo(AppState.userData);
                    
                    // Load SOS config
                    await this.loadSOSConfig(uid);
                    
                    // Load scheduled rides
                    await this.loadScheduledRides(uid);
                    
                    // Check for active ride
                    await this.checkActiveRide(uid);
                    
                    // Load ride history
                    await this.loadRideHistory(uid);
                    
                    // Load notifications
                    await this.loadNotifications(uid);
                    
                    // Load search history
                    EnhancedSearchEngine.loadSearchHistory();
                    
                    // Start real-time sync
                    this.startRealtimeSync(uid);
                    
                    EnhancedUIUpdater.hideLoading();
                    return true;
                } else {
                    console.warn('No user data found');
                    EnhancedUIUpdater.hideLoading();
                    return false;
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                EnhancedUIUpdater.hideLoading();
                EnhancedUIUpdater.showToast('Error loading user data', 'error');
                return false;
            }
        },
        
        startRealtimeSync: function(uid) {
            // Clear existing listeners
            this.stopRealtimeSync();
            
            console.log('Starting real-time sync for user:', uid);
            
            // Listen for user data changes
            const userRef = database.ref(`users/${uid}`);
            AppState.realtimeListeners.push(
                userRef.on('value', (snapshot) => {
                    const userData = snapshot.val();
                    if (userData) {
                        console.log('User data updated in real-time');
                        AppState.userData = userData;
                        AppState.walletBalance = userData.walletBalance || 0;
                        EnhancedUIUpdater.updateWalletBalance(AppState.walletBalance);
                        EnhancedUIUpdater.updateUserInfo(userData);
                    }
                })
            );
            
            // Listen for active ride changes
            const activeRideRef = database.ref('rides')
                .orderByChild('passengerId')
                .equalTo(uid)
                .orderByChild('status')
                .startAt('requested')
                .endAt('started');
            
            AppState.realtimeListeners.push(
                activeRideRef.on('value', (snapshot) => {
                    const rides = snapshot.val();
                    if (rides) {
                        const rideId = Object.keys(rides)[0];
                        const ride = { id: rideId, ...rides[rideId] };
                        
                        if (!AppState.currentRide || AppState.currentRide.id !== rideId) {
                            console.log('New active ride detected:', rideId);
                            AppState.currentRide = ride;
                            EnhancedUIUpdater.showRideInfo(ride);
                            
                            // Listen to driver location if assigned
                            if (ride.driverId) {
                                this.listenToDriverLocation(ride.driverId);
                                this.loadDriverInfo(ride.driverId);
                            }
                            
                            // Listen to chat messages
                            this.listenToChatMessages(rideId);
                        } else {
                            // Update existing ride
                            AppState.currentRide = ride;
                            EnhancedUIUpdater.updateRideStatus(ride.status);
                            EnhancedUIUpdater.updateTimeline(ride.status);
                            
                            // Show SOS button when driver accepted
                            if (ride.status === 'accepted' && AppState.sosConfig) {
                                document.getElementById('sosButton').style.display = 'flex';
                            }
                            
                            // Handle ride completion
                            if (ride.status === 'completed') {
                                this.handleRideCompletion(ride);
                            }
                        }
                    } else if (AppState.currentRide) {
                        // No active ride found
                        console.log('Active ride ended');
                        this.resetActiveRide();
                    }
                })
            );
            
            // Listen for notifications
            const notificationsRef = database.ref(`notifications/${uid}`)
                .orderByChild('timestamp')
                .limitToLast(20);
            
            AppState.realtimeListeners.push(
                notificationsRef.on('value', (snapshot) => {
                    const notifications = snapshot.val();
                    if (notifications) {
                        console.log('New notifications received');
                        AppState.notifications = Object.values(notifications).reverse();
                        const unreadCount = AppState.notifications.filter(n => !n.read).length;
                        AppState.unreadNotifications = unreadCount;
                        EnhancedUIUpdater.updateNotificationBadge(unreadCount);
                        EnhancedUIUpdater.updateNotifications(AppState.notifications);
                    }
                })
            );
            
            // Listen for scheduled ride updates
            const scheduledRidesRef = database.ref('scheduledRides')
                .orderByChild('passengerId')
                .equalTo(uid);
            
            AppState.realtimeListeners.push(
                scheduledRidesRef.on('value', (snapshot) => {
                    const rides = snapshot.val();
                    if (rides) {
                        AppState.scheduledRides = Object.values(rides);
                        this.updateScheduledRideTimers();
                    }
                })
            );
            
            // Listen for shared ride invitations
            const sharedInvitationsRef = database.ref('sharedRideInvitations')
                .orderByChild('recipientId')
                .equalTo(uid)
                .orderByChild('status')
                .equalTo('pending');
            
            AppState.realtimeListeners.push(
                sharedInvitationsRef.on('child_added', (snapshot) => {
                    const invitation = { id: snapshot.key, ...snapshot.val() };
                    console.log('New shared ride invitation:', invitation.id);
                    EnhancedUIUpdater.showSharedRideInvitation(invitation);
                })
            );
            
            // Listen for broadcast invitations
            const broadcastInvitationsRef = database.ref('broadcastInvitations')
                .orderByChild('recipientId')
                .equalTo(uid)
                .orderByChild('status')
                .equalTo('active');
            
            AppState.realtimeListeners.push(
                broadcastInvitationsRef.on('child_added', (snapshot) => {
                    const invitation = { id: snapshot.key, ...snapshot.val() };
                    console.log('New broadcast invitation:', invitation.id);
                    this.handleBroadcastInvitation(invitation);
                })
            );
            
            // Show real-time indicator
            EnhancedUIUpdater.showRealTimeIndicator();
            
            console.log('Real-time sync started successfully');
        },
        
        stopRealtimeSync: function() {
            console.log('Stopping real-time sync');
            AppState.realtimeListeners.forEach(listener => {
                if (listener && typeof listener === 'function') {
                    listener(); // Call to unsubscribe
                }
            });
            AppState.realtimeListeners = [];
        },
        
        async loadSOSConfig(uid) {
            try {
                const snapshot = await database.ref(`sosConfig/${uid}`).once('value');
                AppState.sosConfig = snapshot.val();
                
                if (AppState.sosConfig) {
                    console.log('SOS config loaded');
                    
                    // Update emergency contact display
                    document.getElementById('emergencyContact1Name').textContent = AppState.sosConfig.contact1Name || 'Contact 1';
                    document.getElementById('emergencyContact1Phone').textContent = AppState.sosConfig.contact1Phone || '';
                    document.getElementById('emergencyContact2Name').textContent = AppState.sosConfig.contact2Name || 'Contact 2';
                    document.getElementById('emergencyContact2Phone').textContent = AppState.sosConfig.contact2Phone || '';
                    
                    // Show SOS button in forms
                    document.getElementById('sosButton').style.display = 'none'; // Will show when ride is accepted
                }
            } catch (error) {
                console.error('Error loading SOS config:', error);
            }
        },
        
        async loadScheduledRides(uid) {
            try {
                const snapshot = await database.ref('scheduledRides')
                    .orderByChild('passengerId')
                    .equalTo(uid)
                    .once('value');
                
                const rides = snapshot.val();
                if (rides) {
                    AppState.scheduledRides = Object.values(rides).filter(ride => 
                        ride.status === 'scheduled' || ride.status === 'upcoming'
                    );
                    console.log(`Loaded ${AppState.scheduledRides.length} scheduled rides`);
                    
                    // Start timers for scheduled rides
                    this.updateScheduledRideTimers();
                }
            } catch (error) {
                console.error('Error loading scheduled rides:', error);
            }
        },
        
        updateScheduledRideTimers: function() {
            // Clear existing timers
            AppState.scheduledTimers.forEach(timerId => clearTimeout(timerId));
            AppState.scheduledTimers = [];
            
            // Set up timers for each scheduled ride
            AppState.scheduledRides.forEach(ride => {
                if (ride.scheduledTime && ride.status === 'scheduled') {
                    const scheduledTime = new Date(ride.scheduledTime).getTime();
                    const now = Date.now();
                    const timeUntilRide = scheduledTime - now;
                    
                    if (timeUntilRide > 0) {
                        // Show timer 30 minutes before ride
                        const timerTime = Math.max(0, timeUntilRide - (30 * 60 * 1000));
                        
                        const timerId = setTimeout(() => {
                            EnhancedUIUpdater.showScheduledRideTimer(scheduledTime);
                            
                            // Set another timer for actual ride time
                            const rideTimerId = setTimeout(() => {
                                this.requestScheduledRide(ride.id);
                            }, timeUntilRide - timerTime);
                            
                            AppState.scheduledTimers.push(rideTimerId);
                        }, timerTime);
                        
                        AppState.scheduledTimers.push(timerId);
                    }
                }
            });
        },
        
        async requestScheduledRide(scheduledRideId) {
            try {
                const snapshot = await database.ref(`scheduledRides/${scheduledRideId}`).once('value');
                const scheduledRide = snapshot.val();
                
                if (!scheduledRide) {
                    throw new Error('Scheduled ride not found');
                }
                
                // Create ride from scheduled ride
                const rideId = database.ref().child('rides').push().key;
                const ride = {
                    id: rideId,
                    ...scheduledRide,
                    scheduled: true,
                    scheduledRideId: scheduledRideId,
                    status: 'requested',
                    timestamp: Date.now(),
                    updatedAt: Date.now()
                };
                
                // Remove scheduled fields
                delete ride.scheduledTime;
                delete ride.scheduledRideId;
                
                await database.ref(`rides/${rideId}`).set(ride);
                await database.ref(`scheduledRides/${scheduledRideId}/status`).set('active');
                
                AppState.currentRide = ride;
                EnhancedUIUpdater.showRideInfo(ride);
                EnhancedUIUpdater.hideScheduledRideTimer();
                
                // Start searching animation
                EnhancedUIUpdater.showSearchingAnimation(ride.serviceType || 'car');
                
                EnhancedUIUpdater.showToast('Scheduled ride requested', 'success');
                
                // Listen for updates
                this.listenToRideUpdates(rideId);
                
                return rideId;
            } catch (error) {
                console.error('Error requesting scheduled ride:', error);
                EnhancedUIUpdater.showToast('Error requesting scheduled ride', 'error');
                throw error;
            }
        },
        
        async cancelScheduledRide() {
            try {
                // Find active scheduled ride
                const activeScheduledRide = AppState.scheduledRides.find(ride => 
                    ride.status === 'scheduled' || ride.status === 'upcoming'
                );
                
                if (!activeScheduledRide) {
                    throw new Error('No scheduled ride to cancel');
                }
                
                await database.ref(`scheduledRides/${activeScheduledRide.id}/status`).set('cancelled');
                
                // Clear timers
                AppState.scheduledTimers.forEach(timerId => clearTimeout(timerId));
                AppState.scheduledTimers = [];
                
                EnhancedUIUpdater.hideScheduledRideTimer();
                EnhancedUIUpdater.showToast('Scheduled ride cancelled', 'success');
                
                return true;
            } catch (error) {
                console.error('Error cancelling scheduled ride:', error);
                EnhancedUIUpdater.showToast('Error cancelling scheduled ride', 'error');
                return false;
            }
        },
        
        async checkActiveRide(uid) {
            try {
                const snapshot = await database.ref('rides')
                    .orderByChild('passengerId')
                    .equalTo(uid)
                    .orderByChild('status')
                    .startAt('requested')
                    .endAt('started')
                    .once('value');
                
                const rides = snapshot.val();
                if (rides) {
                    const rideId = Object.keys(rides)[0];
                    AppState.currentRide = { id: rideId, ...rides[rideId] };
                    console.log('Active ride found:', rideId);
                    EnhancedUIUpdater.showRideInfo(AppState.currentRide);
                    
                    // Listen for ride updates
                    this.listenToRideUpdates(rideId);
                    
                    // If driver assigned, listen to driver location
                    if (AppState.currentRide.driverId) {
                        this.listenToDriverLocation(AppState.currentRide.driverId);
                        this.loadDriverInfo(AppState.currentRide.driverId);
                    }
                    
                    // Listen to chat messages
                    this.listenToChatMessages(rideId);
                    
                    return true;
                }
                console.log('No active ride found');
                return false;
            } catch (error) {
                console.error('Error checking active ride:', error);
                return false;
            }
        },
        
        async loadRideHistory(uid) {
            try {
                EnhancedUIUpdater.showLoading('Loading ride history...');
                
                const snapshot = await database.ref('rides')
                    .orderByChild('passengerId')
                    .equalTo(uid)
                    .once('value');
                
                const rides = snapshot.val();
                if (rides) {
                    const ridesArray = Object.keys(rides).map(id => ({
                        id,
                        ...rides[id]
                    })).sort((a, b) => b.timestamp - a.timestamp);
                    
                    // Filter based on active filter
                    const filtered = this.filterRides(ridesArray, AppState.activeFilter);
                    
                    // Update UI
                    EnhancedUIUpdater.updateHistoryList(filtered);
                    
                    // Update stats
                    this.updateUserStats(ridesArray);
                    
                    console.log(`Loaded ${ridesArray.length} ride history items`);
                }
                
                EnhancedUIUpdater.hideLoading();
            } catch (error) {
                console.error('Error loading ride history:', error);
                EnhancedUIUpdater.hideLoading();
            }
        },
        
        async loadNotifications(uid) {
            try {
                const snapshot = await database.ref(`notifications/${uid}`)
                    .orderByChild('timestamp')
                    .limitToLast(20)
                    .once('value');
                
                const notifications = snapshot.val();
                if (notifications) {
                    AppState.notifications = Object.values(notifications).reverse();
                    const unreadCount = AppState.notifications.filter(n => !n.read).length;
                    AppState.unreadNotifications = unreadCount;
                    EnhancedUIUpdater.updateNotificationBadge(unreadCount);
                    EnhancedUIUpdater.updateNotifications(AppState.notifications);
                    
                    console.log(`Loaded ${AppState.notifications.length} notifications`);
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        },
        
        async markNotificationAsRead(notificationId) {
            try {
                await database.ref(`notifications/${AppState.currentUser.uid}/${notificationId}/read`).set(true);
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        },
        
        filterRides: function(rides, filter) {
            switch(filter) {
                case 'completed':
                    return rides.filter(ride => ride.status === 'completed');
                case 'cancelled':
                    return rides.filter(ride => ride.status === 'cancelled');
                case 'scheduled':
                    return rides.filter(ride => ride.scheduled);
                case 'emergency':
                    return rides.filter(ride => ride.emergency);
                case 'delivery':
                    return rides.filter(ride => ride.serviceType === 'delivery');
                case 'truck':
                    return rides.filter(ride => ride.serviceType === 'truck');
                case 'broadcast':
                    return rides.filter(ride => ride.broadcast);
                case 'shared':
                    return rides.filter(ride => ride.shared);
                default:
                    return rides;
            }
        },
        
        updateUserStats: function(rides) {
            const completed = rides.filter(ride => ride.status === 'completed').length;
            const cancelled = rides.filter(ride => ride.status === 'cancelled').length;
            const totalSpent = rides
                .filter(ride => ride.status === 'completed')
                .reduce((sum, ride) => sum + (ride.fare || 0), 0);
            
            document.getElementById('completedRides').textContent = completed;
            document.getElementById('cancelledRides').textContent = cancelled;
            document.getElementById('totalSpent').textContent = `ZMW ${totalSpent.toFixed(2)}`;
        },
        
        listenToRideUpdates: function(rideId) {
            const rideRef = database.ref(`rides/${rideId}`);
            
            AppState.realtimeListeners.push(
                rideRef.on('value', (snapshot) => {
                    const ride = snapshot.val();
                    if (ride) {
                        console.log('Ride updated:', rideId, ride.status);
                        AppState.currentRide = { id: rideId, ...ride };
                        EnhancedUIUpdater.updateRideStatus(ride.status);
                        EnhancedUIUpdater.updateTimeline(ride.status);
                        
                        // Update driver info if assigned
                        if (ride.driverId && !AppState.selectedVehicle) {
                            this.loadDriverInfo(ride.driverId);
                        }
                        
                        // Show SOS button when driver accepted
                        if (ride.status === 'accepted' && AppState.sosConfig) {
                            document.getElementById('sosButton').style.display = 'flex';
                        }
                        
                        // Handle ride completion
                        if (ride.status === 'completed') {
                            this.handleRideCompletion(ride);
                        }
                        
                        // Handle ride cancellation
                        if (ride.status === 'cancelled') {
                            this.resetActiveRide();
                        }
                    }
                })
            );
        },
        
        async loadDriverInfo(driverId) {
            try {
                const snapshot = await database.ref(`users/${driverId}`).once('value');
                const driver = snapshot.val();
                if (driver) {
                    AppState.selectedVehicle = driver;
                    EnhancedUIUpdater.showDriverInfo(driver);
                    
                    // Load driver and vehicle images from storage
                    this.loadDriverImages(driverId);
                    
                    console.log('Driver info loaded:', driverId);
                }
            } catch (error) {
                console.error('Error loading driver info:', error);
            }
        },
        
        async loadDriverImages(driverId) {
            try {
                // Load driver photo
                const driverPhotoRef = storage.ref(`driver_photos/${driverId}.jpg`);
                driverPhotoRef.getDownloadURL().then(url => {
                    const driverImg = document.getElementById('driverImage');
                    const driverPlaceholder = document.getElementById('driverImagePlaceholder');
                    
                    driverImg.src = url;
                    driverImg.onload = function() {
                        driverImg.style.display = 'block';
                        driverPlaceholder.style.display = 'none';
                    };
                }).catch(() => {
                    // Driver photo not found, use placeholder
                    console.log('Driver photo not found, using placeholder');
                });
                
                // Load vehicle photo
                const vehiclePhotoRef = storage.ref(`vehicle_photos/${driverId}.jpg`);
                vehiclePhotoRef.getDownloadURL().then(url => {
                    const vehicleImg = document.getElementById('vehicleImage');
                    const vehiclePlaceholder = document.getElementById('vehicleImagePlaceholder');
                    
                    vehicleImg.src = url;
                    vehicleImg.onload = function() {
                        vehicleImg.style.display = 'block';
                        vehiclePlaceholder.style.display = 'none';
                    };
                }).catch(() => {
                    // Vehicle photo not found, use placeholder
                    console.log('Vehicle photo not found, using placeholder');
                });
            } catch (error) {
                console.error('Error loading driver images:', error);
            }
        },
        
        listenToDriverLocation(driverId) {
            const locationRef = database.ref(`driverLocations/${driverId}`);
            
            AppState.realtimeListeners.push(
                locationRef.on('value', (snapshot) => {
                    const location = snapshot.val();
                    if (location) {
                        AppState.driverLocation = {
                            lat: location.latitude,
                            lng: location.longitude
                        };
                        EnhancedUIUpdater.updateDriverMarker(AppState.driverLocation);
                        
                        // Update tracking info if we have pickup location
                        if (AppState.currentRide && AppState.currentRide.pickupLat) {
                            const pickupLocation = {
                                lat: AppState.currentRide.pickupLat,
                                lng: AppState.currentRide.pickupLng
                            };
                            EnhancedUIUpdater.updateDriverTracking(AppState.driverLocation, pickupLocation);
                        }
                    }
                })
            );
        },
        
        listenToChatMessages(rideId) {
            const chatRef = database.ref(`chats/${rideId}/messages`).orderByChild('timestamp').limitToLast(50);
            
            AppState.realtimeListeners.push(
                chatRef.on('child_added', (snapshot) => {
                    const message = snapshot.val();
                    if (message) {
                        EnhancedUIUpdater.showChatMessage(message, message.senderId === AppState.currentUser.uid);
                    }
                })
            );
            
            // Listen for typing indicators
            const typingRef = database.ref(`chats/${rideId}/typing`);
            AppState.realtimeListeners.push(
                typingRef.on('value', (snapshot) => {
                    const typingData = snapshot.val();
                    if (typingData && typingData.driverTyping) {
                        EnhancedUIUpdater.updateTypingIndicator(true);
                        
                        // Clear typing indicator after 3 seconds
                        clearTimeout(AppState.typingTimeout);
                        AppState.typingTimeout = setTimeout(() => {
                            EnhancedUIUpdater.updateTypingIndicator(false);
                        }, 3000);
                    } else {
                        EnhancedUIUpdater.updateTypingIndicator(false);
                    }
                })
            );
        },
        
        async requestRide(rideData) {
            try {
                EnhancedUIUpdater.showLoading('Requesting ride...');
                
                // Validate ride data
                if (!rideData.pickup || !rideData.destination) {
                    throw new Error('Pickup and destination locations are required');
                }
                
                // Validate locations are within city
                if (!EnhancedSearchEngine.validateCoordinatesInCity(
                    rideData.pickupLat, rideData.pickupLng, AppState.currentCity
                ) || !EnhancedSearchEngine.validateCoordinatesInCity(
                    rideData.destLat, rideData.destLng, AppState.currentCity
                )) {
                    throw new Error('Locations must be within city boundaries');
                }
                
                const rideId = database.ref().child('rides').push().key;
                const ride = {
                    id: rideId,
                    ...rideData,
                    status: 'requested',
                    timestamp: Date.now(),
                    updatedAt: Date.now(),
                    passengerId: AppState.currentUser.uid,
                    passengerName: AppState.userData.name,
                    passengerPhone: AppState.userData.phone,
                    city: AppState.currentCity,
                    referredBy: AppState.currentReferralCode
                };
                
                console.log('Creating ride:', rideId);
                await database.ref(`rides/${rideId}`).set(ride);
                
                AppState.currentRide = ride;
                EnhancedUIUpdater.showRideInfo(ride);
                EnhancedUIUpdater.updateTimeline('requested');
                
                // Show searching animation
                EnhancedUIUpdater.showSearchingAnimation('car');
                
                // Listen for updates
                this.listenToRideUpdates(rideId);
                
                // Send notification to available drivers
                await this.notifyAvailableDrivers(ride);
                
                EnhancedUIUpdater.hideLoading();
                EnhancedUIUpdater.showToast('Ride requested successfully', 'success');
                
                // Handle shared ride if applicable
                if (rideData.shared && rideData.sharedMembers) {
                    await this.createSharedRideInvitations(rideId, rideData);
                }
                
                // Handle broadcast ride if applicable
                if (rideData.broadcast && rideData.broadcastRecipients) {
                    await this.createBroadcastRide(rideId, rideData);
                }
                
                console.log('Ride request completed:', rideId);
                return rideId;
            } catch (error) {
                console.error('Error requesting ride:', error);
                EnhancedUIUpdater.hideLoading();
                EnhancedUIUpdater.showToast(error.message, 'error');
                throw error;
            }
        },
        
        async notifyAvailableDrivers(ride) {
            try {
                console.log('Notifying available drivers for ride:', ride.id);
                
                // Find available drivers near pickup location
                const driversSnapshot = await database.ref('drivers')
                    .orderByChild('status')
                    .equalTo('available')
                    .once('value');
                
                const drivers = driversSnapshot.val();
                if (drivers) {
                    Object.keys(drivers).forEach(driverId => {
                        const driver = drivers[driverId];
                        
                        // Check if driver is within reasonable distance (optional)
                        // For now, notify all available drivers
                        
                        // Send notification to driver
                        this.sendNotification(driverId, 'New Ride Request', 
                            `New ride request from ${ride.passengerName} to ${ride.destinationDisplay || ride.destination}`, 
                            'ride',
                            { rideId: ride.id, action: 'view_ride' }
                        );
                    });
                    
                    console.log(`Notified ${Object.keys(drivers).length} drivers`);
                } else {
                    console.log('No available drivers found');
                }
            } catch (error) {
                console.error('Error notifying drivers:', error);
            }
        },
        
        async createSharedRideInvitations(rideId, rideData) {
            try {
                console.log('Creating shared ride invitations for ride:', rideId);
                
                const invitations = [];
                
                // Create invitation for each shared member
                for (const member of rideData.sharedMembers) {
                    // Find user by referral code
                    const usersSnapshot = await database.ref('users').once('value');
                    const users = usersSnapshot.val();
                    let memberId = null;
                    
                    for (const [userId, userData] of Object.entries(users)) {
                        if (userData.referralCode === member.referralCode) {
                            memberId = userId;
                            break;
                        }
                    }
                    
                    if (memberId) {
                        const invitationId = database.ref().child('sharedRideInvitations').push().key;
                        const invitation = {
                            id: invitationId,
                            rideId: rideId,
                            hostId: AppState.currentUser.uid,
                            hostName: AppState.userData.name,
                            recipientId: memberId,
                            recipientName: member.name,
                            pickupDisplay: rideData.pickupDisplay,
                            destinationDisplay: rideData.destinationDisplay,
                            rideType: rideData.rideType,
                            totalFare: rideData.totalFare,
                            yourShare: member.share,
                            splitType: rideData.splitType,
                            distance: rideData.distance,
                            status: 'pending',
                            timestamp: Date.now()
                        };
                        
                        await database.ref(`sharedRideInvitations/${invitationId}`).set(invitation);
                        invitations.push(invitation);
                        
                        // Send notification
                        await this.sendNotification(
                            memberId,
                            'Ride Share Invitation',
                            `${AppState.userData.name} invited you to share a ride`,
                            'shared',
                            { invitationId: invitationId, rideId: rideId, action: 'view_shared_invitation' }
                        );
                    }
                }
                
                console.log(`Created ${invitations.length} shared ride invitations`);
                return invitations;
            } catch (error) {
                console.error('Error creating shared ride invitations:', error);
                return [];
            }
        },
        
        async rejectSharedRideInvitation(invitationId) {
            try {
                await database.ref(`sharedRideInvitations/${invitationId}/status`).set('rejected');
                EnhancedUIUpdater.showToast('Invitation declined', 'info');
            } catch (error) {
                console.error('Error rejecting shared ride invitation:', error);
            }
        },
        
        async acceptSharedRideInvitation(invitationId) {
            try {
                const snapshot = await database.ref(`sharedRideInvitations/${invitationId}`).once('value');
                const invitation = snapshot.val();
                
                if (!invitation) {
                    throw new Error('Invitation not found');
                }
                
                // Update invitation status
                await database.ref(`sharedRideInvitations/${invitationId}/status`).set('accepted');
                
                // Update ride with shared member
                await database.ref(`rides/${invitation.rideId}/sharedMembers/${AppState.currentUser.uid}`).set({
                    userId: AppState.currentUser.uid,
                    name: AppState.userData.name,
                    status: 'accepted',
                    paid: false
                });
                
                EnhancedUIUpdater.showToast('Ride share accepted', 'success');
                
                return invitation;
            } catch (error) {
                console.error('Error accepting shared ride invitation:', error);
                throw error;
            }
        },
        
        async createBroadcastRide(rideId, rideData) {
            try {
                console.log('Creating broadcast ride:', rideId);
                
                const broadcastId = database.ref().child('broadcasts').push().key;
                const broadcast = {
                    id: broadcastId,
                    rideId: rideId,
                    hostId: AppState.currentUser.uid,
                    hostName: AppState.userData.name,
                    pickupDisplay: rideData.pickupDisplay,
                    destinationDisplay: rideData.destinationDisplay,
                    rideType: rideData.rideType,
                    distance: rideData.distance,
                    status: 'active',
                    timestamp: Date.now(),
                    trackingUsers: []
                };
                
                await database.ref(`broadcasts/${broadcastId}`).set(broadcast);
                
                // Create invitations for broadcast recipients
                for (const recipient of rideData.broadcastRecipients) {
                    // Find user by referral code
                    const usersSnapshot = await database.ref('users').once('value');
                    const users = usersSnapshot.val();
                    let recipientId = null;
                    
                    for (const [userId, userData] of Object.entries(users)) {
                        if (userData.referralCode === recipient.referralCode) {
                            recipientId = userId;
                            break;
                        }
                    }
                    
                    if (recipientId) {
                        const invitationId = database.ref().child('broadcastInvitations').push().key;
                        const invitation = {
                            id: invitationId,
                            broadcastId: broadcastId,
                            rideId: rideId,
                            hostId: AppState.currentUser.uid,
                            hostName: AppState.userData.name,
                            recipientId: recipientId,
                            recipientName: recipient.name,
                            status: 'active',
                            timestamp: Date.now()
                        };
                        
                        await database.ref(`broadcastInvitations/${invitationId}`).set(invitation);
                        
                        // Send notification
                        await this.sendNotification(
                            recipientId,
                            'Broadcast Ride',
                            `${AppState.userData.name} is sharing their ride live`,
                            'broadcast',
                            { broadcastId: broadcastId, rideId: rideId, action: 'view_broadcast' }
                        );
                    }
                }
                
                console.log('Broadcast ride created:', broadcastId);
                return broadcastId;
            } catch (error) {
                console.error('Error creating broadcast ride:', error);
                throw error;
            }
        },
        
        async handleBroadcastInvitation(invitation) {
            try {
                // Load broadcast details
                const broadcastSnapshot = await database.ref(`broadcasts/${invitation.broadcastId}`).once('value');
                const broadcast = broadcastSnapshot.val();
                
                if (broadcast) {
                    // Show broadcast tracking interface
                    EnhancedUIUpdater.showBroadcastTracking({
                        ...broadcast,
                        invitationId: invitation.id
                    });
                }
            } catch (error) {
                console.error('Error handling broadcast invitation:', error);
            }
        },
        
        async startBroadcastTracking(broadcastId) {
            try {
                // Listen to broadcast updates
                const broadcastRef = database.ref(`broadcasts/${broadcastId}`);
                
                AppState.realtimeListeners.push(
                    broadcastRef.on('value', (snapshot) => {
                        const broadcast = snapshot.val();
                        if (broadcast) {
                            // Update tracking interface
                            EnhancedUIUpdater.updateBroadcastTrackingUsers(broadcast.trackingUsers || []);
                        }
                    })
                );
                
                // Listen to ride updates for this broadcast
                const rideRef = database.ref(`rides/${broadcastId}`);
                AppState.realtimeListeners.push(
                    rideRef.on('value', (snapshot) => {
                        const ride = snapshot.val();
                        if (ride && ride.driverId) {
                            // Load driver info
                            this.loadDriverInfo(ride.driverId);
                        }
                    })
                );
                
                console.log('Started broadcast tracking for:', broadcastId);
            } catch (error) {
                console.error('Error starting broadcast tracking:', error);
            }
        },
        
        stopBroadcastTracking(broadcastId) {
            // Note: The real-time listener removal is handled by stopRealtimeSync
            console.log('Stopped broadcast tracking for:', broadcastId);
        },
        
        async requestDelivery(deliveryData) {
            try {
                EnhancedUIUpdater.showLoading('Requesting delivery...');
                
                // Validate delivery data
                if (!deliveryData.pickup || !deliveryData.destination) {
                    throw new Error('Pickup and destination locations are required');
                }
                
                const rideId = database.ref().child('rides').push().key;
                const ride = {
                    id: rideId,
                    ...deliveryData,
                    serviceType: 'delivery',
                    status: 'requested',
                    timestamp: Date.now(),
                    updatedAt: Date.now(),
                    passengerId: AppState.currentUser.uid,
                    passengerName: AppState.userData.name,
                    passengerPhone: AppState.userData.phone,
                    city: AppState.currentCity,
                    referredBy: AppState.currentReferralCode
                };
                
                await database.ref(`rides/${rideId}`).set(ride);
                
                AppState.currentRide = ride;
                EnhancedUIUpdater.showRideInfo(ride);
                EnhancedUIUpdater.updateTimeline('requested');
                
                // Show searching animation
                EnhancedUIUpdater.showSearchingAnimation('delivery');
                
                // Listen for updates
                this.listenToRideUpdates(rideId);
                
                EnhancedUIUpdater.hideLoading();
                EnhancedUIUpdater.showToast('Delivery requested successfully', 'success');
                console.log('Delivery request completed:', rideId);
                return rideId;
            } catch (error) {
                console.error('Error requesting delivery:', error);
                EnhancedUIUpdater.hideLoading();
                EnhancedUIUpdater.showToast(error.message, 'error');
                throw error;
            }
        },
        
        async requestTruck(truckData) {
            try {
                EnhancedUIUpdater.showLoading('Requesting truck...');
                
                // Validate truck data
                if (!truckData.pickup || !truckData.destination) {
                    throw new Error('Pickup and destination locations are required');
                }
                
                const rideId = database.ref().child('rides').push().key;
                const ride = {
                    id: rideId,
                    ...truckData,
                    serviceType: 'truck',
                    status: 'requested',
                    timestamp: Date.now(),
                    updatedAt: Date.now(),
                    passengerId: AppState.currentUser.uid,
                    passengerName: AppState.userData.name,
                    passengerPhone: AppState.userData.phone,
                    city: AppState.currentCity,
                    referredBy: AppState.currentReferralCode
                };
                
                await database.ref(`rides/${rideId}`).set(ride);
                
                AppState.currentRide = ride;
                EnhancedUIUpdater.showRideInfo(ride);
                EnhancedUIUpdater.updateTimeline('requested');
                
                // Show searching animation
                EnhancedUIUpdater.showSearchingAnimation('truck');
                
                // Listen for updates
                this.listenToRideUpdates(rideId);
                
                EnhancedUIUpdater.hideLoading();
                EnhancedUIUpdater.showToast('Truck requested successfully', 'success');
                console.log('Truck request completed:', rideId);
                return rideId;
            } catch (error) {
                console.error('Error requesting truck:', error);
                EnhancedUIUpdater.hideLoading();
                EnhancedUIUpdater.showToast(error.message, 'error');
                throw error;
            }
        },
        
        async requestShopping(shoppingData) {
            try {
                EnhancedUIUpdater.showLoading('Submitting shopping request...');
                
                // Validate shopping data
                if (!shoppingData.destination) {
                    throw new Error('Delivery location is required');
                }
                
                const rideId = database.ref().child('rides').push().key;
                const ride = {
                    id: rideId,
                    ...shoppingData,
                    serviceType: 'shopping',
                    status: 'requested',
                    timestamp: Date.now(),
                    updatedAt: Date.now(),
                    passengerId: AppState.currentUser.uid,
                    passengerName: AppState.userData.name,
                    passengerPhone: AppState.userData.phone,
                    city: AppState.currentCity,
                    referredBy: AppState.currentReferralCode
                };
                
                await database.ref(`rides/${rideId}`).set(ride);
                
                AppState.currentRide = ride;
                EnhancedUIUpdater.showRideInfo(ride);
                EnhancedUIUpdater.updateTimeline('requested');
                
                // Show searching animation
                EnhancedUIUpdater.showSearchingAnimation('express');
                
                // Listen for updates
                this.listenToRideUpdates(rideId);
                
                EnhancedUIUpdater.hideLoading();
                EnhancedUIUpdater.showToast('Shopping request submitted', 'success');
                console.log('Shopping request completed:', rideId);
                return rideId;
            } catch (error) {
                console.error('Error requesting shopping:', error);
                EnhancedUIUpdater.hideLoading();
                EnhancedUIUpdater.showToast(error.message, 'error');
                throw error;
            }
        },
        
        async cancelRide(rideId, reason) {
            try {
                EnhancedUIUpdater.showLoading('Cancelling ride...');
                
                await database.ref(`rides/${rideId}`).update({
                    status: 'cancelled',
                    cancelReason: reason,
                    cancelledAt: Date.now(),
                    updatedAt: Date.now()
                });
                
                // Notify driver if assigned
                if (AppState.currentRide?.driverId) {
                    await this.sendNotification(
                        AppState.currentRide.driverId,
                        'Ride Cancelled',
                        `Ride cancelled by passenger. Reason: ${reason}`,
                        'warning'
                    );
                }
                
                EnhancedUIUpdater.stopSearchingAnimation();
                EnhancedUIUpdater.hideLoading();
                EnhancedUIUpdater.showToast('Ride cancelled successfully', 'success');
                console.log('Ride cancelled:', rideId);
                return true;
            } catch (error) {
                console.error('Error cancelling ride:', error);
                EnhancedUIUpdater.hideLoading();
                EnhancedUIUpdater.showToast('Error cancelling ride', 'error');
                return false;
            }
        },
        
        async scheduleRide(rideData) {
            try {
                EnhancedUIUpdater.showLoading('Scheduling ride...');
                
                // Validate ride data
                if (!rideData.pickup || !rideData.destination) {
                    throw new Error('Pickup and destination locations are required');
                }
                
                const rideId = database.ref().child('scheduledRides').push().key;
                const ride = {
                    id: rideId,
                    ...rideData,
                    status: 'scheduled',
                    timestamp: Date.now(),
                    passengerId: AppState.currentUser.uid,
                    passengerName: AppState.userData.name,
                    city: AppState.currentCity
                };
                
                await database.ref(`scheduledRides/${rideId}`).set(ride);
                
                AppState.scheduledRides.push(ride);
                
                EnhancedUIUpdater.hideLoading();
                EnhancedUIUpdater.showToast('Ride scheduled successfully', 'success');
                
                // Set up notification for scheduled ride
                const scheduleTime = new Date(rideData.scheduledTime);
                const notificationTime = new Date(scheduleTime.getTime() - 30 * 60000); // 30 minutes before
                
                // Schedule notification
                this.scheduleNotification(
                    rideId,
                    'Scheduled Ride Reminder',
                    `Your ride is scheduled for ${scheduleTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`,
                    notificationTime.getTime()
                );
                
                // Update timers
                this.updateScheduledRideTimers();
                
                console.log('Ride scheduled:', rideId);
                return rideId;
            } catch (error) {
                console.error('Error scheduling ride:', error);
                EnhancedUIUpdater.hideLoading();
                EnhancedUIUpdater.showToast('Error scheduling ride', 'error');
                throw error;
            }
        },
        
        async scheduleNotification(notificationId, title, message, timestamp) {
            try {
                await database.ref(`scheduledNotifications/${notificationId}`).set({
                    userId: AppState.currentUser.uid,
                    title: title,
                    message: message,
                    timestamp: timestamp,
                    status: 'pending'
                });
            } catch (error) {
                console.error('Error scheduling notification:', error);
            }
        },
        
        async sendChatMessage(rideId, message, isDriver = false) {
            try {
                const messageId = database.ref().child(`chats/${rideId}/messages`).push().key;
                const chatMessage = {
                    id: messageId,
                    text: message,
                    senderId: isDriver ? AppState.currentRide?.driverId : AppState.currentUser.uid,
                    senderName: isDriver ? AppState.selectedVehicle?.name : AppState.userData?.name,
                    timestamp: Date.now(),
                    isDriver: isDriver
                };
                
                await database.ref(`chats/${rideId}/messages/${messageId}`).set(chatMessage);
                
                // Update typing indicator
                await database.ref(`chats/${rideId}/typing/${isDriver ? 'driverTyping' : 'passengerTyping'}`).set(false);
                
                console.log('Chat message sent:', messageId);
                return messageId;
            } catch (error) {
                console.error('Error sending chat message:', error);
                throw error;
            }
        },
        
        async updateTypingStatus(rideId, isTyping, isDriver = false) {
            try {
                await database.ref(`chats/${rideId}/typing/${isDriver ? 'driverTyping' : 'passengerTyping'}`).set(isTyping);
            } catch (error) {
                console.error('Error updating typing status:', error);
            }
        },
        
        async saveSOSConfig(config) {
            try {
                await database.ref(`sosConfig/${AppState.currentUser.uid}`).set(config);
                AppState.sosConfig = config;
                
                // Update emergency contact display
                document.getElementById('emergencyContact1Name').textContent = config.contact1Name || 'Contact 1';
                document.getElementById('emergencyContact1Phone').textContent = config.contact1Phone || '';
                document.getElementById('emergencyContact2Name').textContent = config.contact2Name || 'Contact 2';
                document.getElementById('emergencyContact2Phone').textContent = config.contact2Phone || '';
                
                EnhancedUIUpdater.showToast('SOS configuration saved', 'success');
                console.log('SOS config saved');
                return true;
            } catch (error) {
                console.error('Error saving SOS config:', error);
                EnhancedUIUpdater.showToast('Error saving SOS config', 'error');
                return false;
            }
        },
        
        async sendSOSAlert(rideId, sosData) {
            try {
                const alertId = database.ref().child('sosAlerts').push().key;
                await database.ref(`sosAlerts/${alertId}`).set({
                    ...sosData,
                    rideId: rideId,
                    timestamp: Date.now(),
                    status: 'active'
                });
                
                // Also send as notification to emergency contacts
                if (sosData.emergencyContact1) {
                    await this.sendSMSNotification(
                        sosData.emergencyContact1,
                        'SOS Alert',
                        `EMERGENCY: ${sosData.message}. Location: ${sosData.location?.lat},${sosData.location?.lng}. Ride Details: ${sosData.rideDetails?.pickup} to ${sosData.rideDetails?.destination} in ${sosData.city}`
                    );
                }
                if (sosData.emergencyContact2) {
                    await this.sendSMSNotification(
                        sosData.emergencyContact2,
                        'SOS Alert',
                        `EMERGENCY: ${sosData.message}. Location: ${sosData.location?.lat},${sosData.location?.lng}. Ride Details: ${sosData.rideDetails?.pickup} to ${sosData.rideDetails?.destination} in ${sosData.city}`
                    );
                }
                
                EnhancedUIUpdater.showToast('SOS alert sent to emergency contacts', 'success');
                console.log('SOS alert sent:', alertId);
                return true;
            } catch (error) {
                console.error('Error sending SOS alert:', error);
                EnhancedUIUpdater.showToast('Error sending SOS alert', 'error');
                return false;
        }
    },
    
    async sendSMSNotification(phoneNumber, title, message) {
        try {
            // This would typically call an SMS gateway API
            // For now, we'll log it and store in database
            console.log(`SMS to ${phoneNumber}: ${title} - ${message}`);
            
            const smsId = database.ref().child('smsNotifications').push().key;
            await database.ref(`smsNotifications/${smsId}`).set({
                phoneNumber: phoneNumber,
                title: title,
                message: message,
                timestamp: Date.now(),
                status: 'sent'
            });
            
            return true;
        } catch (error) {
            console.error('Error sending SMS:', error);
            return false;
        }
    },
    
    async sendNotification(userId, title, message, type = 'info', data = null) {
        try {
            const notificationId = database.ref().child(`notifications/${userId}`).push().key;
            const notification = {
                id: notificationId,
                title: title,
                message: message,
                type: type,
                read: false,
                timestamp: Date.now(),
                data: data
            };
            
            await database.ref(`notifications/${userId}/${notificationId}`).set(notification);
            console.log('Notification sent:', notificationId);
            return true;
        } catch (error) {
            console.error('Error sending notification:', error);
            return false;
        }
    },
    
    async transferMoney(recipientCode, amount, message = '') {
        try {
            EnhancedUIUpdater.showLoading('Processing transfer...');
            
            // Find recipient by referral code
            const usersSnapshot = await database.ref('users').once('value');
            const users = usersSnapshot.val();
            let recipientId = null;
            let recipientName = '';
            
            for (const [userId, userData] of Object.entries(users)) {
                if (userData.referralCode === recipientCode) {
                    recipientId = userId;
                    recipientName = userData.name;
                    break;
                }
            }
            
            if (!recipientId) {
                throw new Error('Recipient not found. Please check the referral code.');
            }
            
            if (recipientId === AppState.currentUser.uid) {
                throw new Error('Cannot transfer money to yourself.');
            }
            
            // Check sender balance
            if (AppState.walletBalance < amount) {
                throw new Error('Insufficient balance');
            }
            
            // Perform transfer
            const senderNewBalance = AppState.walletBalance - amount;
            const recipientSnapshot = await database.ref(`users/${recipientId}/walletBalance`).once('value');
            const recipientBalance = recipientSnapshot.val() || 0;
            const recipientNewBalance = recipientBalance + amount;
            
            // Update balances in a transaction
            await database.ref().update({
                [`users/${AppState.currentUser.uid}/walletBalance`]: senderNewBalance,
                [`users/${recipientId}/walletBalance`]: recipientNewBalance
            });
            
            // Record transaction
            const transactionId = database.ref().child('transactions').push().key;
            const transaction = {
                id: transactionId,
                senderId: AppState.currentUser.uid,
                senderName: AppState.userData.name,
                recipientId: recipientId,
                recipientName: recipientName,
                amount: amount,
                message: message,
                timestamp: Date.now(),
                type: 'transfer',
                status: 'completed'
            };
            
            await database.ref(`transactions/${transactionId}`).set(transaction);
            
            // Update local balance
            EnhancedUIUpdater.updateWalletBalance(senderNewBalance);
            
            // Send notification to recipient
            await this.sendNotification(
                recipientId,
                'Money Received',
                `You received ZMW ${amount.toFixed(2)} from ${AppState.userData.name}`,
                'success',
                { transactionId: transactionId, action: 'view_payment' }
            );
            
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast(`ZMW ${amount.toFixed(2)} sent to ${recipientName}`, 'success');
            console.log('Money transferred:', transactionId);
            return true;
        } catch (error) {
            console.error('Error transferring money:', error);
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast(error.message, 'error');
            return false;
        }
    },
    
    async loadTransactions(userId) {
        try {
            EnhancedUIUpdater.showLoading('Loading transactions...');
            
            const snapshot = await database.ref('transactions')
                .orderByChild('senderId')
                .equalTo(userId)
                .once('value');
            
            const sentTransactions = snapshot.val() || {};
            
            const receivedSnapshot = await database.ref('transactions')
                .orderByChild('recipientId')
                .equalTo(userId)
                .once('value');
            
            const receivedTransactions = receivedSnapshot.val() || {};
            
            // Combine and sort transactions
            const allTransactions = [
                ...Object.values(sentTransactions),
                ...Object.values(receivedTransactions)
            ].sort((a, b) => b.timestamp - a.timestamp);
            
            EnhancedUIUpdater.hideLoading();
            console.log(`Loaded ${allTransactions.length} transactions`);
            return allTransactions;
        } catch (error) {
            console.error('Error loading transactions:', error);
            EnhancedUIUpdater.hideLoading();
            return [];
        }
    },
    
    async loadRideDetails(rideId) {
        try {
            const snapshot = await database.ref(`rides/${rideId}`).once('value');
            const ride = snapshot.val();
            if (ride) {
                return { id: rideId, ...ride };
            }
            return null;
        } catch (error) {
            console.error('Error loading ride details:', error);
            return null;
        }
    },
    
    handleRideCompletion: function(ride) {
        console.log('Handling ride completion:', ride.id);
        
        // Stop searching animation
        EnhancedUIUpdater.stopSearchingAnimation();
        
        // Hide ride status bar
        document.getElementById('rideStatusBar').classList.remove('active');
        
        // Hide SOS button
        document.getElementById('sosButton').style.display = 'none';
        
        // Hide emergency status
        document.getElementById('emergencyStatus').style.display = 'none';
        
        // Update timeline to completed
        EnhancedUIUpdater.updateTimeline('completed');
        
        // Add receipt button
        const actionButtons = document.querySelector('#rideInfoPanel .action-buttons');
        const existingReceiptBtn = document.querySelector('#receiptBtn');
        
        if (!existingReceiptBtn) {
            const receiptBtn = document.createElement('button');
            receiptBtn.id = 'receiptBtn';
            receiptBtn.className = 'btn btn-primary';
            receiptBtn.innerHTML = '<i class="fas fa-receipt"></i> View Receipt';
            receiptBtn.addEventListener('click', () => {
                this.generateReceipt(ride);
            });
            
            actionButtons.appendChild(receiptBtn);
        }
        
        // Update wallet balance if paid with wallet
        if (ride.paymentMethod === 'wallet') {
            const newBalance = AppState.walletBalance - ride.fare;
            EnhancedUIUpdater.updateWalletBalance(newBalance);
        }
        
        // Handle referral reward if applicable
        if (ride.referredBy) {
            this.handleReferralReward(ride);
        }
        
        // Send completion notification
        this.sendNotification(
            AppState.currentUser.uid,
            'Ride Completed',
            `Your ride to ${ride.destinationDisplay || ride.destination} has been completed. Fare: ZMW ${ride.fare?.toFixed(2)}`,
            'success',
            { rideId: ride.id, action: 'view_ride' }
        );
        
        // Reset active ride after delay
        setTimeout(() => {
            this.resetActiveRide();
        }, 5000);
    },
    
    async handleReferralReward(ride) {
        try {
            // Find referrer by referral code
            const usersSnapshot = await database.ref('users').once('value');
            const users = usersSnapshot.val();
            let referrerId = null;
            
            for (const [userId, userData] of Object.entries(users)) {
                if (userData.referralCode === ride.referredBy) {
                    referrerId = userId;
                    break;
                }
            }
            
            if (referrerId) {
                // Add ZMW 25 reward to referrer
                const referrerSnapshot = await database.ref(`users/${referrerId}/walletBalance`).once('value');
                const referrerBalance = referrerSnapshot.val() || 0;
                const newReferrerBalance = referrerBalance + 25;
                
                await database.ref(`users/${referrerId}/walletBalance`).set(newReferrerBalance);
                
                // Record transaction
                const transactionId = database.ref().child('transactions').push().key;
                const transaction = {
                    id: transactionId,
                    senderId: 'system',
                    senderName: 'Jubel System',
                    recipientId: referrerId,
                    recipientName: users[referrerId].name,
                    amount: 25,
                    message: `Referral reward from ${AppState.userData.name}`,
                    timestamp: Date.now(),
                    type: 'referral',
                    status: 'completed'
                };
                
                await database.ref(`transactions/${transactionId}`).set(transaction);
                
                // Send notification to referrer
                await this.sendNotification(
                    referrerId,
                    'Referral Reward',
                    `You earned ZMW 25.00 because ${AppState.userData.name} used your referral code`,
                    'success',
                    { transactionId: transactionId, action: 'view_payment' }
                );
                
                console.log('Referral reward processed:', transactionId);
            }
        } catch (error) {
            console.error('Error handling referral reward:', error);
        }
    },
    
    generateReceipt: function(ride) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Add receipt content
        doc.setFontSize(18);
        doc.setTextColor(255, 107, 53);
        doc.text('JUBEL RIDE RECEIPT', 105, 20, { align: 'center' });
        
        doc.setFontSize(10);
        doc.setTextColor(0, 0, 0);
        doc.text(`Receipt No: ${ride.id.substring(0, 8)}`, 20, 40);
        doc.text(`Date: ${new Date(ride.timestamp).toLocaleString()}`, 20, 45);
        doc.text(`City: ${ride.city || AppState.currentCity}`, 20, 50);
        
        // Add ride details
        doc.text(`Passenger: ${AppState.userData.name}`, 20, 60);
        doc.text(`Driver: ${ride.driverName || 'Not assigned'}`, 20, 65);
        doc.text(`Pickup: ${ride.pickupDisplay || ride.pickup}`, 20, 70);
        doc.text(`Destination: ${ride.destinationDisplay || ride.destination}`, 20, 75);
        doc.text(`Distance: ${ride.distance?.toFixed(1) || '0'} km`, 20, 80);
        
        if (ride.serviceType) {
            doc.text(`Service Type: ${ride.serviceType.charAt(0).toUpperCase() + ride.serviceType.slice(1)}`, 20, 85);
        } else {
            doc.text(`Ride Type: ${ride.rideType?.charAt(0).toUpperCase() + ride.rideType?.slice(1)}`, 20, 85);
        }
        
        // Add fare breakdown
        doc.text('Fare Breakdown:', 20, 95);
        
        let yPos = 100;
        if (ride.serviceType === 'truck') {
            const config = AppState.truckTypes[ride.truckType] || AppState.truckTypes.light;
            doc.text(`Base Fare: ZMW ${config.base.toFixed(2)}`, 30, yPos);
            yPos += 5;
            doc.text(`Distance Fare: ZMW ${((ride.distance || 0) * config.perKm).toFixed(2)}`, 30, yPos);
        } else if (ride.serviceType === 'delivery') {
            const config = AppState.deliveryTypes[ride.deliveryType] || AppState.deliveryTypes.standard;
            doc.text(`Base Fare: ZMW ${config.base.toFixed(2)}`, 30, yPos);
            yPos += 5;
            doc.text(`Distance Fare: ZMW ${((ride.distance || 0) * config.perKm).toFixed(2)}`, 30, yPos);
        } else {
            doc.text(`Base Fare: ZMW ${(AppState.rideTypes[ride.rideType]?.base || 20).toFixed(2)}`, 30, yPos);
            yPos += 5;
            doc.text(`Distance Fare: ZMW ${((ride.distance || 0) * (AppState.rideTypes[ride.rideType]?.perKm || 3)).toFixed(2)}`, 30, yPos);
        }
        
        yPos += 5;
        doc.text(`Total: ZMW ${ride.fare?.toFixed(2) || '0.00'}`, 30, yPos);
        
        // Add payment method
        yPos += 10;
        doc.text(`Payment Method: ${ride.paymentMethod?.charAt(0).toUpperCase() + ride.paymentMethod?.slice(1)}`, 20, yPos);
        
        // Add referral discount if applicable
        if (ride.referredBy) {
            yPos += 5;
            doc.text(`Referral Discount: 50% applied`, 20, yPos);
            yPos += 5;
            doc.text(`Referral Code: ${ride.referredBy}`, 20, yPos);
        }
        
        // Add QR code for verification
        doc.text('Scan for verification:', 20, yPos + 10);
        
        // Save PDF
        doc.save(`Jubel_Receipt_${ride.id.substring(0, 8)}.pdf`);
        EnhancedUIUpdater.showToast('Receipt downloaded', 'success');
        console.log('Receipt generated for ride:', ride.id);
    },
    
    resetActiveRide: function() {
        console.log('Resetting active ride state');
        
        // Hide ride info panel
        document.getElementById('rideInfoPanel').classList.remove('active');
        
        // Show active service form
        switchService(AppState.activeService);
        
        // Hide fare display
        document.getElementById('fareDisplay').classList.remove('active');
        
        // Hide ride type selection
        document.getElementById('rideTypeSelection').classList.remove('active');
        
        // Hide price calculator
        document.getElementById('priceCalculator').style.display = 'none';
        
        // Hide emergency status
        document.getElementById('emergencyStatus').style.display = 'none';
        
        // Hide SOS button
        document.getElementById('sosButton').style.display = 'none';
        
        // Hide ride status bar
        document.getElementById('rideStatusBar').classList.remove('active');
        
        // Hide emergency contact display
        document.getElementById('emergencyContactDisplay').style.display = 'none';
        
        // Hide broadcast feature
        document.getElementById('broadcastFeature').style.display = 'none';
        
        // Clear current ride
        AppState.currentRide = null;
        AppState.emergencyMode = false;
        AppState.selectedVehicle = null;
        AppState.driverLocation = null;
        AppState.currentReferralCode = null;
        AppState.referralOwnerName = null;
        
        // Remove driver marker
        if (driverMarker) {
            map.removeLayer(driverMarker);
            driverMarker = null;
        }
        
        // Remove route
        if (routeLayer) {
            map.removeLayer(routeLayer);
            routeLayer = null;
        }
        
        // Remove route polyline
        if (AppState.routePolyline) {
            map.removeLayer(AppState.routePolyline);
            AppState.routePolyline = null;
        }
        
        // Clear destination input
        document.getElementById('destinationLocation').value = '';
        
        // Remove destination marker
        if (destinationMarker) {
            map.removeLayer(destinationMarker);
            destinationMarker = null;
        }
        
        // Clear emergency station markers
        emergencyStationMarkers.forEach(marker => map.removeLayer(marker));
        emergencyStationMarkers = [];
        
        // Clear emergency markers
        emergencyMarkers.forEach(marker => map.removeLayer(marker));
        emergencyMarkers = [];
        
        // Clear chat messages
        document.getElementById('chatMessages').innerHTML = '';
        
        // Reset typing indicator
        EnhancedUIUpdater.updateTypingIndicator(false);
        
        EnhancedUIUpdater.showToast('Ride completed', 'success');
    },
    
    syncUserData: async function() {
        if (AppState.isSyncing) return;
        
        try {
            AppState.isSyncing = true;
            EnhancedUIUpdater.showSyncIndicator(true);
            
            console.log('Syncing user data...');
            
            // Sync user data
            if (AppState.currentUser) {
                await this.loadUserData(AppState.currentUser.uid);
            }
            
            // Sync current ride if exists
            if (AppState.currentRide) {
                const ride = await this.loadRideDetails(AppState.currentRide.id);
                if (ride) {
                    AppState.currentRide = ride;
                    EnhancedUIUpdater.showRideInfo(ride);
                }
            }
            
            EnhancedUIUpdater.showToast('Data synced successfully', 'success');
            console.log('User data sync completed');
        } catch (error) {
            console.error('Error syncing data:', error);
            EnhancedUIUpdater.showToast('Error syncing data', 'error');
        } finally {
            AppState.isSyncing = false;
            EnhancedUIUpdater.showSyncIndicator(false);
        }
    }
};

// ============================================
// ADVANCED CITY DETECTION AND LOCATION SERVICES
// ============================================
const CityDetector = {
    async detectCityFromLocation(lat, lng) {
        try {
            console.log(`Detecting city from location: ${lat}, ${lng}`);
            EnhancedUIUpdater.showLoading('Detecting your city...');
            
            const response = await fetch(
                `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=10&addressdetails=1`
            );
            
            if (!response.ok) {
                throw new Error('Reverse geocoding failed');
            }
            
            const data = await response.json();
            
            if (data && data.address) {
                const city = data.address.city || data.address.town || data.address.village || data.address.municipality;
                const state = data.address.state;
                
                if (city) {
                    // Validate it's a Zambian city
                    if (this.validateCity(city)) {
                        AppState.currentCity = city;
                        AppState.detectedCity = city;
                        
                        console.log(`City detected: ${city}`);
                        
                        // Update UI
                        EnhancedUIUpdater.updateCityDisplay(city);
                        
                        // Show city boundary on map
                        EnhancedUIUpdater.showCityBoundaryOnMap(city);
                        
                        // Clear search cache for new city
                        EnhancedSearchEngine.clearCache();
                        
                        // Update all UI elements that show city
                        this.updateCityInUI(city);
                        
                        EnhancedUIUpdater.hideLoading();
                        EnhancedUIUpdater.showToast(`Detected city: ${city}`, 'success');
                        return city;
                    } else {
                        console.log(`City ${city} not in Zambian cities list`);
                    }
                }
            }
            
            // If no valid city found, use default
            return this.useDefaultCity();
            
        } catch (error) {
            console.error('City detection error:', error);
            AppState.cityDetectionAttempts++;
            
            if (AppState.cityDetectionAttempts < AppState.maxCityDetectionAttempts) {
                // Retry after delay
                setTimeout(() => {
                    this.detectCityFromLocation(lat, lng);
                }, 2000);
            } else {
                // Use default city
                return this.useDefaultCity();
            }
            
            return null;
        }
    },
    
    validateCity: function(cityName) {
        const validCities = [
            'Lusaka', 'Ndola', 'Kitwe', 'Kabwe', 'Livingstone', 'Chipata',
            'Chingola', 'Mufulira', 'Luanshya', 'Kasama', 'Solwezi', 'Mazabuka',
            'Mongu', 'Kafue', 'Choma', 'Mumbwa', 'Kapiri Mposhi', 'Nchelenge',
            'Samfya', 'Katima Mulilo', 'Kalulushi', 'Chililabombwe'
        ];
        
        // Check for exact match or contains
        return validCities.some(validCity => 
            cityName.toLowerCase().includes(validCity.toLowerCase())
        );
    },
    
    useDefaultCity: function() {
        AppState.currentCity = 'Lusaka';
        AppState.detectedCity = 'Lusaka';
        
        console.log('Using default city: Lusaka');
        
        EnhancedUIUpdater.updateCityDisplay('Lusaka (Default)');
        EnhancedUIUpdater.showCityBoundaryOnMap('Lusaka');
        
        // Update all UI elements
        this.updateCityInUI('Lusaka');
        
        EnhancedUIUpdater.showToast('Using default city: Lusaka', 'warning');
        return 'Lusaka';
    },
    
    updateCityInUI: function(city) {
        // Update all elements with city class
        document.querySelectorAll('.current-city').forEach(element => {
            element.textContent = city;
        });
        
        // Update search placeholders
        document.querySelectorAll('input[placeholder*="city"]').forEach(input => {
            input.placeholder = input.placeholder.replace(/city/i, city);
        });
        
        // Update page title if needed
        document.title = `Jubel Passenger - ${city}`;
    },
    
    async getDetailedAddress(lat, lng) {
        try {
            const response = await fetch(
                `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`
            );
            
            if (!response.ok) {
                throw new Error('Detailed reverse geocoding failed');
            }
            
            const data = await response.json();
            
            if (data && data.address) {
                const address = data.address;
                const parts = [];
                
                if (address.house_number || address.housenumber) {
                    parts.push(address.house_number || address.housenumber);
                }
                
                if (address.road) {
                    parts.push(address.road);
                }
                
                if (address.suburb || address.neighbourhood) {
                    parts.push(address.suburb || address.neighbourhood);
                }
                
                if (address.city || address.town) {
                    parts.push(address.city || address.town);
                }
                
                const fullAddress = parts.join(', ') || data.display_name;
                
                AppState.locationManagement.userDetectedAddress = {
                    address: fullAddress,
                    houseNumber: address.house_number || address.housenumber,
                    road: address.road,
                    suburb: address.suburb || address.neighbourhood,
                    city: address.city || address.town,
                    state: address.state,
                    fullDisplay: data.display_name,
                    lat: lat,
                    lng: lng
                };
                
                return AppState.locationManagement.userDetectedAddress;
            }
            
            return {
                address: `${lat.toFixed(6)}, ${lng.toFixed(6)}`,
                fullDisplay: `${lat.toFixed(6)}, ${lng.toFixed(6)}`,
                lat: lat,
                lng: lng
            };
        } catch (error) {
            console.error('Detailed address error:', error);
            return {
                address: `${lat.toFixed(6)}, ${lng.toFixed(6)}`,
                fullDisplay: `${lat.toFixed(6)}, ${lng.toFixed(6)}`,
                lat: lat,
                lng: lng
            };
        }
    }
};

// ============================================
// INITIALIZATION
// ============================================
async function initializeApp() {
    try {
        console.log('Initializing Jubel Passenger App...');
        EnhancedUIUpdater.showLoading('Initializing app...');
        
        // Initialize search engine
        EnhancedSearchEngine.init();
        
        // Initialize location manager
        EnhancedLocationManager.init();
        
        // Check authentication
        const urlParams = new URLSearchParams(window.location.search);
        const email = urlParams.get('email');
        const uid = urlParams.get('uid');
        
        if (email && uid) {
            console.log('Authenticated via URL parameters');
            AppState.currentUser = { uid, email };
            await EnhancedFirebaseManager.loadUserData(uid);
        } else {
            console.log('Checking Firebase auth state...');
            // Listen for auth state changes
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    console.log('User authenticated:', user.uid);
                    AppState.currentUser = user;
                    await EnhancedFirebaseManager.loadUserData(user.uid);
                } else {
                    console.log('No user logged in, redirecting to signup');
                    window.location.href = 'signup.html';
                }
            });
        }
        
        // Initialize map
        initializeMap();
        
        // Set up event listeners
        setupEventListeners();
        
        // Get current location
        getCurrentLocation();
        
        // Set minimum date for schedule form
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('scheduleDate').min = today;
        
        // Initialize shopping items
        initializeShoppingItems();
        
        // Start sync interval
        AppState.syncInterval = setInterval(() => {
            EnhancedFirebaseManager.syncUserData();
        }, 60000); // Sync every minute
        
        EnhancedUIUpdater.hideLoading();
        EnhancedUIUpdater.showToast('Jubel Passenger App Ready', 'success');
        console.log('App initialization completed successfully');
        
    } catch (error) {
        console.error('Error initializing app:', error);
        EnhancedUIUpdater.hideLoading();
        EnhancedUIUpdater.showToast('Error initializing app', 'error');
    }
}

function initializeMap() {
    console.log('Initializing map...');
    // Default to Lusaka coordinates
    const defaultLat = -15.4167;
    const defaultLng = 28.2833;
    
    map = L.map('map').setView([defaultLat, defaultLng], 13);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: ' OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(map);
    
    // Add map controls
    L.control.scale().addTo(map);
    
    EnhancedUIUpdater.hideMapLoading();
    console.log('Map initialized');
}

function initializeShoppingItems() {
    console.log('Initializing shopping items...');
    const itemsContainer = document.getElementById('shoppingItems');
    const addItemBtn = document.getElementById('addItemBtn');
    
    if (!itemsContainer || !addItemBtn) {
        console.warn('Shopping items elements not found');
        return;
    }
    
    // Add first item removal button
    const firstItem = itemsContainer.querySelector('.item-entry');
    if (firstItem) {
        const removeBtn = firstItem.querySelector('.remove-item');
        if (removeBtn) {
            removeBtn.addEventListener('click', function() {
                if (itemsContainer.children.length > 1) {
                    firstItem.remove();
                }
            });
        }
    }
    
    // Add new item
    addItemBtn.addEventListener('click', function() {
        const itemEntry = document.createElement('div');
        itemEntry.className = 'item-entry';
        itemEntry.innerHTML = `
            <input type="text" class="item-input" placeholder="Item name">
            <button class="remove-item" type="button">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        itemsContainer.appendChild(itemEntry);
        
        // Add event to remove button
        const removeBtn = itemEntry.querySelector('.remove-item');
        removeBtn.addEventListener('click', function() {
            itemEntry.remove();
        });
    });
    
    console.log('Shopping items initialized');
}

async function getCurrentLocation() {
    if (!navigator.geolocation) {
        console.warn('Geolocation is not supported by your browser');
        EnhancedUIUpdater.showToast('Geolocation is not supported by your browser', 'warning');
        return;
    }
    
    console.log('Getting current location...');
    EnhancedUIUpdater.showLoading('Getting your location...');
    
    try {
        const position = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            });
        });
        
        const { latitude, longitude } = position.coords;
        console.log(`Location obtained: ${latitude}, ${longitude}`);
        
        AppState.userLocation = { lat: latitude, lng: longitude };
        
        // Center map on user location
        map.setView([latitude, longitude], 15);
        
        // Add current location marker
        currentLocationMarker = L.marker([latitude, longitude], {
            icon: L.divIcon({
                className: 'current-location-marker',
                html: '<i class="fas fa-user"></i>',
                iconSize: [18, 18],
                iconAnchor: [9, 18]
            })
        }).addTo(map).bindPopup('Your Location');
        
        // Get detailed address
        const detailedAddress = await CityDetector.getDetailedAddress(latitude, longitude);
        console.log('Detailed address:', detailedAddress);
        
        // Update pickup location inputs
        const addressInputs = [
            'pickupLocation', 'deliveryPickup', 'shortDeliveryPickup', 
            'truckPickup', 'schedulePickup', 'someonePickup',
            'sharePickup', 'broadcastPickup'
        ];
        
        addressInputs.forEach(inputId => {
            const input = document.getElementById(inputId);
            if (input) {
                input.value = detailedAddress.address;
                input.dataset.lat = latitude;
                input.dataset.lng = longitude;
                
                // Show clear/edit buttons
                EnhancedLocationManager.updatePickupInputButtons(inputId);
            }
        });
        
        // Update emergency user location display
        document.getElementById('emergencyUserLocation').textContent = detailedAddress.fullDisplay;
        
        AppState.pickup = {
            lat: latitude,
            lng: longitude,
            address: detailedAddress.address,
            name: 'Current Location',
            fullDisplay: detailedAddress.fullDisplay
        };
        
        // Detect city based on location
        const city = await CityDetector.detectCityFromLocation(latitude, longitude);
        console.log(`City detected: ${city}`);
        
        EnhancedUIUpdater.hideLoading();
        EnhancedUIUpdater.showToast('Location detected successfully', 'success');
        
    } catch (error) {
        console.error('Geolocation error:', error);
        EnhancedUIUpdater.hideLoading();
        EnhancedUIUpdater.showToast('Unable to get your location. Using default location.', 'warning');
        
        // Use default location
        AppState.userLocation = { lat: -15.4167, lng: 28.2833 };
        map.setView([-15.4167, 28.2833], 13);
        
        // Set default city
        CityDetector.useDefaultCity();
    }
}

// ============================================
// EVENT HANDLERS SETUP
// ============================================
function setupEventListeners() {
    console.log('Setting up event listeners...');
    
    // Navigation tabs
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const screen = tab.dataset.screen;
            switchScreen(screen);
        });
    });
    
    // Back buttons
    document.querySelectorAll('.back-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            switchScreen('home');
        });
    });
    
    // Panel handle
    document.getElementById('panelHandle').addEventListener('click', togglePanel);
    
    // Service tabs
    document.querySelectorAll('.service-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const service = tab.dataset.service;
            switchService(service);
        });
    });
    
    // Ride type selection
    document.querySelectorAll('.ride-type-card').forEach(card => {
        card.addEventListener('click', () => {
            // Remove selected class from all cards
            document.querySelectorAll('.ride-type-card').forEach(c => {
                c.classList.remove('selected');
            });
            
            // Add selected class to clicked card
            card.classList.add('selected');
            
            // Update selected ride type
            AppState.selectedRideType = card.dataset.type;
            
            // Update prices
            if (AppState.pickup && AppState.destination) {
                EnhancedUIUpdater.calculateAndUpdatePrices();
            }
        });
    });
    
    // Truck type selection
    document.querySelectorAll('.truck-type').forEach(truck => {
        truck.addEventListener('click', () => {
            document.querySelectorAll('.truck-type').forEach(t => {
                t.classList.remove('selected');
            });
            truck.classList.add('selected');
            
            // Update prices if destinations are set
            if (AppState.pickup && AppState.destination) {
                EnhancedUIUpdater.calculateAndUpdatePrices();
            }
        });
    });
    
    // Delivery type selection
    document.getElementById('standardDelivery')?.addEventListener('click', () => {
        document.querySelectorAll('#deliveryForm .filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.getElementById('standardDelivery').classList.add('active');
        
        if (AppState.pickup && AppState.destination) {
            EnhancedUIUpdater.calculateAndUpdatePrices();
        }
    });
    
    document.getElementById('expressDelivery')?.addEventListener('click', () => {
        document.querySelectorAll('#deliveryForm .filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.getElementById('expressDelivery').classList.add('active');
        
        if (AppState.pickup && AppState.destination) {
            EnhancedUIUpdater.calculateAndUpdatePrices();
        }
    });
    
    document.getElementById('sameDayDelivery')?.addEventListener('click', () => {
        document.querySelectorAll('#deliveryForm .filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.getElementById('sameDayDelivery').classList.add('active');
        
        if (AppState.pickup && AppState.destination) {
            EnhancedUIUpdater.calculateAndUpdatePrices();
        }
    });
    
    // Map control buttons
    document.getElementById('locateMeBtn')?.addEventListener('click', () => {
        if (AppState.userLocation) {
            map.setView([AppState.userLocation.lat, AppState.userLocation.lng], 15);
            EnhancedUIUpdater.showToast('Centered on your location', 'info');
        } else {
            getCurrentLocation();
        }
    });
    
    document.getElementById('zoomInBtn')?.addEventListener('click', () => {
        map.zoomIn();
    });
    
    document.getElementById('zoomOutBtn')?.addEventListener('click', () => {
        map.zoomOut();
    });
    
    document.getElementById('clearRouteBtn')?.addEventListener('click', () => {
        if (routeLayer) {
            map.removeLayer(routeLayer);
            routeLayer = null;
        }
        
        if (AppState.routePolyline) {
            map.removeLayer(AppState.routePolyline);
            AppState.routePolyline = null;
        }
        
        if (destinationMarker) {
            map.removeLayer(destinationMarker);
            destinationMarker = null;
        }
        
        const destinationInput = document.getElementById('destinationLocation');
        if (destinationInput) {
            destinationInput.value = '';
        }
        AppState.destination = null;
        
        EnhancedUIUpdater.showToast('Route cleared', 'info');
    });
    
    // Request ride button
    document.getElementById('requestRideBtn')?.addEventListener('click', async () => {
        if (!AppState.pickup || !AppState.destination) {
            EnhancedUIUpdater.showToast('Please select pickup and destination locations', 'warning');
            return;
        }
        
        // Validate both locations are within city
        if (!EnhancedSearchEngine.validateCoordinatesInCity(
            AppState.pickup.lat, AppState.pickup.lng, AppState.currentCity
        ) || !EnhancedSearchEngine.validateCoordinatesInCity(
            AppState.destination.lat, AppState.destination.lng, AppState.currentCity
        )) {
            EnhancedUIUpdater.showToast('Locations must be within city boundaries', 'warning');
            return;
        }
        
        // Calculate distance
        const distance = EnhancedPriceCalculator.calculateDistance(
            AppState.pickup.lat, AppState.pickup.lng,
            AppState.destination.lat, AppState.destination.lng
        );
        
        if (distance < 0.5) {
            EnhancedUIUpdater.showToast('Minimum ride distance is 0.5 km', 'warning');
            return;
        }
        
        // Validate distance within city limits
        const validation = EnhancedPriceCalculator.validateDistanceWithinCity(
            AppState.pickup.lat, AppState.pickup.lng,
            AppState.destination.lat, AppState.destination.lng,
            AppState.currentCity
        );
        
        if (!validation.valid) {
            EnhancedUIUpdater.showToast(validation.message, 'warning');
            return;
        }
        
        // Show payment modal with ride details
        document.getElementById('paymentAmount').textContent = `ZMW ${AppState.rideFare.toFixed(2)}`;
        
        // Add referral code section to payment modal
        EnhancedUIUpdater.updatePaymentModalWithReferral(AppState.rideFare);
        
        showModal('payment');
        
        // Store ride data for after payment
        window.pendingRideData = {
            pickup: AppState.pickup.address,
            pickupDisplay: AppState.pickup.fullDisplay || AppState.pickup.name,
            destination: AppState.destination.address,
            destinationDisplay: AppState.destination.fullAddress || AppState.destination.name,
            pickupLat: AppState.pickup.lat,
            pickupLng: AppState.pickup.lng,
            destLat: AppState.destination.lat,
            destLng: AppState.destination.lng,
            rideType: AppState.selectedRideType,
            fare: AppState.rideFare,
            distance: distance
        };
    });
    
    // Request delivery button
    document.getElementById('requestDeliveryBtn')?.addEventListener('click', async () => {
        const pickupInput = document.getElementById('deliveryPickup');
        const destinationInput = document.getElementById('deliveryDestination');
        const parcelDesc = document.getElementById('parcelDescription');
        const receiverName = document.getElementById('receiverName');
        const receiverPhone = document.getElementById('receiverPhone');
        const parcelValue = document.getElementById('parcelValue');
        
        if (!pickupInput?.value || !destinationInput?.value || !parcelDesc?.value || 
            !receiverName?.value || !receiverPhone?.value) {
            EnhancedUIUpdater.showToast('Please fill all required fields', 'warning');
            return;
        }
        
        if (!AppState.pickup || !AppState.destination) {
            EnhancedUIUpdater.showToast('Please select valid pickup and delivery locations', 'warning');
            return;
        }
        
        // Validate locations are within city
        if (!EnhancedSearchEngine.validateCoordinatesInCity(
            AppState.pickup.lat, AppState.pickup.lng, AppState.currentCity
        ) || !EnhancedSearchEngine.validateCoordinatesInCity(
            AppState.destination.lat, AppState.destination.lng, AppState.currentCity
        )) {
            EnhancedUIUpdater.showToast('Locations must be within city boundaries', 'warning');
            return;
        }
        
        const distance = EnhancedPriceCalculator.calculateDistance(
            AppState.pickup.lat, AppState.pickup.lng,
            AppState.destination.lat, AppState.destination.lng
        );
        
        // Get delivery type
        let deliveryType = 'standard';
        if (document.getElementById('expressDelivery')?.classList.contains('active')) {
            deliveryType = 'express';
        } else if (document.getElementById('sameDayDelivery')?.classList.contains('active')) {
            deliveryType = 'sameDay';
        }
        
        // Calculate fare
        const fare = EnhancedPriceCalculator.calculateDeliveryFare(
            distance, 
            deliveryType, 
            parseFloat(parcelValue?.value) || 0
        );
        
        // Show payment modal
        document.getElementById('paymentAmount').textContent = `ZMW ${fare.toFixed(2)}`;
        
        // Add referral code section to payment modal
        EnhancedUIUpdater.updatePaymentModalWithReferral(fare);
        
        showModal('payment');
        
        // Store delivery data for after payment
        window.pendingDeliveryData = {
            pickup: AppState.pickup.address,
            pickupDisplay: AppState.pickup.fullDisplay || AppState.pickup.name,
            destination: AppState.destination.address,
            destinationDisplay: AppState.destination.fullAddress || AppState.destination.name,
            pickupLat: AppState.pickup.lat,
            pickupLng: AppState.pickup.lng,
            destLat: AppState.destination.lat,
            destLng: AppState.destination.lng,
            parcelDescription: parcelDesc.value,
            receiverName: receiverName.value,
            receiverPhone: receiverPhone.value,
            parcelValue: parseFloat(parcelValue?.value) || 0,
            deliveryType: deliveryType,
            fare: fare,
            distance: distance
        };
    });
    
    // Request truck button
    document.getElementById('requestTruckBtn')?.addEventListener('click', async () => {
        const pickupInput = document.getElementById('truckPickup');
        const destinationInput = document.getElementById('truckDestination');
        const itemDesc = document.getElementById('truckItemDescription');
        const estimatedWeight = document.getElementById('estimatedWeight');
        const needHelpers = document.getElementById('needHelpers')?.checked;
        
        if (!pickupInput?.value || !destinationInput?.value || !itemDesc?.value || !estimatedWeight?.value) {
            EnhancedUIUpdater.showToast('Please fill all required fields', 'warning');
            return;
        }
        
        if (!AppState.pickup || !AppState.destination) {
            EnhancedUIUpdater.showToast('Please select valid pickup and destination locations', 'warning');
            return;
        }
        
        // Validate locations are within city
        if (!EnhancedSearchEngine.validateCoordinatesInCity(
            AppState.pickup.lat, AppState.pickup.lng, AppState.currentCity
        ) || !EnhancedSearchEngine.validateCoordinatesInCity(
            AppState.destination.lat, AppState.destination.lng, AppState.currentCity
        )) {
            EnhancedUIUpdater.showToast('Locations must be within city boundaries', 'warning');
            return;
        }
        
        const distance = EnhancedPriceCalculator.calculateDistance(
            AppState.pickup.lat, AppState.pickup.lng,
            AppState.destination.lat, AppState.destination.lng
        );
        
        // Get selected truck type
        const selectedTruck = document.querySelector('.truck-type.selected');
        const truckType = selectedTruck ? selectedTruck.dataset.type : 'light';
        
        // Calculate fare
        const fare = EnhancedPriceCalculator.calculateTruckFare(distance, truckType, needHelpers);
        
        // Show payment modal
        document.getElementById('paymentAmount').textContent = `ZMW ${fare.toFixed(2)}`;
        
        // Add referral code section to payment modal
        EnhancedUIUpdater.updatePaymentModalWithReferral(fare);
        
        showModal('payment');
        
        // Store truck data for after payment
        window.pendingTruckData = {
            pickup: AppState.pickup.address,
            pickupDisplay: AppState.pickup.fullDisplay || AppState.pickup.name,
            destination: AppState.destination.address,
            destinationDisplay: AppState.destination.fullAddress || AppState.destination.name,
            pickupLat: AppState.pickup.lat,
            pickupLng: AppState.pickup.lng,
            destLat: AppState.destination.lat,
            destLng: AppState.destination.lng,
            truckType: truckType,
            itemDescription: itemDesc.value,
            estimatedWeight: parseFloat(estimatedWeight.value) || 0,
            needHelpers: needHelpers,
            fare: fare,
            distance: distance
        };
    });
    
    // Request shopping button
    document.getElementById('requestShoppingBtn')?.addEventListener('click', async () => {
        const shopName = document.getElementById('shopName');
        const shopLocation = document.getElementById('shopLocation');
        const destinationInput = document.getElementById('shoppingDestination');
        const instructions = document.getElementById('shoppingInstructions');
        const budget = document.getElementById('shoppingBudget');
        
        if (!shopName?.value || !shopLocation?.value || !destinationInput?.value) {
            EnhancedUIUpdater.showToast('Please fill all required fields', 'warning');
            return;
        }
        
        if (!AppState.destination) {
            EnhancedUIUpdater.showToast('Please select a valid delivery location', 'warning');
            return;
        }
        
        // Validate destination is within city
        if (!EnhancedSearchEngine.validateCoordinatesInCity(
            AppState.destination.lat, AppState.destination.lng, AppState.currentCity
        )) {
            EnhancedUIUpdater.showToast('Delivery location must be within city boundaries', 'warning');
            return;
        }
        
        // Calculate distance from shop to destination
        const distance = AppState.shopLocation ? 
            EnhancedPriceCalculator.calculateDistance(
                AppState.shopLocation.lat, AppState.shopLocation.lng,
                AppState.destination.lat, AppState.destination.lng
            ) : 5; // Default 5km if shop location not set
        
        // Count items
        const itemsCount = document.querySelectorAll('.item-input').length;
        
        // Calculate fare
        const fare = EnhancedPriceCalculator.calculateShoppingFare(
            distance, 
            itemsCount, 
            parseFloat(budget?.value) || 0
        );
        
        // Show payment modal
        document.getElementById('paymentAmount').textContent = `ZMW ${fare.toFixed(2)}`;
        
        // Add referral code section to payment modal
        EnhancedUIUpdater.updatePaymentModalWithReferral(fare);
        
        showModal('payment');
        
        // Store shopping data for after payment
        window.pendingShoppingData = {
            shopName: shopName.value,
            shopLocation: shopLocation.value,
            shopLat: AppState.shopLocation?.lat,
            shopLng: AppState.shopLocation?.lng,
            destination: AppState.destination.address,
            destinationDisplay: AppState.destination.fullAddress || AppState.destination.name,
            destLat: AppState.destination.lat,
            destLng: AppState.destination.lng,
            items: Array.from(document.querySelectorAll('.item-input')).map(input => input.value),
            itemsCount: itemsCount,
            instructions: instructions?.value || '',
            estimatedBudget: parseFloat(budget?.value) || 0,
            fare: fare,
            distance: distance
        };
    });
    
    // More options button
    document.getElementById('moreOptionsBtn')?.addEventListener('click', () => {
        const menu = document.getElementById('moreOptionsMenu');
        menu.classList.toggle('active');
    });
    
    // Broadcast ride button
    document.getElementById('broadcastRideBtn')?.addEventListener('click', () => {
        switchService('broadcast');
        document.getElementById('moreOptionsMenu').classList.remove('active');
    });
    
    // SOS setup button
    document.getElementById('sosSetupBtn')?.addEventListener('click', () => {
        showModal('sos');
        document.getElementById('moreOptionsMenu').classList.remove('active');
    });
    
    // Recent destinations button
    document.getElementById('recentDestinationsBtn')?.addEventListener('click', () => {
        EnhancedUIUpdater.showSearchHistory('destinationLocation');
        document.getElementById('moreOptionsMenu').classList.remove('active');
    });
    
    // More options menu items
    document.querySelectorAll('#moreOptionsMenu .dropdown-item').forEach(item => {
        item.addEventListener('click', () => {
            const option = item.dataset.option;
            handleMoreOptionSelection(option);
        });
    });
    
    // Cancel ride button
    document.getElementById('cancelRideBtn')?.addEventListener('click', () => {
        if (AppState.currentRide) {
            showModal('cancel');
        } else {
            EnhancedUIUpdater.showToast('No active ride to cancel', 'warning');
        }
    });
    
    // Payment method selection
    document.querySelectorAll('.payment-method').forEach(method => {
        method.addEventListener('click', () => {
            document.querySelectorAll('.payment-method').forEach(m => {
                m.classList.remove('selected');
            });
            method.classList.add('selected');
        });
    });
    
    // Confirm payment button
    document.getElementById('confirmPaymentBtn')?.addEventListener('click', async () => {
        const selectedMethod = document.querySelector('.payment-method.selected');
        if (!selectedMethod) {
            EnhancedUIUpdater.showToast('Please select a payment method', 'warning');
            return;
        }
        
        const paymentMethod = selectedMethod.dataset.payment;
        const amount = parseFloat(document.getElementById('paymentAmount').textContent.replace('ZMW ', ''));
        
        // Check wallet balance if paying with wallet
        if (paymentMethod === 'wallet' && AppState.walletBalance < amount) {
            EnhancedUIUpdater.showToast('Insufficient wallet balance', 'error');
            return;
        }
        
        // Prepare ride data based on pending service
        let rideData = {};
        
        if (window.pendingDeliveryData) {
            rideData = {
                ...window.pendingDeliveryData,
                paymentMethod: paymentMethod,
                status: 'requested',
                referredBy: AppState.currentReferralCode
            };
            
            try {
                // If paying with wallet, deduct from balance
                if (paymentMethod === 'wallet') {
                    await EnhancedFirebaseManager.withdrawMoney(amount);
                }
                
                await EnhancedFirebaseManager.requestDelivery(rideData);
                hideModal('payment');
                delete window.pendingDeliveryData;
            } catch (error) {
                EnhancedUIUpdater.showToast('Error processing delivery request', 'error');
            }
        } else if (window.pendingTruckData) {
            rideData = {
                ...window.pendingTruckData,
                paymentMethod: paymentMethod,
                status: 'requested',
                referredBy: AppState.currentReferralCode
            };
            
            try {
                if (paymentMethod === 'wallet') {
                    await EnhancedFirebaseManager.withdrawMoney(amount);
                }
                
                await EnhancedFirebaseManager.requestTruck(rideData);
                hideModal('payment');
                delete window.pendingTruckData;
            } catch (error) {
                EnhancedUIUpdater.showToast('Error processing truck request', 'error');
            }
        } else if (window.pendingShoppingData) {
            rideData = {
                ...window.pendingShoppingData,
                paymentMethod: paymentMethod,
                status: 'requested',
                referredBy: AppState.currentReferralCode
            };
            
            try {
                if (paymentMethod === 'wallet') {
                    await EnhancedFirebaseManager.withdrawMoney(amount);
                }
                
                await EnhancedFirebaseManager.requestShopping(rideData);
                hideModal('payment');
                delete window.pendingShoppingData;
            } catch (error) {
                EnhancedUIUpdater.showToast('Error processing shopping request', 'error');
            }
        } else if (window.pendingSharedRideData) {
            rideData = {
                ...window.pendingSharedRideData,
                paymentMethod: paymentMethod,
                status: 'requested',
                referredBy: AppState.currentReferralCode
            };
            
            try {
                if (paymentMethod === 'wallet') {
                    await EnhancedFirebaseManager.withdrawMoney(amount);
                }
                
                await EnhancedFirebaseManager.acceptSharedRideInvitation(rideData.invitationId);
                hideModal('payment');
                delete window.pendingSharedRideData;
            } catch (error) {
                EnhancedUIUpdater.showToast('Error processing shared ride', 'error');
            }
        } else if (window.pendingBroadcastData) {
            rideData = {
                ...window.pendingBroadcastData,
                paymentMethod: paymentMethod,
                status: 'requested',
                referredBy: AppState.currentReferralCode
            };
            
            try {
                if (paymentMethod === 'wallet') {
                    await EnhancedFirebaseManager.withdrawMoney(amount);
                }
                
                await EnhancedFirebaseManager.requestRide(rideData);
                hideModal('payment');
                delete window.pendingBroadcastData;
            } catch (error) {
                EnhancedUIUpdater.showToast('Error processing broadcast request', 'error');
            }
        } else {
            // Regular car ride
            const distance = EnhancedPriceCalculator.calculateDistance(
                AppState.pickup.lat, AppState.pickup.lng,
                AppState.destination.lat, AppState.destination.lng
            );
            
            rideData = {
                pickup: AppState.pickup.address,
                pickupDisplay: AppState.pickup.fullDisplay || AppState.pickup.name,
                destination: AppState.destination.address,
                destinationDisplay: AppState.destination.fullAddress || AppState.destination.name,
                pickupLat: AppState.pickup.lat,
                pickupLng: AppState.pickup.lng,
                destLat: AppState.destination.lat,
                destLng: AppState.destination.lng,
                rideType: AppState.selectedRideType,
                fare: AppState.rideFare,
                distance: distance,
                paymentMethod: paymentMethod,
                status: 'requested',
                referredBy: AppState.currentReferralCode
            };
            
            try {
                if (paymentMethod === 'wallet') {
                    await EnhancedFirebaseManager.withdrawMoney(amount);
                }
                
                await EnhancedFirebaseManager.requestRide(rideData);
                hideModal('payment');
            } catch (error) {
                EnhancedUIUpdater.showToast('Error processing ride request', 'error');
            }
        }
        
        // Clear referral data
        AppState.currentReferralCode = null;
        AppState.referralOwnerName = null;
    });
    
    // Modal close buttons
    document.querySelectorAll('.modal-close').forEach(btn => {
        btn.addEventListener('click', () => {
            const modal = btn.dataset.modal;
            hideModal(modal);
        });
    });
    
    // Transfer money button
    document.getElementById('transferBtn')?.addEventListener('click', () => {
        showModal('transfer');
    });
    
    // Confirm transfer button
    document.getElementById('confirmTransferBtn')?.addEventListener('click', async () => {
        const recipientCode = document.getElementById('recipientCode')?.value.trim();
        const amount = parseFloat(document.getElementById('transferAmount')?.value);
        const message = document.getElementById('transferMessage')?.value.trim();
        
        if (!recipientCode || !amount || amount <= 0) {
            EnhancedUIUpdater.showToast('Please enter valid transfer details', 'warning');
            return;
        }
        
        if (amount > AppState.walletBalance) {
            EnhancedUIUpdater.showToast('Insufficient balance', 'error');
            return;
        }
        
        await EnhancedFirebaseManager.transferMoney(recipientCode, amount, message);
        hideModal('transfer');
    });
    
    // Transactions button
    document.getElementById('transactionsBtn')?.addEventListener('click', async () => {
        showModal('transactions');
        const transactions = await EnhancedFirebaseManager.loadTransactions(AppState.currentUser.uid);
        displayTransactions(transactions);
    });
    
    // History filter buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            // Update active button
            document.querySelectorAll('.filter-btn').forEach(b => {
                b.classList.remove('active');
            });
            btn.classList.add('active');
            
            // Update filter and reload history
            AppState.activeFilter = btn.dataset.filter;
            EnhancedFirebaseManager.loadRideHistory(AppState.currentUser.uid);
        });
    });
    
    // Deposit button
    document.getElementById('depositBtn')?.addEventListener('click', () => {
        const amount = prompt('Enter deposit amount (ZMW):');
        if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
            const depositAmount = parseFloat(amount);
            EnhancedFirebaseManager.depositMoney(depositAmount);
        }
    });
    
    // Withdraw button
    document.getElementById('withdrawBtn')?.addEventListener('click', () => {
        if (AppState.walletBalance <= 0) {
            EnhancedUIUpdater.showToast('No balance to withdraw', 'warning');
            return;
        }
        
        const amount = prompt(`Enter withdrawal amount (ZMW). Available: ZMW ${AppState.walletBalance.toFixed(2)}:`);
        if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
            const withdrawalAmount = parseFloat(amount);
            
            if (withdrawalAmount > AppState.walletBalance) {
                EnhancedUIUpdater.showToast('Insufficient balance', 'error');
                return;
            }
            
            EnhancedFirebaseManager.withdrawMoney(withdrawalAmount);
        }
    });
    
    // Share referral button
    document.getElementById('shareReferralBtn')?.addEventListener('click', () => {
        const code = document.getElementById('referralCode')?.textContent;
        const text = `Join me on Jubel! Use my referral code ${code} for 50% off your first ride. Download the app now!`;
        
        if (navigator.share) {
            navigator.share({
                title: 'Jubel Referral',
                text: text,
                url: window.location.href
            }).catch(() => {
                // Fallback to clipboard
                navigator.clipboard.writeText(text)
                    .then(() => EnhancedUIUpdater.showToast('Referral code copied', 'success'))
                    .catch(() => EnhancedUIUpdater.showToast('Error copying code', 'error'));
            });
        } else {
            navigator.clipboard.writeText(text)
                .then(() => EnhancedUIUpdater.showToast('Referral code copied', 'success'))
                .catch(() => EnhancedUIUpdater.showToast('Error copying code', 'error'));
        }
    });
    
    // Update profile button
    document.getElementById('updateProfileBtn')?.addEventListener('click', () => {
        showModal('updateProfile');
        
        // Pre-fill form with current data
        document.getElementById('updateName').value = AppState.userData?.name || '';
        document.getElementById('updatePhone').value = AppState.userData?.phone || '';
        document.getElementById('updateEmail').value = AppState.currentUser?.email || '';
        document.getElementById('updateHomeAddress').value = AppState.userData?.homeAddress || '';
        document.getElementById('updateWorkAddress').value = AppState.userData?.workAddress || '';
    });
    
    // Save profile button
    document.getElementById('saveProfileBtn')?.addEventListener('click', async () => {
        const name = document.getElementById('updateName')?.value.trim();
        const phone = document.getElementById('updatePhone')?.value.trim();
        const homeAddress = document.getElementById('updateHomeAddress')?.value.trim();
        const workAddress = document.getElementById('updateWorkAddress')?.value.trim();
        
        if (!name || !phone) {
            EnhancedUIUpdater.showToast('Please fill in name and phone number', 'warning');
            return;
        }
        
        const profileData = {
            name: name,
            phone: phone,
            homeAddress: homeAddress,
            workAddress: workAddress
        };
        
        await EnhancedFirebaseManager.updateProfile(profileData);
        hideModal('updateProfile');
    });
    
    // Logout button
    document.getElementById('logoutBtn')?.addEventListener('click', () => {
        if (confirm('Are you sure you want to logout?')) {
            EnhancedFirebaseManager.stopRealtimeSync();
            
            if (AppState.syncInterval) {
                clearInterval(AppState.syncInterval);
            }
            
            auth.signOut().then(() => {
                window.location.href = 'signup.html';
            });
        }
    });
    
    // Notification bell
    document.getElementById('notificationBell')?.addEventListener('click', () => {
        const panel = document.getElementById('notificationsPanel');
        panel.classList.toggle('active');
    });
    
    document.getElementById('notificationsClose')?.addEventListener('click', () => {
        document.getElementById('notificationsPanel').classList.remove('active');
    });
    
    // Schedule ride option
    document.querySelector('[data-option="schedule"]')?.addEventListener('click', () => {
        showModal('schedule');
        document.getElementById('moreOptionsMenu').classList.remove('active');
    });
    
    // Click outside suggestion lists to close them
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.location-input') && !e.target.closest('.suggestion-list') && !e.target.closest('.search-history')) {
            document.querySelectorAll('.suggestion-list').forEach(list => {
                list.style.display = 'none';
            });
            const searchHistory = document.getElementById('searchHistory');
            if (searchHistory) {
                searchHistory.style.display = 'none';
            }
        }
        
        // Close dropdown menus
        if (!e.target.closest('.more-options-menu') && !e.target.closest('#moreOptionsBtn')) {
            const moreOptionsMenu = document.getElementById('moreOptionsMenu');
            if (moreOptionsMenu) {
                moreOptionsMenu.classList.remove('active');
            }
        }
        
        if (!e.target.closest('.notifications-panel') && !e.target.closest('#notificationBell')) {
            const notificationsPanel = document.getElementById('notificationsPanel');
            if (notificationsPanel) {
                notificationsPanel.classList.remove('active');
            }
        }
    });
    
    // Escape key to close modals and panels
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            hideAllModals();
            const moreOptionsMenu = document.getElementById('moreOptionsMenu');
            if (moreOptionsMenu) {
                moreOptionsMenu.classList.remove('active');
            }
            const notificationsPanel = document.getElementById('notificationsPanel');
            if (notificationsPanel) {
                notificationsPanel.classList.remove('active');
            }
        }
    });
    
    // Window beforeunload event
    window.addEventListener('beforeunload', () => {
        EnhancedFirebaseManager.stopRealtimeSync();
        
        if (AppState.syncInterval) {
            clearInterval(AppState.syncInterval);
        }
        
        console.log('App cleanup completed');
    });
    
    console.log('Event listeners setup completed');
}

// ============================================
// HELPER FUNCTIONS
// ============================================
function switchScreen(screen) {
    console.log(`Switching to screen: ${screen}`);
    
    // Hide all screens
    document.querySelectorAll('.history-screen, .account-screen, .emergency-screen').forEach(s => {
        s.classList.remove('active');
    });
    
    // Update navigation tabs
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Hide notifications
    document.getElementById('notificationsPanel')?.classList.remove('active');
    document.getElementById('moreOptionsMenu')?.classList.remove('active');
    
    // Show selected screen
    if (screen === 'home') {
        AppState.activeScreen = 'home';
        document.querySelector(`.nav-tab[data-screen="home"]`)?.classList.add('active');
    } else {
        const screenElement = document.getElementById(`${screen}Screen`);
        if (screenElement) {
            screenElement.classList.add('active');
            document.querySelector(`.nav-tab[data-screen="${screen}"]`)?.classList.add('active');
            AppState.activeScreen = screen;
            
            // Load data for specific screens
            if (screen === 'history') {
                EnhancedFirebaseManager.loadRideHistory(AppState.currentUser.uid);
            }
        }
    }
}

function switchService(service) {
    console.log(`Switching to service: ${service}`);
    
    // Hide all forms
    document.querySelectorAll('.ride-request-form, .service-form, #broadcastForm').forEach(form => {
        form.style.display = 'none';
        form.classList.remove('active');
    });
    
    // Update service tabs
    document.querySelectorAll('.service-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Show selected service form
    AppState.activeService = service;
    
    switch(service) {
        case 'car':
            document.querySelector('.service-tab.car')?.classList.add('active');
            document.getElementById('carForm').style.display = 'block';
            break;
        case 'delivery':
            document.querySelector('.service-tab.delivery')?.classList.add('active');
            document.getElementById('deliveryForm').style.display = 'block';
            document.getElementById('deliveryForm').classList.add('active');
            break;
        case 'short-delivery':
            document.querySelector('.service-tab.short-delivery')?.classList.add('active');
            document.getElementById('shortDeliveryForm').style.display = 'block';
            document.getElementById('shortDeliveryForm').classList.add('active');
            break;
        case 'express':
            document.querySelector('.service-tab[data-service="express"]')?.classList.add('active');
            document.getElementById('expressForm').style.display = 'block';
            document.getElementById('expressForm').classList.add('active');
            break;
        case 'truck':
            document.querySelector('.service-tab[data-service="truck"]')?.classList.add('active');
            document.getElementById('truckForm').style.display = 'block';
            document.getElementById('truckForm').classList.add('active');
            break;
        case 'broadcast':
            document.getElementById('broadcastForm').style.display = 'block';
            document.getElementById('broadcastForm').classList.add('active');
            break;
    }
}

function handleMoreOptionSelection(option) {
    console.log(`More option selected: ${option}`);
    switch(option) {
        case 'schedule':
            showModal('schedule');
            break;
    }
}

function showModal(modalId) {
    console.log(`Showing modal: ${modalId}`);
    const modal = document.getElementById(`${modalId}Modal`);
    if (modal) {
        modal.classList.add('active');
    }
}

function hideModal(modalId) {
    console.log(`Hiding modal: ${modalId}`);
    const modal = document.getElementById(`${modalId}Modal`);
    if (modal) {
        modal.classList.remove('active');
    }
}

function hideAllModals() {
    console.log('Hiding all modals');
    document.querySelectorAll('.modal-overlay').forEach(modal => {
        modal.classList.remove('active');
    });
}

function togglePanel() {
    const panel = document.getElementById('mainPanel');
    panel.classList.toggle('collapsed');
}

function displayTransactions(transactions) {
    const container = document.getElementById('transactionsList');
    if (!container) return;
    
    if (transactions.length === 0) {
        container.innerHTML = `
            <div class="empty-state" style="padding: 30px 0;">
                <div class="empty-icon">
                    <i class="fas fa-receipt"></i>
                </div>
                <div class="empty-title">No transactions yet</div>
                <div class="empty-message">Your wallet transactions will appear here</div>
            </div>
        `;
        return;
    }
    
    let html = '';
    transactions.forEach(transaction => {
        const isSent = transaction.senderId === AppState.currentUser.uid;
        const isSystem = transaction.senderId === 'system' || transaction.recipientId === 'system';
        const date = new Date(transaction.timestamp);
        
        html += `
            <div class="history-item" style="margin-bottom: 10px;">
                <div class="history-header">
                    <div class="history-type">
                        <div class="history-icon" style="background: ${isSent ? 'var(--error-red)' : isSystem ? 'var(--info-blue)' : 'var(--success-green)'}">
                            <i class="fas fa-${isSent ? 'arrow-up' : isSystem ? 'exchange-alt' : 'arrow-down'}"></i>
                        </div>
                        <div class="history-type-name">
                            ${isSent ? 'Money Sent' : isSystem ? transaction.type === 'deposit' ? 'Deposit' : transaction.type === 'withdrawal' ? 'Withdrawal' : 'System' : 'Money Received'}
                        </div>
                    </div>
                    <div class="history-date">
                        ${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                    </div>
                </div>
                
                <div style="padding: 10px 0;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="color: var(--text-gray);">${isSent ? 'To' : isSystem ? 'Type' : 'From'}:</span>
                        <span style="font-weight: 600;">${isSent ? transaction.recipientName : isSystem ? transaction.type.charAt(0).toUpperCase() + transaction.type.slice(1) : transaction.senderName}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="color: var(--text-gray);">Amount:</span>
                        <span style="font-weight: 700; color: ${isSent ? 'var(--error-red)' : 'var(--success-green)'}">
                            ${isSent ? '-' : '+'}ZMW ${transaction.amount.toFixed(2)}
                        </span>
                    </div>
                    ${transaction.message ? `
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-gray);">Message:</span>
                        <span style="font-size: 12px;">${transaction.message}</span>
                    </div>
                    ` : ''}
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// ============================================
// START THE APPLICATION
// ============================================
window.addEventListener('load', initializeApp);
</script>
</script>
</body>
</html>







