<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jubel - Advanced Passenger App</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        /* Advanced CSS with enhanced design */
        :root {
            --primary-orange: #FF6B35;
            --primary-orange-light: #FF8B5C;
            --primary-orange-dark: #E55A28;
            --primary-red: #E74C3C;
            --primary-gradient: linear-gradient(135deg, #FF6B35, #FF8B5C);
            --secondary-gradient: linear-gradient(135deg, #FF8B5C, #FF6B35);
            --white: #FFFFFF;
            --white-light: #FAFAFA;
            --white-dark: #F5F5F5;
            --light-gray: #F8F9FA;
            --medium-gray: #E9ECEF;
            --dark-gray: #333333;
            --text-gray: #666666;
            --border-color: #E0E0E0;
            --success-green: #2ECC71;
            --warning-yellow: #F39C12;
            --info-blue: #3498DB;
            --error-red: #E74C3C;
            --ambulance-blue: #0066CC;
            --fire-truck-red: #CC0000;
            --police-blue: #0047AB;
            --hospital-green: #27AE60;
            --premium-gold: #FFD700;
            --economy-green: #2ECC71;
            --light-truck-brown: #8B4513;
            
            --shadow-xs: 0 1px 3px rgba(0,0,0,0.05);
            --shadow-sm: 0 2px 6px rgba(0,0,0,0.07);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
            --shadow-xl: 0 12px 36px rgba(0,0,0,0.15);
            
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            --radius-full: 999px;
            
            --transition-fast: 150ms ease;
            --transition-normal: 250ms ease;
            --transition-slow: 350ms ease;
            
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 12px;
            --spacing-lg: 16px;
            --spacing-xl: 24px;
            --spacing-xxl: 32px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            background-color: var(--white);
            color: var(--dark-gray);
            overflow-x: hidden;
            height: 100vh;
            font-size: 14px;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Enhanced Map Container */
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            background: var(--light-gray);
        }

        .map-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, rgba(255,255,255,0.1) 0%, transparent 100%);
            pointer-events: none;
            z-index: 2;
        }

        /* Floating UI Elements */
        .floating-ui {
            position: fixed;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            pointer-events: none;
        }

        .floating-ui > * {
            pointer-events: auto;
        }

        .top-left {
            top: var(--spacing-lg);
            left: var(--spacing-lg);
        }

        .top-center {
            top: var(--spacing-lg);
            left: 50%;
            transform: translateX(-50%);
        }

        .top-right {
            top: var(--spacing-lg);
            right: var(--spacing-lg);
        }

        /* Enhanced Balance Card */
        .balance-card {
            background: var(--white);
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            transition: all var(--transition-normal);
        }

        .balance-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl);
        }

        .balance-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 1.1rem;
        }

        .balance-info {
            display: flex;
            flex-direction: column;
        }

        .balance-label {
            font-size: 0.75rem;
            color: var(--text-gray);
            font-weight: 500;
            margin-bottom: 2px;
        }

        .balance-amount {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-orange);
            letter-spacing: -0.5px;
        }

        .balance-subtext {
            font-size: 0.7rem;
            color: var(--text-gray);
            opacity: 0.8;
        }

        /* Enhanced Status Indicators */
        .status-indicator {
            background: var(--white);
            padding: var(--spacing-md);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            min-width: 200px;
            transition: all var(--transition-normal);
        }

        .status-indicator:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl);
        }

        .status-pulse {
            width: 12px;
            height: 12px;
            border-radius: var(--radius-full);
            position: relative;
        }

        .status-pulse::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: var(--radius-full);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            100% {
                transform: scale(2.5);
                opacity: 0;
            }
        }

        .status-pulse.searching {
            background: var(--warning-yellow);
        }

        .status-pulse.searching::after {
            background: var(--warning-yellow);
        }

        .status-pulse.arriving {
            background: var(--info-blue);
        }

        .status-pulse.arriving::after {
            background: var(--info-blue);
        }

        .status-pulse.riding {
            background: var(--success-green);
        }

        .status-pulse.riding::after {
            background: var(--success-green);
        }

        .status-pulse.emergency {
            background: var(--error-red);
        }

        .status-pulse.emergency::after {
            background: var(--error-red);
        }

        .status-text {
            flex: 1;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--dark-gray);
        }

        /* Enhanced ETA Display */
        .eta-display {
            background: var(--white);
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
        }

        .eta-icon {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-full);
            background: var(--primary-orange-light);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 1rem;
        }

        .eta-info {
            display: flex;
            flex-direction: column;
        }

        .eta-label {
            font-size: 0.75rem;
            color: var(--text-gray);
            font-weight: 500;
        }

        .eta-time {
            font-size: 1rem;
            font-weight: 700;
            color: var(--primary-orange);
        }

        /* Enhanced SOS Button */
        .sos-button {
            position: fixed;
            top: var(--spacing-lg);
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 60px;
            border-radius: var(--radius-full);
            background: var(--error-red);
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 800;
            box-shadow: var(--shadow-xl);
            z-index: 150;
            cursor: pointer;
            animation: sosPulse 2s infinite;
            border: 3px solid var(--white);
            transition: all var(--transition-normal);
        }

        .sos-button:hover {
            transform: translateX(-50%) scale(1.1);
            box-shadow: 0 0 30px rgba(231, 76, 60, 0.6);
        }

        @keyframes sosPulse {
            0% {
                box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7);
            }
            70% {
                box-shadow: 0 0 0 15px rgba(231, 76, 60, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(231, 76, 60, 0);
            }
        }

        /* Enhanced Countdown Timer */
        .countdown-timer {
            position: fixed;
            top: 90px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-gradient);
            color: var(--white);
            padding: var(--spacing-md) var(--spacing-xl);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            z-index: 150;
            display: none;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .countdown-timer.active {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .countdown-text {
            font-size: 0.8rem;
            opacity: 0.9;
            margin-bottom: 4px;
        }

        .countdown-time {
            font-size: 1.3rem;
            font-weight: 800;
            letter-spacing: 1px;
            font-variant-numeric: tabular-nums;
        }

        /* Enhanced Main Panel */
        .main-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
            box-shadow: 0 -4px 32px rgba(0, 0, 0, 0.15);
            z-index: 200;
            transition: transform var(--transition-slow) cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .main-panel.collapsed {
            transform: translateY(calc(100% - 60px));
        }

        .panel-header {
            padding: var(--spacing-lg);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
            background: var(--white);
            border-bottom: 1px solid var(--border-color);
        }

        .panel-handle {
            width: 40px;
            height: 4px;
            background: var(--medium-gray);
            border-radius: var(--radius-full);
            margin: 0 auto;
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .panel-handle:hover {
            background: var(--primary-orange);
            transform: scaleX(1.2);
        }

        .panel-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--dark-gray);
            text-align: center;
        }

        .panel-subtitle {
            font-size: 0.85rem;
            color: var(--text-gray);
            text-align: center;
            opacity: 0.8;
        }

        /* Enhanced Navigation */
        .nav-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--spacing-xs);
            padding: 0 var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
        }

        .nav-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            background: var(--light-gray);
            cursor: pointer;
            transition: all var(--transition-normal);
            border: none;
            outline: none;
        }

        .nav-button:hover {
            background: var(--medium-gray);
            transform: translateY(-2px);
        }

        .nav-button.active {
            background: var(--primary-gradient);
            color: var(--white);
            box-shadow: var(--shadow-md);
        }

        .nav-button.active:hover {
            background: var(--secondary-gradient);
        }

        .nav-icon {
            font-size: 1.2rem;
            margin-bottom: 2px;
        }

        .nav-label {
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Enhanced Content Area */
        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-lg);
            padding-bottom: calc(var(--spacing-lg) + env(safe-area-inset-bottom));
        }

        .screen-content {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--white);
            z-index: 90;
            padding: var(--spacing-lg);
            overflow-y: auto;
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .screen-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Enhanced Forms */
        .location-input-group {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .location-input {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md) var(--spacing-lg);
            background: var(--white);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-lg);
            transition: all var(--transition-normal);
            position: relative;
        }

        .location-input:focus-within {
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }

        .location-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-orange);
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .location-input input {
            flex: 1;
            border: none;
            outline: none;
            background: transparent;
            font-size: 0.9rem;
            color: var(--dark-gray);
            min-width: 0;
        }

        .location-input input::placeholder {
            color: var(--text-gray);
            opacity: 0.7;
        }

        /* Enhanced Quick Locations */
        .quick-locations {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
            flex-wrap: wrap;
        }

        .quick-location-btn {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--light-gray);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-full);
            cursor: pointer;
            transition: all var(--transition-normal);
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--dark-gray);
        }

        .quick-location-btn:hover {
            background: var(--medium-gray);
            transform: translateY(-1px);
        }

        .quick-location-btn.active {
            background: var(--primary-orange);
            color: var(--white);
            border-color: var(--primary-orange);
        }

        /* Enhanced Ride Type Selection */
        .ride-type-selection {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
        }

        .ride-type-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-md);
            background: var(--white);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all var(--transition-normal);
            text-align: center;
        }

        .ride-type-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }

        .ride-type-card.selected {
            border-color: var(--primary-orange);
            background: linear-gradient(135deg, rgba(255, 107, 53, 0.05), rgba(255, 107, 53, 0.1));
            box-shadow: var(--shadow-md);
        }

        .ride-type-icon {
            width: 50px;
            height: 50px;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            margin-bottom: var(--spacing-xs);
            color: var(--white);
        }

        .ride-type-card.economy .ride-type-icon {
            background: var(--economy-green);
        }

        .ride-type-card.standard .ride-type-icon {
            background: var(--primary-orange);
        }

        .ride-type-card.premium .ride-type-icon {
            background: var(--premium-gold);
            color: var(--dark-gray);
        }

        .ride-type-name {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--dark-gray);
        }

        .ride-type-price {
            font-size: 0.9rem;
            font-weight: 800;
            color: var(--primary-orange);
            margin-top: 2px;
        }

        .ride-type-desc {
            font-size: 0.7rem;
            color: var(--text-gray);
            opacity: 0.8;
            margin-top: 2px;
        }

        /* Enhanced Fare Display */
        .fare-display-card {
            background: var(--primary-gradient);
            color: var(--white);
            padding: var(--spacing-lg);
            border-radius: var(--radius-lg);
            margin-bottom: var(--spacing-lg);
            box-shadow: var(--shadow-md);
            animation: fadeInUp 0.5s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fare-display-label {
            font-size: 0.85rem;
            opacity: 0.9;
            margin-bottom: var(--spacing-xs);
            text-align: center;
        }

        .fare-display-amount {
            font-size: 2rem;
            font-weight: 800;
            text-align: center;
            margin-bottom: var(--spacing-xs);
            letter-spacing: -1px;
        }

        .fare-display-details {
            display: flex;
            justify-content: center;
            gap: var(--spacing-xl);
            margin-top: var(--spacing-md);
            padding-top: var(--spacing-md);
            border-top: 1px solid rgba(255,255,255,0.2);
        }

        .fare-detail-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .fare-detail-label {
            font-size: 0.7rem;
            opacity: 0.8;
            margin-bottom: 2px;
        }

        .fare-detail-value {
            font-size: 0.9rem;
            font-weight: 600;
        }

        /* Enhanced Buttons */
        .primary-button {
            width: 100%;
            padding: var(--spacing-lg);
            background: var(--primary-gradient);
            color: var(--white);
            border: none;
            border-radius: var(--radius-lg);
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-normal);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            box-shadow: var(--shadow-md);
        }

        .primary-button:hover:not(:disabled) {
            background: var(--secondary-gradient);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .primary-button:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: var(--shadow-sm);
        }

        .primary-button:disabled {
            background: var(--medium-gray);
            color: var(--text-gray);
            cursor: not-allowed;
            box-shadow: none;
        }

        .secondary-button {
            width: 100%;
            padding: var(--spacing-md) var(--spacing-lg);
            background: var(--white);
            color: var(--primary-orange);
            border: 2px solid var(--primary-orange);
            border-radius: var(--radius-lg);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .secondary-button:hover {
            background: var(--primary-orange);
            color: var(--white);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .danger-button {
            background: linear-gradient(135deg, #E74C3C, #C0392B);
            color: var(--white);
            border: none;
        }

        .danger-button:hover {
            background: linear-gradient(135deg, #C0392B, #E74C3C);
        }

        /* Enhanced More Options */
        .more-options-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
        }

        .more-option-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-md);
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-normal);
            text-align: center;
        }

        .more-option-card:hover {
            border-color: var(--primary-orange);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .more-option-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-orange);
            font-size: 1.1rem;
            transition: all var(--transition-normal);
        }

        .more-option-card:hover .more-option-icon {
            background: var(--primary-orange);
            color: var(--white);
        }

        .more-option-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--dark-gray);
        }

        /* Enhanced Emergency Services */
        .emergency-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .emergency-service-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-lg);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all var(--transition-normal);
            text-align: center;
            border: 2px solid transparent;
        }

        .emergency-service-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }

        .emergency-service-card.police {
            background: linear-gradient(135deg, rgba(0, 71, 171, 0.1), rgba(0, 71, 171, 0.05));
            border-color: var(--police-blue);
        }

        .emergency-service-card.fire {
            background: linear-gradient(135deg, rgba(204, 0, 0, 0.1), rgba(204, 0, 0, 0.05));
            border-color: var(--fire-truck-red);
        }

        .emergency-service-card.hospital {
            background: linear-gradient(135deg, rgba(39, 174, 96, 0.1), rgba(39, 174, 96, 0.05));
            border-color: var(--hospital-green);
        }

        .emergency-service-card.ambulance {
            background: linear-gradient(135deg, rgba(0, 102, 204, 0.1), rgba(0, 102, 204, 0.05));
            border-color: var(--ambulance-blue);
        }

        .emergency-icon {
            width: 60px;
            height: 60px;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--white);
            margin-bottom: var(--spacing-sm);
        }

        .emergency-service-card.police .emergency-icon {
            background: var(--police-blue);
        }

        .emergency-service-card.fire .emergency-icon {
            background: var(--fire-truck-red);
        }

        .emergency-service-card.hospital .emergency-icon {
            background: var(--hospital-green);
        }

        .emergency-service-card.ambulance .emergency-icon {
            background: var(--ambulance-blue);
        }

        .emergency-label {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--dark-gray);
        }

        .emergency-description {
            font-size: 0.75rem;
            color: var(--text-gray);
            opacity: 0.8;
        }

        /* Enhanced History Items */
        .history-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .history-item {
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            cursor: pointer;
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .history-item:hover {
            border-color: var(--primary-orange);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .history-item.expanded {
            margin-bottom: var(--spacing-lg);
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-sm);
        }

        .history-route {
            flex: 1;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .history-location {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            font-size: 0.85rem;
            color: var(--dark-gray);
        }

        .history-location-icon {
            color: var(--primary-orange);
            font-size: 0.8rem;
        }

        .history-arrow {
            color: var(--text-gray);
            font-size: 0.8rem;
            margin: 0 var(--spacing-xs);
        }

        .history-type-badge {
            padding: 4px 8px;
            border-radius: var(--radius-full);
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .history-type-ride {
            background: rgba(255, 107, 53, 0.1);
            color: var(--primary-orange);
        }

        .history-type-delivery {
            background: rgba(52, 152, 219, 0.1);
            color: var(--info-blue);
        }

        .history-type-emergency {
            background: rgba(231, 76, 60, 0.1);
            color: var(--error-red);
        }

        .history-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: var(--spacing-sm);
        }

        .history-info {
            display: flex;
            gap: var(--spacing-lg);
        }

        .history-info-item {
            display: flex;
            flex-direction: column;
        }

        .history-info-label {
            font-size: 0.7rem;
            color: var(--text-gray);
            margin-bottom: 2px;
        }

        .history-info-value {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--dark-gray);
        }

        .history-fare {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-orange);
        }

        .history-expand-btn {
            width: 100%;
            text-align: center;
            padding: var(--spacing-sm);
            color: var(--primary-orange);
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            border-top: 1px solid var(--border-color);
            margin-top: var(--spacing-md);
            transition: all var(--transition-normal);
        }

        .history-expand-btn:hover {
            background: var(--light-gray);
        }

        .history-expanded-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease;
        }

        .history-item.expanded .history-expanded-content {
            max-height: 500px;
            margin-top: var(--spacing-md);
            padding-top: var(--spacing-md);
            border-top: 1px solid var(--border-color);
        }

        .expanded-details-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-md);
        }

        .expanded-detail-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .expanded-detail-label {
            font-size: 0.75rem;
            color: var(--text-gray);
            font-weight: 500;
        }

        .expanded-detail-value {
            font-size: 0.85rem;
            color: var(--dark-gray);
            font-weight: 600;
        }

        /* Enhanced Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-lg);
            animation: fadeIn 0.3s ease;
        }

        .modal-overlay.hidden {
            display: none;
        }

        .modal-container {
            background: var(--white);
            border-radius: var(--radius-xl);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: var(--shadow-xl);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--dark-gray);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-full);
            background: var(--light-gray);
            border: none;
            color: var(--text-gray);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all var(--transition-normal);
        }

        .modal-close:hover {
            background: var(--medium-gray);
            color: var(--dark-gray);
        }

        .modal-content {
            padding: var(--spacing-lg);
            max-height: calc(90vh - 120px);
            overflow-y: auto;
        }

        .modal-actions {
            padding: var(--spacing-lg);
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: var(--spacing-md);
        }

        .modal-actions .primary-button {
            flex: 1;
        }

        /* Enhanced Search Suggestions */
        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-xl);
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            animation: fadeIn 0.2s ease;
        }

        .search-suggestions.active {
            display: block;
        }

        .search-suggestion-item {
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: flex-start;
            gap: var(--spacing-md);
        }

        .search-suggestion-item:hover {
            background: var(--light-gray);
        }

        .search-suggestion-item:last-child {
            border-bottom: none;
        }

        .search-suggestion-icon {
            width: 24px;
            height: 24px;
            border-radius: var(--radius-full);
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-orange);
            font-size: 0.8rem;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .search-suggestion-content {
            flex: 1;
            min-width: 0;
        }

        .search-suggestion-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--dark-gray);
            margin-bottom: 2px;
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .search-suggestion-address {
            font-size: 0.8rem;
            color: var(--text-gray);
            margin-bottom: 4px;
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .search-suggestion-distance {
            font-size: 0.75rem;
            color: var(--primary-orange);
            font-weight: 500;
        }

        .search-suggestion-city {
            font-size: 0.7rem;
            color: var(--text-gray);
            background: var(--light-gray);
            padding: 2px 6px;
            border-radius: var(--radius-full);
            display: inline-block;
            margin-top: 2px;
        }

        /* Enhanced Loading States */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-lg);
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 3px solid var(--light-gray);
            border-top-color: var(--primary-orange);
            border-radius: var(--radius-full);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1rem;
            font-weight: 600;
            color: var(--dark-gray);
            text-align: center;
        }

        /* Enhanced Chat System */
        .chat-container {
            position: fixed;
            bottom: 80px;
            right: var(--spacing-lg);
            width: 350px;
            max-width: 90vw;
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            z-index: 300;
            display: none;
            flex-direction: column;
            overflow: hidden;
            animation: slideInUp 0.3s ease;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-container.active {
            display: flex;
        }

        .chat-header {
            background: var(--primary-gradient);
            color: var(--white);
            padding: var(--spacing-md) var(--spacing-lg);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-title {
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .chat-close {
            background: none;
            border: none;
            color: var(--white);
            cursor: pointer;
            font-size: 1.2rem;
            opacity: 0.8;
            transition: opacity var(--transition-fast);
        }

        .chat-close:hover {
            opacity: 1;
        }

        .chat-messages {
            flex: 1;
            padding: var(--spacing-lg);
            max-height: 300px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }

        .chat-message {
            max-width: 80%;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-lg);
            font-size: 0.85rem;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .chat-message.received {
            align-self: flex-start;
            background: var(--light-gray);
            color: var(--dark-gray);
            border-bottom-left-radius: 4px;
        }

        .chat-message.sent {
            align-self: flex-end;
            background: var(--primary-orange);
            color: var(--white);
            border-bottom-right-radius: 4px;
        }

        .chat-input-container {
            padding: var(--spacing-md);
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: var(--spacing-sm);
        }

        .chat-input {
            flex: 1;
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-full);
            font-size: 0.85rem;
            outline: none;
            transition: border-color var(--transition-fast);
        }

        .chat-input:focus {
            border-color: var(--primary-orange);
        }

        .chat-send-btn {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            background: var(--primary-orange);
            color: var(--white);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-normal);
        }

        .chat-send-btn:hover {
            background: var(--primary-orange-dark);
            transform: scale(1.05);
        }

        .chat-notification {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 20px;
            height: 20px;
            background: var(--error-red);
            color: var(--white);
            border-radius: var(--radius-full);
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Enhanced Receipt */
        .receipt-container {
            background: var(--white);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }

        .receipt-header {
            background: var(--primary-gradient);
            color: var(--white);
            padding: var(--spacing-lg);
            text-align: center;
        }

        .receipt-title {
            font-size: 1.3rem;
            font-weight: 800;
            margin-bottom: 4px;
        }

        .receipt-subtitle {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .receipt-content {
            padding: var(--spacing-lg);
        }

        .receipt-row {
            display: flex;
            justify-content: space-between;
            padding: var(--spacing-sm) 0;
            border-bottom: 1px solid var(--border-color);
        }

        .receipt-row:last-child {
            border-bottom: none;
        }

        .receipt-label {
            color: var(--text-gray);
            font-size: 0.85rem;
        }

        .receipt-value {
            font-weight: 600;
            color: var(--dark-gray);
            font-size: 0.85rem;
        }

        .receipt-total {
            background: var(--light-gray);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            margin-top: var(--spacing-lg);
        }

        .receipt-total .receipt-row {
            border-bottom: none;
        }

        .receipt-total .receipt-label {
            font-size: 0.9rem;
            font-weight: 700;
        }

        .receipt-total .receipt-value {
            font-size: 1.1rem;
            font-weight: 800;
            color: var(--primary-orange);
        }

        /* Enhanced Cancel Ride Modal */
        .cancel-reasons {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
        }

        .cancel-reason {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-md);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .cancel-reason:hover {
            border-color: var(--primary-orange);
            background: rgba(255, 107, 53, 0.05);
        }

        .cancel-reason.selected {
            border-color: var(--primary-orange);
            background: rgba(255, 107, 53, 0.1);
        }

        .cancel-reason-icon {
            width: 20px;
            height: 20px;
            border-radius: var(--radius-full);
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-normal);
        }

        .cancel-reason.selected .cancel-reason-icon {
            border-color: var(--primary-orange);
            background: var(--primary-orange);
        }

        .cancel-reason.selected .cancel-reason-icon::after {
            content: 'âœ“';
            color: var(--white);
            font-size: 0.7rem;
            font-weight: 700;
        }

        .cancel-reason-text {
            flex: 1;
            font-size: 0.85rem;
            color: var(--dark-gray);
        }

        .cancel-comment {
            width: 100%;
            padding: var(--spacing-md);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 0.85rem;
            resize: vertical;
            min-height: 80px;
            transition: border-color var(--transition-normal);
        }

        .cancel-comment:focus {
            outline: none;
            border-color: var(--primary-orange);
        }

        /* Enhanced Map Markers */
        .driver-marker {
            background: var(--primary-orange);
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.4);
            border: 3px solid white;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .emergency-marker {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            border: 3px solid white;
            animation: pulseEmergency 2s infinite;
        }

        @keyframes pulseEmergency {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .pickup-marker {
            background: var(--success-green);
            color: white;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            box-shadow: 0 2px 8px rgba(46, 204, 113, 0.4);
            border: 2px solid white;
        }

        .destination-marker {
            background: var(--primary-red);
            color: white;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            box-shadow: 0 2px 8px rgba(231, 76, 60, 0.4);
            border: 2px solid white;
        }

        /* Enhanced Responsive Design */
        @media (max-width: 768px) {
            .floating-ui {
                gap: var(--spacing-sm);
            }

            .top-left, .top-right {
                top: var(--spacing-md);
                left: var(--spacing-md);
                right: var(--spacing-md);
                max-width: none;
            }

            .top-right {
                top: 120px;
                left: var(--spacing-md);
                right: var(--spacing-md);
            }

            .balance-card, .status-indicator, .eta-display {
                width: 100%;
                max-width: none;
            }

            .ride-type-selection {
                grid-template-columns: 1fr;
                gap: var(--spacing-sm);
            }

            .emergency-grid {
                grid-template-columns: 1fr;
            }

            .more-options-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .chat-container {
                width: calc(100vw - 40px);
                right: 20px;
                bottom: 100px;
            }

            .expanded-details-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            :root {
                --spacing-lg: 12px;
                --spacing-xl: 16px;
            }

            .nav-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 2px;
                padding: 0 var(--spacing-md);
            }

            .nav-button {
                padding: var(--spacing-sm);
            }

            .nav-icon {
                font-size: 1rem;
            }

            .nav-label {
                font-size: 0.7rem;
            }

            .panel-content {
                padding: var(--spacing-md);
            }
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .visible {
            display: block !important;
        }

        .flex {
            display: flex;
        }

        .flex-col {
            display: flex;
            flex-direction: column;
        }

        .items-center {
            align-items: center;
        }

        .justify-center {
            justify-content: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .gap-sm {
            gap: var(--spacing-sm);
        }

        .gap-md {
            gap: var(--spacing-md);
        }

        .gap-lg {
            gap: var(--spacing-lg);
        }

        .w-full {
            width: 100%;
        }

        .h-full {
            height: 100%;
        }

        .text-center {
            text-align: center;
        }

        .text-left {
            text-align: left;
        }

        .text-right {
            text-align: right;
        }

        .font-bold {
            font-weight: 700;
        }

        .font-semibold {
            font-weight: 600;
        }

        .text-primary {
            color: var(--primary-orange);
        }

        .text-secondary {
            color: var(--text-gray);
        }

        .text-success {
            color: var(--success-green);
        }

        .text-error {
            color: var(--error-red);
        }

        .bg-light {
            background: var(--light-gray);
        }

        .bg-white {
            background: var(--white);
        }

        .rounded-sm {
            border-radius: var(--radius-sm);
        }

        .rounded-md {
            border-radius: var(--radius-md);
        }

        .rounded-lg {
            border-radius: var(--radius-lg);
        }

        .rounded-full {
            border-radius: var(--radius-full);
        }

        .shadow-sm {
            box-shadow: var(--shadow-sm);
        }

        .shadow-md {
            box-shadow: var(--shadow-md);
        }

        .shadow-lg {
            box-shadow: var(--shadow-lg);
        }

        .p-sm {
            padding: var(--spacing-sm);
        }

        .p-md {
            padding: var(--spacing-md);
        }

        .p-lg {
            padding: var(--spacing-lg);
        }

        .m-sm {
            margin: var(--spacing-sm);
        }

        .m-md {
            margin: var(--spacing-md);
        }

        .m-lg {
            margin: var(--spacing-lg);
        }

        .mt-sm {
            margin-top: var(--spacing-sm);
        }

        .mt-md {
            margin-top: var(--spacing-md);
        }

        .mt-lg {
            margin-top: var(--spacing-lg);
        }

        .mb-sm {
            margin-bottom: var(--spacing-sm);
        }

        .mb-md {
            margin-bottom: var(--spacing-md);
        }

        .mb-lg {
            margin-bottom: var(--spacing-lg);
        }

        .transition {
            transition: all var(--transition-normal);
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--light-gray);
            border-radius: var(--radius-full);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--medium-gray);
            border-radius: var(--radius-full);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-orange);
        }

        /* Selection Styling */
        ::selection {
            background: rgba(255, 107, 53, 0.3);
            color: var(--dark-gray);
        }

        /* Focus Styling */
        :focus-visible {
            outline: 2px solid var(--primary-orange);
            outline-offset: 2px;
        }

        /* Print Styling */
        @media print {
            .no-print {
                display: none !important;
            }
        }

        /* Dark mode prevention */
        @media (prefers-color-scheme: dark) {
            body {
                background: var(--white) !important;
                color: var(--dark-gray) !important;
            }
        }
    </style>
</head>
<body>
    <!-- Main Map Container -->
    <div id="map"></div>
    <div class="map-overlay"></div>

    <!-- Floating UI Elements -->
    <div class="floating-ui top-left">
        <div class="balance-card">
            <div class="balance-icon">
                <i class="fas fa-wallet"></i>
            </div>
            <div class="balance-info">
                <div class="balance-label">Available Balance</div>
                <div class="balance-amount" id="walletBalance">ZMW 0.00</div>
                <div class="balance-subtext">Jubel Wallet</div>
            </div>
        </div>

        <div class="status-indicator" id="rideStatus" style="display: none;">
            <div class="status-pulse" id="statusPulse"></div>
            <div class="status-text" id="statusText">Searching for driver</div>
        </div>
    </div>

    <div class="floating-ui top-right">
        <div class="eta-display" id="etaDisplay" style="display: none;">
            <div class="eta-icon">
                <i class="fas fa-clock"></i>
            </div>
            <div class="eta-info">
                <div class="eta-label">Estimated Arrival</div>
                <div class="eta-time" id="etaTime">5 min</div>
            </div>
        </div>
    </div>

    <!-- SOS Button -->
    <div class="sos-button" id="sosButton" style="display: none;">
        SOS
    </div>

    <!-- Countdown Timer -->
    <div class="countdown-timer" id="countdownTimer">
        <div class="countdown-text">Scheduled Ride In</div>
        <div class="countdown-time" id="countdownTime">00:00:00</div>
    </div>

    <!-- Chat Container -->
    <div class="chat-container" id="chatContainer">
        <div class="chat-header">
            <div class="chat-title">
                <i class="fas fa-comments"></i>
                <span>Chat with Driver</span>
                <div class="chat-notification" id="chatNotification" style="display: none;">3</div>
            </div>
            <button class="chat-close" id="chatClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <!-- Messages will be inserted here -->
        </div>
        <div class="chat-input-container">
            <input type="text" class="chat-input" id="chatInput" placeholder="Type your message...">
            <button class="chat-send-btn" id="chatSend">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <!-- Main Panel -->
    <div class="main-panel" id="mainPanel">
        <div class="panel-header">
            <div class="panel-handle" id="panelHandle"></div>
            <div class="panel-title">Jubel Ride</div>
            <div class="panel-subtitle">Safe, Fast, Reliable</div>
        </div>

        <div class="panel-content">
            <!-- Home Screen -->
            <div id="homeScreen" class="screen-content active">
                <div class="location-input-group">
                    <div class="location-input">
                        <div class="location-icon">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <input type="text" id="pickupLocation" placeholder="Current location" readonly>
                    </div>
                    <div class="location-input">
                        <div class="location-icon">
                            <i class="fas fa-flag"></i>
                        </div>
                        <input type="text" id="destinationLocation" placeholder="Where to?" autocomplete="off">
                        <div class="search-suggestions" id="destinationSuggestions"></div>
                    </div>
                </div>

                <div class="quick-locations">
                    <button class="quick-location-btn" data-location="home">
                        <i class="fas fa-home"></i>
                        Home
                    </button>
                    <button class="quick-location-btn" data-location="work">
                        <i class="fas fa-briefcase"></i>
                        Work
                    </button>
                    <button class="quick-location-btn" data-location="gym">
                        <i class="fas fa-dumbbell"></i>
                        Gym
                    </button>
                    <button class="quick-location-btn" data-location="mall">
                        <i class="fas fa-shopping-cart"></i>
                        Mall
                    </button>
                </div>

                <div class="ride-type-selection" id="rideTypeSelection">
                    <div class="ride-type-card economy" data-type="economy">
                        <div class="ride-type-icon">
                            <i class="fas fa-car-side"></i>
                        </div>
                        <div class="ride-type-name">Economy</div>
                        <div class="ride-type-price" id="economyPrice">ZMW 0.00</div>
                        <div class="ride-type-desc">Affordable & Comfortable</div>
                    </div>
                    <div class="ride-type-card standard selected" data-type="standard">
                        <div class="ride-type-icon">
                            <i class="fas fa-car"></i>
                        </div>
                        <div class="ride-type-name">Standard</div>
                        <div class="ride-type-price" id="standardPrice">ZMW 0.00</div>
                        <div class="ride-type-desc">Recommended</div>
                    </div>
                    <div class="ride-type-card premium" data-type="premium">
                        <div class="ride-type-icon">
                            <i class="fas fa-crown"></i>
                        </div>
                        <div class="ride-type-name">Premium</div>
                        <div class="ride-type-price" id="premiumPrice">ZMW 0.00</div>
                        <div class="ride-type-desc">Luxury Experience</div>
                    </div>
                </div>

                <div class="fare-display-card" id="fareDisplay" style="display: none;">
                    <div class="fare-display-label">Estimated Fare</div>
                    <div class="fare-display-amount" id="estimatedFare">ZMW 0.00</div>
                    <div class="fare-display-details">
                        <div class="fare-detail-item">
                            <div class="fare-detail-label">Distance</div>
                            <div class="fare-detail-value" id="estimatedDistance">0 km</div>
                        </div>
                        <div class="fare-detail-item">
                            <div class="fare-detail-label">Time</div>
                            <div class="fare-detail-value" id="estimatedTime">0 min</div>
                        </div>
                        <div class="fare-detail-item">
                            <div class="fare-detail-label">Ride</div>
                            <div class="fare-detail-value" id="selectedRideType">Standard</div>
                        </div>
                    </div>
                </div>

                <button class="primary-button" id="requestRideBtn" style="display: none;">
                    <i class="fas fa-car"></i>
                    Request Ride
                </button>

                <div class="more-options-grid">
                    <div class="more-option-card" data-option="express-delivery">
                        <div class="more-option-icon">
                            <i class="fas fa-shipping-fast"></i>
                        </div>
                        <div class="more-option-label">Express Delivery</div>
                    </div>
                    <div class="more-option-card" data-option="schedule-ride">
                        <div class="more-option-icon">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <div class="more-option-label">Schedule Ride</div>
                    </div>
                    <div class="more-option-card" data-option="emergency">
                        <div class="more-option-icon">
                            <i class="fas fa-ambulance"></i>
                        </div>
                        <div class="more-option-label">Emergency</div>
                    </div>
                    <div class="more-option-card" data-option="order-for-someone">
                        <div class="more-option-icon">
                            <i class="fas fa-user-friends"></i>
                        </div>
                        <div class="more-option-label">Order for Someone</div>
                    </div>
                    <div class="more-option-card" data-option="light-truck">
                        <div class="more-option-icon">
                            <i class="fas fa-truck-pickup"></i>
                        </div>
                        <div class="more-option-label">Light Truck</div>
                    </div>
                    <div class="more-option-card" data-option="sos-setup">
                        <div class="more-option-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="more-option-label">SOS Setup</div>
                    </div>
                </div>

                <!-- Active Ride Info -->
                <div id="activeRideInfo" style="display: none;">
                    <div class="fare-display-card">
                        <div class="fare-display-label">Active Ride</div>
                        <div class="fare-display-amount" id="activeRideFare">ZMW 0.00</div>
                        <div class="fare-display-details">
                            <div class="fare-detail-item">
                                <div class="fare-detail-label">Driver</div>
                                <div class="fare-detail-value" id="activeDriverName">-</div>
                            </div>
                            <div class="fare-detail-item">
                                <div class="fare-detail-label">ETA</div>
                                <div class="fare-detail-value" id="activeRideETA">-</div>
                            </div>
                            <div class="fare-detail-item">
                                <div class="fare-detail-label">Status</div>
                                <div class="fare-detail-value" id="activeRideStatus">-</div>
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-md mt-lg">
                        <button class="secondary-button" id="contactDriverBtn">
                            <i class="fas fa-phone"></i>
                            Contact Driver
                        </button>
                        <button class="secondary-button danger-button" id="cancelRideBtn">
                            <i class="fas fa-times"></i>
                            Cancel Ride
                        </button>
                    </div>
                </div>
            </div>

            <!-- History Screen -->
            <div id="historyScreen" class="screen-content">
                <div class="flex justify-between items-center mb-lg">
                    <h2 class="text-lg font-bold">Ride History</h2>
                    <select id="historyFilter" class="bg-light rounded-lg p-sm text-sm">
                        <option value="all">All Rides</option>
                        <option value="ride">Rides Only</option>
                        <option value="delivery">Deliveries</option>
                        <option value="emergency">Emergency</option>
                        <option value="completed">Completed</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>

                <div class="history-list" id="historyList">
                    <!-- History items will be loaded here -->
                </div>
            </div>

            <!-- Account Screen -->
            <div id="accountScreen" class="screen-content">
                <div class="flex flex-col items-center mb-lg">
                    <div class="balance-icon" style="width: 80px; height: 80px; font-size: 1.5rem; margin-bottom: var(--spacing-md);">
                        <i class="fas fa-user"></i>
                    </div>
                    <h2 class="text-lg font-bold" id="accountName">Passenger</h2>
                    <p class="text-secondary text-sm" id="accountEmail">user@email.com</p>
                </div>

                <div class="grid grid-cols-3 gap-sm mb-lg">
                    <div class="bg-light rounded-lg p-md text-center">
                        <div class="text-primary font-bold text-lg" id="ridesCompleted">0</div>
                        <div class="text-secondary text-xs">Completed</div>
                    </div>
                    <div class="bg-light rounded-lg p-md text-center">
                        <div class="text-primary font-bold text-lg" id="ridesCancelled">0</div>
                        <div class="text-secondary text-xs">Cancelled</div>
                    </div>
                    <div class="bg-light rounded-lg p-md text-center">
                        <div class="text-primary font-bold text-lg" id="ridesPending">0</div>
                        <div class="text-secondary text-xs">Pending</div>
                    </div>
                </div>

                <div class="bg-light rounded-lg p-lg mb-lg">
                    <h3 class="font-bold mb-sm">Refer & Earn</h3>
                    <p class="text-secondary text-sm mb-sm">Share your code and earn ZMW 25 when friends complete their first ride</p>
                    <div class="bg-white rounded-lg p-md text-center mb-sm">
                        <div class="text-primary font-bold text-lg" id="referralCode">JUBEL-XXXX</div>
                        <div class="text-secondary text-xs">50% discount for new users</div>
                    </div>
                    <button class="secondary-button w-full" id="shareReferralBtn">
                        <i class="fas fa-share"></i>
                        Share Referral Code
                    </button>
                </div>

                <div class="flex gap-sm">
                    <button class="secondary-button flex-1" id="depositBtn">
                        <i class="fas fa-plus"></i>
                        Deposit
                    </button>
                    <button class="secondary-button flex-1" id="withdrawBtn">
                        <i class="fas fa-minus"></i>
                        Withdraw
                    </button>
                </div>
            </div>

            <!-- Emergency Screen -->
            <div id="emergencyScreen" class="screen-content">
                <h2 class="text-lg font-bold mb-lg">Emergency Services</h2>
                <p class="text-secondary text-sm mb-lg">For immediate assistance in critical situations</p>

                <div class="emergency-grid">
                    <div class="emergency-service-card police" data-type="police">
                        <div class="emergency-icon">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <div class="emergency-label">Police Ride</div>
                        <div class="emergency-description">Emergency police response</div>
                    </div>

                    <div class="emergency-service-card fire" data-type="fire">
                        <div class="emergency-icon">
                            <i class="fas fa-fire-extinguisher"></i>
                        </div>
                        <div class="emergency-label">Fire Brigade</div>
                        <div class="emergency-description">Fire emergency response</div>
                    </div>

                    <div class="emergency-service-card hospital" data-type="hospital">
                        <div class="emergency-icon">
                            <i class="fas fa-hospital"></i>
                        </div>
                        <div class="emergency-label">Hospital Ride</div>
                        <div class="emergency-description">Medical emergency transport</div>
                    </div>

                    <div class="emergency-service-card ambulance" data-type="ambulance">
                        <div class="emergency-icon">
                            <i class="fas fa-ambulance"></i>
                        </div>
                        <div class="emergency-label">Ambulance</div>
                        <div class="emergency-description">Medical emergency with personnel</div>
                    </div>
                </div>

                <div class="bg-light rounded-lg p-lg mt-lg">
                    <h3 class="font-bold mb-sm">Emergency Instructions</h3>
                    <p class="text-secondary text-sm">
                        <i class="fas fa-info-circle text-primary"></i>
                        Only use emergency services for genuine emergencies. Misuse may result in penalties. In case of immediate danger, call 911 first.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <div class="nav-grid">
        <button class="nav-button active" data-screen="home">
            <div class="nav-icon">
                <i class="fas fa-home"></i>
            </div>
            <div class="nav-label">Home</div>
        </button>
        <button class="nav-button" data-screen="history">
            <div class="nav-icon">
                <i class="fas fa-history"></i>
            </div>
            <div class="nav-label">History</div>
        </button>
        <button class="nav-button" data-screen="account">
            <div class="nav-icon">
                <i class="fas fa-user"></i>
            </div>
            <div class="nav-label">Account</div>
        </button>
        <button class="nav-button" data-screen="emergency">
            <div class="nav-icon">
                <i class="fas fa-ambulance"></i>
            </div>
            <div class="nav-label">Emergency</div>
        </button>
    </div>

    <!-- Modals -->
    <div id="paymentModal" class="modal-overlay hidden">
        <div class="modal-container">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-credit-card"></i>
                    Select Payment Method
                </div>
                <button class="modal-close" id="closePaymentModal">&times;</button>
            </div>
            <div class="modal-content">
                <div class="flex flex-col gap-md">
                    <div class="payment-option selected" data-type="wallet">
                        <div class="flex items-center gap-md p-md rounded-lg border-2 border-primary bg-light">
                            <div class="w-12 h-12 rounded-full bg-primary flex items-center justify-center text-white">
                                <i class="fas fa-wallet"></i>
                            </div>
                            <div class="flex-1">
                                <div class="font-bold">Jubel Wallet</div>
                                <div class="text-sm text-secondary">Pay with your Jubel wallet balance</div>
                                <div class="text-sm font-semibold text-primary" id="paymentWalletBalance">Balance: ZMW 0.00</div>
                            </div>
                            <div class="w-6 h-6 rounded-full border-2 border-primary flex items-center justify-center">
                                <div class="w-3 h-3 rounded-full bg-primary"></div>
                            </div>
                        </div>
                    </div>

                    <div class="payment-option" data-type="airtel">
                        <div class="flex items-center gap-md p-md rounded-lg border-2 border-gray-300 hover:border-primary transition">
                            <div class="w-12 h-12 rounded-full bg-red-600 flex items-center justify-center text-white">
                                <i class="fas fa-mobile-alt"></i>
                            </div>
                            <div class="flex-1">
                                <div class="font-bold">Airtel Money</div>
                                <div class="text-sm text-secondary">Pay with Airtel Money</div>
                            </div>
                            <div class="w-6 h-6 rounded-full border-2 border-gray-300"></div>
                        </div>
                    </div>

                    <div class="payment-option" data-type="mtn">
                        <div class="flex items-center gap-md p-md rounded-lg border-2 border-gray-300 hover:border-primary transition">
                            <div class="w-12 h-12 rounded-full bg-yellow-600 flex items-center justify-center text-white">
                                <i class="fas fa-mobile-alt"></i>
                            </div>
                            <div class="flex-1">
                                <div class="font-bold">MTN Money</div>
                                <div class="text-sm text-secondary">Pay with MTN Money</div>
                            </div>
                            <div class="w-6 h-6 rounded-full border-2 border-gray-300"></div>
                        </div>
                    </div>

                    <div class="payment-option" data-type="cash">
                        <div class="flex items-center gap-md p-md rounded-lg border-2 border-gray-300 hover:border-primary transition">
                            <div class="w-12 h-12 rounded-full bg-green-600 flex items-center justify-center text-white">
                                <i class="fas fa-money-bill"></i>
                            </div>
                            <div class="flex-1">
                                <div class="font-bold">Cash</div>
                                <div class="text-sm text-secondary">Pay with cash when you arrive</div>
                            </div>
                            <div class="w-6 h-6 rounded-full border-2 border-gray-300"></div>
                        </div>
                    </div>
                </div>

                <div class="mt-lg p-md bg-red-50 rounded-lg hidden" id="insufficientBalance">
                    <div class="flex items-center gap-sm">
                        <i class="fas fa-exclamation-circle text-red-600"></i>
                        <div class="text-sm text-red-600">
                            Insufficient balance in your Jubel wallet. Please choose another payment method.
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="secondary-button" id="cancelPaymentBtn">Cancel</button>
                <button class="primary-button" id="confirmPaymentBtn">Confirm & Request Ride</button>
            </div>
        </div>
    </div>

    <div id="cancelRideModal" class="modal-overlay hidden">
        <div class="modal-container">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-times-circle text-red-600"></i>
                    Cancel Ride
                </div>
                <button class="modal-close" id="closeCancelModal">&times;</button>
            </div>
            <div class="modal-content">
                <p class="mb-lg text-secondary">Please tell us why you want to cancel this ride. This helps us improve our service.</p>

                <div class="cancel-reasons">
                    <div class="cancel-reason" data-reason="waiting-too-long">
                        <div class="cancel-reason-icon"></div>
                        <div class="cancel-reason-text">Waiting too long for driver</div>
                    </div>
                    <div class="cancel-reason" data-reason="change-of-plans">
                        <div class="cancel-reason-icon"></div>
                        <div class="cancel-reason-text">Change of plans</div>
                    </div>
                    <div class="cancel-reason" data-reason="found-alternative">
                        <div class="cancel-reason-icon"></div>
                        <div class="cancel-reason-text">Found alternative transportation</div>
                    </div>
                    <div class="cancel-reason" data-reason="driver-not-moving">
                        <div class="cancel-reason-icon"></div>
                        <div class="cancel-reason-text">Driver is not moving towards me</div>
                    </div>
                    <div class="cancel-reason" data-reason="wrong-pickup">
                        <div class="cancel-reason-icon"></div>
                        <div class="cancel-reason-text">Wrong pickup location entered</div>
                    </div>
                    <div class="cancel-reason" data-reason="other">
                        <div class="cancel-reason-icon"></div>
                        <div class="cancel-reason-text">Other reason</div>
                    </div>
                </div>

                <textarea 
                    class="cancel-comment mt-lg" 
                    id="cancelComment" 
                    placeholder="Please provide additional details (optional)"
                    style="display: none;"></textarea>
            </div>
            <div class="modal-actions">
                <button class="secondary-button" id="backCancelBtn">Back</button>
                <button class="primary-button danger-button" id="confirmCancelBtn">Cancel Ride</button>
            </div>
        </div>
    </div>

    <div id="receiptModal" class="modal-overlay hidden">
        <div class="modal-container">
            <div class="receipt-container">
                <div class="receipt-header">
                    <div class="receipt-title">JUBEL RIDE RECEIPT</div>
                    <div class="receipt-subtitle" id="receiptDate">Date</div>
                </div>
                <div class="receipt-content">
                    <div class="receipt-row">
                        <div class="receipt-label">Receipt No:</div>
                        <div class="receipt-value" id="receiptNumber">-</div>
                    </div>
                    <div class="receipt-row">
                        <div class="receipt-label">Passenger:</div>
                        <div class="receipt-value" id="receiptPassenger">-</div>
                    </div>
                    <div class="receipt-row">
                        <div class="receipt-label">Driver:</div>
                        <div class="receipt-value" id="receiptDriver">-</div>
                    </div>
                    <div class="receipt-row">
                        <div class="receipt-label">Vehicle:</div>
                        <div class="receipt-value" id="receiptVehicle">-</div>
                    </div>
                    <div class="receipt-row">
                        <div class="receipt-label">Pickup:</div>
                        <div class="receipt-value" id="receiptPickup">-</div>
                    </div>
                    <div class="receipt-row">
                        <div class="receipt-label">Destination:</div>
                        <div class="receipt-value" id="receiptDestination">-</div>
                    </div>
                    <div class="receipt-row">
                        <div class="receipt-label">Distance:</div>
                        <div class="receipt-value" id="receiptDistance">-</div>
                    </div>
                    <div class="receipt-row">
                        <div class="receipt-label">Ride Type:</div>
                        <div class="receipt-value" id="receiptRideType">-</div>
                    </div>
                    <div class="receipt-row">
                        <div class="receipt-label">Ride Time:</div>
                        <div class="receipt-value" id="receiptRideTime">-</div>
                    </div>
                    <div class="receipt-row">
                        <div class="receipt-label">Payment Method:</div>
                        <div class="receipt-value" id="receiptPaymentMethod">-</div>
                    </div>
                    
                    <div class="receipt-total">
                        <div class="receipt-row">
                            <div class="receipt-label">Base Fare:</div>
                            <div class="receipt-value" id="receiptBaseFare">-</div>
                        </div>
                        <div class="receipt-row">
                            <div class="receipt-label">Distance Fare:</div>
                            <div class="receipt-value" id="receiptDistanceFare">-</div>
                        </div>
                        <div class="receipt-row">
                            <div class="receipt-label">Service Fee:</div>
                            <div class="receipt-value" id="receiptServiceFee">-</div>
                        </div>
                        <div class="receipt-row">
                            <div class="receipt-label">Discount:</div>
                            <div class="receipt-value" id="receiptDiscount">-</div>
                        </div>
                        <div class="receipt-row">
                            <div class="receipt-label">TOTAL:</div>
                            <div class="receipt-value" id="receiptTotal">-</div>
                        </div>
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="secondary-button" id="closeReceiptBtn">Close</button>
                    <button class="primary-button" id="downloadReceiptBtn">
                        <i class="fas fa-download"></i>
                        Download Receipt
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Loading...</div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script>
        // Advanced App Configuration
        class AdvancedJubelApp {
            constructor() {
                this.config = {
                    firebase: {
                        apiKey: "AIzaSyDEACX_P4c5q7djJAcA0I7Lk7leO2TlQ74",
                        authDomain: "jubel-13e1a.firebaseapp.com",
                        databaseURL: "https://jubel-13e1a-default-rtdb.firebaseio.com",
                        projectId: "jubel-13e1a",
                        storageBucket: "jubel-13e1a.firebasestorage.app",
                        messagingSenderId: "882241095445",
                        appId: "1:882241095445:web:ee9ca40fddd008ca910b1c",
                        measurementId: "G-J5JPKL6B5F"
                    },
                    pricing: {
                        baseFare: 23, // ZMW 23 base fare
                        perKm: 1.2, // ZMW 1.2 per km after base
                        perMinute: 0.5, // ZMW 0.5 per minute
                        rideTypeMultipliers: {
                            economy: 0.7, // 30% cheaper
                            standard: 1.0, // Base price
                            premium: 1.5 // 50% more expensive
                        },
                        emergencyServices: {
                            police: 200,
                            fire: 300,
                            hospital: 250,
                            ambulance: 500
                        }
                    },
                    search: {
                        debounceTime: 200,
                        maxResults: 8,
                        cityPriorityBoost: 2.0
                    },
                    cities: [
                        'Lusaka', 'Kitwe', 'Ndola', 'Kabwe', 'Chipata', 'Chingola',
                        'Mufulira', 'Luanshya', 'Livingstone', 'Kasama', 'Solwezi',
                        'Kapiri Mposhi', 'Chililabombwe', 'Mazabuka', 'Monze', 'Choma'
                    ],
                    emergencyServices: {
                        lusaka: {
                            police: [
                                { name: "Lusaka Central Police", lat: -15.4167, lng: 28.2833 },
                                { name: "Woodlands Police Station", lat: -15.3964, lng: 28.3100 },
                                { name: "Kabulonga Police", lat: -15.4050, lng: 28.2950 }
                            ],
                            fire: [
                                { name: "Lusaka Fire Station", lat: -15.4180, lng: 28.2850 },
                                { name: "Industrial Fire Station", lat: -15.4300, lng: 28.2700 }
                            ],
                            hospital: [
                                { name: "UTH Main Hospital", lat: -15.4050, lng: 28.3200 },
                                { name: "Levy Mwanawasa Hospital", lat: -15.4350, lng: 28.3500 }
                            ]
                        }
                    }
                };

                this.state = {
                    currentUser: null,
                    userData: null,
                    userLocation: null,
                    currentCity: null,
                    activeRide: null,
                    walletBalance: 0,
                    selectedRideType: 'standard',
                    selectedPaymentType: 'wallet',
                    selectedDestination: null,
                    currentScreen: 'home',
                    scheduledRides: [],
                    sosConfig: null,
                    emergencyMode: false,
                    chatMessages: [],
                    unreadMessages: 0,
                    searchCache: new Map(),
                    locationCache: new Map()
                };

                this.components = {
                    map: null,
                    markers: {
                        user: null,
                        pickup: null,
                        destination: null,
                        driver: null,
                        emergency: null
                    },
                    route: null,
                    listeners: {},
                    timers: {},
                    searchController: null
                };

                this.init();
            }

            async init() {
                try {
                    // Initialize Firebase
                    firebase.initializeApp(this.config.firebase);
                    
                    // Check authentication
                    await this.checkAuth();
                    
                    // Initialize UI
                    this.initUI();
                    
                    // Initialize Map
                    this.initMap();
                    
                    // Load user data
                    await this.loadUserData();
                    
                    // Setup event listeners
                    this.setupEventListeners();
                    
                    // Check for active ride
                    await this.checkActiveRide();
                    
                    // Start location tracking
                    this.startLocationTracking();
                    
                    // Load scheduled rides
                    await this.loadScheduledRides();
                    
                    // Initialize real-time listeners
                    this.initRealTimeListeners();
                    
                    console.log('Advanced Jubel App initialized successfully');
                } catch (error) {
                    console.error('Initialization error:', error);
                    this.showNotification('Failed to initialize app. Please refresh.', 'error');
                }
            }

            async checkAuth() {
                const urlParams = new URLSearchParams(window.location.search);
                const email = urlParams.get('email');
                const uid = urlParams.get('uid');

                if (email && uid) {
                    this.state.currentUser = { uid, email };
                    return;
                }

                return new Promise((resolve) => {
                    firebase.auth().onAuthStateChanged((user) => {
                        if (user) {
                            this.state.currentUser = user;
                            resolve();
                        } else {
                            window.location.href = 'signup.html';
                        }
                    });
                });
            }

            async loadUserData() {
                if (!this.state.currentUser) return;

                try {
                    const snapshot = await firebase.database().ref(`users/${this.state.currentUser.uid}`).once('value');
                    this.state.userData = snapshot.val();
                    
                    if (this.state.userData) {
                        this.state.walletBalance = this.state.userData.walletBalance || 0;
                        this.updateWalletUI();
                        this.updateUserProfileUI();
                        
                        // Load SOS config
                        await this.loadSOSConfig();
                    }
                } catch (error) {
                    console.error('Error loading user data:', error);
                }
            }

            async loadSOSConfig() {
                try {
                    const snapshot = await firebase.database().ref(`sosConfig/${this.state.currentUser.uid}`).once('value');
                    this.state.sosConfig = snapshot.val();
                } catch (error) {
                    console.error('Error loading SOS config:', error);
                }
            }

            async checkActiveRide() {
                if (!this.state.currentUser) return;

                try {
                    const snapshot = await firebase.database()
                        .ref('rides')
                        .orderByChild('passengerId')
                        .equalTo(this.state.currentUser.uid)
                        .once('value');

                    const rides = snapshot.val();
                    if (rides) {
                        for (const rideId in rides) {
                            const ride = rides[rideId];
                            if (!['completed', 'cancelled'].includes(ride.status)) {
                                this.state.activeRide = { id: rideId, ...ride };
                                this.updateUIForActiveRide();
                                this.listenForRideUpdates(rideId);
                                break;
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error checking active ride:', error);
                }
            }

            async loadScheduledRides() {
                if (!this.state.currentUser) return;

                try {
                    const snapshot = await firebase.database()
                        .ref('scheduledRides')
                        .orderByChild('passengerId')
                        .equalTo(this.state.currentUser.uid)
                        .once('value');

                    const rides = snapshot.val();
                    if (rides) {
                        this.state.scheduledRides = Object.values(rides).filter(ride => 
                            ride.status === 'scheduled' || ride.status === 'processing'
                        );
                        this.checkScheduledRides();
                    }
                } catch (error) {
                    console.error('Error loading scheduled rides:', error);
                }
            }

            checkScheduledRides() {
                const now = Date.now();
                this.state.scheduledRides.forEach(ride => {
                    if (ride.scheduledTime <= now && ride.status === 'scheduled') {
                        this.processScheduledRide(ride);
                    }
                });
            }

            async processScheduledRide(ride) {
                try {
                    // Update ride status
                    await firebase.database().ref(`scheduledRides/${ride.id}`).update({
                        status: 'processing'
                    });

                    // Request the ride
                    this.requestScheduledRide(ride);
                } catch (error) {
                    console.error('Error processing scheduled ride:', error);
                }
            }

            requestScheduledRide(ride) {
                this.showNotification(`Scheduled ride to ${ride.destination} is now being requested`, 'info');
                
                // Prepare ride request
                const rideRequest = {
                    ...ride,
                    status: 'requested',
                    timestamp: Date.now(),
                    updatedAt: Date.now()
                };

                // Show payment selection if needed
                this.showPaymentModal(ride.fare);
            }

            initMap() {
                this.components.map = L.map('map').setView([-15.4167, 28.2833], 13);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap contributors'
                }).addTo(this.components.map);
                
                // Add user location marker
                this.updateUserLocationMarker();
            }

            updateUserLocationMarker() {
                if (!this.components.map) return;

                if (this.components.markers.user) {
                    this.components.map.removeLayer(this.components.markers.user);
                }

                if (this.state.userLocation) {
                    this.components.markers.user = L.marker([this.state.userLocation.lat, this.state.userLocation.lng], {
                        icon: L.divIcon({
                            className: 'user-marker',
                            html: '<div class="pickup-marker"><i class="fas fa-user"></i></div>',
                            iconSize: [28, 28]
                        })
                    }).addTo(this.components.map)
                      .bindPopup('Your Location');
                }
            }

            async updateUserLocation(lat, lng) {
                this.state.userLocation = { lat, lng };
                this.updateUserLocationMarker();
                
                // Detect city
                await this.detectCity(lat, lng);
                
                // Update pickup location display
                this.updatePickupDisplay(lat, lng);
                
                // Update fare estimate if destination is set
                if (this.state.selectedDestination) {
                    this.calculateFare();
                }
                
                // Update user location in database
                if (this.state.currentUser) {
                    firebase.database().ref(`passengerLocations/${this.state.currentUser.uid}`).set({
                        latitude: lat,
                        longitude: lng,
                        timestamp: Date.now()
                    });
                }
            }

            async detectCity(lat, lng) {
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18`);
                    const data = await response.json();
                    
                    if (data && data.address) {
                        const city = this.extractCityFromAddress(data.address);
                        if (city && city !== this.state.currentCity) {
                            this.state.currentCity = city;
                            console.log('Detected city:', city);
                        }
                    }
                } catch (error) {
                    console.error('Error detecting city:', error);
                }
            }

            extractCityFromAddress(address) {
                const cityFields = ['city', 'town', 'village', 'municipality'];
                for (const field of cityFields) {
                    if (address[field]) {
                        return address[field];
                    }
                }
                return null;
            }

            updatePickupDisplay(lat, lng) {
                this.getAddressDisplay(lat, lng).then(address => {
                    document.getElementById('pickupLocation').value = address;
                });
            }

            async getAddressDisplay(lat, lng) {
                const cacheKey = `${lat},${lng}`;
                if (this.state.locationCache.has(cacheKey)) {
                    return this.state.locationCache.get(cacheKey);
                }

                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18`);
                    const data = await response.json();
                    
                    if (data && data.address) {
                        const address = this.formatAddressForDisplay(data.address);
                        this.state.locationCache.set(cacheKey, address);
                        return address;
                    }
                } catch (error) {
                    console.error('Error getting address:', error);
                }

                return `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            }

            formatAddressForDisplay(address) {
                const parts = [];
                
                if (address.house_number) parts.push(address.house_number);
                if (address.road) parts.push(address.road);
                if (address.suburb) parts.push(address.suburb);
                
                return parts.join(', ') || 'Current Location';
            }

            startLocationTracking() {
                if (!navigator.geolocation) {
                    this.showNotification('Geolocation is not supported by your browser', 'error');
                    return;
                }

                navigator.geolocation.watchPosition(
                    (position) => {
                        this.updateUserLocation(
                            position.coords.latitude,
                            position.coords.longitude
                        );
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                        this.showNotification('Unable to get your location. Please enable location services.', 'error');
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 30000
                    }
                );
            }

            initUI() {
                // Update wallet display
                this.updateWalletUI();
                
                // Setup ride type selection
                this.setupRideTypeSelection();
                
                // Setup navigation
                this.setupNavigation();
                
                // Initialize price displays
                this.updatePriceDisplays();
            }

            updateWalletUI() {
                const balanceElement = document.getElementById('walletBalance');
                const paymentBalanceElement = document.getElementById('paymentWalletBalance');
                
                if (balanceElement) {
                    balanceElement.textContent = `ZMW ${this.state.walletBalance.toFixed(2)}`;
                }
                
                if (paymentBalanceElement) {
                    paymentBalanceElement.textContent = `Balance: ZMW ${this.state.walletBalance.toFixed(2)}`;
                }
            }

            updateUserProfileUI() {
                if (!this.state.userData) return;

                const nameElement = document.getElementById('accountName');
                const emailElement = document.getElementById('accountEmail');
                const referralElement = document.getElementById('referralCode');

                if (nameElement) nameElement.textContent = this.state.userData.name || 'Passenger';
                if (emailElement) emailElement.textContent = this.state.userData.email || 'user@email.com';
                if (referralElement) referralElement.textContent = this.state.userData.referralCode || 'JUBEL-XXXX';
            }

            setupRideTypeSelection() {
                const cards = document.querySelectorAll('.ride-type-card');
                cards.forEach(card => {
                    card.addEventListener('click', () => {
                        cards.forEach(c => c.classList.remove('selected'));
                        card.classList.add('selected');
                        this.state.selectedRideType = card.dataset.type;
                        this.calculateFare();
                    });
                });
            }

            setupNavigation() {
                const navButtons = document.querySelectorAll('.nav-button');
                navButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const screen = button.dataset.screen;
                        this.switchScreen(screen);
                    });
                });
            }

            switchScreen(screen) {
                this.state.currentScreen = screen;
                
                // Update active nav button
                document.querySelectorAll('.nav-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`.nav-button[data-screen="${screen}"]`).classList.add('active');
                
                // Show selected screen
                document.querySelectorAll('.screen-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`${screen}Screen`).classList.add('active');
                
                // Load data for screen
                switch(screen) {
                    case 'history':
                        this.loadRideHistory();
                        break;
                    case 'account':
                        this.updateUserStats();
                        break;
                }
            }

            async loadRideHistory() {
                if (!this.state.currentUser) return;

                try {
                    const snapshot = await firebase.database()
                        .ref('rides')
                        .orderByChild('passengerId')
                        .equalTo(this.state.currentUser.uid)
                        .once('value');

                    const rides = snapshot.val();
                    const historyList = document.getElementById('historyList');
                    
                    if (!rides) {
                        historyList.innerHTML = '<p class="text-center text-secondary p-lg">No ride history found</p>';
                        return;
                    }

                    const ridesArray = Object.keys(rides).map(id => ({ id, ...rides[id] }));
                    ridesArray.sort((a, b) => b.timestamp - a.timestamp);

                    historyList.innerHTML = ridesArray.map(ride => this.createHistoryItem(ride)).join('');
                    
                    // Add expand functionality
                    this.setupHistoryExpansion();
                } catch (error) {
                    console.error('Error loading ride history:', error);
                    document.getElementById('historyList').innerHTML = 
                        '<p class="text-center text-error p-lg">Error loading ride history</p>';
                }
            }

            createHistoryItem(ride) {
                const date = new Date(ride.timestamp);
                const formattedDate = date.toLocaleDateString();
                const formattedTime = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                const typeClass = ride.emergencyDetails ? 'emergency' : 
                                (ride.expressDelivery || ride.truckDelivery) ? 'delivery' : 'ride';
                
                const typeText = ride.emergencyDetails ? 'EMERGENCY' : 
                               (ride.expressDelivery || ride.truckDelivery) ? 'DELIVERY' : 'RIDE';
                
                const statusClass = this.getStatusClass(ride.status);
                const statusText = this.getStatusText(ride.status);
                
                return `
                    <div class="history-item" data-ride-id="${ride.id}">
                        <div class="history-item-header">
                            <div class="history-route">
                                <div class="history-location">
                                    <i class="fas fa-map-marker-alt history-location-icon"></i>
                                    ${this.truncateText(ride.pickupDisplayLocation || ride.pickupLocation, 30)}
                                </div>
                                <div class="history-arrow">
                                    <i class="fas fa-arrow-right"></i>
                                </div>
                                <div class="history-location">
                                    <i class="fas fa-flag history-location-icon"></i>
                                    ${this.truncateText(ride.destination, 30)}
                                </div>
                            </div>
                            <div class="history-type-badge history-type-${typeClass}">
                                ${typeText}
                            </div>
                        </div>
                        
                        <div class="history-details">
                            <div class="history-info">
                                <div class="history-info-item">
                                    <div class="history-info-label">Date</div>
                                    <div class="history-info-value">${formattedDate}</div>
                                </div>
                                <div class="history-info-item">
                                    <div class="history-info-label">Time</div>
                                    <div class="history-info-value">${formattedTime}</div>
                                </div>
                                <div class="history-info-item">
                                    <div class="history-info-label">Status</div>
                                    <div class="history-info-value ${statusClass}">${statusText}</div>
                                </div>
                            </div>
                            <div class="history-fare">
                                ZMW ${ride.fare ? ride.fare.toFixed(2) : '0.00'}
                            </div>
                        </div>
                        
                        <div class="history-expand-btn">
                            <i class="fas fa-chevron-down"></i>
                            Show Details
                        </div>
                        
                        <div class="history-expanded-content">
                            <div class="expanded-details-grid">
                                <div class="expanded-detail-item">
                                    <div class="expanded-detail-label">Ride ID</div>
                                    <div class="expanded-detail-value">${ride.id.substring(0, 8)}</div>
                                </div>
                                <div class="expanded-detail-item">
                                    <div class="expanded-detail-label">Distance</div>
                                    <div class="expanded-detail-value">${ride.distance || 'N/A'}</div>
                                </div>
                                <div class="expanded-detail-item">
                                    <div class="expanded-detail-label">Ride Type</div>
                                    <div class="expanded-detail-value">${ride.rideClass || 'Standard'}</div>
                                </div>
                                <div class="expanded-detail-item">
                                    <div class="expanded-detail-label">Payment</div>
                                    <div class="expanded-detail-value">${ride.paymentMethod || 'Wallet'}</div>
                                </div>
                                ${ride.driverName ? `
                                    <div class="expanded-detail-item">
                                        <div class="expanded-detail-label">Driver</div>
                                        <div class="expanded-detail-value">${ride.driverName}</div>
                                    </div>
                                ` : ''}
                                ${ride.vehicleDetails ? `
                                    <div class="expanded-detail-item">
                                        <div class="expanded-detail-label">Vehicle</div>
                                        <div class="expanded-detail-value">${ride.vehicleDetails}</div>
                                    </div>
                                ` : ''}
                            </div>
                            
                            ${ride.emergencyDetails ? `
                                <div class="mt-lg p-md bg-red-50 rounded-lg">
                                    <div class="font-bold text-red-600 mb-sm">Emergency Details</div>
                                    <div class="text-sm">Type: ${ride.emergencyDetails.type}</div>
                                    <div class="text-sm">Severity: ${ride.emergencyDetails.severity}</div>
                                </div>
                            ` : ''}
                            
                            <div class="mt-lg flex gap-sm">
                                <button class="secondary-button flex-1 view-receipt-btn" data-ride-id="${ride.id}">
                                    <i class="fas fa-receipt"></i>
                                    View Receipt
                                </button>
                                <button class="secondary-button flex-1 rate-ride-btn" data-ride-id="${ride.id}" ${ride.status !== 'completed' ? 'disabled' : ''}>
                                    <i class="fas fa-star"></i>
                                    Rate Ride
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            truncateText(text, maxLength) {
                if (!text) return '';
                return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
            }

            getStatusClass(status) {
                const statusClasses = {
                    'completed': 'text-success',
                    'cancelled': 'text-error',
                    'requested': 'text-warning',
                    'accepted': 'text-info',
                    'arrived': 'text-info',
                    'started': 'text-info',
                    'picked_up': 'text-info'
                };
                return statusClasses[status] || 'text-secondary';
            }

            getStatusText(status) {
                const statusMap = {
                    'requested': 'Requested',
                    'accepted': 'Accepted',
                    'arrived': 'Arrived',
                    'started': 'Started',
                    'picked_up': 'Picked Up',
                    'completed': 'Completed',
                    'cancelled': 'Cancelled',
                    'paid': 'Paid'
                };
                return statusMap[status] || status;
            }

            setupHistoryExpansion() {
                document.querySelectorAll('.history-expand-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const historyItem = btn.closest('.history-item');
                        historyItem.classList.toggle('expanded');
                        
                        const icon = btn.querySelector('i');
                        if (historyItem.classList.contains('expanded')) {
                            icon.className = 'fas fa-chevron-up';
                            btn.innerHTML = '<i class="fas fa-chevron-up"></i> Hide Details';
                        } else {
                            icon.className = 'fas fa-chevron-down';
                            btn.innerHTML = '<i class="fas fa-chevron-down"></i> Show Details';
                        }
                    });
                });

                // View receipt buttons
                document.querySelectorAll('.view-receipt-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const rideId = btn.dataset.rideId;
                        await this.showReceipt(rideId);
                    });
                });
            }

            updateUserStats() {
                if (!this.state.currentUser) return;

                firebase.database()
                    .ref('rides')
                    .orderByChild('passengerId')
                    .equalTo(this.state.currentUser.uid)
                    .once('value')
                    .then(snapshot => {
                        const rides = snapshot.val();
                        if (!rides) return;

                        const ridesArray = Object.values(rides);
                        
                        const completed = ridesArray.filter(r => r.status === 'completed' || r.status === 'paid').length;
                        const cancelled = ridesArray.filter(r => r.status === 'cancelled').length;
                        const pending = ridesArray.filter(r => ['requested', 'accepted', 'arrived', 'started'].includes(r.status)).length;

                        document.getElementById('ridesCompleted').textContent = completed;
                        document.getElementById('ridesCancelled').textContent = cancelled;
                        document.getElementById('ridesPending').textContent = pending;
                    })
                    .catch(error => {
                        console.error('Error updating user stats:', error);
                    });
            }

            setupEventListeners() {
                // Destination search
                this.setupDestinationSearch();
                
                // Quick locations
                this.setupQuickLocations();
                
                // More options
                this.setupMoreOptions();
                
                // Emergency services
                this.setupEmergencyServices();
                
                // Payment modal
                this.setupPaymentModal();
                
                // Cancel ride modal
                this.setupCancelModal();
                
            // Chat system
            this.setupChatSystem();

            // Ride request
            document.getElementById('requestRideBtn').addEventListener('click', () => {
                this.requestRide();
            });

            // Contact driver
            document.getElementById('contactDriverBtn').addEventListener('click', () => {
                this.contactDriver();
            });

            // Cancel ride
            document.getElementById('cancelRideBtn').addEventListener('click', () => {
                this.showCancelModal();
            });

            // SOS button
            document.getElementById('sosButton').addEventListener('click', () => {
                this.triggerSOS();
            });

            // Panel handle
            document.getElementById('panelHandle').addEventListener('click', () => {
                this.togglePanel();
            });

            // Share referral
            document.getElementById('shareReferralBtn').addEventListener('click', () => {
                this.shareReferralCode();
            });

            // Deposit
            document.getElementById('depositBtn').addEventListener('click', () => {
                this.depositToWallet();
            });

            // Withdraw
            document.getElementById('withdrawBtn').addEventListener('click', () => {
                this.withdrawFromWallet();
            });

            // Chat close
            document.getElementById('chatClose').addEventListener('click', () => {
                this.closeChat();
            });

            // Chat send
            document.getElementById('chatSend').addEventListener('click', () => {
                this.sendChatMessage();
            });

            // Chat input enter key
            document.getElementById('chatInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    this.sendChatMessage();
                }
            });
        }

        setupDestinationSearch() {
            const input = document.getElementById('destinationLocation');
            const suggestions = document.getElementById('destinationSuggestions');
            let debounceTimer;

            input.addEventListener('input', () => {
                clearTimeout(debounceTimer);
                const query = input.value.trim();

                if (query.length < 2) {
                    suggestions.classList.remove('active');
                    return;
                }

                debounceTimer = setTimeout(() => {
                    this.searchPlaces(query, suggestions);
                }, this.config.search.debounceTime);
            });

            input.addEventListener('focus', () => {
                if (input.value.trim().length >= 2) {
                    const query = input.value.trim();
                    this.searchPlaces(query, suggestions);
                }
            });

            // Close suggestions when clicking outside
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !suggestions.contains(e.target)) {
                    suggestions.classList.remove('active');
                }
            });
        }

        async searchPlaces(query, suggestionsContainer) {
            try {
                // Cancel previous search if any
                if (this.components.searchController) {
                    this.components.searchController.abort();
                }

                this.components.searchController = new AbortController();
                const signal = this.components.searchController.signal;

                // Check cache first
                const cacheKey = `${query}_${this.state.currentCity}`;
                if (this.state.searchCache.has(cacheKey)) {
                    const cachedResults = this.state.searchCache.get(cacheKey);
                    this.displaySearchResults(cachedResults, suggestionsContainer);
                    return;
                }

                // Build search query
                let searchQuery = query;
                if (this.state.currentCity && this.config.cities.includes(this.state.currentCity)) {
                    searchQuery += `, ${this.state.currentCity}, Zambia`;
                } else {
                    searchQuery += ', Zambia';
                }

                // Fetch from Nominatim
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&limit=${this.config.search.maxResults}&countrycodes=zm&dedupe=1`,
                    { signal }
                );

                const results = await response.json();

                // Process results
                const processedResults = results.map(place => ({
                    ...place,
                    displayName: place.display_name,
                    lat: parseFloat(place.lat),
                    lon: parseFloat(place.lon),
                    distance: this.calculateDistance(
                        this.state.userLocation.lat,
                        this.state.userLocation.lng,
                        parseFloat(place.lat),
                        parseFloat(place.lon)
                    ),
                    city: this.extractCityFromDisplayName(place.display_name),
                    type: place.type || place.class
                }));

                // Sort by relevance
                processedResults.sort((a, b) => {
                    // Boost results in current city
                    const aBoost = a.city === this.state.currentCity ? this.config.search.cityPriorityBoost : 1;
                    const bBoost = b.city === this.state.currentCity ? this.config.search.cityPriorityBoost : 1;

                    return (a.distance * (1/aBoost)) - (b.distance * (1/bBoost));
                });

                // Cache results
                this.state.searchCache.set(cacheKey, processedResults);

                // Display results
                this.displaySearchResults(processedResults, suggestionsContainer);

            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('Search was aborted');
                    return;
                }
                console.error('Search error:', error);
                suggestionsContainer.innerHTML = '<div class="p-md text-center text-secondary">Error searching places</div>';
                suggestionsContainer.classList.add('active');
            }
        }

        displaySearchResults(results, container) {
            if (!results || results.length === 0) {
                container.innerHTML = '<div class="p-md text-center text-secondary">No places found</div>';
                container.classList.add('active');
                return;
            }

            const items = results.map(result => `
                <div class="search-suggestion-item" data-lat="${result.lat}" data-lon="${result.lon}" data-name="${result.displayName}">
                    <div class="search-suggestion-icon">
                        ${this.getPlaceIcon(result.type)}
                    </div>
                    <div class="search-suggestion-content">
                        <div class="search-suggestion-title">${this.formatPlaceName(result.displayName)}</div>
                        <div class="search-suggestion-address">${this.formatAddress(result.displayName)}</div>
                        <div class="search-suggestion-distance">
                            ${result.distance ? `${(result.distance / 1000).toFixed(1)} km away` : ''}
                            ${result.city ? `<span class="search-suggestion-city">${result.city}</span>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = items;
            container.classList.add('active');

            // Add click handlers
            container.querySelectorAll('.search-suggestion-item').forEach(item => {
                item.addEventListener('click', () => {
                    const lat = parseFloat(item.dataset.lat);
                    const lon = parseFloat(item.dataset.lon);
                    const name = item.dataset.name;

                    document.getElementById('destinationLocation').value = this.formatPlaceName(name);
                    container.classList.remove('active');

                    this.state.selectedDestination = { lat, lon, name };
                    this.addDestinationMarker(lat, lon);
                    this.calculateFare();
                    this.showRideRequestButton();
                });
            });
        }

        formatPlaceName(fullName) {
            const parts = fullName.split(',');
            return parts.slice(0, 2).join(', ').trim();
        }

        formatAddress(fullName) {
            const parts = fullName.split(',');
            return parts.slice(2, 4).join(', ').trim();
        }

        getPlaceIcon(type) {
            const icons = {
                'restaurant': 'ðŸ½ï¸',
                'cafe': 'â˜•',
                'bank': 'ðŸ¦',
                'hospital': 'ðŸ¥',
                'pharmacy': 'ðŸ’Š',
                'school': 'ðŸ«',
                'supermarket': 'ðŸ›’',
                'mall': 'ðŸª',
                'hotel': 'ðŸ¨',
                'police': 'ðŸ‘®',
                'fire_station': 'ðŸš’',
                'default': 'ðŸ“'
            };

            return icons[type] || icons.default;
        }

        addDestinationMarker(lat, lng) {
            if (this.components.markers.destination) {
                this.components.map.removeLayer(this.components.markers.destination);
            }

            this.components.markers.destination = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'destination-marker',
                    html: '<div class="destination-marker"><i class="fas fa-flag"></i></div>',
                    iconSize: [28, 28]
                })
            }).addTo(this.components.map)
              .bindPopup('Destination');

            // Fit map to show both user and destination
            if (this.state.userLocation) {
                const bounds = L.latLngBounds([
                    [this.state.userLocation.lat, this.state.userLocation.lng],
                    [lat, lng]
                ]);
                this.components.map.fitBounds(bounds, { padding: [50, 50] });
            }

            // Draw route
            this.drawRoute();
        }

        drawRoute() {
            if (!this.state.userLocation || !this.state.selectedDestination) return;

            if (this.components.route) {
                this.components.map.removeLayer(this.components.route);
            }

            // Draw straight line for now (can be enhanced with OSRM)
            this.components.route = L.polyline([
                [this.state.userLocation.lat, this.state.userLocation.lng],
                [this.state.selectedDestination.lat, this.state.selectedDestination.lng]
            ], {
                color: '#FF6B35',
                weight: 4,
                opacity: 0.7,
                dashArray: '10, 10'
            }).addTo(this.components.map);
        }

        calculateFare() {
            if (!this.state.userLocation || !this.state.selectedDestination) {
                this.hideFareDisplay();
                return;
            }

            // Calculate distance
            const distance = this.calculateDistance(
                this.state.userLocation.lat,
                this.state.userLocation.lng,
                this.state.selectedDestination.lat,
                this.state.selectedDestination.lon
            );

            // Calculate time (assume 30 km/h average speed)
            const timeMinutes = (distance / 1000) / 30 * 60;

            // Calculate fare
            let fare = this.config.pricing.baseFare;
            fare += (distance / 1000) * this.config.pricing.perKm;
            fare += timeMinutes * this.config.pricing.perMinute;

            // Apply ride type multiplier
            const multiplier = this.config.pricing.rideTypeMultipliers[this.state.selectedRideType] || 1;
            fare *= multiplier;

            // Round to 2 decimal places
            fare = Math.round(fare * 100) / 100;

            // Update UI
            this.updateFareDisplay(fare, distance, timeMinutes);
        }

        calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth radius in meters
            const Ï†1 = lat1 * Math.PI / 180;
            const Ï†2 = lat2 * Math.PI / 180;
            const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
            const Î”Î» = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                      Math.cos(Ï†1) * Math.cos(Ï†2) *
                      Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        updateFareDisplay(fare, distance, timeMinutes) {
            const fareDisplay = document.getElementById('fareDisplay');
            const estimatedFare = document.getElementById('estimatedFare');
            const estimatedDistance = document.getElementById('estimatedDistance');
            const estimatedTime = document.getElementById('estimatedTime');
            const selectedRideType = document.getElementById('selectedRideType');

            // Update ride type prices
            this.updatePriceDisplays(distance, timeMinutes);

            // Update main fare display
            estimatedFare.textContent = `ZMW ${fare.toFixed(2)}`;
            estimatedDistance.textContent = `${(distance / 1000).toFixed(1)} km`;
            estimatedTime.textContent = `${Math.ceil(timeMinutes)} min`;
            selectedRideType.textContent = this.state.selectedRideType.charAt(0).toUpperCase() + this.state.selectedRideType.slice(1);

            // Show fare display
            fareDisplay.style.display = 'block';
        }

        updatePriceDisplays(distance = 0, timeMinutes = 0) {
            // Calculate base fare for 1 km distance
            let baseFare = this.config.pricing.baseFare;
            baseFare += (distance / 1000) * this.config.pricing.perKm;
            baseFare += timeMinutes * this.config.pricing.perMinute;

            // Update each ride type price
            Object.keys(this.config.pricing.rideTypeMultipliers).forEach(type => {
                const multiplier = this.config.pricing.rideTypeMultipliers[type];
                const price = baseFare * multiplier;
                const element = document.getElementById(`${type}Price`);
                if (element) {
                    element.textContent = `ZMW ${price.toFixed(2)}`;
                }
            });
        }

        hideFareDisplay() {
            document.getElementById('fareDisplay').style.display = 'none';
            document.getElementById('requestRideBtn').style.display = 'none';
        }

        showRideRequestButton() {
            document.getElementById('requestRideBtn').style.display = 'flex';
        }

        async requestRide() {
            if (!this.state.userLocation || !this.state.selectedDestination) {
                this.showNotification('Please select a destination first', 'error');
                return;
            }

            // Get pickup address
            const pickupAddress = await this.getAddressDisplay(
                this.state.userLocation.lat,
                this.state.userLocation.lng
            );

            // Calculate distance
            const distance = this.calculateDistance(
                this.state.userLocation.lat,
                this.state.userLocation.lng,
                this.state.selectedDestination.lat,
                this.state.selectedDestination.lon
            );

            // Calculate fare
            const timeMinutes = (distance / 1000) / 30 * 60;
            let fare = this.config.pricing.baseFare;
            fare += (distance / 1000) * this.config.pricing.perKm;
            fare += timeMinutes * this.config.pricing.perMinute;
            fare *= this.config.pricing.rideTypeMultipliers[this.state.selectedRideType] || 1;
            fare = Math.round(fare * 100) / 100;

            // Show payment modal
            this.showPaymentModal(fare);
        }

        showPaymentModal(fare) {
            this.state.currentFare = fare;
            
            // Check wallet balance
            const insufficientBalance = fare > this.state.walletBalance;
            document.getElementById('insufficientBalance').classList.toggle('hidden', !insufficientBalance);
            
            // Show modal
            document.getElementById('paymentModal').classList.remove('hidden');
        }

        setupPaymentModal() {
            const modal = document.getElementById('paymentModal');
            const closeBtn = document.getElementById('closePaymentModal');
            const cancelBtn = document.getElementById('cancelPaymentBtn');
            const confirmBtn = document.getElementById('confirmPaymentBtn');

            closeBtn.addEventListener('click', () => {
                modal.classList.add('hidden');
            });

            cancelBtn.addEventListener('click', () => {
                modal.classList.add('hidden');
            });

            confirmBtn.addEventListener('click', async () => {
                await this.confirmPayment();
            });

            // Payment option selection
            document.querySelectorAll('.payment-option').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('.payment-option').forEach(opt => {
                        opt.querySelector('div').classList.remove('border-primary', 'bg-light');
                        opt.querySelector('div').classList.add('border-gray-300');
                        opt.querySelector('div').lastElementChild.classList.remove('border-primary');
                        opt.querySelector('div').lastElementChild.classList.add('border-gray-300');
                        opt.querySelector('div').lastElementChild.innerHTML = '';
                    });

                    option.querySelector('div').classList.add('border-primary', 'bg-light');
                    option.querySelector('div').classList.remove('border-gray-300');
                    option.querySelector('div').lastElementChild.classList.add('border-primary');
                    option.querySelector('div').lastElementChild.classList.remove('border-gray-300');
                    option.querySelector('div').lastElementChild.innerHTML = '<div class="w-3 h-3 rounded-full bg-primary"></div>';

                    this.state.selectedPaymentType = option.dataset.type;
                });
            });
        }

        async confirmPayment() {
            try {
                this.showLoading('Processing payment...');

                if (this.state.selectedPaymentType === 'wallet' && this.state.currentFare > this.state.walletBalance) {
                    throw new Error('Insufficient wallet balance');
                }

                // Create ride request
                const rideId = firebase.database().ref().child('rides').push().key;
                
                const rideRequest = {
                    id: rideId,
                    passengerId: this.state.currentUser.uid,
                    passengerName: this.state.userData.name,
                    passengerPhone: this.state.userData.phone,
                    pickupLocation: document.getElementById('pickupLocation').value,
                    pickupLat: this.state.userLocation.lat,
                    pickupLng: this.state.userLocation.lng,
                    destination: document.getElementById('destinationLocation').value,
                    destLat: this.state.selectedDestination.lat,
                    destLon: this.state.selectedDestination.lon,
                    rideType: this.state.selectedRideType,
                    fare: this.state.currentFare,
                    status: 'requested',
                    timestamp: Date.now(),
                    updatedAt: Date.now(),
                    paymentMethod: this.state.selectedPaymentType,
                    currentCity: this.state.currentCity
                };

                // Deduct from wallet if paying with wallet
                if (this.state.selectedPaymentType === 'wallet') {
                    const newBalance = this.state.walletBalance - this.state.currentFare;
                    await firebase.database().ref(`users/${this.state.currentUser.uid}`).update({
                        walletBalance: newBalance
                    });
                    this.state.walletBalance = newBalance;
                    this.updateWalletUI();
                }

                // Save ride request
                await firebase.database().ref(`rides/${rideId}`).set(rideRequest);

                // Update state
                this.state.activeRide = rideRequest;

                // Update UI
                this.updateUIForActiveRide();
                this.showNotification('Ride requested successfully! Searching for driver...', 'success');

                // Close payment modal
                document.getElementById('paymentModal').classList.add('hidden');

                // Start listening for driver assignment
                this.listenForRideUpdates(rideId);

            } catch (error) {
                console.error('Payment error:', error);
                this.showNotification(error.message || 'Payment failed. Please try again.', 'error');
            } finally {
                this.hideLoading();
            }
        }

        updateUIForActiveRide() {
            if (!this.state.activeRide) return;

            // Hide ride request form
            document.getElementById('requestRideBtn').style.display = 'none';
            document.getElementById('fareDisplay').style.display = 'none';
            document.getElementById('rideTypeSelection').style.display = 'none';

            // Show active ride info
            document.getElementById('activeRideInfo').style.display = 'block';
            document.getElementById('activeRideFare').textContent = `ZMW ${this.state.activeRide.fare.toFixed(2)}`;
            document.getElementById('activeRideStatus').textContent = this.getStatusText(this.state.activeRide.status);

            // Show status indicator
            document.getElementById('rideStatus').style.display = 'flex';
            document.getElementById('etaDisplay').style.display = 'flex';
            
            // Show SOS button if configured
            if (this.state.sosConfig) {
                document.getElementById('sosButton').style.display = 'flex';
            }

            // Update status pulse
            const statusPulse = document.getElementById('statusPulse');
            statusPulse.className = 'status-pulse searching';
        }

        listenForRideUpdates(rideId) {
            this.components.listeners[rideId] = firebase.database()
                .ref(`rides/${rideId}`)
                .on('value', (snapshot) => {
                    const ride = snapshot.val();
                    if (!ride) return;

                    this.state.activeRide = { id: rideId, ...ride };
                    this.updateActiveRideUI(ride);

                    // Handle different statuses
                    switch (ride.status) {
                        case 'accepted':
                            this.handleDriverAssignment(ride);
                            break;
                        case 'arrived':
                            this.showNotification('Your driver has arrived!', 'info');
                            break;
                        case 'started':
                            this.showNotification('Trip started!', 'info');
                            break;
                        case 'completed':
                            this.handleRideCompletion(ride);
                            break;
                        case 'cancelled':
                            this.handleRideCancellation(ride);
                            break;
                    }
                });
        }

        updateActiveRideUI(ride) {
            document.getElementById('activeRideStatus').textContent = this.getStatusText(ride.status);
            document.getElementById('statusText').textContent = this.getStatusText(ride.status);

            // Update status pulse
            const statusPulse = document.getElementById('statusPulse');
            switch (ride.status) {
                case 'requested':
                    statusPulse.className = 'status-pulse searching';
                    break;
                case 'accepted':
                    statusPulse.className = 'status-pulse arriving';
                    break;
                case 'arrived':
                case 'started':
                    statusPulse.className = 'status-pulse riding';
                    break;
            }

            // Update driver info if available
            if (ride.driverId) {
                this.loadDriverInfo(ride.driverId);
            }

            // Update ETA
            if (ride.eta) {
                document.getElementById('etaTime').textContent = `${ride.eta} min`;
            }
        }

        async handleDriverAssignment(ride) {
            try {
                // Load driver info
                const driver = await this.loadDriverInfo(ride.driverId);
                
                // Add driver marker
                this.addDriverMarker(ride.driverLat, ride.driverLng, driver.name);
                
                // Draw route from driver to pickup
                this.drawDriverRoute(ride.driverLat, ride.driverLng);
                
                // Start tracking driver location
                this.trackDriverLocation(ride.driverId);
                
                // Show notification
                this.showNotification(`${driver.name} is on the way!`, 'success');
                
            } catch (error) {
                console.error('Error handling driver assignment:', error);
            }
        }

        async loadDriverInfo(driverId) {
            try {
                const snapshot = await firebase.database().ref(`users/${driverId}`).once('value');
                const driver = snapshot.val();
                
                if (driver) {
                    document.getElementById('activeDriverName').textContent = driver.name;
                    
                    // Update chat with driver name
                    const chatTitle = document.querySelector('.chat-title span');
                    if (chatTitle) {
                        chatTitle.textContent = `Chat with ${driver.name}`;
                    }
                    
                    return driver;
                }
            } catch (error) {
                console.error('Error loading driver info:', error);
            }
            return null;
        }

        addDriverMarker(lat, lng, name) {
            if (this.components.markers.driver) {
                this.components.map.removeLayer(this.components.markers.driver);
            }

            this.components.markers.driver = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'driver-marker',
                    html: '<div class="driver-marker">ðŸš—</div>',
                    iconSize: [40, 40]
                })
            }).addTo(this.components.map)
              .bindPopup(`Driver: ${name}`);
        }

        drawDriverRoute(driverLat, driverLng) {
            if (!this.state.userLocation) return;

            if (this.components.route) {
                this.components.map.removeLayer(this.components.route);
            }

            this.components.route = L.polyline([
                [driverLat, driverLng],
                [this.state.userLocation.lat, this.state.userLocation.lng]
            ], {
                color: '#3498DB',
                weight: 4,
                opacity: 0.7
            }).addTo(this.components.map);
        }

        trackDriverLocation(driverId) {
            if (this.components.listeners[`driver_${driverId}`]) {
                firebase.database().ref(`driverLocations/${driverId}`).off('value', this.components.listeners[`driver_${driverId}`]);
            }

            this.components.listeners[`driver_${driverId}`] = firebase.database()
                .ref(`driverLocations/${driverId}`)
                .on('value', (snapshot) => {
                    const location = snapshot.val();
                    if (location && this.components.markers.driver) {
                        this.components.markers.driver.setLatLng([location.latitude, location.longitude]);
                        
                        // Update ETA
                        if (this.state.userLocation) {
                            const distance = this.calculateDistance(
                                location.latitude,
                                location.longitude,
                                this.state.userLocation.lat,
                                this.state.userLocation.lng
                            );
                            const eta = Math.ceil((distance / 1000) / 30 * 60);
                            document.getElementById('etaTime').textContent = `${eta} min`;
                        }
                    }
                });
        }

        handleRideCompletion(ride) {
            // Update UI
            document.getElementById('activeRideInfo').style.display = 'none';
            document.getElementById('rideStatus').style.display = 'none';
            document.getElementById('etaDisplay').style.display = 'none';
            document.getElementById('sosButton').style.display = 'none';
            
            // Remove markers
            if (this.components.markers.driver) {
                this.components.map.removeLayer(this.components.markers.driver);
                this.components.markers.driver = null;
            }
            
            if (this.components.route) {
                this.components.map.removeLayer(this.components.route);
                this.components.route = null;
            }
            
            // Show receipt
            this.showReceipt(ride.id);
            
            // Show notification
            this.showNotification('Ride completed successfully!', 'success');
            
            // Reset state
            this.state.activeRide = null;
            
            // Reload history
            this.loadRideHistory();
        }

        handleRideCancellation(ride) {
            // Update UI
            document.getElementById('activeRideInfo').style.display = 'none';
            document.getElementById('rideStatus').style.display = 'none';
            document.getElementById('etaDisplay').style.display = 'none';
            document.getElementById('sosButton').style.display = 'none';
            
            // Remove markers
            if (this.components.markers.driver) {
                this.components.map.removeLayer(this.components.markers.driver);
                this.components.markers.driver = null;
            }
            
            if (this.components.route) {
                this.components.map.removeLayer(this.components.route);
                this.components.route = null;
            }
            
            // Show notification
            this.showNotification('Ride has been cancelled', 'info');
            
            // Reset state
            this.state.activeRide = null;
            
            // Reload history
            this.loadRideHistory();
        }

        showCancelModal() {
            document.getElementById('cancelRideModal').classList.remove('hidden');
            
            // Setup cancel reason selection
            this.setupCancelReasons();
        }

        setupCancelReasons() {
            const reasons = document.querySelectorAll('.cancel-reason');
            reasons.forEach(reason => {
                reason.addEventListener('click', () => {
                    reasons.forEach(r => r.classList.remove('selected'));
                    reason.classList.add('selected');
                    
                    // Show comment box for "other" reason
                    const commentBox = document.getElementById('cancelComment');
                    commentBox.style.display = reason.dataset.reason === 'other' ? 'block' : 'none';
                });
            });
        }

        setupCancelModal() {
            const modal = document.getElementById('cancelRideModal');
            const closeBtn = document.getElementById('closeCancelModal');
            const backBtn = document.getElementById('backCancelBtn');
            const confirmBtn = document.getElementById('confirmCancelBtn');

            closeBtn.addEventListener('click', () => {
                modal.classList.add('hidden');
            });

            backBtn.addEventListener('click', () => {
                modal.classList.add('hidden');
            });

            confirmBtn.addEventListener('click', async () => {
                await this.confirmRideCancellation();
            });
        }

        async confirmRideCancellation() {
            try {
                if (!this.state.activeRide) return;

                const selectedReason = document.querySelector('.cancel-reason.selected');
                if (!selectedReason) {
                    this.showNotification('Please select a cancellation reason', 'error');
                    return;
                }

                const reason = selectedReason.dataset.reason;
                const comment = document.getElementById('cancelComment').value;

                // Update ride status
                await firebase.database().ref(`rides/${this.state.activeRide.id}`).update({
                    status: 'cancelled',
                    cancelledAt: Date.now(),
                    cancellationReason: reason,
                    cancellationComment: comment,
                    updatedAt: Date.now()
                });

                // Close modal
                document.getElementById('cancelRideModal').classList.add('hidden');

                // Show notification
                this.showNotification('Ride cancelled successfully', 'info');

            } catch (error) {
                console.error('Error cancelling ride:', error);
                this.showNotification('Failed to cancel ride. Please try again.', 'error');
            }
        }

        setupQuickLocations() {
            document.querySelectorAll('.quick-location-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const location = btn.dataset.location;
                    this.useQuickLocation(location);
                });
            });
        }

        useQuickLocation(location) {
            const addresses = {
                home: '123 Home Street, Lusaka',
                work: '456 Work Avenue, Lusaka',
                gym: 'Fitness Center, Lusaka',
                mall: 'Manda Hill Mall, Lusaka'
            };

            if (addresses[location]) {
                document.getElementById('destinationLocation').value = addresses[location];
                // Trigger search and fare calculation
                this.searchPlaces(addresses[location], document.getElementById('destinationSuggestions'));
            }
        }

        setupMoreOptions() {
            document.querySelectorAll('.more-option-card').forEach(card => {
                card.addEventListener('click', () => {
                    const option = card.dataset.option;
                    this.handleMoreOption(option);
                });
            });
        }

        handleMoreOption(option) {
            switch (option) {
                case 'express-delivery':
                    this.showNotification('Express delivery coming soon!', 'info');
                    break;
                case 'schedule-ride':
                    this.showNotification('Schedule ride coming soon!', 'info');
                    break;
                case 'emergency':
                    this.switchScreen('emergency');
                    break;
                case 'order-for-someone':
                    this.showNotification('Order for someone coming soon!', 'info');
                    break;
                case 'light-truck':
                    this.showNotification('Light truck service coming soon!', 'info');
                    break;
                case 'sos-setup':
                    this.showSOSSetup();
                    break;
            }
        }

        setupEmergencyServices() {
            document.querySelectorAll('.emergency-service-card').forEach(card => {
                card.addEventListener('click', () => {
                    const type = card.dataset.type;
                    this.handleEmergencyService(type);
                });
            });
        }

        async handleEmergencyService(type) {
            try {
                // Find nearest emergency service location
                const nearestLocation = await this.findNearestEmergencyService(type);
                
                if (!nearestLocation) {
                    this.showNotification('No emergency service found in your area', 'error');
                    return;
                }

                // Calculate fare
                const distance = this.calculateDistance(
                    this.state.userLocation.lat,
                    this.state.userLocation.lng,
                    nearestLocation.lat,
                    nearestLocation.lng
                );

                const fare = this.calculateEmergencyFare(type, distance);

                // Show confirmation
                const confirm = await this.showEmergencyConfirmation(type, nearestLocation.name, fare);
                
                if (confirm) {
                    this.requestEmergencyRide(type, nearestLocation, fare);
                }

            } catch (error) {
                console.error('Emergency service error:', error);
                this.showNotification('Emergency service unavailable. Please call 911.', 'error');
            }
        }

        async findNearestEmergencyService(type) {
            if (!this.state.currentCity || !this.config.emergencyServices[this.state.currentCity.toLowerCase()]) {
                return null;
            }

            const services = this.config.emergencyServices[this.state.currentCity.toLowerCase()][type];
            if (!services || services.length === 0) return null;

            // Find nearest service
            let nearest = null;
            let minDistance = Infinity;

            for (const service of services) {
                const distance = this.calculateDistance(
                    this.state.userLocation.lat,
                    this.state.userLocation.lng,
                    service.lat,
                    service.lng
                );

                if (distance < minDistance) {
                    minDistance = distance;
                    nearest = service;
                }
            }

            return nearest;
        }

        calculateEmergencyFare(type, distance) {
            const baseFare = this.config.pricing.emergencyServices[type] || 200;
            const distanceFare = (distance / 1000) * 5; // ZMW 5 per km for emergency
            return baseFare + distanceFare;
        }

        async showEmergencyConfirmation(type, locationName, fare) {
            return new Promise((resolve) => {
                // Create custom confirmation modal
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal-container">
                        <div class="modal-header">
                            <div class="modal-title">
                                <i class="fas fa-exclamation-triangle text-red-600"></i>
                                Emergency ${type.charAt(0).toUpperCase() + type.slice(1)} Request
                            </div>
                        </div>
                        <div class="modal-content">
                            <div class="mb-lg">
                                <p class="font-bold mb-sm">You are requesting an emergency ${type} ride</p>
                                <p class="text-secondary text-sm mb-sm">Location: ${locationName}</p>
                                <p class="text-secondary text-sm">Fare: <span class="font-bold text-primary">ZMW ${fare.toFixed(2)}</span></p>
                            </div>
                            <div class="bg-red-50 rounded-lg p-md mb-lg">
                                <p class="text-red-600 text-sm">
                                    <i class="fas fa-info-circle"></i>
                                    This is for emergencies only. Misuse may result in penalties.
                                </p>
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button class="secondary-button" id="cancelEmergencyBtn">Cancel</button>
                            <button class="primary-button danger-button" id="confirmEmergencyBtn">
                                Request Emergency Ride
                            </button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                document.getElementById('cancelEmergencyBtn').addEventListener('click', () => {
                    document.body.removeChild(modal);
                    resolve(false);
                });

                document.getElementById('confirmEmergencyBtn').addEventListener('click', () => {
                    document.body.removeChild(modal);
                    resolve(true);
                });
            });
        }

        async requestEmergencyRide(type, location, fare) {
            try {
                this.showLoading('Requesting emergency service...');

                const rideId = firebase.database().ref().child('rides').push().key;
                
                const rideRequest = {
                    id: rideId,
                    passengerId: this.state.currentUser.uid,
                    passengerName: this.state.userData.name,
                    passengerPhone: this.state.userData.phone,
                    pickupLocation: location.name,
                    pickupLat: location.lat,
                    pickupLng: location.lng,
                    destination: 'Emergency Location',
                    destLat: this.state.userLocation.lat,
                    destLon: this.state.userLocation.lng,
                    rideType: type,
                    fare: fare,
                    status: 'requested',
                    timestamp: Date.now(),
                    updatedAt: Date.now(),
                    paymentMethod: 'emergency',
                    emergencyService: true,
                    currentCity: this.state.currentCity,
                    priority: 'high'
                };

                await firebase.database().ref(`rides/${rideId}`).set(rideRequest);

                this.state.activeRide = rideRequest;
                this.state.emergencyMode = true;

                this.updateUIForActiveRide();
                this.showNotification('Emergency service requested! Help is on the way.', 'success');

                this.listenForRideUpdates(rideId);

            } catch (error) {
                console.error('Error requesting emergency ride:', error);
                this.showNotification('Failed to request emergency service. Please call 911.', 'error');
            } finally {
                this.hideLoading();
            }
        }

        showSOSSetup() {
            // Create SOS setup modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-container">
                    <div class="modal-header">
                        <div class="modal-title">
                            <i class="fas fa-exclamation-triangle text-red-600"></i>
                            SOS Emergency Setup
                        </div>
                        <button class="modal-close" id="closeSOSModal">&times;</button>
                    </div>
                    <div class="modal-content">
                        <div class="mb-lg">
                            <p class="text-secondary text-sm mb-lg">
                                Set up emergency contacts who will be notified when you trigger SOS during a ride.
                            </p>
                            
                            <div class="mb-md">
                                <label class="block text-sm font-bold mb-sm">Emergency Contact 1 *</label>
                                <input type="tel" class="w-full p-sm border rounded-lg" 
                                       id="sosContact1" placeholder="Phone number" 
                                       value="${this.state.sosConfig?.contact1 || ''}">
                            </div>
                            
                            <div class="mb-md">
                                <label class="block text-sm font-bold mb-sm">Emergency Contact 2</label>
                                <input type="tel" class="w-full p-sm border rounded-lg" 
                                       id="sosContact2" placeholder="Phone number (optional)"
                                       value="${this.state.sosConfig?.contact2 || ''}">
                            </div>
                            
                            <div class="mb-md">
                                <label class="block text-sm font-bold mb-sm">Emergency Message</label>
                                <textarea class="w-full p-sm border rounded-lg" id="sosMessage" rows="3">
${this.state.sosConfig?.message || 'I need help! My current location and ride details will be shared with you.'}
                                </textarea>
                            </div>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button class="secondary-button" id="cancelSOSBtn">Cancel</button>
                        <button class="primary-button" id="saveSOSBtn">Save SOS Configuration</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            document.getElementById('closeSOSModal').addEventListener('click', () => {
                document.body.removeChild(modal);
            });

            document.getElementById('cancelSOSBtn').addEventListener('click', () => {
                document.body.removeChild(modal);
            });

            document.getElementById('saveSOSBtn').addEventListener('click', async () => {
                await this.saveSOSConfig(modal);
            });
        }

        async saveSOSConfig(modal) {
            try {
                const contact1 = document.getElementById('sosContact1').value.trim();
                const contact2 = document.getElementById('sosContact2').value.trim();
                const message = document.getElementById('sosMessage').value.trim();

                if (!contact1) {
                    this.showNotification('Emergency contact 1 is required', 'error');
                    return;
                }

                const sosConfig = {
                    contact1,
                    contact2: contact2 || null,
                    message: message || 'I need help! My current location and ride details will be shared with you.',
                    updatedAt: Date.now()
                };

                await firebase.database().ref(`sosConfig/${this.state.currentUser.uid}`).set(sosConfig);
                
                this.state.sosConfig = sosConfig;
                document.body.removeChild(modal);
                
                this.showNotification('SOS configuration saved successfully', 'success');

            } catch (error) {
                console.error('Error saving SOS config:', error);
                this.showNotification('Failed to save SOS configuration', 'error');
            }
        }

        async triggerSOS() {
            if (!this.state.sosConfig || !this.state.sosConfig.contact1) {
                this.showNotification('Please set up SOS emergency contacts first', 'error');
                return;
            }

            if (!this.state.activeRide) {
                this.showNotification('No active ride to trigger SOS for', 'error');
                return;
            }

            const confirm = await this.showSOSConfirmation();
            if (!confirm) return;

            try {
                this.showLoading('Sending SOS alert...');

                const sosAlert = {
                    passengerId: this.state.currentUser.uid,
                    passengerName: this.state.userData.name,
                    passengerPhone: this.state.userData.phone,
                    emergencyContact1: this.state.sosConfig.contact1,
                    emergencyContact2: this.state.sosConfig.contact2,
                    message: this.state.sosConfig.message,
                    rideId: this.state.activeRide.id,
                    rideDetails: this.state.activeRide,
                    location: this.state.userLocation,
                    timestamp: Date.now()
                };

                // Add driver info if available
                if (this.state.activeRide.driverId) {
                    const driver = await this.loadDriverInfo(this.state.activeRide.driverId);
                    if (driver) {
                        sosAlert.driverDetails = {
                            name: driver.name,
                            phone: driver.phone
                        };
                    }
                }

                await firebase.database().ref('sosAlerts').push().set(sosAlert);

                this.showNotification('SOS alert sent to emergency contacts!', 'success');
                console.log('SOS Alert Sent:', sosAlert);

            } catch (error) {
                console.error('Error sending SOS alert:', error);
                this.showNotification('Failed to send SOS alert. Please call emergency services.', 'error');
            } finally {
                this.hideLoading();
            }
        }

        async showSOSConfirmation() {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal-container">
                        <div class="modal-header">
                            <div class="modal-title">
                                <i class="fas fa-exclamation-triangle text-red-600"></i>
                                Trigger SOS Alert
                            </div>
                        </div>
                        <div class="modal-content">
                            <div class="mb-lg">
                                <p class="font-bold text-red-600 mb-sm">EMERGENCY SOS</p>
                                <p class="text-secondary text-sm mb-lg">
                                    This will send an emergency alert to your contacts with your location and ride details.
                                    Only use in genuine emergencies.
                                </p>
                                <div class="bg-red-50 rounded-lg p-md">
                                    <p class="text-red-600 text-sm">
                                        <i class="fas fa-exclamation-circle"></i>
                                        If you are in immediate danger, call 911 first.
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button class="secondary-button" id="cancelSOSAlertBtn">Cancel</button>
                            <button class="primary-button danger-button" id="confirmSOSAlertBtn">
                                Send SOS Alert
                            </button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                document.getElementById('cancelSOSAlertBtn').addEventListener('click', () => {
                    document.body.removeChild(modal);
                    resolve(false);
                });

                document.getElementById('confirmSOSAlertBtn').addEventListener('click', () => {
                    document.body.removeChild(modal);
                    resolve(true);
                });
            });
        }

        setupChatSystem() {
            // Chat will be activated when driver sends a message
        }

        async sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message || !this.state.activeRide) return;

            try {
                const chatId = this.state.activeRide.id;
                const chatMessage = {
                    senderId: this.state.currentUser.uid,
                    senderName: this.state.userData.name,
                    message: message,
                    timestamp: Date.now(),
                    type: 'passenger'
                };

                await firebase.database().ref(`chats/${chatId}/messages`).push().set(chatMessage);
                
                // Add to local messages
                this.state.chatMessages.push(chatMessage);
                this.displayChatMessage(chatMessage, 'sent');
                
                // Clear input
                input.value = '';
                
            } catch (error) {
                console.error('Error sending chat message:', error);
            }
        }

        displayChatMessage(message, type) {
            const messagesContainer = document.getElementById('chatMessages');
            
            const messageElement = document.createElement('div');
            messageElement.className = `chat-message ${type}`;
            messageElement.innerHTML = `
                <div class="font-bold text-xs mb-1">${message.senderName}</div>
                <div>${message.message}</div>
                <div class="text-xs opacity-75 mt-1">${new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
            `;
            
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        listenForDriverMessages(rideId) {
            if (this.components.listeners[`chat_${rideId}`]) {
                firebase.database().ref(`chats/${rideId}/messages`).off('child_added', this.components.listeners[`chat_${rideId}`]);
            }

            this.components.listeners[`chat_${rideId}`] = firebase.database()
                .ref(`chats/${rideId}/messages`)
                .orderByChild('timestamp')
                .startAt(Date.now())
                .on('child_added', (snapshot) => {
                    const message = snapshot.val();
                    
                    if (message.senderId !== this.state.currentUser.uid) {
                        // Driver sent a message
                        this.state.chatMessages.push(message);
                        this.displayChatMessage(message, 'received');
                        
                        // Show chat popup if closed
                        if (!document.getElementById('chatContainer').classList.contains('active')) {
                            document.getElementById('chatContainer').classList.add('active');
                            
                            // Update notification badge
                            this.state.unreadMessages++;
                            this.updateChatNotification();
                        }
                        
                        // Show notification
                        this.showNotification(`New message from driver: ${message.message.substring(0, 50)}...`, 'info');
                    }
                });
        }

        updateChatNotification() {
            const notification = document.getElementById('chatNotification');
            if (this.state.unreadMessages > 0) {
                notification.textContent = this.state.unreadMessages;
                notification.style.display = 'flex';
            } else {
                notification.style.display = 'none';
            }
        }

        openChat() {
            document.getElementById('chatContainer').classList.add('active');
            this.state.unreadMessages = 0;
            this.updateChatNotification();
        }

        closeChat() {
            document.getElementById('chatContainer').classList.remove('active');
        }

        async showReceipt(rideId) {
            try {
                const snapshot = await firebase.database().ref(`rides/${rideId}`).once('value');
                const ride = snapshot.val();
                
                if (!ride) {
                    this.showNotification('Ride not found', 'error');
                    return;
                }

                // Populate receipt data
                const date = new Date(ride.timestamp);
                document.getElementById('receiptDate').textContent = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                document.getElementById('receiptNumber').textContent = rideId.substring(0, 8).toUpperCase();
                document.getElementById('receiptPassenger').textContent = ride.passengerName;
                document.getElementById('receiptDriver').textContent = ride.driverName || 'Not assigned';
                document.getElementById('receiptVehicle').textContent = ride.vehicleDetails || 'Not specified';
                document.getElementById('receiptPickup').textContent = ride.pickupLocation;
                document.getElementById('receiptDestination').textContent = ride.destination;
                document.getElementById('receiptDistance').textContent = ride.distance || 'N/A';
                document.getElementById('receiptRideType').textContent = ride.rideType || 'Standard';
                document.getElementById('receiptRideTime').textContent = ride.duration || 'N/A';
                document.getElementById('receiptPaymentMethod').textContent = ride.paymentMethod || 'Wallet';

                // Calculate fare breakdown
                const baseFare = this.config.pricing.baseFare;
                const distanceFare = ride.fare - baseFare > 0 ? ride.fare - baseFare : 0;
                const serviceFee = ride.fare * 0.1; // 10% service fee
                const discount = ride.promoCode ? ride.fare * 0.2 : 0;
                const total = ride.fare + serviceFee - discount;

                document.getElementById('receiptBaseFare').textContent = `ZMW ${baseFare.toFixed(2)}`;
                document.getElementById('receiptDistanceFare').textContent = `ZMW ${distanceFare.toFixed(2)}`;
                document.getElementById('receiptServiceFee').textContent = `ZMW ${serviceFee.toFixed(2)}`;
                document.getElementById('receiptDiscount').textContent = `ZMW ${discount.toFixed(2)}`;
                document.getElementById('receiptTotal').textContent = `ZMW ${total.toFixed(2)}`;

                // Show modal
                document.getElementById('receiptModal').classList.remove('hidden');

                // Setup download button
                document.getElementById('downloadReceiptBtn').onclick = () => {
                    this.downloadReceipt(ride, total, serviceFee, discount);
                };

            } catch (error) {
                console.error('Error showing receipt:', error);
                this.showNotification('Failed to load receipt', 'error');
            }
        }

        downloadReceipt(ride, total, serviceFee, discount) {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Add receipt content
                doc.setFontSize(20);
                doc.setTextColor(255, 107, 53);
                doc.text('JUBEL RIDE RECEIPT', 105, 20, { align: 'center' });

                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                
                let y = 40;
                const lineHeight = 7;

                doc.text(`Receipt No: ${ride.id.substring(0, 8).toUpperCase()}`, 20, y);
                y += lineHeight;
                
                doc.text(`Date: ${new Date(ride.timestamp).toLocaleDateString()}`, 20, y);
                y += lineHeight;
                
                doc.text(`Passenger: ${ride.passengerName}`, 20, y);
                y += lineHeight;
                
                doc.text(`Driver: ${ride.driverName || 'Not assigned'}`, 20, y);
                y += lineHeight;
                
                doc.text(`Vehicle: ${ride.vehicleDetails || 'Not specified'}`, 20, y);
                y += lineHeight;
                
                doc.text(`Pickup: ${ride.pickupLocation}`, 20, y);
                y += lineHeight;
                
                doc.text(`Destination: ${ride.destination}`, 20, y);
                y += lineHeight * 2;

                // Fare breakdown
                doc.setFont(undefined, 'bold');
                doc.text('Fare Breakdown:', 20, y);
                y += lineHeight;
                doc.setFont(undefined, 'normal');

                doc.text(`Base Fare: ZMW ${this.config.pricing.baseFare.toFixed(2)}`, 30, y);
                y += lineHeight;
                
                const distanceFare = ride.fare - this.config.pricing.baseFare > 0 ? ride.fare - this.config.pricing.baseFare : 0;
                doc.text(`Distance Fare: ZMW ${distanceFare.toFixed(2)}`, 30, y);
                y += lineHeight;
                
                doc.text(`Service Fee: ZMW ${serviceFee.toFixed(2)}`, 30, y);
                y += lineHeight;
                
                doc.text(`Discount: ZMW ${discount.toFixed(2)}`, 30, y);
                y += lineHeight * 2;

                // Total
                doc.setFont(undefined, 'bold');
                doc.text(`TOTAL: ZMW ${total.toFixed(2)}`, 20, y);
                y += lineHeight * 2;

                // Footer
                doc.setFontSize(8);
                doc.setFont(undefined, 'normal');
                doc.text('Thank you for choosing Jubel!', 105, y, { align: 'center' });
                y += lineHeight;
                doc.text('For any queries, contact: support@jubel.com', 105, y, { align: 'center' });

                // Save PDF
                doc.save(`Jubel_Receipt_${ride.id.substring(0, 8)}.pdf`);
                
                this.showNotification('Receipt downloaded successfully!', 'success');

            } catch (error) {
                console.error('Error downloading receipt:', error);
                this.showNotification('Failed to download receipt', 'error');
            }
        }

        async shareReferralCode() {
            const referralCode = this.state.userData?.referralCode || 'JUBEL-XXXX';
            const shareText = `Join me on Jubel! Use my referral code ${referralCode} for 50% off your first ride. Download the app now!`;

            try {
                if (navigator.share) {
                    await navigator.share({
                        title: 'Jubel Referral',
                        text: shareText,
                        url: window.location.href
                    });
                    this.showNotification('Referral code shared successfully!', 'success');
                } else {
                    await navigator.clipboard.writeText(shareText);
                    this.showNotification('Referral code copied to clipboard!', 'success');
                }
            } catch (error) {
                console.error('Error sharing referral:', error);
                this.showNotification('Failed to share referral code', 'error');
            }
        }

        async depositToWallet() {
            const amount = prompt('Enter deposit amount (ZMW):');
            if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
                this.showNotification('Please enter a valid amount', 'error');
                return;
            }

            const depositAmount = parseFloat(amount);
            
            try {
                const newBalance = this.state.walletBalance + depositAmount;
                
                await firebase.database().ref(`users/${this.state.currentUser.uid}`).update({
                    walletBalance: newBalance
                });

                this.state.walletBalance = newBalance;
                this.updateWalletUI();
                
                this.showNotification(`Successfully deposited ZMW ${depositAmount.toFixed(2)}`, 'success');

            } catch (error) {
                console.error('Error depositing to wallet:', error);
                this.showNotification('Failed to process deposit', 'error');
            }
        }

        async withdrawFromWallet() {
            if (this.state.walletBalance <= 0) {
                this.showNotification('Your wallet balance is zero', 'error');
                return;
            }

            const amount = prompt(`Enter withdrawal amount (ZMW). Available: ZMW ${this.state.walletBalance.toFixed(2)}:`);
            if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
                this.showNotification('Please enter a valid amount', 'error');
                return;
            }

            const withdrawalAmount = parseFloat(amount);
            
            if (withdrawalAmount > this.state.walletBalance) {
                this.showNotification('Insufficient balance', 'error');
                return;
            }

            try {
                const newBalance = this.state.walletBalance - withdrawalAmount;
                
                await firebase.database().ref(`users/${this.state.currentUser.uid}`).update({
                    walletBalance: newBalance
                });

                this.state.walletBalance = newBalance;
                this.updateWalletUI();
                
                this.showNotification(`Successfully withdrew ZMW ${withdrawalAmount.toFixed(2)}`, 'success');

            } catch (error) {
                console.error('Error withdrawing from wallet:', error);
                this.showNotification('Failed to process withdrawal', 'error');
            }
        }

        async contactDriver() {
            if (!this.state.activeRide || !this.state.activeRide.driverId) {
                this.showNotification('No driver assigned to this ride', 'error');
                return;
            }

            try {
                const driver = await this.loadDriverInfo(this.state.activeRide.driverId);
                if (driver && driver.phone) {
                    window.open(`tel:${driver.phone}`, '_self');
                } else {
                    this.showNotification('Driver phone number not available', 'error');
                }
            } catch (error) {
                console.error('Error contacting driver:', error);
                this.showNotification('Failed to contact driver', 'error');
            }
        }

        togglePanel() {
            document.getElementById('mainPanel').classList.toggle('collapsed');
        }

        showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm transition-transform transform translate-x-full`;
            
            let bgColor = 'bg-primary';
            let icon = 'info-circle';
            
            switch (type) {
                case 'success':
                    bgColor = 'bg-green-500';
                    icon = 'check-circle';
                    break;
                case 'error':
                    bgColor = 'bg-red-500';
                    icon = 'exclamation-circle';
                    break;
                case 'warning':
                    bgColor = 'bg-yellow-500';
                    icon = 'exclamation-triangle';
                    break;
            }
            
            notification.style.cssText = `
                background: ${type === 'success' ? '#2ECC71' : type === 'error' ? '#E74C3C' : type === 'warning' ? '#F39C12' : '#FF6B35'};
                color: white;
                padding: 12px 16px;
                border-radius: 12px;
                box-shadow: 0 8px 24px rgba(0,0,0,0.15);
                max-width: 320px;
                transform: translateX(400px);
                transition: transform 0.3s ease;
                z-index: 1000;
                position: fixed;
                top: 20px;
                right: 20px;
                display: flex;
                align-items: center;
                gap: 12px;
            `;
            
            notification.innerHTML = `
                <i class="fas fa-${icon}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 10);
            
            // Remove after 4 seconds
            setTimeout(() => {
                notification.style.transform = 'translateX(400px)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }

        showLoading(text = 'Loading...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        initRealTimeListeners() {
            // Listen for wallet balance changes
            if (this.state.currentUser) {
                firebase.database()
                    .ref(`users/${this.state.currentUser.uid}/walletBalance`)
                    .on('value', (snapshot) => {
                        const newBalance = snapshot.val() || 0;
                        if (newBalance !== this.state.walletBalance) {
                            this.state.walletBalance = newBalance;
                            this.updateWalletUI();
                        }
                    });
            }
        }

        extractCityFromDisplayName(displayName) {
            if (!displayName) return null;
            
            const displayLower = displayName.toLowerCase();
            for (const city of this.config.cities) {
                if (displayLower.includes(city.toLowerCase())) {
                    return city;
                }
            }
            return null;
        }
    }

    // Initialize the app when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
        const app = new AdvancedJubelApp();
        window.JubelApp = app; // Make app accessible globally for debugging
    });

    // Handle offline/online status
    window.addEventListener('online', () => {
        if (window.JubelApp) {
            window.JubelApp.showNotification('Connection restored', 'success');
        }
    });

    window.addEventListener('offline', () => {
        if (window.JubelApp) {
            window.JubelApp.showNotification('You are offline. Some features may not work.', 'warning');
        }
    });

    // Handle page visibility changes
    document.addEventListener('visibilitychange', () => {
        if (!document.hidden && window.JubelApp && window.JubelApp.state.currentScreen === 'home') {
            // Refresh location when page becomes visible
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        if (window.JubelApp) {
                            window.JubelApp.updateUserLocation(
                                position.coords.latitude,
                                position.coords.longitude
                            );
                        }
                    },
                    (error) => {
                        console.error('Error refreshing location:', error);
                    }
                );
            }
        }
    });
    </script>
</body>
</html>
