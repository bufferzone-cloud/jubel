

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jubel Passenger App</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">
    
    <style>
        /* ============================================
           GLOBAL STYLES & VARIABLES
        ============================================ */
        :root {
            --primary-orange: #FF6B35;
            --primary-orange-dark: #E55A2B;
            --primary-orange-light: #FF8B5C;
            --white: #FFFFFF;
            --background-light: #F8F9FA;
            --background-gray: #F1F3F4;
            --text-dark: #1A1A1A;
            --text-gray: #666666;
            --text-light: #999999;
            --border-color: #E0E0E0;
            --success-green: #4CAF50;
            --error-red: #F44336;
            --warning-yellow: #FFC107;
            --info-blue: #2196F3;
            --card-shadow: 0 2px 8px rgba(0,0,0,0.1);
            --card-shadow-hover: 0 4px 12px rgba(0,0,0,0.15);
            --transition: all 0.3s ease;
            --border-radius: 12px;
            --border-radius-sm: 8px;
            --border-radius-lg: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        body {
            background: var(--white);
            color: var(--text-dark);
            overflow: hidden;
            height: 100vh;
            position: relative;
        }

        /* ============================================
           MAP CONTAINER (60% OF SCREEN)
        ============================================ */
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 60vh;
            z-index: 1;
            background: var(--background-gray);
        }

        .map-loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--primary-orange);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }

        .map-loading-text {
            color: var(--text-gray);
            font-size: 14px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ============================================
           TOP NAVIGATION BAR
        ============================================ */
        .top-bar {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--card-shadow);
            z-index: 1001;
            max-width: 95%;
            margin: 0 auto;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--primary-orange);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-icon img {
            width: 30px;
            height: 30px;
            object-fit: contain;
        }

        .logo-text {
            font-weight: 600;
            font-size: 16px;
            color: var(--text-dark);
        }

        .user-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .balance-badge {
            background: var(--background-light);
            padding: 8px 12px;
            border-radius: var(--border-radius-sm);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .balance-badge i {
            color: var(--primary-orange);
        }

        .balance-amount {
            font-weight: 600;
            color: var(--primary-orange);
        }

        .notification-bell {
            position: relative;
            width: 40px;
            height: 40px;
            background: var(--background-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .notification-bell i {
            color: var(--text-gray);
            font-size: 18px;
        }

        .notification-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            background: var(--error-red);
            color: var(--white);
            font-size: 10px;
            min-width: 18px;
            height: 18px;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        /* ============================================
           CITY DETECTION INDICATOR
        ============================================ */
        .city-detection {
            position: absolute;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--white);
            padding: 8px 16px;
            border-radius: 20px;
            box-shadow: var(--card-shadow);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            z-index: 1001;
            max-width: 90%;
        }

        .city-detection i {
            color: var(--primary-orange);
        }

        /* ============================================
           RIDE STATUS BAR
        ============================================ */
        .ride-status-bar {
            position: absolute;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 12px 20px;
            box-shadow: var(--card-shadow);
            display: none;
            align-items: center;
            justify-content: space-between;
            width: 90%;
            max-width: 400px;
            z-index: 1001;
        }

        .ride-status-bar.active {
            display: flex;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .status-dot.searching {
            background: var(--warning-yellow);
            animation: pulse 1.5s infinite;
        }

        .status-dot.arriving {
            background: var(--info-blue);
            animation: pulse 1s infinite;
        }

        .status-dot.riding {
            background: var(--success-green);
        }

        .status-dot.completed {
            background: var(--success-green);
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .status-text {
            font-weight: 500;
            font-size: 14px;
        }

        .status-eta {
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--text-gray);
            font-size: 14px;
        }

        /* ============================================
           EMERGENCY STATUS
        ============================================ */
        .emergency-status {
            position: absolute;
            top: 130px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--error-red);
            color: var(--white);
            padding: 10px 20px;
            border-radius: var(--border-radius);
            display: none;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            z-index: 1001;
            animation: emergencyPulse 2s infinite;
        }

        @keyframes emergencyPulse {
            0% { background-color: var(--error-red); }
            50% { background-color: #FF5252; }
            100% { background-color: var(--error-red); }
        }

        /* ============================================
           SOS BUTTON
        ============================================ */
        .sos-button {
            position: absolute;
            bottom: 200px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: var(--error-red);
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.4);
            cursor: pointer;
            z-index: 1001;
            animation: sosPulse 2s infinite;
        }

        .sos-button i {
            color: var(--white);
            font-size: 24px;
        }

        @keyframes sosPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* ============================================
           MAP CONTROLS
        ============================================ */
        .map-controls {
            position: absolute;
            bottom: 130px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1001;
        }

        .map-control-btn {
            width: 44px;
            height: 44px;
            background: var(--white);
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--card-shadow);
            cursor: pointer;
            color: var(--text-gray);
            font-size: 18px;
            transition: var(--transition);
        }

        .map-control-btn:hover {
            background: var(--background-light);
            color: var(--primary-orange);
        }

        /* ============================================
           MAIN PANEL (40% OF SCREEN)
        ============================================ */
        .main-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 45vh;
            background: var(--white);
            border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
            z-index: 1002;
            padding: 0;
            transition: transform 0.3s ease;
            overflow: hidden;
        }

        .main-panel.collapsed {
            transform: translateY(calc(100% - 60px));
        }

        .panel-handle {
            width: 40px;
            height: 4px;
            background: var(--border-color);
            border-radius: 2px;
            margin: 12px auto;
            cursor: pointer;
        }

        .nav-tabs {
            display: flex;
            background: var(--white);
            border-bottom: 1px solid var(--border-color);
            padding: 0 16px;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 0;
            background: none;
            border: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            color: var(--text-light);
            cursor: pointer;
            font-size: 12px;
            transition: var(--transition);
        }

        .nav-tab.active {
            color: var(--primary-orange);
        }

        .nav-tab i {
            font-size: 18px;
            margin-bottom: 2px;
        }

        /* ============================================
           HOME SCREEN CONTENT
        ============================================ */
        #homeContent {
            height: calc(100% - 120px);
            overflow-y: auto;
            padding: 0 16px 20px;
        }

        .service-tabs {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin: 15px 0;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .service-tab {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            padding: 12px 5px;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: var(--transition);
        }

        .service-tab.active {
            background: var(--background-light);
        }

        .service-icon {
            width: 40px;
            height: 40px;
            background: var(--background-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 5px;
        }

        .service-tab.active .service-icon {
            background: var(--primary-orange);
            color: var(--white);
        }

        .service-name {
            font-size: 12px;
            font-weight: 500;
            text-align: center;
        }

        .service-desc {
            font-size: 10px;
            color: var(--text-light);
            text-align: center;
        }

        /* ============================================
           QUICK ACTIONS
        ============================================ */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .quick-action-btn {
            background: var(--background-light);
            border: none;
            border-radius: var(--border-radius-sm);
            padding: 12px 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: var(--transition);
        }

        .quick-action-btn:hover {
            background: #E8F0FE;
        }

        .quick-action-icon {
            width: 32px;
            height: 32px;
            background: var(--primary-orange);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
        }

        .quick-action-text {
            flex: 1;
            text-align: left;
        }

        .quick-action-title {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-dark);
        }

        .quick-action-desc {
            font-size: 10px;
            color: var(--text-light);
        }

        /* ============================================
           RIDE REQUEST FORM
        ============================================ */
        .ride-request-form {
            background: var(--white);
            margin-top: 15px;
        }

        .form-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-dark);
        }

        .form-title i {
            color: var(--primary-orange);
        }

        .location-inputs {
            background: var(--background-light);
            border-radius: var(--border-radius);
            overflow: hidden;
            margin-bottom: 20px;
        }

        .location-input {
            position: relative;
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .location-input:last-child {
            border-bottom: none;
        }

        .location-input i {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary-orange);
        }

        .location-input input {
            width: 100%;
            border: none;
            background: none;
            padding-left: 30px;
            font-size: 14px;
            color: var(--text-dark);
            outline: none;
        }

        .location-input input::placeholder {
            color: var(--text-light);
        }

        .search-loading {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            border: 2px solid var(--border-color);
            border-top: 2px solid var(--primary-orange);
            border-radius: 50%;
            display: none;
        }

        .location-input.searching .search-loading {
            display: block;
            animation: spin 1s linear infinite;
        }

        /* ============================================
           SUGGESTION LISTS
        ============================================ */
        .suggestion-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--white);
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1003;
            display: none;
        }

        .suggestion-item {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: var(--transition);
        }

        .suggestion-item:hover {
            background: var(--background-light);
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-item {
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .suggestion-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 2px;
        }

        .suggestion-details {
            flex: 1;
        }

        .suggestion-name {
            font-weight: 500;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .suggestion-address {
            font-size: 12px;
            color: var(--text-gray);
            margin-bottom: 4px;
        }

        .suggestion-distance {
            font-size: 11px;
            color: var(--primary-orange);
        }

        .suggestion-verified {
            font-size: 11px;
            color: var(--success-green);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* ============================================
           RIDE TYPE SELECTION
        ============================================ */
        .ride-type-selection {
            margin: 20px 0;
        }

        .ride-type-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-weight: 500;
        }

        .ride-type-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .ride-type-card {
            background: var(--background-light);
            border-radius: var(--border-radius-sm);
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid transparent;
        }

        .ride-type-card.selected {
            border-color: var(--primary-orange);
            background: rgba(255, 107, 53, 0.1);
        }

        .ride-type-icon {
            font-size: 24px;
            color: var(--text-gray);
            margin-bottom: 8px;
        }

        .ride-type-card.selected .ride-type-icon {
            color: var(--primary-orange);
        }

        .ride-type-name {
            font-weight: 500;
            font-size: 13px;
            margin-bottom: 5px;
        }

        .ride-type-price {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary-orange);
        }

        /* ============================================
           FARE DISPLAY
        ============================================ */
        .fare-display {
            background: var(--background-light);
            border-radius: var(--border-radius);
            padding: 16px;
            margin: 20px 0;
            text-align: center;
        }

        .fare-label {
            font-size: 13px;
            color: var(--text-gray);
            margin-bottom: 8px;
        }

        .fare-amount {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary-orange);
            margin-bottom: 8px;
        }

        .fare-details {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-gray);
        }

        /* ============================================
           ACTION BUTTONS
        ============================================ */
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            padding: 15px;
            border: none;
            border-radius: var(--border-radius-sm);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: var(--transition);
        }

        .btn-primary {
            background: var(--primary-orange);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--primary-orange-dark);
        }

        .btn-secondary {
            background: var(--background-light);
            color: var(--text-dark);
        }

        .btn-secondary:hover {
            background: #E8F0FE;
        }

        .btn-danger {
            background: var(--error-red);
            color: var(--white);
        }

        .btn-danger:hover {
            background: #D32F2F;
        }

        .btn-orange {
            background: var(--primary-orange);
            color: var(--white);
            border: none;
            padding: 8px 16px;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
        }

        /* ============================================
           PRICE CALCULATOR
        ============================================ */
        .price-calculator-display {
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 16px;
            margin: 20px 0;
        }

        .price-breakdown {
            margin-top: 10px;
        }

        .price-breakdown-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 13px;
        }

        .price-breakdown-row:last-child {
            border-bottom: none;
        }

        .price-breakdown-row.total {
            font-weight: 600;
            font-size: 14px;
            color: var(--primary-orange);
        }

        /* ============================================
           RIDE INFO PANEL
        ============================================ */
        .ride-info-panel {
            display: none;
        }

        .driver-info {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 16px;
            background: var(--background-light);
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }

        .driver-avatar {
            width: 60px;
            height: 60px;
            background: var(--primary-orange);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 24px;
        }

        .driver-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .driver-details {
            flex: 1;
        }

        .driver-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .driver-rating {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            color: var(--text-gray);
            margin-bottom: 4px;
        }

        .driver-rating i {
            color: var(--warning-yellow);
        }

        .driver-vehicle {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            color: var(--text-gray);
        }

        /* ============================================
           TIMELINE
        ============================================ */
        .timeline {
            display: flex;
            justify-content: space-between;
            position: relative;
            margin: 20px 0;
            padding: 0 10px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 20px;
            right: 20px;
            height: 2px;
            background: var(--border-color);
            z-index: 1;
        }

        .timeline-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 2;
            position: relative;
        }

        .step-dot {
            width: 32px;
            height: 32px;
            background: var(--white);
            border: 2px solid var(--border-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            color: var(--text-light);
        }

        .step-dot.active {
            border-color: var(--primary-orange);
            background: var(--primary-orange);
            color: var(--white);
        }

        .step-dot.completed {
            border-color: var(--success-green);
            background: var(--success-green);
            color: var(--white);
        }

        .step-label {
            font-size: 11px;
            color: var(--text-light);
            text-align: center;
            max-width: 60px;
        }

        .step-label.active {
            color: var(--primary-orange);
            font-weight: 500;
        }

        /* ============================================
           TRIP DETAILS
        ============================================ */
        .trip-details {
            background: var(--background-light);
            border-radius: var(--border-radius);
            padding: 16px;
            margin: 20px 0;
        }

        .trip-locations {
            position: relative;
            padding-left: 24px;
        }

        .trip-locations::before {
            content: '';
            position: absolute;
            left: 11px;
            top: 20px;
            bottom: 20px;
            width: 2px;
            background: var(--primary-orange);
        }

        .location-point {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            position: relative;
        }

        .location-point:last-child {
            margin-bottom: 0;
        }

        .location-marker {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            position: absolute;
            left: -30px;
        }

        .location-marker.pickup {
            background: var(--primary-orange);
        }

        .location-marker.destination {
            background: var(--info-blue);
        }

        .location-text {
            flex: 1;
        }

        .location-label {
            font-size: 12px;
            color: var(--text-gray);
            margin-bottom: 4px;
        }

        .location-address {
            font-size: 14px;
            font-weight: 500;
        }

        /* ============================================
           FARE BREAKDOWN
        ============================================ */
        .fare-breakdown {
            background: var(--background-light);
            border-radius: var(--border-radius);
            padding: 16px;
            margin: 20px 0;
        }

        .fare-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
        }

        .fare-row:last-child {
            border-bottom: none;
        }

        .fare-row.total {
            font-weight: 600;
            color: var(--primary-orange);
            font-size: 16px;
        }

        /* ============================================
           MODALS
        ============================================ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }

        .modal {
            background: var(--white);
            border-radius: var(--border-radius-lg);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 18px;
        }

        .modal-title i {
            color: var(--primary-orange);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--text-light);
            cursor: pointer;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .modal-close:hover {
            background: var(--background-light);
            color: var(--text-dark);
        }

        .modal-content {
            padding: 20px;
        }

        /* ============================================
           FORM GROUPS
        ============================================ */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-dark);
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            font-size: 14px;
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-orange);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* ============================================
           PAYMENT METHODS
        ============================================ */
        .payment-methods {
            margin: 20px 0;
        }

        .payment-method {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            margin-bottom: 10px;
            cursor: pointer;
            transition: var(--transition);
        }

        .payment-method.selected {
            border-color: var(--primary-orange);
            background: rgba(255, 107, 53, 0.05);
        }

        .payment-icon {
            width: 40px;
            height: 40px;
            background: var(--background-light);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-orange);
            font-size: 20px;
        }

        .payment-details {
            flex: 1;
        }

        .payment-name {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .payment-info {
            font-size: 12px;
            color: var(--text-gray);
        }

        /* ============================================
           CANCEL REASONS
        ============================================ */
        .cancel-reasons {
            margin: 20px 0;
        }

        .cancel-reason {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            margin-bottom: 10px;
            cursor: pointer;
            transition: var(--transition);
        }

        .cancel-reason.selected {
            border-color: var(--primary-orange);
            background: rgba(255, 107, 53, 0.05);
        }

        .reason-icon {
            width: 40px;
            height: 40px;
            background: var(--background-light);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-gray);
            font-size: 18px;
        }

        .cancel-reason.selected .reason-icon {
            color: var(--primary-orange);
        }

        .reason-text {
            flex: 1;
            font-size: 14px;
        }

        /* ============================================
           EMERGENCY SERVICES
        ============================================ */
        .emergency-services {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .emergency-service {
            background: var(--background-light);
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid transparent;
        }

        .emergency-service:hover {
            border-color: var(--primary-orange);
            transform: translateY(-2px);
        }

        .emergency-icon {
            width: 60px;
            height: 60px;
            background: var(--primary-orange);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            color: var(--white);
            font-size: 24px;
        }

        .emergency-service.police .emergency-icon {
            background: #2196F3;
        }

        .emergency-service.fire .emergency-icon {
            background: #FF9800;
        }

        .emergency-service.medical .emergency-icon {
            background: #F44336;
        }

        .emergency-name {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .emergency-description {
            font-size: 12px;
            color: var(--text-gray);
        }

        /* ============================================
           EMERGENCY STATIONS
        ============================================ */
        .emergency-stations {
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
        }

        .emergency-station {
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            margin-bottom: 10px;
            cursor: pointer;
            transition: var(--transition);
        }

        .emergency-station.selected {
            border-color: var(--primary-orange);
            background: rgba(255, 107, 53, 0.05);
        }

        .station-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .station-name {
            font-weight: 500;
            font-size: 14px;
        }

        .station-distance {
            font-size: 13px;
            color: var(--primary-orange);
            font-weight: 600;
        }

        .station-address {
            font-size: 13px;
            color: var(--text-gray);
            margin-bottom: 8px;
        }

        .station-details {
            display: flex;
            gap: 15px;
            font-size: 12px;
            color: var(--text-light);
        }

        /* ============================================
           CHAT CONTAINER
        ============================================ */
        .chat-container {
            position: fixed;
            bottom: 45vh;
            right: 20px;
            width: 300px;
            height: 400px;
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: none;
            flex-direction: column;
            z-index: 1003;
        }

        .chat-container.active {
            display: flex;
        }

        .chat-header {
            padding: 15px;
            background: var(--primary-orange);
            color: var(--white);
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-title {
            font-weight: 600;
        }

        .chat-close {
            background: none;
            border: none;
            color: var(--white);
            cursor: pointer;
            font-size: 18px;
        }

        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: var(--background-light);
        }

        .message {
            margin-bottom: 15px;
            max-width: 80%;
        }

        .message.sent {
            margin-left: auto;
            text-align: right;
        }

        .message.sent > div:first-child {
            background: var(--primary-orange);
            color: var(--white);
            padding: 10px 15px;
            border-radius: 18px 18px 4px 18px;
            display: inline-block;
        }

        .message.received > div:first-child {
            background: var(--white);
            color: var(--text-dark);
            padding: 10px 15px;
            border-radius: 18px 18px 18px 4px;
            display: inline-block;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .message-time {
            font-size: 10px;
            color: var(--text-light);
            margin-top: 4px;
        }

        .chat-input-container {
            display: flex;
            padding: 15px;
            border-top: 1px solid var(--border-color);
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            font-size: 14px;
        }

        .chat-send-btn {
            width: 40px;
            height: 40px;
            background: var(--primary-orange);
            border: none;
            border-radius: 50%;
            color: var(--white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ============================================
           NOTIFICATIONS PANEL
        ============================================ */
        .notifications-panel {
            position: fixed;
            top: 70px;
            right: 20px;
            width: 350px;
            max-height: 500px;
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: none;
            flex-direction: column;
            z-index: 1003;
        }

        .notifications-panel.active {
            display: flex;
        }

        .notifications-header {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notifications-title {
            font-weight: 600;
            font-size: 16px;
        }

        .notifications-close {
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            font-size: 18px;
        }

        .notifications-list {
            flex: 1;
            overflow-y: auto;
        }

        .notification-item {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: var(--transition);
        }

        .notification-item:hover {
            background: var(--background-light);
        }

        .notification-item.unread {
            background: rgba(33, 150, 243, 0.05);
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .notification-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
            font-size: 14px;
        }

        .notification-time {
            font-size: 12px;
            color: var(--text-light);
        }

        .notification-message {
            font-size: 13px;
            color: var(--text-gray);
            line-height: 1.4;
        }

        /* ============================================
           DROPDOWN MENUS
        ============================================ */
        .dropdown-menu, .more-options-menu {
            position: fixed;
            top: 70px;
            right: 20px;
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            min-width: 200px;
            z-index: 1003;
            display: none;
        }

        .dropdown-menu.active, .more-options-menu.active {
            display: block;
        }

        .dropdown-item {
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: var(--transition);
        }

        .dropdown-item:hover {
            background: var(--background-light);
        }

        .dropdown-item i {
            width: 20px;
            color: var(--text-gray);
        }

        .dropdown-item:hover i {
            color: var(--primary-orange);
        }

        /* ============================================
           HISTORY SCREEN
        ============================================ */
        .history-screen, .account-screen, .emergency-screen {
            display: none;
            height: calc(100% - 60px);
            overflow-y: auto;
            padding: 0 16px 20px;
        }

        .history-screen.active, .account-screen.active, .emergency-screen.active {
            display: block;
        }

        .screen-header {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .back-btn {
            width: 40px;
            height: 40px;
            background: var(--background-light);
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-dark);
            cursor: pointer;
            transition: var(--transition);
        }

        .back-btn:hover {
            background: #E8F0FE;
        }

        .screen-title {
            font-size: 20px;
            font-weight: 600;
        }

        .history-filters {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 15px;
            margin-bottom: 20px;
            -webkit-overflow-scrolling: touch;
        }

        .history-filters::-webkit-scrollbar {
            display: none;
        }

        .filter-btn {
            padding: 8px 16px;
            background: var(--background-light);
            border: none;
            border-radius: 20px;
            font-size: 12px;
            white-space: nowrap;
            cursor: pointer;
            transition: var(--transition);
        }

        .filter-btn.active {
            background: var(--primary-orange);
            color: var(--white);
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .history-item {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 16px;
            box-shadow: var(--card-shadow);
            cursor: pointer;
            transition: var(--transition);
        }

        .history-item:hover {
            box-shadow: var(--card-shadow-hover);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .history-type {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .history-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 18px;
        }

        .history-type-name {
            font-weight: 500;
            font-size: 14px;
        }

        .history-date {
            font-size: 12px;
            color: var(--text-gray);
        }

        .history-locations {
            margin-bottom: 15px;
        }

        .history-location {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 10px;
        }

        .history-location i {
            color: var(--text-light);
            margin-top: 2px;
        }

        .history-location-text {
            font-size: 13px;
            line-height: 1.4;
        }

        .history-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-price {
            font-weight: 600;
            font-size: 16px;
            color: var(--primary-orange);
        }

        .history-status {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 500;
        }

        .status-completed {
            background: rgba(76, 175, 80, 0.1);
            color: var(--success-green);
        }

        .status-cancelled {
            background: rgba(244, 67, 54, 0.1);
            color: var(--error-red);
        }

        .status-ongoing {
            background: rgba(255, 107, 53, 0.1);
            color: var(--primary-orange);
        }

        /* ============================================
           ACCOUNT SCREEN
        ============================================ */
        .account-header {
            text-align: center;
            padding: 20px 0;
        }

        .account-avatar {
            width: 80px;
            height: 80px;
            background: var(--primary-orange);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 32px;
            margin: 0 auto 15px;
        }

        .account-name {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .account-phone {
            color: var(--text-gray);
            font-size: 14px;
        }

        .account-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .stat-card {
            background: var(--background-light);
            border-radius: var(--border-radius);
            padding: 15px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-orange);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-gray);
        }

        .account-section {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 20px;
            margin: 20px 0;
            box-shadow: var(--card-shadow);
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            margin-bottom: 20px;
            font-size: 16px;
        }

        .section-title i {
            color: var(--primary-orange);
        }

        .wallet-balance {
            text-align: center;
            padding: 20px;
            background: var(--background-light);
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }

        .balance-label {
            font-size: 14px;
            color: var(--text-gray);
            margin-bottom: 10px;
        }

        .balance-amount-large {
            font-size: 36px;
            font-weight: 700;
            color: var(--primary-orange);
        }

        .wallet-actions {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .btn-wallet {
            background: var(--background-light);
            border: none;
            border-radius: var(--border-radius-sm);
            padding: 12px 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 12px;
        }

        .btn-wallet:hover {
            background: #E8F0FE;
        }

        .btn-wallet i {
            font-size: 18px;
            color: var(--primary-orange);
        }

        .referral-card {
            background: linear-gradient(135deg, #FFE8DC, #FFD9C8);
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }

        .referral-code {
            font-family: monospace;
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-orange);
            margin: 15px 0;
            letter-spacing: 1px;
        }

        .referral-note {
            font-size: 12px;
            color: var(--text-gray);
            margin-top: 10px;
        }

        /* ============================================
           LOADING OVERLAY
        ============================================ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        .loading-text {
            margin-top: 20px;
            font-size: 16px;
            color: var(--text-gray);
        }

        /* ============================================
           TOAST CONTAINER
        ============================================ */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 4000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 350px;
        }

        .toast {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            display: flex;
            align-items: flex-start;
            gap: 12px;
            animation: slideIn 0.3s ease;
            border-left: 4px solid var(--primary-orange);
        }

        .toast.success {
            border-left-color: var(--success-green);
        }

        .toast.error {
            border-left-color: var(--error-red);
        }

        .toast.warning {
            border-left-color: var(--warning-yellow);
        }

        .toast.info {
            border-left-color: var(--info-blue);
        }

        .toast.hiding {
            animation: slideOut 0.3s ease forwards;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .toast-icon {
            font-size: 20px;
        }

        .toast.success .toast-icon {
            color: var(--success-green);
        }

        .toast.error .toast-icon {
            color: var(--error-red);
        }

        .toast.warning .toast-icon {
            color: var(--warning-yellow);
        }

        .toast.info .toast-icon {
            color: var(--info-blue);
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .toast-message {
            font-size: 13px;
            color: var(--text-gray);
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            font-size: 16px;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: var(--transition);
        }

        .toast-close:hover {
            background: var(--background-light);
            color: var(--text-dark);
        }

        /* ============================================
           REAL-TIME INDICATOR
        ============================================ */
        .real-time-indicator {
            position: fixed;
            bottom: 50vh;
            left: 20px;
            background: var(--white);
            padding: 8px 12px;
            border-radius: 20px;
            box-shadow: var(--card-shadow);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--text-gray);
            z-index: 1001;
            display: none;
        }

        .real-time-indicator.active {
            display: flex;
        }

        .real-time-indicator i {
            color: var(--primary-orange);
            animation: spin 2s linear infinite;
        }

        /* ============================================
           SYNC INDICATOR
        ============================================ */
        .sync-indicator {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--white);
            padding: 8px 16px;
            border-radius: 20px;
            box-shadow: var(--card-shadow);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--text-gray);
            z-index: 1001;
            display: none;
        }

        .sync-indicator.active {
            display: flex;
        }

        .sync-indicator.syncing .sync-icon {
            animation: spin 1s linear infinite;
        }

        /* ============================================
           SHARE RIDE STATUS
        ============================================ */
        .share-ride-status {
            background: var(--background-light);
            border-radius: var(--border-radius);
            padding: 15px;
            margin: 15px 0;
        }

        /* ============================================
           BROADCAST FEATURE
        ============================================ */
        .broadcast-feature {
            background: var(--background-light);
            border-radius: var(--border-radius);
            padding: 15px;
            margin: 15px 0;
        }

        .broadcast-feature-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .broadcast-feature-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
        }

        .broadcast-status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--text-light);
        }

        .broadcast-status-indicator.active {
            background: var(--success-green);
            animation: pulse 2s infinite;
        }

        .broadcast-status-indicator.inactive {
            background: var(--text-light);
        }

        .broadcast-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .broadcast-input-group input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            font-size: 14px;
        }

        .broadcast-btn {
            width: 40px;
            height: 40px;
            background: var(--primary-orange);
            border: none;
            border-radius: var(--border-radius-sm);
            color: var(--white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .broadcast-recipients {
            max-height: 150px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .broadcast-recipient {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: var(--white);
            border-radius: var(--border-radius-sm);
            margin-bottom: 8px;
        }

        .recipient-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .recipient-avatar {
            width: 36px;
            height: 36px;
            background: var(--primary-orange);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-weight: 600;
        }

        .recipient-name {
            font-weight: 500;
            font-size: 14px;
        }

        .recipient-status {
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 500;
        }

        .status-joined {
            background: rgba(76, 175, 80, 0.1);
            color: var(--success-green);
        }

        .status-pending {
            background: rgba(255, 107, 53, 0.1);
            color: var(--primary-orange);
        }

        /* ============================================
           EMERGENCY CONTACT DISPLAY
        ============================================ */
        .emergency-contact-display {
            background: rgba(244, 67, 54, 0.05);
            border: 1px solid rgba(244, 67, 54, 0.2);
            border-radius: var(--border-radius);
            padding: 15px;
            margin: 15px 0;
        }

        .emergency-contact-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            color: var(--error-red);
        }

        .emergency-contact-title {
            font-weight: 500;
            font-size: 14px;
        }

        .emergency-contact-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--white);
            border-radius: var(--border-radius-sm);
            margin-bottom: 10px;
        }

        .contact-info {
            flex: 1;
        }

        .contact-name {
            font-weight: 500;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .contact-phone {
            font-size: 13px;
            color: var(--text-gray);
        }

        .contact-action-btn {
            width: 40px;
            height: 40px;
            background: var(--error-red);
            border: none;
            border-radius: 50%;
            color: var(--white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ============================================
           SCHEDULE COUNTDOWN
        ============================================ */
        .schedule-countdown {
            position: fixed;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--white);
            padding: 15px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1003;
            min-width: 300px;
            text-align: center;
        }

        .countdown-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
            font-weight: 500;
        }

        .countdown-timer {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .time-unit {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .time-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary-orange);
            min-width: 50px;
        }

        .time-label {
            font-size: 11px;
            color: var(--text-gray);
            margin-top: 4px;
        }

        .time-separator {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-light);
            margin: 0 5px;
        }

        /* ============================================
           RESPONSIVE DESIGN
        ============================================ */
        @media (max-width: 768px) {
            .service-tabs {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }
            
            .quick-actions {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .action-buttons {
                grid-template-columns: 1fr;
            }
            
            .modal {
                width: 95%;
                max-height: 85vh;
            }
            
            .emergency-services {
                grid-template-columns: 1fr;
            }
            
            .account-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .wallet-actions {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .history-filters {
                padding-bottom: 10px;
                margin-bottom: 15px;
            }
            
            .filter-btn {
                padding: 6px 12px;
                font-size: 11px;
            }
            
            .chat-container {
                width: 280px;
                height: 350px;
            }
            
            .notifications-panel {
                width: 300px;
            }
        }

        @media (max-width: 480px) {
            .service-tabs {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .ride-type-cards {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .quick-actions {
                grid-template-columns: 1fr;
            }
            
            .account-stats {
                grid-template-columns: 1fr;
            }
            
            .wallet-actions {
                grid-template-columns: 1fr;
            }
            
            .history-filters {
                flex-wrap: nowrap;
                overflow-x: auto;
            }
            
            .modal {
                width: 100%;
                height: 100%;
                max-height: 100vh;
                border-radius: 0;
            }
            
            .modal-overlay {
                padding: 0;
            }
        }

        /* ============================================
           CUSTOM MAP MARKERS
        ============================================ */
        .current-location-marker {
            background: var(--primary-orange);
            border-radius: 50%;
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .pickup-marker {
            color: var(--primary-orange);
            font-size: 24px;
            text-shadow: 0 0 3px var(--white);
        }

        .destination-marker {
            color: var(--info-blue);
            font-size: 24px;
            text-shadow: 0 0 3px var(--white);
        }

        .driver-marker {
            color: var(--primary-orange);
            font-size: 24px;
            text-shadow: 0 0 3px var(--white);
            animation: driverMove 2s infinite alternate;
        }

        @keyframes driverMove {
            from { transform: translateY(0); }
            to { transform: translateY(-5px); }
        }

        .emergency-vehicle-marker {
            background: var(--error-red);
            border-radius: 50%;
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            box-shadow: 0 0 10px rgba(244, 67, 54, 0.5);
        }

        /* ============================================
           PULSING RIDE ICON
        ============================================ */
        .pulsing-ride-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--primary-orange);
            font-size: 60px;
            z-index: 1000;
            pointer-events: none;
            animation: ridePulse 1.5s infinite;
            text-shadow: 0 0 20px rgba(255, 107, 53, 0.5);
        }

        @keyframes ridePulse {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(1.1); opacity: 0.8; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- The HTML structure remains exactly as you provided -->
    <!-- Map Container -->
    <div id="map">
        <div class="map-loading-overlay" id="mapLoadingOverlay">
            <div class="loading-spinner"></div>
            <div class="map-loading-text">Loading map...</div>
        </div>
    </div>
    
    <!-- Top Navigation Bar -->
    <div class="top-bar">
        <div class="logo-container">
            <div class="logo-icon">
                <img src="jubel.png" alt="Jubel Logo" id="jubelLogo">
            </div>
            <div class="logo-text" id="userFullName">Loading...</div>
        </div>
        
        <div class="user-actions">
            <div class="balance-badge" id="balanceBadge">
                <i class="fas fa-wallet"></i>
                <span>Balance: <span class="balance-amount" id="walletBalance">ZMW 0.00</span></span>
            </div>
            <div class="notification-bell" id="notificationBell">
                <i class="fas fa-bell"></i>
                <span class="notification-badge" id="notificationCount">0</span>
            </div>
        </div>
    </div>
    
    <!-- City Detection Indicator -->
    <div class="city-detection" id="cityDetection">
        <i class="fas fa-map-marker-alt"></i>
        <span id="currentCityDisplay">Detecting your city...</span>
    </div>
    
    <!-- Ride Status Bar -->
    <div class="ride-status-bar" id="rideStatusBar">
        <div class="status-indicator">
            <div class="status-dot searching" id="statusDot"></div>
            <span class="status-text" id="statusText">Searching for driver</span>
        </div>
        <div class="status-eta">
            <i class="fas fa-clock"></i>
            <span id="etaText">5 min</span>
        </div>
    </div>
    
    <!-- Emergency Status -->
    <div class="emergency-status" id="emergencyStatus">
        <i class="fas fa-exclamation-triangle"></i>
        <span>EMERGENCY RIDE IN PROGRESS</span>
    </div>
    
    <!-- SOS Button -->
    <div class="sos-button" id="sosButton">
        <i class="fas fa-exclamation-triangle"></i>
    </div>
    
    <!-- Map Controls -->
    <div class="map-controls">
        <button class="map-control-btn" id="locateMeBtn" title="Locate Me">
            <i class="fas fa-location-arrow"></i>
        </button>
        <button class="map-control-btn" id="zoomInBtn" title="Zoom In">
            <i class="fas fa-plus"></i>
        </button>
        <button class="map-control-btn" id="zoomOutBtn" title="Zoom Out">
            <i class="fas fa-minus"></i>
        </button>
        <button class="map-control-btn" id="clearRouteBtn" title="Clear Route">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <!-- Chat Container -->
    <div class="chat-container" id="chatContainer">
        <div class="chat-header">
            <div class="chat-title">Chat with Driver</div>
            <button class="chat-close" id="chatClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <!-- Messages will be inserted here -->
        </div>
        <div class="chat-typing-indicator" id="typingIndicator">
            Driver is typing...
        </div>
        <div class="chat-input-container">
            <button class="chat-attachment-btn" id="attachmentBtn">
                <i class="fas fa-paperclip"></i>
            </button>
            <input type="text" class="chat-input" id="chatInput" placeholder="Type your message...">
            <button class="chat-send-btn" id="chatSend">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
    
    <!-- Notifications Panel -->
    <div class="notifications-panel" id="notificationsPanel">
        <div class="notifications-header">
            <div class="notifications-title">Notifications</div>
            <button class="notifications-close" id="notificationsClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="notifications-list" id="notificationsList">
            <!-- Notifications will be inserted here -->
        </div>
    </div>
    
    <!-- Dropdown Menu -->
    <div class="dropdown-menu" id="dropdownMenu">
        <div class="dropdown-item" data-action="profile">
            <i class="fas fa-user"></i>
            <span>Profile</span>
        </div>
        <div class="dropdown-item" data-action="settings">
            <i class="fas fa-cog"></i>
            <span>Settings</span>
        </div>
        <div class="dropdown-item" data-action="help">
            <i class="fas fa-question-circle"></i>
            <span>Help & Support</span>
        </div>
        <div class="dropdown-item" data-action="logout">
            <i class="fas fa-sign-out-alt"></i>
            <span>Logout</span>
        </div>
    </div>
    
    <!-- More Options Menu -->
    <div class="more-options-menu" id="moreOptionsMenu">
        <div class="dropdown-item" data-option="schedule">
            <i class="fas fa-calendar-alt"></i>
            <span>Schedule Ride</span>
        </div>
        <div class="dropdown-item" data-option="orderForSomeone">
            <i class="fas fa-user-friends"></i>
            <span>Order for Someone</span>
        </div>
        <div class="dropdown-item" data-option="shareRide">
            <i class="fas fa-share-alt"></i>
            <span>Share Ride</span>
        </div>
        <div class="dropdown-item" data-option="broadcast">
            <i class="fas fa-broadcast-tower"></i>
            <span>Broadcast Ride</span>
        </div>
    </div>
    
    <!-- Main Panel -->
    <div class="main-panel" id="mainPanel">
        <div class="panel-handle" id="panelHandle"></div>
        
        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" data-screen="home">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </button>
            <button class="nav-tab" data-screen="history">
                <i class="fas fa-history"></i>
                <span>History</span>
            </button>
            <button class="nav-tab" data-screen="account">
                <i class="fas fa-user"></i>
                <span>Account</span>
            </button>
            <button class="nav-tab" data-screen="emergency">
                <i class="fas fa-ambulance"></i>
                <span>Emergency</span>
            </button>
        </div>
        
        <!-- Home Screen Content -->
        <div id="homeContent">
            <!-- Service Tabs -->
            <div class="service-tabs" id="serviceTabs">
                <div class="service-tab car active" data-service="car">
                    <div class="service-icon">
                        <i class="fas fa-car"></i>
                    </div>
                    <div class="service-name">Car</div>
                    <div class="service-desc">Ride anywhere</div>
                </div>
                
                <div class="service-tab delivery" data-service="delivery">
                    <div class="service-icon">
                        <i class="fas fa-shipping-fast"></i>
                    </div>
                    <div class="service-name">Delivery</div>
                    <div class="service-desc">Send packages</div>
                </div>
                
                <div class="service-tab short-delivery" data-service="short-delivery">
                    <div class="service-icon">
                        <i class="fas fa-bicycle"></i>
                    </div>
                    <div class="service-name">Short Delivery</div>
                    <div class="service-desc">Quick deliveries</div>
                </div>
                
                <div class="service-tab" data-service="express">
                    <div class="service-icon">
                        <i class="fas fa-shopping-bag"></i>
                    </div>
                    <div class="service-name">Express Shopping</div>
                    <div class="service-desc">Shop for you</div>
                </div>
                
                <div class="service-tab" data-service="truck">
                    <div class="service-icon">
                        <i class="fas fa-truck"></i>
                    </div>
                    <div class="service-name">Truck</div>
                    <div class="service-desc">Move items</div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="quick-actions">
                <button class="quick-action-btn" id="moreOptionsBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-ellipsis-h"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">More Options</div>
                        <div class="quick-action-desc">Schedule, share, broadcast</div>
                    </div>
                </button>
                <button class="quick-action-btn" id="broadcastRideBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-broadcast-tower"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">Broadcast Ride</div>
                        <div class="quick-action-desc">Share with friends</div>
                    </div>
                </button>
                <button class="quick-action-btn" id="sosSetupBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">SOS Setup</div>
                        <div class="quick-action-desc">Emergency contacts</div>
                    </div>
                </button>
                <button class="quick-action-btn" id="recentDestinationsBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-history"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">Recent Destinations</div>
                        <div class="quick-action-desc">Quick access</div>
                    </div>
                </button>
            </div>
            
            <!-- Car Service Form (Default) -->
            <div class="ride-request-form active" id="carForm">
                <div class="form-title">
                    <i class="fas fa-car"></i>
                    Book a Ride
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="pickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="pickupLocation" placeholder="Current location" readonly>
                        <div class="search-loading" id="searchLoading"></div>
                        <div class="suggestion-list" id="pickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="destinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="destinationLocation" placeholder="Where to?" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="destinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Stops Container -->
                <div id="stopsContainer" style="margin: 10px 0;"></div>
                <button type="button" class="btn btn-secondary" id="addStopBtn" style="width: 100%; margin-bottom: 15px;">
                    <i class="fas fa-plus"></i> Add Stop
                </button>
                
                <!-- Search History -->
                <div class="search-history" id="searchHistory" style="display: none;"></div>
                
                <!-- Ride Type Selection -->
                <div class="ride-type-selection" id="rideTypeSelection">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                        <span id="rideTypeInfo" style="font-size: 11px; color: var(--text-light); cursor: pointer;">
                            <i class="fas fa-info-circle"></i>
                        </span>
                    </div>
                    
                    <!-- Ride Type Cards will be inserted here by JavaScript -->
                    <div class="ride-type-cards" id="rideTypeCardsContainer"></div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="fareDisplay">
                    <div class="fare-label">Estimated Fare</div>
                    <div class="fare-amount" id="estimatedFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="distanceDetail">0 km</span>
                        <span id="timeDetail">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Price Calculator Display -->
                <div class="price-calculator-display" id="priceCalculator" style="display: none;">
                    <div class="fare-label">Fare Breakdown</div>
                    <div class="fare-amount" id="calculatedFare">ZMW 0.00</div>
                    <div class="price-breakdown" id="priceBreakdown">
                        <!-- Breakdown will be inserted here -->
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestRideBtn">
                        <i class="fas fa-search"></i>
                        Request Ride
                    </button>
                </div>
            </div>
            
            <!-- Delivery Service Form -->
            <div class="service-form delivery-form" id="deliveryForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-shipping-fast"></i>
                    Package Delivery
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="deliveryPickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="deliveryPickup" placeholder="Pickup location" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="deliveryPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="deliveryDestinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="deliveryDestination" placeholder="Delivery address" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="deliveryDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Delivery Details -->
                <div class="form-group">
                    <label class="form-label">Parcel Description</label>
                    <input type="text" class="form-control" id="parcelDescription" placeholder="What are you sending?">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Receiver's Details</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="receiverName" placeholder="Receiver name">
                        <input type="tel" class="form-control" id="receiverPhone" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Parcel Value (ZMW)</label>
                    <input type="number" class="form-control" id="parcelValue" placeholder="Value of parcel" min="0" step="0.01">
                </div>
                
                <!-- Delivery Options -->
                <div class="form-group">
                    <label class="form-label">Delivery Type</label>
                    <div style="display: flex; gap: 10px;">
                        <button class="filter-btn active" id="standardDelivery">Standard</button>
                        <button class="filter-btn" id="expressDelivery">Express</button>
                        <button class="filter-btn" id="sameDayDelivery">Same Day</button>
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="deliveryFareDisplay" style="display: none;">
                    <div class="fare-label">Delivery Fare</div>
                    <div class="fare-amount" id="deliveryFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="deliveryDistance">0 km</span>
                        <span id="deliveryTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestDeliveryBtn">
                        <i class="fas fa-shipping-fast"></i>
                        Request Delivery
                    </button>
                </div>
            </div>
            
            <!-- Short Delivery Form -->
            <div class="service-form delivery-form" id="shortDeliveryForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-bicycle"></i>
                    Short Delivery
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="shortDeliveryPickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="shortDeliveryPickup" placeholder="Pickup location" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shortDeliveryPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="shortDeliveryDestinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="shortDeliveryDestination" placeholder="Delivery address" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shortDeliveryDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Delivery Details -->
                <div class="form-group">
                    <label class="form-label">What are you sending?</label>
                    <input type="text" class="form-control" id="shortParcelDescription" placeholder="Food, documents, small items...">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Receiver's Phone</label>
                    <input type="tel" class="form-control" id="shortReceiverPhone" placeholder="Receiver phone number">
                </div>
                
                <!-- Quick Options -->
                <div class="form-group">
                    <label class="form-label">Quick Options</label>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <span class="filter-btn">Food</span>
                        <span class="filter-btn">Documents</span>
                        <span class="filter-btn">Medication</span>
                        <span class="filter-btn">Small Package</span>
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="shortDeliveryFareDisplay" style="display: none;">
                    <div class="fare-label">Delivery Fare</div>
                    <div class="fare-amount" id="shortDeliveryFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="shortDeliveryDistance">0 km</span>
                        <span id="shortDeliveryTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestShortDeliveryBtn">
                        <i class="fas fa-bolt"></i>
                        Quick Delivery
                    </button>
                </div>
            </div>
            
            <!-- Express Shopping Form -->
            <div class="service-form express-form" id="expressForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-shopping-bag"></i>
                    Express Shopping
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="shopNameInput">
                        <i class="fas fa-store"></i>
                        <input type="text" id="shopName" placeholder="Shop/Restaurant name" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shopSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="shopLocation" placeholder="Shop location" readonly>
                    </div>
                </div>
                
                <!-- Items List -->
                <div class="form-group">
                    <label class="form-label">Shopping List</label>
                    <div class="item-list" id="shoppingItems">
                        <div class="item-entry">
                            <input type="text" class="item-input" placeholder="Item name">
                            <button class="remove-item" type="button">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <button class="add-item" type="button" id="addItemBtn">
                        <i class="fas fa-plus"></i>
                        Add Item
                    </button>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Special Instructions</label>
                    <textarea class="form-control form-textarea" id="shoppingInstructions" placeholder="Any specific requests or instructions..."></textarea>
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="shoppingDestinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="shoppingDestination" placeholder="Delivery address" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shoppingDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Budget -->
                <div class="form-group">
                    <label class="form-label">Estimated Budget (ZMW)</label>
                    <input type="number" class="form-control" id="shoppingBudget" placeholder="Estimated cost of items">
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="shoppingFareDisplay" style="display: none;">
                    <div class="fare-label">Shopping Service Fare</div>
                    <div class="fare-amount" id="shoppingFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="shoppingDistance">0 km</span>
                        <span id="shoppingTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestShoppingBtn">
                        <i class="fas fa-shopping-cart"></i>
                        Request Shopping
                    </button>
                </div>
            </div>
            
            <!-- Truck Delivery Form -->
            <div class="service-form truck-form" id="truckForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-truck"></i>
                    Truck Delivery
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="truckPickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="truckPickup" placeholder="Pickup location (Current location)" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="truckPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="truckDestinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="truckDestination" placeholder="Destination" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="truckDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Truck Type Selection -->
                <div class="form-group">
                    <label class="form-label">Select Truck Type</label>
                    <div class="truck-types">
                        <div class="truck-type" data-type="pickup">
                            <div class="truck-icon">
                                <i class="fas fa-truck-pickup"></i>
                            </div>
                            <div class="truck-name">Pickup Truck</div>
                            <div class="truck-capacity">Up to 1.5 tons</div>
                        </div>
                        
                        <div class="truck-type selected" data-type="light">
                            <div class="truck-icon">
                                <i class="fas fa-truck-moving"></i>
                            </div>
                            <div class="truck-name">Light Truck</div>
                            <div class="truck-capacity">Up to 3 tons</div>
                        </div>
                        
                        <div class="truck-type" data-type="medium">
                            <div class="truck-icon">
                                <i class="fas fa-truck"></i>
                            </div>
                            <div class="truck-name">Medium Truck</div>
                            <div class="truck-capacity">Up to 7 tons</div>
                        </div>
                        
                        <div class="truck-type" data-type="heavy">
                            <div class="truck-icon">
                                <i class="fas fa-truck-loading"></i>
                            </div>
                            <div class="truck-name">Heavy Truck</div>
                            <div class="truck-capacity">Up to 15 tons</div>
                        </div>
                    </div>
                </div>
                
                <!-- Item Details -->
                <div class="form-group">
                    <label class="form-label">What are you moving?</label>
                    <input type="text" class="form-control" id="truckItemDescription" placeholder="Furniture, boxes, equipment...">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Estimated Weight (kg)</label>
                    <input type="number" class="form-control" id="estimatedWeight" placeholder="Approximate weight">
                </div>
                
                <!-- Additional Help -->
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="needHelpers">
                        <span style="margin-left: 8px;">Need loading/unloading helpers (+ZMW 50)</span>
                    </label>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="truckFareDisplay" style="display: none;">
                    <div class="fare-label">Truck Fare</div>
                    <div class="fare-amount" id="truckFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="truckDistance">0 km</span>
                        <span id="truckTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestTruckBtn">
                        <i class="fas fa-truck"></i>
                        Request Truck
                    </button>
                </div>
            </div>
            
            <!-- Ride Info Panel -->
            <div class="ride-info-panel" id="rideInfoPanel" style="display: none;">
                <div class="driver-info">
                    <div class="driver-avatar" id="driverAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="driver-details">
                        <div class="driver-name" id="driverName">Driver Name</div>
                        <div class="driver-rating">
                            <i class="fas fa-star"></i>
                            <span id="driverRating">4.8</span>
                        </div>
                        <div class="driver-vehicle">
                            <i class="fas fa-car"></i>
                            <span id="vehicleDetails">Toyota Corolla - ABC 123</span>
                        </div>
                    </div>
                </div>
                
                <!-- Driver Media Display -->
                <div class="driver-media" id="driverMedia">
                    <div class="media-container">
                        <div class="media-placeholder" id="driverImagePlaceholder">
                            <i class="fas fa-user"></i>
                            <span>Driver Image</span>
                        </div>
                        <img id="driverImage" style="display: none;">
                    </div>
                    <div class="media-container">
                        <div class="media-placeholder" id="vehicleImagePlaceholder">
                            <i class="fas fa-car"></i>
                            <span>Vehicle Image</span>
                        </div>
                        <img id="vehicleImage" style="display: none;">
                    </div>
                </div>
                
                <!-- Tracking Info -->
                <div class="tracking-info" id="trackingInfo">
                    <div class="tracking-header">
                        <div class="tracking-title">Driver Distance</div>
                        <div class="tracking-distance" id="driverDistance">0 km</div>
                    </div>
                    <div class="tracking-progress">
                        <div class="tracking-progress-bar" id="trackingProgress" style="width: 0%"></div>
                    </div>
                    <div class="tracking-details">
                        <span id="pickupDistance">0 km to pickup</span>
                        <span id="etaToPickup">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Timeline -->
                <div class="timeline" id="rideTimeline">
                    <div class="timeline-step">
                        <div class="step-dot active" id="stepRequested">
                            <i class="fas fa-search"></i>
                        </div>
                        <div class="step-label active">Requested</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepAccepted">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <div class="step-label">Accepted</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepArrived">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="step-label">Arrived</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepStarted">
                            <i class="fas fa-play"></i>
                        </div>
                        <div class="step-label">Started</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepCompleted">
                            <i class="fas fa-flag-checkered"></i>
                        </div>
                        <div class="step-label">Completed</div>
                    </div>
                </div>
                
                <!-- Ride Stops -->
                <div class="ride-stops" id="rideStopsContainer" style="display: none; margin-top: 15px;">
                    <div class="section-title" style="font-size: 14px; color: var(--text-gray); margin-bottom: 10px;">
                        <i class="fas fa-map-pin"></i> Stops
                    </div>
                    <div id="rideStopsList"></div>
                </div>
                
                <div class="trip-details">
                    <div class="trip-locations">
                        <div class="location-point">
                            <div class="location-marker pickup">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="location-text">
                                <div class="location-label">Pickup</div>
                                <div class="location-address" id="currentPickup">Loading...</div>
                            </div>
                        </div>
                        
                        <div class="location-point">
                            <div class="location-marker destination">
                                <i class="fas fa-flag"></i>
                            </div>
                            <div class="location-text">
                                <div class="location-label">Destination</div>
                                <div class="location-address" id="currentDestination">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Location Details -->
                <div class="location-details">
                    <div class="location-detail-item">
                        <div class="location-detail-icon">
                            <i class="fas fa-road"></i>
                        </div>
                        <div class="location-detail-content">
                            <div class="location-detail-label">Distance</div>
                            <div class="location-detail-value" id="rideDistance">0 km</div>
                        </div>
                    </div>
                    <div class="location-detail-item">
                        <div class="location-detail-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="location-detail-content">
                            <div class="location-detail-label">Estimated Time</div>
                            <div class="location-detail-value" id="rideTime">0 min</div>
                        </div>
                    </div>
                </div>
                
                <div class="fare-breakdown">
                    <div class="fare-row">
                        <span class="fare-label">Base Fare</span>
                        <span class="fare-value" id="baseFareValue">ZMW 15.00</span>
                    </div>
                    <div class="fare-row">
                        <span class="fare-label">Distance</span>
                        <span class="fare-value" id="distanceFareValue">ZMW 5.00</span>
                    </div>
                    <div class="fare-row">
                        <span class="fare-label">Ride Type</span>
                        <span class="fare-value" id="rideTypeValue">Standard</span>
                    </div>
                    <div class="fare-row total">
                        <span class="fare-label">Total Fare</span>
                        <span class="fare-value" id="totalFareValue">ZMW 20.00</span>
                    </div>
                </div>
                
                <!-- Emergency Contact Display -->
                <div class="emergency-contact-display" id="emergencyContactDisplay" style="display: none;">
                    <div class="emergency-contact-header">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div class="emergency-contact-title">Emergency Contacts</div>
                    </div>
                    <div class="emergency-contact-item">
                        <div class="contact-info">
                            <div class="contact-name" id="emergencyContact1Name">Contact 1</div>
                            <div class="contact-phone" id="emergencyContact1Phone">000-000-0000</div>
                        </div>
                        <button class="contact-action-btn" id="emergencyContact1Btn">
                            <i class="fas fa-phone"></i>
                        </button>
                    </div>
                    <div class="emergency-contact-item">
                        <div class="contact-info">
                            <div class="contact-name" id="emergencyContact2Name">Contact 2</div>
                            <div class="contact-phone" id="emergencyContact2Phone">000-000-0000</div>
                        </div>
                        <button class="contact-action-btn" id="emergencyContact2Btn">
                            <i class="fas fa-phone"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Broadcast Feature -->
                <div class="broadcast-feature" id="broadcastFeature" style="display: none;">
                    <div class="broadcast-feature-header">
                        <div class="broadcast-feature-title">
                            <i class="fas fa-broadcast-tower"></i>
                            <span>Broadcast Ride</span>
                        </div>
                        <div class="broadcast-status-indicator inactive" id="broadcastStatusIndicator"></div>
                    </div>
                    <div class="broadcast-form">
                        <div class="broadcast-input-group">
                            <input type="text" id="broadcastMemberInput" placeholder="Enter friend's referral code">
                            <button class="broadcast-btn" id="addBroadcastMemberBtn">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div class="broadcast-recipients" id="broadcastMembersContainer">
                            <!-- Recipients will be inserted here -->
                        </div>
                        <button class="btn btn-secondary" id="startBroadcastBtn">
                            <i class="fas fa-play"></i>
                            Start Broadcasting
                        </button>
                    </div>
                </div>

                <!-- Share Ride Status -->
                <div class="share-ride-status" id="shareRideStatus" style="display: none;"></div>
                
                <div class="action-buttons">
                    <button class="btn btn-danger" id="cancelRideBtn">
                        <i class="fas fa-times-circle"></i>
                        Cancel Ride
                    </button>
                    <button class="btn btn-secondary" id="contactDriverBtn">
                        <i class="fas fa-phone"></i>
                        Call Driver
                    </button>
                    <button class="btn btn-secondary" id="openChatBtn">
                        <i class="fas fa-comment"></i>
                        Chat
                    </button>
                </div>
            </div>
            
            <!-- Broadcast Ride Form -->
            <div class="service-form" id="broadcastForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-broadcast-tower"></i>
                    Broadcast Ride
                </div>
                
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="broadcastPickup" placeholder="Pickup location" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="broadcastPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="broadcastDestination" placeholder="Destination" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="broadcastDestinationSuggestions"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Passenger Phone Numbers (comma separated)</label>
                    <textarea class="form-control form-textarea" id="broadcastPassengers" placeholder="Enter phone numbers of passengers to share this ride with..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Ride Type</label>
                    <select class="form-control" id="broadcastRideType">
                        <option value="standard">Standard</option>
                        <option value="economy">Economy</option>
                        <option value="premium">Premium</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Split Fare</label>
                    <select class="form-control" id="broadcastSplitType">
                        <option value="equal">Equal Split</option>
                        <option value="you_pay_more">You Pay 70%</option>
                        <option value="you_pay_all">You Pay All</option>
                    </select>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="broadcastFareDisplay" style="display: none;">
                    <div class="fare-label">Broadcast Fare</div>
                    <div class="fare-amount" id="broadcastFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="broadcastDistance">0 km</span>
                        <span id="broadcastTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="startBroadcastRideBtn">
                        <i class="fas fa-broadcast-tower"></i>
                        Start Broadcast
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- History Screen -->
    <div class="history-screen" id="historyScreen" style="display: none;">
        <div class="screen-header">
            <button class="back-btn" data-screen="home">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="screen-title">Ride History</div>
        </div>
        
        <div class="history-filters">
            <button class="filter-btn active" data-filter="all">All</button>
            <button class="filter-btn" data-filter="completed">Completed</button>
            <button class="filter-btn" data-filter="cancelled">Cancelled</button>
            <button class="filter-btn" data-filter="scheduled">Scheduled</button>
            <button class="filter-btn" data-filter="emergency">Emergency</button>
            <button class="filter-btn" data-filter="delivery">Delivery</button>
            <button class="filter-btn" data-filter="truck">Truck</button>
            <button class="filter-btn" data-filter="broadcast">Broadcast</button>
        </div>
        
        <div class="history-list" id="historyList">
            <!-- History items will be inserted here -->
        </div>
    </div>
    
    <!-- Account Screen -->
    <div class="account-screen" id="accountScreen" style="display: none;">
        <div class="screen-header">
            <button class="back-btn" data-screen="home">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="screen-title">My Account</div>
        </div>
        
        <div class="account-header">
            <div class="account-avatar" id="accountAvatar">
                <i class="fas fa-user"></i>
            </div>
            <div class="account-name" id="accountName">Loading...</div>
            <div class="account-phone" id="accountPhone">Loading...</div>
        </div>
        
        <div class="account-stats">
            <div class="stat-card">
                <div class="stat-value" id="completedRides">0</div>
                <div class="stat-label">Completed Rides</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="cancelledRides">0</div>
                <div class="stat-label">Cancelled Rides</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalSpent">ZMW 0</div>
                <div class="stat-label">Total Spent</div>
            </div>
        </div>
        
        <div class="account-section">
            <div class="section-title">
                <i class="fas fa-wallet"></i>
                Wallet Balance
            </div>
            
            <div class="wallet-balance">
                <div class="balance-label">Available Balance</div>
                <div class="balance-amount-large" id="accountBalance">ZMW 0.00</div>
            </div>
            
            <div class="wallet-actions">
                <button class="btn-wallet" id="depositBtn">
                    <i class="fas fa-plus"></i>
                    Deposit
                </button>
                <button class="btn-wallet" id="withdrawBtn">
                    <i class="fas fa-minus"></i>
                    Withdraw
                </button>
                <button class="btn-wallet" id="transferBtn">
                    <i class="fas fa-exchange-alt"></i>
                    Transfer
                </button>
                <button class="btn-wallet" id="transactionsBtn">
                    <i class="fas fa-history"></i>
                    History
                </button>
            </div>
        </div>
        
        <div class="account-section">
            <div class="section-title">
                <i class="fas fa-gift"></i>
                Referral Program
            </div>
            
            <div class="referral-card">
                <div>Share your referral code and earn ZMW 25 for each friend's first ride</div>
                <div class="referral-code" id="referralCode">JUBEL-XXXX</div>
                <button class="btn btn-primary" id="shareReferralBtn">
                    <i class="fas fa-share"></i>
                    Share Code
                </button>
                <div class="referral-note">Your friend gets 50% off their first ride</div>
            </div>
        </div>
        
        <div class="account-section">
            <div class="section-title">
                <i class="fas fa-cog"></i>
                Settings
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-secondary" id="updateProfileBtn">
                    <i class="fas fa-user-edit"></i>
                    Update Profile
                </button>
                <button class="btn btn-secondary" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </button>
            </div>
        </div>
    </div>
    
    <!-- Emergency Screen -->
    <div class="emergency-screen" id="emergencyScreen" style="display: none;">
        <div class="screen-header">
            <button class="back-btn" data-screen="home">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="screen-title">Emergency Services</div>
        </div>
        
        <div class="emergency-services">
            <div class="emergency-service police" data-type="police">
                <div class="emergency-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <div class="emergency-name">Police Ride</div>
                <div class="emergency-description">Emergency transport with police escort</div>
            </div>
            
            <div class="emergency-service fire" data-type="fire">
                <div class="emergency-icon">
                    <i class="fas fa-fire-extinguisher"></i>
                </div>
                <div class="emergency-name">Fire Brigade</div>
                <div class="emergency-description">Fire emergency response team</div>
            </div>
            
            <div class="emergency-service medical" data-type="medical">
                <div class="emergency-icon">
                    <i class="fas fa-ambulance"></i>
                </div>
                <div class="emergency-name">Hospital Ride</div>
                <div class="emergency-description">Medical emergency transport</div>
            </div>
            
            <div class="emergency-service" data-type="sos">
                <div class="emergency-icon" style="background: var(--error-red);">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="emergency-name">SOS Emergency</div>
                <div class="emergency-description">Immediate emergency assistance</div>
            </div>
        </div>
        
        <div class="emergency-note">
            <p><strong>Important:</strong> Only use emergency services for genuine emergencies. Misuse may result in penalties. In case of immediate danger, call 911 first.</p>
        </div>
    </div>
    
    <!-- Modals -->
    
    <!-- Payment Modal -->
    <div class="modal-overlay" id="paymentModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-credit-card"></i>
                    Select Payment Method
                </div>
                <button class="modal-close" data-modal="payment">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <div class="form-label">Available Balance: <span id="paymentBalance">ZMW 0.00</span></div>
                    <div class="form-label">Total Amount: <span id="paymentAmount">ZMW 0.00</span></div>
                </div>
                
                <!-- Referral Discount Section -->
                <div class="referral-discount-section" id="referralDiscountSection" style="display: none;">
                    <div class="section-header">
                        <i class="fas fa-gift"></i>
                        <span>Referral Discount (50% off)</span>
                    </div>
                    <div class="referral-input-group">
                        <input type="text" id="referralCodeInput" placeholder="Enter referral code">
                        <button id="applyReferralBtn" class="btn btn-orange">
                            <i class="fas fa-check"></i> Apply
                        </button>
                    </div>
                    <div id="referrerInfo" style="display: none; font-size: 12px; color: var(--success-green); margin-top: 5px;"></div>
                    <div class="discount-breakdown" style="margin-top: 10px;">
                        <div class="price-row">
                            <span>Original Fare:</span>
                            <span id="originalFareAmount">ZMW 0.00</span>
                        </div>
                        <div class="price-row">
                            <span>Discount:</span>
                            <span id="discountAmount" style="color: var(--success-green);">-ZMW 0.00</span>
                        </div>
                        <div class="price-row total">
                            <span>Final Fare:</span>
                            <span id="finalFareAmount" style="font-weight: bold;">ZMW 0.00</span>
                        </div>
                    </div>
                </div>
                
                <div class="payment-methods">
                    <div class="payment-method" data-payment="wallet">
                        <div class="payment-icon">
                            <i class="fas fa-wallet"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Jubel Wallet</div>
                            <div class="payment-info">Pay with your wallet balance</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-payment="mobile">
                        <div class="payment-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Mobile Money</div>
                            <div class="payment-info">Pay via MTN/Zamtel/Airtel</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-payment="cash">
                        <div class="payment-icon">
                            <i class="fas fa-money-bill"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Cash</div>
                            <div class="payment-info">Pay driver directly</div>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmPaymentBtn">
                        <i class="fas fa-check"></i>
                        Confirm Payment
                    </button>
                    <button class="btn btn-secondary" data-modal="payment">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Cancel Ride Modal -->
    <div class="modal-overlay" id="cancelModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-times-circle"></i>
                    Cancel Ride
                </div>
                <button class="modal-close" data-modal="cancel">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <div class="form-label">Please select a reason for cancellation:</div>
                </div>
                
                <div class="cancel-reasons">
                    <div class="cancel-reason" data-reason="driver_late">
                        <div class="reason-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="reason-text">Driver is taking too long</div>
                    </div>
                    
                    <div class="cancel-reason" data-reason="change_plans">
                        <div class="reason-icon">
                            <i class="fas fa-calendar-times"></i>
                        </div>
                        <div class="reason-text">Change of plans</div>
                    </div>
                    
                    <div class="cancel-reason" data-reason="found_alternative">
                        <div class="reason-icon">
                            <i class="fas fa-car"></i>
                        </div>
                        <div class="reason-text">Found alternative transport</div>
                    </div>
                    
                    <div class="cancel-reason" data-reason="emergency">
                        <div class="reason-icon">
                            <i class="fas fa-exclamation"></i>
                        </div>
                        <div class="reason-text">Emergency situation</div>
                    </div>
                    
                    <div class="cancel-reason" data-reason="other">
                        <div class="reason-icon">
                            <i class="fas fa-ellipsis-h"></i>
                        </div>
                        <div class="reason-text">Other reason</div>
                    </div>
                </div>
                
                <div class="form-group" id="otherReasonGroup" style="display: none;">
                    <label class="form-label">Please specify:</label>
                    <textarea class="form-control form-textarea" id="otherReason" placeholder="Enter your reason here..."></textarea>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-danger" id="confirmCancelBtn">
                        <i class="fas fa-times"></i>
                        Cancel Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="cancel">
                        Go Back
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Emergency Ride Modal -->
    <div class="modal-overlay" id="emergencyModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-ambulance"></i>
                    Emergency Ride Details
                </div>
                <button class="modal-close" data-modal="emergency">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content emergency-modal-content">
                <div class="form-group">
                    <div class="form-label" id="emergencyServiceType">Police Ride</div>
                </div>
                
                <!-- Emergency Reasons -->
                <div class="form-group">
                    <label class="form-label">Select Emergency Reason</label>
                    <div class="emergency-reasons">
                        <div class="emergency-reason" data-reason="accident">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-car-crash"></i>
                            </div>
                            <div class="emergency-reason-text">Accident</div>
                        </div>
                        
                        <div class="emergency-reason" data-reason="medical">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-heartbeat"></i>
                            </div>
                            <div class="emergency-reason-text">Medical Emergency</div>
                        </div>
                        
                        <div class="emergency-reason" data-reason="crime">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="emergency-reason-text">Crime/Assault</div>
                        </div>
                        
                        <div class="emergency-reason" data-reason="fire">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-fire"></i>
                            </div>
                            <div class="emergency-reason-text">Fire Emergency</div>
                        </div>
                        
                        <div class="emergency-reason" data-reason="other">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="emergency-reason-text">Other Emergency</div>
                        </div>
                    </div>
                    
                    <div class="emergency-reason-input" id="emergencyReasonOther" style="display: none;">
                        <label class="form-label">Please describe the emergency:</label>
                        <textarea class="form-control form-textarea" id="emergencyOtherReason" placeholder="Describe the emergency situation..."></textarea>
                    </div>
                </div>
                
                <!-- Location Inputs -->
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="emergencyPickup" placeholder="Pickup location" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="emergencyPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="emergencyDestination" placeholder="Destination" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="emergencyDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Emergency Stations -->
                <div class="form-group">
                    <label class="form-label">Select Nearest Emergency Station</label>
                    <div class="emergency-stations" id="emergencyStations">
                        <!-- Stations will be inserted here -->
                    </div>
                </div>
                
                <!-- User Location Details -->
                <div class="location-details">
                    <div class="location-detail-item">
                        <div class="location-detail-icon">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="location-detail-content">
                            <div class="location-detail-label">Your Location</div>
                            <div class="location-detail-value" id="emergencyUserLocation">Detecting location...</div>
                        </div>
                    </div>
                </div>
                
                <!-- Price Calculation -->
                <div class="price-calculation">
                    <div class="calculation-row">
                        <span>Base Emergency Fare:</span>
                        <span id="emergencyBaseFare">ZMW 100.00</span>
                    </div>
                    <div class="calculation-row">
                        <span>Distance to Service:</span>
                        <span id="emergencyDistance">0 km</span>
                    </div>
                    <div class="calculation-row">
                        <span>Estimated Time:</span>
                        <span id="emergencyTime">5 min</span>
                    </div>
                    <div class="calculation-row total">
                        <span>Total Fare:</span>
                        <span id="emergencyTotalFare">ZMW 100.00</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-danger" id="confirmEmergencyBtn">
                        <i class="fas fa-exclamation-triangle"></i>
                        Request Emergency Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="emergency">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- SOS Setup Modal -->
    <div class="modal-overlay" id="sosModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    SOS Emergency Setup
                </div>
                <button class="modal-close" data-modal="sos">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <label class="form-label">Primary Emergency Contact</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="sosContact1Name" placeholder="Contact name">
                        <input type="tel" class="form-control" id="sosContact1Phone" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Secondary Emergency Contact (Optional)</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="sosContact2Name" placeholder="Contact name">
                        <input type="tel" class="form-control" id="sosContact2Phone" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Emergency Message</label>
                    <textarea class="form-control form-textarea" id="sosMessage">
I need help! My current location and ride details will be shared with you.
                    </textarea>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="saveSOSBtn">
                        <i class="fas fa-save"></i>
                        Save SOS Setup
                    </button>
                    <button class="btn btn-secondary" data-modal="sos">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Transfer Money Modal -->
    <div class="modal-overlay" id="transferModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-exchange-alt"></i>
                    Transfer Money
                </div>
                <button class="modal-close" data-modal="transfer">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <div class="form-label">Available Balance: <span id="transferBalance">ZMW 0.00</span></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Recipient's Referral Code</label>
                    <input type="text" class="form-control" id="recipientCode" placeholder="Enter recipient's Jubel referral code">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Amount (ZMW)</label>
                    <input type="number" class="form-control" id="transferAmount" placeholder="Enter amount" min="1" step="0.01">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Message (Optional)</label>
                    <input type="text" class="form-control" id="transferMessage" placeholder="Add a message">
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmTransferBtn">
                        <i class="fas fa-paper-plane"></i>
                        Send Money
                    </button>
                    <button class="btn btn-secondary" data-modal="transfer">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Wallet Transactions Modal -->
    <div class="modal-overlay" id="transactionsModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-history"></i>
                    Wallet Transactions
                </div>
                <button class="modal-close" data-modal="transactions">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div id="transactionsList">
                    <!-- Transactions will be inserted here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Schedule Ride Modal -->
    <div class="modal-overlay" id="scheduleModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-calendar-alt"></i>
                    Schedule a Ride
                </div>
                <button class="modal-close" data-modal="schedule">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="schedulePickup" placeholder="Pickup location">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="schedulePickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="scheduleDestination" placeholder="Destination">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="scheduleDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- For Someone Else -->
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="scheduleForSomeone">
                        <span style="margin-left: 8px;">Booking for someone else</span>
                    </label>
                </div>
                
                <div class="form-group" id="someoneElseDetails" style="display: none;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="recipientName" placeholder="Recipient name">
                        <input type="tel" class="form-control" id="recipientPhone" placeholder="Recipient phone">
                    </div>
                </div>
                
                <div class="schedule-grid">
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-control" id="scheduleDate" min="">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Time</label>
                        <input type="time" class="form-control" id="scheduleTime">
                    </div>
                </div>
                
                <!-- Ride Type Selection for Schedule -->
                <div class="ride-type-selection" style="margin: 0 0 16px 0;">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                    </div>
                    <div class="ride-type-grid" id="scheduleRideTypeGrid">
                        <div class="ride-type-card economy" data-type="economy">
                            <div class="ride-type-icon">
                                <i class="fas fa-car-side"></i>
                            </div>
                            <div class="ride-type-name">Economy</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card selected" data-type="standard">
                            <div class="ride-type-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="ride-type-name">Standard</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card premium" data-type="premium">
                            <div class="ride-type-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="ride-type-name">Premium</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="scheduleFareDisplay" style="display: none;">
                    <div class="fare-label">Scheduled Ride Fare</div>
                    <div class="fare-amount" id="scheduleFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="scheduleDistance">0 km</span>
                        <span id="scheduleTimeEstimate">ETA: 0 min</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmScheduleBtn">
                        <i class="fas fa-calendar-check"></i>
                        Schedule Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="schedule">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Order for Someone Modal -->
    <div class="modal-overlay" id="orderForSomeoneModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-user-friends"></i>
                    Order for Someone Else
                </div>
                <button class="modal-close" data-modal="orderForSomeone">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="someonePickup" placeholder="Pickup location">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="someonePickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="someoneDestination" placeholder="Destination">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="someoneDestinationSuggestions"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Recipient Details</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="someoneName" placeholder="Full name">
                        <input type="tel" class="form-control" id="someonePhone" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Special Instructions (Optional)</label>
                    <textarea class="form-control form-textarea" id="someoneInstructions" placeholder="Any instructions for the driver..."></textarea>
                </div>
                
                <!-- Ride Type Selection -->
                <div class="ride-type-selection" style="margin: 0 0 16px 0;">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                    </div>
                    <div class="ride-type-grid" id="someoneRideTypeGrid">
                        <div class="ride-type-card economy" data-type="economy">
                            <div class="ride-type-icon">
                                <i class="fas fa-car-side"></i>
                            </div>
                            <div class="ride-type-name">Economy</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card selected" data-type="standard">
                            <div class="ride-type-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="ride-type-name">Standard</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card premium" data-type="premium">
                            <div class="ride-type-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="ride-type-name">Premium</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="someoneFareDisplay" style="display: none;">
                    <div class="fare-label">Estimated Fare</div>
                    <div class="fare-amount" id="someoneFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="someoneDistance">0 km</span>
                        <span id="someoneTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmSomeoneRideBtn">
                        <i class="fas fa-car"></i>
                        Request Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="orderForSomeone">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Share Ride Modal -->
    <div class="modal-overlay" id="shareRideModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-share-alt"></i>
                    Share Ride
                </div>
                <button class="modal-close" data-modal="shareRide">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="sharePickup" placeholder="Pickup location">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="sharePickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="shareDestination" placeholder="Destination">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shareDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Share Members Input -->
                <div class="form-group">
                    <label class="form-label">Add Friends by Referral Code</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" class="form-control" id="shareMemberInput" placeholder="Enter friend's referral code">
                        <button class="btn btn-secondary" id="addShareMemberBtn">
                            <i class="fas fa-plus"></i> Add
                        </button>
                    </div>
                </div>
                
                <!-- Share Members List -->
                <div class="form-group">
                    <div id="shareFriendsList" class="share-friends-list">
                        <!-- Share members will be inserted here -->
                    </div>
                </div>
                
                <!-- Share Calculations -->
                <div class="form-group" id="shareCalculations" style="display: none;">
                    <!-- Calculations will be inserted here -->
                </div>
                
                <!-- Ride Type Selection -->
                <div class="ride-type-selection" style="margin: 0 0 16px 0;">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                    </div>
                    <div class="ride-type-grid" id="shareRideTypeGrid">
                        <div class="ride-type-card economy" data-type="economy">
                            <div class="ride-type-icon">
                                <i class="fas fa-car-side"></i>
                            </div>
                            <div class="ride-type-name">Economy</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card selected" data-type="standard">
                            <div class="ride-type-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="ride-type-name">Standard</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card premium" data-type="premium">
                            <div class="ride-type-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="ride-type-name">Premium</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Estimated Fare: <span id="shareFareEstimate">ZMW 0.00</span></label>
                    <div class="price-calculation">
                        <div class="calculation-row">
                            <span>Your Share:</span>
                            <span id="yourShare">ZMW 0.00</span>
                        </div>
                        <div class="calculation-row">
                            <span>Friend's Share:</span>
                            <span id="friendShare">ZMW 0.00</span>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmShareRideBtn">
                        <i class="fas fa-user-friends"></i>
                        Share Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="shareRide">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Share Ride Invitation Modal -->
    <div class="modal-overlay" id="shareRideInvitationModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-users"></i>
                    Share Ride Invitation
                </div>
                <button class="modal-close" data-modal="shareRideInvitation">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="invitation-details" id="invitationDetails">
                    <!-- Invitation details will be inserted here -->
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" id="acceptShareInvitationBtn">
                        <i class="fas fa-check"></i>
                        Accept Invitation
                    </button>
                    <button class="btn btn-secondary" id="rejectShareInvitationBtn">
                        <i class="fas fa-times"></i>
                        Decline
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Update Profile Modal -->
    <div class="modal-overlay" id="updateProfileModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-user-edit"></i>
                    Update Profile
                </div>
                <button class="modal-close" data-modal="updateProfile">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <input type="text" class="form-control" id="updateName" placeholder="Your full name">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Phone Number</label>
                    <input type="tel" class="form-control" id="updatePhone" placeholder="Your phone number">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" class="form-control" id="updateEmail" placeholder="Your email address" readonly>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Home Address (Optional)</label>
                    <input type="text" class="form-control" id="updateHomeAddress" placeholder="Your home address">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Work Address (Optional)</label>
                    <input type="text" class="form-control" id="updateWorkAddress" placeholder="Your work address">
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="saveProfileBtn">
                        <i class="fas fa-save"></i>
                        Save Changes
                    </button>
                    <button class="btn btn-secondary" data-modal="updateProfile">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Loading...</div>
    </div>
    
    <!-- Search Loading Overlay -->
    <div id="searchLoading" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); z-index: 10000;">
        <i class="fas fa-spinner fa-spin"></i> Searching...
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Real-time Indicator -->
    <div class="real-time-indicator" id="realTimeIndicator">
        <i class="fas fa-sync-alt"></i>
        <span>Real-time updates active</span>
    </div>
    
    <!-- Sync Indicator -->
    <div class="sync-indicator" id="syncIndicator">
        <i class="fas fa-sync-alt sync-icon"></i>
        <span>Syncing...</span>
    </div>
    
    <!-- Schedule Countdown -->
    <div id="scheduleCountdown" style="display: none;"></div>
    
    <!-- JavaScript Libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Main JavaScript Code -->
    <script>
        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyDEACX_P4c5q7djJAcA0I7Lk7leO2TlQ74",
            authDomain: "jubel-13e1a.firebaseapp.com",
            databaseURL: "https://jubel-13e1a-default-rtdb.firebaseio.com",
            projectId: "jubel-13e1a",
            storageBucket: "jubel-13e1a.firebasestorage.app",
            messagingSenderId: "882241095445",
            appId: "1:882241095445:web:ee9ca40fddd008ca910b1c",
            measurementId: "G-J5JPKL6B5F"
        };

        // ============================================
        // GLOBAL STATE
        // ============================================
        const AppState = {
            currentUser: null,
            userData: null,
            currentRide: null,
            activeScreen: 'home',
            activeService: 'car',
            walletBalance: 0,
            userLocation: null,
            currentCity: null,
            selectedRideType: 'standard',
            selectedVehicle: null,
            destination: null,
            pickup: null,
            rideFare: 0,
            driverLocation: null,
            chatMessages: [],
            scheduledRides: [],
            emergencyMode: false,
            sosConfig: null,
            searchCache: new Map(),
            notifications: [],
            unreadNotifications: 0,
            searchHistory: [],
            broadcastRecipients: [],
            emergencyStations: { police: [], fire: [], medical: [] },
            realtimeListeners: [],
            rideTypes: {
                economy: { base: 15, perKm: 2.5, multiplier: 0.8, min: 10 },
                standard: { base: 20, perKm: 3.0, multiplier: 1.0, min: 15 },
                premium: { base: 30, perKm: 4.0, multiplier: 1.5, min: 25 }
            },
            emergencyServices: {
                police: { base: 150, perKm: 5.0, multiplier: 2.0, min: 100 },
                fire: { base: 200, perKm: 6.0, multiplier: 2.5, min: 150 },
                medical: { base: 180, perKm: 5.5, multiplier: 2.2, min: 120 }
            },
            deliveryTypes: {
                standard: { base: 25, perKm: 2.0, multiplier: 1.0 },
                express: { base: 40, perKm: 3.0, multiplier: 1.5 },
                sameDay: { base: 60, perKm: 4.0, multiplier: 2.0 }
            },
            truckTypes: {
                pickup: { base: 80, perKm: 5.0, multiplier: 1.0, capacity: '1.5 tons' },
                light: { base: 120, perKm: 6.0, multiplier: 1.2, capacity: '3 tons' },
                medium: { base: 200, perKm: 8.0, multiplier: 1.5, capacity: '7 tons' },
                heavy: { base: 350, perKm: 12.0, multiplier: 2.0, capacity: '15 tons' }
            },
            referralDiscountApplied: false,
            referralCodeUsed: null,
            referralOwnerName: null,
            shareRideFriends: [],
            maxShareFriends: 4,
            activeFilter: 'all',
            chatOpen: false,
            notificationsOpen: false,
            mapInitialized: false
        };

        // ============================================
        // MAP VARIABLES
        // ============================================
        let map = null;
        let currentLocationMarker = null;
        let pickupMarker = null;
        let destinationMarker = null;
        let driverMarker = null;
        let routeLayer = null;
        let emergencyStationMarkers = [];
        let routePolyline = null;
        let pulsingIcon = null;

        // ============================================
        // ENHANCED SEARCH ENGINE
        // ============================================
        const EnhancedSearchEngine = {
            cache: new Map(),
            searchHistory: [],
            maxHistoryItems: 15,
            
            init: function() {
                this.loadSearchHistory();
            },
            
            loadSearchHistory: function() {
                try {
                    const history = localStorage.getItem('jubel_search_history');
                    if (history) {
                        this.searchHistory = JSON.parse(history);
                    }
                } catch (error) {
                    console.error('Error loading search history:', error);
                    this.searchHistory = [];
                }
            },
            
            saveSearchHistory: function() {
                try {
                    localStorage.setItem('jubel_search_history', JSON.stringify(this.searchHistory));
                } catch (error) {
                    console.error('Error saving search history:', error);
                }
            },
            
            addToHistory: function(query, location, type) {
                const historyItem = {
                    query: query,
                    location: location,
                    type: type,
                    timestamp: Date.now(),
                    city: AppState.currentCity
                };
                
                this.searchHistory = this.searchHistory.filter(item => 
                    !(item.query === query && item.type === type && item.city === AppState.currentCity)
                );
                
                this.searchHistory.unshift(historyItem);
                
                if (this.searchHistory.length > this.maxHistoryItems) {
                    this.searchHistory = this.searchHistory.slice(0, this.maxHistoryItems);
                }
                
                this.saveSearchHistory();
                return historyItem;
            },
            
            search: async function(query, type = 'destination', location = null, forceCity = null) {
                try {
                    const city = forceCity || AppState.currentCity;
                    if (!city) {
                        console.warn('No city detected for search');
                        return [];
                    }
                    
                    const cacheKey = `${query.toLowerCase()}-${type}-${city}-${location ? `${location.lat.toFixed(4)},${location.lng.toFixed(4)}` : 'none'}`;
                    
                    if (this.cache.has(cacheKey)) {
                        const cached = this.cache.get(cacheKey);
                        if (Date.now() - cached.timestamp < 300000) {
                            return cached.results;
                        }
                    }
                    
                    const searchUrl = this.buildCityConstrainedSearchUrl(query, city, location);
                    
                    const response = await fetch(searchUrl, {
                        headers: {
                            'User-Agent': 'JubelRideApp/1.0',
                            'Accept': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Search failed: ${response.status} ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    const results = this.processAndFilterResults(data, location, city, type);
                    
                    this.cache.set(cacheKey, {
                        results: results,
                        timestamp: Date.now(),
                        query: query,
                        city: city
                    });
                    
                    if (type === 'destination' && results.length > 0) {
                        this.addToHistory(query, results[0], type);
                    }
                    
                    return results;
                } catch (error) {
                    console.error('Search error:', error);
                    
                    if (AppState.currentCity) {
                        const fallbackResults = await this.localCitySearch(query, AppState.currentCity, location);
                        if (fallbackResults.length > 0) {
                            return fallbackResults;
                        }
                    }
                    
                    EnhancedUIUpdater.showToast('Search service temporarily unavailable. Please try again.', 'warning');
                    return [];
                }
            },
            
            buildCityConstrainedSearchUrl: function(query, city, location) {
                const bounds = this.getCityBounds(city);
                if (!bounds) {
                    return this.buildSearchUrl(query, location, city);
                }
                
                const params = new URLSearchParams({
                    q: `${query}, ${city}, Zambia`,
                    format: 'json',
                    limit: 20,
                    countrycodes: 'zm',
                    bounded: 1,
                    viewbox: bounds.join(','),
                    'accept-language': 'en',
                    addressdetails: 1,
                    polygon: 0
                });
                
                return `https://nominatim.openstreetmap.org/search?${params}`;
            },
            
            buildSearchUrl: function(query, location, city) {
                const params = new URLSearchParams({
                    q: `${query}${city ? `, ${city}, Zambia` : ', Zambia'}`,
                    format: 'json',
                    limit: 15,
                    countrycodes: 'zm',
                    'accept-language': 'en',
                    addressdetails: 1
                });
                
                return `https://nominatim.openstreetmap.org/search?${params}`;
            },
            
            getCityBounds: function(cityName) {
                const cityBounds = {
                    'Lusaka': [27.8, -15.8, 28.8, -15.2],
                    'Ndola': [28.5, -13.1, 28.8, -12.9],
                    'Kitwe': [27.9, -13.1, 28.4, -12.7],
                    'Kabwe': [28.3, -14.6, 28.6, -14.3],
                    'Livingstone': [25.7, -18.0, 26.0, -17.7],
                    'Chipata': [32.5, -13.8, 32.8, -13.6],
                    'Chingola': [27.8, -12.8, 27.9, -12.4],
                    'Mufulira': [28.1, -12.7, 28.3, -12.5],
                    'Luanshya': [28.3, -13.2, 28.5, -13.0],
                    'Kasama': [31.1, -10.3, 31.3, -10.1],
                    'Solwezi': [26.3, -12.3, 26.5, -12.1],
                    'Mazabuka': [27.7, -15.9, 27.9, -15.7]
                };
                
                return cityBounds[cityName] || null;
            },
            
            processAndFilterResults: function(data, location, city, type) {
                if (!data || data.length === 0) return [];
                
                const cityLower = city.toLowerCase();
                const processedResults = [];
                
                data.forEach(place => {
                    try {
                        const address = place.address || {};
                        const placeCity = address.city || address.town || address.village || address.municipality;
                        const placeCityLower = placeCity ? placeCity.toLowerCase() : '';
                        
                        if (city && !this.isInCity(place, cityLower, placeCityLower)) {
                            return;
                        }
                        
                        let distance = 0;
                        if (location) {
                            distance = this.calculateDistance(
                                location.lat, location.lng,
                                parseFloat(place.lat), parseFloat(place.lon)
                            );
                        }
                        
                        const displayAddress = this.formatAddress(place, city);
                        
                        const result = {
                            id: place.place_id || `${place.lat}-${place.lon}`,
                            name: place.display_name.split(',')[0] || 'Unnamed Location',
                            address: displayAddress,
                            fullAddress: place.display_name,
                            lat: parseFloat(place.lat),
                            lng: parseFloat(place.lon),
                            type: place.type || place.class || 'unknown',
                            distance: distance,
                            city: placeCity || city,
                            category: this.categorizePlace(place),
                            isVerified: this.isVerifiedLocation(place)
                        };
                        
                        processedResults.push(result);
                    } catch (error) {
                        console.error('Error processing search result:', error);
                    }
                });
                
                return processedResults
                    .sort((a, b) => {
                        if (a.isVerified !== b.isVerified) {
                            return b.isVerified - a.isVerified;
                        }
                        if (location && a.distance !== b.distance) {
                            return a.distance - b.distance;
                        }
                        return 0;
                    })
                    .slice(0, 10);
            },
            
            isInCity: function(place, targetCity, placeCity) {
                if (!targetCity) return true;
                
                if (placeCity && placeCity.includes(targetCity)) {
                    return true;
                }
                
                const address = place.address || {};
                const components = [
                    address.city,
                    address.town,
                    address.village,
                    address.municipality
                ].filter(Boolean);
                
                return components.some(component => 
                    component.toLowerCase().includes(targetCity)
                );
            },
            
            formatAddress: function(place, currentCity) {
                const address = place.address || {};
                const parts = [];
                
                if (address.house_number || address.housenumber) {
                    parts.push(address.house_number || address.housenumber);
                }
                
                if (address.road) {
                    parts.push(address.road);
                }
                
                if (address.suburb || address.neighbourhood) {
                    parts.push(address.suburb || address.neighbourhood);
                }
                
                if (address.city || address.town) {
                    const cityName = address.city || address.town;
                    if (cityName.toLowerCase() !== currentCity.toLowerCase()) {
                        parts.push(cityName);
                    }
                }
                
                if (parts.length === 0) {
                    return place.display_name.split(',').slice(0, 2).join(',').trim();
                }
                
                return parts.join(', ');
            },
            
            categorizePlace: function(place) {
                const type = place.type || place.class || '';
                
                if (type.includes('restaurant') || type.includes('cafe') || type.includes('fast_food')) {
                    return 'restaurant';
                } else if (type.includes('hotel') || type.includes('motel') || type.includes('guest_house')) {
                    return 'hotel';
                } else if (type.includes('mall') || type.includes('supermarket') || type.includes('shop')) {
                    return 'shopping';
                } else if (type.includes('bank') || type.includes('atm')) {
                    return 'bank';
                } else if (type.includes('hospital') || type.includes('clinic') || type.includes('pharmacy')) {
                    return 'medical';
                } else {
                    return 'other';
                }
            },
            
            isVerifiedLocation: function(place) {
                const verifiedTypes = [
                    'restaurant', 'hotel', 'mall', 'supermarket', 'bank', 'hospital',
                    'clinic', 'school', 'university', 'government'
                ];
                
                const type = place.type || place.class || '';
                return verifiedTypes.some(verifiedType => type.includes(verifiedType));
            },
            
            calculateDistance: function(lat1, lon1, lat2, lon2) {
                const R = 6371;
                const dLat = this.toRad(lat2 - lat1);
                const dLon = this.toRad(lon2 - lon1);
                const a = 
                    Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(this.toRad(lat1)) * Math.cos(this.toRad(lat2)) * 
                    Math.sin(dLon/2) * Math.sin(dLon/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            },
            
            toRad: function(value) {
                return value * Math.PI / 180;
            },
            
            localCitySearch: async function(query, city, location) {
                try {
                    const bounds = this.getCityBounds(city);
                    if (bounds) {
                        const [west, south, east, north] = bounds;
                        
                        const searchUrl = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}+${encodeURIComponent(city)}+Zambia&format=json&limit=10&viewbox=${west},${south},${east},${north}&bounded=1`;
                        
                        const response = await fetch(searchUrl);
                        const data = await response.json();
                        
                        return data.map(place => ({
                            id: place.place_id,
                            name: place.display_name.split(',')[0],
                            address: this.formatAddress(place, city),
                            lat: parseFloat(place.lat),
                            lng: parseFloat(place.lon),
                            distance: location ? this.calculateDistance(location.lat, location.lng, parseFloat(place.lat), parseFloat(place.lon)) : 0
                        }));
                    }
                } catch (error) {
                    console.error('Local search error:', error);
                }
                
                return [];
            }
        };

        // ============================================
        // ENHANCED UI UPDATER
        // ============================================
        const EnhancedUIUpdater = {
            updateWalletBalance: function(balance) {
                const formatted = `ZMW ${balance.toFixed(2)}`;
                const elements = ['walletBalance', 'accountBalance', 'paymentBalance', 'transferBalance'];
                elements.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) element.textContent = formatted;
                });
                
                AppState.walletBalance = balance;
            },
            
            updateUserInfo: function(userData) {
                if (userData.name) {
                    const userFullName = document.getElementById('userFullName');
                    const accountName = document.getElementById('accountName');
                    if (userFullName) userFullName.textContent = userData.name;
                    if (accountName) accountName.textContent = userData.name;
                }
                
                if (userData.phone) {
                    const accountPhone = document.getElementById('accountPhone');
                    if (accountPhone) accountPhone.textContent = userData.phone;
                }
                
                if (userData.referralCode) {
                    const referralCode = document.getElementById('referralCode');
                    if (referralCode) referralCode.textContent = userData.referralCode;
                }
            },
            
            showToast: function(message, type = 'info', duration = 5000) {
                const toastContainer = document.getElementById('toastContainer');
                if (!toastContainer) return;
                
                const toastId = 'toast-' + Date.now();
                
                const icons = {
                    success: 'fa-check-circle',
                    error: 'fa-exclamation-circle',
                    warning: 'fa-exclamation-triangle',
                    info: 'fa-info-circle'
                };
                
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.id = toastId;
                toast.innerHTML = `
                    <div class="toast-icon">
                        <i class="fas ${icons[type] || icons.info}"></i>
                    </div>
                    <div class="toast-content">
                        <div class="toast-title">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
                        <div class="toast-message">${message}</div>
                    </div>
                    <button class="toast-close" onclick="EnhancedUIUpdater.removeToast('${toastId}')">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                toastContainer.appendChild(toast);
                
                setTimeout(() => {
                    this.removeToast(toastId);
                }, duration);
            },
            
            removeToast: function(toastId) {
                const toast = document.getElementById(toastId);
                if (toast) {
                    toast.classList.add('hiding');
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, 300);
                }
            },
            
            showLoading: function(message = 'Loading...') {
                const overlay = document.getElementById('loadingOverlay');
                const text = document.getElementById('loadingText');
                if (overlay && text) {
                    text.textContent = message;
                    overlay.style.display = 'flex';
                }
            },
            
            hideLoading: function() {
                const overlay = document.getElementById('loadingOverlay');
                if (overlay) {
                    overlay.style.display = 'none';
                }
            },
            
            updateCityDisplay: function(city) {
                const display = document.getElementById('currentCityDisplay');
                if (display && city) {
                    display.textContent = `City: ${city}`;
                    display.parentElement.style.display = 'flex';
                    
                    setTimeout(() => {
                        if (display.parentElement) {
                            display.parentElement.style.display = 'none';
                        }
                    }, 5000);
                }
            },
            
            updateRidePrices: function(distanceKm) {
                const surge = this.getSurgeMultiplier();
                
                ['economy', 'standard', 'premium'].forEach(type => {
                    const price = this.calculateRideFare(distanceKm, type, surge);
                    const element = document.getElementById(`${type}Price`);
                    if (element) {
                        element.textContent = `ZMW ${price.toFixed(2)}`;
                    }
                });
                
                const selectedPrice = this.calculateRideFare(distanceKm, AppState.selectedRideType, surge);
                const estimatedFare = document.getElementById('estimatedFare');
                if (estimatedFare) estimatedFare.textContent = `ZMW ${selectedPrice.toFixed(2)}`;
                
                const time = this.estimateTime(distanceKm, AppState.selectedRideType);
                const distanceDetail = document.getElementById('distanceDetail');
                const timeDetail = document.getElementById('timeDetail');
                
                if (distanceDetail) distanceDetail.textContent = `${distanceKm.toFixed(1)} km`;
                if (timeDetail) timeDetail.textContent = `ETA: ${time} min`;
                
                AppState.rideFare = selectedPrice;
            },
            
            calculateRideFare: function(distanceKm, rideType = 'standard', surge = 1.0) {
                const config = AppState.rideTypes[rideType] || AppState.rideTypes.standard;
                
                let fare = config.base + (distanceKm * config.perKm);
                fare *= config.multiplier;
                fare *= surge;
                fare = Math.max(fare, config.min);
                
                return Math.round(fare * 100) / 100;
            },
            
            estimateTime: function(distanceKm, rideType = 'standard') {
                const baseSpeed = rideType === 'premium' ? 45 : 35;
                let baseTime = (distanceKm / baseSpeed) * 60;
                baseTime *= this.getTrafficFactor();
                
                if (rideType === 'premium') {
                    baseTime += 2;
                } else {
                    baseTime += 5;
                }
                
                return Math.ceil(baseTime);
            },
            
            getSurgeMultiplier: function() {
                const hour = new Date().getHours();
                const day = new Date().getDay();
                
                if (day >= 1 && day <= 5) {
                    if (hour >= 7 && hour <= 9) return 1.5;
                    if (hour >= 16 && hour <= 19) return 1.8;
                }
                
                if (day === 5 || day === 6) {
                    if (hour >= 20 && hour <= 23) return 2.0;
                }
                
                if (hour >= 22 || hour <= 5) return 1.8;
                
                return 1.0;
            },
            
            getTrafficFactor: function() {
                const hour = new Date().getHours();
                const day = new Date().getDay();
                
                if (day >= 1 && day <= 5) {
                    if ((hour >= 7 && hour <= 9) || (hour >= 16 && hour <= 19)) {
                        return 1.5;
                    }
                }
                
                return 1.0;
            },
            
            showSearchSuggestions: function(inputId, results, type = 'destination') {
                const container = document.getElementById(`${inputId}Suggestions`);
                if (!container) return;
                
                container.innerHTML = '';
                
                if (results.length === 0) {
                    container.innerHTML = `
                        <div class="no-results">
                            <i class="fas fa-search"></i>
                            <div>No results found in ${AppState.currentCity}</div>
                        </div>
                    `;
                } else {
                    results.forEach(result => {
                        const item = document.createElement('div');
                        item.className = 'suggestion-item';
                        item.dataset.lat = result.lat;
                        item.dataset.lng = result.lng;
                        item.dataset.address = result.address;
                        item.dataset.name = result.name;
                        
                        let icon = 'fa-map-marker-alt';
                        let iconColor = '#FF6B35';
                        
                        if (result.category === 'restaurant') {
                            icon = 'fa-utensils';
                            iconColor = '#FFC107';
                        } else if (result.category === 'hotel') {
                            icon = 'fa-hotel';
                            iconColor = '#2196F3';
                        } else if (result.category === 'shopping') {
                            icon = 'fa-shopping-cart';
                            iconColor = '#9C27B0';
                        } else if (result.category === 'medical') {
                            icon = 'fa-hospital';
                            iconColor = '#F44336';
                        } else if (result.isVerified) {
                            icon = 'fa-check-circle';
                            iconColor = '#4CAF50';
                        }
                        
                        item.innerHTML = `
                            <div class="suggestion-icon" style="color: ${iconColor}">
                                <i class="fas ${icon}"></i>
                            </div>
                            <div class="suggestion-details">
                                <div class="suggestion-name">${result.name}</div>
                                <div class="suggestion-address">${result.address}</div>
                                ${result.distance ? `<div class="suggestion-distance">${result.distance.toFixed(1)} km away</div>` : ''}
                            </div>
                        `;
                        
                        item.addEventListener('click', () => {
                            this.selectLocation(inputId, result, type);
                        });
                        
                        container.appendChild(item);
                    });
                }
                
                container.style.display = 'block';
            },
            
            selectLocation: function(inputId, location, type) {
                const input = document.getElementById(inputId);
                if (!input) return;
                
                input.value = location.address || location.name;
                
                if (type === 'pickup') {
                    AppState.pickup = location;
                    this.updatePickupMarker(location);
                } else {
                    AppState.destination = location;
                    this.updateDestinationMarker(location);
                }
                
                const suggestions = document.getElementById(`${inputId}Suggestions`);
                if (suggestions) {
                    suggestions.style.display = 'none';
                }
                
                if (AppState.pickup && AppState.destination) {
                    this.calculateAndUpdatePrices();
                    this.drawRoute(AppState.pickup, AppState.destination);
                }
            },
            
            updatePickupMarker: function(location) {
                if (!map) return;
                
                if (pickupMarker) {
                    pickupMarker.setLatLng([location.lat, location.lng]);
                } else {
                    pickupMarker = L.marker([location.lat, location.lng], {
                        icon: L.divIcon({
                            className: 'pickup-marker',
                            html: '<i class="fas fa-map-marker-alt"></i>',
                            iconSize: [24, 24],
                            iconAnchor: [12, 24]
                        })
                    }).addTo(map).bindPopup('Pickup Location');
                }
                
                map.setView([location.lat, location.lng], 15);
            },
            
            updateDestinationMarker: function(location) {
                if (!map) return;
                
                if (destinationMarker) {
                    destinationMarker.setLatLng([location.lat, location.lng]);
                } else {
                    destinationMarker = L.marker([location.lat, location.lng], {
                        icon: L.divIcon({
                            className: 'destination-marker',
                            html: '<i class="fas fa-flag"></i>',
                            iconSize: [24, 24],
                            iconAnchor: [12, 24]
                        })
                    }).addTo(map).bindPopup('Destination');
                }
            },
            
            calculateAndUpdatePrices: function() {
                if (AppState.pickup && AppState.destination) {
                    const distance = EnhancedSearchEngine.calculateDistance(
                        AppState.pickup.lat, AppState.pickup.lng,
                        AppState.destination.lat, AppState.destination.lng
                    );
                    
                    switch(AppState.activeService) {
                        case 'car':
                            this.updateRidePrices(distance);
                            const fareDisplay = document.getElementById('fareDisplay');
                            const rideTypeSelection = document.getElementById('rideTypeSelection');
                            if (fareDisplay) fareDisplay.classList.add('active');
                            if (rideTypeSelection) rideTypeSelection.classList.add('active');
                            break;
                    }
                }
            },
            
            drawRoute: async function(start, end) {
                if (!map) return;
                
                if (routeLayer) {
                    map.removeLayer(routeLayer);
                }
                
                try {
                    const response = await fetch(
                        `https://router.project-osrm.org/route/v1/driving/${start.lng},${start.lat};${end.lng},${end.lat}?overview=full&geometries=geojson`
                    );
                    
                    if (response.ok) {
                        const data = await response.json();
                        
                        if (data.routes && data.routes.length > 0) {
                            const route = data.routes[0];
                            const routeCoordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                            
                            routeLayer = L.polyline(routeCoordinates, {
                                color: '#FF6B35',
                                weight: 4,
                                opacity: 0.7,
                                lineJoin: 'round',
                                lineCap: 'round'
                            }).addTo(map);
                            
                            const bounds = L.latLngBounds(routeCoordinates);
                            map.fitBounds(bounds, { padding: [50, 50] });
                        }
                    }
                } catch (error) {
                    console.error('Routing service error:', error);
                    
                    routeLayer = L.polyline([
                        [start.lat, start.lng],
                        [end.lat, end.lng]
                    ], {
                        color: '#FF6B35',
                        weight: 3,
                        opacity: 0.7,
                        dashArray: '10, 10'
                    }).addTo(map);
                    
                    const bounds = L.latLngBounds(
                        [start.lat, start.lng],
                        [end.lat, end.lng]
                    );
                    map.fitBounds(bounds, { padding: [50, 50] });
                }
            },
            
            showPulsingRideIcon: function() {
                this.removePulsingRideIcon();
                
                const serviceType = AppState.activeService;
                let iconClass = 'fa-car';
                
                if (serviceType === 'truck') {
                    iconClass = 'fa-truck';
                } else if (serviceType === 'delivery' || serviceType === 'short-delivery') {
                    iconClass = 'fa-shipping-fast';
                } else if (serviceType === 'express') {
                    iconClass = 'fa-shopping-bag';
                }
                
                pulsingIcon = document.createElement('div');
                pulsingIcon.id = 'pulsingRideIcon';
                pulsingIcon.className = 'pulsing-ride-icon';
                pulsingIcon.innerHTML = `<i class="fas ${iconClass}"></i>`;
                
                const mapContainer = document.getElementById('map');
                if (mapContainer) {
                    mapContainer.appendChild(pulsingIcon);
                }
            },
            
            removePulsingRideIcon: function() {
                const pulsingIcon = document.getElementById('pulsingRideIcon');
                if (pulsingIcon) {
                    pulsingIcon.remove();
                }
            }
        };

        // ============================================
        // CITY DETECTOR
        // ============================================
        const CityDetector = {
            detectCityFromLocation: async function(lat, lng) {
                try {
                    const response = await fetch(
                        `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=10`
                    );
                    
                    if (response.ok) {
                        const data = await response.json();
                        const address = data.address;
                        
                        if (address.city) {
                            return address.city;
                        } else if (address.town) {
                            return address.town;
                        } else if (address.village) {
                            return address.village;
                        } else if (address.municipality) {
                            return address.municipality;
                        }
                    }
                } catch (error) {
                    console.error('City detection error:', error);
                }
                
                return null;
            },
            
            getDetailedAddress: async function(lat, lng) {
                try {
                    const response = await fetch(
                        `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18`
                    );
                    
                    if (response.ok) {
                        const data = await response.json();
                        const address = data.address;
                        
                        let street = address.road || '';
                        let suburb = address.suburb || '';
                        let city = address.city || address.town || '';
                        
                        return {
                            address: street + (suburb ? `, ${suburb}` : ''),
                            fullDisplay: data.display_name,
                            city: city
                        };
                    }
                } catch (error) {
                    console.error('Address detection error:', error);
                }
                
                return {
                    address: 'Current Location',
                    fullDisplay: 'Current Location',
                    city: null
                };
            }
        };

        // ============================================
        // MAIN FUNCTIONS
        // ============================================
        async function getCurrentLocation() {
            if (!navigator.geolocation) {
                EnhancedUIUpdater.showToast('Geolocation is not supported by your browser', 'warning');
                return;
            }
            
            EnhancedUIUpdater.showLoading('Getting your location...');
            
            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    });
                });
                
                const { latitude, longitude } = position.coords;
                AppState.userLocation = { lat: latitude, lng: longitude };
                
                if (map) {
                    map.setView([latitude, longitude], 15);
                    
                    currentLocationMarker = L.marker([latitude, longitude], {
                        icon: L.divIcon({
                            className: 'current-location-marker',
                            html: '<i class="fas fa-user"></i>',
                            iconSize: [18, 18],
                            iconAnchor: [9, 18]
                        })
                    }).addTo(map).bindPopup('Your Location');
                }
                
                const detailedAddress = await CityDetector.getDetailedAddress(latitude, longitude);
                const city = await CityDetector.detectCityFromLocation(latitude, longitude);
                
                AppState.currentCity = city;
                EnhancedUIUpdater.updateCityDisplay(city);
                
                const pickupInputs = [
                    'pickupLocation', 'deliveryPickup', 'shortDeliveryPickup', 
                    'truckPickup', 'schedulePickup', 'someonePickup',
                    'sharePickup', 'broadcastPickup', 'emergencyPickup'
                ];
                
                pickupInputs.forEach(inputId => {
                    const input = document.getElementById(inputId);
                    if (input) {
                        input.value = detailedAddress.address;
                        input.dataset.lat = latitude;
                        input.dataset.lng = longitude;
                    }
                });
                
                document.getElementById('emergencyUserLocation').textContent = detailedAddress.fullDisplay;
                
                AppState.pickup = {
                    lat: latitude,
                    lng: longitude,
                    address: detailedAddress.address,
                    name: 'Current Location',
                    fullDisplay: detailedAddress.fullDisplay
                };
                
                EnhancedUIUpdater.hideLoading();
                EnhancedUIUpdater.showToast('Location detected successfully', 'success');
                
            } catch (error) {
                console.error('Geolocation error:', error);
                EnhancedUIUpdater.hideLoading();
                EnhancedUIUpdater.showToast('Unable to get your location', 'warning');
                
                AppState.userLocation = { lat: -15.4167, lng: 28.2833 };
                if (map) map.setView([-15.4167, 28.2833], 13);
            }
        }
        
        function initializeMap() {
            const defaultLat = -15.4167;
            const defaultLng = 28.2833;
            
            map = L.map('map').setView([defaultLat, defaultLng], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: ' OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
            
            L.control.scale().addTo(map);
            
            AppState.mapInitialized = true;
            
            const mapLoadingOverlay = document.getElementById('mapLoadingOverlay');
            if (mapLoadingOverlay) {
                mapLoadingOverlay.style.display = 'none';
            }
        }
        
        function switchScreen(screen) {
            document.querySelectorAll('.history-screen, .account-screen, .emergency-screen').forEach(s => {
                s.classList.remove('active');
                s.style.display = 'none';
            });
            
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById('chatContainer')?.classList.remove('active');
            document.getElementById('notificationsPanel')?.classList.remove('active');
            document.getElementById('moreOptionsMenu')?.classList.remove('active');
            
            if (screen === 'home') {
                AppState.activeScreen = 'home';
                document.querySelector(`.nav-tab[data-screen="home"]`)?.classList.add('active');
                document.getElementById('homeContent').style.display = 'block';
            } else {
                const screenElement = document.getElementById(`${screen}Screen`);
                if (screenElement) {
                    screenElement.style.display = 'block';
                    screenElement.classList.add('active');
                    document.querySelector(`.nav-tab[data-screen="${screen}"]`)?.classList.add('active');
                    AppState.activeScreen = screen;
                }
            }
        }
        
        function switchService(service) {
            document.querySelectorAll('.ride-request-form, .service-form, #broadcastForm').forEach(form => {
                form.style.display = 'none';
                form.classList.remove('active');
            });
            
            document.querySelectorAll('.service-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            AppState.activeService = service;
            
            switch(service) {
                case 'car':
                    document.querySelector('.service-tab.car')?.classList.add('active');
                    document.getElementById('carForm').style.display = 'block';
                    break;
                case 'delivery':
                    document.querySelector('.service-tab.delivery')?.classList.add('active');
                    document.getElementById('deliveryForm').style.display = 'block';
                    document.getElementById('deliveryForm').classList.add('active');
                    break;
                case 'short-delivery':
                    document.querySelector('.service-tab.short-delivery')?.classList.add('active');
                    document.getElementById('shortDeliveryForm').style.display = 'block';
                    document.getElementById('shortDeliveryForm').classList.add('active');
                    break;
                case 'express':
                    document.querySelector('.service-tab[data-service="express"]')?.classList.add('active');
                    document.getElementById('expressForm').style.display = 'block';
                    document.getElementById('expressForm').classList.add('active');
                    break;
                case 'truck':
                    document.querySelector('.service-tab[data-service="truck"]')?.classList.add('active');
                    document.getElementById('truckForm').style.display = 'block';
                    document.getElementById('truckForm').classList.add('active');
                    break;
                case 'broadcast':
                    document.getElementById('broadcastForm').style.display = 'block';
                    document.getElementById('broadcastForm').classList.add('active');
                    break;
            }
        }
        
        function showModal(modalId) {
            const modal = document.getElementById(`${modalId}Modal`);
            if (modal) {
                modal.style.display = 'block';
            }
        }
        
        function hideModal(modalId) {
            const modal = document.getElementById(`${modalId}Modal`);
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        function togglePanel() {
            const panel = document.getElementById('mainPanel');
            panel.classList.toggle('collapsed');
        }
        
        // ============================================
        // EVENT LISTENERS SETUP
        // ============================================
        function setupEventListeners() {
            // Navigation tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const screen = tab.dataset.screen;
                    switchScreen(screen);
                });
            });
            
            // Back buttons
            document.querySelectorAll('.back-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    switchScreen('home');
                });
            });
            
            // Panel handle
            const panelHandle = document.getElementById('panelHandle');
            if (panelHandle) {
                panelHandle.addEventListener('click', togglePanel);
            }
            
            // Service tabs
            document.querySelectorAll('.service-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const service = tab.dataset.service;
                    switchService(service);
                });
            });
            
            // Map controls
            document.getElementById('locateMeBtn')?.addEventListener('click', getCurrentLocation);
            document.getElementById('zoomInBtn')?.addEventListener('click', () => map?.zoomIn());
            document.getElementById('zoomOutBtn')?.addEventListener('click', () => map?.zoomOut());
            
            // More options button
            document.getElementById('moreOptionsBtn')?.addEventListener('click', () => {
                const menu = document.getElementById('moreOptionsMenu');
                menu.classList.toggle('active');
            });
            
            // SOS button
            document.getElementById('sosButton')?.addEventListener('click', () => {
                showModal('sos');
            });
            
            // Emergency services
            document.querySelectorAll('.emergency-service').forEach(service => {
                service.addEventListener('click', () => {
                    const type = service.dataset.type;
                    if (type === 'sos') {
                        showModal('sos');
                    } else {
                        handleEmergencyService(type);
                    }
                });
            });
            
            // Close modals
            document.querySelectorAll('.modal-close').forEach(btn => {
                btn.addEventListener('click', () => {
                    const modal = btn.dataset.modal;
                    hideModal(modal);
                });
            });
            
            // Request Ride button
            document.getElementById('requestRideBtn')?.addEventListener('click', async () => {
                if (!AppState.pickup || !AppState.destination) {
                    EnhancedUIUpdater.showToast('Please select pickup and destination locations', 'warning');
                    return;
                }
                
                if (!AppState.currentCity) {
                    EnhancedUIUpdater.showToast('Please wait while we detect your city', 'warning');
                    return;
                }
                
                const distance = EnhancedSearchEngine.calculateDistance(
                    AppState.pickup.lat, AppState.pickup.lng,
                    AppState.destination.lat, AppState.destination.lng
                );
                
                if (distance < 0.5) {
                    EnhancedUIUpdater.showToast('Minimum ride distance is 0.5 km', 'warning');
                    return;
                }
                
                showPaymentModal('car', AppState.rideFare);
            });
            
            // Ride type selection
            document.querySelectorAll('.ride-type-card').forEach(card => {
                card.addEventListener('click', () => {
                    document.querySelectorAll('.ride-type-card').forEach(c => {
                        c.classList.remove('selected');
                    });
                    
                    card.classList.add('selected');
                    AppState.selectedRideType = card.dataset.type;
                    
                    if (AppState.pickup && AppState.destination) {
                        const distance = EnhancedSearchEngine.calculateDistance(
                            AppState.pickup.lat, AppState.pickup.lng,
                            AppState.destination.lat, AppState.destination.lng
                        );
                        
                        EnhancedUIUpdater.updateRidePrices(distance);
                    }
                });
            });
            
            // Search input handlers
            setupSearchInputs();
            
            // Initialize Enhanced Search Engine
            EnhancedSearchEngine.init();
        }
        
        function setupSearchInputs() {
            const searchInputs = [
                'destinationLocation', 'deliveryDestination', 'shortDeliveryDestination',
                'truckDestination', 'scheduleDestination', 'someoneDestination',
                'shareDestination', 'broadcastDestination', 'shoppingDestination',
                'emergencyDestination'
            ];
            
            searchInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('input', async (e) => {
                        const query = e.target.value.trim();
                        
                        if (query.length < 2) {
                            const suggestions = document.getElementById(`${inputId}Suggestions`);
                            if (suggestions) {
                                suggestions.style.display = 'none';
                            }
                            return;
                        }
                        
                        const results = await EnhancedSearchEngine.search(
                            query,
                            'destination',
                            AppState.userLocation,
                            AppState.currentCity
                        );
                        
                        EnhancedUIUpdater.showSearchSuggestions(inputId, results, 'destination');
                    });
                }
            });
        }
        
        function handleEmergencyService(type) {
            if (!AppState.userLocation) {
                EnhancedUIUpdater.showToast('Please allow location access for emergency services', 'warning');
                return;
            }
            
            if (!AppState.currentCity) {
                EnhancedUIUpdater.showToast('Please wait while we detect your city', 'warning');
                return;
            }
            
            const emergencyServiceType = document.getElementById('emergencyServiceType');
            if (emergencyServiceType) {
                emergencyServiceType.textContent = 
                    type.charAt(0).toUpperCase() + type.slice(1) + ' Ride';
                emergencyServiceType.dataset.type = type;
            }
            
            showModal('emergency');
        }
        
        function showPaymentModal(serviceType, amount) {
            AppState.rideFare = amount;
            
            document.getElementById('paymentAmount').textContent = `ZMW ${amount.toFixed(2)}`;
            
            const referralDiscountSection = document.getElementById('referralDiscountSection');
            if (referralDiscountSection) {
                referralDiscountSection.style.display = 'block';
            }
            
            showModal('payment');
        }
        
        // ============================================
        // INITIALIZE APP
        // ============================================
        async function initializeApp() {
            try {
                EnhancedUIUpdater.showLoading('Initializing app...');
                
                // Initialize Firebase
                firebase.initializeApp(firebaseConfig);
                
                // Check authentication
                const urlParams = new URLSearchParams(window.location.search);
                const email = urlParams.get('email');
                const uid = urlParams.get('uid');
                
                if (email && uid) {
                    AppState.currentUser = { uid, email };
                    // Load user data (simplified for this example)
                    AppState.userData = {
                        name: email.split('@')[0],
                        phone: 'Unknown',
                        referralCode: 'JUBEL-' + uid.substring(0, 8).toUpperCase()
                    };
                    
                    EnhancedUIUpdater.updateUserInfo(AppState.userData);
                    EnhancedUIUpdater.updateWalletBalance(100); // Default balance
                }
                
                // Initialize map
                initializeMap();
                
                // Setup event listeners
                setupEventListeners();
                
                // Get current location
                await getCurrentLocation();
                
                // Initialize ride type cards
                initializeRideTypeCards();
                
                EnhancedUIUpdater.hideLoading();
                EnhancedUIUpdater.showToast('Jubel Passenger App Ready', 'success');
                
            } catch (error) {
                console.error('Error initializing app:', error);
                EnhancedUIUpdater.hideLoading();
                EnhancedUIUpdater.showToast('Error initializing app', 'error');
            }
        }
        
        function initializeRideTypeCards() {
            const container = document.getElementById('rideTypeCardsContainer');
            if (!container) return;
            
            const rideTypes = [
                { type: 'economy', name: 'Economy', icon: 'fa-car-side', price: 'ZMW 15.00' },
                { type: 'standard', name: 'Standard', icon: 'fa-car', price: 'ZMW 20.00' },
                { type: 'premium', name: 'Premium', icon: 'fa-crown', price: 'ZMW 30.00' }
            ];
            
            container.innerHTML = '';
            
            rideTypes.forEach(rideType => {
                const card = document.createElement('div');
                card.className = `ride-type-card ${rideType.type === AppState.selectedRideType ? 'selected' : ''}`;
                card.dataset.type = rideType.type;
                card.innerHTML = `
                    <div class="ride-type-icon">
                        <i class="fas ${rideType.icon}"></i>
                    </div>
                    <div class="ride-type-name">${rideType.name}</div>
                    <div class="ride-type-price" id="${rideType.type}Price">${rideType.price}</div>
                `;
                
                card.addEventListener('click', () => {
                    document.querySelectorAll('.ride-type-card').forEach(c => {
                        c.classList.remove('selected');
                    });
                    
                    card.classList.add('selected');
                    AppState.selectedRideType = rideType.type;
                    
                    if (AppState.pickup && AppState.destination) {
                        const distance = EnhancedSearchEngine.calculateDistance(
                            AppState.pickup.lat, AppState.pickup.lng,
                            AppState.destination.lat, AppState.destination.lng
                        );
                        
                        EnhancedUIUpdater.updateRidePrices(distance);
                    }
                });
                
                container.appendChild(card);
            });
        }
        
        // Start the application
        window.addEventListener('load', initializeApp);
    </script>
</body>
</html>

