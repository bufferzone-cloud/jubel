<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jubel Passenger App</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Core application styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-orange: #FF6B35;
            --primary-dark: #2D3436;
            --secondary-blue: #0984E3;
            --success-green: #00B894;
            --error-red: #D63031;
            --warning-yellow: #FDCB6E;
            --info-blue: #74B9FF;
            --text-dark: #2D3436;
            --text-gray: #636E72;
            --text-light: #B2BEC3;
            --background-light: #F9F9F9;
            --background-white: #FFFFFF;
            --border-color: #E0E0E0;
            --shadow-light: 0 2px 10px rgba(0,0,0,0.1);
            --shadow-medium: 0 4px 20px rgba(0,0,0,0.15);
            --shadow-heavy: 0 8px 30px rgba(0,0,0,0.2);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--background-light);
            color: var(--text-dark);
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        /* Map Container */
        #map {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1;
        }

        .map-loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--background-white);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border-color);
            border-top-color: var(--primary-orange);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .map-loading-text {
            font-size: 16px;
            color: var(--text-gray);
            font-weight: 500;
        }

        /* Top Navigation Bar */
        .top-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: var(--background-white);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: var(--shadow-light);
            z-index: 1000;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--primary-orange);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-icon img {
            width: 30px;
            height: 30px;
            object-fit: contain;
        }

        .logo-text {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-dark);
        }

        .user-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .balance-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--background-light);
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .balance-badge i {
            color: var(--primary-orange);
        }

        .balance-amount {
            font-weight: 600;
            color: var(--success-green);
        }

        .notification-bell {
            position: relative;
            width: 40px;
            height: 40px;
            background: var(--background-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            min-width: 18px;
            height: 18px;
            background: var(--error-red);
            color: white;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
            padding: 0 4px;
        }

        /* City Detection */
        .city-detection {
            position: absolute;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--background-white);
            padding: 8px 16px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow-light);
            z-index: 1000;
            font-size: 14px;
            color: var(--text-gray);
        }

        .city-detection i {
            color: var(--primary-orange);
        }

        /* Ride Status Bar */
        .ride-status-bar {
            position: absolute;
            top: 70px;
            left: 20px;
            right: 20px;
            background: var(--background-white);
            border-radius: 12px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow-medium);
            z-index: 1000;
            transform: translateY(-100px);
            transition: transform 0.3s ease;
        }

        .ride-status-bar.active {
            transform: translateY(0);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 6px;
        }

        .status-dot.searching {
            background: var(--warning-yellow);
            animation: pulse 1.5s infinite;
        }

        .status-dot.arriving {
            background: var(--info-blue);
            animation: pulse 1s infinite;
        }

        .status-dot.riding {
            background: var(--success-green);
        }

        .status-dot.completed {
            background: var(--success-green);
        }

        .status-dot.cancelled {
            background: var(--error-red);
        }

        .status-text {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-dark);
        }

        .status-eta {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            color: var(--text-gray);
        }

        .status-eta i {
            color: var(--primary-orange);
        }

        /* Emergency Status */
        .emergency-status {
            position: absolute;
            top: 70px;
            left: 20px;
            right: 20px;
            background: var(--error-red);
            color: white;
            border-radius: 12px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
            box-shadow: var(--shadow-medium);
            z-index: 1000;
            font-size: 14px;
            font-weight: 600;
        }

        /* SOS Button */
        .sos-button {
            position: absolute;
            bottom: 150px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: var(--error-red);
            border-radius: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            box-shadow: var(--shadow-heavy);
            z-index: 1000;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .sos-button:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(214, 48, 49, 0.5);
        }

        /* Map Controls */
        .map-controls {
            position: absolute;
            bottom: 220px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }

        .map-control-btn {
            width: 44px;
            height: 44px;
            background: var(--background-white);
            border: none;
            border-radius: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-dark);
            font-size: 18px;
            box-shadow: var(--shadow-light);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .map-control-btn:hover {
            background: var(--background-light);
            transform: translateY(-2px);
        }

        /* Main Panel */
        .main-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--background-white);
            border-radius: 24px 24px 0 0;
            box-shadow: var(--shadow-heavy);
            z-index: 1000;
            transition: transform 0.3s ease;
            max-height: 85vh;
            overflow-y: auto;
        }

        .main-panel.collapsed {
            transform: translateY(calc(100% - 80px));
        }

        .panel-handle {
            width: 40px;
            height: 4px;
            background: var(--border-color);
            border-radius: 2px;
            margin: 12px auto;
            cursor: pointer;
        }

        .nav-tabs {
            display: flex;
            justify-content: space-around;
            padding: 0 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .nav-tab {
            flex: 1;
            padding: 15px 0;
            background: none;
            border: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: var(--text-light);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .nav-tab.active {
            color: var(--primary-orange);
        }

        .nav-tab i {
            font-size: 20px;
            margin-bottom: 2px;
        }

        /* Service Tabs */
        .service-tabs {
            display: flex;
            gap: 15px;
            padding: 20px;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .service-tabs::-webkit-scrollbar {
            display: none;
        }

        .service-tab {
            min-width: 70px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 12px;
            border-radius: 12px;
            background: var(--background-light);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .service-tab.active {
            background: var(--primary-orange);
            color: white;
        }

        .service-tab.active .service-icon {
            background: rgba(255, 255, 255, 0.2);
        }

        .service-icon {
            width: 50px;
            height: 50px;
            background: var(--background-white);
            border-radius: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            color: var(--primary-orange);
        }

        .service-name {
            font-size: 12px;
            font-weight: 600;
            text-align: center;
        }

        .service-desc {
            font-size: 10px;
            color: var(--text-light);
            text-align: center;
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            padding: 0 20px 20px;
        }

        .quick-action-btn {
            background: var(--background-light);
            border: none;
            border-radius: 12px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .quick-action-btn:hover {
            background: var(--border-color);
            transform: translateY(-2px);
        }

        .quick-action-icon {
            width: 40px;
            height: 40px;
            background: var(--background-white);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--primary-orange);
        }

        .quick-action-text {
            flex: 1;
            text-align: left;
        }

        .quick-action-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .quick-action-desc {
            font-size: 11px;
            color: var(--text-gray);
        }

        /* Ride Request Form */
        .ride-request-form {
            padding: 0 20px 30px;
        }

        .form-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-dark);
        }

        .form-title i {
            color: var(--primary-orange);
        }

        .location-inputs {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .location-input {
            position: relative;
            background: var(--background-light);
            border-radius: 12px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .location-input.active {
            background: var(--background-white);
            box-shadow: 0 0 0 2px var(--primary-orange);
        }

        .location-input i {
            color: var(--text-gray);
            font-size: 16px;
        }

        .location-input input {
            flex: 1;
            border: none;
            background: none;
            font-size: 14px;
            color: var(--text-dark);
            outline: none;
        }

        .location-input input::placeholder {
            color: var(--text-light);
        }

        .clear-pickup-btn,
        .edit-pickup-btn {
            background: none;
            border: none;
            color: var(--text-gray);
            font-size: 14px;
            cursor: pointer;
            padding: 4px;
        }

        .clear-pickup-btn:hover,
        .edit-pickup-btn:hover {
            color: var(--primary-orange);
        }

        .suggestion-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--background-white);
            border-radius: 12px;
            box-shadow: var(--shadow-medium);
            margin-top: 5px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1001;
            display: none;
        }

        .suggestion-list.active {
            display: block;
        }

        .suggestion-item {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background 0.2s ease;
            border-bottom: 1px solid var(--border-color);
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-item:hover {
            background: var(--background-light);
        }

        .suggestion-icon {
            width: 32px;
            height: 32px;
            background: var(--background-light);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .suggestion-details {
            flex: 1;
        }

        .suggestion-name {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .suggestion-address {
            font-size: 12px;
            color: var(--text-gray);
            margin-bottom: 2px;
        }

        .suggestion-distance {
            font-size: 11px;
            color: var(--text-light);
        }

        .suggestion-verified {
            font-size: 10px;
            color: var(--success-green);
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 2px;
        }

        /* Stops Container */
        #stopsContainer {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .stop-item {
            background: var(--background-light);
            border-radius: 12px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .stop-item i {
            color: var(--text-gray);
        }

        .stop-item input {
            flex: 1;
            border: none;
            background: none;
            font-size: 14px;
            color: var(--text-dark);
            outline: none;
        }

        .remove-stop {
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            padding: 4px;
        }

        .remove-stop:hover {
            color: var(--error-red);
        }

        /* Ride Type Selection */
        .ride-type-selection {
            margin-bottom: 20px;
        }

        .ride-type-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-dark);
        }

        .ride-type-cards {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .ride-type-card {
            min-width: 100px;
            background: var(--background-light);
            border-radius: 12px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .ride-type-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-light);
        }

        .ride-type-card.selected {
            background: var(--primary-orange);
            color: white;
            border-color: var(--primary-orange);
        }

        .ride-type-card.selected .ride-type-icon {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .ride-type-icon {
            width: 50px;
            height: 50px;
            background: var(--background-white);
            border-radius: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            color: var(--primary-orange);
        }

        .ride-type-name {
            font-size: 13px;
            font-weight: 600;
        }

        .ride-type-price {
            font-size: 16px;
            font-weight: 700;
        }

        /* Fare Display */
        .fare-display {
            background: var(--background-light);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .fare-display.active {
            background: linear-gradient(135deg, var(--primary-orange), #FF8B5C);
            color: white;
        }

        .fare-label {
            font-size: 14px;
            color: var(--text-gray);
            margin-bottom: 8px;
        }

        .fare-display.active .fare-label {
            color: rgba(255, 255, 255, 0.9);
        }

        .fare-amount {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .fare-details {
            display: flex;
            justify-content: center;
            gap: 20px;
            font-size: 14px;
            color: var(--text-gray);
        }

        .fare-display.active .fare-details {
            color: rgba(255, 255, 255, 0.8);
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: var(--primary-orange);
            color: white;
        }

        .btn-primary:hover {
            background: #FF8B5C;
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .btn-secondary {
            background: var(--background-light);
            color: var(--text-dark);
        }

        .btn-secondary:hover {
            background: var(--border-color);
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--error-red);
            color: white;
        }

        .btn-danger:hover {
            background: #FF6B6B;
            transform: translateY(-2px);
        }

        /* Ride Info Panel */
        .ride-info-panel {
            padding: 0 20px 30px;
        }

        .driver-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .driver-avatar {
            width: 70px;
            height: 70px;
            background: var(--background-light);
            border-radius: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            color: var(--text-gray);
            overflow: hidden;
        }

        .driver-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .driver-details {
            flex: 1;
        }

        .driver-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .driver-rating {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 14px;
            color: var(--warning-yellow);
            margin-bottom: 4px;
        }

        .driver-vehicle {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            color: var(--text-gray);
        }

        /* Timeline */
        .timeline {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 0 10px;
        }

        .timeline-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .step-dot {
            width: 40px;
            height: 40px;
            background: var(--background-light);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: var(--text-light);
            transition: all 0.3s ease;
        }

        .step-dot.active {
            background: var(--primary-orange);
            color: white;
            transform: scale(1.1);
        }

        .step-dot.completed {
            background: var(--success-green);
            color: white;
        }

        .step-label {
            font-size: 12px;
            color: var(--text-light);
            text-align: center;
        }

        .step-label.active {
            color: var(--primary-orange);
            font-weight: 500;
        }

        /* Trip Details */
        .trip-details {
            background: var(--background-light);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .trip-locations {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .location-point {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .location-marker {
            width: 32px;
            height: 32px;
            background: var(--background-white);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .location-marker.pickup {
            color: var(--primary-orange);
        }

        .location-marker.destination {
            color: var(--secondary-blue);
        }

        .location-text {
            flex: 1;
        }

        .location-label {
            font-size: 12px;
            color: var(--text-gray);
            margin-bottom: 2px;
        }

        .location-address {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-dark);
        }

        /* Fare Breakdown */
        .fare-breakdown {
            background: var(--background-light);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .fare-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .fare-row.total {
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 0;
        }

        .fare-label {
            color: var(--text-gray);
        }

        .fare-value {
            color: var(--text-dark);
            font-weight: 500;
        }

        .fare-row.total .fare-label {
            color: var(--text-dark);
        }

        .fare-row.total .fare-value {
            color: var(--primary-orange);
        }

        /* Chat Container */
        .chat-container {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 320px;
            background: var(--background-white);
            border-radius: 20px 20px 0 0;
            box-shadow: var(--shadow-heavy);
            z-index: 1001;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .chat-container.active {
            transform: translateY(0);
        }

        .chat-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-dark);
        }

        .chat-close {
            background: none;
            border: none;
            color: var(--text-gray);
            font-size: 18px;
            cursor: pointer;
            padding: 4px;
        }

        .chat-close:hover {
            color: var(--text-dark);
        }

        .chat-messages {
            height: 300px;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.4;
        }

        .message.sent {
            align-self: flex-end;
            background: var(--primary-orange);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.received {
            align-self: flex-start;
            background: var(--background-light);
            color: var(--text-dark);
            border-bottom-left-radius: 4px;
        }

        .message-time {
            font-size: 11px;
            margin-top: 4px;
            opacity: 0.7;
        }

        .message.sent .message-time {
            text-align: right;
        }

        .chat-typing-indicator {
            padding: 10px 20px;
            font-size: 12px;
            color: var(--text-gray);
            display: none;
        }

        .chat-typing-indicator.active {
            display: block;
        }

        .chat-input-container {
            padding: 15px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .chat-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s ease;
        }

        .chat-input:focus {
            border-color: var(--primary-orange);
        }

        .chat-send-btn {
            width: 40px;
            height: 40px;
            background: var(--primary-orange);
            border: none;
            border-radius: 20px;
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .chat-send-btn:hover {
            background: #FF8B5C;
            transform: scale(1.05);
        }

        /* Notifications Panel */
        .notifications-panel {
            position: absolute;
            top: 70px;
            right: 20px;
            width: 320px;
            background: var(--background-white);
            border-radius: 20px;
            box-shadow: var(--shadow-heavy);
            z-index: 1001;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .notifications-panel.active {
            transform: translateX(0);
        }

        .notifications-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notifications-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-dark);
        }

        .notifications-close {
            background: none;
            border: none;
            color: var(--text-gray);
            font-size: 18px;
            cursor: pointer;
            padding: 4px;
        }

        .notifications-list {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px 0;
        }

        .notification-item {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .notification-item:hover {
            background: var(--background-light);
        }

        .notification-item.unread {
            background: rgba(116, 185, 255, 0.1);
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .notification-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-dark);
        }

        .notification-time {
            font-size: 11px;
            color: var(--text-light);
        }

        .notification-message {
            font-size: 13px;
            color: var(--text-gray);
            line-height: 1.4;
        }

        /* Modal Overlays */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }

        .modal {
            background: var(--background-white);
            border-radius: 24px;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-heavy);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-title i {
            color: var(--primary-orange);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-gray);
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
        }

        .modal-close:hover {
            color: var(--text-dark);
        }

        .modal-content {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-dark);
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            font-size: 14px;
            color: var(--text-dark);
            outline: none;
            transition: border-color 0.2s ease;
        }

        .form-control:focus {
            border-color: var(--primary-orange);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        /* Shopping Categories */
        .shopping-categories {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .shopping-category {
            background: var(--background-light);
            border: none;
            border-radius: 12px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .shopping-category:hover {
            background: var(--border-color);
            transform: translateY(-2px);
        }

        .shopping-category.active {
            background: var(--primary-orange);
            color: white;
        }

        .shopping-category i {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .category-name {
            font-size: 13px;
            font-weight: 600;
            text-align: center;
        }

        /* Emergency Stations */
        .emergency-stations {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .emergency-station {
            background: var(--background-light);
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .emergency-station:hover {
            background: var(--border-color);
        }

        .emergency-station.selected {
            border-color: var(--primary-orange);
            background: rgba(255, 107, 53, 0.1);
        }

        .station-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .station-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-dark);
        }

        .station-distance {
            font-size: 13px;
            color: var(--text-gray);
        }

        .station-address {
            font-size: 12px;
            color: var(--text-gray);
            margin-bottom: 5px;
        }

        .station-details {
            display: flex;
            gap: 15px;
            font-size: 11px;
            color: var(--text-light);
        }

        /* Split Ride Friends */
        .share-friends-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .share-friend-item {
            background: var(--background-light);
            border-radius: 12px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .friend-avatar {
            width: 40px;
            height: 40px;
            background: var(--background-white);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--text-gray);
            overflow: hidden;
        }

        .friend-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .friend-info {
            flex: 1;
        }

        .friend-name {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .friend-phone {
            font-size: 12px;
            color: var(--text-gray);
        }

        .remove-friend-btn {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 16px;
            cursor: pointer;
            padding: 4px;
        }

        .remove-friend-btn:hover {
            color: var(--error-red);
        }

        /* Price Calculation */
        .price-calculation {
            background: var(--background-light);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .calculation-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .calculation-row.total {
            padding-top: 8px;
            border-top: 1px solid var(--border-color);
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 0;
        }

        /* Toast Container */
        .toast-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 3000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 320px;
        }

        .toast {
            background: var(--background-white);
            border-radius: 12px;
            padding: 15px 20px;
            box-shadow: var(--shadow-medium);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease;
            border-left: 4px solid var(--info-blue);
        }

        .toast.success {
            border-left-color: var(--success-green);
        }

        .toast.error {
            border-left-color: var(--error-red);
        }

        .toast.warning {
            border-left-color: var(--warning-yellow);
        }

        .toast.info {
            border-left-color: var(--info-blue);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast-icon {
            font-size: 20px;
        }

        .toast.success .toast-icon {
            color: var(--success-green);
        }

        .toast.error .toast-icon {
            color: var(--error-red);
        }

        .toast.warning .toast-icon {
            color: var(--warning-yellow);
        }

        .toast.info .toast-icon {
            color: var(--info-blue);
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .toast-message {
            font-size: 13px;
            color: var(--text-gray);
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 16px;
            cursor: pointer;
            padding: 4px;
        }

        .toast-close:hover {
            color: var(--text-dark);
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 4000;
        }

        .loading-text {
            margin-top: 15px;
            font-size: 16px;
            color: var(--text-gray);
            font-weight: 500;
        }

        /* Pulsing Ride Icon */
        .pulsing-ride-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 80px;
            color: var(--primary-orange);
            z-index: 500;
            animation: pulseLarge 1.5s infinite;
            pointer-events: none;
        }

        @keyframes pulseLarge {
            0% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 0.7;
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }

        /* Schedule Countdown */
        .schedule-countdown {
            background: var(--primary-orange);
            color: white;
            border-radius: 12px;
            padding: 20px;
            margin: 20px;
            text-align: center;
        }

        .countdown-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
            font-size: 16px;
            font-weight: 600;
        }

        .countdown-timer {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .time-unit {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .time-value {
            font-size: 32px;
            font-weight: 700;
            min-width: 50px;
        }

        .time-label {
            font-size: 12px;
            opacity: 0.9;
        }

        .time-separator {
            font-size: 24px;
            font-weight: 700;
            margin: 0 5px;
        }

        /* Responsive adjustments */
        @media (max-width: 480px) {
            .quick-actions {
                grid-template-columns: 1fr;
            }
            
            .ride-type-cards {
                flex-direction: column;
            }
            
            .ride-type-card {
                min-width: auto;
            }
            
            .chat-container {
                width: 100%;
            }
            
            .notifications-panel {
                width: 100%;
                right: 0;
                border-radius: 20px 0 0 20px;
            }
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--background-light);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--text-light);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-gray);
        }
    </style>
</head>
<body>
    <!-- Map Container -->
    <div id="map">
        <div class="map-loading-overlay" id="mapLoadingOverlay">
            <div class="loading-spinner"></div>
            <div class="map-loading-text">Loading map...</div>
        </div>
    </div>
    
    <!-- Top Navigation Bar -->
    <div class="top-bar">
        <div class="logo-container">
            <div class="logo-icon">
                <img src="jubel.png" alt="Jubel Logo" id="jubelLogo">
            </div>
            <div class="logo-text" id="userFullName">Loading...</div>
        </div>
        
        <div class="user-actions">
            <div class="balance-badge" id="balanceBadge">
                <i class="fas fa-wallet"></i>
                <span>Balance: <span class="balance-amount" id="walletBalance">ZMW 0.00</span></span>
            </div>
            <div class="notification-bell" id="notificationBell">
                <i class="fas fa-bell"></i>
                <span class="notification-badge" id="notificationCount">0</span>
            </div>
        </div>
    </div>
    
    <!-- City Detection Indicator -->
    <div class="city-detection" id="cityDetection">
        <i class="fas fa-map-marker-alt"></i>
        <span id="currentCityDisplay">Detecting your city...</span>
    </div>
    
    <!-- Ride Status Bar -->
    <div class="ride-status-bar" id="rideStatusBar">
        <div class="status-indicator">
            <div class="status-dot searching" id="statusDot"></div>
            <span class="status-text" id="statusText">Searching for driver</span>
        </div>
        <div class="status-eta">
            <i class="fas fa-clock"></i>
            <span id="etaText">5 min</span>
        </div>
    </div>
    
    <!-- Emergency Status -->
    <div class="emergency-status" id="emergencyStatus">
        <i class="fas fa-exclamation-triangle"></i>
        <span>EMERGENCY RIDE IN PROGRESS</span>
    </div>
    
    <!-- SOS Button -->
    <div class="sos-button" id="sosButton">
        <i class="fas fa-exclamation-triangle"></i>
    </div>
    
    <!-- Map Controls -->
    <div class="map-controls">
        <button class="map-control-btn" id="locateMeBtn" title="Locate Me">
            <i class="fas fa-location-arrow"></i>
        </button>
        <button class="map-control-btn" id="zoomInBtn" title="Zoom In">
            <i class="fas fa-plus"></i>
        </button>
        <button class="map-control-btn" id="zoomOutBtn" title="Zoom Out">
            <i class="fas fa-minus"></i>
        </button>
        <button class="map-control-btn" id="clearRouteBtn" title="Clear Route">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <!-- Chat Container -->
    <div class="chat-container" id="chatContainer">
        <div class="chat-header">
            <div class="chat-title">Chat with Driver</div>
            <button class="chat-close" id="chatClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <!-- Messages will be inserted here -->
        </div>
        <div class="chat-typing-indicator" id="typingIndicator">
            Driver is typing...
        </div>
        <div class="chat-input-container">
            <input type="text" class="chat-input" id="chatInput" placeholder="Type your message...">
            <button class="chat-send-btn" id="chatSend">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
    
    <!-- Notifications Panel -->
    <div class="notifications-panel" id="notificationsPanel">
        <div class="notifications-header">
            <div class="notifications-title">Notifications</div>
            <button class="notifications-close" id="notificationsClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="notifications-list" id="notificationsList">
            <!-- Notifications will be inserted here -->
        </div>
    </div>
    
    <!-- More Options Menu -->
    <div class="more-options-menu" id="moreOptionsMenu">
        <div class="dropdown-item" data-option="schedule">
            <i class="fas fa-calendar-alt"></i>
            <span>Schedule Ride</span>
        </div>
        <div class="dropdown-item" data-option="orderForSomeone">
            <i class="fas fa-user-friends"></i>
            <span>Order for Someone</span>
        </div>
        <div class="dropdown-item" data-option="shareRide">
            <i class="fas fa-share-alt"></i>
            <span>Share Ride</span>
        </div>
        <div class="dropdown-item" data-option="broadcast">
            <i class="fas fa-broadcast-tower"></i>
            <span>Broadcast Ride</span>
        </div>
    </div>
    
    <!-- Main Panel -->
    <div class="main-panel" id="mainPanel">
        <div class="panel-handle" id="panelHandle"></div>
        
        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" data-screen="home">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </button>
            <button class="nav-tab" data-screen="history">
                <i class="fas fa-history"></i>
                <span>History</span>
            </button>
            <button class="nav-tab" data-screen="account">
                <i class="fas fa-user"></i>
                <span>Account</span>
            </button>
            <button class="nav-tab" data-screen="emergency">
                <i class="fas fa-ambulance"></i>
                <span>Emergency</span>
            </button>
        </div>
        
        <!-- Home Screen Content -->
        <div id="homeContent">
            <!-- Service Tabs -->
            <div class="service-tabs" id="serviceTabs">
                <div class="service-tab car active" data-service="car">
                    <div class="service-icon">
                        <i class="fas fa-car"></i>
                    </div>
                    <div class="service-name">Car</div>
                    <div class="service-desc">Ride anywhere</div>
                </div>
                
                <div class="service-tab delivery" data-service="delivery">
                    <div class="service-icon">
                        <i class="fas fa-shipping-fast"></i>
                    </div>
                    <div class="service-name">Delivery</div>
                    <div class="service-desc">Send packages</div>
                </div>
                
                <div class="service-tab short-delivery" data-service="short-delivery">
                    <div class="service-icon">
                        <i class="fas fa-bicycle"></i>
                    </div>
                    <div class="service-name">Short Delivery</div>
                    <div class="service-desc">Quick deliveries</div>
                </div>
                
                <div class="service-tab" data-service="express">
                    <div class="service-icon">
                        <i class="fas fa-shopping-bag"></i>
                    </div>
                    <div class="service-name">Express Shopping</div>
                    <div class="service-desc">Shop for you</div>
                </div>
                
                <div class="service-tab" data-service="truck">
                    <div class="service-icon">
                        <i class="fas fa-truck"></i>
                    </div>
                    <div class="service-name">Truck</div>
                    <div class="service-desc">Move items</div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="quick-actions">
                <button class="quick-action-btn" id="moreOptionsBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-ellipsis-h"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">More Options</div>
                        <div class="quick-action-desc">Schedule, share, broadcast</div>
                    </div>
                </button>
                <button class="quick-action-btn" id="broadcastRideBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-broadcast-tower"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">Broadcast Ride</div>
                        <div class="quick-action-desc">Share with friends</div>
                    </div>
                </button>
                <button class="quick-action-btn" id="sosSetupBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">SOS Setup</div>
                        <div class="quick-action-desc">Emergency contacts</div>
                    </div>
                </button>
                <button class="quick-action-btn" id="recentDestinationsBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-history"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">Recent Destinations</div>
                        <div class="quick-action-desc">Quick access</div>
                    </div>
                </button>
            </div>
            
            <!-- Car Service Form (Default) -->
            <div class="ride-request-form active" id="carForm">
                <div class="form-title">
                    <i class="fas fa-car"></i>
                    Book a Ride
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="pickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="pickupLocation" placeholder="Current location" readonly>
                        <button class="edit-pickup-btn" style="display: none;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="clear-pickup-btn" style="display: none;">
                            <i class="fas fa-times"></i>
                        </button>
                        <div class="suggestion-list" id="pickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="destinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="destinationLocation" placeholder="Where to?" autocomplete="off">
                        <div class="suggestion-list" id="destinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Stops Container -->
                <div id="stopsContainer" style="margin: 10px 0;"></div>
                <button type="button" class="btn btn-secondary" id="addStopBtn" style="width: 100%; margin-bottom: 15px;">
                    <i class="fas fa-plus"></i> Add Stop
                </button>
                
                <!-- Ride Type Selection -->
                <div class="ride-type-selection" id="rideTypeSelection">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                        <span id="rideTypeInfo" style="font-size: 11px; color: var(--text-light); cursor: pointer;">
                            <i class="fas fa-info-circle"></i>
                        </span>
                    </div>
                    
                    <div class="ride-type-cards" id="rideTypeCardsContainer">
                        <div class="ride-type-card economy" data-type="economy">
                            <div class="ride-type-icon">
                                <i class="fas fa-car-side"></i>
                            </div>
                            <div class="ride-type-name">Economy</div>
                            <div class="ride-type-price" id="economyPrice">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card selected" data-type="standard">
                            <div class="ride-type-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="ride-type-name">Standard</div>
                            <div class="ride-type-price" id="standardPrice">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card premium" data-type="premium">
                            <div class="ride-type-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="ride-type-name">Premium</div>
                            <div class="ride-type-price" id="premiumPrice">ZMW 0.00</div>
                        </div>
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="fareDisplay">
                    <div class="fare-label">Estimated Fare</div>
                    <div class="fare-amount" id="estimatedFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="distanceDetail">0 km</span>
                        <span id="timeDetail">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestRideBtn">
                        <i class="fas fa-search"></i>
                        Request Ride
                    </button>
                </div>
            </div>
            
            <!-- Delivery Service Form -->
            <div class="ride-request-form delivery-form" id="deliveryForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-shipping-fast"></i>
                    Package Delivery
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="deliveryPickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="deliveryPickup" placeholder="Pickup location" readonly>
                        <button class="edit-pickup-btn" style="display: none;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="clear-pickup-btn" style="display: none;">
                            <i class="fas fa-times"></i>
                        </button>
                        <div class="suggestion-list" id="deliveryPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="deliveryDestinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="deliveryDestination" placeholder="Delivery address" autocomplete="off">
                        <div class="suggestion-list" id="deliveryDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Delivery Details -->
                <div class="form-group">
                    <label class="form-label">Parcel Description</label>
                    <input type="text" class="form-control" id="parcelDescription" placeholder="What are you sending?">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Receiver's Details</label>
                    <div class="form-grid">
                        <input type="text" class="form-control" id="receiverName" placeholder="Receiver name">
                        <input type="tel" class="form-control" id="receiverPhone" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Parcel Value (ZMW)</label>
                    <input type="number" class="form-control" id="parcelValue" placeholder="Value of parcel" min="0" step="0.01">
                </div>
                
                <!-- Delivery Options -->
                <div class="form-group">
                    <label class="form-label">Delivery Type</label>
                    <div style="display: flex; gap: 10px; margin-top: 8px;">
                        <button class="btn btn-secondary delivery-type-btn active" data-type="standard">Standard</button>
                        <button class="btn btn-secondary delivery-type-btn" data-type="express">Express</button>
                        <button class="btn btn-secondary delivery-type-btn" data-type="sameDay">Same Day</button>
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="deliveryFareDisplay">
                    <div class="fare-label">Delivery Fare</div>
                    <div class="fare-amount" id="deliveryFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="deliveryDistance">0 km</span>
                        <span id="deliveryTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestDeliveryBtn">
                        <i class="fas fa-shipping-fast"></i>
                        Request Delivery
                    </button>
                </div>
            </div>
            
            <!-- Short Delivery Form -->
            <div class="ride-request-form delivery-form" id="shortDeliveryForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-bicycle"></i>
                    Short Delivery
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="shortDeliveryPickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="shortDeliveryPickup" placeholder="Pickup location" readonly>
                        <button class="edit-pickup-btn" style="display: none;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="clear-pickup-btn" style="display: none;">
                            <i class="fas fa-times"></i>
                        </button>
                        <div class="suggestion-list" id="shortDeliveryPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="shortDeliveryDestinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="shortDeliveryDestination" placeholder="Delivery address" autocomplete="off">
                        <div class="suggestion-list" id="shortDeliveryDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Delivery Details -->
                <div class="form-group">
                    <label class="form-label">What are you sending?</label>
                    <input type="text" class="form-control" id="shortParcelDescription" placeholder="Food, documents, small items...">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Receiver's Phone</label>
                    <input type="tel" class="form-control" id="shortReceiverPhone" placeholder="Receiver phone number">
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="shortDeliveryFareDisplay">
                    <div class="fare-label">Delivery Fare</div>
                    <div class="fare-amount" id="shortDeliveryFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="shortDeliveryDistance">0 km</span>
                        <span id="shortDeliveryTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestShortDeliveryBtn">
                        <i class="fas fa-bolt"></i>
                        Quick Delivery
                    </button>
                </div>
            </div>
            
            <!-- Express Shopping Form -->
            <div class="ride-request-form express-form" id="expressForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-shopping-bag"></i>
                    Express Shopping
                </div>
                
                <!-- Shopping Categories -->
                <div class="shopping-categories" id="shoppingCategories">
                    <button class="shopping-category" data-category="restaurant">
                        <i class="fas fa-utensils"></i>
                        <div class="category-name">Restaurants</div>
                    </button>
                    <button class="shopping-category" data-category="pharmacy">
                        <i class="fas fa-prescription-bottle-medical"></i>
                        <div class="category-name">Pharmacies</div>
                    </button>
                    <button class="shopping-category" data-category="supermarket">
                        <i class="fas fa-shopping-cart"></i>
                        <div class="category-name">Supermarkets</div>
                    </button>
                    <button class="shopping-category" data-category="mall">
                        <i class="fas fa-store"></i>
                        <div class="category-name">Shopping Malls</div>
                    </button>
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="shopNameInput">
                        <i class="fas fa-store"></i>
                        <input type="text" id="shopName" placeholder="Shop/Restaurant name" autocomplete="off">
                        <div class="suggestion-list" id="shopSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="shopLocation" placeholder="Shop location" readonly>
                    </div>
                </div>
                
                <!-- Items List -->
                <div class="form-group">
                    <label class="form-label">Shopping List</label>
                    <div class="item-list" id="shoppingItems">
                        <div class="item-entry">
                            <input type="text" class="item-input" placeholder="Item name">
                            <button class="remove-item" type="button">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <button class="btn btn-secondary" type="button" id="addItemBtn" style="margin-top: 10px;">
                        <i class="fas fa-plus"></i>
                        Add Item
                    </button>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Special Instructions</label>
                    <textarea class="form-control form-textarea" id="shoppingInstructions" placeholder="Any specific requests or instructions..."></textarea>
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="shoppingDestinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="shoppingDestination" placeholder="Delivery address" autocomplete="off">
                        <div class="suggestion-list" id="shoppingDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Budget -->
                <div class="form-group">
                    <label class="form-label">Estimated Budget (ZMW)</label>
                    <input type="number" class="form-control" id="shoppingBudget" placeholder="Estimated cost of items">
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="shoppingFareDisplay">
                    <div class="fare-label">Shopping Service Fare</div>
                    <div class="fare-amount" id="shoppingFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="shoppingDistance">0 km</span>
                        <span id="shoppingTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestShoppingBtn">
                        <i class="fas fa-shopping-cart"></i>
                        Request Shopping
                    </button>
                </div>
            </div>
            
            <!-- Truck Delivery Form -->
            <div class="ride-request-form truck-form" id="truckForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-truck"></i>
                    Truck Delivery
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="truckPickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="truckPickup" placeholder="Pickup location (Current location)" readonly>
                        <button class="edit-pickup-btn" style="display: none;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="clear-pickup-btn" style="display: none;">
                            <i class="fas fa-times"></i>
                        </button>
                        <div class="suggestion-list" id="truckPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="truckDestinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="truckDestination" placeholder="Destination" autocomplete="off">
                        <div class="suggestion-list" id="truckDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Truck Type Selection -->
                <div class="form-group">
                    <label class="form-label">Select Truck Type</label>
                    <div class="ride-type-cards">
                        <div class="ride-type-card" data-type="pickup">
                            <div class="ride-type-icon">
                                <i class="fas fa-truck-pickup"></i>
                            </div>
                            <div class="ride-type-name">Pickup Truck</div>
                            <div class="ride-type-price" id="pickupTruckPrice">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card selected" data-type="light">
                            <div class="ride-type-icon">
                                <i class="fas fa-truck-moving"></i>
                            </div>
                            <div class="ride-type-name">Light Truck</div>
                            <div class="ride-type-price" id="lightTruckPrice">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card" data-type="medium">
                            <div class="ride-type-icon">
                                <i class="fas fa-truck"></i>
                            </div>
                            <div class="ride-type-name">Medium Truck</div>
                            <div class="ride-type-price" id="mediumTruckPrice">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card" data-type="heavy">
                            <div class="ride-type-icon">
                                <i class="fas fa-truck-loading"></i>
                            </div>
                            <div class="ride-type-name">Heavy Truck</div>
                            <div class="ride-type-price" id="heavyTruckPrice">ZMW 0.00</div>
                        </div>
                    </div>
                </div>
                
                <!-- Item Details -->
                <div class="form-group">
                    <label class="form-label">What are you moving?</label>
                    <input type="text" class="form-control" id="truckItemDescription" placeholder="Furniture, boxes, equipment...">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Estimated Weight (kg)</label>
                    <input type="number" class="form-control" id="estimatedWeight" placeholder="Approximate weight">
                </div>
                
                <!-- Additional Help -->
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="needHelpers">
                        <span style="margin-left: 8px;">Need loading/unloading helpers (+ZMW 50)</span>
                    </label>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="truckFareDisplay">
                    <div class="fare-label">Truck Fare</div>
                    <div class="fare-amount" id="truckFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="truckDistance">0 km</span>
                        <span id="truckTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestTruckBtn">
                        <i class="fas fa-truck"></i>
                        Request Truck
                    </button>
                </div>
            </div>
            
            <!-- Split Ride Form -->
            <div class="ride-request-form" id="splitRideForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-user-friends"></i>
                    Split Ride
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="splitPickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="splitPickup" placeholder="Pickup location" readonly>
                        <button class="edit-pickup-btn" style="display: none;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="clear-pickup-btn" style="display: none;">
                            <i class="fas fa-times"></i>
                        </button>
                        <div class="suggestion-list" id="splitPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="splitDestinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="splitDestination" placeholder="Destination" autocomplete="off">
                        <div class="suggestion-list" id="splitDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Add Friends Section -->
                <div class="form-group">
                    <label class="form-label">Add Friends (Max 3)</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="text" class="form-control" id="splitFriendInput" placeholder="Enter friend's referral code">
                        <button class="btn btn-secondary" id="addSplitFriendBtn" style="min-width: 60px;">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    
                    <!-- Friends List -->
                    <div class="share-friends-list" id="splitFriendsList">
                        <!-- Friends will be added here -->
                    </div>
                </div>
                
                <!-- Ride Type Selection -->
                <div class="ride-type-selection">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                    </div>
                    <div class="ride-type-cards">
                        <div class="ride-type-card economy" data-type="economy">
                            <div class="ride-type-icon">
                                <i class="fas fa-car-side"></i>
                            </div>
                            <div class="ride-type-name">Economy</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card selected" data-type="standard">
                            <div class="ride-type-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="ride-type-name">Standard</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card premium" data-type="premium">
                            <div class="ride-type-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="ride-type-name">Premium</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                    </div>
                </div>
                
                <!-- Price Calculation -->
                <div class="price-calculation">
                    <div class="calculation-row">
                        <span>Total Fare:</span>
                        <span id="splitTotalFare">ZMW 0.00</span>
                    </div>
                    <div class="calculation-row">
                        <span>Your Share:</span>
                        <span id="splitYourShare">ZMW 0.00</span>
                    </div>
                    <div class="calculation-row">
                        <span>Each Friend's Share:</span>
                        <span id="splitFriendShare">ZMW 0.00</span>
                    </div>
                    <div class="calculation-row total">
                        <span>Split Between:</span>
                        <span id="splitPeopleCount">1 person</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestSplitRideBtn">
                        <i class="fas fa-user-friends"></i>
                        Request Split Ride
                    </button>
                </div>
            </div>
            
            <!-- Broadcast Ride Form -->
            <div class="ride-request-form" id="broadcastRideForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-broadcast-tower"></i>
                    Broadcast Ride
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="broadcastPickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="broadcastPickup" placeholder="Pickup location" readonly>
                        <button class="edit-pickup-btn" style="display: none;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="clear-pickup-btn" style="display: none;">
                            <i class="fas fa-times"></i>
                        </button>
                        <div class="suggestion-list" id="broadcastPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="broadcastDestinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="broadcastDestination" placeholder="Destination" autocomplete="off">
                        <div class="suggestion-list" id="broadcastDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Add Referral Codes -->
                <div class="form-group">
                    <label class="form-label">Add Friends to Broadcast</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="text" class="form-control" id="broadcastFriendInput" placeholder="Enter friend's referral code">
                        <button class="btn btn-secondary" id="addBroadcastFriendBtn" style="min-width: 60px;">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    
                    <!-- Friends List -->
                    <div class="share-friends-list" id="broadcastFriendsList">
                        <!-- Friends will be added here -->
                    </div>
                </div>
                
                <!-- Ride Type Selection -->
                <div class="ride-type-selection">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                    </div>
                    <div class="ride-type-cards">
                        <div class="ride-type-card economy" data-type="economy">
                            <div class="ride-type-icon">
                                <i class="fas fa-car-side"></i>
                            </div>
                            <div class="ride-type-name">Economy</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card selected" data-type="standard">
                            <div class="ride-type-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="ride-type-name">Standard</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card premium" data-type="premium">
                            <div class="ride-type-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="ride-type-name">Premium</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="broadcastFareDisplay">
                    <div class="fare-label">Broadcast Ride Fare</div>
                    <div class="fare-amount" id="broadcastFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="broadcastDistance">0 km</span>
                        <span id="broadcastTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="startBroadcastRideBtn">
                        <i class="fas fa-broadcast-tower"></i>
                        Start Broadcast
                    </button>
                </div>
            </div>
            
            <!-- Ride Info Panel -->
            <div class="ride-info-panel" id="rideInfoPanel" style="display: none;">
                <div class="driver-info">
                    <div class="driver-avatar" id="driverAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="driver-details">
                        <div class="driver-name" id="driverName">Driver Name</div>
                        <div class="driver-rating">
                            <i class="fas fa-star"></i>
                            <span id="driverRating">4.8</span>
                        </div>
                        <div class="driver-vehicle">
                            <i class="fas fa-car"></i>
                            <span id="vehicleDetails">Toyota Corolla - ABC 123</span>
                        </div>
                    </div>
                </div>
                
                <!-- Timeline -->
                <div class="timeline" id="rideTimeline">
                    <div class="timeline-step">
                        <div class="step-dot active" id="stepRequested">
                            <i class="fas fa-search"></i>
                        </div>
                        <div class="step-label active">Requested</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepAccepted">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <div class="step-label">Accepted</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepArrived">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="step-label">Arrived</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepStarted">
                            <i class="fas fa-play"></i>
                        </div>
                        <div class="step-label">Started</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepCompleted">
                            <i class="fas fa-flag-checkered"></i>
                        </div>
                        <div class="step-label">Completed</div>
                    </div>
                </div>
                
                <div class="trip-details">
                    <div class="trip-locations">
                        <div class="location-point">
                            <div class="location-marker pickup">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="location-text">
                                <div class="location-label">Pickup</div>
                                <div class="location-address" id="currentPickup">Loading...</div>
                            </div>
                        </div>
                        
                        <div class="location-point">
                            <div class="location-marker destination">
                                <i class="fas fa-flag"></i>
                            </div>
                            <div class="location-text">
                                <div class="location-label">Destination</div>
                                <div class="location-address" id="currentDestination">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="fare-breakdown">
                    <div class="fare-row">
                        <span class="fare-label">Base Fare</span>
                        <span class="fare-value" id="baseFareValue">ZMW 15.00</span>
                    </div>
                    <div class="fare-row">
                        <span class="fare-label">Distance</span>
                        <span class="fare-value" id="distanceFareValue">ZMW 5.00</span>
                    </div>
                    <div class="fare-row">
                        <span class="fare-label">Ride Type</span>
                        <span class="fare-value" id="rideTypeValue">Standard</span>
                    </div>
                    <div class="fare-row total">
                        <span class="fare-label">Total Fare</span>
                        <span class="fare-value" id="totalFareValue">ZMW 20.00</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-danger" id="cancelRideBtn">
                        <i class="fas fa-times-circle"></i>
                        Cancel Ride
                    </button>
                    <button class="btn btn-secondary" id="contactDriverBtn">
                        <i class="fas fa-phone"></i>
                        Call Driver
                    </button>
                    <button class="btn btn-secondary" id="openChatBtn">
                        <i class="fas fa-comment"></i>
                        Chat
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- History Screen -->
    <div class="ride-request-form" id="historyScreen" style="display: none;">
        <div class="screen-header" style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
            <button class="btn btn-secondary back-btn" data-screen="home" style="width: 40px; padding: 10px;">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="form-title">Ride History</div>
        </div>
        
        <div style="display: flex; gap: 8px; overflow-x: auto; margin-bottom: 20px; padding-bottom: 10px;">
            <button class="btn btn-secondary filter-btn active" data-filter="all">All</button>
            <button class="btn btn-secondary filter-btn" data-filter="completed">Completed</button>
            <button class="btn btn-secondary filter-btn" data-filter="cancelled">Cancelled</button>
            <button class="btn btn-secondary filter-btn" data-filter="scheduled">Scheduled</button>
            <button class="btn btn-secondary filter-btn" data-filter="emergency">Emergency</button>
            <button class="btn btn-secondary filter-btn" data-filter="delivery">Delivery</button>
            <button class="btn btn-secondary filter-btn" data-filter="truck">Truck</button>
            <button class="btn btn-secondary filter-btn" data-filter="broadcast">Broadcast</button>
            <button class="btn btn-secondary filter-btn" data-filter="share">Share</button>
        </div>
        
        <div class="history-list" id="historyList">
            <!-- History items will be inserted here -->
        </div>
    </div>
    
    <!-- Account Screen -->
    <div class="ride-request-form" id="accountScreen" style="display: none;">
        <div class="screen-header" style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
            <button class="btn btn-secondary back-btn" data-screen="home" style="width: 40px; padding: 10px;">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="form-title">My Account</div>
        </div>
        
        <div class="account-header" style="text-align: center; margin-bottom: 30px;">
            <div class="driver-avatar" id="accountAvatar" style="margin: 0 auto 15px;">
                <i class="fas fa-user"></i>
            </div>
            <div class="driver-name" id="accountName">Loading...</div>
            <div style="font-size: 14px; color: var(--text-gray);" id="accountPhone">Loading...</div>
        </div>
        
        <div class="fare-display" style="margin-bottom: 30px;">
            <div class="fare-label">Wallet Balance</div>
            <div class="fare-amount" id="accountBalance">ZMW 0.00</div>
            <div class="fare-details">
                <span>Available for rides</span>
            </div>
        </div>
        
        <div class="action-buttons" style="margin-bottom: 30px;">
            <button class="btn btn-primary" id="depositBtn">
                <i class="fas fa-plus"></i>
                Deposit
            </button>
            <button class="btn btn-secondary" id="withdrawBtn">
                <i class="fas fa-minus"></i>
                Withdraw
            </button>
            <button class="btn btn-secondary" id="transferBtn">
                <i class="fas fa-exchange-alt"></i>
                Transfer
            </button>
        </div>
        
        <div class="form-group">
            <label class="form-label">Your Referral Code</label>
            <div style="display: flex; gap: 10px;">
                <input type="text" class="form-control" id="referralCode" value="JUBEL-XXXX" readonly>
                <button class="btn btn-secondary" id="copyReferralBtn" style="min-width: 60px;">
                    <i class="fas fa-copy"></i>
                </button>
            </div>
            <div style="font-size: 12px; color: var(--text-gray); margin-top: 5px;">
                Share this code with friends to earn ZMW 25 on their first ride
            </div>
        </div>
        
        <div class="action-buttons">
            <button class="btn btn-secondary" id="updateProfileBtn">
                <i class="fas fa-user-edit"></i>
                Update Profile
            </button>
            <button class="btn btn-danger" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i>
                Logout
            </button>
        </div>
    </div>
    
    <!-- Emergency Screen -->
    <div class="ride-request-form" id="emergencyScreen" style="display: none;">
        <div class="screen-header" style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
            <button class="btn btn-secondary back-btn" data-screen="home" style="width: 40px; padding: 10px;">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="form-title">Emergency Services</div>
        </div>
        
        <div class="emergency-services" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 30px;">
            <button class="shopping-category emergency-service" data-type="police">
                <i class="fas fa-shield-alt"></i>
                <div class="category-name">Police</div>
            </button>
            
            <button class="shopping-category emergency-service" data-type="hospital">
                <i class="fas fa-hospital"></i>
                <div class="category-name">Hospital</div>
            </button>
            
            <button class="shopping-category emergency-service" data-type="fire">
                <i class="fas fa-fire-extinguisher"></i>
                <div class="category-name">Fire Brigade</div>
            </button>
            
            <button class="shopping-category emergency-service" data-type="sos">
                <i class="fas fa-exclamation-triangle"></i>
                <div class="category-name">SOS Setup</div>
            </button>
        </div>
        
        <div style="background: rgba(253, 203, 110, 0.1); border-radius: 12px; padding: 15px; margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                <i class="fas fa-exclamation-circle" style="color: var(--warning-yellow);"></i>
                <div style="font-weight: 600; color: var(--text-dark);">Important Notice</div>
            </div>
            <div style="font-size: 13px; color: var(--text-gray);">
                Only use emergency services for genuine emergencies. Misuse may result in penalties. In case of immediate danger, call 911 first.
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    
    <!-- Payment Modal -->
    <div class="modal-overlay" id="paymentModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-credit-card"></i>
                    Select Payment Method
                </div>
                <button class="modal-close" data-modal="payment">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <div class="form-label">Available Balance: <span id="paymentBalance">ZMW 0.00</span></div>
                    <div class="form-label">Total Amount: <span id="paymentAmount">ZMW 0.00</span></div>
                </div>
                
                <!-- Referral Discount Section -->
                <div class="form-group" id="referralDiscountSection" style="display: none;">
                    <label class="form-label">Referral Code (50% Discount)</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" class="form-control" id="referralCodeInput" placeholder="Enter referral code">
                        <button id="applyReferralBtn" class="btn btn-secondary" style="min-width: 80px;">
                            Apply
                        </button>
                    </div>
                    <div id="referrerInfo" style="font-size: 12px; color: var(--success-green); margin-top: 5px; display: none;"></div>
                </div>
                
                <div class="fare-breakdown" style="margin-bottom: 20px;">
                    <div class="fare-row">
                        <span class="fare-label">Original Fare:</span>
                        <span class="fare-value" id="originalFareAmount">ZMW 0.00</span>
                    </div>
                    <div class="fare-row">
                        <span class="fare-label">Discount:</span>
                        <span class="fare-value" id="discountAmount" style="color: var(--success-green);">-ZMW 0.00</span>
                    </div>
                    <div class="fare-row total">
                        <span class="fare-label">Final Fare:</span>
                        <span class="fare-value" id="finalFareAmount" style="color: var(--primary-orange);">ZMW 0.00</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Select Payment Method</label>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button class="btn btn-secondary payment-method active" data-payment="wallet">
                            <i class="fas fa-wallet"></i> Jubel Wallet
                        </button>
                        <button class="btn btn-secondary payment-method" data-payment="cash">
                            <i class="fas fa-money-bill"></i> Cash
                        </button>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmPaymentBtn">
                        <i class="fas fa-check"></i>
                        Confirm Payment
                    </button>
                    <button class="btn btn-secondary" data-modal="payment">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Cancel Ride Modal -->
    <div class="modal-overlay" id="cancelModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-times-circle"></i>
                    Cancel Ride
                </div>
                <button class="modal-close" data-modal="cancel">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <div class="form-label">Please select a reason for cancellation:</div>
                </div>
                
                <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px;">
                    <button class="btn btn-secondary cancel-reason" data-reason="driver_late">
                        <i class="fas fa-clock"></i> Driver is taking too long
                    </button>
                    
                    <button class="btn btn-secondary cancel-reason" data-reason="change_plans">
                        <i class="fas fa-calendar-times"></i> Change of plans
                    </button>
                    
                    <button class="btn btn-secondary cancel-reason" data-reason="found_alternative">
                        <i class="fas fa-car"></i> Found alternative transport
                    </button>
                    
                    <button class="btn btn-secondary cancel-reason" data-reason="emergency">
                        <i class="fas fa-exclamation"></i> Emergency situation
                    </button>
                    
                    <button class="btn btn-secondary cancel-reason" data-reason="other">
                        <i class="fas fa-ellipsis-h"></i> Other reason
                    </button>
                </div>
                
                <div class="form-group" id="otherReasonGroup" style="display: none;">
                    <label class="form-label">Please specify:</label>
                    <textarea class="form-control form-textarea" id="otherReason" placeholder="Enter your reason here..."></textarea>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-danger" id="confirmCancelBtn">
                        <i class="fas fa-times"></i>
                        Cancel Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="cancel">
                        Go Back
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Emergency Ride Modal -->
    <div class="modal-overlay" id="emergencyModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-ambulance"></i>
                    <span id="emergencyServiceTitle">Emergency Ride Details</span>
                </div>
                <button class="modal-close" data-modal="emergency">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <div class="form-label">Emergency Reason</div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;">
                        <button class="btn btn-secondary emergency-reason-btn" data-reason="accident">Accident</button>
                        <button class="btn btn-secondary emergency-reason-btn" data-reason="medical">Medical Emergency</button>
                        <button class="btn btn-secondary emergency-reason-btn" data-reason="crime">Crime/Assault</button>
                        <button class="btn btn-secondary emergency-reason-btn" data-reason="fire">Fire Emergency</button>
                        <button class="btn btn-secondary emergency-reason-btn" data-reason="other">Other</button>
                    </div>
                    
                    <div class="form-group" id="emergencyReasonOther" style="display: none; margin-top: 15px;">
                        <label class="form-label">Please describe the emergency:</label>
                        <textarea class="form-control form-textarea" id="emergencyOtherReason" placeholder="Describe the emergency situation..."></textarea>
                    </div>
                </div>
                
                <!-- Emergency Stations -->
                <div class="form-group">
                    <label class="form-label">Select Nearest Station</label>
                    <div class="emergency-stations" id="emergencyStations">
                        <!-- Stations will be inserted here -->
                    </div>
                </div>
                
                <!-- Location Details -->
                <div class="location-details" style="background: var(--background-light); border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <i class="fas fa-map-marker-alt" style="color: var(--primary-orange);"></i>
                        <div style="font-weight: 500; color: var(--text-dark);">Your Location</div>
                    </div>
                    <div style="font-size: 14px; color: var(--text-gray);" id="emergencyUserLocation">Detecting location...</div>
                </div>
                
                <!-- Price Calculation -->
                <div class="fare-breakdown" style="margin-bottom: 20px;">
                    <div class="fare-row">
                        <span class="fare-label">Base Emergency Fare:</span>
                        <span class="fare-value" id="emergencyBaseFare">ZMW 100.00</span>
                    </div>
                    <div class="fare-row">
                        <span class="fare-label">Distance to Station:</span>
                        <span class="fare-value" id="emergencyDistance">0 km</span>
                    </div>
                    <div class="fare-row">
                        <span class="fare-label">Estimated Time:</span>
                        <span class="fare-value" id="emergencyTime">5 min</span>
                    </div>
                    <div class="fare-row total">
                        <span class="fare-label">Total Fare:</span>
                        <span class="fare-value" id="emergencyTotalFare" style="color: var(--error-red);">ZMW 100.00</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-danger" id="confirmEmergencyBtn">
                        <i class="fas fa-exclamation-triangle"></i>
                        Request Emergency Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="emergency">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- SOS Setup Modal -->
    <div class="modal-overlay" id="sosModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    SOS Emergency Setup
                </div>
                <button class="modal-close" data-modal="sos">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <label class="form-label">Primary Emergency Contact</label>
                    <div class="form-grid">
                        <input type="text" class="form-control" id="sosContact1Name" placeholder="Contact name">
                        <input type="tel" class="form-control" id="sosContact1Phone" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Secondary Emergency Contact (Optional)</label>
                    <div class="form-grid">
                        <input type="text" class="form-control" id="sosContact2Name" placeholder="Contact name">
                        <input type="tel" class="form-control" id="sosContact2Phone" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Emergency Message</label>
                    <textarea class="form-control form-textarea" id="sosMessage" rows="3">
I need help! My current location and ride details will be shared with you.
                    </textarea>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="saveSOSBtn">
                        <i class="fas fa-save"></i>
                        Save SOS Setup
                    </button>
                    <button class="btn btn-secondary" data-modal="sos">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Schedule Ride Modal -->
    <div class="modal-overlay" id="scheduleModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-calendar-alt"></i>
                    Schedule a Ride
                </div>
                <button class="modal-close" data-modal="schedule">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="location-inputs">
                    <div class="location-input" id="schedulePickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="schedulePickup" placeholder="Pickup location" readonly>
                        <button class="edit-pickup-btn" style="display: none;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="clear-pickup-btn" style="display: none;">
                            <i class="fas fa-times"></i>
                        </button>
                        <div class="suggestion-list" id="schedulePickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="scheduleDestinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="scheduleDestination" placeholder="Destination" autocomplete="off">
                        <div class="suggestion-list" id="scheduleDestinationSuggestions"></div>
                    </div>
                </div>
                
                <div class="form-grid" style="margin-bottom: 20px;">
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-control" id="scheduleDate" min="">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Time</label>
                        <input type="time" class="form-control" id="scheduleTime">
                    </div>
                </div>
                
                <!-- Ride Type Selection -->
                <div class="ride-type-selection" style="margin-bottom: 20px;">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                    </div>
                    <div class="ride-type-cards">
                        <div class="ride-type-card economy" data-type="economy">
                            <div class="ride-type-icon">
                                <i class="fas fa-car-side"></i>
                            </div>
                            <div class="ride-type-name">Economy</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card selected" data-type="standard">
                            <div class="ride-type-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="ride-type-name">Standard</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card premium" data-type="premium">
                            <div class="ride-type-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="ride-type-name">Premium</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="scheduleFareDisplay">
                    <div class="fare-label">Scheduled Ride Fare</div>
                    <div class="fare-amount" id="scheduleFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="scheduleDistance">0 km</span>
                        <span id="scheduleTimeEstimate">ETA: 0 min</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmScheduleBtn">
                        <i class="fas fa-calendar-check"></i>
                        Schedule Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="schedule">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Share Ride Invitation Modal -->
    <div class="modal-overlay" id="shareInvitationModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-user-friends"></i>
                    Share Ride Invitation
                </div>
                <button class="modal-close" data-modal="shareInvitation">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="driver-info" style="margin-bottom: 20px;">
                    <div class="driver-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="driver-details">
                        <div class="driver-name" id="invitationHostName">John Doe</div>
                        <div class="driver-vehicle">
                            <i class="fas fa-user-friends"></i>
                            <span>Invited you to share a ride</span>
                        </div>
                    </div>
                </div>
                
                <div class="trip-details" style="margin-bottom: 20px;">
                    <div class="trip-locations">
                        <div class="location-point">
                            <div class="location-marker pickup">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="location-text">
                                <div class="location-label">From</div>
                                <div class="location-address" id="invitationPickup">Loading...</div>
                            </div>
                        </div>
                        
                        <div class="location-point">
                            <div class="location-marker destination">
                                <i class="fas fa-flag"></i>
                            </div>
                            <div class="location-text">
                                <div class="location-label">To</div>
                                <div class="location-address" id="invitationDestination">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="fare-breakdown" style="margin-bottom: 20px;">
                    <div class="fare-row">
                        <span class="fare-label">Distance</span>
                        <span class="fare-value" id="invitationDistance">0 km</span>
                    </div>
                    <div class="fare-row">
                        <span class="fare-label">Total Fare</span>
                        <span class="fare-value" id="invitationTotalFare">ZMW 0.00</span>
                    </div>
                    <div class="fare-row total">
                        <span class="fare-label">Your Share</span>
                        <span class="fare-value" id="invitationYourShare" style="color: var(--primary-orange);">ZMW 0.00</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="acceptShareInvitationBtn">
                        <i class="fas fa-check"></i>
                        Accept & Pay
                    </button>
                    <button class="btn btn-danger" id="rejectShareInvitationBtn">
                        <i class="fas fa-times"></i>
                        Decline
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Wallet Transfer Modal -->
    <div class="modal-overlay" id="transferModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-exchange-alt"></i>
                    Transfer Money
                </div>
                <button class="modal-close" data-modal="transfer">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <div class="form-label">Available Balance: <span id="transferBalance">ZMW 0.00</span></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Recipient's Referral Code</label>
                    <input type="text" class="form-control" id="recipientCode" placeholder="Enter recipient's Jubel referral code">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Amount (ZMW)</label>
                    <input type="number" class="form-control" id="transferAmount" placeholder="Enter amount" min="1" step="0.01">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Message (Optional)</label>
                    <input type="text" class="form-control" id="transferMessage" placeholder="Add a message">
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmTransferBtn">
                        <i class="fas fa-paper-plane"></i>
                        Send Money
                    </button>
                    <button class="btn btn-secondary" data-modal="transfer">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Shopping Locations Modal -->
    <div class="modal-overlay" id="shoppingLocationsModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-store"></i>
                    <span id="shoppingCategoryTitle">Select Location</span>
                </div>
                <button class="modal-close" data-modal="shoppingLocations">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="emergency-stations" id="shoppingLocationsList">
                    <!-- Shopping locations will be inserted here -->
                </div>
                
                <div class="action-buttons" style="margin-top: 20px;">
                    <button class="btn btn-secondary" data-modal="shoppingLocations">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Loading...</div>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- External JavaScript Libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
// ============================================
// FIREBASE CONFIGURATION AND INITIALIZATION
// ============================================
const firebaseConfig = {
    apiKey: "AIzaSyDEACX_P4c5q7djJAcA0I7Lk7leO2TlQ74",
    authDomain: "jubel-13e1a.firebaseapp.com",
    databaseURL: "https://jubel-13e1a-default-rtdb.firebaseio.com",
    projectId: "jubel-13e1a",
    storageBucket: "jubel-13e1a.firebasestorage.app",
    messagingSenderId: "882241095445",
    appId: "1:882241095445:web:ee9ca40fddd008ca910b1c",
    measurementId: "G-J5JPKL6B5F"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const auth = firebase.auth();

// ============================================
// GLOBAL STATE MANAGEMENT
// ============================================
const AppState = {
    // User State
    currentUser: null,
    userData: null,
    walletBalance: 0,
    
    // Location State
    userLocation: null,
    currentCity: null,
    pickup: null,
    destination: null,
    stops: [],
    
    // Ride State
    currentRide: null,
    activeService: 'car',
    selectedRideType: 'standard',
    rideFare: 0,
    
    // UI State
    activeScreen: 'home',
    chatOpen: false,
    notificationsOpen: false,
    
    // Features State
    sosConfig: null,
    scheduledRides: [],
    shareRideFriends: [],
    broadcastFriends: [],
    emergencyStations: {},
    
    // Real-time Listeners
    realtimeListeners: [],
    
    // Configuration
    rideTypes: {
        economy: { base: 15, perKm: 2.5, multiplier: 0.8, min: 10 },
        standard: { base: 20, perKm: 3.0, multiplier: 1.0, min: 15 },
        premium: { base: 30, perKm: 4.0, multiplier: 1.5, min: 25 }
    },
    
    deliveryTypes: {
        standard: { base: 25, perKm: 2.0, multiplier: 1.0 },
        express: { base: 40, perKm: 3.0, multiplier: 1.5 },
        sameDay: { base: 60, perKm: 4.0, multiplier: 2.0 }
    },
    
    truckTypes: {
        pickup: { base: 80, perKm: 5.0, multiplier: 1.0 },
        light: { base: 120, perKm: 6.0, multiplier: 1.2 },
        medium: { base: 200, perKm: 8.0, multiplier: 1.5 },
        heavy: { base: 350, perKm: 12.0, multiplier: 2.0 }
    },
    
    emergencyServices: {
        police: { base: 150, perKm: 5.0, multiplier: 2.0 },
        hospital: { base: 180, perKm: 5.5, multiplier: 2.2 },
        fire: { base: 200, perKm: 6.0, multiplier: 2.5 }
    },
    
    // Shopping categories
    shoppingCategories: {
        restaurant: ['Pizza', 'Nando\'s', 'Hungry Lion'],
        pharmacy: ['Pharmacy', 'Chemist', 'Drug Store'],
        supermarket: ['Supermarket', 'Grocery', 'Market'],
        mall: ['Mall', 'Shopping Centre', 'Plaza']
    },
    
    // Search cache
    searchCache: new Map(),
    searchHistory: [],
    
    // Referral system
    referralDiscountApplied: false,
    referralCodeUsed: null,
    referralOwnerName: null,
    
    // Active timers
    activeScheduledTimer: null,
    
    // Map references
    map: null,
    currentLocationMarker: null,
    pickupMarker: null,
    destinationMarker: null,
    driverMarker: null,
    routeLayer: null,
    pulsingIcon: null
};

// ============================================
// CORE APPLICATION FUNCTIONS
// ============================================

// Initialize the application
async function initializeApp() {
    try {
        showLoading('Initializing app...');
        
        // Check authentication
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                AppState.currentUser = user;
                await loadUserData(user.uid);
                initializeMap();
                setupEventListeners();
                getCurrentLocation();
                startRealtimeSync(user.uid);
                hideLoading();
                showToast('Jubel Passenger App Ready', 'success');
            } else {
                window.location.href = 'signup.html';
            }
        });
    } catch (error) {
        console.error('Error initializing app:', error);
        hideLoading();
        showToast('Error initializing app', 'error');
    }
}

// Load user data from Firebase
async function loadUserData(uid) {
    try {
        const snapshot = await database.ref(`users/${uid}`).once('value');
        AppState.userData = snapshot.val();
        
        if (AppState.userData) {
            AppState.walletBalance = AppState.userData.walletBalance || 0;
            updateWalletDisplay();
            updateUserInfo();
            
            // Load additional user data
            await Promise.all([
                loadSOSConfig(uid),
                loadScheduledRides(uid),
                loadNotifications(uid),
                checkActiveRide(uid)
            ]);
        }
    } catch (error) {
        console.error('Error loading user data:', error);
        showToast('Error loading user data', 'error');
    }
}

// Start real-time sync for user data
function startRealtimeSync(uid) {
    // User data updates
    AppState.realtimeListeners.push(
        database.ref(`users/${uid}`).on('value', (snapshot) => {
            const userData = snapshot.val();
            if (userData) {
                AppState.userData = userData;
                AppState.walletBalance = userData.walletBalance || 0;
                updateWalletDisplay();
                updateUserInfo();
            }
        })
    );
    
    // Active ride updates
    AppState.realtimeListeners.push(
        database.ref('rides')
            .orderByChild('passengerId')
            .equalTo(uid)
            .orderByChild('status')
            .startAt('requested')
            .endAt('started')
            .on('value', (snapshot) => {
                const rides = snapshot.val();
                if (rides) {
                    const rideId = Object.keys(rides)[0];
                    const ride = { id: rideId, ...rides[rideId] };
                    
                    if (!AppState.currentRide || AppState.currentRide.id !== rideId) {
                        AppState.currentRide = ride;
                        showRideInfo(ride);
                        
                        if (ride.driverId) {
                            listenToDriverLocation(ride.driverId);
                            loadDriverInfo(ride.driverId);
                        }
                        
                        listenToChatMessages(rideId);
                    } else {
                        AppState.currentRide = ride;
                        updateRideStatus(ride.status);
                        updateTimeline(ride.status);
                        
                        if (ride.status === 'completed') {
                            handleRideCompletion(ride);
                        }
                    }
                } else if (AppState.currentRide) {
                    resetActiveRide();
                }
            })
    );
    
    // Notifications updates
    AppState.realtimeListeners.push(
        database.ref(`notifications/${uid}`)
            .orderByChild('timestamp')
            .limitToLast(20)
            .on('value', (snapshot) => {
                const notifications = snapshot.val();
                if (notifications) {
                    const notificationsArray = Object.values(notifications).reverse();
                    const unreadCount = notificationsArray.filter(n => !n.read).length;
                    updateNotificationBadge(unreadCount);
                    updateNotifications(notificationsArray);
                }
            })
    );
    
    // Scheduled rides updates
    AppState.realtimeListeners.push(
        database.ref('scheduledRides')
            .orderByChild('passengerId')
            .equalTo(uid)
            .orderByChild('status')
            .equalTo('scheduled')
            .on('value', (snapshot) => {
                const scheduledRides = snapshot.val();
                if (scheduledRides) {
                    AppState.scheduledRides = Object.values(scheduledRides);
                    
                    // Check for upcoming scheduled rides
                    const now = Date.now();
                    AppState.scheduledRides.forEach(ride => {
                        if (ride.scheduledTime && ride.scheduledTime > now) {
                            const timeUntilRide = ride.scheduledTime - now;
                            if (timeUntilRide <= 3600000) { // 1 hour
                                showScheduleCountdown(ride.scheduledTime, ride.id);
                            }
                        }
                    });
                }
            })
    );
    
    // Share ride invitations
    AppState.realtimeListeners.push(
        database.ref('shareInvitations')
            .orderByChild('recipientId')
            .equalTo(uid)
            .orderByChild('status')
            .equalTo('pending')
            .on('value', (snapshot) => {
                const invitations = snapshot.val();
                if (invitations) {
                    Object.entries(invitations).forEach(([invitationId, invitation]) => {
                        showShareInvitation(invitationId, invitation);
                    });
                }
            })
    );
}

// ============================================
// MAP FUNCTIONS
// ============================================

// Initialize Leaflet map
function initializeMap() {
    const defaultLat = -15.4167;
    const defaultLng = 28.2833;
    
    AppState.map = L.map('map').setView([defaultLat, defaultLng], 13);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: ' OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(AppState.map);
    
    // Add scale control
    L.control.scale().addTo(AppState.map);
    
    hideMapLoading();
}

// Get current location using geolocation API
function getCurrentLocation() {
    if (!navigator.geolocation) {
        showToast('Geolocation is not supported by your browser', 'warning');
        return;
    }
    
    showLoading('Getting your location...');
    
    navigator.geolocation.getCurrentPosition(
        async (position) => {
            const { latitude, longitude } = position.coords;
            AppState.userLocation = { lat: latitude, lng: longitude };
            
            // Update map view
            AppState.map.setView([latitude, longitude], 15);
            
            // Add current location marker
            if (AppState.currentLocationMarker) {
                AppState.currentLocationMarker.setLatLng([latitude, longitude]);
            } else {
                AppState.currentLocationMarker = L.marker([latitude, longitude], {
                    icon: L.divIcon({
                        className: 'current-location-marker',
                        html: '<i class="fas fa-user"></i>',
                        iconSize: [18, 18],
                        iconAnchor: [9, 18]
                    })
                }).addTo(AppState.map).bindPopup('Your Location');
            }
            
            // Detect city from location
            await detectCity(latitude, longitude);
            
            // Update pickup location
            updatePickupLocation();
            
            hideLoading();
            showToast('Location detected successfully', 'success');
        },
        (error) => {
            console.error('Geolocation error:', error);
            hideLoading();
            showToast('Unable to get your location', 'warning');
        },
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        }
    );
}

// Detect city from coordinates
async function detectCity(lat, lng) {
    try {
        const response = await fetch(
            `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=10&addressdetails=1`
        );
        
        if (response.ok) {
            const data = await response.json();
            const address = data.address;
            
            // Try to get city from various address fields
            const city = address.city || address.town || address.village || address.municipality;
            
            if (city) {
                AppState.currentCity = city;
                updateCityDisplay(city);
                showToast(`Detected city: ${city}`, 'success');
            } else {
                showToast('Unable to detect city', 'warning');
            }
        }
    } catch (error) {
        console.error('Error detecting city:', error);
        showToast('Error detecting city', 'error');
    }
}

// Draw route between points
async function drawRoute(start, end) {
    if (!AppState.map) return;
    
    // Clear existing route
    if (AppState.routeLayer) {
        AppState.map.removeLayer(AppState.routeLayer);
        AppState.routeLayer = null;
    }
    
    // Clear destination marker
    if (AppState.destinationMarker) {
        AppState.map.removeLayer(AppState.destinationMarker);
        AppState.destinationMarker = null;
    }
    
    // Add destination marker
    AppState.destinationMarker = L.marker([end.lat, end.lng], {
        icon: L.divIcon({
            className: 'destination-marker',
            html: '<i class="fas fa-flag"></i>',
            iconSize: [20, 20],
            iconAnchor: [10, 20]
        })
    }).addTo(AppState.map).bindPopup('Destination');
    
    try {
        // Use OSRM routing service
        const response = await fetch(
            `https://router.project-osrm.org/route/v1/driving/${start.lng},${start.lat};${end.lng},${end.lat}?overview=full&geometries=geojson`
        );
        
        if (response.ok) {
            const data = await response.json();
            
            if (data.routes && data.routes.length > 0) {
                const route = data.routes[0];
                const routeCoordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                
                // Draw route
                AppState.routeLayer = L.polyline(routeCoordinates, {
                    color: '#FF6B35',
                    weight: 4,
                    opacity: 0.7,
                    lineJoin: 'round',
                    lineCap: 'round'
                }).addTo(AppState.map);
                
                // Fit map to route bounds
                const bounds = L.latLngBounds(routeCoordinates);
                AppState.map.fitBounds(bounds, { padding: [50, 50] });
                
                // Calculate distance and time
                const distance = route.distance / 1000; // Convert to km
                const duration = route.duration / 60; // Convert to minutes
                
                // Update fare calculation
                calculateFare(distance);
                
                return { distance, duration };
            }
        }
    } catch (error) {
        console.error('Routing service error:', error);
        
        // Fallback: draw straight line
        AppState.routeLayer = L.polyline([
            [start.lat, start.lng],
            [end.lat, end.lng]
        ], {
            color: '#FF6B35',
            weight: 3,
            opacity: 0.7,
            dashArray: '10, 10'
        }).addTo(AppState.map);
        
        // Calculate straight line distance
        const distance = calculateDistance(start.lat, start.lng, end.lat, end.lng);
        calculateFare(distance);
        
        return { distance, duration: distance * 2 }; // Estimate duration
    }
}

// Calculate distance between two points (Haversine formula)
function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // Earth's radius in km
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
        Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

// ============================================
// SEARCH FUNCTIONS
// ============================================

// Search for locations
async function searchLocations(query, type = 'destination') {
    if (!query || query.length < 2) return [];
    
    if (!AppState.currentCity) {
        showToast('Please wait while we detect your city', 'warning');
        return [];
    }
    
    // Check cache first
    const cacheKey = `${query}-${type}-${AppState.currentCity}`;
    if (AppState.searchCache.has(cacheKey)) {
        const cached = AppState.searchCache.get(cacheKey);
        if (Date.now() - cached.timestamp < 300000) { // 5 minutes
            return cached.results;
        }
    }
    
    try {
        // Use Nominatim search with city constraint
        const searchUrl = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}+${encodeURIComponent(AppState.currentCity)}+Zambia&format=json&limit=10&addressdetails=1`;
        
        const response = await fetch(searchUrl, {
            headers: {
                'User-Agent': 'JubelRideApp/1.0'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            
            // Process and filter results
            const results = data.map(place => ({
                id: place.place_id,
                name: place.display_name.split(',')[0],
                address: formatAddress(place),
                lat: parseFloat(place.lat),
                lng: parseFloat(place.lon),
                distance: AppState.userLocation ? 
                    calculateDistance(
                        AppState.userLocation.lat, AppState.userLocation.lng,
                        parseFloat(place.lat), parseFloat(place.lon)
                    ) : 0
            })).sort((a, b) => a.distance - b.distance);
            
            // Cache results
            AppState.searchCache.set(cacheKey, {
                results: results,
                timestamp: Date.now()
            });
            
            // Add to search history
            if (type === 'destination' && results.length > 0) {
                addToSearchHistory(results[0], query);
            }
            
            return results;
        }
    } catch (error) {
        console.error('Search error:', error);
    }
    
    return [];
}

// Search for shopping locations
async function searchShoppingLocations(category) {
    if (!AppState.currentCity) return [];
    
    const queries = AppState.shoppingCategories[category] || [];
    const results = [];
    
    for (const query of queries) {
        try {
            const searchUrl = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}+${encodeURIComponent(AppState.currentCity)}+Zambia&format=json&limit=5&addressdetails=1`;
            
            const response = await fetch(searchUrl, {
                headers: {
                    'User-Agent': 'JubelRideApp/1.0'
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                
                data.forEach(place => {
                    results.push({
                        id: place.place_id,
                        name: place.display_name.split(',')[0],
                        address: formatAddress(place),
                        lat: parseFloat(place.lat),
                        lng: parseFloat(place.lon),
                        distance: AppState.userLocation ? 
                            calculateDistance(
                                AppState.userLocation.lat, AppState.userLocation.lng,
                                parseFloat(place.lat), parseFloat(place.lon)
                            ) : 0
                    });
                });
            }
        } catch (error) {
            console.error('Shopping search error:', error);
        }
    }
    
    // Sort by distance and remove duplicates
    return results
        .sort((a, b) => a.distance - b.distance)
        .filter((place, index, self) =>
            index === self.findIndex(p => 
                Math.abs(p.lat - place.lat) < 0.001 && 
                Math.abs(p.lng - place.lng) < 0.001
            )
        )
        .slice(0, 10);
}

// Search for emergency stations
async function searchEmergencyStations(type) {
    if (!AppState.currentCity) return [];
    
    const cacheKey = `emergency-${type}-${AppState.currentCity}`;
    if (AppState.searchCache.has(cacheKey)) {
        const cached = AppState.searchCache.get(cacheKey);
        if (Date.now() - cached.timestamp < 3600000) { // 1 hour
            return cached.results;
        }
    }
    
    let query = '';
    switch(type) {
        case 'police':
            query = 'police station';
            break;
        case 'hospital':
            query = 'hospital clinic';
            break;
        case 'fire':
            query = 'fire station';
            break;
    }
    
    try {
        const searchUrl = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}+${encodeURIComponent(AppState.currentCity)}+Zambia&format=json&limit=10&addressdetails=1`;
        
        const response = await fetch(searchUrl, {
            headers: {
                'User-Agent': 'JubelRideApp/1.0'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            
            const results = data.map(place => ({
                id: place.place_id,
                name: place.display_name.split(',')[0],
                address: formatAddress(place),
                lat: parseFloat(place.lat),
                lng: parseFloat(place.lon),
                type: type,
                distance: AppState.userLocation ? 
                    calculateDistance(
                        AppState.userLocation.lat, AppState.userLocation.lng,
                        parseFloat(place.lat), parseFloat(place.lon)
                    ) : 0
            })).sort((a, b) => a.distance - b.distance);
            
            // Cache results
            AppState.searchCache.set(cacheKey, {
                results: results,
                timestamp: Date.now()
            });
            
            return results;
        }
    } catch (error) {
        console.error('Emergency search error:', error);
    }
    
    return [];
}

// Format address for display
function formatAddress(place) {
    const address = place.address || {};
    const parts = [];
    
    if (address.road) parts.push(address.road);
    if (address.suburb) parts.push(address.suburb);
    if (address.city || address.town) parts.push(address.city || address.town);
    
    return parts.join(', ');
}

// Add location to search history
function addToSearchHistory(location, query) {
    const historyItem = {
        query: query,
        location: location,
        timestamp: Date.now()
    };
    
    AppState.searchHistory = AppState.searchHistory.filter(item => 
        item.location.id !== location.id
    );
    
    AppState.searchHistory.unshift(historyItem);
    
    if (AppState.searchHistory.length > 10) {
        AppState.searchHistory = AppState.searchHistory.slice(0, 10);
    }
    
    // Save to localStorage
    try {
        localStorage.setItem('jubel_search_history', JSON.stringify(AppState.searchHistory));
    } catch (error) {
        console.error('Error saving search history:', error);
    }
}

// ============================================
// PRICE CALCULATION FUNCTIONS
// ============================================

// Calculate fare based on distance and service type
function calculateFare(distance, serviceType = null, options = {}) {
    if (!serviceType) serviceType = AppState.activeService;
    
    let fare = 0;
    let baseFare = 0;
    let perKm = 0;
    let multiplier = 1;
    let minFare = 0;
    
    switch(serviceType) {
        case 'car':
            const rideType = AppState.selectedRideType;
            const rideConfig = AppState.rideTypes[rideType];
            baseFare = rideConfig.base;
            perKm = rideConfig.perKm;
            multiplier = rideConfig.multiplier;
            minFare = rideConfig.min;
            break;
            
        case 'delivery':
            const deliveryType = options.deliveryType || 'standard';
            const deliveryConfig = AppState.deliveryTypes[deliveryType];
            baseFare = deliveryConfig.base;
            perKm = deliveryConfig.perKm;
            multiplier = deliveryConfig.multiplier;
            break;
            
        case 'short-delivery':
            baseFare = 15;
            perKm = 2.5;
            break;
            
        case 'truck':
            const truckType = options.truckType || 'light';
            const truckConfig = AppState.truckTypes[truckType];
            baseFare = truckConfig.base;
            perKm = truckConfig.perKm;
            multiplier = truckConfig.multiplier;
            break;
            
        case 'emergency':
            const emergencyType = options.emergencyType;
            const emergencyConfig = AppState.emergencyServices[emergencyType];
            baseFare = emergencyConfig.base;
            perKm = emergencyConfig.perKm;
            multiplier = emergencyConfig.multiplier;
            break;
    }
    
    // Calculate base fare
    fare = baseFare + (distance * perKm);
    fare *= multiplier;
    
    // Apply minimum fare
    if (minFare > 0) {
        fare = Math.max(fare, minFare);
    }
    
    // Apply additional charges
    if (options.helpers) {
        fare += 50; // Loading/unloading helpers
    }
    
    if (options.parcelValue > 500) {
        fare += options.parcelValue * 0.01; // Insurance for valuable parcels
    }
    
    // Apply referral discount
    if (AppState.referralDiscountApplied) {
        fare *= 0.5;
    }
    
    // Round to 2 decimal places
    fare = Math.round(fare * 100) / 100;
    
    AppState.rideFare = fare;
    return fare;
}

// Calculate split ride fare
function calculateSplitFare(totalFare, numberOfPeople) {
    const share = totalFare / numberOfPeople;
    return {
        total: totalFare,
        yourShare: share,
        friendShare: share
    };
}

// Update fare display
function updateFareDisplay(distance, duration) {
    const fare = calculateFare(distance);
    
    // Update main fare display
    const estimatedFare = document.getElementById('estimatedFare');
    const distanceDetail = document.getElementById('distanceDetail');
    const timeDetail = document.getElementById('timeDetail');
    
    if (estimatedFare) estimatedFare.textContent = `ZMW ${fare.toFixed(2)}`;
    if (distanceDetail) distanceDetail.textContent = `${distance.toFixed(1)} km`;
    if (timeDetail) timeDetail.textContent = `ETA: ${Math.ceil(duration)} min`;
    
    // Update ride type prices
    updateRideTypePrices(distance);
    
    // Show fare display
    const fareDisplay = document.getElementById('fareDisplay');
    if (fareDisplay) fareDisplay.classList.add('active');
}

// Update ride type prices
function updateRideTypePrices(distance) {
    Object.keys(AppState.rideTypes).forEach(type => {
        const priceElement = document.getElementById(`${type}Price`);
        if (priceElement) {
            const fare = calculateFare(distance, 'car', { rideType: type });
            priceElement.textContent = `ZMW ${fare.toFixed(2)}`;
        }
    });
}

// ============================================
// RIDE MANAGEMENT FUNCTIONS
// ============================================

// Request a ride
async function requestRide(rideData) {
    if (!AppState.currentUser) {
        showToast('Please login first', 'error');
        return;
    }
    
    if (!AppState.pickup || !AppState.destination) {
        showToast('Please select pickup and destination locations', 'warning');
        return;
    }
    
    // Show payment modal
    showPaymentModal(rideData);
}

// Show payment modal
function showPaymentModal(rideData) {
    const paymentModal = document.getElementById('paymentModal');
    if (!paymentModal) return;
    
    // Update payment amounts
    const paymentAmount = document.getElementById('paymentAmount');
    const originalFareAmount = document.getElementById('originalFareAmount');
    const finalFareAmount = document.getElementById('finalFareAmount');
    
    if (paymentAmount) paymentAmount.textContent = `ZMW ${AppState.rideFare.toFixed(2)}`;
    if (originalFareAmount) originalFareAmount.textContent = `ZMW ${AppState.rideFare.toFixed(2)}`;
    if (finalFareAmount) finalFareAmount.textContent = `ZMW ${AppState.rideFare.toFixed(2)}`;
    
    // Store ride data for later use
    window.currentRideData = rideData;
    
    // Show modal
    paymentModal.style.display = 'flex';
}

// Confirm payment and request ride
async function confirmPayment() {
    const paymentModal = document.getElementById('paymentModal');
    if (!paymentModal) return;
    
    const selectedMethod = document.querySelector('.payment-method.active');
    if (!selectedMethod) {
        showToast('Please select a payment method', 'warning');
        return;
    }
    
    const paymentMethod = selectedMethod.dataset.payment;
    const rideData = window.currentRideData;
    
    if (!rideData) {
        showToast('No ride data found', 'error');
        return;
    }
    
    // Check wallet balance if paying with wallet
    if (paymentMethod === 'wallet' && AppState.walletBalance < AppState.rideFare) {
        showToast('Insufficient wallet balance', 'error');
        return;
    }
    
    showLoading('Requesting ride...');
    
    try {
        // Process payment
        if (paymentMethod === 'wallet') {
            await processWalletPayment(AppState.rideFare);
        }
        
        // Create ride in database
        const rideId = await createRideInDatabase({
            ...rideData,
            paymentMethod: paymentMethod,
            fare: AppState.rideFare,
            status: 'requested',
            timestamp: Date.now(),
            passengerId: AppState.currentUser.uid,
            passengerName: AppState.userData.name,
            passengerPhone: AppState.userData.phone,
            city: AppState.currentCity
        });
        
        // Show ride info
        AppState.currentRide = {
            id: rideId,
            ...rideData,
            status: 'requested'
        };
        
        showRideInfo(AppState.currentRide);
        showPulsingIcon();
        
        // Hide modal
        paymentModal.style.display = 'none';
        delete window.currentRideData;
        
        // Reset referral discount
        AppState.referralDiscountApplied = false;
        AppState.referralCodeUsed = null;
        AppState.referralOwnerName = null;
        
        hideLoading();
        showToast('Ride requested successfully', 'success');
        
    } catch (error) {
        console.error('Error requesting ride:', error);
        hideLoading();
        showToast('Error requesting ride', 'error');
        
        // Refund wallet payment if error occurred
        if (paymentMethod === 'wallet') {
            await processWalletRefund(AppState.rideFare);
        }
    }
}

// Create ride in database
async function createRideInDatabase(rideData) {
    const rideId = database.ref().child('rides').push().key;
    
    await database.ref(`rides/${rideId}`).set(rideData);
    
    // Add to user's ride history
    await database.ref(`userRides/${AppState.currentUser.uid}/${rideId}`).set({
        rideId: rideId,
        timestamp: rideData.timestamp,
        status: rideData.status
    });
    
    return rideId;
}

// Show ride info panel
function showRideInfo(ride) {
    // Hide all forms
    document.querySelectorAll('.ride-request-form').forEach(form => {
        form.style.display = 'none';
    });
    
    // Show ride info panel
    const rideInfoPanel = document.getElementById('rideInfoPanel');
    if (rideInfoPanel) {
        rideInfoPanel.style.display = 'block';
    }
    
    // Update ride info
    updateCurrentPickup(ride.pickup);
    updateCurrentDestination(ride.destination);
    updateRideStatus(ride.status);
    updateTimeline(ride.status);
    
    // Show ride status bar
    const rideStatusBar = document.getElementById('rideStatusBar');
    if (rideStatusBar) {
        rideStatusBar.classList.add('active');
    }
    
    // Show SOS button if ride is accepted
    const sosButton = document.getElementById('sosButton');
    if (sosButton && ride.status === 'accepted') {
        sosButton.style.display = 'flex';
    }
}

// Update ride status
function updateRideStatus(status) {
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const etaText = document.getElementById('etaText');
    
    if (!statusDot || !statusText || !etaText) return;
    
    switch(status) {
        case 'requested':
            statusDot.className = 'status-dot searching';
            statusText.textContent = 'Searching for driver';
            etaText.textContent = '5-10 min';
            break;
        case 'accepted':
            statusDot.className = 'status-dot arriving';
            statusText.textContent = 'Driver on the way';
            etaText.textContent = '5 min';
            break;
        case 'arrived':
            statusDot.className = 'status-dot riding';
            statusText.textContent = 'Driver arrived';
            etaText.textContent = '0 min';
            break;
        case 'started':
            statusDot.className = 'status-dot riding';
            statusText.textContent = 'Trip in progress';
            etaText.textContent = 'En route';
            break;
        case 'completed':
            statusDot.className = 'status-dot completed';
            statusText.textContent = 'Ride completed';
            etaText.textContent = 'Completed';
            break;
        case 'cancelled':
            statusDot.className = 'status-dot cancelled';
            statusText.textContent = 'Ride cancelled';
            etaText.textContent = 'Cancelled';
            break;
    }
}

// Update timeline
function updateTimeline(status) {
    const steps = ['stepRequested', 'stepAccepted', 'stepArrived', 'stepStarted', 'stepCompleted'];
    const stepIndex = ['requested', 'accepted', 'arrived', 'started', 'completed'].indexOf(status);
    
    steps.forEach((stepId, index) => {
        const step = document.getElementById(stepId);
        if (step) {
            if (index < stepIndex) {
                step.className = 'step-dot completed';
            } else if (index === stepIndex) {
                step.className = 'step-dot active';
            } else {
                step.className = 'step-dot';
            }
        }
    });
}

// Show pulsing icon during driver search
function showPulsingIcon() {
    // Remove existing pulsing icon
    if (AppState.pulsingIcon) {
        AppState.pulsingIcon.remove();
    }
    
    // Create new pulsing icon
    const icon = document.createElement('div');
    icon.className = 'pulsing-ride-icon';
    
    // Set icon based on service type
    let iconClass = 'fa-car';
    if (AppState.activeService === 'delivery' || AppState.activeService === 'short-delivery') {
        iconClass = 'fa-bicycle';
    } else if (AppState.activeService === 'truck') {
        iconClass = 'fa-truck';
    }
    
    icon.innerHTML = `<i class="fas ${iconClass}"></i>`;
    
    // Add to map container
    const mapContainer = document.getElementById('map');
    if (mapContainer) {
        mapContainer.appendChild(icon);
        AppState.pulsingIcon = icon;
    }
}

// Cancel ride
async function cancelRide(reason) {
    if (!AppState.currentRide) {
        showToast('No active ride to cancel', 'warning');
        return;
    }
    
    if (!confirm('Are you sure you want to cancel this ride?')) {
        return;
    }
    
    showLoading('Cancelling ride...');
    
    try {
        // Update ride status in database
        await database.ref(`rides/${AppState.currentRide.id}`).update({
            status: 'cancelled',
            cancelReason: reason,
            cancelledAt: Date.now()
        });
        
        // Process refund if payment was made
        if (AppState.currentRide.paymentMethod === 'wallet') {
            await processWalletRefund(AppState.currentRide.fare);
        }
        
        // Reset active ride
        resetActiveRide();
        
        hideLoading();
        showToast('Ride cancelled successfully', 'success');
        
    } catch (error) {
        console.error('Error cancelling ride:', error);
        hideLoading();
        showToast('Error cancelling ride', 'error');
    }
}

// Reset active ride state
function resetActiveRide() {
    AppState.currentRide = null;
    
    // Hide ride info panel
    const rideInfoPanel = document.getElementById('rideInfoPanel');
    if (rideInfoPanel) {
        rideInfoPanel.style.display = 'none';
    }
    
    // Hide ride status bar
    const rideStatusBar = document.getElementById('rideStatusBar');
    if (rideStatusBar) {
        rideStatusBar.classList.remove('active');
    }
    
    // Hide SOS button
    const sosButton = document.getElementById('sosButton');
    if (sosButton) {
        sosButton.style.display = 'none';
    }
    
    // Remove pulsing icon
    if (AppState.pulsingIcon) {
        AppState.pulsingIcon.remove();
        AppState.pulsingIcon = null;
    }
    
    // Switch back to home screen
    switchScreen('home');
}

// ============================================
// WALLET FUNCTIONS
// ============================================

// Process wallet payment
async function processWalletPayment(amount) {
    if (!AppState.currentUser) return;
    
    const newBalance = AppState.walletBalance - amount;
    
    await database.ref(`users/${AppState.currentUser.uid}/walletBalance`).set(newBalance);
    
    // Record transaction
    await database.ref(`transactions/${AppState.currentUser.uid}`).push().set({
        type: 'payment',
        amount: amount,
        balance: newBalance,
        timestamp: Date.now(),
        description: 'Ride payment',
        rideId: AppState.currentRide?.id
    });
    
    AppState.walletBalance = newBalance;
    updateWalletDisplay();
}

// Process wallet refund
async function processWalletRefund(amount) {
    if (!AppState.currentUser) return;
    
    const newBalance = AppState.walletBalance + amount;
    
    await database.ref(`users/${AppState.currentUser.uid}/walletBalance`).set(newBalance);
    
    // Record transaction
    await database.ref(`transactions/${AppState.currentUser.uid}`).push().set({
        type: 'refund',
        amount: amount,
        balance: newBalance,
        timestamp: Date.now(),
        description: 'Ride cancellation refund',
        rideId: AppState.currentRide?.id
    });
    
    AppState.walletBalance = newBalance;
    updateWalletDisplay();
}

// Transfer money to another user
async function transferMoney(recipientCode, amount, message = '') {
    if (!AppState.currentUser) return;
    
    if (AppState.walletBalance < amount) {
        showToast('Insufficient wallet balance', 'error');
        return;
    }
    
    // Find recipient by referral code
    const recipientSnapshot = await database.ref('users')
        .orderByChild('referralCode')
        .equalTo(recipientCode)
        .once('value');
    
    if (!recipientSnapshot.exists()) {
        showToast('Recipient not found', 'error');
        return;
    }
    
    const recipientData = Object.values(recipientSnapshot.val())[0];
    const recipientId = Object.keys(recipientSnapshot.val())[0];
    
    showLoading('Processing transfer...');
    
    try {
        // Deduct from sender
        const senderNewBalance = AppState.walletBalance - amount;
        await database.ref(`users/${AppState.currentUser.uid}/walletBalance`).set(senderNewBalance);
        
        // Add to recipient
        const recipientNewBalance = (recipientData.walletBalance || 0) + amount;
        await database.ref(`users/${recipientId}/walletBalance`).set(recipientNewBalance);
        
        // Record sender transaction
        await database.ref(`transactions/${AppState.currentUser.uid}`).push().set({
            type: 'transfer_sent',
            amount: amount,
            balance: senderNewBalance,
            timestamp: Date.now(),
            description: message || `Transfer to ${recipientData.name}`,
            recipientId: recipientId,
            recipientName: recipientData.name
        });
        
        // Record recipient transaction
        await database.ref(`transactions/${recipientId}`).push().set({
            type: 'transfer_received',
            amount: amount,
            balance: recipientNewBalance,
            timestamp: Date.now(),
            description: message || `Transfer from ${AppState.userData.name}`,
            senderId: AppState.currentUser.uid,
            senderName: AppState.userData.name
        });
        
        // Update local state
        AppState.walletBalance = senderNewBalance;
        updateWalletDisplay();
        
        hideLoading();
        showToast(`Successfully transferred ZMW ${amount.toFixed(2)}`, 'success');
        
        return true;
        
    } catch (error) {
        console.error('Error transferring money:', error);
        hideLoading();
        showToast('Error transferring money', 'error');
        return false;
    }
}

// Update wallet display
function updateWalletDisplay() {
    const walletBalance = document.getElementById('walletBalance');
    const accountBalance = document.getElementById('accountBalance');
    const paymentBalance = document.getElementById('paymentBalance');
    const transferBalance = document.getElementById('transferBalance');
    
    const formatted = `ZMW ${AppState.walletBalance.toFixed(2)}`;
    
    if (walletBalance) walletBalance.textContent = formatted;
    if (accountBalance) accountBalance.textContent = formatted;
    if (paymentBalance) paymentBalance.textContent = formatted;
    if (transferBalance) transferBalance.textContent = formatted;
}

// ============================================
// REFERRAL SYSTEM FUNCTIONS
// ============================================

// Apply referral discount
async function applyReferralDiscount(code) {
    if (!code) {
        showToast('Please enter a referral code', 'warning');
        return false;
    }
    
    if (AppState.referralDiscountApplied) {
        showToast('Referral discount already applied', 'info');
        return true;
    }
    
    // Check if user is trying to use their own code
    if (AppState.userData.referralCode === code) {
        showToast('You cannot use your own referral code', 'warning');
        return false;
    }
    
    showLoading('Validating referral code...');
    
    try {
        // Find user with this referral code
        const referralSnapshot = await database.ref('users')
            .orderByChild('referralCode')
            .equalTo(code)
            .once('value');
        
        if (referralSnapshot.exists()) {
            const referralData = Object.values(referralSnapshot.val())[0];
            const referralId = Object.keys(referralSnapshot.val())[0];
            
            // Check if this referral has already been used by this user
            const usedSnapshot = await database.ref(`usedReferrals/${AppState.currentUser.uid}/${referralId}`).once('value');
            
            if (usedSnapshot.exists()) {
                showToast('You have already used this referral code', 'warning');
                hideLoading();
                return false;
            }
            
            // Apply discount
            AppState.referralDiscountApplied = true;
            AppState.referralCodeUsed = code;
            AppState.referralOwnerName = referralData.name;
            
            // Update UI
            const discountAmount = AppState.rideFare * 0.5;
            const newFare = AppState.rideFare - discountAmount;
            
            const discountAmountElement = document.getElementById('discountAmount');
            const finalFareAmount = document.getElementById('finalFareAmount');
            const referrerInfo = document.getElementById('referrerInfo');
            
            if (discountAmountElement) discountAmountElement.textContent = `-ZMW ${discountAmount.toFixed(2)}`;
            if (finalFareAmount) finalFareAmount.textContent = `ZMW ${newFare.toFixed(2)}`;
            if (referrerInfo) {
                referrerInfo.textContent = `Referral from ${referralData.name}`;
                referrerInfo.style.display = 'block';
            }
            
            hideLoading();
            showToast(`50% discount applied! Referral from ${referralData.name}`, 'success');
            return true;
            
        } else {
            hideLoading();
            showToast('Invalid referral code', 'error');
            return false;
        }
        
    } catch (error) {
        console.error('Error validating referral:', error);
        hideLoading();
        showToast('Error validating referral code', 'error');
        return false;
    }
}

// Process referral earnings after ride completion
async function processReferralEarnings(rideId, referralCode) {
    if (!referralCode) return;
    
    try {
        // Find referral owner
        const referralSnapshot = await database.ref('users')
            .orderByChild('referralCode')
            .equalTo(referralCode)
            .once('value');
        
        if (referralSnapshot.exists()) {
            const referralData = Object.values(referralSnapshot.val())[0];
            const referralId = Object.keys(referralSnapshot.val())[0];
            
            // Check if this is user's first ride
            const userRidesSnapshot = await database.ref(`userRides/${AppState.currentUser.uid}`)
                .orderByChild('status')
                .equalTo('completed')
                .once('value');
            
            if (userRidesSnapshot.numChildren() === 1) { // This is first completed ride
                // Add earnings to referral owner
                const newBalance = (referralData.walletBalance || 0) + 25;
                await database.ref(`users/${referralId}/walletBalance`).set(newBalance);
                
                // Record transaction
                await database.ref(`transactions/${referralId}`).push().set({
                    type: 'referral_earning',
                    amount: 25,
                    balance: newBalance,
                    timestamp: Date.now(),
                    description: `Referral earnings from ${AppState.userData.name}`,
                    rideId: rideId,
                    referredUserId: AppState.currentUser.uid,
                    referredUserName: AppState.userData.name
                });
                
                // Mark referral as used
                await database.ref(`usedReferrals/${AppState.currentUser.uid}/${referralId}`).set({
                    timestamp: Date.now(),
                    rideId: rideId,
                    amount: 25
                });
                
                // Send notification to referral owner
                await sendNotification(
                    referralId,
                    'Referral Earnings',
                    `You earned ZMW 25.00 from ${AppState.userData.name}'s first ride`,
                    'referral'
                );
            }
        }
    } catch (error) {
        console.error('Error processing referral earnings:', error);
    }
}

// ============================================
// SPLIT RIDE FUNCTIONS
// ============================================

// Add friend to split ride
async function addSplitFriend(referralCode) {
    if (AppState.shareRideFriends.length >= 3) {
        showToast('Maximum 3 friends allowed for split ride', 'warning');
        return false;
    }
    
    if (AppState.shareRideFriends.some(friend => friend.code === referralCode)) {
        showToast('Friend already added', 'warning');
        return false;
    }
    
    // Check if user is trying to add themselves
    if (AppState.userData.referralCode === referralCode) {
        showToast('You cannot add yourself', 'warning');
        return false;
    }
    
    showLoading('Adding friend...');
    
    try {
        // Find user by referral code
        const friendSnapshot = await database.ref('users')
            .orderByChild('referralCode')
            .equalTo(referralCode)
            .once('value');
        
        if (friendSnapshot.exists()) {
            const friendData = Object.values(friendSnapshot.val())[0];
            const friendId = Object.keys(friendSnapshot.val())[0];
            
            const friend = {
                id: friendId,
                code: referralCode,
                name: friendData.name,
                phone: friendData.phone,
                status: 'pending'
            };
            
            AppState.shareRideFriends.push(friend);
            updateSplitFriendsList();
            
            hideLoading();
            showToast(`${friendData.name} added to split ride`, 'success');
            
            // Recalculate fare
            if (AppState.pickup && AppState.destination) {
                const distance = calculateDistance(
                    AppState.pickup.lat, AppState.pickup.lng,
                    AppState.destination.lat, AppState.destination.lng
                );
                updateSplitRideFare(distance);
            }
            
            return true;
            
        } else {
            hideLoading();
            showToast('Friend not found. Please check the referral code.', 'error');
            return false;
        }
        
    } catch (error) {
        console.error('Error adding friend:', error);
        hideLoading();
        showToast('Error adding friend', 'error');
        return false;
    }
}

// Update split friends list
function updateSplitFriendsList() {
    const friendsList = document.getElementById('splitFriendsList');
    if (!friendsList) return;
    
    friendsList.innerHTML = '';
    
    if (AppState.shareRideFriends.length === 0) {
        friendsList.innerHTML = '<div style="text-align: center; color: var(--text-gray); padding: 20px;">No friends added yet</div>';
        return;
    }
    
    AppState.shareRideFriends.forEach((friend, index) => {
        const friendElement = document.createElement('div');
        friendElement.className = 'share-friend-item';
        friendElement.innerHTML = `
            <div class="friend-avatar">
                <i class="fas fa-user"></i>
            </div>
            <div class="friend-info">
                <div class="friend-name">${friend.name}</div>
                <div class="friend-phone">${friend.phone || 'Not provided'}</div>
            </div>
            <div class="friend-status" style="font-size: 12px; color: ${friend.status === 'accepted' ? 'var(--success-green)' : friend.status === 'rejected' ? 'var(--error-red)' : 'var(--warning-yellow)'}">
                ${friend.status === 'accepted' ? 'Accepted' : friend.status === 'rejected' ? 'Rejected' : 'Pending'}
            </div>
            <button class="remove-friend-btn" data-index="${index}">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        friendsList.appendChild(friendElement);
    });
    
    // Add event listeners to remove buttons
    friendsList.querySelectorAll('.remove-friend-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const index = parseInt(this.dataset.index);
            removeSplitFriend(index);
        });
    });
}

// Remove friend from split ride
function removeSplitFriend(index) {
    AppState.shareRideFriends.splice(index, 1);
    updateSplitFriendsList();
    
    // Recalculate fare
    if (AppState.pickup && AppState.destination) {
        const distance = calculateDistance(
            AppState.pickup.lat, AppState.pickup.lng,
            AppState.destination.lat, AppState.destination.lng
        );
        updateSplitRideFare(distance);
    }
}

// Update split ride fare calculation
function updateSplitRideFare(distance) {
    const totalFare = calculateFare(distance);
    const numberOfPeople = AppState.shareRideFriends.length + 1;
    const splitFare = calculateSplitFare(totalFare, numberOfPeople);
    
    // Update display
    const splitTotalFare = document.getElementById('splitTotalFare');
    const splitYourShare = document.getElementById('splitYourShare');
    const splitFriendShare = document.getElementById('splitFriendShare');
    const splitPeopleCount = document.getElementById('splitPeopleCount');
    
    if (splitTotalFare) splitTotalFare.textContent = `ZMW ${splitFare.total.toFixed(2)}`;
    if (splitYourShare) splitYourShare.textContent = `ZMW ${splitFare.yourShare.toFixed(2)}`;
    if (splitFriendShare) splitFriendShare.textContent = `ZMW ${splitFare.friendShare.toFixed(2)}`;
    if (splitPeopleCount) splitPeopleCount.textContent = `${numberOfPeople} people`;
}

// Send split ride invitations
async function sendSplitRideInvitations(rideId, rideData) {
    for (const friend of AppState.shareRideFriends) {
        try {
            await database.ref(`shareInvitations/${rideId}_${friend.id}`).set({
                rideId: rideId,
                hostId: AppState.currentUser.uid,
                hostName: AppState.userData.name,
                recipientId: friend.id,
                recipientName: friend.name,
                pickup: rideData.pickup,
                destination: rideData.destination,
                distance: rideData.distance,
                totalFare: rideData.fare,
                yourShare: rideData.fare / (AppState.shareRideFriends.length + 1),
                status: 'pending',
                timestamp: Date.now()
            });
            
            // Send notification to friend
            await sendNotification(
                friend.id,
                'Split Ride Invitation',
                `${AppState.userData.name} invited you to share a ride`,
                'share'
            );
            
        } catch (error) {
            console.error('Error sending invitation to', friend.name, error);
        }
    }
}

// Show share ride invitation
function showShareInvitation(invitationId, invitation) {
    const modal = document.getElementById('shareInvitationModal');
    if (!modal) return;
    
    // Update invitation details
    document.getElementById('invitationHostName').textContent = invitation.hostName;
    document.getElementById('invitationPickup').textContent = invitation.pickup;
    document.getElementById('invitationDestination').textContent = invitation.destination;
    document.getElementById('invitationDistance').textContent = `${invitation.distance.toFixed(1)} km`;
    document.getElementById('invitationTotalFare').textContent = `ZMW ${invitation.totalFare.toFixed(2)}`;
    document.getElementById('invitationYourShare').textContent = `ZMW ${invitation.yourShare.toFixed(2)}`;
    
    // Store invitation data
    modal.dataset.invitationId = invitationId;
    
    // Show modal
    modal.style.display = 'flex';
}

// Accept share ride invitation
async function acceptShareInvitation(invitationId) {
    const modal = document.getElementById('shareInvitationModal');
    if (!modal) return;
    
    showLoading('Processing invitation...');
    
    try {
        // Update invitation status
        await database.ref(`shareInvitations/${invitationId}`).update({
            status: 'accepted',
            acceptedAt: Date.now()
        });
        
        // Get invitation details
        const invitationSnapshot = await database.ref(`shareInvitations/${invitationId}`).once('value');
        const invitation = invitationSnapshot.val();
        
        if (invitation) {
            // Update ride with participant
            await database.ref(`rides/${invitation.rideId}/participants/${AppState.currentUser.uid}`).set({
                name: AppState.userData.name,
                status: 'accepted',
                shareAmount: invitation.yourShare
            });
            
            // Show payment modal for share amount
            AppState.rideFare = invitation.yourShare;
            showPaymentModal({
                ...invitation,
                shareRide: true,
                rideId: invitation.rideId
            });
        }
        
        hideLoading();
        modal.style.display = 'none';
        
    } catch (error) {
        console.error('Error accepting invitation:', error);
        hideLoading();
        showToast('Error accepting invitation', 'error');
    }
}

// Reject share ride invitation
async function rejectShareInvitation(invitationId) {
    const modal = document.getElementById('shareInvitationModal');
    if (!modal) return;
    
    showLoading('Processing...');
    
    try {
        // Update invitation status
        await database.ref(`shareInvitations/${invitationId}`).update({
            status: 'rejected',
            rejectedAt: Date.now()
        });
        
        // Get invitation details
        const invitationSnapshot = await database.ref(`shareInvitations/${invitationId}`).once('value');
        const invitation = invitationSnapshot.val();
        
        if (invitation) {
            // Update ride participant status
            await database.ref(`rides/${invitation.rideId}/participants/${AppState.currentUser.uid}`).set({
                name: AppState.userData.name,
                status: 'rejected'
            });
            
            // Recalculate shares for remaining participants
            await recalculateSplitRideShares(invitation.rideId);
        }
        
        hideLoading();
        modal.style.display = 'none';
        showToast('Invitation declined', 'info');
        
    } catch (error) {
        console.error('Error rejecting invitation:', error);
        hideLoading();
        showToast('Error rejecting invitation', 'error');
    }
}

// Recalculate split ride shares when someone declines
async function recalculateSplitRideShares(rideId) {
    try {
        const rideSnapshot = await database.ref(`rides/${rideId}`).once('value');
        const ride = rideSnapshot.val();
        
        if (!ride || !ride.participants) return;
        
        // Count accepted participants
        const acceptedParticipants = Object.values(ride.participants).filter(p => p.status === 'accepted').length;
        
        if (acceptedParticipants > 0) {
            const newShare = ride.fare / (acceptedParticipants + 1); // +1 for host
            
            // Update shares for all accepted participants
            for (const [userId, participant] of Object.entries(ride.participants)) {
                if (participant.status === 'accepted') {
                    await database.ref(`rides/${rideId}/participants/${userId}/shareAmount`).set(newShare);
                    
                    // Update invitation if exists
                    const invitationId = `${rideId}_${userId}`;
                    await database.ref(`shareInvitations/${invitationId}/yourShare`).set(newShare);
                    
                    // Send notification about share change
                    await sendNotification(
                        userId,
                        'Share Updated',
                        `Your share amount has been updated to ZMW ${newShare.toFixed(2)}`,
                        'share_update'
                    );
                }
            }
        }
    } catch (error) {
        console.error('Error recalculating shares:', error);
    }
}

// ============================================
// BROADCAST RIDE FUNCTIONS
// ============================================

// Add friend to broadcast
async function addBroadcastFriend(referralCode) {
    if (AppState.broadcastFriends.some(friend => friend.code === referralCode)) {
        showToast('Friend already added', 'warning');
        return false;
    }
    
    // Check if user is trying to add themselves
    if (AppState.userData.referralCode === referralCode) {
        showToast('You cannot add yourself', 'warning');
        return false;
    }
    
    showLoading('Adding friend...');
    
    try {
        // Find user by referral code
        const friendSnapshot = await database.ref('users')
            .orderByChild('referralCode')
            .equalTo(referralCode)
            .once('value');
        
        if (friendSnapshot.exists()) {
            const friendData = Object.values(friendSnapshot.val())[0];
            const friendId = Object.keys(friendSnapshot.val())[0];
            
            const friend = {
                id: friendId,
                code: referralCode,
                name: friendData.name,
                phone: friendData.phone
            };
            
            AppState.broadcastFriends.push(friend);
            updateBroadcastFriendsList();
            
            hideLoading();
            showToast(`${friendData.name} added to broadcast`, 'success');
            return true;
            
        } else {
            hideLoading();
            showToast('Friend not found. Please check the referral code.', 'error');
            return false;
        }
        
    } catch (error) {
        console.error('Error adding friend:', error);
        hideLoading();
        showToast('Error adding friend', 'error');
        return false;
    }
}

// Update broadcast friends list
function updateBroadcastFriendsList() {
    const friendsList = document.getElementById('broadcastFriendsList');
    if (!friendsList) return;
    
    friendsList.innerHTML = '';
    
    if (AppState.broadcastFriends.length === 0) {
        friendsList.innerHTML = '<div style="text-align: center; color: var(--text-gray); padding: 20px;">No friends added yet</div>';
        return;
    }
    
    AppState.broadcastFriends.forEach((friend, index) => {
        const friendElement = document.createElement('div');
        friendElement.className = 'share-friend-item';
        friendElement.innerHTML = `
            <div class="friend-avatar">
                <i class="fas fa-user"></i>
            </div>
            <div class="friend-info">
                <div class="friend-name">${friend.name}</div>
                <div class="friend-phone">${friend.phone || 'Not provided'}</div>
            </div>
            <button class="remove-friend-btn" data-index="${index}">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        friendsList.appendChild(friendElement);
    });
    
    // Add event listeners to remove buttons
    friendsList.querySelectorAll('.remove-friend-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const index = parseInt(this.dataset.index);
            removeBroadcastFriend(index);
        });
    });
}

// Remove friend from broadcast
function removeBroadcastFriend(index) {
    AppState.broadcastFriends.splice(index, 1);
    updateBroadcastFriendsList();
}

// Send broadcast notifications
async function sendBroadcastNotifications(rideId, rideData) {
    for (const friend of AppState.broadcastFriends) {
        try {
            await database.ref(`broadcastNotifications/${rideId}_${friend.id}`).set({
                rideId: rideId,
                hostId: AppState.currentUser.uid,
                hostName: AppState.userData.name,
                recipientId: friend.id,
                pickup: rideData.pickup,
                destination: rideData.destination,
                distance: rideData.distance,
                fare: rideData.fare,
                timestamp: Date.now(),
                status: 'active'
            });
            
            // Send notification to friend
            await sendNotification(
                friend.id,
                'Ride Broadcast',
                `${AppState.userData.name} is sharing their ride with you`,
                'broadcast'
            );
            
        } catch (error) {
            console.error('Error sending broadcast to', friend.name, error);
        }
    }
}

// ============================================
// SCHEDULED RIDES FUNCTIONS
// ============================================

// Schedule a ride
async function scheduleRide(rideData, scheduledTime) {
    showLoading('Scheduling ride...');
    
    try {
        const scheduledRideId = database.ref().child('scheduledRides').push().key;
        
        await database.ref(`scheduledRides/${scheduledRideId}`).set({
            ...rideData,
            scheduledTime: scheduledTime,
            status: 'scheduled',
            createdAt: Date.now(),
            passengerId: AppState.currentUser.uid,
            passengerName: AppState.userData.name
        });
        
        // Show countdown if ride is within next hour
        const timeUntilRide = scheduledTime - Date.now();
        if (timeUntilRide <= 3600000) {
            showScheduleCountdown(scheduledTime, scheduledRideId);
        }
        
        hideLoading();
        showToast('Ride scheduled successfully', 'success');
        return scheduledRideId;
        
    } catch (error) {
        console.error('Error scheduling ride:', error);
        hideLoading();
        showToast('Error scheduling ride', 'error');
        return null;
    }
}

// Show schedule countdown
function showScheduleCountdown(scheduledTime, rideId) {
    // Remove existing countdown
    const existingCountdown = document.getElementById('scheduleCountdown');
    if (existingCountdown) {
        existingCountdown.remove();
    }
    
    // Clear existing timer
    if (AppState.activeScheduledTimer) {
        clearInterval(AppState.activeScheduledTimer);
    }
    
    // Create countdown element
    const countdown = document.createElement('div');
    countdown.id = 'scheduleCountdown';
    countdown.className = 'schedule-countdown';
    
    // Add to main panel
    const mainPanel = document.getElementById('mainPanel');
    if (mainPanel) {
        mainPanel.insertBefore(countdown, mainPanel.firstChild);
    }
    
    // Update countdown function
    function updateCountdown() {
        const now = Date.now();
        const timeUntilRide = scheduledTime - now;
        
        if (timeUntilRide <= 0) {
            // Time's up - request the ride
            clearInterval(AppState.activeScheduledTimer);
            countdown.remove();
            requestScheduledRide(rideId);
            return;
        }
        
        const hours = Math.floor(timeUntilRide / (1000 * 60 * 60));
        const minutes = Math.floor((timeUntilRide % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((timeUntilRide % (1000 * 60)) / 1000);
        
        countdown.innerHTML = `
            <div class="countdown-header">
                <i class="fas fa-clock"></i>
                <span>Scheduled Ride</span>
            </div>
            <div class="countdown-timer">
                <div class="time-unit">
                    <div class="time-value">${hours.toString().padStart(2, '0')}</div>
                    <div class="time-label">Hours</div>
                </div>
                <div class="time-separator">:</div>
                <div class="time-unit">
                    <div class="time-value">${minutes.toString().padStart(2, '0')}</div>
                    <div class="time-label">Minutes</div>
                </div>
                <div class="time-separator">:</div>
                <div class="time-unit">
                    <div class="time-value">${seconds.toString().padStart(2, '0')}</div>
                    <div class="time-label">Seconds</div>
                </div>
            </div>
            <button class="btn btn-danger" id="cancelScheduleBtn">
                <i class="fas fa-times"></i> Cancel Schedule
            </button>
        `;
        
        // Add cancel button event listener
        const cancelBtn = document.getElementById('cancelScheduleBtn');
        if (cancelBtn) {
            cancelBtn.addEventListener('click', () => {
                cancelScheduledRide(rideId);
            });
        }
    }
    
    // Initial update
    updateCountdown();
    
    // Update every second
    AppState.activeScheduledTimer = setInterval(updateCountdown, 1000);
}

// Request scheduled ride
async function requestScheduledRide(rideId) {
    showLoading('Requesting scheduled ride...');
    
    try {
        // Get scheduled ride data
        const scheduledRideSnapshot = await database.ref(`scheduledRides/${rideId}`).once('value');
        const scheduledRide = scheduledRideSnapshot.val();
        
        if (!scheduledRide) {
            throw new Error('Scheduled ride not found');
        }
        
        // Create regular ride from scheduled ride
        const rideId = await createRideInDatabase({
            ...scheduledRide,
            scheduled: true,
            scheduledRideId: rideId,
            status: 'requested',
            timestamp: Date.now()
        });
        
        // Update scheduled ride status
        await database.ref(`scheduledRides/${rideId}`).update({
            status: 'executed',
            executedAt: Date.now(),
            rideId: rideId
        });
        
        // Show ride info
        AppState.currentRide = {
            id: rideId,
            ...scheduledRide,
            status: 'requested'
        };
        
        showRideInfo(AppState.currentRide);
        showPulsingIcon();
        
        hideLoading();
        showToast('Scheduled ride requested', 'success');
        
    } catch (error) {
        console.error('Error requesting scheduled ride:', error);
        hideLoading();
        showToast('Error requesting scheduled ride', 'error');
    }
}

// Cancel scheduled ride
async function cancelScheduledRide(rideId) {
    if (!confirm('Are you sure you want to cancel this scheduled ride?')) {
        return;
    }
    
    showLoading('Cancelling scheduled ride...');
    
    try {
        await database.ref(`scheduledRides/${rideId}`).update({
            status: 'cancelled',
            cancelledAt: Date.now()
        });
        
        // Clear timer and remove countdown
        if (AppState.activeScheduledTimer) {
            clearInterval(AppState.activeScheduledTimer);
            AppState.activeScheduledTimer = null;
        }
        
        const countdown = document.getElementById('scheduleCountdown');
        if (countdown) {
            countdown.remove();
        }
        
        hideLoading();
        showToast('Scheduled ride cancelled', 'success');
        
    } catch (error) {
        console.error('Error cancelling scheduled ride:', error);
        hideLoading();
        showToast('Error cancelling scheduled ride', 'error');
    }
}

// ============================================
// EMERGENCY SYSTEM FUNCTIONS
// ============================================

// Load SOS configuration
async function loadSOSConfig(uid) {
    try {
        const snapshot = await database.ref(`sosConfig/${uid}`).once('value');
        AppState.sosConfig = snapshot.val();
        
        if (AppState.sosConfig) {
            // Update SOS button visibility
            const sosButton = document.getElementById('sosButton');
            if (sosButton) {
                sosButton.style.display = 'none'; // Hide until ride is accepted
            }
        }
    } catch (error) {
        console.error('Error loading SOS config:', error);
    }
}

// Save SOS configuration
async function saveSOSConfig() {
    if (!AppState.currentUser) return;
    
    const contact1Name = document.getElementById('sosContact1Name').value.trim();
    const contact1Phone = document.getElementById('sosContact1Phone').value.trim();
    const contact2Name = document.getElementById('sosContact2Name').value.trim();
    const contact2Phone = document.getElementById('sosContact2Phone').value.trim();
    const sosMessage = document.getElementById('sosMessage').value.trim();
    
    if (!contact1Name || !contact1Phone) {
        showToast('Please provide primary emergency contact details', 'warning');
        return;
    }
    
    const sosConfig = {
        contact1Name,
        contact1Phone,
        contact2Name: contact2Name || '',
        contact2Phone: contact2Phone || '',
        message: sosMessage || 'I need help! My current location and ride details will be shared with you.',
        updatedAt: Date.now()
    };
    
    showLoading('Saving SOS configuration...');
    
    try {
        await database.ref(`sosConfig/${AppState.currentUser.uid}`).set(sosConfig);
        AppState.sosConfig = sosConfig;
        
        hideLoading();
        showToast('SOS configuration saved successfully', 'success');
        
        // Hide modal
        const sosModal = document.getElementById('sosModal');
        if (sosModal) {
            sosModal.style.display = 'none';
        }
        
    } catch (error) {
        console.error('Error saving SOS config:', error);
        hideLoading();
        showToast('Error saving SOS configuration', 'error');
    }
}

// Trigger SOS emergency
async function triggerSOS() {
    if (!AppState.sosConfig) {
        showToast('Please setup SOS contacts first', 'warning');
        showModal('sos');
        return;
    }
    
    if (!AppState.currentRide) {
        showToast('No active ride to report SOS for', 'warning');
        return;
    }
    
    if (!confirm('Are you sure you want to send an SOS alert to your emergency contacts?')) {
        return;
    }
    
    showLoading('Sending SOS alert...');
    
    try {
        // Get current location
        const location = AppState.userLocation || { lat: 0, lng: 0 };
        
        // Create SOS alert
        const sosAlertId = database.ref().child('sosAlerts').push().key;
        
        const sosAlert = {
            id: sosAlertId,
            userId: AppState.currentUser.uid,
            userName: AppState.userData.name,
            rideId: AppState.currentRide.id,
            location: location,
            city: AppState.currentCity,
            timestamp: Date.now(),
            status: 'active'
        };
        
        await database.ref(`sosAlerts/${sosAlertId}`).set(sosAlert);
        
        // Send notifications to emergency contacts
        await sendSOSNotifications(sosAlert);
        
        // Show emergency status
        const emergencyStatus = document.getElementById('emergencyStatus');
        if (emergencyStatus) {
            emergencyStatus.style.display = 'flex';
        }
        
        hideLoading();
        showToast('SOS alert sent to emergency contacts', 'success');
        
    } catch (error) {
        console.error('Error sending SOS alert:', error);
        hideLoading();
        showToast('Error sending SOS alert', 'error');
    }
}

// Send SOS notifications to emergency contacts
async function sendSOSNotifications(sosAlert) {
    // Send to primary contact
    if (AppState.sosConfig.contact1Phone) {
        // In a real app, you would send SMS or call here
        console.log(`Sending SOS to ${AppState.sosConfig.contact1Name}: ${AppState.sosConfig.contact1Phone}`);
    }
    
    // Send to secondary contact
    if (AppState.sosConfig.contact2Phone) {
        console.log(`Sending SOS to ${AppState.sosConfig.contact2Name}: ${AppState.sosConfig.contact2Phone}`);
    }
    
    // Also notify app admins
    await database.ref('adminNotifications/sos').push().set({
        ...sosAlert,
        contact1: AppState.sosConfig.contact1Phone,
        contact2: AppState.sosConfig.contact2Phone
    });
}

// Show emergency services modal
async function showEmergencyServices(type) {
    const modal = document.getElementById('emergencyModal');
    if (!modal) return;
    
    // Set service type
    modal.dataset.serviceType = type;
    
    // Update title
    const serviceTitle = document.getElementById('emergencyServiceTitle');
    if (serviceTitle) {
        serviceTitle.textContent = `${type.charAt(0).toUpperCase() + type.slice(1)} Emergency`;
    }
    
    // Update user location
    const emergencyUserLocation = document.getElementById('emergencyUserLocation');
    if (emergencyUserLocation && AppState.userLocation) {
        emergencyUserLocation.textContent = `Lat: ${AppState.userLocation.lat.toFixed(6)}, Lng: ${AppState.userLocation.lng.toFixed(6)}`;
    }
    
    // Load emergency stations
    showLoading('Loading emergency stations...');
    
    try {
        const stations = await searchEmergencyStations(type);
        
        const stationsList = document.getElementById('emergencyStations');
        if (stationsList) {
            stationsList.innerHTML = '';
            
            if (stations.length === 0) {
                stationsList.innerHTML = '<div style="text-align: center; color: var(--text-gray); padding: 20px;">No emergency stations found in your area</div>';
            } else {
                stations.forEach((station, index) => {
                    const stationElement = document.createElement('div');
                    stationElement.className = 'emergency-station';
                    if (index === 0) {
                        stationElement.classList.add('selected');
                        updateEmergencyFare(station.distance, type);
                    }
                    
                    stationElement.innerHTML = `
                        <div class="station-header">
                            <div class="station-name">${station.name}</div>
                            <div class="station-distance">${station.distance.toFixed(1)} km</div>
                        </div>
                        <div class="station-address">${station.address}</div>
                        <div class="station-details">
                            <span><i class="fas fa-phone"></i> Emergency</span>
                            <span><i class="fas fa-clock"></i> 24/7</span>
                        </div>
                    `;
                    
                    stationElement.addEventListener('click', () => {
                        // Remove selected class from all stations
                        stationsList.querySelectorAll('.emergency-station').forEach(s => {
                            s.classList.remove('selected');
                        });
                        
                        // Add selected class to clicked station
                        stationElement.classList.add('selected');
                        
                        // Update fare
                        updateEmergencyFare(station.distance, type);
                    });
                    
                    stationsList.appendChild(stationElement);
                });
            }
        }
        
        hideLoading();
        
        // Show modal
        modal.style.display = 'flex';
        
    } catch (error) {
        console.error('Error loading emergency stations:', error);
        hideLoading();
        showToast('Error loading emergency stations', 'error');
    }
}

// Update emergency fare calculation
function updateEmergencyFare(distance, type) {
    const baseFare = AppState.emergencyServices[type].base;
    const perKm = AppState.emergencyServices[type].perKm;
    const multiplier = AppState.emergencyServices[type].multiplier;
    
    const fare = (baseFare + (distance * perKm)) * multiplier;
    
    // Update display
    const emergencyBaseFare = document.getElementById('emergencyBaseFare');
    const emergencyDistance = document.getElementById('emergencyDistance');
    const emergencyTotalFare = document.getElementById('emergencyTotalFare');
    
    if (emergencyBaseFare) emergencyBaseFare.textContent = `ZMW ${baseFare.toFixed(2)}`;
    if (emergencyDistance) emergencyDistance.textContent = `${distance.toFixed(1)} km`;
    if (emergencyTotalFare) emergencyTotalFare.textContent = `ZMW ${fare.toFixed(2)}`;
    
    AppState.rideFare = fare;
}

// Request emergency ride
async function requestEmergencyRide() {
    const modal = document.getElementById('emergencyModal');
    if (!modal) return;
    
    const serviceType = modal.dataset.serviceType;
    const selectedReason = document.querySelector('.emergency-reason-btn.active');
    
    if (!selectedReason) {
        showToast('Please select an emergency reason', 'warning');
        return;
    }
    
    const reason = selectedReason.dataset.reason;
    const otherReason = reason === 'other' ? document.getElementById('emergencyOtherReason').value.trim() : '';
    
    if (reason === 'other' && !otherReason) {
        showToast('Please describe the emergency', 'warning');
        return;
    }
    
    const selectedStation = document.querySelector('.emergency-station.selected');
    if (!selectedStation) {
        showToast('Please select an emergency station', 'warning');
        return;
    }
    
    // Get station details
    const stationName = selectedStation.querySelector('.station-name').textContent;
    const stationDistance = parseFloat(selectedStation.querySelector('.station-distance').textContent.replace(' km', ''));
    
    // Create emergency ride data
    const rideData = {
        pickup: AppState.userLocation ? `Current location (${AppState.userLocation.lat.toFixed(6)}, ${AppState.userLocation.lng.toFixed(6)})` : 'Current location',
        destination: stationName,
        serviceType: 'emergency',
        emergencyType: serviceType,
        emergencyReason: reason === 'other' ? otherReason : reason,
        fare: AppState.rideFare,
        priority: 'high',
        timestamp: Date.now()
    };
    
    showPaymentModal(rideData);
}

// ============================================
// SHOPPING FUNCTIONS
// ============================================

// Show shopping locations for selected category
async function showShoppingLocations(category) {
    const modal = document.getElementById('shoppingLocationsModal');
    if (!modal) return;
    
    // Set category
    modal.dataset.category = category;
    
    // Update title
    const categoryTitle = document.getElementById('shoppingCategoryTitle');
    if (categoryTitle) {
        const categoryNames = {
            restaurant: 'Restaurants',
            pharmacy: 'Pharmacies',
            supermarket: 'Supermarkets',
            mall: 'Shopping Malls'
        };
        categoryTitle.textContent = `Select ${categoryNames[category] || category}`;
    }
    
    showLoading('Loading locations...');
    
    try {
        const locations = await searchShoppingLocations(category);
        
        const locationsList = document.getElementById('shoppingLocationsList');
        if (locationsList) {
            locationsList.innerHTML = '';
            
            if (locations.length === 0) {
                locationsList.innerHTML = '<div style="text-align: center; color: var(--text-gray); padding: 20px;">No locations found in your area</div>';
            } else {
                locations.forEach(location => {
                    const locationElement = document.createElement('div');
                    locationElement.className = 'emergency-station';
                    
                    locationElement.innerHTML = `
                        <div class="station-header">
                            <div class="station-name">${location.name}</div>
                            <div class="station-distance">${location.distance.toFixed(1)} km</div>
                        </div>
                        <div class="station-address">${location.address}</div>
                    `;
                    
                    locationElement.addEventListener('click', () => {
                        // Set shop name and location
                        const shopNameInput = document.getElementById('shopName');
                        const shopLocationInput = document.getElementById('shopLocation');
                        
                        if (shopNameInput) shopNameInput.value = location.name;
                        if (shopLocationInput) shopLocationInput.value = location.address;
                        
                        // Update pickup location for shopping
                        AppState.pickup = {
                            lat: location.lat,
                            lng: location.lng,
                            address: location.address,
                            name: location.name
                        };
                        
                        // Hide modal
                        modal.style.display = 'none';
                        
                        // Update pickup display
                        updatePickupLocation();
                    });
                    
                    locationsList.appendChild(locationElement);
                });
            }
        }
        
        hideLoading();
        
        // Show modal
        modal.style.display = 'flex';
        
    } catch (error) {
        console.error('Error loading shopping locations:', error);
        hideLoading();
        showToast('Error loading locations', 'error');
    }
}

// Add shopping item
function addShoppingItem() {
    const shoppingItems = document.getElementById('shoppingItems');
    if (!shoppingItems) return;
    
    const itemEntry = document.createElement('div');
    itemEntry.className = 'item-entry';
    itemEntry.innerHTML = `
        <input type="text" class="item-input" placeholder="Item name">
        <button class="remove-item" type="button">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    shoppingItems.appendChild(itemEntry);
    
    // Add event listener to remove button
    const removeBtn = itemEntry.querySelector('.remove-item');
    removeBtn.addEventListener('click', function() {
        if (shoppingItems.children.length > 1) {
            itemEntry.remove();
        }
    });
}

// Get shopping items
function getShoppingItems() {
    const shoppingItems = document.getElementById('shoppingItems');
    if (!shoppingItems) return [];
    
    const items = [];
    shoppingItems.querySelectorAll('.item-input').forEach(input => {
        if (input.value.trim()) {
            items.push(input.value.trim());
        }
    });
    
    return items;
}

// ============================================
// NOTIFICATION FUNCTIONS
// ============================================

// Load notifications
async function loadNotifications(uid) {
    try {
        const snapshot = await database.ref(`notifications/${uid}`)
            .orderByChild('timestamp')
            .limitToLast(20)
            .once('value');
        
        const notifications = snapshot.val();
        if (notifications) {
            const notificationsArray = Object.values(notifications).reverse();
            const unreadCount = notificationsArray.filter(n => !n.read).length;
            updateNotificationBadge(unreadCount);
            updateNotifications(notificationsArray);
        }
    } catch (error) {
        console.error('Error loading notifications:', error);
    }
}

// Send notification
async function sendNotification(userId, title, message, type = 'info', data = {}) {
    try {
        const notificationId = database.ref().child(`notifications/${userId}`).push().key;
        
        await database.ref(`notifications/${userId}/${notificationId}`).set({
            id: notificationId,
            title: title,
            message: message,
            type: type,
            data: data,
            read: false,
            timestamp: Date.now()
        });
        
        return notificationId;
    } catch (error) {
        console.error('Error sending notification:', error);
        return null;
    }
}

// Update notification badge
function updateNotificationBadge(count) {
    const badge = document.getElementById('notificationCount');
    if (badge) {
        badge.textContent = count;
        badge.style.display = count > 0 ? 'flex' : 'none';
    }
}

// Update notifications list
function updateNotifications(notifications) {
    const notificationsList = document.getElementById('notificationsList');
    if (!notificationsList) return;
    
    notificationsList.innerHTML = '';
    
    if (notifications.length === 0) {
        notificationsList.innerHTML = `
            <div style="text-align: center; color: var(--text-gray); padding: 30px 20px;">
                <i class="fas fa-bell-slash" style="font-size: 40px; margin-bottom: 10px;"></i>
                <div>No notifications</div>
            </div>
        `;
        return;
    }
    
    notifications.forEach(notification => {
        const notificationElement = document.createElement('div');
        notificationElement.className = 'notification-item';
        if (!notification.read) {
            notificationElement.classList.add('unread');
        }
        
        // Set icon based on type
        let icon = 'fa-info-circle';
        let iconColor = 'var(--info-blue)';
        
        switch(notification.type) {
            case 'success':
                icon = 'fa-check-circle';
                iconColor = 'var(--success-green)';
                break;
            case 'error':
                icon = 'fa-exclamation-circle';
                iconColor = 'var(--error-red)';
                break;
            case 'warning':
                icon = 'fa-exclamation-triangle';
                iconColor = 'var(--warning-yellow)';
                break;
            case 'ride':
                icon = 'fa-car';
                iconColor = 'var(--primary-orange)';
                break;
            case 'payment':
                icon = 'fa-money-bill-wave';
                iconColor = 'var(--success-green)';
                break;
            case 'referral':
                icon = 'fa-gift';
                iconColor = 'var(--primary-orange)';
                break;
            case 'share':
                icon = 'fa-user-friends';
                iconColor = 'var(--info-blue)';
                break;
            case 'broadcast':
                icon = 'fa-broadcast-tower';
                iconColor = 'var(--warning-yellow)';
                break;
        }
        
        const time = new Date(notification.timestamp);
        const timeString = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        notificationElement.innerHTML = `
            <div class="notification-header">
                <div class="notification-title">
                    <i class="fas ${icon}" style="color: ${iconColor}"></i>
                    ${notification.title}
                </div>
                <div class="notification-time">${timeString}</div>
            </div>
            <div class="notification-message">${notification.message}</div>
        `;
        
        notificationElement.addEventListener('click', async () => {
            if (!notification.read) {
                // Mark as read
                await database.ref(`notifications/${AppState.currentUser.uid}/${notification.id}/read`).set(true);
            }
            
            // Handle notification action
            handleNotificationAction(notification);
        });
        
        notificationsList.appendChild(notificationElement);
    });
}

// Handle notification action
function handleNotificationAction(notification) {
    switch(notification.type) {
        case 'share':
            // Show share invitation if available
            if (notification.data && notification.data.invitationId) {
                // The real-time listener will handle showing the invitation
            }
            break;
            
        case 'ride':
            // Show ride info if it's the current ride
            if (AppState.currentRide) {
                showRideInfo(AppState.currentRide);
            }
            break;
            
        case 'payment':
            // Show wallet or ride history
            switchScreen('account');
            break;
    }
}

// Toggle notifications panel
function toggleNotifications() {
    const panel = document.getElementById('notificationsPanel');
    if (!panel) return;
    
    if (panel.classList.contains('active')) {
        panel.classList.remove('active');
        AppState.notificationsOpen = false;
    } else {
        panel.classList.add('active');
        AppState.notificationsOpen = true;
        
        // Mark all notifications as read
        markAllNotificationsAsRead();
    }
}

// Mark all notifications as read
async function markAllNotificationsAsRead() {
    if (!AppState.currentUser) return;
    
    try {
        const snapshot = await database.ref(`notifications/${AppState.currentUser.uid}`).once('value');
        const notifications = snapshot.val();
        
        if (notifications) {
            const updates = {};
            Object.keys(notifications).forEach(key => {
                updates[`${key}/read`] = true;
            });
            
            await database.ref(`notifications/${AppState.currentUser.uid}`).update(updates);
            
            // Update badge
            updateNotificationBadge(0);
        }
    } catch (error) {
        console.error('Error marking notifications as read:', error);
    }
}

// ============================================
// UI UPDATE FUNCTIONS
// ============================================

// Update user info display
function updateUserInfo() {
    if (!AppState.userData) return;
    
    const userFullName = document.getElementById('userFullName');
    const accountName = document.getElementById('accountName');
    const accountPhone = document.getElementById('accountPhone');
    const referralCode = document.getElementById('referralCode');
    
    if (userFullName) userFullName.textContent = AppState.userData.name || 'User';
    if (accountName) accountName.textContent = AppState.userData.name || 'User';
    if (accountPhone) accountPhone.textContent = AppState.userData.phone || '';
    if (referralCode) referralCode.value = AppState.userData.referralCode || 'JUBEL-XXXX';
}

// Update city display
function updateCityDisplay(city) {
    const display = document.getElementById('currentCityDisplay');
    if (display) {
        display.textContent = `City: ${city}`;
    }
}

// Update pickup location
function updatePickupLocation() {
    if (!AppState.userLocation) return;
    
    // Update all pickup inputs
    const pickupInputs = [
        'pickupLocation',
        'deliveryPickup',
        'shortDeliveryPickup',
        'truckPickup',
        'splitPickup',
        'broadcastPickup',
        'schedulePickup'
    ];
    
    const address = AppState.userLocation ? `Current location (${AppState.userLocation.lat.toFixed(6)}, ${AppState.userLocation.lng.toFixed(6)})` : 'Current location';
    
    pickupInputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
            input.value = address;
            
            // Show clear button
            const clearBtn = input.parentNode.querySelector('.clear-pickup-btn');
            if (clearBtn) {
                clearBtn.style.display = 'block';
            }
            
            // Show edit button
            const editBtn = input.parentNode.querySelector('.edit-pickup-btn');
            if (editBtn) {
                editBtn.style.display = 'block';
            }
        }
    });
    
    // Update pickup in state
    AppState.pickup = {
        lat: AppState.userLocation.lat,
        lng: AppState.userLocation.lng,
        address: address
    };
    
    // Update pickup marker on map
    updatePickupMarker();
}

// Update pickup marker
function updatePickupMarker() {
    if (!AppState.map || !AppState.pickup) return;
    
    if (AppState.pickupMarker) {
        AppState.pickupMarker.setLatLng([AppState.pickup.lat, AppState.pickup.lng]);
    } else {
        AppState.pickupMarker = L.marker([AppState.pickup.lat, AppState.pickup.lng], {
            icon: L.divIcon({
                className: 'pickup-marker',
                html: '<i class="fas fa-map-marker-alt"></i>',
                iconSize: [20, 20],
                iconAnchor: [10, 20]
            })
        }).addTo(AppState.map).bindPopup('Pickup Location');
    }
}

// Update current pickup display in ride info
function updateCurrentPickup(pickup) {
    const currentPickup = document.getElementById('currentPickup');
    if (currentPickup) {
        currentPickup.textContent = pickup;
    }
}

// Update current destination display in ride info
function updateCurrentDestination(destination) {
    const currentDestination = document.getElementById('currentDestination');
    if (currentDestination) {
        currentDestination.textContent = destination;
    }
}

// Show toast notification
function showToast(message, type = 'info', duration = 5000) {
    const container = document.getElementById('toastContainer');
    if (!container) return;
    
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    
    let icon = 'fa-info-circle';
    switch(type) {
        case 'success':
            icon = 'fa-check-circle';
            break;
        case 'error':
            icon = 'fa-exclamation-circle';
            break;
        case 'warning':
            icon = 'fa-exclamation-triangle';
            break;
    }
    
    toast.innerHTML = `
        <div class="toast-icon">
            <i class="fas ${icon}"></i>
        </div>
        <div class="toast-content">
            <div class="toast-title">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
            <div class="toast-message">${message}</div>
        </div>
        <button class="toast-close">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    container.appendChild(toast);
    
    // Add close button event listener
    const closeBtn = toast.querySelector('.toast-close');
    closeBtn.addEventListener('click', () => {
        toast.remove();
    });
    
    // Auto-remove after duration
    setTimeout(() => {
        if (toast.parentNode) {
            toast.remove();
        }
    }, duration);
}

// Show loading overlay
function showLoading(message = 'Loading...') {
    const overlay = document.getElementById('loadingOverlay');
    const text = document.getElementById('loadingText');
    
    if (overlay) {
        if (text) text.textContent = message;
        overlay.style.display = 'flex';
    }
}

// Hide loading overlay
function hideLoading() {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
        overlay.style.display = 'none';
    }
}

// Hide map loading overlay
function hideMapLoading() {
    const overlay = document.getElementById('mapLoadingOverlay');
    if (overlay) {
        overlay.style.display = 'none';
    }
}

// Show modal
function showModal(modalId) {
    const modal = document.getElementById(`${modalId}Modal`);
    if (modal) {
        modal.style.display = 'flex';
    }
}

// Hide modal
function hideModal(modalId) {
    const modal = document.getElementById(`${modalId}Modal`);
    if (modal) {
        modal.style.display = 'none';
    }
}

// Hide all modals
function hideAllModals() {
    document.querySelectorAll('.modal-overlay').forEach(modal => {
        modal.style.display = 'none';
    });
}

// Switch screen
function switchScreen(screen) {
    // Hide all screens
    document.querySelectorAll('.ride-request-form').forEach(form => {
        form.style.display = 'none';
    });
    
    // Hide chat and notifications
    const chatContainer = document.getElementById('chatContainer');
    const notificationsPanel = document.getElementById('notificationsPanel');
    const moreOptionsMenu = document.getElementById('moreOptionsMenu');
    
    if (chatContainer) chatContainer.classList.remove('active');
    if (notificationsPanel) notificationsPanel.classList.remove('active');
    if (moreOptionsMenu) moreOptionsMenu.classList.remove('active');
    
    AppState.chatOpen = false;
    AppState.notificationsOpen = false;
    
    // Update active nav tab
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.screen === screen) {
            tab.classList.add('active');
        }
    });
    
    AppState.activeScreen = screen;
    
    // Show selected screen
    if (screen === 'home') {
        document.getElementById('homeContent').style.display = 'block';
        
        // Show appropriate form based on active service
        switchService(AppState.activeService);
        
    } else {
        const screenElement = document.getElementById(`${screen}Screen`);
        if (screenElement) {
            screenElement.style.display = 'block';
        }
        
        // Load data for specific screens
        if (screen === 'history') {
            loadRideHistory();
        }
    }
}

// Switch service
function switchService(service) {
    // Hide all forms
    document.querySelectorAll('.ride-request-form').forEach(form => {
        form.style.display = 'none';
    });
    
    // Update active service tab
    document.querySelectorAll('.service-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.service === service) {
            tab.classList.add('active');
        }
    });
    
    AppState.activeService = service;
    
    // Show appropriate form
    let formId = 'carForm';
    
    switch(service) {
        case 'delivery':
            formId = 'deliveryForm';
            break;
        case 'short-delivery':
            formId = 'shortDeliveryForm';
            break;
        case 'express':
            formId = 'expressForm';
            break;
        case 'truck':
            formId = 'truckForm';
            break;
        case 'split':
            formId = 'splitRideForm';
            break;
        case 'broadcast':
            formId = 'broadcastRideForm';
            break;
    }
    
    const form = document.getElementById(formId);
    if (form) {
        form.style.display = 'block';
    }
}

// Toggle panel
function togglePanel() {
    const panel = document.getElementById('mainPanel');
    if (panel) {
        panel.classList.toggle('collapsed');
    }
}

// ============================================
// EVENT LISTENER SETUP
// ============================================

function setupEventListeners() {
    // Navigation tabs
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const screen = tab.dataset.screen;
            switchScreen(screen);
        });
    });
    
    // Back buttons
    document.querySelectorAll('.back-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            switchScreen('home');
        });
    });
    
    // Panel handle
    const panelHandle = document.getElementById('panelHandle');
    if (panelHandle) {
        panelHandle.addEventListener('click', togglePanel);
    }
    
    // Service tabs
    document.querySelectorAll('.service-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const service = tab.dataset.service;
            switchService(service);
        });
    });
    
    // Map controls
    const locateMeBtn = document.getElementById('locateMeBtn');
    if (locateMeBtn) {
        locateMeBtn.addEventListener('click', getCurrentLocation);
    }
    
    const zoomInBtn = document.getElementById('zoomInBtn');
    if (zoomInBtn) {
        zoomInBtn.addEventListener('click', () => {
            if (AppState.map) {
                AppState.map.zoomIn();
            }
        });
    }
    
    const zoomOutBtn = document.getElementById('zoomOutBtn');
    if (zoomOutBtn) {
        zoomOutBtn.addEventListener('click', () => {
            if (AppState.map) {
                AppState.map.zoomOut();
            }
        });
    }
    
    const clearRouteBtn = document.getElementById('clearRouteBtn');
    if (clearRouteBtn) {
        clearRouteBtn.addEventListener('click', () => {
            // Clear route and destination
            if (AppState.routeLayer) {
                AppState.map.removeLayer(AppState.routeLayer);
                AppState.routeLayer = null;
            }
            
            if (AppState.destinationMarker) {
                AppState.map.removeLayer(AppState.destinationMarker);
                AppState.destinationMarker = null;
            }
            
            // Clear destination input
            const destinationInput = document.getElementById('destinationLocation');
            if (destinationInput) {
                destinationInput.value = '';
            }
            
            AppState.destination = null;
            
            // Hide fare display
            const fareDisplay = document.getElementById('fareDisplay');
            if (fareDisplay) {
                fareDisplay.classList.remove('active');
            }
            
            showToast('Route cleared', 'info');
        });
    }
    
    // Request ride button
    const requestRideBtn = document.getElementById('requestRideBtn');
    if (requestRideBtn) {
        requestRideBtn.addEventListener('click', () => {
            if (!AppState.pickup || !AppState.destination) {
                showToast('Please select pickup and destination locations', 'warning');
                return;
            }
            
            const distance = calculateDistance(
                AppState.pickup.lat, AppState.pickup.lng,
                AppState.destination.lat, AppState.destination.lng
            );
            
            if (distance < 0.5) {
                showToast('Minimum ride distance is 0.5 km', 'warning');
                return;
            }
            
            const rideData = {
                pickup: AppState.pickup.address,
                destination: AppState.destination.address,
                pickupLat: AppState.pickup.lat,
                pickupLng: AppState.pickup.lng,
                destLat: AppState.destination.lat,
                destLng: AppState.destination.lng,
                rideType: AppState.selectedRideType,
                fare: AppState.rideFare,
                distance: distance,
                serviceType: 'car'
            };
            
            requestRide(rideData);
        });
    }
    
    // More options button
    const moreOptionsBtn = document.getElementById('moreOptionsBtn');
    if (moreOptionsBtn) {
        moreOptionsBtn.addEventListener('click', () => {
            const menu = document.getElementById('moreOptionsMenu');
            menu.classList.toggle('active');
        });
    }
    
    // More options menu items
    document.querySelectorAll('#moreOptionsMenu .dropdown-item').forEach(item => {
        item.addEventListener('click', () => {
            const option = item.dataset.option;
            
            switch(option) {
                case 'schedule':
                    showModal('schedule');
                    break;
                case 'orderForSomeone':
                    // Similar to schedule but for someone else
                    showToast('Feature coming soon', 'info');
                    break;
                case 'shareRide':
                    switchService('split');
                    break;
                case 'broadcast':
                    switchService('broadcast');
                    break;
            }
            
            // Hide menu
            const menu = document.getElementById('moreOptionsMenu');
            menu.classList.remove('active');
        });
    });
    
    // SOS button
    const sosButton = document.getElementById('sosButton');
    if (sosButton) {
        sosButton.addEventListener('click', triggerSOS);
    }
    
    // SOS setup button
    const sosSetupBtn = document.getElementById('sosSetupBtn');
    if (sosSetupBtn) {
        sosSetupBtn.addEventListener('click', () => {
            showModal('sos');
        });
    }
    
    // Cancel ride button
    const cancelRideBtn = document.getElementById('cancelRideBtn');
    if (cancelRideBtn) {
        cancelRideBtn.addEventListener('click', () => {
            showModal('cancel');
        });
    }
    
    // Contact driver button
    const contactDriverBtn = document.getElementById('contactDriverBtn');
    if (contactDriverBtn) {
        contactDriverBtn.addEventListener('click', () => {
            if (AppState.currentRide && AppState.currentRide.driverPhone) {
                // In a real app, this would call the driver
                showToast('Calling driver...', 'info');
            } else {
                showToast('Driver phone number not available', 'warning');
            }
        });
    }
    
    // Open chat button
    const openChatBtn = document.getElementById('openChatBtn');
    if (openChatBtn) {
        openChatBtn.addEventListener('click', () => {
            const chatContainer = document.getElementById('chatContainer');
            if (chatContainer) {
                chatContainer.classList.add('active');
                AppState.chatOpen = true;
            }
        });
    }
    
    // Close chat button
    const chatClose = document.getElementById('chatClose');
    if (chatClose) {
        chatClose.addEventListener('click', () => {
            const chatContainer = document.getElementById('chatContainer');
            if (chatContainer) {
                chatContainer.classList.remove('active');
                AppState.chatOpen = false;
            }
        });
    }
    
    // Send chat message
    const chatSend = document.getElementById('chatSend');
    const chatInput = document.getElementById('chatInput');
    
    if (chatSend && chatInput) {
        chatSend.addEventListener('click', sendChatMessage);
        
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });
    }
    
    // Notification bell
    const notificationBell = document.getElementById('notificationBell');
    if (notificationBell) {
        notificationBell.addEventListener('click', toggleNotifications);
    }
    
    // Close notifications button
    const notificationsClose = document.getElementById('notificationsClose');
    if (notificationsClose) {
        notificationsClose.addEventListener('click', () => {
            const panel = document.getElementById('notificationsPanel');
            if (panel) {
                panel.classList.remove('active');
                AppState.notificationsOpen = false;
            }
        });
    }
    
    // Emergency services
    document.querySelectorAll('.emergency-service').forEach(service => {
        service.addEventListener('click', () => {
            const type = service.dataset.type;
            
            if (type === 'sos') {
                showModal('sos');
            } else {
                showEmergencyServices(type);
            }
        });
    }
    
    // Close modals
    document.querySelectorAll('.modal-close').forEach(btn => {
        btn.addEventListener('click', () => {
            const modal = btn.dataset.modal;
            hideModal(modal);
        });
    });
    
    // Modal overlay click to close
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
                overlay.style.display = 'none';
            }
        });
    });
    
    // Cancel reasons
    document.querySelectorAll('.cancel-reason').forEach(reason => {
        reason.addEventListener('click', () => {
            // Remove active class from all reasons
            document.querySelectorAll('.cancel-reason').forEach(r => {
                r.classList.remove('active');
            });
            
            // Add active class to clicked reason
            reason.classList.add('active');
            
            // Show/hide other reason input
            const otherReasonGroup = document.getElementById('otherReasonGroup');
            if (otherReasonGroup) {
                otherReasonGroup.style.display = 
                    reason.dataset.reason === 'other' ? 'block' : 'none';
            }
        });
    });
    
    // Confirm cancel button
    const confirmCancelBtn = document.getElementById('confirmCancelBtn');
    if (confirmCancelBtn) {
        confirmCancelBtn.addEventListener('click', async () => {
            const selectedReason = document.querySelector('.cancel-reason.active');
            if (!selectedReason) {
                showToast('Please select a cancellation reason', 'warning');
                return;
            }
            
            let reason = selectedReason.dataset.reason;
            if (reason === 'other') {
                const otherReason = document.getElementById('otherReason').value.trim();
                if (!otherReason) {
                    showToast('Please specify your reason', 'warning');
                    return;
                }
                reason = `other: ${otherReason}`;
            }
            
            await cancelRide(reason);
            hideModal('cancel');
        });
    }
    
    // Payment methods
    document.querySelectorAll('.payment-method').forEach(method => {
        method.addEventListener('click', () => {
            // Remove active class from all methods
            document.querySelectorAll('.payment-method').forEach(m => {
                m.classList.remove('active');
            });
            
            // Add active class to clicked method
            method.classList.add('active');
        });
    });
    
    // Apply referral button
    const applyReferralBtn = document.getElementById('applyReferralBtn');
    if (applyReferralBtn) {
        applyReferralBtn.addEventListener('click', async () => {
            const referralCodeInput = document.getElementById('referralCodeInput');
            if (!referralCodeInput) return;
            
            const code = referralCodeInput.value.trim();
            await applyReferralDiscount(code);
        });
    }
    
    // Confirm payment button
    const confirmPaymentBtn = document.getElementById('confirmPaymentBtn');
    if (confirmPaymentBtn) {
        confirmPaymentBtn.addEventListener('click', confirmPayment);
    }
    
    // Emergency reason buttons
    document.querySelectorAll('.emergency-reason-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            // Remove active class from all buttons
            document.querySelectorAll('.emergency-reason-btn').forEach(b => {
                b.classList.remove('active');
            });
            
            // Add active class to clicked button
            btn.classList.add('active');
            
            // Show/hide other reason input
            const otherReasonGroup = document.getElementById('emergencyReasonOther');
            if (otherReasonGroup) {
                otherReasonGroup.style.display = 
                    btn.dataset.reason === 'other' ? 'block' : 'none';
            }
        });
    });
    
    // Confirm emergency button
    const confirmEmergencyBtn = document.getElementById('confirmEmergencyBtn');
    if (confirmEmergencyBtn) {
        confirmEmergencyBtn.addEventListener('click', requestEmergencyRide);
    }
    
    // Save SOS button
    const saveSOSBtn = document.getElementById('saveSOSBtn');
    if (saveSOSBtn) {
        saveSOSBtn.addEventListener('click', saveSOSConfig);
    }
    
    // Confirm schedule button
    const confirmScheduleBtn = document.getElementById('confirmScheduleBtn');
    if (confirmScheduleBtn) {
        confirmScheduleBtn.addEventListener('click', async () => {
            const date = document.getElementById('scheduleDate').value;
            const time = document.getElementById('scheduleTime').value;
            
            if (!date || !time) {
                showToast('Please select date and time', 'warning');
                return;
            }
            
            if (!AppState.pickup || !AppState.destination) {
                showToast('Please select pickup and destination locations', 'warning');
                return;
            }
            
            const scheduledTime = new Date(`${date}T${time}`).getTime();
            
            if (scheduledTime <= Date.now()) {
                showToast('Please select a future time', 'warning');
                return;
            }
            
            const distance = calculateDistance(
                AppState.pickup.lat, AppState.pickup.lng,
                AppState.destination.lat, AppState.destination.lng
            );
            
            const fare = calculateFare(distance);
            
            const rideData = {
                pickup: AppState.pickup.address,
                destination: AppState.destination.address,
                pickupLat: AppState.pickup.lat,
                pickupLng: AppState.pickup.lng,
                destLat: AppState.destination.lat,
                destLng: AppState.destination.lng,
                rideType: AppState.selectedRideType,
                fare: fare,
                distance: distance,
                serviceType: 'car'
            };
            
            await scheduleRide(rideData, scheduledTime);
            hideModal('schedule');
        });
    }
    
    // Accept share invitation button
    const acceptShareInvitationBtn = document.getElementById('acceptShareInvitationBtn');
    if (acceptShareInvitationBtn) {
        acceptShareInvitationBtn.addEventListener('click', () => {
            const modal = document.getElementById('shareInvitationModal');
            if (modal && modal.dataset.invitationId) {
                acceptShareInvitation(modal.dataset.invitationId);
            }
        });
    }
    
    // Reject share invitation button
    const rejectShareInvitationBtn = document.getElementById('rejectShareInvitationBtn');
    if (rejectShareInvitationBtn) {
        rejectShareInvitationBtn.addEventListener('click', () => {
            const modal = document.getElementById('shareInvitationModal');
            if (modal && modal.dataset.invitationId) {
                rejectShareInvitation(modal.dataset.invitationId);
            }
        });
    }
    
    // Add stop button
    const addStopBtn = document.getElementById('addStopBtn');
    if (addStopBtn) {
        addStopBtn.addEventListener('click', addStop);
    }
    
    // Ride type cards
    document.querySelectorAll('.ride-type-card').forEach(card => {
        card.addEventListener('click', () => {
            // Remove selected class from all cards
            card.parentNode.querySelectorAll('.ride-type-card').forEach(c => {
                c.classList.remove('selected');
            });
            
            // Add selected class to clicked card
            card.classList.add('selected');
            
            // Update selected ride type
            AppState.selectedRideType = card.dataset.type;
            
            // Recalculate fare if destination is set
            if (AppState.pickup && AppState.destination) {
                const distance = calculateDistance(
                    AppState.pickup.lat, AppState.pickup.lng,
                    AppState.destination.lat, AppState.destination.lng
                );
                updateFareDisplay(distance, distance * 2); // Estimate duration
            }
        });
    });
    
    // Shopping categories
    document.querySelectorAll('.shopping-category').forEach(category => {
        category.addEventListener('click', () => {
            const categoryType = category.dataset.category;
            showShoppingLocations(categoryType);
        });
    });
    
    // Add shopping item button
    const addItemBtn = document.getElementById('addItemBtn');
    if (addItemBtn) {
        addItemBtn.addEventListener('click', addShoppingItem);
    }
    
    // Add split friend button
    const addSplitFriendBtn = document.getElementById('addSplitFriendBtn');
    if (addSplitFriendBtn) {
        addSplitFriendBtn.addEventListener('click', async () => {
            const friendInput = document.getElementById('splitFriendInput');
            if (!friendInput) return;
            
            const code = friendInput.value.trim();
            if (!code) {
                showToast('Please enter a referral code', 'warning');
                return;
            }
            
            const success = await addSplitFriend(code);
            if (success) {
                friendInput.value = '';
            }
        });
    }
    
    // Add broadcast friend button
    const addBroadcastFriendBtn = document.getElementById('addBroadcastFriendBtn');
    if (addBroadcastFriendBtn) {
        addBroadcastFriendBtn.addEventListener('click', async () => {
            const friendInput = document.getElementById('broadcastFriendInput');
            if (!friendInput) return;
            
            const code = friendInput.value.trim();
            if (!code) {
                showToast('Please enter a referral code', 'warning');
                return;
            }
            
            const success = await addBroadcastFriend(code);
            if (success) {
                friendInput.value = '';
            }
        });
    }
    
    // Destination search inputs
    const destinationInputs = [
        'destinationLocation',
        'deliveryDestination',
        'shortDeliveryDestination',
        'truckDestination',
        'splitDestination',
        'broadcastDestination',
        'shoppingDestination',
        'scheduleDestination'
    ];
    
    destinationInputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
            let searchTimeout;
            
            input.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                
                const query = input.value.trim();
                if (query.length < 2) {
                    const suggestions = document.getElementById(`${inputId}Suggestions`);
                    if (suggestions) {
                        suggestions.style.display = 'none';
                    }
                    return;
                }
                
                searchTimeout = setTimeout(async () => {
                    const results = await searchLocations(query);
                    showSearchSuggestions(inputId, results);
                }, 300);
            });
            
            input.addEventListener('focus', () => {
                const query = input.value.trim();
                if (query.length >= 2) {
                    // Show suggestions if there's already text
                    setTimeout(async () => {
                        const results = await searchLocations(query);
                        showSearchSuggestions(inputId, results);
                    }, 100);
                }
            });
            
            input.addEventListener('blur', () => {
                // Hide suggestions after a delay
                setTimeout(() => {
                    const suggestions = document.getElementById(`${inputId}Suggestions`);
                    if (suggestions) {
                        suggestions.style.display = 'none';
                    }
                }, 200);
            });
        }
    });
    
    // Shop name search
    const shopNameInput = document.getElementById('shopName');
    if (shopNameInput) {
        let searchTimeout;
        
        shopNameInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            
            const query = shopNameInput.value.trim();
            if (query.length < 2) {
                const suggestions = document.getElementById('shopSuggestions');
                if (suggestions) {
                    suggestions.style.display = 'none';
                }
                return;
            }
            
            searchTimeout = setTimeout(async () => {
                const results = await searchLocations(query);
                showSearchSuggestions('shopName', results);
            }, 300);
        });
    }
    
    // Pickup location edit buttons
    document.querySelectorAll('.edit-pickup-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            
            const input = btn.parentNode.querySelector('input');
            if (input) {
                input.removeAttribute('readonly');
                input.focus();
                
                // Change edit button to save button
                btn.innerHTML = '<i class="fas fa-save"></i>';
                btn.title = 'Save pickup location';
                
                // Change click handler
                btn.onclick = (e) => {
                    e.stopPropagation();
                    savePickupLocation(input, btn);
                };
            }
        });
    });
    
    // Pickup location clear buttons
    document.querySelectorAll('.clear-pickup-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            
            const input = btn.parentNode.querySelector('input');
            if (input) {
                input.value = '';
                btn.style.display = 'none';
                
                // Hide edit button if visible
                const editBtn = btn.parentNode.querySelector('.edit-pickup-btn');
                if (editBtn) {
                    editBtn.style.display = 'none';
                }
                
                // Clear pickup in state
                AppState.pickup = null;
                
                // Clear pickup marker
                if (AppState.pickupMarker) {
                    AppState.map.removeLayer(AppState.pickupMarker);
                    AppState.pickupMarker = null;
                }
                
                // Clear route if exists
                if (AppState.routeLayer) {
                    AppState.map.removeLayer(AppState.routeLayer);
                    AppState.routeLayer = null;
                }
                
                // Hide fare display
                const fareDisplay = document.getElementById('fareDisplay');
                if (fareDisplay) {
                    fareDisplay.classList.remove('active');
                }
                
                showToast('Pickup location cleared', 'info');
            }
        });
    });
    
    // Pickup location inputs for manual entry
    const pickupInputs = [
        'pickupLocation',
        'deliveryPickup',
        'shortDeliveryPickup',
        'truckPickup',
        'splitPickup',
        'broadcastPickup',
        'schedulePickup'
    ];
    
    pickupInputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
            let searchTimeout;
            
            input.addEventListener('input', function() {
                if (this.readOnly) return;
                
                clearTimeout(searchTimeout);
                
                const query = this.value.trim();
                if (query.length < 2) {
                    const suggestions = document.getElementById(`${inputId}Suggestions`);
                    if (suggestions) {
                        suggestions.style.display = 'none';
                    }
                    return;
                }
                
                searchTimeout = setTimeout(async () => {
                    const results = await searchLocations(query, 'pickup');
                    showSearchSuggestions(inputId, results, true);
                }, 300);
            });
        }
    });
    
    // Deposit button
    const depositBtn = document.getElementById('depositBtn');
    if (depositBtn) {
        depositBtn.addEventListener('click', () => {
            showToast('Deposit feature coming soon', 'info');
        });
    }
    
    // Withdraw button
    const withdrawBtn = document.getElementById('withdrawBtn');
    if (withdrawBtn) {
        withdrawBtn.addEventListener('click', () => {
            showToast('Withdraw feature coming soon', 'info');
        });
    }
    
    // Transfer button
    const transferBtn = document.getElementById('transferBtn');
    if (transferBtn) {
        transferBtn.addEventListener('click', () => {
            showModal('transfer');
        });
    }
    
    // Copy referral button
    const copyReferralBtn = document.getElementById('copyReferralBtn');
    if (copyReferralBtn) {
        copyReferralBtn.addEventListener('click', () => {
            const referralCode = document.getElementById('referralCode');
            if (referralCode) {
                navigator.clipboard.writeText(referralCode.value)
                    .then(() => {
                        showToast('Referral code copied to clipboard', 'success');
                    })
                    .catch(() => {
                        showToast('Failed to copy referral code', 'error');
                    });
            }
        });
    }
    
    // Update profile button
    const updateProfileBtn = document.getElementById('updateProfileBtn');
    if (updateProfileBtn) {
        updateProfileBtn.addEventListener('click', () => {
            showToast('Update profile feature coming soon', 'info');
        });
    }
    
    // Logout button
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', async () => {
            if (confirm('Are you sure you want to logout?')) {
                showLoading('Logging out...');
                
                try {
                    // Stop all real-time listeners
                    AppState.realtimeListeners.forEach(listener => {
                        if (typeof listener === 'function') {
                            listener();
                        }
                    });
                    AppState.realtimeListeners = [];
                    
                    // Sign out
                    await auth.signOut();
                    
                    // Redirect to signup page
                    window.location.href = 'signup.html';
                    
                } catch (error) {
                    console.error('Error logging out:', error);
                    hideLoading();
                    showToast('Error logging out', 'error');
                }
            }
        });
    }
    
    // Confirm transfer button
    const confirmTransferBtn = document.getElementById('confirmTransferBtn');
    if (confirmTransferBtn) {
        confirmTransferBtn.addEventListener('click', async () => {
            const recipientCode = document.getElementById('recipientCode').value.trim();
            const amount = parseFloat(document.getElementById('transferAmount').value);
            const message = document.getElementById('transferMessage').value.trim();
            
            if (!recipientCode) {
                showToast('Please enter recipient referral code', 'warning');
                return;
            }
            
            if (!amount || amount <= 0) {
                showToast('Please enter a valid amount', 'warning');
                return;
            }
            
            if (amount > AppState.walletBalance) {
                showToast('Insufficient wallet balance', 'error');
                return;
            }
            
            const success = await transferMoney(recipientCode, amount, message);
            if (success) {
                hideModal('transfer');
            }
        });
    }
    
    // Set minimum date for schedule
    const scheduleDate = document.getElementById('scheduleDate');
    if (scheduleDate) {
        const today = new Date().toISOString().split('T')[0];
        scheduleDate.min = today;
        scheduleDate.value = today;
    }
    
    // Set default time for schedule
    const scheduleTime = document.getElementById('scheduleTime');
    if (scheduleTime) {
        const now = new Date();
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = (now.getMinutes() + 30).toString().padStart(2, '0'); // 30 minutes from now
        scheduleTime.value = `${hours}:${minutes}`;
    }
    
    // Broadcast ride button
    const broadcastRideBtn = document.getElementById('broadcastRideBtn');
    if (broadcastRideBtn) {
        broadcastRideBtn.addEventListener('click', () => {
            switchService('broadcast');
        });
    }
    
    // Request split ride button
    const requestSplitRideBtn = document.getElementById('requestSplitRideBtn');
    if (requestSplitRideBtn) {
        requestSplitRideBtn.addEventListener('click', async () => {
            if (!AppState.pickup || !AppState.destination) {
                showToast('Please select pickup and destination locations', 'warning');
                return;
            }
            
            if (AppState.shareRideFriends.length === 0) {
                showToast('Please add at least one friend to split the ride with', 'warning');
                return;
            }
            
            const distance = calculateDistance(
                AppState.pickup.lat, AppState.pickup.lng,
                AppState.destination.lat, AppState.destination.lng
            );
            
            const totalFare = calculateFare(distance);
            const numberOfPeople = AppState.shareRideFriends.length + 1;
            const yourShare = totalFare / numberOfPeople;
            
            const rideData = {
                pickup: AppState.pickup.address,
                destination: AppState.destination.address,
                pickupLat: AppState.pickup.lat,
                pickupLng: AppState.pickup.lng,
                destLat: AppState.destination.lat,
                destLng: AppState.destination.lng,
                rideType: AppState.selectedRideType,
                fare: totalFare,
                distance: distance,
                serviceType: 'car',
                splitRide: true,
                numberOfPeople: numberOfPeople,
                yourShare: yourShare
            };
            
            // Create ride in database
            showLoading('Creating split ride...');
            
            try {
                const rideId = await createRideInDatabase({
                    ...rideData,
                    status: 'pending',
                    timestamp: Date.now(),
                    passengerId: AppState.currentUser.uid,
                    passengerName: AppState.userData.name
                });
                
                // Send invitations
                await sendSplitRideInvitations(rideId, rideData);
                
                // Show payment modal for your share
                AppState.rideFare = yourShare;
                showPaymentModal({
                    ...rideData,
                    rideId: rideId
                });
                
                hideLoading();
                showToast('Split ride created. Invitations sent to friends.', 'success');
                
            } catch (error) {
                console.error('Error creating split ride:', error);
                hideLoading();
                showToast('Error creating split ride', 'error');
            }
        });
    }
    
    // Start broadcast ride button
    const startBroadcastRideBtn = document.getElementById('startBroadcastRideBtn');
    if (startBroadcastRideBtn) {
        startBroadcastRideBtn.addEventListener('click', async () => {
            if (!AppState.pickup || !AppState.destination) {
                showToast('Please select pickup and destination locations', 'warning');
                return;
            }
            
            const distance = calculateDistance(
                AppState.pickup.lat, AppState.pickup.lng,
                AppState.destination.lat, AppState.destination.lng
            );
            
            const fare = calculateFare(distance);
            
            const rideData = {
                pickup: AppState.pickup.address,
                destination: AppState.destination.address,
                pickupLat: AppState.pickup.lat,
                pickupLng: AppState.pickup.lng,
                destLat: AppState.destination.lat,
                destLng: AppState.destination.lng,
                rideType: AppState.selectedRideType,
                fare: fare,
                distance: distance,
                serviceType: 'car',
                broadcast: true
            };
            
            // Create ride in database
            showLoading('Creating broadcast ride...');
            
            try {
                const rideId = await createRideInDatabase({
                    ...rideData,
                    status: 'requested',
                    timestamp: Date.now(),
                    passengerId: AppState.currentUser.uid,
                    passengerName: AppState.userData.name
                });
                
                // Send broadcast notifications
                await sendBroadcastNotifications(rideId, rideData);
                
                // Show ride info
                AppState.currentRide = {
                    id: rideId,
                    ...rideData,
                    status: 'requested'
                };
                
                showRideInfo(AppState.currentRide);
                showPulsingIcon();
                
                hideLoading();
                showToast('Broadcast ride started. Friends can now track your ride.', 'success');
                
            } catch (error) {
                console.error('Error creating broadcast ride:', error);
                hideLoading();
                showToast('Error creating broadcast ride', 'error');
            }
        });
    }
    
    // Request delivery buttons
    const requestDeliveryBtn = document.getElementById('requestDeliveryBtn');
    if (requestDeliveryBtn) {
        requestDeliveryBtn.addEventListener('click', () => {
            if (!AppState.pickup || !AppState.destination) {
                showToast('Please select pickup and destination locations', 'warning');
                return;
            }
            
            const distance = calculateDistance(
                AppState.pickup.lat, AppState.pickup.lng,
                AppState.destination.lat, AppState.destination.lng
            );
            
            // Get delivery type
            const deliveryTypeBtn = document.querySelector('.delivery-type-btn.active');
            const deliveryType = deliveryTypeBtn ? deliveryTypeBtn.dataset.type : 'standard';
            
            // Get parcel value
            const parcelValueInput = document.getElementById('parcelValue');
            const parcelValue = parcelValueInput ? parseFloat(parcelValueInput.value) || 0 : 0;
            
            const fare = calculateFare(distance, 'delivery', {
                deliveryType: deliveryType,
                parcelValue: parcelValue
            });
            
            const rideData = {
                pickup: AppState.pickup.address,
                destination: AppState.destination.address,
                pickupLat: AppState.pickup.lat,
                pickupLng: AppState.pickup.lng,
                destLat: AppState.destination.lat,
                destLng: AppState.destination.lng,
                serviceType: 'delivery',
                deliveryType: deliveryType,
                parcelDescription: document.getElementById('parcelDescription').value,
                receiverName: document.getElementById('receiverName').value,
                receiverPhone: document.getElementById('receiverPhone').value,
                parcelValue: parcelValue,
                fare: fare,
                distance: distance
            };
            
            AppState.rideFare = fare;
            showPaymentModal(rideData);
        });
    }
    
    // Request short delivery button
    const requestShortDeliveryBtn = document.getElementById('requestShortDeliveryBtn');
    if (requestShortDeliveryBtn) {
        requestShortDeliveryBtn.addEventListener('click', () => {
            if (!AppState.pickup || !AppState.destination) {
                showToast('Please select pickup and destination locations', 'warning');
                return;
            }
            
            const distance = calculateDistance(
                AppState.pickup.lat, AppState.pickup.lng,
                AppState.destination.lat, AppState.destination.lng
            );
            
            const fare = calculateFare(distance, 'short-delivery');
            
            const rideData = {
                pickup: AppState.pickup.address,
                destination: AppState.destination.address,
                pickupLat: AppState.pickup.lat,
                pickupLng: AppState.pickup.lng,
                destLat: AppState.destination.lat,
                destLng: AppState.destination.lng,
                serviceType: 'short-delivery',
                parcelDescription: document.getElementById('shortParcelDescription').value,
                receiverPhone: document.getElementById('shortReceiverPhone').value,
                fare: fare,
                distance: distance
            };
            
            AppState.rideFare = fare;
            showPaymentModal(rideData);
        });
    }
    
    // Request shopping button
    const requestShoppingBtn = document.getElementById('requestShoppingBtn');
    if (requestShoppingBtn) {
        requestShoppingBtn.addEventListener('click', () => {
            if (!AppState.pickup || !AppState.destination) {
                showToast('Please select pickup and destination locations', 'warning');
                return;
            }
            
            const shopName = document.getElementById('shopName').value;
            if (!shopName) {
                showToast('Please select a shop', 'warning');
                return;
            }
            
            const distance = calculateDistance(
                AppState.pickup.lat, AppState.pickup.lng,
                AppState.destination.lat, AppState.destination.lng
            );
            
            // Get shopping items
            const items = getShoppingItems();
            if (items.length === 0) {
                showToast('Please add at least one item to your shopping list', 'warning');
                return;
            }
            
            // Get budget
            const budgetInput = document.getElementById('shoppingBudget');
            const budget = budgetInput ? parseFloat(budgetInput.value) || 0 : 0;
            
            // Calculate fare (base + distance + items + budget percentage)
            let fare = 30 + (distance * 2.5) + (items.length * 5);
            if (budget > 0) {
                fare += budget * 0.05;
            }
            fare = Math.round(fare * 100) / 100;
            
            const rideData = {
                pickup: AppState.pickup.address,
                destination: AppState.destination.address,
                pickupLat: AppState.pickup.lat,
                pickupLng: AppState.pickup.lng,
                destLat: AppState.destination.lat,
                destLng: AppState.destination.lng,
                serviceType: 'shopping',
                shopName: shopName,
                shopLocation: document.getElementById('shopLocation').value,
                items: items,
                instructions: document.getElementById('shoppingInstructions').value,
                budget: budget,
                fare: fare,
                distance: distance
            };
            
            AppState.rideFare = fare;
            showPaymentModal(rideData);
        });
    }
    
    // Request truck button
    const requestTruckBtn = document.getElementById('requestTruckBtn');
    if (requestTruckBtn) {
        requestTruckBtn.addEventListener('click', () => {
            if (!AppState.pickup || !AppState.destination) {
                showToast('Please select pickup and destination locations', 'warning');
                return;
            }
            
            const distance = calculateDistance(
                AppState.pickup.lat, AppState.pickup.lng,
                AppState.destination.lat, AppState.destination.lng
            );
            
            // Get truck type
            const truckTypeCard = document.querySelector('.ride-type-card.selected');
            const truckType = truckTypeCard ? truckTypeCard.dataset.type : 'light';
            
            // Get helpers option
            const needHelpers = document.getElementById('needHelpers').checked;
            
            const fare = calculateFare(distance, 'truck', {
                truckType: truckType,
                helpers: needHelpers
            });
            
            const rideData = {
                pickup: AppState.pickup.address,
                destination: AppState.destination.address,
                pickupLat: AppState.pickup.lat,
                pickupLng: AppState.pickup.lng,
                destLat: AppState.destination.lat,
                destLng: AppState.destination.lng,
                serviceType: 'truck',
                truckType: truckType,
                itemDescription: document.getElementById('truckItemDescription').value,
                estimatedWeight: document.getElementById('estimatedWeight').value,
                needHelpers: needHelpers,
                fare: fare,
                distance: distance
            };
            
            AppState.rideFare = fare;
            showPaymentModal(rideData);
        });
    }
    
    // Delivery type buttons
    document.querySelectorAll('.delivery-type-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            // Remove active class from all buttons
            btn.parentNode.querySelectorAll('.delivery-type-btn').forEach(b => {
                b.classList.remove('active');
            });
            
            // Add active class to clicked button
            btn.classList.add('active');
            
            // Recalculate fare if destination is set
            if (AppState.pickup && AppState.destination) {
                const distance = calculateDistance(
                    AppState.pickup.lat, AppState.pickup.lng,
                    AppState.destination.lat, AppState.destination.lng
                );
                
                const deliveryType = btn.dataset.type;
                const parcelValueInput = document.getElementById('parcelValue');
                const parcelValue = parcelValueInput ? parseFloat(parcelValueInput.value) || 0 : 0;
                
                const fare = calculateFare(distance, 'delivery', {
                    deliveryType: deliveryType,
                    parcelValue: parcelValue
                });
                
                // Update fare display
                const deliveryFare = document.getElementById('deliveryFare');
                const deliveryDistance = document.getElementById('deliveryDistance');
                
                if (deliveryFare) deliveryFare.textContent = `ZMW ${fare.toFixed(2)}`;
                if (deliveryDistance) deliveryDistance.textContent = `${distance.toFixed(1)} km`;
            }
        });
    });
    
    // Truck type selection
    document.querySelectorAll('.truck-form .ride-type-card').forEach(card => {
        card.addEventListener('click', () => {
            // Remove selected class from all cards
            card.parentNode.querySelectorAll('.ride-type-card').forEach(c => {
                c.classList.remove('selected');
            });
            
            // Add selected class to clicked card
            card.classList.add('selected');
            
            // Recalculate fare if destination is set
            if (AppState.pickup && AppState.destination) {
                const distance = calculateDistance(
                    AppState.pickup.lat, AppState.pickup.lng,
                    AppState.destination.lat, AppState.destination.lng
                );
                
                const truckType = card.dataset.type;
                const needHelpers = document.getElementById('needHelpers').checked;
                
                const fare = calculateFare(distance, 'truck', {
                    truckType: truckType,
                    helpers: needHelpers
                });
                
                // Update fare display
                const truckFare = document.getElementById('truckFare');
                const truckDistance = document.getElementById('truckDistance');
                
                if (truckFare) truckFare.textContent = `ZMW ${fare.toFixed(2)}`;
                if (truckDistance) truckDistance.textContent = `${distance.toFixed(1)} km`;
                
                // Update truck type price displays
                const truckTypes = ['pickup', 'light', 'medium', 'heavy'];
                truckTypes.forEach(type => {
                    const typeFare = calculateFare(distance, 'truck', {
                        truckType: type,
                        helpers: false
                    });
                    
                    const priceElement = document.getElementById(`${type}TruckPrice`);
                    if (priceElement) {
                        priceElement.textContent = `ZMW ${typeFare.toFixed(2)}`;
                    }
                });
            }
        });
    });
    
    // Helpers checkbox
    const needHelpers = document.getElementById('needHelpers');
    if (needHelpers) {
        needHelpers.addEventListener('change', () => {
            if (AppState.pickup && AppState.destination) {
                const distance = calculateDistance(
                    AppState.pickup.lat, AppState.pickup.lng,
                    AppState.destination.lat, AppState.destination.lng
                );
                
                const truckTypeCard = document.querySelector('.truck-form .ride-type-card.selected');
                const truckType = truckTypeCard ? truckTypeCard.dataset.type : 'light';
                
                const fare = calculateFare(distance, 'truck', {
                    truckType: truckType,
                    helpers: needHelpers.checked
                });
                
                // Update fare display
                const truckFare = document.getElementById('truckFare');
                if (truckFare) {
                    truckFare.textContent = `ZMW ${fare.toFixed(2)}`;
                }
            }
        });
    }
    
    // Parcel value input
    const parcelValueInput = document.getElementById('parcelValue');
    if (parcelValueInput) {
        parcelValueInput.addEventListener('input', () => {
            if (AppState.pickup && AppState.destination) {
                const distance = calculateDistance(
                    AppState.pickup.lat, AppState.pickup.lng,
                    AppState.destination.lat, AppState.destination.lng
                );
                
                const deliveryTypeBtn = document.querySelector('.delivery-type-btn.active');
                const deliveryType = deliveryTypeBtn ? deliveryTypeBtn.dataset.type : 'standard';
                
                const parcelValue = parseFloat(parcelValueInput.value) || 0;
                
                const fare = calculateFare(distance, 'delivery', {
                    deliveryType: deliveryType,
                    parcelValue: parcelValue
                });
                
                // Update fare display
                const deliveryFare = document.getElementById('deliveryFare');
                if (deliveryFare) {
                    deliveryFare.textContent = `ZMW ${fare.toFixed(2)}`;
                }
            }
        });
    }
    
    // Shopping budget input
    const shoppingBudget = document.getElementById('shoppingBudget');
    if (shoppingBudget) {
        shoppingBudget.addEventListener('input', () => {
            if (AppState.pickup && AppState.destination) {
                const distance = calculateDistance(
                    AppState.pickup.lat, AppState.pickup.lng,
                    AppState.destination.lat, AppState.destination.lng
                );
                
                const items = getShoppingItems();
                const budget = parseFloat(shoppingBudget.value) || 0;
                
                // Calculate fare
                let fare = 30 + (distance * 2.5) + (items.length * 5);
                if (budget > 0) {
                    fare += budget * 0.05;
                }
                fare = Math.round(fare * 100) / 100;
                
                // Update fare display
                const shoppingFare = document.getElementById('shoppingFare');
                if (shoppingFare) {
                    shoppingFare.textContent = `ZMW ${fare.toFixed(2)}`;
                }
            }
        });
    }
    
    // Shopping item inputs
    document.addEventListener('input', (e) => {
        if (e.target.classList.contains('item-input')) {
            if (AppState.pickup && AppState.destination) {
                const distance = calculateDistance(
                    AppState.pickup.lat, AppState.pickup.lng,
                    AppState.destination.lat, AppState.destination.lng
                );
                
                const items = getShoppingItems();
                const budgetInput = document.getElementById('shoppingBudget');
                const budget = budgetInput ? parseFloat(budgetInput.value) || 0 : 0;
                
                // Calculate fare
                let fare = 30 + (distance * 2.5) + (items.length * 5);
                if (budget > 0) {
                    fare += budget * 0.05;
                }
                fare = Math.round(fare * 100) / 100;
                
                // Update fare display
                const shoppingFare = document.getElementById('shoppingFare');
                if (shoppingFare) {
                    shoppingFare.textContent = `ZMW ${fare.toFixed(2)}`;
                }
            }
        }
    });
}

// ============================================
// HELPER FUNCTIONS
// ============================================

// Show search suggestions
function showSearchSuggestions(inputId, results, isPickup = false) {
    const suggestions = document.getElementById(`${inputId}Suggestions`);
    if (!suggestions) return;
    
    suggestions.innerHTML = '';
    
    if (results.length === 0) {
        suggestions.innerHTML = `
            <div class="suggestion-item">
                <div class="suggestion-icon">
                    <i class="fas fa-search"></i>
                </div>
                <div class="suggestion-details">
                    <div class="suggestion-name">No results found</div>
                    <div class="suggestion-address">Try a different search term</div>
                </div>
            </div>
        `;
    } else {
        results.forEach(result => {
            const item = document.createElement('div');
            item.className = 'suggestion-item';
            item.innerHTML = `
                <div class="suggestion-icon">
                    <i class="fas fa-map-marker-alt"></i>
                </div>
                <div class="suggestion-details">
                    <div class="suggestion-name">${result.name}</div>
                    <div class="suggestion-address">${result.address}</div>
                    ${result.distance ? `<div class="suggestion-distance">${result.distance.toFixed(1)} km away</div>` : ''}
                </div>
            `;
            
            item.addEventListener('click', () => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.value = result.address;
                    
                    if (isPickup) {
                        // Update pickup location
                        AppState.pickup = {
                            lat: result.lat,
                            lng: result.lng,
                            address: result.address,
                            name: result.name
                        };
                        
                        updatePickupMarker();
                        
                        // Show clear button
                        const clearBtn = input.parentNode.querySelector('.clear-pickup-btn');
                        if (clearBtn) {
                            clearBtn.style.display = 'block';
                        }
                        
                        // Reset edit button
                        const editBtn = input.parentNode.querySelector('.edit-pickup-btn');
                        if (editBtn) {
                            editBtn.innerHTML = '<i class="fas fa-edit"></i>';
                            editBtn.title = 'Edit pickup location';
                            editBtn.onclick = (e) => {
                                e.stopPropagation();
                                input.removeAttribute('readonly');
                                input.focus();
                                editBtn.innerHTML = '<i class="fas fa-save"></i>';
                                editBtn.onclick = (e) => {
                                    e.stopPropagation();
                                    savePickupLocation(input, editBtn);
                                };
                            };
                        }
                        
                        // Set input as readonly
                        input.setAttribute('readonly', true);
                    } else {
                        // Update destination
                        AppState.destination = {
                            lat: result.lat,
                            lng: result.lng,
                            address: result.address,
                            name: result.name
                        };
                        
                        // Draw route if pickup is set
                        if (AppState.pickup) {
                            drawRoute(AppState.pickup, AppState.destination);
                        }
                    }
                }
                
                // Hide suggestions
                suggestions.style.display = 'none';
            });
            
            suggestions.appendChild(item);
        });
    }
    
    suggestions.style.display = 'block';
}

// Save pickup location
function savePickupLocation(input, button) {
    const query = input.value.trim();
    
    if (!query) {
        showToast('Please enter a pickup location', 'warning');
        return;
    }
    
    // Search for the location
    showLoading('Searching for location...');
    
    setTimeout(async () => {
        const results = await searchLocations(query, 'pickup');
        
        if (results.length > 0) {
            const result = results[0];
            
            AppState.pickup = {
                lat: result.lat,
                lng: result.lng,
                address: result.address,
                name: result.name
            };
            
            input.value = result.address;
            input.setAttribute('readonly', true);
            
            updatePickupMarker();
            
            // Reset button
            button.innerHTML = '<i class="fas fa-edit"></i>';
            button.title = 'Edit pickup location';
            button.onclick = (e) => {
                e.stopPropagation();
                input.removeAttribute('readonly');
                input.focus();
                button.innerHTML = '<i class="fas fa-save"></i>';
                button.onclick = (e) => {
                    e.stopPropagation();
                    savePickupLocation(input, button);
                };
            };
            
            // Show clear button
            const clearBtn = input.parentNode.querySelector('.clear-pickup-btn');
            if (clearBtn) {
                clearBtn.style.display = 'block';
            }
            
            hideLoading();
            showToast('Pickup location updated', 'success');
            
            // Redraw route if destination is set
            if (AppState.destination) {
                drawRoute(AppState.pickup, AppState.destination);
            }
            
        } else {
            hideLoading();
            showToast('Location not found', 'error');
        }
    }, 100);
}

// Add stop
function addStop() {
    const stopsContainer = document.getElementById('stopsContainer');
    if (!stopsContainer) return;
    
    const stopCount = stopsContainer.children.length;
    
    if (stopCount >= 5) {
        showToast('Maximum 5 stops allowed', 'warning');
        return;
    }
    
    const stopItem = document.createElement('div');
    stopItem.className = 'stop-item';
    stopItem.innerHTML = `
        <i class="fas fa-map-marker-alt" style="color: var(--text-gray);"></i>
        <input type="text" class="stop-input" placeholder="Add stop ${stopCount + 1}" data-stop-index="${stopCount}">
        <button class="remove-stop" type="button">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    stopsContainer.appendChild(stopItem);
    
    // Add event listener to remove button
    const removeBtn = stopItem.querySelector('.remove-stop');
    removeBtn.addEventListener('click', function() {
        stopItem.remove();
        updateStopIndices();
    });
    
    // Add event listener to input for search
    const input = stopItem.querySelector('.stop-input');
    let searchTimeout;
    
    input.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        
        const query = input.value.trim();
        if (query.length < 2) return;
        
        searchTimeout = setTimeout(async () => {
            const results = await searchLocations(query);
            showStopSuggestions(input, results);
        }, 300);
    });
}

// Update stop indices
function updateStopIndices() {
    const stopsContainer = document.getElementById('stopsContainer');
    if (!stopsContainer) return;
    
    const stops = stopsContainer.querySelectorAll('.stop-item');
    stops.forEach((stop, index) => {
        const input = stop.querySelector('.stop-input');
        if (input) {
            input.placeholder = `Add stop ${index + 1}`;
            input.dataset.stopIndex = index;
        }
    });
}

// Show stop suggestions
function showStopSuggestions(input, results) {
    // Create suggestions container if it doesn't exist
    let suggestions = input.parentNode.querySelector('.suggestion-list');
    if (!suggestions) {
        suggestions = document.createElement('div');
        suggestions.className = 'suggestion-list';
        input.parentNode.appendChild(suggestions);
    }
    
    suggestions.innerHTML = '';
    
    if (results.length === 0) {
        suggestions.innerHTML = `
            <div class="suggestion-item">
                <div class="suggestion-icon">
                    <i class="fas fa-search"></i>
                </div>
                <div class="suggestion-details">
                    <div class="suggestion-name">No results found</div>
                    <div class="suggestion-address">Try a different search term</div>
                </div>
            </div>
        `;
    } else {
        results.forEach(result => {
            const item = document.createElement('div');
            item.className = 'suggestion-item';
            item.innerHTML = `
                <div class="suggestion-icon">
                    <i class="fas fa-map-marker-alt"></i>
                </div>
                <div class="suggestion-details">
                    <div class="suggestion-name">${result.name}</div>
                    <div class="suggestion-address">${result.address}</div>
                    ${result.distance ? `<div class="suggestion-distance">${result.distance.toFixed(1)} km away</div>` : ''}
                </div>
            `;
            
            item.addEventListener('click', () => {
                input.value = result.address;
                
                // Add stop to state
                const stopIndex = parseInt(input.dataset.stopIndex);
                AppState.stops[stopIndex] = {
                    lat: result.lat,
                    lng: result.lng,
                    address: result.address,
                    name: result.name
                };
                
                // Hide suggestions
                suggestions.style.display = 'none';
                
                // Recalculate route with stops
                if (AppState.pickup && AppState.destination) {
                    calculateRouteWithStops();
                }
            });
            
            suggestions.appendChild(item);
        });
    }
    
    suggestions.style.display = 'block';
    
    // Position suggestions below input
    const rect = input.getBoundingClientRect();
    suggestions.style.top = `${rect.height}px`;
    suggestions.style.left = '0';
    suggestions.style.right = '0';
}

// Calculate route with stops
async function calculateRouteWithStops() {
    if (!AppState.pickup || !AppState.destination) return;
    
    // For simplicity, we'll calculate distance as sum of straight line distances
    // In a real app, you would use a routing service that supports waypoints
    
    let totalDistance = 0;
    let lastPoint = AppState.pickup;
    
    // Add distances to stops
    for (const stop of AppState.stops) {
        if (stop) {
            totalDistance += calculateDistance(
                lastPoint.lat, lastPoint.lng,
                stop.lat, stop.lng
            );
            lastPoint = stop;
        }
    }
    
    // Add distance from last stop to destination
    totalDistance += calculateDistance(
        lastPoint.lat, lastPoint.lng,
        AppState.destination.lat, AppState.destination.lng
    );
    
    // Update fare display
    updateFareDisplay(totalDistance, totalDistance * 2); // Estimate duration
}

// Send chat message
async function sendChatMessage() {
    const chatInput = document.getElementById('chatInput');
    if (!chatInput || !AppState.currentRide) return;
    
    const message = chatInput.value.trim();
    if (!message) return;
    
    try {
        const messageId = database.ref().child(`chats/${AppState.currentRide.id}/messages`).push().key;
        
        await database.ref(`chats/${AppState.currentRide.id}/messages/${messageId}`).set({
            id: messageId,
            text: message,
            senderId: AppState.currentUser.uid,
            senderName: AppState.userData.name,
            timestamp: Date.now(),
            type: 'text'
        });
        
        // Clear input
        chatInput.value = '';
        
        // Add message to UI
        addChatMessage(message, true);
        
    } catch (error) {
        console.error('Error sending chat message:', error);
        showToast('Error sending message', 'error');
    }
}

// Add chat message to UI
function addChatMessage(message, isSent = false) {
    const chatMessages = document.getElementById('chatMessages');
    if (!chatMessages) return;
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
    
    const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    
    messageDiv.innerHTML = `
        <div>${message}</div>
        <div class="message-time">${time}</div>
    `;
    
    chatMessages.appendChild(messageDiv);
    
    // Scroll to bottom
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Listen to chat messages
function listenToChatMessages(rideId) {
    // Stop previous listener if exists
    const previousIndex = AppState.realtimeListeners.findIndex(l => l.type === 'chat' && l.rideId === rideId);
    if (previousIndex !== -1) {
        AppState.realtimeListeners[previousIndex].listener();
        AppState.realtimeListeners.splice(previousIndex, 1);
    }
    
    const chatRef = database.ref(`chats/${rideId}/messages`).orderByChild('timestamp').limitToLast(50);
    
    const listener = chatRef.on('child_added', (snapshot) => {
        const message = snapshot.val();
        
        if (message && message.senderId !== AppState.currentUser.uid) {
            addChatMessage(message.text, false);
        }
    });
    
    AppState.realtimeListeners.push({
        type: 'chat',
        rideId: rideId,
        listener: () => chatRef.off('child_added', listener)
    });
}

// Load driver info
async function loadDriverInfo(driverId) {
    try {
        const snapshot = await database.ref(`users/${driverId}`).once('value');
        const driver = snapshot.val();
        
        if (driver) {
            // Update driver info in UI
            const driverName = document.getElementById('driverName');
            const driverRating = document.getElementById('driverRating');
            const vehicleDetails = document.getElementById('vehicleDetails');
            
            if (driverName) driverName.textContent = driver.name || 'Driver';
            if (driverRating) driverRating.textContent = driver.rating?.toFixed(1) || '4.8';
            if (vehicleDetails) {
                vehicleDetails.textContent = driver.vehicle ? 
                    `${driver.vehicle.model || 'Car'} - ${driver.vehicle.plate || 'ABC 123'}` : 
                    'Car details not available';
            }
            
            // Load driver avatar
            const driverAvatar = document.getElementById('driverAvatar');
            if (driverAvatar && driver.photoUrl) {
                driverAvatar.innerHTML = `<img src="${driver.photoUrl}" alt="${driver.name}">`;
            }
        }
    } catch (error) {
        console.error('Error loading driver info:', error);
    }
}

// Listen to driver location
function listenToDriverLocation(driverId) {
    // Stop previous listener if exists
    const previousIndex = AppState.realtimeListeners.findIndex(l => l.type === 'driverLocation' && l.driverId === driverId);
    if (previousIndex !== -1) {
        AppState.realtimeListeners[previousIndex].listener();
        AppState.realtimeListeners.splice(previousIndex, 1);
    }
    
    const locationRef = database.ref(`driverLocations/${driverId}`);
    
    const listener = locationRef.on('value', (snapshot) => {
        const location = snapshot.val();
        
        if (location && AppState.map) {
            // Update driver marker
            if (AppState.driverMarker) {
                AppState.driverMarker.setLatLng([location.lat, location.lng]);
            } else {
                AppState.driverMarker = L.marker([location.lat, location.lng], {
                    icon: L.divIcon({
                        className: 'driver-marker',
                        html: '<i class="fas fa-car"></i>',
                        iconSize: [32, 32],
                        iconAnchor: [16, 32]
                    })
                }).addTo(AppState.map).bindPopup('Your Driver');
            }
            
            // Update driver distance display if needed
            updateDriverDistance(location);
        }
    });
    
    AppState.realtimeListeners.push({
        type: 'driverLocation',
        driverId: driverId,
        listener: () => locationRef.off('value', listener)
    });
}

// Update driver distance
function updateDriverDistance(driverLocation) {
    if (!AppState.pickup) return;
    
    const distance = calculateDistance(
        driverLocation.lat, driverLocation.lng,
        AppState.pickup.lat, AppState.pickup.lng
    );
    
    // Update ETA (assuming average speed of 40 km/h)
    const etaMinutes = Math.ceil((distance / 40) * 60);
    
    const etaText = document.getElementById('etaText');
    if (etaText && AppState.currentRide?.status === 'accepted') {
        etaText.textContent = `${etaMinutes} min`;
    }
}

// Load ride history
async function loadRideHistory() {
    if (!AppState.currentUser) return;
    
    showLoading('Loading ride history...');
    
    try {
        const snapshot = await database.ref(`userRides/${AppState.currentUser.uid}`)
            .orderByChild('timestamp')
            .limitToLast(50)
            .once('value');
        
        const userRides = snapshot.val();
        
        if (userRides) {
            // Get ride details for each ride
            const rideIds = Object.keys(userRides);
            const rides = [];
            
            for (const rideId of rideIds) {
                const rideSnapshot = await database.ref(`rides/${rideId}`).once('value');
                const ride = rideSnapshot.val();
                
                if (ride) {
                    rides.push({
                        id: rideId,
                        ...ride
                    });
                }
            }
            
            // Sort by timestamp (newest first)
            rides.sort((a, b) => b.timestamp - a.timestamp);
            
            // Update history list
            updateHistoryList(rides);
        } else {
            updateHistoryList([]);
        }
        
        hideLoading();
        
    } catch (error) {
        console.error('Error loading ride history:', error);
        hideLoading();
        showToast('Error loading ride history', 'error');
    }
}

// Update history list
function updateHistoryList(rides) {
    const historyList = document.getElementById('historyList');
    if (!historyList) return;
    
    historyList.innerHTML = '';
    
    if (rides.length === 0) {
        historyList.innerHTML = `
            <div style="text-align: center; color: var(--text-gray); padding: 40px 20px;">
                <i class="fas fa-history" style="font-size: 40px; margin-bottom: 10px;"></i>
                <div>No ride history</div>
                <div style="font-size: 14px; margin-top: 5px;">Your rides will appear here</div>
            </div>
        `;
        return;
    }
    
    rides.forEach(ride => {
        const rideElement = document.createElement('div');
        rideElement.className = 'history-item';
        
        const date = new Date(ride.timestamp);
        const dateString = date.toLocaleDateString();
        const timeString = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        // Determine icon and color based on service type
        let icon = 'fa-car';
        let color = 'var(--primary-orange)';
        
        switch(ride.serviceType) {
            case 'delivery':
                icon = 'fa-shipping-fast';
                color = 'var(--secondary-blue)';
                break;
            case 'short-delivery':
                icon = 'fa-bicycle';
                color = 'var(--info-blue)';
                break;
            case 'shopping':
                icon = 'fa-shopping-bag';
                color = 'var(--success-green)';
                break;
            case 'truck':
                icon = 'fa-truck';
                color = 'var(--warning-yellow)';
                break;
            case 'emergency':
                icon = 'fa-ambulance';
                color = 'var(--error-red)';
                break;
        }
        
        // Determine status color
        let statusColor = 'var(--text-gray)';
        if (ride.status === 'completed') {
            statusColor = 'var(--success-green)';
        } else if (ride.status === 'cancelled') {
            statusColor = 'var(--error-red)';
        }
        
        rideElement.innerHTML = `
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                <div style="width: 40px; height: 40px; background: ${color}; border-radius: 20px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas ${icon}" style="color: white; font-size: 18px;"></i>
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: 500; margin-bottom: 2px;">${ride.pickup || 'Pickup location'}</div>
                    <div style="font-size: 12px; color: var(--text-gray);">
                        <i class="fas fa-arrow-right" style="margin: 0 5px;"></i>
                        ${ride.destination || 'Destination'}
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="font-weight: 700; color: var(--text-dark);">ZMW ${ride.fare?.toFixed(2) || '0.00'}</div>
                    <div style="font-size: 11px; color: ${statusColor};">${ride.status?.charAt(0).toUpperCase() + ride.status?.slice(1) || 'Unknown'}</div>
                </div>
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--text-light);">
                <div>${dateString} ${timeString}</div>
                <div>${ride.distance ? ride.distance.toFixed(1) + ' km' : ''}</div>
            </div>
        `;
        
        historyList.appendChild(rideElement);
    });
}

// Handle ride completion
async function handleRideCompletion(ride) {
    // Process referral earnings if applicable
    if (ride.referredBy) {
        await processReferralEarnings(ride.id, ride.referredBy);
    }
    
    // Send completion notification
    await sendNotification(
        AppState.currentUser.uid,
        'Ride Completed',
        `Your ride to ${ride.destination} has been completed. Fare: ZMW ${ride.fare?.toFixed(2) || '0.00'}`,
        'ride'
    );
    
    // Reset active ride after a delay
    setTimeout(() => {
        if (AppState.currentRide?.id === ride.id) {
            resetActiveRide();
        }
    }, 5000);
}

// Check for active ride
async function checkActiveRide(uid) {
    try {
        const snapshot = await database.ref('rides')
            .orderByChild('passengerId')
            .equalTo(uid)
            .orderByChild('status')
            .startAt('requested')
            .endAt('started')
            .once('value');
        
        const rides = snapshot.val();
        if (rides) {
            const rideId = Object.keys(rides)[0];
            const ride = { id: rideId, ...rides[rideId] };
            
            AppState.currentRide = ride;
            showRideInfo(ride);
            
            if (ride.driverId) {
                listenToDriverLocation(ride.driverId);
                loadDriverInfo(ride.driverId);
            }
            
            listenToChatMessages(rideId);
            
            return true;
        }
        return false;
    } catch (error) {
        console.error('Error checking active ride:', error);
        return false;
    }
}

// Load scheduled rides
async function loadScheduledRides(uid) {
    try {
        const snapshot = await database.ref('scheduledRides')
            .orderByChild('passengerId')
            .equalTo(uid)
            .orderByChild('status')
            .equalTo('scheduled')
            .once('value');
        
        const scheduledRides = snapshot.val();
        if (scheduledRides) {
            AppState.scheduledRides = Object.values(scheduledRides);
        }
    } catch (error) {
        console.error('Error loading scheduled rides:', error);
    }
}

// ============================================
// INITIALIZATION
// ============================================

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', initializeApp);

// Prevent page refresh
window.addEventListener('beforeunload', (e) => {
    // Don't show warning for regular navigation
    // The app should handle state persistence
});

// Handle visibility change
document.addEventListener('visibilitychange', () => {
    if (!document.hidden && AppState.currentUser) {
        // App became visible again, refresh data
        loadUserData(AppState.currentUser.uid);
    }
});

// Handle online/offline status
window.addEventListener('online', () => {
    showToast('Back online', 'success');
    
    if (AppState.currentUser) {
        // Sync data when coming back online
        loadUserData(AppState.currentUser.uid);
    }
});

window.addEventListener('offline', () => {
    showToast('You are offline', 'warning');
});
    </script>
</body>
</html>
