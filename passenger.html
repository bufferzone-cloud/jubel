<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jubel - Passenger</title>
    <!-- OpenLayers CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.3.0/ol.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* All existing CSS styles remain unchanged */
        :root {
            --primary-orange: #FF6B35;
            --primary-red: #E74C3C;
            --primary-gradient: linear-gradient(135deg, #FF6B35, #E74C3C);
            --secondary-orange: #E55A28;
            --secondary-red: #C0392B;
            --light-orange: #FFE8E0;
            --light-red: #FADBD8;
            --white: #FFFFFF;
            --light-gray: #F5F5F5;
            --dark-gray: #333333;
            --medium-gray: #777777;
            --success-green: #2ecc71;
            --warning-yellow: #f39c12;
            --info-blue: #3498db;
            --error-red: #e74c3c;
            --border-color: #E8E8E8;
            --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 4px 15px rgba(0, 0, 0, 0.15);
            --shadow-heavy: 0 6px 20px rgba(0, 0, 0, 0.2);
            --app-padding: 10px;
            --element-radius: 6px;
            --transition-speed: 0.3s;
            --premium-gold: #FFD700;
            --premium-purple: #8A2BE2;
            --economy-green: #2ecc71;
            --emergency-red: #FF0000;
            --ambulance-red: #FF0000;
            --ambulance-white: #FFFFFF;
            --fire-truck-red: #FF0000;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--white);
            color: var(--dark-gray);
            max-width: 100%;
            overflow-x: hidden;
            height: 100vh;
            font-size: 13px;
        }
        
        /* Main Map */
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        /* OpenLayers specific styles */
        .ol-zoom {
            top: 10px;
            left: auto;
            right: 10px;
        }
        
        .ol-rotate {
            top: 70px;
            right: 10px;
        }
        
        .ol-attribution {
            display: none;
        }
        
        .ol-control button {
            background-color: var(--primary-orange) !important;
            color: var(--white) !important;
            border-radius: 50% !important;
            width: 36px !important;
            height: 36px !important;
            font-size: 16px !important;
        }
        
        .ol-control button:hover {
            background-color: var(--secondary-orange) !important;
        }
        
        /* Custom markers */
        .driver-marker {
            width: 32px;
            height: 32px;
            background: var(--primary-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            border: 2px solid white;
        }
        
        .pickup-marker {
            width: 22px;
            height: 22px;
            background: var(--primary-orange);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            border: 2px solid white;
        }
        
        .destination-marker {
            width: 22px;
            height: 22px;
            background: var(--primary-red);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            border: 2px solid white;
        }
        
        .current-location-marker {
            width: 18px;
            height: 18px;
            background: var(--info-blue);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            border: 2px solid white;
        }
        
        .premium-marker {
            width: 24px;
            height: 24px;
            background: var(--premium-gold);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            border: 2px solid var(--premium-purple);
        }
        
        .economy-marker {
            width: 20px;
            height: 20px;
            background: var(--economy-green);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            border: 2px solid white;
        }
        
        .emergency-marker {
            width: 26px;
            height: 26px;
            background: var(--emergency-red);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            border: 2px solid white;
            animation: emergency-pulse 1s infinite;
        }
        
        .ambulance-marker {
            width: 28px;
            height: 28px;
            background: linear-gradient(45deg, var(--ambulance-red) 50%, var(--ambulance-white) 50%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: var(--ambulance-red);
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            border: 2px solid var(--ambulance-red);
        }
        
        .fire-truck-marker {
            width: 28px;
            height: 28px;
            background: var(--fire-truck-red);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            border: 2px solid white;
        }
        
        .truck-marker {
            width: 24px;
            height: 24px;
            background: var(--warning-yellow);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            border: 2px solid white;
        }
        
        @keyframes emergency-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        /* Vehicle type badges */
        .vehicle-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.6rem;
            font-weight: 700;
            margin-left: 4px;
        }
        
        .badge-premium {
            background: linear-gradient(45deg, var(--premium-gold), var(--premium-purple));
            color: white;
        }
        
        .badge-economy {
            background: var(--economy-green);
            color: white;
        }
        
        .badge-emergency {
            background: var(--emergency-red);
            color: white;
        }
        
        .badge-ambulance {
            background: linear-gradient(45deg, var(--ambulance-red), var(--ambulance-white));
            color: var(--ambulance-red);
            border: 1px solid var(--ambulance-red);
        }
        
        .badge-fire-truck {
            background: var(--fire-truck-red);
            color: white;
        }
        
        .badge-truck {
            background: var(--warning-yellow);
            color: white;
        }
        
        .badge-standard {
            background: var(--primary-orange);
            color: white;
        }
        
        /* Premium ride styling */
        .vehicle-option.premium {
            border: 2px solid var(--premium-gold);
            background: linear-gradient(135deg, #FFF9E6, #FFE680);
        }
        
        .vehicle-option.premium.selected {
            border-color: var(--premium-purple);
            background: linear-gradient(135deg, var(--premium-gold), var(--premium-purple));
            color: white;
        }
        
        .vehicle-option.premium .vehicle-icon {
            color: var(--premium-purple);
        }
        
        .vehicle-option.premium.selected .vehicle-icon {
            color: white;
        }
        
        /* Economy ride styling */
        .vehicle-option.economy {
            border: 2px solid var(--economy-green);
            background: linear-gradient(135deg, #E6F7E9, #A5D6A7);
        }
        
        .vehicle-option.economy.selected {
            border-color: var(--success-green);
            background: linear-gradient(135deg, var(--economy-green), var(--success-green));
            color: white;
        }
        
        /* Emergency ride styling */
        .vehicle-option.emergency {
            border: 2px solid var(--emergency-red);
            background: linear-gradient(135deg, #FFEBEE, #FFCDD2);
            animation: emergency-pulse 2s infinite;
        }
        
        .vehicle-option.emergency.selected {
            background: var(--emergency-red);
            color: white;
        }
        
        /* Ambulance styling */
        .vehicle-option.ambulance {
            border: 2px solid var(--ambulance-red);
            background: linear-gradient(45deg, #FFEBEE 50%, #FFFFFF 50%);
        }
        
        .vehicle-option.ambulance.selected {
            background: linear-gradient(45deg, var(--ambulance-red) 50%, var(--ambulance-white) 50%);
            color: var(--ambulance-red);
        }
        
        /* Fire truck styling */
        .vehicle-option.fire-truck {
            border: 2px solid var(--fire-truck-red);
            background: linear-gradient(135deg, #FFEBEE, #FFCDD2);
        }
        
        .vehicle-option.fire-truck.selected {
            background: var(--fire-truck-red);
            color: white;
        }
        
        /* Truck styling */
        .vehicle-option.truck {
            border: 2px solid var(--warning-yellow);
            background: linear-gradient(135deg, #FFF3E0, #FFE0B2);
        }
        
        .vehicle-option.truck.selected {
            background: var(--warning-yellow);
            color: white;
        }
        
        /* Rest of your existing CSS styles remain unchanged */
        .floating-balance {
            position: fixed;
            top: 10px;
            right: 10px;
            background: var(--white);
            padding: 6px 10px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 700;
            color: var(--dark-gray);
            border: 2px solid var(--primary-orange);
            font-size: 0.75rem;
        }
        
        .balance-amount {
            color: var(--primary-orange);
            font-size: 0.8rem;
        }
        
        .passenger-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            border-radius: 15px 15px 0 0;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
            z-index: 100;
            padding: var(--app-padding);
            transform: translateY(0);
            transition: transform var(--transition-speed) ease;
            max-height: 45vh;
            overflow-y: auto;
        }
        
        .passenger-panel.collapsed {
            transform: translateY(calc(100% - 40px));
        }
        
        .panel-collapse-handle {
            width: 35px;
            height: 3px;
            background: var(--border-color);
            border-radius: 2px;
            margin: 0 auto 8px;
            cursor: pointer;
        }
        
        .nav-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            padding: 6px 3px;
            border-radius: var(--element-radius);
            background: var(--light-gray);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            border: none;
            font-size: 0.6rem;
            font-weight: 600;
        }
        
        .nav-btn.active {
            background: var(--primary-gradient);
            color: var(--white);
        }
        
        .nav-btn i {
            font-size: 0.8rem;
        }
        
        /* Schedule Ride Button */
        .schedule-ride-btn {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--primary-orange);
            color: var(--white);
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .schedule-ride-options {
            display: none;
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            margin-top: 5px;
            overflow: hidden;
            box-shadow: var(--shadow-medium);
        }
        
        .schedule-ride-options.active {
            display: block;
        }
        
        .schedule-option {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all var(--transition-speed) ease;
        }
        
        .schedule-option:hover {
            background: var(--light-orange);
        }
        
        .schedule-option:last-child {
            border-bottom: none;
        }
        
        .schedule-option-icon {
            width: 20px;
            text-align: center;
            font-size: 0.9rem;
        }
        
        .schedule-option-text {
            flex: 1;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        /* Schedule Ride Forms */
        .schedule-ride-form {
            display: none;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
        }
        
        .schedule-ride-form.active {
            display: flex;
        }
        
        /* Schedule Ride - Ride Now Form */
        .schedule-ride-now-form {
            display: none;
        }
        
        .schedule-ride-now-form.active {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        /* Schedule Ride - Delivery Form */
        .schedule-delivery-form {
            display: none;
        }
        
        .schedule-delivery-form.active {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        /* Schedule Ride - Schedule for Someone Form */
        .schedule-for-someone-form {
            display: none;
        }
        
        .schedule-for-someone-form.active {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        /* Schedule Timer Display */
        .schedule-timer-display {
            background: var(--primary-gradient);
            color: var(--white);
            padding: 10px;
            border-radius: var(--element-radius);
            text-align: center;
            margin: 8px 0;
        }
        
        .schedule-timer-time {
            font-size: 1.5rem;
            font-weight: 800;
            margin: 4px 0;
        }
        
        .schedule-timer-controls {
            display: flex;
            gap: 6px;
            margin-top: 8px;
        }
        
        .schedule-timer-control {
            flex: 1;
            padding: 6px;
            border: none;
            border-radius: var(--element-radius);
            background: var(--white);
            color: var(--primary-orange);
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
        }
        
        /* Multi-Stop Ride Form */
        .multi-stop-form {
            display: none;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
        }
        
        .multi-stop-form.active {
            display: block;
        }
        
        .multi-stop-item {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 6px;
            padding: 6px;
            background: var(--white);
            border-radius: var(--element-radius);
        }
        
        .multi-stop-number {
            width: 20px;
            height: 20px;
            background: var(--primary-orange);
            color: var(--white);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            font-weight: 700;
        }
        
        .multi-stop-input {
            flex: 1;
            padding: 6px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 0.7rem;
        }
        
        .add-stop-btn {
            width: 100%;
            padding: 6px;
            border: 1px dashed var(--border-color);
            border-radius: var(--element-radius);
            background: var(--white);
            cursor: pointer;
            font-size: 0.7rem;
            color: var(--primary-orange);
            margin-top: 6px;
        }
        
        /* More Options Button */
        .more-options-btn {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--primary-orange);
            color: var(--white);
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .more-options-dropdown {
            display: none;
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            margin-top: 5px;
            overflow: hidden;
            box-shadow: var(--shadow-medium);
        }
        
        .more-options-dropdown.active {
            display: block;
        }
        
        .more-option-item {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all var(--transition-speed) ease;
        }
        
        .more-option-item:hover {
            background: var(--light-orange);
        }
        
        .more-option-item:last-child {
            border-bottom: none;
        }
        
        .more-option-icon {
            width: 20px;
            text-align: center;
            font-size: 0.9rem;
        }
        
        .more-option-text {
            flex: 1;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        /* Order for Someone Else Form */
        .order-for-someone-form {
            display: none;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
        }
        
        .order-for-someone-form.active {
            display: flex;
        }
        
        /* Express Delivery Form */
        .express-delivery-form {
            display: none;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
        }
        
        .express-delivery-form.active {
            display: flex;
        }
        
        /* SOS Setup Form */
        .sos-setup-form {
            display: none;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
        }
        
        .sos-setup-form.active {
            display: flex;
        }
        
        /* SOS Button */
        .sos-button {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--error-red);
            color: var(--white);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 700;
            box-shadow: var(--shadow-heavy);
            z-index: 150;
            cursor: pointer;
            animation: sos-pulse 2s infinite;
            display: none;
        }
        
        @keyframes sos-pulse {
            0% {
                transform: translateX(-50%) scale(1);
                box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7);
            }
            70% {
                transform: translateX(-50%) scale(1.05);
                box-shadow: 0 0 0 10px rgba(231, 76, 60, 0);
            }
            100% {
                transform: translateX(-50%) scale(1);
                box-shadow: 0 0 0 0 rgba(231, 76, 60, 0);
            }
        }
        
        /* Delivery Fee Display */
        .delivery-fee-display {
            background: var(--primary-gradient);
            color: var(--white);
            padding: 10px;
            border-radius: var(--element-radius);
            text-align: center;
            margin: 8px 0;
        }
        
        .delivery-fee-amount {
            font-size: 1.2rem;
            font-weight: 800;
            margin: 4px 0;
        }
        
        .delivery-eta-display {
            font-size: 0.8rem;
            font-weight: 600;
            opacity: 0.9;
        }
        
        /* All other existing CSS styles remain unchanged */
        .ride-request-form {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .location-input {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--white);
            position: relative;
        }
        
        .location-input i {
            color: var(--primary-orange);
        }
        
        .location-input input {
            border: none;
            outline: none;
            width: 100%;
            font-size: 0.8rem;
        }
        
        .vehicle-selection {
            display: flex;
            gap: 6px;
            margin: 8px 0;
            flex-wrap: wrap;
        }
        
        .vehicle-option {
            flex: 1;
            min-width: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 4px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .vehicle-option.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .vehicle-icon {
            font-size: 1rem;
            color: var(--medium-gray);
        }
        
        .vehicle-option.selected .vehicle-icon {
            color: var(--primary-orange);
        }
        
        .vehicle-name {
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .vehicle-price {
            font-size: 0.65rem;
            color: var(--medium-gray);
        }
        
        .promo-section {
            margin-top: 8px;
            padding: 8px;
            border: 1px dashed var(--border-color);
            border-radius: var(--element-radius);
            display: none;
        }
        
        .promo-section.active {
            display: block;
        }
        
        .promo-input {
            display: flex;
            gap: 6px;
        }
        
        .promo-input input {
            flex: 1;
            padding: 6px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 0.75rem;
        }
        
        .btn-promo {
            background: var(--primary-orange);
            color: var(--white);
            border: none;
            border-radius: var(--element-radius);
            padding: 6px 10px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .promo-toggle {
            width: 100%;
            padding: 6px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .fare-display {
            background: var(--primary-gradient);
            color: var(--white);
            padding: 10px;
            border-radius: var(--element-radius);
            text-align: center;
            margin: 8px 0;
            box-shadow: var(--shadow-medium);
        }
        
        .fare-amount {
            font-size: 1.5rem;
            font-weight: 800;
            margin: 4px 0;
        }
        
        .eta-display {
            font-size: 0.9rem;
            font-weight: 600;
            opacity: 0.9;
        }
        
        .request-ride-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: var(--element-radius);
            background: var(--primary-gradient);
            color: var(--white);
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            margin-top: 8px;
            box-shadow: var(--shadow-medium);
        }
        
        .request-ride-btn:disabled {
            background: var(--medium-gray);
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .ride-info-panel {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 10px;
            box-shadow: var(--shadow-medium);
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            display: none;
        }
        
        .driver-info {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .driver-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            color: var(--white);
            font-weight: 700;
        }
        
        .driver-details h2 {
            font-size: 0.85rem;
            margin-bottom: 2px;
        }
        
        .driver-details p {
            color: var(--medium-gray);
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 3px;
            font-size: 0.7rem;
        }
        
        .trip-details {
            margin-bottom: 10px;
        }
        
        .location-row {
            display: flex;
            align-items: flex-start;
            gap: 5px;
            margin-bottom: 8px;
        }
        
        .location-icon {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            flex-shrink: 0;
        }
        
        .pickup-icon {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .destination-icon {
            background: var(--primary-red);
            color: var(--white);
        }
        
        .location-text {
            flex: 1;
        }
        
        .location-text h4 {
            font-size: 0.8rem;
            margin-bottom: 2px;
        }
        
        .location-text p {
            color: var(--medium-gray);
            font-size: 0.7rem;
        }
        
        .fare-details {
            background: var(--light-orange);
            padding: 8px;
            border-radius: var(--element-radius);
            margin-bottom: 10px;
        }
        
        .fare-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 0.7rem;
        }
        
        .fare-row.total {
            font-weight: 700;
            font-size: 0.8rem;
            border-top: 1px solid var(--border-color);
            padding-top: 5px;
            margin-top: 5px;
        }
        
        .ride-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }
        
        .btn {
            padding: 8px;
            border: none;
            border-radius: var(--element-radius);
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .btn-cancel {
            background: var(--error-red);
            color: var(--white);
        }
        
        .btn-contact {
            background: var(--info-blue);
            color: var(--white);
        }
        
        .screen-content {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 50px;
            background: var(--white);
            z-index: 90;
            padding: var(--app-padding);
            overflow-y: auto;
            display: none;
        }
        
        .screen-content.active {
            display: block;
        }
        
        .screen-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .back-button {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            font-size: 0.9rem;
        }
        
        .screen-title {
            font-size: 1rem;
            font-weight: 700;
        }
        
        .account-section, .history-section, .payments-section {
            margin-bottom: 15px;
        }
        
        .section-title {
            font-size: 0.85rem;
            margin-bottom: 8px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .input-group {
            margin-bottom: 8px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 600;
            font-size: 0.75rem;
        }
        
        .input-field {
            width: 100%;
            padding: 8px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 0.75rem;
            transition: all var(--transition-speed) ease;
        }
        
        .input-field:focus {
            outline: none;
            border-color: var(--primary-orange);
        }
        
        .wallet-balance {
            background: var(--primary-gradient);
            color: var(--white);
            padding: 10px;
            border-radius: var(--element-radius);
            text-align: center;
            margin-bottom: 10px;
        }
        
        .balance-label {
            font-size: 0.7rem;
            margin-bottom: 2px;
        }
        
        .balance-amount-large {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 5px;
        }
        
        .wallet-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin-bottom: 10px;
        }
        
        .btn-wallet {
            background: var(--white);
            color: var(--primary-orange);
            border: 2px solid var(--primary-orange);
            padding: 6px;
            font-size: 0.7rem;
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .btn-wallet:hover {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .payment-methods {
            margin-top: 10px;
        }
        
        .payment-method {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            margin-bottom: 6px;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .payment-method.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .payment-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: var(--medium-gray);
        }
        
        .payment-details {
            flex: 1;
        }
        
        .payment-name {
            font-weight: 600;
            font-size: 0.75rem;
        }
        
        .payment-info {
            color: var(--medium-gray);
            font-size: 0.65rem;
        }
        
        .history-item {
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            font-size: 0.7rem;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-item:hover {
            background: var(--light-orange);
        }
        
        .history-locations {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .history-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.65rem;
            color: var(--medium-gray);
        }
        
        .status-badge {
            padding: 2px 5px;
            border-radius: 10px;
            font-size: 0.6rem;
            font-weight: 700;
        }
        
        .status-completed {
            background: #e6f7e9;
            color: #2e7d32;
        }
        
        .status-cancelled {
            background: #ffebee;
            color: #c62828;
        }
        
        .status-requested {
            background: #fff3e0;
            color: #ef6c00;
        }
        
        .status-accepted {
            background: #e3f2fd;
            color: #1565c0;
        }
        
        .notification {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-gradient);
            color: var(--white);
            padding: 8px 14px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 300;
            display: none;
            font-weight: 600;
            text-align: center;
            font-size: 0.75rem;
            max-width: 80%;
        }
        
        .ride-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: var(--white);
            padding: 6px 10px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 700;
            color: var(--dark-gray);
            border: 2px solid var(--border-color);
            font-size: 0.75rem;
            display: none;
        }
        
        .status-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: var(--medium-gray);
        }
        
        .status-dot.searching {
            background: var(--warning-yellow);
            animation: pulse 2s infinite;
        }
        
        .status-dot.arriving {
            background: var(--info-blue);
            animation: pulse 1.5s infinite;
        }
        
        .status-dot.riding {
            background: var(--success-green);
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .estimated-time {
            position: fixed;
            top: 50px;
            right: 10px;
            background: var(--white);
            padding: 6px 10px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 700;
            color: var(--dark-gray);
            border: 2px solid var(--border-color);
            font-size: 0.75rem;
            display: none;
        }
        
        .saved-locations {
            display: flex;
            gap: 6px;
            margin: 8px 0;
        }
        
        .saved-location-btn {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
            cursor: pointer;
            font-size: 0.65rem;
            transition: all var(--transition-speed) ease;
        }
        
        .saved-location-btn:hover {
            background: var(--light-orange);
            border-color: var(--primary-orange);
        }
        
        .suggestion-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-medium);
            z-index: 200;
            max-height: 180px;
            overflow-y: auto;
            display: none;
        }
        
        .suggestion-item {
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .suggestion-item:hover {
            background: var(--light-orange);
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
        
        .suggestion-icon {
            font-size: 0.9rem;
            width: 18px;
            text-align: center;
        }
        
        .suggestion-details {
            flex: 1;
        }
        
        .suggestion-name {
            font-weight: 600;
            font-size: 0.75rem;
        }
        
        .suggestion-address {
            color: var(--medium-gray);
            font-size: 0.65rem;
        }
        
        .suggestion-distance {
            color: var(--medium-gray);
            font-size: 0.55rem;
            margin-top: 2px;
        }
        
        .loading-text {
            text-align: center;
            padding: 15px;
            color: var(--medium-gray);
        }
        
        .no-places {
            text-align: center;
            padding: 15px;
            color: var(--medium-gray);
        }
        
        .filter-options {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .filter-options select, .filter-options input {
            flex: 1;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .stat-card {
            background: var(--light-gray);
            padding: 10px;
            border-radius: var(--element-radius);
            text-align: center;
        }
        
        .stat-number {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        .stat-label {
            font-size: 0.65rem;
            color: var(--medium-gray);
        }
        
        .referral-section {
            background: var(--light-orange);
            padding: 12px;
            border-radius: var(--element-radius);
            margin-bottom: 12px;
        }
        
        .referral-code {
            background: var(--white);
            padding: 8px;
            border-radius: var(--element-radius);
            text-align: center;
            margin: 8px 0;
        }
        
        .code {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        .description {
            font-size: 0.65rem;
            color: var(--medium-gray);
            margin-top: 4px;
        }
        
        .contact-section {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .contact-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: var(--element-radius);
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .contact-btn.whatsapp {
            background: #25D366;
            color: white;
        }
        
        .contact-btn.phone {
            background: var(--info-blue);
            color: white;
        }
        
        .rating-stars {
            display: flex;
            gap: 4px;
            margin-top: 4px;
        }
        
        .star {
            font-size: 1.3rem;
            color: var(--light-gray);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .star.active {
            color: var(--warning-yellow);
        }
        
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
        }
        
        .popup-overlay.hidden {
            display: none;
        }
        
        .popup-form {
            background: var(--white);
            border-radius: var(--element-radius);
            width: 100%;
            max-width: 450px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: var(--shadow-heavy);
        }
        
        .large-popup {
            max-width: 700px;
        }
        
        .popup-header {
            display: flex;
            align-items: center;
            justify-content: between;
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .popup-title {
            font-size: 1.1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .close-popup {
            background: none;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            color: var(--medium-gray);
        }
        
        .popup-content {
            padding: 12px;
        }
        
        .popup-map-container {
            height: 180px;
            border-radius: var(--element-radius);
            overflow: hidden;
            margin-bottom: 12px;
        }
        
        .popup-details {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .detail-row:last-child {
            border-bottom: none;
        }
        
        .detail-label {
            font-weight: 600;
            font-size: 0.75rem;
        }
        
        .detail-value {
            font-size: 0.75rem;
            color: var(--medium-gray);
        }
        
        .driver-details-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }
        
        .popup-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 12px;
        }
        
        /* Payment Selection Popup Styles */
        .payment-selection-popup {
            max-width: 350px;
        }
        
        .payment-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            margin-bottom: 8px;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .payment-option.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .payment-option-icon {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            color: var(--medium-gray);
        }
        
        .payment-option.selected .payment-option-icon {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .payment-option-details {
            flex: 1;
        }
        
        .payment-option-name {
            font-weight: 600;
            font-size: 0.85rem;
        }
        
        .payment-option-description {
            color: var(--medium-gray);
            font-size: 0.7rem;
        }
        
        .payment-option-balance {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--primary-orange);
        }
        
        .confirm-payment-btn {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: var(--element-radius);
            background: var(--primary-gradient);
            color: var(--white);
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            margin-top: 12px;
        }
        
        .confirm-payment-btn:disabled {
            background: var(--medium-gray);
            cursor: not-allowed;
        }
        
        .insufficient-balance {
            color: var(--error-red);
            font-size: 0.75rem;
            margin-top: 4px;
            display: none;
        }
        
        /* Package Delivery Form Styles */
        .package-form {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
            display: none;
        }
        
        .package-form.active {
            display: block;
        }
        
        .form-row {
            display: flex;
            gap: 6px;
            margin-bottom: 6px;
        }
        
        .form-group {
            flex: 1;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 3px;
            font-weight: 600;
            font-size: 0.7rem;
        }
        
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 6px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 0.7rem;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 50px;
        }
        
        .package-toggle {
            width: 100%;
            padding: 6px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .driver-details-card {
            background: var(--light-orange);
            padding: 10px;
            border-radius: var(--element-radius);
            margin-bottom: 10px;
            border: 1px solid var(--primary-orange);
        }
        
        .driver-details-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 6px;
        }
        
        .driver-details-header h3 {
            font-size: 0.85rem;
            color: var(--primary-orange);
        }
        
        .driver-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }
        
        .driver-detail-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .driver-detail-label {
            font-size: 0.65rem;
            color: var(--medium-gray);
            font-weight: 600;
        }
        
        .driver-detail-value {
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .driver-vehicle-details {
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px dashed var(--border-color);
        }
        
        .vehicle-detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
            font-size: 0.65rem;
        }
        
        .vehicle-detail-label {
            color: var(--medium-gray);
        }
        
        .vehicle-detail-value {
            font-weight: 600;
        }
        
        /* Enhanced History Item Styles */
        .history-item-type {
            font-size: 0.65rem;
            font-weight: 600;
            padding: 2px 5px;
            border-radius: 8px;
            margin-bottom: 4px;
            display: inline-block;
        }
        
        .history-item-type.ride {
            background: var(--light-orange);
            color: var(--primary-orange);
        }
        
        .history-item-type.delivery {
            background: var(--light-red);
            color: var(--primary-red);
        }
        
        .history-package-details {
            background: var(--light-gray);
            padding: 6px;
            border-radius: var(--element-radius);
            margin: 6px 0;
            font-size: 0.65rem;
        }
        
        .package-detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
        }
        
        .package-detail-label {
            font-weight: 600;
            color: var(--medium-gray);
        }
        
        .package-detail-value {
            color: var(--dark-gray);
        }
        
        .history-driver-info {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px dashed var(--border-color);
        }
        
        .history-driver-avatar {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            color: var(--white);
            font-weight: 700;
        }
        
        .history-driver-details {
            flex: 1;
        }
        
        .history-driver-name {
            font-size: 0.65rem;
            font-weight: 600;
        }
        
        .history-driver-rating {
            font-size: 0.55rem;
            color: var(--medium-gray);
        }
        
        .history-fare {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        /* Driver Search Animation */
        .searching-animation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 200;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .searching-pulse {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(255, 107, 53, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse-ring 2s infinite;
            position: relative;
        }
        
        .searching-pulse-inner {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }
        
        .searching-text {
            margin-top: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 12px;
            border-radius: var(--element-radius);
            font-weight: 600;
            color: var(--primary-orange);
            box-shadow: var(--shadow-medium);
        }
        
        @keyframes pulse-ring {
            0% {
                transform: scale(0.8);
                opacity: 1;
            }
            80%, 100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }
        
        /* Enhanced Ride History Popup Styles */
        .history-chat-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }
        
        .history-chat-messages {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 10px;
            padding: 10px;
            background: var(--light-gray);
            border-radius: var(--element-radius);
        }
        
        .history-chat-message {
            padding: 8px;
            margin-bottom: 8px;
            border-radius: var(--element-radius);
            max-width: 80%;
        }
        
        .history-chat-message.passenger {
            background: var(--primary-orange);
            color: white;
            margin-left: auto;
        }
        
        .history-chat-message.driver {
            background: var(--white);
            border: 1px solid var(--border-color);
            margin-right: auto;
        }
        
        .receipt-button {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--primary-orange);
            border-radius: var(--element-radius);
            background: var(--white);
            color: var(--primary-orange);
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }
        
        /* Scheduled Ride Item Styles */
        .scheduled-ride-item {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            background: var(--light-orange);
            border-radius: var(--element-radius);
            margin-bottom: 8px;
        }
        
        .scheduled-ride-time {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--primary-orange);
            margin-bottom: 5px;
        }
        
        .scheduled-ride-details {
            font-size: 0.75rem;
            margin-bottom: 8px;
        }
        
        .scheduled-ride-actions {
            display: flex;
            gap: 6px;
        }
        
        .scheduled-action-btn {
            flex: 1;
            padding: 6px;
            border: none;
            border-radius: var(--element-radius);
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
        }
        
        .scheduled-edit-btn {
            background: var(--info-blue);
            color: white;
        }
        
        .scheduled-cancel-btn {
            background: var(--error-red);
            color: white;
        }
        
        @media (max-width: 480px) {
            .floating-balance, .ride-status {
                padding: 5px 7px;
                font-size: 0.65rem;
            }
            
            .passenger-panel {
                padding: 8px;
            }
            
            .nav-buttons {
                gap: 3px;
            }
            
            .nav-btn {
                padding: 5px 2px;
                font-size: 0.55rem;
            }
            
            .vehicle-selection {
                flex-wrap: wrap;
            }
            
            .vehicle-option {
                min-width: 70px;
            }
        }
    </style>
</head>
<body>
    <!-- Main App -->
    <div id="mainApp">
        <!-- Main Map -->
        <div id="map"></div>
        
        <!-- Floating Balance (Only on Home Screen) -->
        <div class="floating-balance home-only">
            <i class="fas fa-wallet"></i>
            <span>Balance: <span class="balance-amount" id="walletBalance">K0.00</span></span>
        </div>
        
        <!-- Ride Status (Only on Home Screen) -->
        <div class="ride-status home-only" id="rideStatus">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Searching for driver</span>
        </div>
        
        <!-- Estimated Time (Only on Home Screen) -->
        <div class="estimated-time home-only" id="estimatedTime">
            <i class="fas fa-clock"></i>
            <span id="timeText">5 min</span>
        </div>
        
        <!-- SOS Button -->
        <div class="sos-button" id="sosButton">
            SOS
        </div>
        
        <!-- Driver Search Animation -->
        <div class="searching-animation" id="searchingAnimation">
            <div class="searching-pulse">
                <div class="searching-pulse-inner">
                    <i class="fas fa-car"></i>
                </div>
            </div>
            <div class="searching-text">Searching for driver</div>
        </div>
        
        <!-- Passenger Panel -->
        <div class="passenger-panel" id="passengerPanel">
            <div class="panel-collapse-handle" id="panelCollapseHandle"></div>
            
            <div class="nav-buttons">
                <button class="nav-btn active" data-screen="home">
                    <i class="fas fa-home"></i>
                    <span>Home</span>
                </button>
                <button class="nav-btn" data-screen="account">
                    <i class="fas fa-user"></i>
                    <span>Account</span>
                </button>
                <button class="nav-btn" data-screen="history">
                    <i class="fas fa-history"></i>
                    <span>History</span>
                </button>
                <button class="nav-btn" data-screen="payments">
                    <i class="fas fa-credit-card"></i>
                    <span>Payments</span>
                </button>
            </div>
            
            <!-- Schedule Ride Button -->
            <button class="schedule-ride-btn" id="scheduleRideBtn">
                <i class="fas fa-clock"></i>
                Schedule Ride
            </button>
            
            <!-- Schedule Ride Options -->
            <div class="schedule-ride-options" id="scheduleRideOptions">
                <div class="schedule-option" data-option="ride-now">
                    <div class="schedule-option-icon">
                        <i class="fas fa-car"></i>
                    </div>
                    <div class="schedule-option-text">Ride Now</div>
                </div>
                <div class="schedule-option" data-option="delivery">
                    <div class="schedule-option-icon">
                        <i class="fas fa-box"></i>
                    </div>
                    <div class="schedule-option-text">Delivery</div>
                </div>
                <div class="schedule-option" data-option="schedule-for-someone">
                    <div class="schedule-option-icon">
                        <i class="fas fa-user-friends"></i>
                    </div>
                    <div class="schedule-option-text">Schedule for Someone</div>
                </div>
            </div>
            
            <!-- Multi-Stop Form -->
            <div class="multi-stop-form" id="multiStopForm">
                <h4 class="section-title">Multi-Stop Ride</h4>
                <div id="multiStopContainer">
                    <div class="multi-stop-item">
                        <div class="multi-stop-number">1</div>
                        <input type="text" class="multi-stop-input" placeholder="Pickup location">
                        <div class="suggestion-list multi-stop-suggestions"></div>
                    </div>
                </div>
                <button class="add-stop-btn" id="addStopBtn">
                    <i class="fas fa-plus"></i> Add Stop
                </button>
            </div>
            
            <!-- More Options Button -->
            <button class="more-options-btn" id="moreOptionsBtn">
                <i class="fas fa-ellipsis-h"></i>
                More Options
            </button>
            
            <!-- More Options Dropdown -->
            <div class="more-options-dropdown" id="moreOptionsDropdown">
                <div class="more-option-item" data-option="order-for-someone">
                    <div class="more-option-icon">
                        <i class="fas fa-user-friends"></i>
                    </div>
                    <div class="more-option-text">Order for Someone Else</div>
                </div>
                <div class="more-option-item" data-option="express-delivery">
                    <div class="more-option-icon">
                        <i class="fas fa-shipping-fast"></i>
                    </div>
                    <div class="more-option-text">Express Delivery</div>
                </div>
                <div class="more-option-item" data-option="multi-stop">
                    <div class="more-option-icon">
                        <i class="fas fa-map-marker-alt"></i>
                    </div>
                    <div class="more-option-text">Multi-Stop Ride</div>
                </div>
                <div class="more-option-item" data-option="sos-setup">
                    <div class="more-option-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="more-option-text">SOS Setup</div>
                </div>
            </div>
            
            <!-- Home Screen Content -->
            <div id="homeScreenContent">
                <!-- Schedule Ride - Ride Now Form -->
                <div class="schedule-ride-now-form" id="scheduleRideNowForm">
                    <h4 class="section-title">Schedule Ride - Ride Now</h4>
                    
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="schedulePickupLocation" placeholder="Pickup location">
                        <div class="suggestion-list" id="schedulePickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="scheduleDestinationLocation" placeholder="Destination">
                        <div class="suggestion-list" id="scheduleDestinationSuggestions"></div>
                    </div>
                    
                    <div class="input-group">
                        <label for="scheduleTime">Schedule Time</label>
                        <input type="datetime-local" id="scheduleTime" class="input-field">
                    </div>
                    
                    <div class="vehicle-selection">
                        <div class="vehicle-option selected" data-type="car">
                            <i class="fas fa-car vehicle-icon"></i>
                            <span class="vehicle-name">Standard</span>
                            <span class="vehicle-price">Clean Cars</span>
                        </div>
                        <div class="vehicle-option premium" data-type="premium">
                            <i class="fas fa-crown vehicle-icon"></i>
                            <span class="vehicle-name">Premium</span>
                            <span class="vehicle-price">Luxury Cars</span>
                        </div>
                        <div class="vehicle-option economy" data-type="economy">
                            <i class="fas fa-car-side vehicle-icon"></i>
                            <span class="vehicle-name">Economy</span>
                            <span class="vehicle-price">Budget Cars</span>
                        </div>
                    </div>
                    
                    <div class="fare-display">
                        <p>Estimated Fare</p>
                        <div class="fare-amount" id="scheduleEstimatedFare">K0.00</div>
                        <p class="eta-display" id="scheduleEtaDisplay">ETA: -- min</p>
                    </div>
                    
                    <button class="request-ride-btn" id="scheduleRideNowBtn">Schedule Ride</button>
                    <button class="btn btn-cancel" id="cancelScheduleRideNowBtn">Cancel</button>
                </div>
                
                <!-- Schedule Ride - Delivery Form -->
                <div class="schedule-delivery-form" id="scheduleDeliveryForm">
                    <h4 class="section-title">Schedule Ride - Delivery</h4>
                    
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="scheduleDeliveryPickup" placeholder="Pickup location">
                        <div class="suggestion-list" id="scheduleDeliveryPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="scheduleDeliveryDestination" placeholder="Delivery destination">
                        <div class="suggestion-list" id="scheduleDeliveryDestinationSuggestions"></div>
                    </div>
                    
                    <div class="input-group">
                        <label for="scheduleDeliveryTime">Schedule Time</label>
                        <input type="datetime-local" id="scheduleDeliveryTime" class="input-field">
                    </div>
                    
                    <div class="input-group">
                        <label for="schedulePackageDetails">Package Details</label>
                        <textarea id="schedulePackageDetails" class="input-field" placeholder="Package description, size, weight, etc."></textarea>
                    </div>
                    
                    <div class="vehicle-selection">
                        <div class="vehicle-option selected" data-type="bike">
                            <i class="fas fa-motorcycle vehicle-icon"></i>
                            <span class="vehicle-name">Bike</span>
                            <span class="vehicle-price">Quick Delivery</span>
                        </div>
                        <div class="vehicle-option truck" data-type="truck">
                            <i class="fas fa-truck vehicle-icon"></i>
                            <span class="vehicle-name">Truck</span>
                            <span class="vehicle-price">Heavy Items</span>
                        </div>
                    </div>
                    
                    <div class="fare-display">
                        <p>Estimated Fare</p>
                        <div class="fare-amount" id="scheduleDeliveryFare">K0.00</div>
                        <p class="eta-display" id="scheduleDeliveryEtaDisplay">ETA: -- min</p>
                    </div>
                    
                    <button class="request-ride-btn" id="scheduleDeliveryBtn">Schedule Delivery</button>
                    <button class="btn btn-cancel" id="cancelScheduleDeliveryBtn">Cancel</button>
                </div>
                
                <!-- Schedule Ride - Schedule for Someone Form -->
                <div class="schedule-for-someone-form" id="scheduleForSomeoneForm">
                    <h4 class="section-title">Schedule Ride - For Someone Else</h4>
                    
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="scheduleSomeonePickup" placeholder="Pickup location">
                        <div class="suggestion-list" id="scheduleSomeonePickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="scheduleSomeoneDestination" placeholder="Destination">
                        <div class="suggestion-list" id="scheduleSomeoneDestinationSuggestions"></div>
                    </div>
                    
                    <div class="input-group">
                        <label for="scheduleSomeoneTime">Schedule Time</label>
                        <input type="datetime-local" id="scheduleSomeoneTime" class="input-field">
                    </div>
                    
                    <div class="input-group">
                        <label for="recipientScheduleName">Recipient's Full Name</label>
                        <input type="text" id="recipientScheduleName" class="input-field" placeholder="Full name">
                    </div>
                    
                    <div class="input-group">
                        <label for="recipientSchedulePhone">Recipient's Phone Number</label>
                        <input type="tel" id="recipientSchedulePhone" class="input-field" placeholder="Phone number">
                    </div>
                    
                    <div class="vehicle-selection">
                        <div class="vehicle-option selected" data-type="car">
                            <i class="fas fa-car vehicle-icon"></i>
                            <span class="vehicle-name">Standard</span>
                            <span class="vehicle-price">Clean Cars</span>
                        </div>
                        <div class="vehicle-option premium" data-type="premium">
                            <i class="fas fa-crown vehicle-icon"></i>
                            <span class="vehicle-name">Premium</span>
                            <span class="vehicle-price">Luxury Cars</span>
                        </div>
                    </div>
                    
                    <div class="fare-display">
                        <p>Estimated Fare</p>
                        <div class="fare-amount" id="scheduleSomeoneFare">K0.00</div>
                        <p class="eta-display" id="scheduleSomeoneEtaDisplay">ETA: -- min</p>
                    </div>
                    
                    <button class="request-ride-btn" id="scheduleForSomeoneBtn">Schedule Ride</button>
                    <button class="btn btn-cancel" id="cancelScheduleForSomeoneBtn">Cancel</button>
                </div>
                
                <!-- Schedule Timer Display -->
                <div class="schedule-timer-display" id="scheduleTimerDisplay" style="display: none;">
                    <p>Scheduled Ride Timer</p>
                    <div class="schedule-timer-time" id="scheduleTimerTime">00:00:00</div>
                    <p id="scheduleTimerDestination">To: Destination</p>
                    <div class="schedule-timer-controls">
                        <button class="schedule-timer-control" id="editScheduleTimerBtn">Edit</button>
                        <button class="schedule-timer-control" id="cancelScheduleTimerBtn">Cancel</button>
                    </div>
                </div>
                
                <!-- Order for Someone Else Form -->
                <div class="order-for-someone-form" id="orderForSomeoneForm">
                    <h4 class="section-title">Order for Someone Else</h4>
                    
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="recipientPickupLocation" placeholder="Pickup location">
                        <div class="suggestion-list" id="recipientPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="recipientDestinationLocation" placeholder="Drop-off location">
                        <div class="suggestion-list" id="recipientDestinationSuggestions"></div>
                    </div>
                    
                    <div class="input-group">
                        <label for="recipientName">Recipient's Full Name</label>
                        <input type="text" id="recipientName" class="input-field" placeholder="Full name">
                    </div>
                    
                    <div class="input-group">
                        <label for="recipientEmail">Recipient's Email</label>
                        <input type="email" id="recipientEmail" class="input-field" placeholder="Email address">
                    </div>
                    
                    <div class="input-group">
                        <label for="recipientPhone">Recipient's Phone Number</label>
                        <input type="tel" id="recipientPhone" class="input-field" placeholder="Phone number">
                    </div>
                    
                    <div class="delivery-fee-display">
                        <p>Delivery Fee</p>
                        <div class="delivery-fee-amount" id="recipientDeliveryFee">K0.00</div>
                        <p class="delivery-eta-display" id="recipientEtaDisplay">ETA: -- min</p>
                    </div>
                    
                    <button class="request-ride-btn" id="orderForSomeoneBtn">Book Ride</button>
                    <button class="btn btn-cancel" id="cancelOrderForSomeoneBtn">Cancel</button>
                </div>
                
                <!-- Express Delivery Form -->
                <div class="express-delivery-form" id="expressDeliveryForm">
                    <h4 class="section-title">Express Delivery</h4>
                    
                    <div class="input-group">
                        <label for="shopName">Shop or Restaurant Name</label>
                        <input type="text" id="shopName" class="input-field" placeholder="Name of shop or restaurant">
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="shopLocation" placeholder="Shop location">
                        <div class="suggestion-list" id="shopLocationSuggestions"></div>
                    </div>
                    
                    <div class="input-group">
                        <label for="deliveryItems">Items to Purchase</label>
                        <textarea id="deliveryItems" class="input-field" placeholder="List of items to be purchased"></textarea>
                    </div>
                    
                    <div class="input-group">
                        <label for="deliveryAmount">Total Amount to Spend (K)</label>
                        <input type="number" id="deliveryAmount" class="input-field" placeholder="Total amount">
                    </div>
                    
                    <div class="input-group">
                        <label for="deliveryInstructions">Special Instructions</label>
                        <textarea id="deliveryInstructions" class="input-field" placeholder="Any special instructions"></textarea>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="deliveryDestination" placeholder="Delivery destination">
                        <div class="suggestion-list" id="deliveryDestinationSuggestions"></div>
                    </div>
                    
                    <div class="vehicle-selection">
                        <div class="vehicle-option selected" data-type="bike">
                            <i class="fas fa-motorcycle vehicle-icon"></i>
                            <span class="vehicle-name">Bike</span>
                            <span class="vehicle-price">Quick Delivery</span>
                        </div>
                        <div class="vehicle-option truck" data-type="truck">
                            <i class="fas fa-truck vehicle-icon"></i>
                            <span class="vehicle-name">Truck</span>
                            <span class="vehicle-price">Heavy Items</span>
                        </div>
                        <div class="vehicle-option emergency" data-type="emergency">
                            <i class="fas fa-exclamation-triangle vehicle-icon"></i>
                            <span class="vehicle-name">Emergency</span>
                            <span class="vehicle-price">Urgent</span>
                        </div>
                    </div>
                    
                    <div class="delivery-fee-display">
                        <p>Delivery Fee</p>
                        <div class="delivery-fee-amount" id="expressDeliveryFee">K0.00</div>
                        <p class="delivery-eta-display" id="expressDeliveryEtaDisplay">ETA: -- min</p>
                    </div>
                    
                    <button class="request-ride-btn" id="expressDeliveryBtn">Request Delivery</button>
                    <button class="btn btn-cancel" id="cancelExpressDeliveryBtn">Cancel</button>
                </div>
                
                <!-- SOS Setup Form -->
                <div class="sos-setup-form" id="sosSetupForm">
                    <h4 class="section-title">SOS Setup</h4>
                    
                    <div class="input-group">
                        <label for="emergencyContact1">Emergency Contact 1</label>
                        <input type="tel" id="emergencyContact1" class="input-field" placeholder="Phone number">
                    </div>
                    
                    <div class="input-group">
                        <label for="emergencyContact2">Emergency Contact 2</label>
                        <input type="tel" id="emergencyContact2" class="input-field" placeholder="Phone number">
                    </div>
                    
                    <div class="input-group">
                        <label for="sosMessage">Emergency Message</label>
                        <textarea id="sosMessage" class="input-field" placeholder="Pre-typed emergency message">I need help! My current location and ride details will be shared with you.</textarea>
                    </div>
                    
                    <button class="request-ride-btn" id="saveSosBtn">Save SOS Configuration</button>
                    <button class="btn btn-cancel" id="cancelSosSetupBtn">Cancel</button>
                </div>
                
                <!-- Original Ride Request Form -->
                <div class="ride-request-form" id="rideRequestForm">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="pickupLocation" placeholder="Current location" readonly>
                    </div>
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="destinationLocation" placeholder="Where to?">
                        <div class="suggestion-list" id="destinationSuggestions"></div>
                    </div>
                    
                    <div class="saved-locations">
                        <button class="saved-location-btn" data-address="home">
                            <i class="fas fa-home"></i>
                            Home
                        </button>
                        <button class="saved-location-btn" data-address="work">
                            <i class="fas fa-briefcase"></i>
                            Work
                        </button>
                    </div>
                    
                    <div class="vehicle-selection">
                        <div class="vehicle-option selected" data-type="car">
                            <i class="fas fa-car vehicle-icon"></i>
                            <span class="vehicle-name">Standard</span>
                            <span class="vehicle-price">Clean Cars</span>
                        </div>
                        <div class="vehicle-option premium" data-type="premium">
                            <i class="fas fa-crown vehicle-icon"></i>
                            <span class="vehicle-name">Premium</span>
                            <span class="vehicle-price">Luxury Cars</span>
                        </div>
                        <div class="vehicle-option economy" data-type="economy">
                            <i class="fas fa-car-side vehicle-icon"></i>
                            <span class="vehicle-name">Economy</span>
                            <span class="vehicle-price">Budget Cars</span>
                        </div>
                        <div class="vehicle-option emergency" data-type="emergency">
                            <i class="fas fa-exclamation-triangle vehicle-icon"></i>
                            <span class="vehicle-name">Emergency</span>
                            <span class="vehicle-price">Urgent Ride</span>
                        </div>
                        <div class="vehicle-option ambulance" data-type="ambulance">
                            <i class="fas fa-ambulance vehicle-icon"></i>
                            <span class="vehicle-name">Ambulance</span>
                            <span class="vehicle-price">Medical</span>
                        </div>
                        <div class="vehicle-option fire-truck" data-type="fire-truck">
                            <i class="fas fa-fire-extinguisher vehicle-icon"></i>
                            <span class="vehicle-name">Fire Truck</span>
                            <span class="vehicle-price">Emergency</span>
                        </div>
                        <div class="vehicle-option" data-type="bike">
                            <i class="fas fa-motorcycle vehicle-icon"></i>
                            <span class="vehicle-name">Bike</span>
                            <span class="vehicle-price">Quick Delivery</span>
                        </div>
                        <div class="vehicle-option truck" data-type="truck">
                            <i class="fas fa-truck vehicle-icon"></i>
                            <span class="vehicle-name">Truck</span>
                            <span class="vehicle-price">Heavy Items</span>
                        </div>
                    </div>
                    
                    <!-- Package Delivery Form -->
                    <button class="package-toggle" id="packageToggle" style="display: none;">
                        <i class="fas fa-box"></i>
                        Add Package Details
                    </button>
                    
                    <div class="package-form" id="packageForm">
                        <h4 class="section-title">Package Delivery Details</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="receiverName">Receiver Name</label>
                                <input type="text" id="receiverName" placeholder="Full name of receiver">
                            </div>
                            <div class="form-group">
                                <label for="receiverPhone">Receiver Phone</label>
                                <input type="tel" id="receiverPhone" placeholder="Phone number">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="packageDescription">Package Description</label>
                            <input type="text" id="packageDescription" placeholder="What is being delivered?">
                        </div>
                        <div class="form-group">
                            <label for="specialInstructions">Special Instructions</label>
                            <textarea id="specialInstructions" placeholder="Any special handling instructions?"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="packageValue">Package Value (K)</label>
                            <input type="number" id="packageValue" placeholder="Estimated value for insurance">
                        </div>
                    </div>
                    
                    <button class="promo-toggle" id="promoToggle">
                        <i class="fas fa-tag"></i>
                        Apply Promo Coupon
                    </button>
                    
                    <div class="promo-section" id="promoSection">
                        <div class="promo-input">
                            <input type="text" id="promoCode" placeholder="Promo code">
                            <button class="btn-promo" id="applyPromoBtn">Apply</button>
                        </div>
                    </div>
                    
                    <div class="fare-display">
                        <p>Estimated Fare</p>
                        <div class="fare-amount" id="estimatedFare">K0.00</div>
                        <p class="eta-display" id="etaDisplay">ETA: -- min</p>
                    </div>
                    
                    <button class="request-ride-btn" id="requestRideBtn">Request Ride</button>
                </div>
                
                <!-- Ride Info Panel (Hidden initially) -->
                <div class="ride-info-panel" id="rideInfoPanel">
                    <!-- Driver Details Card -->
                    <div class="driver-details-card" id="driverDetailsCard" style="display: none;">
                        <div class="driver-details-header">
                            <i class="fas fa-id-card"></i>
                            <h3>Driver Details</h3>
                        </div>
                        <div class="driver-details-grid">
                            <div class="driver-detail-item">
                                <span class="driver-detail-label">Driver Name</span>
                                <span class="driver-detail-value" id="driverFullName">John Doe</span>
                            </div>
                            <div class="driver-detail-item">
                                <span class="driver-detail-label">Phone</span>
                                <span class="driver-detail-value" id="driverContactPhone">+260 123 456 789</span>
                            </div>
                            <div class="driver-detail-item">
                                <span class="driver-detail-label">Rating</span>
                                <span class="driver-detail-value" id="driverRatingValue">4.8 </span>
                            </div>
                            <div class="driver-detail-item">
                                <span class="driver-detail-label">Experience</span>
                                <span class="driver-detail-value" id="driverExperience">2 years</span>
                            </div>
                        </div>
                        <div class="driver-vehicle-details">
                            <div class="vehicle-detail-row">
                                <span class="vehicle-detail-label">Vehicle Type</span>
                                <span class="vehicle-detail-value" id="vehicleType">Car</span>
                            </div>
                            <div class="vehicle-detail-row">
                                <span class="vehicle-detail-label">Vehicle Model</span>
                                <span class="vehicle-detail-value" id="vehicleModel">Toyota Corolla</span>
                            </div>
                            <div class="vehicle-detail-row">
                                <span class="vehicle-detail-label">License Plate</span>
                                <span class="vehicle-detail-value" id="vehicleLicense">ABC 123</span>
                            </div>
                            <div class="vehicle-detail-row">
                                <span class="vehicle-detail-label">Color</span>
                                <span class="vehicle-detail-value" id="vehicleColor">Blue</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="driver-info">
                        <div class="driver-avatar" id="driverAvatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="driver-details">
                            <h2 id="driverName">Driver Name</h2>
                            <p><i class="fas fa-phone"></i> <span id="driverPhone">000-000-0000</span></p>
                            <p><i class="fas fa-car"></i> <span id="vehicleDetails">Toyota Corolla - ABC123</span></p>
                            <p><i class="fas fa-star"></i> <span id="driverRating">4.5 </span></p>
                        </div>
                    </div>
                    
                    <div class="trip-details">
                        <div class="location-row">
                            <div class="location-icon pickup-icon">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="location-text">
                                <h4>Pickup Location</h4>
                                <p id="currentPickupLocation">123 Main Street, City</p>
                            </div>
                        </div>
                        <div class="location-row">
                            <div class="location-icon destination-icon">
                                <i class="fas fa-flag"></i>
                            </div>
                            <div class="location-text">
                                <h4>Destination</h4>
                                <p id="currentDestinationLocation">456 Oak Avenue, City</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="fare-details">
                        <div class="fare-row">
                            <span>Base Fare</span>
                            <span id="baseFare">K15.00</span>
                        </div>
                        <div class="fare-row">
                            <span>Distance</span>
                            <span id="distanceFare">K5.00</span>
                        </div>
                        <div class="fare-row">
                            <span>Discount</span>
                            <span id="discountFare">-K2.00</span>
                        </div>
                        <div class="fare-row total">
                            <span>Total Fare</span>
                            <span id="totalFare">K18.00</span>
                        </div>
                    </div>
                    
                    <div class="ride-actions">
                        <button class="btn btn-cancel" id="cancelRideBtn">
                            <i class="fas fa-times-circle"></i>
                            Cancel Ride
                        </button>
                        <button class="btn btn-contact" id="contactDriverBtn">
                            <i class="fas fa-phone"></i>
                            Contact Driver
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Screen Contents -->
        <div class="screen-content" id="homeScreen">
            <!-- Home screen is the map, so this is empty -->
        </div>
        
        <div class="screen-content" id="accountScreen">
            <div class="screen-header">
                <button class="back-button" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="screen-title">Account</h2>
            </div>
            
            <div class="account-section">
                <div class="account-header">
                    <div class="driver-avatar" id="accountAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="driver-details">
                        <h2 id="accountName">Passenger</h2>
                        <p><i class="fas fa-phone"></i> <span id="accountPhone">Not set</span></p>
                        <p><i class="fas fa-envelope"></i> <span id="accountEmail">Not set</span></p>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="ridesCompleted">0</div>
                        <div class="stat-label">Completed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="ridesCancelled">0</div>
                        <div class="stat-label">Cancelled</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="ridesPending">0</div>
                        <div class="stat-label">Pending</div>
                    </div>
                </div>
                
                <div class="referral-section">
                    <h3 class="section-title">
                        <i class="fas fa-share-alt"></i>
                        Refer & Earn
                    </h3>
                    <p>Share your code and get K25 when friends join</p>
                    <div class="referral-code">
                        <div class="code" id="referralCode">JUBEL-XXXX</div>
                        <div class="description">50% discount for new users</div>
                    </div>
                    <button class="btn btn-primary" id="shareReferralBtn">
                        <i class="fas fa-share"></i>
                        Share Referral Code
                    </button>
                </div>
                
                <div class="wallet-section">
                    <h3 class="section-title">
                        <i class="fas fa-wallet"></i>
                        Jubel Wallet
                    </h3>
                    <div class="wallet-balance">
                        <div class="balance-label">Current Balance</div>
                        <div class="balance-amount-large" id="accountBalance">K0.00</div>
                    </div>
                    <div class="wallet-actions">
                        <button class="btn-wallet" id="depositBtn">
                            <i class="fas fa-plus"></i>
                            Deposit
                        </button>
                        <button class="btn-wallet" id="withdrawBtn">
                            <i class="fas fa-minus"></i>
                            Withdraw
                        </button>
                    </div>
                </div>
                
                <div class="contact-section">
                    <button class="contact-btn whatsapp" id="whatsappBtn">
                        <i class="fab fa-whatsapp"></i>
                        WhatsApp
                    </button>
                    <button class="contact-btn phone" id="callBtn">
                        <i class="fas fa-phone"></i>
                        Call Us
                    </button>
                </div>
            </div>
        </div>
        
        <div class="screen-content" id="historyScreen">
            <div class="screen-header">
                <button class="back-button" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="screen-title">Ride History</h2>
            </div>
            
            <div class="filter-options">
                <select id="historyFilter" class="input-field">
                    <option value="all">All Rides</option>
                    <option value="requested">Awaiting Driver</option>
                    <option value="accepted">In Progress</option>
                    <option value="completed">Completed</option>
                    <option value="cancelled">Cancelled</option>
                    <option value="scheduled">Scheduled</option>
                    <option value="emergency">Emergency</option>
                    <option value="delivery">Delivery</option>
                </select>
                <input type="date" id="historyDate" class="input-field">
            </div>
            
            <!-- Scheduled Rides Section -->
            <div class="history-section" id="scheduledRidesSection" style="display: none;">
                <h3 class="section-title">
                    <i class="fas fa-clock"></i>
                    Scheduled Rides
                </h3>
                <div id="scheduledRidesList"></div>
            </div>
            
            <!-- Ride History Section -->
            <div class="history-section">
                <div id="historyList">
                    <div class="loading-text">
                        <i class="fas fa-spinner fa-spin"></i>
                        Loading ride history...
                    </div>
                </div>
            </div>
        </div>
        
        <div class="screen-content" id="paymentsScreen">
            <div class="screen-header">
                <button class="back-button" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="screen-title">Payment Methods</h2>
            </div>
            
            <div class="payments-section">
                <h3 class="section-title">
                    <i class="fas fa-credit-card"></i>
                    Payment Methods
                </h3>
                
                <div class="payment-methods">
                    <div class="payment-method selected" data-method="airtel">
                        <div class="payment-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Airtel Money</div>
                            <div class="payment-info">Pay with Airtel Money</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-method="mtn">
                        <div class="payment-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">MTN Money</div>
                            <div class="payment-info">Pay with MTN Money</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-method="zamtel">
                        <div class="payment-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Zamtel Money</div>
                            <div class="payment-info">Pay with Zamtel Money</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-method="card">
                        <div class="payment-icon">
                            <i class="fas fa-credit-card"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Credit/Debit Card</div>
                            <div class="payment-info">Visa, Mastercard</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-method="cash">
                        <div class="payment-icon">
                            <i class="fas fa-money-bill"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Cash</div>
                            <div class="payment-info">Pay with cash</div>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-primary" id="addPaymentMethodBtn">
                    <i class="fas fa-plus"></i>
                    Add Payment Method
                </button>
            </div>
        </div>
    </div>
    
    <!-- Payment Selection Popup -->
    <div id="paymentSelectionPopup" class="popup-overlay hidden">
        <div class="popup-form payment-selection-popup">
            <div class="popup-header">
                <h2 class="popup-title">
                    <i class="fas fa-credit-card"></i>
                    Select Payment Method
                </h2>
                <button class="close-popup" id="closePaymentPopup">&times;</button>
            </div>
            <div class="popup-content">
                <div class="payment-options">
                    <div class="payment-option selected" data-payment-type="wallet">
                        <div class="payment-option-icon">
                            <i class="fas fa-wallet"></i>
                        </div>
                        <div class="payment-option-details">
                            <div class="payment-option-name">Jubel Wallet</div>
                            <div class="payment-option-description">Pay with your Jubel wallet balance</div>
                            <div class="payment-option-balance" id="paymentWalletBalance">Balance: K0.00</div>
                        </div>
                    </div>
                    
                    <div class="payment-option" data-payment-type="mobile">
                        <div class="payment-option-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="payment-option-details">
                            <div class="payment-option-name">Mobile Money</div>
                            <div class="payment-option-description">Pay with Airtel, MTN or Zamtel Money</div>
                        </div>
                    </div>
                    
                    <div class="payment-option" data-payment-type="cash">
                        <div class="payment-option-icon">
                            <i class="fas fa-money-bill"></i>
                        </div>
                        <div class="payment-option-details">
                            <div class="payment-option-name">Cash on Delivery</div>
                            <div class="payment-option-description">Pay with cash when you arrive</div>
                        </div>
                    </div>
                </div>
                
                <div class="insufficient-balance" id="insufficientBalance">
                    <i class="fas fa-exclamation-circle"></i>
                    Insufficient balance in your Jubel wallet
                </div>
                
                <button class="confirm-payment-btn" id="confirmPaymentBtn">
                    Confirm Payment & Request Ride
                </button>
            </div>
        </div>
    </div>
    
    <!-- Enhanced Ride Details Popup -->
    <div id="rideDetailsPopup" class="popup-overlay hidden">
        <div class="popup-form large-popup">
            <div class="popup-header">
                <h2 class="popup-title">
                    <i class="fas fa-info-circle"></i>
                    Ride Details
                </h2>
                <button class="close-popup" id="closeRidePopupTop">&times;</button>
            </div>
            <div class="popup-content">
                <div class="popup-map-container" id="popupRideMap"></div>
                <div class="popup-details">
                    <div class="detail-row">
                        <span class="detail-label">Pickup:</span>
                        <span class="detail-value" id="popupRidePickup">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Destination:</span>
                        <span class="detail-value" id="popupRideDestination">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Fare:</span>
                        <span class="detail-value" id="popupRideFare">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Distance:</span>
                        <span class="detail-value" id="popupRideDistance">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Ride Type:</span>
                        <span class="detail-value" id="popupRideType">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Status:</span>
                        <span class="detail-value" id="popupRideStatus">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Date & Time:</span>
                        <span class="detail-value" id="popupRideDate">Loading...</span>
                    </div>
                    
                    <!-- Driver Details Section -->
                    <div id="popupDriverDetails" class="driver-details-section hidden">
                        <h3 class="section-title">Driver Information</h3>
                        <div class="detail-row">
                            <span class="detail-label">Driver Name:</span>
                            <span class="detail-value" id="popupDriverName">Loading...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Phone:</span>
                            <span class="detail-value" id="popupDriverPhone">Loading...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Vehicle:</span>
                            <span class="detail-value" id="popupDriverVehicle">Loading...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Rating:</span>
                            <span class="detail-value" id="popupDriverRating">Loading...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Progress:</span>
                            <span class="detail-value" id="popupDriverProgress">Loading...</span>
                        </div>
                    </div>
                    
                    <!-- Chat History Section -->
                    <div id="popupChatSection" class="history-chat-section hidden">
                        <h3 class="section-title">
                            <i class="fas fa-comments"></i>
                            Chat History
                        </h3>
                        <div class="history-chat-messages" id="historyChatMessages">
                            <div class="loading-text">Loading chat history...</div>
                        </div>
                    </div>
                    
                    <!-- Receipt Button -->
                    <button class="receipt-button" id="generateReceiptBtn">
                        <i class="fas fa-receipt"></i>
                        Generate & Download Receipt
                    </button>
                    
                    <div class="popup-actions">
                        <button class="btn btn-primary" id="closeRidePopup">
                            <i class="fas fa-times"></i>
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Rating Popup -->
    <div id="ratingPopup" class="popup-overlay hidden">
        <div class="popup-form">
            <div class="popup-header">
                <h2 class="popup-title">
                    <i class="fas fa-star"></i>
                    Rate Your Driver
                </h2>
                <button class="close-popup" id="closeRatingPopup">&times;</button>
            </div>
            <div class="popup-content">
                <div class="rating-driver-info" style="text-align: center; margin-bottom: 20px;">
                    <div class="driver-avatar" id="ratingDriverAvatar" style="width: 60px; height: 60px; margin: 0 auto 10px; background: var(--primary-orange); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white;">
                        <i class="fas fa-user"></i>
                    </div>
                    <h3 id="ratingDriverName" style="margin-bottom: 5px;">Driver Name</h3>
                    <p id="ratingVehicleInfo" style="color: var(--medium-gray); font-size: 0.9rem;">Vehicle Info</p>
                </div>
                
                <div class="rating-stars-container" style="text-align: center; margin: 20px 0;">
                    <div class="rating-stars" id="ratingStars">
                        <span class="star" data-rating="1"><i class="far fa-star"></i></span>
                        <span class="star" data-rating="2"><i class="far fa-star"></i></span>
                        <span class="star" data-rating="3"><i class="far fa-star"></i></span>
                        <span class="star" data-rating="4"><i class="far fa-star"></i></span>
                        <span class="star" data-rating="5"><i class="far fa-star"></i></span>
                    </div>
                    <div id="ratingText" style="margin-top: 10px; font-size: 0.9rem; color: var(--medium-gray);">Tap to rate</div>
                </div>
                
                <div class="rating-comment" style="margin-bottom: 20px;">
                    <label for="ratingComment" style="display: block; margin-bottom: 8px; font-weight: 600;">Additional Comments (Optional)</label>
                    <textarea id="ratingComment" placeholder="How was your ride experience?" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: var(--element-radius); resize: vertical; min-height: 80px;"></textarea>
                </div>
                
                <button id="submitRatingBtn" class="request-ride-btn" style="width: 100%;">
                    <i class="fas fa-paper-plane"></i> Submit Rating
                </button>
            </div>
        </div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification"></div>
    
    <!-- Firebase and OpenLayers JS -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <!-- OpenLayers JS -->
    <script src="https://cdn.jsdelivr.net/npm/ol@v7.3.0/dist/ol.js"></script>
    <!-- Additional libraries -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script>
// Firebase configuration
const firebaseConfig = {
    apiKey: "AIzaSyDEACX_P4c5q7djJAcA0I7Lk7leO2TlQ74",
    authDomain: "jubel-13e1a.firebaseapp.com",
    databaseURL: "https://jubel-13e1a-default-rtdb.firebaseio.com",
    projectId: "jubel-13e1a",
    storageBucket: "jubel-13e1a.firebasestorage.app",
    messagingSenderId: "882241095445",
    appId: "1:882241095445:web:ee9ca40fddd008ca910b1c",
    measurementId: "G-J5JPKL6B5F"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const auth = firebase.auth();

// App state
let currentUser = null;
let currentRide = null;
let passengerMap;
let popupRideMap;
let locationWatchId = null;
let currentLocationMarker = null;
let pickupMarker = null;
let destinationMarker = null;
let driverMarker = null;
let routeLayer = null;
let selectedVehicleType = 'car';
let walletBalance = 0;
let userFullName = "Passenger";
let driverAssignmentListener = null;
let rideHistoryListener = null;
let activeRideListener = null;
let appliedPromoCode = null;
let userStats = {
    completed: 0,
    cancelled: 0,
    pending: 0
};
let paymentMethod = 'airtel';
let userRating = 0;
let userLocation = null;
let destinationSearchResults = [];
let selectedDestination = null;
let driverLocationListener = null;
let userData = null;
let selectedPaymentType = 'wallet';
let rideFare = 0;
let currentCity = "Detecting...";
let packageDetails = null;
let walletBalanceListener = null;
let currentScreen = 'home';
let homeScreenRefreshRequired = false;

// Enhanced state variables
let sosConfig = null;
let activeMoreOption = null;
let activeScheduleOption = null;
let recipientPickupMarker = null;
let recipientDestinationMarker = null;
let shopLocationMarker = null;
let deliveryDestinationMarker = null;
let schedulePickupMarker = null;
let scheduleDestinationMarker = null;

// Chat state management
let chatListener = null;
let currentChatRideId = null;
let unreadMessages = {};
let chatPopupClosedByUser = false;
let driverMessageListener = null;

// Search state management
let pickupSearchResults = [];
let recipientPickupSearchResults = [];
let shopLocationSearchResults = [];
let deliveryDestinationSearchResults = [];
let schedulePickupSearchResults = [];
let scheduleDestinationSearchResults = [];
let scheduleDeliveryPickupSearchResults = [];
let scheduleDeliveryDestinationSearchResults = [];
let scheduleSomeonePickupSearchResults = [];
let scheduleSomeoneDestinationSearchResults = [];
let activeSearchField = null;

// Ride request type tracking
let currentRideRequestType = 'standard';
let currentRideRequestData = null;

// Driver images state
let driverProfileImage = null;
let driverVehicleImage = null;

// Ride persistence state
let activeRideRestored = false;

// Scheduled rides state
let scheduledRides = [];
let scheduledTimers = {};
let currentScheduleTimer = null;
let scheduleRideListener = null;

// Multi-stop state
let multiStopMarkers = [];
let multiStopRoutes = [];
let currentMultiStopCount = 2;

// Search cache for performance
let searchCache = new Map();
const CACHE_TTL = 10 * 60 * 1000; // 10 minutes

// Debounce timers for search
let searchDebounceTimers = {};

// Enhanced Zambian cities for search
const zambianCities = [
    'Lusaka', 'Kitwe', 'Ndola', 'Kabwe', 'Chipata', 'Chingola', 
    'Mufulira', 'Luanshya', 'Livingstone', 'Kasama', 'Solwezi', 
    'Kapiri Mposhi', 'Chililabombwe', 'Mazabuka', 'Mongu', 'Kafue',
    'Choma', 'Mansa', 'Nchelenge', 'Kawambwa', 'Mbala', 'Mpika',
    'Petauke', 'Katete', 'Siavonga', 'Monze', 'Kalulushi', 'Mwinilunga'
];

// City aliases for handling spelling mistakes
const cityAliases = {
    'lusaka': 'Lusaka', 'lsk': 'Lusaka', 'lsk city': 'Lusaka', 'lusaka city': 'Lusaka',
    'kitwe': 'Kitwe', 'kitwe town': 'Kitwe',
    'ndola': 'Ndola', 'ndola city': 'Ndola',
    'kabwe': 'Kabwe', 'kabwe town': 'Kabwe',
    'chipata': 'Chipata', 'chipata town': 'Chipata',
    'chingola': 'Chingola', 'chingola town': 'Chingola',
    'mufulira': 'Mufulira', 'mufulira town': 'Mufulira',
    'luanshya': 'Luanshya', 'luanshya town': 'Luanshya',
    'livingstone': 'Livingstone', 'livingstone town': 'Livingstone',
    'kasama': 'Kasama', 'kasama town': 'Kasama',
    'solwezi': 'Solwezi', 'solwezi town': 'Solwezi',
    'kapiri': 'Kapiri Mposhi', 'kapiri mposhi': 'Kapiri Mposhi', 'kapiri mposhi town': 'Kapiri Mposhi',
    'chililabombwe': 'Chililabombwe', 'chili': 'Chililabombwe', 'chililabombwe town': 'Chililabombwe',
    'mazabuka': 'Mazabuka', 'mazabuka town': 'Mazabuka',
    'mongu': 'Mongu', 'mongu town': 'Mongu',
    'kafue': 'Kafue', 'kafue town': 'Kafue',
    'choma': 'Choma', 'choma town': 'Choma',
    'mansa': 'Mansa', 'mansa town': 'Mansa',
    'nchelenge': 'Nchelenge',
    'kawambwa': 'Kawambwa',
    'mbala': 'Mbala',
    'mpika': 'Mpika',
    'petauke': 'Petauke',
    'katete': 'Katete',
    'siavonga': 'Siavonga',
    'monze': 'Monze',
    'kalulushi': 'Kalulushi',
    'mwinilunga': 'Mwinilunga'
};

// Enhanced city boundaries
const cityBoundaries = {
    'Lusaka': { lat: -15.4167, lng: 28.2833, radius: 30000 },
    'Kitwe': { lat: -12.8139, lng: 28.2136, radius: 25000 },
    'Ndola': { lat: -12.9667, lng: 28.6333, radius: 25000 },
    'Kabwe': { lat: -14.4333, lng: 28.4500, radius: 20000 },
    'Chipata': { lat: -13.6333, lng: 32.6500, radius: 20000 },
    'Chingola': { lat: -12.5333, lng: 27.8500, radius: 20000 },
    'Mufulira': { lat: -12.5500, lng: 28.2333, radius: 20000 },
    'Luanshya': { lat: -13.1333, lng: 28.4000, radius: 20000 },
    'Livingstone': { lat: -17.8500, lng: 25.8667, radius: 20000 },
    'Kasama': { lat: -10.2000, lng: 31.2000, radius: 20000 },
    'Solwezi': { lat: -12.1833, lng: 26.4000, radius: 20000 },
    'Kapiri Mposhi': { lat: -13.9667, lng: 28.6833, radius: 15000 },
    'Chililabombwe': { lat: -12.3667, lng: 27.8333, radius: 15000 },
    'Mazabuka': { lat: -15.8567, lng: 27.7483, radius: 15000 },
    'Mongu': { lat: -15.2486, lng: 23.1275, radius: 15000 },
    'Kafue': { lat: -15.7667, lng: 28.1833, radius: 15000 },
    'Choma': { lat: -16.8167, lng: 26.9833, radius: 15000 },
    'Mansa': { lat: -11.2000, lng: 28.8833, radius: 15000 }
};

// Common Zambian places and landmarks
const commonZambianPlaces = {
    'Manda Hill': { city: 'Lusaka', lat: -15.4070, lng: 28.3147 },
    'East Park Mall': { city: 'Lusaka', lat: -15.3942, lng: 28.3403 },
    'Levy Mall': { city: 'Lusaka', lat: -15.4167, lng: 28.2833 },
    'Arcades Shopping Mall': { city: 'Lusaka', lat: -15.3986, lng: 28.3192 },
    'University of Zambia': { city: 'Lusaka', lat: -15.3878, lng: 28.3272 },
    'Lusaka Airport': { city: 'Lusaka', lat: -15.3308, lng: 28.4528 },
    'Lusaka Central Hospital': { city: 'Lusaka', lat: -15.4131, lng: 28.2878 },
    'Kamwala Market': { city: 'Lusaka', lat: -15.4181, lng: 28.2889 },
    'Soweto Market': { city: 'Lusaka', lat: -15.4147, lng: 28.3011 },
    'Ndola Airport': { city: 'Ndola', lat: -12.9981, lng: 28.6644 },
    'Ndola Central Hospital': { city: 'Ndola', lat: -12.9667, lng: 28.6333 },
    'Kitwe Central Hospital': { city: 'Kitwe', lat: -12.8139, lng: 28.2136 },
    'Nkana Golf Club': { city: 'Kitwe', lat: -12.8167, lng: 28.2167 },
    'Livingstone Airport': { city: 'Livingstone', lat: -17.8217, lng: 25.8225 },
    'Victoria Falls': { city: 'Livingstone', lat: -17.9244, lng: 25.8572 },
    'Livingstone Museum': { city: 'Livingstone', lat: -17.8500, lng: 25.8667 },
    'Kabwe Central Hospital': { city: 'Kabwe', lat: -14.4333, lng: 28.4500 },
    'Chililabombwe General Hospital': { city: 'Chililabombwe', lat: -12.3667, lng: 27.8333 }
};

// Vehicle type configurations
const vehicleConfigs = {
    'car': { 
        name: 'Standard', 
        icon: 'fas fa-car',
        multiplier: 1.0,
        markerClass: 'standard-marker',
        baseFare: 23
    },
    'premium': { 
        name: 'Premium', 
        icon: 'fas fa-crown',
        multiplier: 1.8,
        markerClass: 'premium-marker',
        baseFare: 40
    },
    'economy': { 
        name: 'Economy', 
        icon: 'fas fa-car-side',
        multiplier: 0.7,
        markerClass: 'economy-marker',
        baseFare: 18
    },
    'emergency': { 
        name: 'Emergency', 
        icon: 'fas fa-exclamation-triangle',
        multiplier: 2.5,
        markerClass: 'emergency-marker',
        baseFare: 60
    },
    'ambulance': { 
        name: 'Ambulance', 
        icon: 'fas fa-ambulance',
        multiplier: 3.0,
        markerClass: 'ambulance-marker',
        baseFare: 80
    },
    'fire-truck': { 
        name: 'Fire Truck', 
        icon: 'fas fa-fire-extinguisher',
        multiplier: 3.5,
        markerClass: 'fire-truck-marker',
        baseFare: 100
    },
    'bike': { 
        name: 'Bike', 
        icon: 'fas fa-motorcycle',
        multiplier: 0.6,
        markerClass: 'bike-marker',
        baseFare: 15
    },
    'truck': { 
        name: 'Truck', 
        icon: 'fas fa-truck',
        multiplier: 2.2,
        markerClass: 'truck-marker',
        baseFare: 50
    }
};

// Initialize the app
document.addEventListener('DOMContentLoaded', function() {
    initializeAuth();
});

// Authentication functions
function initializeAuth() {
    const urlParams = new URLSearchParams(window.location.search);
    const email = urlParams.get('email');
    const uid = urlParams.get('uid');
    
    if (email && uid) {
        loadUserData(uid);
    } else {
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                loadUserData(user.uid);
            } else {
                window.location.href = 'signup.html';
            }
        });
    }
}

// Load user data from Firebase
function loadUserData(uid) {
    database.ref('users/' + uid).once('value')
        .then(snapshot => {
            userData = snapshot.val();
            if (userData) {
                currentUser = {
                    uid: uid,
                    email: userData.email,
                    displayName: userData.name
                };
                
                initializeMap();
                setupEventListeners();
                loadPassengerData();
                
                document.getElementById('accountName').textContent = userData.name || 'Passenger';
                document.getElementById('accountEmail').textContent = userData.email || 'Not set';
                document.getElementById('accountPhone').textContent = userData.phone || 'Not set';
                document.getElementById('referralCode').textContent = userData.referralCode || 'JUBEL-XXXX';
                
                walletBalance = userData.walletBalance || 0;
                updateWalletBalanceUI();
                
                setupWalletBalanceListener(uid);
                loadSOSConfig(uid);
                checkActiveRide(uid);
                loadScheduledRides(uid);
                
                showNotification('Welcome back to Jubel!');
            } else {
                showNotification('User data not found. Please sign up again.');
                setTimeout(() => {
                    window.location.href = 'signup.html';
                }, 2000);
            }
        })
        .catch(error => {
            console.error('Error loading user data:', error);
            showNotification('Error loading user data. Please try again.');
        });
}

// Initialize OpenLayers map
function initializeMap() {
    // Set initial view to Zambia
    const initialCenter = ol.proj.fromLonLat([28.0, -14.5]);
    
    passengerMap = new ol.Map({
        target: 'map',
        layers: [
            new ol.layer.Tile({
                source: new ol.source.OSM()
            })
        ],
        view: new ol.View({
            center: initialCenter,
            zoom: 7,
            maxZoom: 19,
            minZoom: 6
        }),
        controls: ol.control.defaults({
            attributionOptions: {
                collapsible: false
            }
        })
    });
    
    // Add custom zoom controls
    passengerMap.addControl(new ol.control.Zoom());
    
    // Initialize popup map
    const popupMapContainer = document.getElementById('popupRideMap');
    if (popupMapContainer) {
        popupRideMap = new ol.Map({
            target: 'popupRideMap',
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.OSM()
                })
            ],
            view: new ol.View({
                center: initialCenter,
                zoom: 7,
                maxZoom: 19,
                minZoom: 6
            }),
            controls: ol.control.defaults({
                zoom: false,
                rotate: false,
                attribution: false
            })
        });
    }
    
    // Vector layer for markers
    window.mapVectorLayer = new ol.layer.Vector({
        source: new ol.source.Vector()
    });
    passengerMap.addLayer(window.mapVectorLayer);
    
    // Vector layer for routes
    window.routeVectorLayer = new ol.layer.Vector({
        source: new ol.source.Vector(),
        style: new ol.style.Style({
            stroke: new ol.style.Stroke({
                color: '#FF6B35',
                width: 4,
                lineDash: [8, 8]
            })
        })
    });
    passengerMap.addLayer(window.routeVectorLayer);
    
    // Vector layer for popup map
    if (popupRideMap) {
        window.popupMapVectorLayer = new ol.layer.Vector({
            source: new ol.source.Vector()
        });
        popupRideMap.addLayer(window.popupMapVectorLayer);
        
        window.popupRouteVectorLayer = new ol.layer.Vector({
            source: new ol.source.Vector(),
            style: new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: '#FF6B35',
                    width: 4,
                    lineDash: [8, 8]
                })
            })
        });
        popupRideMap.addLayer(window.popupRouteVectorLayer);
    }
    
    // Refresh passenger position
    refreshPassengerPosition();
}

// Create custom marker
function createMarker(coordinates, type, label = '') {
    const markerType = vehicleConfigs[type] || vehicleConfigs.car;
    const markerClass = markerType.markerClass || 'standard-marker';
    
    const markerElement = document.createElement('div');
    markerElement.className = markerClass;
    markerElement.innerHTML = `<i class="${markerType.icon}"></i>`;
    
    if (label) {
        const labelElement = document.createElement('div');
        labelElement.className = 'driver-marker-label';
        labelElement.textContent = label;
        markerElement.appendChild(labelElement);
    }
    
    return new ol.Overlay({
        position: ol.proj.fromLonLat(coordinates),
        element: markerElement,
        positioning: 'center-center',
        stopEvent: false
    });
}

// Add marker to map
function addMarkerToMap(map, coordinates, type, label = '') {
    const marker = createMarker(coordinates, type, label);
    map.addOverlay(marker);
    return marker;
}

// Remove marker from map
function removeMarkerFromMap(map, marker) {
    if (marker) {
        map.removeOverlay(marker);
    }
}

// Draw route on map
function drawRouteOnMap(map, vectorLayer, startCoords, endCoords) {
    // Clear existing route
    vectorLayer.getSource().clear();
    
    // Create coordinates array
    const coordinates = [
        ol.proj.fromLonLat(startCoords),
        ol.proj.fromLonLat(endCoords)
    ];
    
    // Create line feature
    const routeFeature = new ol.Feature({
        geometry: new ol.geom.LineString(coordinates)
    });
    
    // Add to vector layer
    vectorLayer.getSource().addFeature(routeFeature);
    
    // Fit map to show the entire route
    const extent = routeFeature.getGeometry().getExtent();
    map.getView().fit(extent, {
        padding: [50, 50, 50, 50],
        duration: 1000
    });
}

// Update map view to coordinates
function updateMapView(map, coordinates, zoom = 16) {
    map.getView().animate({
        center: ol.proj.fromLonLat(coordinates),
        zoom: zoom,
        duration: 1000
    });
}

// Enhanced city detection
function determineCurrentCity(lat, lng) {
    return new Promise((resolve, reject) => {
        console.log(`Starting city detection for coordinates: ${lat}, ${lng}`);
        
        // Check if within known city boundaries first
        const boundaryCity = checkCityBoundaries(lat, lng);
        if (boundaryCity) {
            console.log(`City detected via boundaries: ${boundaryCity}`);
            currentCity = boundaryCity;
            resolve(currentCity);
            return;
        }
        
        // Try to find the nearest Zambian city
        const nearestCity = findNearestZambianCity(lat, lng);
        if (nearestCity) {
            console.log(`Nearest Zambian city: ${nearestCity}`);
            currentCity = nearestCity;
            resolve(currentCity);
            return;
        }
        
        // Use Nominatim reverse geocoding
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=10&addressdetails=1&accept-language=en`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data && data.address) {
                    const detectedCity = extractCityFromAddress(data.address);
                    
                    if (detectedCity && detectedCity !== "Unknown Location") {
                        currentCity = detectedCity;
                        console.log(`City detected via Nominatim: ${currentCity}`);
                        resolve(currentCity);
                    } else {
                        const fallbackCity = extractCityFromDisplayName(data.display_name);
                        currentCity = fallbackCity || "Unknown Location";
                        console.log(`City detected via fallback: ${currentCity}`);
                        resolve(currentCity);
                    }
                } else {
                    currentCity = "Unknown Location";
                    console.log(`No city data found`);
                    resolve(currentCity);
                }
            })
            .catch(error => {
                console.error('Error in city detection:', error);
                currentCity = "Unknown Location";
                resolve(currentCity);
            });
    });
}

// Check if coordinates fall within known city boundaries
function checkCityBoundaries(lat, lng) {
    for (const [city, boundary] of Object.entries(cityBoundaries)) {
        const distance = calculateDistance(lat, lng, boundary.lat, boundary.lng);
        if (distance <= boundary.radius) {
            return city;
        }
    }
    return null;
}

// Find nearest Zambian city
function findNearestZambianCity(lat, lng) {
    let nearestCity = null;
    let shortestDistance = Infinity;
    
    for (const [city, boundary] of Object.entries(cityBoundaries)) {
        const distance = calculateDistance(lat, lng, boundary.lat, boundary.lng);
        if (distance < shortestDistance) {
            shortestDistance = distance;
            nearestCity = city;
        }
    }
    
    // If within 100km of a city, return it
    return shortestDistance <= 100000 ? nearestCity : null;
}

// Extract city from address object
function extractCityFromAddress(address) {
    const priorityFields = [
        'city', 'town', 'village', 'municipality', 
        'suburb', 'county', 'state_district', 'state'
    ];
    
    for (const field of priorityFields) {
        if (address[field]) {
            const detectedName = address[field].toString().trim();
            const normalized = normalizeCityName(detectedName);
            if (zambianCities.includes(normalized)) {
                return normalized;
            }
        }
    }
    
    return null;
}

// Extract city from display name
function extractCityFromDisplayName(displayName) {
    if (!displayName) return "Unknown Location";
    
    const nameLower = displayName.toLowerCase();
    
    for (const city of zambianCities) {
        if (nameLower.includes(city.toLowerCase())) {
            return city;
        }
    }
    
    for (const [alias, actualCity] of Object.entries(cityAliases)) {
        if (nameLower.includes(alias)) {
            return actualCity;
        }
    }
    
    return "Unknown Location";
}

// Normalize city names
function normalizeCityName(cityName) {
    if (!cityName) return "";
    
    const normalized = cityName.toString().trim();
    
    const variations = {
        'lusaka city': 'Lusaka',
        'lska': 'Lusaka',
        'kitwe town': 'Kitwe',
        'ndola city': 'Ndola',
        'kabwe town': 'Kabwe',
        'chipata town': 'Chipata',
        'chingola town': 'Chingola',
        'mufulira town': 'Mufulira',
        'luanshya town': 'Luanshya',
        'livingstone town': 'Livingstone',
        'kasama town': 'Kasama',
        'solwezi town': 'Solwezi',
        'kapiri mposhi town': 'Kapiri Mposhi',
        'chililabombwe town': 'Chililabombwe'
    };
    
    const lowerName = normalized.toLowerCase();
    
    // First check variations
    if (variations[lowerName]) {
        return variations[lowerName];
    }
    
    // Then check exact match
    const exactMatch = zambianCities.find(city => 
        city.toLowerCase() === lowerName
    );
    
    if (exactMatch) {
        return exactMatch;
    }
    
    // Finally, check if it contains a city name
    for (const city of zambianCities) {
        if (lowerName.includes(city.toLowerCase())) {
            return city;
        }
    }
    
    return normalized;
}

// Enhanced: Update pickup location with precise address details
function updatePickupLocation(lat, lng) {
    // Remove existing pickup marker
    removeMarkerFromMap(passengerMap, pickupMarker);
    
    // Add new pickup marker
    pickupMarker = addMarkerToMap(passengerMap, [lng, lat], 'car', 'Pickup');
    
    // Get precise address
    getPreciseAddress(lat, lng, 'pickupLocation');
}

// Get precise address format (House number or building name, Road, Area, City)
function getPreciseAddress(lat, lng, elementId) {
    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1&accept-language=en`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Geocoding error: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data && data.address) {
                const address = data.address;
                const preciseAddress = buildPreciseAddress(address);
                document.getElementById(elementId).value = preciseAddress || `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            } else {
                document.getElementById(elementId).value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            }
        })
        .catch(error => {
            console.error('Reverse geocoding error:', error);
            document.getElementById(elementId).value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        });
}

// Build precise address without city, province, or country
function buildPreciseAddress(address) {
    const addressParts = [];
    
    // House number or building name
    if (address.house_number || address.housenumber) {
        addressParts.push(address.house_number || address.housenumber);
    }
    if (address.building) {
        if (!addressParts.length) addressParts.push(address.building);
    }
    
    // Road/Street
    if (address.road) {
        addressParts.push(address.road);
    }
    
    // Area/Suburb
    if (address.suburb) {
        addressParts.push(address.suburb);
    } else if (address.neighbourhood) {
        addressParts.push(address.neighbourhood);
    } else if (address.residential) {
        addressParts.push(address.residential);
    } else if (address.quarter) {
        addressParts.push(address.quarter);
    }
    
    // City
    if (address.city) {
        addressParts.push(address.city);
    } else if (address.town) {
        addressParts.push(address.town);
    } else if (address.village) {
        addressParts.push(address.village);
    }
    
    const filteredParts = addressParts.filter(part => part && part.trim().length > 0);
    
    if (filteredParts.length > 0) {
        return filteredParts.join(', ');
    }
    
    return null;
}

// Get full address for ride submission
function getFullAddress(lat, lng) {
    return new Promise((resolve, reject) => {
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=16&addressdetails=1&accept-language=en`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Full address geocoding error: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data && data.display_name) {
                    resolve(data.display_name);
                } else {
                    resolve(`${lat.toFixed(6)}, ${lng.toFixed(6)}`);
                }
            })
            .catch(error => {
                console.error('Full address geocoding error:', error);
                resolve(`${lat.toFixed(6)}, ${lng.toFixed(6)}`);
            });
    });
}

// Refresh passenger position
function refreshPassengerPosition() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            userLocation = { lat, lng };
            
            // Update map view
            updateMapView(passengerMap, [lng, lat], 16);
            
            // Update or create current location marker
            removeMarkerFromMap(passengerMap, currentLocationMarker);
            currentLocationMarker = addMarkerToMap(passengerMap, [lng, lat], 'car', 'You');
            
            // Update pickup location
            updatePickupLocation(lat, lng);
            
            // Detect current city
            determineCurrentCity(lat, lng).then(city => {
                console.log("Final detected city:", city);
                currentCity = city;
                if (currentScreen === 'home') {
                    showNotification(`Location detected in ${city}`);
                }
            }).catch(error => {
                console.error('City detection failed:', error);
                currentCity = "Unknown Location";
                if (currentScreen === 'home') {
                    showNotification('Unable to detect city. Using general location.');
                }
            });
            
            // Start continuous location tracking
            if (!locationWatchId) {
                startLocationTracking();
            }
            
            if (currentScreen === 'home') {
                showNotification('Location refreshed');
            }
        }, error => {
            console.error('Geolocation error:', error);
            handleGeolocationError(error);
        }, {
            enableHighAccuracy: true,
            timeout: 20000,
            maximumAge: 30000
        });
    } else {
        showNotification('Geolocation is not supported by this browser.');
        currentCity = "Unknown Location";
    }
}

// Handle geolocation errors
function handleGeolocationError(error) {
    let errorMessage = 'Unable to refresh location. ';
    
    switch(error.code) {
        case error.PERMISSION_DENIED:
            errorMessage += 'Please enable location services in your browser settings.';
            break;
        case error.POSITION_UNAVAILABLE:
            errorMessage += 'Location information is unavailable.';
            break;
        case error.TIMEOUT:
            errorMessage += 'Location request timed out. Please try again.';
            break;
        default:
            errorMessage += 'Please enable location services.';
    }
    
    if (currentScreen === 'home') {
        showNotification(errorMessage);
    }
    
    currentCity = currentCity || "Unknown Location";
}

// Start location tracking
function startLocationTracking() {
    if (navigator.geolocation && currentUser) {
        locationWatchId = navigator.geolocation.watchPosition(position => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            userLocation = { lat, lng };
            
            // Update database with passenger location
            database.ref('passengerLocations/' + currentUser.uid).set({
                latitude: lat,
                longitude: lng,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            
            // Update current location marker
            if (currentLocationMarker) {
                currentLocationMarker.setPosition(ol.proj.fromLonLat([lng, lat]));
            }
            
            // Update fare estimate if destination is set
            const destination = document.getElementById('destinationLocation').value;
            if (destination) {
                updateFareEstimate();
            }
        }, error => {
            console.error('Location tracking error:', error);
        }, {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 30000
        });
    }
}

// Calculate distance between two points
function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371e3; // Earth's radius in meters
    const 1 = lat1 * Math.PI / 180;
    const 2 = lat2 * Math.PI / 180;
    const  = (lat2 - lat1) * Math.PI / 180;
    const  = (lon2 - lon1) * Math.PI / 180;

    const a = Math.sin(/2) * Math.sin(/2) +
              Math.cos(1) * Math.cos(2) *
              Math.sin(/2) * Math.sin(/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

    return R * c; // Distance in meters
}

// Forward geocoding
function forwardGeocode(query) {
    return new Promise(resolve => {
        if (!query || query.length < 2) {
            resolve([]);
            return;
        }
        
        // First check common places
        const commonPlace = findCommonPlace(query.toLowerCase());
        if (commonPlace) {
            resolve([{
                display_name: commonPlace.name,
                lat: commonPlace.lat.toString(),
                lon: commonPlace.lng.toString()
            }]);
            return;
        }
        
        // Try with current city first
        let searchQuery = query;
        if (currentCity && currentCity !== "Unknown Location" && currentCity !== "Detecting...") {
            searchQuery = `${query}, ${currentCity}, Zambia`;
        } else {
            searchQuery = `${query}, Zambia`;
        }
        
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&limit=5&countrycodes=zm`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Forward geocoding error: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data && data.length > 0) {
                    resolve(data);
                } else {
                    // Try without city constraint
                    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`)
                        .then(response => response.json())
                        .then(fallbackData => {
                            resolve(fallbackData || []);
                        })
                        .catch(() => resolve([]));
                }
            })
            .catch(error => {
                console.error('Forward geocoding error:', error);
                resolve([]);
            });
    });
}

// Find common Zambian place
function findCommonPlace(query) {
    const queryLower = query.toLowerCase();
    
    // Check exact matches first
    for (const [placeName, placeInfo] of Object.entries(commonZambianPlaces)) {
        if (placeName.toLowerCase() === queryLower) {
            return { name: placeName, ...placeInfo };
        }
    }
    
    // Check partial matches
    for (const [placeName, placeInfo] of Object.entries(commonZambianPlaces)) {
        if (placeName.toLowerCase().includes(queryLower) || queryLower.includes(placeName.toLowerCase())) {
            return { name: placeName, ...placeInfo };
        }
    }
    
    // Check city names
    for (const city of zambianCities) {
        if (city.toLowerCase() === queryLower) {
            // Return the city center
            const boundary = cityBoundaries[city];
            if (boundary) {
                return { name: city, city: city, lat: boundary.lat, lng: boundary.lng };
            }
        }
    }
    
    return null;
}

// Update fare estimate
function updateFareEstimate() {
    const destination = document.getElementById('destinationLocation').value;
    
    if (!destination || destination.length < 3 || !userLocation) {
        document.getElementById('estimatedFare').textContent = 'K0.00';
        document.getElementById('etaDisplay').textContent = 'ETA: -- min';
        document.getElementById('requestRideBtn').disabled = true;
        return;
    }
    
    // Show calculating message
    document.getElementById('estimatedFare').textContent = 'Calculating...';
    document.getElementById('etaDisplay').textContent = 'Estimating...';
    
    forwardGeocode(destination).then(results => {
        if (results.length > 0) {
            const destLat = parseFloat(results[0].lat);
            const destLng = parseFloat(results[0].lon);
            
            const distance = calculateDistance(
                userLocation.lat, userLocation.lng,
                destLat, destLng
            );
            
            // Convert distance to kilometers
            const distanceKm = distance / 1000;
            
            // Get vehicle configuration
            const vehicleConfig = vehicleConfigs[selectedVehicleType] || vehicleConfigs.car;
            
            // Calculate base fare
            let baseFare = vehicleConfig.baseFare;
            
            if (distanceKm > 0) {
                // Add distance-based fare: K5 per km
                baseFare += Math.ceil(distanceKm * 5);
            }
            
            // Apply vehicle multiplier
            baseFare = baseFare * vehicleConfig.multiplier;
            
            // Apply promo code discount if any
            if (appliedPromoCode) {
                baseFare = baseFare * 0.8; // 20% discount for promo codes
            }
            
            // Ensure minimum fare
            baseFare = Math.max(15, baseFare);
            
            // Update UI
            document.getElementById('estimatedFare').textContent = `K${baseFare.toFixed(2)}`;
            
            // Calculate ETA: Assume average speed of 30km/h in city
            const etaMinutes = Math.ceil((distanceKm / 30) * 60);
            document.getElementById('etaDisplay').textContent = `ETA: ${etaMinutes} min`;
            
            document.getElementById('requestRideBtn').disabled = false;
            
            // Store fare for later use
            rideFare = baseFare;
            
            console.log(`Fare calculated: K${baseFare.toFixed(2)} for ${distanceKm.toFixed(1)}km, ETA: ${etaMinutes}min`);
            
            // Update destination marker
            updateDestinationMarker(destLat, destLng, results[0].display_name);
            
            // Draw route
            if (userLocation) {
                drawRouteOnMap(
                    passengerMap,
                    window.routeVectorLayer,
                    [userLocation.lng, userLocation.lat],
                    [destLng, destLat]
                );
            }
        } else {
            document.getElementById('estimatedFare').textContent = 'K0.00';
            document.getElementById('etaDisplay').textContent = 'ETA: -- min';
            document.getElementById('requestRideBtn').disabled = true;
        }
    }).catch(error => {
        console.error('Error calculating fare:', error);
        document.getElementById('estimatedFare').textContent = 'K0.00';
        document.getElementById('etaDisplay').textContent = 'ETA: -- min';
        document.getElementById('requestRideBtn').disabled = true;
    });
}

// Update destination marker
function updateDestinationMarker(lat, lng, name) {
    // Remove existing destination marker
    removeMarkerFromMap(passengerMap, destinationMarker);
    
    // Add new destination marker
    destinationMarker = addMarkerToMap(passengerMap, [lng, lat], 'car', 'Destination');
}

// Load scheduled rides
function loadScheduledRides(uid) {
    database.ref('scheduledRides').orderByChild('passengerId').equalTo(uid).once('value')
        .then(snapshot => {
            const rides = snapshot.val();
            if (rides) {
                scheduledRides = Object.keys(rides).map(rideId => ({
                    id: rideId,
                    ...rides[rideId]
                }));
                
                // Filter active scheduled rides (not cancelled or completed)
                const activeScheduled = scheduledRides.filter(ride => 
                    ride.status === 'scheduled' || ride.status === 'pending'
                );
                
                if (activeScheduled.length > 0) {
                    // Set up listeners for each scheduled ride
                    activeScheduled.forEach(ride => {
                        setupScheduledRideTimer(ride);
                    });
                }
            }
        })
        .catch(error => {
            console.error('Error loading scheduled rides:', error);
        });
}

// Setup scheduled ride timer
function setupScheduledRideTimer(ride) {
    const scheduledTime = new Date(ride.scheduledTime);
    const now = new Date();
    const timeDiff = scheduledTime.getTime() - now.getTime();
    
    if (timeDiff > 0) {
        // Schedule is in the future
        const timerId = setTimeout(() => {
            executeScheduledRide(ride);
        }, timeDiff);
        
        scheduledTimers[ride.id] = timerId;
        
        // Schedule notification 5 minutes before
        if (timeDiff > 5 * 60 * 1000) {
            setTimeout(() => {
                showNotification(`Your scheduled ride to ${ride.destination} is in 5 minutes!`);
            }, timeDiff - (5 * 60 * 1000));
        }
    } else {
        // Schedule is in the past, mark as expired
        database.ref('scheduledRides/' + ride.id).update({
            status: 'expired'
        });
    }
}

// Execute scheduled ride when timer finishes
function executeScheduledRide(ride) {
    // Convert scheduled ride to active ride
    const rideId = database.ref().child('rides').push().key;
    
    const rideRequest = {
        id: rideId,
        passengerId: ride.passengerId,
        passengerName: ride.passengerName,
        passengerPhone: ride.passengerPhone,
        pickupLocation: ride.pickupLocation,
        pickupDisplayLocation: ride.pickupDisplayLocation,
        destination: ride.destination,
        pickupLat: ride.pickupLat,
        pickupLng: ride.pickupLng,
        destLat: ride.destLat,
        destLng: ride.destLng,
        rideType: ride.rideType || 'car',
        fare: ride.fare,
        distance: ride.distance,
        status: 'requested',
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        updatedAt: firebase.database.ServerValue.TIMESTAMP,
        paymentMethod: ride.paymentMethod || 'cash',
        isScheduled: true,
        scheduledRideId: ride.id,
        currentCity: currentCity
    };
    
    // Add package details if this was a scheduled delivery
    if (ride.packageDetails) {
        rideRequest.packageDetails = ride.packageDetails;
    }
    
    // Add recipient details if this was scheduled for someone else
    if (ride.recipientDetails) {
        rideRequest.orderForSomeone = ride.recipientDetails;
    }
    
    database.ref('rides/' + rideId).set(rideRequest)
        .then(() => {
            // Update scheduled ride status
            database.ref('scheduledRides/' + ride.id).update({
                status: 'executed',
                executedAt: firebase.database.ServerValue.TIMESTAMP
            });
            
            // Start the ride request process
            currentRide = rideRequest;
            updateUIForActiveRide();
            
            document.getElementById('searchingAnimation').style.display = 'flex';
            document.getElementById('rideStatus').style.display = 'flex';
            document.getElementById('statusDot').className = 'status-dot searching';
            document.getElementById('statusText').textContent = 'Searching for driver';
            
            if (sosConfig && sosConfig.contact1) {
                document.getElementById('sosButton').style.display = 'flex';
            }
            
            showNotification('Your scheduled ride has started! Searching for driver...');
            
            listenForDriverAssignment(rideId);
        })
        .catch(error => {
            console.error('Error executing scheduled ride:', error);
            showNotification('Error starting scheduled ride. Please try again.');
        });
}

// Check for active ride when app loads
function checkActiveRide(uid) {
    console.log('Checking for active ride for user:', uid);
    
    database.ref('rides').orderByChild('passengerId').equalTo(uid).once('value')
        .then(snapshot => {
            const rides = snapshot.val();
            if (rides) {
                const rideEntries = Object.entries(rides);
                console.log('Found rides:', rideEntries.length);
                
                for (const [rideId, ride] of rideEntries) {
                    console.log(`Checking ride ${rideId}:`, ride.status);
                    
                    // Check for active rides (not completed or cancelled)
                    if (ride.status !== 'completed' && ride.status !== 'cancelled' && ride.status !== 'requested') {
                        console.log('Found active ride to restore:', rideId);
                        restoreActiveRide(rideId, ride);
                        return;
                    }
                    
                    // Also check for rides that have a driver assigned but are still requested
                    if (ride.status === 'requested' && ride.driverId) {
                        console.log('Found requested ride with driver:', rideId);
                        restoreActiveRide(rideId, ride);
                        return;
                    }
                }
                
                console.log('No active rides found');
            } else {
                console.log('No rides found for user');
            }
        })
        .catch(error => {
            console.error('Error checking active ride:', error);
        });
}

// Restore active ride after app refresh
function restoreActiveRide(rideId, ride) {
    console.log('Restoring active ride:', rideId);
    
    currentRide = {
        id: rideId,
        ...ride
    };
    
    updateUIForActiveRide();
    
    if (ride.status === 'requested' && !ride.driverId) {
        document.getElementById('searchingAnimation').style.display = 'flex';
        document.getElementById('rideStatus').style.display = 'flex';
        document.getElementById('statusDot').className = 'status-dot searching';
        document.getElementById('statusText').textContent = 'Searching for driver';
        
        listenForDriverAssignment(rideId);
    } 
    else if (ride.driverId && (ride.status === 'accepted' || ride.status === 'arrived' || ride.status === 'started' || ride.status === 'picked_up')) {
        console.log('Ride has driver, updating UI');
        handleDriverAssignment(ride);
        updateRideStatusDisplay(ride.status);
        
        if (ride.driverId) {
            trackDriverLocation(ride.driverId);
        }
        
        startDriverMessageListener(rideId);
        
        if (sosConfig && sosConfig.contact1) {
            document.getElementById('sosButton').style.display = 'flex';
        }
    }
    
    activeRideRestored = true;
    showNotification('Active ride restored');
}

// Load SOS configuration
function loadSOSConfig(uid) {
    database.ref('sosConfig/' + uid).once('value')
        .then(snapshot => {
            sosConfig = snapshot.val();
            if (sosConfig) {
                document.getElementById('emergencyContact1').value = sosConfig.contact1 || '';
                document.getElementById('emergencyContact2').value = sosConfig.contact2 || '';
                document.getElementById('sosMessage').value = sosConfig.message || 'I need help! My current location and ride details will be shared with you.';
            }
        })
        .catch(error => {
            console.error('Error loading SOS config:', error);
        });
}

// Set up real-time wallet balance listener
function setupWalletBalanceListener(uid) {
    if (walletBalanceListener) {
        walletBalanceListener();
    }
    
    walletBalanceListener = database.ref('users/' + uid + '/walletBalance').on('value', snapshot => {
        const newBalance = snapshot.val() || 0;
        if (newBalance !== walletBalance) {
            walletBalance = newBalance;
            updateWalletBalanceUI();
            showNotification(`Wallet balance updated: K${walletBalance.toFixed(2)}`);
        }
    }, error => {
        console.error('Error listening to wallet balance:', error);
    });
}

// Update wallet balance across all UI elements
function updateWalletBalanceUI() {
    document.getElementById('walletBalance').textContent = `K${walletBalance.toFixed(2)}`;
    document.getElementById('accountBalance').textContent = `K${walletBalance.toFixed(2)}`;
    document.getElementById('paymentWalletBalance').textContent = `Balance: K${walletBalance.toFixed(2)}`;
}

// Enhanced search function
function searchPlacesEnhanced(query, searchType = 'destination') {
    if (!query || query.length < 2) {
        hideSearchSuggestions(searchType);
        return;
    }
    
    const suggestionsContainer = document.getElementById(`${searchType}Suggestions`);
    const cacheKey = `${searchType}:${query.toLowerCase()}`;
    
    // Check cache first
    const cached = searchCache.get(cacheKey);
    if (cached && (Date.now() - cached.timestamp) < CACHE_TTL) {
        console.log('Using cached results for:', query);
        displaySearchResults(cached.results, searchType);
        return;
    }
    
    // Clear any existing timeout
    if (searchDebounceTimers[searchType]) {
        clearTimeout(searchDebounceTimers[searchType]);
    }
    
    // Show loading state
    suggestionsContainer.innerHTML = '<div class="loading-text">Searching...</div>';
    suggestionsContainer.style.display = 'block';
    
    // Debounce search to prevent excessive API calls
    searchDebounceTimers[searchType] = setTimeout(() => {
        const processedQuery = preprocessSearchQuery(query);
        
        // First, check if it's a known common place
        const commonPlace = findCommonPlace(processedQuery);
        if (commonPlace) {
            console.log('Found common place:', commonPlace.name);
            const enhancedResults = [{
                ...commonPlace,
                display_name: commonPlace.name,
                lat: commonPlace.lat.toString(),
                lon: commonPlace.lng.toString(),
                displayLat: commonPlace.lat,
                displayLon: commonPlace.lng,
                distance: userLocation ? calculateDistance(
                    userLocation.lat, userLocation.lng,
                    commonPlace.lat, commonPlace.lng
                ) : 0,
                city: commonPlace.city,
                isCurrentCity: commonPlace.city === currentCity,
                priority: 0,
                relevanceScore: 100,
                displayName: commonPlace.name
            }];
            
            searchCache.set(cacheKey, {
                results: enhancedResults,
                timestamp: Date.now()
            });
            
            displaySearchResults(enhancedResults, searchType);
            return;
        }
        
        // Build search query with current city priority
        let searchQueries = [];
        
        // Query 1: Search within current city if we have one
        if (currentCity && currentCity !== "Unknown Location" && currentCity !== "Detecting...") {
            searchQueries.push(`${processedQuery}, ${currentCity}, Zambia`);
        }
        
        // Query 2: Search within Zambia broadly
        searchQueries.push(`${processedQuery}, Zambia`);
        
        // Query 3: Search without country restriction (fallback)
        searchQueries.push(processedQuery);
        
        // Try each query in order
        trySearchQueries(searchQueries, 0, processedQuery, searchType, cacheKey);
        
    }, 400); // 400ms debounce
}

// Try multiple search queries
function trySearchQueries(queries, index, originalQuery, searchType, cacheKey) {
    if (index >= queries.length) {
        showNoResultsMessage(originalQuery, searchType);
        return;
    }
    
    const searchQuery = queries[index];
    console.log(`Trying search query ${index + 1}/${queries.length}: ${searchQuery}`);
    
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&limit=15&dedupe=1&countrycodes=zm&addressdetails=1`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Search API error: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data && data.length > 0) {
                const enhancedResults = data
                    .filter(place => place.display_name && place.lat && place.lon)
                    .map(place => {
                        const distance = userLocation ? calculateDistance(
                            userLocation.lat, userLocation.lng,
                            parseFloat(place.lat), parseFloat(place.lon)
                        ) : 0;
                        
                        const placeCity = extractCityFromPlace(place) || currentCity || "Unknown";
                        
                        return {
                            ...place,
                            displayLat: parseFloat(place.lat),
                            displayLon: parseFloat(place.lon),
                            distance,
                            city: placeCity,
                            isCurrentCity: placeCity === currentCity,
                            priority: placeCity === currentCity ? 1 : 2,
                            relevanceScore: calculateRelevanceScore(place, originalQuery, placeCity),
                            displayName: formatDisplayName(place.display_name, placeCity)
                        };
                    })
                    .sort((a, b) => {
                        // Sort by relevance score first
                        if (b.relevanceScore !== a.relevanceScore) {
                            return b.relevanceScore - a.relevanceScore;
                        }
                        // Then by distance
                        if (userLocation) {
                            return a.distance - b.distance;
                        }
                        // Then by whether it's in current city
                        if (a.isCurrentCity !== b.isCurrentCity) {
                            return a.isCurrentCity ? -1 : 1;
                        }
                        return 0;
                    });
                
                // Cache the results
                searchCache.set(cacheKey, {
                    results: enhancedResults,
                    timestamp: Date.now()
                });
                
                displaySearchResults(enhancedResults, searchType);
            } else {
                // Try next query
                trySearchQueries(queries, index + 1, originalQuery, searchType, cacheKey);
            }
        })
        .catch(error => {
            console.error('Search error:', error);
            // Try next query
            trySearchQueries(queries, index + 1, originalQuery, searchType, cacheKey);
        });
}

// Calculate relevance score for search results
function calculateRelevanceScore(place, query, city) {
    let score = 0;
    const placeName = (place.display_name || '').toLowerCase();
    const queryLower = query.toLowerCase();
    
    // Exact match bonus
    if (placeName.includes(queryLower)) {
        score += 20;
    }
    
    // Word-by-word matching
    const queryWords = queryLower.split(' ');
    const placeWords = placeName.split(' ');
    
    queryWords.forEach(word => {
        if (word.length > 2) {
            if (placeName.includes(word)) {
                score += 10;
            }
            // Check for word boundaries
            if (placeName.includes(` ${word} `) || placeName.startsWith(`${word} `) || placeName.endsWith(` ${word}`)) {
                score += 5;
            }
        }
    });
    
    // City matching bonus
    if (city === currentCity) {
        score += 15;
    }
    
    // Type bonuses
    if (place.type === 'administrative' || place.class === 'boundary') {
        score -= 5;
    }
    
    if (place.type === 'amenity' || place.class === 'shop' || place.type === 'tourism') {
        score += 8;
    }
    
    // Importance from Nominatim
    if (place.importance) {
        score += place.importance * 10;
    }
    
    // Distance penalty if too far
    if (userLocation) {
        const distance = calculateDistance(
            userLocation.lat, userLocation.lng,
            parseFloat(place.lat), parseFloat(place.lon)
        );
        if (distance > 50000) {
            score -= 10;
        } else if (distance > 100000) {
            score -= 20;
        } else {
            // Closer is better
            score += Math.max(0, 10 - (distance / 5000));
        }
    }
    
    return Math.max(0, score);
}

// Extract city from place data
function extractCityFromPlace(place) {
    if (place.address) {
        const cityFromAddress = extractCityFromAddress(place.address);
        if (cityFromAddress) return cityFromAddress;
    }
    
    return extractCityFromDisplayName(place.display_name);
}

// Format display name for better UX
function formatDisplayName(fullName, city) {
    if (!fullName) return 'Unknown Location';
    
    const parts = fullName.split(',');
    const relevantParts = [];
    
    // Keep the first 2-3 parts which usually contain the specific location
    for (let i = 0; i < Math.min(3, parts.length); i++) {
        const part = parts[i].trim();
        if (part) {
            relevantParts.push(part);
        }
    }
    
    return relevantParts.join(', ') || fullName;
}

// Preprocess search query
function preprocessSearchQuery(query) {
    let processed = query.trim();
    
    // Remove common filler words
    const stopWords = ['the', 'a', 'an', 'in', 'on', 'at', 'to', 'for', 'of', 'and', 'or', 'but'];
    stopWords.forEach(word => {
        const regex = new RegExp(`\\b${word}\\b`, 'gi');
        processed = processed.replace(regex, '');
    });
    
    processed = processed.replace(/\s+/g, ' ').trim();
    
    // Handle Zambian place name variations
    const zambianVariations = {
        'unza': 'University of Zambia',
        'cbu': 'Copperbelt University',
        'manda': 'Manda Hill',
        'levy': 'Levy Mall',
        'eastpark': 'East Park Mall',
        'arcades': 'Arcades Shopping Mall',
        'vicfalls': 'Victoria Falls'
    };
    
    Object.keys(zambianVariations).forEach(variation => {
        if (processed.toLowerCase().includes(variation)) {
            processed = processed.toLowerCase().replace(variation, zambianVariations[variation].toLowerCase());
        }
    });
    
    // Expand abbreviations
    const abbreviations = {
        'st': 'street',
        'ave': 'avenue',
        'rd': 'road',
        'blvd': 'boulevard',
        'hwy': 'highway',
        'ln': 'lane',
        'dr': 'drive',
        'hosp': 'hospital',
        'univ': 'university',
        'sch': 'school'
    };
    
    Object.keys(abbreviations).forEach(abbr => {
        const regex = new RegExp(`\\b${abbr}\\b`, 'gi');
        processed = processed.replace(regex, abbreviations[abbr]);
    });
    
    return processed;
}

// Display search results
function displaySearchResults(results, searchType) {
    const suggestionsContainer = document.getElementById(`${searchType}Suggestions`);
    
    suggestionsContainer.innerHTML = '';
    
    updateSearchResultsCache(results, searchType);
    
    if (results.length === 0) {
        showNoResultsMessage('', searchType);
        return;
    }
    
    const uniqueResults = removeDuplicatePlaces(results).slice(0, 10);
    
    uniqueResults.forEach((result, index) => {
        const suggestionItem = document.createElement('div');
        suggestionItem.className = 'suggestion-item';
        if (index === 0) suggestionItem.classList.add('first-result');
        
        const placeType = getPlaceType(result);
        const placeIcon = getPlaceIcon(placeType);
        
        const cityBadge = result.isCurrentCity ? '' : 
            `<span class="city-badge" style="font-size: 0.6rem; background: var(--light-gray); padding: 2px 4px; border-radius: 4px; margin-left: 4px;">${result.city}</span>`;
        
        const distanceText = userLocation && result.distance > 0 ? 
            `${(result.distance / 1000).toFixed(1)} km away` : '';
        
        const displayName = result.displayName || result.display_name;
        
        suggestionItem.innerHTML = `
            <div class="suggestion-icon">${placeIcon}</div>
            <div class="suggestion-details">
                <div class="suggestion-name">
                    ${displayName}
                    ${cityBadge}
                </div>
                <div class="suggestion-address">${getShortAddress(result.display_name)}</div>
                <div class="suggestion-distance">${distanceText}</div>
            </div>
            ${result.isCurrentCity ? '<div class="current-city-indicator" style="font-size: 0.6rem; color: var(--primary-orange);"> Current City</div>' : ''}
        `;
        
        suggestionItem.addEventListener('click', function() {
            handleSearchResultSelection(result, searchType);
        });
        
        suggestionsContainer.appendChild(suggestionItem);
    });
    
    suggestionsContainer.style.display = 'block';
}

// Get short address for display
function getShortAddress(fullAddress) {
    if (!fullAddress) return '';
    
    const parts = fullAddress.split(',');
    return parts.slice(0, Math.min(2, parts.length)).join(', ');
}

// Remove duplicate places
function removeDuplicatePlaces(places) {
    const seen = new Set();
    const uniquePlaces = [];
    
    places.forEach(place => {
        const coordKey = `${place.lat}-${place.lon}`;
        const nameKey = (place.display_name || '').substring(0, 30).toLowerCase().replace(/[^a-z0-9]/g, '');
        const uniqueKey = `${coordKey}-${nameKey}`;
        
        if (!seen.has(uniqueKey)) {
            seen.add(uniqueKey);
            uniquePlaces.push(place);
        }
    });
    
    return uniquePlaces;
}

// Update search results cache
function updateSearchResultsCache(results, searchType) {
    switch(searchType) {
        case 'destination': 
            destinationSearchResults = results;
            break;
        case 'pickup':
            pickupSearchResults = results;
            break;
        case 'recipientPickup':
            recipientPickupSearchResults = results;
            break;
        case 'recipientDestination':
            destinationSearchResults = results;
            break;
        case 'shopLocation':
            shopLocationSearchResults = results;
            break;
        case 'deliveryDestination':
            deliveryDestinationSearchResults = results;
            break;
        case 'schedulePickup':
            schedulePickupSearchResults = results;
            break;
        case 'scheduleDestination':
            scheduleDestinationSearchResults = results;
            break;
        case 'scheduleDeliveryPickup':
            scheduleDeliveryPickupSearchResults = results;
            break;
        case 'scheduleDeliveryDestination':
            scheduleDeliveryDestinationSearchResults = results;
            break;
        case 'scheduleSomeonePickup':
            scheduleSomeonePickupSearchResults = results;
            break;
        case 'scheduleSomeoneDestination':
            scheduleSomeoneDestinationSearchResults = results;
            break;
    }
}

// Handle search result selection
function handleSearchResultSelection(result, searchType) {
    const inputField = document.getElementById(searchType + (searchType === 'pickup' ? 'Location' : 
                                 searchType === 'destination' ? 'Location' :
                                 searchType === 'recipientPickup' ? 'Location' :
                                 searchType === 'recipientDestination' ? 'Location' :
                                 searchType === 'shopLocation' ? '' :
                                 searchType === 'deliveryDestination' ? '' :
                                 searchType === 'schedulePickup' ? 'Location' :
                                 searchType === 'scheduleDestination' ? 'Location' :
                                 searchType === 'scheduleDeliveryPickup' ? '' :
                                 searchType === 'scheduleDeliveryDestination' ? '' :
                                 searchType === 'scheduleSomeonePickup' ? '' :
                                 searchType === 'scheduleSomeoneDestination' ? '' : ''));
    
    if (inputField) {
        inputField.value = result.display_name;
    }
    
    hideSearchSuggestions(searchType);
    
    switch(searchType) {
        case 'destination':
            updateFareEstimate();
            updateDestinationMarker(
                result.displayLat, 
                result.displayLon, 
                result.display_name
            );
            
            if (userLocation) {
                drawRouteOnMap(
                    passengerMap,
                    window.routeVectorLayer,
                    [userLocation.lng, userLocation.lat],
                    [result.displayLon, result.displayLat]
                );
            }
            
            selectedDestination = result;
            document.getElementById('requestRideBtn').disabled = false;
            showNotification(`Destination set to ${result.displayName}`);
            break;
            
        case 'pickup':
            updateManualPickupLocation(result.displayLat, result.displayLon, result.display_name);
            showNotification(`Pickup location set to ${result.displayName}`);
            break;
            
        case 'recipientPickup':
            calculateRecipientDeliveryFee();
            showNotification(`Recipient pickup set to ${result.displayName}`);
            break;
            
        case 'recipientDestination':
            calculateRecipientDeliveryFee();
            showNotification(`Recipient destination set to ${result.displayName}`);
            break;
            
        case 'shopLocation':
            calculateExpressDeliveryFee();
            showNotification(`Shop location set to ${result.displayName}`);
            break;
            
        case 'deliveryDestination':
            calculateExpressDeliveryFee();
            showNotification(`Delivery destination set to ${result.displayName}`);
            break;
            
        case 'schedulePickup':
            calculateScheduleRideFare('ride-now');
            showNotification(`Schedule pickup set to ${result.displayName}`);
            break;
            
        case 'scheduleDestination':
            calculateScheduleRideFare('ride-now');
            showNotification(`Schedule destination set to ${result.displayName}`);
            break;
            
        case 'scheduleDeliveryPickup':
            calculateScheduleRideFare('delivery');
            showNotification(`Delivery pickup set to ${result.displayName}`);
            break;
            
        case 'scheduleDeliveryDestination':
            calculateScheduleRideFare('delivery');
            showNotification(`Delivery destination set to ${result.displayName}`);
            break;
            
        case 'scheduleSomeonePickup':
            calculateScheduleRideFare('schedule-for-someone');
            showNotification(`Recipient pickup set to ${result.displayName}`);
            break;
            
        case 'scheduleSomeoneDestination':
            calculateScheduleRideFare('schedule-for-someone');
            showNotification(`Recipient destination set to ${result.displayName}`);
            break;
    }
}

// Hide search suggestions
function hideSearchSuggestions(searchType) {
    const suggestionsContainer = document.getElementById(`${searchType}Suggestions`);
    if (suggestionsContainer) {
        suggestionsContainer.style.display = 'none';
    }
    
    if (searchDebounceTimers[searchType]) {
        clearTimeout(searchDebounceTimers[searchType]);
        searchDebounceTimers[searchType] = null;
    }
}

// Hide all search suggestions
function hideAllSearchSuggestions() {
    const searchTypes = [
        'destination', 'pickup', 'recipientPickup', 
        'recipientDestination', 'shopLocation', 'deliveryDestination',
        'schedulePickup', 'scheduleDestination', 'scheduleDeliveryPickup',
        'scheduleDeliveryDestination', 'scheduleSomeonePickup', 'scheduleSomeoneDestination'
    ];
    
    searchTypes.forEach(type => {
        hideSearchSuggestions(type);
    });
}

// Show no results message
function showNoResultsMessage(query = '', searchType = 'destination') {
    const suggestionsContainer = document.getElementById(`${searchType}Suggestions`);
    
    if (suggestionsContainer) {
        suggestionsContainer.innerHTML = '<div class="no-places">No places found. Try a different search term.</div>';
    }
}

// Update manual pickup location
function updateManualPickupLocation(lat, lng, name) {
    // Remove existing markers
    removeMarkerFromMap(passengerMap, currentLocationMarker);
    removeMarkerFromMap(passengerMap, pickupMarker);
    
    // Add new pickup marker
    pickupMarker = addMarkerToMap(passengerMap, [lng, lat], 'car', 'Pickup');
    
    userLocation = { lat, lng };
    
    const destination = document.getElementById('destinationLocation').value;
    if (destination) {
        updateFareEstimate();
        
        forwardGeocode(destination).then(results => {
            if (results.length > 0) {
                const destLat = parseFloat(results[0].lat);
                const destLng = parseFloat(results[0].lon);
                drawRouteOnMap(
                    passengerMap,
                    window.routeVectorLayer,
                    [lng, lat],
                    [destLng, destLat]
                );
            }
        });
    }
    
    updateMapView(passengerMap, [lng, lat], 16);
}

// Get place type
function getPlaceType(place) {
    if (place.type === 'restaurant' || place.class === 'amenity' && place.type === 'restaurant') {
        return 'restaurant';
    } else if (place.type === 'cafe' || place.class === 'amenity' && place.type === 'cafe') {
        return 'cafe';
    } else if (place.type === 'bar' || place.class === 'amenity' && place.type === 'bar') {
        return 'bar';
    } else if (place.type === 'pub' || place.class === 'amenity' && place.type === 'pub') {
        return 'pub';
    } else if (place.type === 'fast_food' || place.class === 'amenity' && place.type === 'fast_food') {
        return 'fast_food';
    } else if (place.type === 'bank' || place.class === 'amenity' && place.type === 'bank') {
        return 'bank';
    } else if (place.type === 'atm' || place.class === 'amenity' && place.type === 'atm') {
        return 'atm';
    } else if (place.type === 'hospital' || place.class === 'amenity' && place.type === 'hospital') {
        return 'hospital';
    } else if (place.type === 'pharmacy' || place.class === 'amenity' && place.type === 'pharmacy') {
        return 'pharmacy';
    } else if (place.type === 'school' || place.class === 'amenity' && place.type === 'school') {
        return 'school';
    } else if (place.type === 'university' || place.class === 'amenity' && place.type === 'university') {
        return 'university';
    } else if (place.type === 'library' || place.class === 'amenity' && place.type === 'library') {
        return 'library';
    } else if (place.type === 'cinema' || place.class === 'amenity' && place.type === 'cinema') {
        return 'cinema';
    } else if (place.type === 'theatre' || place.class === 'amenity' && place.type === 'theatre') {
        return 'theatre';
    } else if (place.type === 'museum' || place.class === 'amenity' && place.type === 'museum') {
        return 'museum';
    } else if (place.type === 'hotel' || place.class === 'tourism' && place.type === 'hotel') {
        return 'hotel';
    } else if (place.type === 'supermarket' || place.class === 'shop' && place.type === 'supermarket') {
        return 'supermarket';
    } else if (place.type === 'mall' || place.class === 'shop' && place.type === 'mall') {
        return 'mall';
    } else if (place.type === 'clothes' || place.class === 'shop' && place.type === 'clothes') {
        return 'clothes';
    } else if (place.type === 'fuel' || place.class === 'amenity' && place.type === 'fuel') {
        return 'fuel';
    } else if (place.type === 'parking' || place.class === 'amenity' && place.type === 'parking') {
        return 'parking';
    } else if (place.type === 'bus_station' || place.class === 'amenity' && place.type === 'bus_station') {
        return 'bus_station';
    } else if (place.type === 'taxi' || place.class === 'amenity' && place.type === 'taxi') {
        return 'taxi';
    } else if (place.type === 'police' || place.class === 'amenity' && place.type === 'police') {
        return 'police';
    } else if (place.type === 'market' || place.class === 'amenity' && place.type === 'marketplace') {
        return 'market';
    } else if (place.type === 'post_office' || place.class === 'amenity' && place.type === 'post_office') {
        return 'post_office';
    } else if (place.type === 'place_of_worship' || place.class === 'amenity' && place.type === 'place_of_worship') {
        return 'place_of_worship';
    } else if (place.type === 'stadium' || place.class === 'leisure' && place.type === 'stadium') {
        return 'stadium';
    } else if (place.type === 'park' || place.class === 'leisure' && place.type === 'park') {
        return 'park';
    } else if (place.type === 'monument' || place.class === 'historic' && place.type === 'monument') {
        return 'monument';
    } else if (place.type === 'castle' || place.class === 'historic' && place.type === 'castle') {
        return 'castle';
    } else {
        return 'place';
    }
}

// Get place icon
function getPlaceIcon(placeType) {
    const icons = {
        'restaurant': '',
        'cafe': '',
        'bar': '',
        'pub': '',
        'fast_food': '',
        'bank': '',
        'atm': '',
        'hospital': '',
        'pharmacy': '',
        'school': '',
        'university': '',
        'library': '',
        'cinema': '',
        'theatre': '',
        'museum': '',
        'hotel': '',
        'supermarket': '',
        'mall': '',
        'clothes': '',
        'fuel': '',
        'parking': '',
        'bus_station': '',
        'taxi': '',
        'police': '',
        'market': '',
        'post_office': '',
        'place_of_worship': '',
        'stadium': '',
        'park': '',
        'monument': '',
        'castle': ''
    };
    
    return icons[placeType] || '';
}

// Setup search input listeners
function setupSearchInputListeners() {
    const searchConfigs = [
        { type: 'destination', inputId: 'destinationLocation', suggestionsId: 'destinationSuggestions' },
        { type: 'pickup', inputId: 'pickupLocation', suggestionsId: 'pickupSuggestions' },
        { type: 'recipientPickup', inputId: 'recipientPickupLocation', suggestionsId: 'recipientPickupSuggestions' },
        { type: 'recipientDestination', inputId: 'recipientDestinationLocation', suggestionsId: 'recipientDestinationSuggestions' },
        { type: 'shopLocation', inputId: 'shopLocation', suggestionsId: 'shopLocationSuggestions' },
        { type: 'deliveryDestination', inputId: 'deliveryDestination', suggestionsId: 'deliveryDestinationSuggestions' },
        { type: 'schedulePickup', inputId: 'schedulePickupLocation', suggestionsId: 'schedulePickupSuggestions' },
        { type: 'scheduleDestination', inputId: 'scheduleDestinationLocation', suggestionsId: 'scheduleDestinationSuggestions' },
        { type: 'scheduleDeliveryPickup', inputId: 'scheduleDeliveryPickup', suggestionsId: 'scheduleDeliveryPickupSuggestions' },
        { type: 'scheduleDeliveryDestination', inputId: 'scheduleDeliveryDestination', suggestionsId: 'scheduleDeliveryDestinationSuggestions' },
        { type: 'scheduleSomeonePickup', inputId: 'scheduleSomeonePickup', suggestionsId: 'scheduleSomeonePickupSuggestions' },
        { type: 'scheduleSomeoneDestination', inputId: 'scheduleSomeoneDestination', suggestionsId: 'scheduleSomeoneDestinationSuggestions' }
    ];
    
    searchConfigs.forEach(config => {
        setupSearchInputListener(config.type, config.inputId, config.suggestionsId);
    });
}

// Setup individual search input listener
function setupSearchInputListener(searchType, inputId, suggestionsId) {
    let lastQuery = '';
    const inputField = document.getElementById(inputId);
    
    if (!inputField) return;
    
    inputField.addEventListener('input', function() {
        const query = this.value.trim();
        
        if (searchDebounceTimers[searchType]) {
            clearTimeout(searchDebounceTimers[searchType]);
        }
        
        if (query.length >= 2 && query !== lastQuery) {
            searchDebounceTimers[searchType] = setTimeout(() => {
                lastQuery = query;
                searchPlacesEnhanced(query, searchType);
            }, 400);
        } else if (query.length < 2) {
            hideSearchSuggestions(searchType);
            lastQuery = '';
        }
    });
    
    inputField.addEventListener('focus', function() {
        const query = this.value.trim();
        const cachedResults = getCachedSearchResults(searchType);
        
        if (query.length >= 2 && cachedResults.length > 0) {
            displaySearchResults(cachedResults, searchType);
        } else if (query.length >= 2) {
            searchPlacesEnhanced(query, searchType);
        }
    });
    
    inputField.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            hideSearchSuggestions(searchType);
        } else if (e.key === 'Enter') {
            hideSearchSuggestions(searchType);
            const cachedResults = getCachedSearchResults(searchType);
            if (cachedResults.length > 0) {
                handleSearchResultSelection(cachedResults[0], searchType);
            }
        }
    });
}

// Get cached search results
function getCachedSearchResults(searchType) {
    switch(searchType) {
        case 'destination': return destinationSearchResults;
        case 'pickup': return pickupSearchResults;
        case 'recipientPickup': return recipientPickupSearchResults;
        case 'recipientDestination': return destinationSearchResults;
        case 'shopLocation': return shopLocationSearchResults;
        case 'deliveryDestination': return deliveryDestinationSearchResults;
        case 'schedulePickup': return schedulePickupSearchResults;
        case 'scheduleDestination': return scheduleDestinationSearchResults;
        case 'scheduleDeliveryPickup': return scheduleDeliveryPickupSearchResults;
        case 'scheduleDeliveryDestination': return scheduleDeliveryDestinationSearchResults;
        case 'scheduleSomeonePickup': return scheduleSomeonePickupSearchResults;
        case 'scheduleSomeoneDestination': return scheduleSomeoneDestinationSearchResults;
        default: return [];
    }
}

// Calculate schedule ride fare
function calculateScheduleRideFare(scheduleType) {
    let pickupLocation, destinationLocation;
    
    switch(scheduleType) {
        case 'ride-now':
            pickupLocation = document.getElementById('schedulePickupLocation').value;
            destinationLocation = document.getElementById('scheduleDestinationLocation').value;
            break;
        case 'delivery':
            pickupLocation = document.getElementById('scheduleDeliveryPickup').value;
            destinationLocation = document.getElementById('scheduleDeliveryDestination').value;
            break;
        case 'schedule-for-someone':
            pickupLocation = document.getElementById('scheduleSomeonePickup').value;
            destinationLocation = document.getElementById('scheduleSomeoneDestination').value;
            break;
        default:
            return;
    }
    
    if (!pickupLocation || !destinationLocation) {
        return;
    }
    
    Promise.all([
        forwardGeocode(pickupLocation),
        forwardGeocode(destinationLocation)
    ]).then(([pickupResults, destinationResults]) => {
        if (pickupResults.length > 0 && destinationResults.length > 0) {
            const pickupLat = parseFloat(pickupResults[0].lat);
            const pickupLng = parseFloat(pickupResults[0].lon);
            const destLat = parseFloat(destinationResults[0].lat);
            const destLng = parseFloat(destinationResults[0].lon);
            
            const distance = calculateDistance(pickupLat, pickupLng, destLat, destLng);
            const distanceKm = distance / 1000;
            
            // Get selected vehicle type
            let vehicleType = 'car';
            if (scheduleType === 'ride-now') {
                const selectedOption = document.querySelector('.schedule-ride-now-form .vehicle-option.selected');
                vehicleType = selectedOption ? selectedOption.getAttribute('data-type') : 'car';
            } else if (scheduleType === 'delivery') {
                const selectedOption = document.querySelector('.schedule-delivery-form .vehicle-option.selected');
                vehicleType = selectedOption ? selectedOption.getAttribute('data-type') : 'bike';
            } else {
                const selectedOption = document.querySelector('.schedule-for-someone-form .vehicle-option.selected');
                vehicleType = selectedOption ? selectedOption.getAttribute('data-type') : 'car';
            }
            
            const vehicleConfig = vehicleConfigs[vehicleType] || vehicleConfigs.car;
            let baseFare = vehicleConfig.baseFare;
            
            if (distanceKm > 0) {
                baseFare += Math.ceil(distanceKm * 5);
            }
            
            baseFare = baseFare * vehicleConfig.multiplier;
            
            // Adjust for delivery
            if (scheduleType === 'delivery') {
                baseFare = baseFare * 0.8;
            }
            
            let fareElement, etaElement;
            
            switch(scheduleType) {
                case 'ride-now':
                    fareElement = document.getElementById('scheduleEstimatedFare');
                    etaElement = document.getElementById('scheduleEtaDisplay');
                    break;
                case 'delivery':
                    fareElement = document.getElementById('scheduleDeliveryFare');
                    etaElement = document.getElementById('scheduleDeliveryEtaDisplay');
                    break;
                case 'schedule-for-someone':
                    fareElement = document.getElementById('scheduleSomeoneFare');
                    etaElement = document.getElementById('scheduleSomeoneEtaDisplay');
                    break;
            }
            
            if (fareElement) {
                fareElement.textContent = `K${baseFare.toFixed(2)}`;
            }
            
            const etaMinutes = Math.ceil((distanceKm / 30) * 60);
            if (etaElement) {
                etaElement.textContent = `ETA: ${etaMinutes} min`;
            }
        }
    }).catch(error => {
        console.error('Error calculating schedule fare:', error);
    });
}

// Calculate recipient delivery fee
function calculateRecipientDeliveryFee() {
    const pickupLocation = document.getElementById('recipientPickupLocation').value;
    const destinationLocation = document.getElementById('recipientDestinationLocation').value;
    
    if (!pickupLocation || !destinationLocation) {
        document.getElementById('recipientDeliveryFee').textContent = 'K0.00';
        document.getElementById('recipientEtaDisplay').textContent = 'ETA: -- min';
        document.getElementById('orderForSomeoneBtn').disabled = true;
        return;
    }
    
    Promise.all([
        forwardGeocode(pickupLocation),
        forwardGeocode(destinationLocation)
    ]).then(([pickupResults, destinationResults]) => {
        if (pickupResults.length > 0 && destinationResults.length > 0) {
            const pickupLat = parseFloat(pickupResults[0].lat);
            const pickupLng = parseFloat(pickupResults[0].lon);
            const destLat = parseFloat(destinationResults[0].lat);
            const destLng = parseFloat(destinationResults[0].lon);
            
            const distance = calculateDistance(pickupLat, pickupLng, destLat, destLng);
            const distanceKm = distance / 1000;
            
            const vehicleConfig = vehicleConfigs.car;
            let baseFare = vehicleConfig.baseFare;
            
            if (distanceKm > 0) {
                baseFare += Math.ceil(distanceKm * 5);
            }
            
            baseFare = baseFare * vehicleConfig.multiplier;
            
            document.getElementById('recipientDeliveryFee').textContent = `K${baseFare.toFixed(2)}`;
            
            const etaMinutes = Math.ceil((distanceKm / 30) * 60);
            document.getElementById('recipientEtaDisplay').textContent = `ETA: ${etaMinutes} min`;
            
            document.getElementById('orderForSomeoneBtn').disabled = false;
        } else {
            document.getElementById('recipientDeliveryFee').textContent = 'K0.00';
            document.getElementById('recipientEtaDisplay').textContent = 'ETA: -- min';
            document.getElementById('orderForSomeoneBtn').disabled = true;
        }
    }).catch(error => {
        console.error('Error calculating recipient delivery fee:', error);
        document.getElementById('recipientDeliveryFee').textContent = 'K0.00';
        document.getElementById('recipientEtaDisplay').textContent = 'ETA: -- min';
        document.getElementById('orderForSomeoneBtn').disabled = true;
    });
}

// Calculate express delivery fee
function calculateExpressDeliveryFee() {
    const shopLocation = document.getElementById('shopLocation').value;
    const deliveryDestination = document.getElementById('deliveryDestination').value;
    
    if (!shopLocation || !deliveryDestination) {
        document.getElementById('expressDeliveryFee').textContent = 'K0.00';
        document.getElementById('expressDeliveryEtaDisplay').textContent = 'ETA: -- min';
        document.getElementById('expressDeliveryBtn').disabled = true;
        return;
    }
    
    Promise.all([
        forwardGeocode(shopLocation),
        forwardGeocode(deliveryDestination)
    ]).then(([shopResults, destinationResults]) => {
        if (shopResults.length > 0 && destinationResults.length > 0) {
            const shopLat = parseFloat(shopResults[0].lat);
            const shopLng = parseFloat(shopResults[0].lon);
            const destLat = parseFloat(destinationResults[0].lat);
            const destLng = parseFloat(destinationResults[0].lon);
            
            const distance = calculateDistance(shopLat, shopLng, destLat, destLng);
            const distanceKm = distance / 1000;
            
            const selectedOption = document.querySelector('.express-delivery-form .vehicle-option.selected');
            const vehicleType = selectedOption ? selectedOption.getAttribute('data-type') : 'bike';
            const vehicleConfig = vehicleConfigs[vehicleType] || vehicleConfigs.bike;
            
            let baseFare = vehicleConfig.baseFare;
            
            if (distanceKm > 0) {
                baseFare += Math.ceil(distanceKm * 5);
            }
            
            baseFare = baseFare * vehicleConfig.multiplier;
            
            document.getElementById('expressDeliveryFee').textContent = `K${baseFare.toFixed(2)}`;
            
            const etaMinutes = Math.ceil((distanceKm / 30) * 60);
            document.getElementById('expressDeliveryEtaDisplay').textContent = `ETA: ${etaMinutes} min`;
            
            document.getElementById('expressDeliveryBtn').disabled = false;
        } else {
            document.getElementById('expressDeliveryFee').textContent = 'K0.00';
            document.getElementById('expressDeliveryEtaDisplay').textContent = 'ETA: -- min';
            document.getElementById('expressDeliveryBtn').disabled = true;
        }
    }).catch(error => {
        console.error('Error calculating express delivery fee:', error);
        document.getElementById('expressDeliveryFee').textContent = 'K0.00';
        document.getElementById('expressDeliveryEtaDisplay').textContent = 'ETA: -- min';
        document.getElementById('expressDeliveryBtn').disabled = true;
    });
}

// Ride request function
function requestRide() {
    const pickupLocation = document.getElementById('pickupLocation').value;
    const destinationLocation = document.getElementById('destinationLocation').value;
    
    if (!destinationLocation) {
        showNotification('Please enter a destination');
        return;
    }
    
    if (!userLocation && !pickupMarker) {
        showNotification('Unable to determine your location. Please try again.');
        return;
    }
    
    const pickupLatLng = userLocation ? { lat: userLocation.lat, lng: userLocation.lng } : null;
    
    if (!pickupLatLng) {
        showNotification('Please set a pickup location');
        return;
    }
    
    // Get package details if applicable
    if (document.getElementById('packageForm').classList.contains('active')) {
        packageDetails = {
            receiverName: document.getElementById('receiverName').value,
            receiverPhone: document.getElementById('receiverPhone').value,
            packageDescription: document.getElementById('packageDescription').value,
            specialInstructions: document.getElementById('specialInstructions').value,
            packageValue: document.getElementById('packageValue').value
        };
    } else {
        packageDetails = null;
    }
    
    Promise.all([
        getFullAddress(pickupLatLng.lat, pickupLatLng.lng),
        forwardGeocode(destinationLocation)
    ]).then(([fullPickupAddress, destinationResults]) => {
        if (destinationResults.length === 0) {
            showNotification('Invalid destination address. Please select a valid destination.');
            return;
        }
        
        const destLat = parseFloat(destinationResults[0].lat);
        const destLng = parseFloat(destinationResults[0].lon);
        
        const distance = calculateDistance(
            pickupLatLng.lat, pickupLatLng.lng,
            destLat, destLng
        );
        const distanceKm = distance / 1000;
        
        // Get vehicle configuration
        const vehicleConfig = vehicleConfigs[selectedVehicleType] || vehicleConfigs.car;
        
        // Calculate fare
        let baseFare = vehicleConfig.baseFare;
        
        if (distanceKm > 0) {
            baseFare += Math.ceil(distanceKm * 5);
        }
        
        baseFare = baseFare * vehicleConfig.multiplier;
        
        // Apply promo code discount if any
        if (appliedPromoCode) {
            baseFare = baseFare * 0.8; // 20% discount for promo codes
        }
        
        baseFare = Math.max(15, baseFare);
        
        const rideId = database.ref().child('rides').push().key;
        
        const rideRequest = {
            id: rideId,
            passengerId: currentUser.uid,
            passengerName: userData.name || 'Passenger',
            passengerPhone: userData.phone || 'Not provided',
            pickupLocation: fullPickupAddress,
            pickupDisplayLocation: pickupLocation,
            destination: destinationResults[0].display_name || destinationLocation,
            pickupLat: pickupLatLng.lat,
            pickupLng: pickupLatLng.lng,
            destLat: destLat,
            destLng: destLng,
            rideType: selectedVehicleType,
            fare: baseFare,
            distance: distanceKm.toFixed(2) + ' km',
            status: 'requested',
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            updatedAt: firebase.database.ServerValue.TIMESTAMP,
            promoCode: appliedPromoCode,
            paymentMethod: selectedPaymentType,
            packageDetails: packageDetails,
            currentCity: currentCity
        };
        
        currentRideRequestData = rideRequest;
        currentRideRequestType = 'standard';
        
        showPaymentSelection(baseFare);
    }).catch(error => {
        console.error('Error in ride request process:', error);
        showNotification('Error calculating route. Please try again.');
    });
}

// Show payment selection
function showPaymentSelection(fare = null) {
    const calculatedFare = fare || rideFare;
    
    document.getElementById('paymentWalletBalance').textContent = `Balance: K${walletBalance.toFixed(2)}`;
    
    if (walletBalance < calculatedFare && selectedPaymentType === 'wallet') {
        document.getElementById('insufficientBalance').style.display = 'block';
        document.getElementById('confirmPaymentBtn').disabled = true;
    } else {
        document.getElementById('insufficientBalance').style.display = 'none';
        document.getElementById('confirmPaymentBtn').disabled = false;
    }
    
    document.getElementById('paymentSelectionPopup').classList.remove('hidden');
}

// Close payment selection
function closePaymentSelection() {
    document.getElementById('paymentSelectionPopup').classList.add('hidden');
}

// Submit ride request after payment confirmation
function submitRideRequest() {
    if (!currentRideRequestData) {
        showNotification('No ride request data found. Please try again.');
        return;
    }
    
    const rideRequest = currentRideRequestData;
    
    // Apply referral discount if applicable
    if (appliedPromoCode && appliedPromoCode.startsWith('JUBEL-')) {
        // Apply 50% discount for referral codes
        rideRequest.fare = rideRequest.fare * 0.5;
        rideRequest.referralCode = appliedPromoCode;
        
        // Store referral for reward when ride is completed
        database.ref('pendingReferrals').push().set({
            referralCode: appliedPromoCode,
            passengerId: currentUser.uid,
            rideId: rideRequest.id,
            discountApplied: true,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });
    }
    
    if (selectedPaymentType === 'wallet') {
        const newBalance = walletBalance - rideRequest.fare;
        
        if (newBalance < 0) {
            showNotification('Insufficient wallet balance. Please select another payment method.');
            return;
        }
        
        database.ref('users/' + currentUser.uid).update({
            walletBalance: newBalance
        })
        .then(() => {
            walletBalance = newBalance;
            updateWalletBalanceUI();
            
            return database.ref('rides/' + rideRequest.id).set(rideRequest);
        })
        .then(() => {
            currentRide = rideRequest;
            
            closePaymentSelection();
            
            updateUIForActiveRide();
            
            document.getElementById('searchingAnimation').style.display = 'flex';
            
            document.getElementById('rideStatus').style.display = 'flex';
            document.getElementById('statusDot').className = 'status-dot searching';
            document.getElementById('statusText').textContent = 'Searching for driver';
            
            if (sosConfig && sosConfig.contact1) {
                document.getElementById('sosButton').style.display = 'flex';
            }
            
            showNotification('Ride requested. Searching for a driver...');
            
            listenForDriverAssignment(rideRequest.id);
        })
        .catch(error => {
            console.error('Error requesting ride:', error);
            showNotification('Error requesting ride. Please try again.');
        });
    } else {
        database.ref('rides/' + rideRequest.id).set(rideRequest)
            .then(() => {
                currentRide = rideRequest;
                
                closePaymentSelection();
                
                updateUIForActiveRide();
                
                document.getElementById('searchingAnimation').style.display = 'flex';
                
                document.getElementById('rideStatus').style.display = 'flex';
                document.getElementById('statusDot').className = 'status-dot searching';
                document.getElementById('statusText').textContent = 'Searching for driver';
                
                if (sosConfig && sosConfig.contact1) {
                    document.getElementById('sosButton').style.display = 'flex';
                }
                
                showNotification('Ride requested. Searching for a driver...');
                
                listenForDriverAssignment(rideRequest.id);
            })
            .catch(error => {
                console.error('Error requesting ride:', error);
                showNotification('Error requesting ride. Please try again.');
            });
    }
    
    currentRideRequestData = null;
}

// Update UI for active ride
function updateUIForActiveRide() {
    if (!currentRide) return;
    
    document.getElementById('rideRequestForm').style.display = 'none';
    document.getElementById('rideInfoPanel').style.display = 'block';
    
    document.getElementById('currentPickupLocation').textContent = currentRide.pickupDisplayLocation || currentRide.pickupLocation;
    document.getElementById('currentDestinationLocation').textContent = currentRide.destination;
    
    const baseFare = currentRide.fare || 0;
    const discount = appliedPromoCode ? baseFare * 0.5 : 0; // 50% discount for referrals
    const totalFare = baseFare - discount;
    
    document.getElementById('baseFare').textContent = `K${baseFare.toFixed(2)}`;
    document.getElementById('discountFare').textContent = `-K${discount.toFixed(2)}`;
    document.getElementById('totalFare').textContent = `K${totalFare.toFixed(2)}`;
    
    // Show driver details if available
    if (currentRide.driverId) {
        loadDriverDetails(currentRide.driverId);
    }
}

// Listen for driver assignment
function listenForDriverAssignment(rideId) {
    if (driverAssignmentListener) {
        driverAssignmentListener();
    }
    
    driverAssignmentListener = database.ref('rides/' + rideId).on('value', snapshot => {
        const ride = snapshot.val();
        if (!ride) {
            showNotification('Ride not found. Please try again.');
            return;
        }
        
        console.log('Ride status update:', ride.status, ride.driverId);
        
        if (ride.driverId && ride.status === 'accepted') {
            handleDriverAssignment(ride);
        } else if (ride.status === 'completed') {
            showRideCompletion(ride);
        } else if (ride.status === 'cancelled') {
            handleRideCancellation(ride);
        } else if (ride.status === 'arrived') {
            showNotification('Your driver has arrived at the pickup location.');
        } else if (ride.status === 'picked_up') {
            showNotification('You have been picked up. Enjoy your ride!');
        } else if (ride.status === 'started') {
            showNotification('Your trip has started.');
        }
    }, error => {
        console.error('Error listening for driver assignment:', error);
        showNotification('Connection error. Please check your internet connection.');
    });
}

// Handle driver assignment
function handleDriverAssignment(ride) {
    console.log('Driver assigned to ride:', ride.driverId);
    
    document.getElementById('searchingAnimation').style.display = 'none';
    
    document.getElementById('statusDot').className = 'status-dot arriving';
    document.getElementById('statusText').textContent = 'Driver arriving';
    
    document.getElementById('estimatedTime').style.display = 'flex';
    document.getElementById('timeText').textContent = '5 min';
    
    // Load driver details
    loadDriverDetails(ride.driverId);
    
    // Add driver marker if we have location
    if (ride.driverLat && ride.driverLng) {
        addDriverMarker(ride.driverLat, ride.driverLng);
        drawRouteOnMap(
            passengerMap,
            window.routeVectorLayer,
            [ride.driverLng, ride.driverLat],
            [ride.pickupLng, ride.pickupLat]
        );
        trackDriverLocation(ride.driverId);
    }
    
    showNotification(`Driver ${ride.driverName || 'is'} on the way!`);
    startDriverMessageListener(ride.id);
    
    listenForRideStatusUpdates(ride.id);
}

// Add driver marker
function addDriverMarker(lat, lng) {
    // Remove existing driver marker
    removeMarkerFromMap(passengerMap, driverMarker);
    
    // Add new driver marker
    driverMarker = addMarkerToMap(passengerMap, [lng, lat], currentRide.rideType || 'car', 'Driver');
}

// Track driver location
function trackDriverLocation(driverId) {
    if (driverLocationListener) {
        driverLocationListener();
    }
    
    driverLocationListener = database.ref('driverLocations/' + driverId).on('value', snapshot => {
        const location = snapshot.val();
        if (location && driverMarker) {
            driverMarker.setPosition(ol.proj.fromLonLat([location.longitude, location.latitude]));
            updateDriverETA(location.latitude, location.longitude);
        }
    });
}

// Update driver ETA
function updateDriverETA(driverLat, driverLng) {
    if (userLocation) {
        const distance = calculateDistance(
            driverLat, driverLng,
            userLocation.lat, userLocation.lng
        );
        
        const etaMinutes = Math.ceil((distance / 1000) / 30 * 60);
        document.getElementById('timeText').textContent = `${etaMinutes} min`;
    }
}

// Load driver details
function loadDriverDetails(driverId) {
    database.ref('users/' + driverId).once('value')
        .then(driverSnapshot => {
            const driver = driverSnapshot.val();
            if (driver) {
                updateDriverUI(driver);
                updateDriverDetailsCard(driver);
            }
        })
        .catch(error => {
            console.error('Error loading driver details:', error);
        });
}

// Update driver UI
function updateDriverUI(driver) {
    document.getElementById('driverName').textContent = driver.name || 'Driver';
    document.getElementById('driverPhone').textContent = driver.phone || 'N/A';
    document.getElementById('driverRating').textContent = driver.rating ? `${driver.rating} ` : '4.5 ';
    
    if (driver.vehicle) {
        document.getElementById('vehicleDetails').textContent = 
            `${driver.vehicle.type || 'Vehicle'} - ${driver.vehicle.licensePlate || 'ABC123'}`;
    }
    
    updateDriverAvatarWithImage(driver);
}

// Update driver avatar with image
function updateDriverAvatarWithImage(driver) {
    const driverAvatar = document.getElementById('driverAvatar');
    
    if (driver.images && driver.images.profilePhoto) {
        driverProfileImage = driver.images.profilePhoto;
        driverAvatar.innerHTML = `<img src="${driverProfileImage}" class="driver-profile-image" alt="Driver" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
    }
    else if (driver.name) {
        driverAvatar.innerHTML = driver.name.charAt(0).toUpperCase();
    } else {
        driverAvatar.innerHTML = '<i class="fas fa-user"></i>';
    }
}

// Update driver details card
function updateDriverDetailsCard(driver) {
    const driverDetailsCard = document.getElementById('driverDetailsCard');
    if (driverDetailsCard) {
        driverDetailsCard.style.display = 'block';
        
        document.getElementById('driverFullName').textContent = driver.name || 'Driver';
        document.getElementById('driverContactPhone').textContent = driver.phone || 'Not available';
        document.getElementById('driverRatingValue').textContent = driver.rating ? `${driver.rating} ` : '4.5 ';
        document.getElementById('driverExperience').textContent = driver.experience || '2 years';
        
        if (driver.vehicle) {
            document.getElementById('vehicleType').textContent = driver.vehicle.type || 'Car';
            document.getElementById('vehicleModel').textContent = driver.vehicle.model || 'Not specified';
            document.getElementById('vehicleLicense').textContent = driver.vehicle.licensePlate || 'Not available';
            document.getElementById('vehicleColor').textContent = driver.vehicle.color || 'Not specified';
        }
    }
}

// Listen for ride status updates
function listenForRideStatusUpdates(rideId) {
    database.ref('rides/' + rideId).on('value', snapshot => {
        const ride = snapshot.val();
        if (ride) {
            currentRide = ride;
            
            switch(ride.status) {
                case 'accepted':
                    document.getElementById('statusText').textContent = 'Driver on the way';
                    break;
                case 'arrived':
                    document.getElementById('statusText').textContent = 'Driver arrived';
                    document.getElementById('statusDot').className = 'status-dot riding';
                    showNotification('Your driver has arrived!');
                    break;
                case 'started':
                    document.getElementById('statusText').textContent = 'Trip in progress';
                    addDestinationMarker(ride.destLat, ride.destLng);
                    drawRouteOnMap(
                        passengerMap,
                        window.routeVectorLayer,
                        [ride.pickupLng, ride.pickupLat],
                        [ride.destLng, ride.destLat]
                    );
                    break;
                case 'completed':
                    document.getElementById('statusText').textContent = 'Trip completed';
                    document.getElementById('rideStatus').style.display = 'none';
                    document.getElementById('estimatedTime').style.display = 'none';
                    document.getElementById('sosButton').style.display = 'none';
                    resetUIAfterRide();
                    
                    // Process referral reward if applicable
                    if (ride.referralCode) {
                        processReferralReward(ride.referralCode, ride.id);
                    }
                    
                    showRatingPopup(ride);
                    showNotification('Trip completed. Thank you for using Jubel!');
                    break;
                case 'cancelled':
                    document.getElementById('rideStatus').style.display = 'none';
                    document.getElementById('estimatedTime').style.display = 'none';
                    document.getElementById('sosButton').style.display = 'none';
                    resetUIAfterRide();
                    showNotification('Ride cancelled');
                    break;
            }
        }
    });
}

// Process referral reward when ride is completed
function processReferralReward(referralCode, rideId) {
    // Find the referrer
    database.ref('users').orderByChild('referralCode').equalTo(referralCode).once('value')
        .then(snapshot => {
            if (snapshot.exists()) {
                const referrerData = snapshot.val();
                const referrerId = Object.keys(referrerData)[0];
                const referrer = referrerData[referrerId];
                
                // Check if referral has already been rewarded
                database.ref('referralRewards').orderByChild('rideId').equalTo(rideId).once('value')
                    .then(rewardSnapshot => {
                        if (!rewardSnapshot.exists()) {
                            // Reward the referrer
                            const newBalance = (referrer.walletBalance || 0) + 25;
                            database.ref('users/' + referrerId).update({
                                walletBalance: newBalance
                            })
                            .then(() => {
                                console.log(`Rewarded ${referrer.name} with K25 for referral`);
                                
                                // Record the reward
                                database.ref('referralRewards').push().set({
                                    referrerId: referrerId,
                                    referredUserId: currentUser.uid,
                                    referralCode: referralCode,
                                    rideId: rideId,
                                    rewardAmount: 25,
                                    timestamp: firebase.database.ServerValue.TIMESTAMP
                                });
                                
                                // Remove from pending referrals
                                database.ref('pendingReferrals').orderByChild('rideId').equalTo(rideId).once('value')
                                    .then(pendingSnapshot => {
                                        if (pendingSnapshot.exists()) {
                                            const pendingKey = Object.keys(pendingSnapshot.val())[0];
                                            database.ref('pendingReferrals/' + pendingKey).remove();
                                        }
                                    });
                            });
                        }
                    });
            }
        })
        .catch(error => {
            console.error('Error processing referral reward:', error);
        });
}

// Reset UI after ride
function resetUIAfterRide() {
    document.getElementById('rideRequestForm').style.display = 'flex';
    document.getElementById('rideInfoPanel').style.display = 'none';
    document.getElementById('driverDetailsCard').style.display = 'none';
    document.getElementById('destinationLocation').value = '';
    
    document.getElementById('packageForm').classList.remove('active');
    document.getElementById('receiverName').value = '';
    document.getElementById('receiverPhone').value = '';
    document.getElementById('packageDescription').value = '';
    document.getElementById('specialInstructions').value = '';
    document.getElementById('packageValue').value = '';
    
    document.getElementById('promoCode').value = '';
    appliedPromoCode = null;
    document.getElementById('promoCode').style.borderColor = '';
    document.getElementById('applyPromoBtn').innerHTML = 'Apply';
    document.getElementById('applyPromoBtn').classList.remove('btn-success');
    document.getElementById('applyPromoBtn').classList.add('btn-promo');
    document.getElementById('promoSection').classList.remove('active');
    
    // Remove markers
    removeMarkerFromMap(passengerMap, driverMarker);
    removeMarkerFromMap(passengerMap, destinationMarker);
    
    // Clear route
    window.routeVectorLayer.getSource().clear();
    
    if (driverLocationListener) {
        driverLocationListener();
        driverLocationListener = null;
    }
    
    if (driverMessageListener) {
        driverMessageListener();
        driverMessageListener = null;
    }
    
    currentRide = null;
}

// Show rating popup
function showRatingPopup(ride) {
    if (!document.getElementById('ratingPopup')) {
        createRatingPopup();
    }
    
    document.getElementById('ratingPopup').setAttribute('data-ride-id', ride.id);
    document.getElementById('ratingDriverName').textContent = ride.driverName || 'Driver';
    document.getElementById('ratingVehicleInfo').textContent = 
        `${ride.driverVehicle?.type || 'Vehicle'} - ${ride.driverVehicle?.licensePlate || 'N/A'}`;
    
    resetRatingStars();
    document.getElementById('ratingPopup').classList.remove('hidden');
}

// Create rating popup
function createRatingPopup() {
    const ratingPopup = document.createElement('div');
    ratingPopup.id = 'ratingPopup';
    ratingPopup.className = 'popup-overlay hidden';
    ratingPopup.innerHTML = `
        <div class="popup-form" style="max-width: 400px;">
            <div class="popup-header">
                <h2 class="popup-title">
                    <i class="fas fa-star"></i>
                    Rate Your Driver
                </h2>
                <button class="close-popup" id="closeRatingPopup">&times;</button>
            </div>
            <div class="popup-content">
                <div class="rating-driver-info" style="text-align: center; margin-bottom: 20px;">
                    <div class="driver-avatar" id="ratingDriverAvatar" style="width: 60px; height: 60px; margin: 0 auto 10px; background: var(--primary-orange); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white;">
                        <i class="fas fa-user"></i>
                    </div>
                    <h3 id="ratingDriverName" style="margin-bottom: 5px;">Driver Name</h3>
                    <p id="ratingVehicleInfo" style="color: var(--medium-gray); font-size: 0.9rem;">Vehicle Info</p>
                </div>
                
                <div class="rating-stars-container" style="text-align: center; margin: 20px 0;">
                    <div class="rating-stars" id="ratingStars">
                        <span class="star" data-rating="1"><i class="far fa-star"></i></span>
                        <span class="star" data-rating="2"><i class="far fa-star"></i></span>
                        <span class="star" data-rating="3"><i class="far fa-star"></i></span>
                        <span class="star" data-rating="4"><i class="far fa-star"></i></span>
                        <span class="star" data-rating="5"><i class="far fa-star"></i></span>
                    </div>
                    <div id="ratingText" style="margin-top: 10px; font-size: 0.9rem; color: var(--medium-gray);">Tap to rate</div>
                </div>
                
                <div class="rating-comment" style="margin-bottom: 20px;">
                    <label for="ratingComment" style="display: block; margin-bottom: 8px; font-weight: 600;">Additional Comments (Optional)</label>
                    <textarea id="ratingComment" placeholder="How was your ride experience?" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: var(--element-radius); resize: vertical; min-height: 80px;"></textarea>
                </div>
                
                <button id="submitRatingBtn" class="request-ride-btn" style="width: 100%;">
                    <i class="fas fa-paper-plane"></i> Submit Rating
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(ratingPopup);
    
    document.getElementById('closeRatingPopup').addEventListener('click', closeRatingPopup);
    document.getElementById('submitRatingBtn').addEventListener('click', submitRating);
    
    const stars = document.querySelectorAll('#ratingStars .star');
    stars.forEach(star => {
        star.addEventListener('click', function() {
            const rating = parseInt(this.getAttribute('data-rating'));
            setRatingStars(rating);
        });
        
        star.addEventListener('mouseover', function() {
            const rating = parseInt(this.getAttribute('data-rating'));
            highlightStars(rating);
        });
    });
    
    document.getElementById('ratingStars').addEventListener('mouseleave', function() {
        const currentRating = parseInt(document.getElementById('ratingStars').getAttribute('data-current-rating') || '0');
        if (currentRating > 0) {
            setRatingStars(currentRating);
        } else {
            resetRatingStars();
        }
    });
}

// Set rating stars
function setRatingStars(rating) {
    const stars = document.querySelectorAll('#ratingStars .star');
    const ratingText = document.getElementById('ratingText');
    
    stars.forEach((star, index) => {
        if (index < rating) {
            star.innerHTML = '<i class="fas fa-star"></i>';
            star.style.color = '#FFD700';
        } else {
            star.innerHTML = '<i class="far fa-star"></i>';
            star.style.color = '#CCCCCC';
        }
    });
    
    const ratingTexts = {
        1: 'Poor',
        2: 'Fair',
        3: 'Good',
        4: 'Very Good',
        5: 'Excellent'
    };
    
    ratingText.textContent = ratingTexts[rating] || 'Tap to rate';
    ratingText.style.color = '#FF6B35';
    document.getElementById('ratingStars').setAttribute('data-current-rating', rating);
}

// Highlight stars on hover
function highlightStars(rating) {
    const stars = document.querySelectorAll('#ratingStars .star');
    
    stars.forEach((star, index) => {
        if (index < rating) {
            star.innerHTML = '<i class="fas fa-star"></i>';
            star.style.color = '#FFD700';
        } else {
            star.innerHTML = '<i class="far fa-star"></i>';
            star.style.color = '#CCCCCC';
        }
    });
}

// Reset rating stars
function resetRatingStars() {
    const stars = document.querySelectorAll('#ratingStars .star');
    const ratingText = document.getElementById('ratingText');
    
    stars.forEach(star => {
        star.innerHTML = '<i class="far fa-star"></i>';
        star.style.color = '#CCCCCC';
    });
    
    ratingText.textContent = 'Tap to rate';
    ratingText.style.color = 'var(--medium-gray)';
    document.getElementById('ratingStars').setAttribute('data-current-rating', '0');
}

// Submit rating
function submitRating() {
    const rideId = document.getElementById('ratingPopup').getAttribute('data-ride-id');
    const rating = parseInt(document.getElementById('ratingStars').getAttribute('data-current-rating') || '0');
    const comment = document.getElementById('ratingComment').value.trim();
    
    if (rating === 0) {
        showNotification('Please select a rating');
        return;
    }
    
    if (!rideId || !currentRide || !currentRide.driverId) {
        showNotification('Error submitting rating. Please try again.');
        return;
    }
    
    const ratingData = {
        rideId: rideId,
        driverId: currentRide.driverId,
        passengerId: currentUser.uid,
        passengerName: userData.name || 'Passenger',
        rating: rating,
        comment: comment,
        timestamp: firebase.database.ServerValue.TIMESTAMP
    };
    
    database.ref('ratings').push(ratingData)
        .then(() => {
            updateDriverRating(currentRide.driverId, rating);
            showNotification('Thank you for your rating!');
            closeRatingPopup();
        })
        .catch(error => {
            console.error('Error submitting rating:', error);
            showNotification('Error submitting rating. Please try again.');
        });
}

// Update driver rating
function updateDriverRating(driverId, newRating) {
    database.ref('ratings').orderByChild('driverId').equalTo(driverId).once('value')
        .then(snapshot => {
            const ratings = snapshot.val();
            let totalRating = 0;
            let ratingCount = 0;
            
            if (ratings) {
                Object.values(ratings).forEach(rating => {
                    totalRating += rating.rating;
                    ratingCount++;
                });
            }
            
            // Add new rating
            totalRating += newRating;
            ratingCount++;
            
            const averageRating = totalRating / ratingCount;
            return database.ref('users/' + driverId + '/stats/rating').set(averageRating.toFixed(1));
        })
        .catch(error => {
            console.error('Error updating driver rating:', error);
        });
}

// Close rating popup
function closeRatingPopup() {
    document.getElementById('ratingPopup').classList.add('hidden');
    document.getElementById('ratingComment').value = '';
    resetRatingStars();
}

// Apply promo code
function applyPromoCode() {
    const promoCode = document.getElementById('promoCode').value.trim();
    
    if (!promoCode) {
        showNotification('Please enter a promo code.');
        return;
    }
    
    if (promoCode.startsWith('JUBEL')) {
        applyReferralCode(promoCode);
    } else {
        if (promoCode.startsWith('JUBEL-')) {
            appliedPromoCode = promoCode;
            showNotification('Promo code applied! 50% discount will be applied to your ride.');
            updateFareEstimate();
            
            document.getElementById('promoCode').style.borderColor = 'var(--success-green)';
            document.getElementById('applyPromoBtn').innerHTML = '<i class="fas fa-check"></i> Applied';
            document.getElementById('applyPromoBtn').classList.remove('btn-promo');
            document.getElementById('applyPromoBtn').classList.add('btn-success');
        } else {
            showNotification('Invalid promo code. Please check and try again.');
            document.getElementById('promoCode').style.borderColor = 'var(--error-red)';
        }
    }
}

// Apply referral code
function applyReferralCode(referralCode) {
    database.ref('users').orderByChild('referralCode').equalTo(referralCode).once('value')
        .then(snapshot => {
            if (snapshot.exists()) {
                appliedPromoCode = referralCode;
                showNotification('Referral code applied! 50% discount will be applied to your ride.');
                updateFareEstimate();
                
                document.getElementById('promoCode').style.borderColor = 'var(--success-green)';
                document.getElementById('applyPromoBtn').innerHTML = '<i class="fas fa-check"></i> Applied';
                document.getElementById('applyPromoBtn').classList.remove('btn-promo');
                document.getElementById('applyPromoBtn').classList.add('btn-success');
            } else {
                showNotification('Invalid referral code. Please check and try again.');
                document.getElementById('promoCode').style.borderColor = 'var(--error-red)';
            }
        })
        .catch(error => {
            console.error('Error applying referral code:', error);
            showNotification('Error applying referral code. Please try again.');
        });
}

// Load passenger data
function loadPassengerData() {
    if (currentUser) {
        updateUserStats();
    }
}

// Update user stats
function updateUserStats() {
    if (!currentUser) return;
    
    database.ref('rides').orderByChild('passengerId').equalTo(currentUser.uid).once('value')
        .then(snapshot => {
            const rides = snapshot.val();
            if (rides) {
                const ridesArray = Object.values(rides);
                
                userStats = {
                    completed: ridesArray.filter(ride => ride.status === 'completed' || ride.status === 'paid').length,
                    cancelled: ridesArray.filter(ride => ride.status === 'cancelled').length,
                    pending: ridesArray.filter(ride => ride.status === 'requested' || ride.status === 'accepted').length
                };
                
                document.getElementById('ridesCompleted').textContent = userStats.completed;
                document.getElementById('ridesCancelled').textContent = userStats.cancelled;
                document.getElementById('ridesPending').textContent = userStats.pending;
            }
        });
}

// Load ride history
function loadRideHistory() {
    if (currentUser) {
        const filter = document.getElementById('historyFilter').value;
        const dateFilter = document.getElementById('historyDate').value;
        
        if (rideHistoryListener) {
            rideHistoryListener();
        }
        
        // Load scheduled rides
        loadScheduledRidesForHistory(currentUser.uid, filter, dateFilter);
        
        // Load regular ride history
        rideHistoryListener = database.ref('rides').orderByChild('passengerId').equalTo(currentUser.uid).on('value', snapshot => {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';
            
            const rides = snapshot.val();
            if (rides) {
                let ridesArray = Object.keys(rides).map(rideId => ({
                    id: rideId,
                    ...rides[rideId]
                }));
                
                if (filter !== 'all') {
                    if (filter === 'scheduled') {
                        // Show scheduled rides in history
                        historyList.innerHTML = '<div class="loading-text">Loading scheduled rides...</div>';
                        return;
                    } else if (filter === 'emergency') {
                        ridesArray = ridesArray.filter(ride => 
                            ride.rideType === 'emergency' || 
                            ride.rideType === 'ambulance' || 
                            ride.rideType === 'fire-truck'
                        );
                    } else if (filter === 'delivery') {
                        ridesArray = ridesArray.filter(ride => 
                            ride.rideType === 'bike' || 
                            ride.rideType === 'truck' ||
                            ride.packageDetails
                        );
                    } else {
                        ridesArray = ridesArray.filter(ride => ride.status === filter);
                    }
                }
                
                if (dateFilter) {
                    const filterDate = new Date(dateFilter);
                    ridesArray = ridesArray.filter(ride => {
                        const rideDate = new Date(ride.timestamp);
                        return rideDate.toDateString() === filterDate.toDateString();
                    });
                }
                
                ridesArray.sort((a, b) => b.timestamp - a.timestamp);
                
                if (ridesArray.length === 0) {
                    historyList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--medium-gray);">No rides found matching your criteria.</p>';
                    return;
                }
                
                ridesArray.forEach(ride => {
                    const historyItem = createHistoryItem(ride);
                    historyList.appendChild(historyItem);
                });
            } else {
                historyList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--medium-gray);">No ride history found.</p>';
            }
        }, error => {
            console.error('Error loading ride history:', error);
            historyList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--error-red);">Error loading ride history.</p>';
        });
    }
}

// Create history item
function createHistoryItem(ride) {
    const historyItem = document.createElement('div');
    historyItem.className = 'history-item';
    historyItem.setAttribute('data-ride-id', ride.id);
    
    const date = new Date(ride.timestamp);
    const formattedDate = date.toLocaleDateString();
    const formattedTime = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    // Determine ride type
    let typeClass = 'ride';
    let typeText = 'Ride';
    let badgeClass = 'badge-standard';
    
    if (ride.rideType === 'bike' || ride.rideType === 'truck' || ride.packageDetails) {
        typeClass = 'delivery';
        typeText = 'Delivery';
        badgeClass = ride.rideType === 'truck' ? 'badge-truck' : 'badge-standard';
    } else if (ride.rideType === 'premium') {
        typeText = 'Premium';
        badgeClass = 'badge-premium';
    } else if (ride.rideType === 'economy') {
        typeText = 'Economy';
        badgeClass = 'badge-economy';
    } else if (ride.rideType === 'emergency') {
        typeText = 'Emergency';
        badgeClass = 'badge-emergency';
    } else if (ride.rideType === 'ambulance') {
        typeText = 'Ambulance';
        badgeClass = 'badge-ambulance';
    } else if (ride.rideType === 'fire-truck') {
        typeText = 'Fire Truck';
        badgeClass = 'badge-fire-truck';
    }
    
    let statusClass = 'status-requested';
    let statusText = getStatusText(ride.status);
    
    if (ride.status === 'accepted') {
        statusClass = 'status-accepted';
    } else if (ride.status === 'completed' || ride.status === 'paid') {
        statusClass = 'status-completed';
    } else if (ride.status === 'cancelled') {
        statusClass = 'status-cancelled';
    } else if (ride.status === 'requested') {
        statusClass = 'status-pending';
        statusText = 'Pending';
    }
    
    let historyContent = '';
    
    if (typeClass === 'delivery') {
        historyContent = `
            <div class="history-item-type ${typeClass}">
                ${typeText} <span class="vehicle-badge ${badgeClass}">${ride.rideType || 'Standard'}</span>
            </div>
            <div class="history-locations">
                <div>
                    <strong>Pickup:</strong> ${ride.pickupDisplayLocation || ride.pickupLocation}
                </div>
                <div>
                    <strong>Delivery:</strong> ${ride.destination}
                </div>
            </div>
            ${ride.packageDetails ? `
            <div class="history-package-details">
                <div class="package-detail-row">
                    <span class="package-detail-label">Receiver:</span>
                    <span class="package-detail-value">${ride.packageDetails.receiverName || 'N/A'}</span>
                </div>
                <div class="package-detail-row">
                    <span class="package-detail-label">Package:</span>
                    <span class="package-detail-value">${ride.packageDetails.packageDescription || 'N/A'}</span>
                </div>
                <div class="package-detail-row">
                    <span class="package-detail-label">Value:</span>
                    <span class="package-detail-value">K${ride.packageDetails.packageValue || '0.00'}</span>
                </div>
            </div>
            ` : ''}
            <div class="history-info">
                <div class="history-fare">K${ride.fare ? ride.fare.toFixed(2) : '0.00'}</div>
                <div>${formattedDate} ${formattedTime}</div>
                <div class="status-badge ${statusClass}">
                    ${statusText}
                </div>
            </div>
        `;
    } else {
        historyContent = `
            <div class="history-item-type ${typeClass}">
                ${typeText} <span class="vehicle-badge ${badgeClass}">${ride.rideType || 'Standard'}</span>
            </div>
            <div class="history-locations">
                <div>
                    <strong>From:</strong> ${ride.pickupDisplayLocation || ride.pickupLocation}
                </div>
                <div>
                    <strong>To:</strong> ${ride.destination}
                </div>
            </div>
            <div class="history-info">
                <div class="history-fare">K${ride.fare ? ride.fare.toFixed(2) : '0.00'}</div>
                <div>${formattedDate} ${formattedTime}</div>
                <div class="status-badge ${statusClass}">
                    ${statusText}
                </div>
            </div>
        `;
    }
    
    historyItem.innerHTML = historyContent;
    
    // Load driver info if available
    if (ride.driverId) {
        database.ref('users/' + ride.driverId).once('value')
            .then(driverSnapshot => {
                const driver = driverSnapshot.val();
                if (driver) {
                    const driverInfo = document.createElement('div');
                    driverInfo.className = 'history-driver-info';
                    driverInfo.innerHTML = `
                        <div class="history-driver-avatar">
                            ${driver.name ? driver.name.charAt(0).toUpperCase() : 'D'}
                        </div>
                        <div class="history-driver-details">
                            <div class="history-driver-name">${driver.name || 'Driver'}</div>
                            <div class="history-driver-rating">${driver.rating || '4.5'} </div>
                        </div>
                    `;
                    historyItem.appendChild(driverInfo);
                }
            });
    }
    
    // Add click event to show ride details
    historyItem.addEventListener('click', function() {
        showRideDetailsPopup(ride.id);
    });
    
    return historyItem;
}

// Get status text
function getStatusText(status) {
    const statusMap = {
        'requested': 'Awaiting Driver',
        'accepted': 'In Progress',
        'completed': 'Completed',
        'paid': 'Completed',
        'cancelled': 'Cancelled',
        'arrived': 'Driver Arrived',
        'picked_up': 'Picked Up',
        'started': 'Trip Started',
        'scheduled': 'Scheduled'
    };
    
    return statusMap[status] || status;
}

// Show ride details popup
function showRideDetailsPopup(rideId) {
    // Check if it's a scheduled ride
    if (rideId.startsWith('scheduled_')) {
        showScheduledRideDetails(rideId.replace('scheduled_', ''));
        return;
    }
    
    database.ref('rides/' + rideId).once('value')
        .then(snapshot => {
            const ride = snapshot.val();
            if (ride) {
                document.getElementById('popupRidePickup').textContent = ride.pickupDisplayLocation || ride.pickupLocation;
                document.getElementById('popupRideDestination').textContent = ride.destination;
                document.getElementById('popupRideFare').textContent = `K${ride.fare ? ride.fare.toFixed(2) : '0.00'}`;
                document.getElementById('popupRideDistance').textContent = ride.distance || 'Calculating...';
                document.getElementById('popupRideStatus').textContent = getStatusText(ride.status);
                
                // Get vehicle type display name
                const vehicleConfig = vehicleConfigs[ride.rideType] || vehicleConfigs.car;
                document.getElementById('popupRideType').textContent = vehicleConfig.name;
                
                const date = new Date(ride.timestamp);
                document.getElementById('popupRideDate').textContent = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                // Update popup map
                updatePopupRideMap(ride);
                
                // Load chat history
                loadRideChatHistory(rideId);
                
                if (ride.driverId) {
                    database.ref('users/' + ride.driverId).once('value')
                        .then(driverSnapshot => {
                            const driver = driverSnapshot.val();
                            if (driver) {
                                document.getElementById('popupDriverName').textContent = driver.name || 'Driver';
                                document.getElementById('popupDriverPhone').textContent = driver.phone || 'N/A';
                                document.getElementById('popupDriverVehicle').textContent = `${driver.vehicleType || 'Car'} (${driver.licensePlate || 'N/A'})`;
                                document.getElementById('popupDriverRating').textContent = driver.rating || '4.5';
                                
                                updateDriverProgress(ride.status);
                                document.getElementById('popupDriverDetails').classList.remove('hidden');
                            }
                        });
                } else {
                    document.getElementById('popupDriverDetails').classList.add('hidden');
                }
                
                document.getElementById('rideDetailsPopup').classList.remove('hidden');
            }
        })
        .catch(error => {
            console.error('Error loading ride details:', error);
            showNotification('Error loading ride details.');
        });
}

// Update popup ride map
function updatePopupRideMap(ride) {
    if (!popupRideMap || !window.popupMapVectorLayer || !window.popupRouteVectorLayer) return;
    
    // Clear existing features
    window.popupMapVectorLayer.getSource().clear();
    window.popupRouteVectorLayer.getSource().clear();
    
    // Add pickup marker
    const pickupMarker = createMarker([ride.pickupLng, ride.pickupLat], 'car', 'Pickup');
    popupRideMap.addOverlay(pickupMarker);
    
    // Add destination marker
    const destinationMarker = createMarker([ride.destLng, ride.destLat], 'car', 'Destination');
    popupRideMap.addOverlay(destinationMarker);
    
    // Draw route
    drawRouteOnMap(
        popupRideMap,
        window.popupRouteVectorLayer,
        [ride.pickupLng, ride.pickupLat],
        [ride.destLng, ride.destLat]
    );
}

// Load ride chat history
function loadRideChatHistory(rideId) {
    const chatMessages = document.getElementById('historyChatMessages');
    if (!chatMessages) return;
    
    chatMessages.innerHTML = '<div class="loading-text">Loading chat history...</div>';
    document.getElementById('popupChatSection').classList.remove('hidden');
    
    database.ref('chats/' + rideId).orderByChild('timestamp').once('value')
        .then(snapshot => {
            const messages = snapshot.val();
            chatMessages.innerHTML = '';
            
            if (messages) {
                const messagesArray = Object.values(messages);
                messagesArray.sort((a, b) => a.timestamp - b.timestamp);
                
                if (messagesArray.length === 0) {
                    chatMessages.innerHTML = '<div class="no-places" style="text-align: center; padding: 20px; color: var(--medium-gray);">No chat messages</div>';
                    return;
                }
                
                messagesArray.forEach(message => {
                    const messageElement = document.createElement('div');
                    messageElement.className = `history-chat-message ${message.senderId === currentUser.uid ? 'passenger' : 'driver'}`;
                    
                    const timestamp = new Date(message.timestamp);
                    const timeString = timestamp.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    messageElement.innerHTML = `
                        <div style="font-size: 0.8rem;">${message.message}</div>
                        <div style="font-size: 0.6rem; opacity: 0.7; margin-top: 4px;">${message.senderName}  ${timeString}</div>
                    `;
                    
                    chatMessages.appendChild(messageElement);
                });
                
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } else {
                chatMessages.innerHTML = '<div class="no-places" style="text-align: center; padding: 20px; color: var(--medium-gray);">No chat messages</div>';
            }
        })
        .catch(error => {
            console.error('Error loading chat history:', error);
            chatMessages.innerHTML = '<div class="no-places" style="text-align: center; padding: 20px; color: var(--error-red);">Error loading chat history.</div>';
        });
}

// Update driver progress
function updateDriverProgress(status) {
    const progressElement = document.getElementById('popupDriverProgress');
    
    switch(status) {
        case 'requested':
            progressElement.textContent = 'Waiting for driver to accept';
            break;
        case 'accepted':
            progressElement.textContent = 'Driver on the way to pickup';
            break;
        case 'arrived':
            progressElement.textContent = 'Driver arrived at pickup location';
            break;
        case 'picked_up':
            progressElement.textContent = 'Passenger picked up';
            break;
        case 'started':
            progressElement.textContent = 'Trip in progress';
            break;
        case 'completed':
            progressElement.textContent = 'Trip completed';
            break;
        case 'paid':
            progressElement.textContent = 'Payment completed';
            break;
        default:
            progressElement.textContent = 'Status: ' + status;
    }
}

// Close ride details popup
function closeRideDetailsPopup() {
    document.getElementById('rideDetailsPopup').classList.add('hidden');
}

// Show scheduled ride details
function showScheduledRideDetails(scheduleId) {
    database.ref('scheduledRides/' + scheduleId).once('value')
        .then(snapshot => {
            const ride = snapshot.val();
            if (ride) {
                // Create a custom popup for scheduled rides
                const popup = document.createElement('div');
                popup.className = 'popup-overlay';
                popup.innerHTML = `
                    <div class="popup-form">
                        <div class="popup-header">
                            <h2 class="popup-title">
                                <i class="fas fa-clock"></i>
                                Scheduled Ride Details
                            </h2>
                            <button class="close-popup" onclick="this.closest('.popup-overlay').remove()">&times;</button>
                        </div>
                        <div class="popup-content">
                            <div class="detail-row">
                                <span class="detail-label">Pickup:</span>
                                <span class="detail-value">${ride.pickupDisplayLocation || ride.pickupLocation}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Destination:</span>
                                <span class="detail-value">${ride.destination}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Fare:</span>
                                <span class="detail-value">K${ride.fare ? ride.fare.toFixed(2) : '0.00'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Scheduled Time:</span>
                                <span class="detail-value">${new Date(ride.scheduledTime).toLocaleString()}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Type:</span>
                                <span class="detail-value">${ride.scheduleType || 'Ride'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Status:</span>
                                <span class="detail-value">${ride.status || 'Scheduled'}</span>
                            </div>
                            ${ride.recipientName ? `
                            <div class="detail-row">
                                <span class="detail-label">Recipient:</span>
                                <span class="detail-value">${ride.recipientName}</span>
                            </div>
                            ` : ''}
                            ${ride.packageDetails ? `
                            <div class="detail-row">
                                <span class="detail-label">Package Details:</span>
                                <span class="detail-value">${ride.packageDetails}</span>
                            </div>
                            ` : ''}
                            <div class="popup-actions" style="margin-top: 20px;">
                                <button class="btn btn-cancel" onclick="cancelScheduledRide('${scheduleId}')" style="margin-right: 10px;">
                                    <i class="fas fa-times"></i> Cancel Schedule
                                </button>
                                <button class="btn btn-primary" onclick="this.closest('.popup-overlay').remove()">
                                    <i class="fas fa-times"></i> Close
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(popup);
            }
        })
        .catch(error => {
            console.error('Error loading scheduled ride details:', error);
            showNotification('Error loading scheduled ride details.');
        });
}

// Load scheduled rides for history
function loadScheduledRidesForHistory(uid, filter, dateFilter) {
    database.ref('scheduledRides').orderByChild('passengerId').equalTo(uid).once('value')
        .then(snapshot => {
            const rides = snapshot.val();
            const scheduledRidesList = document.getElementById('scheduledRidesList');
            const scheduledRidesSection = document.getElementById('scheduledRidesSection');
            
            if (!rides || Object.keys(rides).length === 0) {
                scheduledRidesSection.style.display = 'none';
                return;
            }
            
            let ridesArray = Object.keys(rides).map(rideId => ({
                id: rideId,
                ...rides[rideId]
            }));
            
            // Filter by status if needed
            if (filter === 'scheduled') {
                ridesArray = ridesArray.filter(ride => ride.status === 'scheduled');
            }
            
            if (dateFilter) {
                const filterDate = new Date(dateFilter);
                ridesArray = ridesArray.filter(ride => {
                    const rideDate = new Date(ride.scheduledTime);
                    return rideDate.toDateString() === filterDate.toDateString();
                });
            }
            
            if (ridesArray.length === 0) {
                scheduledRidesSection.style.display = 'none';
                return;
            }
            
            scheduledRidesSection.style.display = 'block';
            scheduledRidesList.innerHTML = '';
            
            ridesArray.sort((a, b) => a.scheduledTime - b.scheduledTime).forEach(ride => {
                const scheduledItem = createScheduledRideItem(ride);
                scheduledRidesList.appendChild(scheduledItem);
            });
        })
        .catch(error => {
            console.error('Error loading scheduled rides:', error);
        });
}

// Create scheduled ride item
function createScheduledRideItem(ride) {
    const item = document.createElement('div');
    item.className = 'scheduled-ride-item';
    item.setAttribute('data-ride-id', ride.id);
    
    const scheduledTime = new Date(ride.scheduledTime);
    const formattedTime = scheduledTime.toLocaleString();
    const timeDiff = scheduledTime.getTime() - new Date().getTime();
    const hoursUntil = Math.ceil(timeDiff / (1000 * 60 * 60));
    
    let statusText = 'Scheduled';
    if (ride.status === 'executed') statusText = 'Executed';
    if (ride.status === 'cancelled') statusText = 'Cancelled';
    if (ride.status === 'expired') statusText = 'Expired';
    
    item.innerHTML = `
        <div class="scheduled-ride-time">${formattedTime}</div>
        <div class="scheduled-ride-details">
            <div><strong>From:</strong> ${ride.pickupDisplayLocation || ride.pickupLocation}</div>
            <div><strong>To:</strong> ${ride.destination}</div>
            <div><strong>Fare:</strong> K${ride.fare ? ride.fare.toFixed(2) : '0.00'}</div>
            <div><strong>Status:</strong> ${statusText}</div>
            ${hoursUntil > 0 ? `<div><strong>Time until ride:</strong            ${hoursUntil > 0 ? `<div><strong>Time until ride:</strong> ${hoursUntil} hours</div>` : ''}
        </div>
        <div class="scheduled-ride-actions">
            ${ride.status === 'scheduled' ? `
            <button class="scheduled-action-btn scheduled-edit-btn" onclick="editScheduledRide('${ride.id}')">
                <i class="fas fa-edit"></i> Edit
            </button>
            ` : ''}
            <button class="scheduled-action-btn scheduled-cancel-btn" onclick="cancelScheduledRide('${ride.id}')">
                <i class="fas fa-times"></i> Cancel
            </button>
        </div>
    `;
    
    return item;
}

// Cancel scheduled ride
function cancelScheduledRide(scheduleId) {
    if (!confirm('Are you sure you want to cancel this scheduled ride?')) return;
    
    database.ref('scheduledRides/' + scheduleId).update({
        status: 'cancelled',
        cancelledAt: firebase.database.ServerValue.TIMESTAMP
    })
    .then(() => {
        showNotification('Scheduled ride cancelled');
        loadRideHistory();
        
        // Clear timer if exists
        if (scheduledTimers[scheduleId]) {
            clearTimeout(scheduledTimers[scheduleId]);
            delete scheduledTimers[scheduleId];
        }
    })
    .catch(error => {
        console.error('Error cancelling scheduled ride:', error);
        showNotification('Error cancelling scheduled ride');
    });
}

// Edit scheduled ride
function editScheduledRide(scheduleId) {
    database.ref('scheduledRides/' + scheduleId).once('value')
        .then(snapshot => {
            const ride = snapshot.val();
            if (ride) {
                // Show the appropriate schedule form based on schedule type
                if (ride.scheduleType === 'ride-now') {
                    showScheduleRideNowForm();
                    document.getElementById('schedulePickupLocation').value = ride.pickupDisplayLocation || ride.pickupLocation;
                    document.getElementById('scheduleDestinationLocation').value = ride.destination;
                    document.getElementById('scheduleTime').value = new Date(ride.scheduledTime).toISOString().slice(0, 16);
                    
                    // Select vehicle type
                    document.querySelectorAll('.schedule-ride-now-form .vehicle-option').forEach(option => {
                        option.classList.remove('selected');
                        if (option.getAttribute('data-type') === ride.rideType) {
                            option.classList.add('selected');
                        }
                    });
                    
                    // Store the schedule ID for updating
                    document.getElementById('scheduleRideNowBtn').setAttribute('data-schedule-id', scheduleId);
                    document.getElementById('scheduleRideNowBtn').textContent = 'Update Scheduled Ride';
                }
                // Similar handling for other schedule types...
            }
        })
        .catch(error => {
            console.error('Error loading scheduled ride for editing:', error);
            showNotification('Error loading scheduled ride details');
        });
}

// Setup event listeners
function setupEventListeners() {
    // Panel collapse handle
    document.getElementById('panelCollapseHandle').addEventListener('click', function() {
        const panel = document.getElementById('passengerPanel');
        panel.classList.toggle('collapsed');
    });
    
    // Navigation buttons
    document.querySelectorAll('.nav-btn').forEach(button => {
        button.addEventListener('click', function() {
            const screen = this.getAttribute('data-screen');
            switchScreen(screen);
        });
    });
    
    // Back buttons
    document.querySelectorAll('.back-button').forEach(button => {
        button.addEventListener('click', function() {
            const screen = this.getAttribute('data-screen');
            switchScreen(screen);
        });
    });
    
    // Vehicle selection
    document.querySelectorAll('.vehicle-option').forEach(option => {
        option.addEventListener('click', function() {
            const container = this.closest('.vehicle-selection');
            container.querySelectorAll('.vehicle-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            this.classList.add('selected');
            
            selectedVehicleType = this.getAttribute('data-type');
            
            // Update package toggle visibility for delivery vehicles
            if (selectedVehicleType === 'bike' || selectedVehicleType === 'truck') {
                document.getElementById('packageToggle').style.display = 'block';
            } else {
                document.getElementById('packageToggle').style.display = 'none';
                document.getElementById('packageForm').classList.remove('active');
            }
            
            updateFareEstimate();
        });
    });
    
    // Destination input
    document.getElementById('destinationLocation').addEventListener('input', function() {
        updateFareEstimate();
    });
    
    // Request ride button
    document.getElementById('requestRideBtn').addEventListener('click', requestRide);
    
    // Cancel ride button
    document.getElementById('cancelRideBtn').addEventListener('click', cancelCurrentRide);
    
    // Contact driver button
    document.getElementById('contactDriverBtn').addEventListener('click', contactDriver);
    
    // Location refresh (implicit in periodic updates)
    
    // Saved locations
    document.querySelectorAll('.saved-location-btn').forEach(button => {
        button.addEventListener('click', function() {
            const addressType = this.getAttribute('data-address');
            setSavedLocation(addressType);
        });
    });
    
    // Promo toggle
    document.getElementById('promoToggle').addEventListener('click', function() {
        document.getElementById('promoSection').classList.toggle('active');
    });
    
    // Apply promo button
    document.getElementById('applyPromoBtn').addEventListener('click', applyPromoCode);
    
    // Promo code input Enter key
    document.getElementById('promoCode').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            applyPromoCode();
        }
    });
    
    // Package toggle
    document.getElementById('packageToggle').addEventListener('click', function() {
        document.getElementById('packageForm').classList.toggle('active');
    });
    
    // Payment method selection
    document.querySelectorAll('.payment-method').forEach(method => {
        method.addEventListener('click', function() {
            document.querySelectorAll('.payment-method').forEach(m => {
                m.classList.remove('selected');
            });
            this.classList.add('selected');
            paymentMethod = this.getAttribute('data-method');
        });
    });
    
    // Payment selection popup
    document.querySelectorAll('.payment-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.payment-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            this.classList.add('selected');
            selectedPaymentType = this.getAttribute('data-payment-type');
            showPaymentSelection();
        });
    });
    
    // Close payment popup
    document.getElementById('closePaymentPopup').addEventListener('click', closePaymentSelection);
    
    // Confirm payment button
    document.getElementById('confirmPaymentBtn').addEventListener('click', submitRideRequest);
    
    // History filter
    document.getElementById('historyFilter').addEventListener('change', loadRideHistory);
    
    // History date filter
    document.getElementById('historyDate').addEventListener('change', loadRideHistory);
    
    // Close ride popup
    document.getElementById('closeRidePopupTop').addEventListener('click', closeRideDetailsPopup);
    document.getElementById('closeRidePopup').addEventListener('click', closeRideDetailsPopup);
    
    // Generate receipt button
    document.getElementById('generateReceiptBtn').addEventListener('click', generateReceipt);
    
    // Deposit button
    document.getElementById('depositBtn').addEventListener('click', showDepositPopup);
    
    // Withdraw button
    document.getElementById('withdrawBtn').addEventListener('click', showWithdrawPopup);
    
    // Share referral button
    document.getElementById('shareReferralBtn').addEventListener('click', shareReferralCode);
    
    // WhatsApp button
    document.getElementById('whatsappBtn').addEventListener('click', contactWhatsApp);
    
    // Call button
    document.getElementById('callBtn').addEventListener('click', contactPhone);
    
    // Add payment method button
    document.getElementById('addPaymentMethodBtn').addEventListener('click', addPaymentMethod);
    
    // SOS button
    document.getElementById('sosButton').addEventListener('click', triggerSOS);
    
    // Schedule ride button
    document.getElementById('scheduleRideBtn').addEventListener('click', toggleScheduleRideOptions);
    
    // Schedule ride options
    document.querySelectorAll('.schedule-option').forEach(option => {
        option.addEventListener('click', function() {
            const optionType = this.getAttribute('data-option');
            showScheduleForm(optionType);
        });
    });
    
    // Cancel schedule buttons
    document.getElementById('cancelScheduleRideNowBtn').addEventListener('click', hideAllScheduleForms);
    document.getElementById('cancelScheduleDeliveryBtn').addEventListener('click', hideAllScheduleForms);
    document.getElementById('cancelScheduleForSomeoneBtn').addEventListener('click', hideAllScheduleForms);
    document.getElementById('cancelOrderForSomeoneBtn').addEventListener('click', hideOrderForSomeoneForm);
    document.getElementById('cancelExpressDeliveryBtn').addEventListener('click', hideExpressDeliveryForm);
    document.getElementById('cancelSosSetupBtn').addEventListener('click', hideSosSetupForm);
    
    // Schedule ride now button
    document.getElementById('scheduleRideNowBtn').addEventListener('click', scheduleRideNow);
    
    // Schedule delivery button
    document.getElementById('scheduleDeliveryBtn').addEventListener('click', scheduleDelivery);
    
    // Schedule for someone button
    document.getElementById('scheduleForSomeoneBtn').addEventListener('click', scheduleForSomeone);
    
    // More options button
    document.getElementById('moreOptionsBtn').addEventListener('click', toggleMoreOptions);
    
    // More options items
    document.querySelectorAll('.more-option-item').forEach(option => {
        option.addEventListener('click', function() {
            const optionType = this.getAttribute('data-option');
            showMoreOptionForm(optionType);
        });
    });
    
    // Order for someone button
    document.getElementById('orderForSomeoneBtn').addEventListener('click', orderForSomeone);
    
    // Express delivery button
    document.getElementById('expressDeliveryBtn').addEventListener('click', requestExpressDelivery);
    
    // Save SOS button
    document.getElementById('saveSosBtn').addEventListener('click', saveSOSConfig);
    
    // Add stop button
    document.getElementById('addStopBtn').addEventListener('click', addMultiStop);
    
    // Schedule timer controls
    document.getElementById('editScheduleTimerBtn').addEventListener('click', editScheduledTimer);
    document.getElementById('cancelScheduleTimerBtn').addEventListener('click', cancelScheduledTimer);
    
    // Setup search input listeners
    setupSearchInputListeners();
    
    // Click outside to hide suggestions
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.location-input') && !e.target.closest('.suggestion-list')) {
            hideAllSearchSuggestions();
        }
    });
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Escape to hide suggestions and popups
        if (e.key === 'Escape') {
            hideAllSearchSuggestions();
            closePaymentSelection();
            closeRideDetailsPopup();
            closeRatingPopup();
        }
        
        // Ctrl+R to refresh location
        if (e.ctrlKey && e.key === 'r') {
            e.preventDefault();
            refreshPassengerPosition();
        }
    });
    
    // Handle page visibility changes
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden && homeScreenRefreshRequired) {
            refreshPassengerPosition();
            homeScreenRefreshRequired = false;
        }
    });
}

// Switch screen
function switchScreen(screen) {
    // Update navigation buttons
    document.querySelectorAll('.nav-btn').forEach(button => {
        if (button.getAttribute('data-screen') === screen) {
            button.classList.add('active');
        } else {
            button.classList.remove('active');
        }
    });
    
    // Hide all screens
    document.querySelectorAll('.screen-content').forEach(screenElement => {
        screenElement.classList.remove('active');
    });
    
    // Show selected screen
    document.getElementById(screen + 'Screen').classList.add('active');
    
    // Update current screen
    currentScreen = screen;
    
    // Hide floating elements on non-home screens
    const floatingElements = document.querySelectorAll('.home-only');
    if (screen === 'home') {
        floatingElements.forEach(element => {
            element.style.display = 'flex';
        });
        refreshPassengerPosition();
    } else {
        floatingElements.forEach(element => {
            element.style.display = 'none';
        });
        homeScreenRefreshRequired = true;
    }
    
    // Load data for specific screens
    switch(screen) {
        case 'history':
            loadRideHistory();
            break;
        case 'account':
            updateUserStats();
            break;
    }
}

// Set saved location
function setSavedLocation(type) {
    let address = '';
    let lat, lng;
    
    switch(type) {
        case 'home':
            address = 'Home Address';
            // Default coordinates for Lusaka (can be customized by user)
            lat = -15.4167;
            lng = 28.2833;
            break;
        case 'work':
            address = 'Work Address';
            // Default coordinates for Kitwe
            lat = -12.8139;
            lng = 28.2136;
            break;
    }
    
    document.getElementById('destinationLocation').value = address;
    updateManualPickupLocation(lat, lng, address);
    showNotification(`${type} location set`);
}

// Cancel current ride
function cancelCurrentRide() {
    if (!currentRide || !confirm('Are you sure you want to cancel this ride?')) {
        return;
    }
    
    database.ref('rides/' + currentRide.id).update({
        status: 'cancelled',
        cancelledAt: firebase.database.ServerValue.TIMESTAMP,
        cancelledBy: 'passenger'
    })
    .then(() => {
        showNotification('Ride cancelled');
        
        // Notify driver if assigned
        if (currentRide.driverId) {
            database.ref('driverRides/' + currentRide.driverId + '/' + currentRide.id).update({
                status: 'cancelled'
            });
            
            // Send notification to driver
            sendPushNotificationToDriver(currentRide.driverId, 'Ride cancelled by passenger');
        }
        
        resetUIAfterRide();
    })
    .catch(error => {
        console.error('Error cancelling ride:', error);
        showNotification('Error cancelling ride');
    });
}

// Contact driver
function contactDriver() {
    if (!currentRide || !currentRide.driverId) {
        showNotification('No driver assigned');
        return;
    }
    
    database.ref('users/' + currentRide.driverId).once('value')
        .then(snapshot => {
            const driver = snapshot.val();
            if (driver && driver.phone) {
                window.open(`tel:${driver.phone}`, '_blank');
            } else {
                showNotification('Driver phone number not available');
            }
        })
        .catch(error => {
            console.error('Error getting driver phone:', error);
            showNotification('Error contacting driver');
        });
}

// Handle ride completion
function showRideCompletion(ride) {
    document.getElementById('rideStatus').style.display = 'none';
    document.getElementById('estimatedTime').style.display = 'none';
    document.getElementById('sosButton').style.display = 'none';
    
    resetUIAfterRide();
    
    // Process payment if needed
    if (ride.paymentMethod === 'cash' && ride.status === 'completed') {
        showPaymentCompletionPopup(ride);
    }
}

// Handle ride cancellation
function handleRideCancellation(ride) {
    resetUIAfterRide();
    showNotification('Ride was cancelled');
}

// Add destination marker
function addDestinationMarker(lat, lng) {
    // Remove existing destination marker
    removeMarkerFromMap(passengerMap, destinationMarker);
    
    // Add new destination marker
    destinationMarker = addMarkerToMap(passengerMap, [lng, lat], 'car', 'Destination');
}

// Show notification
function showNotification(message, duration = 3000) {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.style.display = 'block';
    
    setTimeout(() => {
        notification.style.display = 'none';
    }, duration);
}

// Update ride status display
function updateRideStatusDisplay(status) {
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    
    switch(status) {
        case 'requested':
            statusDot.className = 'status-dot searching';
            statusText.textContent = 'Searching for driver';
            break;
        case 'accepted':
            statusDot.className = 'status-dot arriving';
            statusText.textContent = 'Driver arriving';
            break;
        case 'arrived':
            statusDot.className = 'status-dot riding';
            statusText.textContent = 'Driver arrived';
            break;
        case 'picked_up':
        case 'started':
            statusDot.className = 'status-dot riding';
            statusText.textContent = 'Trip in progress';
            break;
        case 'completed':
            statusDot.className = 'status-dot riding';
            statusText.textContent = 'Trip completed';
            break;
        default:
            statusDot.className = 'status-dot';
            statusText.textContent = status;
    }
}

// Generate receipt
function generateReceipt() {
    if (!currentRide) {
        showNotification('No ride information available');
        return;
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Receipt Header
    doc.setFontSize(20);
    doc.setTextColor(255, 107, 53);
    doc.text('JUBEL', 105, 20, { align: 'center' });
    
    doc.setFontSize(12);
    doc.setTextColor(100, 100, 100);
    doc.text('Ride Receipt', 105, 30, { align: 'center' });
    
    // Line separator
    doc.setDrawColor(255, 107, 53);
    doc.setLineWidth(0.5);
    doc.line(20, 35, 190, 35);
    
    // Ride Details
    doc.setFontSize(10);
    doc.setTextColor(0, 0, 0);
    
    let yPos = 45;
    
    // Passenger Info
    doc.setFont(undefined, 'bold');
    doc.text('Passenger Information:', 20, yPos);
    doc.setFont(undefined, 'normal');
    yPos += 7;
    doc.text(`Name: ${userData.name || 'Passenger'}`, 20, yPos);
    yPos += 5;
    doc.text(`Phone: ${userData.phone || 'Not provided'}`, 20, yPos);
    yPos += 10;
    
    // Ride Info
    doc.setFont(undefined, 'bold');
    doc.text('Ride Details:', 20, yPos);
    doc.setFont(undefined, 'normal');
    yPos += 7;
    doc.text(`Pickup: ${currentRide.pickupDisplayLocation || currentRide.pickupLocation}`, 20, yPos);
    yPos += 5;
    doc.text(`Destination: ${currentRide.destination}`, 20, yPos);
    yPos += 5;
    doc.text(`Distance: ${currentRide.distance || 'N/A'}`, 20, yPos);
    yPos += 5;
    doc.text(`Vehicle Type: ${vehicleConfigs[currentRide.rideType]?.name || 'Standard'}`, 20, yPos);
    yPos += 10;
    
    // Fare Breakdown
    doc.setFont(undefined, 'bold');
    doc.text('Fare Breakdown:', 20, yPos);
    doc.setFont(undefined, 'normal');
    yPos += 7;
    
    const baseFare = currentRide.fare || 0;
    const discount = appliedPromoCode ? baseFare * 0.5 : 0;
    const totalFare = baseFare - discount;
    
    doc.text(`Base Fare: K${baseFare.toFixed(2)}`, 20, yPos);
    yPos += 5;
    
    if (discount > 0) {
        doc.text(`Promo Discount: -K${discount.toFixed(2)}`, 20, yPos);
        yPos += 5;
    }
    
    doc.setFont(undefined, 'bold');
    doc.text(`Total Fare: K${totalFare.toFixed(2)}`, 20, yPos);
    yPos += 10;
    
    // Payment Info
    doc.setFont(undefined, 'normal');
    doc.text(`Payment Method: ${selectedPaymentType === 'wallet' ? 'Jubel Wallet' : selectedPaymentType === 'cash' ? 'Cash' : 'Mobile Money'}`, 20, yPos);
    yPos += 5;
    
    const date = new Date(currentRide.timestamp);
    doc.text(`Date: ${date.toLocaleDateString()}`, 20, yPos);
    yPos += 5;
    doc.text(`Time: ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`, 20, yPos);
    yPos += 10;
    
    // Footer
    doc.setFontSize(8);
    doc.setTextColor(150, 150, 150);
    doc.text('Thank you for choosing Jubel!', 105, yPos, { align: 'center' });
    yPos += 5;
    doc.text('For support, contact: support@jubel.com', 105, yPos, { align: 'center' });
    
    // Save the PDF
    const fileName = `Jubel_Receipt_${currentRide.id}_${date.getTime()}.pdf`;
    doc.save(fileName);
    
    showNotification('Receipt downloaded successfully');
}

// Show deposit popup
function showDepositPopup() {
    const amount = prompt('Enter deposit amount (K):', '50');
    if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
        const depositAmount = parseFloat(amount);
        const newBalance = walletBalance + depositAmount;
        
        database.ref('users/' + currentUser.uid).update({
            walletBalance: newBalance
        })
        .then(() => {
            walletBalance = newBalance;
            updateWalletBalanceUI();
            showNotification(`Successfully deposited K${depositAmount.toFixed(2)}`);
            
            // Record transaction
            database.ref('transactions').push().set({
                userId: currentUser.uid,
                type: 'deposit',
                amount: depositAmount,
                previousBalance: walletBalance - depositAmount,
                newBalance: walletBalance,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                status: 'completed'
            });
        })
        .catch(error => {
            console.error('Error depositing:', error);
            showNotification('Error processing deposit');
        });
    }
}

// Show withdraw popup
function showWithdrawPopup() {
    if (walletBalance <= 0) {
        showNotification('No balance to withdraw');
        return;
    }
    
    const amount = prompt(`Enter withdrawal amount (K${walletBalance.toFixed(2)} available):`, walletBalance.toFixed(2));
    if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
        const withdrawAmount = parseFloat(amount);
        
        if (withdrawAmount > walletBalance) {
            showNotification('Insufficient balance');
            return;
        }
        
        const newBalance = walletBalance - withdrawAmount;
        
        database.ref('users/' + currentUser.uid).update({
            walletBalance: newBalance
        })
        .then(() => {
            walletBalance = newBalance;
            updateWalletBalanceUI();
            showNotification(`Withdrawal of K${withdrawAmount.toFixed(2)} requested`);
            
            // Record transaction
            database.ref('transactions').push().set({
                userId: currentUser.uid,
                type: 'withdrawal',
                amount: withdrawAmount,
                previousBalance: walletBalance + withdrawAmount,
                newBalance: walletBalance,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                status: 'pending' // Will be processed by admin
            });
        })
        .catch(error => {
            console.error('Error withdrawing:', error);
            showNotification('Error processing withdrawal');
        });
    }
}

// Share referral code
function shareReferralCode() {
    const referralCode = document.getElementById('referralCode').textContent;
    const shareText = `Join me on Jubel! Use my referral code ${referralCode} for 50% off your first ride. Download the app now!`;
    
    if (navigator.share) {
        navigator.share({
            title: 'Join Jubel',
            text: shareText,
            url: 'https://jubel.app'
        })
        .then(() => console.log('Share successful'))
        .catch(error => console.error('Share error:', error));
    } else {
        // Fallback for browsers that don't support Web Share API
        navigator.clipboard.writeText(shareText)
            .then(() => showNotification('Referral link copied to clipboard'))
            .catch(err => {
                console.error('Copy error:', err);
                showNotification('Failed to copy referral link');
            });
    }
}

// Contact WhatsApp
function contactWhatsApp() {
    const phone = '+260960000000'; // Replace with actual support number
    const message = encodeURIComponent(`Hello Jubel Support, I need assistance. My user ID is ${currentUser.uid}`);
    window.open(`https://wa.me/${phone}?text=${message}`, '_blank');
}

// Contact phone
function contactPhone() {
    const phone = '+260960000000'; // Replace with actual support number
    window.open(`tel:${phone}`, '_blank');
}

// Add payment method
function addPaymentMethod() {
    showNotification('Payment method feature coming soon!');
}

// Toggle schedule ride options
function toggleScheduleRideOptions() {
    document.getElementById('scheduleRideOptions').classList.toggle('active');
}

// Show schedule form
function showScheduleForm(scheduleType) {
    hideAllScheduleForms();
    hideAllMoreOptionForms();
    
    switch(scheduleType) {
        case 'ride-now':
            document.getElementById('scheduleRideNowForm').classList.add('active');
            break;
        case 'delivery':
            document.getElementById('scheduleDeliveryForm').classList.add('active');
            break;
        case 'schedule-for-someone':
            document.getElementById('scheduleForSomeoneForm').classList.add('active');
            break;
    }
    
    activeScheduleOption = scheduleType;
    document.getElementById('scheduleRideOptions').classList.remove('active');
}

// Hide all schedule forms
function hideAllScheduleForms() {
    document.getElementById('scheduleRideNowForm').classList.remove('active');
    document.getElementById('scheduleDeliveryForm').classList.remove('active');
    document.getElementById('scheduleForSomeoneForm').classList.remove('active');
    
    // Clear forms
    document.getElementById('schedulePickupLocation').value = '';
    document.getElementById('scheduleDestinationLocation').value = '';
    document.getElementById('scheduleTime').value = '';
    document.getElementById('scheduleDeliveryPickup').value = '';
    document.getElementById('scheduleDeliveryDestination').value = '';
    document.getElementById('scheduleDeliveryTime').value = '';
    document.getElementById('schedulePackageDetails').value = '';
    document.getElementById('scheduleSomeonePickup').value = '';
    document.getElementById('scheduleSomeoneDestination').value = '';
    document.getElementById('scheduleSomeoneTime').value = '';
    document.getElementById('recipientScheduleName').value = '';
    document.getElementById('recipientSchedulePhone').value = '';
    
    activeScheduleOption = null;
}

// Schedule ride now
function scheduleRideNow() {
    const pickupLocation = document.getElementById('schedulePickupLocation').value;
    const destinationLocation = document.getElementById('scheduleDestinationLocation').value;
    const scheduleTime = document.getElementById('scheduleTime').value;
    
    if (!pickupLocation || !destinationLocation || !scheduleTime) {
        showNotification('Please fill all required fields');
        return;
    }
    
    const selectedOption = document.querySelector('.schedule-ride-now-form .vehicle-option.selected');
    const vehicleType = selectedOption ? selectedOption.getAttribute('data-type') : 'car';
    
    // Get coordinates for pickup and destination
    Promise.all([
        forwardGeocode(pickupLocation),
        forwardGeocode(destinationLocation)
    ]).then(([pickupResults, destinationResults]) => {
        if (pickupResults.length === 0 || destinationResults.length === 0) {
            showNotification('Invalid pickup or destination address');
            return;
        }
        
        const pickupLat = parseFloat(pickupResults[0].lat);
        const pickupLng = parseFloat(pickupResults[0].lon);
        const destLat = parseFloat(destinationResults[0].lat);
        const destLng = parseFloat(destinationResults[0].lon);
        
        const distance = calculateDistance(pickupLat, pickupLng, destLat, destLng);
        const distanceKm = distance / 1000;
        
        const vehicleConfig = vehicleConfigs[vehicleType] || vehicleConfigs.car;
        let baseFare = vehicleConfig.baseFare;
        
        if (distanceKm > 0) {
            baseFare += Math.ceil(distanceKm * 5);
        }
        
        baseFare = baseFare * vehicleConfig.multiplier;
        baseFare = Math.max(15, baseFare);
        
        const scheduleId = database.ref().child('scheduledRides').push().key;
        
        const scheduledRide = {
            id: scheduleId,
            passengerId: currentUser.uid,
            passengerName: userData.name || 'Passenger',
            passengerPhone: userData.phone || 'Not provided',
            pickupLocation: pickupResults[0].display_name || pickupLocation,
            pickupDisplayLocation: pickupLocation,
            destination: destinationResults[0].display_name || destinationLocation,
            pickupLat: pickupLat,
            pickupLng: pickupLng,
            destLat: destLat,
            destLng: destLng,
            rideType: vehicleType,
            fare: baseFare,
            distance: distanceKm.toFixed(2) + ' km',
            scheduledTime: new Date(scheduleTime).getTime(),
            scheduleType: 'ride-now',
            status: 'scheduled',
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            paymentMethod: 'cash',
            currentCity: currentCity
        };
        
        // Check if this is an update
        const scheduleIdToUpdate = document.getElementById('scheduleRideNowBtn').getAttribute('data-schedule-id');
        const rideId = scheduleIdToUpdate || scheduleId;
        
        if (scheduleIdToUpdate) {
            scheduledRide.id = scheduleIdToUpdate;
            database.ref('scheduledRides/' + scheduleIdToUpdate).update(scheduledRide)
                .then(() => {
                    showNotification('Scheduled ride updated successfully');
                    hideAllScheduleForms();
                    loadRideHistory();
                })
                .catch(error => {
                    console.error('Error updating scheduled ride:', error);
                    showNotification('Error updating scheduled ride');
                });
        } else {
            database.ref('scheduledRides/' + scheduleId).set(scheduledRide)
                .then(() => {
                    showNotification('Ride scheduled successfully');
                    hideAllScheduleForms();
                    
                    // Setup timer for scheduled ride
                    setupScheduledRideTimer(scheduledRide);
                    
                    // Show schedule timer display
                    showScheduleTimerDisplay(scheduledRide);
                })
                .catch(error => {
                    console.error('Error scheduling ride:', error);
                    showNotification('Error scheduling ride');
                });
        }
    }).catch(error => {
        console.error('Error in schedule ride process:', error);
        showNotification('Error calculating route');
    });
}

// Schedule delivery
function scheduleDelivery() {
    const pickupLocation = document.getElementById('scheduleDeliveryPickup').value;
    const destinationLocation = document.getElementById('scheduleDeliveryDestination').value;
    const scheduleTime = document.getElementById('scheduleDeliveryTime').value;
    const packageDetails = document.getElementById('schedulePackageDetails').value;
    
    if (!pickupLocation || !destinationLocation || !scheduleTime || !packageDetails) {
        showNotification('Please fill all required fields');
        return;
    }
    
    const selectedOption = document.querySelector('.schedule-delivery-form .vehicle-option.selected');
    const vehicleType = selectedOption ? selectedOption.getAttribute('data-type') : 'bike';
    
    Promise.all([
        forwardGeocode(pickupLocation),
        forwardGeocode(destinationLocation)
    ]).then(([pickupResults, destinationResults]) => {
        if (pickupResults.length === 0 || destinationResults.length === 0) {
            showNotification('Invalid pickup or destination address');
            return;
        }
        
        const pickupLat = parseFloat(pickupResults[0].lat);
        const pickupLng = parseFloat(pickupResults[0].lon);
        const destLat = parseFloat(destinationResults[0].lat);
        const destLng = parseFloat(destinationResults[0].lon);
        
        const distance = calculateDistance(pickupLat, pickupLng, destLat, destLng);
        const distanceKm = distance / 1000;
        
        const vehicleConfig = vehicleConfigs[vehicleType] || vehicleConfigs.bike;
        let baseFare = vehicleConfig.baseFare;
        
        if (distanceKm > 0) {
            baseFare += Math.ceil(distanceKm * 5);
        }
        
        baseFare = baseFare * vehicleConfig.multiplier;
        baseFare = Math.max(15, baseFare);
        
        const scheduleId = database.ref().child('scheduledRides').push().key;
        
        const scheduledRide = {
            id: scheduleId,
            passengerId: currentUser.uid,
            passengerName: userData.name || 'Passenger',
            passengerPhone: userData.phone || 'Not provided',
            pickupLocation: pickupResults[0].display_name || pickupLocation,
            pickupDisplayLocation: pickupLocation,
            destination: destinationResults[0].display_name || destinationLocation,
            pickupLat: pickupLat,
            pickupLng: pickupLng,
            destLat: destLat,
            destLng: destLng,
            rideType: vehicleType,
            fare: baseFare,
            distance: distanceKm.toFixed(2) + ' km',
            scheduledTime: new Date(scheduleTime).getTime(),
            scheduleType: 'delivery',
            status: 'scheduled',
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            paymentMethod: 'cash',
            packageDetails: packageDetails,
            currentCity: currentCity
        };
        
        database.ref('scheduledRides/' + scheduleId).set(scheduledRide)
            .then(() => {
                showNotification('Delivery scheduled successfully');
                hideAllScheduleForms();
                
                // Setup timer for scheduled ride
                setupScheduledRideTimer(scheduledRide);
                
                // Show schedule timer display
                showScheduleTimerDisplay(scheduledRide);
            })
            .catch(error => {
                console.error('Error scheduling delivery:', error);
                showNotification('Error scheduling delivery');
            });
    }).catch(error => {
        console.error('Error in schedule delivery process:', error);
        showNotification('Error calculating route');
    });
}

// Schedule for someone
function scheduleForSomeone() {
    const pickupLocation = document.getElementById('scheduleSomeonePickup').value;
    const destinationLocation = document.getElementById('scheduleSomeoneDestination').value;
    const scheduleTime = document.getElementById('scheduleSomeoneTime').value;
    const recipientName = document.getElementById('recipientScheduleName').value;
    const recipientPhone = document.getElementById('recipientSchedulePhone').value;
    
    if (!pickupLocation || !destinationLocation || !scheduleTime || !recipientName || !recipientPhone) {
        showNotification('Please fill all required fields');
        return;
    }
    
    const selectedOption = document.querySelector('.schedule-for-someone-form .vehicle-option.selected');
    const vehicleType = selectedOption ? selectedOption.getAttribute('data-type') : 'car';
    
    Promise.all([
        forwardGeocode(pickupLocation),
        forwardGeocode(destinationLocation)
    ]).then(([pickupResults, destinationResults]) => {
        if (pickupResults.length === 0 || destinationResults.length === 0) {
            showNotification('Invalid pickup or destination address');
            return;
        }
        
        const pickupLat = parseFloat(pickupResults[0].lat);
        const pickupLng = parseFloat(pickupResults[0].lon);
        const destLat = parseFloat(destinationResults[0].lat);
        const destLng = parseFloat(destinationResults[0].lon);
        
        const distance = calculateDistance(pickupLat, pickupLng, destLat, destLng);
        const distanceKm = distance / 1000;
        
        const vehicleConfig = vehicleConfigs[vehicleType] || vehicleConfigs.car;
        let baseFare = vehicleConfig.baseFare;
        
        if (distanceKm > 0) {
            baseFare += Math.ceil(distanceKm * 5);
        }
        
        baseFare = baseFare * vehicleConfig.multiplier;
        baseFare = Math.max(15, baseFare);
        
        const scheduleId = database.ref().child('scheduledRides').push().key;
        
        const scheduledRide = {
            id: scheduleId,
            passengerId: currentUser.uid,
            passengerName: userData.name || 'Passenger',
            passengerPhone: userData.phone || 'Not provided',
            pickupLocation: pickupResults[0].display_name || pickupLocation,
            pickupDisplayLocation: pickupLocation,
            destination: destinationResults[0].display_name || destinationLocation,
            pickupLat: pickupLat,
            pickupLng: pickupLng,
            destLat: destLat,
            destLng: destLng,
            rideType: vehicleType,
            fare: baseFare,
            distance: distanceKm.toFixed(2) + ' km',
            scheduledTime: new Date(scheduleTime).getTime(),
            scheduleType: 'schedule-for-someone',
            status: 'scheduled',
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            paymentMethod: 'cash',
            recipientDetails: {
                name: recipientName,
                phone: recipientPhone
            },
            currentCity: currentCity
        };
        
        database.ref('scheduledRides/' + scheduleId).set(scheduledRide)
            .then(() => {
                showNotification('Ride scheduled for recipient successfully');
                hideAllScheduleForms();
                
                // Setup timer for scheduled ride
                setupScheduledRideTimer(scheduledRide);
                
                // Show schedule timer display
                showScheduleTimerDisplay(scheduledRide);
            })
            .catch(error => {
                console.error('Error scheduling ride for someone:', error);
                showNotification('Error scheduling ride for someone');
            });
    }).catch(error => {
        console.error('Error in schedule for someone process:', error);
        showNotification('Error calculating route');
    });
}

// Show schedule timer display
function showScheduleTimerDisplay(scheduledRide) {
    const timerDisplay = document.getElementById('scheduleTimerDisplay');
    const timerTime = document.getElementById('scheduleTimerTime');
    const timerDestination = document.getElementById('scheduleTimerDestination');
    
    timerDestination.textContent = `To: ${scheduledRide.destination}`;
    timerDisplay.style.display = 'block';
    
    // Start countdown timer
    startScheduleTimer(scheduledRide);
}

// Start schedule timer
function startScheduleTimer(scheduledRide) {
    if (currentScheduleTimer) {
        clearInterval(currentScheduleTimer);
    }
    
    function updateTimer() {
        const now = new Date().getTime();
        const scheduledTime = new Date(scheduledRide.scheduledTime).getTime();
        const timeDiff = scheduledTime - now;
        
        if (timeDiff <= 0) {
            clearInterval(currentScheduleTimer);
            document.getElementById('scheduleTimerTime').textContent = '00:00:00';
            return;
        }
        
        const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);
        
        document.getElementById('scheduleTimerTime').textContent = 
            `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    
    updateTimer();
    currentScheduleTimer = setInterval(updateTimer, 1000);
}

// Edit scheduled timer
function editScheduledTimer() {
    hideAllScheduleForms();
    showScheduleRideOptions();
}

// Cancel scheduled timer
function cancelScheduledTimer() {
    if (confirm('Are you sure you want to cancel this scheduled ride?')) {
        // Find and cancel the scheduled ride
        const scheduledRides = Object.values(scheduledRides);
        const activeScheduled = scheduledRides.find(ride => ride.status === 'scheduled');
        
        if (activeScheduled) {
            cancelScheduledRide(activeScheduled.id);
        }
        
        document.getElementById('scheduleTimerDisplay').style.display = 'none';
        if (currentScheduleTimer) {
            clearInterval(currentScheduleTimer);
            currentScheduleTimer = null;
        }
    }
}

// Show schedule ride options
function showScheduleRideOptions() {
    document.getElementById('scheduleRideOptions').classList.add('active');
}

// Toggle more options
function toggleMoreOptions() {
    document.getElementById('moreOptionsDropdown').classList.toggle('active');
}

// Show more option form
function showMoreOptionForm(optionType) {
    hideAllScheduleForms();
    hideAllMoreOptionForms();
    
    switch(optionType) {
        case 'order-for-someone':
            document.getElementById('orderForSomeoneForm').classList.add('active');
            break;
        case 'express-delivery':
            document.getElementById('expressDeliveryForm').classList.add('active');
            break;
        case 'multi-stop':
            document.getElementById('multiStopForm').classList.add('active');
            break;
        case 'sos-setup':
            document.getElementById('sosSetupForm').classList.add('active');
            break;
    }
    
    activeMoreOption = optionType;
    document.getElementById('moreOptionsDropdown').classList.remove('active');
}

// Hide all more option forms
function hideAllMoreOptionForms() {
    document.getElementById('orderForSomeoneForm').classList.remove('active');
    document.getElementById('expressDeliveryForm').classList.remove('active');
    document.getElementById('multiStopForm').classList.remove('active');
    document.getElementById('sosSetupForm').classList.remove('active');
    
    // Clear forms
    document.getElementById('recipientPickupLocation').value = '';
    document.getElementById('recipientDestinationLocation').value = '';
    document.getElementById('recipientName').value = '';
    document.getElementById('recipientEmail').value = '';
    document.getElementById('recipientPhone').value = '';
    document.getElementById('shopName').value = '';
    document.getElementById('shopLocation').value = '';
    document.getElementById('deliveryItems').value = '';
    document.getElementById('deliveryAmount').value = '';
    document.getElementById('deliveryInstructions').value = '';
    document.getElementById('deliveryDestination').value = '';
    
    activeMoreOption = null;
}

// Hide order for someone form
function hideOrderForSomeoneForm() {
    document.getElementById('orderForSomeoneForm').classList.remove('active');
}

// Hide express delivery form
function hideExpressDeliveryForm() {
    document.getElementById('expressDeliveryForm').classList.remove('active');
}

// Hide SOS setup form
function hideSosSetupForm() {
    document.getElementById('sosSetupForm').classList.remove('active');
}

// Order for someone
function orderForSomeone() {
    const pickupLocation = document.getElementById('recipientPickupLocation').value;
    const destinationLocation = document.getElementById('recipientDestinationLocation').value;
    const recipientName = document.getElementById('recipientName').value;
    const recipientEmail = document.getElementById('recipientEmail').value;
    const recipientPhone = document.getElementById('recipientPhone').value;
    
    if (!pickupLocation || !destinationLocation || !recipientName || !recipientPhone) {
        showNotification('Please fill all required fields');
        return;
    }
    
    Promise.all([
        forwardGeocode(pickupLocation),
        forwardGeocode(destinationLocation)
    ]).then(([pickupResults, destinationResults]) => {
        if (pickupResults.length === 0 || destinationResults.length === 0) {
            showNotification('Invalid pickup or destination address');
            return;
        }
        
        const pickupLat = parseFloat(pickupResults[0].lat);
        const pickupLng = parseFloat(pickupResults[0].lon);
        const destLat = parseFloat(destinationResults[0].lat);
        const destLng = parseFloat(destinationResults[0].lon);
        
        const distance = calculateDistance(pickupLat, pickupLng, destLat, destLng);
        const distanceKm = distance / 1000;
        
        const vehicleConfig = vehicleConfigs.car;
        let baseFare = vehicleConfig.baseFare;
        
        if (distanceKm > 0) {
            baseFare += Math.ceil(distanceKm * 5);
        }
        
        baseFare = baseFare * vehicleConfig.multiplier;
        baseFare = Math.max(15, baseFare);
        
        const rideId = database.ref().child('rides').push().key;
        
        const rideRequest = {
            id: rideId,
            passengerId: currentUser.uid,
            passengerName: userData.name || 'Passenger',
            passengerPhone: userData.phone || 'Not provided',
            pickupLocation: pickupResults[0].display_name || pickupLocation,
            pickupDisplayLocation: pickupLocation,
            destination: destinationResults[0].display_name || destinationLocation,
            pickupLat: pickupLat,
            pickupLng: pickupLng,
            destLat: destLat,
            destLng: destLng,
            rideType: 'car',
            fare: baseFare,
            distance: distanceKm.toFixed(2) + ' km',
            status: 'requested',
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            updatedAt: firebase.database.ServerValue.TIMESTAMP,
            paymentMethod: 'cash',
            orderForSomeone: {
                name: recipientName,
                email: recipientEmail,
                phone: recipientPhone
            },
            currentCity: currentCity
        };
        
        database.ref('rides/' + rideId).set(rideRequest)
            .then(() => {
                currentRide = rideRequest;
                
                hideOrderForSomeoneForm();
                
                updateUIForActiveRide();
                
                document.getElementById('searchingAnimation').style.display = 'flex';
                
                document.getElementById('rideStatus').style.display = 'flex';
                document.getElementById('statusDot').className = 'status-dot searching';
                document.getElementById('statusText').textContent = 'Searching for driver';
                
                if (sosConfig && sosConfig.contact1) {
                    document.getElementById('sosButton').style.display = 'flex';
                }
                
                showNotification('Ride requested for recipient. Searching for a driver...');
                
                listenForDriverAssignment(rideId);
            })
            .catch(error => {
                console.error('Error requesting ride for someone:', error);
                showNotification('Error requesting ride');
            });
    }).catch(error => {
        console.error('Error in order for someone process:', error);
        showNotification('Error calculating route');
    });
}

// Request express delivery
function requestExpressDelivery() {
    const shopName = document.getElementById('shopName').value;
    const shopLocation = document.getElementById('shopLocation').value;
    const deliveryItems = document.getElementById('deliveryItems').value;
    const deliveryAmount = document.getElementById('deliveryAmount').value;
    const deliveryInstructions = document.getElementById('deliveryInstructions').value;
    const deliveryDestination = document.getElementById('deliveryDestination').value;
    
    if (!shopName || !shopLocation || !deliveryItems || !deliveryAmount || !deliveryDestination) {
        showNotification('Please fill all required fields');
        return;
    }
    
    const selectedOption = document.querySelector('.express-delivery-form .vehicle-option.selected');
    const vehicleType = selectedOption ? selectedOption.getAttribute('data-type') : 'bike';
    
    Promise.all([
        forwardGeocode(shopLocation),
        forwardGeocode(deliveryDestination)
    ]).then(([shopResults, destinationResults]) => {
        if (shopResults.length === 0 || destinationResults.length === 0) {
            showNotification('Invalid shop or delivery address');
            return;
        }
        
        const shopLat = parseFloat(shopResults[0].lat);
        const shopLng = parseFloat(shopResults[0].lon);
        const destLat = parseFloat(destinationResults[0].lat);
        const destLng = parseFloat(destinationResults[0].lon);
        
        const distance = calculateDistance(shopLat, shopLng, destLat, destLng);
        const distanceKm = distance / 1000;
        
        const vehicleConfig = vehicleConfigs[vehicleType] || vehicleConfigs.bike;
        let baseFare = vehicleConfig.baseFare;
        
        if (distanceKm > 0) {
            baseFare += Math.ceil(distanceKm * 5);
        }
        
        baseFare = baseFare * vehicleConfig.multiplier;
        baseFare = Math.max(15, baseFare);
        
        const rideId = database.ref().child('rides').push().key;
        
        const rideRequest = {
            id: rideId,
            passengerId: currentUser.uid,
            passengerName: userData.name || 'Passenger',
            passengerPhone: userData.phone || 'Not provided',
            pickupLocation: shopResults[0].display_name || shopLocation,
            pickupDisplayLocation: shopLocation,
            destination: destinationResults[0].display_name || deliveryDestination,
            pickupLat: shopLat,
            pickupLng: shopLng,
            destLat: destLat,
            destLng: destLng,
            rideType: vehicleType,
            fare: baseFare,
            distance: distanceKm.toFixed(2) + ' km',
            status: 'requested',
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            updatedAt: firebase.database.ServerValue.TIMESTAMP,
            paymentMethod: 'cash',
            expressDelivery: {
                shopName: shopName,
                items: deliveryItems,
                amount: parseFloat(deliveryAmount),
                instructions: deliveryInstructions
            },
            currentCity: currentCity
        };
        
        database.ref('rides/' + rideId).set(rideRequest)
            .then(() => {
                currentRide = rideRequest;
                
                hideExpressDeliveryForm();
                
                updateUIForActiveRide();
                
                document.getElementById('searchingAnimation').style.display = 'flex';
                
                document.getElementById('rideStatus').style.display = 'flex';
                document.getElementById('statusDot').className = 'status-dot searching';
                document.getElementById('statusText').textContent = 'Searching for driver';
                
                if (sosConfig && sosConfig.contact1) {
                    document.getElementById('sosButton').style.display = 'flex';
                }
                
                showNotification('Express delivery requested. Searching for a driver...');
                
                listenForDriverAssignment(rideId);
            })
            .catch(error => {
                console.error('Error requesting express delivery:', error);
                showNotification('Error requesting delivery');
            });
    }).catch(error => {
        console.error('Error in express delivery process:', error);
        showNotification('Error calculating route');
    });
}

// Save SOS config
function saveSOSConfig() {
    const contact1 = document.getElementById('emergencyContact1').value.trim();
    const contact2 = document.getElementById('emergencyContact2').value.trim();
    const message = document.getElementById('sosMessage').value.trim();
    
    if (!contact1) {
        showNotification('Please provide at least one emergency contact');
        return;
    }
    
    sosConfig = {
        contact1: contact1,
        contact2: contact2,
        message: message || 'I need help! My current location and ride details will be shared with you.',
        updatedAt: firebase.database.ServerValue.TIMESTAMP
    };
    
    database.ref('sosConfig/' + currentUser.uid).set(sosConfig)
        .then(() => {
            showNotification('SOS configuration saved successfully');
            hideSosSetupForm();
            
            // Show SOS button if we have an active ride
            if (currentRide) {
                document.getElementById('sosButton').style.display = 'flex';
            }
        })
        .catch(error => {
            console.error('Error saving SOS config:', error);
            showNotification('Error saving SOS configuration');
        });
}

// Add multi-stop
function addMultiStop() {
    const container = document.getElementById('multiStopContainer');
    const stopCount = container.children.length + 1;
    
    const stopItem = document.createElement('div');
    stopItem.className = 'multi-stop-item';
    stopItem.innerHTML = `
        <div class="multi-stop-number">${stopCount}</div>
        <input type="text" class="multi-stop-input" placeholder="Stop location">
        <div class="suggestion-list multi-stop-suggestions"></div>
    `;
    
    container.appendChild(stopItem);
    
    // Setup search for the new input
    const input = stopItem.querySelector('.multi-stop-input');
    input.addEventListener('input', function() {
        const query = this.value.trim();
        if (query.length >= 2) {
            searchPlacesEnhanced(query, 'multi-stop');
        }
    });
    
    currentMultiStopCount = stopCount;
}

// Trigger SOS
function triggerSOS() {
    if (!sosConfig || !sosConfig.contact1) {
        showNotification('SOS not configured. Please set up emergency contacts first.');
        return;
    }
    
    if (!confirm('Trigger emergency SOS? Your location and ride details will be sent to your emergency contacts.')) {
        return;
    }
    
    let locationInfo = 'Unable to get current location';
    if (userLocation) {
        locationInfo = `https://maps.google.com/?q=${userLocation.lat},${userLocation.lng}`;
    }
    
    let rideInfo = 'No active ride';
    if (currentRide) {
        rideInfo = `Ride to: ${currentRide.destination}. Driver: ${currentRide.driverName || 'Not assigned'}`;
    }
    
    const message = `${sosConfig.message}\n\nLocation: ${locationInfo}\n${rideInfo}\nTime: ${new Date().toLocaleString()}`;
    
    // Send SMS to emergency contacts
    if (sosConfig.contact1) {
        sendEmergencySMS(sosConfig.contact1, message);
    }
    
    if (sosConfig.contact2) {
        sendEmergencySMS(sosConfig.contact2, message);
    }
    
    // Also notify Jubel support
    database.ref('emergencyAlerts').push().set({
        userId: currentUser.uid,
        userName: userData.name || 'Passenger',
        location: userLocation,
        rideId: currentRide ? currentRide.id : null,
        message: message,
        timestamp: firebase.database.ServerValue.TIMESTAMP
    });
    
    showNotification('Emergency alert sent to your contacts and Jubel support');
}

// Send emergency SMS
function sendEmergencySMS(phoneNumber, message) {
    // This would typically integrate with an SMS gateway
    console.log(`Sending emergency SMS to ${phoneNumber}: ${message}`);
    
    // For demo purposes, we'll just show a notification
    showNotification(`Emergency alert would be sent to ${phoneNumber} via SMS gateway`);
}

// Start driver message listener
function startDriverMessageListener(rideId) {
    if (driverMessageListener) {
        driverMessageListener();
    }
    
    driverMessageListener = database.ref('chats/' + rideId).orderByChild('timestamp').limitToLast(1).on('child_added', snapshot => {
        const message = snapshot.val();
        
        // Only show notification if message is from driver and chat popup is closed
        if (message.senderId !== currentUser.uid && !chatPopupClosedByUser) {
            showNotification(`Driver: ${message.message}`);
        }
    });
}

// Send push notification to driver
function sendPushNotificationToDriver(driverId, message) {
    // This would integrate with Firebase Cloud Messaging or another push notification service
    database.ref('driverNotifications/' + driverId).push().set({
        message: message,
        rideId: currentRide ? currentRide.id : null,
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        read: false
    });
}

// Show payment completion popup
function showPaymentCompletionPopup(ride) {
    const popup = document.createElement('div');
    popup.className = 'popup-overlay';
    popup.innerHTML = `
        <div class="popup-form">
            <div class="popup-header">
                <h2 class="popup-title">
                    <i class="fas fa-money-bill-wave"></i>
                    Payment Required
                </h2>
            </div>
            <div class="popup-content">
                <p style="text-align: center; margin-bottom: 20px;">
                    Your ride has been completed. Please pay the driver K${ride.fare ? ride.fare.toFixed(2) : '0.00'} in cash.
                </p>
                <div style="text-align: center;">
                    <button class="request-ride-btn" onclick="markRideAsPaid('${ride.id}')">
                        <i class="fas fa-check"></i> I Have Paid
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(popup);
}

// Mark ride as paid
function markRideAsPaid(rideId) {
    database.ref('rides/' + rideId).update({
        status: 'paid',
        paidAt: firebase.database.ServerValue.TIMESTAMP
    })
    .then(() => {
        document.querySelector('.popup-overlay').remove();
        showNotification('Payment confirmed. Thank you!');
    })
    .catch(error => {
        console.error('Error marking ride as paid:', error);
        showNotification('Error confirming payment');
    });
}

// Initialize the app
console.log('Jubel Passenger App Initialized');
</script>
</body>
</html>
