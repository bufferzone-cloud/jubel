<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jubel - Passenger</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Enhanced CSS with all requested features */
        :root {
            --primary-orange: #FF6B35;
            --primary-red: #E74C3C;
            --primary-gradient: linear-gradient(135deg, #FF6B35, #E74C3C);
            --secondary-orange: #E55A28;
            --secondary-red: #C0392B;
            --light-orange: #FFE8E0;
            --light-red: #FADBD8;
            --white: #FFFFFF;
            --light-gray: #F5F5F5;
            --dark-gray: #333333;
            --medium-gray: #777777;
            --success-green: #2ecc71;
            --warning-yellow: #f39c12;
            --info-blue: #3498db;
            --error-red: #e74c3c;
            --border-color: #E8E8E8;
            --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 4px 15px rgba(0, 0, 0, 0.15);
            --shadow-heavy: 0 6px 20px rgba(0, 0, 0, 0.2);
            --app-padding: 10px;
            --element-radius: 6px;
            --transition-speed: 0.3s;
            --city-highlight: #FF9800;
            --search-highlight: #FFF3E0;
            --fast-transition: 0.15s;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--white);
            color: var(--dark-gray);
            max-width: 100%;
            overflow-x: hidden;
            height: 100vh;
            font-size: 13px;
        }
        
        /* Main App */
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        .floating-balance {
            position: fixed;
            top: 10px;
            right: 10px;
            background: var(--white);
            padding: 6px 10px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 700;
            color: var(--dark-gray);
            border: 2px solid var(--primary-orange);
            font-size: 0.75rem;
        }
        
        .balance-amount {
            color: var(--primary-orange);
            font-size: 0.8rem;
        }
        
        .passenger-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            border-radius: 15px 15px 0 0;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
            z-index: 100;
            padding: var(--app-padding);
            transform: translateY(0);
            transition: transform var(--transition-speed) ease;
            max-height: 45vh;
            overflow-y: auto;
        }
        
        .passenger-panel.collapsed {
            transform: translateY(calc(100% - 40px));
        }
        
        .panel-collapse-handle {
            width: 35px;
            height: 3px;
            background: var(--border-color);
            border-radius: 2px;
            margin: 0 auto 8px;
            cursor: pointer;
        }
        
        .nav-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            padding: 6px 3px;
            border-radius: var(--element-radius);
            background: var(--light-gray);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            border: none;
            font-size: 0.6rem;
            font-weight: 600;
        }
        
        .nav-btn.active {
            background: var(--primary-gradient);
            color: var(--white);
        }
        
        .nav-btn i {
            font-size: 0.8rem;
        }
        
        /* Schedule Ride Button */
        .schedule-ride-btn {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--primary-gradient);
            color: var(--white);
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 4px;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            box-shadow: var(--shadow-medium);
            transition: all var(--transition-speed) ease;
        }
        
        .schedule-ride-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-heavy);
        }
        
        /* More Options Button */
        .more-options-btn {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
            color: var(--dark-gray);
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            transition: all var(--transition-speed) ease;
        }
        
        .more-options-btn:hover {
            background: var(--light-orange);
            border-color: var(--primary-orange);
        }
        
        .more-options-dropdown {
            display: none;
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            margin-top: 5px;
            overflow: hidden;
            box-shadow: var(--shadow-medium);
        }
        
        .more-options-dropdown.active {
            display: block;
        }
        
        .more-option-item {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all var(--transition-speed) ease;
        }
        
        .more-option-item:hover {
            background: var(--light-orange);
        }
        
        .more-option-item:last-child {
            border-bottom: none;
        }
        
        .more-option-icon {
            width: 20px;
            text-align: center;
            font-size: 0.9rem;
        }
        
        .more-option-text {
            flex: 1;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        /* Order for Someone Else Form */
        .order-for-someone-form {
            display: none;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
        }
        
        .order-for-someone-form.active {
            display: flex;
        }
        
        /* Express Delivery Form */
        .express-delivery-form {
            display: none;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
        }
        
        .express-delivery-form.active {
            display: flex;
        }
        
        /* SOS Setup Form */
        .sos-setup-form {
            display: none;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
        }
        
        .sos-setup-form.active {
            display: flex;
        }
        
        /* SOS Button */
        .sos-button {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--error-red);
            color: var(--white);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 700;
            box-shadow: var(--shadow-heavy);
            z-index: 150;
            cursor: pointer;
            animation: sos-pulse 2s infinite;
            display: none;
        }
        
        @keyframes sos-pulse {
            0% {
                transform: translateX(-50%) scale(1);
                box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7);
            }
            70% {
                transform: translateX(-50%) scale(1.05);
                box-shadow: 0 0 0 10px rgba(231, 76, 60, 0);
            }
            100% {
                transform: translateX(-50%) scale(1);
                box-shadow: 0 0 0 0 rgba(231, 76, 60, 0);
            }
        }
        
        /* Delivery Fee Display */
        .delivery-fee-display {
            background: var(--primary-gradient);
            color: var(--white);
            padding: 10px;
            border-radius: var(--element-radius);
            text-align: center;
            margin: 8px 0;
        }
        
        .delivery-fee-amount {
            font-size: 1.2rem;
            font-weight: 800;
            margin: 4px 0;
        }
        
        .delivery-eta-display {
            font-size: 0.8rem;
            font-weight: 600;
            opacity: 0.9;
        }
        
        /* Enhanced Location Input */
        .location-input-container {
            position: relative;
            margin-bottom: 8px;
        }
        
        .location-input {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--white);
            position: relative;
            transition: all var(--fast-transition) ease;
        }
        
        .location-input.active {
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
        }
        
        .location-input i {
            color: var(--primary-orange);
        }
        
        .location-input input {
            border: none;
            outline: none;
            width: 100%;
            font-size: 0.8rem;
            background: transparent;
        }
        
        .clear-pickup-btn {
            background: none;
            border: none;
            color: var(--error-red);
            font-size: 0.8rem;
            cursor: pointer;
            padding: 0 5px;
        }
        
        /* Enhanced Suggestion List */
        .suggestion-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 200;
            max-height: 250px;
            overflow-y: auto;
            display: none;
            animation: fadeInUp 0.2s ease;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .suggestion-item {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--fast-transition) ease;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }
        
        .suggestion-item:hover {
            background: var(--search-highlight);
        }
        
        .suggestion-item.first-result {
            background: var(--light-orange);
            border-left: 3px solid var(--primary-orange);
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
        
        .suggestion-icon {
            font-size: 0.9rem;
            width: 20px;
            text-align: center;
            margin-top: 2px;
        }
        
        .suggestion-details {
            flex: 1;
        }
        
        .suggestion-name {
            font-weight: 600;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .city-badge {
            background: var(--city-highlight);
            color: white;
            padding: 1px 4px;
            border-radius: 4px;
            font-size: 0.6rem;
            font-weight: 600;
        }
        
        .current-city-indicator {
            background: var(--success-green);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.6rem;
            font-weight: 600;
        }
        
        .suggestion-address {
            color: var(--medium-gray);
            font-size: 0.7rem;
            margin-top: 2px;
        }
        
        .suggestion-distance {
            color: var(--medium-gray);
            font-size: 0.65rem;
            margin-top: 2px;
        }
        
        .loading-text {
            padding: 15px;
            text-align: center;
            color: var(--medium-gray);
            font-size: 0.8rem;
        }
        
        .no-places {
            padding: 15px;
            text-align: center;
            color: var(--medium-gray);
            font-size: 0.8rem;
        }
        
        /* Vehicle Selection */
        .vehicle-selection {
            display: flex;
            gap: 6px;
            margin: 8px 0;
        }
        
        .vehicle-option {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 4px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .vehicle-option.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .vehicle-icon {
            font-size: 1rem;
            color: var(--medium-gray);
        }
        
        .vehicle-option.selected .vehicle-icon {
            color: var(--primary-orange);
        }
        
        .vehicle-name {
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .vehicle-price {
            font-size: 0.65rem;
            color: var(--medium-gray);
        }
        
        /* Fare Display */
        .fare-display {
            background: var(--primary-gradient);
            color: var(--white);
            padding: 10px;
            border-radius: var(--element-radius);
            text-align: center;
            margin: 8px 0;
            box-shadow: var(--shadow-medium);
        }
        
        .fare-amount {
            font-size: 1.5rem;
            font-weight: 800;
            margin: 4px 0;
        }
        
        .eta-display {
            font-size: 0.9rem;
            font-weight: 600;
            opacity: 0.9;
        }
        
        /* Request Ride Button */
        .request-ride-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: var(--element-radius);
            background: var(--primary-gradient);
            color: var(--white);
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            margin-top: 8px;
            box-shadow: var(--shadow-medium);
        }
        
        .request-ride-btn:disabled {
            background: var(--medium-gray);
            cursor: not-allowed;
            box-shadow: none;
        }
        
        /* Ride Info Panel */
        .ride-info-panel {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 10px;
            box-shadow: var(--shadow-medium);
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            display: none;
        }
        
        .driver-details-card {
            background: var(--light-orange);
            padding: 10px;
            border-radius: var(--element-radius);
            margin-bottom: 10px;
            border: 1px solid var(--primary-orange);
            display: none;
        }
        
        /* Enhanced Chat System */
        .chat-indicator {
            font-size: 0.7rem;
            color: var(--info-blue);
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        /* Enhanced History Details */
        .history-details-popup .popup-form {
            max-width: 800px;
            max-height: 80vh;
        }
        
        .history-map-container {
            height: 200px;
            border-radius: var(--element-radius);
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        .history-chat-section {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            padding: 10px;
            margin-top: 15px;
        }
        
        .chat-message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 12px;
            max-width: 80%;
        }
        
        .chat-message.passenger {
            background: var(--light-orange);
            margin-left: auto;
        }
        
        .chat-message.driver {
            background: var(--light-gray);
            margin-right: auto;
        }
        
        /* City Detection Indicator */
        .city-detection-indicator {
            position: fixed;
            top: 10px;
            left: 10px;
            background: var(--white);
            padding: 6px 10px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-medium);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 600;
            color: var(--dark-gray);
            border: 2px solid var(--city-highlight);
            font-size: 0.7rem;
        }
        
        .city-name {
            color: var(--city-highlight);
            font-weight: 700;
        }
        
        /* Enhanced Search Performance */
        .searching-indicator {
            display: none;
            position: absolute;
            right: 10px;
            color: var(--primary-orange);
            font-size: 0.8rem;
        }
        
        .searching-indicator.active {
            display: block;
            animation: pulse 1s infinite;
        }
        
        /* Schedule Ride Popup */
        .schedule-popup {
            max-width: 500px;
        }
        
        .schedule-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }
        
        .schedule-tab {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: var(--element-radius);
            background: var(--light-gray);
            color: var(--dark-gray);
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all var(--transition-speed) ease;
        }
        
        .schedule-tab.active {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .schedule-form {
            display: none;
        }
        
        .schedule-form.active {
            display: block;
        }
        
        /* Enhanced Ride History Item */
        .history-item {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            font-size: 0.75rem;
            position: relative;
        }
        
        .history-item:hover {
            background: var(--light-orange);
            transform: translateX(2px);
        }
        
        .history-item-type {
            font-size: 0.65rem;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 8px;
            margin-bottom: 6px;
            display: inline-block;
        }
        
        .history-item-type.ride {
            background: var(--light-orange);
            color: var(--primary-orange);
        }
        
        .history-item-type.delivery {
            background: var(--light-red);
            color: var(--primary-red);
        }
        
        .history-locations {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-bottom: 8px;
        }
        
        .history-location {
            display: flex;
            align-items: flex-start;
            gap: 6px;
        }
        
        .history-location-icon {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            flex-shrink: 0;
            margin-top: 2px;
        }
        
        .history-pickup-icon {
            background: var(--primary-orange);
            color: white;
        }
        
        .history-destination-icon {
            background: var(--primary-red);
            color: white;
        }
        
        .history-location-text {
            flex: 1;
            font-size: 0.75rem;
            line-height: 1.3;
        }
        
        .history-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.7rem;
            color: var(--medium-gray);
        }
        
        .history-fare {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        .history-date {
            font-size: 0.65rem;
        }
        
        .status-badge {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.65rem;
            font-weight: 700;
        }
        
        .status-completed {
            background: #e6f7e9;
            color: #2e7d32;
        }
        
        .status-cancelled {
            background: #ffebee;
            color: #c62828;
        }
        
        .status-requested {
            background: #fff3e0;
            color: #ef6c00;
        }
        
        .status-accepted {
            background: #e3f2fd;
            color: #1565c0;
        }
        
        /* Enhanced Driver Details */
        .driver-details-enhanced {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: var(--light-orange);
            border-radius: var(--element-radius);
            margin-bottom: 10px;
        }
        
        .driver-avatar-enhanced {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: white;
            font-weight: 700;
            overflow: hidden;
        }
        
        .driver-avatar-enhanced img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .driver-info-enhanced {
            flex: 1;
        }
        
        .driver-name {
            font-size: 0.9rem;
            font-weight: 700;
            margin-bottom: 2px;
        }
        
        .driver-phone {
            font-size: 0.75rem;
            color: var(--medium-gray);
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .driver-rating {
            font-size: 0.75rem;
            color: var(--warning-yellow);
            font-weight: 600;
        }
        
        /* Enhanced Route Display */
        .route-details {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 15px 0;
        }
        
        .route-point {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        .route-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            flex-shrink: 0;
            margin-top: 2px;
        }
        
        .route-pickup-icon {
            background: var(--primary-orange);
            color: white;
        }
        
        .route-destination-icon {
            background: var(--primary-red);
            color: white;
        }
        
        .route-text {
            flex: 1;
        }
        
        .route-label {
            font-size: 0.75rem;
            color: var(--medium-gray);
            margin-bottom: 2px;
        }
        
        .route-address {
            font-size: 0.85rem;
            font-weight: 600;
            line-height: 1.3;
        }
        
        /* Fare Breakdown */
        .fare-breakdown {
            background: var(--light-gray);
            padding: 12px;
            border-radius: var(--element-radius);
            margin: 15px 0;
        }
        
        .fare-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 0.8rem;
        }
        
        .fare-row.total {
            border-top: 1px solid var(--border-color);
            margin-top: 6px;
            padding-top: 8px;
            font-weight: 700;
            font-size: 0.9rem;
            color: var(--primary-orange);
        }
        
        /* Enhanced Chat History */
        .chat-history {
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            background: var(--light-gray);
            border-radius: var(--element-radius);
            margin: 15px 0;
        }
        
        .chat-message-history {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 12px;
            max-width: 80%;
            font-size: 0.8rem;
        }
        
        .chat-message-history.passenger {
            background: var(--light-orange);
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        
        .chat-message-history.driver {
            background: var(--white);
            margin-right: auto;
            border-bottom-left-radius: 4px;
            border: 1px solid var(--border-color);
        }
        
        .chat-time {
            font-size: 0.65rem;
            color: var(--medium-gray);
            margin-top: 4px;
            text-align: right;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }
        
        .btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: var(--element-radius);
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .btn-primary {
            background: var(--primary-orange);
            color: white;
        }
        
        .btn-secondary {
            background: var(--light-gray);
            color: var(--dark-gray);
            border: 1px solid var(--border-color);
        }
        
        .btn-danger {
            background: var(--error-red);
            color: white;
        }
        
        /* Enhanced Screens */
        .screen-content {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 50px;
            background: var(--white);
            z-index: 90;
            padding: var(--app-padding);
            overflow-y: auto;
            display: none;
        }
        
        .screen-content.active {
            display: block;
        }
        
        .screen-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .back-button {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            font-size: 0.9rem;
        }
        
        .screen-title {
            font-size: 1.1rem;
            font-weight: 700;
            flex: 1;
        }
        
        /* Enhanced Account Screen */
        .account-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .stat-card {
            background: var(--light-gray);
            padding: 12px;
            border-radius: var(--element-radius);
            text-align: center;
            transition: all var(--transition-speed) ease;
        }
        
        .stat-card:hover {
            background: var(--light-orange);
            transform: translateY(-2px);
        }
        
        .stat-number {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        .stat-label {
            font-size: 0.65rem;
            color: var(--medium-gray);
        }
        
        /* Enhanced Payments Screen */
        .payment-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .payment-option-card {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .payment-option-card.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .payment-icon-card {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: var(--medium-gray);
        }
        
        .payment-option-card.selected .payment-icon-card {
            background: var(--primary-orange);
            color: white;
        }
        
        .payment-details-card {
            flex: 1;
        }
        
        .payment-name-card {
            font-weight: 600;
            font-size: 0.85rem;
        }
        
        .payment-info-card {
            color: var(--medium-gray);
            font-size: 0.7rem;
        }
        
        /* Enhanced Notifications */
        .notification {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-gradient);
            color: var(--white);
            padding: 12px 18px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 1000;
            display: none;
            font-weight: 600;
            text-align: center;
            font-size: 0.8rem;
            max-width: 85%;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                transform: translateX(-50%) translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }
        
        /* Enhanced Map Markers */
        .current-location-marker {
            background: var(--info-blue);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            border: 2px solid white;
        }
        
        .pickup-marker-enhanced {
            background: var(--primary-orange);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            border: 2px solid white;
        }
        
        .destination-marker-enhanced {
            background: var(--primary-red);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            border: 2px solid white;
        }
        
        .driver-marker-enhanced {
            background: var(--success-green);
            color: white;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
            border: 2px solid white;
        }
        
        /* Enhanced Loading States */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            z-index: 2000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--light-gray);
            border-top-color: var(--primary-orange);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text-large {
            font-size: 1rem;
            color: var(--primary-orange);
            font-weight: 600;
        }
        
        /* Enhanced Responsive Design */
        @media (max-width: 480px) {
            .floating-balance {
                padding: 5px 8px;
                font-size: 0.65rem;
            }
            
            .city-detection-indicator {
                padding: 5px 8px;
                font-size: 0.6rem;
            }
            
            .passenger-panel {
                padding: 8px;
            }
            
            .nav-buttons {
                gap: 3px;
            }
            
            .nav-btn {
                padding: 5px 2px;
                font-size: 0.55rem;
            }
            
            .schedule-ride-btn,
            .more-options-btn {
                padding: 7px;
                font-size: 0.7rem;
            }
            
            .location-input {
                padding: 7px;
            }
            
            .suggestion-item {
                padding: 8px;
            }
            
            .fare-amount {
                font-size: 1.3rem;
            }
            
            .request-ride-btn {
                padding: 10px;
                font-size: 0.8rem;
            }
        }
        
        @media (max-width: 360px) {
            .nav-buttons {
                grid-template-columns: repeat(2, 1fr);
                margin-bottom: 8px;
            }
            
            .nav-btn {
                font-size: 0.6rem;
                padding: 6px 3px;
            }
            
            .vehicle-option {
                padding: 6px 2px;
            }
            
            .vehicle-name {
                font-size: 0.65rem;
            }
            
            .vehicle-price {
                font-size: 0.6rem;
            }
        }
        
        /* Enhanced Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--light-gray);
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary-orange);
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-orange);
        }
        
        /* Enhanced Focus States */
        input:focus, 
        select:focus, 
        textarea:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.2);
        }
        
        /* Enhanced Button States */
        button:active {
            transform: scale(0.98);
        }
        
        /* Enhanced Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideInUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        /* Enhanced Card Effects */
        .card {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 12px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
            transition: all var(--transition-speed) ease;
        }
        
        .card:hover {
            box-shadow: var(--shadow-medium);
            transform: translateY(-2px);
        }
        
        /* Enhanced Section Titles */
        .section-title-enhanced {
            font-size: 0.9rem;
            font-weight: 700;
            margin-bottom: 10px;
            padding-bottom: 6px;
            border-bottom: 2px solid var(--light-orange);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        /* Enhanced Form Elements */
        .form-group-enhanced {
            margin-bottom: 12px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 4px;
            font-weight: 600;
            font-size: 0.75rem;
            color: var(--dark-gray);
        }
        
        .form-control {
            width: 100%;
            padding: 8px 10px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 0.8rem;
            transition: all var(--transition-speed) ease;
        }
        
        .form-control:focus {
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }
        
        /* Enhanced Badges */
        .badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 0.65rem;
            font-weight: 600;
        }
        
        .badge-primary {
            background: var(--light-orange);
            color: var(--primary-orange);
        }
        
        .badge-success {
            background: #e6f7e9;
            color: #2e7d32;
        }
        
        .badge-warning {
            background: #fff3e0;
            color: #ef6c00;
        }
        
        .badge-danger {
            background: #ffebee;
            color: #c62828;
        }
        
        /* Enhanced Tooltips */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip .tooltip-text {
            visibility: hidden;
            width: 120px;
            background-color: var(--dark-gray);
            color: var(--white);
            text-align: center;
            border-radius: 4px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.7rem;
        }
        
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        /* Enhanced Empty States */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--medium-gray);
        }
        
        .empty-state-icon {
            font-size: 3rem;
            color: var(--light-gray);
            margin-bottom: 15px;
        }
        
        .empty-state-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .empty-state-description {
            font-size: 0.8rem;
        }
        
        /* Enhanced Search Header */
        .search-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: var(--light-gray);
            border-radius: var(--element-radius);
            margin-bottom: 10px;
        }
        
        .current-city-display {
            background: var(--city-highlight);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        /* Enhanced Route Line */
        .leaflet-routing-container {
            display: none !important;
        }
        
        /* Enhanced Map Controls */
        .map-controls {
            position: fixed;
            top: 70px;
            right: 10px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .map-control-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--white);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow-medium);
            transition: all var(--transition-speed) ease;
        }
        
        .map-control-btn:hover {
            background: var(--light-orange);
            transform: scale(1.1);
        }
        
        /* Enhanced Rating System */
        .rating-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin: 15px 0;
        }
        
        .rating-category {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: var(--light-gray);
            border-radius: var(--element-radius);
        }
        
        .rating-stars-enhanced {
            display: flex;
            gap: 2px;
        }
        
        .rating-star {
            font-size: 1.2rem;
            color: var(--light-gray);
            cursor: pointer;
            transition: all var(--fast-transition) ease;
        }
        
        .rating-star.active {
            color: var(--warning-yellow);
        }
        
        /* Enhanced Status Messages */
        .status-message {
            padding: 10px;
            border-radius: var(--element-radius);
            margin: 10px 0;
            font-size: 0.8rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-message.info {
            background: var(--light-orange);
            color: var(--primary-orange);
        }
        
        .status-message.success {
            background: #e6f7e9;
            color: #2e7d32;
        }
        
        .status-message.warning {
            background: #fff3e0;
            color: #ef6c00;
        }
        
        .status-message.error {
            background: #ffebee;
            color: #c62828;
        }
        
        /* Enhanced Progress Bar */
        .progress-bar {
            height: 4px;
            background: var(--light-gray);
            border-radius: 2px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--primary-orange);
            transition: width 0.3s ease;
        }
        
        /* Enhanced Time Display */
        .time-display {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            color: var(--medium-gray);
        }
        
        .time-icon {
            color: var(--primary-orange);
        }
        
        /* Enhanced Price Display */
        .price-display {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-orange);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .price-currency {
            font-size: 0.8rem;
            color: var(--medium-gray);
        }
        
        /* Enhanced Distance Display */
        .distance-display {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            color: var(--medium-gray);
        }
        
        .distance-icon {
            color: var(--info-blue);
        }
        
        /* Enhanced Avatar System */
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1rem;
            overflow: hidden;
        }
        
        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .avatar.small {
            width: 30px;
            height: 30px;
            font-size: 0.8rem;
        }
        
        .avatar.large {
            width: 60px;
            height: 60px;
            font-size: 1.4rem;
        }
        
        /* Enhanced Input Groups */
        .input-group-enhanced {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .input-group-enhanced .form-control {
            flex: 1;
        }
        
        /* Enhanced Button Groups */
        .btn-group {
            display: flex;
            gap: 8px;
        }
        
        .btn-group .btn {
            flex: 1;
        }
        
        /* Enhanced Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--light-gray);
            transition: .4s;
            border-radius: 24px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: var(--primary-orange);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        /* Enhanced Modal Backdrop */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-backdrop.active {
            display: block;
        }
        
        /* Enhanced Tab System */
        .tab-header {
            display: flex;
            gap: 2px;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .tab {
            padding: 10px 15px;
            border: none;
            background: none;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--medium-gray);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all var(--transition-speed) ease;
        }
        
        .tab.active {
            color: var(--primary-orange);
            border-bottom-color: var(--primary-orange);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        /* Enhanced List Groups */
        .list-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .list-item {
            padding: 12px;
            background: var(--light-gray);
            border-radius: var(--element-radius);
            transition: all var(--transition-speed) ease;
        }
        
        .list-item:hover {
            background: var(--light-orange);
            transform: translateX(2px);
        }
        
        /* Enhanced Grid System */
        .grid {
            display: grid;
            gap: 10px;
        }
        
        .grid-2 {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .grid-3 {
            grid-template-columns: repeat(3, 1fr);
        }
        
        .grid-4 {
            grid-template-columns: repeat(4, 1fr);
        }
        
        /* Enhanced Spacing Utilities */
        .mt-1 { margin-top: 4px; }
        .mt-2 { margin-top: 8px; }
        .mt-3 { margin-top: 12px; }
        .mt-4 { margin-top: 16px; }
        
        .mb-1 { margin-bottom: 4px; }
        .mb-2 { margin-bottom: 8px; }
        .mb-3 { margin-bottom: 12px; }
        .mb-4 { margin-bottom: 16px; }
        
        .p-1 { padding: 4px; }
        .p-2 { padding: 8px; }
        .p-3 { padding: 12px; }
        .p-4 { padding: 16px; }
        
        /* Enhanced Text Utilities */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-left { text-align: left; }
        
        .text-small { font-size: 0.7rem; }
        .text-medium { font-size: 0.85rem; }
        .text-large { font-size: 1rem; }
        
        .text-bold { font-weight: 700; }
        .text-semibold { font-weight: 600; }
        
        .text-primary { color: var(--primary-orange); }
        .text-success { color: var(--success-green); }
        .text-warning { color: var(--warning-yellow); }
        .text-danger { color: var(--error-red); }
        .text-muted { color: var(--medium-gray); }
        
        /* Enhanced Flex Utilities */
        .flex { display: flex; }
        .flex-column { flex-direction: column; }
        .flex-row { flex-direction: row; }
        .flex-wrap { flex-wrap: wrap; }
        
        .align-center { align-items: center; }
        .align-start { align-items: flex-start; }
        .align-end { align-items: flex-end; }
        
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .justify-around { justify-content: space-around; }
        
        .gap-1 { gap: 4px; }
        .gap-2 { gap: 8px; }
        .gap-3 { gap: 12px; }
        .gap-4 { gap: 16px; }
        
        /* Enhanced Border Utilities */
        .border { border: 1px solid var(--border-color); }
        .border-top { border-top: 1px solid var(--border-color); }
        .border-bottom { border-bottom: 1px solid var(--border-color); }
        .border-left { border-left: 1px solid var(--border-color); }
        .border-right { border-right: 1px solid var(--border-color); }
        
        .rounded { border-radius: var(--element-radius); }
        .rounded-full { border-radius: 50%; }
        
        /* Enhanced Shadow Utilities */
        .shadow-none { box-shadow: none; }
        .shadow-light { box-shadow: var(--shadow-light); }
        .shadow-medium { box-shadow: var(--shadow-medium); }
        .shadow-heavy { box-shadow: var(--shadow-heavy); }
        
        /* Enhanced Background Utilities */
        .bg-white { background-color: var(--white); }
        .bg-light { background-color: var(--light-gray); }
        .bg-orange { background-color: var(--light-orange); }
        .bg-primary { background: var(--primary-gradient); }
        
        /* Enhanced Display Utilities */
        .d-none { display: none !important; }
        .d-block { display: block !important; }
        .d-flex { display: flex !important; }
        .d-grid { display: grid !important; }
        
        /* Enhanced Position Utilities */
        .position-relative { position: relative; }
        .position-absolute { position: absolute; }
        .position-fixed { position: fixed; }
        .position-sticky { position: sticky; }
        
        /* Enhanced Overflow Utilities */
        .overflow-hidden { overflow: hidden; }
        .overflow-auto { overflow: auto; }
        .overflow-y-auto { overflow-y: auto; }
        .overflow-x-auto { overflow-x: auto; }
        
        /* Enhanced Width Utilities */
        .w-25 { width: 25%; }
        .w-50 { width: 50%; }
        .w-75 { width: 75%; }
        .w-100 { width: 100%; }
        
        /* Enhanced Height Utilities */
        .h-25 { height: 25%; }
        .h-50 { height: 50%; }
        .h-75 { height: 75%; }
        .h-100 { height: 100%; }
        
        /* Enhanced Cursor Utilities */
        .cursor-pointer { cursor: pointer; }
        .cursor-default { cursor: default; }
        .cursor-not-allowed { cursor: not-allowed; }
        
        /* Enhanced Transition Utilities */
        .transition { transition: all var(--transition-speed) ease; }
        .transition-fast { transition: all var(--fast-transition) ease; }
        
        /* Enhanced Opacity Utilities */
        .opacity-0 { opacity: 0; }
        .opacity-25 { opacity: 0.25; }
        .opacity-50 { opacity: 0.5; }
        .opacity-75 { opacity: 0.75; }
        .opacity-100 { opacity: 1; }
        
        /* Enhanced Z-index Utilities */
        .z-0 { z-index: 0; }
        .z-10 { z-index: 10; }
        .z-20 { z-index: 20; }
        .z-30 { z-index: 30; }
        .z-40 { z-index: 40; }
        .z-50 { z-index: 50; }
        
        /* Enhanced Transform Utilities */
        .transform-none { transform: none; }
        .transform-scale-95 { transform: scale(0.95); }
        .transform-scale-105 { transform: scale(1.05); }
        .transform-rotate-90 { transform: rotate(90deg); }
        .transform-rotate-180 { transform: rotate(180deg); }
        
        /* Enhanced Animation Utilities */
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        
        .animate-bounce {
            animation: bounce 1s infinite;
        }
        
        @keyframes bounce {
            0%, 100% {
                transform: translateY(-25%);
                animation-timing-function: cubic-bezier(0.8, 0, 1, 1);
            }
            50% {
                transform: translateY(0);
                animation-timing-function: cubic-bezier(0, 0, 0.2, 1);
            }
        }
        
        /* Enhanced Responsive Utilities */
        @media (min-width: 640px) {
            .sm\:grid-2 { grid-template-columns: repeat(2, 1fr); }
            .sm\:grid-3 { grid-template-columns: repeat(3, 1fr); }
            .sm\:grid-4 { grid-template-columns: repeat(4, 1fr); }
        }
        
        @media (min-width: 768px) {
            .md\:grid-2 { grid-template-columns: repeat(2, 1fr); }
            .md\:grid-3 { grid-template-columns: repeat(3, 1fr); }
            .md\:grid-4 { grid-template-columns: repeat(4, 1fr); }
        }
        
        @media (min-width: 1024px) {
            .lg\:grid-2 { grid-template-columns: repeat(2, 1fr); }
            .lg\:grid-3 { grid-template-columns: repeat(3, 1fr); }
            .lg\:grid-4 { grid-template-columns: repeat(4, 1fr); }
        }
        
        /* Enhanced Print Styles */
        @media print {
            .no-print {
                display: none !important;
            }
            
            .print-only {
                display: block !important;
            }
        }
        
        /* Enhanced Dark Mode Support */
        @media (prefers-color-scheme: dark) {
            :root {
                --white: #1a1a1a;
                --light-gray: #2d2d2d;
                --dark-gray: #f0f0f0;
                --medium-gray: #a0a0a0;
                --border-color: #404040;
            }
            
            body {
                background-color: var(--white);
                color: var(--dark-gray);
            }
        }
        
        /* Enhanced Accessibility */
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* Enhanced Focus Visible */
        :focus-visible {
            outline: 2px solid var(--primary-orange);
            outline-offset: 2px;
        }
        
        /* Enhanced Reduced Motion */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        /* Enhanced Custom Scrollbar for Firefox */
        * {
            scrollbar-width: thin;
            scrollbar-color: var(--primary-orange) var(--light-gray);
        }
    </style>
</head>
<body>
    <!-- Main App -->
    <div id="mainApp">
        <!-- Main Map -->
        <div id="map"></div>
        
        <!-- City Detection Indicator -->
        <div class="city-detection-indicator" id="cityIndicator">
            <i class="fas fa-map-marker-alt"></i>
            <span>City: <span class="city-name" id="currentCity">Detecting...</span></span>
        </div>
        
        <!-- Floating Balance -->
        <div class="floating-balance home-only">
            <i class="fas fa-wallet"></i>
            <span>Balance: <span class="balance-amount" id="walletBalance">K0.00</span></span>
        </div>
        
        <!-- Ride Status -->
        <div class="ride-status home-only" id="rideStatus">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Searching for driver</span>
        </div>
        
        <!-- Estimated Time -->
        <div class="estimated-time home-only" id="estimatedTime">
            <i class="fas fa-clock"></i>
            <span id="timeText">5 min</span>
        </div>
        
        <!-- SOS Button -->
        <div class="sos-button" id="sosButton">
            SOS
        </div>
        
        <!-- Map Controls -->
        <div class="map-controls">
            <button class="map-control-btn" id="centerMapBtn" title="Center on my location">
                <i class="fas fa-location-crosshairs"></i>
            </button>
            <button class="map-control-btn" id="refreshLocationBtn" title="Refresh location">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
        
        <!-- Driver Search Animation -->
        <div class="searching-animation" id="searchingAnimation">
            <div class="searching-pulse">
                <div class="searching-pulse-inner">
                    <i class="fas fa-car"></i>
                </div>
            </div>
            <div class="searching-text">Searching for driver</div>
        </div>
        
        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-spinner"></div>
            <div class="loading-text-large" id="loadingText">Loading...</div>
        </div>
        
        <!-- Passenger Panel -->
        <div class="passenger-panel" id="passengerPanel">
            <div class="panel-collapse-handle" id="panelCollapseHandle"></div>
            
            <div class="nav-buttons">
                <button class="nav-btn active" data-screen="home">
                    <i class="fas fa-home"></i>
                    <span>Home</span>
                </button>
                <button class="nav-btn" data-screen="account">
                    <i class="fas fa-user"></i>
                    <span>Account</span>
                </button>
                <button class="nav-btn" data-screen="history">
                    <i class="fas fa-history"></i>
                    <span>History</span>
                </button>
                <button class="nav-btn" data-screen="payments">
                    <i class="fas fa-credit-card"></i>
                    <span>Payments</span>
                </button>
            </div>
            
            <!-- Schedule Ride Button -->
            <button class="schedule-ride-btn" id="scheduleRideBtn">
                <i class="fas fa-clock"></i>
                Schedule Ride
            </button>
            
            <!-- More Options Button -->
            <button class="more-options-btn" id="moreOptionsBtn">
                <i class="fas fa-ellipsis-h"></i>
                More Options
            </button>
            
            <!-- More Options Dropdown -->
            <div class="more-options-dropdown" id="moreOptionsDropdown">
                <div class="more-option-item" data-option="order-for-someone">
                    <div class="more-option-icon">
                        <i class="fas fa-user-friends"></i>
                    </div>
                    <div class="more-option-text">Order for Someone Else</div>
                </div>
                <div class="more-option-item" data-option="express-delivery">
                    <div class="more-option-icon">
                        <i class="fas fa-shipping-fast"></i>
                    </div>
                    <div class="more-option-text">Express Delivery</div>
                </div>
                <div class="more-option-item" data-option="sos-setup">
                    <div class="more-option-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="more-option-text">SOS Setup</div>
                </div>
            </div>
            
            <!-- Home Screen Content -->
            <div id="homeScreenContent">
                <!-- Order for Someone Else Form -->
                <div class="order-for-someone-form" id="orderForSomeoneForm">
                    <h4 class="section-title">Order for Someone Else</h4>
                    
                    <div class="location-input-container">
                        <div class="location-input">
                            <i class="fas fa-map-marker-alt"></i>
                            <input type="text" id="recipientPickupLocation" placeholder="Pickup location">
                            <div class="suggestion-list" id="recipientPickupSuggestions"></div>
                        </div>
                    </div>
                    
                    <div class="location-input-container">
                        <div class="location-input">
                            <i class="fas fa-flag"></i>
                            <input type="text" id="recipientDestinationLocation" placeholder="Drop-off location">
                            <div class="suggestion-list" id="recipientDestinationSuggestions"></div>
                        </div>
                    </div>
                    
                    <div class="form-group-enhanced">
                        <label for="recipientName" class="form-label">Recipient's Full Name</label>
                        <input type="text" id="recipientName" class="form-control" placeholder="Full name">
                    </div>
                    
                    <div class="form-group-enhanced">
                        <label for="recipientEmail" class="form-label">Recipient's Email</label>
                        <input type="email" id="recipientEmail" class="form-control" placeholder="Email address">
                    </div>
                    
                    <div class="form-group-enhanced">
                        <label for="recipientPhone" class="form-label">Recipient's Phone Number</label>
                        <input type="tel" id="recipientPhone" class="form-control" placeholder="Phone number">
                    </div>
                    
                    <div class="delivery-fee-display">
                        <p>Delivery Fee</p>
                        <div class="delivery-fee-amount" id="recipientDeliveryFee">K0.00</div>
                        <p class="delivery-eta-display" id="recipientEtaDisplay">ETA: -- min</p>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn btn-primary" id="orderForSomeoneBtn">
                            <i class="fas fa-car"></i> Book Ride
                        </button>
                        <button class="btn btn-secondary" id="cancelOrderForSomeoneBtn">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </div>
                
                <!-- Express Delivery Form -->
                <div class="express-delivery-form" id="expressDeliveryForm">
                    <h4 class="section-title">Express Delivery</h4>
                    
                    <div class="form-group-enhanced">
                        <label for="shopName" class="form-label">Shop or Restaurant Name</label>
                        <input type="text" id="shopName" class="form-control" placeholder="Name of shop or restaurant">
                    </div>
                    
                    <div class="location-input-container">
                        <div class="location-input">
                            <i class="fas fa-map-marker-alt"></i>
                            <input type="text" id="shopLocation" placeholder="Shop location">
                            <div class="suggestion-list" id="shopLocationSuggestions"></div>
                        </div>
                    </div>
                    
                    <div class="form-group-enhanced">
                        <label for="deliveryItems" class="form-label">Items to Purchase</label>
                        <textarea id="deliveryItems" class="form-control" placeholder="List of items to be purchased" rows="2"></textarea>
                    </div>
                    
                    <div class="form-group-enhanced">
                        <label for="deliveryAmount" class="form-label">Total Amount to Spend (K)</label>
                        <input type="number" id="deliveryAmount" class="form-control" placeholder="Total amount">
                    </div>
                    
                    <div class="form-group-enhanced">
                        <label for="deliveryInstructions" class="form-label">Special Instructions</label>
                        <textarea id="deliveryInstructions" class="form-control" placeholder="Any special instructions" rows="2"></textarea>
                    </div>
                    
                    <div class="location-input-container">
                        <div class="location-input">
                            <i class="fas fa-flag"></i>
                            <input type="text" id="deliveryDestination" placeholder="Delivery destination">
                            <div class="suggestion-list" id="deliveryDestinationSuggestions"></div>
                        </div>
                    </div>
                    
                    <div class="vehicle-selection">
                        <div class="vehicle-option" data-type="car">
                            <i class="fas fa-car vehicle-icon"></i>
                            <span class="vehicle-name">Car</span>
                            <span class="vehicle-price">Fast & Secure</span>
                        </div>
                        <div class="vehicle-option selected" data-type="bike">
                            <i class="fas fa-motorcycle vehicle-icon"></i>
                            <span class="vehicle-name">Bike</span>
                            <span class="vehicle-price">Quick Delivery</span>
                        </div>
                        <div class="vehicle-option" data-type="bicycle">
                            <i class="fas fa-bicycle vehicle-icon"></i>
                            <span class="vehicle-name">Bicycle</span>
                            <span class="vehicle-price">Eco Friendly</span>
                        </div>
                    </div>
                    
                    <div class="delivery-fee-display">
                        <p>Delivery Fee</p>
                        <div class="delivery-fee-amount" id="expressDeliveryFee">K0.00</div>
                        <p class="delivery-eta-display" id="expressDeliveryEtaDisplay">ETA: -- min</p>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn btn-primary" id="expressDeliveryBtn">
                            <i class="fas fa-shipping-fast"></i> Request Delivery
                        </button>
                        <button class="btn btn-secondary" id="cancelExpressDeliveryBtn">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </div>
                
                <!-- SOS Setup Form -->
                <div class="sos-setup-form" id="sosSetupForm">
                    <h4 class="section-title">SOS Setup</h4>
                    
                    <div class="form-group-enhanced">
                        <label for="emergencyContact1" class="form-label">Emergency Contact 1</label>
                        <input type="tel" id="emergencyContact1" class="form-control" placeholder="Phone number">
                    </div>
                    
                    <div class="form-group-enhanced">
                        <label for="emergencyContact2" class="form-label">Emergency Contact 2</label>
                        <input type="tel" id="emergencyContact2" class="form-control" placeholder="Phone number">
                    </div>
                    
                    <div class="form-group-enhanced">
                        <label for="sosMessage" class="form-label">Emergency Message</label>
                        <textarea id="sosMessage" class="form-control" placeholder="Pre-typed emergency message" rows="3">I need help! My current location and ride details will be shared with you.</textarea>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn btn-primary" id="saveSosBtn">
                            <i class="fas fa-save"></i> Save SOS Configuration
                        </button>
                        <button class="btn btn-secondary" id="cancelSosSetupBtn">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </div>
                
                <!-- Original Ride Request Form -->
                <div class="ride-request-form" id="rideRequestForm">
                    <div class="search-header">
                        <i class="fas fa-search text-primary"></i>
                        <span>Search in: <span class="current-city-display" id="currentCityDisplay">Detecting...</span></span>
                    </div>
                    
                    <div class="location-input-container">
                        <div class="location-input">
                            <i class="fas fa-map-marker-alt"></i>
                            <input type="text" id="pickupLocation" placeholder="Current location" readonly>
                            <button class="clear-pickup-btn d-none" id="clearPickupBtn" title="Clear pickup location">
                                <i class="fas fa-times"></i>
                            </button>
                            <div class="suggestion-list" id="pickupSuggestions"></div>
                        </div>
                    </div>
                    
                    <div class="location-input-container">
                        <div class="location-input">
                            <i class="fas fa-flag"></i>
                            <input type="text" id="destinationLocation" placeholder="Where to?">
                            <div class="suggestion-list" id="destinationSuggestions"></div>
                        </div>
                    </div>
                    
                    <div class="saved-locations">
                        <button class="saved-location-btn" data-address="home">
                            <i class="fas fa-home"></i>
                            Home
                        </button>
                        <button class="saved-location-btn" data-address="work">
                            <i class="fas fa-briefcase"></i>
                            Work
                        </button>
                    </div>
                    
                    <div class="vehicle-selection">
                        <div class="vehicle-option selected" data-type="car">
                            <i class="fas fa-car vehicle-icon"></i>
                            <span class="vehicle-name">Ride</span>
                            <span class="vehicle-price">Clean Cars</span>
                        </div>
                        <div class="vehicle-option" data-type="bike">
                            <i class="fas fa-motorcycle vehicle-icon"></i>
                            <span class="vehicle-name">Delivery</span>
                            <span class="vehicle-price">on time</span>
                        </div>
                        <div class="vehicle-option" data-type="bicycle">
                            <i class="fas fa-bicycle vehicle-icon"></i>
                            <span class="vehicle-name">Short Delivery</span>
                            <span class="vehicle-price">on time</span>
                        </div>
                    </div>
                    
                    <!-- Package Delivery Form -->
                    <button class="package-toggle" id="packageToggle" style="display: none;">
                        <i class="fas fa-box"></i>
                        Add Package Details
                    </button>
                    
                    <div class="package-form" id="packageForm">
                        <h4 class="section-title">Package Delivery Details</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="receiverName">Receiver Name</label>
                                <input type="text" id="receiverName" placeholder="Full name of receiver">
                            </div>
                            <div class="form-group">
                                <label for="receiverPhone">Receiver Phone</label>
                                <input type="tel" id="receiverPhone" placeholder="Phone number">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="packageDescription">Package Description</label>
                            <input type="text" id="packageDescription" placeholder="What is being delivered?">
                        </div>
                        <div class="form-group">
                            <label for="specialInstructions">Special Instructions</label>
                            <textarea id="specialInstructions" placeholder="Any special handling instructions?"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="packageValue">Package Value (K)</label>
                            <input type="number" id="packageValue" placeholder="Estimated value for insurance">
                        </div>
                    </div>
                    
                    <button class="promo-toggle" id="promoToggle">
                        <i class="fas fa-tag"></i>
                        Apply Promo Coupon
                    </button>
                    
                    <div class="promo-section" id="promoSection">
                        <div class="promo-input">
                            <input type="text" id="promoCode" placeholder="Promo code">
                            <button class="btn-promo" id="applyPromoBtn">Apply</button>
                        </div>
                    </div>
                    
                    <div class="fare-display">
                        <p>Estimated Fare</p>
                        <div class="fare-amount" id="estimatedFare">K0.00</div>
                        <p class="eta-display" id="etaDisplay">ETA: -- min</p>
                    </div>
                    
                    <button class="request-ride-btn" id="requestRideBtn">Request Ride</button>
                </div>
                
                <!-- Ride Info Panel -->
                <div class="ride-info-panel" id="rideInfoPanel">
                    <!-- Driver Details Card -->
                    <div class="driver-details-card" id="driverDetailsCard">
                        <div class="driver-details-header">
                            <i class="fas fa-id-card"></i>
                            <h3>Driver Details</h3>
                        </div>
                        <div class="driver-details-grid">
                            <div class="driver-detail-item">
                                <span class="driver-detail-label">Driver Name</span>
                                <span class="driver-detail-value" id="driverFullName">John Doe</span>
                            </div>
                            <div class="driver-detail-item">
                                <span class="driver-detail-label">Phone</span>
                                <span class="driver-detail-value" id="driverContactPhone">+260 123 456 789</span>
                            </div>
                            <div class="driver-detail-item">
                                <span class="driver-detail-label">Rating</span>
                                <span class="driver-detail-value" id="driverRatingValue">4.8 </span>
                            </div>
                            <div class="driver-detail-item">
                                <span class="driver-detail-label">Experience</span>
                                <span class="driver-detail-value" id="driverExperience">2 years</span>
                            </div>
                        </div>
                        <div class="driver-vehicle-details">
                            <div class="vehicle-detail-row">
                                <span class="vehicle-detail-label">Vehicle Type</span>
                                <span class="vehicle-detail-value" id="vehicleType">Car</span>
                            </div>
                            <div class="vehicle-detail-row">
                                <span class="vehicle-detail-label">Vehicle Model</span>
                                <span class="vehicle-detail-value" id="vehicleModel">Toyota Corolla</span>
                            </div>
                            <div class="vehicle-detail-row">
                                <span class="vehicle-detail-label">License Plate</span>
                                <span class="vehicle-detail-value" id="vehicleLicense">ABC 123</span>
                            </div>
                            <div class="vehicle-detail-row">
                                <span class="vehicle-detail-label">Color</span>
                                <span class="vehicle-detail-value" id="vehicleColor">Blue</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="driver-info">
                        <div class="driver-avatar" id="driverAvatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="driver-details">
                            <h2 id="driverName">Driver Name</h2>
                            <p><i class="fas fa-phone"></i> <span id="driverPhone">000-000-0000</span></p>
                            <p><i class="fas fa-car"></i> <span id="vehicleDetails">Toyota Corolla - ABC123</span></p>
                            <p><i class="fas fa-star"></i> <span id="driverRating">4.5 </span></p>
                        </div>
                    </div>
                    
                    <div class="trip-details">
                        <div class="location-row">
                            <div class="location-icon pickup-icon">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="location-text">
                                <h4>Pickup Location</h4>
                                <p id="currentPickupLocation">123 Main Street, City</p>
                            </div>
                        </div>
                        <div class="location-row">
                            <div class="location-icon destination-icon">
                                <i class="fas fa-flag"></i>
                            </div>
                            <div class="location-text">
                                <h4>Destination</h4>
                                <p id="currentDestinationLocation">456 Oak Avenue, City</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="fare-details">
                        <div class="fare-row">
                            <span>Base Fare</span>
                            <span id="baseFare">K15.00</span>
                        </div>
                        <div class="fare-row">
                            <span>Distance</span>
                            <span id="distanceFare">K5.00</span>
                        </div>
                        <div class="fare-row">
                            <span>Discount</span>
                            <span id="discountFare">-K2.00</span>
                        </div>
                        <div class="fare-row total">
                            <span>Total Fare</span>
                            <span id="totalFare">K18.00</span>
                        </div>
                    </div>
                    
                    <div class="ride-actions" id="rideActionsContainer">
                        <button class="btn btn-cancel" id="cancelRideBtn">
                            <i class="fas fa-times-circle"></i>
                            Cancel Ride
                        </button>
                        <button class="btn btn-contact" id="contactDriverBtn">
                            <i class="fas fa-phone"></i>
                            Contact Driver
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Screen Contents -->
        <div class="screen-content" id="homeScreen">
            <!-- Home screen is the map -->
        </div>
        
        <div class="screen-content" id="accountScreen">
            <div class="screen-header">
                <button class="back-button" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="screen-title">Account</h2>
            </div>
            
            <div class="account-section">
                <div class="account-header">
                    <div class="avatar large" id="accountAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="driver-details">
                        <h2 id="accountName">Passenger</h2>
                        <p><i class="fas fa-phone"></i> <span id="accountPhone">Not set</span></p>
                        <p><i class="fas fa-envelope"></i> <span id="accountEmail">Not set</span></p>
                    </div>
                </div>
                
                <div class="account-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="ridesCompleted">0</div>
                        <div class="stat-label">Completed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="ridesCancelled">0</div>
                        <div class="stat-label">Cancelled</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="ridesPending">0</div>
                        <div class="stat-label">Pending</div>
                    </div>
                </div>
                
                <div class="referral-section">
                    <h3 class="section-title">
                        <i class="fas fa-share-alt"></i>
                        Refer & Earn
                    </h3>
                    <p>Share your code and get K25 when friends join</p>
                    <div class="referral-code">
                        <div class="code" id="referralCode">JUBEL-XXXX</div>
                        <div class="description">50% discount for new users</div>
                    </div>
                    <button class="btn btn-primary" id="shareReferralBtn">
                        <i class="fas fa-share"></i>
                        Share Referral Code
                    </button>
                </div>
                
                <div class="wallet-section">
                    <h3 class="section-title">
                        <i class="fas fa-wallet"></i>
                        Jubel Wallet
                    </h3>
                    <div class="wallet-balance">
                        <div class="balance-label">Current Balance</div>
                        <div class="balance-amount-large" id="accountBalance">K0.00</div>
                    </div>
                    <div class="wallet-actions">
                        <button class="btn-wallet" id="depositBtn">
                            <i class="fas fa-plus"></i>
                            Deposit
                        </button>
                        <button class="btn-wallet" id="withdrawBtn">
                            <i class="fas fa-minus"></i>
                            Withdraw
                        </button>
                    </div>
                </div>
                
                <div class="contact-section">
                    <button class="contact-btn whatsapp" id="whatsappBtn">
                        <i class="fab fa-whatsapp"></i>
                        WhatsApp
                    </button>
                    <button class="contact-btn phone" id="callBtn">
                        <i class="fas fa-phone"></i>
                        Call Us
                    </button>
                </div>
            </div>
        </div>
        
        <div class="screen-content" id="historyScreen">
            <div class="screen-header">
                <button class="back-button" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="screen-title">Ride History</h2>
            </div>
            
            <div class="filter-options">
                <select id="historyFilter" class="form-control">
                    <option value="all">All Rides</option>
                    <option value="requested">Awaiting Driver</option>
                    <option value="accepted">In Progress</option>
                    <option value="completed">Completed</option>
                    <option value="cancelled">Cancelled</option>
                </select>
                <input type="date" id="historyDate" class="form-control">
            </div>
            
            <div class="history-section">
                <div id="historyList">
                    <div class="loading-text">
                        <i class="fas fa-spinner fa-spin"></i>
                        Loading ride history...
                    </div>
                </div>
            </div>
        </div>
        
        <div class="screen-content" id="paymentsScreen">
            <div class="screen-header">
                <button class="back-button" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="screen-title">Payment Methods</h2>
            </div>
            
            <div class="payments-section">
                <h3 class="section-title">
                    <i class="fas fa-credit-card"></i>
                    Payment Methods
                </h3>
                
                <div class="payment-options">
                    <div class="payment-option-card selected" data-method="airtel">
                        <div class="payment-icon-card">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="payment-details-card">
                            <div class="payment-name-card">Airtel Money</div>
                            <div class="payment-info-card">Pay with Airtel Money</div>
                        </div>
                    </div>
                    
                    <div class="payment-option-card" data-method="mtn">
                        <div class="payment-icon-card">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="payment-details-card">
                            <div class="payment-name-card">MTN Money</div>
                            <div class="payment-info-card">Pay with MTN Money</div>
                        </div>
                    </div>
                    
                    <div class="payment-option-card" data-method="zamtel">
                        <div class="payment-icon-card">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="payment-details-card">
                            <div class="payment-name-card">Zamtel Money</div>
                            <div class="payment-info-card">Pay with Zamtel Money</div>
                        </div>
                    </div>
                    
                    <div class="payment-option-card" data-method="card">
                        <div class="payment-icon-card">
                            <i class="fas fa-credit-card"></i>
                        </div>
                        <div class="payment-details-card">
                            <div class="payment-name-card">Credit/Debit Card</div>
                            <div class="payment-info-card">Visa, Mastercard</div>
                        </div>
                    </div>
                    
                    <div class="payment-option-card" data-method="cash">
                        <div class="payment-icon-card">
                            <i class="fas fa-money-bill"></i>
                        </div>
                        <div class="payment-details-card">
                            <div class="payment-name-card">Cash</div>
                            <div class="payment-info-card">Pay with cash</div>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-primary" id="addPaymentMethodBtn">
                    <i class="fas fa-plus"></i>
                    Add Payment Method
                </button>
            </div>
        </div>
        
        <!-- Schedule Screen -->
        <div class="screen-content" id="scheduleScreen">
            <div class="screen-header">
                <button class="back-button" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="screen-title">Scheduled Rides</h2>
            </div>
            
            <div class="scheduled-rides-section">
                <div class="scheduled-rides-list" id="scheduledRidesList">
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="empty-state-title">No scheduled rides</div>
                        <div class="empty-state-description">Schedule your first ride to get started</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Payment Selection Popup -->
    <div id="paymentSelectionPopup" class="popup-overlay hidden">
        <div class="popup-form payment-selection-popup">
            <div class="popup-header">
                <h2 class="popup-title">
                    <i class="fas fa-credit-card"></i>
                    Select Payment Method
                </h2>
                <button class="close-popup" id="closePaymentPopup">&times;</button>
            </div>
            <div class="popup-content">
                <div class="payment-options">
                    <div class="payment-option selected" data-payment-type="wallet">
                        <div class="payment-option-icon">
                            <i class="fas fa-wallet"></i>
                        </div>
                        <div class="payment-option-details">
                            <div class="payment-option-name">Jubel Wallet</div>
                            <div class="payment-option-description">Pay with your Jubel wallet balance</div>
                            <div class="payment-option-balance" id="paymentWalletBalance">Balance: K0.00</div>
                        </div>
                    </div>
                    
                    <div class="payment-option" data-payment-type="mobile">
                        <div class="payment-option-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="payment-option-details">
                            <div class="payment-option-name">Mobile Money</div>
                            <div class="payment-option-description">Pay with Airtel, MTN or Zamtel Money</div>
                        </div>
                    </div>
                    
                    <div class="payment-option" data-payment-type="cash">
                        <div class="payment-option-icon">
                            <i class="fas fa-money-bill"></i>
                        </div>
                        <div class="payment-option-details">
                            <div class="payment-option-name">Cash on Delivery</div>
                            <div class="payment-option-description">Pay with cash when you arrive</div>
                        </div>
                    </div>
                </div>
                
                <div class="insufficient-balance" id="insufficientBalance">
                    <i class="fas fa-exclamation-circle"></i>
                    Insufficient balance in your Jubel wallet
                </div>
                
                <button class="confirm-payment-btn" id="confirmPaymentBtn">
                    Confirm Payment & Request Ride
                </button>
            </div>
        </div>
    </div>
    
    <!-- Enhanced Ride Details Popup -->
    <div id="rideDetailsPopup" class="popup-overlay hidden">
        <div class="popup-form large-popup">
            <div class="popup-header">
                <h2 class="popup-title">
                    <i class="fas fa-info-circle"></i>
                    Ride Details
                </h2>
                <button class="close-popup" id="closeRidePopupTop">&times;</button>
            </div>
            <div class="popup-content">
                <div class="history-map-container" id="popupRideMap"></div>
                
                <div class="route-details">
                    <div class="route-point">
                        <div class="route-icon route-pickup-icon">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="route-text">
                            <div class="route-label">Pickup Location</div>
                            <div class="route-address" id="popupRidePickup">Loading...</div>
                        </div>
                    </div>
                    
                    <div class="route-point">
                        <div class="route-icon route-destination-icon">
                            <i class="fas fa-flag"></i>
                        </div>
                        <div class="route-text">
                            <div class="route-label">Destination</div>
                            <div class="route-address" id="popupRideDestination">Loading...</div>
                        </div>
                    </div>
                </div>
                
                <div class="fare-breakdown">
                    <div class="fare-row">
                        <span>Fare:</span>
                        <span id="popupRideFare">K0.00</span>
                    </div>
                    <div class="fare-row">
                        <span>Distance:</span>
                        <span id="popupRideDistance">0 km</span>
                    </div>
                    <div class="fare-row">
                        <span>Ride Type:</span>
                        <span id="popupRideType">Standard</span>
                    </div>
                    <div class="fare-row">
                        <span>Status:</span>
                        <span id="popupRideStatus">Completed</span>
                    </div>
                    <div class="fare-row">
                        <span>Date & Time:</span>
                        <span id="popupRideDate">Loading...</span>
                    </div>
                </div>
                
                <!-- Enhanced Driver Details Section -->
                <div id="popupDriverDetails" class="driver-details-section">
                    <h3 class="section-title">Driver Information</h3>
                    <div class="driver-details-enhanced">
                        <div class="driver-avatar-enhanced" id="popupDriverAvatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="driver-info-enhanced">
                            <div class="driver-name" id="popupDriverName">Driver Name</div>
                            <div class="driver-phone">
                                <i class="fas fa-phone"></i>
                                <span id="popupDriverPhone">000-000-0000</span>
                            </div>
                            <div class="driver-rating" id="popupDriverRating">4.5 </div>
                        </div>
                    </div>
                    <div class="vehicle-info mt-2">
                        <div class="fare-row">
                            <span>Vehicle:</span>
                            <span id="popupDriverVehicle">Toyota Corolla - ABC123</span>
                        </div>
                        <div class="fare-row">
                            <span>Progress:</span>
                            <span id="popupDriverProgress">Trip Completed</span>
                        </div>
                    </div>
                </div>
                
                <!-- Enhanced Chat History Section -->
                <div id="popupChatHistory" class="chat-history-section">
                    <h3 class="section-title">Chat History</h3>
                    <div class="chat-history" id="popupChatMessages">
                        <div class="empty-state">
                            <div class="empty-state-icon">
                                <i class="fas fa-comments"></i>
                            </div>
                            <div class="empty-state-title">No chat messages</div>
                            <div class="empty-state-description">No messages were exchanged during this ride</div>
                        </div>
                    </div>
                </div>
                
                <div class="popup-actions">
                    <button class="btn btn-secondary" id="closeRidePopup">
                        <i class="fas fa-times"></i>
                        Close
                    </button>
                    <button class="btn btn-primary" id="shareRideDetailsBtn">
                        <i class="fas fa-share-alt"></i>
                        Share Details
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Schedule Ride Popup -->
    <div id="scheduleRidePopup" class="popup-overlay hidden">
        <div class="popup-form schedule-popup">
            <div class="popup-header">
                <h2 class="popup-title">
                    <i class="fas fa-clock"></i>
                    Schedule a Ride
                </h2>
                <button class="close-popup" id="closeSchedulePopup">&times;</button>
            </div>
            <div class="popup-content">
                <div class="schedule-tabs">
                    <button class="schedule-tab active" data-tab="standard">Standard Ride</button>
                    <button class="schedule-tab" data-tab="delivery">Delivery</button>
                    <button class="schedule-tab" data-tab="someone-else">For Someone Else</button>
                </div>
                
                <div id="scheduleStandardForm" class="schedule-form active">
                    <div class="location-input-container">
                        <div class="location-input">
                            <i class="fas fa-map-marker-alt"></i>
                            <input type="text" id="schedulePickupLocation" placeholder="Pickup location">
                            <div class="suggestion-list" id="schedulePickupSuggestions"></div>
                        </div>
                    </div>
                    <div class="location-input-container">
                        <div class="location-input">
                            <i class="fas fa-flag"></i>
                            <input type="text" id="scheduleDestination" placeholder="Destination">
                            <div class="suggestion-list" id="scheduleDestinationSuggestions"></div>
                        </div>
                    </div>
                    
                    <div class="vehicle-selection">
                        <div class="vehicle-option selected" data-type="car">
                            <i class="fas fa-car vehicle-icon"></i>
                            <span class="vehicle-name">Car</span>
                        </div>
                        <div class="vehicle-option" data-type="bike">
                            <i class="fas fa-motorcycle vehicle-icon"></i>
                            <span class="vehicle-name">Bike</span>
                        </div>
                        <div class="vehicle-option" data-type="bicycle">
                            <i class="fas fa-bicycle vehicle-icon"></i>
                            <span class="vehicle-name">Bicycle</span>
                        </div>
                    </div>
                    
                    <button class="package-toggle" id="schedulePackageToggle" style="display: none;">
                        <i class="fas fa-box"></i>
                        Add Package Details
                    </button>
                    
                    <div class="package-form" id="schedulePackageForm" style="display: none;">
                        <h4 class="section-title">Package Details</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="scheduleReceiverName">Receiver Name</label>
                                <input type="text" id="scheduleReceiverName" placeholder="Full name">
                            </div>
                            <div class="form-group">
                                <label for="scheduleReceiverPhone">Receiver Phone</label>
                                <input type="tel" id="scheduleReceiverPhone" placeholder="Phone number">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="schedulePackageDescription">Package Description</label>
                            <input type="text" id="schedulePackageDescription" placeholder="What is being delivered?">
                        </div>
                        <div class="form-group">
                            <label for="scheduleSpecialInstructions">Special Instructions</label>
                            <textarea id="scheduleSpecialInstructions" placeholder="Any special handling instructions?"></textarea>
                        </div>
                    </div>
                </div>
                
                <div id="scheduleDeliveryForm" class="schedule-form" style="display: none;">
                    <div class="form-group-enhanced">
                        <label for="scheduleShopName" class="form-label">Shop or Restaurant Name</label>
                        <input type="text" id="scheduleShopName" class="form-control" placeholder="Name of shop or restaurant">
                    </div>
                    <div class="location-input-container">
                        <div class="location-input">
                            <i class="fas fa-map-marker-alt"></i>
                            <input type="text" id="scheduleShopLocation" placeholder="Shop location">
                            <div class="suggestion-list" id="scheduleShopSuggestions"></div>
                        </div>
                    </div>
                    <div class="form-group-enhanced">
                        <label for="scheduleDeliveryItems" class="form-label">Items to Purchase</label>
                        <textarea id="scheduleDeliveryItems" class="form-control" placeholder="List of items to be purchased"></textarea>
                    </div>
                    <div class="location-input-container">
                        <div class="location-input">
                            <i class="fas fa-flag"></i>
                            <input type="text" id="scheduleDeliveryDestination" placeholder="Delivery destination">
                            <div class="suggestion-list" id="scheduleDeliveryDestSuggestions"></div>
                        </div>
                    </div>
                </div>
                
                <div id="scheduleSomeoneElseForm" class="schedule-form" style="display: none;">
                    <div class="location-input-container">
                        <div class="location-input">
                            <i class="fas fa-map-marker-alt"></i>
                            <input type="text" id="scheduleRecipientPickup" placeholder="Recipient pickup location">
                            <div class="suggestion-list" id="scheduleRecipientPickupSuggestions"></div>
                        </div>
                    </div>
                    <div class="location-input-container">
                        <div class="location-input">
                            <i class="fas fa-flag"></i>
                            <input type="text" id="scheduleRecipientDestination" placeholder="Recipient destination">
                            <div class="suggestion-list" id="scheduleRecipientDestSuggestions"></div>
                        </div>
                    </div>
                    <div class="form-group-enhanced">
                        <label for="scheduleRecipientName" class="form-label">Recipient Name</label>
                        <input type="text" id="scheduleRecipientName" class="form-control" placeholder="Full name">
                    </div>
                    <div class="form-group-enhanced">
                        <label for="scheduleRecipientPhone" class="form-label">Recipient Phone</label>
                        <input type="tel" id="scheduleRecipientPhone" class="form-control" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="scheduling-options mt-3">
                    <div class="form-group-enhanced">
                        <label for="scheduleDate" class="form-label">Date</label>
                        <input type="date" id="scheduleDate" class="form-control" min="">
                    </div>
                    <div class="form-group-enhanced">
                        <label for="scheduleTime" class="form-label">Time</label>
                        <input type="time" id="scheduleTime" class="form-control">
                    </div>
                    <div class="form-group-enhanced">
                        <label for="schedulePaymentMethod" class="form-label">Payment Method</label>
                        <select id="schedulePaymentMethod" class="form-control">
                            <option value="wallet">Jubel Wallet</option>
                            <option value="cash">Cash</option>
                            <option value="mobile">Mobile Money</option>
                        </select>
                    </div>
                </div>
                
                <div class="fare-display mt-3">
                    <p>Estimated Fare</p>
                    <div class="fare-amount" id="scheduleEstimatedFare">K0.00</div>
                    <p class="eta-display" id="scheduleEtaDisplay">ETA: -- min</p>
                </div>
                
                <div class="action-buttons mt-3">
                    <button id="confirmScheduleRideBtn" class="btn btn-primary">
                        <i class="fas fa-calendar-check"></i> Schedule Ride
                    </button>
                    <button id="cancelScheduleBtn" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Chat Popup -->
    <div id="chatPopup" class="popup-overlay hidden">
        <div class="popup-form" style="max-width: 400px; height: 500px; display: flex; flex-direction: column;">
            <div class="popup-header">
                <h2 class="popup-title">
                    <i class="fas fa-comments"></i>
                    Chat with Driver
                </h2>
                <button class="close-popup" id="closeChatPopup">&times;</button>
            </div>
            <div class="chat-driver-info">
                <div class="flex align-center gap-2">
                    <div class="avatar small" id="chatDriverAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div>
                        <div class="driver-name" id="chatDriverName">Driver</div>
                        <div class="driver-rating" id="chatDriverRating">4.5 </div>
                    </div>
                </div>
            </div>
            <div class="chat-messages" id="chatMessages" style="flex: 1;"></div>
            <div class="chat-input-container">
                <div class="flex gap-2">
                    <input type="text" id="chatMessageInput" placeholder="Type your message..." class="form-control">
                    <button id="sendChatMessageBtn" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Rating Popup -->
    <div id="ratingPopup" class="popup-overlay hidden">
        <div class="popup-form" style="max-width: 450px;">
            <div class="popup-header">
                <h2 class="popup-title">
                    <i class="fas fa-star"></i>
                    Rate Your Experience
                </h2>
                <button class="close-popup" id="closeRatingPopup">&times;</button>
            </div>
            <div class="popup-content">
                <div class="rating-driver-info text-center mb-3">
                    <div class="avatar large mx-auto mb-2" id="ratingDriverAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <h3 id="ratingDriverName">Driver Name</h3>
                    <p id="ratingVehicleInfo" class="text-muted">Vehicle Info</p>
                    <p class="text-primary">
                        <i class="fas fa-map-marker-alt"></i> 
                        <span id="ratingTripInfo">Trip completed</span>
                    </p>
                </div>
                
                <div class="rating-container">
                    <div class="rating-category">
                        <span>Overall Experience</span>
                        <div class="rating-stars-enhanced" id="ratingStars">
                            <span class="rating-star" data-rating="1"></span>
                            <span class="rating-star" data-rating="2"></span>
                            <span class="rating-star" data-rating="3"></span>
                            <span class="rating-star" data-rating="4"></span>
                            <span class="rating-star" data-rating="5"></span>
                        </div>
                    </div>
                    
                    <div class="rating-category">
                        <span>Driver Courtesy</span>
                        <div class="rating-stars-enhanced" data-category="courtesy">
                            <span class="rating-star" data-value="1"></span>
                            <span class="rating-star" data-value="2"></span>
                            <span class="rating-star" data-value="3"></span>
                            <span class="rating-star" data-value="4"></span>
                            <span class="rating-star" data-value="5"></span>
                        </div>
                    </div>
                    
                    <div class="rating-category">
                        <span>Vehicle Cleanliness</span>
                        <div class="rating-stars-enhanced" data-category="cleanliness">
                            <span class="rating-star" data-value="1"></span>
                            <span class="rating-star" data-value="2"></span>
                            <span class="rating-star" data-value="3"></span>
                            <span class="rating-star" data-value="4"></span>
                            <span class="rating-star" data-value="5"></span>
                        </div>
                    </div>
                    
                    <div class="rating-category">
                        <span>Driving Safety</span>
                        <div class="rating-stars-enhanced" data-category="safety">
                            <span class="rating-star" data-value="1"></span>
                            <span class="rating-star" data-value="2"></span>
                            <span class="rating-star" data-value="3"></span>
                            <span class="rating-star" data-value="4"></span>
                            <span class="rating-star" data-value="5"></span>
                        </div>
                    </div>
                </div>
                
                <div class="form-group-enhanced mt-3">
                    <label for="ratingComment" class="form-label">Additional Comments (Optional)</label>
                    <textarea id="ratingComment" class="form-control" placeholder="Share your experience or any suggestions..." rows="3"></textarea>
                </div>
                
                <div class="action-buttons mt-3">
                    <button id="skipRatingBtn" class="btn btn-secondary">
                        Skip Rating
                    </button>
                    <button id="submitRatingBtn" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i> Submit Rating
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification"></div>
    
    <!-- Firebase and Leaflet JS -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <script>
// Enhanced Firebase configuration
const firebaseConfig = {
    apiKey: "AIzaSyDEACX_P4c5q7djJAcA0I7Lk7leO2TlQ74",
    authDomain: "jubel-13e1a.firebaseapp.com",
    databaseURL: "https://jubel-13e1a-default-rtdb.firebaseio.com",
    projectId: "jubel-13e1a",
    storageBucket: "jubel-13e1a.firebasestorage.app",
    messagingSenderId: "882241095445",
    appId: "1:882241095445:web:ee9ca40fddd008ca910b1c",
    measurementId: "G-J5JPKL6B5F"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const auth = firebase.auth();

// Enhanced App State
let currentUser = null;
let currentRide = null;
let passengerMap = null;
let popupRideMap = null;
let locationWatchId = null;
let currentLocationMarker = null;
let pickupMarker = null;
let destinationMarker = null;
let driverMarker = null;
let routePolyline = null;
let selectedVehicleType = 'car';
let walletBalance = 0;
let userFullName = "Passenger";
let driverAssignmentListener = null;
let rideHistoryListener = null;
let activeRideListener = null;
let appliedPromoCode = null;
let userStats = {
    completed: 0,
    cancelled: 0,
    pending: 0
};
let paymentMethod = 'airtel';
let userRating = 0;
let userLocation = null;
let destinationSearchResults = [];
let selectedDestination = null;
let driverLocationListener = null;
let userData = null;
let selectedPaymentType = 'wallet';
let rideFare = 0;
let currentCity = null;
let packageDetails = null;
let walletBalanceListener = null;
let currentScreen = 'home';
let homeScreenRefreshRequired = false;
let searchDebounceTimer = null;
let currentSearchField = null;
let lastSearchQuery = "";
let searchCache = new Map();
let searchCacheTimestamp = new Map();
const SEARCH_CACHE_TTL = 5 * 60 * 1000; // 5 minutes

// Enhanced Search Variables
let activeSearchResults = [];
let pickupSearchResults = [];
let recipientPickupSearchResults = [];
let shopLocationSearchResults = [];
let deliveryDestinationSearchResults = [];
let schedulePickupSearchResults = [];
let scheduleDestinationSearchResults = [];
let scheduleShopSearchResults = [];
let scheduleDeliveryDestSearchResults = [];
let scheduleRecipientPickupSearchResults = [];
let scheduleRecipientDestSearchResults = [];

// Enhanced Feature Variables
let sosConfig = null;
let activeMoreOption = null;
let recipientPickupMarker = null;
let recipientDestinationMarker = null;
let shopLocationMarker = null;
let deliveryDestinationMarker = null;
let chatListener = null;
let currentChatRideId = null;
let unreadMessages = {};
let chatPopupClosedByUser = false;
let driverMessageListener = null;
let currentRideRequestType = 'standard';
let currentRideRequestData = null;
let driverProfileImage = null;
let driverVehicleImage = null;
let activeRideRestored = false;
let scheduledRides = [];
let scheduledRideTimers = {};
let scheduledRideCheckInterval = null;
let liveTrackingListeners = {};
let sharedRideLinks = {};

// Enhanced Zambian cities with comprehensive data
const zambianCities = [
    'Lusaka', 'Kitwe', 'Ndola', 'Kabwe', 'Chipata', 'Chingola', 
    'Mufulira', 'Luanshya', 'Livingstone', 'Kasama', 'Solwezi', 
    'Kapiri Mposhi', 'Chililabombwe', 'Mazabuka', 'Mongu', 'Kafue',
    'Choma', 'Mansa', 'Nchelenge', 'Senanga', 'Sesheke', 'Kalulushi',
    'Lundazi', 'Petauke', 'Mpika', 'Mwinilunga', 'Nakonde', 'Mbala',
    'Isoka', 'Chinsali', 'Mpongwe', 'Serenje', 'Chongwe', 'Rufunsa',
    'Kabwe Central', 'Luwingu', 'Mufumbwe', 'Chavuma', 'Shangombo'
];

const cityAliases = {
    'lusaka': 'Lusaka', 'lsk': 'Lusaka', 'lsk city': 'Lusaka', 'lusaka city': 'Lusaka',
    'kitwe': 'Kitwe', 'kitwe town': 'Kitwe', 'kitwe central': 'Kitwe',
    'ndola': 'Ndola', 'ndola city': 'Ndola', 'ndola central': 'Ndola',
    'kabwe': 'Kabwe', 'kabwe town': 'Kabwe', 'kabwe central': 'Kabwe',
    'chipata': 'Chipata', 'chipata town': 'Chipata', 'chipata central': 'Chipata',
    'chingola': 'Chingola', 'chingola town': 'Chingola',
    'mufulira': 'Mufulira', 'mufulira town': 'Mufulira',
    'luanshya': 'Luanshya', 'luanshya town': 'Luanshya',
    'livingstone': 'Livingstone', 'livingstone town': 'Livingstone',
    'kasama': 'Kasama', 'kasama town': 'Kasama',
    'solwezi': 'Solwezi', 'solwezi town': 'Solwezi',
    'kapiri': 'Kapiri Mposhi', 'kapiri mposhi': 'Kapiri Mposhi',
    'chililabombwe': 'Chililabombwe', 'chililabombwe town': 'Chililabombwe',
    'mazabuka': 'Mazabuka', 'mazabuka town': 'Mazabuka',
    'mongu': 'Mongu', 'mongu town': 'Mongu',
    'kafue': 'Kafue', 'kafue town': 'Kafue',
    'choma': 'Choma', 'choma town': 'Choma',
    'mansa': 'Mansa', 'mansa town': 'Mansa'
};

const cityBoundaries = {
    'Lusaka': { lat: -15.4167, lng: 28.2833, radius: 30000, displayName: 'Lusaka, Zambia' },
    'Kitwe': { lat: -12.8139, lng: 28.2136, radius: 25000, displayName: 'Kitwe, Zambia' },
    'Ndola': { lat: -12.9667, lng: 28.6333, radius: 25000, displayName: 'Ndola, Zambia' },
    'Kabwe': { lat: -14.4333, lng: 28.4500, radius: 20000, displayName: 'Kabwe, Zambia' },
    'Chipata': { lat: -13.6333, lng: 32.6500, radius: 20000, displayName: 'Chipata, Zambia' },
    'Chingola': { lat: -12.5333, lng: 27.8500, radius: 20000, displayName: 'Chingola, Zambia' },
    'Mufulira': { lat: -12.5500, lng: 28.2333, radius: 20000, displayName: 'Mufulira, Zambia' },
    'Luanshya': { lat: -13.1333, lng: 28.4000, radius: 20000, displayName: 'Luanshya, Zambia' },
    'Livingstone': { lat: -17.8500, lng: 25.8667, radius: 20000, displayName: 'Livingstone, Zambia' },
    'Kasama': { lat: -10.2000, lng: 31.2000, radius: 20000, displayName: 'Kasama, Zambia' },
    'Solwezi': { lat: -12.1833, lng: 26.4000, radius: 20000, displayName: 'Solwezi, Zambia' },
    'Kapiri Mposhi': { lat: -13.9667, lng: 28.6833, radius: 15000, displayName: 'Kapiri Mposhi, Zambia' },
    'Chililabombwe': { lat: -12.3667, lng: 27.8333, radius: 15000, displayName: 'Chililabombwe, Zambia' },
    'Mazabuka': { lat: -15.8667, lng: 27.7667, radius: 15000, displayName: 'Mazabuka, Zambia' },
    'Mongu': { lat: -15.2500, lng: 23.1500, radius: 20000, displayName: 'Mongu, Zambia' },
    'Kafue': { lat: -15.7667, lng: 28.1833, radius: 15000, displayName: 'Kafue, Zambia' },
    'Choma': { lat: -16.8000, lng: 26.9833, radius: 15000, displayName: 'Choma, Zambia' },
    'Mansa': { lat: -11.2000, lng: 28.8833, radius: 15000, displayName: 'Mansa, Zambia' }
};

// Enhanced Zambian landmarks and common places for quick search
const commonLandmarks = {
    'Lusaka': [
        'Manda Hill Shopping Mall', 'East Park Mall', 'Arcades Shopping Mall', 'Levy Junction Mall',
        'University of Zambia', 'Lusaka International Airport', 'Lusaka Central Hospital',
        'Lusaka National Museum', 'State House', 'National Assembly', 'Supreme Court',
        'Zambia National Broadcasting Corporation', 'Lusaka Golf Club', 'Zambia National Service',
        'Lusaka City Market', 'Soweto Market', 'Kamwala Market', 'Chilenje Market',
        'Lusaka Bus Station', 'Intercity Bus Terminus'
    ],
    'Kitwe': [
        'Mukuba Mall', 'Kitwe Main Market', 'Kitwe Central Hospital', 'Copperbelt University',
        'Nkana Golf Club', 'Mindolo Dam', 'Kitwe Museum', 'Chimwemwe Shopping Centre',
        'Riverside Mall', 'Kitwe City Mall'
    ],
    'Ndola': [
        'Mukuba Mall', 'Ndola Central Hospital', 'Copperbelt University Ndola Campus',
        'Ndola Golf Club', 'Dag Hammarskjld Crash Site', 'Ndola Museum', 'Masala Market',
        'Ndola Central Police Station', 'Simon Mwansa Kapwepwe International Airport'
    ],
    'Livingstone': [
        'Victoria Falls', 'Livingstone Museum', 'Mosi-oa-Tunya National Park',
        'Livingstone Airport', 'Maramba Market', 'Livingstone Central Hospital',
        'David Livingstone Safari Lodge', 'Royal Livingstone Hotel'
    ]
};

// Enhanced place types for better categorization
const placeTypes = {
    'restaurant': { icon: '', color: '#FF6B35' },
    'cafe': { icon: '', color: '#795548' },
    'bar': { icon: '', color: '#FF9800' },
    'hotel': { icon: '', color: '#2196F3' },
    'mall': { icon: '', color: '#9C27B0' },
    'supermarket': { icon: '', color: '#4CAF50' },
    'bank': { icon: '', color: '#009688' },
    'hospital': { icon: '', color: '#F44336' },
    'school': { icon: '', color: '#3F51B5' },
    'university': { icon: '', color: '#673AB7' },
    'airport': { icon: '', color: '#00BCD4' },
    'bus_station': { icon: '', color: '#FF5722' },
    'park': { icon: '', color: '#4CAF50' },
    'museum': { icon: '', color: '#795548' },
    'market': { icon: '', color: '#FF9800' },
    'pharmacy': { icon: '', color: '#2196F3' },
    'fuel': { icon: '', color: '#FFC107' },
    'parking': { icon: '', color: '#607D8B' },
    'default': { icon: '', color: '#FF6B35' }
};

// Initialize the app
document.addEventListener('DOMContentLoaded', function() {
    console.log(" Jubel Passenger App Initializing...");
    initializeAuth();
    setupPerformanceMonitoring();
    setupErrorHandling();
});

// Performance monitoring
function setupPerformanceMonitoring() {
    window.addEventListener('load', function() {
        const timing = performance.timing;
        const loadTime = timing.loadEventEnd - timing.navigationStart;
        console.log(` Page loaded in ${loadTime}ms`);
        
        if (loadTime > 3000) {
            console.warn(" Page load time is high, optimizing...");
        }
    });
}

// Enhanced error handling
function setupErrorHandling() {
    window.onerror = function(msg, url, lineNo, columnNo, error) {
        console.error(" Global error:", {
            message: msg,
            url: url,
            line: lineNo,
            column: columnNo,
            error: error
        });
        return false;
    };
    
    window.addEventListener('unhandledrejection', function(event) {
        console.error(" Unhandled promise rejection:", event.reason);
    });
}

// Enhanced authentication
function initializeAuth() {
    showLoading("Authenticating...");
    
    const urlParams = new URLSearchParams(window.location.search);
    const email = urlParams.get('email');
    const uid = urlParams.get('uid');
    
    if (email && uid) {
        console.log(" Authenticating with URL parameters...");
        loadUserData(uid);
    } else {
        console.log(" Checking Firebase auth state...");
        auth.onAuthStateChanged(user => {
            if (user) {
                console.log(" User authenticated:", user.uid);
                currentUser = user;
                loadUserData(user.uid);
            } else {
                console.log(" No authenticated user, redirecting to signup...");
                window.location.href = 'signup.html';
            }
        }, error => {
            console.error(" Auth state change error:", error);
            hideLoading();
            showNotification("Authentication error. Please refresh the page.");
        });
    }
}

// Enhanced user data loading
function loadUserData(uid) {
    showLoading("Loading your profile...");
    
    database.ref('users/' + uid).once('value')
        .then(snapshot => {
            userData = snapshot.val();
            if (userData) {
                console.log(" User data loaded:", userData);
                currentUser = {
                    uid: uid,
                    email: userData.email,
                    displayName: userData.name
                };
                
                initializeMap();
                setupEventListeners();
                loadPassengerData();
                
                // Update account information
                document.getElementById('accountName').textContent = userData.name || 'Passenger';
                document.getElementById('accountEmail').textContent = userData.email || 'Not set';
                document.getElementById('accountPhone').textContent = userData.phone || 'Not set';
                document.getElementById('referralCode').textContent = userData.referralCode || 'JUBEL-XXXX';
                
                walletBalance = userData.walletBalance || 0;
                updateWalletBalanceUI();
                
                // Setup listeners
                setupWalletBalanceListener(uid);
                loadSOSConfig(uid);
                checkActiveRide(uid);
                loadScheduledRides(uid);
                initializeCityDetection();
                
                showNotification('Welcome back to Jubel! ');
                hideLoading();
            } else {
                console.error(" User data not found");
                showNotification('User data not found. Please sign up again.');
                setTimeout(() => {
                    window.location.href = 'signup.html';
                }, 2000);
            }
        })
        .catch(error => {
            console.error(' Error loading user data:', error);
            hideLoading();
            showNotification('Error loading user data. Please try again.');
        });
}

// Enhanced map initialization
function initializeMap() {
    console.log(" Initializing map...");
    
    // Default to Lusaka coordinates
    const defaultLat = -15.4167;
    const defaultLng = 28.2833;
    
    passengerMap = L.map('map', {
        zoomControl: false,
        attributionControl: false
    }).setView([defaultLat, defaultLng], 13);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: ' OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(passengerMap);
    
    // Initialize popup map for ride details
    popupRideMap = L.map('popupRideMap').setView([defaultLat, defaultLng], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: ' OpenStreetMap contributors'
    }).addTo(popupRideMap);
    
    // Add custom controls
    addMapControls();
    
    // Refresh passenger position
    refreshPassengerPosition();
    
    console.log(" Map initialized successfully");
}

// Enhanced map controls
function addMapControls() {
    // Add zoom control
    L.control.zoom({
        position: 'topright'
    }).addTo(passengerMap);
    
    // Add attribution
    L.control.attribution({
        position: 'bottomright'
    }).addTo(passengerMap);
    
    console.log(" Map controls added");
}

// Enhanced city detection
function initializeCityDetection() {
    if (userLocation) {
        determineCurrentCity(userLocation.lat, userLocation.lng)
            .then(city => {
                console.log(" City detected:", city);
                updateCityUI(city);
                updateSearchRestrictions(city);
            })
            .catch(error => {
                console.error(" City detection failed:", error);
                setDefaultCity();
            });
    } else {
        setDefaultCity();
    }
}

function setDefaultCity() {
    currentCity = "Lusaka";
    updateCityUI(currentCity);
    updateSearchRestrictions(currentCity);
    console.log(" Using default city:", currentCity);
}

function updateCityUI(city) {
    document.getElementById('currentCity').textContent = city;
    document.getElementById('currentCityDisplay').textContent = city;
    document.getElementById('cityIndicator').style.display = 'flex';
    
    // Add animation for city change
    const cityElement = document.getElementById('currentCity');
    cityElement.style.transform = 'scale(1.1)';
    setTimeout(() => {
        cityElement.style.transform = 'scale(1)';
    }, 300);
}

function updateSearchRestrictions(city) {
    console.log(" Search restricted to city:", city);
    // This will be used by the search functions to filter results
}

// Enhanced location refresh
function refreshPassengerPosition() {
    showLoading("Detecting your location...");
    
    if (!navigator.geolocation) {
        console.error(" Geolocation not supported");
        hideLoading();
        showNotification("Geolocation is not supported by your browser.");
        return;
    }
    
    navigator.geolocation.getCurrentPosition(
        position => {
            handleLocationSuccess(position);
        },
        error => {
            handleLocationError(error);
        },
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        }
    );
}

function handleLocationSuccess(position) {
    const lat = position.coords.latitude;
    const lng = position.coords.longitude;
    userLocation = { lat, lng };
    
    console.log(" Location obtained:", userLocation);
    
    // Update map view
    passengerMap.setView([lat, lng], 16);
    
    // Update or create current location marker
    if (currentLocationMarker) {
        currentLocationMarker.setLatLng([lat, lng]);
    } else {
        currentLocationMarker = L.marker([lat, lng], {
            icon: L.divIcon({
                className: 'current-location-marker',
                html: '<div class="current-location-marker"><i class="fas fa-user"></i></div>',
                iconSize: [20, 20]
            })
        }).addTo(passengerMap)
            .bindPopup('Your current location');
    }
    
    // Update pickup location
    updatePickupLocation(lat, lng);
    
    // Detect city
    determineCurrentCity(lat, lng)
        .then(city => {
            console.log(" City detected from location:", city);
            updateCityUI(city);
            updateSearchRestrictions(city);
            showNotification(`Location detected in ${city} `);
            hideLoading();
            
            // Start continuous location tracking
            if (!locationWatchId) {
                startLocationTracking();
            }
        })
        .catch(error => {
            console.error(" City detection failed:", error);
            setDefaultCity();
            hideLoading();
        });
}

function handleLocationError(error) {
    console.error(" Geolocation error:", error);
    hideLoading();
    
    let errorMessage = 'Unable to refresh location. ';
    
    switch(error.code) {
        case error.PERMISSION_DENIED:
            errorMessage = 'Location access denied. Please enable location services in your browser settings.';
            break;
        case error.POSITION_UNAVAILABLE:
            errorMessage = 'Location information is unavailable.';
            break;
        case error.TIMEOUT:
            errorMessage = 'Location request timed out. Please try again.';
            break;
        default:
            errorMessage = 'Unknown location error occurred.';
    }
    
    showNotification(errorMessage);
    setDefaultCity();
}

// Enhanced city detection function
function determineCurrentCity(lat, lng) {
    return new Promise((resolve, reject) => {
        console.log(" Determining city for coordinates:", lat, lng);
        
        // First check city boundaries
        const boundaryCity = checkCityBoundaries(lat, lng);
        if (boundaryCity) {
            console.log(" City determined from boundaries:", boundaryCity);
            currentCity = boundaryCity;
            resolve(currentCity);
            return;
        }
        
        // Use reverse geocoding as fallback
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1&accept-language=en`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Reverse geocoding error: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                const detectedCity = extractCityFromGeocodeData(data);
                if (detectedCity && detectedCity !== "Unknown Location") {
                    console.log(" City determined from geocoding:", detectedCity);
                    currentCity = detectedCity;
                    resolve(currentCity);
                } else {
                    console.log(" City not found in geocoding data");
                    const fallbackCity = determineCityByProximity(lat, lng);
                    currentCity = fallbackCity;
                    resolve(currentCity);
                }
            })
            .catch(error => {
                console.error(" Reverse geocoding error:", error);
                const fallbackCity = determineCityByProximity(lat, lng) || "Lusaka";
                currentCity = fallbackCity;
                resolve(currentCity);
            });
    });
}

function checkCityBoundaries(lat, lng) {
    for (const [city, boundary] of Object.entries(cityBoundaries)) {
        const distance = calculateDistance(lat, lng, boundary.lat, boundary.lng);
        if (distance <= boundary.radius) {
            return city;
        }
    }
    return null;
}

function extractCityFromGeocodeData(data) {
    if (!data || !data.address) {
        return null;
    }
    
    const address = data.address;
    const priorityFields = [
        'city', 'town', 'village', 'municipality', 
        'suburb', 'county', 'state_district', 'state'
    ];
    
    for (const field of priorityFields) {
        if (address[field]) {
            const detectedName = address[field].toString().trim();
            const normalized = normalizeCityName(detectedName);
            if (zambianCities.includes(normalized)) {
                return normalized;
            }
        }
    }
    
    return null;
}

function normalizeCityName(cityName) {
    if (!cityName) return "";
    
    const normalized = cityName.toString().trim();
    
    // Handle common variations
    const lowerName = normalized.toLowerCase();
    
    // Check if it's a known alias
    if (cityAliases[lowerName]) {
        return cityAliases[lowerName];
    }
    
    // Check for exact match
    for (const city of zambianCities) {
        if (city.toLowerCase() === lowerName) {
            return city;
        }
    }
    
    // Check for partial match
    for (const city of zambianCities) {
        if (lowerName.includes(city.toLowerCase()) || city.toLowerCase().includes(lowerName)) {
            return city;
        }
    }
    
    return normalized;
}

function determineCityByProximity(lat, lng) {
    let closestCity = null;
    let shortestDistance = Infinity;
    
    for (const [city, center] of Object.entries(cityBoundaries)) {
        const distance = calculateDistance(lat, lng, center.lat, center.lng);
        if (distance < shortestDistance) {
            shortestDistance = distance;
            closestCity = city;
        }
    }
    
    return shortestDistance <= 100000 ? closestCity : "Unknown Location";
}

function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371e3;
    const 1 = lat1 * Math.PI / 180;
    const 2 = lat2 * Math.PI / 180;
    const  = (lat2 - lat1) * Math.PI / 180;
    const  = (lon2 - lon1) * Math.PI / 180;

    const a = Math.sin(/2) * Math.sin(/2) +
              Math.cos(1) * Math.cos(2) *
              Math.sin(/2) * Math.sin(/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

    return R * c;
}

// Enhanced pickup location update
function updatePickupLocation(lat, lng) {
    if (pickupMarker) {
        passengerMap.removeLayer(pickupMarker);
    }
    
    pickupMarker = L.marker([lat, lng], {
        icon: L.divIcon({
            className: 'pickup-marker-enhanced',
            html: '<div class="pickup-marker-enhanced"><i class="fas fa-map-marker-alt"></i></div>',
            iconSize: [24, 24]
        })
    }).addTo(passengerMap)
        .bindPopup('Pickup Location')
        .openPopup();
    
    getPreciseAddress(lat, lng, 'pickupLocation');
    
    // Make pickup location editable
    const pickupInput = document.getElementById('pickupLocation');
    pickupInput.removeAttribute('readonly');
    document.getElementById('clearPickupBtn').classList.remove('d-none');
    
    // Update fare estimate if destination exists
    const destination = document.getElementById('destinationLocation').value;
    if (destination) {
        updateFareEstimate();
    }
}

function getPreciseAddress(lat, lng, elementId) {
    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1&accept-language=en`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Geocoding error: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            const address = buildPreciseAddress(data);
            document.getElementById(elementId).value = address;
        })
        .catch(error => {
            console.error('Reverse geocoding error:', error);
            document.getElementById(elementId).value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        });
}

function buildPreciseAddress(data) {
    if (!data || !data.address) {
        return "";
    }
    
    const address = data.address;
    const parts = [];
    
    // Build address in format: House/Building  Road  Area  City
    if (address.house_number || address.housenumber) {
        parts.push(address.house_number || address.housenumber);
    }
    
    if (address.building) {
        parts.push(address.building);
    } else if (address.amenity) {
        parts.push(address.amenity);
    }
    
    if (address.road) {
        parts.push(address.road);
    }
    
    if (address.suburb) {
        parts.push(address.suburb);
    } else if (address.neighbourhood) {
        parts.push(address.neighbourhood);
    }
    
    if (address.city || address.town || address.village) {
        parts.push(address.city || address.town || address.village);
    }
    
    return parts.filter(part => part && part.trim().length > 0).join(', ');
}

// ULTRA-FAST CITY-LOCKED SEARCH - Enhanced Implementation
function searchPlacesEnhanced(query, searchType) {
    if (!query || query.trim().length < 2) {
        hideSearchSuggestions(searchType);
        return;
    }
    
    const cleanQuery = query.trim();
    
    // Debounce search
    if (searchDebounceTimer) {
        clearTimeout(searchDebounceTimer);
    }
    
    // Show loading indicator
    const suggestionsContainer = document.getElementById(`${searchType}Suggestions`);
    suggestionsContainer.innerHTML = '<div class="loading-text">Searching...</div>';
    suggestionsContainer.style.display = 'block';
    
    // Check cache first
    const cacheKey = `${currentCity}_${cleanQuery}_${searchType}`;
    const cachedData = searchCache.get(cacheKey);
    const cacheTime = searchCacheTimestamp.get(cacheKey);
    
    if (cachedData && cacheTime && (Date.now() - cacheTime) < SEARCH_CACHE_TTL) {
        console.log(" Using cached search results");
        displaySearchResults(cachedData, searchType);
        return;
    }
    
    searchDebounceTimer = setTimeout(() => {
        performEnhancedSearch(cleanQuery, searchType)
            .then(results => {
                // Cache results
                searchCache.set(cacheKey, results);
                searchCacheTimestamp.set(cacheKey, Date.now());
                
                if (results.length > 0) {
                    displaySearchResults(results, searchType);
                } else {
                    showNoResultsMessage(cleanQuery, searchType);
                }
            })
            .catch(error => {
                console.error('Search error:', error);
                showNoResultsMessage(cleanQuery, searchType);
            });
    }, 150); // Reduced debounce time for faster response
}

async function performEnhancedSearch(query, searchType) {
    console.log(` Performing enhanced search for: "${query}" in ${currentCity}`);
    
    // First, check if it's a common landmark
    const landmarkResults = searchCommonLandmarks(query);
    if (landmarkResults.length > 0) {
        return landmarkResults;
    }
    
    // Perform city-locked search
    try {
        const results = await performCityLockedSearch(query);
        return results;
    } catch (error) {
        console.error("City-locked search failed, trying fallback:", error);
        return await performFallbackSearch(query);
    }
}

function searchCommonLandmarks(query) {
    const lowerQuery = query.toLowerCase();
    const results = [];
    
    if (commonLandmarks[currentCity]) {
        commonLandmarks[currentCity].forEach(landmark => {
            if (landmark.toLowerCase().includes(lowerQuery)) {
                results.push({
                    display_name: landmark,
                    lat: cityBoundaries[currentCity]?.lat || -15.4167,
                    lon: cityBoundaries[currentCity]?.lng || 28.2833,
                    type: 'landmark',
                    importance: 0.9,
                    isCurrentCity: true,
                    city: currentCity,
                    distance: userLocation ? calculateDistance(
                        userLocation.lat, userLocation.lng,
                        cityBoundaries[currentCity]?.lat || -15.4167,
                        cityBoundaries[currentCity]?.lng || 28.2833
                    ) : 0
                });
            }
        });
    }
    
    return results.slice(0, 5); // Limit to 5 results
}

async function performCityLockedSearch(query) {
    if (!currentCity || currentCity === "Unknown Location") {
        throw new Error("No city detected");
    }
    
    const cityBoundary = cityBoundaries[currentCity];
    if (!cityBoundary) {
        throw new Error("City boundary not found");
    }
    
    // Build search query with city lock
    const searchQuery = `${query}, ${currentCity}, Zambia`;
    
    // Calculate bounding box for the city
    const bbox = calculateCityBoundingBox(cityBoundary);
    const bboxStr = `${bbox.minLng},${bbox.minLat},${bbox.maxLng},${bbox.maxLat}`;
    
    // Perform search with city bounding box
    const response = await fetch(
        `https://nominatim.openstreetmap.org/search?` +
        `format=json&` +
        `q=${encodeURIComponent(searchQuery)}&` +
        `limit=15&` +
        `dedupe=1&` +
        `countrycodes=zm&` +
        `bounded=1&` +
        `viewbox=${bboxStr}&` +
        `addressdetails=1`
    );
    
    if (!response.ok) {
        throw new Error(`Search API error: ${response.status}`);
    }
    
    const data = await response.json();
    
    if (!data || data.length === 0) {
        return [];
    }
    
    // Filter and enhance results
    const enhancedResults = data
        .filter(place => {
            // Strict city boundary filtering
            if (!cityBoundary) return true;
            
            const distance = calculateDistance(
                parseFloat(place.lat),
                parseFloat(place.lon),
                cityBoundary.lat,
                cityBoundary.lng
            );
            
            return distance <= cityBoundary.radius * 2; // Allow some buffer
        })
        .map(place => enhanceSearchResult(place))
        .sort((a, b) => {
            // Sort by relevance score, then distance
            if (b.relevanceScore !== a.relevanceScore) {
                return b.relevanceScore - a.relevanceScore;
            }
            return a.distance - b.distance;
        });
    
    return enhancedResults.slice(0, 10); // Limit to 10 results
}

function calculateCityBoundingBox(cityBoundary) {
    const radiusKm = cityBoundary.radius / 1000;
    const latDelta = (radiusKm / 111.32) * 1.5; // 50% buffer
    const lngDelta = (radiusKm / (111.32 * Math.cos(cityBoundary.lat * Math.PI / 180))) * 1.5;
    
    return {
        minLat: cityBoundary.lat - latDelta,
        maxLat: cityBoundary.lat + latDelta,
        minLng: cityBoundary.lng - lngDelta,
        maxLng: cityBoundary.lng + lngDelta
    };
}

function enhanceSearchResult(place) {
    const result = {
        ...place,
        displayLat: parseFloat(place.lat),
        displayLon: parseFloat(place.lon),
        distance: userLocation ? calculateDistance(
            userLocation.lat,
            userLocation.lng,
            parseFloat(place.lat),
            parseFloat(place.lon)
        ) : 0,
        city: extractCityFromPlace(place) || currentCity,
        isCurrentCity: extractCityFromPlace(place) === currentCity,
        placeType: getPlaceType(place),
        relevanceScore: calculateRelevanceScore(place, lastSearchQuery || ''),
        displayName: formatDisplayName(place.display_name, extractCityFromPlace(place) || currentCity)
    };
    
    return result;
}

function extractCityFromPlace(place) {
    if (place.address) {
        return extractCityFromAddress(place.address);
    }
    
    if (place.display_name) {
        return extractCityFromDisplayName(place.display_name);
    }
    
    return null;
}

function extractCityFromAddress(address) {
    const priorityFields = ['city', 'town', 'village', 'municipality'];
    
    for (const field of priorityFields) {
        if (address[field]) {
            const cityName = normalizeCityName(address[field]);
            if (zambianCities.includes(cityName)) {
                return cityName;
            }
        }
    }
    
    return null;
}

function extractCityFromDisplayName(displayName) {
    if (!displayName) return null;
    
    const lowerName = displayName.toLowerCase();
    
    // Check for exact city names
    for (const city of zambianCities) {
        if (lowerName.includes(city.toLowerCase())) {
            return city;
        }
    }
    
    // Check for city aliases
    for (const [alias, city] of Object.entries(cityAliases)) {
        if (lowerName.includes(alias)) {
            return city;
        }
    }
    
    return null;
}

function getPlaceType(place) {
    if (place.class && place.type) {
        const key = place.type.toLowerCase();
        if (placeTypes[key]) {
            return key;
        }
    }
    
    // Check address for specific types
    if (place.address) {
        if (place.address.shop) return 'shop';
        if (place.address.amenity) return place.address.amenity.toLowerCase();
        if (place.address.railway) return 'station';
    }
    
    return 'default';
}

function calculateRelevanceScore(place, query) {
    let score = 0;
    const placeName = (place.display_name || '').toLowerCase();
    const queryLower = query.toLowerCase();
    
    // Exact match boost
    if (placeName === queryLower) {
        score += 20;
    }
    
    // Contains query boost
    if (placeName.includes(queryLower)) {
        score += 15;
    }
    
    // Word match boost
    const queryWords = queryLower.split(' ');
    const placeWords = placeName.split(' ');
    
    queryWords.forEach(word => {
        if (word.length > 2 && placeName.includes(word)) {
            score += 5;
        }
    });
    
    // Current city boost
    if (place.city === currentCity) {
        score += 10;
    }
    
    // Importance boost (from OSM)
    if (place.importance) {
        score += place.importance * 10;
    }
    
    // Distance penalty
    if (place.distance && place.distance > 5000) {
        score -= Math.floor(place.distance / 1000); // -1 for every km beyond 5km
    }
    
    // Type boost for specific places
    if (place.type === 'yes' || place.class === 'place') {
        score -= 2; // Penalize generic places
    }
    
    return Math.max(0, score);
}

function formatDisplayName(fullName, city) {
    if (!fullName) return 'Unknown Location';
    
    // Remove city and country from the end to avoid duplication
    const parts = fullName.split(',');
    const relevantParts = [];
    
    for (let i = 0; i < parts.length; i++) {
        const part = parts[i].trim();
        const partLower = part.toLowerCase();
        
        // Stop when we reach city or country
        if (zambianCities.some(c => c.toLowerCase() === partLower) ||
            partLower === 'zambia' ||
            partLower.includes('province')) {
            break;
        }
        
        relevantParts.push(part);
    }
    
    const result = relevantParts.join(', ');
    return result || `${city}, Zambia`;
}

async function performFallbackSearch(query) {
    const searchQuery = `${query}, Zambia`;
    
    const response = await fetch(
        `https://nominatim.openstreetmap.org/search?` +
        `format=json&` +
        `q=${encodeURIComponent(searchQuery)}&` +
        `limit=10&` +
        `dedupe=1&` +
        `countrycodes=zm`
    );
    
    if (!response.ok) {
        throw new Error(`Fallback search error: ${response.status}`);
    }
    
    const data = await response.json();
    
    if (!data || data.length === 0) {
        return [];
    }
    
    return data
        .filter(place => place.display_name && place.lat && place.lon)
        .map(place => enhanceSearchResult(place))
        .sort((a, b) => b.relevanceScore - a.relevanceScore)
        .slice(0, 10);
}

// Enhanced search results display
function displaySearchResults(results, searchType) {
    const suggestionsContainer = document.getElementById(`${searchType}Suggestions`);
    
    if (!suggestionsContainer) {
        console.error("Suggestions container not found for:", searchType);
        return;
    }
    
    suggestionsContainer.innerHTML = '';
    
    // Update search results cache
    updateSearchResultsCache(results, searchType);
    
    if (results.length === 0) {
        showNoResultsMessage('', searchType);
        return;
    }
    
    // Remove duplicates and limit results
    const uniqueResults = removeDuplicatePlaces(results).slice(0, 8);
    
    uniqueResults.forEach((result, index) => {
        const suggestionItem = createSuggestionItem(result, index, searchType);
        suggestionsContainer.appendChild(suggestionItem);
    });
    
    suggestionsContainer.style.display = 'block';
    
    // Add click outside listener
    setTimeout(() => {
        document.addEventListener('click', handleClickOutsideSuggestions.bind(null, searchType), { once: true });
    }, 10);
}

function createSuggestionItem(result, index, searchType) {
    const suggestionItem = document.createElement('div');
    suggestionItem.className = 'suggestion-item';
    if (index === 0) suggestionItem.classList.add('first-result');
    
    const placeType = result.placeType || 'default';
    const placeIcon = placeTypes[placeType]?.icon || '';
    
    // Build city badge if not current city
    let cityBadge = '';
    if (result.city && result.city !== currentCity) {
        cityBadge = `<span class="city-badge">${result.city}</span>`;
    }
    
    // Build distance text
    let distanceText = '';
    if (result.distance > 0) {
        if (result.distance < 1000) {
            distanceText = `${Math.round(result.distance)} m away`;
        } else {
            distanceText = `${(result.distance / 1000).toFixed(1)} km away`;
        }
    }
    
    // Build display HTML
    suggestionItem.innerHTML = `
        <div class="suggestion-icon">${placeIcon}</div>
        <div class="suggestion-details">
            <div class="suggestion-name">
                ${result.displayName || result.display_name}
                ${cityBadge}
            </div>
            <div class="suggestion-address">${getShortAddress(result.display_name)}</div>
            ${distanceText ? `<div class="suggestion-distance">${distanceText}</div>` : ''}
        </div>
        ${result.isCurrentCity ? '<div class="current-city-indicator"> Current City</div>' : ''}
    `;
    
    // Add click handler
    suggestionItem.addEventListener('click', function(e) {
        e.stopPropagation();
        handleSearchResultSelection(result, searchType);
    });
    
    return suggestionItem;
}

function getShortAddress(fullAddress) {
    if (!fullAddress) return '';
    
    const parts = fullAddress.split(',');
    const relevantParts = parts.slice(0, 2); // First two parts only
    return relevantParts.join(',');
}

function removeDuplicatePlaces(places) {
    const seen = new Set();
    return places.filter(place => {
        const coordKey = `${place.lat}-${place.lon}`;
        const nameKey = (place.display_name || '').substring(0, 50).toLowerCase();
        const uniqueKey = `${coordKey}-${nameKey}`;
        
        if (seen.has(uniqueKey)) {
            return false;
        }
        seen.add(uniqueKey);
        return true;
    });
}

function updateSearchResultsCache(results, searchType) {
    switch(searchType) {
        case 'destination': 
            destinationSearchResults = results;
            break;
        case 'pickup':
            pickupSearchResults = results;
            break;
        case 'recipientPickup':
            recipientPickupSearchResults = results;
            break;
        case 'recipientDestination':
            destinationSearchResults = results;
            break;
        case 'shopLocation':
            shopLocationSearchResults = results;
            break;
        case 'deliveryDestination':
            deliveryDestinationSearchResults = results;
            break;
        case 'schedulePickup':
            schedulePickupSearchResults = results;
            break;
        case 'scheduleDestination':
            scheduleDestinationSearchResults = results;
            break;
        case 'scheduleShop':
            scheduleShopSearchResults = results;
            break;
        case 'scheduleDeliveryDest':
            scheduleDeliveryDestSearchResults = results;
            break;
        case 'scheduleRecipientPickup':
            scheduleRecipientPickupSearchResults = results;
            break;
        case 'scheduleRecipientDest':
            scheduleRecipientDestSearchResults = results;
            break;
    }
    
    activeSearchResults = results;
}

function handleClickOutsideSuggestions(searchType) {
    const suggestionsContainer = document.getElementById(`${searchType}Suggestions`);
    if (suggestionsContainer && suggestionsContainer.style.display !== 'none') {
        hideSearchSuggestions(searchType);
    }
}

function showNoResultsMessage(query, searchType) {
    const suggestionsContainer = document.getElementById(`${searchType}Suggestions`);
    
    if (suggestionsContainer) {
        let message = 'No places found';
        if (currentCity && (searchType === 'pickup' || searchType === 'destination')) {
            message += ` in ${currentCity}`;
        }
        suggestionsContainer.innerHTML = `<div class="no-places">${message}</div>`;
    }
}

// Enhanced search result selection
function handleSearchResultSelection(result, searchType) {
    const inputField = getInputFieldForSearchType(searchType);
    
    if (inputField) {
        inputField.value = result.display_name;
        inputField.focus();
    }
    
    hideSearchSuggestions(searchType);
    
    // Handle different search types
    switch(searchType) {
        case 'destination':
            handleDestinationSelection(result);
            break;
            
        case 'pickup':
            handlePickupSelection(result);
            break;
            
        case 'recipientPickup':
            handleRecipientPickupSelection(result);
            break;
            
        case 'recipientDestination':
            handleRecipientDestinationSelection(result);
            break;
            
        case 'shopLocation':
            handleShopLocationSelection(result);
            break;
            
        case 'deliveryDestination':
            handleDeliveryDestinationSelection(result);
            break;
            
        // Schedule search types
        case 'schedulePickup':
        case 'scheduleDestination':
        case 'scheduleShop':
        case 'scheduleDeliveryDest':
        case 'scheduleRecipientPickup':
        case 'scheduleRecipientDest':
            handleScheduleSelection(result, searchType);
            break;
    }
    
    showNotification(`Location set: ${result.display_name}`);
}

function getInputFieldForSearchType(searchType) {
    const fieldMap = {
        'destination': 'destinationLocation',
        'pickup': 'pickupLocation',
        'recipientPickup': 'recipientPickupLocation',
        'recipientDestination': 'recipientDestinationLocation',
        'shopLocation': 'shopLocation',
        'deliveryDestination': 'deliveryDestination',
        'schedulePickup': 'schedulePickupLocation',
        'scheduleDestination': 'scheduleDestination',
        'scheduleShop': 'scheduleShopLocation',
        'scheduleDeliveryDest': 'scheduleDeliveryDestination',
        'scheduleRecipientPickup': 'scheduleRecipientPickup',
        'scheduleRecipientDest': 'scheduleRecipientDestination'
    };
    
    const fieldId = fieldMap[searchType];
    return fieldId ? document.getElementById(fieldId) : null;
}

function handleDestinationSelection(result) {
    updateFareEstimate();
    updateDestinationMarker(
        result.displayLat, 
        result.displayLon, 
        result.display_name
    );
    
    if (userLocation) {
        drawRoute(userLocation.lat, userLocation.lng, result.displayLat, result.displayLon);
    }
    
    selectedDestination = result;
    document.getElementById('requestRideBtn').disabled = false;
}

function handlePickupSelection(result) {
    updateManualPickupLocation(result.displayLat, result.displayLon, result.display_name);
}

function handleRecipientPickupSelection(result) {
    calculateRecipientDeliveryFee();
    updateRecipientPickupMarker(result.displayLat, result.displayLon, result.display_name);
}

function handleRecipientDestinationSelection(result) {
    calculateRecipientDeliveryFee();
    updateRecipientDestinationMarker(result.displayLat, result.displayLon, result.display_name);
}

function handleShopLocationSelection(result) {
    calculateExpressDeliveryFee();
    updateShopLocationMarker(result.displayLat, result.displayLon, result.display_name);
}

function handleDeliveryDestinationSelection(result) {
    calculateExpressDeliveryFee();
    updateDeliveryDestinationMarker(result.displayLat, result.displayLon, result.display_name);
}

function handleScheduleSelection(result, searchType) {
    // Update the corresponding schedule form field
    const inputField = getInputFieldForSearchType(searchType);
    if (inputField) {
        inputField.value = result.display_name;
    }
    
    // Calculate schedule fare if both pickup and destination are set
    calculateScheduleFare();
}

function updateManualPickupLocation(lat, lng, name) {
    if (currentLocationMarker) {
        passengerMap.removeLayer(currentLocationMarker);
        currentLocationMarker = null;
    }
    
    if (pickupMarker) {
        passengerMap.removeLayer(pickupMarker);
    }
    
    pickupMarker = L.marker([lat, lng], {
        icon: L.divIcon({
            className: 'pickup-marker-enhanced',
            html: '<div class="pickup-marker-enhanced"><i class="fas fa-map-marker-alt"></i></div>',
            iconSize: [24, 24]
        })
    }).addTo(passengerMap)
        .bindPopup(`<strong>${name}</strong><br>Pickup Location`)
        .openPopup();
    
    userLocation = { lat, lng };
    
    const destination = document.getElementById('destinationLocation').value;
    if (destination) {
        updateFareEstimate();
        
        forwardGeocode(destination).then(results => {
            if (results.length > 0) {
                const destLat = parseFloat(results[0].lat);
                const destLng = parseFloat(results[0].lon);
                drawRoute(lat, lng, destLat, destLng);
            }
        });
    }
    
    passengerMap.setView([lat, lng], 16);
}

function updateDestinationMarker(lat, lng, name) {
    if (destinationMarker) {
        passengerMap.removeLayer(destinationMarker);
    }
    
    destinationMarker = L.marker([lat, lng], {
        icon: L.divIcon({
            className: 'destination-marker-enhanced',
            html: '<div class="destination-marker-enhanced"><i class="fas fa-flag"></i></div>',
            iconSize: [24, 24]
        })
    }).addTo(passengerMap)
        .bindPopup(`<strong>${name}</strong><br>Your destination`)
        .openPopup();
    
    if (userLocation) {
        const bounds = L.latLngBounds(
            [userLocation.lat, userLocation.lng],
            [lat, lng]
        );
        passengerMap.fitBounds(bounds, { padding: [50, 50] });
    }
}

function drawRoute(startLat, startLng, endLat, endLng) {
    if (routePolyline) {
        passengerMap.removeLayer(routePolyline);
    }
    
    // Use OSRM for routing
    fetch(`https://router.project-osrm.org/route/v1/driving/${startLng},${startLat};${endLng},${endLat}?overview=full&geometries=geojson`)
        .then(response => response.json())
        .then(data => {
            if (data.routes && data.routes.length > 0) {
                const route = data.routes[0];
                const routeCoordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                
                routePolyline = L.polyline(routeCoordinates, {
                    color: '#FF6B35',
                    weight: 4,
                    opacity: 0.8,
                    dashArray: '5, 10',
                    lineCap: 'round'
                }).addTo(passengerMap);
                
                // Fit bounds to show entire route
                passengerMap.fitBounds(routePolyline.getBounds(), { 
                    padding: [50, 50],
                    maxZoom: 16
                });
            }
        })
        .catch(error => {
            console.error('Error fetching route:', error);
            // Fallback: draw straight line
            routePolyline = L.polyline([
                [startLat, startLng],
                [endLat, endLng]
            ], {
                color: '#FF6B35',
                weight: 4,
                opacity: 0.8,
                dashArray: '5, 10'
            }).addTo(passengerMap);
        });
}

// Enhanced fare estimation
function updateFareEstimate() {
    const destination = document.getElementById('destinationLocation').value;
    
    if (!destination || destination.length < 3 || !userLocation) {
        resetFareEstimate();
        return;
    }
    
    forwardGeocode(destination).then(results => {
        if (results.length > 0) {
            const destLat = parseFloat(results[0].lat);
            const destLng = parseFloat(results[0].lon);
            
            const distance = calculateDistance(
                userLocation.lat, userLocation.lng,
                destLat, destLng
            );
            
            const fare = calculateFare(distance, selectedVehicleType);
            const eta = calculateETA(distance);
            
            updateFareDisplay(fare, eta);
            rideFare = fare;
        } else {
            resetFareEstimate();
        }
    }).catch(error => {
        console.error('Error calculating fare:', error);
        resetFareEstimate();
    });
}

function calculateFare(distance, vehicleType) {
    let baseFare = 23; // Base fare in Kwacha
    
    // Distance calculation (increment every 90 meters)
    if (distance > 0) {
        baseFare += Math.ceil(distance / 90);
    }
    
    // Vehicle type multiplier
    switch(vehicleType) {
        case 'car':
            baseFare = baseFare * 1.0;
            break;
        case 'bike':
            baseFare = baseFare * 0.7;
            break;
        case 'bicycle':
            baseFare = baseFare * 0.5;
            break;
    }
    
    // Apply promo code discount
    if (appliedPromoCode) {
        baseFare = baseFare * 0.8; // 20% discount
    }
    
    // Minimum fare
    baseFare = Math.max(baseFare, 15);
    
    // Round to nearest whole number
    return Math.ceil(baseFare);
}

function calculateETA(distance) {
    // Calculate ETA based on distance
    // Assuming average speed of 30 km/h in urban areas
    const speedKmPerHour = 30;
    const distanceKm = distance / 1000;
    const hours = distanceKm / speedKmPerHour;
    const minutes = Math.ceil(hours * 60);
    
    // Minimum ETA of 5 minutes, maximum of 120 minutes
    return Math.min(Math.max(minutes, 5), 120);
}

function updateFareDisplay(fare, etaMinutes) {
    document.getElementById('estimatedFare').textContent = `K${fare.toFixed(2)}`;
    document.getElementById('etaDisplay').textContent = `ETA: ${etaMinutes} min`;
    document.getElementById('requestRideBtn').disabled = false;
    
    // Add animation
    const fareElement = document.getElementById('estimatedFare');
    fareElement.style.transform = 'scale(1.1)';
    setTimeout(() => {
        fareElement.style.transform = 'scale(1)';
    }, 300);
}

function resetFareEstimate() {
    document.getElementById('estimatedFare').textContent = 'K0.00';
    document.getElementById('etaDisplay').textContent = 'ETA: -- min';
    document.getElementById('requestRideBtn').disabled = true;
    rideFare = 0;
}

// Enhanced forward geocoding
function forwardGeocode(query) {
    return new Promise((resolve, reject) => {
        if (!query || query.trim().length < 2) {
            resolve([]);
            return;
        }
        
        const searchQuery = `${query}, Zambia`;
        
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&limit=5&countrycodes=zm`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Geocoding error: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data && data.length > 0) {
                    // Filter by current city if available
                    if (currentCity && currentCity !== "Unknown Location") {
                        const filteredResults = data.filter(result => {
                            const city = extractCityFromPlace(result);
                            return city === currentCity;
                        });
                        resolve(filteredResults.length > 0 ? filteredResults : data);
                    } else {
                        resolve(data);
                    }
                } else {
                    resolve([]);
                }
            })
            .catch(error => {
                console.error('Forward geocoding error:', error);
                resolve([]);
            });
    });
}

// Enhanced search input setup
function setupSearchInputListeners() {
    // Setup all search inputs
    const searchConfigs = [
        { type: 'destination', inputId: 'destinationLocation', suggestionsId: 'destinationSuggestions' },
        { type: 'pickup', inputId: 'pickupLocation', suggestionsId: 'pickupSuggestions' },
        { type: 'recipientPickup', inputId: 'recipientPickupLocation', suggestionsId: 'recipientPickupSuggestions' },
        { type: 'recipientDestination', inputId: 'recipientDestinationLocation', suggestionsId: 'recipientDestinationSuggestions' },
        { type: 'shopLocation', inputId: 'shopLocation', suggestionsId: 'shopLocationSuggestions' },
        { type: 'deliveryDestination', inputId: 'deliveryDestination', suggestionsId: 'deliveryDestinationSuggestions' },
        { type: 'schedulePickup', inputId: 'schedulePickupLocation', suggestionsId: 'schedulePickupSuggestions' },
        { type: 'scheduleDestination', inputId: 'scheduleDestination', suggestionsId: 'scheduleDestinationSuggestions' },
        { type: 'scheduleShop', inputId: 'scheduleShopLocation', suggestionsId: 'scheduleShopSuggestions' },
        { type: 'scheduleDeliveryDest', inputId: 'scheduleDeliveryDestination', suggestionsId: 'scheduleDeliveryDestSuggestions' },
        { type: 'scheduleRecipientPickup', inputId: 'scheduleRecipientPickup', suggestionsId: 'scheduleRecipientPickupSuggestions' },
        { type: 'scheduleRecipientDest', inputId: 'scheduleRecipientDestination', suggestionsId: 'scheduleRecipientDestSuggestions' }
    ];
    
    searchConfigs.forEach(config => {
        setupSearchInputListener(config.type, config.inputId, config.suggestionsId);
    });
}

function setupSearchInputListener(searchType, inputId, suggestionsId) {
    const inputField = document.getElementById(inputId);
    if (!inputField) return;
    
    let debounceTimer;
    
    inputField.addEventListener('input', function() {
        const query = this.value.trim();
        
        if (debounceTimer) {
            clearTimeout(debounceTimer);
        }
        
        if (query.length >= 2) {
            // Show loading immediately
            const suggestionsContainer = document.getElementById(suggestionsId);
            if (suggestionsContainer) {
                suggestionsContainer.innerHTML = '<div class="loading-text">Searching...</div>';
                suggestionsContainer.style.display = 'block';
            }
            
            debounceTimer = setTimeout(() => {
                lastSearchQuery = query;
                searchPlacesEnhanced(query, searchType);
            }, 200);
        } else if (query.length === 0) {
            hideSearchSuggestions(searchType);
        } else {
            hideSearchSuggestions(searchType);
        }
    });
    
    inputField.addEventListener('focus', function() {
        const query = this.value.trim();
        const cachedResults = getCachedSearchResults(searchType);
        
        if (query.length >= 2 && cachedResults.length > 0) {
            displaySearchResults(cachedResults, searchType);
        } else if (query.length >= 2) {
            searchPlacesEnhanced(query, searchType);
        }
    });
    
    inputField.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            hideSearchSuggestions(searchType);
        } else if (e.key === 'Enter') {
            e.preventDefault();
            hideSearchSuggestions(searchType);
            const cachedResults = getCachedSearchResults(searchType);
            if (cachedResults.length > 0) {
                handleSearchResultSelection(cachedResults[0], searchType);
            }
        }
    });
    
    // Add focus/blur styling
    inputField.addEventListener('focus', function() {
        this.parentElement.classList.add('active');
    });
    
    inputField.addEventListener('blur', function() {
        setTimeout(() => {
            this.parentElement.classList.remove('active');
        }, 200);
    });
}

function getCachedSearchResults(searchType) {
    switch(searchType) {
        case 'destination': return destinationSearchResults;
        case 'pickup': return pickupSearchResults;
        case 'recipientPickup': return recipientPickupSearchResults;
        case 'recipientDestination': return destinationSearchResults;
        case 'shopLocation': return shopLocationSearchResults;
        case 'deliveryDestination': return deliveryDestinationSearchResults;
        case 'schedulePickup': return schedulePickupSearchResults;
        case 'scheduleDestination': return scheduleDestinationSearchResults;
        case 'scheduleShop': return scheduleShopSearchResults;
        case 'scheduleDeliveryDest': return scheduleDeliveryDestSearchResults;
        case 'scheduleRecipientPickup': return scheduleRecipientPickupSearchResults;
        case 'scheduleRecipientDest': return scheduleRecipientDestSearchResults;
        default: return [];
    }
}

function hideSearchSuggestions(searchType) {
    const suggestionsContainer = document.getElementById(`${searchType}Suggestions`);
    if (suggestionsContainer) {
        suggestionsContainer.style.display = 'none';
    }
}

// Enhanced ride request
function requestRide() {
    const pickupLocation = document.getElementById('pickupLocation').value;
    const destinationLocation = document.getElementById('destinationLocation').value;
    
    if (!destinationLocation) {
        showNotification('Please enter a destination');
        return;
    }
    
    if (!pickupLocation) {
        showNotification('Please enter a pickup location');
        return;
    }
    
    showLoading("Calculating route...");
    
    // Get package details if enabled
    if (document.getElementById('packageForm').classList.contains('active')) {
        packageDetails = {
            receiverName: document.getElementById('receiverName').value,
            receiverPhone: document.getElementById('receiverPhone').value,
            packageDescription: document.getElementById('packageDescription').value,
            specialInstructions: document.getElementById('specialInstructions').value,
            packageValue: document.getElementById('packageValue').value
        };
    } else {
        packageDetails = null;
    }
    
    Promise.all([
        forwardGeocode(pickupLocation),
        forwardGeocode(destinationLocation)
    ]).then(([pickupResults, destinationResults]) => {
        if (pickupResults.length === 0 || destinationResults.length === 0) {
            hideLoading();
            showNotification('Invalid pickup or destination address. Please select valid locations.');
            return;
        }
        
        const pickupLat = parseFloat(pickupResults[0].lat);
        const pickupLng = parseFloat(pickupResults[0].lon);
        const destLat = parseFloat(destinationResults[0].lat);
        const destLng = parseFloat(destinationResults[0].lon);
        
        const distance = calculateDistance(pickupLat, pickupLng, destLat, destLng);
        const fare = calculateFare(distance, selectedVehicleType);
        
        const rideId = database.ref().child('rides').push().key;
        
        const rideRequest = {
            id: rideId,
            passengerId: currentUser.uid,
            passengerName: userData.name || 'Passenger',
            passengerPhone: userData.phone || 'Not provided',
            pickupLocation: pickupResults[0].display_name,
            pickupDisplayLocation: pickupLocation,
            destination: destinationResults[0].display_name,
            pickupLat: pickupLat,
            pickupLng: pickupLng,
            destLat: destLat,
            destLng: destLng,
            rideType: selectedVehicleType,
            fare: fare,
            distance: (distance / 1000).toFixed(2) + ' km',
            status: 'requested',
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            updatedAt: firebase.database.ServerValue.TIMESTAMP,
            promoCode: appliedPromoCode,
            paymentMethod: selectedPaymentType,
            packageDetails: packageDetails,
            currentCity: currentCity
        };
    
        currentRideRequestData = rideRequest;
        currentRideRequestType = 'standard';
        
        hideLoading();
        showPaymentSelection(fare);
        
    }).catch(error => {
        console.error('Error in ride request process:', error);
        hideLoading();
        showNotification('Error calculating route. Please try again.');
    });
}

// Enhanced payment selection
function showPaymentSelection(fare = null) {
    const calculatedFare = fare || rideFare;
    
    document.getElementById('paymentWalletBalance').textContent = `Balance: K${walletBalance.toFixed(2)}`;
    
    if (walletBalance < calculatedFare && selectedPaymentType === 'wallet') {
        document.getElementById('insufficientBalance').style.display = 'block';
        document.getElementById('confirmPaymentBtn').disabled = true;
    } else {
        document.getElementById('insufficientBalance').style.display = 'none';
        document.getElementById('confirmPaymentBtn').disabled = false;
    }
    
    document.getElementById('paymentSelectionPopup').classList.remove('hidden');
}

function closePaymentSelection() {
    document.getElementById('paymentSelectionPopup').classList.add('hidden');
}

function submitRideRequest() {
    if (!currentRideRequestData) {
        showNotification('No ride request data found. Please try again.');
        return;
    }
    
    const rideRequest = currentRideRequestData;
    
    if (selectedPaymentType === 'wallet' && walletBalance < rideRequest.fare) {
        showNotification('Insufficient wallet balance. Please add funds or choose another payment method.');
        return;
    }
    
    showLoading("Requesting ride...");
    
    const processRequest = () => {
        return database.ref('rides/' + rideRequest.id).set(rideRequest)
            .then(() => {
                currentRide = rideRequest;
                closePaymentSelection();
                updateUIForActiveRide();
                
                document.getElementById('searchingAnimation').style.display = 'flex';
                document.getElementById('rideStatus').style.display = 'flex';
                document.getElementById('statusDot').className = 'status-dot searching';
                document.getElementById('statusText').textContent = 'Searching for driver';
                
                if (sosConfig && sosConfig.contact1) {
                    document.getElementById('sosButton').style.display = 'flex';
                }
                
                showNotification('Ride requested. Searching for a driver... ');
                listenForDriverAssignment(rideRequest.id);
                
                hideLoading();
            })
            .catch(error => {
                console.error('Error requesting ride:', error);
                hideLoading();
                showNotification('Error requesting ride. Please try again.');
            });
    };
    
    if (selectedPaymentType === 'wallet') {
        const newBalance = walletBalance - rideRequest.fare;
        
        database.ref('users/' + currentUser.uid).update({
            walletBalance: newBalance
        })
        .then(() => {
            walletBalance = newBalance;
            updateWalletBalanceUI();
            return processRequest();
        })
        .catch(error => {
            console.error('Error updating wallet:', error);
            hideLoading();
            showNotification('Error processing payment. Please try again.');
        });
    } else {
        processRequest();
    }
    
    currentRideRequestData = null;
}

// Enhanced UI update for active ride
function updateUIForActiveRide() {
    document.getElementById('rideRequestForm').style.display = 'none';
    document.getElementById('rideInfoPanel').style.display = 'block';
    
    document.getElementById('currentPickupLocation').textContent = currentRide.pickupDisplayLocation || currentRide.pickupLocation;
    document.getElementById('currentDestinationLocation').textContent = currentRide.destination;
    
    const baseFare = currentRide.fare;
    const discount = appliedPromoCode ? baseFare * 0.2 : 0;
    const totalFare = baseFare - discount;
    
    document.getElementById('baseFare').textContent = `K${baseFare.toFixed(2)}`;
    document.getElementById('discountFare').textContent = `-K${discount.toFixed(2)}`;
    document.getElementById('totalFare').textContent = `K${totalFare.toFixed(2)}`;
    
    // Add share and tracking buttons
    addShareAndTrackingButtons();
}

function addShareAndTrackingButtons() {
    const rideActions = document.querySelector('.ride-actions');
    if (!rideActions) return;
    
    // Remove existing buttons if any
    const existingShareBtn = document.getElementById('shareRideBtn');
    const existingTrackingBtn = document.getElementById('shareTrackingBtn');
    if (existingShareBtn) existingShareBtn.remove();
    if (existingTrackingBtn) existingTrackingBtn.remove();
    
    // Add share ride details button
    const shareBtn = document.createElement('button');
    shareBtn.id = 'shareRideBtn';
    shareBtn.className = 'btn btn-primary';
    shareBtn.innerHTML = '<i class="fas fa-share-alt"></i> Share Ride';
    shareBtn.addEventListener('click', shareRideDetails);
    rideActions.appendChild(shareBtn);
    
    // Add share tracking button for deliveries
    if (currentRide.orderForSomeone || currentRide.expressDelivery || currentRide.packageDetails) {
        const trackingBtn = document.createElement('button');
        trackingBtn.id = 'shareTrackingBtn';
        trackingBtn.className = 'btn btn-secondary';
        trackingBtn.innerHTML = '<i class="fas fa-map-marker-alt"></i> Share Tracking';
        trackingBtn.addEventListener('click', shareLiveTracking);
        rideActions.appendChild(trackingBtn);
    }
}

// Enhanced driver assignment listening
function listenForDriverAssignment(rideId) {
    if (driverAssignmentListener) {
        driverAssignmentListener();
    }
    
    driverAssignmentListener = database.ref('rides/' + rideId).on('value', snapshot => {
        const ride = snapshot.val();
        if (!ride) {
            showNotification('Ride not found. Please try again.');
            return;
        }
        
        console.log('Ride status update:', ride.status, ride.driverId);
        
        switch(ride.status) {
            case 'accepted':
                handleDriverAssignment(ride);
                break;
            case 'completed':
                showRideCompletion(ride);
                break;
            case 'cancelled':
                handleRideCancellation(ride);
                break;
            case 'arrived':
                showNotification('Your driver has arrived at the pickup location. ');
                break;
            case 'picked_up':
                showNotification('You have been picked up. Enjoy your ride! ');
                break;
            case 'started':
                showNotification('Your trip has started. ');
                break;
        }
    }, error => {
        console.error('Error listening for driver assignment:', error);
        showNotification('Connection error. Please check your internet connection.');
    });
}

// Enhanced driver assignment handling
function handleDriverAssignment(ride) {
    document.getElementById('searchingAnimation').style.display = 'none';
    
    document.getElementById('statusDot').className = 'status-dot arriving';
    document.getElementById('statusText').textContent = 'Driver arriving';
    document.getElementById('estimatedTime').style.display = 'flex';
    document.getElementById('timeText').textContent = '5 min';
    
    database.ref('users/' + ride.driverId).once('value')
        .then(driverSnapshot => {
            const driver = driverSnapshot.val();
            if (driver) {
                updateDriverUI(driver, ride);
                updateDriverMarker(ride);
                drawDriverRoute(ride);
                trackDriverLocation(ride.driverId);
                startDriverMessageListener(ride.id);
                
                showNotification(`Driver ${driver.name} is on the way! `);
            }
        })
        .catch(error => {
            console.error('Error loading driver data:', error);
        });
    
    listenForRideStatusUpdates(ride.id);
}

function updateDriverUI(driver, ride) {
    document.getElementById('driverName').textContent = driver.name || 'Driver';
    document.getElementById('driverPhone').textContent = driver.phone || 'N/A';
    document.getElementById('driverRating').textContent = driver.rating || '4.5 ';
    
    if (driver.vehicle) {
        document.getElementById('vehicleDetails').textContent = 
            `${driver.vehicle.type || 'Vehicle'} - ${driver.vehicle.licensePlate || 'ABC123'}`;
    }
    
    // Update enhanced driver details
    updateDriverAvatarWithImage(driver, ride);
    updateDriverDetailsCard(driver);
    addChatWithDriverButton(ride.id, driver);
}

function updateDriverMarker(ride) {
    if (driverMarker) {
        passengerMap.removeLayer(driverMarker);
    }
    
    if (ride.driverLat && ride.driverLng) {
        driverMarker = L.marker([ride.driverLat, ride.driverLng], {
            icon: L.divIcon({
                className: 'driver-marker-enhanced',
                html: '<div class="driver-marker-enhanced"><i class="fas fa-car"></i></div>',
                iconSize: [32, 32]
            })
        }).addTo(passengerMap)
            .bindPopup(`Driver: ${ride.driverName || 'Driver'}`);
    }
}

function drawDriverRoute(ride) {
    if (ride.driverLat && ride.driverLng && ride.pickupLat && ride.pickupLng) {
        fetch(`https://router.project-osrm.org/route/v1/driving/${ride.driverLng},${ride.driverLat};${ride.pickupLng},${ride.pickupLat}?overview=full&geometries=geojson`)
            .then(response => response.json())
            .then(data => {
                if (data.routes && data.routes.length > 0) {
                    const route = data.routes[0];
                    const routeCoordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                    
                    L.polyline(routeCoordinates, {
                        color: '#3498db',
                        weight: 3,
                        opacity: 0.7,
                        dashArray: '10, 10'
                    }).addTo(passengerMap);
                }
            })
            .catch(error => {
                console.error('Error drawing driver route:', error);
            });
    }
}

// Enhanced ride status updates
function listenForRideStatusUpdates(rideId) {
    database.ref('rides/' + rideId).on('value', snapshot => {
        const ride = snapshot.val();
        if (ride) {
            currentRide = ride;
            
            switch(ride.status) {
                case 'accepted':
                    document.getElementById('statusText').textContent = 'Driver on the way';
                    break;
                case 'arrived':
                    document.getElementById('statusText').textContent = 'Driver arrived';
                    document.getElementById('statusDot').className = 'status-dot riding';
                    break;
                case 'started':
                    document.getElementById('statusText').textContent = 'Trip in progress';
                    addDestinationMarker(ride.destLat, ride.destLng);
                    drawRoute(ride.pickupLat, ride.pickupLng, ride.destLat, ride.destLng);
                    break;
                case 'completed':
                    handleRideCompletion(ride);
                    break;
                case 'cancelled':
                    handleRideCancellation(ride);
                    break;
            }
        }
    });
}

function handleRideCompletion(ride) {
    document.getElementById('statusText').textContent = 'Trip completed';
    document.getElementById('rideStatus').style.display = 'none';
    document.getElementById('estimatedTime').style.display = 'none';
    document.getElementById('sosButton').style.display = 'none';
    resetUIAfterRide();
    
    showRatingPopup(ride);
    showNotification('Trip completed. Thank you for using Jubel! ');
}

function handleRideCancellation(ride) {
    document.getElementById('searchingAnimation').style.display = 'none';
    document.getElementById('rideStatus').style.display = 'none';
    document.getElementById('estimatedTime').style.display = 'none';
    document.getElementById('sosButton').style.display = 'none';
    resetUIAfterRide();
    currentRide = null;
    
    cleanupRideResources(ride);
    showNotification('Ride has been cancelled.');
}

function cleanupRideResources(ride) {
    if (driverMarker) {
        passengerMap.removeLayer(driverMarker);
        driverMarker = null;
    }
    
    if (driverAssignmentListener) {
        driverAssignmentListener();
        driverAssignmentListener = null;
    }
    
    if (driverLocationListener) {
        driverLocationListener();
        driverLocationListener = null;
    }
    
    if (driverMessageListener) {
        driverMessageListener();
        driverMessageListener = null;
    }
}

// Enhanced ride history loading
function loadRideHistory() {
    if (!currentUser) return;
    
    const filter = document.getElementById('historyFilter').value;
    const dateFilter = document.getElementById('historyDate').value;
    
    if (rideHistoryListener) {
        rideHistoryListener();
    }
    
    const historyList = document.getElementById('historyList');
    historyList.innerHTML = '<div class="loading-text"><i class="fas fa-spinner fa-spin"></i> Loading ride history...</div>';
    
    rideHistoryListener = database.ref('rides').orderByChild('passengerId').equalTo(currentUser.uid).on('value', snapshot => {
        const rides = snapshot.val();
        historyList.innerHTML = '';
        
        if (rides) {
            let ridesArray = Object.keys(rides).map(rideId => ({
                id: rideId,
                ...rides[rideId]
            }));
            
            // Apply filters
            if (filter !== 'all') {
                ridesArray = ridesArray.filter(ride => ride.status === filter);
            }
            
            if (dateFilter) {
                const filterDate = new Date(dateFilter);
                ridesArray = ridesArray.filter(ride => {
                    const rideDate = new Date(ride.timestamp);
                    return rideDate.toDateString() === filterDate.toDateString();
                });
            }
            
            // Sort by timestamp (newest first)
            ridesArray.sort((a, b) => b.timestamp - a.timestamp);
            
            if (ridesArray.length === 0) {
                historyList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-history"></i>
                        </div>
                        <div class="empty-state-title">No rides found</div>
                        <div class="empty-state-description">No rides match your filter criteria</div>
                    </div>
                `;
                return;
            }
            
            // Display rides
            ridesArray.forEach(ride => {
                const historyItem = createHistoryItem(ride);
                historyList.appendChild(historyItem);
            });
        } else {
            historyList.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-history"></i>
                    </div>
                    <div class="empty-state-title">No ride history</div>
                    <div class="empty-state-description">Your ride history will appear here</div>
                </div>
            `;
        }
    }, error => {
        console.error('Error loading ride history:', error);
        historyList.innerHTML = '<div class="error-text">Error loading ride history. Please try again.</div>';
    });
}

function createHistoryItem(ride) {
    const historyItem = document.createElement('div');
    historyItem.className = 'history-item';
    historyItem.setAttribute('data-ride-id', ride.id);
    
    const date = new Date(ride.timestamp);
    const formattedDate = date.toLocaleDateString();
    const formattedTime = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    const isDelivery = ride.rideType === 'bike' || ride.rideType === 'bicycle';
    const typeClass = isDelivery ? 'delivery' : 'ride';
    const typeText = isDelivery ? 'Delivery' : 'Ride';
    
    let statusClass = 'status-requested';
    let statusText = getStatusText(ride.status);
    
    switch(ride.status) {
        case 'accepted':
            statusClass = 'status-accepted';
            break;
        case 'completed':
        case 'paid':
            statusClass = 'status-completed';
            break;
        case 'cancelled':
            statusClass = 'status-cancelled';
            break;
        case 'requested':
            statusClass = 'status-requested';
            break;
    }
    
    // Build history item content
    let content = `
        <div class="history-item-type ${typeClass}">${typeText}</div>
        <div class="history-locations">
            <div class="history-location">
                <div class="history-location-icon history-pickup-icon">
                    <i class="fas fa-map-marker-alt"></i>
                </div>
                <div class="history-location-text">
                    ${ride.pickupDisplayLocation || ride.pickupLocation}
                </div>
            </div>
            <div class="history-location">
                <div class="history-location-icon history-destination-icon">
                    <i class="fas fa-flag"></i>
                </div>
                <div class="history-location-text">
                    ${ride.destination}
                </div>
            </div>
        </div>
        <div class="history-info">
            <div class="history-fare">K${ride.fare ? ride.fare.toFixed(2) : '0.00'}</div>
            <div class="history-date">${formattedDate} ${formattedTime}</div>
            <div class="status-badge ${statusClass}">
                ${statusText}
            </div>
        </div>
    `;
    
    // Add driver info if available
    if (ride.driverId) {
        content += `
            <div class="history-driver-info">
                <div class="history-driver-avatar">
                    ${ride.driverName ? ride.driverName.charAt(0).toUpperCase() : 'D'}
                </div>
                <div class="history-driver-details">
                    <div class="history-driver-name">${ride.driverName || 'Driver'}</div>
                    <div class="history-driver-rating">${ride.driverRating || '4.5'} </div>
                </div>
            </div>
        `;
    }
    
    historyItem.innerHTML = content;
    
    // Add click handler for showing details
    historyItem.addEventListener('click', function() {
        showRideDetailsPopup(ride.id);
    });
    
    return historyItem;
}

// Enhanced ride details popup
function showRideDetailsPopup(rideId) {
    showLoading("Loading ride details...");
    
    database.ref('rides/' + rideId).once('value')
        .then(snapshot => {
            const ride = snapshot.val();
            if (ride) {
                populateRideDetailsPopup(ride);
                loadChatHistory(rideId);
                updatePopupRideMap(ride);
                hideLoading();
                document.getElementById('rideDetailsPopup').classList.remove('hidden');
            }
        })
        .catch(error => {
            console.error('Error loading ride details:', error);
            hideLoading();
            showNotification('Error loading ride details.');
        });
}

function populateRideDetailsPopup(ride) {
    // Basic ride details
    document.getElementById('popupRidePickup').textContent = ride.pickupDisplayLocation || ride.pickupLocation;
    document.getElementById('popupRideDestination').textContent = ride.destination;
    document.getElementById('popupRideFare').textContent = `K${ride.fare ? ride.fare.toFixed(2) : '0.00'}`;
    document.getElementById('popupRideDistance').textContent = ride.distance || '0 km';
    document.getElementById('popupRideStatus').textContent = getStatusText(ride.status);
    document.getElementById('popupRideType').textContent = ride.rideType ? ride.rideType.charAt(0).toUpperCase() + ride.rideType.slice(1) : 'Standard';
    
    const date = new Date(ride.timestamp);
    document.getElementById('popupRideDate').textContent = 
        `${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
    
    // Driver details if available
    if (ride.driverId) {
        database.ref('users/' + ride.driverId).once('value')
            .then(driverSnapshot => {
                const driver = driverSnapshot.val();
                if (driver) {
                    document.getElementById('popupDriverName').textContent = driver.name || 'Driver';
                    document.getElementById('popupDriverPhone').textContent = driver.phone || 'N/A';
                    document.getElementById('popupDriverRating').textContent = driver.rating || '4.5 ';
                    
                    if (driver.vehicle) {
                        document.getElementById('popupDriverVehicle').textContent = 
                            `${driver.vehicle.type || 'Car'} (${driver.vehicle.licensePlate || 'N/A'})`;
                    }
                    
                    document.getElementById('popupDriverDetails').classList.remove('hidden');
                }
            });
    }
}

function loadChatHistory(rideId) {
    const chatContainer = document.getElementById('popupChatMessages');
    chatContainer.innerHTML = '<div class="loading-text">Loading chat history...</div>';
    
    database.ref('chats/' + rideId).orderByChild('timestamp').once('value')
        .then(snapshot => {
            const messages = snapshot.val();
            chatContainer.innerHTML = '';
            
            if (messages) {
                const messagesArray = Object.values(messages);
                messagesArray.sort((a, b) => a.timestamp - b.timestamp);
                
                if (messagesArray.length === 0) {
                    chatContainer.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">
                                <i class="fas fa-comments"></i>
                            </div>
                            <div class="empty-state-title">No chat messages</div>
                            <div class="empty-state-description">No messages were exchanged during this ride</div>
                        </div>
                    `;
                    return;
                }
                
                messagesArray.forEach(message => {
                    const messageElement = document.createElement('div');
                    messageElement.className = `chat-message-history ${message.senderId === currentUser.uid ? 'passenger' : 'driver'}`;
                    
                    const time = new Date(message.timestamp);
                    const timeString = time.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    messageElement.innerHTML = `
                        <div>${message.message}</div>
                        <div class="chat-time">${timeString}</div>
                    `;
                    
                    chatContainer.appendChild(messageElement);
                });
                
                // Scroll to bottom
                chatContainer.scrollTop = chatContainer.scrollHeight;
            } else {
                chatContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-comments"></i>
                        </div>
                        <div class="empty-state-title">No chat messages</div>
                        <div class="empty-state-description">No messages were exchanged during this ride</div>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading chat history:', error);
            chatContainer.innerHTML = '<div class="error-text">Error loading chat history</div>';
        });
}

function updatePopupRideMap(ride) {
    if (!popupRideMap) return;
    
    // Clear existing layers
    popupRideMap.eachLayer(layer => {
        if (layer instanceof L.TileLayer) return;
        popupRideMap.removeLayer(layer);
    });
    
    // Add route if we have coordinates
    if (ride.pickupLat && ride.pickupLng && ride.destLat && ride.destLng) {
        // Set view to show entire route
        const bounds = L.latLngBounds(
            [ride.pickupLat, ride.pickupLng],
            [ride.destLat, ride.destLng]
        );
        popupRideMap.fitBounds(bounds, { padding: [30, 30] });
        
        // Add markers
        L.marker([ride.pickupLat, ride.pickupLng], {
            icon: L.divIcon({
                className: 'pickup-marker-enhanced',
                html: '<div class="pickup-marker-enhanced"><i class="fas fa-map-marker-alt"></i></div>',
                iconSize: [24, 24]
            })
        }).addTo(popupRideMap)
            .bindPopup('Pickup Location');
        
        L.marker([ride.destLat, ride.destLng], {
            icon: L.divIcon({
                className: 'destination-marker-enhanced',
                html: '<div class="destination-marker-enhanced"><i class="fas fa-flag"></i></div>',
                iconSize: [24, 24]
            })
        }).addTo(popupRideMap)
            .bindPopup('Destination');
        
        // Draw route
        fetch(`https://router.project-osrm.org/route/v1/driving/${ride.pickupLng},${ride.pickupLat};${ride.destLng},${ride.destLat}?overview=full&geometries=geojson`)
            .then(response => response.json())
            .then(data => {
                if (data.routes && data.routes.length > 0) {
                    const route = data.routes[0];
                    const routeCoordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                    
                    L.polyline(routeCoordinates, {
                        color: '#FF6B35',
                        weight: 4,
                        opacity: 0.8
                    }).addTo(popupRideMap);
                }
            })
            .catch(error => {
                console.error('Error drawing route:', error);
                // Draw straight line as fallback
                L.polyline([
                    [ride.pickupLat, ride.pickupLng],
                    [ride.destLat, ride.destLng]
                ], {
                    color: '#FF6B35',
                    weight: 4,
                    opacity: 0.8,
                    dashArray: '5, 10'
                }).addTo(popupRideMap);
            });
    } else {
        // Default view if no coordinates
        popupRideMap.setView([-15.4167, 28.2833], 13);
    }
}

// Enhanced status text
function getStatusText(status) {
    const statusMap = {
        'requested': 'Awaiting Driver',
        'accepted': 'Driver on the way',
        'completed': 'Completed',
        'paid': 'Completed',
        'cancelled': 'Cancelled',
        'arrived': 'Driver arrived',
        'picked_up': 'Picked up',
        'started': 'In progress'
    };
    
    return statusMap[status] || status;
}

// Enhanced UI reset after ride
function resetUIAfterRide() {
    document.getElementById('rideRequestForm').style.display = 'flex';
    document.getElementById('rideInfoPanel').style.display = 'none';
    document.getElementById('driverDetailsCard').style.display = 'none';
    
    // Clear form fields
    document.getElementById('destinationLocation').value = '';
    document.getElementById('promoCode').value = '';
    document.getElementById('packageForm').classList.remove('active');
    document.getElementById('promoSection').classList.remove('active');
    
    // Reset promo code
    appliedPromoCode = null;
    
    // Clear map markers
    if (destinationMarker) {
        passengerMap.removeLayer(destinationMarker);
        destinationMarker = null;
    }
    
    if (driverMarker) {
        passengerMap.removeLayer(driverMarker);
        driverMarker = null;
    }
    
    if (routePolyline) {
        passengerMap.removeLayer(routePolyline);
        routePolyline = null;
    }
    
    // Reset fare estimate
    document.getElementById('estimatedFare').textContent = 'K0.00';
    document.getElementById('etaDisplay').textContent = 'ETA: -- min';
    document.getElementById('requestRideBtn').disabled = true;
    
    // Close chat popup if open
    if (document.getElementById('chatPopup') && !document.getElementById('chatPopup').classList.contains('hidden')) {
        closeChatPopup();
    }
    
    currentRide = null;
}

// Enhanced event listeners setup
function setupEventListeners() {
    console.log(" Setting up event listeners...");
    
    // Navigation buttons
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const screen = this.getAttribute('data-screen');
            switchScreen(screen);
        });
    });
    
    // Back buttons
    document.querySelectorAll('.back-button').forEach(btn => {
        btn.addEventListener('click', function() {
            const screen = this.getAttribute('data-screen');
            switchScreen(screen);
        });
    });
    
    // Vehicle selection
    document.querySelectorAll('.vehicle-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.vehicle-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            this.classList.add('selected');
            selectedVehicleType = this.getAttribute('data-type');
            
            // Show/hide package form based on vehicle type
            const packageToggle = document.getElementById('packageToggle');
            if (selectedVehicleType === 'bike' || selectedVehicleType === 'bicycle') {
                packageToggle.style.display = 'flex';
            } else {
                packageToggle.style.display = 'none';
                document.getElementById('packageForm').classList.remove('active');
            }
            
            updateFareEstimate();
        });
    });
    
    // Package toggle
    document.getElementById('packageToggle')?.addEventListener('click', function() {
        document.getElementById('packageForm').classList.toggle('active');
    });
    
    // Request ride button
    document.getElementById('requestRideBtn')?.addEventListener('click', requestRide);
    
    // Cancel ride button
    document.getElementById('cancelRideBtn')?.addEventListener('click', function() {
        if (currentRide && confirm('Are you sure you want to cancel this ride?')) {
            cancelRide();
        }
    });
    
    // Contact driver button
    document.getElementById('contactDriverBtn')?.addEventListener('click', contactDriver);
    
    // Promo toggle
    document.getElementById('promoToggle')?.addEventListener('click', function() {
        document.getElementById('promoSection').classList.toggle('active');
    });
    
    // Apply promo button
    document.getElementById('applyPromoBtn')?.addEventListener('click', applyPromoCode);
    
    // Panel collapse
    document.getElementById('panelCollapseHandle')?.addEventListener('click', togglePanelCollapse);
    
    // Map controls
    document.getElementById('centerMapBtn')?.addEventListener('click', centerMap);
    document.getElementById('refreshLocationBtn')?.addEventListener('click', refreshPassengerPosition);
    
    // Clear pickup button
    document.getElementById('clearPickupBtn')?.addEventListener('click', function() {
        document.getElementById('pickupLocation').value = '';
        if (pickupMarker) {
            passengerMap.removeLayer(pickupMarker);
            pickupMarker = null;
        }
        this.classList.add('d-none');
    });
    
    // Schedule ride button
    document.getElementById('scheduleRideBtn')?.addEventListener('click', openScheduleRidePopup);
    
    // More options
    document.getElementById('moreOptionsBtn')?.addEventListener('click', toggleMoreOptions);
    document.querySelectorAll('.more-option-item').forEach(item => {
        item.addEventListener('click', function() {
            const option = this.getAttribute('data-option');
            handleMoreOptionSelection(option);
        });
    });
    
    // SOS button
    document.getElementById('sosButton')?.addEventListener('click', triggerSOS);
    
    // Payment selection
    document.getElementById('closePaymentPopup')?.addEventListener('click', closePaymentSelection);
    document.getElementById('confirmPaymentBtn')?.addEventListener('click', submitRideRequest);
    document.querySelectorAll('.payment-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.payment-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            this.classList.add('selected');
            selectedPaymentType = this.getAttribute('data-payment-type');
            checkWalletBalance();
        });
    });
    
    // Ride details popup
    document.getElementById('closeRidePopup')?.addEventListener('click', closeRideDetailsPopup);
    document.getElementById('closeRidePopupTop')?.addEventListener('click', closeRideDetailsPopup);
    
    // Schedule popup
    document.getElementById('closeSchedulePopup')?.addEventListener('click', closeSchedulePopup);
    document.getElementById('cancelScheduleBtn')?.addEventListener('click', closeSchedulePopup);
    document.getElementById('confirmScheduleRideBtn')?.addEventListener('click', confirmScheduleRide);
    
    // Schedule tabs
    document.querySelectorAll('.schedule-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            document.querySelectorAll('.schedule-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.schedule-form').forEach(f => f.style.display = 'none');
            
            this.classList.add('active');
            const tabName = this.getAttribute('data-tab');
            document.getElementById(`schedule${tabName.charAt(0).toUpperCase() + tabName.slice(1)}Form`).style.display = 'block';
        });
    });
    
    // History filter
    document.getElementById('historyFilter')?.addEventListener('change', loadRideHistory);
    document.getElementById('historyDate')?.addEventListener('change', loadRideHistory);
    
    // Account actions
    document.getElementById('shareReferralBtn')?.addEventListener('click', shareReferralCode);
    document.getElementById('depositBtn')?.addEventListener('click', depositToWallet);
    document.getElementById('withdrawBtn')?.addEventListener('click', withdrawFromWallet);
    document.getElementById('whatsappBtn')?.addEventListener('click', contactWhatsApp);
    document.getElementById('callBtn')?.addEventListener('click', contactPhone);
    
    // Setup search listeners
    setupSearchInputListeners();
    
    console.log(" Event listeners setup complete");
}

// Enhanced utility functions
function showLoading(message = "Loading...") {
    const overlay = document.getElementById('loadingOverlay');
    const text = document.getElementById('loadingText');
    if (overlay && text) {
        text.textContent = message;
        overlay.style.display = 'flex';
    }
}

function hideLoading() {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
        overlay.style.display = 'none';
    }
}

function showNotification(message) {
    const notification = document.getElementById('notification');
    if (notification) {
        notification.textContent = message;
        notification.style.display = 'block';
        
        // Auto-hide after 4 seconds
        setTimeout(() => {
            notification.style.display = 'none';
        }, 4000);
    }
}

function switchScreen(screenId) {
    const previousScreen = currentScreen;
    currentScreen = screenId;
    
    // Hide all screens
    document.querySelectorAll('.screen-content').forEach(screen => {
        screen.classList.remove('active');
    });
    
    // Show selected screen
    document.getElementById(screenId + 'Screen').classList.add('active');
    
    // Update navigation buttons
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`.nav-btn[data-screen="${screenId}"]`)?.classList.add('active');
    
    // Show/hide home-only elements
    if (screenId === 'home') {
        document.querySelectorAll('.home-only').forEach(el => {
            el.style.display = 'flex';
        });
        
        if (previousScreen !== 'home' && homeScreenRefreshRequired) {
            refreshHomeScreen();
        }
    } else {
        document.querySelectorAll('.home-only').forEach(el => {
            el.style.display = 'none';
        });
        homeScreenRefreshRequired = true;
    }
    
    // Load screen-specific data
    switch(screenId) {
        case 'history':
            loadRideHistory();
            break;
        case 'account':
            loadAccountData();
            break;
        case 'payments':
            // Payments screen already loaded
            break;
        case 'schedule':
            loadScheduledRidesUI();
            break;
    }
}

function refreshHomeScreen() {
    console.log(" Refreshing home screen...");
    
    refreshPassengerPosition();
    document.getElementById('destinationLocation').value = '';
    resetFareEstimate();
    
    if (destinationMarker) {
        passengerMap.removeLayer(destinationMarker);
        destinationMarker = null;
    }
    
    if (routePolyline) {
        passengerMap.removeLayer(routePolyline);
        routePolyline = null;
    }
    
    document.getElementById('promoSection').classList.remove('active');
    document.getElementById('promoCode').value = '';
    appliedPromoCode = null;
    
    document.getElementById('packageForm').classList.remove('active');
    document.getElementById('packageToggle').style.display = 'none';
    
    document.getElementById('rideRequestForm').style.display = 'flex';
    document.getElementById('rideInfoPanel').style.display = 'none';
    
    homeScreenRefreshRequired = false;
    
    showNotification('Home screen refreshed ');
}

function centerMap() {
    if (userLocation) {
        passengerMap.setView([userLocation.lat, userLocation.lng], 16);
        showNotification('Map centered on your location ');
    }
}

function togglePanelCollapse() {
    const panel = document.getElementById('passengerPanel');
    panel.classList.toggle('collapsed');
}

// Additional helper functions (implement as needed)
function checkWalletBalance() {
    const fare = rideFare || 0;
    const insufficientBalance = document.getElementById('insufficientBalance');
    const confirmBtn = document.getElementById('confirmPaymentBtn');
    
    if (selectedPaymentType === 'wallet' && walletBalance < fare) {
        insufficientBalance.style.display = 'block';
        confirmBtn.disabled = true;
    } else {
        insufficientBalance.style.display = 'none';
        confirmBtn.disabled = false;
    }
}

function updateWalletBalanceUI() {
    document.getElementById('walletBalance').textContent = `K${walletBalance.toFixed(2)}`;
    document.getElementById('accountBalance').textContent = `K${walletBalance.toFixed(2)}`;
    document.getElementById('paymentWalletBalance').textContent = `Balance: K${walletBalance.toFixed(2)}`;
}

// Initialize the enhanced app
function initializeEnhancedApp() {
    console.log(" Jubel Passenger App with Enhanced Features Initialized");
    
    // Periodic city updates
    setInterval(() => {
        if (userLocation && currentScreen === 'home') {
            determineCurrentCity(userLocation.lat, userLocation.lng)
                .then(city => {
                    if (city !== currentCity) {
                        console.log(" City changed to:", city);
                        currentCity = city;
                        updateCityUI(city);
                        updateSearchRestrictions(city);
                    }
                })
                .catch(error => {
                    console.error("Periodic city detection failed:", error);
                });
        }
    }, 300000); // Every 5 minutes
    
    // Handle app visibility
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden && currentScreen === 'home') {
            setTimeout(refreshHomeScreen, 1000);
        }
    });
    
    // Handle connectivity
    window.addEventListener('online', function() {
        showNotification('Connection restored. ');
        if (currentScreen === 'home') {
            setTimeout(refreshPassengerPosition, 1000);
        }
    });
    
    window.addEventListener('offline', function() {
        showNotification('You are currently offline. Some features may not work. ');
    });
    
    // Clear old cache entries periodically
    setInterval(() => {
        const now = Date.now();
        for (const [key, timestamp] of searchCacheTimestamp.entries()) {
            if (now - timestamp > SEARCH_CACHE_TTL) {
                searchCache.delete(key);
                searchCacheTimestamp.delete(key);
            }
        }
    }, 60000); // Clean cache every minute
    
    console.log(" Enhanced app initialization complete");
}

// Start the enhanced app
setTimeout(initializeEnhancedApp, 1000);

    </script>
</body>
</html>
