<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jubel Passenger App</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root {
            --primary-orange: #FF6B35;
            --primary-red: #E74C3C;
            --primary-gradient: linear-gradient(135deg, #FF6B35, #E74C3C);
            --secondary-orange: #E55A28;
            --secondary-red: #C0392B;
            --light-orange: #FFF5F0;
            --light-red: #FCE8E6;
            --white: #FFFFFF;
            --off-white: #F9F9F9;
            --light-gray: #F5F5F5;
            --medium-gray: #E0E0E0;
            --dark-gray: #333333;
            --text-gray: #666666;
            --text-light: #888888;
            --success-green: #2ECC71;
            --warning-yellow: #F39C12;
            --info-blue: #3498DB;
            --error-red: #E74C3C;
            --border-color: #EEEEEE;
            --shadow-light: 0 1px 6px rgba(0, 0, 0, 0.08);
            --shadow-medium: 0 2px 12px rgba(0, 0, 0, 0.12);
            --shadow-heavy: 0 4px 20px rgba(0, 0, 0, 0.15);
            --app-padding: 12px;
            --element-radius: 12px;
            --button-radius: 20px;
            --card-radius: 16px;
            --transition-speed: 0.25s;
            --ambulance-blue: #2980B9;
            --fire-truck-red: #C0392B;
            --police-blue: #2C3E50;
            --premium-gold: #FFD700;
            --economy-green: #27AE60;
            --light-truck-brown: #8B4513;
            --delivery-purple: #8E44AD;
            --express-shop-green: #16A085;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }
        
        body {
            background-color: var(--off-white);
            color: var(--dark-gray);
            max-width: 100%;
            overflow-x: hidden;
            height: 100vh;
            font-size: 13px;
            line-height: 1.4;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Map Container */
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 55%;
            z-index: 1;
            background: #f8f9fa;
        }
        
        /* Top Bar Components */
        .top-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 200;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px var(--app-padding);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            height: 56px;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .logo-icon {
            width: 32px;
            height: 32px;
            background: var(--primary-gradient);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-weight: 700;
            font-size: 14px;
            overflow: hidden;
        }
        
        .logo-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .logo-text {
            font-size: 14px;
            font-weight: 700;
            color: var(--dark-gray);
            line-height: 1.2;
        }
        
        .user-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .balance-badge {
            background: var(--white);
            padding: 6px 12px;
            border-radius: var(--button-radius);
            box-shadow: var(--shadow-light);
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 600;
            color: var(--dark-gray);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .balance-badge:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }
        
        .balance-amount {
            color: var(--primary-orange);
            font-weight: 700;
            font-size: 13px;
        }
        
        .notification-bell {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
            cursor: pointer;
            position: relative;
            transition: all var(--transition-speed) ease;
        }
        
        .notification-bell:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }
        
        .notification-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            width: 16px;
            height: 16px;
            background: var(--error-red);
            color: var(--white);
            border-radius: 50%;
            font-size: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            border: 2px solid var(--white);
        }
        
        /* Ride Status Bar */
        .ride-status-bar {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 150;
            display: none;
            background: var(--white);
            padding: 8px 16px;
            border-radius: var(--button-radius);
            box-shadow: var(--shadow-heavy);
            border: 1px solid var(--border-color);
            align-items: center;
            gap: 10px;
            min-width: 280px;
            max-width: 90%;
        }
        
        .ride-status-bar.active {
            display: flex;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                transform: translateX(-50%) translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--warning-yellow);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.1); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        .status-dot.searching { background: var(--warning-yellow); }
        .status-dot.arriving { background: var(--info-blue); }
        .status-dot.riding { background: var(--success-green); animation: none; }
        
        .status-text {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
        }
        
        .status-eta {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--text-gray);
            font-size: 12px;
            font-weight: 500;
        }
        
        /* Emergency Status */
        .emergency-status {
            position: absolute;
            top: 60px;
            right: var(--app-padding);
            z-index: 150;
            background: linear-gradient(135deg, var(--error-red), #C0392B);
            color: var(--white);
            padding: 8px 14px;
            border-radius: var(--button-radius);
            box-shadow: var(--shadow-heavy);
            display: none;
            align-items: center;
            gap: 6px;
            font-weight: 700;
            font-size: 12px;
            animation: emergencyPulse 1s infinite;
        }
        
        @keyframes emergencyPulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
            70% { transform: scale(1.02); box-shadow: 0 0 0 8px rgba(231, 76, 60, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
        }
        
        /* SOS Button */
        .sos-button {
            position: absolute;
            bottom: 160px;
            right: var(--app-padding);
            z-index: 150;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--error-red), #C0392B);
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 14px;
            font-weight: 700;
            box-shadow: var(--shadow-heavy);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            animation: sosPulse 2s infinite;
        }
        
        .sos-button:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(231, 76, 60, 0.4);
        }
        
        @keyframes sosPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* Main Panel */
        .main-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            border-radius: var(--card-radius) var(--card-radius) 0 0;
            box-shadow: 0 -4px 30px rgba(0, 0, 0, 0.1);
            z-index: 100;
            padding: var(--app-padding);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 45vh;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-orange) var(--light-gray);
        }
        
        .main-panel::-webkit-scrollbar {
            width: 4px;
        }
        
        .main-panel::-webkit-scrollbar-track {
            background: var(--light-gray);
            border-radius: 2px;
        }
        
        .main-panel::-webkit-scrollbar-thumb {
            background: var(--primary-orange);
            border-radius: 2px;
        }
        
        .main-panel.collapsed {
            transform: translateY(calc(100% - 48px));
        }
        
        .panel-handle {
            width: 36px;
            height: 3px;
            background: var(--medium-gray);
            border-radius: 2px;
            margin: 0 auto 12px;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .panel-handle:hover {
            background: var(--primary-orange);
            width: 48px;
        }
        
        /* Navigation Tabs */
        .nav-tabs {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            margin-bottom: 12px;
            padding: 4px;
            background: var(--light-gray);
            border-radius: var(--button-radius);
        }
        
        .nav-tab {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 10px 6px;
            border-radius: calc(var(--button-radius) - 4px);
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            color: var(--text-gray);
            font-size: 11px;
            font-weight: 600;
        }
        
        .nav-tab i {
            font-size: 16px;
            transition: all var(--transition-speed) ease;
        }
        
        .nav-tab.active {
            background: var(--white);
            color: var(--primary-orange);
            box-shadow: var(--shadow-light);
        }
        
        .nav-tab.active i {
            color: var(--primary-orange);
            transform: translateY(-2px);
        }
        
        .nav-tab:hover:not(.active) {
            background: rgba(255, 107, 53, 0.1);
            color: var(--primary-orange);
        }
        
        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .quick-action-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            text-align: left;
        }
        
        .quick-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
            border-color: var(--primary-orange);
        }
        
        .quick-action-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: var(--light-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-orange);
            font-size: 16px;
        }
        
        .quick-action-text {
            flex: 1;
        }
        
        .quick-action-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
            margin-bottom: 2px;
        }
        
        .quick-action-desc {
            font-size: 11px;
            color: var(--text-light);
        }
        
        /* Service Tabs */
        .service-tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 16px;
            overflow-x: auto;
            padding-bottom: 4px;
        }
        
        .service-tabs::-webkit-scrollbar {
            display: none;
        }
        
        .service-tab {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 12px 16px;
            background: var(--white);
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            min-width: 100px;
            text-align: center;
            flex-shrink: 0;
        }
        
        .service-tab:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .service-tab.active {
            border-color: var(--primary-orange);
            background: var(--light-orange);
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
        }
        
        .service-tab.car.active { border-color: var(--primary-orange); }
        .service-tab.delivery.active { border-color: var(--delivery-purple); background: #F4E6FA; }
        .service-tab.short-delivery.active { border-color: var(--express-shop-green); background: #E1F5FE; }
        
        .service-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--text-gray);
            transition: all var(--transition-speed) ease;
        }
        
        .service-tab.active .service-icon {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .service-tab.delivery.active .service-icon {
            background: var(--delivery-purple);
        }
        
        .service-tab.short-delivery.active .service-icon {
            background: var(--express-shop-green);
        }
        
        .service-name {
            font-weight: 600;
            font-size: 12px;
            color: var(--dark-gray);
        }
        
        .service-desc {
            font-size: 10px;
            color: var(--text-light);
            margin-top: 2px;
        }
        
        /* Ride Request Form */
        .ride-request-form {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }
        
        .form-title {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--dark-gray);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .location-inputs {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .location-input {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: var(--off-white);
            border: 2px solid transparent;
            border-radius: var(--element-radius);
            transition: all var(--transition-speed) ease;
            position: relative;
        }
        
        .location-input.active {
            border-color: var(--primary-orange);
            background: var(--white);
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
        }
        
        .location-input i {
            color: var(--primary-orange);
            font-size: 14px;
            width: 18px;
            text-align: center;
        }
        
        .location-input input {
            flex: 1;
            border: none;
            background: transparent;
            outline: none;
            font-size: 13px;
            color: var(--dark-gray);
            font-weight: 500;
        }
        
        .location-input input::placeholder {
            color: var(--text-light);
        }
        
        .suggestion-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 1000;
            max-height: 250px;
            overflow-y: auto;
            display: none;
            margin-top: 4px;
        }
        
        .suggestion-list.active {
            display: block;
            animation: fadeIn 0.2s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .suggestion-item {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        .suggestion-item:hover {
            background: var(--light-orange);
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
        
        .suggestion-icon {
            color: var(--primary-orange);
            font-size: 12px;
            margin-top: 2px;
        }
        
        .suggestion-details {
            flex: 1;
        }
        
        .suggestion-name {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
            margin-bottom: 2px;
        }
        
        .suggestion-address {
            font-size: 11px;
            color: var(--text-gray);
            line-height: 1.3;
        }
        
        .suggestion-distance {
            font-size: 10px;
            color: var(--text-light);
            margin-top: 2px;
        }
        
        /* Ride Type Selection */
        .ride-type-selection {
            margin: 16px 0;
            display: none;
        }
        
        .ride-type-selection.active {
            display: block;
            animation: fadeInUp 0.3s ease;
        }
        
        .ride-type-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--dark-gray);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .ride-type-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        
        .ride-type-card {
            background: var(--white);
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            padding: 14px 10px;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .ride-type-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .ride-type-card.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
        }
        
        .ride-type-card.economy.selected {
            border-color: var(--economy-green);
            background: #E8F6EF;
        }
        
        .ride-type-card.premium.selected {
            border-color: var(--premium-gold);
            background: #FFF9E6;
        }
        
        .ride-type-icon {
            width: 42px;
            height: 42px;
            border-radius: 10px;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 8px;
            font-size: 18px;
            color: var(--text-gray);
            transition: all var(--transition-speed) ease;
        }
        
        .ride-type-card.selected .ride-type-icon {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .ride-type-card.economy.selected .ride-type-icon {
            background: var(--economy-green);
        }
        
        .ride-type-card.premium.selected .ride-type-icon {
            background: var(--premium-gold);
            color: var(--dark-gray);
        }
        
        .ride-type-name {
            font-weight: 600;
            font-size: 12px;
            color: var(--dark-gray);
            margin-bottom: 2px;
        }
        
        .ride-type-price {
            font-size: 14px;
            font-weight: 700;
            color: var(--primary-orange);
            margin-bottom: 2px;
        }
        
        .ride-type-card.economy .ride-type-price {
            color: var(--economy-green);
        }
        
        .ride-type-card.premium .ride-type-price {
            color: #B8860B;
        }
        
        .ride-type-eta {
            font-size: 10px;
            color: var(--text-light);
        }
        
        /* Fare Display */
        .fare-display {
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            padding: 16px;
            border-radius: var(--element-radius);
            margin: 16px 0;
            text-align: center;
            box-shadow: var(--shadow-medium);
            display: none;
        }
        
        .fare-display.active {
            display: block;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fare-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 2px;
        }
        
        .fare-amount {
            font-size: 26px;
            font-weight: 800;
            margin: 6px 0;
        }
        
        .fare-details {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 11px;
            opacity: 0.9;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-top: 16px;
        }
        
        .btn {
            padding: 14px;
            border: none;
            border-radius: var(--button-radius);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            box-shadow: 0 3px 12px rgba(255, 107, 53, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 16px rgba(255, 107, 53, 0.4);
        }
        
        .btn-secondary {
            background: var(--white);
            color: var(--primary-orange);
            border: 2px solid var(--primary-orange);
        }
        
        .btn-secondary:hover {
            background: var(--light-orange);
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--error-red), #C0392B);
            color: var(--white);
            box-shadow: 0 3px 12px rgba(231, 76, 60, 0.3);
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 16px rgba(231, 76, 60, 0.4);
        }
        
        /* Ride Info Panel */
        .ride-info-panel {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-medium);
            border: 1px solid var(--border-color);
            display: none;
        }
        
        .ride-info-panel.active {
            display: block;
            animation: fadeInUp 0.3s ease;
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .driver-info {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .driver-avatar {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--white);
            font-weight: 700;
            overflow: hidden;
        }
        
        .driver-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .driver-details {
            flex: 1;
        }
        
        .driver-name {
            font-size: 14px;
            font-weight: 700;
            color: var(--dark-gray);
            margin-bottom: 2px;
        }
        
        .driver-rating {
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--warning-yellow);
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 12px;
        }
        
        .driver-vehicle {
            font-size: 12px;
            color: var(--text-gray);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .vehicle-image {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            overflow: hidden;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .vehicle-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .trip-details {
            margin-bottom: 16px;
        }
        
        .trip-locations {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .location-point {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        .location-marker {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            color: var(--white);
            font-size: 11px;
        }
        
        .location-marker.pickup {
            background: var(--primary-orange);
        }
        
        .location-marker.destination {
            background: var(--primary-red);
        }
        
        .location-text {
            flex: 1;
        }
        
        .location-label {
            font-size: 11px;
            color: var(--text-light);
            margin-bottom: 2px;
            font-weight: 600;
        }
        
        .location-address {
            font-size: 13px;
            color: var(--dark-gray);
            font-weight: 500;
            line-height: 1.3;
        }
        
        .fare-breakdown {
            background: var(--off-white);
            border-radius: var(--element-radius);
            padding: 14px;
            margin-bottom: 16px;
        }
        
        .fare-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .fare-row:last-child {
            border-bottom: none;
        }
        
        .fare-label {
            font-size: 13px;
            color: var(--text-gray);
        }
        
        .fare-value {
            font-size: 13px;
            font-weight: 600;
            color: var(--dark-gray);
        }
        
        .fare-row.total {
            margin-top: 6px;
            padding-top: 10px;
            border-top: 2px solid var(--border-color);
        }
        
        .fare-row.total .fare-label {
            font-size: 14px;
            font-weight: 700;
            color: var(--dark-gray);
        }
        
        .fare-row.total .fare-value {
            font-size: 18px;
            font-weight: 800;
            color: var(--primary-orange);
        }
        
        /* Chat System */
        .chat-container {
            position: absolute;
            bottom: 200px;
            right: var(--app-padding);
            z-index: 300;
            width: 320px;
            max-width: calc(100vw - 40px);
            background: var(--white);
            border-radius: var(--card-radius);
            box-shadow: var(--shadow-heavy);
            display: none;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        
        .chat-container.active {
            display: flex;
            animation: chatSlideUp 0.3s ease;
        }
        
        @keyframes chatSlideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .chat-header {
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            padding: 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .chat-title {
            font-weight: 600;
            font-size: 13px;
        }
        
        .chat-close {
            background: none;
            border: none;
            color: var(--white);
            font-size: 16px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all var(--transition-speed) ease;
        }
        
        .chat-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .chat-messages {
            flex: 1;
            padding: 14px;
            max-height: 250px;
            overflow-y: auto;
            background: var(--off-white);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .message {
            max-width: 80%;
            padding: 8px 12px;
            border-radius: 16px;
            font-size: 13px;
            line-height: 1.3;
        }
        
        .message.sent {
            align-self: flex-end;
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            border-bottom-right-radius: 4px;
        }
        
        .message.received {
            align-self: flex-start;
            background: var(--white);
            color: var(--dark-gray);
            border: 1px solid var(--border-color);
            border-bottom-left-radius: 4px;
        }
        
        .message-time {
            font-size: 10px;
            color: var(--text-light);
            margin-top: 2px;
            text-align: right;
        }
        
        .message.received .message-time {
            color: var(--text-gray);
        }
        
        .chat-input-container {
            padding: 14px;
            background: var(--white);
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 8px;
        }
        
        .chat-input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid var(--border-color);
            border-radius: var(--button-radius);
            font-size: 13px;
            outline: none;
            transition: all var(--transition-speed) ease;
        }
        
        .chat-input:focus {
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
        }
        
        .chat-send-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-speed) ease;
        }
        
        .chat-send-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 3px 10px rgba(255, 107, 53, 0.3);
        }
        
        .chat-notification {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 18px;
            height: 18px;
            background: var(--error-red);
            color: var(--white);
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            animation: bounce 1s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        
        /* Modal System */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
            backdrop-filter: blur(4px);
        }
        
        .modal-overlay.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        
        .modal {
            background: var(--white);
            border-radius: var(--card-radius);
            box-shadow: var(--shadow-heavy);
            max-width: 450px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            animation: modalSlideUp 0.3s ease;
        }
        
        @keyframes modalSlideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--dark-gray);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--text-light);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all var(--transition-speed) ease;
        }
        
        .modal-close:hover {
            color: var(--error-red);
            background: var(--light-red);
        }
        
        .modal-content {
            padding: 20px;
        }
        
        /* History Screen */
        .history-screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--white);
            z-index: 200;
            display: none;
            flex-direction: column;
            padding-top: 56px;
        }
        
        .history-screen.active {
            display: flex;
            animation: slideInRight 0.3s ease;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        .screen-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: var(--white);
            padding: 14px var(--app-padding);
            border-bottom: 1px solid var(--border-color);
            z-index: 10;
            display: flex;
            align-items: center;
            gap: 14px;
        }
        
        .back-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--dark-gray);
            border: none;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .back-btn:hover {
            background: var(--medium-gray);
            transform: translateX(-2px);
        }
        
        .screen-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--dark-gray);
        }
        
        .history-filters {
            padding: 14px var(--app-padding);
            background: var(--off-white);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 8px;
            overflow-x: auto;
            scrollbar-width: none;
        }
        
        .history-filters::-webkit-scrollbar {
            display: none;
        }
        
        .filter-btn {
            padding: 6px 14px;
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--button-radius);
            font-size: 12px;
            font-weight: 600;
            color: var(--text-gray);
            cursor: pointer;
            white-space: nowrap;
            transition: all var(--transition-speed) ease;
        }
        
        .filter-btn.active {
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            border-color: transparent;
        }
        
        .filter-btn:hover:not(.active) {
            border-color: var(--primary-orange);
            color: var(--primary-orange);
        }
        
        .history-list {
            flex: 1;
            overflow-y: auto;
            padding: 14px var(--app-padding);
        }
        
        .history-item {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 16px;
            margin-bottom: 10px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .history-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
            border-color: var(--primary-orange);
        }
        
        .history-item.expanded {
            margin-bottom: 16px;
        }
        
        .history-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .history-type {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .history-icon {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            background: var(--light-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-orange);
        }
        
        .history-type-name {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
        }
        
        .history-date {
            font-size: 12px;
            color: var(--text-light);
        }
        
        .history-status {
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-completed {
            background: #E8F6EF;
            color: var(--economy-green);
        }
        
        .status-cancelled {
            background: var(--light-red);
            color: var(--error-red);
        }
        
        .status-ongoing {
            background: #E3F2FD;
            color: var(--info-blue);
        }
        
        .history-locations {
            margin-bottom: 10px;
        }
        
        .history-location {
            display: flex;
            align-items: flex-start;
            gap: 6px;
            margin-bottom: 6px;
        }
        
        .history-location i {
            color: var(--text-light);
            margin-top: 2px;
        }
        
        .history-location-text {
            font-size: 12px;
            color: var(--text-gray);
            line-height: 1.3;
        }
        
        .history-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
        }
        
        .history-price {
            font-size: 14px;
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        .history-driver {
            font-size: 12px;
            color: var(--text-gray);
        }
        
        .history-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .history-item.expanded .history-details {
            max-height: 400px;
            margin-top: 14px;
            padding-top: 14px;
            border-top: 1px solid var(--border-color);
        }
        
        .detail-section {
            margin-bottom: 14px;
        }
        
        .detail-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--dark-gray);
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .detail-label {
            font-size: 11px;
            color: var(--text-light);
            font-weight: 500;
        }
        
        .detail-value {
            font-size: 13px;
            color: var(--dark-gray);
            font-weight: 500;
        }
        
        /* Account Screen */
        .account-screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--white);
            z-index: 200;
            display: none;
            flex-direction: column;
            padding-top: 56px;
        }
        
        .account-screen.active {
            display: flex;
        }
        
        .account-header {
            padding: 20px var(--app-padding);
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            text-align: center;
        }
        
        .account-avatar {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            margin: 0 auto 14px;
            border: 3px solid rgba(255, 255, 255, 0.3);
        }
        
        .account-name {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 2px;
        }
        
        .account-phone {
            font-size: 13px;
            opacity: 0.9;
        }
        
        .account-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            padding: 16px var(--app-padding);
            background: var(--white);
        }
        
        .stat-card {
            background: var(--off-white);
            border-radius: var(--element-radius);
            padding: 14px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary-orange);
            margin-bottom: 2px;
        }
        
        .stat-label {
            font-size: 11px;
            color: var(--text-gray);
            font-weight: 500;
        }
        
        .account-section {
            padding: 16px var(--app-padding);
            border-bottom: 1px solid var(--border-color);
        }
        
        .section-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--dark-gray);
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .wallet-balance {
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            padding: 20px;
            border-radius: var(--element-radius);
            text-align: center;
            margin-bottom: 16px;
        }
        
        .balance-label {
            font-size: 13px;
            opacity: 0.9;
            margin-bottom: 6px;
        }
        
        .balance-amount-large {
            font-size: 30px;
            font-weight: 800;
            margin-bottom: 2px;
        }
        
        .wallet-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 14px;
        }
        
        .btn-wallet {
            padding: 10px;
            border: 2px solid var(--primary-orange);
            background: var(--white);
            color: var(--primary-orange);
            border-radius: var(--button-radius);
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .btn-wallet:hover {
            background: var(--primary-orange);
            color: var(--white);
            transform: translateY(-2px);
        }
        
        .referral-card {
            background: var(--light-orange);
            border-radius: var(--element-radius);
            padding: 16px;
            text-align: center;
            margin-top: 14px;
        }
        
        .referral-code {
            background: var(--white);
            padding: 14px;
            border-radius: var(--element-radius);
            margin: 14px 0;
            font-family: monospace;
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-orange);
            letter-spacing: 2px;
        }
        
        .referral-note {
            font-size: 11px;
            color: var(--text-gray);
            margin-top: 6px;
        }
        
        /* Emergency Screen */
        .emergency-screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--white);
            z-index: 200;
            display: none;
            flex-direction: column;
            padding-top: 56px;
        }
        
        .emergency-screen.active {
            display: flex;
        }
        
        .emergency-services {
            padding: 16px var(--app-padding);
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .emergency-service {
            background: var(--white);
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .emergency-service:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-medium);
        }
        
        .emergency-service.police {
            border-color: var(--police-blue);
        }
        
        .emergency-service.police:hover {
            border-color: var(--police-blue);
            box-shadow: 0 6px 20px rgba(44, 62, 80, 0.2);
        }
        
        .emergency-service.fire {
            border-color: var(--fire-truck-red);
        }
        
        .emergency-service.fire:hover {
            border-color: var(--fire-truck-red);
            box-shadow: 0 6px 20px rgba(192, 57, 43, 0.2);
        }
        
        .emergency-service.medical {
            border-color: var(--ambulance-blue);
        }
        
        .emergency-service.medical:hover {
            border-color: var(--ambulance-blue);
            box-shadow: 0 6px 20px rgba(41, 128, 185, 0.2);
        }
        
        .emergency-icon {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin: 0 auto 10px;
            color: var(--white);
        }
        
        .emergency-service.police .emergency-icon {
            background: var(--police-blue);
        }
        
        .emergency-service.fire .emergency-icon {
            background: var(--fire-truck-red);
        }
        
        .emergency-service.medical .emergency-icon {
            background: var(--ambulance-blue);
        }
        
        .emergency-name {
            font-size: 14px;
            font-weight: 700;
            color: var(--dark-gray);
            margin-bottom: 6px;
        }
        
        .emergency-description {
            font-size: 12px;
            color: var(--text-gray);
            line-height: 1.3;
        }
        
        .emergency-note {
            padding: 16px var(--app-padding);
            background: var(--light-red);
            margin: 16px var(--app-padding);
            border-radius: var(--element-radius);
            border-left: 3px solid var(--error-red);
        }
        
        .emergency-note p {
            font-size: 12px;
            color: var(--dark-gray);
            line-height: 1.4;
        }
        
        /* Loading States */
        .loading {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid var(--light-gray);
            border-radius: 50%;
            border-top-color: var(--primary-orange);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            z-index: 10000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
        }
        
        .loading-overlay.active {
            display: flex;
        }
        
        .loading-spinner {
            width: 52px;
            height: 52px;
            border: 4px solid var(--light-gray);
            border-radius: 50%;
            border-top-color: var(--primary-orange);
            animation: spin 1s linear infinite;
        }
        
        .loading-text {
            font-size: 14px;
            font-weight: 600;
            color: var(--dark-gray);
        }
        
        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 90px;
            right: var(--app-padding);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-width: 350px;
        }
        
        .toast {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 14px;
            box-shadow: var(--shadow-heavy);
            border-left: 3px solid var(--primary-orange);
            display: flex;
            align-items: flex-start;
            gap: 10px;
            animation: slideInRight 0.3s ease;
            transform: translateX(0);
            transition: transform 0.3s ease;
        }
        
        .toast.hiding {
            transform: translateX(100%);
        }
        
        .toast-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--light-orange);
            color: var(--primary-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
            margin-bottom: 2px;
        }
        
        .toast-message {
            font-size: 12px;
            color: var(--text-gray);
            line-height: 1.3;
        }
        
        .toast-close {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 16px;
            cursor: pointer;
            padding: 2px;
            border-radius: 4px;
            transition: all var(--transition-speed) ease;
        }
        
        .toast-close:hover {
            color: var(--error-red);
            background: var(--light-red);
        }
        
        .toast.success {
            border-left-color: var(--success-green);
        }
        
        .toast.success .toast-icon {
            background: #E8F6EF;
            color: var(--success-green);
        }
        
        .toast.error {
            border-left-color: var(--error-red);
        }
        
        .toast.error .toast-icon {
            background: var(--light-red);
            color: var(--error-red);
        }
        
        .toast.warning {
            border-left-color: var(--warning-yellow);
        }
        
        .toast.warning .toast-icon {
            background: #FFF3E0;
            color: var(--warning-yellow);
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            :root {
                --app-padding: 10px;
                --element-radius: 10px;
                --button-radius: 16px;
            }
            
            .quick-actions {
                grid-template-columns: 1fr;
            }
            
            .ride-type-grid {
                grid-template-columns: 1fr;
            }
            
            .emergency-services {
                grid-template-columns: 1fr;
            }
            
            .chat-container {
                width: calc(100vw - 20px);
                right: 10px;
            }
            
            .detail-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 480px) {
            .nav-tabs {
                gap: 4px;
            }
            
            .nav-tab {
                padding: 8px 4px;
                font-size: 10px;
            }
            
            .nav-tab i {
                font-size: 14px;
            }
            
            .balance-badge {
                padding: 5px 8px;
                font-size: 12px;
            }
            
            .service-tab {
                min-width: 85px;
                padding: 10px 12px;
            }
        }
        
        /* Custom Markers */
        .current-location-marker {
            background: var(--info-blue);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            box-shadow: 0 1px 8px rgba(0,0,0,0.3);
            border: 2px solid white;
        }
        
        .pickup-marker {
            background: var(--primary-orange);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            box-shadow: 0 1px 8px rgba(0,0,0,0.3);
            border: 2px solid white;
        }
        
        .destination-marker {
            background: var(--primary-red);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            box-shadow: 0 1px 8px rgba(0,0,0,0.3);
            border: 2px solid white;
        }
        
        .driver-marker {
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: white;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            box-shadow: 0 1px 8px rgba(0,0,0,0.3);
            border: 2px solid white;
            animation: pulse 2s infinite;
        }
        
        .emergency-vehicle-marker {
            background: var(--error-red);
            color: white;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            box-shadow: 0 1px 8px rgba(0,0,0,0.3);
            border: 2px solid white;
            animation: emergencyPulse 1s infinite;
        }
        
        /* Enhanced Form Elements */
        .form-group {
            margin-bottom: 14px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 13px;
            color: var(--dark-gray);
            background: var(--white);
            transition: all var(--transition-speed) ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
        }
        
        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        /* Search Loading Indicator */
        .search-loading {
            display: none;
            position: absolute;
            top: 50%;
            right: 12px;
            transform: translateY(-50%);
            width: 14px;
            height: 14px;
            border: 2px solid var(--light-gray);
            border-radius: 50%;
            border-top-color: var(--primary-orange);
            animation: spin 0.6s linear infinite;
        }
        
        .location-input.searching .search-loading {
            display: block;
        }
        
        /* No Results Message */
        .no-results {
            padding: 30px 16px;
            text-align: center;
            color: var(--text-light);
            font-size: 13px;
        }
        
        .no-results i {
            font-size: 28px;
            margin-bottom: 10px;
            opacity: 0.5;
        }
        
        /* Price Calculation Display */
        .price-calculation {
            background: var(--off-white);
            border-radius: var(--element-radius);
            padding: 14px;
            margin: 14px 0;
            font-size: 12px;
            color: var(--text-gray);
        }
        
        .calculation-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }
        
        .calculation-row:last-child {
            margin-bottom: 0;
            padding-top: 6px;
            border-top: 1px solid var(--border-color);
            font-weight: 600;
            color: var(--dark-gray);
        }
        
        /* Cancel Reasons Modal */
        .cancel-reasons {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-bottom: 16px;
        }
        
        .cancel-reason {
            padding: 14px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .cancel-reason:hover {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .cancel-reason.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .reason-icon {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-gray);
        }
        
        .cancel-reason.selected .reason-icon {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .reason-text {
            flex: 1;
            font-weight: 500;
            color: var(--dark-gray);
        }
        
        /* Schedule Ride Form */
        .schedule-form {
            display: none;
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }
        
        .schedule-form.active {
            display: block;
        }
        
        .schedule-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 14px;
        }
        
        /* More Options */
        .more-options {
            display: none;
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }
        
        .more-options.active {
            display: block;
        }
        
        .options-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .option-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 14px;
            background: var(--off-white);
            border: 2px solid transparent;
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .option-btn:hover {
            border-color: var(--primary-orange);
            background: var(--white);
            transform: translateY(-2px);
        }
        
        .option-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: var(--light-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-orange);
            font-size: 16px;
        }
        
        .option-name {
            font-weight: 600;
            font-size: 12px;
            color: var(--dark-gray);
            text-align: center;
        }
        
        /* Empty States */
        .empty-state {
            padding: 50px 16px;
            text-align: center;
            color: var(--text-light);
        }
        
        .empty-icon {
            font-size: 40px;
            margin-bottom: 14px;
            opacity: 0.3;
        }
        
        .empty-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text-gray);
        }
        
        .empty-message {
            font-size: 13px;
            margin-bottom: 16px;
            line-height: 1.4;
        }
        
        /* Service Forms */
        .service-form {
            display: none;
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }
        
        .service-form.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        /* Truck Delivery Form */
        .truck-form {
            border-color: var(--light-truck-brown);
        }
        
        .truck-form .form-title {
            color: var(--light-truck-brown);
        }
        
        /* Delivery Form */
        .delivery-form {
            border-color: var(--delivery-purple);
        }
        
        .delivery-form .form-title {
            color: var(--delivery-purple);
        }
        
        /* Express Shopping Form */
        .express-form {
            border-color: var(--express-shop-green);
        }
        
        .express-form .form-title {
            color: var(--express-shop-green);
        }
        
        /* Order for Someone Else Form */
        .someone-else-form {
            border-color: var(--info-blue);
        }
        
        .someone-else-form .form-title {
            color: var(--info-blue);
        }
        
        /* Ride Sharing Form */
        .share-ride-form {
            border-color: var(--warning-yellow);
        }
        
        .share-ride-form .form-title {
            color: var(--warning-yellow);
        }
        
        /* Payment Selection Styles */
        .payment-methods {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin: 16px 0;
        }
        
        .payment-method {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .payment-method:hover {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .payment-method.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .payment-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-gray);
        }
        
        .payment-method.selected .payment-icon {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .payment-details {
            flex: 1;
        }
        
        .payment-name {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
        }
        
        .payment-info {
            font-size: 11px;
            color: var(--text-gray);
            margin-top: 2px;
        }
        
        /* Wallet Transfer Form */
        .transfer-form {
            display: none;
        }
        
        .transfer-form.active {
            display: block;
        }
        
        /* Timeline */
        .timeline {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 16px 0;
            padding: 0 20px;
            position: relative;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            top: 12px;
            left: 10%;
            right: 10%;
            height: 2px;
            background: var(--border-color);
            z-index: 1;
        }
        
        .timeline-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            position: relative;
            z-index: 2;
            flex: 1;
        }
        
        .step-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            font-size: 10px;
            border: 2px solid var(--white);
            transition: all var(--transition-speed) ease;
        }
        
        .step-dot.active {
            background: var(--primary-orange);
            color: var(--white);
            transform: scale(1.1);
        }
        
        .step-dot.completed {
            background: var(--success-green);
            color: var(--white);
        }
        
        .step-label {
            font-size: 11px;
            color: var(--text-light);
            text-align: center;
        }
        
        .step-label.active {
            color: var(--primary-orange);
            font-weight: 600;
        }
        
        /* Parcel Details */
        .parcel-details {
            background: var(--off-white);
            border-radius: var(--element-radius);
            padding: 14px;
            margin: 12px 0;
        }
        
        .parcel-value-input {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .parcel-value-input span {
            font-weight: 600;
            color: var(--text-gray);
        }
        
        .parcel-value-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 13px;
        }
        
        /* Truck Types */
        .truck-types {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 12px 0;
        }
        
        .truck-type {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            text-align: center;
        }
        
        .truck-type:hover {
            border-color: var(--light-truck-brown);
            transform: translateY(-2px);
        }
        
        .truck-type.selected {
            border-color: var(--light-truck-brown);
            background: rgba(139, 69, 19, 0.05);
        }
        
        .truck-icon {
            font-size: 20px;
            color: var(--light-truck-brown);
            margin-bottom: 6px;
        }
        
        .truck-name {
            font-weight: 600;
            font-size: 12px;
            color: var(--dark-gray);
            margin-bottom: 2px;
        }
        
        .truck-capacity {
            font-size: 10px;
            color: var(--text-gray);
        }
        
        /* Item List for Express Shopping */
        .item-list {
            margin: 12px 0;
        }
        
        .item-entry {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .item-entry input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 13px;
        }
        
        .remove-item {
            width: 36px;
            height: 36px;
            border-radius: var(--element-radius);
            background: var(--light-red);
            border: none;
            color: var(--error-red);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .add-item {
            width: 100%;
            padding: 10px;
            background: var(--light-orange);
            border: 2px dashed var(--primary-orange);
            border-radius: var(--element-radius);
            color: var(--primary-orange);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all var(--transition-speed) ease;
        }
        
        .add-item:hover {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        /* Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* Focus Styles */
        *:focus {
            outline: 2px solid var(--primary-orange);
            outline-offset: 2px;
        }
        
        *:focus:not(.focus-visible) {
            outline: none;
        }
        
        /* Print Styles */
        @media print {
            .main-panel,
            .top-bar,
            .chat-container,
            .modal-overlay,
            .sos-button,
            .ride-status-bar,
            .emergency-status {
                display: none !important;
            }
            
            #map {
                position: relative;
                height: 300px;
            }
        }
        
        /* Enhanced Broadcast Section */
        .broadcast-section {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 16px;
            margin: 12px 0;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }
        
        .broadcast-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .broadcast-input-group {
            display: flex;
            gap: 8px;
        }
        
        .broadcast-input-group input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 13px;
        }
        
        .broadcast-btn {
            padding: 10px 16px;
            background: var(--primary-orange);
            color: var(--white);
            border: none;
            border-radius: var(--element-radius);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .broadcast-btn:hover {
            background: var(--secondary-orange);
            transform: translateY(-2px);
        }
        
        .broadcast-list {
            margin-top: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .broadcast-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .broadcast-item:last-child {
            border-bottom: none;
        }
        
        .broadcast-name {
            font-weight: 600;
            font-size: 13px;
        }
        
        .broadcast-status {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 10px;
            background: var(--light-orange);
            color: var(--primary-orange);
        }
        
        .broadcast-status.pending {
            background: #FFF3E0;
            color: var(--warning-yellow);
        }
        
        .broadcast-status.accepted {
            background: #E8F6EF;
            color: var(--success-green);
        }
        
        /* Driver Media Display */
        .driver-media {
            display: flex;
            gap: 12px;
            margin-top: 10px;
        }
        
        .media-container {
            flex: 1;
            border-radius: var(--element-radius);
            overflow: hidden;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 80px;
        }
        
        .media-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .media-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            font-size: 12px;
        }
        
        .media-placeholder i {
            font-size: 24px;
            margin-bottom: 4px;
        }
        
        /* Emergency Reason Selection */
        .emergency-reasons {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin: 16px 0;
        }
        
        .emergency-reason {
            padding: 14px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .emergency-reason:hover {
            border-color: var(--error-red);
            background: var(--light-red);
        }
        
        .emergency-reason.selected {
            border-color: var(--error-red);
            background: var(--light-red);
        }
        
        .emergency-reason-icon {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            background: var(--light-red);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--error-red);
        }
        
        .emergency-reason.selected .emergency-reason-icon {
            background: var(--error-red);
            color: var(--white);
        }
        
        .emergency-reason-text {
            flex: 1;
            font-weight: 500;
            color: var(--dark-gray);
        }
        
        /* Emergency Stations List */
        .emergency-stations {
            margin: 16px 0;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .emergency-station {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            margin-bottom: 8px;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .emergency-station:hover {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .emergency-station.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .station-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        
        .station-name {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
        }
        
        .station-distance {
            font-size: 11px;
            color: var(--text-gray);
        }
        
        .station-address {
            font-size: 12px;
            color: var(--text-gray);
            line-height: 1.3;
        }
        
        .station-details {
            margin-top: 6px;
            font-size: 11px;
            color: var(--text-light);
            display: flex;
            gap: 10px;
        }
        
        /* Enhanced Search Results */
        .search-results-container {
            position: relative;
            z-index: 1001;
        }
        
        .search-result-item {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        
        .search-result-item:hover {
            background: var(--light-orange);
        }
        
        .search-result-icon {
            color: var(--primary-orange);
            font-size: 16px;
            margin-top: 2px;
        }
        
        .search-result-content {
            flex: 1;
        }
        
        .search-result-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
            margin-bottom: 2px;
        }
        
        .search-result-subtitle {
            font-size: 12px;
            color: var(--text-gray);
            margin-bottom: 2px;
        }
        
        .search-result-details {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-light);
        }
        
        /* City Detection Indicator */
        .city-detection {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 150;
            background: var(--white);
            padding: 8px 16px;
            border-radius: var(--button-radius);
            box-shadow: var(--shadow-heavy);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            font-weight: 500;
            color: var(--dark-gray);
        }
        
        .city-detection i {
            color: var(--primary-orange);
        }
        
        /* Enhanced Notifications Panel */
        .notifications-panel {
            position: absolute;
            top: 56px;
            right: var(--app-padding);
            z-index: 250;
            width: 320px;
            max-width: calc(100vw - 40px);
            background: var(--white);
            border-radius: var(--card-radius);
            box-shadow: var(--shadow-heavy);
            display: none;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        
        .notifications-panel.active {
            display: flex;
            animation: slideDown 0.3s ease;
        }
        
        .notifications-header {
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            padding: 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .notifications-title {
            font-weight: 600;
            font-size: 13px;
        }
        
        .notifications-close {
            background: none;
            border: none;
            color: var(--white);
            font-size: 16px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all var(--transition-speed) ease;
        }
        
        .notifications-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .notifications-list {
            flex: 1;
            max-height: 300px;
            overflow-y: auto;
            background: var(--off-white);
        }
        
        .notification-item {
            padding: 14px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .notification-item:hover {
            background: var(--white);
        }
        
        .notification-item.unread {
            background: var(--light-orange);
        }
        
        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        
        .notification-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .notification-time {
            font-size: 11px;
            color: var(--text-light);
        }
        
        .notification-message {
            font-size: 12px;
            color: var(--text-gray);
            line-height: 1.3;
        }
        
        .notification-actions {
            margin-top: 8px;
            display: flex;
            gap: 8px;
        }
        
        .notification-action-btn {
            padding: 4px 8px;
            font-size: 11px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background: var(--white);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .notification-action-btn:hover {
            background: var(--primary-orange);
            color: var(--white);
            border-color: var(--primary-orange);
        }
        
        /* Dropdown Menu */
        .dropdown-menu {
            position: absolute;
            top: 60px;
            right: var(--app-padding);
            z-index: 250;
            width: 200px;
            background: var(--white);
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            display: none;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        
        .dropdown-menu.active {
            display: flex;
            animation: slideDown 0.3s ease;
        }
        
        .dropdown-item {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            color: var(--dark-gray);
        }
        
        .dropdown-item:hover {
            background: var(--light-orange);
            color: var(--primary-orange);
        }
        
        .dropdown-item:last-child {
            border-bottom: none;
        }
        
        .dropdown-item i {
            width: 18px;
            text-align: center;
        }
        
        /* More Options Menu */
        .more-options-menu {
            position: absolute;
            bottom: 200px;
            left: var(--app-padding);
            z-index: 250;
            width: 200px;
            background: var(--white);
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            display: none;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        
        .more-options-menu.active {
            display: flex;
            animation: slideUp 0.3s ease;
        }
        
        /* Enhanced Emergency Modal */
        .emergency-modal-content {
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .emergency-reason-input {
            margin-top: 10px;
        }
        
        .emergency-reason-input textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 13px;
            resize: vertical;
            min-height: 80px;
        }
        
        /* Real-time Updates Indicator */
        .real-time-indicator {
            position: fixed;
            bottom: 10px;
            right: 10px;
            z-index: 1000;
            background: var(--success-green);
            color: var(--white);
            padding: 6px 12px;
            border-radius: var(--button-radius);
            font-size: 11px;
            font-weight: 600;
            display: none;
            align-items: center;
            gap: 6px;
            box-shadow: var(--shadow-medium);
        }
        
        .real-time-indicator.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        
        /* Enhanced Chat Features */
        .chat-typing-indicator {
            font-size: 11px;
            color: var(--text-light);
            font-style: italic;
            padding: 4px 12px;
            display: none;
        }
        
        .chat-typing-indicator.active {
            display: block;
        }
        
        .chat-attachment-btn {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 16px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all var(--transition-speed) ease;
        }
        
        .chat-attachment-btn:hover {
            color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        /* Enhanced Search Bar */
        .search-bar-container {
            position: relative;
            margin-bottom: 12px;
        }
        
        .search-bar {
            width: 100%;
            padding: 12px 16px 12px 40px;
            border: 2px solid var(--border-color);
            border-radius: var(--button-radius);
            font-size: 13px;
            transition: all var(--transition-speed) ease;
        }
        
        .search-bar:focus {
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
        }
        
        .search-bar-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
        }
        
        /* Enhanced Price Calculator */
        .price-calculator-display {
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            padding: 16px;
            border-radius: var(--element-radius);
            margin: 16px 0;
            box-shadow: var(--shadow-medium);
        }
        
        .price-breakdown {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .price-breakdown-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 12px;
            opacity: 0.9;
        }
        
        .price-breakdown-row.total {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            font-weight: 700;
            font-size: 14px;
        }
        
        /* Enhanced Map Controls */
        .map-controls {
            position: absolute;
            top: 100px;
            right: var(--app-padding);
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .map-control-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--white);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-medium);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--dark-gray);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .map-control-btn:hover {
            background: var(--primary-orange);
            color: var(--white);
            transform: scale(1.1);
        }
        
        /* Enhanced Driver Tracking */
        .tracking-info {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 12px;
            margin: 12px 0;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }
        
        .tracking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .tracking-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
        }
        
        .tracking-distance {
            font-size: 12px;
            color: var(--primary-orange);
            font-weight: 600;
        }
        
        .tracking-progress {
            height: 6px;
            background: var(--light-gray);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        
        .tracking-progress-bar {
            height: 100%;
            background: var(--primary-orange);
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        .tracking-details {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-gray);
        }
        
        /* Enhanced Broadcast Feature */
        .broadcast-feature {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 16px;
            margin: 16px 0;
            box-shadow: var(--shadow-medium);
            border: 1px solid var(--border-color);
        }
        
        .broadcast-feature-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        
        .broadcast-feature-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--dark-gray);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .broadcast-status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success-green);
            animation: pulse 1.5s infinite;
        }
        
        .broadcast-status-indicator.inactive {
            background: var(--text-light);
            animation: none;
        }
        
        .broadcast-recipients {
            max-height: 150px;
            overflow-y: auto;
            margin-bottom: 12px;
        }
        
        .broadcast-recipient {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .broadcast-recipient:last-child {
            border-bottom: none;
        }
        
        .recipient-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .recipient-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--light-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-orange);
            font-weight: 600;
            font-size: 12px;
        }
        
        .recipient-name {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
        }
        
        .recipient-status {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
        }
        
        .status-joined {
            background: #E8F6EF;
            color: var(--success-green);
        }
        
        .status-pending {
            background: #FFF3E0;
            color: var(--warning-yellow);
        }
        
        /* Enhanced Location Details */
        .location-details {
            background: var(--off-white);
            border-radius: var(--element-radius);
            padding: 14px;
            margin: 12px 0;
        }
        
        .location-detail-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .location-detail-item:last-child {
            margin-bottom: 0;
        }
        
        .location-detail-icon {
            color: var(--primary-orange);
            font-size: 14px;
            margin-top: 2px;
        }
        
        .location-detail-content {
            flex: 1;
        }
        
        .location-detail-label {
            font-size: 11px;
            color: var(--text-light);
            margin-bottom: 2px;
        }
        
        .location-detail-value {
            font-size: 13px;
            color: var(--dark-gray);
            font-weight: 500;
            line-height: 1.3;
        }
        
        /* Enhanced Emergency Contact */
        .emergency-contact-display {
            background: var(--light-red);
            border-radius: var(--element-radius);
            padding: 14px;
            margin: 12px 0;
            border-left: 3px solid var(--error-red);
        }
        
        .emergency-contact-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .emergency-contact-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
        }
        
        .emergency-contact-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(231, 76, 60, 0.1);
        }
        
        .emergency-contact-item:last-child {
            border-bottom: none;
        }
        
        .contact-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .contact-name {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
        }
        
        .contact-phone {
            font-size: 12px;
            color: var(--text-gray);
        }
        
        .contact-action-btn {
            padding: 4px 8px;
            font-size: 11px;
            border-radius: 12px;
            background: var(--white);
            border: 1px solid var(--error-red);
            color: var(--error-red);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .contact-action-btn:hover {
            background: var(--error-red);
            color: var(--white);
        }
        
        /* Enhanced Service Type Indicators */
        .service-type-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .indicator-car {
            background: var(--light-orange);
            color: var(--primary-orange);
        }
        
        .indicator-delivery {
            background: #F4E6FA;
            color: var(--delivery-purple);
        }
        
        .indicator-truck {
            background: rgba(139, 69, 19, 0.1);
            color: var(--light-truck-brown);
        }
        
        .indicator-emergency {
            background: var(--light-red);
            color: var(--error-red);
        }
        
        .indicator-shopping {
            background: #E1F5FE;
            color: var(--express-shop-green);
        }
        
        /* Enhanced Price Updates Animation */
        .price-update-animation {
            animation: priceUpdate 0.5s ease;
        }
        
        @keyframes priceUpdate {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* Enhanced Real-time Sync Indicator */
        .sync-indicator {
            position: fixed;
            bottom: 10px;
            left: 10px;
            z-index: 1000;
            background: var(--info-blue);
            color: var(--white);
            padding: 6px 12px;
            border-radius: var(--button-radius);
            font-size: 11px;
            font-weight: 600;
            display: none;
            align-items: center;
            gap: 6px;
            box-shadow: var(--shadow-medium);
        }
        
        .sync-indicator.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        
        .sync-indicator.syncing .sync-icon {
            animation: spin 1s linear infinite;
        }
        
        /* Enhanced Distance Display */
        .distance-display {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--light-orange);
            border-radius: var(--element-radius);
            font-size: 12px;
            color: var(--dark-gray);
        }
        
        .distance-value {
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        /* Enhanced ETA Display */
        .eta-display {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--light-gray);
            border-radius: var(--element-radius);
            font-size: 12px;
            color: var(--dark-gray);
        }
        
        .eta-value {
            font-weight: 700;
            color: var(--info-blue);
        }
        
        /* Enhanced Search History */
        .search-history {
            margin-top: 8px;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .search-history-item {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .search-history-item:hover {
            background: var(--light-orange);
        }
        
        .search-history-icon {
            color: var(--text-light);
            font-size: 12px;
        }
        
        .search-history-text {
            flex: 1;
            font-size: 13px;
            color: var(--dark-gray);
        }
        
        .search-history-time {
            font-size: 11px;
            color: var(--text-light);
        }
        
        /* Enhanced Broadcast Notifications */
        .broadcast-notification {
            background: var(--info-blue);
            color: var(--white);
            padding: 12px;
            border-radius: var(--element-radius);
            margin: 12px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .broadcast-notification-content {
            flex: 1;
        }
        
        .broadcast-notification-title {
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 4px;
        }
        
        .broadcast-notification-message {
            font-size: 12px;
            opacity: 0.9;
        }
        
        .broadcast-notification-actions {
            display: flex;
            gap: 8px;
        }
        
        /* Enhanced Map Loading */
        .map-loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 12px;
        }
        
        .map-loading-text {
            font-size: 14px;
            font-weight: 600;
            color: var(--dark-gray);
        }
        
        /* Enhanced Error Display */
        .error-display {
            background: var(--light-red);
            border-radius: var(--element-radius);
            padding: 14px;
            margin: 12px 0;
            border-left: 3px solid var(--error-red);
        }
        
        .error-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--error-red);
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .error-message {
            font-size: 12px;
            color: var(--dark-gray);
            line-height: 1.3;
        }
        
        /* Enhanced Success Display */
        .success-display {
            background: #E8F6EF;
            border-radius: var(--element-radius);
            padding: 14px;
            margin: 12px 0;
            border-left: 3px solid var(--success-green);
        }
        
        .success-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--success-green);
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .success-message {
            font-size: 12px;
            color: var(--dark-gray);
            line-height: 1.3;
        }
        
        /* Enhanced Warning Display */
        .warning-display {
            background: #FFF3E0;
            border-radius: var(--element-radius);
            padding: 14px;
            margin: 12px 0;
            border-left: 3px solid var(--warning-yellow);
        }
        
        .warning-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--warning-yellow);
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .warning-message {
            font-size: 12px;
            color: var(--dark-gray);
            line-height: 1.3;
        }
    </style>
</head>
<body>
    <!-- Map Container -->
    <div id="map">
        <div class="map-loading-overlay" id="mapLoadingOverlay">
            <div class="loading-spinner"></div>
            <div class="map-loading-text">Loading map...</div>
        </div>
    </div>
    
    <!-- Top Navigation Bar -->
    <div class="top-bar">
        <div class="logo-container">
            <div class="logo-icon">
                <img src="jubel.png" alt="Jubel Logo" id="jubelLogo">
            </div>
            <div class="logo-text" id="userFullName">Loading...</div>
        </div>
        
        <div class="user-actions">
            <div class="balance-badge" id="balanceBadge">
                <i class="fas fa-wallet"></i>
                <span>Balance: <span class="balance-amount" id="walletBalance">ZMW 0.00</span></span>
            </div>
            <div class="notification-bell" id="notificationBell">
                <i class="fas fa-bell"></i>
                <span class="notification-badge" id="notificationCount">0</span>
            </div>
        </div>
    </div>
    
    <!-- City Detection Indicator -->
    <div class="city-detection" id="cityDetection">
        <i class="fas fa-map-marker-alt"></i>
        <span id="currentCityDisplay">Detecting your city...</span>
    </div>
    
    <!-- Ride Status Bar -->
    <div class="ride-status-bar" id="rideStatusBar">
        <div class="status-indicator">
            <div class="status-dot searching" id="statusDot"></div>
            <span class="status-text" id="statusText">Searching for driver</span>
        </div>
        <div class="status-eta">
            <i class="fas fa-clock"></i>
            <span id="etaText">5 min</span>
        </div>
    </div>
    
    <!-- Emergency Status -->
    <div class="emergency-status" id="emergencyStatus">
        <i class="fas fa-exclamation-triangle"></i>
        <span>EMERGENCY RIDE IN PROGRESS</span>
    </div>
    
    <!-- SOS Button -->
    <div class="sos-button" id="sosButton">
        <i class="fas fa-exclamation-triangle"></i>
    </div>
    
    <!-- Map Controls -->
    <div class="map-controls">
        <button class="map-control-btn" id="locateMeBtn" title="Locate Me">
            <i class="fas fa-location-arrow"></i>
        </button>
        <button class="map-control-btn" id="zoomInBtn" title="Zoom In">
            <i class="fas fa-plus"></i>
        </button>
        <button class="map-control-btn" id="zoomOutBtn" title="Zoom Out">
            <i class="fas fa-minus"></i>
        </button>
        <button class="map-control-btn" id="clearRouteBtn" title="Clear Route">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <!-- Chat Container -->
    <div class="chat-container" id="chatContainer">
        <div class="chat-header">
            <div class="chat-title">Chat with Driver</div>
            <button class="chat-close" id="chatClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <!-- Messages will be inserted here -->
        </div>
        <div class="chat-typing-indicator" id="typingIndicator">
            Driver is typing...
        </div>
        <div class="chat-input-container">
            <button class="chat-attachment-btn" id="attachmentBtn">
                <i class="fas fa-paperclip"></i>
            </button>
            <input type="text" class="chat-input" id="chatInput" placeholder="Type your message...">
            <button class="chat-send-btn" id="chatSend">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
    
    <!-- Notifications Panel -->
    <div class="notifications-panel" id="notificationsPanel">
        <div class="notifications-header">
            <div class="notifications-title">Notifications</div>
            <button class="notifications-close" id="notificationsClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="notifications-list" id="notificationsList">
            <!-- Notifications will be inserted here -->
        </div>
    </div>
    
    <!-- Dropdown Menu -->
    <div class="dropdown-menu" id="dropdownMenu">
        <div class="dropdown-item" data-action="profile">
            <i class="fas fa-user"></i>
            <span>Profile</span>
        </div>
        <div class="dropdown-item" data-action="settings">
            <i class="fas fa-cog"></i>
            <span>Settings</span>
        </div>
        <div class="dropdown-item" data-action="help">
            <i class="fas fa-question-circle"></i>
            <span>Help & Support</span>
        </div>
        <div class="dropdown-item" data-action="logout">
            <i class="fas fa-sign-out-alt"></i>
            <span>Logout</span>
        </div>
    </div>
    
    <!-- More Options Menu -->
    <div class="more-options-menu" id="moreOptionsMenu">
        <div class="dropdown-item" data-option="schedule">
            <i class="fas fa-calendar-alt"></i>
            <span>Schedule Ride</span>
        </div>
        <div class="dropdown-item" data-option="orderForSomeone">
            <i class="fas fa-user-friends"></i>
            <span>Order for Someone</span>
        </div>
        <div class="dropdown-item" data-option="shareRide">
            <i class="fas fa-share-alt"></i>
            <span>Share Ride</span>
        </div>
        <div class="dropdown-item" data-option="broadcast">
            <i class="fas fa-broadcast-tower"></i>
            <span>Broadcast Ride</span>
        </div>
    </div>
    
    <!-- Main Panel -->
    <div class="main-panel" id="mainPanel">
        <div class="panel-handle" id="panelHandle"></div>
        
        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" data-screen="home">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </button>
            <button class="nav-tab" data-screen="history">
                <i class="fas fa-history"></i>
                <span>History</span>
            </button>
            <button class="nav-tab" data-screen="account">
                <i class="fas fa-user"></i>
                <span>Account</span>
            </button>
            <button class="nav-tab" data-screen="emergency">
                <i class="fas fa-ambulance"></i>
                <span>Emergency</span>
            </button>
        </div>
        
        <!-- Home Screen Content -->
        <div id="homeContent">
            <!-- Service Tabs -->
            <div class="service-tabs" id="serviceTabs">
                <div class="service-tab car active" data-service="car">
                    <div class="service-icon">
                        <i class="fas fa-car"></i>
                    </div>
                    <div class="service-name">Car</div>
                    <div class="service-desc">Ride anywhere</div>
                </div>
                
                <div class="service-tab delivery" data-service="delivery">
                    <div class="service-icon">
                        <i class="fas fa-shipping-fast"></i>
                    </div>
                    <div class="service-name">Delivery</div>
                    <div class="service-desc">Send packages</div>
                </div>
                
                <div class="service-tab short-delivery" data-service="short-delivery">
                    <div class="service-icon">
                        <i class="fas fa-bicycle"></i>
                    </div>
                    <div class="service-name">Short Delivery</div>
                    <div class="service-desc">Quick deliveries</div>
                </div>
                
                <div class="service-tab" data-service="express">
                    <div class="service-icon">
                        <i class="fas fa-shopping-bag"></i>
                    </div>
                    <div class="service-name">Express Shopping</div>
                    <div class="service-desc">Shop for you</div>
                </div>
                
                <div class="service-tab" data-service="truck">
                    <div class="service-icon">
                        <i class="fas fa-truck"></i>
                    </div>
                    <div class="service-name">Truck</div>
                    <div class="service-desc">Move items</div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="quick-actions">
                <button class="quick-action-btn" id="moreOptionsBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-ellipsis-h"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">More Options</div>
                        <div class="quick-action-desc">Schedule, share, broadcast</div>
                    </div>
                </button>
                <button class="quick-action-btn" id="broadcastRideBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-broadcast-tower"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">Broadcast Ride</div>
                        <div class="quick-action-desc">Share with friends</div>
                    </div>
                </button>
                <button class="quick-action-btn" id="sosSetupBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">SOS Setup</div>
                        <div class="quick-action-desc">Emergency contacts</div>
                    </div>
                </button>
                <button class="quick-action-btn" id="recentDestinationsBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-history"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">Recent Destinations</div>
                        <div class="quick-action-desc">Quick access</div>
                    </div>
                </button>
            </div>
            
            <!-- Car Service Form (Default) -->
            <div class="ride-request-form active" id="carForm">
                <div class="form-title">
                    <i class="fas fa-car"></i>
                    Book a Ride
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="pickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="pickupLocation" placeholder="Current location" readonly>
                        <div class="search-loading" id="searchLoading"></div>
                        <div class="suggestion-list" id="pickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="destinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="destinationLocation" placeholder="Where to?" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="destinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Stops Container -->
                <div id="stopsContainer" style="margin: 10px 0;"></div>
                <button type="button" class="btn btn-secondary" id="addStopBtn" style="width: 100%; margin-bottom: 15px;">
                    <i class="fas fa-plus"></i> Add Stop
                </button>
                
                <!-- Search History -->
                <div class="search-history" id="searchHistory" style="display: none;"></div>
                
                <!-- Ride Type Selection -->
                <div class="ride-type-selection" id="rideTypeSelection">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                        <span id="rideTypeInfo" style="font-size: 11px; color: var(--text-light); cursor: pointer;">
                            <i class="fas fa-info-circle"></i>
                        </span>
                    </div>
                    
                    <!-- Ride Type Cards will be inserted here by JavaScript -->
                    <div class="ride-type-cards" id="rideTypeCardsContainer"></div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="fareDisplay">
                    <div class="fare-label">Estimated Fare</div>
                    <div class="fare-amount" id="estimatedFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="distanceDetail">0 km</span>
                        <span id="timeDetail">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Price Calculator Display -->
                <div class="price-calculator-display" id="priceCalculator" style="display: none;">
                    <div class="fare-label">Fare Breakdown</div>
                    <div class="fare-amount" id="calculatedFare">ZMW 0.00</div>
                    <div class="price-breakdown" id="priceBreakdown">
                        <!-- Breakdown will be inserted here -->
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestRideBtn">
                        <i class="fas fa-search"></i>
                        Request Ride
                    </button>
                </div>
            </div>
            
            <!-- Delivery Service Form -->
            <div class="service-form delivery-form" id="deliveryForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-shipping-fast"></i>
                    Package Delivery
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="deliveryPickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="deliveryPickup" placeholder="Pickup location" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="deliveryPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="deliveryDestinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="deliveryDestination" placeholder="Delivery address" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="deliveryDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Delivery Details -->
                <div class="form-group">
                    <label class="form-label">Parcel Description</label>
                    <input type="text" class="form-control" id="parcelDescription" placeholder="What are you sending?">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Receiver's Details</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="receiverName" placeholder="Receiver name">
                        <input type="tel" class="form-control" id="receiverPhone" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Parcel Value (ZMW)</label>
                    <input type="number" class="form-control" id="parcelValue" placeholder="Value of parcel" min="0" step="0.01">
                </div>
                
                <!-- Delivery Options -->
                <div class="form-group">
                    <label class="form-label">Delivery Type</label>
                    <div style="display: flex; gap: 10px;">
                        <button class="filter-btn active" id="standardDelivery">Standard</button>
                        <button class="filter-btn" id="expressDelivery">Express</button>
                        <button class="filter-btn" id="sameDayDelivery">Same Day</button>
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="deliveryFareDisplay" style="display: none;">
                    <div class="fare-label">Delivery Fare</div>
                    <div class="fare-amount" id="deliveryFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="deliveryDistance">0 km</span>
                        <span id="deliveryTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestDeliveryBtn">
                        <i class="fas fa-shipping-fast"></i>
                        Request Delivery
                    </button>
                </div>
            </div>
            
            <!-- Short Delivery Form -->
            <div class="service-form delivery-form" id="shortDeliveryForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-bicycle"></i>
                    Short Delivery
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="shortDeliveryPickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="shortDeliveryPickup" placeholder="Pickup location" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shortDeliveryPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="shortDeliveryDestinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="shortDeliveryDestination" placeholder="Delivery address" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shortDeliveryDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Delivery Details -->
                <div class="form-group">
                    <label class="form-label">What are you sending?</label>
                    <input type="text" class="form-control" id="shortParcelDescription" placeholder="Food, documents, small items...">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Receiver's Phone</label>
                    <input type="tel" class="form-control" id="shortReceiverPhone" placeholder="Receiver phone number">
                </div>
                
                <!-- Quick Options -->
                <div class="form-group">
                    <label class="form-label">Quick Options</label>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <span class="filter-btn">Food</span>
                        <span class="filter-btn">Documents</span>
                        <span class="filter-btn">Medication</span>
                        <span class="filter-btn">Small Package</span>
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="shortDeliveryFareDisplay" style="display: none;">
                    <div class="fare-label">Delivery Fare</div>
                    <div class="fare-amount" id="shortDeliveryFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="shortDeliveryDistance">0 km</span>
                        <span id="shortDeliveryTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestShortDeliveryBtn">
                        <i class="fas fa-bolt"></i>
                        Quick Delivery
                    </button>
                </div>
            </div>
            
            <!-- Express Shopping Form -->
            <div class="service-form express-form" id="expressForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-shopping-bag"></i>
                    Express Shopping
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="shopNameInput">
                        <i class="fas fa-store"></i>
                        <input type="text" id="shopName" placeholder="Shop/Restaurant name" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shopSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="shopLocation" placeholder="Shop location" readonly>
                    </div>
                </div>
                
                <!-- Items List -->
                <div class="form-group">
                    <label class="form-label">Shopping List</label>
                    <div class="item-list" id="shoppingItems">
                        <div class="item-entry">
                            <input type="text" class="item-input" placeholder="Item name">
                            <button class="remove-item" type="button">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <button class="add-item" type="button" id="addItemBtn">
                        <i class="fas fa-plus"></i>
                        Add Item
                    </button>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Special Instructions</label>
                    <textarea class="form-control form-textarea" id="shoppingInstructions" placeholder="Any specific requests or instructions..."></textarea>
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="shoppingDestinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="shoppingDestination" placeholder="Delivery address" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shoppingDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Budget -->
                <div class="form-group">
                    <label class="form-label">Estimated Budget (ZMW)</label>
                    <input type="number" class="form-control" id="shoppingBudget" placeholder="Estimated cost of items">
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="shoppingFareDisplay" style="display: none;">
                    <div class="fare-label">Shopping Service Fare</div>
                    <div class="fare-amount" id="shoppingFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="shoppingDistance">0 km</span>
                        <span id="shoppingTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestShoppingBtn">
                        <i class="fas fa-shopping-cart"></i>
                        Request Shopping
                    </button>
                </div>
            </div>
            
            <!-- Truck Delivery Form -->
            <div class="service-form truck-form" id="truckForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-truck"></i>
                    Truck Delivery
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="truckPickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="truckPickup" placeholder="Pickup location (Current location)" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="truckPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="truckDestinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="truckDestination" placeholder="Destination" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="truckDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Truck Type Selection -->
                <div class="form-group">
                    <label class="form-label">Select Truck Type</label>
                    <div class="truck-types">
                        <div class="truck-type" data-type="pickup">
                            <div class="truck-icon">
                                <i class="fas fa-truck-pickup"></i>
                            </div>
                            <div class="truck-name">Pickup Truck</div>
                            <div class="truck-capacity">Up to 1.5 tons</div>
                        </div>
                        
                        <div class="truck-type selected" data-type="light">
                            <div class="truck-icon">
                                <i class="fas fa-truck-moving"></i>
                            </div>
                            <div class="truck-name">Light Truck</div>
                            <div class="truck-capacity">Up to 3 tons</div>
                        </div>
                        
                        <div class="truck-type" data-type="medium">
                            <div class="truck-icon">
                                <i class="fas fa-truck"></i>
                            </div>
                            <div class="truck-name">Medium Truck</div>
                            <div class="truck-capacity">Up to 7 tons</div>
                        </div>
                        
                        <div class="truck-type" data-type="heavy">
                            <div class="truck-icon">
                                <i class="fas fa-truck-loading"></i>
                            </div>
                            <div class="truck-name">Heavy Truck</div>
                            <div class="truck-capacity">Up to 15 tons</div>
                        </div>
                    </div>
                </div>
                
                <!-- Item Details -->
                <div class="form-group">
                    <label class="form-label">What are you moving?</label>
                    <input type="text" class="form-control" id="truckItemDescription" placeholder="Furniture, boxes, equipment...">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Estimated Weight (kg)</label>
                    <input type="number" class="form-control" id="estimatedWeight" placeholder="Approximate weight">
                </div>
                
                <!-- Additional Help -->
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="needHelpers">
                        <span style="margin-left: 8px;">Need loading/unloading helpers (+ZMW 50)</span>
                    </label>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="truckFareDisplay" style="display: none;">
                    <div class="fare-label">Truck Fare</div>
                    <div class="fare-amount" id="truckFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="truckDistance">0 km</span>
                        <span id="truckTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestTruckBtn">
                        <i class="fas fa-truck"></i>
                        Request Truck
                    </button>
                </div>
            </div>
            
            <!-- Ride Info Panel -->
            <div class="ride-info-panel" id="rideInfoPanel" style="display: none;">
                <div class="driver-info">
                    <div class="driver-avatar" id="driverAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="driver-details">
                        <div class="driver-name" id="driverName">Driver Name</div>
                        <div class="driver-rating">
                            <i class="fas fa-star"></i>
                            <span id="driverRating">4.8</span>
                        </div>
                        <div class="driver-vehicle">
                            <i class="fas fa-car"></i>
                            <span id="vehicleDetails">Toyota Corolla - ABC 123</span>
                        </div>
                    </div>
                </div>
                
                <!-- Driver Media Display -->
                <div class="driver-media" id="driverMedia">
                    <div class="media-container">
                        <div class="media-placeholder" id="driverImagePlaceholder">
                            <i class="fas fa-user"></i>
                            <span>Driver Image</span>
                        </div>
                        <img id="driverImage" style="display: none;">
                    </div>
                    <div class="media-container">
                        <div class="media-placeholder" id="vehicleImagePlaceholder">
                            <i class="fas fa-car"></i>
                            <span>Vehicle Image</span>
                        </div>
                        <img id="vehicleImage" style="display: none;">
                    </div>
                </div>
                
                <!-- Tracking Info -->
                <div class="tracking-info" id="trackingInfo">
                    <div class="tracking-header">
                        <div class="tracking-title">Driver Distance</div>
                        <div class="tracking-distance" id="driverDistance">0 km</div>
                    </div>
                    <div class="tracking-progress">
                        <div class="tracking-progress-bar" id="trackingProgress" style="width: 0%"></div>
                    </div>
                    <div class="tracking-details">
                        <span id="pickupDistance">0 km to pickup</span>
                        <span id="etaToPickup">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Timeline -->
                <div class="timeline" id="rideTimeline">
                    <div class="timeline-step">
                        <div class="step-dot active" id="stepRequested">
                            <i class="fas fa-search"></i>
                        </div>
                        <div class="step-label active">Requested</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepAccepted">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <div class="step-label">Accepted</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepArrived">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="step-label">Arrived</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepStarted">
                            <i class="fas fa-play"></i>
                        </div>
                        <div class="step-label">Started</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepCompleted">
                            <i class="fas fa-flag-checkered"></i>
                        </div>
                        <div class="step-label">Completed</div>
                    </div>
                </div>
                
                <!-- Ride Stops -->
                <div class="ride-stops" id="rideStopsContainer" style="display: none; margin-top: 15px;">
                    <div class="section-title" style="font-size: 14px; color: var(--text-gray); margin-bottom: 10px;">
                        <i class="fas fa-map-pin"></i> Stops
                    </div>
                    <div id="rideStopsList"></div>
                </div>
                
                <div class="trip-details">
                    <div class="trip-locations">
                        <div class="location-point">
                            <div class="location-marker pickup">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="location-text">
                                <div class="location-label">Pickup</div>
                                <div class="location-address" id="currentPickup">Loading...</div>
                            </div>
                        </div>
                        
                        <div class="location-point">
                            <div class="location-marker destination">
                                <i class="fas fa-flag"></i>
                            </div>
                            <div class="location-text">
                                <div class="location-label">Destination</div>
                                <div class="location-address" id="currentDestination">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Location Details -->
                <div class="location-details">
                    <div class="location-detail-item">
                        <div class="location-detail-icon">
                            <i class="fas fa-road"></i>
                        </div>
                        <div class="location-detail-content">
                            <div class="location-detail-label">Distance</div>
                            <div class="location-detail-value" id="rideDistance">0 km</div>
                        </div>
                    </div>
                    <div class="location-detail-item">
                        <div class="location-detail-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="location-detail-content">
                            <div class="location-detail-label">Estimated Time</div>
                            <div class="location-detail-value" id="rideTime">0 min</div>
                        </div>
                    </div>
                </div>
                
                <div class="fare-breakdown">
                    <div class="fare-row">
                        <span class="fare-label">Base Fare</span>
                        <span class="fare-value" id="baseFareValue">ZMW 15.00</span>
                    </div>
                    <div class="fare-row">
                        <span class="fare-label">Distance</span>
                        <span class="fare-value" id="distanceFareValue">ZMW 5.00</span>
                    </div>
                    <div class="fare-row">
                        <span class="fare-label">Ride Type</span>
                        <span class="fare-value" id="rideTypeValue">Standard</span>
                    </div>
                    <div class="fare-row total">
                        <span class="fare-label">Total Fare</span>
                        <span class="fare-value" id="totalFareValue">ZMW 20.00</span>
                    </div>
                </div>
                
                <!-- Emergency Contact Display -->
                <div class="emergency-contact-display" id="emergencyContactDisplay" style="display: none;">
                    <div class="emergency-contact-header">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div class="emergency-contact-title">Emergency Contacts</div>
                    </div>
                    <div class="emergency-contact-item">
                        <div class="contact-info">
                            <div class="contact-name" id="emergencyContact1Name">Contact 1</div>
                            <div class="contact-phone" id="emergencyContact1Phone">000-000-0000</div>
                        </div>
                        <button class="contact-action-btn" id="emergencyContact1Btn">
                            <i class="fas fa-phone"></i>
                        </button>
                    </div>
                    <div class="emergency-contact-item">
                        <div class="contact-info">
                            <div class="contact-name" id="emergencyContact2Name">Contact 2</div>
                            <div class="contact-phone" id="emergencyContact2Phone">000-000-0000</div>
                        </div>
                        <button class="contact-action-btn" id="emergencyContact2Btn">
                            <i class="fas fa-phone"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Broadcast Feature -->
                <div class="broadcast-feature" id="broadcastFeature" style="display: none;">
                    <div class="broadcast-feature-header">
                        <div class="broadcast-feature-title">
                            <i class="fas fa-broadcast-tower"></i>
                            <span>Broadcast Ride</span>
                        </div>
                        <div class="broadcast-status-indicator inactive" id="broadcastStatusIndicator"></div>
                    </div>
                    <div class="broadcast-form">
                        <div class="broadcast-input-group">
                            <input type="text" id="broadcastMemberInput" placeholder="Enter friend's referral code">
                            <button class="broadcast-btn" id="addBroadcastMemberBtn">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div class="broadcast-recipients" id="broadcastMembersContainer">
                            <!-- Recipients will be inserted here -->
                        </div>
                        <button class="btn btn-secondary" id="startBroadcastBtn">
                            <i class="fas fa-play"></i>
                            Start Broadcasting
                        </button>
                    </div>
                </div>

                <!-- Share Ride Status -->
                <div class="share-ride-status" id="shareRideStatus" style="display: none;"></div>
                
                <div class="action-buttons">
                    <button class="btn btn-danger" id="cancelRideBtn">
                        <i class="fas fa-times-circle"></i>
                        Cancel Ride
                    </button>
                    <button class="btn btn-secondary" id="contactDriverBtn">
                        <i class="fas fa-phone"></i>
                        Call Driver
                    </button>
                    <button class="btn btn-secondary" id="openChatBtn">
                        <i class="fas fa-comment"></i>
                        Chat
                    </button>
                </div>
            </div>
            
            <!-- Broadcast Ride Form -->
            <div class="service-form" id="broadcastForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-broadcast-tower"></i>
                    Broadcast Ride
                </div>
                
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="broadcastPickup" placeholder="Pickup location" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="broadcastPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="broadcastDestination" placeholder="Destination" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="broadcastDestinationSuggestions"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Passenger Phone Numbers (comma separated)</label>
                    <textarea class="form-control form-textarea" id="broadcastPassengers" placeholder="Enter phone numbers of passengers to share this ride with..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Ride Type</label>
                    <select class="form-control" id="broadcastRideType">
                        <option value="standard">Standard</option>
                        <option value="economy">Economy</option>
                        <option value="premium">Premium</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Split Fare</label>
                    <select class="form-control" id="broadcastSplitType">
                        <option value="equal">Equal Split</option>
                        <option value="you_pay_more">You Pay 70%</option>
                        <option value="you_pay_all">You Pay All</option>
                    </select>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="broadcastFareDisplay" style="display: none;">
                    <div class="fare-label">Broadcast Fare</div>
                    <div class="fare-amount" id="broadcastFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="broadcastDistance">0 km</span>
                        <span id="broadcastTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="startBroadcastRideBtn">
                        <i class="fas fa-broadcast-tower"></i>
                        Start Broadcast
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- History Screen -->
    <div class="history-screen" id="historyScreen" style="display: none;">
        <div class="screen-header">
            <button class="back-btn" data-screen="home">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="screen-title">Ride History</div>
        </div>
        
        <div class="history-filters">
            <button class="filter-btn active" data-filter="all">All</button>
            <button class="filter-btn" data-filter="completed">Completed</button>
            <button class="filter-btn" data-filter="cancelled">Cancelled</button>
            <button class="filter-btn" data-filter="scheduled">Scheduled</button>
            <button class="filter-btn" data-filter="emergency">Emergency</button>
            <button class="filter-btn" data-filter="delivery">Delivery</button>
            <button class="filter-btn" data-filter="truck">Truck</button>
            <button class="filter-btn" data-filter="broadcast">Broadcast</button>
        </div>
        
        <div class="history-list" id="historyList">
            <!-- History items will be inserted here -->
        </div>
    </div>
    
    <!-- Account Screen -->
    <div class="account-screen" id="accountScreen" style="display: none;">
        <div class="screen-header">
            <button class="back-btn" data-screen="home">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="screen-title">My Account</div>
        </div>
        
        <div class="account-header">
            <div class="account-avatar" id="accountAvatar">
                <i class="fas fa-user"></i>
            </div>
            <div class="account-name" id="accountName">Loading...</div>
            <div class="account-phone" id="accountPhone">Loading...</div>
        </div>
        
        <div class="account-stats">
            <div class="stat-card">
                <div class="stat-value" id="completedRides">0</div>
                <div class="stat-label">Completed Rides</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="cancelledRides">0</div>
                <div class="stat-label">Cancelled Rides</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalSpent">ZMW 0</div>
                <div class="stat-label">Total Spent</div>
            </div>
        </div>
        
        <div class="account-section">
            <div class="section-title">
                <i class="fas fa-wallet"></i>
                Wallet Balance
            </div>
            
            <div class="wallet-balance">
                <div class="balance-label">Available Balance</div>
                <div class="balance-amount-large" id="accountBalance">ZMW 0.00</div>
            </div>
            
            <div class="wallet-actions">
                <button class="btn-wallet" id="depositBtn">
                    <i class="fas fa-plus"></i>
                    Deposit
                </button>
                <button class="btn-wallet" id="withdrawBtn">
                    <i class="fas fa-minus"></i>
                    Withdraw
                </button>
                <button class="btn-wallet" id="transferBtn">
                    <i class="fas fa-exchange-alt"></i>
                    Transfer
                </button>
                <button class="btn-wallet" id="transactionsBtn">
                    <i class="fas fa-history"></i>
                    History
                </button>
            </div>
        </div>
        
        <div class="account-section">
            <div class="section-title">
                <i class="fas fa-gift"></i>
                Referral Program
            </div>
            
            <div class="referral-card">
                <div>Share your referral code and earn ZMW 25 for each friend's first ride</div>
                <div class="referral-code" id="referralCode">JUBEL-XXXX</div>
                <button class="btn btn-primary" id="shareReferralBtn">
                    <i class="fas fa-share"></i>
                    Share Code
                </button>
                <div class="referral-note">Your friend gets 50% off their first ride</div>
            </div>
        </div>
        
        <div class="account-section">
            <div class="section-title">
                <i class="fas fa-cog"></i>
                Settings
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-secondary" id="updateProfileBtn">
                    <i class="fas fa-user-edit"></i>
                    Update Profile
                </button>
                <button class="btn btn-secondary" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </button>
            </div>
        </div>
    </div>
    
    <!-- Emergency Screen -->
    <div class="emergency-screen" id="emergencyScreen" style="display: none;">
        <div class="screen-header">
            <button class="back-btn" data-screen="home">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="screen-title">Emergency Services</div>
        </div>
        
        <div class="emergency-services">
            <div class="emergency-service police" data-type="police">
                <div class="emergency-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <div class="emergency-name">Police Ride</div>
                <div class="emergency-description">Emergency transport with police escort</div>
            </div>
            
            <div class="emergency-service fire" data-type="fire">
                <div class="emergency-icon">
                    <i class="fas fa-fire-extinguisher"></i>
                </div>
                <div class="emergency-name">Fire Brigade</div>
                <div class="emergency-description">Fire emergency response team</div>
            </div>
            
            <div class="emergency-service medical" data-type="medical">
                <div class="emergency-icon">
                    <i class="fas fa-ambulance"></i>
                </div>
                <div class="emergency-name">Hospital Ride</div>
                <div class="emergency-description">Medical emergency transport</div>
            </div>
            
            <div class="emergency-service" data-type="sos">
                <div class="emergency-icon" style="background: var(--error-red);">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="emergency-name">SOS Emergency</div>
                <div class="emergency-description">Immediate emergency assistance</div>
            </div>
        </div>
        
        <div class="emergency-note">
            <p><strong>Important:</strong> Only use emergency services for genuine emergencies. Misuse may result in penalties. In case of immediate danger, call 911 first.</p>
        </div>
    </div>
    
    <!-- Modals -->
    
    <!-- Payment Modal -->
    <div class="modal-overlay" id="paymentModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-credit-card"></i>
                    Select Payment Method
                </div>
                <button class="modal-close" data-modal="payment">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <div class="form-label">Available Balance: <span id="paymentBalance">ZMW 0.00</span></div>
                    <div class="form-label">Total Amount: <span id="paymentAmount">ZMW 0.00</span></div>
                </div>
                
                <!-- Referral Discount Section -->
                <div class="referral-discount-section" id="referralDiscountSection" style="display: none;">
                    <div class="section-header">
                        <i class="fas fa-gift"></i>
                        <span>Referral Discount (50% off)</span>
                    </div>
                    <div class="referral-input-group">
                        <input type="text" id="referralCodeInput" placeholder="Enter referral code">
                        <button id="applyReferralBtn" class="btn btn-orange">
                            <i class="fas fa-check"></i> Apply
                        </button>
                    </div>
                    <div id="referrerInfo" style="display: none; font-size: 12px; color: var(--success-green); margin-top: 5px;"></div>
                    <div class="discount-breakdown" style="margin-top: 10px;">
                        <div class="price-row">
                            <span>Original Fare:</span>
                            <span id="originalFareAmount">ZMW 0.00</span>
                        </div>
                        <div class="price-row">
                            <span>Discount:</span>
                            <span id="discountAmount" style="color: var(--success-green);">-ZMW 0.00</span>
                        </div>
                        <div class="price-row total">
                            <span>Final Fare:</span>
                            <span id="finalFareAmount" style="font-weight: bold;">ZMW 0.00</span>
                        </div>
                    </div>
                </div>
                
                <div class="payment-methods">
                    <div class="payment-method" data-payment="wallet">
                        <div class="payment-icon">
                            <i class="fas fa-wallet"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Jubel Wallet</div>
                            <div class="payment-info">Pay with your wallet balance</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-payment="mobile">
                        <div class="payment-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Mobile Money</div>
                            <div class="payment-info">Pay via MTN/Zamtel/Airtel</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-payment="cash">
                        <div class="payment-icon">
                            <i class="fas fa-money-bill"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Cash</div>
                            <div class="payment-info">Pay driver directly</div>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmPaymentBtn">
                        <i class="fas fa-check"></i>
                        Confirm Payment
                    </button>
                    <button class="btn btn-secondary" data-modal="payment">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Cancel Ride Modal -->
    <div class="modal-overlay" id="cancelModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-times-circle"></i>
                    Cancel Ride
                </div>
                <button class="modal-close" data-modal="cancel">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <div class="form-label">Please select a reason for cancellation:</div>
                </div>
                
                <div class="cancel-reasons">
                    <div class="cancel-reason" data-reason="driver_late">
                        <div class="reason-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="reason-text">Driver is taking too long</div>
                    </div>
                    
                    <div class="cancel-reason" data-reason="change_plans">
                        <div class="reason-icon">
                            <i class="fas fa-calendar-times"></i>
                        </div>
                        <div class="reason-text">Change of plans</div>
                    </div>
                    
                    <div class="cancel-reason" data-reason="found_alternative">
                        <div class="reason-icon">
                            <i class="fas fa-car"></i>
                        </div>
                        <div class="reason-text">Found alternative transport</div>
                    </div>
                    
                    <div class="cancel-reason" data-reason="emergency">
                        <div class="reason-icon">
                            <i class="fas fa-exclamation"></i>
                        </div>
                        <div class="reason-text">Emergency situation</div>
                    </div>
                    
                    <div class="cancel-reason" data-reason="other">
                        <div class="reason-icon">
                            <i class="fas fa-ellipsis-h"></i>
                        </div>
                        <div class="reason-text">Other reason</div>
                    </div>
                </div>
                
                <div class="form-group" id="otherReasonGroup" style="display: none;">
                    <label class="form-label">Please specify:</label>
                    <textarea class="form-control form-textarea" id="otherReason" placeholder="Enter your reason here..."></textarea>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-danger" id="confirmCancelBtn">
                        <i class="fas fa-times"></i>
                        Cancel Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="cancel">
                        Go Back
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Emergency Ride Modal -->
    <div class="modal-overlay" id="emergencyModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-ambulance"></i>
                    Emergency Ride Details
                </div>
                <button class="modal-close" data-modal="emergency">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content emergency-modal-content">
                <div class="form-group">
                    <div class="form-label" id="emergencyServiceType">Police Ride</div>
                </div>
                
                <!-- Emergency Reasons -->
                <div class="form-group">
                    <label class="form-label">Select Emergency Reason</label>
                    <div class="emergency-reasons">
                        <div class="emergency-reason" data-reason="accident">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-car-crash"></i>
                            </div>
                            <div class="emergency-reason-text">Accident</div>
                        </div>
                        
                        <div class="emergency-reason" data-reason="medical">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-heartbeat"></i>
                            </div>
                            <div class="emergency-reason-text">Medical Emergency</div>
                        </div>
                        
                        <div class="emergency-reason" data-reason="crime">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="emergency-reason-text">Crime/Assault</div>
                        </div>
                        
                        <div class="emergency-reason" data-reason="fire">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-fire"></i>
                            </div>
                            <div class="emergency-reason-text">Fire Emergency</div>
                        </div>
                        
                        <div class="emergency-reason" data-reason="other">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="emergency-reason-text">Other Emergency</div>
                        </div>
                    </div>
                    
                    <div class="emergency-reason-input" id="emergencyReasonOther" style="display: none;">
                        <label class="form-label">Please describe the emergency:</label>
                        <textarea class="form-control form-textarea" id="emergencyOtherReason" placeholder="Describe the emergency situation..."></textarea>
                    </div>
                </div>
                
                <!-- Location Inputs -->
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="emergencyPickup" placeholder="Pickup location" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="emergencyPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="emergencyDestination" placeholder="Destination" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="emergencyDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Emergency Stations -->
                <div class="form-group">
                    <label class="form-label">Select Nearest Emergency Station</label>
                    <div class="emergency-stations" id="emergencyStations">
                        <!-- Stations will be inserted here -->
                    </div>
                </div>
                
                <!-- User Location Details -->
                <div class="location-details">
                    <div class="location-detail-item">
                        <div class="location-detail-icon">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="location-detail-content">
                            <div class="location-detail-label">Your Location</div>
                            <div class="location-detail-value" id="emergencyUserLocation">Detecting location...</div>
                        </div>
                    </div>
                </div>
                
                <!-- Price Calculation -->
                <div class="price-calculation">
                    <div class="calculation-row">
                        <span>Base Emergency Fare:</span>
                        <span id="emergencyBaseFare">ZMW 100.00</span>
                    </div>
                    <div class="calculation-row">
                        <span>Distance to Service:</span>
                        <span id="emergencyDistance">0 km</span>
                    </div>
                    <div class="calculation-row">
                        <span>Estimated Time:</span>
                        <span id="emergencyTime">5 min</span>
                    </div>
                    <div class="calculation-row total">
                        <span>Total Fare:</span>
                        <span id="emergencyTotalFare">ZMW 100.00</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-danger" id="confirmEmergencyBtn">
                        <i class="fas fa-exclamation-triangle"></i>
                        Request Emergency Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="emergency">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- SOS Setup Modal -->
    <div class="modal-overlay" id="sosModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    SOS Emergency Setup
                </div>
                <button class="modal-close" data-modal="sos">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <label class="form-label">Primary Emergency Contact</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="sosContact1Name" placeholder="Contact name">
                        <input type="tel" class="form-control" id="sosContact1Phone" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Secondary Emergency Contact (Optional)</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="sosContact2Name" placeholder="Contact name">
                        <input type="tel" class="form-control" id="sosContact2Phone" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Emergency Message</label>
                    <textarea class="form-control form-textarea" id="sosMessage">
I need help! My current location and ride details will be shared with you.
                    </textarea>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="saveSOSBtn">
                        <i class="fas fa-save"></i>
                        Save SOS Setup
                    </button>
                    <button class="btn btn-secondary" data-modal="sos">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Transfer Money Modal -->
    <div class="modal-overlay" id="transferModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-exchange-alt"></i>
                    Transfer Money
                </div>
                <button class="modal-close" data-modal="transfer">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <div class="form-label">Available Balance: <span id="transferBalance">ZMW 0.00</span></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Recipient's Referral Code</label>
                    <input type="text" class="form-control" id="recipientCode" placeholder="Enter recipient's Jubel referral code">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Amount (ZMW)</label>
                    <input type="number" class="form-control" id="transferAmount" placeholder="Enter amount" min="1" step="0.01">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Message (Optional)</label>
                    <input type="text" class="form-control" id="transferMessage" placeholder="Add a message">
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmTransferBtn">
                        <i class="fas fa-paper-plane"></i>
                        Send Money
                    </button>
                    <button class="btn btn-secondary" data-modal="transfer">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Wallet Transactions Modal -->
    <div class="modal-overlay" id="transactionsModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-history"></i>
                    Wallet Transactions
                </div>
                <button class="modal-close" data-modal="transactions">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div id="transactionsList">
                    <!-- Transactions will be inserted here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Schedule Ride Modal -->
    <div class="modal-overlay" id="scheduleModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-calendar-alt"></i>
                    Schedule a Ride
                </div>
                <button class="modal-close" data-modal="schedule">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="schedulePickup" placeholder="Pickup location">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="schedulePickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="scheduleDestination" placeholder="Destination">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="scheduleDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- For Someone Else -->
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="scheduleForSomeone">
                        <span style="margin-left: 8px;">Booking for someone else</span>
                    </label>
                </div>
                
                <div class="form-group" id="someoneElseDetails" style="display: none;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="recipientName" placeholder="Recipient name">
                        <input type="tel" class="form-control" id="recipientPhone" placeholder="Recipient phone">
                    </div>
                </div>
                
                <div class="schedule-grid">
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-control" id="scheduleDate" min="">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Time</label>
                        <input type="time" class="form-control" id="scheduleTime">
                    </div>
                </div>
                
                <!-- Ride Type Selection for Schedule -->
                <div class="ride-type-selection" style="margin: 0 0 16px 0;">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                    </div>
                    <div class="ride-type-grid" id="scheduleRideTypeGrid">
                        <div class="ride-type-card economy" data-type="economy">
                            <div class="ride-type-icon">
                                <i class="fas fa-car-side"></i>
                            </div>
                            <div class="ride-type-name">Economy</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card selected" data-type="standard">
                            <div class="ride-type-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="ride-type-name">Standard</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card premium" data-type="premium">
                            <div class="ride-type-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="ride-type-name">Premium</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="scheduleFareDisplay" style="display: none;">
                    <div class="fare-label">Scheduled Ride Fare</div>
                    <div class="fare-amount" id="scheduleFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="scheduleDistance">0 km</span>
                        <span id="scheduleTimeEstimate">ETA: 0 min</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmScheduleBtn">
                        <i class="fas fa-calendar-check"></i>
                        Schedule Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="schedule">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Order for Someone Modal -->
    <div class="modal-overlay" id="orderForSomeoneModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-user-friends"></i>
                    Order for Someone Else
                </div>
                <button class="modal-close" data-modal="orderForSomeone">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="someonePickup" placeholder="Pickup location">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="someonePickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="someoneDestination" placeholder="Destination">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="someoneDestinationSuggestions"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Recipient Details</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="someoneName" placeholder="Full name">
                        <input type="tel" class="form-control" id="someonePhone" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Special Instructions (Optional)</label>
                    <textarea class="form-control form-textarea" id="someoneInstructions" placeholder="Any instructions for the driver..."></textarea>
                </div>
                
                <!-- Ride Type Selection -->
                <div class="ride-type-selection" style="margin: 0 0 16px 0;">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                    </div>
                    <div class="ride-type-grid" id="someoneRideTypeGrid">
                        <div class="ride-type-card economy" data-type="economy">
                            <div class="ride-type-icon">
                                <i class="fas fa-car-side"></i>
                            </div>
                            <div class="ride-type-name">Economy</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card selected" data-type="standard">
                            <div class="ride-type-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="ride-type-name">Standard</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card premium" data-type="premium">
                            <div class="ride-type-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="ride-type-name">Premium</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="someoneFareDisplay" style="display: none;">
                    <div class="fare-label">Estimated Fare</div>
                    <div class="fare-amount" id="someoneFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="someoneDistance">0 km</span>
                        <span id="someoneTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmSomeoneRideBtn">
                        <i class="fas fa-car"></i>
                        Request Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="orderForSomeone">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Share Ride Modal -->
    <div class="modal-overlay" id="shareRideModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-share-alt"></i>
                    Share Ride
                </div>
                <button class="modal-close" data-modal="shareRide">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="sharePickup" placeholder="Pickup location">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="sharePickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="shareDestination" placeholder="Destination">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shareDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Share Members Input -->
                <div class="form-group">
                    <label class="form-label">Add Friends by Referral Code</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" class="form-control" id="shareMemberInput" placeholder="Enter friend's referral code">
                        <button class="btn btn-secondary" id="addShareMemberBtn">
                            <i class="fas fa-plus"></i> Add
                        </button>
                    </div>
                </div>
                
                <!-- Share Members List -->
                <div class="form-group">
                    <div id="shareFriendsList" class="share-friends-list">
                        <!-- Share members will be inserted here -->
                    </div>
                </div>
                
                <!-- Share Calculations -->
                <div class="form-group" id="shareCalculations" style="display: none;">
                    <!-- Calculations will be inserted here -->
                </div>
                
                <!-- Ride Type Selection -->
                <div class="ride-type-selection" style="margin: 0 0 16px 0;">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                    </div>
                    <div class="ride-type-grid" id="shareRideTypeGrid">
                        <div class="ride-type-card economy" data-type="economy">
                            <div class="ride-type-icon">
                                <i class="fas fa-car-side"></i>
                            </div>
                            <div class="ride-type-name">Economy</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card selected" data-type="standard">
                            <div class="ride-type-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="ride-type-name">Standard</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card premium" data-type="premium">
                            <div class="ride-type-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="ride-type-name">Premium</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Estimated Fare: <span id="shareFareEstimate">ZMW 0.00</span></label>
                    <div class="price-calculation">
                        <div class="calculation-row">
                            <span>Your Share:</span>
                            <span id="yourShare">ZMW 0.00</span>
                        </div>
                        <div class="calculation-row">
                            <span>Friend's Share:</span>
                            <span id="friendShare">ZMW 0.00</span>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmShareRideBtn">
                        <i class="fas fa-user-friends"></i>
                        Share Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="shareRide">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Share Ride Invitation Modal -->
    <div class="modal-overlay" id="shareRideInvitationModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-users"></i>
                    Share Ride Invitation
                </div>
                <button class="modal-close" data-modal="shareRideInvitation">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="invitation-details" id="invitationDetails">
                    <!-- Invitation details will be inserted here -->
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" id="acceptShareInvitationBtn">
                        <i class="fas fa-check"></i>
                        Accept Invitation
                    </button>
                    <button class="btn btn-secondary" id="rejectShareInvitationBtn">
                        <i class="fas fa-times"></i>
                        Decline
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Update Profile Modal -->
    <div class="modal-overlay" id="updateProfileModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-user-edit"></i>
                    Update Profile
                </div>
                <button class="modal-close" data-modal="updateProfile">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <input type="text" class="form-control" id="updateName" placeholder="Your full name">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Phone Number</label>
                    <input type="tel" class="form-control" id="updatePhone" placeholder="Your phone number">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" class="form-control" id="updateEmail" placeholder="Your email address" readonly>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Home Address (Optional)</label>
                    <input type="text" class="form-control" id="updateHomeAddress" placeholder="Your home address">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Work Address (Optional)</label>
                    <input type="text" class="form-control" id="updateWorkAddress" placeholder="Your work address">
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="saveProfileBtn">
                        <i class="fas fa-save"></i>
                        Save Changes
                    </button>
                    <button class="btn btn-secondary" data-modal="updateProfile">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Loading...</div>
    </div>
    
    <!-- Search Loading Overlay -->
    <div id="searchLoading" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); z-index: 10000;">
        <i class="fas fa-spinner fa-spin"></i> Searching...
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Real-time Indicator -->
    <div class="real-time-indicator" id="realTimeIndicator">
        <i class="fas fa-sync-alt"></i>
        <span>Real-time updates active</span>
    </div>
    
    <!-- Sync Indicator -->
    <div class="sync-indicator" id="syncIndicator">
        <i class="fas fa-sync-alt sync-icon"></i>
        <span>Syncing...</span>
    </div>
    
    <!-- Schedule Countdown -->
    <div id="scheduleCountdown" style="display: none;"></div>
    
    <!-- External JavaScript Libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>             
    <script>
// ============================================
// FIREBASE CONFIGURATION AND INITIALIZATION
// ============================================
const firebaseConfig = {
    apiKey: "AIzaSyDEACX_P4c5q7djJAcA0I7Lk7leO2TlQ74",
    authDomain: "jubel-13e1a.firebaseapp.com",
    databaseURL: "https://jubel-13e1a-default-rtdb.firebaseio.com",
    projectId: "jubel-13e1a",
    storageBucket: "jubel-13e1a.firebasestorage.app",
    messagingSenderId: "882241095445",
    appId: "1:882241095445:web:ee9ca40fddd008ca910b1c",
    measurementId: "G-J5JPKL6B5F"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const auth = firebase.auth();
const storage = firebase.storage();

// ============================================
// ENHANCED GLOBAL STATE MANAGEMENT
// ============================================
const AppState = {
    currentUser: null,
    userData: null,
    currentRide: null,
    activeScreen: 'home',
    activeService: 'car',
    walletBalance: 0,
    userLocation: null,
    currentCity: null,
    selectedRideType: 'standard',
    selectedVehicle: null,
    destination: null,
    pickup: null,
    rideFare: 0,
    driverLocation: null,
    chatMessages: [],
    scheduledRides: [],
    emergencyMode: false,
    sosConfig: null,
    searchCache: new Map(),
    lastSearchTime: 0,
    notifications: [],
    unreadNotifications: 0,
    searchHistory: [],
    broadcastRecipients: [],
    emergencyStations: {
        police: [],
        fire: [],
        medical: []
    },
    realtimeListeners: [],
    rideTypes: {
        economy: { base: 15, perKm: 2.5, multiplier: 0.8, min: 10, icon: 'fa-car-side', name: 'Economy' },
        standard: { base: 20, perKm: 3.0, multiplier: 1.0, min: 15, icon: 'fa-car', name: 'Standard' },
        premium: { base: 30, perKm: 4.0, multiplier: 1.5, min: 25, icon: 'fa-crown', name: 'Premium' }
    },
    emergencyServices: {
        police: { base: 150, perKm: 5.0, multiplier: 2.0, min: 100, icon: 'fa-shield-alt' },
        fire: { base: 200, perKm: 6.0, multiplier: 2.5, min: 150, icon: 'fa-fire-extinguisher' },
        medical: { base: 180, perKm: 5.5, multiplier: 2.2, min: 120, icon: 'fa-ambulance' }
    },
    deliveryTypes: {
        standard: { base: 25, perKm: 2.0, multiplier: 1.0 },
        express: { base: 40, perKm: 3.0, multiplier: 1.5 },
        sameDay: { base: 60, perKm: 4.0, multiplier: 2.0 }
    },
    truckTypes: {
        pickup: { base: 80, perKm: 5.0, multiplier: 1.0, capacity: '1.5 tons', icon: 'fa-truck-pickup' },
        light: { base: 120, perKm: 6.0, multiplier: 1.2, capacity: '3 tons', icon: 'fa-truck-moving' },
        medium: { base: 200, perKm: 8.0, multiplier: 1.5, capacity: '7 tons', icon: 'fa-truck' },
        heavy: { base: 350, perKm: 12.0, multiplier: 2.0, capacity: '15 tons', icon: 'fa-truck-loading' }
    },
    shoppingCategories: {
        restaurant: { 
            name: 'Restaurants',
            icon: 'fa-utensils',
            brands: ['Pizza', 'Nando\'s', 'Hungry Lion'],
            type: 'restaurant'
        },
        pharmacy: {
            name: 'Pharmacies',
            icon: 'fa-pills',
            brands: ['Medicine', 'Pharmacy', 'Drugstore'],
            type: 'pharmacy'
        },
        supermarket: {
            name: 'Supermarkets',
            icon: 'fa-shopping-cart',
            brands: ['Shoprite', 'Pick n Pay', 'Spar'],
            type: 'supermarket'
        },
        mall: {
            name: 'Shopping Malls',
            icon: 'fa-store',
            brands: ['Mall', 'Shopping Centre', 'Plaza'],
            type: 'mall'
        }
    },
    lastPriceUpdate: 0,
    cityDetectionAttempts: 0,
    maxCityDetectionAttempts: 5,
    isSyncing: false,
    syncInterval: null,
    emergencyReason: null,
    selectedEmergencyStation: null,
    activeBroadcast: null,
    typingTimeout: null,
    driverTyping: false,
    locationManagement: {
        isEditingPickup: false,
        currentPickupInputId: null,
        pickupSearchResults: [],
        cityBounds: null,
        cityPolygon: null,
        userDetectedAddress: null
    },
    activeScheduledTimer: null,
    rideRequestPulsingIcons: {
        car: null,
        bike: null,
        truck: null
    },
    shareRideFriends: [],
    maxShareFriends: 3,
    routeDirections: null,
    pendingRideData: null,
    referralDiscountApplied: false,
    referralCodeUsed: null,
    referralOwnerName: null,
    shareRideInvitations: new Map(),
    broadcastInvitations: new Map(),
    paymentPendingMembers: new Set(),
    rideSplitDetails: null,
    activeRoute: null,
    activeFilter: 'all',
    lastSearchQuery: null,
    chatOpen: false,
    notificationsOpen: false,
    mapInitialized: false,
    rideStops: [],
    maxStops: 3,
    shoppingCart: [],
    splitRideMembers: [],
    activeSplitRide: null,
    broadcastMembers: [],
    activeNotifications: [],
    walletTransactions: [],
    emergencyContacts: [],
    realtimeUpdateInterval: null,
    locationWatchId: null,
    isAppInBackground: false,
    lastActivityTime: Date.now(),
    unhandledNotifications: [],
    pendingActions: [],
    activePaymentSession: null,
    rideTrackingData: {
        routePolyline: null,
        distanceTraveled: 0,
        lastUpdate: null,
        etaUpdates: []
    },
    shoppingSession: {
        selectedShop: null,
        items: [],
        totalBudget: 0,
        deliveryAddress: null
    },
    splitRideSession: {
        hostId: null,
        participants: [],
        fareDistribution: {},
        paymentStatus: {}
    },
    broadcastSession: {
        hostId: null,
        recipients: [],
        trackingEnabled: true,
        notificationsSent: false
    },
    emergencySession: {
        active: false,
        type: null,
        stationId: null,
        reason: null,
        timestamp: null
    }
};

// ============================================
// ENHANCED MAP MANAGEMENT
// ============================================
let map = null;
let currentLocationMarker = null;
let pickupMarker = null;
let destinationMarker = null;
let driverMarker = null;
let routeLayer = null;
let emergencyMarkers = [];
let emergencyStationMarkers = [];
let cityBoundaryLayer = null;
let routePolyline = null;
let pulsingIcon = null;
let stopMarkers = [];
let shoppingMarkers = [];

// ============================================
// REAL-TIME LOCATION TRACKER
// ============================================
const RealTimeLocationTracker = {
    watchId: null,
    lastUpdate: null,
    updateInterval: 5000,
    highAccuracy: true,
    
    init: function() {
        console.log('Real-time location tracker initialized');
        this.startTracking();
    },
    
    startTracking: function() {
        if (!navigator.geolocation) {
            console.warn('Geolocation not supported');
            return;
        }
        
        const options = {
            enableHighAccuracy: this.highAccuracy,
            timeout: 10000,
            maximumAge: 0
        };
        
        this.watchId = navigator.geolocation.watchPosition(
            this.onPositionUpdate.bind(this),
            this.onPositionError.bind(this),
            options
        );
        
        console.log('Started real-time location tracking');
    },
    
    onPositionUpdate: function(position) {
        const { latitude, longitude } = position.coords;
        const accuracy = position.coords.accuracy;
        const timestamp = position.timestamp;
        
        AppState.userLocation = {
            lat: latitude,
            lng: longitude,
            accuracy: accuracy,
            timestamp: timestamp
        };
        
        this.lastUpdate = Date.now();
        
        // Update map marker
        if (currentLocationMarker && map) {
            currentLocationMarker.setLatLng([latitude, longitude]);
        }
        
        // Update user location in Firebase if logged in
        if (AppState.currentUser) {
            this.updateUserLocationInFirebase(latitude, longitude);
        }
        
        // Auto-detect city on first location
        if (!AppState.currentCity && AppState.cityDetectionAttempts < 3) {
            this.detectCityFromLocation(latitude, longitude);
        }
        
        // Check proximity to destination if active ride
        if (AppState.currentRide && AppState.destination) {
            this.checkProximityToDestination(latitude, longitude);
        }
        
        console.log(`Location updated: ${latitude.toFixed(6)}, ${longitude.toFixed(6)}`);
    },
    
    updateUserLocationInFirebase: async function(lat, lng) {
        try {
            if (!AppState.currentUser) return;
            
            const userLocationRef = database.ref(`userLocations/${AppState.currentUser.uid}`);
            await userLocationRef.set({
                latitude: lat,
                longitude: lng,
                timestamp: Date.now(),
                accuracy: AppState.userLocation.accuracy || 50
            });
        } catch (error) {
            console.error('Error updating location in Firebase:', error);
        }
    },
    
    detectCityFromLocation: async function(lat, lng) {
        try {
            AppState.cityDetectionAttempts++;
            
            const response = await fetch(
                `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=10&addressdetails=1`
            );
            
            if (response.ok) {
                const data = await response.json();
                const address = data.address;
                
                if (address) {
                    const city = address.city || address.town || address.village || address.municipality;
                    const state = address.state || address.region;
                    
                    if (city && state === 'Lusaka Province') {
                        AppState.currentCity = 'Lusaka';
                        EnhancedUIUpdater.updateCityDisplay('Lusaka');
                        this.loadCityBoundaries('Lusaka');
                        return;
                    }
                    
                    // Add other Zambian city detection logic
                    const zambianCities = ['Lusaka', 'Ndola', 'Kitwe', 'Kabwe', 'Livingstone', 'Chipata', 'Chingola', 'Mufulira', 'Luanshya'];
                    for (const cityName of zambianCities) {
                        if (address.city?.includes(cityName) || address.town?.includes(cityName) || 
                            address.village?.includes(cityName) || address.municipality?.includes(cityName)) {
                            AppState.currentCity = cityName;
                            EnhancedUIUpdater.updateCityDisplay(cityName);
                            this.loadCityBoundaries(cityName);
                            return;
                        }
                    }
                }
            }
            
            // If still no city detected, try geocoding with more specific parameters
            if (!AppState.currentCity && AppState.cityDetectionAttempts < 3) {
                setTimeout(() => {
                    this.detectCityFromLocation(lat, lng);
                }, 1000);
            }
        } catch (error) {
            console.error('City detection error:', error);
        }
    },
    
    loadCityBoundaries: function(cityName) {
        const cityBounds = {
            'Lusaka': [[-15.8, 27.8], [-15.2, 28.8]],
            'Ndola': [[-13.1, 28.5], [-12.9, 28.8]],
            'Kitwe': [[-13.1, 27.9], [-12.7, 28.4]],
            'Kabwe': [[-14.6, 28.3], [-14.3, 28.6]],
            'Livingstone': [[-18.0, 25.7], [-17.7, 26.0]],
            'Chipata': [[-13.8, 32.5], [-13.6, 32.8]],
            'Chingola': [[-12.8, 27.8], [-12.4, 27.9]],
            'Mufulira': [[-12.7, 28.1], [-12.5, 28.3]],
            'Luanshya': [[-13.2, 28.3], [-13.0, 28.5]]
        };
        
        if (cityBounds[cityName] && map) {
            const bounds = cityBounds[cityName];
            const polygon = L.rectangle(bounds, {
                color: '#FF6B35',
                weight: 2,
                opacity: 0.3,
                fillOpacity: 0.1,
                fillColor: '#FF6B35'
            }).addTo(map);
            
            polygon.bindTooltip(`City Boundary: ${cityName}`);
            AppState.locationManagement.cityBounds = bounds;
            AppState.locationManagement.cityPolygon = polygon;
            
            console.log(`City boundary loaded for ${cityName}`);
        }
    },
    
    checkProximityToDestination: function(lat, lng) {
        if (!AppState.currentRide || !AppState.destination) return;
        
        const distance = EnhancedSearchEngine.calculateDistance(
            lat, lng,
            AppState.destination.lat, AppState.destination.lng
        );
        
        if (distance < 0.1) { // Within 100 meters
            if (AppState.currentRide.status === 'started') {
                EnhancedFirebaseManager.completeRide(AppState.currentRide.id);
            }
        }
    },
    
    onPositionError: function(error) {
        console.error('Geolocation error:', error);
        
        switch(error.code) {
            case error.PERMISSION_DENIED:
                EnhancedUIUpdater.showToast('Location access denied. Please enable location services.', 'error');
                break;
            case error.POSITION_UNAVAILABLE:
                EnhancedUIUpdater.showToast('Location information unavailable.', 'warning');
                break;
            case error.TIMEOUT:
                EnhancedUIUpdater.showToast('Location request timeout.', 'warning');
                break;
        }
    },
    
    stopTracking: function() {
        if (this.watchId !== null) {
            navigator.geolocation.clearWatch(this.watchId);
            this.watchId = null;
            console.log('Stopped real-time location tracking');
        }
    },
    
    getCurrentLocation: function() {
        return new Promise((resolve, reject) => {
            if (!navigator.geolocation) {
                reject(new Error('Geolocation not supported'));
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    resolve({ lat: latitude, lng: longitude });
                },
                (error) => {
                    reject(error);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        });
    },
    
    calculateBearing: function(lat1, lon1, lat2, lon2) {
        const toRad = (value) => value * Math.PI / 180;
        const toDeg = (value) => value * 180 / Math.PI;
        
        const 1 = toRad(lat1);
        const 2 = toRad(lat2);
        const  = toRad(lon2 - lon1);
        
        const y = Math.sin() * Math.cos(2);
        const x = Math.cos(1) * Math.sin(2) - Math.sin(1) * Math.cos(2) * Math.cos();
        const  = Math.atan2(y, x);
        
        return (toDeg() + 360) % 360;
    }
};

// ============================================
// ENHANCED SEARCH ENGINE WITH REAL-TIME UPDATES
// ============================================
const EnhancedSearchEngine = {
    cache: new Map(),
    lastSearch: 0,
    debounceTimer: null,
    searchHistory: [],
    maxHistoryItems: 20,
    activeSearches: new Set(),
    currentCityBounds: null,
    searchProviders: ['nominatim', 'photon'],
    currentProviderIndex: 0,
    
    init: function() {
        console.log('Enhanced Search Engine initialized');
        this.loadSearchHistory();
        this.setupSearchListeners();
    },
    
    loadSearchHistory: function() {
        try {
            const history = localStorage.getItem('jubel_search_history');
            if (history) {
                this.searchHistory = JSON.parse(history);
                console.log(`Loaded ${this.searchHistory.length} search history items`);
            }
        } catch (error) {
            console.error('Error loading search history:', error);
            this.searchHistory = [];
        }
    },
    
    saveSearchHistory: function() {
        try {
            localStorage.setItem('jubel_search_history', JSON.stringify(this.searchHistory));
        } catch (error) {
            console.error('Error saving search history:', error);
        }
    },
    
    setupSearchListeners: function() {
        // Setup real-time search for all input fields
        const searchInputs = [
            'destinationLocation', 'deliveryDestination', 'shortDeliveryDestination',
            'truckDestination', 'scheduleDestination', 'someoneDestination',
            'shareDestination', 'broadcastDestination', 'shoppingDestination',
            'emergencyDestination', 'shopName', 'someonePickup', 'sharePickup'
        ];
        
        searchInputs.forEach(inputId => {
            const input = document.getElementById(inputId);
            if (input) {
                input.addEventListener('input', (e) => {
                    this.handleRealTimeSearch(inputId, e.target.value);
                });
                
                input.addEventListener('focus', () => {
                    this.showSearchSuggestions(inputId, []);
                });
            }
        });
    },
    
    handleRealTimeSearch: function(inputId, query) {
        clearTimeout(this.debounceTimer);
        
        if (query.length < 2) {
            this.hideSearchSuggestions(inputId);
            return;
        }
        
        this.debounceTimer = setTimeout(async () => {
            await this.performSearch(inputId, query);
        }, 300);
    },
    
    async performSearch(inputId, query) {
        const searchId = `${Date.now()}-${Math.random()}`;
        this.activeSearches.add(searchId);
        
        try {
            if (!AppState.currentCity) {
                EnhancedUIUpdater.showToast('Detecting your city...', 'warning');
                return;
            }
            
            const cacheKey = `${query.toLowerCase()}-${inputId}-${AppState.currentCity}`;
            
            if (this.cache.has(cacheKey)) {
                const cached = this.cache.get(cacheKey);
                if (Date.now() - cached.timestamp < 300000) { // 5 minutes cache
                    this.showSearchSuggestions(inputId, cached.results);
                    return;
                }
            }
            
            const results = await this.searchMultiProvider(query, AppState.currentCity);
            
            this.cache.set(cacheKey, {
                results: results,
                timestamp: Date.now(),
                query: query
            });
            
            this.showSearchSuggestions(inputId, results);
            
            if (results.length > 0 && inputId.includes('destination')) {
                this.addToHistory(query, results[0], 'destination');
            }
            
        } catch (error) {
            console.error('Search error:', error);
            this.showSearchSuggestions(inputId, []);
        } finally {
            this.activeSearches.delete(searchId);
        }
    },
    
    async searchMultiProvider(query, city) {
        const providers = [
            this.searchNominatim.bind(this, query, city),
            this.searchPhoton.bind(this, query, city)
        ];
        
        for (const provider of providers) {
            try {
                const results = await provider();
                if (results.length > 0) {
                    return results;
                }
            } catch (error) {
                console.error('Provider error:', error);
                continue;
            }
        }
        
        return [];
    },
    
    async searchNominatim(query, city) {
        const bounds = this.getCityBounds(city);
        const params = new URLSearchParams({
            q: `${query}, ${city}, Zambia`,
            format: 'json',
            limit: 15,
            countrycodes: 'zm',
            'accept-language': 'en',
            addressdetails: 1
        });
        
        if (bounds) {
            params.append('viewbox', `${bounds[0][1]},${bounds[0][0]},${bounds[1][1]},${bounds[1][0]}`);
            params.append('bounded', '1');
        }
        
        const response = await fetch(`https://nominatim.openstreetmap.org/search?${params}`);
        
        if (!response.ok) {
            throw new Error(`Nominatim search failed: ${response.status}`);
        }
        
        const data = await response.json();
        return this.processSearchResults(data, city);
    },
    
    async searchPhoton(query, city) {
        const params = new URLSearchParams({
            q: `${query} ${city} Zambia`,
            limit: 10,
            lang: 'en'
        });
        
        const response = await fetch(`https://photon.komoot.io/api/?${params}`);
        
        if (!response.ok) {
            throw new Error(`Photon search failed: ${response.status}`);
        }
        
        const data = await response.json();
        return this.processPhotonResults(data.features || [], city);
    },
    
    processSearchResults(data, city) {
        if (!data || data.length === 0) return [];
        
        const cityLower = city.toLowerCase();
        const processedResults = [];
        
        data.forEach(place => {
            try {
                const address = place.address || {};
                const placeCity = address.city || address.town || address.village || address.municipality;
                
                if (city && !this.isInCity(place, cityLower, placeCity?.toLowerCase())) {
                    return;
                }
                
                const distance = AppState.userLocation ? 
                    this.calculateDistance(
                        AppState.userLocation.lat, AppState.userLocation.lng,
                        parseFloat(place.lat), parseFloat(place.lon)
                    ) : 0;
                
                const result = {
                    id: place.place_id || `${place.lat}-${place.lon}`,
                    name: place.display_name.split(',')[0] || place.name || 'Unnamed Location',
                    address: this.formatAddress(place, city),
                    fullAddress: place.display_name,
                    lat: parseFloat(place.lat),
                    lng: parseFloat(place.lon),
                    type: place.type || place.class || 'unknown',
                    importance: place.importance || 0,
                    distance: distance,
                    city: placeCity || city,
                    category: this.categorizePlace(place),
                    relevance: this.calculateRelevance(place, city),
                    isVerified: this.isVerifiedLocation(place),
                    boundingbox: place.boundingbox
                };
                
                processedResults.push(result);
            } catch (error) {
                console.error('Error processing result:', error);
            }
        });
        
        return processedResults
            .sort((a, b) => {
                if (a.isVerified !== b.isVerified) return b.isVerified - a.isVerified;
                if (a.relevance !== b.relevance) return b.relevance - a.relevance;
                if (a.distance !== b.distance) return a.distance - b.distance;
                return b.importance - a.importance;
            })
            .slice(0, 10);
    },
    
    processPhotonResults(features, city) {
        if (!features || features.length === 0) return [];
        
        const processedResults = [];
        
        features.forEach(feature => {
            try {
                const properties = feature.properties || {};
                const geometry = feature.geometry || {};
                
                if (!geometry.coordinates) return;
                
                const [lng, lat] = geometry.coordinates;
                const distance = AppState.userLocation ? 
                    this.calculateDistance(AppState.userLocation.lat, AppState.userLocation.lng, lat, lng) : 0;
                
                const result = {
                    id: properties.osm_id || `${lat}-${lng}`,
                    name: properties.name || 'Unnamed Location',
                    address: this.formatPhotonAddress(properties, city),
                    fullAddress: properties.name,
                    lat: lat,
                    lng: lng,
                    type: properties.osm_key || 'unknown',
                    importance: properties.importance || 0,
                    distance: distance,
                    city: properties.city || city,
                    category: this.categorizePhotonPlace(properties),
                    relevance: properties.importance || 0,
                    isVerified: properties.osm_key ? true : false
                };
                
                processedResults.push(result);
            } catch (error) {
                console.error('Error processing photon result:', error);
            }
        });
        
        return processedResults.sort((a, b) => b.relevance - a.relevance).slice(0, 10);
    },
    
    formatPhotonAddress(properties, city) {
        const parts = [];
        
        if (properties.housenumber) parts.push(properties.housenumber);
        if (properties.street) parts.push(properties.street);
        if (properties.district) parts.push(properties.district);
        if (properties.city && properties.city.toLowerCase() !== city.toLowerCase()) {
            parts.push(properties.city);
        }
        
        return parts.length > 0 ? parts.join(', ') : properties.name || 'Address not available';
    },
    
    categorizePhotonPlace(properties) {
        const type = properties.osm_key || '';
        
        if (type.includes('amenity')) {
            if (properties.osm_value === 'restaurant' || properties.osm_value === 'fast_food' || 
                properties.osm_value === 'cafe') {
                return 'restaurant';
            } else if (properties.osm_value === 'pharmacy' || properties.osm_value === 'hospital') {
                return 'pharmacy';
            } else if (properties.osm_value === 'supermarket' || properties.osm_value === 'shop') {
                return 'supermarket';
            } else if (properties.osm_value === 'mall') {
                return 'mall';
            }
        }
        
        return 'other';
    },
    
    isInCity: function(place, targetCity, placeCity) {
        if (!targetCity) return true;
        
        if (placeCity && placeCity.includes(targetCity)) {
            return true;
        }
        
        const address = place.address || {};
        const components = [
            address.city,
            address.town,
            address.village,
            address.municipality,
            address.county,
            address.state_district
        ].filter(Boolean);
        
        return components.some(component => 
            component.toLowerCase().includes(targetCity)
        );
    },
    
    calculateRelevance: function(place, city) {
        let score = place.importance || 0;
        
        const address = place.address || {};
        const placeCity = address.city || address.town || address.village;
        
        if (placeCity && placeCity.toLowerCase().includes(city.toLowerCase())) {
            score += 0.4;
        }
        
        if (AppState.userLocation) {
            const distance = this.calculateDistance(
                AppState.userLocation.lat, AppState.userLocation.lng,
                place.lat, place.lng
            );
            
            if (distance < 1) score += 0.3;
            else if (distance < 3) score += 0.2;
            else if (distance < 5) score += 0.1;
        }
        
        if (place.type === 'restaurant' || place.type === 'hotel' || 
            place.type === 'mall' || place.type === 'supermarket') {
            score += 0.2;
        }
        
        return Math.min(score, 1.0);
    },
    
    formatAddress: function(place, currentCity) {
        const address = place.address || {};
        const parts = [];
        
        if (address.house_number || address.housenumber) {
            parts.push(address.house_number || address.housenumber);
        }
        
        if (address.road) {
            parts.push(address.road);
        }
        
        if (address.suburb || address.neighbourhood) {
            parts.push(address.suburb || address.neighbourhood);
        }
        
        if (address.city || address.town) {
            const cityName = address.city || address.town;
            if (cityName.toLowerCase() !== currentCity.toLowerCase()) {
                parts.push(cityName);
            }
        }
        
        if (parts.length === 0) {
            return place.display_name.split(',').slice(0, 2).join(',').trim();
        }
        
        return parts.join(', ');
    },
    
    categorizePlace: function(place) {
        const type = place.type || place.class || '';
        
        if (type.includes('restaurant') || type.includes('cafe') || type.includes('fast_food')) {
            return 'restaurant';
        } else if (type.includes('pharmacy') || type.includes('chemist')) {
            return 'pharmacy';
        } else if (type.includes('supermarket') || type.includes('convenience')) {
            return 'supermarket';
        } else if (type.includes('mall') || type.includes('shopping_centre')) {
            return 'mall';
        } else if (type.includes('hotel') || type.includes('guest_house')) {
            return 'hotel';
        } else if (type.includes('bank') || type.includes('atm')) {
            return 'bank';
        } else if (type.includes('hospital') || type.includes('clinic')) {
            return 'medical';
        } else {
            return 'other';
        }
    },
    
    isVerifiedLocation: function(place) {
        const verifiedTypes = [
            'restaurant', 'hotel', 'mall', 'supermarket', 'bank', 'hospital',
            'clinic', 'pharmacy', 'school', 'university', 'government'
        ];
        
        const type = place.type || place.class || '';
        return verifiedTypes.some(verifiedType => type.includes(verifiedType));
    },
    
    calculateDistance: function(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = this.toRad(lat2 - lat1);
        const dLon = this.toRad(lon2 - lon1);
        const a = 
            Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(this.toRad(lat1)) * Math.cos(this.toRad(lat2)) * 
            Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    },
    
    toRad: function(value) {
        return value * Math.PI / 180;
    },
    
    getCityBounds: function(cityName) {
        const cityBounds = {
            'Lusaka': [[-15.8, 27.8], [-15.2, 28.8]],
            'Ndola': [[-13.1, 28.5], [-12.9, 28.8]],
            'Kitwe': [[-13.1, 27.9], [-12.7, 28.4]],
            'Kabwe': [[-14.6, 28.3], [-14.3, 28.6]],
            'Livingstone': [[-18.0, 25.7], [-17.7, 26.0]],
            'Chipata': [[-13.8, 32.5], [-13.6, 32.8]],
            'Chingola': [[-12.8, 27.8], [-12.4, 27.9]],
            'Mufulira': [[-12.7, 28.1], [-12.5, 28.3]],
            'Luanshya': [[-13.2, 28.3], [-13.0, 28.5]]
        };
        
        return cityBounds[cityName] || null;
    },
    
    showSearchSuggestions: function(inputId, results) {
        const container = document.getElementById(`${inputId}Suggestions`);
        if (!container) return;
        
        container.innerHTML = '';
        
        if (results.length === 0) {
            container.innerHTML = `
                <div class="no-results">
                    <i class="fas fa-search"></i>
                    <div>No results found in ${AppState.currentCity}</div>
                    <div style="font-size: 11px; color: #666; margin-top: 5px;">
                        Try a different search term
                    </div>
                </div>
            `;
        } else {
            results.forEach(result => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.dataset.lat = result.lat;
                item.dataset.lng = result.lng;
                item.dataset.address = result.address;
                item.dataset.name = result.name;
                
                let icon = 'fa-map-marker-alt';
                let iconColor = '#FF6B35';
                
                switch(result.category) {
                    case 'restaurant':
                        icon = 'fa-utensils';
                        iconColor = '#FFC107';
                        break;
                    case 'pharmacy':
                        icon = 'fa-pills';
                        iconColor = '#F44336';
                        break;
                    case 'supermarket':
                        icon = 'fa-shopping-cart';
                        iconColor = '#4CAF50';
                        break;
                    case 'mall':
                        icon = 'fa-store';
                        iconColor = '#9C27B0';
                        break;
                    case 'hotel':
                        icon = 'fa-hotel';
                        iconColor = '#2196F3';
                        break;
                    case 'medical':
                        icon = 'fa-hospital';
                        iconColor = '#F44336';
                        break;
                }
                
                item.innerHTML = `
                    <div class="suggestion-icon" style="color: ${iconColor}">
                        <i class="fas ${icon}"></i>
                    </div>
                    <div class="suggestion-details">
                        <div class="suggestion-name">${result.name}</div>
                        <div class="suggestion-address">${result.address}</div>
                        ${result.distance ? `<div class="suggestion-distance">${result.distance.toFixed(1)} km away</div>` : ''}
                        ${result.isVerified ? `<div class="suggestion-verified"><i class="fas fa-check-circle"></i> Verified</div>` : ''}
                    </div>
                `;
                
                item.addEventListener('click', () => {
                    this.selectLocation(inputId, result);
                });
                
                container.appendChild(item);
            });
            
            const cityNote = document.createElement('div');
            cityNote.className = 'city-search-note';
            cityNote.innerHTML = `
                <i class="fas fa-city"></i>
                <span>Searching within ${AppState.currentCity}</span>
            `;
            container.appendChild(cityNote);
        }
        
        container.style.display = 'block';
        this.positionSuggestionsContainer(inputId);
    },
    
    positionSuggestionsContainer: function(inputId) {
        const container = document.getElementById(`${inputId}Suggestions`);
        const input = document.getElementById(inputId);
        
        if (container && input) {
            const rect = input.getBoundingClientRect();
            container.style.top = `${rect.bottom + window.scrollY}px`;
            container.style.left = `${rect.left + window.scrollX}px`;
            container.style.width = `${rect.width}px`;
        }
    },
    
    hideSearchSuggestions: function(inputId) {
        const container = document.getElementById(`${inputId}Suggestions`);
        if (container) {
            container.style.display = 'none';
        }
    },
    
    selectLocation: function(inputId, location) {
        const input = document.getElementById(inputId);
        if (input) {
            input.value = location.name;
            input.dataset.lat = location.lat;
            input.dataset.lng = location.lng;
            input.dataset.address = location.address;
            
            // Update AppState based on input type
            if (inputId.includes('destination')) {
                AppState.destination = location;
                EnhancedUIUpdater.updateDestinationMarker(location);
                if (AppState.pickup) {
                    EnhancedRouteManager.drawRouteWithStops();
                    EnhancedPriceCalculator.calculateAllPrices();
                }
            } else if (inputId.includes('pickup') || inputId === 'shopName') {
                AppState.pickup = location;
                EnhancedUIUpdater.updatePickupMarker(location);
                if (AppState.destination) {
                    EnhancedRouteManager.drawRouteWithStops();
                    EnhancedPriceCalculator.calculateAllPrices();
                }
            }
            
            this.hideSearchSuggestions(inputId);
        }
    },
    
    addToHistory: function(query, location, type) {
        const historyItem = {
            query: query,
            location: location,
            type: type,
            timestamp: Date.now(),
            city: AppState.currentCity
        };
        
        // Remove duplicates
        this.searchHistory = this.searchHistory.filter(item => 
            !(item.query === query && item.type === type && item.city === AppState.currentCity)
        );
        
        this.searchHistory.unshift(historyItem);
        
        if (this.searchHistory.length > this.maxHistoryItems) {
            this.searchHistory = this.searchHistory.slice(0, this.maxHistoryItems);
        }
        
        this.saveSearchHistory();
        return historyItem;
    },
    
    clearCache: function() {
        this.cache.clear();
        console.log('Search cache cleared');
    },
    
    clearSearchHistory: function() {
        this.searchHistory = [];
        this.saveSearchHistory();
        EnhancedUIUpdater.showToast('Search history cleared', 'success');
    }
};

// ============================================
// ENHANCED ROUTE MANAGER WITH STOPS
// ============================================
const EnhancedRouteManager = {
    routeControl: null,
    waypoints: [],
    currentRoute: null,
    routeSummary: null,
    
    init: function() {
        console.log('Enhanced Route Manager initialized');
        this.setupStopsManagement();
    },
    
    setupStopsManagement: function() {
        const addStopBtn = document.getElementById('addStopBtn');
        const stopsContainer = document.getElementById('stopsContainer');
        
        if (addStopBtn && stopsContainer) {
            addStopBtn.addEventListener('click', () => {
                this.addStop();
            });
        }
    },
    
    addStop: function() {
        if (AppState.rideStops.length >= AppState.maxStops) {
            EnhancedUIUpdater.showToast(`Maximum ${AppState.maxStops} stops allowed`, 'warning');
            return;
        }
        
        const stopNumber = AppState.rideStops.length + 1;
        const stopId = `stop-${Date.now()}`;
        
        AppState.rideStops.push({
            id: stopId,
            number: stopNumber,
            location: null,
            address: '',
            estimatedTime: 0,
            distanceFromPrevious: 0
        });
        
        this.renderStops();
        this.updateRouteWithStops();
    },
    
    removeStop: function(stopId) {
        AppState.rideStops = AppState.rideStops.filter(stop => stop.id !== stopId);
        
        // Re-number stops
        AppState.rideStops.forEach((stop, index) => {
            stop.number = index + 1;
        });
        
        this.renderStops();
        this.updateRouteWithStops();
    },
    
    renderStops: function() {
        const stopsContainer = document.getElementById('stopsContainer');
        const rideStopsList = document.getElementById('rideStopsList');
        
        if (!stopsContainer || !rideStopsList) return;
        
        // Clear existing stops
        stopsContainer.innerHTML = '';
        rideStopsList.innerHTML = '';
        
        if (AppState.rideStops.length === 0) {
            stopsContainer.style.display = 'none';
            return;
        }
        
        stopsContainer.style.display = 'block';
        
        AppState.rideStops.forEach((stop, index) => {
            // Add to main form
            const stopElement = document.createElement('div');
            stopElement.className = 'stop-input';
            stopElement.dataset.stopId = stop.id;
            
            stopElement.innerHTML = `
                <div class="stop-header">
                    <div class="stop-number">Stop ${stop.number}</div>
                    <button class="remove-stop-btn" data-stop-id="${stop.id}">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="location-input">
                    <i class="fas fa-map-marker-alt"></i>
                    <input type="text" class="stop-location-input" 
                           data-stop-id="${stop.id}"
                           placeholder="Enter stop location"
                           value="${stop.address || ''}">
                    <div class="suggestion-list" id="stopSuggestions-${stop.id}"></div>
                </div>
            `;
            
            stopsContainer.appendChild(stopElement);
            
            // Add to ride info panel
            if (AppState.currentRide) {
                const rideStopElement = document.createElement('div');
                rideStopElement.className = 'ride-stop-item';
                rideStopElement.innerHTML = `
                    <div class="stop-marker">
                        <i class="fas fa-map-pin"></i>
                        <span class="stop-number">${stop.number}</span>
                    </div>
                    <div class="stop-details">
                        <div class="stop-address">${stop.address || 'Not set'}</div>
                        ${stop.estimatedTime ? `<div class="stop-eta">ETA: +${stop.estimatedTime}min</div>` : ''}
                    </div>
                `;
                rideStopsList.appendChild(rideStopElement);
            }
            
            // Setup event listeners
            const removeBtn = stopElement.querySelector('.remove-stop-btn');
            const locationInput = stopElement.querySelector('.stop-location-input');
            
            if (removeBtn) {
                removeBtn.addEventListener('click', () => {
                    this.removeStop(stop.id);
                });
            }
            
            if (locationInput) {
                locationInput.addEventListener('input', (e) => {
                    this.handleStopLocationSearch(stop.id, e.target.value);
                });
                
                locationInput.addEventListener('focus', () => {
                    this.showStopLocationSuggestions(stop.id);
                });
            }
        });
        
        // Show ride stops in info panel if active ride
        if (AppState.currentRide && AppState.rideStops.length > 0) {
            document.getElementById('rideStopsContainer').style.display = 'block';
        }
    },
    
    handleStopLocationSearch: function(stopId, query) {
        clearTimeout(EnhancedSearchEngine.debounceTimer);
        
        if (query.length < 2) {
            this.hideStopLocationSuggestions(stopId);
            return;
        }
        
        EnhancedSearchEngine.debounceTimer = setTimeout(async () => {
            await this.searchStopLocation(stopId, query);
        }, 300);
    },
    
    async searchStopLocation(stopId, query) {
        if (!AppState.currentCity) return;
        
        try {
            const results = await EnhancedSearchEngine.searchMultiProvider(query, AppState.currentCity);
            this.showStopLocationSuggestions(stopId, results);
        } catch (error) {
            console.error('Stop location search error:', error);
        }
    },
    
    showStopLocationSuggestions: function(stopId, results = []) {
        const container = document.getElementById(`stopSuggestions-${stopId}`);
        if (!container) return;
        
        container.innerHTML = '';
        
        if (results.length === 0) {
            container.innerHTML = '<div class="no-results">No results found</div>';
        } else {
            results.forEach(result => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.innerHTML = `
                    <div class="suggestion-icon">
                        <i class="fas fa-map-marker-alt"></i>
                    </div>
                    <div class="suggestion-details">
                        <div class="suggestion-name">${result.name}</div>
                        <div class="suggestion-address">${result.address}</div>
                    </div>
                `;
                
                item.addEventListener('click', () => {
                    this.selectStopLocation(stopId, result);
                });
                
                container.appendChild(item);
            });
        }
        
        container.style.display = 'block';
    },
    
    hideStopLocationSuggestions: function(stopId) {
        const container = document.getElementById(`stopSuggestions-${stopId}`);
        if (container) {
            container.style.display = 'none';
        }
    },
    
    selectStopLocation: function(stopId, location) {
        const stop = AppState.rideStops.find(s => s.id === stopId);
        if (stop) {
            stop.location = location;
            stop.address = location.address || location.name;
            
            const input = document.querySelector(`.stop-location-input[data-stop-id="${stopId}"]`);
            if (input) {
                input.value = stop.address;
            }
            
            this.hideStopLocationSuggestions(stopId);
            this.updateRouteWithStops();
        }
    },
    
    updateRouteWithStops: function() {
        if (!AppState.pickup || !AppState.destination) return;
        
        const waypoints = this.buildWaypointsArray();
        this.drawRouteWithWaypoints(waypoints);
    },
    
    buildWaypointsArray: function() {
        const waypoints = [];
        
        // Start with pickup
        if (AppState.pickup) {
            waypoints.push(L.latLng(AppState.pickup.lat, AppState.pickup.lng));
        }
        
        // Add stops
        AppState.rideStops.forEach(stop => {
            if (stop.location) {
                waypoints.push(L.latLng(stop.location.lat, stop.location.lng));
            }
        });
        
        // End with destination
        if (AppState.destination) {
            waypoints.push(L.latLng(AppState.destination.lat, AppState.destination.lng));
        }
        
        return waypoints;
    },
    
    drawRouteWithWaypoints: async function(waypoints) {
        if (waypoints.length < 2) return;
        
        // Clear existing route
        if (this.routeControl) {
            map.removeControl(this.routeControl);
        }
        
        if (routeLayer) {
            map.removeLayer(routeLayer);
            routeLayer = null;
        }
        
        try {
            // Use OSRM for routing with multiple waypoints
            const coordinates = waypoints.map(wp => `${wp.lng},${wp.lat}`).join(';');
            const url = `https://router.project-osrm.org/route/v1/driving/${coordinates}?overview=full&geometries=geojson`;
            
            const response = await fetch(url);
            if (!response.ok) throw new Error('Routing failed');
            
            const data = await response.json();
            
            if (data.routes && data.routes.length > 0) {
                const route = data.routes[0];
                const routeCoordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                
                // Draw route on map
                routeLayer = L.polyline(routeCoordinates, {
                    color: '#FF6B35',
                    weight: 4,
                    opacity: 0.7,
                    lineJoin: 'round',
                    lineCap: 'round'
                }).addTo(map);
                
                // Update AppState
                AppState.activeRoute = {
                    distance: route.distance / 1000, // Convert to km
                    duration: route.duration / 60, // Convert to minutes
                    coordinates: routeCoordinates,
                    waypoints: waypoints
                };
                
                // Calculate stop distances and times
                this.calculateStopDetails(route.legs || []);
                
                // Fit map to route bounds
                const bounds = L.latLngBounds(routeCoordinates);
                map.fitBounds(bounds, { padding: [50, 50] });
                
                // Update prices
                EnhancedPriceCalculator.calculateAllPrices();
                
                return route;
            }
        } catch (error) {
            console.error('Routing error:', error);
            // Fallback: draw straight lines between points
            routeLayer = L.polyline(waypoints, {
                color: '#FF6B35',
                weight: 3,
                opacity: 0.5,
                dashArray: '10, 10'
            }).addTo(map);
            
            // Fit bounds
            const bounds = L.latLngBounds(waypoints);
            map.fitBounds(bounds, { padding: [50, 50] });
        }
    },
    
    calculateStopDetails: function(legs) {
        if (!legs || legs.length === 0) return;
        
        let cumulativeDistance = 0;
        let cumulativeDuration = 0;
        
        AppState.rideStops.forEach((stop, index) => {
            if (index < legs.length) {
                const leg = legs[index];
                stop.distanceFromPrevious = leg.distance / 1000; // km
                stop.estimatedTime = leg.duration / 60; // minutes
                cumulativeDistance += stop.distanceFromPrevious;
                cumulativeDuration += stop.estimatedTime;
            }
        });
        
        // Update total distance and time in AppState
        if (AppState.activeRoute) {
            AppState.activeRoute.totalDistance = cumulativeDistance;
            AppState.activeRoute.totalDuration = cumulativeDuration;
        }
    },
    
    clearStops: function() {
        AppState.rideStops = [];
        this.renderStops();
        
        // Redraw route without stops
        if (AppState.pickup && AppState.destination) {
            this.drawRouteWithWaypoints([
                L.latLng(AppState.pickup.lat, AppState.pickup.lng),
                L.latLng(AppState.destination.lat, AppState.destination.lng)
            ]);
        }
    },
    
    getRouteSummary: function() {
        if (!AppState.activeRoute) return null;
        
        return {
            totalDistance: AppState.activeRoute.distance,
            totalDuration: AppState.activeRoute.duration,
            stopsCount: AppState.rideStops.length,
            stops: AppState.rideStops.map(stop => ({
                number: stop.number,
                address: stop.address,
                distanceFromPrevious: stop.distanceFromPrevious,
                estimatedTime: stop.estimatedTime
            }))
        };
    }
};

// ============================================
// ENHANCED PRICE CALCULATOR WITH REAL-TIME UPDATES
// ============================================
const EnhancedPriceCalculator = {
    baseFare: 15,
    perKmRate: 3.0,
    perMinuteRate: 0.5,
    surgeMultiplier: 1.0,
    serviceFee: 5,
    taxRate: 0.16,
    
    init: function() {
        console.log('Enhanced Price Calculator initialized');
        this.calculateSurgeMultiplier();
        setInterval(() => this.calculateSurgeMultiplier(), 300000); // Update every 5 minutes
    },
    
    calculateSurgeMultiplier: function() {
        const hour = new Date().getHours();
        const day = new Date().getDay();
        
        let surge = 1.0;
        
        // Peak hours
        if ((hour >= 7 && hour <= 9) || (hour >= 16 && hour <= 19)) {
            surge = 1.5;
        }
        
        // Weekend nights
        if ((day === 5 || day === 6) && hour >= 20) {
            surge = 2.0;
        }
        
        // Late night
        if (hour >= 22 || hour <= 5) {
            surge = 1.8;
        }
        
        // Weather consideration (simulated)
        const weatherFactor = Math.random() * 0.5 + 0.75; // 0.75 to 1.25
        surge *= weatherFactor;
        
        this.surgeMultiplier = Math.min(Math.max(surge, 1.0), 3.0);
        return this.surgeMultiplier;
    },
    
    calculateAllPrices: function() {
        if (!AppState.activeRoute) return;
        
        const distance = AppState.activeRoute.distance;
        const duration = AppState.activeRoute.duration;
        
        // Calculate for all ride types
        Object.keys(AppState.rideTypes).forEach(rideType => {
            const price = this.calculateRidePrice(distance, duration, rideType);
            this.updateRideTypePrice(rideType, price);
        });
        
        // Update selected ride type price
        const selectedPrice = this.calculateRidePrice(distance, duration, AppState.selectedRideType);
        this.updateEstimatedFare(selectedPrice);
        
        // Update split ride calculations
        if (AppState.splitRideSession.participants.length > 0) {
            this.calculateSplitRidePrices();
        }
        
        // Update shopping prices if active
        if (AppState.activeService === 'express') {
            this.calculateShoppingPrice();
        }
        
        // Update delivery prices if active
        if (AppState.activeService === 'delivery' || AppState.activeService === 'short-delivery') {
            this.calculateDeliveryPrice();
        }
        
        // Update truck prices if active
        if (AppState.activeService === 'truck') {
            this.calculateTruckPrice();
        }
    },
    
    calculateRidePrice: function(distance, duration, rideType) {
        const config = AppState.rideTypes[rideType];
        if (!config) return 0;
        
        let price = config.base;
        price += distance * config.perKm;
        price += duration * 0.5; // Time component
        
        // Apply ride type multiplier
        price *= config.multiplier;
        
        // Apply surge pricing
        price *= this.surgeMultiplier;
        
        // Apply service fee
        price += this.serviceFee;
        
        // Apply tax
        price *= (1 + this.taxRate);
        
        // Ensure minimum fare
        price = Math.max(price, config.min);
        
        return Math.round(price * 100) / 100;
    },
    
    updateRideTypePrice: function(rideType, price) {
        const priceElement = document.getElementById(`${rideType}Price`);
        if (priceElement) {
            priceElement.textContent = `ZMW ${price.toFixed(2)}`;
        }
        
        const card = document.querySelector(`.ride-type-card[data-type="${rideType}"]`);
        if (card) {
            const priceSpan = card.querySelector('.ride-type-price');
            if (priceSpan) {
                priceSpan.textContent = `ZMW ${price.toFixed(2)}`;
            }
        }
    },
    
    updateEstimatedFare: function(price) {
        const fareElement = document.getElementById('estimatedFare');
        if (fareElement) {
            fareElement.textContent = `ZMW ${price.toFixed(2)}`;
        }
        
        AppState.rideFare = price;
        
        // Update payment modal
        const paymentAmount = document.getElementById('paymentAmount');
        if (paymentAmount) {
            paymentAmount.textContent = `ZMW ${price.toFixed(2)}`;
        }
        
        // Update original fare for referral discount
        const originalFareAmount = document.getElementById('originalFareAmount');
        if (originalFareAmount) {
            originalFareAmount.textContent = `ZMW ${price.toFixed(2)}`;
        }
    },
    
    calculateSplitRidePrices: function() {
        if (!AppState.activeRoute) return;
        
        const totalParticipants = AppState.splitRideSession.participants.length + 1; // +1 for host
        const totalPrice = this.calculateRidePrice(
            AppState.activeRoute.distance,
            AppState.activeRoute.duration,
            AppState.selectedRideType
        );
        
        const sharePerPerson = totalPrice / totalParticipants;
        
        // Update host share
        const yourShareElement = document.getElementById('yourShare');
        if (yourShareElement) {
            yourShareElement.textContent = `ZMW ${sharePerPerson.toFixed(2)}`;
        }
        
        // Update friend shares
        AppState.splitRideSession.participants.forEach((participant, index) => {
            const friendShareElement = document.getElementById(`friendShare-${index}`);
            if (friendShareElement) {
                friendShareElement.textContent = `ZMW ${sharePerPerson.toFixed(2)}`;
            }
        });
        
        // Update total fare
        const shareFareEstimate = document.getElementById('shareFareEstimate');
        if (shareFareEstimate) {
            shareFareEstimate.textContent = `ZMW ${totalPrice.toFixed(2)}`;
        }
        
        // Store in session
        AppState.splitRideSession.fareDistribution = {
            total: totalPrice,
            perPerson: sharePerPerson,
            participants: totalParticipants
        };
    },
    
    calculateShoppingPrice: function() {
        if (!AppState.activeRoute || !AppState.shoppingSession) return;
        
        const basePrice = this.calculateRidePrice(
            AppState.activeRoute.distance,
            AppState.activeRoute.duration,
            'standard'
        );
        
        let shoppingPrice = basePrice;
        
        // Add item handling fee
        shoppingPrice += AppState.shoppingSession.items.length * 5;
        
        // Add shopping service fee
        shoppingPrice += 20;
        
        // Update display
        const shoppingFare = document.getElementById('shoppingFare');
        if (shoppingFare) {
            shoppingFare.textContent = `ZMW ${shoppingPrice.toFixed(2)}`;
        }
        
        AppState.rideFare = shoppingPrice;
    },
    
    calculateDeliveryPrice: function() {
        if (!AppState.activeRoute) return;
        
        const basePrice = this.calculateRidePrice(
            AppState.activeRoute.distance,
            AppState.activeRoute.duration,
            'standard'
        );
        
        let deliveryPrice = basePrice;
        
        // Add delivery service fee
        deliveryPrice += 15;
        
        // Update display
        const deliveryFare = document.getElementById('deliveryFare');
        if (deliveryFare) {
            deliveryFare.textContent = `ZMW ${deliveryPrice.toFixed(2)}`;
        }
        
        AppState.rideFare = deliveryPrice;
    },
    
    calculateTruckPrice: function() {
        if (!AppState.activeRoute) return;
        
        const truckType = document.querySelector('.truck-type.selected')?.dataset.type || 'light';
        const config = AppState.truckTypes[truckType];
        
        let truckPrice = config.base;
        truckPrice += AppState.activeRoute.distance * config.perKm;
        truckPrice *= config.multiplier;
        
        // Add helpers fee if selected
        const needHelpers = document.getElementById('needHelpers')?.checked;
        if (needHelpers) {
            truckPrice += 50;
        }
        
        // Update display
        const truckFare = document.getElementById('truckFare');
        if (truckFare) {
            truckFare.textContent = `ZMW ${truckPrice.toFixed(2)}`;
        }
        
        AppState.rideFare = truckPrice;
    },
    
    calculateEmergencyPrice: function(serviceType, distance) {
        const config = AppState.emergencyServices[serviceType];
        if (!config) return 0;
        
        let price = config.base;
        price += distance * config.perKm;
        price *= config.multiplier;
        
        // Emergency premium
        price *= 1.5;
        
        return Math.max(price, config.min);
    },
    
    applyReferralDiscount: function(originalPrice) {
        if (!AppState.referralDiscountApplied) return originalPrice;
        
        const discount = originalPrice * 0.5;
        const discountedPrice = originalPrice - discount;
        
        // Update display
        const discountAmount = document.getElementById('discountAmount');
        const finalFareAmount = document.getElementById('finalFareAmount');
        
        if (discountAmount) {
            discountAmount.textContent = `-ZMW ${discount.toFixed(2)}`;
        }
        
        if (finalFareAmount) {
            finalFareAmount.textContent = `ZMW ${discountedPrice.toFixed(2)}`;
        }
        
        return discountedPrice;
    },
    
    getPriceBreakdown: function(price, rideType) {
        const config = AppState.rideTypes[rideType];
        
        return {
            baseFare: config.base,
            distanceFare: (AppState.activeRoute?.distance || 0) * config.perKm,
            timeFare: (AppState.activeRoute?.duration || 0) * 0.5,
            rideTypeMultiplier: config.multiplier,
            surgeMultiplier: this.surgeMultiplier,
            serviceFee: this.serviceFee,
            tax: price * this.taxRate,
            total: price
        };
    }
};

// ============================================
// ENHANCED WALLET SYSTEM WITH REAL-TIME TRANSACTIONS
// ============================================
const EnhancedWalletSystem = {
    transactions: [],
    pendingTransactions: [],
    
    init: function() {
        console.log('Enhanced Wallet System initialized');
        this.loadTransactions();
        this.setupWalletListeners();
    },
    
    loadTransactions: function() {
        if (!AppState.currentUser) return;
        
        const transactionsRef = database.ref(`walletTransactions/${AppState.currentUser.uid}`);
        
        transactionsRef.orderByChild('timestamp').limitToLast(50).on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                this.transactions = Object.values(data).reverse();
                AppState.walletTransactions = this.transactions;
                this.updateTransactionHistory();
                
                // Update wallet balance
                const latestBalance = this.calculateCurrentBalance();
                if (latestBalance !== AppState.walletBalance) {
                    AppState.walletBalance = latestBalance;
                    EnhancedUIUpdater.updateWalletBalance(latestBalance);
                }
            }
        });
    },
    
    calculateCurrentBalance: function() {
        let balance = 0;
        
        this.transactions.forEach(transaction => {
            if (transaction.type === 'deposit' || transaction.type === 'refund' || 
                (transaction.type === 'transfer' && transaction.recipientId === AppState.currentUser.uid)) {
                balance += transaction.amount;
            } else if (transaction.type === 'withdrawal' || transaction.type === 'ride_payment' ||
                      (transaction.type === 'transfer' && transaction.senderId === AppState.currentUser.uid)) {
                balance -= transaction.amount;
            }
        });
        
        return Math.max(balance, 0);
    },
    
    setupWalletListeners: function() {
        // Deposit button
        const depositBtn = document.getElementById('depositBtn');
        if (depositBtn) {
            depositBtn.addEventListener('click', () => {
                this.showDepositModal();
            });
        }
        
        // Withdraw button
        const withdrawBtn = document.getElementById('withdrawBtn');
        if (withdrawBtn) {
            withdrawBtn.addEventListener('click', () => {
                this.showWithdrawModal();
            });
        }
        
        // Transfer button
        const transferBtn = document.getElementById('transferBtn');
        if (transferBtn) {
            transferBtn.addEventListener('click', () => {
                this.showTransferModal();
            });
        }
        
        // Transactions button
        const transactionsBtn = document.getElementById('transactionsBtn');
        if (transactionsBtn) {
            transactionsBtn.addEventListener('click', () => {
                this.showTransactionsModal();
            });
        }
        
        // Confirm Transfer button
        const confirmTransferBtn = document.getElementById('confirmTransferBtn');
        if (confirmTransferBtn) {
            confirmTransferBtn.addEventListener('click', async () => {
                await this.processTransfer();
            });
        }
    },
    
    showDepositModal: function() {
        EnhancedUIUpdater.showModal('deposit');
        
        // Setup deposit form
        const depositForm = document.getElementById('depositForm');
        if (depositForm) {
            depositForm.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Amount (ZMW)</label>
                    <input type="number" class="form-control" id="depositAmount" 
                           placeholder="Enter amount" min="10" step="0.01">
                </div>
                <div class="form-group">
                    <label class="form-label">Payment Method</label>
                    <select class="form-control" id="depositMethod">
                        <option value="mobile_money">Mobile Money</option>
                        <option value="bank_transfer">Bank Transfer</option>
                        <option value="card">Credit/Debit Card</option>
                    </select>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmDepositBtn">
                        <i class="fas fa-plus"></i> Deposit
                    </button>
                    <button class="btn btn-secondary" onclick="EnhancedUIUpdater.hideModal('deposit')">
                        Cancel
                    </button>
                </div>
            `;
            
            const confirmDepositBtn = document.getElementById('confirmDepositBtn');
            if (confirmDepositBtn) {
                confirmDepositBtn.addEventListener('click', async () => {
                    await this.processDeposit();
                });
            }
        }
    },
    
    showWithdrawModal: function() {
        if (AppState.walletBalance < 10) {
            EnhancedUIUpdater.showToast('Minimum withdrawal amount is ZMW 10', 'warning');
            return;
        }
        
        EnhancedUIUpdater.showModal('withdraw');
        
        const withdrawForm = document.getElementById('withdrawForm');
        if (withdrawForm) {
            withdrawForm.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Available Balance: ZMW ${AppState.walletBalance.toFixed(2)}</label>
                </div>
                <div class="form-group">
                    <label class="form-label">Amount (ZMW)</label>
                    <input type="number" class="form-control" id="withdrawAmount" 
                           placeholder="Enter amount" min="10" max="${AppState.walletBalance}" 
                           step="0.01" value="${Math.min(100, AppState.walletBalance)}">
                </div>
                <div class="form-group">
                    <label class="form-label">Withdraw to</label>
                    <select class="form-control" id="withdrawMethod">
                        <option value="mobile_money">Mobile Money</option>
                        <option value="bank_account">Bank Account</option>
                    </select>
                </div>
                <div class="form-group" id="mobileMoneyDetails" style="display: block;">
                    <label class="form-label">Mobile Money Number</label>
                    <input type="tel" class="form-control" id="mobileNumber" 
                           placeholder="Enter phone number" value="${AppState.userData?.phone || ''}">
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmWithdrawBtn">
                        <i class="fas fa-minus"></i> Withdraw
                    </button>
                    <button class="btn btn-secondary" onclick="EnhancedUIUpdater.hideModal('withdraw')">
                        Cancel
                    </button>
                </div>
            `;
            
            const withdrawMethod = document.getElementById('withdrawMethod');
            const mobileMoneyDetails = document.getElementById('mobileMoneyDetails');
            
            if (withdrawMethod && mobileMoneyDetails) {
                withdrawMethod.addEventListener('change', function() {
                    mobileMoneyDetails.style.display = this.value === 'mobile_money' ? 'block' : 'none';
                });
            }
            
            const confirmWithdrawBtn = document.getElementById('confirmWithdrawBtn');
            if (confirmWithdrawBtn) {
                confirmWithdrawBtn.addEventListener('click', async () => {
                    await this.processWithdrawal();
                });
            }
        }
    },
    
    showTransferModal: function() {
        EnhancedUIUpdater.showModal('transfer');
        
        const transferBalance = document.getElementById('transferBalance');
        if (transferBalance) {
            transferBalance.textContent = `ZMW ${AppState.walletBalance.toFixed(2)}`;
        }
    },
    
    showTransactionsModal: function() {
        EnhancedUIUpdater.showModal('transactions');
        this.updateTransactionHistory();
    },
    
    async processDeposit() {
        const amountInput = document.getElementById('depositAmount');
        const methodSelect = document.getElementById('depositMethod');
        
        if (!amountInput || !methodSelect) return;
        
        const amount = parseFloat(amountInput.value);
        const method = methodSelect.value;
        
        if (!amount || amount < 10) {
            EnhancedUIUpdater.showToast('Minimum deposit amount is ZMW 10', 'warning');
            return;
        }
        
        try {
            EnhancedUIUpdater.showLoading('Processing deposit...');
            
            // Create transaction record
            const transactionId = database.ref().child('walletTransactions').push().key;
            const transaction = {
                id: transactionId,
                userId: AppState.currentUser.uid,
                type: 'deposit',
                amount: amount,
                method: method,
                status: 'pending',
                timestamp: Date.now(),
                description: `Deposit via ${method}`
            };
            
            await database.ref(`walletTransactions/${AppState.currentUser.uid}/${transactionId}`).set(transaction);
            
            // Simulate payment processing (in real app, integrate with payment gateway)
            setTimeout(async () => {
                // Update transaction status
                await database.ref(`walletTransactions/${AppState.currentUser.uid}/${transactionId}/status`).set('completed');
                
                // Update user wallet balance
                const newBalance = AppState.walletBalance + amount;
                await database.ref(`users/${AppState.currentUser.uid}/walletBalance`).set(newBalance);
                
                EnhancedUIUpdater.hideLoading();
                EnhancedUIUpdater.hideModal('deposit');
                EnhancedUIUpdater.showToast(`Deposit of ZMW ${amount.toFixed(2)} successful`, 'success');
                
                // Send notification
                EnhancedFirebaseManager.sendNotification(
                    AppState.currentUser.uid,
                    'Deposit Successful',
                    `Your deposit of ZMW ${amount.toFixed(2)} has been processed`,
                    'payment'
                );
            }, 2000);
            
        } catch (error) {
            console.error('Deposit error:', error);
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Deposit failed. Please try again.', 'error');
        }
    },
    
    async processWithdrawal() {
        const amountInput = document.getElementById('withdrawAmount');
        const methodSelect = document.getElementById('withdrawMethod');
        const mobileNumberInput = document.getElementById('mobileNumber');
        
        if (!amountInput || !methodSelect) return;
        
        const amount = parseFloat(amountInput.value);
        const method = methodSelect.value;
        const mobileNumber = mobileNumberInput?.value || '';
        
        if (!amount || amount < 10) {
            EnhancedUIUpdater.showToast('Minimum withdrawal amount is ZMW 10', 'warning');
            return;
        }
        
        if (amount > AppState.walletBalance) {
            EnhancedUIUpdater.showToast('Insufficient balance', 'error');
            return;
        }
        
        if (method === 'mobile_money' && (!mobileNumber || mobileNumber.length < 10)) {
            EnhancedUIUpdater.showToast('Please enter a valid mobile number', 'warning');
            return;
        }
        
        try {
            EnhancedUIUpdater.showLoading('Processing withdrawal...');
            
            // Create transaction record
            const transactionId = database.ref().child('walletTransactions').push().key;
            const transaction = {
                id: transactionId,
                userId: AppState.currentUser.uid,
                type: 'withdrawal',
                amount: amount,
                method: method,
                status: 'pending',
                timestamp: Date.now(),
                description: `Withdrawal to ${method === 'mobile_money' ? mobileNumber : 'bank account'}`,
                recipientDetails: method === 'mobile_money' ? { phone: mobileNumber } : {}
            };
            
            await database.ref(`walletTransactions/${AppState.currentUser.uid}/${transactionId}`).set(transaction);
            
            // Update user wallet balance immediately
            const newBalance = AppState.walletBalance - amount;
            await database.ref(`users/${AppState.currentUser.uid}/walletBalance`).set(newBalance);
            
            // Simulate processing (in real app, integrate with payout API)
            setTimeout(async () => {
                await database.ref(`walletTransactions/${AppState.currentUser.uid}/${transactionId}/status`).set('completed');
                
                EnhancedUIUpdater.hideLoading();
                EnhancedUIUpdater.hideModal('withdraw');
                EnhancedUIUpdater.showToast(`Withdrawal of ZMW ${amount.toFixed(2)} processed`, 'success');
                
                // Send notification
                EnhancedFirebaseManager.sendNotification(
                    AppState.currentUser.uid,
                    'Withdrawal Processed',
                    `Your withdrawal of ZMW ${amount.toFixed(2)} has been sent`,
                    'payment'
                );
            }, 3000);
            
        } catch (error) {
            console.error('Withdrawal error:', error);
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Withdrawal failed. Please try again.', 'error');
        }
    },
    
    async processTransfer() {
        const recipientCodeInput = document.getElementById('recipientCode');
        const amountInput = document.getElementById('transferAmount');
        const messageInput = document.getElementById('transferMessage');
        
        if (!recipientCodeInput || !amountInput) return;
        
        const recipientCode = recipientCodeInput.value.trim();
        const amount = parseFloat(amountInput.value);
        const message = messageInput?.value.trim() || '';
        
        if (!recipientCode) {
            EnhancedUIUpdater.showToast('Please enter recipient referral code', 'warning');
            return;
        }
        
        if (!amount || amount < 1) {
            EnhancedUIUpdater.showToast('Minimum transfer amount is ZMW 1', 'warning');
            return;
        }
        
        if (amount > AppState.walletBalance) {
            EnhancedUIUpdater.showToast('Insufficient balance', 'error');
            return;
        }
        
        try {
            EnhancedUIUpdater.showLoading('Processing transfer...');
            
            // Find recipient by referral code
            const recipientSnapshot = await database.ref('users')
                .orderByChild('referralCode')
                .equalTo(recipientCode)
                .once('value');
            
            const recipientData = recipientSnapshot.val();
            if (!recipientData) {
                throw new Error('Recipient not found');
            }
            
            const recipientId = Object.keys(recipientData)[0];
            const recipient = recipientData[recipientId];
            
            // Check if transferring to self
            if (recipientId === AppState.currentUser.uid) {
                throw new Error('Cannot transfer to yourself');
            }
            
            // Create transaction records for both users
            const transactionId = database.ref().child('walletTransactions').push().key;
            const timestamp = Date.now();
            
            // Sender transaction
            const senderTransaction = {
                id: transactionId,
                userId: AppState.currentUser.uid,
                type: 'transfer',
                amount: amount,
                status: 'completed',
                timestamp: timestamp,
                description: `Transfer to ${recipient.name}`,
                recipientId: recipientId,
                recipientName: recipient.name,
                message: message,
                direction: 'outgoing'
            };
            
            // Recipient transaction
            const recipientTransaction = {
                id: transactionId,
                userId: recipientId,
                type: 'transfer',
                amount: amount,
                status: 'completed',
                timestamp: timestamp,
                description: `Transfer from ${AppState.userData.name}`,
                senderId: AppState.currentUser.uid,
                senderName: AppState.userData.name,
                message: message,
                direction: 'incoming'
            };
            
            // Update sender balance
            const senderNewBalance = AppState.walletBalance - amount;
            await database.ref(`users/${AppState.currentUser.uid}/walletBalance`).set(senderNewBalance);
            
            // Update recipient balance
            const recipientCurrentBalance = recipient.walletBalance || 0;
            const recipientNewBalance = recipientCurrentBalance + amount;
            await database.ref(`users/${recipientId}/walletBalance`).set(recipientNewBalance);
            
            // Save transactions
            await database.ref(`walletTransactions/${AppState.currentUser.uid}/${transactionId}`).set(senderTransaction);
            await database.ref(`walletTransactions/${recipientId}/${transactionId}`).set(recipientTransaction);
            
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.hideModal('transfer');
            EnhancedUIUpdater.showToast(`Transfer of ZMW ${amount.toFixed(2)} to ${recipient.name} successful`, 'success');
            
            // Send notification to recipient
            EnhancedFirebaseManager.sendNotification(
                recipientId,
                'Money Received',
                `${AppState.userData.name} sent you ZMW ${amount.toFixed(2)}`,
                'payment',
                { senderName: AppState.userData.name, amount: amount }
            );
            
        } catch (error) {
            console.error('Transfer error:', error);
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast(error.message || 'Transfer failed', 'error');
        }
    },
    
    updateTransactionHistory: function() {
        const container = document.getElementById('transactionsList');
        if (!container) return;
        
        container.innerHTML = '';
        
        if (this.transactions.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-receipt"></i>
                    </div>
                    <div class="empty-title">No transactions yet</div>
                    <div class="empty-message">Your transaction history will appear here</div>
                </div>
            `;
            return;
        }
        
        this.transactions.forEach(transaction => {
            const transactionElement = this.createTransactionElement(transaction);
            container.appendChild(transactionElement);
        });
    },
    
    createTransactionElement: function(transaction) {
        const element = document.createElement('div');
        element.className = `transaction-item ${transaction.type}`;
        
        const date = new Date(transaction.timestamp);
        let icon = 'fa-exchange-alt';
        let iconColor = '#2196F3';
        let amountPrefix = '';
        
        switch(transaction.type) {
            case 'deposit':
                icon = 'fa-arrow-down';
                iconColor = '#4CAF50';
                amountPrefix = '+';
                break;
            case 'withdrawal':
                icon = 'fa-arrow-up';
                iconColor = '#F44336';
                amountPrefix = '-';
                break;
            case 'ride_payment':
                icon = 'fa-car';
                iconColor = '#FF6B35';
                amountPrefix = '-';
                break;
            case 'refund':
                icon = 'fa-undo';
                iconColor = '#FFC107';
                amountPrefix = '+';
                break;
            case 'referral_earning':
                icon = 'fa-gift';
                iconColor = '#9C27B0';
                amountPrefix = '+';
                break;
            case 'transfer':
                if (transaction.direction === 'incoming') {
                    icon = 'fa-arrow-down';
                    iconColor = '#4CAF50';
                    amountPrefix = '+';
                } else {
                    icon = 'fa-arrow-up';
                    iconColor = '#F44336';
                    amountPrefix = '-';
                }
                break;
        }
        
        element.innerHTML = `
            <div class="transaction-header">
                <div class="transaction-icon" style="background: ${iconColor}20; color: ${iconColor}">
                    <i class="fas ${icon}"></i>
                </div>
                <div class="transaction-details">
                    <div class="transaction-title">${this.getTransactionTitle(transaction)}</div>
                    <div class="transaction-description">${this.getTransactionDescription(transaction)}</div>
                    <div class="transaction-date">${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                </div>
                <div class="transaction-amount" style="color: ${amountPrefix === '+' ? '#4CAF50' : '#F44336'}">
                    ${amountPrefix}ZMW ${transaction.amount.toFixed(2)}
                </div>
            </div>
            <div class="transaction-footer">
                <div class="transaction-status ${transaction.status}">${transaction.status}</div>
                ${transaction.rideId ? `<div class="transaction-ride">Ride: ${transaction.rideId.substring(0, 8)}...</div>` : ''}
            </div>
        `;
        
        return element;
    },
    
    getTransactionTitle: function(transaction) {
        switch(transaction.type) {
            case 'deposit': return 'Deposit';
            case 'withdrawal': return 'Withdrawal';
            case 'ride_payment': return 'Ride Payment';
            case 'refund': return 'Ride Refund';
            case 'referral_earning': return 'Referral Earnings';
            case 'transfer': 
                return transaction.direction === 'incoming' ? 'Money Received' : 'Money Sent';
            default: return 'Transaction';
        }
    },
    
    getTransactionDescription: function(transaction) {
        if (transaction.description) return transaction.description;
        
        switch(transaction.type) {
            case 'transfer':
                return transaction.direction === 'incoming' 
                    ? `From: ${transaction.senderName}`
                    : `To: ${transaction.recipientName}`;
            case 'referral_earning':
                return `From: ${transaction.referredUserName}`;
            default:
                return '';
        }
    },
    
    processRidePayment: async function(rideId, amount, paymentMethod = 'wallet') {
        try {
            // Create transaction record
            const transactionId = database.ref().child('walletTransactions').push().key;
            const transaction = {
                id: transactionId,
                userId: AppState.currentUser.uid,
                type: 'ride_payment',
                amount: amount,
                rideId: rideId,
                status: 'completed',
                timestamp: Date.now(),
                paymentMethod: paymentMethod,
                description: `Ride payment - ${AppState.currentRide?.pickupDisplay || 'Ride'}`
            };
            
            await database.ref(`walletTransactions/${AppState.currentUser.uid}/${transactionId}`).set(transaction);
            
            // Update wallet balance if payment method is wallet
            if (paymentMethod === 'wallet') {
                const newBalance = AppState.walletBalance - amount;
                await database.ref(`users/${AppState.currentUser.uid}/walletBalance`).set(newBalance);
                AppState.walletBalance = newBalance;
                EnhancedUIUpdater.updateWalletBalance(newBalance);
            }
            
            return transactionId;
            
        } catch (error) {
            console.error('Ride payment error:', error);
            throw error;
        }
    },
    
    processRefund: async function(rideId, amount, reason) {
        try {
            const transactionId = database.ref().child('walletTransactions').push().key;
            const transaction = {
                id: transactionId,
                userId: AppState.currentUser.uid,
                type: 'refund',
                amount: amount,
                rideId: rideId,
                status: 'completed',
                timestamp: Date.now(),
                reason: reason,
                description: `Ride refund - ${reason}`
            };
            
            await database.ref(`walletTransactions/${AppState.currentUser.uid}/${transactionId}`).set(transaction);
            
            // Update wallet balance
            const newBalance = AppState.walletBalance + amount;
            await database.ref(`users/${AppState.currentUser.uid}/walletBalance`).set(newBalance);
            AppState.walletBalance = newBalance;
            EnhancedUIUpdater.updateWalletBalance(newBalance);
            
            EnhancedUIUpdater.showToast(`Refund of ZMW ${amount.toFixed(2)} processed`, 'success');
            
            return transactionId;
            
        } catch (error) {
            console.error('Refund error:', error);
            throw error;
        }
    },
    
    processReferralEarnings: async function(referredUserId, rideId, amount) {
        try {
            // Get referral owner (the one who referred the user)
            const referralSnapshot = await database.ref('referrals')
                .orderByChild('referredUserId')
                .equalTo(referredUserId)
                .once('value');
            
            const referralData = referralSnapshot.val();
            if (!referralData) return;
            
            const referralId = Object.keys(referralData)[0];
            const referral = referralData[referralId];
            const referralOwnerId = referral.referrerUserId;
            
            // Create transaction for referral owner
            const transactionId = database.ref().child('walletTransactions').push().key;
            const transaction = {
                id: transactionId,
                userId: referralOwnerId,
                type: 'referral_earning',
                amount: amount,
                rideId: rideId,
                status: 'completed',
                timestamp: Date.now(),
                referredUserId: referredUserId,
                referralCode: referral.referralCode,
                description: `Referral earnings from ${referral.referredUserName}`
            };
            
            await database.ref(`walletTransactions/${referralOwnerId}/${transactionId}`).set(transaction);
            
            // Update referral owner's wallet balance
            const ownerSnapshot = await database.ref(`users/${referralOwnerId}/walletBalance`).once('value');
            const currentBalance = ownerSnapshot.val() || 0;
            const newBalance = currentBalance + amount;
            
            await database.ref(`users/${referralOwnerId}/walletBalance`).set(newBalance);
            
            // Send notification to referral owner
            EnhancedFirebaseManager.sendNotification(
                referralOwnerId,
                'Referral Earnings',
                `You earned ZMW ${amount.toFixed(2)} from ${referral.referredUserName}'s ride`,
                'referral',
                { amount: amount, referredUserName: referral.referredUserName }
            );
            
        } catch (error) {
            console.error('Referral earnings error:', error);
        }
    }
};

// ============================================
// SPLIT RIDE MANAGER
// ============================================
const SplitRideManager = {
    maxParticipants: 4,
    currentSplitRide: null,
    
    init: function() {
        console.log('Split Ride Manager initialized');
        this.setupSplitRideListeners();
    },
    
    setupSplitRideListeners: function() {
        // Share ride button
        const shareRideBtn = document.getElementById('shareRideBtn');
        if (shareRideBtn) {
            shareRideBtn.addEventListener('click', () => {
                this.showShareRideModal();
            });
        }
        
        // Add share member button
        const addShareMemberBtn = document.getElementById('addShareMemberBtn');
        if (addShareMemberBtn) {
            addShareMemberBtn.addEventListener('click', () => {
                this.addShareMember();
            });
        }
        
        // Confirm share ride button
        const confirmShareRideBtn = document.getElementById('confirmShareRideBtn');
        if (confirmShareRideBtn) {
            confirmShareRideBtn.addEventListener('click', async () => {
                await this.createShareRide();
            });
        }
        
        // Accept share invitation button
        const acceptShareInvitationBtn = document.getElementById('acceptShareInvitationBtn');
        if (acceptShareInvitationBtn) {
            acceptShareInvitationBtn.addEventListener('click', async () => {
                await this.acceptShareInvitation();
            });
        }
        
        // Reject share invitation button
        const rejectShareInvitationBtn = document.getElementById('rejectShareInvitationBtn');
        if (rejectShareInvitationBtn) {
            rejectShareInvitationBtn.addEventListener('click', async () => {
                await this.rejectShareInvitation();
            });
        }
    },
    
    showShareRideModal: function() {
        if (!AppState.pickup || !AppState.destination) {
            EnhancedUIUpdater.showToast('Please select pickup and destination first', 'warning');
            return;
        }
        
        EnhancedUIUpdater.showModal('shareRide');
        
        // Reset share ride session
        AppState.splitRideSession = {
            hostId: AppState.currentUser.uid,
            participants: [],
            fareDistribution: {},
            paymentStatus: {},
            rideData: {
                pickup: AppState.pickup,
                destination: AppState.destination,
                rideType: AppState.selectedRideType
            }
        };
        
        // Update fare estimate
        this.updateShareRideFare();
    },
    
    updateShareRideFare: function() {
        if (!AppState.activeRoute) return;
        
        const totalParticipants = AppState.splitRideSession.participants.length + 1;
        const totalPrice = EnhancedPriceCalculator.calculateRidePrice(
            AppState.activeRoute.distance,
            AppState.activeRoute.duration,
            AppState.selectedRideType
        );
        
        const sharePerPerson = totalPrice / totalParticipants;
        
        // Update display
        const shareFareEstimate = document.getElementById('shareFareEstimate');
        const yourShare = document.getElementById('yourShare');
        const friendShare = document.getElementById('friendShare');
        
        if (shareFareEstimate) shareFareEstimate.textContent = `ZMW ${totalPrice.toFixed(2)}`;
        if (yourShare) yourShare.textContent = `ZMW ${sharePerPerson.toFixed(2)}`;
        if (friendShare) friendShare.textContent = `ZMW ${sharePerPerson.toFixed(2)}`;
        
        // Update calculations display
        const calculationsContainer = document.getElementById('shareCalculations');
        if (calculationsContainer) {
            calculationsContainer.style.display = 'block';
            calculationsContainer.innerHTML = `
                <div class="calculation-row">
                    <span>Total Fare:</span>
                    <span>ZMW ${totalPrice.toFixed(2)}</span>
                </div>
                <div class="calculation-row">
                    <span>Participants:</span>
                    <span>${totalParticipants} people</span>
                </div>
                <div class="calculation-row">
                    <span>Share per person:</span>
                    <span>ZMW ${sharePerPerson.toFixed(2)}</span>
                </div>
            `;
        }
        
        // Update session data
        AppState.splitRideSession.fareDistribution = {
            total: totalPrice,
            perPerson: sharePerPerson,
            participants: totalParticipants
        };
    },
    
    async addShareMember() {
        const memberInput = document.getElementById('shareMemberInput');
        if (!memberInput) return;
        
        const referralCode = memberInput.value.trim();
        if (!referralCode) {
            EnhancedUIUpdater.showToast('Please enter a referral code', 'warning');
            return;
        }
        
        if (AppState.splitRideSession.participants.length >= this.maxParticipants - 1) {
            EnhancedUIUpdater.showToast(`Maximum ${this.maxParticipants - 1} friends allowed`, 'warning');
            return;
        }
        
        // Check if already added
        if (AppState.splitRideSession.participants.some(p => p.referralCode === referralCode)) {
            EnhancedUIUpdater.showToast('Friend already added', 'warning');
            return;
        }
        
        try {
            EnhancedUIUpdater.showLoading('Adding friend...');
            
            // Find user by referral code
            const userSnapshot = await database.ref('users')
                .orderByChild('referralCode')
                .equalTo(referralCode)
                .once('value');
            
            const userData = userSnapshot.val();
            if (!userData) {
                throw new Error('User not found');
            }
            
            const userId = Object.keys(userData)[0];
            const user = userData[userId];
            
            // Check if adding self
            if (userId === AppState.currentUser.uid) {
                throw new Error('Cannot add yourself');
            }
            
            // Add to participants
            AppState.splitRideSession.participants.push({
                userId: userId,
                name: user.name,
                phone: user.phone,
                referralCode: referralCode,
                status: 'invited',
                paymentStatus: 'pending'
            });
            
            // Update UI
            this.updateShareFriendsList();
            this.updateShareRideFare();
            
            memberInput.value = '';
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast(`${user.name} added to ride`, 'success');
            
        } catch (error) {
            console.error('Add share member error:', error);
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast(error.message || 'Failed to add friend', 'error');
        }
    },
    
    updateShareFriendsList: function() {
        const container = document.getElementById('shareFriendsList');
        if (!container) return;
        
        container.innerHTML = '';
        
        AppState.splitRideSession.participants.forEach((participant, index) => {
            const friendElement = document.createElement('div');
            friendElement.className = 'share-friend-item';
            friendElement.innerHTML = `
                <div class="friend-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="friend-info">
                    <div class="friend-name">${participant.name}</div>
                    <div class="friend-status ${participant.status}">${participant.status}</div>
                </div>
                <button class="remove-friend-btn" data-index="${index}">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(friendElement);
            
            // Add remove event listener
            const removeBtn = friendElement.querySelector('.remove-friend-btn');
            if (removeBtn) {
                removeBtn.addEventListener('click', () => {
                    this.removeShareMember(index);
                });
            }
        });
    },
    
    removeShareMember: function(index) {
        AppState.splitRideSession.participants.splice(index, 1);
        this.updateShareFriendsList();
        this.updateShareRideFare();
    },
    
    async createShareRide() {
        if (AppState.splitRideSession.participants.length === 0) {
            EnhancedUIUpdater.showToast('Please add at least one friend', 'warning');
            return;
        }
        
        if (!AppState.pickup || !AppState.destination) {
            EnhancedUIUpdater.showToast('Please select pickup and destination', 'warning');
            return;
        }
        
        try {
            EnhancedUIUpdater.showLoading('Creating share ride...');
            
            // Calculate total fare
            const totalFare = AppState.splitRideSession.fareDistribution.total;
            const perPersonFare = AppState.splitRideSession.fareDistribution.perPerson;
            
            // Create share ride record
            const shareRideId = database.ref().child('shareRides').push().key;
            
            const shareRideData = {
                id: shareRideId,
                hostId: AppState.currentUser.uid,
                hostName: AppState.userData.name,
                participants: AppState.splitRideSession.participants.map(p => ({
                    userId: p.userId,
                    name: p.name,
                    status: 'invited',
                    paymentStatus: 'pending'
                })),
                rideData: {
                    pickup: AppState.pickup,
                    destination: AppState.destination,
                    rideType: AppState.selectedRideType,
                    distance: AppState.activeRoute?.distance || 0,
                    duration: AppState.activeRoute?.duration || 0,
                    totalFare: totalFare,
                    perPersonFare: perPersonFare
                },
                status: 'inviting',
                timestamp: Date.now(),
                city: AppState.currentCity
            };
            
            await database.ref(`shareRides/${shareRideId}`).set(shareRideData);
            
            // Send invitations to all participants
            await this.sendShareRideInvitations(shareRideId, shareRideData);
            
            // Show payment modal for host
            AppState.activeSplitRide = shareRideId;
            EnhancedUIUpdater.hideModal('shareRide');
            EnhancedUIUpdater.showPaymentModal('split_ride', perPersonFare, {
                ...AppState.splitRideSession.rideData,
                shareRideId: shareRideId,
                isHost: true
            });
            
            EnhancedUIUpdater.hideLoading();
            
        } catch (error) {
            console.error('Create share ride error:', error);
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Failed to create share ride', 'error');
        }
    },
    
    async sendShareRideInvitations(shareRideId, shareRideData) {
        const invitations = AppState.splitRideSession.participants.map(async (participant) => {
            // Create invitation record
            const invitationId = database.ref().child('shareRideInvitations').push().key;
            
            const invitation = {
                id: invitationId,
                shareRideId: shareRideId,
                hostId: AppState.currentUser.uid,
                hostName: AppState.userData.name,
                recipientId: participant.userId,
                recipientName: participant.name,
                rideData: shareRideData.rideData,
                fare: shareRideData.rideData.perPersonFare,
                status: 'pending',
                timestamp: Date.now()
            };
            
            await database.ref(`shareRideInvitations/${invitationId}`).set(invitation);
            
            // Send notification to participant
            await EnhancedFirebaseManager.sendNotification(
                participant.userId,
                'Share Ride Invitation',
                `${AppState.userData.name} invited you to share a ride`,
                'share_ride',
                { 
                    shareRideId: shareRideId,
                    invitationId: invitationId,
                    action: 'view_share_invitation'
                }
            );
            
            return invitationId;
        });
        
        await Promise.all(invitations);
    },
    
    async acceptShareInvitation() {
        const modal = document.getElementById('shareRideInvitationModal');
        if (!modal) return;
        
        const invitationId = modal.dataset.invitationId;
        if (!invitationId) return;
        
        try {
            EnhancedUIUpdater.showLoading('Accepting invitation...');
            
            // Update invitation status
            await database.ref(`shareRideInvitations/${invitationId}/status`).set('accepted');
            
            // Get invitation details
            const invitationSnapshot = await database.ref(`shareRideInvitations/${invitationId}`).once('value');
            const invitation = invitationSnapshot.val();
            
            if (!invitation) {
                throw new Error('Invitation not found');
            }
            
            // Update share ride participant status
            const shareRideRef = database.ref(`shareRides/${invitation.shareRideId}/participants`);
            const participantsSnapshot = await shareRideRef.once('value');
            const participants = participantsSnapshot.val() || [];
            
            const updatedParticipants = participants.map(p => {
                if (p.userId === AppState.currentUser.uid) {
                    return { ...p, status: 'accepted' };
                }
                return p;
            });
            
            await shareRideRef.set(updatedParticipants);
            
            // Show payment modal
            EnhancedUIUpdater.hideModal('shareRideInvitation');
            EnhancedUIUpdater.showPaymentModal('split_ride', invitation.fare, {
                pickup: invitation.rideData.pickup,
                destination: invitation.rideData.destination,
                rideType: invitation.rideData.rideType,
                shareRideId: invitation.shareRideId,
                isHost: false,
                invitationId: invitationId
            });
            
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Invitation accepted', 'success');
            
        } catch (error) {
            console.error('Accept invitation error:', error);
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Failed to accept invitation', 'error');
        }
    },
    
    async rejectShareInvitation() {
        const modal = document.getElementById('shareRideInvitationModal');
        if (!modal) return;
        
        const invitationId = modal.dataset.invitationId;
        if (!invitationId) return;
        
        try {
            // Update invitation status
            await database.ref(`shareRideInvitations/${invitationId}/status`).set('rejected');
            
            // Get invitation details
            const invitationSnapshot = await database.ref(`shareRideInvitations/${invitationId}`).once('value');
            const invitation = invitationSnapshot.val();
            
            if (invitation) {
                // Update share ride participant status
                const shareRideRef = database.ref(`shareRides/${invitation.shareRideId}/participants`);
                const participantsSnapshot = await shareRideRef.once('value');
                const participants = participantsSnapshot.val() || [];
                
                const updatedParticipants = participants.map(p => {
                    if (p.userId === AppState.currentUser.uid) {
                        return { ...p, status: 'rejected' };
                    }
                    return p;
                });
                
                await shareRideRef.set(updatedParticipants);
                
                // Recalculate fares for remaining participants
                await this.recalculateShareRideFares(invitation.shareRideId);
            }
            
            EnhancedUIUpdater.hideModal('shareRideInvitation');
            EnhancedUIUpdater.showToast('Invitation declined', 'info');
            
        } catch (error) {
            console.error('Reject invitation error:', error);
            EnhancedUIUpdater.showToast('Failed to decline invitation', 'error');
        }
    },
    
    async recalculateShareRideFares(shareRideId) {
        try {
            const shareRideSnapshot = await database.ref(`shareRides/${shareRideId}`).once('value');
            const shareRide = shareRideSnapshot.val();
            
            if (!shareRide) return;
            
            // Count accepted participants
            const acceptedParticipants = shareRide.participants.filter(p => p.status === 'accepted').length;
            const totalParticipants = acceptedParticipants + 1; // +1 for host
            
            if (totalParticipants > 1) {
                const newPerPersonFare = shareRide.rideData.totalFare / totalParticipants;
                
                // Update share ride with new fare
                await database.ref(`shareRides/${shareRideId}/rideData/perPersonFare`).set(newPerPersonFare);
                
                // Notify all participants about fare change
                await this.notifyFareChange(shareRideId, newPerPersonFare);
            }
            
        } catch (error) {
            console.error('Recalculate fares error:', error);
        }
    },
    
    async notifyFareChange(shareRideId, newFare) {
        const shareRideSnapshot = await database.ref(`shareRides/${shareRideId}`).once('value');
        const shareRide = shareRideSnapshot.val();
        
        if (!shareRide) return;
        
        // Notify host
        await EnhancedFirebaseManager.sendNotification(
            shareRide.hostId,
            'Fare Updated',
            `Share ride fare updated to ZMW ${newFare.toFixed(2)} per person`,
            'share_ride',
            { shareRideId: shareRideId, newFare: newFare }
        );
        
        // Notify accepted participants
        const acceptedParticipants = shareRide.participants.filter(p => p.status === 'accepted');
        
        acceptedParticipants.forEach(async (participant) => {
            await EnhancedFirebaseManager.sendNotification(
                participant.userId,
                'Fare Updated',
                `Share ride fare updated to ZMW ${newFare.toFixed(2)}`,
                'share_ride',
                { shareRideId: shareRideId, newFare: newFare }
            );
        });
    },
    
    listenToShareRideUpdates: function(shareRideId) {
        const shareRideRef = database.ref(`shareRides/${shareRideId}`);
        
        shareRideRef.on('value', (snapshot) => {
            const shareRide = snapshot.val();
            if (shareRide) {
                this.updateShareRideStatus(shareRide);
                
                // Check if all participants have paid
                if (this.checkAllPaymentsComplete(shareRide)) {
                    this.startShareRide(shareRideId, shareRide);
                }
            }
        });
    },
    
    updateShareRideStatus: function(shareRide) {
        const statusContainer = document.getElementById('shareRideStatus');
        if (!statusContainer) return;
        
        const acceptedCount = shareRide.participants.filter(p => p.status === 'accepted').length;
        const rejectedCount = shareRide.participants.filter(p => p.status === 'rejected').length;
        const pendingCount = shareRide.participants.filter(p => p.status === 'invited').length;
        
        statusContainer.innerHTML = `
            <div class="status-summary">
                <div class="status-item accepted">
                    <i class="fas fa-check-circle"></i>
                    <span>${acceptedCount} Accepted</span>
                </div>
                <div class="status-item rejected">
                    <i class="fas fa-times-circle"></i>
                    <span>${rejectedCount} Rejected</span>
                </div>
                <div class="status-item pending">
                    <i class="fas fa-clock"></i>
                    <span>${pendingCount} Pending</span>
                </div>
            </div>
        `;
        
        statusContainer.style.display = 'block';
    },
    
    checkAllPaymentsComplete: function(shareRide) {
        // Check host payment
        if (!shareRide.hostPayment || shareRide.hostPayment.status !== 'completed') {
            return false;
        }
        
        // Check all accepted participants have paid
        const acceptedParticipants = shareRide.participants.filter(p => p.status === 'accepted');
        
        return acceptedParticipants.every(participant => 
            participant.paymentStatus === 'completed'
        );
    },
    
    async startShareRide(shareRideId, shareRide) {
        try {
            // Update share ride status
            await database.ref(`shareRides/${shareRideId}/status`).set('ready');
            
            // Create actual ride
            const rideId = await EnhancedFirebaseManager.requestRide({
                ...shareRide.rideData,
                shareRideId: shareRideId,
                isShared: true,
                participants: [
                    { userId: shareRide.hostId, name: shareRide.hostName },
                    ...shareRide.participants.filter(p => p.status === 'accepted')
                ]
            });
            
            // Link ride to share ride
            await database.ref(`shareRides/${shareRideId}/rideId`).set(rideId);
            
            // Notify all participants
            await this.notifyShareRideStarted(shareRideId, rideId);
            
        } catch (error) {
            console.error('Start share ride error:', error);
        }
    },
    
    async notifyShareRideStarted(shareRideId, rideId) {
        const shareRideSnapshot = await database.ref(`shareRides/${shareRideId}`).once('value');
        const shareRide = shareRideSnapshot.val();
        
        if (!shareRide) return;
        
        // Notify host
        await EnhancedFirebaseManager.sendNotification(
            shareRide.hostId,
            'Share Ride Started',
            'Your share ride has been requested',
            'ride',
            { rideId: rideId }
        );
        
        // Notify accepted participants
        const acceptedParticipants = shareRide.participants.filter(p => p.status === 'accepted');
        
        acceptedParticipants.forEach(async (participant) => {
            await EnhancedFirebaseManager.sendNotification(
                participant.userId,
                'Share Ride Started',
                'The shared ride has been requested',
                'ride',
                { rideId: rideId }
            );
        });
    }
};

// ============================================
// BROADCAST RIDE MANAGER
// ============================================
const BroadcastRideManager = {
    currentBroadcast: null,
    
    init: function() {
        console.log('Broadcast Ride Manager initialized');
        this.setupBroadcastListeners();
    },
    
    setupBroadcastListeners: function() {
        // Broadcast ride button
        const broadcastRideBtn = document.getElementById('broadcastRideBtn');
        if (broadcastRideBtn) {
            broadcastRideBtn.addEventListener('click', () => {
                this.showBroadcastModal();
            });
        }
        
        // Start broadcast button
        const startBroadcastBtn = document.getElementById('startBroadcastBtn');
        if (startBroadcastBtn) {
            startBroadcastBtn.addEventListener('click', async () => {
                await this.startBroadcast();
            });
        }
        
        // Add broadcast member button
        const addBroadcastMemberBtn = document.getElementById('addBroadcastMemberBtn');
        if (addBroadcastMemberBtn) {
            addBroadcastMemberBtn.addEventListener('click', () => {
                this.addBroadcastMember();
            });
        }
    },
    
    showBroadcastModal: function() {
        if (!AppState.pickup || !AppState.destination) {
            EnhancedUIUpdater.showToast('Please select pickup and destination first', 'warning');
            return;
        }
        
        EnhancedUIUpdater.showModal('broadcast');
        
        // Reset broadcast session
        AppState.broadcastSession = {
            hostId: AppState.currentUser.uid,
            recipients: [],
            trackingEnabled: true,
            notificationsSent: false,
            rideData: {
                pickup: AppState.pickup,
                destination: AppState.destination,
                rideType: AppState.selectedRideType
            }
        };
        
        // Update fare display
        this.updateBroadcastFare();
    },
    
    updateBroadcastFare: function() {
        if (!AppState.activeRoute) return;
        
        const totalPrice = EnhancedPriceCalculator.calculateRidePrice(
            AppState.activeRoute.distance,
            AppState.activeRoute.duration,
            AppState.selectedRideType
        );
        
        // Update display
        const broadcastFare = document.getElementById('broadcastFare');
        const broadcastDistance = document.getElementById('broadcastDistance');
        const broadcastTime = document.getElementById('broadcastTime');
        
        if (broadcastFare) broadcastFare.textContent = `ZMW ${totalPrice.toFixed(2)}`;
        if (broadcastDistance) broadcastDistance.textContent = `${AppState.activeRoute.distance.toFixed(1)} km`;
        if (broadcastTime) broadcastTime.textContent = `ETA: ${Math.ceil(AppState.activeRoute.duration)} min`;
        
        AppState.rideFare = totalPrice;
    },
    
    async addBroadcastMember() {
        const memberInput = document.getElementById('broadcastMemberInput');
        if (!memberInput) return;
        
        const referralCode = memberInput.value.trim();
        if (!referralCode) {
            EnhancedUIUpdater.showToast('Please enter a referral code', 'warning');
            return;
        }
        
        // Check if already added
        if (AppState.broadcastSession.recipients.some(r => r.referralCode === referralCode)) {
            EnhancedUIUpdater.showToast('User already added', 'warning');
            return;
        }
        
        try {
            EnhancedUIUpdater.showLoading('Adding user...');
            
            // Find user by referral code
            const userSnapshot = await database.ref('users')
                .orderByChild('referralCode')
                .equalTo(referralCode)
                .once('value');
            
            const userData = userSnapshot.val();
            if (!userData) {
                throw new Error('User not found');
            }
            
            const userId = Object.keys(userData)[0];
            const user = userData[userId];
            
            // Check if adding self
            if (userId === AppState.currentUser.uid) {
                throw new Error('Cannot add yourself');
            }
            
            // Add to recipients
            AppState.broadcastSession.recipients.push({
                userId: userId,
                name: user.name,
                referralCode: referralCode,
                status: 'invited'
            });
            
            // Update UI
            this.updateBroadcastMembersList();
            
            memberInput.value = '';
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast(`${user.name} added to broadcast`, 'success');
            
        } catch (error) {
            console.error('Add broadcast member error:', error);
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast(error.message || 'Failed to add user', 'error');
        }
    },
    
    updateBroadcastMembersList: function() {
        const container = document.getElementById('broadcastMembersContainer');
        if (!container) return;
        
        container.innerHTML = '';
        
        AppState.broadcastSession.recipients.forEach((recipient, index) => {
            const memberElement = document.createElement('div');
            memberElement.className = 'broadcast-member-item';
            memberElement.innerHTML = `
                <div class="member-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="member-info">
                    <div class="member-name">${recipient.name}</div>
                    <div class="member-status ${recipient.status}">${recipient.status}</div>
                </div>
                <button class="remove-member-btn" data-index="${index}">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(memberElement);
            
            // Add remove event listener
            const removeBtn = memberElement.querySelector('.remove-member-btn');
            if (removeBtn) {
                removeBtn.addEventListener('click', () => {
                    this.removeBroadcastMember(index);
                });
            }
        });
    },
    
    removeBroadcastMember: function(index) {
        AppState.broadcastSession.recipients.splice(index, 1);
        this.updateBroadcastMembersList();
    },
    
    async startBroadcast() {
        if (AppState.broadcastSession.recipients.length === 0) {
            EnhancedUIUpdater.showToast('Please add at least one recipient', 'warning');
            return;
        }
        
        if (!AppState.pickup || !AppState.destination) {
            EnhancedUIUpdater.showToast('Please select pickup and destination', 'warning');
            return;
        }
        
        try {
            EnhancedUIUpdater.showLoading('Starting broadcast...');
            
            // Create broadcast record
            const broadcastId = database.ref().child('broadcasts').push().key;
            
            const broadcastData = {
                id: broadcastId,
                hostId: AppState.currentUser.uid,
                hostName: AppState.userData.name,
                recipients: AppState.broadcastSession.recipients,
                rideData: {
                    pickup: AppState.pickup,
                    destination: AppState.destination,
                    rideType: AppState.selectedRideType,
                    distance: AppState.activeRoute?.distance || 0,
                    duration: AppState.activeRoute?.duration || 0,
                    fare: AppState.rideFare
                },
                status: 'active',
                timestamp: Date.now(),
                city: AppState.currentCity,
                trackingEnabled: AppState.broadcastSession.trackingEnabled
            };
            
            await database.ref(`broadcasts/${broadcastId}`).set(broadcastData);
            
            // Send invitations to all recipients
            await this.sendBroadcastInvitations(broadcastId, broadcastData);
            
            // Create actual ride
            const rideId = await EnhancedFirebaseManager.requestRide({
                ...broadcastData.rideData,
                broadcastId: broadcastId,
                isBroadcast: true
            });
            
            // Link ride to broadcast
            await database.ref(`broadcasts/${broadcastId}/rideId`).set(rideId);
            
            // Start tracking broadcast
            this.startBroadcastTracking(broadcastId, rideId);
            
            EnhancedUIUpdater.hideModal('broadcast');
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Broadcast started successfully', 'success');
            
        } catch (error) {
            console.error('Start broadcast error:', error);
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Failed to start broadcast', 'error');
        }
    },
    
    async sendBroadcastInvitations(broadcastId, broadcastData) {
        const invitations = AppState.broadcastSession.recipients.map(async (recipient) => {
            // Create invitation record
            const invitationId = database.ref().child('broadcastInvitations').push().key;
            
            const invitation = {
                id: invitationId,
                broadcastId: broadcastId,
                hostId: AppState.currentUser.uid,
                hostName: AppState.userData.name,
                recipientId: recipient.userId,
                recipientName: recipient.name,
                rideData: broadcastData.rideData,
                status: 'sent',
                timestamp: Date.now()
            };
            
            await database.ref(`broadcastInvitations/${invitationId}`).set(invitation);
            
            // Send notification to recipient
            await EnhancedFirebaseManager.sendNotification(
                recipient.userId,
                'Ride Broadcast',
                `${AppState.userData.name} is sharing their ride with you`,
                'broadcast',
                { 
                    broadcastId: broadcastId,
                    invitationId: invitationId,
                    action: 'view_broadcast'
                }
            );
            
            return invitationId;
        });
        
        await Promise.all(invitations);
    },
    
    startBroadcastTracking: function(broadcastId, rideId) {
        AppState.currentBroadcast = broadcastId;
        
        // Listen to ride updates
        const rideRef = database.ref(`rides/${rideId}`);
        
        rideRef.on('value', async (snapshot) => {
            const ride = snapshot.val();
            if (ride) {
                // Update broadcast with ride status
                await database.ref(`broadcasts/${broadcastId}/rideStatus`).set(ride.status);
                
                // Update driver location if available
                if (ride.driverLocation) {
                    await database.ref(`broadcasts/${broadcastId}/driverLocation`).set(ride.driverLocation);
                }
                
                // Send updates to recipients
                await this.sendBroadcastUpdate(broadcastId, ride);
            }
        });
    },
    
    async sendBroadcastUpdate(broadcastId, ride) {
        const broadcastSnapshot = await database.ref(`broadcasts/${broadcastId}`).once('value');
        const broadcast = broadcastSnapshot.val();
        
        if (!broadcast) return;
        
        // Prepare update message based on ride status
        let message = '';
        switch(ride.status) {
            case 'requested':
                message = `${broadcast.hostName} has requested a ride`;
                break;
            case 'accepted':
                message = `Driver assigned for ${broadcast.hostName}'s ride`;
                break;
            case 'arrived':
                message = `Driver has arrived for ${broadcast.hostName}'s ride`;
                break;
            case 'started':
                message = `${broadcast.hostName}'s ride has started`;
                break;
            case 'completed':
                message = `${broadcast.hostName}'s ride has been completed`;
                break;
        }
        
        // Send notifications to all recipients
        broadcast.recipients.forEach(async (recipient) => {
            if (recipient.status === 'invited') {
                await EnhancedFirebaseManager.sendNotification(
                    recipient.userId,
                    'Ride Update',
                    message,
                    'broadcast_update',
                    { broadcastId: broadcastId, rideStatus: ride.status }
                );
            }
        });
    }
};

// ============================================
// SHOPPING MODULE MANAGER
// ============================================
const ShoppingModuleManager = {
    currentShop: null,
    shoppingCart: [],
    shoppingCategories: [],
    
    init: function() {
        console.log('Shopping Module Manager initialized');
        this.loadShoppingCategories();
        this.setupShoppingListeners();
    },
    
    loadShoppingCategories: function() {
        this.shoppingCategories = [
            {
                id: 'restaurants',
                name: 'Restaurants',
                icon: 'fa-utensils',
                brands: ['Pizza', 'Nando\'s', 'Hungry Lion'],
                type: 'restaurant'
            },
            {
                id: 'pharmacies',
                name: 'Pharmacies',
                icon: 'fa-pills',
                brands: ['Medicine', 'Pharmacy', 'Drugstore'],
                type: 'pharmacy'
            },
            {
                id: 'supermarkets',
                name: 'Supermarkets',
                icon: 'fa-shopping-cart',
                brands: ['Shoprite', 'Pick n Pay', 'Spar'],
                type: 'supermarket'
            },
            {
                id: 'malls',
                name: 'Shopping Malls',
                icon: 'fa-store',
                brands: ['Mall', 'Shopping Centre', 'Plaza'],
                type: 'mall'
            }
        ];
    },
    
    setupShoppingListeners: function() {
        // Shopping service tab
        const shoppingTab = document.querySelector('.service-tab[data-service="express"]');
        if (shoppingTab) {
            shoppingTab.addEventListener('click', () => {
                this.showShoppingInterface();
            });
        }
        
        // Add item button
        const addItemBtn = document.getElementById('addItemBtn');
        if (addItemBtn) {
            addItemBtn.addEventListener('click', () => {
                this.addShoppingItem();
            });
        }
        
        // Shop search
        const shopNameInput = document.getElementById('shopName');
        if (shopNameInput) {
            shopNameInput.addEventListener('input', (e) => {
                this.searchShops(e.target.value);
            });
        }
        
        // Request shopping button
        const requestShoppingBtn = document.getElementById('requestShoppingBtn');
        if (requestShoppingBtn) {
            requestShoppingBtn.addEventListener('click', async () => {
                await this.requestShopping();
            });
        }
    },
    
    showShoppingInterface: function() {
        // Show category buttons
        this.renderShoppingCategories();
        
        // Initialize shopping cart
        this.renderShoppingCart();
    },
    
    renderShoppingCategories: function() {
        const categoriesContainer = document.getElementById('shoppingCategories');
        if (!categoriesContainer) {
            // Create categories container
            const expressForm = document.getElementById('expressForm');
            if (expressForm) {
                const categoriesHTML = `
                    <div class="shopping-categories" id="shoppingCategories">
                        <div class="section-title">
                            <i class="fas fa-store"></i>
                            Shop Categories
                        </div>
                        <div class="categories-grid">
                            ${this.shoppingCategories.map(category => `
                                <div class="category-card" data-category="${category.id}">
                                    <div class="category-icon">
                                        <i class="fas ${category.icon}"></i>
                                    </div>
                                    <div class="category-name">${category.name}</div>
                                    <div class="category-brands">
                                        ${category.brands.map(brand => `<span class="brand-tag">${brand}</span>`).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                expressForm.insertAdjacentHTML('afterbegin', categoriesHTML);
                
                // Add event listeners to category cards
                document.querySelectorAll('.category-card').forEach(card => {
                    card.addEventListener('click', () => {
                        this.handleCategorySelect(card.dataset.category);
                    });
                });
            }
        }
    },
    
    handleCategorySelect: function(categoryId) {
        const category = this.shoppingCategories.find(c => c.id === categoryId);
        if (!category) return;
        
        this.showShopSelectionModal(category);
    },
    
    showShopSelectionModal: async function(category) {
        EnhancedUIUpdater.showLoading(`Loading ${category.name}...`);
        
        try {
            // Search for shops in this category
            let shops = [];
            
            // Search for each brand in the category
            for (const brand of category.brands) {
                const results = await EnhancedSearchEngine.searchMultiProvider(
                    `${brand} ${AppState.currentCity}`,
                    AppState.currentCity
                );
                
                shops = shops.concat(results.filter(shop => 
                    shop.category === category.type || 
                    shop.name.toLowerCase().includes(brand.toLowerCase())
                ));
            }
            
            // Remove duplicates
            shops = shops.filter((shop, index, self) =>
                index === self.findIndex(s => s.id === shop.id)
            );
            
            // Sort by distance
            shops.sort((a, b) => a.distance - b.distance);
            
            EnhancedUIUpdater.hideLoading();
            this.renderShopSelectionModal(category, shops.slice(0, 10));
            
        } catch (error) {
            console.error('Shop search error:', error);
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Error loading shops', 'error');
        }
    },
    
    renderShopSelectionModal: function(category, shops) {
        const modalHTML = `
            <div class="modal-overlay" id="shopSelectionModal">
                <div class="modal">
                    <div class="modal-header">
                        <div class="modal-title">
                            <i class="fas ${category.icon}"></i>
                            Select ${category.name}
                        </div>
                        <button class="modal-close" onclick="EnhancedUIUpdater.hideModal('shopSelection')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-content">
                        <div class="shop-list">
                            ${shops.length > 0 ? shops.map(shop => `
                                <div class="shop-item" data-shop-id="${shop.id}">
                                    <div class="shop-icon">
                                        <i class="fas ${category.icon}"></i>
                                    </div>
                                    <div class="shop-details">
                                        <div class="shop-name">${shop.name}</div>
                                        <div class="shop-address">${shop.address}</div>
                                        <div class="shop-distance">${shop.distance?.toFixed(1) || '?'} km away</div>
                                    </div>
                                    <button class="select-shop-btn" data-shop='${JSON.stringify(shop)}'>
                                        <i class="fas fa-check"></i> Select
                                    </button>
                                </div>
                            `).join('') : `
                                <div class="no-results">
                                    <i class="fas fa-search"></i>
                                    <div>No ${category.name} found in ${AppState.currentCity}</div>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Add modal to body
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        
        // Add event listeners to select buttons
        document.querySelectorAll('.select-shop-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const shopData = JSON.parse(btn.dataset.shop);
                this.selectShop(shopData, category);
                EnhancedUIUpdater.hideModal('shopSelection');
            });
        });
        
        // Show modal
        const modal = document.getElementById('shopSelectionModal');
        if (modal) {
            modal.style.display = 'block';
        }
    },
    
    selectShop: function(shop, category) {
        AppState.shoppingSession.selectedShop = {
            ...shop,
            category: category
        };
        
        // Update shop name input
        const shopNameInput = document.getElementById('shopName');
        if (shopNameInput) {
            shopNameInput.value = shop.name;
            shopNameInput.dataset.lat = shop.lat;
            shopNameInput.dataset.lng = shop.lng;
        }
        
        // Update shop location input
        const shopLocationInput = document.getElementById('shopLocation');
        if (shopLocationInput) {
            shopLocationInput.value = shop.address;
        }
        
        // Update pickup location
        AppState.pickup = shop;
        EnhancedUIUpdater.updatePickupMarker(shop);
        
        // Show shop details
        this.showShopDetails(shop, category);
        
        EnhancedUIUpdater.showToast(`${shop.name} selected`, 'success');
    },
    
    showShopDetails: function(shop, category) {
        const detailsContainer = document.getElementById('shopDetails');
        if (!detailsContainer) {
            const expressForm = document.getElementById('expressForm');
            if (expressForm) {
                const detailsHTML = `
                    <div class="shop-details-card" id="shopDetails">
                        <div class="shop-header">
                            <div class="shop-icon-large">
                                <i class="fas ${category.icon}"></i>
                            </div>
                            <div class="shop-info">
                                <div class="shop-name-large">${shop.name}</div>
                                <div class="shop-category">${category.name}</div>
                                <div class="shop-address">${shop.address}</div>
                            </div>
                        </div>
                        <div class="shop-distance-info">
                            <i class="fas fa-road"></i>
                            <span>${shop.distance?.toFixed(1) || '?'} km from your location</span>
                        </div>
                    </div>
                `;
                
                // Insert after categories
                const categories = document.getElementById('shoppingCategories');
                if (categories) {
                    categories.insertAdjacentHTML('afterend', detailsHTML);
                }
            }
        }
    },
    
    addShoppingItem: function() {
        const itemsContainer = document.getElementById('shoppingItems');
        if (!itemsContainer) return;
        
        const itemCount = itemsContainer.children.length;
        if (itemCount >= 20) {
            EnhancedUIUpdater.showToast('Maximum 20 items allowed', 'warning');
            return;
        }
        
        const itemEntry = document.createElement('div');
        itemEntry.className = 'item-entry';
        itemEntry.innerHTML = `
            <input type="text" class="item-input" placeholder="Item name" data-item-id="${Date.now()}">
            <input type="number" class="item-price" placeholder="Price (ZMW)" min="0" step="0.01">
            <input type="number" class="item-quantity" placeholder="Qty" min="1" value="1">
            <button class="remove-item" type="button">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        itemsContainer.appendChild(itemEntry);
        
        // Add event listener to remove button
        const removeBtn = itemEntry.querySelector('.remove-item');
        if (removeBtn) {
            removeBtn.addEventListener('click', () => {
                itemEntry.remove();
                this.updateShoppingCart();
            });
        }
        
        // Add event listeners to inputs
        const inputs = itemEntry.querySelectorAll('input');
        inputs.forEach(input => {
            input.addEventListener('input', () => {
                this.updateShoppingCart();
            });
        });
    },
    
    updateShoppingCart: function() {
        const itemsContainer = document.getElementById('shoppingItems');
        if (!itemsContainer) return;
        
        const itemEntries = itemsContainer.querySelectorAll('.item-entry');
        AppState.shoppingSession.items = [];
        
        let totalBudget = 0;
        
        itemEntries.forEach(entry => {
            const nameInput = entry.querySelector('.item-input');
            const priceInput = entry.querySelector('.item-price');
            const quantityInput = entry.querySelector('.item-quantity');
            
            const name = nameInput?.value.trim();
            const price = parseFloat(priceInput?.value) || 0;
            const quantity = parseInt(quantityInput?.value) || 1;
            
            if (name) {
                AppState.shoppingSession.items.push({
                    name: name,
                    price: price,
                    quantity: quantity,
                    total: price * quantity
                });
                
                totalBudget += price * quantity;
            }
        });
        
        AppState.shoppingSession.totalBudget = totalBudget;
        
        // Update budget input
        const budgetInput = document.getElementById('shoppingBudget');
        if (budgetInput) {
            budgetInput.value = totalBudget.toFixed(2);
        }
        
        // Update price calculation
        EnhancedPriceCalculator.calculateShoppingPrice();
    },
    
    renderShoppingCart: function() {
        const cartContainer = document.getElementById('shoppingCartSummary');
        if (!cartContainer) {
            const expressForm = document.getElementById('expressForm');
            if (expressForm) {
                const cartHTML = `
                    <div class="shopping-cart-summary" id="shoppingCartSummary">
                        <div class="section-title">
                            <i class="fas fa-shopping-bag"></i>
                            Shopping Cart
                        </div>
                        <div class="cart-items" id="cartItemsList">
                            <!-- Items will be added here -->
                        </div>
                        <div class="cart-total">
                            <span>Estimated Total:</span>
                            <span id="cartTotalAmount">ZMW 0.00</span>
                        </div>
                    </div>
                `;
                
                // Insert before action buttons
                const actionButtons = expressForm.querySelector('.action-buttons');
                if (actionButtons) {
                    actionButtons.insertAdjacentHTML('beforebegin', cartHTML);
                }
            }
        }
    },
    
    async requestShopping() {
        if (!AppState.shoppingSession.selectedShop) {
            EnhancedUIUpdater.showToast('Please select a shop first', 'warning');
            return;
        }
        
        if (AppState.shoppingSession.items.length === 0) {
            EnhancedUIUpdater.showToast('Please add items to your shopping list', 'warning');
            return;
        }
        
        if (!AppState.destination) {
            EnhancedUIUpdater.showToast('Please select delivery address', 'warning');
            return;
        }
        
        const shoppingData = {
            shop: AppState.shoppingSession.selectedShop,
            items: AppState.shoppingSession.items,
            totalBudget: AppState.shoppingSession.totalBudget,
            instructions: document.getElementById('shoppingInstructions')?.value || '',
            pickup: AppState.shoppingSession.selectedShop,
            destination: AppState.destination,
            rideType: 'standard',
            fare: AppState.rideFare,
            distance: AppState.activeRoute?.distance || 0,
            duration: AppState.activeRoute?.duration || 0,
            serviceType: 'shopping'
        };
        
        // Show payment modal
        EnhancedUIUpdater.showPaymentModal('shopping', AppState.rideFare, shoppingData);
    }
};

// ============================================
// EMERGENCY SYSTEM MANAGER
// ============================================
const EmergencySystemManager = {
    emergencyTypes: ['police', 'medical', 'fire'],
    currentEmergency: null,
    nearbyStations: [],
    
    init: function() {
        console.log('Emergency System Manager initialized');
        this.setupEmergencyListeners();
    },
    
    setupEmergencyListeners: function() {
        // Emergency service buttons
        document.querySelectorAll('.emergency-service').forEach(service => {
            service.addEventListener('click', () => {
                const type = service.dataset.type;
                if (type === 'sos') {
                    this.triggerSOS();
                } else {
                    this.handleEmergencyService(type);
                }
            });
        });
        
        // Emergency reasons
        document.querySelectorAll('.emergency-reason').forEach(reason => {
            reason.addEventListener('click', (e) => {
                this.selectEmergencyReason(e.target.closest('.emergency-reason').dataset.reason);
            });
        });
        
        // Confirm emergency button
        const confirmEmergencyBtn = document.getElementById('confirmEmergencyBtn');
        if (confirmEmergencyBtn) {
            confirmEmergencyBtn.addEventListener('click', async () => {
                await this.confirmEmergencyRequest();
            });
        }
        
        // SOS button
        const sosButton = document.getElementById('sosButton');
        if (sosButton) {
            sosButton.addEventListener('click', () => {
                this.triggerSOS();
            });
        }
        
        // SOS setup button
        const sosSetupBtn = document.getElementById('sosSetupBtn');
        if (sosSetupBtn) {
            sosSetupBtn.addEventListener('click', () => {
                this.showSOSSetupModal();
            });
        }
        
        // Save SOS button
        const saveSOSBtn = document.getElementById('saveSOSBtn');
        if (saveSOSBtn) {
            saveSOSBtn.addEventListener('click', async () => {
                await this.saveSOSSetup();
            });
        }
    },
    
    async handleEmergencyService(type) {
        if (!AppState.userLocation) {
            EnhancedUIUpdater.showToast('Please allow location access for emergency services', 'warning');
            return;
        }
        
        if (!AppState.currentCity) {
            EnhancedUIUpdater.showToast('Detecting your city...', 'warning');
            return;
        }
        
        AppState.emergencySession.type = type;
        
        try {
            EnhancedUIUpdater.showLoading(`Loading ${type} stations...`);
            
            // Load emergency stations
            await this.loadEmergencyStations(type);
            
            // Update emergency service type display
            const emergencyServiceType = document.getElementById('emergencyServiceType');
            if (emergencyServiceType) {
                emergencyServiceType.textContent = this.getEmergencyServiceName(type);
                emergencyServiceType.dataset.type = type;
            }
            
            // Update user location display
            const emergencyUserLocation = document.getElementById('emergencyUserLocation');
            if (emergencyUserLocation && AppState.userLocation) {
                emergencyUserLocation.textContent = `Lat: ${AppState.userLocation.lat.toFixed(6)}, Lng: ${AppState.userLocation.lng.toFixed(6)}`;
            }
            
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showModal('emergency');
            
        } catch (error) {
            console.error('Emergency service error:', error);
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Failed to load emergency stations', 'error');
        }
    },
    
    async loadEmergencyStations(type) {
        try {
            let stations = [];
            
            // Search for stations based on type
            let query = '';
            switch(type) {
                case 'police':
                    query = 'police station';
                    break;
                case 'medical':
                    query = 'hospital clinic';
                    break;
                case 'fire':
                    query = 'fire station';
                    break;
            }
            
            const results = await EnhancedSearchEngine.searchMultiProvider(
                `${query} ${AppState.currentCity}`,
                AppState.currentCity
            );
            
            // Filter and process stations
            stations = results
                .filter(result => {
                    const name = result.name.toLowerCase();
                    switch(type) {
                        case 'police':
                            return name.includes('police') || name.includes('station');
                        case 'medical':
                            return name.includes('hospital') || name.includes('clinic') || name.includes('medical');
                        case 'fire':
                            return name.includes('fire') || name.includes('brigade');
                        default:
                            return true;
                    }
                })
                .map(station => ({
                    ...station,
                    type: type,
                    distance: station.distance || EnhancedSearchEngine.calculateDistance(
                        AppState.userLocation.lat, AppState.userLocation.lng,
                        station.lat, station.lng
                    )
                }))
                .sort((a, b) => a.distance - b.distance)
                .slice(0, 5);
            
            this.nearbyStations = stations;
            this.renderEmergencyStations();
            
            // Update price calculation
            if (stations.length > 0) {
                this.updateEmergencyPrice(stations[0]);
            }
            
        } catch (error) {
            console.error('Load emergency stations error:', error);
            throw error;
        }
    },
    
    renderEmergencyStations: function() {
        const container = document.getElementById('emergencyStations');
        if (!container) return;
        
        container.innerHTML = '';
        
        if (this.nearbyStations.length === 0) {
            container.innerHTML = `
                <div class="no-results">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>No ${this.getEmergencyServiceName(AppState.emergencySession.type)} stations found nearby</div>
                </div>
            `;
            return;
        }
        
        this.nearbyStations.forEach((station, index) => {
            const stationElement = document.createElement('div');
            stationElement.className = `emergency-station ${index === 0 ? 'selected' : ''}`;
            stationElement.dataset.stationIndex = index;
            stationElement.innerHTML = `
                <div class="station-header">
                    <div class="station-name">${station.name}</div>
                    <div class="station-distance">${station.distance.toFixed(1)} km</div>
                </div>
                <div class="station-address">${station.address}</div>
                <div class="station-type">${this.getEmergencyServiceName(station.type)}</div>
            `;
            
            stationElement.addEventListener('click', () => {
                // Remove selected class from all stations
                container.querySelectorAll('.emergency-station').forEach(s => {
                    s.classList.remove('selected');
                });
                
                // Add selected class to clicked station
                stationElement.classList.add('selected');
                
                // Update selected station
                AppState.emergencySession.stationId = station.id;
                AppState.selectedEmergencyStation = station;
                
                // Update price
                this.updateEmergencyPrice(station);
            });
            
            container.appendChild(stationElement);
        });
        
        // Set first station as selected
        if (this.nearbyStations.length > 0) {
            AppState.emergencySession.stationId = this.nearbyStations[0].id;
            AppState.selectedEmergencyStation = this.nearbyStations[0];
        }
    },
    
    updateEmergencyPrice: function(station) {
        if (!station || !AppState.userLocation) return;
        
        const distance = station.distance || EnhancedSearchEngine.calculateDistance(
            AppState.userLocation.lat, AppState.userLocation.lng,
            station.lat, station.lng
        );
        
        const price = EnhancedPriceCalculator.calculateEmergencyPrice(
            AppState.emergencySession.type,
            distance
        );
        
        const time = Math.ceil((distance / 40) * 60); // Estimated time in minutes
        
        // Update display
        const emergencyDistance = document.getElementById('emergencyDistance');
        const emergencyTime = document.getElementById('emergencyTime');
        const emergencyTotalFare = document.getElementById('emergencyTotalFare');
        
        if (emergencyDistance) emergencyDistance.textContent = `${distance.toFixed(1)} km`;
        if (emergencyTime) emergencyTime.textContent = `${time} min`;
        if (emergencyTotalFare) emergencyTotalFare.textContent = `ZMW ${price.toFixed(2)}`;
        
        AppState.rideFare = price;
    },
    
    selectEmergencyReason: function(reason) {
        AppState.emergencySession.reason = reason;
        
        // Update UI
        document.querySelectorAll('.emergency-reason').forEach(el => {
            el.classList.remove('selected');
        });
        
        const selectedReason = document.querySelector(`.emergency-reason[data-reason="${reason}"]`);
        if (selectedReason) {
            selectedReason.classList.add('selected');
        }
        
        // Show/hide other reason input
        const otherReasonInput = document.getElementById('emergencyReasonOther');
        if (otherReasonInput) {
            otherReasonInput.style.display = reason === 'other' ? 'block' : 'none';
        }
    },
    
    getEmergencyServiceName: function(type) {
        switch(type) {
            case 'police': return 'Police';
            case 'medical': return 'Medical';
            case 'fire': return 'Fire Brigade';
            default: return 'Emergency';
        }
    },
    
    async confirmEmergencyRequest() {
        if (!AppState.emergencySession.reason) {
            EnhancedUIUpdater.showToast('Please select an emergency reason', 'warning');
            return;
        }
        
        if (!AppState.selectedEmergencyStation) {
            EnhancedUIUpdater.showToast('Please select an emergency station', 'warning');
            return;
        }
        
        // Get other reason text if applicable
        let reasonDetails = AppState.emergencySession.reason;
        if (reasonDetails === 'other') {
            const otherReasonText = document.getElementById('emergencyOtherReason')?.value.trim();
            if (!otherReasonText) {
                EnhancedUIUpdater.showToast('Please describe the emergency', 'warning');
                return;
            }
            reasonDetails = `other: ${otherReasonText}`;
        }
        
        // Get destination if provided
        const emergencyDestination = document.getElementById('emergencyDestination')?.value;
        let destination = null;
        
        if (emergencyDestination) {
            // Search for destination
            const results = await EnhancedSearchEngine.searchMultiProvider(
                emergencyDestination,
                AppState.currentCity
            );
            
            if (results.length > 0) {
                destination = results[0];
            }
        }
        
        const emergencyData = {
            type: AppState.emergencySession.type,
            station: AppState.selectedEmergencyStation,
            reason: reasonDetails,
            userLocation: AppState.userLocation,
            destination: destination,
            fare: AppState.rideFare,
            timestamp: Date.now(),
            userId: AppState.currentUser.uid,
            userName: AppState.userData.name,
            userPhone: AppState.userData.phone
        };
        
        // Show confirmation dialog
        if (confirm(`Request ${this.getEmergencyServiceName(AppState.emergencySession.type)} emergency? This is for genuine emergencies only.`)) {
            await this.sendEmergencyRequest(emergencyData);
        }
    },
    
    async sendEmergencyRequest(emergencyData) {
        try {
            EnhancedUIUpdater.showLoading('Requesting emergency service...');
            
            // Create emergency record
            const emergencyId = database.ref().child('emergencies').push().key;
            
            const emergencyRecord = {
                id: emergencyId,
                ...emergencyData,
                status: 'requested',
                city: AppState.currentCity
            };
            
            await database.ref(`emergencies/${emergencyId}`).set(emergencyRecord);
            
            // Create ride record
            const rideId = await EnhancedFirebaseManager.requestRide({
                pickup: emergencyData.userLocation,
                destination: emergencyData.destination || emergencyData.station,
                rideType: 'emergency',
                fare: emergencyData.fare,
                emergency: true,
                emergencyType: emergencyData.type,
                emergencyReason: emergencyData.reason,
                emergencyId: emergencyId
            });
            
            // Link ride to emergency
            await database.ref(`emergencies/${emergencyId}/rideId`).set(rideId);
            
            // Send notifications to emergency contacts if configured
            if (AppState.sosConfig) {
                await this.notifyEmergencyContacts(emergencyRecord);
            }
            
            EnhancedUIUpdater.hideModal('emergency');
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Emergency service requested. Help is on the way.', 'success');
            
        } catch (error) {
            console.error('Emergency request error:', error);
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Failed to request emergency service', 'error');
        }
    },
    
    async notifyEmergencyContacts(emergencyData) {
        const contacts = [];
        
        if (AppState.sosConfig.contact1Phone) {
            contacts.push({
                name: AppState.sosConfig.contact1Name || 'Contact 1',
                phone: AppState.sosConfig.contact1Phone
            });
        }
        
        if (AppState.sosConfig.contact2Phone) {
            contacts.push({
                name: AppState.sosConfig.contact2Name || 'Contact 2',
                phone: AppState.sosConfig.contact2Phone
            });
        }
        
        // In a real app, you would send SMS or make calls here
        // For now, just log the notification
        console.log('Notifying emergency contacts:', contacts);
        console.log('Emergency details:', emergencyData);
        
        // Send app notifications
        contacts.forEach(async (contact) => {
            // Find user by phone number
            const userSnapshot = await database.ref('users')
                .orderByChild('phone')
                .equalTo(contact.phone)
                .once('value');
            
            const userData = userSnapshot.val();
            if (userData) {
                const userId = Object.keys(userData)[0];
                
                await EnhancedFirebaseManager.sendNotification(
                    userId,
                    'EMERGENCY ALERT',
                    `${AppState.userData.name} has triggered an emergency alert`,
                    'emergency',
                    {
                        emergencyId: emergencyData.id,
                        emergencyType: emergencyData.type,
                        userLocation: emergencyData.userLocation
                    }
                );
            }
        });
    },
    
    triggerSOS: function() {
        if (!AppState.sosConfig) {
            EnhancedUIUpdater.showToast('Please setup SOS contacts first', 'warning');
            this.showSOSSetupModal();
            return;
        }
        
        if (!AppState.currentRide) {
            EnhancedUIUpdater.showToast('No active ride to report SOS for', 'warning');
            return;
        }
        
        if (!confirm('Trigger SOS emergency alert? This will notify your emergency contacts.')) {
            return;
        }
        
        const sosData = {
            rideId: AppState.currentRide.id,
            userLocation: AppState.userLocation,
            timestamp: Date.now(),
            contacts: [
                {
                    name: AppState.sosConfig.contact1Name,
                    phone: AppState.sosConfig.contact1Phone
                },
                {
                    name: AppState.sosConfig.contact2Name,
                    phone: AppState.sosConfig.contact2Phone
                }
            ].filter(contact => contact.phone),
            message: AppState.sosConfig.message || 'I need help!'
        };
        
        this.sendSOSAlert(sosData);
    },
    
    async sendSOSAlert(sosData) {
        try {
            EnhancedUIUpdater.showLoading('Sending SOS alert...');
            
            // Create SOS record
            const sosId = database.ref().child('sosAlerts').push().key;
            
            const sosRecord = {
                id: sosId,
                ...sosData,
                userId: AppState.currentUser.uid,
                userName: AppState.userData.name,
                status: 'active'
            };
            
            await database.ref(`sosAlerts/${sosId}`).set(sosRecord);
            
            // Notify emergency contacts
            await this.notifySOSContacts(sosRecord);
            
            // Notify nearby drivers
            await this.notifyNearbyDrivers(sosRecord);
            
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('SOS alert sent to emergency contacts', 'success');
            
        } catch (error) {
            console.error('SOS alert error:', error);
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Failed to send SOS alert', 'error');
        }
    },
    
    async notifySOSContacts(sosRecord) {
        // Send SMS notifications (simulated)
        console.log('Sending SOS notifications to:', sosRecord.contacts);
        
        // In a real app, integrate with SMS gateway
        // For now, just send app notifications
        sosRecord.contacts.forEach(async (contact) => {
            // Find user by phone
            const userSnapshot = await database.ref('users')
                .orderByChild('phone')
                .equalTo(contact.phone)
                .once('value');
            
            const userData = userSnapshot.val();
            if (userData) {
                const userId = Object.keys(userData)[0];
                
                await EnhancedFirebaseManager.sendNotification(
                    userId,
                    'SOS EMERGENCY',
                    `${sosRecord.userName} needs help! Location: ${sosRecord.userLocation.lat}, ${sosRecord.userLocation.lng}`,
                    'emergency',
                    {
                        sosId: sosRecord.id,
                        userLocation: sosRecord.userLocation,
                        rideId: sosRecord.rideId
                    }
                );
            }
        });
    },
    
    async notifyNearbyDrivers(sosRecord) {
        // Find nearby drivers
        const driversRef = database.ref('driverLocations');
        
        driversRef.once('value', async (snapshot) => {
            const drivers = snapshot.val();
            if (!drivers) return;
            
            Object.entries(drivers).forEach(async ([driverId, location]) => {
                const distance = EnhancedSearchEngine.calculateDistance(
                    sosRecord.userLocation.lat, sosRecord.userLocation.lng,
                    location.latitude, location.longitude
                );
                
                // Notify drivers within 5km
                if (distance < 5) {
                    await EnhancedFirebaseManager.sendNotification(
                        driverId,
                        'SOS ALERT - Nearby Passenger',
                        'A nearby passenger needs emergency assistance',
                        'emergency',
                        {
                            sosId: sosRecord.id,
                            userLocation: sosRecord.userLocation,
                            distance: distance
                        }
                    );
                }
            });
        });
    },
    
    showSOSSetupModal: function() {
        EnhancedUIUpdater.showModal('sos');
        
        // Load existing SOS config
        if (AppState.sosConfig) {
            const contact1Name = document.getElementById('sosContact1Name');
            const contact1Phone = document.getElementById('sosContact1Phone');
            const contact2Name = document.getElementById('sosContact2Name');
            const contact2Phone = document.getElementById('sosContact2Phone');
            const sosMessage = document.getElementById('sosMessage');
            
            if (contact1Name) contact1Name.value = AppState.sosConfig.contact1Name || '';
            if (contact1Phone) contact1Phone.value = AppState.sosConfig.contact1Phone || '';
            if (contact2Name) contact2Name.value = AppState.sosConfig.contact2Name || '';
            if (contact2Phone) contact2Phone.value = AppState.sosConfig.contact2Phone || '';
            if (sosMessage) sosMessage.value = AppState.sosConfig.message || '';
        }
    },
    
    async saveSOSSetup() {
        const contact1Name = document.getElementById('sosContact1Name')?.value.trim();
        const contact1Phone = document.getElementById('sosContact1Phone')?.value.trim();
        const contact2Name = document.getElementById('sosContact2Name')?.value.trim();
        const contact2Phone = document.getElementById('sosContact2Phone')?.value.trim();
        const sosMessage = document.getElementById('sosMessage')?.value.trim();
        
        if (!contact1Phone) {
            EnhancedUIUpdater.showToast('Primary contact phone number is required', 'warning');
            return;
        }
        
        try {
            EnhancedUIUpdater.showLoading('Saving SOS setup...');
            
            const sosConfig = {
                contact1Name: contact1Name || 'Emergency Contact 1',
                contact1Phone: contact1Phone,
                contact2Name: contact2Name || '',
                contact2Phone: contact2Phone || '',
                message: sosMessage || 'I need help! My current location and ride details will be shared with you.',
                userId: AppState.currentUser.uid,
                updatedAt: Date.now()
            };
            
            await database.ref(`sosConfig/${AppState.currentUser.uid}`).set(sosConfig);
            
            AppState.sosConfig = sosConfig;
            
            EnhancedUIUpdater.hideModal('sos');
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('SOS setup saved successfully', 'success');
            
        } catch (error) {
            console.error('Save SOS setup error:', error);
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Failed to save SOS setup', 'error');
        }
    }
};

// ============================================
// ENHANCED NOTIFICATION MANAGER
// ============================================
const EnhancedNotificationManager = {
    notificationSound: null,
    vibrationEnabled: true,
    permissionGranted: false,
    
    init: function() {
        console.log('Enhanced Notification Manager initialized');
        this.requestPermission();
        this.setupNotificationListeners();
        this.loadNotificationSound();
    },
    
    requestPermission: function() {
        if (!("Notification" in window)) {
            console.log("This browser does not support notifications");
            return;
        }
        
        if (Notification.permission === "granted") {
            this.permissionGranted = true;
        } else if (Notification.permission !== "denied") {
            Notification.requestPermission().then(permission => {
                this.permissionGranted = permission === "granted";
            });
        }
    },
    
    loadNotificationSound: function() {
        this.notificationSound = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA==');
    },
    
    setupNotificationListeners: function() {
        // Notification bell
        const notificationBell = document.getElementById('notificationBell');
        if (notificationBell) {
            notificationBell.addEventListener('click', () => {
                this.toggleNotificationsPanel();
            });
        }
        
        // Close notifications button
        const notificationsClose = document.getElementById('notificationsClose');
        if (notificationsClose) {
            notificationsClose.addEventListener('click', () => {
                this.hideNotificationsPanel();
            });
        }
        
        // Mark all as read button
        const markAllReadBtn = document.getElementById('markAllReadBtn');
        if (markAllReadBtn) {
            markAllReadBtn.addEventListener('click', () => {
                this.markAllNotificationsAsRead();
            });
        }
        
        // Clear notifications button
        const clearNotificationsBtn = document.getElementById('clearNotificationsBtn');
        if (clearNotificationsBtn) {
            clearNotificationsBtn.addEventListener('click', () => {
                this.clearAllNotifications();
            });
        }
    },
    
    toggleNotificationsPanel: function() {
        const panel = document.getElementById('notificationsPanel');
        if (panel) {
            panel.classList.toggle('active');
            AppState.notificationsOpen = panel.classList.contains('active');
            
            if (AppState.notificationsOpen) {
                this.markAllNotificationsAsRead();
            }
        }
    },
    
    hideNotificationsPanel: function() {
        const panel = document.getElementById('notificationsPanel');
        if (panel) {
            panel.classList.remove('active');
            AppState.notificationsOpen = false;
        }
    },
    
    showNotification: function(title, message, type = 'info', data = null) {
        // Create browser notification
        if (this.permissionGranted) {
            const notification = new Notification(title, {
                body: message,
                icon: '/jubel.png',
                tag: 'jubel-notification'
            });
            
            notification.onclick = function() {
                window.focus();
                if (data && data.action) {
                    EnhancedUIUpdater.handleNotificationAction(data.action, data);
                }
            };
        }
        
        // Play sound
        if (this.notificationSound) {
            this.notificationSound.play().catch(e => console.log('Audio play failed:', e));
        }
        
        // Vibrate if supported
        if (this.vibrationEnabled && navigator.vibrate) {
            navigator.vibrate(200);
        }
        
        // Add to app notifications
        this.addAppNotification(title, message, type, data);
        
        // Update badge
        this.updateNotificationBadge();
    },
    
    addAppNotification: function(title, message, type, data) {
        const notificationId = `notification-${Date.now()}`;
        
        const notification = {
            id: notificationId,
            title: title,
            message: message,
            type: type,
            data: data,
            timestamp: Date.now(),
            read: false
        };
        
        AppState.notifications.unshift(notification);
        
        // Keep only last 50 notifications
        if (AppState.notifications.length > 50) {
            AppState.notifications = AppState.notifications.slice(0, 50);
        }
        
        // Update UI
        this.updateNotificationsList();
        
        // Save to Firebase if user is logged in
        if (AppState.currentUser) {
            this.saveNotificationToFirebase(notification);
        }
    },
    
    async saveNotificationToFirebase(notification) {
        try {
            await database.ref(`notifications/${AppState.currentUser.uid}/${notification.id}`).set(notification);
        } catch (error) {
            console.error('Save notification error:', error);
        }
    },
    
    updateNotificationsList: function() {
        const container = document.getElementById('notificationsList');
        if (!container) return;
        
        container.innerHTML = '';
        
        if (AppState.notifications.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-bell-slash"></i>
                    </div>
                    <div class="empty-title">No notifications</div>
                    <div class="empty-message">You're all caught up!</div>
                </div>
            `;
            return;
        }
        
        AppState.notifications.forEach(notification => {
            const notificationElement = this.createNotificationElement(notification);
            container.appendChild(notificationElement);
        });
    },
    
    createNotificationElement: function(notification) {
        const element = document.createElement('div');
        element.className = `notification-item ${notification.read ? '' : 'unread'}`;
        element.dataset.notificationId = notification.id;
        
        const date = new Date(notification.timestamp);
        let icon = 'fa-info-circle';
        let iconColor = '#2196F3';
        
        switch(notification.type) {
            case 'success':
                icon = 'fa-check-circle';
                iconColor = '#4CAF50';
                break;
            case 'error':
                icon = 'fa-exclamation-circle';
                iconColor = '#F44336';
                break;
            case 'warning':
                icon = 'fa-exclamation-triangle';
                iconColor = '#FFC107';
                break;
            case 'ride':
                icon = 'fa-car';
                iconColor = '#FF6B35';
                break;
            case 'payment':
                icon = 'fa-credit-card';
                iconColor = '#4CAF50';
                break;
            case 'referral':
                icon = 'fa-gift';
                iconColor = '#FF6B35';
                break;
            case 'emergency':
                icon = 'fa-exclamation-triangle';
                iconColor = '#F44336';
                break;
        }
        
        element.innerHTML = `
            <div class="notification-header">
                <div class="notification-icon" style="color: ${iconColor}">
                    <i class="fas ${icon}"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">${notification.title}</div>
                    <div class="notification-time">${this.formatTimeAgo(notification.timestamp)}</div>
                </div>
            </div>
            <div class="notification-message">${notification.message}</div>
            ${notification.data?.action ? `
            <div class="notification-actions">
                <button class="notification-action-btn" data-action="${notification.data.action}">
                    View Details
                </button>
            </div>
            ` : ''}
        `;
        
        element.addEventListener('click', () => {
            this.markNotificationAsRead(notification.id);
            
            if (notification.data?.action) {
                EnhancedUIUpdater.handleNotificationAction(notification.data.action, notification.data);
            }
        });
        
        return element;
    },
    
    formatTimeAgo: function(timestamp) {
        const now = Date.now();
        const diff = now - timestamp;
        
        if (diff < 60000) return 'Just now';
        if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
        if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
        return `${Math.floor(diff / 86400000)}d ago`;
    },
    
    markNotificationAsRead: function(notificationId) {
        const notification = AppState.notifications.find(n => n.id === notificationId);
        if (notification && !notification.read) {
            notification.read = true;
            this.updateNotificationsList();
            this.updateNotificationBadge();
            
            // Update in Firebase
            if (AppState.currentUser) {
                database.ref(`notifications/${AppState.currentUser.uid}/${notificationId}/read`).set(true);
            }
        }
    },
    
    markAllNotificationsAsRead: function() {
        AppState.notifications.forEach(notification => {
            notification.read = true;
            
            // Update in Firebase
            if (AppState.currentUser) {
                database.ref(`notifications/${AppState.currentUser.uid}/${notification.id}/read`).set(true);
            }
        });
        
        this.updateNotificationsList();
        this.updateNotificationBadge();
    },
    
    clearAllNotifications: function() {
        if (confirm('Clear all notifications?')) {
            AppState.notifications = [];
            this.updateNotificationsList();
            this.updateNotificationBadge();
            
            // Clear from Firebase
            if (AppState.currentUser) {
                database.ref(`notifications/${AppState.currentUser.uid}`).remove();
            }
        }
    },
    
    updateNotificationBadge: function() {
        const badge = document.getElementById('notificationCount');
        if (!badge) return;
        
        const unreadCount = AppState.notifications.filter(n => !n.read).length;
        
        if (unreadCount > 0) {
            badge.textContent = unreadCount > 99 ? '99+' : unreadCount.toString();
            badge.style.display = 'flex';
            
            // Update document title
            document.title = `(${unreadCount}) Jubel Passenger`;
        } else {
            badge.style.display = 'none';
            document.title = 'Jubel Passenger';
        }
    },
    
    sendRideNotification: function(ride, type) {
        let title = '';
        let message = '';
        
        switch(type) {
            case 'requested':
                title = 'Ride Requested';
                message = 'Your ride has been requested. Searching for driver...';
                break;
            case 'accepted':
                title = 'Driver Assigned';
                message = `Driver ${ride.driverName} is on the way`;
                break;
            case 'arrived':
                title = 'Driver Arrived';
                message = 'Your driver has arrived at the pickup location';
                break;
            case 'started':
                title = 'Ride Started';
                message = 'Your ride has started';
                break;
            case 'completed':
                title = 'Ride Completed';
                message = 'Your ride has been completed';
                break;
            case 'cancelled':
                title = 'Ride Cancelled';
                message = 'Your ride has been cancelled';
                break;
        }
        
        this.showNotification(title, message, 'ride', { rideId: ride.id });
    },
    
    sendPaymentNotification: function(amount, type) {
        const title = type === 'payment' ? 'Payment Successful' : 'Refund Processed';
        const message = type === 'payment' 
            ? `Payment of ZMW ${amount.toFixed(2)} completed`
            : `Refund of ZMW ${amount.toFixed(2)} processed`;
        
        this.showNotification(title, message, 'payment');
    },
    
    sendReferralNotification: function(referredUserName, amount) {
        const title = 'Referral Earnings';
        const message = `You earned ZMW ${amount.toFixed(2)} from ${referredUserName}'s ride`;
        
        this.showNotification(title, message, 'referral');
    }
};

// ============================================
// ENHANCED UI UPDATER (CONTINUED)
// ============================================
const EnhancedUIUpdater = {
    // Previous UI updater methods...
    // Adding new methods for enhanced features
    
    showPulsingIcon: function(serviceType) {
        this.removePulsingIcon();
        
        let iconClass = 'fa-car';
        let iconSize = '60px';
        let iconColor = '#FF6B35';
        
        switch(serviceType) {
            case 'car':
            case 'standard':
            case 'economy':
            case 'premium':
                iconClass = 'fa-car';
                break;
            case 'delivery':
            case 'short-delivery':
                iconClass = 'fa-motorcycle';
                iconColor = '#4CAF50';
                break;
            case 'truck':
                iconClass = 'fa-truck';
                iconColor = '#795548';
                iconSize = '70px';
                break;
            case 'shopping':
                iconClass = 'fa-shopping-bag';
                iconColor = '#9C27B0';
                break;
            case 'emergency':
                iconClass = 'fa-ambulance';
                iconColor = '#F44336';
                break;
        }
        
        pulsingIcon = document.createElement('div');
        pulsingIcon.id = 'pulsingRideIcon';
        pulsingIcon.className = 'pulsing-ride-icon';
        pulsingIcon.innerHTML = `<i class="fas ${iconClass}"></i>`;
        pulsingIcon.style.cssText = `
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: ${iconSize};
            color: ${iconColor};
            z-index: 1000;
            animation: pulse 1.5s infinite;
            pointer-events: none;
        `;
        
        const mapContainer = document.getElementById('map');
        if (mapContainer) {
            mapContainer.appendChild(pulsingIcon);
        }
    },
    
    removePulsingIcon: function() {
        const icon = document.getElementById('pulsingRideIcon');
        if (icon) {
            icon.remove();
        }
    },
    
    showPaymentModal: function(serviceType, amount, rideData = null) {
        // Store ride data
        window.pendingRideData = rideData || {
            pickup: AppState.pickup,
            destination: AppState.destination,
            rideType: AppState.selectedRideType,
            fare: amount,
            distance: AppState.activeRoute?.distance || 0,
            duration: AppState.activeRoute?.duration || 0,
            serviceType: AppState.activeService
        };
        
        AppState.rideFare = amount;
        
        // Update payment modal
        const paymentAmount = document.getElementById('paymentAmount');
        if (paymentAmount) {
            paymentAmount.textContent = `ZMW ${amount.toFixed(2)}`;
        }
        
        const originalFareAmount = document.getElementById('originalFareAmount');
        if (originalFareAmount) {
            originalFareAmount.textContent = `ZMW ${amount.toFixed(2)}`;
        }
        
        const finalFareAmount = document.getElementById('finalFareAmount');
        if (finalFareAmount) {
            const finalAmount = AppState.referralDiscountApplied ? amount * 0.5 : amount;
            finalFareAmount.textContent = `ZMW ${finalAmount.toFixed(2)}`;
        }
        
        // Reset referral discount UI
        this.resetReferralDiscountUI();
        
        // Show modal
        this.showModal('payment');
    },
    
    resetReferralDiscountUI: function() {
        const referralInputSection = document.getElementById('referralInputSection');
        const referralAppliedSection = document.getElementById('referralAppliedSection');
        const referralCodeInput = document.getElementById('referralCodeInput');
        
        if (referralInputSection) referralInputSection.style.display = 'block';
        if (referralAppliedSection) referralAppliedSection.style.display = 'none';
        if (referralCodeInput) referralCodeInput.value = '';
        
        AppState.referralDiscountApplied = false;
        AppState.referralCodeUsed = null;
        AppState.referralOwnerName = null;
    },
    
    applyReferralDiscount: function() {
        const referralCodeInput = document.getElementById('referralCodeInput');
        if (!referralCodeInput) return;
        
        const referralCode = referralCodeInput.value.trim();
        if (!referralCode) {
            this.showToast('Please enter a referral code', 'warning');
            return;
        }
        
        EnhancedFirebaseManager.validateReferralCode(referralCode)
            .then(result => {
                if (result.valid) {
                    AppState.referralDiscountApplied = true;
                    AppState.referralCodeUsed = referralCode;
                    AppState.referralOwnerName = result.ownerName;
                    
                    this.updateReferralDiscountUI();
                    this.showToast(`50% discount applied! Referral from ${result.ownerName}`, 'success');
                } else {
                    this.showToast('Invalid referral code', 'error');
                }
            })
            .catch(error => {
                console.error('Referral validation error:', error);
                this.showToast('Error validating referral code', 'error');
            });
    },
    
    updateReferralDiscountUI: function() {
        const discountAmount = AppState.rideFare * 0.5;
        const finalAmount = AppState.rideFare - discountAmount;
        
        const referralInputSection = document.getElementById('referralInputSection');
        const referralAppliedSection = document.getElementById('referralAppliedSection');
        const discountAmountElement = document.getElementById('discountAmount');
        const referrerInfo = document.getElementById('referrerInfo');
        const finalFareAmount = document.getElementById('finalFareAmount');
        const paymentAmount = document.getElementById('paymentAmount');
        
        if (referralInputSection) referralInputSection.style.display = 'none';
        if (referralAppliedSection) referralAppliedSection.style.display = 'block';
        if (discountAmountElement) discountAmountElement.textContent = `-ZMW ${discountAmount.toFixed(2)}`;
        if (referrerInfo) referrerInfo.textContent = `Referred by: ${AppState.referralOwnerName}`;
        if (finalFareAmount) finalFareAmount.textContent = `ZMW ${finalAmount.toFixed(2)}`;
        if (paymentAmount) paymentAmount.textContent = `ZMW ${finalAmount.toFixed(2)}`;
    },
    
    showModal: function(modalId) {
        const modal = document.getElementById(`${modalId}Modal`);
        if (modal) {
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
    },
    
    hideModal: function(modalId) {
        const modal = document.getElementById(`${modalId}Modal`);
        if (modal) {
            modal.style.display = 'none';
            document.body.style.overflow = '';
        }
    },
    
    hideAllModals: function() {
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.style.display = 'none';
        });
        document.body.style.overflow = '';
    },
    
    // ... rest of the UI updater methods
};

// ============================================
// ENHANCED FIREBASE MANAGER (CONTINUED)
// ============================================
const EnhancedFirebaseManager = {
    // Previous Firebase methods...
    // Adding new methods for enhanced features
    
    validateReferralCode: async function(referralCode) {
        try {
            const snapshot = await database.ref('users')
                .orderByChild('referralCode')
                .equalTo(referralCode)
                .once('value');
            
            const userData = snapshot.val();
            if (userData) {
                const userId = Object.keys(userData)[0];
                const user = userData[userId];
                
                return {
                    valid: true,
                    ownerName: user.name,
                    userId: userId
                };
            }
            
            return { valid: false };
            
        } catch (error) {
            console.error('Validate referral error:', error);
            throw error;
        }
    },
    
    findUserByReferralCode: async function(referralCode) {
        try {
            const snapshot = await database.ref('users')
                .orderByChild('referralCode')
                .equalTo(referralCode)
                .once('value');
            
            const userData = snapshot.val();
            if (userData) {
                const userId = Object.keys(userData)[0];
                return { id: userId, ...userData[userId] };
            }
            
            return null;
            
        } catch (error) {
            console.error('Find user error:', error);
            throw error;
        }
    },
    
    sendNotification: async function(userId, title, message, type = 'info', data = null) {
        try {
            const notificationId = database.ref().child('notifications').push().key;
            
            const notification = {
                id: notificationId,
                userId: userId,
                title: title,
                message: message,
                type: type,
                data: data,
                timestamp: Date.now(),
                read: false
            };
            
            await database.ref(`notifications/${userId}/${notificationId}`).set(notification);
            
            return notificationId;
            
        } catch (error) {
            console.error('Send notification error:', error);
        }
    },
    
    // ... rest of the Firebase methods
};

// ============================================
// INITIALIZATION FUNCTION
// ============================================
async function initializeApp() {
    try {
        console.log('Initializing Enhanced Jubel Passenger App...');
        EnhancedUIUpdater.showLoading('Initializing app...');
        
        // Initialize all managers
        EnhancedSearchEngine.init();
        EnhancedRouteManager.init();
        EnhancedPriceCalculator.init();
        EnhancedWalletSystem.init();
        SplitRideManager.init();
        BroadcastRideManager.init();
        ShoppingModuleManager.init();
        EmergencySystemManager.init();
        EnhancedNotificationManager.init();
        
        // Initialize map
        await initializeMap();
        
        // Setup event listeners
        setupEventListeners();
        
        // Start real-time location tracking
        RealTimeLocationTracker.init();
        
        // Check authentication
        await checkAuthentication();
        
        // Start real-time sync
        startRealtimeSync();
        
        // Schedule periodic updates
        schedulePeriodicUpdates();
        
        EnhancedUIUpdater.hideLoading();
        EnhancedUIUpdater.showToast('Jubel Passenger App Ready', 'success');
        
        console.log('App initialization completed successfully');
        
    } catch (error) {
        console.error('Error initializing app:', error);
        EnhancedUIUpdater.hideLoading();
        EnhancedUIUpdater.showToast('Error initializing app', 'error');
    }
}

async function initializeMap() {
    try {
        console.log('Initializing map...');
        EnhancedUIUpdater.showMapLoading();
        
        // Set default center to Lusaka
        const defaultCenter = [-15.4167, 28.2833];
        
        map = L.map('map').setView(defaultCenter, 13);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: ' OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);
        
        // Add scale control
        L.control.scale().addTo(map);
        
        EnhancedUIUpdater.hideMapLoading();
        console.log('Map initialized');
        
    } catch (error) {
        console.error('Map initialization error:', error);
        EnhancedUIUpdater.hideMapLoading();
        EnhancedUIUpdater.showToast('Map initialization failed', 'error');
    }
}

async function checkAuthentication() {
    const urlParams = new URLSearchParams(window.location.search);
    const email = urlParams.get('email');
    const uid = urlParams.get('uid');
    
    if (email && uid) {
        console.log('Authenticated via URL parameters');
        AppState.currentUser = { uid: uid, email: email };
        await loadUserData(uid);
    } else {
        console.log('Checking Firebase auth state...');
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                console.log('User authenticated:', user.uid);
                AppState.currentUser = user;
                await loadUserData(user.uid);
            } else {
                console.log('No user logged in, redirecting to signup');
                window.location.href = 'signup.html';
            }
        });
    }
}

async function loadUserData(uid) {
    try {
        console.log(`Loading user data for UID: ${uid}`);
        EnhancedUIUpdater.showLoading('Loading your profile...');
        
        const snapshot = await database.ref(`users/${uid}`).once('value');
        AppState.userData = snapshot.val();
        
        if (AppState.userData) {
            console.log('User data loaded successfully');
            
            // Update UI
            EnhancedUIUpdater.updateWalletBalance(AppState.userData.walletBalance || 0);
            EnhancedUIUpdater.updateUserInfo(AppState.userData);
            
            // Load additional data
            await Promise.all([
                loadSOSConfig(uid),
                loadNotifications(uid),
                loadWalletTransactions(uid)
            ]);
            
            EnhancedUIUpdater.hideLoading();
            return true;
        } else {
            console.warn('No user data found');
            EnhancedUIUpdater.hideLoading();
            return false;
        }
    } catch (error) {
        console.error('Error loading user data:', error);
        EnhancedUIUpdater.hideLoading();
        EnhancedUIUpdater.showToast('Error loading user data', 'error');
        return false;
    }
}

async function loadSOSConfig(uid) {
    try {
        const snapshot = await database.ref(`sosConfig/${uid}`).once('value');
        AppState.sosConfig = snapshot.val();
        
        if (AppState.sosConfig) {
            console.log('SOS config loaded');
        }
    } catch (error) {
        console.error('Error loading SOS config:', error);
    }
}

async function loadNotifications(uid) {
    try {
        const snapshot = await database.ref(`notifications/${uid}`)
            .orderByChild('timestamp')
            .limitToLast(50)
            .once('value');
        
        const notifications = snapshot.val();
        if (notifications) {
            AppState.notifications = Object.values(notifications).reverse();
            EnhancedNotificationManager.updateNotificationsList();
            EnhancedNotificationManager.updateNotificationBadge();
        }
    } catch (error) {
        console.error('Error loading notifications:', error);
    }
}

async function loadWalletTransactions(uid) {
    try {
        const snapshot = await database.ref(`walletTransactions/${uid}`)
            .orderByChild('timestamp')
            .limitToLast(50)
            .once('value');
        
        const transactions = snapshot.val();
        if (transactions) {
            AppState.walletTransactions = Object.values(transactions).reverse();
        }
    } catch (error) {
        console.error('Error loading wallet transactions:', error);
    }
}

function startRealtimeSync() {
    if (!AppState.currentUser) return;
    
    console.log('Starting real-time sync...');
    
    // User data updates
    const userRef = database.ref(`users/${AppState.currentUser.uid}`);
    AppState.realtimeListeners.push(
        userRef.on('value', (snapshot) => {
            const userData = snapshot.val();
            if (userData) {
                AppState.userData = userData;
                AppState.walletBalance = userData.walletBalance || 0;
                EnhancedUIUpdater.updateWalletBalance(AppState.walletBalance);
            }
        })
    );
    
    // Active ride updates
    const activeRideRef = database.ref('rides')
        .orderByChild('passengerId')
        .equalTo(AppState.currentUser.uid)
        .orderByChild('status')
        .startAt('requested')
        .endAt('started');
    
    AppState.realtimeListeners.push(
        activeRideRef.on('value', (snapshot) => {
            const rides = snapshot.val();
            if (rides) {
                const rideId = Object.keys(rides)[0];
                const ride = { id: rideId, ...rides[rideId] };
                
                if (!AppState.currentRide || AppState.currentRide.id !== rideId) {
                    AppState.currentRide = ride;
                    handleNewRide(ride);
                } else {
                    AppState.currentRide = ride;
                    updateRideStatus(ride);
                }
            } else if (AppState.currentRide) {
                console.log('Active ride ended');
                resetActiveRide();
            }
        })
    );
    
    // Notifications updates
    const notificationsRef = database.ref(`notifications/${AppState.currentUser.uid}`);
    AppState.realtimeListeners.push(
        notificationsRef.on('child_added', (snapshot) => {
            const notification = snapshot.val();
            if (notification && !notification.read) {
                EnhancedNotificationManager.showNotification(
                    notification.title,
                    notification.message,
                    notification.type,
                    notification.data
                );
            }
        })
    );
    
    console.log('Real-time sync started');
}

function schedulePeriodicUpdates() {
    // Update surge pricing every 5 minutes
    setInterval(() => {
        EnhancedPriceCalculator.calculateSurgeMultiplier();
        if (AppState.activeRoute) {
            EnhancedPriceCalculator.calculateAllPrices();
        }
    }, 300000);
    
    // Check scheduled rides every minute
    setInterval(() => {
        checkScheduledRides();
    }, 60000);
    
    // Update location every 30 seconds
    setInterval(() => {
        if (AppState.userLocation) {
            RealTimeLocationTracker.updateUserLocationInFirebase(
                AppState.userLocation.lat,
                AppState.userLocation.lng
            );
        }
    }, 30000);
}

function setupEventListeners() {
    console.log('Setting up event listeners...');
    
    // Basic event listeners setup
    // (This is a simplified version - in production, you'd have complete setup)
    
    // Navigation
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const screen = this.dataset.screen;
            switchScreen(screen);
        });
    });
    
    // Service tabs
    document.querySelectorAll('.service-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const service = this.dataset.service;
            switchService(service);
        });
    });
    
    // Map controls
    document.getElementById('locateMeBtn')?.addEventListener('click', () => {
        RealTimeLocationTracker.getCurrentLocation()
            .then(location => {
                map.setView([location.lat, location.lng], 15);
            })
            .catch(error => {
                console.error('Location error:', error);
            });
    });
    
    // Request ride button
    document.getElementById('requestRideBtn')?.addEventListener('click', () => {
        if (!AppState.pickup || !AppState.destination) {
            EnhancedUIUpdater.showToast('Please select pickup and destination locations', 'warning');
            return;
        }
        
        EnhancedUIUpdater.showPaymentModal(
            AppState.activeService,
            AppState.rideFare
        );
    });
    
    // More event listeners would be added here...
    
    console.log('Event listeners setup completed');
}

// Start the application
window.addEventListener('load', initializeApp);

// Prevent page refresh
window.addEventListener('beforeunload', function(e) {
    if (AppState.currentRide || AppState.activeSplitRide || AppState.currentBroadcast) {
        e.preventDefault();
        e.returnValue = 'You have an active ride or session. Are you sure you want to leave?';
    }
});

// Keep app alive in background
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        AppState.isAppInBackground = true;
        console.log('App moved to background');
    } else {
        AppState.isAppInBackground = false;
        AppState.lastActivityTime = Date.now();
        console.log('App moved to foreground');
    }
});

// Periodic activity check to keep app alive
setInterval(() => {
    if (!AppState.isAppInBackground && Date.now() - AppState.lastActivityTime > 30000) {
        // Simulate activity to prevent sleep
        AppState.lastActivityTime = Date.now();
    }
}, 10000);
</script>
</body>
</html>

