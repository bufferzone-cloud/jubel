
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jubel Passenger App</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    
    <style>
        :root {
            /* Color Palette */
            --primary-orange: #FF6B35;
            --primary-orange-light: #FF8B5C;
            --primary-orange-dark: #E55A2B;
            --white: #FFFFFF;
            --off-white: #F8F9FA;
            --light-gray: #E9ECEF;
            --medium-gray: #DEE2E6;
            --dark-gray: #6C757D;
            --text-dark: #212529;
            --text-gray: #495057;
            --success-green: #28A745;
            --warning-yellow: #FFC107;
            --error-red: #DC3545;
            --info-blue: #17A2B8;
            
            /* Shadows */
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
            
            /* Border Radius */
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
            --radius-full: 999px;
            
            /* Transitions */
            --transition-fast: 150ms ease;
            --transition-normal: 250ms ease;
            --transition-slow: 350ms ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--white);
            color: var(--text-dark);
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            position: relative;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Map Container - 60% of screen */
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 60vh;
            z-index: 1;
            background: var(--light-gray);
        }

        .map-loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--white);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--light-gray);
            border-top: 3px solid var(--primary-orange);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        .map-loading-text {
            color: var(--text-gray);
            font-size: 14px;
            font-weight: 500;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Top Navigation Bar */
        .top-bar {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background: var(--white);
            z-index: 1001;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            box-shadow: var(--shadow-sm);
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: var(--primary-orange);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-icon img {
            width: 24px;
            height: 24px;
            object-fit: contain;
        }

        .logo-text {
            font-weight: 600;
            font-size: 16px;
            color: var(--text-dark);
        }

        .user-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .balance-badge {
            background: var(--off-white);
            padding: 6px 12px;
            border-radius: var(--radius-full);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--text-gray);
        }

        .balance-badge i {
            color: var(--primary-orange);
        }

        .balance-amount {
            font-weight: 600;
            color: var(--text-dark);
        }

        .notification-bell {
            position: relative;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--off-white);
            border-radius: var(--radius-full);
            cursor: pointer;
        }

        .notification-bell i {
            font-size: 18px;
            color: var(--text-gray);
        }

        .notification-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            background: var(--error-red);
            color: var(--white);
            font-size: 10px;
            font-weight: 600;
            min-width: 18px;
            height: 18px;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
        }

        /* City Detection */
        .city-detection {
            position: absolute;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--white);
            padding: 8px 16px;
            border-radius: var(--radius-full);
            box-shadow: var(--shadow-md);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 500;
            z-index: 1000;
            color: var(--text-gray);
        }

        .city-detection i {
            color: var(--primary-orange);
        }

        /* Main Panel - 40% of screen */
        .main-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 45vh;
            background: var(--white);
            border-top-left-radius: var(--radius-lg);
            border-top-right-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            z-index: 1002;
            overflow: hidden;
            transition: transform var(--transition-normal);
        }

        .main-panel.collapsed {
            transform: translateY(calc(100% - 60px));
        }

        .panel-handle {
            width: 40px;
            height: 4px;
            background: var(--medium-gray);
            border-radius: var(--radius-full);
            margin: 12px auto;
            cursor: pointer;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            border-bottom: 1px solid var(--light-gray);
            padding: 0 16px;
        }

        .nav-tab {
            flex: 1;
            padding: 16px 0;
            background: none;
            border: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            color: var(--dark-gray);
            font-size: 12px;
            cursor: pointer;
            transition: color var(--transition-fast);
            position: relative;
        }

        .nav-tab.active {
            color: var(--primary-orange);
        }

        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 50%;
            transform: translateX(-50%);
            width: 40%;
            height: 3px;
            background: var(--primary-orange);
            border-radius: var(--radius-full);
        }

        .nav-tab i {
            font-size: 18px;
            margin-bottom: 2px;
        }

        /* Content Area */
        #homeContent {
            height: calc(100% - 130px);
            overflow-y: auto;
            padding: 16px;
            padding-bottom: 80px;
        }

        .service-tabs {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding: 4px 0;
            margin-bottom: 20px;
            scrollbar-width: none;
        }

        .service-tabs::-webkit-scrollbar {
            display: none;
        }

        .service-tab {
            flex: 0 0 auto;
            width: 80px;
            padding: 12px;
            background: var(--off-white);
            border-radius: var(--radius-md);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .service-tab.active {
            background: var(--primary-orange);
            color: var(--white);
        }

        .service-tab.active .service-icon {
            background: rgba(255, 255, 255, 0.2);
        }

        .service-icon {
            width: 40px;
            height: 40px;
            background: var(--white);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .service-tab.active .service-icon i {
            color: var(--white);
        }

        .service-icon i {
            font-size: 20px;
            color: var(--primary-orange);
        }

        .service-name {
            font-size: 12px;
            font-weight: 600;
            text-align: center;
        }

        .service-desc {
            font-size: 10px;
            color: var(--dark-gray);
            text-align: center;
        }

        .service-tab.active .service-desc {
            color: rgba(255, 255, 255, 0.9);
        }

        /* Ride Request Form */
        .ride-request-form {
            display: none;
        }

        .ride-request-form.active {
            display: block;
            animation: fadeIn var(--transition-normal);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-dark);
        }

        .form-title i {
            color: var(--primary-orange);
        }

        .location-inputs {
            background: var(--off-white);
            border-radius: var(--radius-md);
            overflow: hidden;
            margin-bottom: 16px;
        }

        .location-input {
            position: relative;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid var(--light-gray);
        }

        .location-input:last-child {
            border-bottom: none;
        }

        .location-input i {
            color: var(--primary-orange);
            font-size: 16px;
            flex-shrink: 0;
        }

        .location-input input {
            flex: 1;
            background: none;
            border: none;
            font-size: 15px;
            color: var(--text-dark);
            outline: none;
            font-family: inherit;
        }

        .location-input input::placeholder {
            color: var(--dark-gray);
        }

        .suggestion-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--white);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1003;
            margin-top: 4px;
            display: none;
        }

        .suggestion-list.active {
            display: block;
        }

        .suggestion-item {
            padding: 14px 16px;
            border-bottom: 1px solid var(--light-gray);
            cursor: pointer;
            transition: background var(--transition-fast);
        }

        .suggestion-item:hover {
            background: var(--off-white);
        }

        .suggestion-name {
            font-weight: 500;
            margin-bottom: 4px;
            color: var(--text-dark);
        }

        .suggestion-address {
            font-size: 12px;
            color: var(--text-gray);
        }

        .suggestion-distance {
            font-size: 11px;
            color: var(--primary-orange);
            margin-top: 4px;
            font-weight: 500;
        }

        /* Ride Type Selection */
        .ride-type-selection {
            margin: 20px 0;
            display: none;
        }

        .ride-type-selection.active {
            display: block;
        }

        .ride-type-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ride-type-cards {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 4px 0;
        }

        .ride-type-card {
            flex: 0 0 auto;
            width: 120px;
            padding: 16px;
            background: var(--off-white);
            border-radius: var(--radius-md);
            border: 2px solid transparent;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .ride-type-card.selected {
            background: var(--white);
            border-color: var(--primary-orange);
            box-shadow: var(--shadow-md);
        }

        .ride-type-icon {
            width: 40px;
            height: 40px;
            background: var(--white);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
        }

        .ride-type-card.selected .ride-type-icon {
            background: var(--primary-orange);
        }

        .ride-type-icon i {
            font-size: 18px;
            color: var(--primary-orange);
        }

        .ride-type-card.selected .ride-type-icon i {
            color: var(--white);
        }

        .ride-type-name {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text-dark);
        }

        .ride-type-price {
            font-size: 15px;
            font-weight: 700;
            color: var(--primary-orange);
        }

        /* Fare Display */
        .fare-display {
            background: var(--off-white);
            border-radius: var(--radius-md);
            padding: 16px;
            margin: 20px 0;
            display: none;
        }

        .fare-display.active {
            display: block;
            animation: slideUp var(--transition-normal);
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fare-label {
            font-size: 13px;
            color: var(--text-gray);
            margin-bottom: 6px;
        }

        .fare-amount {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 8px;
        }

        .fare-details {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: var(--dark-gray);
        }

        /* Action Buttons */
        .action-buttons {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 16px;
            background: var(--white);
            border-top: 1px solid var(--light-gray);
            z-index: 1003;
        }

        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: var(--radius-md);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            font-family: inherit;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: var(--primary-orange);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--primary-orange-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: var(--off-white);
            color: var(--text-dark);
            border: 2px solid var(--light-gray);
        }

        .btn-secondary:hover {
            background: var(--light-gray);
        }

        .btn-danger {
            background: var(--error-red);
            color: var(--white);
        }

        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* Ride Status Bar */
        .ride-status-bar {
            position: absolute;
            top: calc(60vh - 60px);
            left: 0;
            width: 100%;
            background: var(--white);
            padding: 12px 16px;
            border-top-left-radius: var(--radius-lg);
            border-top-right-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            z-index: 1002;
            display: none;
        }

        .ride-status-bar.active {
            display: block;
            animation: slideDown var(--transition-normal);
        }

        @keyframes slideDown {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: var(--radius-full);
            background: var(--dark-gray);
        }

        .status-dot.searching {
            background: var(--warning-yellow);
            animation: pulse 1.5s infinite;
        }

        .status-dot.arriving {
            background: var(--info-blue);
            animation: pulse 1s infinite;
        }

        .status-dot.riding {
            background: var(--success-green);
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .status-text {
            font-weight: 600;
            font-size: 15px;
            color: var(--text-dark);
        }

        .status-eta {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-gray);
        }

        .status-eta i {
            color: var(--primary-orange);
        }

        /* SOS Button */
        .sos-button {
            position: absolute;
            bottom: 100px;
            right: 16px;
            width: 60px;
            height: 60px;
            background: var(--error-red);
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-lg);
            cursor: pointer;
            z-index: 1000;
            animation: pulse 2s infinite;
            border: 4px solid rgba(255, 255, 255, 0.8);
        }

        .sos-button i {
            color: var(--white);
            font-size: 24px;
        }

        /* Map Controls */
        .map-controls {
            position: absolute;
            bottom: 170px;
            right: 16px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }

        .map-control-btn {
            width: 44px;
            height: 44px;
            background: var(--white);
            border-radius: var(--radius-full);
            border: none;
            box-shadow: var(--shadow-md);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }

        .map-control-btn:hover {
            background: var(--off-white);
            transform: scale(1.1);
        }

        .map-control-btn i {
            color: var(--primary-orange);
            font-size: 18px;
        }

        /* Pulsing Ride Icon */
        .pulsing-ride-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 80px;
            color: var(--primary-orange);
            z-index: 1000;
            animation: ridePulse 1.5s infinite;
            pointer-events: none;
            opacity: 0.8;
        }

        @keyframes ridePulse {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 0.8; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 0.4; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0.8; }
        }

        /* Ride Info Panel */
        .ride-info-panel {
            display: none;
        }

        .ride-info-panel.active {
            display: block;
        }

        .driver-info {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--off-white);
            border-radius: var(--radius-md);
            margin-bottom: 16px;
        }

        .driver-avatar {
            width: 60px;
            height: 60px;
            background: var(--white);
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid var(--primary-orange);
        }

        .driver-avatar i {
            font-size: 24px;
            color: var(--primary-orange);
        }

        .driver-details {
            flex: 1;
        }

        .driver-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .driver-rating {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 14px;
            color: var(--text-gray);
            margin-bottom: 4px;
        }

        .driver-rating i {
            color: var(--warning-yellow);
        }

        .driver-vehicle {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 13px;
            color: var(--dark-gray);
        }

        .driver-vehicle i {
            color: var(--primary-orange);
        }

        /* Timeline */
        .timeline {
            display: flex;
            justify-content: space-between;
            padding: 16px 0;
            margin: 16px 0;
            border-top: 1px solid var(--light-gray);
            border-bottom: 1px solid var(--light-gray);
        }

        .timeline-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .step-dot {
            width: 32px;
            height: 32px;
            background: var(--light-gray);
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-normal);
        }

        .step-dot i {
            color: var(--white);
            font-size: 14px;
        }

        .step-dot.active {
            background: var(--primary-orange);
        }

        .step-dot.completed {
            background: var(--success-green);
        }

        .step-label {
            font-size: 11px;
            color: var(--dark-gray);
            text-align: center;
            transition: color var(--transition-normal);
        }

        .step-label.active {
            color: var(--primary-orange);
            font-weight: 600;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 16px;
        }

        .modal {
            background: var(--white);
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: modalSlideUp var(--transition-normal);
        }

        @keyframes modalSlideUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--light-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 18px;
        }

        .modal-title i {
            color: var(--primary-orange);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--dark-gray);
            cursor: pointer;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-full);
            transition: background var(--transition-fast);
        }

        .modal-close:hover {
            background: var(--off-white);
        }

        .modal-content {
            padding: 20px;
        }

        .payment-methods {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 20px 0;
        }

        .payment-method {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            border: 2px solid var(--light-gray);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .payment-method.selected {
            border-color: var(--primary-orange);
            background: rgba(255, 107, 53, 0.05);
        }

        .payment-icon {
            width: 40px;
            height: 40px;
            background: var(--off-white);
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .payment-method.selected .payment-icon {
            background: var(--primary-orange);
        }

        .payment-icon i {
            color: var(--primary-orange);
            font-size: 18px;
        }

        .payment-method.selected .payment-icon i {
            color: var(--white);
        }

        .payment-details {
            flex: 1;
        }

        .payment-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .payment-info {
            font-size: 13px;
            color: var(--text-gray);
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 80px;
            right: 16px;
            z-index: 3000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 350px;
        }

        .toast {
            background: var(--white);
            border-radius: var(--radius-md);
            padding: 16px;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: flex-start;
            gap: 12px;
            animation: toastSlideIn var(--transition-normal);
            border-left: 4px solid var(--primary-orange);
        }

        .toast.success {
            border-left-color: var(--success-green);
        }

        .toast.error {
            border-left-color: var(--error-red);
        }

        .toast.warning {
            border-left-color: var(--warning-yellow);
        }

        @keyframes toastSlideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .toast-icon {
            font-size: 20px;
            color: var(--primary-orange);
        }

        .toast.success .toast-icon {
            color: var(--success-green);
        }

        .toast.error .toast-icon {
            color: var(--error-red);
        }

        .toast.warning .toast-icon {
            color: var(--warning-yellow);
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .toast-message {
            font-size: 14px;
            color: var(--text-gray);
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--dark-gray);
            cursor: pointer;
            font-size: 14px;
            padding: 4px;
            border-radius: var(--radius-full);
            transition: background var(--transition-fast);
        }

        .toast-close:hover {
            background: var(--off-white);
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 4000;
        }

        .loading-text {
            margin-top: 20px;
            font-size: 16px;
            font-weight: 500;
            color: var(--text-dark);
        }

        /* Notification Panel */
        .notifications-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 100%;
            max-width: 350px;
            height: 100%;
            background: var(--white);
            box-shadow: var(--shadow-lg);
            z-index: 2001;
            transition: transform var(--transition-normal);
            display: flex;
            flex-direction: column;
        }

        .notifications-panel.active {
            transform: translateX(-400px);
        }

        .notifications-header {
            padding: 20px;
            border-bottom: 1px solid var(--light-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notifications-title {
            font-size: 18px;
            font-weight: 600;
        }

        .notifications-list {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .notification-item {
            padding: 16px;
            border-bottom: 1px solid var(--light-gray);
            cursor: pointer;
            transition: background var(--transition-fast);
        }

        .notification-item.unread {
            background: rgba(255, 107, 53, 0.05);
            border-left: 3px solid var(--primary-orange);
        }

        .notification-item:hover {
            background: var(--off-white);
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .notification-title {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .notification-time {
            font-size: 12px;
            color: var(--dark-gray);
        }

        .notification-message {
            font-size: 14px;
            color: var(--text-gray);
        }

        /* Search History */
        .search-history {
            position: absolute;
            background: var(--white);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            z-index: 1003;
            margin-top: 4px;
            width: 100%;
            max-height: 300px;
            overflow-y: auto;
        }

        .search-history-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--light-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            font-weight: 500;
        }

        .search-history-header i {
            color: var(--primary-orange);
            margin-right: 8px;
        }

        .clear-history-btn {
            background: none;
            border: none;
            color: var(--error-red);
            font-size: 12px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            transition: background var(--transition-fast);
        }

        .clear-history-btn:hover {
            background: var(--off-white);
        }

        .search-history-item {
            padding: 12px 16px;
            border-bottom: 1px solid var(--light-gray);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background var(--transition-fast);
        }

        .search-history-item:hover {
            background: var(--off-white);
        }

        .search-history-icon {
            width: 32px;
            height: 32px;
            background: var(--off-white);
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .search-history-icon i {
            color: var(--primary-orange);
            font-size: 14px;
        }

        .search-history-text {
            flex: 1;
        }

        .search-history-text div:first-child {
            font-weight: 500;
            font-size: 14px;
            margin-bottom: 2px;
        }

        .search-history-text div:last-child {
            font-size: 12px;
            color: var(--dark-gray);
        }

        .search-history-time {
            font-size: 11px;
            color: var(--dark-gray);
            white-space: nowrap;
        }

        /* Stops Container */
        #stopsContainer {
            background: var(--off-white);
            border-radius: var(--radius-md);
            padding: 12px;
        }

        .stop-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--white);
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
            border-left: 3px solid var(--primary-orange);
        }

        .stop-item:last-child {
            margin-bottom: 0;
        }

        .stop-number {
            width: 24px;
            height: 24px;
            background: var(--primary-orange);
            color: var(--white);
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
        }

        .stop-address {
            flex: 1;
            font-size: 14px;
        }

        .remove-stop {
            background: none;
            border: none;
            color: var(--error-red);
            cursor: pointer;
            padding: 4px;
            border-radius: var(--radius-full);
            transition: background var(--transition-fast);
        }

        .remove-stop:hover {
            background: var(--off-white);
        }

        /* Form Groups */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
            color: var(--text-dark);
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--light-gray);
            border-radius: var(--radius-md);
            font-size: 15px;
            font-family: inherit;
            transition: border-color var(--transition-fast);
            background: var(--white);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-orange);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .filter-btn {
            padding: 8px 16px;
            background: var(--off-white);
            border: 2px solid var(--light-gray);
            border-radius: var(--radius-full);
            font-size: 14px;
            cursor: pointer;
            transition: all var(--transition-fast);
            font-family: inherit;
        }

        .filter-btn.active {
            background: var(--primary-orange);
            border-color: var(--primary-orange);
            color: var(--white);
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--off-white);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--medium-gray);
            border-radius: var(--radius-full);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--dark-gray);
        }

        /* Emergency Status */
        .emergency-status {
            position: absolute;
            top: 70px;
            left: 0;
            width: 100%;
            background: var(--error-red);
            color: var(--white);
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-weight: 600;
            z-index: 1000;
            animation: emergencyPulse 2s infinite;
        }

        @keyframes emergencyPulse {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 20px 0;
        }

        .quick-action-btn {
            background: var(--off-white);
            border: none;
            border-radius: var(--radius-md);
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all var(--transition-fast);
            text-align: left;
        }

        .quick-action-btn:hover {
            background: var(--light-gray);
            transform: translateY(-2px);
        }

        .quick-action-icon {
            width: 40px;
            height: 40px;
            background: var(--white);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quick-action-icon i {
            color: var(--primary-orange);
            font-size: 18px;
        }

        .quick-action-text {
            flex: 1;
        }

        .quick-action-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 2px;
        }

        .quick-action-desc {
            font-size: 11px;
            color: var(--dark-gray);
        }

        /* Price Calculator */
        .price-calculator-display {
            background: var(--off-white);
            border-radius: var(--radius-md);
            padding: 16px;
            margin: 20px 0;
            animation: fadeIn var(--transition-normal);
        }

        .price-breakdown {
            margin-top: 16px;
            border-top: 1px solid var(--light-gray);
            padding-top: 12px;
        }

        .price-breakdown-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .price-breakdown-row.total {
            font-weight: 600;
            font-size: 16px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 2px solid var(--light-gray);
        }

        /* Real-time Indicator */
        .real-time-indicator {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--success-green);
            color: var(--white);
            padding: 8px 16px;
            border-radius: var(--radius-full);
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
            animation: slideInBottom var(--transition-normal);
        }

        @keyframes slideInBottom {
            from { transform: translateX(-50%) translateY(100%); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .main-panel {
                height: 45vh;
            }
            
            .service-tabs {
                gap: 8px;
            }
            
            .service-tab {
                width: 70px;
                padding: 10px;
            }
            
            .ride-type-card {
                width: 110px;
            }
        }

        @media (max-width: 480px) {
            .top-bar {
                padding: 0 12px;
            }
            
            .logo-text {
                font-size: 15px;
            }
            
            .balance-badge {
                font-size: 13px;
                padding: 5px 10px;
            }
            
            .service-tab {
                width: 65px;
            }
            
            .ride-type-card {
                width: 100px;
                padding: 12px;
            }
            
            .modal {
                max-width: 100%;
                margin: 16px;
            }
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .visible {
            display: block !important;
        }

        .text-center {
            text-align: center;
        }

        .text-right {
            text-align: right;
        }

        .mb-1 {
            margin-bottom: 4px;
        }

        .mb-2 {
            margin-bottom: 8px;
        }

        .mb-3 {
            margin-bottom: 12px;
        }

        .mb-4 {
            margin-bottom: 16px;
        }

        .mt-1 {
            margin-top: 4px;
        }

        .mt-2 {
            margin-top: 8px;
        }

        .mt-3 {
            margin-top: 12px;
        }

        .mt-4 {
            margin-top: 16px;
        }

        .p-1 {
            padding: 4px;
        }

        .p-2 {
            padding: 8px;
        }

        .p-3 {
            padding: 12px;
        }

        .p-4 {
            padding: 16px;
        }

        /* Empty States */
        .empty-state {
            padding: 40px 20px;
            text-align: center;
            color: var(--text-gray);
        }

        .empty-icon {
            width: 60px;
            height: 60px;
            background: var(--off-white);
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
        }

        .empty-icon i {
            font-size: 24px;
            color: var(--primary-orange);
        }

        .empty-title {
            font-weight: 600;
            font-size: 18px;
            margin-bottom: 8px;
            color: var(--text-dark);
        }

        .empty-message {
            font-size: 14px;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <!-- Map Container (60% of screen) -->
    <div id="map">
        <div class="map-loading-overlay" id="mapLoadingOverlay">
            <div class="loading-spinner"></div>
            <div class="map-loading-text">Loading map...</div>
        </div>
    </div>

    <!-- Top Navigation Bar -->
    <div class="top-bar">
        <div class="logo-container">
            <div class="logo-icon">
                <i class="fas fa-car"></i>
            </div>
            <div class="logo-text" id="userFullName">Jubel</div>
        </div>
        
        <div class="user-actions">
            <div class="balance-badge" id="balanceBadge">
                <i class="fas fa-wallet"></i>
                <span>ZMW <span class="balance-amount" id="walletBalance">0.00</span></span>
            </div>
            <div class="notification-bell" id="notificationBell">
                <i class="fas fa-bell"></i>
                <span class="notification-badge" id="notificationCount">0</span>
            </div>
        </div>
    </div>

    <!-- City Detection Indicator -->
    <div class="city-detection" id="cityDetection">
        <i class="fas fa-map-marker-alt"></i>
        <span id="currentCityDisplay">Detecting your city...</span>
    </div>

    <!-- Ride Status Bar -->
    <div class="ride-status-bar" id="rideStatusBar">
        <div class="status-indicator">
            <div class="status-dot searching" id="statusDot"></div>
            <span class="status-text" id="statusText">Searching for driver</span>
        </div>
        <div class="status-eta">
            <i class="fas fa-clock"></i>
            <span id="etaText">5 min</span>
        </div>
    </div>

    <!-- Emergency Status -->
    <div class="emergency-status" id="emergencyStatus">
        <i class="fas fa-exclamation-triangle"></i>
        <span>EMERGENCY RIDE IN PROGRESS</span>
    </div>

    <!-- SOS Button -->
    <div class="sos-button" id="sosButton">
        <i class="fas fa-exclamation-triangle"></i>
    </div>

    <!-- Map Controls -->
    <div class="map-controls">
        <button class="map-control-btn" id="locateMeBtn" title="Locate Me">
            <i class="fas fa-location-arrow"></i>
        </button>
        <button class="map-control-btn" id="zoomInBtn" title="Zoom In">
            <i class="fas fa-plus"></i>
        </button>
        <button class="map-control-btn" id="zoomOutBtn" title="Zoom Out">
            <i class="fas fa-minus"></i>
        </button>
        <button class="map-control-btn" id="clearRouteBtn" title="Clear Route">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <!-- Main Panel (40% of screen) -->
    <div class="main-panel" id="mainPanel">
        <div class="panel-handle" id="panelHandle"></div>
        
        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" data-screen="home">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </button>
            <button class="nav-tab" data-screen="history">
                <i class="fas fa-history"></i>
                <span>History</span>
            </button>
            <button class="nav-tab" data-screen="account">
                <i class="fas fa-user"></i>
                <span>Account</span>
            </button>
            <button class="nav-tab" data-screen="emergency">
                <i class="fas fa-ambulance"></i>
                <span>Emergency</span>
            </button>
        </div>
        
        <!-- Home Screen Content -->
        <div id="homeContent">
            <!-- Service Tabs -->
            <div class="service-tabs" id="serviceTabs">
                <div class="service-tab car active" data-service="car">
                    <div class="service-icon">
                        <i class="fas fa-car"></i>
                    </div>
                    <div class="service-name">Car</div>
                    <div class="service-desc">Ride anywhere</div>
                </div>
                
                <div class="service-tab delivery" data-service="delivery">
                    <div class="service-icon">
                        <i class="fas fa-shipping-fast"></i>
                    </div>
                    <div class="service-name">Delivery</div>
                    <div class="service-desc">Send packages</div>
                </div>
                
                <div class="service-tab short-delivery" data-service="short-delivery">
                    <div class="service-icon">
                        <i class="fas fa-bicycle"></i>
                    </div>
                    <div class="service-name">Short Delivery</div>
                    <div class="service-desc">Quick deliveries</div>
                </div>
                
                <div class="service-tab" data-service="express">
                    <div class="service-icon">
                        <i class="fas fa-shopping-bag"></i>
                    </div>
                    <div class="service-name">Express Shopping</div>
                    <div class="service-desc">Shop for you</div>
                </div>
                
                <div class="service-tab" data-service="truck">
                    <div class="service-icon">
                        <i class="fas fa-truck"></i>
                    </div>
                    <div class="service-name">Truck</div>
                    <div class="service-desc">Move items</div>
                </div>
            </div>
            
            <!-- Car Service Form (Default) -->
            <div class="ride-request-form active" id="carForm">
                <div class="form-title">
                    <i class="fas fa-car"></i>
                    Book a Ride
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="pickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="pickupLocation" placeholder="Current location" readonly>
                        <div class="search-loading" id="searchLoading"></div>
                        <div class="suggestion-list" id="pickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="destinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="destinationLocation" placeholder="Where to?" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="destinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Stops Container -->
                <div id="stopsContainer"></div>
                <button type="button" class="btn btn-secondary" id="addStopBtn" style="width: 100%; margin: 10px 0;">
                    <i class="fas fa-plus"></i> Add Stop
                </button>
                
                <!-- Search History -->
                <div class="search-history" id="searchHistory" style="display: none;"></div>
                
                <!-- Ride Type Selection -->
                <div class="ride-type-selection" id="rideTypeSelection">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                    </div>
                    <div class="ride-type-cards" id="rideTypeCardsContainer"></div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="fareDisplay">
                    <div class="fare-label">Estimated Fare</div>
                    <div class="fare-amount" id="estimatedFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="distanceDetail">0 km</span>
                        <span id="timeDetail">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestRideBtn">
                        <i class="fas fa-search"></i>
                        Request Ride
                    </button>
                </div>
            </div>
            
            <!-- Ride Info Panel -->
            <div class="ride-info-panel" id="rideInfoPanel">
                <div class="driver-info">
                    <div class="driver-avatar" id="driverAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="driver-details">
                        <div class="driver-name" id="driverName">Driver Name</div>
                        <div class="driver-rating">
                            <i class="fas fa-star"></i>
                            <span id="driverRating">4.8</span>
                        </div>
                        <div class="driver-vehicle">
                            <i class="fas fa-car"></i>
                            <span id="vehicleDetails">Toyota Corolla - ABC 123</span>
                        </div>
                    </div>
                </div>
                
                <!-- Timeline -->
                <div class="timeline" id="rideTimeline">
                    <div class="timeline-step">
                        <div class="step-dot active" id="stepRequested">
                            <i class="fas fa-search"></i>
                        </div>
                        <div class="step-label active">Requested</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepAccepted">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <div class="step-label">Accepted</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepArrived">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="step-label">Arrived</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepStarted">
                            <i class="fas fa-play"></i>
                        </div>
                        <div class="step-label">Started</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepCompleted">
                            <i class="fas fa-flag-checkered"></i>
                        </div>
                        <div class="step-label">Completed</div>
                    </div>
                </div>
                
                <div class="trip-details">
                    <div class="trip-locations">
                        <div class="location-point">
                            <div class="location-marker pickup">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="location-text">
                                <div class="location-label">Pickup</div>
                                <div class="location-address" id="currentPickup">Loading...</div>
                            </div>
                        </div>
                        
                        <div class="location-point">
                            <div class="location-marker destination">
                                <i class="fas fa-flag"></i>
                            </div>
                            <div class="location-text">
                                <div class="location-label">Destination</div>
                                <div class="location-address" id="currentDestination">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Location Details -->
                <div class="location-details">
                    <div class="location-detail-item">
                        <div class="location-detail-icon">
                            <i class="fas fa-road"></i>
                        </div>
                        <div class="location-detail-content">
                            <div class="location-detail-label">Distance</div>
                            <div class="location-detail-value" id="rideDistance">0 km</div>
                        </div>
                    </div>
                    <div class="location-detail-item">
                        <div class="location-detail-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="location-detail-content">
                            <div class="location-detail-label">Estimated Time</div>
                            <div class="location-detail-value" id="rideTime">0 min</div>
                        </div>
                    </div>
                </div>
                
                <div class="fare-breakdown">
                    <div class="fare-row">
                        <span class="fare-label">Base Fare</span>
                        <span class="fare-value" id="baseFareValue">ZMW 15.00</span>
                    </div>
                    <div class="fare-row">
                        <span class="fare-label">Distance</span>
                        <span class="fare-value" id="distanceFareValue">ZMW 5.00</span>
                    </div>
                    <div class="fare-row">
                        <span class="fare-label">Ride Type</span>
                        <span class="fare-value" id="rideTypeValue">Standard</span>
                    </div>
                    <div class="fare-row total">
                        <span class="fare-label">Total Fare</span>
                        <span class="fare-value" id="totalFareValue">ZMW 20.00</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-danger" id="cancelRideBtn">
                        <i class="fas fa-times-circle"></i>
                        Cancel Ride
                    </button>
                    <button class="btn btn-secondary" id="contactDriverBtn">
                        <i class="fas fa-phone"></i>
                        Call Driver
                    </button>
                    <button class="btn btn-secondary" id="openChatBtn">
                        <i class="fas fa-comment"></i>
                        Chat
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Payment Modal -->
    <div class="modal-overlay" id="paymentModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-credit-card"></i>
                    Select Payment Method
                </div>
                <button class="modal-close" data-modal="payment">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <div class="form-label">Available Balance: <span id="paymentBalance">ZMW 0.00</span></div>
                    <div class="form-label">Total Amount: <span id="paymentAmount">ZMW 0.00</span></div>
                </div>
                
                <!-- Referral Discount Section -->
                <div class="referral-discount-section" id="referralDiscountSection">
                    <div class="section-header" style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                        <i class="fas fa-gift" style="color: var(--primary-orange);"></i>
                        <span style="font-weight: 600;">Referral Discount (50% off)</span>
                    </div>
                    <div class="referral-input-group" style="display: flex; gap: 10px; margin-bottom: 12px;">
                        <input type="text" class="form-control" id="referralCodeInput" placeholder="Enter referral code">
                        <button id="applyReferralBtn" class="btn btn-primary" style="padding: 12px 16px; white-space: nowrap;">
                            <i class="fas fa-check"></i> Apply
                        </button>
                    </div>
                    <div id="referrerInfo" style="display: none; font-size: 12px; color: var(--success-green); margin-bottom: 8px;"></div>
                    <div class="discount-breakdown" style="border-top: 1px solid var(--light-gray); padding-top: 12px;">
                        <div class="price-breakdown-row">
                            <span>Original Fare:</span>
                            <span id="originalFareAmount">ZMW 0.00</span>
                        </div>
                        <div class="price-breakdown-row">
                            <span>Discount:</span>
                            <span id="discountAmount" style="color: var(--success-green);">-ZMW 0.00</span>
                        </div>
                        <div class="price-breakdown-row total">
                            <span>Final Fare:</span>
                            <span id="finalFareAmount" style="font-weight: bold;">ZMW 0.00</span>
                        </div>
                    </div>
                </div>
                
                <div class="payment-methods">
                    <div class="payment-method" data-payment="wallet">
                        <div class="payment-icon">
                            <i class="fas fa-wallet"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Jubel Wallet</div>
                            <div class="payment-info">Pay with your wallet balance</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-payment="mobile">
                        <div class="payment-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Mobile Money</div>
                            <div class="payment-info">Pay via MTN/Zamtel/Airtel</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-payment="cash">
                        <div class="payment-icon">
                            <i class="fas fa-money-bill"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Cash</div>
                            <div class="payment-info">Pay driver directly</div>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons" style="position: static; padding: 0; border: none; margin-top: 24px;">
                    <button class="btn btn-primary" id="confirmPaymentBtn" style="margin-bottom: 12px;">
                        <i class="fas fa-check"></i>
                        Confirm Payment
                    </button>
                    <button class="btn btn-secondary" data-modal="payment" style="background: transparent; color: var(--text-dark);">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Cancel Ride Modal -->
    <div class="modal-overlay" id="cancelModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-times-circle"></i>
                    Cancel Ride
                </div>
                <button class="modal-close" data-modal="cancel">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <div class="form-label">Please select a reason for cancellation:</div>
                </div>
                
                <div class="cancel-reasons">
                    <div class="cancel-reason" data-reason="driver_late">
                        <div class="reason-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="reason-text">Driver is taking too long</div>
                    </div>
                    
                    <div class="cancel-reason" data-reason="change_plans">
                        <div class="reason-icon">
                            <i class="fas fa-calendar-times"></i>
                        </div>
                        <div class="reason-text">Change of plans</div>
                    </div>
                    
                    <div class="cancel-reason" data-reason="found_alternative">
                        <div class="reason-icon">
                            <i class="fas fa-car"></i>
                        </div>
                        <div class="reason-text">Found alternative transport</div>
                    </div>
                    
                    <div class="cancel-reason" data-reason="emergency">
                        <div class="reason-icon">
                            <i class="fas fa-exclamation"></i>
                        </div>
                        <div class="reason-text">Emergency situation</div>
                    </div>
                    
                    <div class="cancel-reason" data-reason="other">
                        <div class="reason-icon">
                            <i class="fas fa-ellipsis-h"></i>
                        </div>
                        <div class="reason-text">Other reason</div>
                    </div>
                </div>
                
                <div class="form-group" id="otherReasonGroup" style="display: none;">
                    <label class="form-label">Please specify:</label>
                    <textarea class="form-control form-textarea" id="otherReason" placeholder="Enter your reason here..."></textarea>
                </div>
                
                <div class="action-buttons" style="position: static; padding: 0; border: none; margin-top: 24px;">
                    <button class="btn btn-danger" id="confirmCancelBtn" style="margin-bottom: 12px;">
                        <i class="fas fa-times"></i>
                        Cancel Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="cancel">
                        Go Back
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Notifications Panel -->
    <div class="notifications-panel" id="notificationsPanel">
        <div class="notifications-header">
            <div class="notifications-title">Notifications</div>
            <button class="notifications-close" id="notificationsClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="notifications-list" id="notificationsList">
            <!-- Notifications will be inserted here -->
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Loading...</div>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Real-time Indicator -->
    <div class="real-time-indicator" id="realTimeIndicator">
        <i class="fas fa-sync-alt"></i>
        <span>Real-time updates active</span>
    </div>

    <!-- External JavaScript Libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>
    
    <script>
        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyDEACX_P4c5q7djJAcA0I7Lk7leO2TlQ74",
            authDomain: "jubel-13e1a.firebaseapp.com",
            databaseURL: "https://jubel-13e1a-default-rtdb.firebaseio.com",
            projectId: "jubel-13e1a",
            storageBucket: "jubel-13e1a.firebasestorage.app",
            messagingSenderId: "882241095445",
            appId: "1:882241095445:web:ee9ca40fddd008ca910b1c",
            measurementId: "G-J5JPKL6B5F"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        const storage = firebase.storage();

        // ============================================
        // GLOBAL STATE MANAGEMENT
        // ============================================
        const AppState = {
            currentUser: null,
            userData: null,
            currentRide: null,
            activeScreen: 'home',
            activeService: 'car',
            walletBalance: 0,
            userLocation: null,
            currentCity: null,
            selectedRideType: 'standard',
            selectedVehicle: null,
            destination: null,
            pickup: null,
            rideFare: 0,
            driverLocation: null,
            chatMessages: [],
            scheduledRides: [],
            emergencyMode: false,
            sosConfig: null,
            searchCache: new Map(),
            lastSearchTime: 0,
            notifications: [],
            unreadNotifications: 0,
            searchHistory: [],
            broadcastRecipients: [],
            realtimeListeners: [],
            rideTypes: {
                economy: { base: 15, perKm: 2.5, multiplier: 0.8, min: 10 },
                standard: { base: 20, perKm: 3.0, multiplier: 1.0, min: 15 },
                premium: { base: 30, perKm: 4.0, multiplier: 1.5, min: 25 }
            },
            referralDiscountApplied: false,
            referralCodeUsed: null,
            referralOwnerName: null,
            activeRoute: null,
            chatOpen: false,
            notificationsOpen: false,
            mapInitialized: false,
            rideStops: []
        };

        // ============================================
        // MAP MANAGEMENT
        // ============================================
        let map = null;
        let currentLocationMarker = null;
        let pickupMarker = null;
        let destinationMarker = null;
        let driverMarker = null;
        let routeLayer = null;
        let pulsingIcon = null;

        // ============================================
        // ENHANCED LOCATION SEARCH ENGINE
        // ============================================
        class EnhancedSearchEngine {
            static cache = new Map();
            static searchHistory = [];
            static maxHistoryItems = 15;

            static init() {
                this.loadSearchHistory();
                console.log('Enhanced Search Engine initialized');
            }

            static loadSearchHistory() {
                try {
                    const history = localStorage.getItem('jubel_search_history');
                    if (history) {
                        this.searchHistory = JSON.parse(history);
                        console.log(`Loaded ${this.searchHistory.length} search history items`);
                    }
                } catch (error) {
                    console.error('Error loading search history:', error);
                    this.searchHistory = [];
                }
            }

            static saveSearchHistory() {
                try {
                    localStorage.setItem('jubel_search_history', JSON.stringify(this.searchHistory));
                } catch (error) {
                    console.error('Error saving search history:', error);
                }
            }

            static addToHistory(query, location, type) {
                const historyItem = {
                    query: query,
                    location: location,
                    type: type,
                    timestamp: Date.now(),
                    city: AppState.currentCity
                };

                this.searchHistory = this.searchHistory.filter(item => 
                    !(item.query === query && item.type === type && item.city === AppState.currentCity)
                );

                this.searchHistory.unshift(historyItem);

                if (this.searchHistory.length > this.maxHistoryItems) {
                    this.searchHistory = this.searchHistory.slice(0, this.maxHistoryItems);
                }

                this.saveSearchHistory();
                return historyItem;
            }

            static async search(query, type = 'destination', location = null, forceCity = null) {
                try {
                    const city = forceCity || AppState.currentCity;
                    if (!city) {
                        console.warn('No city detected for search');
                        return [];
                    }

                    const cacheKey = `${query.toLowerCase()}-${type}-${city}-${location ? `${location.lat.toFixed(4)},${location.lng.toFixed(4)}` : 'none'}`;

                    if (this.cache.has(cacheKey)) {
                        const cached = this.cache.get(cacheKey);
                        if (Date.now() - cached.timestamp < 300000) {
                            console.log('Returning cached search results');
                            return cached.results;
                        }
                    }

                    console.log(`Searching for "${query}" in ${city}, type: ${type}`);

                    const searchUrl = this.buildCityConstrainedSearchUrl(query, city, location);

                    const response = await fetch(searchUrl, {
                        headers: {
                            'User-Agent': 'JubelRideApp/1.0',
                            'Accept': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`Search failed: ${response.status} ${response.statusText}`);
                    }

                    const data = await response.json();
                    console.log(`Received ${data.length} results for "${query}"`);

                    const results = this.processAndFilterResults(data, location, city, type);

                    this.cache.set(cacheKey, {
                        results: results,
                        timestamp: Date.now(),
                        query: query,
                        city: city
                    });

                    if (type === 'destination' && results.length > 0) {
                        this.addToHistory(query, results[0], type);
                    }

                    return results;
                } catch (error) {
                    console.error('Search error:', error);
                    UI.showToast('Search service temporarily unavailable. Please try again.', 'warning');
                    return [];
                }
            }

            static buildCityConstrainedSearchUrl(query, city, location) {
                const bounds = this.getCityBounds(city);
                if (!bounds) {
                    return `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query + ', ' + city + ', Zambia')}&format=json&limit=15&countrycodes=zm&accept-language=en&addressdetails=1`;
                }

                const params = new URLSearchParams({
                    q: `${query}, ${city}, Zambia`,
                    format: 'json',
                    limit: 20,
                    countrycodes: 'zm',
                    bounded: 1,
                    viewbox: bounds.join(','),
                    'accept-language': 'en',
                    addressdetails: 1
                });

                return `https://nominatim.openstreetmap.org/search?${params}`;
            }

            static getCityBounds(cityName) {
                const cityBounds = {
                    'Lusaka': [27.8, -15.8, 28.8, -15.2],
                    'Ndola': [28.5, -13.1, 28.8, -12.9],
                    'Kitwe': [27.9, -13.1, 28.4, -12.7],
                    'Kabwe': [28.3, -14.6, 28.6, -14.3],
                    'Livingstone': [25.7, -18.0, 26.0, -17.7],
                    'Chipata': [32.5, -13.8, 32.8, -13.6]
                };

                return cityBounds[cityName] || null;
            }

            static processAndFilterResults(data, location, city, type) {
                if (!data || data.length === 0) return [];

                const cityLower = city.toLowerCase();
                const processedResults = [];

                data.forEach(place => {
                    try {
                        const address = place.address || {};
                        const placeCity = address.city || address.town || address.village || address.municipality;
                        const placeCityLower = placeCity ? placeCity.toLowerCase() : '';

                        if (city && !this.isInCity(place, cityLower, placeCityLower)) {
                            return;
                        }

                        let distance = 0;
                        if (location) {
                            distance = this.calculateDistance(
                                location.lat, location.lng,
                                parseFloat(place.lat), parseFloat(place.lon)
                            );
                        }

                        const displayAddress = this.formatAddress(place, city);

                        const result = {
                            id: place.place_id || `${place.lat}-${place.lon}`,
                            name: place.display_name.split(',')[0] || 'Unnamed Location',
                            address: displayAddress,
                            fullAddress: place.display_name,
                            lat: parseFloat(place.lat),
                            lng: parseFloat(place.lon),
                            distance: distance,
                            city: placeCity || city
                        };

                        processedResults.push(result);
                    } catch (error) {
                        console.error('Error processing search result:', error, place);
                    }
                });

                return processedResults
                    .sort((a, b) => {
                        if (location && a.distance !== b.distance) {
                            return a.distance - b.distance;
                        }
                        return 0;
                    })
                    .slice(0, 10);
            }

            static isInCity(place, targetCity, placeCity) {
                if (!targetCity) return true;
                if (placeCity && placeCity.includes(targetCity)) return true;

                const address = place.address || {};
                const components = [
                    address.city,
                    address.town,
                    address.village,
                    address.municipality,
                    address.county
                ].filter(Boolean);

                return components.some(component => 
                    component.toLowerCase().includes(targetCity)
                );
            }

            static formatAddress(place, currentCity) {
                const address = place.address || {};
                const parts = [];

                if (address.road) {
                    parts.push(address.road);
                }

                if (address.suburb || address.neighbourhood) {
                    parts.push(address.suburb || address.neighbourhood);
                }

                if (address.city || address.town) {
                    const cityName = address.city || address.town;
                    if (cityName.toLowerCase() !== currentCity.toLowerCase()) {
                        parts.push(cityName);
                    }
                }

                if (parts.length === 0) {
                    return place.display_name.split(',').slice(0, 2).join(',').trim();
                }

                return parts.join(', ');
            }

            static calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 6371;
                const dLat = this.toRad(lat2 - lat1);
                const dLon = this.toRad(lon2 - lon1);
                const a = 
                    Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(this.toRad(lat1)) * Math.cos(this.toRad(lat2)) * 
                    Math.sin(dLon/2) * Math.sin(dLon/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            }

            static toRad(value) {
                return value * Math.PI / 180;
            }

            static getSearchHistory(type = null, city = null) {
                let history = this.searchHistory;

                if (type) {
                    history = history.filter(item => item.type === type);
                }

                if (city) {
                    history = history.filter(item => item.city === city);
                }

                return history;
            }

            static clearSearchHistory() {
                this.searchHistory = [];
                this.saveSearchHistory();
                UI.showToast('Search history cleared', 'success');
            }

            static validateCoordinatesInCity(lat, lng, city) {
                const bounds = this.getCityBounds(city);
                if (!bounds) return true;

                const [west, south, east, north] = bounds;
                return lng >= west && lng <= east && lat >= south && lat <= north;
            }
        }

        // ============================================
        // UI MANAGEMENT
        // ============================================
        class UI {
            static showToast(message, type = 'info', duration = 5000) {
                const toastContainer = document.getElementById('toastContainer');
                if (!toastContainer) return null;

                const toastId = 'toast-' + Date.now();

                const icons = {
                    success: 'fa-check-circle',
                    error: 'fa-exclamation-circle',
                    warning: 'fa-exclamation-triangle',
                    info: 'fa-info-circle'
                };

                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.id = toastId;
                toast.innerHTML = `
                    <div class="toast-icon">
                        <i class="fas ${icons[type] || icons.info}"></i>
                    </div>
                    <div class="toast-content">
                        <div class="toast-message">${message}</div>
                    </div>
                    <button class="toast-close" onclick="document.getElementById('${toastId}').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                `;

                toastContainer.appendChild(toast);

                setTimeout(() => {
                    const toastElement = document.getElementById(toastId);
                    if (toastElement) {
                        toastElement.style.opacity = '0';
                        toastElement.style.transform = 'translateX(100%)';
                        setTimeout(() => toastElement.remove(), 300);
                    }
                }, duration);

                return toastId;
            }

            static showLoading(message = 'Loading...') {
                const overlay = document.getElementById('loadingOverlay');
                const text = document.getElementById('loadingText');
                if (overlay && text) {
                    text.textContent = message;
                    overlay.style.display = 'flex';
                }
            }

            static hideLoading() {
                const overlay = document.getElementById('loadingOverlay');
                if (overlay) {
                    overlay.style.display = 'none';
                }
            }

            static showMapLoading() {
                const mapLoadingOverlay = document.getElementById('mapLoadingOverlay');
                if (mapLoadingOverlay) {
                    mapLoadingOverlay.style.display = 'flex';
                }
            }

            static hideMapLoading() {
                const mapLoadingOverlay = document.getElementById('mapLoadingOverlay');
                if (mapLoadingOverlay) {
                    mapLoadingOverlay.style.display = 'none';
                }
            }

            static updateWalletBalance(balance) {
                const formatted = balance.toFixed(2);
                const walletBalance = document.getElementById('walletBalance');
                const paymentBalance = document.getElementById('paymentBalance');

                if (walletBalance) walletBalance.textContent = formatted;
                if (paymentBalance) paymentBalance.textContent = formatted;

                AppState.walletBalance = balance;
            }

            static updateUserInfo(userData) {
                if (userData.name) {
                    const userFullName = document.getElementById('userFullName');
                    if (userFullName) userFullName.textContent = userData.name;
                }
            }

            static updateCityDisplay(city) {
                const display = document.getElementById('currentCityDisplay');
                if (display && city) {
                    display.textContent = `City: ${city}`;
                    display.parentElement.style.display = 'flex';
                    
                    setTimeout(() => {
                        if (display.parentElement) {
                            display.parentElement.style.display = 'none';
                        }
                    }, 5000);
                }
            }

            static updateRidePrices(distanceKm) {
                const types = ['economy', 'standard', 'premium'];
                
                types.forEach(type => {
                    const price = this.calculateRideFare(distanceKm, type);
                    const element = document.getElementById(`${type}Price`);
                    if (element) {
                        element.textContent = `ZMW ${price.toFixed(2)}`;
                    }
                });

                const selectedPrice = this.calculateRideFare(distanceKm, AppState.selectedRideType);
                const estimatedFare = document.getElementById('estimatedFare');
                if (estimatedFare) estimatedFare.textContent = `ZMW ${selectedPrice.toFixed(2)}`;

                const time = this.estimateTime(distanceKm, AppState.selectedRideType);
                const distanceDetail = document.getElementById('distanceDetail');
                const timeDetail = document.getElementById('timeDetail');

                if (distanceDetail) distanceDetail.textContent = `${distanceKm.toFixed(1)} km`;
                if (timeDetail) timeDetail.textContent = `ETA: ${time} min`;

                AppState.rideFare = selectedPrice;

                const fareDisplay = document.getElementById('fareDisplay');
                if (fareDisplay) fareDisplay.classList.add('active');
            }

            static calculateRideFare(distanceKm, rideType = 'standard') {
                const config = AppState.rideTypes[rideType] || AppState.rideTypes.standard;
                let fare = config.base + (distanceKm * config.perKm);
                fare *= config.multiplier;
                fare = Math.max(fare, config.min);
                return Math.round(fare * 100) / 100;
            }

            static estimateTime(distanceKm, rideType = 'standard') {
                const baseSpeed = rideType === 'premium' ? 45 : 35;
                let baseTime = (distanceKm / baseSpeed) * 60;
                baseTime += rideType === 'premium' ? 2 : 5;
                return Math.ceil(baseTime);
            }

            static showRideInfo(ride) {
                document.getElementById('carForm').style.display = 'none';
                document.getElementById('rideInfoPanel').style.display = 'block';
                document.getElementById('rideInfoPanel').classList.add('active');

                const currentPickup = document.getElementById('currentPickup');
                const currentDestination = document.getElementById('currentDestination');
                const rideDistance = document.getElementById('rideDistance');
                const rideTime = document.getElementById('rideTime');

                if (currentPickup) currentPickup.textContent = ride.pickupDisplay || ride.pickup || 'Loading...';
                if (currentDestination) currentDestination.textContent = ride.destinationDisplay || ride.destination || 'Loading...';
                if (rideDistance) rideDistance.textContent = ride.distance ? `${ride.distance.toFixed(1)} km` : '0 km';
                if (rideTime) rideTime.textContent = ride.estimatedTime ? `${ride.estimatedTime} min` : '0 min';

                this.updateRideStatus(ride.status);
                this.updateTimeline(ride.status);
            }

            static updateRideStatus(status) {
                const statusBar = document.getElementById('rideStatusBar');
                const statusDot = document.getElementById('statusDot');
                const statusText = document.getElementById('statusText');
                const etaText = document.getElementById('etaText');

                if (!statusBar || !statusDot || !statusText || !etaText) return;

                statusBar.classList.add('active');

                switch(status) {
                    case 'requested':
                        statusDot.className = 'status-dot searching';
                        statusText.textContent = 'Searching for driver';
                        etaText.textContent = '5-10 min';
                        this.showPulsingRideIcon();
                        break;
                    case 'accepted':
                        statusDot.className = 'status-dot arriving';
                        statusText.textContent = 'Driver on the way';
                        etaText.textContent = '5 min';
                        break;
                    case 'arrived':
                        statusDot.className = 'status-dot riding';
                        statusText.textContent = 'Driver arrived';
                        etaText.textContent = '0 min';
                        break;
                    case 'started':
                        statusDot.className = 'status-dot riding';
                        statusText.textContent = 'Trip in progress';
                        etaText.textContent = 'En route';
                        break;
                    case 'completed':
                        statusBar.classList.remove('active');
                        break;
                    case 'cancelled':
                        statusBar.classList.remove('active');
                        break;
                }
            }

            static showPulsingRideIcon() {
                this.removePulsingRideIcon();

                const serviceType = AppState.activeService;
                let iconClass = 'fa-car';

                if (serviceType === 'truck') {
                    iconClass = 'fa-truck';
                } else if (serviceType === 'delivery' || serviceType === 'short-delivery') {
                    iconClass = 'fa-shipping-fast';
                } else if (serviceType === 'express') {
                    iconClass = 'fa-shopping-bag';
                }

                pulsingIcon = document.createElement('div');
                pulsingIcon.id = 'pulsingRideIcon';
                pulsingIcon.className = 'pulsing-ride-icon';
                pulsingIcon.innerHTML = `<i class="fas ${iconClass}"></i>`;
                pulsingIcon.style.cssText = `
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    font-size: 80px;
                    color: #FF6B35;
                    z-index: 1000;
                    animation: ridePulse 1.5s infinite;
                    pointer-events: none;
                `;

                const mapContainer = document.getElementById('map');
                if (mapContainer) {
                    mapContainer.appendChild(pulsingIcon);
                }
            }

            static removePulsingRideIcon() {
                const pulsingIcon = document.getElementById('pulsingRideIcon');
                if (pulsingIcon) {
                    pulsingIcon.remove();
                }
            }

            static updateTimeline(status) {
                const steps = ['stepRequested', 'stepAccepted', 'stepArrived', 'stepStarted', 'stepCompleted'];
                const stepLabels = ['Requested', 'Accepted', 'Arrived', 'Started', 'Completed'];
                let currentIndex = stepLabels.indexOf(status);

                if (currentIndex === -1) {
                    currentIndex = 0;
                }

                steps.forEach((stepId, index) => {
                    const step = document.getElementById(stepId);
                    const label = step?.parentNode.querySelector('.step-label');

                    if (step && label) {
                        if (index < currentIndex) {
                            step.className = 'step-dot completed';
                            label.className = 'step-label';
                        } else if (index === currentIndex) {
                            step.className = 'step-dot active';
                            label.className = 'step-label active';
                        } else {
                            step.className = 'step-dot';
                            label.className = 'step-label';
                        }
                    }
                });
            }

            static showSearchSuggestions(inputId, results, type = 'destination') {
                const container = document.getElementById(`${inputId}Suggestions`);
                if (!container) {
                    console.error(`Suggestions container not found for ${inputId}`);
                    return;
                }

                container.innerHTML = '';

                if (results.length === 0) {
                    container.innerHTML = `
                        <div class="suggestion-item">
                            <div class="suggestion-name">No results found</div>
                            <div class="suggestion-address">Try a different search term</div>
                        </div>
                    `;
                } else {
                    results.forEach(result => {
                        const item = document.createElement('div');
                        item.className = 'suggestion-item';
                        item.dataset.lat = result.lat;
                        item.dataset.lng = result.lng;
                        item.dataset.address = result.address;
                        item.dataset.name = result.name;

                        item.innerHTML = `
                            <div class="suggestion-name">${result.name}</div>
                            <div class="suggestion-address">${result.address}</div>
                            ${result.distance ? `<div class="suggestion-distance">${result.distance.toFixed(1)} km away</div>` : ''}
                        `;

                        item.addEventListener('click', () => {
                            if (type === 'pickup') {
                                this.selectPickupLocation(inputId, result);
                            } else {
                                this.selectDestinationLocation(inputId, result);
                            }
                        });

                        container.appendChild(item);
                    });
                }

                container.style.display = 'block';

                const input = document.getElementById(inputId);
                if (input) {
                    const rect = input.getBoundingClientRect();
                    container.style.top = `${rect.bottom + window.scrollY}px`;
                    container.style.left = `${rect.left + window.scrollX}px`;
                    container.style.width = `${rect.width}px`;
                }
            }

            static selectPickupLocation(inputId, location) {
                const input = document.getElementById(inputId);

                if (!EnhancedSearchEngine.validateCoordinatesInCity(location.lat, location.lng, AppState.currentCity)) {
                    this.showToast(`Location must be within ${AppState.currentCity}`, 'warning');
                    return;
                }

                input.value = location.address || location.name;
                AppState.pickup = location;
                this.updatePickupMarker(location);

                const suggestions = document.getElementById(`${inputId}Suggestions`);
                if (suggestions) suggestions.style.display = 'none';

                if (AppState.destination) {
                    this.calculateAndUpdatePrices();
                    this.drawRoute(location, AppState.destination);
                }
            }

            static selectDestinationLocation(inputId, location) {
                const input = document.getElementById(inputId);

                if (!EnhancedSearchEngine.validateCoordinatesInCity(location.lat, location.lng, AppState.currentCity)) {
                    this.showToast(`Location must be within ${AppState.currentCity}`, 'warning');
                    return;
                }

                input.value = location.address || location.name;
                AppState.destination = location;
                this.updateDestinationMarker(location);

                const suggestions = document.getElementById(`${inputId}Suggestions`);
                if (suggestions) suggestions.style.display = 'none';

                if (AppState.pickup) {
                    this.calculateAndUpdatePrices();
                    this.drawRoute(AppState.pickup, location);
                }

                const rideTypeSelection = document.getElementById('rideTypeSelection');
                if (rideTypeSelection) rideTypeSelection.classList.add('active');
            }

            static updatePickupMarker(location) {
                if (!map) return;

                if (pickupMarker) {
                    pickupMarker.setLatLng([location.lat, location.lng]);
                } else {
                    pickupMarker = L.marker([location.lat, location.lng], {
                        icon: L.divIcon({
                            className: 'pickup-marker',
                            html: '<i class="fas fa-map-marker-alt" style="color: #FF6B35; font-size: 24px;"></i>',
                            iconSize: [24, 24],
                            iconAnchor: [12, 24]
                        })
                    }).addTo(map).bindPopup('Pickup Location');
                }
            }

            static updateDestinationMarker(location) {
                if (!map) return;

                if (destinationMarker) {
                    destinationMarker.setLatLng([location.lat, location.lng]);
                } else {
                    destinationMarker = L.marker([location.lat, location.lng], {
                        icon: L.divIcon({
                            className: 'destination-marker',
                            html: '<i class="fas fa-flag" style="color: #FF6B35; font-size: 24px;"></i>',
                            iconSize: [24, 24],
                            iconAnchor: [12, 24]
                        })
                    }).addTo(map).bindPopup('Destination');
                }
            }

            static drawRoute(start, end) {
                if (!map) return;

                if (routeLayer) {
                    map.removeLayer(routeLayer);
                }

                const startValid = EnhancedSearchEngine.validateCoordinatesInCity(
                    start.lat, start.lng, AppState.currentCity
                );
                const endValid = EnhancedSearchEngine.validateCoordinatesInCity(
                    end.lat, end.lng, AppState.currentCity
                );

                if (!startValid || !endValid) {
                    console.warn('Route points outside city bounds');
                    return;
                }

                try {
                    routeLayer = L.polyline([
                        [start.lat, start.lng],
                        [end.lat, end.lng]
                    ], {
                        color: '#FF6B35',
                        weight: 4,
                        opacity: 0.7,
                        dashArray: '10, 10'
                    }).addTo(map);

                    const bounds = L.latLngBounds(
                        [start.lat, start.lng],
                        [end.lat, end.lng]
                    );
                    map.fitBounds(bounds, { padding: [50, 50] });

                    const distance = EnhancedSearchEngine.calculateDistance(start.lat, start.lng, end.lat, end.lng);
                    AppState.activeRoute = {
                        distance: distance,
                        coordinates: [[start.lat, start.lng], [end.lat, end.lng]]
                    };

                } catch (error) {
                    console.error('Routing error:', error);
                }
            }

            static calculateAndUpdatePrices() {
                if (AppState.pickup && AppState.destination) {
                    const distance = EnhancedSearchEngine.calculateDistance(
                        AppState.pickup.lat, AppState.pickup.lng,
                        AppState.destination.lat, AppState.destination.lng
                    );

                    if (distance < 0.5) {
                        this.showToast('Minimum ride distance is 0.5 km', 'warning');
                        return;
                    }

                    this.updateRidePrices(distance);
                }
            }

            static showSearchHistory(inputId) {
                const container = document.getElementById('searchHistory');
                if (!container) return;

                const history = EnhancedSearchEngine.getSearchHistory(
                    inputId.includes('destination') ? 'destination' : 'pickup',
                    AppState.currentCity
                );

                if (history.length === 0) {
                    container.style.display = 'none';
                    return;
                }

                let html = `
                    <div class="search-history-header">
                        <div><i class="fas fa-history"></i> Recent in ${AppState.currentCity}</div>
                        <button class="clear-history-btn" onclick="EnhancedSearchEngine.clearSearchHistory()">
                            Clear
                        </button>
                    </div>
                `;

                history.forEach(item => {
                    html += `
                        <div class="search-history-item" data-lat="${item.location.lat}" data-lng="${item.location.lng}">
                            <div class="search-history-icon">
                                <i class="fas fa-${item.type === 'destination' ? 'flag' : 'map-marker-alt'}"></i>
                            </div>
                            <div class="search-history-text">
                                <div>${item.location.name}</div>
                                <div style="font-size: 12px; color: #666;">${item.location.address}</div>
                            </div>
                            <div class="search-history-time">
                                ${this.formatTimeAgo(item.timestamp)}
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
                container.style.display = 'block';

                const input = document.getElementById(inputId);
                if (input) {
                    const rect = input.getBoundingClientRect();
                    container.style.top = `${rect.bottom + window.scrollY}px`;
                    container.style.left = `${rect.left + window.scrollX}px`;
                    container.style.width = `${rect.width}px`;
                }

                container.querySelectorAll('.search-history-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const lat = parseFloat(item.dataset.lat);
                        const lng = parseFloat(item.dataset.lng);
                        const location = {
                            lat: lat,
                            lng: lng,
                            name: item.querySelector('.search-history-text div').textContent,
                            address: item.querySelector('.search-history-text div:nth-child(2)').textContent
                        };

                        if (inputId.includes('pickup')) {
                            this.selectPickupLocation(inputId, location);
                        } else {
                            this.selectDestinationLocation(inputId, location);
                        }
                        container.style.display = 'none';
                    });
                });
            }

            static formatTimeAgo(timestamp) {
                const now = Date.now();
                const diff = now - timestamp;

                if (diff < 60000) return 'Just now';
                if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
                if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
                return `${Math.floor(diff / 86400000)}d ago`;
            }

            static showModal(modalId) {
                const modal = document.getElementById(`${modalId}Modal`);
                if (modal) {
                    modal.style.display = 'flex';
                }
            }

            static hideModal(modalId) {
                const modal = document.getElementById(`${modalId}Modal`);
                if (modal) {
                    modal.style.display = 'none';
                }
            }

            static showRealTimeIndicator() {
                const indicator = document.getElementById('realTimeIndicator');
                if (indicator) {
                    indicator.classList.add('active');
                    setTimeout(() => {
                        indicator.classList.remove('active');
                    }, 3000);
                }
            }

            static addStop() {
                if (AppState.rideStops.length >= 3) {
                    this.showToast('Maximum 3 stops allowed', 'warning');
                    return;
                }

                const stopContainer = document.getElementById('stopsContainer');
                const stopNumber = AppState.rideStops.length + 1;

                const stopItem = document.createElement('div');
                stopItem.className = 'stop-item';
                stopItem.innerHTML = `
                    <div class="stop-number">${stopNumber}</div>
                    <div class="stop-address" contenteditable="true" placeholder="Enter stop address..."></div>
                    <button class="remove-stop">
                        <i class="fas fa-times"></i>
                    </button>
                `;

                stopContainer.appendChild(stopItem);

                AppState.rideStops.push({
                    number: stopNumber,
                    address: '',
                    location: null
                });

                const removeBtn = stopItem.querySelector('.remove-stop');
                removeBtn.addEventListener('click', () => {
                    this.removeStop(stopNumber);
                });

                const addressDiv = stopItem.querySelector('.stop-address');
                addressDiv.addEventListener('blur', () => {
                    AppState.rideStops[stopNumber - 1].address = addressDiv.textContent;
                });

                this.showToast(`Stop ${stopNumber} added`, 'success');
            }

            static removeStop(stopNumber) {
                AppState.rideStops = AppState.rideStops.filter(stop => stop.number !== stopNumber);
                
                // Re-number remaining stops
                AppState.rideStops.forEach((stop, index) => {
                    stop.number = index + 1;
                });

                const stopContainer = document.getElementById('stopsContainer');
                stopContainer.innerHTML = '';

                AppState.rideStops.forEach(stop => {
                    const stopItem = document.createElement('div');
                    stopItem.className = 'stop-item';
                    stopItem.innerHTML = `
                        <div class="stop-number">${stop.number}</div>
                        <div class="stop-address" contenteditable="true">${stop.address}</div>
                        <button class="remove-stop">
                            <i class="fas fa-times"></i>
                        </button>
                    `;

                    stopContainer.appendChild(stopItem);

                    const removeBtn = stopItem.querySelector('.remove-stop');
                    removeBtn.addEventListener('click', () => {
                        this.removeStop(stop.number);
                    });

                    const addressDiv = stopItem.querySelector('.stop-address');
                    addressDiv.addEventListener('blur', () => {
                        AppState.rideStops[stop.number - 1].address = addressDiv.textContent;
                    });
                });

                this.showToast('Stop removed', 'success');
            }
        }

        // ============================================
        // FIREBASE MANAGER
        // ============================================
        class FirebaseManager {
            static async loadUserData(uid) {
                try {
                    console.log(`Loading user data for UID: ${uid}`);
                    UI.showLoading('Loading your profile...');

                    const snapshot = await database.ref(`users/${uid}`).once('value');
                    AppState.userData = snapshot.val();

                    if (AppState.userData) {
                        console.log('User data loaded successfully:', AppState.userData);

                        AppState.walletBalance = AppState.userData.walletBalance || 0;
                        UI.updateWalletBalance(AppState.walletBalance);
                        UI.updateUserInfo(AppState.userData);

                        await this.checkActiveRide(uid);

                        this.startRealtimeSync(uid);

                        UI.hideLoading();
                        return true;
                    } else {
                        console.warn('No user data found');
                        UI.hideLoading();
                        return false;
                    }
                } catch (error) {
                    console.error('Error loading user data:', error);
                    UI.hideLoading();
                    UI.showToast('Error loading user data', 'error');
                    return false;
                }
            }

            static startRealtimeSync(uid) {
                console.log('Starting real-time sync for user:', uid);

                // Listen to user data changes
                const userRef = database.ref(`users/${uid}`);
                AppState.realtimeListeners.push(
                    userRef.on('value', (snapshot) => {
                        const userData = snapshot.val();
                        if (userData) {
                            AppState.userData = userData;
                            AppState.walletBalance = userData.walletBalance || 0;
                            UI.updateWalletBalance(AppState.walletBalance);
                            UI.updateUserInfo(userData);
                        }
                    })
                );

                // Listen to active rides
                const activeRideRef = database.ref('rides')
                    .orderByChild('passengerId')
                    .equalTo(uid)
                    .orderByChild('status')
                    .startAt('requested')
                    .endAt('started');

                AppState.realtimeListeners.push(
                    activeRideRef.on('value', (snapshot) => {
                        const rides = snapshot.val();
                        if (rides) {
                            const rideId = Object.keys(rides)[0];
                            const ride = { id: rideId, ...rides[rideId] };

                            if (!AppState.currentRide || AppState.currentRide.id !== rideId) {
                                console.log('New active ride detected:', rideId);
                                AppState.currentRide = ride;
                                UI.showRideInfo(ride);

                                if (ride.driverId) {
                                    this.loadDriverInfo(ride.driverId);
                                }
                            } else {
                                AppState.currentRide = ride;
                                UI.updateRideStatus(ride.status);
                                UI.updateTimeline(ride.status);

                                if (ride.status === 'completed') {
                                    this.handleRideCompletion(ride);
                                }
                            }
                        } else if (AppState.currentRide) {
                            console.log('Active ride ended');
                            this.resetActiveRide();
                        }
                    })
                );

                UI.showRealTimeIndicator();
                console.log('Real-time sync started successfully');
            }

            static async checkActiveRide(uid) {
                try {
                    const snapshot = await database.ref('rides')
                        .orderByChild('passengerId')
                        .equalTo(uid)
                        .orderByChild('status')
                        .startAt('requested')
                        .endAt('started')
                        .once('value');

                    const rides = snapshot.val();
                    if (rides) {
                        const rideId = Object.keys(rides)[0];
                        AppState.currentRide = { id: rideId, ...rides[rideId] };
                        console.log('Active ride found:', rideId);
                        UI.showRideInfo(AppState.currentRide);

                        if (AppState.currentRide.driverId) {
                            this.loadDriverInfo(AppState.currentRide.driverId);
                        }

                        return true;
                    }
                    console.log('No active ride found');
                    return false;
                } catch (error) {
                    console.error('Error checking active ride:', error);
                    return false;
                }
            }

            static async loadDriverInfo(driverId) {
                try {
                    const snapshot = await database.ref(`users/${driverId}`).once('value');
                    const driver = snapshot.val();
                    if (driver) {
                        AppState.selectedVehicle = driver;
                        
                        const driverName = document.getElementById('driverName');
                        const driverRating = document.getElementById('driverRating');
                        const vehicleDetails = document.getElementById('vehicleDetails');

                        if (driverName) driverName.textContent = driver.name || 'Driver';
                        if (driverRating) driverRating.textContent = driver.rating?.toFixed(1) || '4.8';
                        if (vehicleDetails) vehicleDetails.textContent = `${driver.vehicle?.model || 'Car'} - ${driver.vehicle?.plate || 'ABC 123'}`;

                        console.log('Driver info loaded:', driverId);
                    }
                } catch (error) {
                    console.error('Error loading driver info:', error);
                }
            }

            static async requestRide(rideData) {
                try {
                    UI.showLoading('Requesting ride...');

                    if (!rideData.pickup || !rideData.destination) {
                        throw new Error('Pickup and destination locations are required');
                    }

                    if (!EnhancedSearchEngine.validateCoordinatesInCity(
                        rideData.pickupLat, rideData.pickupLng, AppState.currentCity
                    ) || !EnhancedSearchEngine.validateCoordinatesInCity(
                        rideData.destLat, rideData.destLng, AppState.currentCity
                    )) {
                        throw new Error('Locations must be within city boundaries');
                    }

                    const rideId = database.ref().child('rides').push().key;

                    if (AppState.referralDiscountApplied && AppState.referralCodeUsed) {
                        rideData.referredBy = AppState.referralCodeUsed;
                        rideData.referralOwnerName = AppState.referralOwnerName;
                        
                        const discountAmount = rideData.fare * 0.5;
                        rideData.fare = rideData.fare - discountAmount;
                        rideData.referralDiscount = discountAmount;
                    }

                    const ride = {
                        id: rideId,
                        ...rideData,
                        status: 'requested',
                        timestamp: Date.now(),
                        updatedAt: Date.now(),
                        passengerId: AppState.currentUser.uid,
                        passengerName: AppState.userData.name,
                        passengerPhone: AppState.userData.phone,
                        city: AppState.currentCity
                    };

                    console.log('Creating ride:', rideId);
                    await database.ref(`rides/${rideId}`).set(ride);

                    AppState.currentRide = ride;
                    UI.showRideInfo(ride);
                    UI.updateTimeline('requested');
                    UI.showPulsingRideIcon();

                    UI.hideLoading();
                    UI.showToast('Ride requested successfully', 'success');

                    console.log('Ride request completed:', rideId);
                    return rideId;
                } catch (error) {
                    console.error('Error requesting ride:', error);
                    UI.hideLoading();
                    UI.showToast(error.message, 'error');
                    throw error;
                }
            }

            static async cancelRide(rideId, reason) {
                try {
                    UI.showLoading('Cancelling ride...');
                    
                    await database.ref(`rides/${rideId}/status`).set('cancelled');
                    await database.ref(`rides/${rideId}/cancelledAt`).set(Date.now());
                    await database.ref(`rides/${rideId}/cancellationReason`).set(reason);

                    // Refund wallet if payment was by wallet
                    if (AppState.currentRide?.paymentMethod === 'wallet') {
                        await this.depositMoney(AppState.currentRide.fare, 'refund', `Ride ${rideId} cancellation`);
                    }

                    this.resetActiveRide();
                    
                    UI.hideLoading();
                    UI.showToast('Ride cancelled successfully', 'success');
                } catch (error) {
                    console.error('Error cancelling ride:', error);
                    UI.hideLoading();
                    UI.showToast('Error cancelling ride', 'error');
                }
            }

            static async depositMoney(amount, type = 'deposit', message = '') {
                try {
                    const newBalance = AppState.walletBalance + amount;
                    
                    await database.ref(`users/${AppState.currentUser.uid}/walletBalance`).set(newBalance);
                    
                    // Record transaction
                    const transactionId = database.ref().child('transactions').push().key;
                    const transaction = {
                        id: transactionId,
                        userId: AppState.currentUser.uid,
                        amount: amount,
                        type: type,
                        message: message,
                        timestamp: Date.now(),
                        balanceAfter: newBalance
                    };
                    
                    await database.ref(`transactions/${transactionId}`).set(transaction);
                    
                    AppState.walletBalance = newBalance;
                    UI.updateWalletBalance(newBalance);
                    
                    return transactionId;
                } catch (error) {
                    console.error('Error depositing money:', error);
                    throw error;
                }
            }

            static async withdrawMoney(amount) {
                try {
                    if (AppState.walletBalance < amount) {
                        throw new Error('Insufficient balance');
                    }
                    
                    const newBalance = AppState.walletBalance - amount;
                    
                    await database.ref(`users/${AppState.currentUser.uid}/walletBalance`).set(newBalance);
                    
                    // Record transaction
                    const transactionId = database.ref().child('transactions').push().key;
                    const transaction = {
                        id: transactionId,
                        userId: AppState.currentUser.uid,
                        amount: -amount,
                        type: 'ride_payment',
                        message: 'Ride payment',
                        timestamp: Date.now(),
                        balanceAfter: newBalance
                    };
                    
                    await database.ref(`transactions/${transactionId}`).set(transaction);
                    
                    AppState.walletBalance = newBalance;
                    UI.updateWalletBalance(newBalance);
                    
                    return transactionId;
                } catch (error) {
                    console.error('Error withdrawing money:', error);
                    throw error;
                }
            }

            static async validateReferralCode(referralCode) {
                try {
                    const snapshot = await database.ref('users')
                        .orderByChild('referralCode')
                        .equalTo(referralCode)
                        .once('value');

                    const users = snapshot.val();
                    if (users) {
                        const userId = Object.keys(users)[0];
                        const userData = users[userId];
                        
                        return {
                            valid: true,
                            ownerId: userId,
                            ownerName: userData.name
                        };
                    }
                    
                    return { valid: false };
                } catch (error) {
                    console.error('Error validating referral code:', error);
                    throw error;
                }
            }

            static handleRideCompletion(ride) {
                // Process referral earnings if applicable
                if (ride.referredBy && ride.referralOwnerName) {
                    this.processReferralEarnings(ride);
                }

                // Reset active ride after a delay
                setTimeout(() => {
                    this.resetActiveRide();
                }, 5000);
            }

            static async processReferralEarnings(ride) {
                try {
                    // Find referral owner
                    const snapshot = await database.ref('users')
                        .orderByChild('referralCode')
                        .equalTo(ride.referredBy)
                        .once('value');

                    const users = snapshot.val();
                    if (users) {
                        const ownerId = Object.keys(users)[0];
                        const referralEarning = 25; // ZMW 25 for referral

                        // Add earnings to owner's wallet
                        const ownerRef = database.ref(`users/${ownerId}/walletBalance`);
                        const ownerSnapshot = await ownerRef.once('value');
                        const currentBalance = ownerSnapshot.val() || 0;
                        await ownerRef.set(currentBalance + referralEarning);

                        // Record referral transaction
                        const transactionId = database.ref().child('transactions').push().key;
                        const transaction = {
                            id: transactionId,
                            userId: ownerId,
                            amount: referralEarning,
                            type: 'referral_earning',
                            message: `Referral from ${ride.passengerName} for ride ${ride.id}`,
                            timestamp: Date.now(),
                            balanceAfter: currentBalance + referralEarning,
                            referredRideId: ride.id,
                            referredUserId: ride.passengerId
                        };

                        await database.ref(`transactions/${transactionId}`).set(transaction);
                    }
                } catch (error) {
                    console.error('Error processing referral earnings:', error);
                }
            }

            static resetActiveRide() {
                AppState.currentRide = null;
                document.getElementById('carForm').style.display = 'block';
                document.getElementById('rideInfoPanel').style.display = 'none';
                document.getElementById('rideInfoPanel').classList.remove('active');
                document.getElementById('rideStatusBar').classList.remove('active');
                UI.removePulsingRideIcon();

                // Reset form
                document.getElementById('destinationLocation').value = '';
                AppState.destination = null;
                document.getElementById('fareDisplay').classList.remove('active');
                document.getElementById('rideTypeSelection').classList.remove('active');

                // Clear markers and route
                if (destinationMarker) {
                    map.removeLayer(destinationMarker);
                    destinationMarker = null;
                }
                if (routeLayer) {
                    map.removeLayer(routeLayer);
                    routeLayer = null;
                }
            }
        }

        // ============================================
        // LOCATION MANAGER
        // ============================================
        class LocationManager {
            static async getCurrentLocation() {
                if (!navigator.geolocation) {
                    UI.showToast('Geolocation is not supported by your browser', 'warning');
                    return;
                }

                UI.showLoading('Getting your location...');

                try {
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 0
                        });
                    });

                    const { latitude, longitude } = position.coords;
                    console.log(`Location obtained: ${latitude}, ${longitude}`);

                    AppState.userLocation = { lat: latitude, lng: longitude };

                    // Update map view
                    map.setView([latitude, longitude], 15);

                    // Add current location marker
                    if (currentLocationMarker) {
                        map.removeLayer(currentLocationMarker);
                    }
                    
                    currentLocationMarker = L.marker([latitude, longitude], {
                        icon: L.divIcon({
                            className: 'current-location-marker',
                            html: '<i class="fas fa-user" style="color: #FF6B35; font-size: 20px;"></i>',
                            iconSize: [20, 20],
                            iconAnchor: [10, 20]
                        })
                    }).addTo(map).bindPopup('Your Location');

                    // Detect city
                    await this.detectCity(latitude, longitude);

                    // Set pickup location
                    const pickupInput = document.getElementById('pickupLocation');
                    if (pickupInput) {
                        pickupInput.value = 'Current Location';
                        AppState.pickup = {
                            lat: latitude,
                            lng: longitude,
                            address: 'Current Location',
                            name: 'Your Location'
                        };
                    }

                    UI.hideLoading();
                    UI.showToast('Location detected successfully', 'success');

                } catch (error) {
                    console.error('Geolocation error:', error);
                    UI.hideLoading();
                    UI.showToast('Unable to get your location', 'warning');
                }
            }

            static async detectCity(latitude, longitude) {
                try {
                    const response = await fetch(
                        `https://nominatim.openstreetmap.org/reverse?lat=${latitude}&lon=${longitude}&format=json&addressdetails=1`
                    );

                    if (response.ok) {
                        const data = await response.json();
                        const address = data.address;
                        
                        // Try to get city from various address components
                        const city = address.city || address.town || address.village || address.municipality;
                        
                        if (city) {
                            AppState.currentCity = city;
                            UI.updateCityDisplay(city);
                            console.log(`City detected: ${city}`);
                        } else {
                            console.warn('Could not detect city from location');
                        }
                    }
                } catch (error) {
                    console.error('Error detecting city:', error);
                }
            }
        }

        // ============================================
        // RIDE TYPE MANAGER
        // ============================================
        class RideTypeManager {
            static init() {
                this.renderRideTypeCards();
                this.setupEventListeners();
            }

            static renderRideTypeCards() {
                const container = document.getElementById('rideTypeCardsContainer');
                if (!container) return;

                const rideTypes = [
                    { id: 'economy', name: 'Economy', icon: 'fa-car-side', price: 'ZMW 0.00' },
                    { id: 'standard', name: 'Standard', icon: 'fa-car', price: 'ZMW 0.00' },
                    { id: 'premium', name: 'Premium', icon: 'fa-crown', price: 'ZMW 0.00' }
                ];

                container.innerHTML = '';

                rideTypes.forEach(type => {
                    const card = document.createElement('div');
                    card.className = `ride-type-card ${type.id === 'standard' ? 'selected' : ''}`;
                    card.dataset.type = type.id;
                    card.innerHTML = `
                        <div class="ride-type-icon">
                            <i class="fas ${type.icon}"></i>
                        </div>
                        <div class="ride-type-name">${type.name}</div>
                        <div class="ride-type-price" id="${type.id}Price">${type.price}</div>
                    `;

                    card.addEventListener('click', () => {
                        this.selectRideType(type.id);
                    });

                    container.appendChild(card);
                });

                // Set initial selected ride type
                AppState.selectedRideType = 'standard';
            }

            static selectRideType(rideType) {
                // Update UI
                document.querySelectorAll('.ride-type-card').forEach(card => {
                    card.classList.remove('selected');
                });
                document.querySelector(`.ride-type-card[data-type="${rideType}"]`).classList.add('selected');

                // Update state
                AppState.selectedRideType = rideType;

                // Update prices if destination is set
                if (AppState.pickup && AppState.destination) {
                    const distance = EnhancedSearchEngine.calculateDistance(
                        AppState.pickup.lat, AppState.pickup.lng,
                        AppState.destination.lat, AppState.destination.lng
                    );
                    UI.updateRidePrices(distance);
                }
            }

            static setupEventListeners() {
                // Add stop button
                const addStopBtn = document.getElementById('addStopBtn');
                if (addStopBtn) {
                    addStopBtn.addEventListener('click', () => {
                        UI.addStop();
                    });
                }
            }
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        async function initializeApp() {
            try {
                console.log('Initializing Jubel Passenger App...');
                UI.showLoading('Initializing app...');

                // Initialize search engine
                EnhancedSearchEngine.init();

                // Initialize ride type manager
                RideTypeManager.init();

                // Check authentication
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        console.log('User authenticated:', user.uid);
                        AppState.currentUser = user;
                        await FirebaseManager.loadUserData(user.uid);
                    } else {
                        console.log('No user logged in, redirecting to signup');
                        window.location.href = 'signup.html';
                    }
                });

                // Initialize map
                initializeMap();

                // Setup event listeners
                setupEventListeners();

                // Get current location
                await LocationManager.getCurrentLocation();

                UI.hideLoading();
                UI.showToast('Jubel Passenger App Ready', 'success');
                console.log('App initialization completed successfully');

            } catch (error) {
                console.error('Error initializing app:', error);
                UI.hideLoading();
                UI.showToast('Error initializing app', 'error');
            }
        }

        function initializeMap() {
            console.log('Initializing map...');
            UI.showMapLoading();

            const defaultLat = -15.4167; // Lusaka coordinates
            const defaultLng = 28.2833;

            map = L.map('map').setView([defaultLat, defaultLng], 13);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: ' OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            L.control.scale().addTo(map);

            UI.hideMapLoading();
            console.log('Map initialized');
        }

        function setupEventListeners() {
            console.log('Setting up event listeners...');

            // Navigation tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const screen = tab.dataset.screen;
                    
                    // Update active tab
                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Show appropriate screen
                    if (screen === 'home') {
                        AppState.activeScreen = 'home';
                        document.getElementById('homeContent').style.display = 'block';
                    }
                    // Note: History, Account, Emergency screens would be implemented here
                });
            });

            // Panel handle
            const panelHandle = document.getElementById('panelHandle');
            if (panelHandle) {
                panelHandle.addEventListener('click', () => {
                    const panel = document.getElementById('mainPanel');
                    panel.classList.toggle('collapsed');
                });
            }

            // Service tabs
            document.querySelectorAll('.service-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const service = tab.dataset.service;
                    
                    // Update active service tab
                    document.querySelectorAll('.service-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    AppState.activeService = service;
                    
                    // Show appropriate form (only car implemented in this example)
                    if (service === 'car') {
                        document.getElementById('carForm').style.display = 'block';
                        document.getElementById('carForm').classList.add('active');
                    }
                });
            });

            // Map controls
            const locateMeBtn = document.getElementById('locateMeBtn');
            if (locateMeBtn) {
                locateMeBtn.addEventListener('click', () => {
                    if (AppState.userLocation) {
                        map.setView([AppState.userLocation.lat, AppState.userLocation.lng], 15);
                        UI.showToast('Centered on your location', 'info');
                    } else {
                        LocationManager.getCurrentLocation();
                    }
                });
            }

            const zoomInBtn = document.getElementById('zoomInBtn');
            if (zoomInBtn) {
                zoomInBtn.addEventListener('click', () => {
                    map.zoomIn();
                });
            }

            const zoomOutBtn = document.getElementById('zoomOutBtn');
            if (zoomOutBtn) {
                zoomOutBtn.addEventListener('click', () => {
                    map.zoomOut();
                });
            }

            const clearRouteBtn = document.getElementById('clearRouteBtn');
            if (clearRouteBtn) {
                clearRouteBtn.addEventListener('click', () => {
                    if (routeLayer) {
                        map.removeLayer(routeLayer);
                        routeLayer = null;
                    }
                    
                    if (destinationMarker) {
                        map.removeLayer(destinationMarker);
                        destinationMarker = null;
                    }
                    
                    document.getElementById('destinationLocation').value = '';
                    AppState.destination = null;
                    
                    UI.showToast('Route cleared', 'info');
                });
            }

            // Destination input search
            const destinationInput = document.getElementById('destinationLocation');
            if (destinationInput) {
                let searchTimeout;
                
                destinationInput.addEventListener('input', (e) => {
                    const query = e.target.value.trim();
                    
                    if (query.length < 2) {
                        const suggestions = document.getElementById('destinationSuggestions');
                        if (suggestions) suggestions.style.display = 'none';
                        return;
                    }
                    
                    clearTimeout(searchTimeout);
                    
                    searchTimeout = setTimeout(async () => {
                        if (!AppState.currentCity) {
                            UI.showToast('Please wait while we detect your city', 'warning');
                            return;
                        }
                        
                        const results = await EnhancedSearchEngine.search(
                            query,
                            'destination',
                            AppState.userLocation,
                            AppState.currentCity
                        );
                        
                        UI.showSearchSuggestions('destinationLocation', results, 'destination');
                    }, 300);
                });

                destinationInput.addEventListener('focus', () => {
                    if (!destinationInput.value.trim()) {
                        UI.showSearchHistory('destinationLocation');
                    }
                });
            }

            // Request Ride button
            const requestRideBtn = document.getElementById('requestRideBtn');
            if (requestRideBtn) {
                requestRideBtn.addEventListener('click', async () => {
                    if (!AppState.pickup || !AppState.destination) {
                        UI.showToast('Please select pickup and destination locations', 'warning');
                        return;
                    }

                    if (!EnhancedSearchEngine.validateCoordinatesInCity(
                        AppState.pickup.lat, AppState.pickup.lng, AppState.currentCity
                    ) || !EnhancedSearchEngine.validateCoordinatesInCity(
                        AppState.destination.lat, AppState.destination.lng, AppState.currentCity
                    )) {
                        UI.showToast('Locations must be within city boundaries', 'warning');
                        return;
                    }

                    const distance = EnhancedSearchEngine.calculateDistance(
                        AppState.pickup.lat, AppState.pickup.lng,
                        AppState.destination.lat, AppState.destination.lng
                    );

                    if (distance < 0.5) {
                        UI.showToast('Minimum ride distance is 0.5 km', 'warning');
                        return;
                    }

                    // Show payment modal
                    showPaymentModal('car', AppState.rideFare);
                });
            }

            // Cancel Ride button
            const cancelRideBtn = document.getElementById('cancelRideBtn');
            if (cancelRideBtn) {
                cancelRideBtn.addEventListener('click', () => {
                    if (AppState.currentRide) {
                        UI.showModal('cancel');
                    } else {
                        UI.showToast('No active ride to cancel', 'warning');
                    }
                });
            }

            // Cancel reasons
            document.querySelectorAll('.cancel-reason[data-reason]').forEach(reason => {
                reason.addEventListener('click', () => {
                    document.querySelectorAll('.cancel-reason').forEach(r => {
                        r.classList.remove('selected');
                    });
                    
                    reason.classList.add('selected');
                    
                    const reasonType = reason.dataset.reason;
                    const otherReasonGroup = document.getElementById('otherReasonGroup');
                    if (otherReasonGroup) {
                        otherReasonGroup.style.display = 
                            reasonType === 'other' ? 'block' : 'none';
                    }
                });
            });

            // Confirm Cancel button
            const confirmCancelBtn = document.getElementById('confirmCancelBtn');
            if (confirmCancelBtn) {
                confirmCancelBtn.addEventListener('click', async () => {
                    const selectedReason = document.querySelector('.cancel-reason.selected');
                    if (!selectedReason) {
                        UI.showToast('Please select a cancellation reason', 'warning');
                        return;
                    }

                    let reason = selectedReason.dataset.reason;
                    if (reason === 'other') {
                        const otherReason = document.getElementById('otherReason')?.value.trim();
                        if (!otherReason) {
                            UI.showToast('Please specify your reason', 'warning');
                            return;
                        }
                        reason = `other: ${otherReason}`;
                    }

                    if (AppState.currentRide) {
                        try {
                            await FirebaseManager.cancelRide(AppState.currentRide.id, reason);
                            UI.hideModal('cancel');
                        } catch (error) {
                            UI.showToast('Error cancelling ride', 'error');
                        }
                    }
                });
            }

            // Payment methods
            document.querySelectorAll('.payment-method').forEach(method => {
                method.addEventListener('click', () => {
                    document.querySelectorAll('.payment-method').forEach(m => {
                        m.classList.remove('selected');
                    });
                    method.classList.add('selected');
                });
            });

            // Apply Referral button
            const applyReferralBtn = document.getElementById('applyReferralBtn');
            if (applyReferralBtn) {
                applyReferralBtn.addEventListener('click', async () => {
                    const referralCodeInput = document.getElementById('referralCodeInput');
                    if (!referralCodeInput) return;

                    const referralCode = referralCodeInput.value.trim();

                    if (!referralCode) {
                        UI.showToast('Please enter a referral code', 'warning');
                        return;
                    }

                    try {
                        const result = await FirebaseManager.validateReferralCode(referralCode);
                        
                        if (result.valid) {
                            AppState.referralDiscountApplied = true;
                            AppState.referralCodeUsed = referralCode;
                            AppState.referralOwnerName = result.ownerName;

                            const discountAmount = AppState.rideFare * 0.5;
                            const newFare = AppState.rideFare - discountAmount;

                            const referralOwnerName = document.getElementById('referrerInfo');
                            const paymentAmount = document.getElementById('paymentAmount');

                            if (referralOwnerName) {
                                referralOwnerName.textContent = `Referred by: ${result.ownerName}`;
                                referralOwnerName.style.display = 'block';
                            }
                            if (paymentAmount) paymentAmount.textContent = `ZMW ${newFare.toFixed(2)}`;

                            UI.showToast(`50% discount applied! Referral from ${result.ownerName}`, 'success');
                        } else {
                            UI.showToast('Invalid referral code', 'error');
                        }
                    } catch (error) {
                        console.error('Error validating referral:', error);
                        UI.showToast('Error validating referral code', 'error');
                    }
                });
            }

            // Confirm Payment button
            const confirmPaymentBtn = document.getElementById('confirmPaymentBtn');
            if (confirmPaymentBtn) {
                confirmPaymentBtn.addEventListener('click', async () => {
                    const selectedMethod = document.querySelector('.payment-method.selected');
                    if (!selectedMethod) {
                        UI.showToast('Please select a payment method', 'warning');
                        return;
                    }

                    const paymentMethod = selectedMethod.dataset.payment;
                    let amount = parseFloat(document.getElementById('paymentAmount').textContent.replace('ZMW ', ''));

                    if (AppState.referralDiscountApplied) {
                        const originalAmount = AppState.rideFare;
                        amount = originalAmount * 0.5;
                    }

                    if (paymentMethod === 'wallet' && AppState.walletBalance < amount) {
                        UI.showToast('Insufficient wallet balance', 'error');
                        return;
                    }

                    const rideData = {
                        pickup: AppState.pickup.address,
                        pickupDisplay: AppState.pickup.name,
                        destination: AppState.destination.address,
                        destinationDisplay: AppState.destination.name,
                        pickupLat: AppState.pickup.lat,
                        pickupLng: AppState.pickup.lng,
                        destLat: AppState.destination.lat,
                        destLng: AppState.destination.lng,
                        rideType: AppState.selectedRideType,
                        fare: amount,
                        distance: EnhancedSearchEngine.calculateDistance(
                            AppState.pickup.lat, AppState.pickup.lng,
                            AppState.destination.lat, AppState.destination.lng
                        ),
                        paymentMethod: paymentMethod,
                        stops: AppState.rideStops
                    };

                    try {
                        if (paymentMethod === 'wallet') {
                            await FirebaseManager.withdrawMoney(amount);
                        }

                        await FirebaseManager.requestRide(rideData);
                        
                        UI.hideModal('payment');
                        AppState.referralDiscountApplied = false;
                        AppState.referralCodeUsed = null;
                        AppState.referralOwnerName = null;

                    } catch (error) {
                        console.error('Error processing payment:', error);
                        UI.showToast('Error processing payment', 'error');
                        
                        if (paymentMethod === 'wallet') {
                            await FirebaseManager.depositMoney(amount, 'refund', 'Payment failed');
                        }
                    }
                });
            }

            // Close modals
            document.querySelectorAll('.modal-close').forEach(btn => {
                btn.addEventListener('click', () => {
                    const modal = btn.dataset.modal;
                    UI.hideModal(modal);
                });
            });

            // Notification bell
            const notificationBell = document.getElementById('notificationBell');
            if (notificationBell) {
                notificationBell.addEventListener('click', () => {
                    const panel = document.getElementById('notificationsPanel');
                    panel.classList.toggle('active');
                });
            }

            const notificationsClose = document.getElementById('notificationsClose');
            if (notificationsClose) {
                notificationsClose.addEventListener('click', () => {
                    const panel = document.getElementById('notificationsPanel');
                    panel.classList.remove('active');
                });
            }

            // SOS button
            const sosButton = document.getElementById('sosButton');
            if (sosButton) {
                sosButton.addEventListener('click', () => {
                    UI.showToast('SOS feature requires setup', 'info');
                });
            }

            console.log('Event listeners setup completed');
        }

        function showPaymentModal(serviceType, amount) {
            // Update payment amount
            document.getElementById('paymentAmount').textContent = `ZMW ${amount.toFixed(2)}`;
            
            // Show modal
            UI.showModal('payment');
            
            // Reset referral discount section
            const referralOwnerName = document.getElementById('referrerInfo');
            if (referralOwnerName) referralOwnerName.style.display = 'none';
            
            const referralCodeInput = document.getElementById('referralCodeInput');
            if (referralCodeInput) referralCodeInput.value = '';
            
            AppState.referralDiscountApplied = false;
            AppState.referralCodeUsed = null;
            AppState.referralOwnerName = null;
        }

        // Start the application
        window.addEventListener('load', initializeApp);
    </script>
</body>
</html>


