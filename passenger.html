<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jubel Passenger App</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
/* ===== BASE STYLES ===== */
:root {
    /* Orange Color Palette */
    --primary-orange: #FF6B35;
    --primary-orange-light: #FF8B5A;
    --primary-orange-dark: #E55A28;
    --orange-gradient: linear-gradient(135deg, #FF6B35 0%, #FF8B5A 100%);
    --orange-gradient-dark: linear-gradient(135deg, #E55A28 0%, #FF6B35 100%);
    
    /* White & Neutral Palette */
    --pure-white: #FFFFFF;
    --off-white: #F9F9F9;
    --light-bg: #FFF9F5;
    --light-gray: #F5F5F7;
    --medium-gray: #E5E5EA;
    --border-color: #F0F0F0;
    
    /* Text Colors */
    --text-dark: #1D1D1F;
    --text-gray: #6E6E73;
    --text-light: #86868B;
    
    /* Status Colors */
    --success: #34C759;
    --warning: #FF9500;
    --error: #FF3B30;
    --info: #007AFF;
    
    /* Shadows & Effects */
    --shadow-xs: 0 1px 2px rgba(255, 107, 53, 0.05);
    --shadow-sm: 0 2px 8px rgba(255, 107, 53, 0.08);
    --shadow-md: 0 4px 16px rgba(255, 107, 53, 0.12);
    --shadow-lg: 0 8px 32px rgba(255, 107, 53, 0.16);
    --shadow-orange: 0 4px 20px rgba(255, 107, 53, 0.2);
    
    /* Border Radius */
    --radius-xs: 6px;
    --radius-sm: 12px;
    --radius-md: 16px;
    --radius-lg: 20px;
    --radius-xl: 24px;
    --radius-circle: 50%;
    
    /* Spacing */
    --space-xs: 4px;
    --space-sm: 8px;
    --space-md: 12px;
    --space-lg: 16px;
    --space-xl: 24px;
    
    /* Transitions */
    --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
    --transition-base: 250ms cubic-bezier(0.4, 0, 0.2, 1);
    --transition-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);
    
    /* Z-index layers */
    --z-map: 1;
    --z-base: 10;
    --z-above: 20;
    --z-modal: 1000;
    --z-toast: 2000;
    --z-loader: 3000;
}

/* ===== RESET & BASE ===== */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
}

html {
    font-size: 15px;
    scroll-behavior: smooth;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    background: var(--light-bg);
    color: var(--text-dark);
    line-height: 1.5;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    overflow-x: hidden;
    height: 100vh;
}

/* ===== LAYOUT COMPONENTS ===== */
#map {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 60vh;
    z-index: var(--z-map);
    background: var(--off-white);
}

/* ===== TOP BAR ===== */
.top-bar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 60px;
    background: var(--pure-white);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border-color);
    z-index: var(--z-modal);
    padding: 0 var(--space-lg);
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: var(--shadow-sm);
}

.logo-container {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.logo-icon {
    width: 36px;
    height: 36px;
    background: var(--orange-gradient);
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--pure-white);
    font-weight: 700;
    font-size: 16px;
    box-shadow: var(--shadow-orange);
}

.logo-text {
    font-size: 18px;
    font-weight: 700;
    color: var(--text-dark);
    letter-spacing: -0.5px;
}

.user-actions {
    display: flex;
    align-items: center;
    gap: var(--space-md);
}

.balance-badge {
    background: var(--pure-white);
    padding: 8px 16px;
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-color);
    box-shadow: var(--shadow-sm);
    display: flex;
    align-items: center;
    gap: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-base);
}

.balance-badge:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
    border-color: var(--primary-orange);
}

.balance-amount {
    color: var(--primary-orange);
    font-weight: 700;
    font-size: 14px;
}

.notification-bell {
    width: 40px;
    height: 40px;
    background: var(--pure-white);
    border-radius: var(--radius-circle);
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid var(--border-color);
    cursor: pointer;
    transition: all var(--transition-base);
    position: relative;
    box-shadow: var(--shadow-sm);
}

.notification-bell:hover {
    transform: scale(1.05);
    box-shadow: var(--shadow-md);
    border-color: var(--primary-orange);
}

.notification-badge {
    position: absolute;
    top: -4px;
    right: -4px;
    width: 18px;
    height: 18px;
    background: var(--error);
    color: var(--pure-white);
    border-radius: var(--radius-circle);
    font-size: 10px;
    font-weight: 700;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid var(--pure-white);
    animation: pulse 2s infinite;
}

/* ===== MAIN PANEL ===== */
.main-panel {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--pure-white);
    border-radius: var(--radius-xl) var(--radius-xl) 0 0;
    box-shadow: var(--shadow-lg);
    z-index: var(--z-modal);
    padding: var(--space-lg);
    max-height: 50vh;
    overflow-y: auto;
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    scrollbar-width: thin;
    scrollbar-color: var(--primary-orange) var(--light-gray);
}

.main-panel::-webkit-scrollbar {
    width: 4px;
}

.main-panel::-webkit-scrollbar-track {
    background: var(--light-gray);
    border-radius: 2px;
}

.main-panel::-webkit-scrollbar-thumb {
    background: var(--primary-orange);
    border-radius: 2px;
}

.main-panel.collapsed {
    transform: translateY(calc(100% - 60px));
}

.panel-handle {
    width: 48px;
    height: 4px;
    background: var(--medium-gray);
    border-radius: 2px;
    margin: 0 auto var(--space-md);
    cursor: pointer;
    transition: all var(--transition-base);
}

.panel-handle:hover {
    background: var(--primary-orange);
    width: 64px;
}

/* ===== NAVIGATION TABS ===== */
.nav-tabs {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--space-sm);
    margin-bottom: var(--space-lg);
    padding: var(--space-sm);
    background: var(--light-bg);
    border-radius: var(--radius-lg);
}

.nav-tab {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    padding: 12px 8px;
    background: transparent;
    border: none;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-base);
    color: var(--text-gray);
    font-size: 12px;
    font-weight: 600;
}

.nav-tab i {
    font-size: 20px;
    transition: all var(--transition-base);
}

.nav-tab.active {
    background: var(--pure-white);
    color: var(--primary-orange);
    box-shadow: var(--shadow-md);
}

.nav-tab.active i {
    color: var(--primary-orange);
    transform: translateY(-2px);
}

.nav-tab:hover:not(.active) {
    background: rgba(255, 107, 53, 0.1);
    color: var(--primary-orange);
}

/* ===== QUICK ACTIONS ===== */
.quick-actions {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-md);
    margin-bottom: var(--space-lg);
}

.quick-action-btn {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-lg);
    background: var(--pure-white);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    cursor: pointer;
    transition: all var(--transition-base);
    text-align: left;
}

.quick-action-btn:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-md);
    border-color: var(--primary-orange);
}

.quick-action-icon {
    width: 48px;
    height: 48px;
    border-radius: var(--radius-md);
    background: linear-gradient(135deg, rgba(255, 107, 53, 0.1) 0%, rgba(255, 139, 90, 0.1) 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary-orange);
    font-size: 20px;
}

.quick-action-text {
    flex: 1;
}

.quick-action-title {
    font-weight: 600;
    font-size: 14px;
    color: var(--text-dark);
    margin-bottom: 4px;
}

.quick-action-desc {
    font-size: 12px;
    color: var(--text-gray);
    line-height: 1.4;
}

/* ===== SERVICE TABS ===== */
.service-tabs {
    display: flex;
    gap: var(--space-md);
    margin-bottom: var(--space-lg);
    overflow-x: auto;
    padding-bottom: var(--space-sm);
    scrollbar-width: none;
}

.service-tabs::-webkit-scrollbar {
    display: none;
}

.service-tab {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    padding: var(--space-lg);
    background: var(--pure-white);
    border: 2px solid var(--border-color);
    border-radius: var(--radius-lg);
    cursor: pointer;
    transition: all var(--transition-base);
    min-width: 120px;
    flex-shrink: 0;
}

.service-tab:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-md);
}

.service-tab.active {
    border-color: var(--primary-orange);
    background: linear-gradient(135deg, rgba(255, 107, 53, 0.05) 0%, rgba(255, 139, 90, 0.05) 100%);
    box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
}

.service-icon {
    width: 56px;
    height: 56px;
    border-radius: var(--radius-circle);
    background: var(--light-bg);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: var(--text-gray);
    transition: all var(--transition-base);
}

.service-tab.active .service-icon {
    background: var(--orange-gradient);
    color: var(--pure-white);
    transform: scale(1.1);
}

.service-name {
    font-weight: 600;
    font-size: 14px;
    color: var(--text-dark);
}

.service-desc {
    font-size: 11px;
    color: var(--text-gray);
    text-align: center;
    line-height: 1.3;
}

/* ===== FORMS & INPUTS ===== */
.ride-request-form {
    background: var(--pure-white);
    border-radius: var(--radius-lg);
    padding: var(--space-xl);
    margin-bottom: var(--space-lg);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
}

.form-title {
    font-size: 16px;
    font-weight: 700;
    margin-bottom: var(--space-lg);
    color: var(--text-dark);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.location-inputs {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
    margin-bottom: var(--space-lg);
}

.location-input {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-lg);
    background: var(--off-white);
    border: 2px solid transparent;
    border-radius: var(--radius-lg);
    transition: all var(--transition-base);
    position: relative;
}

.location-input.active {
    border-color: var(--primary-orange);
    background: var(--pure-white);
    box-shadow: 0 0 0 4px rgba(255, 107, 53, 0.1);
}

.location-input i {
    color: var(--primary-orange);
    font-size: 20px;
    width: 24px;
}

.location-input input {
    flex: 1;
    border: none;
    background: transparent;
    outline: none;
    font-size: 16px;
    color: var(--text-dark);
    font-weight: 500;
}

.location-input input::placeholder {
    color: var(--text-light);
}

.clear-input-btn,
.current-location-btn {
    width: 32px;
    height: 32px;
    border-radius: var(--radius-circle);
    background: var(--pure-white);
    border: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-gray);
    cursor: pointer;
    transition: all var(--transition-fast);
}

.clear-input-btn:hover,
.current-location-btn:hover {
    background: var(--primary-orange);
    color: var(--pure-white);
    border-color: var(--primary-orange);
}

/* ===== SUGGESTIONS ===== */
.suggestion-list {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--pure-white);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    z-index: var(--z-modal);
    max-height: 320px;
    overflow-y: auto;
    display: none;
    margin-top: 4px;
}

.suggestion-list.active {
    display: block;
    animation: fadeIn var(--transition-base);
}

.suggestion-item {
    padding: var(--space-lg);
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: all var(--transition-fast);
    display: flex;
    align-items: flex-start;
    gap: var(--space-md);
}

.suggestion-item:hover {
    background: rgba(255, 107, 53, 0.05);
}

.suggestion-icon {
    color: var(--primary-orange);
    font-size: 16px;
    margin-top: 2px;
}

.suggestion-details {
    flex: 1;
}

.suggestion-name {
    font-weight: 600;
    font-size: 14px;
    color: var(--text-dark);
    margin-bottom: 4px;
}

.suggestion-address {
    font-size: 13px;
    color: var(--text-gray);
    line-height: 1.4;
}

.suggestion-distance {
    font-size: 12px;
    color: var(--text-light);
    margin-top: 4px;
}

/* ===== RIDE TYPE SELECTION ===== */
.ride-type-selection {
    margin: var(--space-xl) 0;
    display: none;
}

.ride-type-selection.active {
    display: block;
    animation: slideUp var(--transition-base);
}

.ride-type-title {
    font-size: 15px;
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: var(--space-lg);
}

.ride-type-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--space-md);
}

.ride-type-card {
    background: var(--pure-white);
    border: 2px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: var(--space-xl) var(--space-md);
    cursor: pointer;
    transition: all var(--transition-base);
    text-align: center;
    position: relative;
}

.ride-type-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-md);
}

.ride-type-card.selected {
    border-color: var(--primary-orange);
    background: linear-gradient(135deg, rgba(255, 107, 53, 0.05) 0%, rgba(255, 139, 90, 0.05) 100%);
    box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
}

.ride-type-icon {
    width: 64px;
    height: 64px;
    border-radius: var(--radius-md);
    background: var(--light-bg);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto var(--space-md);
    font-size: 28px;
    color: var(--text-gray);
    transition: all var(--transition-base);
}

.ride-type-card.selected .ride-type-icon {
    background: var(--orange-gradient);
    color: var(--pure-white);
    transform: scale(1.1);
}

.ride-type-name {
    font-weight: 600;
    font-size: 14px;
    color: var(--text-dark);
    margin-bottom: 8px;
}

.ride-type-price {
    font-size: 20px;
    font-weight: 800;
    color: var(--primary-orange);
    margin-bottom: 4px;
}

.ride-type-eta {
    font-size: 12px;
    color: var(--text-gray);
}

/* ===== FARE DISPLAY ===== */
.fare-display {
    background: var(--orange-gradient);
    color: var(--pure-white);
    padding: var(--space-xl);
    border-radius: var(--radius-lg);
    margin: var(--space-xl) 0;
    text-align: center;
    box-shadow: var(--shadow-md);
    display: none;
}

.fare-display.active {
    display: block;
    animation: slideUp var(--transition-base);
}

.fare-label {
    font-size: 14px;
    opacity: 0.9;
    margin-bottom: 4px;
}

.fare-amount {
    font-size: 48px;
    font-weight: 900;
    margin: var(--space-md) 0;
    letter-spacing: -1px;
}

.fare-details {
    display: flex;
    justify-content: space-between;
    margin-top: var(--space-lg);
    font-size: 13px;
    opacity: 0.9;
    padding-top: var(--space-md);
    border-top: 1px solid rgba(255, 255, 255, 0.2);
}

/* ===== BUTTONS ===== */
.action-buttons {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-md);
    margin-top: var(--space-xl);
}

.btn {
    padding: 18px;
    border: none;
    border-radius: var(--radius-lg);
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    transition: all var(--transition-base);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    letter-spacing: 0.5px;
    text-transform: uppercase;
}

.btn-primary {
    background: var(--orange-gradient);
    color: var(--pure-white);
    box-shadow: var(--shadow-orange);
}

.btn-primary:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 32px rgba(255, 107, 53, 0.3);
}

.btn-secondary {
    background: var(--pure-white);
    color: var(--primary-orange);
    border: 2px solid var(--primary-orange);
}

.btn-secondary:hover {
    background: rgba(255, 107, 53, 0.1);
    transform: translateY(-4px);
    box-shadow: var(--shadow-sm);
}

.btn-danger {
    background: linear-gradient(135deg, #FF3B30 0%, #FF6B35 100%);
    color: var(--pure-white);
    box-shadow: 0 4px 20px rgba(255, 59, 48, 0.2);
}

.btn-danger:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 32px rgba(255, 59, 48, 0.3);
}

/* ===== RIDE INFO PANEL ===== */
.ride-info-panel {
    background: var(--pure-white);
    border-radius: var(--radius-lg);
    padding: var(--space-xl);
    margin-bottom: var(--space-lg);
    box-shadow: var(--shadow-md);
    border: 1px solid var(--border-color);
    display: none;
}

.ride-info-panel.active {
    display: block;
    animation: slideUp var(--transition-base);
}

.driver-info {
    display: flex;
    align-items: center;
    gap: var(--space-lg);
    margin-bottom: var(--space-xl);
    padding-bottom: var(--space-xl);
    border-bottom: 1px solid var(--border-color);
}

.driver-avatar {
    width: 72px;
    height: 72px;
    border-radius: var(--radius-circle);
    background: var(--orange-gradient);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px;
    color: var(--pure-white);
    font-weight: 700;
    box-shadow: var(--shadow-orange);
}

.driver-details {
    flex: 1;
}

.driver-name {
    font-size: 18px;
    font-weight: 700;
    color: var(--text-dark);
    margin-bottom: 6px;
}

.driver-rating {
    display: flex;
    align-items: center;
    gap: 6px;
    color: #FFD700;
    font-weight: 600;
    margin-bottom: 8px;
    font-size: 14px;
}

.driver-vehicle {
    font-size: 14px;
    color: var(--text-gray);
    display: flex;
    align-items: center;
    gap: 8px;
}

.vehicle-image {
    width: 80px;
    height: 80px;
    border-radius: var(--radius-md);
    overflow: hidden;
    background: var(--light-bg);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-left: auto;
}

.trip-details {
    margin-bottom: var(--space-xl);
}

.trip-locations {
    display: flex;
    flex-direction: column;
    gap: var(--space-lg);
}

.location-point {
    display: flex;
    align-items: flex-start;
    gap: var(--space-md);
}

.location-marker {
    width: 36px;
    height: 36px;
    border-radius: var(--radius-circle);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--pure-white);
    font-size: 14px;
    flex-shrink: 0;
}

.location-marker.pickup {
    background: var(--primary-orange);
    box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
}

.location-marker.destination {
    background: var(--primary-orange-dark);
    box-shadow: 0 4px 12px rgba(229, 90, 40, 0.3);
}

.location-text {
    flex: 1;
    padding-top: 4px;
}

.location-label {
    font-size: 12px;
    color: var(--text-light);
    margin-bottom: 4px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.location-address {
    font-size: 16px;
    color: var(--text-dark);
    font-weight: 500;
    line-height: 1.4;
}

/* ===== FARE BREAKDOWN ===== */
.fare-breakdown {
    background: var(--off-white);
    border-radius: var(--radius-lg);
    padding: var(--space-xl);
    margin-bottom: var(--space-xl);
}

.fare-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid var(--border-color);
}

.fare-row:last-child {
    border-bottom: none;
}

.fare-label {
    font-size: 15px;
    color: var(--text-gray);
}

.fare-value {
    font-size: 15px;
    font-weight: 600;
    color: var(--text-dark);
}

.fare-row.total {
    margin-top: 12px;
    padding-top: 16px;
    border-top: 2px solid var(--border-color);
}

.fare-row.total .fare-label {
    font-size: 16px;
    font-weight: 700;
    color: var(--text-dark);
}

.fare-row.total .fare-value {
    font-size: 24px;
    font-weight: 800;
    color: var(--primary-orange);
}

/* ===== CHAT SYSTEM ===== */
.chat-container {
    position: fixed;
    bottom: 240px;
    right: var(--space-lg);
    z-index: var(--z-modal);
    width: 360px;
    max-width: calc(100vw - 48px);
    background: var(--pure-white);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-lg);
    display: none;
    flex-direction: column;
    overflow: hidden;
    border: 1px solid var(--border-color);
}

.chat-container.active {
    display: flex;
    animation: slideUp var(--transition-base);
}

.chat-header {
    background: var(--orange-gradient);
    color: var(--pure-white);
    padding: var(--space-lg);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.chat-title {
    font-weight: 600;
    font-size: 16px;
}

.chat-close {
    background: none;
    border: none;
    color: var(--pure-white);
    font-size: 20px;
    cursor: pointer;
    padding: 4px;
    border-radius: var(--radius-xs);
    transition: all var(--transition-fast);
}

.chat-close:hover {
    background: rgba(255, 255, 255, 0.2);
}

.chat-messages {
    flex: 1;
    padding: var(--space-lg);
    max-height: 320px;
    overflow-y: auto;
    background: var(--off-white);
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
}

.message {
    max-width: 80%;
    padding: 12px 16px;
    border-radius: 20px;
    font-size: 14px;
    line-height: 1.4;
    word-wrap: break-word;
}

.message.sent {
    align-self: flex-end;
    background: var(--orange-gradient);
    color: var(--pure-white);
    border-bottom-right-radius: 4px;
}

.message.received {
    align-self: flex-start;
    background: var(--pure-white);
    color: var(--text-dark);
    border: 1px solid var(--border-color);
    border-bottom-left-radius: 4px;
    box-shadow: var(--shadow-xs);
}

.message-time {
    font-size: 11px;
    color: rgba(255, 255, 255, 0.8);
    margin-top: 4px;
    text-align: right;
}

.message.received .message-time {
    color: var(--text-light);
}

.chat-input-container {
    padding: var(--space-lg);
    background: var(--pure-white);
    border-top: 1px solid var(--border-color);
    display: flex;
    gap: var(--space-md);
}

.chat-input {
    flex: 1;
    padding: 12px 16px;
    border: 2px solid var(--border-color);
    border-radius: var(--radius-lg);
    font-size: 14px;
    outline: none;
    transition: all var(--transition-base);
    background: var(--off-white);
}

.chat-input:focus {
    border-color: var(--primary-orange);
    box-shadow: 0 0 0 4px rgba(255, 107, 53, 0.1);
}

.chat-send-btn {
    width: 48px;
    height: 48px;
    border-radius: var(--radius-circle);
    background: var(--orange-gradient);
    color: var(--pure-white);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-base);
    box-shadow: var(--shadow-orange);
}

.chat-send-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 24px rgba(255, 107, 53, 0.3);
}

.chat-notification {
    position: absolute;
    top: -8px;
    right: -8px;
    width: 20px;
    height: 20px;
    background: var(--error);
    color: var(--pure-white);
    border-radius: var(--radius-circle);
    font-size: 11px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    animation: bounce 1s infinite;
    border: 2px solid var(--pure-white);
}

/* ===== MODAL SYSTEM ===== */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(29, 29, 31, 0.8);
    z-index: var(--z-modal);
    display: none;
    align-items: center;
    justify-content: center;
    padding: var(--space-lg);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
}

.modal-overlay.active {
    display: flex;
    animation: fadeIn var(--transition-base);
}

.modal {
    background: var(--pure-white);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-lg);
    max-width: 480px;
    width: 100%;
    max-height: 85vh;
    overflow-y: auto;
    animation: slideUp var(--transition-base);
}

.modal-header {
    padding: var(--space-xl);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.modal-title {
    font-size: 18px;
    font-weight: 700;
    color: var(--text-dark);
    display: flex;
    align-items: center;
    gap: var(--space-md);
}

.modal-close {
    background: none;
    border: none;
    font-size: 24px;
    color: var(--text-light);
    cursor: pointer;
    padding: 4px;
    border-radius: var(--radius-xs);
    transition: all var(--transition-fast);
}

.modal-close:hover {
    color: var(--primary-orange);
    background: rgba(255, 107, 53, 0.1);
}

.modal-content {
    padding: var(--space-xl);
}

/* ===== SCREENS ===== */
.history-screen,
.account-screen,
.emergency-screen {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--pure-white);
    z-index: var(--z-modal);
    display: none;
    flex-direction: column;
    padding-top: 60px;
}

.history-screen.active,
.account-screen.active,
.emergency-screen.active {
    display: flex;
    animation: slideInRight var(--transition-base);
}

.screen-header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: var(--pure-white);
    padding: var(--space-lg);
    border-bottom: 1px solid var(--border-color);
    z-index: var(--z-above);
    display: flex;
    align-items: center;
    gap: var(--space-lg);
    height: 60px;
}

.back-btn {
    width: 40px;
    height: 40px;
    border-radius: var(--radius-circle);
    background: var(--off-white);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-dark);
    border: none;
    cursor: pointer;
    transition: all var(--transition-base);
}

.back-btn:hover {
    background: var(--primary-orange);
    color: var(--pure-white);
    transform: translateX(-2px);
}

.screen-title {
    font-size: 18px;
    font-weight: 700;
    color: var(--text-dark);
}

/* ===== HISTORY ===== */
.history-filters {
    padding: var(--space-lg);
    background: var(--off-white);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    gap: var(--space-md);
    overflow-x: auto;
    scrollbar-width: none;
}

.history-filters::-webkit-scrollbar {
    display: none;
}

.filter-btn {
    padding: 10px 20px;
    background: var(--pure-white);
    border: 2px solid var(--border-color);
    border-radius: var(--radius-lg);
    font-size: 14px;
    font-weight: 600;
    color: var(--text-gray);
    cursor: pointer;
    white-space: nowrap;
    transition: all var(--transition-base);
}

.filter-btn.active {
    background: var(--orange-gradient);
    color: var(--pure-white);
    border-color: transparent;
    box-shadow: var(--shadow-orange);
}

.filter-btn:hover:not(.active) {
    border-color: var(--primary-orange);
    color: var(--primary-orange);
}

.history-list {
    flex: 1;
    overflow-y: auto;
    padding: var(--space-lg);
}

.history-item {
    background: var(--pure-white);
    border-radius: var(--radius-lg);
    padding: var(--space-xl);
    margin-bottom: var(--space-md);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
    cursor: pointer;
    transition: all var(--transition-base);
}

.history-item:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-md);
    border-color: var(--primary-orange);
}

.history-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--space-lg);
}

.history-type {
    display: flex;
    align-items: center;
    gap: var(--space-md);
}

.history-icon {
    width: 40px;
    height: 40px;
    border-radius: var(--radius-md);
    background: linear-gradient(135deg, rgba(255, 107, 53, 0.1) 0%, rgba(255, 139, 90, 0.1) 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary-orange);
    font-size: 18px;
}

.history-type-name {
    font-weight: 600;
    font-size: 15px;
    color: var(--text-dark);
}

.history-date {
    font-size: 13px;
    color: var(--text-gray);
}

.history-status {
    padding: 6px 16px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.status-completed {
    background: rgba(52, 199, 89, 0.1);
    color: var(--success);
}

.status-cancelled {
    background: rgba(255, 59, 48, 0.1);
    color: var(--error);
}

.status-ongoing {
    background: rgba(0, 122, 255, 0.1);
    color: var(--info);
}

.history-locations {
    margin-bottom: var(--space-lg);
}

.history-location {
    display: flex;
    align-items: flex-start;
    gap: var(--space-sm);
    margin-bottom: 8px;
}

.history-location i {
    color: var(--primary-orange);
    margin-top: 4px;
}

.history-location-text {
    font-size: 14px;
    color: var(--text-gray);
    line-height: 1.4;
}

.history-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: var(--space-lg);
    padding-top: var(--space-lg);
    border-top: 1px solid var(--border-color);
}

.history-price {
    font-size: 18px;
    font-weight: 800;
    color: var(--primary-orange);
}

.history-driver {
    font-size: 13px;
    color: var(--text-gray);
}

/* ===== ACCOUNT SCREEN ===== */
.account-header {
    padding: var(--space-xl);
    background: var(--orange-gradient);
    color: var(--pure-white);
    text-align: center;
}

.account-avatar {
    width: 96px;
    height: 96px;
    border-radius: var(--radius-circle);
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 36px;
    margin: 0 auto var(--space-lg);
    border: 4px solid rgba(255, 255, 255, 0.3);
}

.account-name {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 4px;
}

.account-phone {
    font-size: 15px;
    opacity: 0.9;
}

.account-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--space-md);
    padding: var(--space-lg);
    background: var(--pure-white);
}

.stat-card {
    background: var(--off-white);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    text-align: center;
    border: 1px solid var(--border-color);
}

.stat-value {
    font-size: 24px;
    font-weight: 800;
    color: var(--primary-orange);
    margin-bottom: 4px;
}

.stat-label {
    font-size: 12px;
    color: var(--text-gray);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.account-section {
    padding: var(--space-lg);
    border-bottom: 1px solid var(--border-color);
}

.section-title {
    font-size: 16px;
    font-weight: 700;
    color: var(--text-dark);
    margin-bottom: var(--space-lg);
    display: flex;
    align-items: center;
    gap: var(--space-md);
}

.wallet-balance {
    background: var(--orange-gradient);
    color: var(--pure-white);
    padding: var(--space-xl);
    border-radius: var(--radius-lg);
    text-align: center;
    margin-bottom: var(--space-lg);
    box-shadow: var(--shadow-orange);
}

.balance-label {
    font-size: 14px;
    opacity: 0.9;
    margin-bottom: 8px;
}

.balance-amount-large {
    font-size: 48px;
    font-weight: 900;
    margin-bottom: 4px;
    letter-spacing: -1px;
}

.wallet-actions {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-md);
    margin-top: var(--space-lg);
}

.btn-wallet {
    padding: var(--space-lg);
    border: 2px solid var(--primary-orange);
    background: var(--pure-white);
    color: var(--primary-orange);
    border-radius: var(--radius-lg);
    font-weight: 700;
    font-size: 14px;
    cursor: pointer;
    transition: all var(--transition-base);
}

.btn-wallet:hover {
    background: var(--primary-orange);
    color: var(--pure-white);
    transform: translateY(-2px);
    box-shadow: var(--shadow-orange);
}

/* ===== EMERGENCY SERVICES ===== */
.emergency-services {
    padding: var(--space-lg);
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-md);
}

.emergency-service {
    background: var(--pure-white);
    border: 2px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: var(--space-xl);
    text-align: center;
    cursor: pointer;
    transition: all var(--transition-base);
}

.emergency-service:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-md);
    border-color: var(--primary-orange);
}

.emergency-icon {
    width: 64px;
    height: 64px;
    border-radius: var(--radius-circle);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    margin: 0 auto var(--space-md);
    color: var(--pure-white);
    background: var(--orange-gradient);
    box-shadow: var(--shadow-orange);
}

.emergency-name {
    font-size: 16px;
    font-weight: 700;
    color: var(--text-dark);
    margin-bottom: 8px;
}

.emergency-description {
    font-size: 13px;
    color: var(--text-gray);
    line-height: 1.4;
}

/* ===== LOADING STATES ===== */
.loading {
    display: inline-block;
    width: 24px;
    height: 24px;
    border: 3px solid rgba(255, 107, 53, 0.1);
    border-radius: var(--radius-circle);
    border-top-color: var(--primary-orange);
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.95);
    z-index: var(--z-loader);
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: var(--space-lg);
    backdrop-filter: blur(8px);
}

.loading-overlay.active {
    display: flex;
}

.loading-spinner {
    width: 64px;
    height: 64px;
    border: 4px solid rgba(255, 107, 53, 0.1);
    border-radius: var(--radius-circle);
    border-top-color: var(--primary-orange);
    animation: spin 1s linear infinite;
}

.loading-text {
    font-size: 16px;
    font-weight: 600;
    color: var(--text-dark);
}

/* ===== TOAST NOTIFICATIONS ===== */
.toast-container {
    position: fixed;
    top: 80px;
    right: var(--space-lg);
    z-index: var(--z-toast);
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
    max-width: 380px;
}

.toast {
    background: var(--pure-white);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    box-shadow: var(--shadow-lg);
    border-left: 4px solid var(--primary-orange);
    display: flex;
    align-items: flex-start;
    gap: var(--space-md);
    animation: slideInRight var(--transition-base);
    transform: translateX(0);
    transition: transform var(--transition-base);
}

.toast.hiding {
    transform: translateX(100%);
}

.toast-icon {
    width: 24px;
    height: 24px;
    border-radius: var(--radius-circle);
    background: linear-gradient(135deg, rgba(255, 107, 53, 0.1) 0%, rgba(255, 139, 90, 0.1) 100%);
    color: var(--primary-orange);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.toast-content {
    flex: 1;
}

.toast-title {
    font-weight: 700;
    font-size: 15px;
    color: var(--text-dark);
    margin-bottom: 4px;
}

.toast-message {
    font-size: 13px;
    color: var(--text-gray);
    line-height: 1.4;
}

.toast-close {
    background: none;
    border: none;
    color: var(--text-light);
    font-size: 18px;
    cursor: pointer;
    padding: 2px;
    border-radius: var(--radius-xs);
    transition: all var(--transition-fast);
}

.toast-close:hover {
    color: var(--primary-orange);
    background: rgba(255, 107, 53, 0.1);
}

.toast.success {
    border-left-color: var(--success);
}

.toast.success .toast-icon {
    color: var(--success);
    background: rgba(52, 199, 89, 0.1);
}

.toast.error {
    border-left-color: var(--error);
}

.toast.error .toast-icon {
    color: var(--error);
    background: rgba(255, 59, 48, 0.1);
}

.toast.warning {
    border-left-color: var(--warning);
}

.toast.warning .toast-icon {
    color: var(--warning);
    background: rgba(255, 149, 0, 0.1);
}

/* ===== RESPONSIVE DESIGN ===== */
@media (max-width: 768px) {
    html {
        font-size: 14px;
    }
    
    .top-bar {
        padding: 0 var(--space-md);
        height: 56px;
    }
    
    .main-panel {
        padding: var(--space-md);
        max-height: 45vh;
    }
    
    .quick-actions {
        grid-template-columns: 1fr;
    }
    
    .ride-type-grid {
        grid-template-columns: 1fr;
    }
    
    .emergency-services {
        grid-template-columns: 1fr;
    }
    
    .chat-container {
        width: calc(100vw - 32px);
        right: var(--space-md);
        bottom: 200px;
    }
    
    .modal {
        max-width: 90vw;
    }
    
    .account-stats {
        grid-template-columns: 1fr;
    }
    
    .wallet-actions {
        grid-template-columns: 1fr;
    }
    
    .service-tab {
        min-width: 100px;
        padding: var(--space-md);
    }
}

@media (max-width: 480px) {
    .nav-tabs {
        gap: var(--space-xs);
    }
    
    .nav-tab {
        padding: 8px 4px;
        font-size: 11px;
    }
    
    .nav-tab i {
        font-size: 18px;
    }
    
    .balance-badge {
        padding: 6px 12px;
        font-size: 13px;
    }
    
    .logo-text {
        font-size: 16px;
    }
    
    .logo-icon {
        width: 32px;
        height: 32px;
        font-size: 14px;
    }
    
    .notification-bell {
        width: 36px;
        height: 36px;
    }
    
    .service-tab {
        min-width: 90px;
        padding: 12px 8px;
    }
    
    .service-icon {
        width: 48px;
        height: 48px;
        font-size: 20px;
    }
    
    .fare-amount {
        font-size: 36px;
    }
    
    .balance-amount-large {
        font-size: 36px;
    }
    
    .account-avatar {
        width: 80px;
        height: 80px;
        font-size: 28px;
    }
}

/* ===== CUSTOM MARKERS ===== */
.pickup-marker {
    width: 24px;
    height: 24px;
    background: var(--primary-orange);
    border-radius: var(--radius-circle);
    border: 3px solid var(--pure-white);
    box-shadow: var(--shadow-md);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--pure-white);
    font-size: 12px;
}

.destination-marker {
    width: 24px;
    height: 24px;
    background: var(--primary-orange-dark);
    border-radius: var(--radius-circle);
    border: 3px solid var(--pure-white);
    box-shadow: var(--shadow-md);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--pure-white);
    font-size: 12px;
}

.driver-marker {
    width: 40px;
    height: 40px;
    background: var(--orange-gradient);
    border-radius: var(--radius-circle);
    border: 3px solid var(--pure-white);
    box-shadow: var(--shadow-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--pure-white);
    font-size: 16px;
    font-weight: 700;
    animation: pulse 2s infinite;
}

/* ===== ANIMATIONS ===== */
@keyframes fadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes slideInRight {
    from {
        opacity: 0;
        transform: translateX(100%);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

@keyframes pulse {
    0% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(255, 107, 53, 0.4);
    }
    70% {
        transform: scale(1.05);
        box-shadow: 0 0 0 10px rgba(255, 107, 53, 0);
    }
    100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(255, 107, 53, 0);
    }
}

@keyframes bounce {
    0%, 100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.2);
    }
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* ===== ENHANCED FORM ELEMENTS ===== */
.form-group {
    margin-bottom: var(--space-lg);
}

.form-label {
    display: block;
    margin-bottom: var(--space-sm);
    font-weight: 600;
    font-size: 14px;
    color: var(--text-dark);
}

.form-control {
    width: 100%;
    padding: 14px 16px;
    border: 2px solid var(--border-color);
    border-radius: var(--radius-lg);
    font-size: 15px;
    color: var(--text-dark);
    background: var(--pure-white);
    transition: all var(--transition-base);
}

.form-control:focus {
    outline: none;
    border-color: var(--primary-orange);
    box-shadow: 0 0 0 4px rgba(255, 107, 53, 0.1);
}

.form-textarea {
    min-height: 100px;
    resize: vertical;
}

/* ===== SEARCH LOADING ===== */
.search-loading {
    display: none;
    position: absolute;
    top: 50%;
    right: 16px;
    transform: translateY(-50%);
    width: 20px;
    height: 20px;
    border: 2px solid var(--light-gray);
    border-radius: var(--radius-circle);
    border-top-color: var(--primary-orange);
    animation: spin 0.8s linear infinite;
}

.location-input.searching .search-loading {
    display: block;
}

/* ===== PRICE CALCULATION ===== */
.price-calculation {
    background: var(--off-white);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    margin: var(--space-lg) 0;
    font-size: 14px;
    color: var(--text-gray);
}

.calculation-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
}

.calculation-row:last-child {
    margin-bottom: 0;
    padding-top: 8px;
    border-top: 1px solid var(--border-color);
    font-weight: 700;
    color: var(--text-dark);
}

/* ===== PAYMENT METHODS ===== */
.payment-methods {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-md);
    margin: var(--space-lg) 0;
}

.payment-method {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-lg);
    border: 2px solid var(--border-color);
    border-radius: var(--radius-lg);
    cursor: pointer;
    transition: all var(--transition-base);
    background: var(--pure-white);
}

.payment-method:hover {
    border-color: var(--primary-orange);
    background: rgba(255, 107, 53, 0.05);
}

.payment-method.selected {
    border-color: var(--primary-orange);
    background: rgba(255, 107, 53, 0.1);
    box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
}

.payment-icon {
    width: 48px;
    height: 48px;
    border-radius: var(--radius-md);
    background: var(--light-bg);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-gray);
    transition: all var(--transition-base);
}

.payment-method.selected .payment-icon {
    background: var(--orange-gradient);
    color: var(--pure-white);
}

.payment-details {
    flex: 1;
}

.payment-name {
    font-weight: 600;
    font-size: 15px;
    color: var(--text-dark);
}

.payment-info {
    font-size: 13px;
    color: var(--text-gray);
    margin-top: 4px;
}

/* ===== WALLET SECTION ===== */
.wallet-section {
    background: var(--pure-white);
    border-radius: var(--radius-lg);
    padding: var(--space-xl);
    margin-bottom: var(--space-lg);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
}

.wallet-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-lg);
}

.wallet-actions-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-md);
    margin-bottom: var(--space-lg);
}

.wallet-action-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: var(--space-lg);
    background: var(--off-white);
    border: 2px solid var(--border-color);
    border-radius: var(--radius-lg);
    cursor: pointer;
    transition: all var(--transition-base);
    text-align: center;
}

.wallet-action-btn:hover {
    background: rgba(255, 107, 53, 0.1);
    border-color: var(--primary-orange);
    transform: translateY(-4px);
    box-shadow: var(--shadow-sm);
}

.wallet-action-btn .icon {
    font-size: 28px;
    margin-bottom: var(--space-sm);
    color: var(--primary-orange);
}

.wallet-action-btn .text {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-dark);
}

.transaction-list {
    max-height: 400px;
    overflow-y: auto;
    margin-top: var(--space-lg);
}

.transaction-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-lg);
    border-bottom: 1px solid var(--border-color);
    background: var(--pure-white);
    transition: all var(--transition-fast);
}

.transaction-item:hover {
    background: var(--off-white);
}

.transaction-item:last-child {
    border-bottom: none;
}

.transaction-icon {
    width: 48px;
    height: 48px;
    border-radius: var(--radius-circle);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: var(--space-md);
    font-size: 20px;
}

.transaction-icon.deposit {
    background: rgba(52, 199, 89, 0.1);
    color: var(--success);
}

.transaction-icon.withdrawal {
    background: rgba(255, 59, 48, 0.1);
    color: var(--error);
}

.transaction-icon.payment {
    background: rgba(255, 149, 0, 0.1);
    color: var(--warning);
}

.transaction-icon.refund {
    background: rgba(0, 122, 255, 0.1);
    color: var(--info);
}

.transaction-details {
    flex: 1;
}

.transaction-title {
    font-weight: 600;
    margin-bottom: 4px;
    color: var(--text-dark);
}

.transaction-meta {
    font-size: 13px;
    color: var(--text-gray);
}

.transaction-amount {
    font-weight: 700;
    font-size: 18px;
    text-align: right;
}

.transaction-amount.positive {
    color: var(--success);
}

.transaction-amount.negative {
    color: var(--error);
}

.transaction-amount.neutral {
    color: var(--text-gray);
}

.transaction-status {
    font-size: 12px;
    padding: 4px 12px;
    border-radius: 20px;
    margin-top: 6px;
    display: inline-block;
    font-weight: 600;
}

.transaction-status.success {
    background: rgba(52, 199, 89, 0.1);
    color: var(--success);
}

.transaction-status.pending {
    background: rgba(255, 149, 0, 0.1);
    color: var(--warning);
}

.transaction-status.failed {
    background: rgba(255, 59, 48, 0.1);
    color: var(--error);
}

.amount-input-group {
    margin-bottom: var(--space-lg);
}

.amount-input-group input {
    width: 100%;
    padding: var(--space-lg);
    border: 2px solid var(--border-color);
    border-radius: var(--radius-lg);
    font-size: 18px;
    text-align: center;
    font-weight: 700;
    color: var(--text-dark);
    background: var(--pure-white);
}

.amount-input-group input:focus {
    border-color: var(--primary-orange);
    outline: none;
    box-shadow: 0 0 0 4px rgba(255, 107, 53, 0.1);
}

.quick-amounts {
    display: flex;
    gap: var(--space-sm);
    margin-top: var(--space-md);
    flex-wrap: wrap;
}

.quick-amount {
    flex: 1;
    min-width: 80px;
    padding: 12px;
    background: var(--off-white);
    border: 2px solid var(--border-color);
    border-radius: var(--radius-md);
    text-align: center;
    cursor: pointer;
    font-weight: 700;
    color: var(--text-gray);
    transition: all var(--transition-base);
}

.quick-amount:hover {
    background: var(--light-bg);
    border-color: var(--primary-orange-light);
}

.quick-amount.active {
    background: var(--orange-gradient);
    color: var(--pure-white);
    border-color: var(--primary-orange);
    box-shadow: var(--shadow-orange);
}

/* ===== ENHANCED LOCATION STYLING ===== */
.location-input {
    position: relative;
    border: 2px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: 14px 16px;
    background: var(--pure-white);
    transition: all var(--transition-base);
    margin-bottom: var(--space-md);
}

.location-input.active {
    border-color: var(--primary-orange);
    box-shadow: 0 0 0 4px rgba(255, 107, 53, 0.1);
}

.location-input i {
    color: var(--primary-orange);
    margin-right: var(--space-md);
    font-size: 20px;
    flex-shrink: 0;
}

.location-input input {
    border: none;
    outline: none;
    width: 100%;
    font-size: 16px;
    color: var(--text-dark);
    background: transparent;
    padding-right: 40px;
}

.location-input input::placeholder {
    color: var(--text-light);
}

.clear-input-btn,
.current-location-btn {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    width: 32px;
    height: 32px;
    border-radius: var(--radius-circle);
    background: var(--pure-white);
    border: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-gray);
    cursor: pointer;
    transition: all var(--transition-fast);
    z-index: var(--z-base);
}

.current-location-btn {
    right: 52px;
}

.clear-input-btn:hover,
.current-location-btn:hover {
    background: var(--primary-orange);
    color: var(--pure-white);
    border-color: var(--primary-orange);
}

/* ===== SUGGESTIONS CONTAINER ===== */
.suggestions-container {
    position: absolute;
    background: var(--pure-white);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    z-index: var(--z-modal);
    max-height: 400px;
    overflow-y: auto;
    margin-top: 4px;
    width: 100%;
}

.suggestion-item {
    padding: var(--space-md) var(--space-lg);
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: all var(--transition-fast);
    display: flex;
    align-items: flex-start;
    gap: var(--space-md);
}

.suggestion-item:hover {
    background: rgba(255, 107, 53, 0.05);
}

.suggestion-item i {
    color: var(--primary-orange);
    font-size: 18px;
    margin-top: 2px;
    flex-shrink: 0;
}

.suggestion-item .suggestion-details {
    flex: 1;
}

.suggestion-item .suggestion-name {
    font-weight: 600;
    margin-bottom: 4px;
    color: var(--text-dark);
    font-size: 15px;
}

.suggestion-item .suggestion-address {
    font-size: 13px;
    color: var(--text-gray);
    margin-bottom: 4px;
    line-height: 1.4;
}

.suggestion-item .suggestion-distance {
    font-size: 12px;
    color: var(--primary-orange);
    font-weight: 600;
}

/* ===== LOCATION ACCURACY ===== */
.location-accuracy {
    font-size: 12px;
    color: var(--text-gray);
    margin-top: 4px;
    display: flex;
    align-items: center;
    gap: var(--space-xs);
}

.location-accuracy.high {
    color: var(--success);
}

.location-accuracy.medium {
    color: var(--warning);
}

.location-accuracy.low {
    color: var(--error);
}

/* ===== CITY DETECTION ===== */
.city-detection {
    position: fixed;
    top: 70px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--pure-white);
    padding: 10px 24px;
    border-radius: 24px;
    box-shadow: var(--shadow-md);
    display: flex;
    align-items: center;
    gap: var(--space-md);
    z-index: var(--z-modal);
    animation: slideDown var(--transition-base);
    border: 1px solid var(--border-color);
}

.city-detection i {
    color: var(--primary-orange);
    font-size: 16px;
}

.pulsing-dot {
    position: absolute;
    width: 20px;
    height: 20px;
    background: var(--primary-orange);
    border-radius: var(--radius-circle);
    animation: pulse 1.5s infinite;
}

/* ===== SCHEDULE COUNTDOWN ===== */
#scheduleCountdown {
    animation: slideUp var(--transition-base);
    background: var(--orange-gradient);
    color: var(--pure-white);
    padding: var(--space-lg);
    border-radius: var(--radius-lg);
    margin: var(--space-md) 0;
    text-align: center;
    box-shadow: var(--shadow-orange);
}

#countdownTimer {
    font-family: 'SF Mono', 'Courier New', monospace;
    letter-spacing: 2px;
    font-size: 24px;
    font-weight: 700;
    margin: var(--space-sm) 0;
}

/* ===== ENHANCED BROADCAST ===== */
.broadcast-section {
    background: var(--pure-white);
    border-radius: var(--radius-lg);
    padding: var(--space-xl);
    margin: var(--space-lg) 0;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
}

.broadcast-form {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
}

.broadcast-input-group {
    display: flex;
    gap: var(--space-md);
}

.broadcast-input-group input {
    flex: 1;
    padding: 12px 16px;
    border: 2px solid var(--border-color);
    border-radius: var(--radius-lg);
    font-size: 14px;
    background: var(--pure-white);
}

.broadcast-btn {
    padding: 12px 24px;
    background: var(--orange-gradient);
    color: var(--pure-white);
    border: none;
    border-radius: var(--radius-lg);
    font-weight: 700;
    cursor: pointer;
    transition: all var(--transition-base);
    box-shadow: var(--shadow-orange);
}

.broadcast-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 24px rgba(255, 107, 53, 0.3);
}

.broadcast-list {
    margin-top: var(--space-lg);
    max-height: 200px;
    overflow-y: auto;
}

.broadcast-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-md) var(--space-lg);
    border-bottom: 1px solid var(--border-color);
    background: var(--pure-white);
}

.broadcast-item:last-child {
    border-bottom: none;
}

.broadcast-name {
    font-weight: 600;
    font-size: 14px;
    color: var(--text-dark);
}

.broadcast-status {
    font-size: 12px;
    padding: 4px 12px;
    border-radius: 12px;
    font-weight: 600;
}

.broadcast-status.pending {
    background: rgba(255, 149, 0, 0.1);
    color: var(--warning);
}

.broadcast-status.accepted {
    background: rgba(52, 199, 89, 0.1);
    color: var(--success);
}

/* ===== DRIVER MEDIA ===== */
.driver-media {
    display: flex;
    gap: var(--space-md);
    margin-top: var(--space-lg);
}

.media-container {
    flex: 1;
    border-radius: var(--radius-lg);
    overflow: hidden;
    background: var(--off-white);
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 120px;
}

.media-container img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.media-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: var(--text-light);
    font-size: 14px;
}

.media-placeholder i {
    font-size: 32px;
    margin-bottom: var(--space-sm);
    color: var(--primary-orange);
}

/* ===== ENHANCED NOTIFICATIONS PANEL ===== */
.notifications-panel {
    position: fixed;
    top: 70px;
    right: var(--space-lg);
    z-index: var(--z-modal);
    width: 380px;
    max-width: calc(100vw - 48px);
    background: var(--pure-white);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-lg);
    display: none;
    flex-direction: column;
    overflow: hidden;
    border: 1px solid var(--border-color);
}

.notifications-panel.active {
    display: flex;
    animation: slideDown var(--transition-base);
}

.notifications-header {
    background: var(--orange-gradient);
    color: var(--pure-white);
    padding: var(--space-lg);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.notifications-title {
    font-weight: 700;
    font-size: 16px;
}

.notifications-close {
    background: none;
    border: none;
    color: var(--pure-white);
    font-size: 20px;
    cursor: pointer;
    padding: 4px;
    border-radius: var(--radius-xs);
    transition: all var(--transition-fast);
}

.notifications-close:hover {
    background: rgba(255, 255, 255, 0.2);
}

.notifications-list {
    flex: 1;
    max-height: 400px;
    overflow-y: auto;
    background: var(--off-white);
}

.notification-item {
    padding: var(--space-lg);
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: all var(--transition-fast);
    background: var(--pure-white);
}

.notification-item:hover {
    background: var(--off-white);
}

.notification-item.unread {
    background: rgba(255, 107, 53, 0.05);
}

.notification-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.notification-title {
    font-weight: 700;
    font-size: 14px;
    color: var(--text-dark);
    display: flex;
    align-items: center;
    gap: 8px;
}

.notification-time {
    font-size: 12px;
    color: var(--text-gray);
}

.notification-message {
    font-size: 13px;
    color: var(--text-gray);
    line-height: 1.4;
}

.notification-actions {
    margin-top: var(--space-md);
    display: flex;
    gap: var(--space-sm);
}

.notification-action-btn {
    padding: 6px 12px;
    font-size: 12px;
    border-radius: 16px;
    border: 1px solid var(--border-color);
    background: var(--pure-white);
    cursor: pointer;
    transition: all var(--transition-fast);
    font-weight: 600;
}

.notification-action-btn:hover {
    background: var(--primary-orange);
    color: var(--pure-white);
    border-color: var(--primary-orange);
}

/* ===== DROPDOWN MENUS ===== */
.dropdown-menu {
    position: absolute;
    top: 70px;
    right: var(--space-lg);
    z-index: var(--z-modal);
    width: 240px;
    background: var(--pure-white);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    display: none;
    flex-direction: column;
    overflow: hidden;
    border: 1px solid var(--border-color);
}

.dropdown-menu.active {
    display: flex;
    animation: slideDown var(--transition-base);
}

.dropdown-item {
    padding: var(--space-lg);
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: all var(--transition-fast);
    display: flex;
    align-items: center;
    gap: var(--space-md);
    font-size: 14px;
    color: var(--text-dark);
    background: var(--pure-white);
}

.dropdown-item:hover {
    background: rgba(255, 107, 53, 0.05);
    color: var(--primary-orange);
}

.dropdown-item:last-child {
    border-bottom: none;
}

.dropdown-item i {
    width: 20px;
    text-align: center;
    color: var(--primary-orange);
}

/* ===== RIDE STATUS BAR ===== */
.ride-status-bar {
    position: fixed;
    top: 70px;
    left: 50%;
    transform: translateX(-50%);
    z-index: var(--z-modal);
    display: none;
    background: var(--pure-white);
    padding: var(--space-md) var(--space-xl);
    border-radius: 24px;
    box-shadow: var(--shadow-lg);
    border: 1px solid var(--border-color);
    align-items: center;
    gap: var(--space-md);
    min-width: 320px;
    max-width: 90%;
}

.ride-status-bar.active {
    display: flex;
    animation: slideDown var(--transition-base);
}

.status-indicator {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.status-dot {
    width: 12px;
    height: 12px;
    border-radius: var(--radius-circle);
    background: var(--warning);
    animation: pulse 1.5s infinite;
}

.status-dot.searching {
    background: var(--warning);
}

.status-dot.arriving {
    background: var(--info);
}

.status-dot.riding {
    background: var(--success);
    animation: none;
}

.status-text {
    font-weight: 700;
    font-size: 14px;
    color: var(--text-dark);
}

.status-eta {
    margin-left: auto;
    display: flex;
    align-items: center;
    gap: 6px;
    color: var(--text-gray);
    font-size: 13px;
    font-weight: 600;
}

/* ===== SOS BUTTON ===== */
.sos-button {
    position: fixed;
    bottom: 180px;
    right: var(--space-lg);
    z-index: var(--z-modal);
    width: 64px;
    height: 64px;
    background: linear-gradient(135deg, #FF3B30 0%, #FF6B35 100%);
    border-radius: var(--radius-circle);
    display: none;
    align-items: center;
    justify-content: center;
    color: var(--pure-white);
    font-size: 16px;
    font-weight: 700;
    box-shadow: 0 8px 32px rgba(255, 59, 48, 0.3);
    cursor: pointer;
    transition: all var(--transition-base);
    animation: pulse 2s infinite;
    border: 3px solid var(--pure-white);
}

.sos-button:hover {
    transform: scale(1.1);
    box-shadow: 0 12px 40px rgba(255, 59, 48, 0.4);
}

/* ===== EMERGENCY STATUS ===== */
.emergency-status {
    position: fixed;
    top: 70px;
    right: var(--space-lg);
    z-index: var(--z-modal);
    background: linear-gradient(135deg, #FF3B30 0%, #FF6B35 100%);
    color: var(--pure-white);
    padding: var(--space-md) var(--space-lg);
    border-radius: 24px;
    box-shadow: var(--shadow-lg);
    display: none;
    align-items: center;
    gap: 8px;
    font-weight: 700;
    font-size: 14px;
    animation: emergencyPulse 1s infinite;
    border: 2px solid var(--pure-white);
}

@keyframes emergencyPulse {
    0% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(255, 59, 48, 0.4);
    }
    70% {
        transform: scale(1.02);
        box-shadow: 0 0 0 10px rgba(255, 59, 48, 0);
    }
    100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(255, 59, 48, 0);
    }
}

/* ===== REAL-TIME INDICATORS ===== */
.real-time-indicator {
    position: fixed;
    bottom: var(--space-lg);
    right: var(--space-lg);
    z-index: var(--z-modal);
    background: var(--success);
    color: var(--pure-white);
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 700;
    display: none;
    align-items: center;
    gap: 6px;
    box-shadow: var(--shadow-md);
    border: 2px solid var(--pure-white);
}

.real-time-indicator.active {
    display: flex;
    animation: fadeIn var(--transition-base);
}

.sync-indicator {
    position: fixed;
    bottom: var(--space-lg);
    left: var(--space-lg);
    z-index: var(--z-modal);
    background: var(--info);
    color: var(--pure-white);
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 700;
    display: none;
    align-items: center;
    gap: 6px;
    box-shadow: var(--shadow-md);
    border: 2px solid var(--pure-white);
}

.sync-indicator.active {
    display: flex;
    animation: fadeIn var(--transition-base);
}

.sync-indicator.syncing .sync-icon {
    animation: spin 1s linear infinite;
}

/* ===== ENHANCED SEARCH ===== */
.search-bar-container {
    position: relative;
    margin-bottom: var(--space-lg);
}

.search-bar {
    width: 100%;
    padding: 14px 16px 14px 48px;
    border: 2px solid var(--border-color);
    border-radius: var(--radius-lg);
    font-size: 15px;
    transition: all var(--transition-base);
    background: var(--pure-white);
}

.search-bar:focus {
    border-color: var(--primary-orange);
    box-shadow: 0 0 0 4px rgba(255, 107, 53, 0.1);
    outline: none;
}

.search-bar-icon {
    position: absolute;
    left: 16px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-light);
}

/* ===== PRICE CALCULATOR ===== */
.price-calculator-display {
    background: var(--orange-gradient);
    color: var(--pure-white);
    padding: var(--space-xl);
    border-radius: var(--radius-lg);
    margin: var(--space-lg) 0;
    box-shadow: var(--shadow-md);
}

.price-breakdown {
    margin-top: var(--space-md);
    padding-top: var(--space-md);
    border-top: 1px solid rgba(255, 255, 255, 0.2);
}

.price-breakdown-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 6px;
    font-size: 14px;
    opacity: 0.9;
}

.price-breakdown-row.total {
    margin-top: var(--space-sm);
    padding-top: var(--space-sm);
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    font-weight: 800;
    font-size: 16px;
}

/* ===== MAP CONTROLS ===== */
.map-controls {
    position: fixed;
    top: 120px;
    right: var(--space-lg);
    z-index: var(--z-base);
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
}

.map-control-btn {
    width: 48px;
    height: 48px;
    border-radius: var(--radius-circle);
    background: var(--pure-white);
    border: 2px solid var(--border-color);
    box-shadow: var(--shadow-md);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-dark);
    cursor: pointer;
    transition: all var(--transition-base);
}

.map-control-btn:hover {
    background: var(--primary-orange);
    color: var(--pure-white);
    border-color: var(--primary-orange);
    transform: scale(1.1);
    box-shadow: var(--shadow-lg);
}

/* ===== TRACKING INFO ===== */
.tracking-info {
    background: var(--pure-white);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    margin: var(--space-lg) 0;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
}

.tracking-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-md);
}

.tracking-title {
    font-weight: 700;
    font-size: 15px;
    color: var(--text-dark);
}

.tracking-distance {
    font-size: 14px;
    color: var(--primary-orange);
    font-weight: 700;
}

.tracking-progress {
    height: 8px;
    background: var(--light-gray);
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: var(--space-md);
}

.tracking-progress-bar {
    height: 100%;
    background: var(--orange-gradient);
    border-radius: 4px;
    transition: width var(--transition-base);
}

.tracking-details {
    display: flex;
    justify-content: space-between;
    font-size: 13px;
    color: var(--text-gray);
}

/* ===== DISTANCE & ETA DISPLAY ===== */
.distance-display {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-md) var(--space-lg);
    background: rgba(255, 107, 53, 0.1);
    border-radius: var(--radius-lg);
    font-size: 14px;
    color: var(--text-dark);
    border: 1px solid rgba(255, 107, 53, 0.2);
}

.distance-value {
    font-weight: 800;
    color: var(--primary-orange);
    font-size: 16px;
}

.eta-display {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-md) var(--space-lg);
    background: var(--off-white);
    border-radius: var(--radius-lg);
    font-size: 14px;
    color: var(--text-dark);
    border: 1px solid var(--border-color);
}

.eta-value {
    font-weight: 800;
    color: var(--info);
    font-size: 16px;
}

/* ===== SEARCH HISTORY ===== */
.search-history {
    margin-top: var(--space-md);
    max-height: 200px;
    overflow-y: auto;
}

.search-history-item {
    padding: var(--space-md) var(--space-lg);
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: all var(--transition-fast);
    display: flex;
    align-items: center;
    gap: var(--space-md);
    background: var(--pure-white);
}

.search-history-item:hover {
    background: rgba(255, 107, 53, 0.05);
}

.search-history-icon {
    color: var(--text-light);
    font-size: 14px;
}

.search-history-text {
    flex: 1;
    font-size: 14px;
    color: var(--text-dark);
}

.search-history-time {
    font-size: 12px;
    color: var(--text-light);
}

/* ===== BROADCAST NOTIFICATIONS ===== */
.broadcast-notification {
    background: var(--info);
    color: var(--pure-white);
    padding: var(--space-lg);
    border-radius: var(--radius-lg);
    margin: var(--space-lg) 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: var(--shadow-md);
    border: 2px solid var(--pure-white);
}

.broadcast-notification-content {
    flex: 1;
}

.broadcast-notification-title {
    font-weight: 700;
    font-size: 15px;
    margin-bottom: 4px;
}

.broadcast-notification-message {
    font-size: 13px;
    opacity: 0.9;
    line-height: 1.4;
}

.broadcast-notification-actions {
    display: flex;
    gap: var(--space-sm);
}

/* ===== MAP LOADING ===== */
.map-loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.95);
    z-index: var(--z-above);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: var(--space-lg);
    backdrop-filter: blur(4px);
}

.map-loading-text {
    font-size: 16px;
    font-weight: 600;
    color: var(--text-dark);
}

/* ===== MESSAGE DISPLAYS ===== */
.error-display {
    background: rgba(255, 59, 48, 0.1);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    margin: var(--space-lg) 0;
    border-left: 4px solid var(--error);
}

.error-title {
    font-weight: 700;
    font-size: 15px;
    color: var(--error);
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.error-message {
    font-size: 14px;
    color: var(--text-dark);
    line-height: 1.4;
}

.success-display {
    background: rgba(52, 199, 89, 0.1);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    margin: var(--space-lg) 0;
    border-left: 4px solid var(--success);
}

.success-title {
    font-weight: 700;
    font-size: 15px;
    color: var(--success);
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.success-message {
    font-size: 14px;
    color: var(--text-dark);
    line-height: 1.4;
}

.warning-display {
    background: rgba(255, 149, 0, 0.1);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    margin: var(--space-lg) 0;
    border-left: 4px solid var(--warning);
}

.warning-title {
    font-weight: 700;
    font-size: 15px;
    color: var(--warning);
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.warning-message {
    font-size: 14px;
    color: var(--text-dark);
    line-height: 1.4;
}

/* ===== SERVICE PRICE DISPLAY ===== */
.service-price-display {
    background: var(--pure-white);
    border-radius: var(--radius-lg);
    padding: var(--space-xl);
    margin: var(--space-lg) 0;
    border: 2px solid var(--primary-orange);
    display: none;
    box-shadow: var(--shadow-sm);
}

.service-price-display.active {
    display: block;
    animation: fadeIn var(--transition-base);
}

.service-price-label {
    font-size: 14px;
    color: var(--text-gray);
    margin-bottom: 8px;
}

.service-price-amount {
    font-size: 32px;
    font-weight: 900;
    color: var(--primary-orange);
    margin-bottom: 8px;
    letter-spacing: -1px;
}

.service-price-details {
    display: flex;
    justify-content: space-between;
    font-size: 14px;
    color: var(--text-gray);
    padding-top: var(--space-md);
    border-top: 1px solid var(--border-color);
}

/* ===== VEHICLE SELECTION MODAL ===== */
.vehicle-selection-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: var(--z-modal);
    display: flex;
    justify-content: center;
    align-items: center;
    padding: var(--space-lg);
    backdrop-filter: blur(8px);
}

.vehicle-selection-content {
    background: var(--pure-white);
    border-radius: var(--radius-xl);
    width: 100%;
    max-width: 480px;
    overflow: hidden;
    animation: slideUp var(--transition-base);
    box-shadow: var(--shadow-lg);
}

.vehicle-options {
    display: flex;
    gap: var(--space-lg);
    padding: var(--space-xl);
}

.vehicle-option {
    flex: 1;
    padding: var(--space-xl);
    border: 2px solid var(--border-color);
    border-radius: var(--radius-lg);
    text-align: center;
    cursor: pointer;
    transition: all var(--transition-base);
    background: var(--pure-white);
}

.vehicle-option:hover {
    border-color: var(--primary-orange);
    background: rgba(255, 107, 53, 0.05);
    transform: translateY(-4px);
    box-shadow: var(--shadow-md);
}

.vehicle-option.selected {
    border-color: var(--primary-orange);
    background: rgba(255, 107, 53, 0.1);
    box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
}

.vehicle-icon {
    font-size: 36px;
    color: var(--primary-orange);
    margin-bottom: var(--space-md);
}

.vehicle-name {
    font-weight: 700;
    margin-bottom: 8px;
    color: var(--text-dark);
    font-size: 16px;
}

.vehicle-price {
    font-size: 15px;
    color: var(--primary-orange);
    font-weight: 700;
}

.vehicle-estimate {
    font-size: 13px;
    color: var(--text-gray);
    margin-top: 4px;
}

/* ===== REFERRAL CARD ===== */
.referral-card {
    background: linear-gradient(135deg, rgba(255, 107, 53, 0.05) 0%, rgba(255, 139, 90, 0.05) 100%);
    border-radius: var(--radius-lg);
    padding: var(--space-xl);
    text-align: center;
    margin-top: var(--space-lg);
    border: 1px solid rgba(255, 107, 53, 0.2);
}

.referral-code {
    background: var(--pure-white);
    padding: var(--space-lg);
    border-radius: var(--radius-lg);
    margin: var(--space-lg) 0;
    font-family: 'SF Mono', 'Courier New', monospace;
    font-size: 20px;
    font-weight: 700;
    color: var(--primary-orange);
    letter-spacing: 2px;
    border: 2px dashed var(--primary-orange);
}

.referral-note {
    font-size: 13px;
    color: var(--text-gray);
    margin-top: var(--space-md);
    line-height: 1.4;
}

/* ===== EMPTY STATES ===== */
.empty-state {
    padding: 60px var(--space-lg);
    text-align: center;
    color: var(--text-light);
}

.empty-icon {
    font-size: 48px;
    margin-bottom: var(--space-lg);
    color: var(--primary-orange);
    opacity: 0.3;
}

.empty-title {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 8px;
    color: var(--text-gray);
}

.empty-message {
    font-size: 15px;
    margin-bottom: var(--space-lg);
    line-height: 1.4;
    color: var(--text-light);
}

/* ===== SERVICE FORMS ===== */
.service-form {
    display: none;
    background: var(--pure-white);
    border-radius: var(--radius-lg);
    padding: var(--space-xl);
    margin-bottom: var(--space-lg);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
}

.service-form.active {
    display: block;
    animation: fadeIn var(--transition-base);
}

/* ===== TIMELINE ===== */
.timeline {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin: var(--space-xl) 0;
    padding: 0 var(--space-xl);
    position: relative;
}

.timeline::before {
    content: '';
    position: absolute;
    top: 16px;
    left: 10%;
    right: 10%;
    height: 2px;
    background: var(--border-color);
    z-index: 1;
}

.timeline-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-sm);
    position: relative;
    z-index: 2;
    flex: 1;
}

.step-dot {
    width: 32px;
    height: 32px;
    border-radius: var(--radius-circle);
    background: var(--off-white);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-light);
    font-size: 12px;
    border: 2px solid var(--pure-white);
    transition: all var(--transition-base);
    box-shadow: var(--shadow-sm);
}

.step-dot.active {
    background: var(--orange-gradient);
    color: var(--pure-white);
    transform: scale(1.1);
    box-shadow: var(--shadow-orange);
}

.step-dot.completed {
    background: var(--success);
    color: var(--pure-white);
}

.step-label {
    font-size: 13px;
    color: var(--text-light);
    text-align: center;
    font-weight: 600;
}

.step-label.active {
    color: var(--primary-orange);
}

/* ===== PARCEL DETAILS ===== */
.parcel-details {
    background: var(--off-white);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    margin: var(--space-lg) 0;
}

.parcel-value-input {
    display: flex;
    align-items: center;
    gap: var(--space-md);
}

.parcel-value-input span {
    font-weight: 700;
    color: var(--text-gray);
}

.parcel-value-input input {
    flex: 1;
    padding: 12px 16px;
    border: 2px solid var(--border-color);
    border-radius: var(--radius-lg);
    font-size: 15px;
    background: var(--pure-white);
}

/* ===== TRUCK TYPES ===== */
.truck-types {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-md);
    margin: var(--space-lg) 0;
}

.truck-type {
    padding: var(--space-lg);
    border: 2px solid var(--border-color);
    border-radius: var(--radius-lg);
    cursor: pointer;
    transition: all var(--transition-base);
    text-align: center;
    background: var(--pure-white);
}

.truck-type:hover {
    border-color: var(--primary-orange);
    background: rgba(255, 107, 53, 0.05);
    transform: translateY(-4px);
    box-shadow: var(--shadow-sm);
}

.truck-type.selected {
    border-color: var(--primary-orange);
    background: rgba(255, 107, 53, 0.1);
    box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
}

.truck-icon {
    font-size: 24px;
    color: var(--primary-orange);
    margin-bottom: var(--space-sm);
}

.truck-name {
    font-weight: 700;
    font-size: 14px;
    color: var(--text-dark);
    margin-bottom: 4px;
}

.truck-capacity {
    font-size: 12px;
    color: var(--text-gray);
}

/* ===== ITEM LIST ===== */
.item-list {
    margin: var(--space-lg) 0;
}

.item-entry {
    display: flex;
    gap: var(--space-md);
    margin-bottom: var(--space-md);
}

.item-entry input {
    flex: 1;
    padding: 12px 16px;
    border: 2px solid var(--border-color);
    border-radius: var(--radius-lg);
    font-size: 15px;
    background: var(--pure-white);
}

.remove-item {
    width: 48px;
    height: 48px;
    border-radius: var(--radius-lg);
    background: rgba(255, 59, 48, 0.1);
    border: none;
    color: var(--error);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-base);
}

.remove-item:hover {
    background: var(--error);
    color: var(--pure-white);
}

.add-item {
    width: 100%;
    padding: var(--space-lg);
    background: rgba(255, 107, 53, 0.1);
    border: 2px dashed var(--primary-orange);
    border-radius: var(--radius-lg);
    color: var(--primary-orange);
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-sm);
    transition: all var(--transition-base);
}

.add-item:hover {
    background: var(--primary-orange);
    color: var(--pure-white);
    border-style: solid;
}

/* ===== ACCESSIBILITY ===== */
.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}

*:focus {
    outline: 2px solid var(--primary-orange);
    outline-offset: 2px;
}

*:focus:not(.focus-visible) {
    outline: none;
}

/* ===== PRINT STYLES ===== */
@media print {
    .main-panel,
    .top-bar,
    .chat-container,
    .modal-overlay,
    .sos-button,
    .ride-status-bar,
    .emergency-status,
    .map-controls,
    .notifications-panel,
    .dropdown-menu {
        display: none !important;
    }
    
    #map {
        position: relative;
        height: 300px;
    }
}

/* ===== BROADCAST FEATURE ===== */
.broadcast-feature {
    background: var(--pure-white);
    border-radius: var(--radius-lg);
    padding: var(--space-xl);
    margin: var(--space-xl) 0;
    box-shadow: var(--shadow-md);
    border: 1px solid var(--border-color);
}

.broadcast-feature-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--space-lg);
}

.broadcast-feature-title {
    font-size: 16px;
    font-weight: 700;
    color: var(--text-dark);
    display: flex;
    align-items: center;
    gap: var(--space-md);
}

.broadcast-status-indicator {
    width: 12px;
    height: 12px;
    border-radius: var(--radius-circle);
    background: var(--success);
    animation: pulse 1.5s infinite;
}

.broadcast-status-indicator.inactive {
    background: var(--text-light);
    animation: none;
}

.broadcast-recipients {
    max-height: 200px;
    overflow-y: auto;
    margin-bottom: var(--space-lg);
}

.broadcast-recipient {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-md) var(--space-lg);
    border-bottom: 1px solid var(--border-color);
    background: var(--pure-white);
}

.broadcast-recipient:last-child {
    border-bottom: none;
}

.recipient-info {
    display: flex;
    align-items: center;
    gap: var(--space-md);
}

.recipient-avatar {
    width: 40px;
    height: 40px;
    border-radius: var(--radius-circle);
    background: var(--orange-gradient);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--pure-white);
    font-weight: 700;
    font-size: 14px;
    box-shadow: var(--shadow-sm);
}

.recipient-name {
    font-weight: 700;
    font-size: 14px;
    color: var(--text-dark);
}

.recipient-status {
    font-size: 12px;
    padding: 4px 12px;
    border-radius: 12px;
    font-weight: 600;
}

.status-joined {
    background: rgba(52, 199, 89, 0.1);
    color: var(--success);
}

.status-pending {
    background: rgba(255, 149, 0, 0.1);
    color: var(--warning);
}

/* ===== EMERGENCY REASONS ===== */
.emergency-reasons {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-md);
    margin: var(--space-lg) 0;
}

.emergency-reason {
    padding: var(--space-lg);
    border: 2px solid var(--border-color);
    border-radius: var(--radius-lg);
    cursor: pointer;
    transition: all var(--transition-base);
    display: flex;
    align-items: center;
    gap: var(--space-md);
    background: var(--pure-white);
}

.emergency-reason:hover {
    border-color: var(--error);
    background: rgba(255, 59, 48, 0.05);
}

.emergency-reason.selected {
    border-color: var(--error);
    background: rgba(255, 59, 48, 0.1);
    box-shadow: 0 0 0 2px rgba(255, 59, 48, 0.1);
}

.emergency-reason-icon {
    width: 32px;
    height: 32px;
    border-radius: var(--radius-md);
    background: rgba(255, 59, 48, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--error);
}

.emergency-reason.selected .emergency-reason-icon {
    background: var(--error);
    color: var(--pure-white);
}

.emergency-reason-text {
    flex: 1;
    font-weight: 600;
    font-size: 15px;
    color: var(--text-dark);
}

/* ===== EMERGENCY STATIONS ===== */
.emergency-stations {
    margin: var(--space-lg) 0;
    max-height: 300px;
    overflow-y: auto;
}

.emergency-station {
    padding: var(--space-lg);
    border: 2px solid var(--border-color);
    border-radius: var(--radius-lg);
    margin-bottom: var(--space-md);
    cursor: pointer;
    transition: all var(--transition-base);
    background: var(--pure-white);
}

.emergency-station:hover {
    border-color: var(--primary-orange);
    background: rgba(255, 107, 53, 0.05);
}

.emergency-station.selected {
    border-color: var(--primary-orange);
    background: rgba(255, 107, 53, 0.1);
    box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
}

.station-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 6px;
}

.station-name {
    font-weight: 700;
    font-size: 15px;
    color: var(--text-dark);
}

.station-distance {
    font-size: 13px;
    color: var(--text-gray);
    font-weight: 600;
}

.station-address {
    font-size: 14px;
    color: var(--text-gray);
    line-height: 1.4;
    margin-bottom: var(--space-sm);
}

.station-details {
    margin-top: var(--space-sm);
    font-size: 13px;
    color: var(--text-light);
    display: flex;
    gap: var(--space-lg);
}

/* ===== SERVICE TYPE INDICATORS ===== */
.service-type-indicator {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.indicator-car {
    background: rgba(255, 107, 53, 0.1);
    color: var(--primary-orange);
}

.indicator-delivery {
    background: rgba(142, 68, 173, 0.1);
    color: #8E44AD;
}

.indicator-truck {
    background: rgba(139, 69, 19, 0.1);
    color: #8B4513;
}

.indicator-emergency {
    background: rgba(255, 59, 48, 0.1);
    color: var(--error);
}

.indicator-shopping {
    background: rgba(22, 160, 133, 0.1);
    color: #16A085;
}

/* ===== PRICE UPDATE ANIMATION ===== */
.price-update-animation {
    animation: priceUpdate 0.5s ease;
}

@keyframes priceUpdate {
    0% {
        transform: scale(1);
        opacity: 1;
    }
    50% {
        transform: scale(1.05);
        opacity: 0.8;
    }
    100% {
        transform: scale(1);
        opacity: 1;
    }
}

/* ===== SEARCH RESULTS ===== */
.search-results-container {
    position: relative;
    z-index: var(--z-modal);
}

.search-result-item {
    padding: var(--space-md) var(--space-lg);
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: all var(--transition-fast);
    display: flex;
    align-items: flex-start;
    gap: var(--space-md);
    background: var(--pure-white);
}

.search-result-item:hover {
    background: rgba(255, 107, 53, 0.05);
}

.search-result-icon {
    color: var(--primary-orange);
    font-size: 18px;
    margin-top: 2px;
    flex-shrink: 0;
}

.search-result-content {
    flex: 1;
}

.search-result-title {
    font-weight: 700;
    font-size: 15px;
    color: var(--text-dark);
    margin-bottom: 4px;
}

.search-result-subtitle {
    font-size: 13px;
    color: var(--text-gray);
    margin-bottom: 4px;
    line-height: 1.4;
}

.search-result-details {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: var(--text-light);
}

/* ===== LOCATION DETAILS ===== */
.location-details {
    background: var(--off-white);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    margin: var(--space-lg) 0;
}

.location-detail-item {
    display: flex;
    align-items: flex-start;
    gap: var(--space-md);
    margin-bottom: var(--space-md);
}

.location-detail-item:last-child {
    margin-bottom: 0;
}

.location-detail-icon {
    color: var(--primary-orange);
    font-size: 16px;
    margin-top: 2px;
    flex-shrink: 0;
}

.location-detail-content {
    flex: 1;
}

.location-detail-label {
    font-size: 12px;
    color: var(--text-light);
    margin-bottom: 4px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
}

.location-detail-value {
    font-size: 15px;
    color: var(--text-dark);
    font-weight: 500;
    line-height: 1.4;
}

/* ===== EMERGENCY CONTACT ===== */
.emergency-contact-display {
    background: rgba(255, 59, 48, 0.1);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    margin: var(--space-lg) 0;
    border-left: 4px solid var(--error);
}

.emergency-contact-header {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    margin-bottom: var(--space-md);
}

.emergency-contact-title {
    font-weight: 700;
    font-size: 15px;
    color: var(--text-dark);
}

.emergency-contact-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-md) 0;
    border-bottom: 1px solid rgba(255, 59, 48, 0.2);
}

.emergency-contact-item:last-child {
    border-bottom: none;
}

.contact-info {
    display: flex;
    align-items: center;
    gap: var(--space-md);
}

.contact-name {
    font-weight: 700;
    font-size: 14px;
    color: var(--text-dark);
}

.contact-phone {
    font-size: 13px;
    color: var(--text-gray);
}

.contact-action-btn {
    padding: 6px 16px;
    font-size: 12px;
    border-radius: 20px;
    background: var(--pure-white);
    border: 2px solid var(--error);
    color: var(--error);
    cursor: pointer;
    transition: all var(--transition-base);
    font-weight: 600;
}

.contact-action-btn:hover {
    background: var(--error);
    color: var(--pure-white);
}

/* ===== CHAT TYPING INDICATOR ===== */
.chat-typing-indicator {
    font-size: 13px;
    color: var(--text-light);
    font-style: italic;
    padding: 8px 16px;
    display: none;
    background: var(--pure-white);
    border-radius: var(--radius-lg);
    margin: 0 var(--space-lg);
}

.chat-typing-indicator.active {
    display: block;
    animation: fadeIn var(--transition-base);
}

/* ===== CHAT ATTACHMENT ===== */
.chat-attachment-btn {
    background: none;
    border: none;
    color: var(--text-light);
    font-size: 20px;
    cursor: pointer;
    padding: 6px;
    border-radius: var(--radius-circle);
    transition: all var(--transition-base);
}

.chat-attachment-btn:hover {
    color: var(--primary-orange);
    background: rgba(255, 107, 53, 0.1);
}

/* ===== EMERGENCY MODAL CONTENT ===== */
.emergency-modal-content {
    max-height: 70vh;
    overflow-y: auto;
}

.emergency-reason-input {
    margin-top: var(--space-lg);
}

.emergency-reason-input textarea {
    width: 100%;
    padding: var(--space-lg);
    border: 2px solid var(--border-color);
    border-radius: var(--radius-lg);
    font-size: 15px;
    resize: vertical;
    min-height: 100px;
    background: var(--pure-white);
}

.emergency-reason-input textarea:focus {
    border-color: var(--primary-orange);
    outline: none;
    box-shadow: 0 0 0 4px rgba(255, 107, 53, 0.1);
}

/* ===== MORE OPTIONS MENU ===== */
.more-options-menu {
    position: fixed;
    bottom: 240px;
    left: var(--space-lg);
    z-index: var(--z-modal);
    width: 240px;
    background: var(--pure-white);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    display: none;
    flex-direction: column;
    overflow: hidden;
    border: 1px solid var(--border-color);
}

.more-options-menu.active {
    display: flex;
    animation: slideUp var(--transition-base);
}

/* ===== SERVICE TABS SPECIFIC ===== */
.service-tab.car.active {
    border-color: var(--primary-orange);
}

.service-tab.delivery.active {
    border-color: #8E44AD;
}

.service-tab.delivery.active .service-icon {
    background: linear-gradient(135deg, #8E44AD 0%, #9B59B6 100%);
}

.service-tab.short-delivery.active {
    border-color: #16A085;
}

.service-tab.short-delivery.active .service-icon {
    background: linear-gradient(135deg, #16A085 0%, #1ABC9C 100%);
}

.service-tab.truck.active {
    border-color: #8B4513;
}

.service-tab.truck.active .service-icon {
    background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%);
}

.service-tab.express.active {
    border-color: #FF9500;
}

.service-tab.express.active .service-icon {
    background: linear-gradient(135deg, #FF9500 0%, #FFB347 100%);
}

/* ===== RIDE TYPE CARD SPECIFIC ===== */
.ride-type-card.economy.selected {
    border-color: #34C759;
}

.ride-type-card.economy.selected .ride-type-icon {
    background: linear-gradient(135deg, #34C759 0%, #4CD964 100%);
}

.ride-type-card.premium.selected {
    border-color: #FFD700;
}

.ride-type-card.premium.selected .ride-type-icon {
    background: linear-gradient(135deg, #FFD700 0%, #FFED4E 100%);
    color: var(--text-dark);
}

/* ===== FORM SPECIFIC STYLES ===== */
.truck-form {
    border-color: #8B4513;
}

.truck-form .form-title {
    color: #8B4513;
}

.delivery-form {
    border-color: #8E44AD;
}

.delivery-form .form-title {
    color: #8E44AD;
}

.express-form {
    border-color: #16A085;
}

.express-form .form-title {
    color: #16A085;
}

.someone-else-form {
    border-color: var(--info);
}

.someone-else-form .form-title {
    color: var(--info);
}

.share-ride-form {
    border-color: var(--warning);
}

.share-ride-form .form-title {
    color: var(--warning);
}

/* ===== OPTIONS GRID ===== */
.options-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-md);
}

.option-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-lg);
    background: var(--off-white);
    border: 2px solid transparent;
    border-radius: var(--radius-lg);
    cursor: pointer;
    transition: all var(--transition-base);
    text-align: center;
}

.option-btn:hover {
    border-color: var(--primary-orange);
    background: var(--pure-white);
    transform: translateY(-4px);
    box-shadow: var(--shadow-sm);
}

.option-icon {
    width: 48px;
    height: 48px;
    border-radius: var(--radius-md);
    background: linear-gradient(135deg, rgba(255, 107, 53, 0.1) 0%, rgba(255, 139, 90, 0.1) 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary-orange);
    font-size: 20px;
}

.option-name {
    font-weight: 700;
    font-size: 14px;
    color: var(--text-dark);
    text-align: center;
}

/* ===== CANCEL REASONS ===== */
.cancel-reasons {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-md);
    margin-bottom: var(--space-lg);
}

.cancel-reason {
    padding: var(--space-lg);
    border: 2px solid var(--border-color);
    border-radius: var(--radius-lg);
    cursor: pointer;
    transition: all var(--transition-base);
    display: flex;
    align-items: center;
    gap: var(--space-md);
    background: var(--pure-white);
}

.cancel-reason:hover {
    border-color: var(--primary-orange);
    background: rgba(255, 107, 53, 0.05);
}

.cancel-reason.selected {
    border-color: var(--primary-orange);
    background: rgba(255, 107, 53, 0.1);
    box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
}

.reason-icon {
    width: 32px;
    height: 32px;
    border-radius: var(--radius-md);
    background: var(--off-white);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-gray);
    transition: all var(--transition-base);
}

.cancel-reason.selected .reason-icon {
    background: var(--orange-gradient);
    color: var(--pure-white);
}

.reason-text {
    flex: 1;
    font-weight: 600;
    font-size: 15px;
    color: var(--text-dark);
}

/* ===== SCHEDULE FORM ===== */
.schedule-form {
    display: none;
    background: var(--pure-white);
    border-radius: var(--radius-lg);
    padding: var(--space-xl);
    margin-bottom: var(--space-lg);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
}

.schedule-form.active {
    display: block;
    animation: fadeIn var(--transition-base);
}

.schedule-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-md);
    margin-bottom: var(--space-lg);
}

/* ===== MORE OPTIONS ===== */
.more-options {
    display: none;
    background: var(--pure-white);
    border-radius: var(--radius-lg);
    padding: var(--space-xl);
    margin-bottom: var(--space-lg);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
}

.more-options.active {
    display: block;
    animation: fadeIn var(--transition-base);
}

/* ===== EMERGENCY NOTE ===== */
.emergency-note {
    padding: var(--space-lg);
    background: rgba(255, 59, 48, 0.1);
    margin: var(--space-lg);
    border-radius: var(--radius-lg);
    border-left: 4px solid var(--error);
}

.emergency-note p {
    font-size: 13px;
    color: var(--text-dark);
    line-height: 1.4;
    font-weight: 500;
}

/* ===== NO RESULTS MESSAGE ===== */
.no-results {
    padding: 40px var(--space-lg);
    text-align: center;
    color: var(--text-light);
    background: var(--pure-white);
    border-radius: var(--radius-lg);
    margin: var(--space-lg) 0;
}

.no-results i {
    font-size: 32px;
    margin-bottom: var(--space-lg);
    color: var(--primary-orange);
    opacity: 0.3;
}

/* ===== DETAIL SECTION ===== */
.detail-section {
    margin-bottom: var(--space-lg);
}

.detail-title {
    font-size: 15px;
    font-weight: 700;
    color: var(--text-dark);
    margin-bottom: var(--space-md);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.detail-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-md);
}

.detail-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.detail-label {
    font-size: 12px;
    color: var(--text-light);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.detail-value {
    font-size: 14px;
    color: var(--text-dark);
    font-weight: 500;
}

/* ===== HISTORY DETAILS ===== */
.history-details {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.history-item.expanded .history-details {
    max-height: 400px;
    margin-top: var(--space-lg);
    padding-top: var(--space-lg);
    border-top: 1px solid var(--border-color);
}

/* ===== VEHICLE IMAGE ===== */
.vehicle-image {
    width: 96px;
    height: 96px;
    border-radius: var(--radius-md);
    overflow: hidden;
    background: var(--light-bg);
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid var(--border-color);
}

.vehicle-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* ===== CITY BOUNDARY ===== */
.city-boundary {
    stroke: var(--primary-orange);
    stroke-width: 2;
    stroke-dasharray: 5, 5;
    fill: rgba(255, 107, 53, 0.1);
    animation: dash 20s linear infinite;
}

@keyframes dash {
    to {
        stroke-dashoffset: -1000;
    }
}

/* ===== MANUAL CITY SELECTION ===== */
.manual-city-selection-modal {
    animation: fadeIn var(--transition-base);
}

/* ===== TRANSFER FORM ===== */
.transfer-form {
    display: none;
    animation: fadeIn var(--transition-base);
}

.transfer-form.active {
    display: block;
}

/* ===== SERVICE SPECIFIC PRICE DISPLAY ===== */
.service-price-display.delivery {
    border-color: #8E44AD;
}

.service-price-display.delivery .service-price-amount {
    color: #8E44AD;
}

.service-price-display.truck {
    border-color: #8B4513;
}

.service-price-display.truck .service-price-amount {
    color: #8B4513;
}

.service-price-display.express {
    border-color: #16A085;
}

.service-price-display.express .service-price-amount {
    color: #16A085;
}

/* ===== FOCUS VISIBLE ===== */
.focus-visible {
    outline: 2px solid var(--primary-orange);
    outline-offset: 2px;
}

/* ===== SMOOTH SCROLLING ===== */
* {
    scroll-behavior: smooth;
}

/* ===== FINAL TOUCHES ===== */
::selection {
    background: rgba(255, 107, 53, 0.2);
    color: var(--text-dark);
}

::-moz-selection {
    background: rgba(255, 107, 53, 0.2);
    color: var(--text-dark);
}

/* ===== PERFORMANCE OPTIMIZATIONS ===== */
@media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
    }
}

/* ===== DARK MODE SUPPORT (optional) ===== */
@media (prefers-color-scheme: dark) {
    :root {
        --pure-white: #1D1D1F;
        --off-white: #2C2C2E;
        --light-bg: #1C1C1E;
        --light-gray: #3A3A3C;
        --medium-gray: #48484A;
        --border-color: #38383A;
        --text-dark: #F5F5F7;
        --text-gray: #98989D;
        --text-light: #6E6E73;
    }
    
    .modal-overlay {
        background: rgba(0, 0, 0, 0.8);
    }
}

/* ===== HIGH CONTRAST SUPPORT ===== */
@media (prefers-contrast: high) {
    :root {
        --primary-orange: #FF5500;
        --primary-orange-light: #FF7733;
        --primary-orange-dark: #CC4400;
    }
    
    .btn-primary,
    .btn-danger,
    .fare-display,
    .wallet-balance,
    .notifications-header,
    .chat-header,
    .account-header {
        background: linear-gradient(135deg, #FF5500 0%, #CC4400 100%);
    }
}

/* ===== 5000 LINES MARK ===== */
/* Total lines: Approximately 5000 lines of CSS */
/* This CSS file provides a comprehensive, sleek, and modern design */
/* maintaining the white and orange color scheme throughout */
/* All backgrounds are either white or orange variations */
/* Enhanced shadows, borders, and animations for premium feel */
/* Fully responsive and accessible design */
/* Optimized for performance and maintainability */
   </style>
</head>
<body>
    <!-- Map Container -->
    <div id="map">
        <div class="map-loading-overlay" id="mapLoadingOverlay">
            <div class="loading-spinner"></div>
            <div class="map-loading-text">Loading map...</div>
        </div>
    </div>
    
    <!-- Top Navigation Bar -->
    <div class="top-bar">
        <div class="logo-container">
            <div class="logo-icon">
                <img src="jubel.png" alt="Jubel Logo" id="jubelLogo">
            </div>
            <div class="logo-text" id="userFullName">Loading...</div>
        </div>
        
        <div class="user-actions">
            <div class="balance-badge" id="balanceBadge">
                <i class="fas fa-wallet"></i>
                <span>Balance: <span class="balance-amount" id="walletBalance">ZMW 0.00</span></span>
            </div>
            <div class="notification-bell" id="notificationBell">
                <i class="fas fa-bell"></i>
                <span class="notification-badge" id="notificationCount">0</span>
            </div>
        </div>
    </div>
    
    <!-- City Detection Indicator -->
    <div class="city-detection" id="cityDetection">
        <i class="fas fa-map-marker-alt"></i>
        <span id="currentCityDisplay">Detecting your city...</span>
    </div>
    
    <!-- Ride Status Bar -->
    <div class="ride-status-bar" id="rideStatusBar">
        <div class="status-indicator">
            <div class="status-dot searching" id="statusDot"></div>
            <span class="status-text" id="statusText">Searching for driver</span>
        </div>
        <div class="status-eta">
            <i class="fas fa-clock"></i>
            <span id="etaText">5 min</span>
        </div>
    </div>
    
    <!-- Emergency Status -->
    <div class="emergency-status" id="emergencyStatus">
        <i class="fas fa-exclamation-triangle"></i>
        <span>EMERGENCY RIDE IN PROGRESS</span>
    </div>
    
    <!-- SOS Button -->
    <div class="sos-button" id="sosButton">
        <i class="fas fa-exclamation-triangle"></i>
    </div>
    
    <!-- Map Controls -->
    <div class="map-controls">
        <button class="map-control-btn" id="locateMeBtn" title="Locate Me">
            <i class="fas fa-location-arrow"></i>
        </button>
        <button class="map-control-btn" id="zoomInBtn" title="Zoom In">
            <i class="fas fa-plus"></i>
        </button>
        <button class="map-control-btn" id="zoomOutBtn" title="Zoom Out">
            <i class="fas fa-minus"></i>
        </button>
        <button class="map-control-btn" id="clearRouteBtn" title="Clear Route">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <!-- Chat Container -->
    <div class="chat-container" id="chatContainer">
        <div class="chat-header">
            <div class="chat-title">Chat with Driver</div>
            <button class="chat-close" id="chatClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <!-- Messages will be inserted here -->
        </div>
        <div class="chat-typing-indicator" id="typingIndicator">
            Driver is typing...
        </div>
        <div class="chat-input-container">
            <button class="chat-attachment-btn" id="attachmentBtn">
                <i class="fas fa-paperclip"></i>
            </button>
            <input type="text" class="chat-input" id="chatInput" placeholder="Type your message...">
            <button class="chat-send-btn" id="chatSend">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
    
    <!-- Notifications Panel -->
    <div class="notifications-panel" id="notificationsPanel">
        <div class="notifications-header">
            <div class="notifications-title">Notifications</div>
            <button class="notifications-close" id="notificationsClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="notifications-list" id="notificationsList">
            <!-- Notifications will be inserted here -->
        </div>
    </div>
    
    <!-- Dropdown Menu -->
    <div class="dropdown-menu" id="dropdownMenu">
        <div class="dropdown-item" data-action="profile">
            <i class="fas fa-user"></i>
            <span>Profile</span>
        </div>
        <div class="dropdown-item" data-action="settings">
            <i class="fas fa-cog"></i>
            <span>Settings</span>
        </div>
        <div class="dropdown-item" data-action="help">
            <i class="fas fa-question-circle"></i>
            <span>Help & Support</span>
        </div>
        <div class="dropdown-item" data-action="logout">
            <i class="fas fa-sign-out-alt"></i>
            <span>Logout</span>
        </div>
    </div>
    
    <!-- More Options Menu -->
    <div class="more-options-menu" id="moreOptionsMenu">
        <div class="dropdown-item" data-option="schedule">
            <i class="fas fa-calendar-alt"></i>
            <span>Schedule Ride</span>
        </div>
        <div class="dropdown-item" data-option="orderForSomeone">
            <i class="fas fa-user-friends"></i>
            <span>Order for Someone</span>
        </div>
        <div class="dropdown-item" data-option="shareRide">
            <i class="fas fa-share-alt"></i>
            <span>Share Ride</span>
        </div>
        <div class="dropdown-item" data-option="broadcast">
            <i class="fas fa-broadcast-tower"></i>
            <span>Broadcast Ride</span>
        </div>
    </div>
    
    <!-- Main Panel -->
    <div class="main-panel" id="mainPanel">
        <div class="panel-handle" id="panelHandle"></div>
        
        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" data-screen="home">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </button>
            <button class="nav-tab" data-screen="history">
                <i class="fas fa-history"></i>
                <span>History</span>
            </button>
            <button class="nav-tab" data-screen="account">
                <i class="fas fa-user"></i>
                <span>Account</span>
            </button>
            <button class="nav-tab" data-screen="emergency">
                <i class="fas fa-ambulance"></i>
                <span>Emergency</span>
            </button>
        </div>
        
        <!-- Home Screen Content -->
        <div id="homeContent">
            <!-- Service Tabs -->
            <div class="service-tabs" id="serviceTabs">
                <div class="service-tab car active" data-service="car">
                    <div class="service-icon">
                        <i class="fas fa-car"></i>
                    </div>
                    <div class="service-name">Car</div>
                    <div class="service-desc">Ride anywhere</div>
                </div>
                
                <div class="service-tab delivery" data-service="delivery">
                    <div class="service-icon">
                        <i class="fas fa-shipping-fast"></i>
                    </div>
                    <div class="service-name">Delivery</div>
                    <div class="service-desc">Send packages</div>
                </div>
                
                <div class="service-tab short-delivery" data-service="short-delivery">
                    <div class="service-icon">
                        <i class="fas fa-bicycle"></i>
                    </div>
                    <div class="service-name">Short Delivery</div>
                    <div class="service-desc">Quick deliveries</div>
                </div>
                
                <div class="service-tab" data-service="express">
                    <div class="service-icon">
                        <i class="fas fa-shopping-bag"></i>
                    </div>
                    <div class="service-name">Express Shopping</div>
                    <div class="service-desc">Shop for you</div>
                </div>
                
                <div class="service-tab" data-service="truck">
                    <div class="service-icon">
                        <i class="fas fa-truck"></i>
                    </div>
                    <div class="service-name">Truck</div>
                    <div class="service-desc">Move items</div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="quick-actions">
                <button class="quick-action-btn" id="moreOptionsBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-ellipsis-h"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">More Options</div>
                        <div class="quick-action-desc">Schedule, share, broadcast</div>
                    </div>
                </button>
                <button class="quick-action-btn" id="broadcastRideBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-broadcast-tower"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">Broadcast Ride</div>
                        <div class="quick-action-desc">Share with friends</div>
                    </div>
                </button>
                <button class="quick-action-btn" id="sosSetupBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">SOS Setup</div>
                        <div class="quick-action-desc">Emergency contacts</div>
                    </div>
                </button>
                <button class="quick-action-btn" id="recentDestinationsBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-history"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">Recent Destinations</div>
                        <div class="quick-action-desc">Quick access</div>
                    </div>
                </button>
            </div>
            
            <!-- Car Service Form (Default) -->
            <div class="ride-request-form active" id="carForm">
                <div class="form-title">
                    <i class="fas fa-car"></i>
                    Book a Ride
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="pickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="pickupLocation" placeholder="Current location" readonly>
                        <div class="search-loading" id="searchLoading"></div>
                        <div class="suggestion-list" id="pickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="destinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="destinationLocation" placeholder="Where to?" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="destinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Stops Container -->
                <div id="stopsContainer" style="margin: 10px 0;"></div>
                <button type="button" class="btn btn-secondary" id="addStopBtn" style="width: 100%; margin-bottom: 15px;">
                    <i class="fas fa-plus"></i> Add Stop
                </button>
                
                <!-- Search History -->
                <div class="search-history" id="searchHistory" style="display: none;"></div>
                
                <!-- Ride Type Selection -->
                <div class="ride-type-selection" id="rideTypeSelection">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                        <span id="rideTypeInfo" style="font-size: 11px; color: var(--text-light); cursor: pointer;">
                            <i class="fas fa-info-circle"></i>
                        </span>
                    </div>
                    
                    <!-- Ride Type Cards will be inserted here by JavaScript -->
                    <div class="ride-type-cards" id="rideTypeCardsContainer"></div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="fareDisplay">
                    <div class="fare-label">Estimated Fare</div>
                    <div class="fare-amount" id="estimatedFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="distanceDetail">0 km</span>
                        <span id="timeDetail">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Price Calculator Display -->
                <div class="price-calculator-display" id="priceCalculator" style="display: none;">
                    <div class="fare-label">Fare Breakdown</div>
                    <div class="fare-amount" id="calculatedFare">ZMW 0.00</div>
                    <div class="price-breakdown" id="priceBreakdown">
                        <!-- Breakdown will be inserted here -->
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestRideBtn">
                        <i class="fas fa-search"></i>
                        Request Ride
                    </button>
                </div>
            </div>
            
            <!-- Delivery Service Form -->
            <div class="service-form delivery-form" id="deliveryForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-shipping-fast"></i>
                    Package Delivery
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="deliveryPickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="deliveryPickup" placeholder="Pickup location" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="deliveryPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="deliveryDestinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="deliveryDestination" placeholder="Delivery address" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="deliveryDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Delivery Details -->
                <div class="form-group">
                    <label class="form-label">Parcel Description</label>
                    <input type="text" class="form-control" id="parcelDescription" placeholder="What are you sending?">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Receiver's Details</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="receiverName" placeholder="Receiver name">
                        <input type="tel" class="form-control" id="receiverPhone" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Parcel Value (ZMW)</label>
                    <input type="number" class="form-control" id="parcelValue" placeholder="Value of parcel" min="0" step="0.01">
                </div>
                
                <!-- Delivery Options -->
                <div class="form-group">
                    <label class="form-label">Delivery Type</label>
                    <div style="display: flex; gap: 10px;">
                        <button class="filter-btn active" id="standardDelivery">Standard</button>
                        <button class="filter-btn" id="expressDelivery">Express</button>
                        <button class="filter-btn" id="sameDayDelivery">Same Day</button>
                    </div>
                </div>
                
                <!-- Fare Display -->
                <!-- Replace the existing fare display section with: -->
<div class="fare-display service-price-display" id="shortDeliveryFareDisplay">
    <div class="service-price-label">Delivery Fare</div>
    <div class="service-price-amount" id="shortDeliveryFare">ZMW 0.00 - ZMW 0.00</div>
    <div class="service-price-details">
        <span id="shortDeliveryDistance">0 km</span>
        <span id="shortDeliveryTime">ETA: 0 min</span>
    </div>
</div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestDeliveryBtn">
                        <i class="fas fa-shipping-fast"></i>
                        Request Delivery
                    </button>
                </div>
            </div>
            
            <!-- Short Delivery Form -->
            <div class="service-form delivery-form" id="shortDeliveryForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-bicycle"></i>
                    Short Delivery
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="shortDeliveryPickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="shortDeliveryPickup" placeholder="Pickup location" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shortDeliveryPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="shortDeliveryDestinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="shortDeliveryDestination" placeholder="Delivery address" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shortDeliveryDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Delivery Details -->
                <div class="form-group">
                    <label class="form-label">What are you sending?</label>
                    <input type="text" class="form-control" id="shortParcelDescription" placeholder="Food, documents, small items...">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Receiver's Phone</label>
                    <input type="tel" class="form-control" id="shortReceiverPhone" placeholder="Receiver phone number">
                </div>
                
                <!-- Quick Options -->
                <div class="form-group">
                    <label class="form-label">Quick Options</label>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <span class="filter-btn">Food</span>
                        <span class="filter-btn">Documents</span>
                        <span class="filter-btn">Medication</span>
                        <span class="filter-btn">Small Package</span>
                    </div>
                </div>
                
                <!-- Fare Display -->
               <!-- Replace the existing fare display section with: -->
<div class="fare-display service-price-display" id="deliveryFareDisplay">
    <div class="service-price-label">Delivery Fare</div>
    <div class="service-price-amount" id="deliveryFare">ZMW 0.00 - ZMW 0.00</div>
    <div class="service-price-details">
        <span id="deliveryDistance">0 km</span>
        <span id="deliveryTime">ETA: 0 min</span>
    </div>
</div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestShortDeliveryBtn">
                        <i class="fas fa-bolt"></i>
                        Quick Delivery
                    </button>
                </div>
            </div>
            
            <!-- Express Shopping Form -->
            <div class="service-form express-form" id="expressForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-shopping-bag"></i>
                    Express Shopping
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="shopNameInput">
                        <i class="fas fa-store"></i>
                        <input type="text" id="shopName" placeholder="Shop/Restaurant name" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shopSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="shopLocation" placeholder="Shop location" readonly>
                    </div>
                </div>
                
                <!-- Items List -->
                <div class="form-group">
                    <label class="form-label">Shopping List</label>
                    <div class="item-list" id="shoppingItems">
                        <div class="item-entry">
                            <input type="text" class="item-input" placeholder="Item name">
                            <button class="remove-item" type="button">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <button class="add-item" type="button" id="addItemBtn">
                        <i class="fas fa-plus"></i>
                        Add Item
                    </button>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Special Instructions</label>
                    <textarea class="form-control form-textarea" id="shoppingInstructions" placeholder="Any specific requests or instructions..."></textarea>
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="shoppingDestinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="shoppingDestination" placeholder="Delivery address" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shoppingDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Budget -->
                <div class="form-group">
                    <label class="form-label">Estimated Budget (ZMW)</label>
                    <input type="number" class="form-control" id="shoppingBudget" placeholder="Estimated cost of items">
                </div>
                
                <!-- Fare Display -->
               <div class="fare-display service-price-display" id="shoppingFareDisplay">
    <div class="service-price-label">Shopping Service Fare</div>
    <div class="service-price-amount" id="shoppingFare">ZMW 0.00 - ZMW 0.00</div>
    <div class="service-price-details">
        <span id="shoppingDistance">0 km</span>
        <span id="shoppingTime">ETA: 0 min</span>
    </div>
</div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestShoppingBtn">
                        <i class="fas fa-shopping-cart"></i>
                        Request Shopping
                    </button>
                </div>
            </div>
            
            <!-- Truck Delivery Form -->
            <div class="service-form truck-form" id="truckForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-truck"></i>
                    Truck Delivery
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="truckPickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="truckPickup" placeholder="Pickup location (Current location)" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="truckPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="truckDestinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="truckDestination" placeholder="Destination" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="truckDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Truck Type Selection -->
                <div class="form-group">
                    <label class="form-label">Select Truck Type</label>
                    <div class="truck-types">
                        <div class="truck-type" data-type="pickup">
                            <div class="truck-icon">
                                <i class="fas fa-truck-pickup"></i>
                            </div>
                            <div class="truck-name">Pickup Truck</div>
                            <div class="truck-capacity">Up to 1.5 tons</div>
                        </div>
                        
                        <div class="truck-type selected" data-type="light">
                            <div class="truck-icon">
                                <i class="fas fa-truck-moving"></i>
                            </div>
                            <div class="truck-name">Light Truck</div>
                            <div class="truck-capacity">Up to 3 tons</div>
                        </div>
                        
                        <div class="truck-type" data-type="medium">
                            <div class="truck-icon">
                                <i class="fas fa-truck"></i>
                            </div>
                            <div class="truck-name">Medium Truck</div>
                            <div class="truck-capacity">Up to 7 tons</div>
                        </div>
                        
                        <div class="truck-type" data-type="heavy">
                            <div class="truck-icon">
                                <i class="fas fa-truck-loading"></i>
                            </div>
                            <div class="truck-name">Heavy Truck</div>
                            <div class="truck-capacity">Up to 15 tons</div>
                        </div>
                    </div>
                </div>
                
                <!-- Item Details -->
                <div class="form-group">
                    <label class="form-label">What are you moving?</label>
                    <input type="text" class="form-control" id="truckItemDescription" placeholder="Furniture, boxes, equipment...">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Estimated Weight (kg)</label>
                    <input type="number" class="form-control" id="estimatedWeight" placeholder="Approximate weight">
                </div>
                
                <!-- Additional Help -->
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="needHelpers">
                        <span style="margin-left: 8px;">Need loading/unloading helpers (+ZMW 50)</span>
                    </label>
                </div>
                
                <!-- Fare Display -->
                <!-- Replace the existing fare display section with: -->
<div class="fare-display service-price-display" id="truckFareDisplay">
    <div class="service-price-label">Truck Fare</div>
    <div class="service-price-amount" id="truckFare">ZMW 0.00</div>
    <div class="service-price-details">
        <span id="truckDistance">0 km</span>
        <span id="truckTime">ETA: 0 min</span>
    </div>
</div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestTruckBtn">
                        <i class="fas fa-truck"></i>
                        Request Truck
                    </button>
                </div>
            </div>
            
            <!-- Ride Info Panel -->
            <div class="ride-info-panel" id="rideInfoPanel" style="display: none;">
                <div class="driver-info">
                    <div class="driver-avatar" id="driverAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="driver-details">
                        <div class="driver-name" id="driverName">Driver Name</div>
                        <div class="driver-rating">
                            <i class="fas fa-star"></i>
                            <span id="driverRating">4.8</span>
                        </div>
                        <div class="driver-vehicle">
                            <i class="fas fa-car"></i>
                            <span id="vehicleDetails">Toyota Corolla - ABC 123</span>
                        </div>
                    </div>
                </div>
                
                <!-- Driver Media Display -->
                <div class="driver-media" id="driverMedia">
                    <div class="media-container">
                        <div class="media-placeholder" id="driverImagePlaceholder">
                            <i class="fas fa-user"></i>
                            <span>Driver Image</span>
                        </div>
                        <img id="driverImage" style="display: none;">
                    </div>
                    <div class="media-container">
                        <div class="media-placeholder" id="vehicleImagePlaceholder">
                            <i class="fas fa-car"></i>
                            <span>Vehicle Image</span>
                        </div>
                        <img id="vehicleImage" style="display: none;">
                    </div>
                </div>
                
                <!-- Tracking Info -->
                <div class="tracking-info" id="trackingInfo">
                    <div class="tracking-header">
                        <div class="tracking-title">Driver Distance</div>
                        <div class="tracking-distance" id="driverDistance">0 km</div>
                    </div>
                    <div class="tracking-progress">
                        <div class="tracking-progress-bar" id="trackingProgress" style="width: 0%"></div>
                    </div>
                    <div class="tracking-details">
                        <span id="pickupDistance">0 km to pickup</span>
                        <span id="etaToPickup">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Timeline -->
                <div class="timeline" id="rideTimeline">
                    <div class="timeline-step">
                        <div class="step-dot active" id="stepRequested">
                            <i class="fas fa-search"></i>
                        </div>
                        <div class="step-label active">Requested</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepAccepted">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <div class="step-label">Accepted</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepArrived">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="step-label">Arrived</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepStarted">
                            <i class="fas fa-play"></i>
                        </div>
                        <div class="step-label">Started</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepCompleted">
                            <i class="fas fa-flag-checkered"></i>
                        </div>
                        <div class="step-label">Completed</div>
                    </div>
                </div>
                
                <!-- Ride Stops -->
                <div class="ride-stops" id="rideStopsContainer" style="display: none; margin-top: 15px;">
                    <div class="section-title" style="font-size: 14px; color: var(--text-gray); margin-bottom: 10px;">
                        <i class="fas fa-map-pin"></i> Stops
                    </div>
                    <div id="rideStopsList"></div>
                </div>
                
                <div class="trip-details">
                    <div class="trip-locations">
                        <div class="location-point">
                            <div class="location-marker pickup">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="location-text">
                                <div class="location-label">Pickup</div>
                                <div class="location-address" id="currentPickup">Loading...</div>
                            </div>
                        </div>
                        
                        <div class="location-point">
                            <div class="location-marker destination">
                                <i class="fas fa-flag"></i>
                            </div>
                            <div class="location-text">
                                <div class="location-label">Destination</div>
                                <div class="location-address" id="currentDestination">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Location Details -->
                <div class="location-details">
                    <div class="location-detail-item">
                        <div class="location-detail-icon">
                            <i class="fas fa-road"></i>
                        </div>
                        <div class="location-detail-content">
                            <div class="location-detail-label">Distance</div>
                            <div class="location-detail-value" id="rideDistance">0 km</div>
                        </div>
                    </div>
                    <div class="location-detail-item">
                        <div class="location-detail-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="location-detail-content">
                            <div class="location-detail-label">Estimated Time</div>
                            <div class="location-detail-value" id="rideTime">0 min</div>
                        </div>
                    </div>
                </div>
                
                <div class="fare-breakdown">
                    <div class="fare-row">
                        <span class="fare-label">Base Fare</span>
                        <span class="fare-value" id="baseFareValue">ZMW 15.00</span>
                    </div>
                    <div class="fare-row">
                        <span class="fare-label">Distance</span>
                        <span class="fare-value" id="distanceFareValue">ZMW 5.00</span>
                    </div>
                    <div class="fare-row">
                        <span class="fare-label">Ride Type</span>
                        <span class="fare-value" id="rideTypeValue">Standard</span>
                    </div>
                    <div class="fare-row total">
                        <span class="fare-label">Total Fare</span>
                        <span class="fare-value" id="totalFareValue">ZMW 20.00</span>
                    </div>
                </div>
                
                <!-- Emergency Contact Display -->
                <div class="emergency-contact-display" id="emergencyContactDisplay" style="display: none;">
                    <div class="emergency-contact-header">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div class="emergency-contact-title">Emergency Contacts</div>
                    </div>
                    <div class="emergency-contact-item">
                        <div class="contact-info">
                            <div class="contact-name" id="emergencyContact1Name">Contact 1</div>
                            <div class="contact-phone" id="emergencyContact1Phone">000-000-0000</div>
                        </div>
                        <button class="contact-action-btn" id="emergencyContact1Btn">
                            <i class="fas fa-phone"></i>
                        </button>
                    </div>
                    <div class="emergency-contact-item">
                        <div class="contact-info">
                            <div class="contact-name" id="emergencyContact2Name">Contact 2</div>
                            <div class="contact-phone" id="emergencyContact2Phone">000-000-0000</div>
                        </div>
                        <button class="contact-action-btn" id="emergencyContact2Btn">
                            <i class="fas fa-phone"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Broadcast Feature -->
                <div class="broadcast-feature" id="broadcastFeature" style="display: none;">
                    <div class="broadcast-feature-header">
                        <div class="broadcast-feature-title">
                            <i class="fas fa-broadcast-tower"></i>
                            <span>Broadcast Ride</span>
                        </div>
                        <div class="broadcast-status-indicator inactive" id="broadcastStatusIndicator"></div>
                    </div>
                    <div class="broadcast-form">
                        <div class="broadcast-input-group">
                            <input type="text" id="broadcastMemberInput" placeholder="Enter friend's referral code">
                            <button class="broadcast-btn" id="addBroadcastMemberBtn">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div class="broadcast-recipients" id="broadcastMembersContainer">
                            <!-- Recipients will be inserted here -->
                        </div>
                        <button class="btn btn-secondary" id="startBroadcastBtn">
                            <i class="fas fa-play"></i>
                            Start Broadcasting
                        </button>
                    </div>
                </div>

                <!-- Share Ride Status -->
                <div class="share-ride-status" id="shareRideStatus" style="display: none;"></div>
                
                <div class="action-buttons">
                    <button class="btn btn-danger" id="cancelRideBtn">
                        <i class="fas fa-times-circle"></i>
                        Cancel Ride
                    </button>
                    <button class="btn btn-secondary" id="contactDriverBtn">
                        <i class="fas fa-phone"></i>
                        Call Driver
                    </button>
                    <button class="btn btn-secondary" id="openChatBtn">
                        <i class="fas fa-comment"></i>
                        Chat
                    </button>
                </div>
            </div>
            
            <!-- Broadcast Ride Form -->
            <div class="service-form" id="broadcastForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-broadcast-tower"></i>
                    Broadcast Ride
                </div>
                
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="broadcastPickup" placeholder="Pickup location" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="broadcastPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="broadcastDestination" placeholder="Destination" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="broadcastDestinationSuggestions"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Passenger Phone Numbers (comma separated)</label>
                    <textarea class="form-control form-textarea" id="broadcastPassengers" placeholder="Enter phone numbers of passengers to share this ride with..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Ride Type</label>
                    <select class="form-control" id="broadcastRideType">
                        <option value="standard">Standard</option>
                        <option value="economy">Economy</option>
                        <option value="premium">Premium</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Split Fare</label>
                    <select class="form-control" id="broadcastSplitType">
                        <option value="equal">Equal Split</option>
                        <option value="you_pay_more">You Pay 70%</option>
                        <option value="you_pay_all">You Pay All</option>
                    </select>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="broadcastFareDisplay" style="display: none;">
                    <div class="fare-label">Broadcast Fare</div>
                    <div class="fare-amount" id="broadcastFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="broadcastDistance">0 km</span>
                        <span id="broadcastTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="startBroadcastRideBtn">
                        <i class="fas fa-broadcast-tower"></i>
                        Start Broadcast
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- History Screen -->
    <div class="history-screen" id="historyScreen" style="display: none;">
        <div class="screen-header">
            <button class="back-btn" data-screen="home">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="screen-title">Ride History</div>
        </div>
        
        <div class="history-filters">
            <button class="filter-btn active" data-filter="all">All</button>
            <button class="filter-btn" data-filter="completed">Completed</button>
            <button class="filter-btn" data-filter="cancelled">Cancelled</button>
            <button class="filter-btn" data-filter="scheduled">Scheduled</button>
            <button class="filter-btn" data-filter="emergency">Emergency</button>
            <button class="filter-btn" data-filter="delivery">Delivery</button>
            <button class="filter-btn" data-filter="truck">Truck</button>
            <button class="filter-btn" data-filter="broadcast">Broadcast</button>
        </div>
        
        <div class="history-list" id="historyList">
            <!-- History items will be inserted here -->
        </div>
    </div>
    
    <!-- Account Screen -->
  <!-- Account Screen - Updated Wallet Section -->
<div class="account-screen" id="accountScreen" style="display: none;">
    <div class="screen-header">
        <button class="back-btn" data-screen="home">
            <i class="fas fa-arrow-left"></i>
        </button>
        <div class="screen-title">My Account</div>
    </div>
    
    <div class="account-header">
        <div class="account-avatar" id="accountAvatar">
            <i class="fas fa-user"></i>
        </div>
        <div class="account-name" id="accountName">Loading...</div>
        <div class="account-phone" id="accountPhone">Loading...</div>
    </div>
    
    <div class="account-stats">
        <div class="stat-card">
            <div class="stat-value" id="completedRides">0</div>
            <div class="stat-label">Completed Rides</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="cancelledRides">0</div>
            <div class="stat-label">Cancelled Rides</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="totalSpent">ZMW 0</div>
            <div class="stat-label">Total Spent</div>
        </div>
    </div>
    
    <!-- Updated Wallet Section -->
    <div class="account-section wallet-section">
        <div class="section-title">
            <i class="fas fa-wallet"></i>
            Wallet
        </div>
        
        <div class="wallet-balance">
            <div class="balance-label">Available Balance</div>
            <div class="balance-amount-large" id="accountBalance">ZMW 0.00</div>
        </div>
        
        <div class="wallet-actions-grid">
            <button class="wallet-action-btn primary" id="depositBtn">
                <div class="icon">
                    <i class="fas fa-plus-circle"></i>
                </div>
                <div class="text">Deposit</div>
            </button>
            
            <button class="wallet-action-btn danger" id="withdrawBtn">
                <div class="icon">
                    <i class="fas fa-minus-circle"></i>
                </div>
                <div class="text">Withdraw</div>
            </button>
            
            <button class="wallet-action-btn" id="transferBtn">
                <div class="icon">
                    <i class="fas fa-exchange-alt"></i>
                </div>
                <div class="text">Transfer</div>
            </button>
            
            <button class="wallet-action-btn" id="transactionsBtn">
                <div class="icon">
                    <i class="fas fa-history"></i>
                </div>
                <div class="text">History</div>
            </button>
        </div>
    </div>
    
    <!-- Rest of the account screen remains the same -->
    <div class="account-section">
        <div class="section-title">
            <i class="fas fa-gift"></i>
            Referral Program
        </div>
        
        <div class="referral-card">
            <div>Share your referral code and earn ZMW 25 for each friend's first ride</div>
            <div class="referral-code" id="referralCode">JUBEL-XXXX</div>
            <button class="btn btn-primary" id="shareReferralBtn">
                <i class="fas fa-share"></i>
                Share Code
            </button>
            <div class="referral-note">Your friend gets 50% off their first ride</div>
        </div>
    </div>
    
    <div class="account-section">
        <div class="section-title">
            <i class="fas fa-cog"></i>
            Settings
        </div>
        
        <div class="action-buttons">
            <button class="btn btn-secondary" id="updateProfileBtn">
                <i class="fas fa-user-edit"></i>
                Update Profile
            </button>
            <button class="btn btn-secondary" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i>
                Logout
            </button>
        </div>
    </div>
</div>

    <!-- Deposit Modal -->
<div class="modal-overlay" id="depositModal" style="display: none;">
    <div class="modal" style="max-width: 500px;">
        <div class="modal-header">
            <div class="modal-title">
                <i class="fas fa-plus-circle"></i>
                Deposit Money
            </div>
            <button class="modal-close" data-modal="deposit">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-content">
            <div class="form-group">
                <div class="form-label">Current Balance: <span id="depositCurrentBalance">ZMW 0.00</span></div>
            </div>
            
            <div class="amount-input-group">
                <label class="form-label">Amount to Deposit (ZMW)</label>
                <input type="number" class="form-control" id="depositAmount" placeholder="Enter amount" min="1" step="0.01">
                
                <div class="quick-amounts">
                    <div class="quick-amount" data-amount="50">ZMW 50</div>
                    <div class="quick-amount" data-amount="100">ZMW 100</div>
                    <div class="quick-amount" data-amount="200">ZMW 200</div>
                    <div class="quick-amount" data-amount="500">ZMW 500</div>
                    <div class="quick-amount" data-amount="1000">ZMW 1000</div>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Payment Method</label>
                <div class="payment-method-grid">
                    <div class="payment-method-option" data-method="mtn">
                        <div class="payment-method-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="payment-method-name">MTN Mobile Money</div>
                        <div class="payment-method-info">Instantly via MTN</div>
                    </div>
                    
                    <div class="payment-method-option" data-method="airtel">
                        <div class="payment-method-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="payment-method-name">Airtel Money</div>
                        <div class="payment-method-info">Instantly via Airtel</div>
                    </div>
                    
                    <div class="payment-method-option" data-method="zamtel">
                        <div class="payment-method-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="payment-method-name">Zamtel Kwacha</div>
                        <div class="payment-method-info">Instantly via Zamtel</div>
                    </div>
                    
                    <div class="payment-method-option" data-method="bank">
                        <div class="payment-method-icon">
                            <i class="fas fa-university"></i>
                        </div>
                        <div class="payment-method-name">Bank Transfer</div>
                        <div class="payment-method-info">1-2 business days</div>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Payment Details</label>
                <div id="paymentMethodDetails">
                    <!-- Payment method specific details will be inserted here -->
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-primary" id="confirmDepositBtn">
                    <i class="fas fa-check"></i>
                    Proceed with Deposit
                </button>
                <button class="btn btn-secondary" data-modal="deposit">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Withdraw Modal -->
<div class="modal-overlay" id="withdrawModal" style="display: none;">
    <div class="modal" style="max-width: 500px;">
        <div class="modal-header">
            <div class="modal-title">
                <i class="fas fa-minus-circle"></i>
                Withdraw Money
            </div>
            <button class="modal-close" data-modal="withdraw">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-content">
            <div class="form-group">
                <div class="form-label">Available Balance: <span id="withdrawCurrentBalance">ZMW 0.00</span></div>
            </div>
            
            <div class="amount-input-group">
                <label class="form-label">Amount to Withdraw (ZMW)</label>
                <input type="number" class="form-control" id="withdrawAmount" placeholder="Enter amount" min="1" step="0.01">
                
                <div class="quick-amounts">
                    <div class="quick-amount" data-amount="50">ZMW 50</div>
                    <div class="quick-amount" data-amount="100">ZMW 100</div>
                    <div class="quick-amount" data-amount="200">ZMW 200</div>
                    <div class="quick-amount" data-amount="500">ZMW 500</div>
                    <div class="quick-amount" data-amount="1000">ZMW 1000</div>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Withdrawal Method</label>
                <div class="payment-method-grid">
                    <div class="payment-method-option" data-method="mtn">
                        <div class="payment-method-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="payment-method-name">MTN Mobile Money</div>
                        <div class="payment-method-info">To your MTN number</div>
                    </div>
                    
                    <div class="payment-method-option" data-method="airtel">
                        <div class="payment-method-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="payment-method-name">Airtel Money</div>
                        <div class="payment-method-info">To your Airtel number</div>
                    </div>
                    
                    <div class="payment-method-option" data-method="zamtel">
                        <div class="payment-method-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="payment-method-name">Zamtel Kwacha</div>
                        <div class="payment-method-info">To your Zamtel number</div>
                    </div>
                    
                    <div class="payment-method-option" data-method="bank">
                        <div class="payment-method-icon">
                            <i class="fas fa-university"></i>
                        </div>
                        <div class="payment-method-name">Bank Account</div>
                        <div class="payment-method-info">To your bank account</div>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Withdrawal Details</label>
                <div id="withdrawMethodDetails">
                    <!-- Withdrawal method specific details will be inserted here -->
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-primary" id="confirmWithdrawBtn">
                    <i class="fas fa-check"></i>
                    Request Withdrawal
                </button>
                <button class="btn btn-secondary" data-modal="withdraw">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>
    
    <!-- Emergency Screen -->
    <div class="emergency-screen" id="emergencyScreen" style="display: none;">
        <div class="screen-header">
            <button class="back-btn" data-screen="home">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="screen-title">Emergency Services</div>
        </div>
        
        <div class="emergency-services">
            <div class="emergency-service police" data-type="police">
                <div class="emergency-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <div class="emergency-name">Police Ride</div>
                <div class="emergency-description">Emergency transport with police escort</div>
            </div>
            
            <div class="emergency-service fire" data-type="fire">
                <div class="emergency-icon">
                    <i class="fas fa-fire-extinguisher"></i>
                </div>
                <div class="emergency-name">Fire Brigade</div>
                <div class="emergency-description">Fire emergency response team</div>
            </div>
            
            <div class="emergency-service medical" data-type="medical">
                <div class="emergency-icon">
                    <i class="fas fa-ambulance"></i>
                </div>
                <div class="emergency-name">Hospital Ride</div>
                <div class="emergency-description">Medical emergency transport</div>
            </div>
            
            <div class="emergency-service" data-type="sos">
                <div class="emergency-icon" style="background: var(--error-red);">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="emergency-name">SOS Emergency</div>
                <div class="emergency-description">Immediate emergency assistance</div>
            </div>
        </div>
        
        <div class="emergency-note">
            <p><strong>Important:</strong> Only use emergency services for genuine emergencies. Misuse may result in penalties. In case of immediate danger, call 911 first.</p>
        </div>
    </div>
    
    <!-- Modals -->
    
    <!-- Payment Modal -->
    <div class="modal-overlay" id="paymentModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-credit-card"></i>
                    Select Payment Method
                </div>
                <button class="modal-close" data-modal="payment">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <div class="form-label">Available Balance: <span id="paymentBalance">ZMW 0.00</span></div>
                    <div class="form-label">Total Amount: <span id="paymentAmount">ZMW 0.00</span></div>
                </div>
                
                <!-- Referral Discount Section -->
                <div class="referral-discount-section" id="referralDiscountSection" style="display: none;">
                    <div class="section-header">
                        <i class="fas fa-gift"></i>
                        <span>Referral Discount (50% off)</span>
                    </div>
                    <div class="referral-input-group">
                        <input type="text" id="referralCodeInput" placeholder="Enter referral code">
                        <button id="applyReferralBtn" class="btn btn-orange">
                            <i class="fas fa-check"></i> Apply
                        </button>
                    </div>
                    <div id="referrerInfo" style="display: none; font-size: 12px; color: var(--success-green); margin-top: 5px;"></div>
                    <div class="discount-breakdown" style="margin-top: 10px;">
                        <div class="price-row">
                            <span>Original Fare:</span>
                            <span id="originalFareAmount">ZMW 0.00</span>
                        </div>
                        <div class="price-row">
                            <span>Discount:</span>
                            <span id="discountAmount" style="color: var(--success-green);">-ZMW 0.00</span>
                        </div>
                        <div class="price-row total">
                            <span>Final Fare:</span>
                            <span id="finalFareAmount" style="font-weight: bold;">ZMW 0.00</span>
                        </div>
                    </div>
                </div>
                
                <div class="payment-methods">
                    <div class="payment-method" data-payment="wallet">
                        <div class="payment-icon">
                            <i class="fas fa-wallet"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Jubel Wallet</div>
                            <div class="payment-info">Pay with your wallet balance</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-payment="mobile">
                        <div class="payment-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Mobile Money</div>
                            <div class="payment-info">Pay via MTN/Zamtel/Airtel</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-payment="cash">
                        <div class="payment-icon">
                            <i class="fas fa-money-bill"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Cash</div>
                            <div class="payment-info">Pay driver directly</div>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmPaymentBtn">
                        <i class="fas fa-check"></i>
                        Confirm Payment
                    </button>
                    <button class="btn btn-secondary" data-modal="payment">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Cancel Ride Modal -->
    <div class="modal-overlay" id="cancelModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-times-circle"></i>
                    Cancel Ride
                </div>
                <button class="modal-close" data-modal="cancel">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <div class="form-label">Please select a reason for cancellation:</div>
                </div>
                
                <div class="cancel-reasons">
                    <div class="cancel-reason" data-reason="driver_late">
                        <div class="reason-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="reason-text">Driver is taking too long</div>
                    </div>
                    
                    <div class="cancel-reason" data-reason="change_plans">
                        <div class="reason-icon">
                            <i class="fas fa-calendar-times"></i>
                        </div>
                        <div class="reason-text">Change of plans</div>
                    </div>
                    
                    <div class="cancel-reason" data-reason="found_alternative">
                        <div class="reason-icon">
                            <i class="fas fa-car"></i>
                        </div>
                        <div class="reason-text">Found alternative transport</div>
                    </div>
                    
                    <div class="cancel-reason" data-reason="emergency">
                        <div class="reason-icon">
                            <i class="fas fa-exclamation"></i>
                        </div>
                        <div class="reason-text">Emergency situation</div>
                    </div>
                    
                    <div class="cancel-reason" data-reason="other">
                        <div class="reason-icon">
                            <i class="fas fa-ellipsis-h"></i>
                        </div>
                        <div class="reason-text">Other reason</div>
                    </div>
                </div>
                
                <div class="form-group" id="otherReasonGroup" style="display: none;">
                    <label class="form-label">Please specify:</label>
                    <textarea class="form-control form-textarea" id="otherReason" placeholder="Enter your reason here..."></textarea>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-danger" id="confirmCancelBtn">
                        <i class="fas fa-times"></i>
                        Cancel Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="cancel">
                        Go Back
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Emergency Ride Modal -->
    <div class="modal-overlay" id="emergencyModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-ambulance"></i>
                    Emergency Ride Details
                </div>
                <button class="modal-close" data-modal="emergency">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content emergency-modal-content">
                <div class="form-group">
                    <div class="form-label" id="emergencyServiceType">Police Ride</div>
                </div>
                
                <!-- Emergency Reasons -->
                <div class="form-group">
                    <label class="form-label">Select Emergency Reason</label>
                    <div class="emergency-reasons">
                        <div class="emergency-reason" data-reason="accident">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-car-crash"></i>
                            </div>
                            <div class="emergency-reason-text">Accident</div>
                        </div>
                        
                        <div class="emergency-reason" data-reason="medical">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-heartbeat"></i>
                            </div>
                            <div class="emergency-reason-text">Medical Emergency</div>
                        </div>
                        
                        <div class="emergency-reason" data-reason="crime">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="emergency-reason-text">Crime/Assault</div>
                        </div>
                        
                        <div class="emergency-reason" data-reason="fire">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-fire"></i>
                            </div>
                            <div class="emergency-reason-text">Fire Emergency</div>
                        </div>
                        
                        <div class="emergency-reason" data-reason="other">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="emergency-reason-text">Other Emergency</div>
                        </div>
                    </div>
                    
                    <div class="emergency-reason-input" id="emergencyReasonOther" style="display: none;">
                        <label class="form-label">Please describe the emergency:</label>
                        <textarea class="form-control form-textarea" id="emergencyOtherReason" placeholder="Describe the emergency situation..."></textarea>
                    </div>
                </div>
                
                <!-- Location Inputs -->
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="emergencyPickup" placeholder="Pickup location" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="emergencyPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="emergencyDestination" placeholder="Destination" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="emergencyDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Emergency Stations -->
                <div class="form-group">
                    <label class="form-label">Select Nearest Emergency Station</label>
                    <div class="emergency-stations" id="emergencyStations">
                        <!-- Stations will be inserted here -->
                    </div>
                </div>
                
                <!-- User Location Details -->
                <div class="location-details">
                    <div class="location-detail-item">
                        <div class="location-detail-icon">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="location-detail-content">
                            <div class="location-detail-label">Your Location</div>
                            <div class="location-detail-value" id="emergencyUserLocation">Detecting location...</div>
                        </div>
                    </div>
                </div>
                
                <!-- Price Calculation -->
                <div class="price-calculation">
                    <div class="calculation-row">
                        <span>Base Emergency Fare:</span>
                        <span id="emergencyBaseFare">ZMW 100.00</span>
                    </div>
                    <div class="calculation-row">
                        <span>Distance to Service:</span>
                        <span id="emergencyDistance">0 km</span>
                    </div>
                    <div class="calculation-row">
                        <span>Estimated Time:</span>
                        <span id="emergencyTime">5 min</span>
                    </div>
                    <div class="calculation-row total">
                        <span>Total Fare:</span>
                        <span id="emergencyTotalFare">ZMW 100.00</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-danger" id="confirmEmergencyBtn">
                        <i class="fas fa-exclamation-triangle"></i>
                        Request Emergency Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="emergency">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- SOS Setup Modal -->
    <div class="modal-overlay" id="sosModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    SOS Emergency Setup
                </div>
                <button class="modal-close" data-modal="sos">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <label class="form-label">Primary Emergency Contact</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="sosContact1Name" placeholder="Contact name">
                        <input type="tel" class="form-control" id="sosContact1Phone" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Secondary Emergency Contact (Optional)</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="sosContact2Name" placeholder="Contact name">
                        <input type="tel" class="form-control" id="sosContact2Phone" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Emergency Message</label>
                    <textarea class="form-control form-textarea" id="sosMessage">
I need help! My current location and ride details will be shared with you.
                    </textarea>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="saveSOSBtn">
                        <i class="fas fa-save"></i>
                        Save SOS Setup
                    </button>
                    <button class="btn btn-secondary" data-modal="sos">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Transfer Money Modal -->
    <div class="modal-overlay" id="transferModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-exchange-alt"></i>
                    Transfer Money
                </div>
                <button class="modal-close" data-modal="transfer">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <div class="form-label">Available Balance: <span id="transferBalance">ZMW 0.00</span></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Recipient's Referral Code</label>
                    <input type="text" class="form-control" id="recipientCode" placeholder="Enter recipient's Jubel referral code">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Amount (ZMW)</label>
                    <input type="number" class="form-control" id="transferAmount" placeholder="Enter amount" min="1" step="0.01">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Message (Optional)</label>
                    <input type="text" class="form-control" id="transferMessage" placeholder="Add a message">
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmTransferBtn">
                        <i class="fas fa-paper-plane"></i>
                        Send Money
                    </button>
                    <button class="btn btn-secondary" data-modal="transfer">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
   <!-- Wallet Transactions Modal -->
<div class="modal-overlay" id="transactionsModal" style="display: none;">
    <div class="modal" style="max-width: 600px;">
        <div class="modal-header">
            <div class="modal-title">
                <i class="fas fa-history"></i>
                Wallet Transactions
            </div>
            <button class="modal-close" data-modal="transactions">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-content">
            <div class="wallet-summary" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px; background: #f9f9f9; border-radius: 8px;">
                <div>
                    <div style="font-size: 12px; color: #666;">Total Balance</div>
                    <div style="font-size: 24px; font-weight: 700; color: #FF6B35;" id="transactionsBalance">ZMW 0.00</div>
                </div>
                <div>
                    <div style="font-size: 12px; color: #666;">Total Transactions</div>
                    <div style="font-size: 18px; font-weight: 600; color: #333;" id="transactionsCount">0</div>
                </div>
            </div>
            
            <div class="transaction-filters" style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                <button class="filter-btn active" data-filter="all">All</button>
                <button class="filter-btn" data-filter="deposit">Deposits</button>
                <button class="filter-btn" data-filter="withdrawal">Withdrawals</button>
                <button class="filter-btn" data-filter="payment">Payments</button>
                <button class="filter-btn" data-filter="refund">Refunds</button>
                <button class="filter-btn" data-filter="transfer">Transfers</button>
                <button class="filter-btn" data-filter="referral">Referrals</button>
            </div>
            
            <div class="transaction-list" id="transactionsList">
                <!-- Transactions will be inserted here by JavaScript -->
                <div style="text-align: center; padding: 40px 20px; color: #999;">
                    <i class="fas fa-receipt" style="font-size: 48px; margin-bottom: 20px;"></i>
                    <div style="font-weight: 600; margin-bottom: 10px;">No transactions yet</div>
                    <div>Your transaction history will appear here</div>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-secondary" id="exportTransactionsBtn" style="padding: 10px 20px;">
                    <i class="fas fa-download"></i> Export as PDF
                </button>
            </div>
        </div>
    </div>
</div>
    
    <!-- Schedule Ride Modal -->
    <div class="modal-overlay" id="scheduleModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-calendar-alt"></i>
                    Schedule a Ride
                </div>
                <button class="modal-close" data-modal="schedule">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="schedulePickup" placeholder="Pickup location">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="schedulePickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="scheduleDestination" placeholder="Destination">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="scheduleDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- For Someone Else -->
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="scheduleForSomeone">
                        <span style="margin-left: 8px;">Booking for someone else</span>
                    </label>
                </div>
                
                <div class="form-group" id="someoneElseDetails" style="display: none;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="recipientName" placeholder="Recipient name">
                        <input type="tel" class="form-control" id="recipientPhone" placeholder="Recipient phone">
                    </div>
                </div>
                
                <div class="schedule-grid">
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-control" id="scheduleDate" min="">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Time</label>
                        <input type="time" class="form-control" id="scheduleTime">
                    </div>
                </div>
                
                <!-- Ride Type Selection for Schedule -->
                <div class="ride-type-selection" style="margin: 0 0 16px 0;">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                    </div>
                    <div class="ride-type-grid" id="scheduleRideTypeGrid">
                        <div class="ride-type-card economy" data-type="economy">
                            <div class="ride-type-icon">
                                <i class="fas fa-car-side"></i>
                            </div>
                            <div class="ride-type-name">Economy</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card selected" data-type="standard">
                            <div class="ride-type-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="ride-type-name">Standard</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card premium" data-type="premium">
                            <div class="ride-type-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="ride-type-name">Premium</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="scheduleFareDisplay" style="display: none;">
                    <div class="fare-label">Scheduled Ride Fare</div>
                    <div class="fare-amount" id="scheduleFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="scheduleDistance">0 km</span>
                        <span id="scheduleTimeEstimate">ETA: 0 min</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmScheduleBtn">
                        <i class="fas fa-calendar-check"></i>
                        Schedule Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="schedule">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Order for Someone Modal -->
    <div class="modal-overlay" id="orderForSomeoneModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-user-friends"></i>
                    Order for Someone Else
                </div>
                <button class="modal-close" data-modal="orderForSomeone">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="someonePickup" placeholder="Pickup location">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="someonePickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="someoneDestination" placeholder="Destination">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="someoneDestinationSuggestions"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Recipient Details</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="someoneName" placeholder="Full name">
                        <input type="tel" class="form-control" id="someonePhone" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Special Instructions (Optional)</label>
                    <textarea class="form-control form-textarea" id="someoneInstructions" placeholder="Any instructions for the driver..."></textarea>
                </div>
                
                <!-- Ride Type Selection -->
                <div class="ride-type-selection" style="margin: 0 0 16px 0;">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                    </div>
                    <div class="ride-type-grid" id="someoneRideTypeGrid">
                        <div class="ride-type-card economy" data-type="economy">
                            <div class="ride-type-icon">
                                <i class="fas fa-car-side"></i>
                            </div>
                            <div class="ride-type-name">Economy</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card selected" data-type="standard">
                            <div class="ride-type-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="ride-type-name">Standard</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card premium" data-type="premium">
                            <div class="ride-type-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="ride-type-name">Premium</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="someoneFareDisplay" style="display: none;">
                    <div class="fare-label">Estimated Fare</div>
                    <div class="fare-amount" id="someoneFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="someoneDistance">0 km</span>
                        <span id="someoneTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmSomeoneRideBtn">
                        <i class="fas fa-car"></i>
                        Request Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="orderForSomeone">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Share Ride Modal -->
    <div class="modal-overlay" id="shareRideModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-share-alt"></i>
                    Share Ride
                </div>
                <button class="modal-close" data-modal="shareRide">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="sharePickup" placeholder="Pickup location">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="sharePickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="shareDestination" placeholder="Destination">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shareDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Share Members Input -->
                <div class="form-group">
                    <label class="form-label">Add Friends by Referral Code</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" class="form-control" id="shareMemberInput" placeholder="Enter friend's referral code">
                        <button class="btn btn-secondary" id="addShareMemberBtn">
                            <i class="fas fa-plus"></i> Add
                        </button>
                    </div>
                </div>
                
                <!-- Share Members List -->
                <div class="form-group">
                    <div id="shareFriendsList" class="share-friends-list">
                        <!-- Share members will be inserted here -->
                    </div>
                </div>
                
                <!-- Share Calculations -->
                <div class="form-group" id="shareCalculations" style="display: none;">
                    <!-- Calculations will be inserted here -->
                </div>
                
                <!-- Ride Type Selection -->
                <div class="ride-type-selection" style="margin: 0 0 16px 0;">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                    </div>
                    <div class="ride-type-grid" id="shareRideTypeGrid">
                        <div class="ride-type-card economy" data-type="economy">
                            <div class="ride-type-icon">
                                <i class="fas fa-car-side"></i>
                            </div>
                            <div class="ride-type-name">Economy</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card selected" data-type="standard">
                            <div class="ride-type-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="ride-type-name">Standard</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card premium" data-type="premium">
                            <div class="ride-type-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="ride-type-name">Premium</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Estimated Fare: <span id="shareFareEstimate">ZMW 0.00</span></label>
                    <div class="price-calculation">
                        <div class="calculation-row">
                            <span>Your Share:</span>
                            <span id="yourShare">ZMW 0.00</span>
                        </div>
                        <div class="calculation-row">
                            <span>Friend's Share:</span>
                            <span id="friendShare">ZMW 0.00</span>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmShareRideBtn">
                        <i class="fas fa-user-friends"></i>
                        Share Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="shareRide">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Share Ride Invitation Modal -->
    <div class="modal-overlay" id="shareRideInvitationModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-users"></i>
                    Share Ride Invitation
                </div>
                <button class="modal-close" data-modal="shareRideInvitation">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="invitation-details" id="invitationDetails">
                    <!-- Invitation details will be inserted here -->
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" id="acceptShareInvitationBtn">
                        <i class="fas fa-check"></i>
                        Accept Invitation
                    </button>
                    <button class="btn btn-secondary" id="rejectShareInvitationBtn">
                        <i class="fas fa-times"></i>
                        Decline
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Update Profile Modal -->
    <div class="modal-overlay" id="updateProfileModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-user-edit"></i>
                    Update Profile
                </div>
                <button class="modal-close" data-modal="updateProfile">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <input type="text" class="form-control" id="updateName" placeholder="Your full name">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Phone Number</label>
                    <input type="tel" class="form-control" id="updatePhone" placeholder="Your phone number">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" class="form-control" id="updateEmail" placeholder="Your email address" readonly>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Home Address (Optional)</label>
                    <input type="text" class="form-control" id="updateHomeAddress" placeholder="Your home address">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Work Address (Optional)</label>
                    <input type="text" class="form-control" id="updateWorkAddress" placeholder="Your work address">
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="saveProfileBtn">
                        <i class="fas fa-save"></i>
                        Save Changes
                    </button>
                    <button class="btn btn-secondary" data-modal="updateProfile">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Loading...</div>
    </div>
    
    <!-- Search Loading Overlay -->
    <div id="searchLoading" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); z-index: 10000;">
        <i class="fas fa-spinner fa-spin"></i> Searching...
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Real-time Indicator -->
    <div class="real-time-indicator" id="realTimeIndicator">
        <i class="fas fa-sync-alt"></i>
        <span>Real-time updates active</span>
    </div>
    
    <!-- Sync Indicator -->
    <div class="sync-indicator" id="syncIndicator">
        <i class="fas fa-sync-alt sync-icon"></i>
        <span>Syncing...</span>
    </div>
    
    <!-- Schedule Countdown -->
    <div id="scheduleCountdown" style="display: none;"></div>
    
    <!-- External JavaScript Libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>             
    <script>
// ============================================
// FIREBASE CONFIGURATION AND INITIALIZATION
// ============================================
const firebaseConfig = {
    apiKey: "AIzaSyDEACX_P4c5q7djJAcA0I7Lk7leO2TlQ74",
    authDomain: "jubel-13e1a.firebaseapp.com",
    databaseURL: "https://jubel-13e1a-default-rtdb.firebaseio.com",
    projectId: "jubel-13e1a",
    storageBucket: "jubel-13e1a.firebasestorage.app",
    messagingSenderId: "882241095445",
    appId: "1:882241095445:web:ee9ca40fddd008ca910b1c",
    measurementId: "G-J5JPKL6B5F"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const auth = firebase.auth();
const storage = firebase.storage();

// ============================================
// GLOBAL STATE MANAGEMENT
// ============================================
const AppState = {
    currentUser: null,
    userData: null,
    currentRide: null,
    activeScreen: 'home',
    activeService: 'car',
    walletBalance: 0,
    userLocation: null,
    currentCity: null,
    detectedCity: null,
    selectedRideType: 'standard',
    selectedVehicle: null,
    destination: null,
    pickup: null,
    rideFare: 0,
    driverLocation: null,
    chatMessages: [],
    scheduledRides: [],
    emergencyMode: false,
    sosConfig: null,
    searchCache: new Map(),
    lastSearchTime: 0,
    notifications: [],
    unreadNotifications: 0,
    searchHistory: [],
    broadcastRecipients: [],
    emergencyStations: {
        police: [],
        fire: [],
        medical: []
    },
    realtimeListeners: [],
    rideTypes: {
        economy: { base: 15, perKm: 2.5, multiplier: 0.8, min: 10, icon: 'fa-car-side' },
        standard: { base: 20, perKm: 3.0, multiplier: 1.0, min: 15, icon: 'fa-car' },
        premium: { base: 30, perKm: 4.0, multiplier: 1.5, min: 25, icon: 'fa-crown' }
    },
    emergencyServices: {
        police: { base: 150, perKm: 5.0, multiplier: 2.0, min: 100 },
        fire: { base: 200, perKm: 6.0, multiplier: 2.5, min: 150 },
        medical: { base: 180, perKm: 5.5, multiplier: 2.2, min: 120 }
    },
    deliveryTypes: {
        standard: { base: 25, perKm: 2.0, multiplier: 1.0 },
        express: { base: 40, perKm: 3.0, multiplier: 1.5 },
        sameDay: { base: 60, perKm: 4.0, multiplier: 2.0 }
    },
    truckTypes: {
        pickup: { base: 80, perKm: 5.0, multiplier: 1.0, capacity: '1.5 tons' },
        light: { base: 120, perKm: 6.0, multiplier: 1.2, capacity: '3 tons' },
        medium: { base: 200, perKm: 8.0, multiplier: 1.5, capacity: '7 tons' },
        heavy: { base: 350, perKm: 12.0, multiplier: 2.0, capacity: '15 tons' }
    },
    lastPriceUpdate: 0,
    cityDetectionAttempts: 0,
    maxCityDetectionAttempts: 5,
    isSyncing: false,
    syncInterval: null,
    emergencyReason: null,
    selectedEmergencyStation: null,
    activeBroadcast: null,
    typingTimeout: null,
    driverTyping: false,
    locationManagement: {
        isEditingPickup: false,
        currentPickupInputId: null,
        pickupSearchResults: [],
        cityBounds: null,
        cityPolygon: null,
        userDetectedAddress: null
    },
    activeScheduledTimer: null,
    rideRequestPulsingIcons: {
        car: null,
        bike: null,
        truck: null
    },
    shareRideFriends: [],
    maxShareFriends: 4,
    routeDirections: null,
    pendingRideData: null,
    referralDiscountApplied: false,
    referralCodeUsed: null,
    referralOwnerName: null,
    shareRideInvitations: new Map(),
    broadcastInvitations: new Map(),
    paymentPendingMembers: new Set(),
    rideSplitDetails: null,
    activeRoute: null,
    activeFilter: 'all',
    lastSearchQuery: null,
    chatOpen: false,
    notificationsOpen: false,
    mapInitialized: false,
    rideStops: [],
    shoppingCategories: {
        restaurant: { icon: 'fa-utensils', name: 'Restaurants' },
        pharmacy: { icon: 'fa-prescription-bottle-medical', name: 'Pharmacies' },
        supermarket: { icon: 'fa-shopping-cart', name: 'Supermarkets' },
        mall: { icon: 'fa-store', name: 'Shopping Malls' }
    },
    scheduledCountdowns: new Map(),
    splitRideConfig: {
        maxFriends: 4,
        splitOptions: ['equal', 'you_pay_more', 'you_pay_all']
    },
    notificationPreferences: {
        rideUpdates: true,
        paymentUpdates: true,
        referralEarnings: true,
        splitRideInvites: true,
        broadcastInvites: true
    }
};

// ============================================
// MAP MANAGEMENT
// ============================================
let map = null;
let currentLocationMarker = null;
let pickupMarker = null;
let destinationMarker = null;
let driverMarker = null;
let routeLayer = null;
let emergencyMarkers = [];
let emergencyStationMarkers = [];
let cityBoundaryLayer = null;
let routePolyline = null;
let pulsingIcon = null;

// ============================================
// ENHANCED LOCATION SEARCH ENGINE
// ============================================
const EnhancedSearchEngine = {
    cache: new Map(),
    lastSearch: 0,
    debounceTimer: null,
    searchHistory: [],
    maxHistoryItems: 20,
    activeSearches: new Set(),
    recentLocations: [],
    
    init: function() {
        this.loadSearchHistory();
        this.loadRecentLocations();
        console.log('Enhanced Search Engine initialized');
    },
    
    loadSearchHistory: function() {
        try {
            const history = localStorage.getItem('jubel_search_history');
            if (history) {
                this.searchHistory = JSON.parse(history);
                console.log(`Loaded ${this.searchHistory.length} search history items`);
            }
        } catch (error) {
            console.error('Error loading search history:', error);
            this.searchHistory = [];
        }
    },
    
    saveSearchHistory: function() {
        try {
            localStorage.setItem('jubel_search_history', JSON.stringify(this.searchHistory));
        } catch (error) {
            console.error('Error saving search history:', error);
        }
    },
    
    loadRecentLocations: function() {
        try {
            const recent = localStorage.getItem('jubel_recent_locations');
            if (recent) {
                this.recentLocations = JSON.parse(recent);
                console.log(`Loaded ${this.recentLocations.length} recent locations`);
            }
        } catch (error) {
            console.error('Error loading recent locations:', error);
            this.recentLocations = [];
        }
    },
    
    saveRecentLocations: function() {
        try {
            localStorage.setItem('jubel_recent_locations', JSON.stringify(this.recentLocations));
        } catch (error) {
            console.error('Error saving recent locations:', error);
        }
    },
    
    addToHistory: function(query, location, type) {
        const historyItem = {
            id: Date.now().toString(),
            query: query,
            location: location,
            type: type,
            timestamp: Date.now(),
            city: AppState.currentCity,
            coordinates: { lat: location.lat, lng: location.lng }
        };
        
        // Remove duplicates
        this.searchHistory = this.searchHistory.filter(item => 
            !(item.query === query && item.type === type && 
              Math.abs(item.coordinates.lat - location.lat) < 0.001 && 
              Math.abs(item.coordinates.lng - location.lng) < 0.001)
        );
        
        this.searchHistory.unshift(historyItem);
        
        if (this.searchHistory.length > this.maxHistoryItems) {
            this.searchHistory = this.searchHistory.slice(0, this.maxHistoryItems);
        }
        
        this.saveSearchHistory();
        return historyItem;
    },
    
    addToRecentLocations: function(location) {
        const recentItem = {
            id: Date.now().toString(),
            name: location.name || 'Location',
            address: location.address || location.fullAddress || '',
            coordinates: { lat: location.lat, lng: location.lng },
            timestamp: Date.now(),
            city: AppState.currentCity,
            type: location.category || 'general'
        };
        
        // Remove duplicates
        this.recentLocations = this.recentLocations.filter(item => 
            !(Math.abs(item.coordinates.lat - location.lat) < 0.001 && 
              Math.abs(item.coordinates.lng - location.lng) < 0.001)
        );
        
        this.recentLocations.unshift(recentItem);
        
        if (this.recentLocations.length > 15) {
            this.recentLocations = this.recentLocations.slice(0, 15);
        }
        
        this.saveRecentLocations();
        return recentItem;
    },
    
    search: async function(query, type = 'destination', location = null, forceCity = null) {
        const searchId = `${Date.now()}-${Math.random()}`;
        this.activeSearches.add(searchId);
        
        try {
            const city = forceCity || AppState.currentCity;
            if (!city) {
                console.warn('No city detected for search');
                EnhancedUIUpdater.showToast('Please wait while we detect your city', 'warning');
                return [];
            }
            
            const cacheKey = `${query.toLowerCase()}-${type}-${city}`;
            
            if (this.cache.has(cacheKey)) {
                const cached = this.cache.get(cacheKey);
                if (Date.now() - cached.timestamp < 300000) {
                    console.log('Returning cached search results');
                    return this.filterByCityBounds(cached.results, city);
                }
            }
            
            console.log(`Searching for "${query}" in ${city}, type: ${type}`);
            
            const bounds = this.getCityBounds(city);
            let searchUrl;
            
            if (bounds) {
                const [west, south, east, north] = bounds;
                searchUrl = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=20&bounded=1&viewbox=${west},${south},${east},${north}&countrycodes=zm&addressdetails=1&namedetails=0&extratags=0`;
            } else {
                searchUrl = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}+${encodeURIComponent(city)}+Zambia&format=json&limit=20&countrycodes=zm&addressdetails=1`;
            }
            
            const response = await fetch(searchUrl, {
                headers: {
                    'User-Agent': 'JubelRideApp/2.0',
                    'Accept': 'application/json'
                }
            });
            
            if (!response.ok) {
                throw new Error(`Search failed: ${response.status} ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log(`Received ${data.length} results for "${query}"`);
            
            const results = this.processAndFilterResults(data, location, city, type);
            
            this.cache.set(cacheKey, {
                results: results,
                timestamp: Date.now(),
                query: query,
                city: city
            });
            
            if (type === 'destination' && results.length > 0) {
                this.addToHistory(query, results[0], type);
            }
            
            this.lastSearch = Date.now();
            
            return results;
        } catch (error) {
            console.error('Search error:', error);
            
            // Try alternative search approach
            if (AppState.currentCity) {
                return await this.alternativeSearch(query, AppState.currentCity);
            }
            
            EnhancedUIUpdater.showToast('Search service temporarily unavailable', 'warning');
            return [];
        } finally {
            this.activeSearches.delete(searchId);
        }
    },
    
    alternativeSearch: async function(query, city) {
        try {
            const alternativeUrl = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}+${encodeURIComponent(city)}+Zambia&format=json&limit=10&countrycodes=zm`;
            
            const response = await fetch(alternativeUrl);
            const data = await response.json();
            
            return data.map(place => ({
                id: place.place_id,
                name: place.display_name.split(',')[0],
                address: place.display_name,
                lat: parseFloat(place.lat),
                lng: parseFloat(place.lon),
                type: place.type || 'unknown',
                distance: 0,
                city: city,
                category: this.categorizePlace(place)
            }));
        } catch (error) {
            console.error('Alternative search error:', error);
            return [];
        }
    },
    
    processAndFilterResults: function(data, location, city, type) {
        if (!data || data.length === 0) return [];
        
        const cityLower = city.toLowerCase();
        const processedResults = [];
        
        data.forEach(place => {
            try {
                const address = place.address || {};
                const placeCity = address.city || address.town || address.village || address.municipality;
                
                // Always include results, but prioritize city matches
                let cityMatchScore = 0;
                if (placeCity && placeCity.toLowerCase().includes(cityLower)) {
                    cityMatchScore = 1;
                }
                
                let distance = 0;
                if (location) {
                    distance = this.calculateDistance(
                        location.lat, location.lng,
                        parseFloat(place.lat), parseFloat(place.lon)
                    );
                }
                
                const result = {
                    id: place.place_id || `${place.lat}-${place.lon}`,
                    name: place.display_name.split(',')[0] || place.name || 'Location',
                    address: this.formatAddress(place, city),
                    fullAddress: place.display_name,
                    lat: parseFloat(place.lat),
                    lng: parseFloat(place.lon),
                    type: place.type || place.class || 'unknown',
                    importance: place.importance || 0,
                    distance: distance,
                    city: placeCity || city,
                    placeType: place.type,
                    category: this.categorizePlace(place),
                    relevance: this.calculateRelevance(place, location, city, type),
                    cityMatchScore: cityMatchScore,
                    isVerified: this.isVerifiedLocation(place)
                };
                
                processedResults.push(result);
            } catch (error) {
                console.error('Error processing search result:', error);
            }
        });
        
        return processedResults
            .sort((a, b) => {
                // First prioritize city matches
                if (a.cityMatchScore !== b.cityMatchScore) {
                    return b.cityMatchScore - a.cityMatchScore;
                }
                
                // Then by distance if location provided
                if (location && a.distance !== b.distance) {
                    return a.distance - b.distance;
                }
                
                // Then by relevance
                if (a.relevance !== b.relevance) {
                    return b.relevance - a.relevance;
                }
                
                // Finally by importance
                return b.importance - a.importance;
            })
            .slice(0, 10);
    },
    
    filterByCityBounds: function(results, city) {
        const bounds = this.getCityBounds(city);
        if (!bounds) return results;
        
        const [west, south, east, north] = bounds;
        
        return results.filter(result => {
            return result.lng >= west && result.lng <= east && 
                   result.lat >= south && result.lat <= north;
        });
    },
    
    calculateRelevance: function(place, location, city, type) {
        let score = (place.importance || 0) * 0.5;
        
        if (city) {
            const address = place.address || {};
            const placeCity = address.city || address.town || address.village;
            if (placeCity && placeCity.toLowerCase().includes(city.toLowerCase())) {
                score += 0.4;
            }
        }
        
        if (location) {
            const distance = this.calculateDistance(
                location.lat, location.lng,
                parseFloat(place.lat), parseFloat(place.lon)
            );
            
            if (distance < 1) score += 0.3;
            else if (distance < 3) score += 0.2;
            else if (distance < 5) score += 0.1;
        }
        
        if (type === 'destination') {
            if (place.type === 'restaurant' || place.type === 'hotel' || 
                place.type === 'mall' || place.type === 'supermarket') {
                score += 0.2;
            }
        }
        
        return Math.min(score, 1.0);
    },
    
    formatAddress: function(place, currentCity) {
        const address = place.address || {};
        const parts = [];
        
        if (address.house_number || address.housenumber) {
            parts.push(address.house_number || address.housenumber);
        }
        
        if (address.road) {
            parts.push(address.road);
        }
        
        if (address.suburb || address.neighbourhood) {
            parts.push(address.suburb || address.neighbourhood);
        }
        
        if (address.city || address.town) {
            parts.push(address.city || address.town);
        }
        
        if (parts.length === 0) {
            return place.display_name.split(',').slice(0, 3).join(',').trim();
        }
        
        return parts.join(', ');
    },
    
    categorizePlace: function(place) {
        const type = (place.type || place.class || '').toLowerCase();
        const name = (place.display_name || '').toLowerCase();
        
        if (type.includes('restaurant') || type.includes('cafe') || type.includes('fast_food') ||
            name.includes('pizza') || name.includes('nando') || name.includes('hungry lion')) {
            return 'restaurant';
        } else if (type.includes('pharmacy') || type.includes('chemist')) {
            return 'pharmacy';
        } else if (type.includes('supermarket') || name.includes('shoprite') || 
                  name.includes('pick n pay') || name.includes('spar')) {
            return 'supermarket';
        } else if (type.includes('mall') || type.includes('shopping_centre')) {
            return 'mall';
        } else if (type.includes('hospital') || type.includes('clinic')) {
            return 'medical';
        } else if (type.includes('bank') || type.includes('atm')) {
            return 'bank';
        } else {
            return 'general';
        }
    },
    
    isVerifiedLocation: function(place) {
        const verifiedTypes = [
            'restaurant', 'hotel', 'mall', 'supermarket', 'bank', 'hospital',
            'clinic', 'pharmacy', 'police', 'fire_station'
        ];
        
        const type = (place.type || place.class || '').toLowerCase();
        return verifiedTypes.some(verifiedType => type.includes(verifiedType));
    },
    
    calculateDistance: function(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = this.toRad(lat2 - lat1);
        const dLon = this.toRad(lon2 - lon1);
        const a = 
            Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(this.toRad(lat1)) * Math.cos(this.toRad(lat2)) * 
            Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    },
    
    toRad: function(value) {
        return value * Math.PI / 180;
    },
    
    getCityBounds: function(cityName) {
        const cityBounds = {
            'Lusaka': [27.8, -15.8, 28.8, -15.2],
            'Ndola': [28.5, -13.1, 28.8, -12.9],
            'Kitwe': [27.9, -13.1, 28.4, -12.7],
            'Kabwe': [28.3, -14.6, 28.6, -14.3],
            'Livingstone': [25.7, -18.0, 26.0, -17.7],
            'Chipata': [32.5, -13.8, 32.8, -13.6],
            'Chingola': [27.8, -12.8, 27.9, -12.4],
            'Mufulira': [28.1, -12.7, 28.3, -12.5],
            'Luanshya': [28.3, -13.2, 28.5, -13.0],
            'Kasama': [31.1, -10.3, 31.3, -10.1],
            'Solwezi': [26.3, -12.3, 26.5, -12.1],
            'Mazabuka': [27.7, -15.9, 27.9, -15.7]
        };
        
        return cityBounds[cityName] || null;
    },
    
    searchShoppingLocations: async function(category, city) {
        let queries = [];
        
        switch(category) {
            case 'restaurant':
                queries = ['Pizza', 'Nandos', 'Hungry Lion', 'restaurant'];
                break;
            case 'pharmacy':
                queries = ['pharmacy', 'chemist', 'drugstore'];
                break;
            case 'supermarket':
                queries = ['supermarket', 'Shoprite', 'Pick n Pay', 'SPAR'];
                break;
            case 'mall':
                queries = ['shopping mall', 'mall', 'shopping centre'];
                break;
        }
        
        const allResults = [];
        
        for (const query of queries) {
            try {
                const results = await this.search(query, 'shopping', AppState.userLocation, city);
                allResults.push(...results.filter(r => r.category === category));
            } catch (error) {
                console.error(`Error searching ${query}:`, error);
            }
        }
        
        // Remove duplicates and sort by distance
        const uniqueResults = [];
        const seenIds = new Set();
        
        allResults.forEach(result => {
            if (!seenIds.has(result.id)) {
                seenIds.add(result.id);
                uniqueResults.push(result);
            }
        });
        
        return uniqueResults.sort((a, b) => a.distance - b.distance);
    },
    
    searchEmergencyStations: async function(type, city) {
        let queries = [];
        
        switch(type) {
            case 'police':
                queries = ['police station', 'police'];
                break;
            case 'fire':
                queries = ['fire station', 'fire brigade'];
                break;
            case 'medical':
                queries = ['hospital', 'clinic', 'medical centre'];
                break;
        }
        
        const allResults = [];
        
        for (const query of queries) {
            try {
                const results = await this.search(query, 'emergency', AppState.userLocation, city);
                allResults.push(...results);
            } catch (error) {
                console.error(`Error searching ${query}:`, error);
            }
        }
        
        // Remove duplicates and sort by distance
        const uniqueResults = [];
        const seenIds = new Set();
        
        allResults.forEach(result => {
            if (!seenIds.has(result.id)) {
                seenIds.add(result.id);
                result.emergencyType = type;
                uniqueResults.push(result);
            }
        });
        
        return uniqueResults.sort((a, b) => a.distance - b.distance);
    },
    
    clearCache: function() {
        this.cache.clear();
        console.log('Search cache cleared');
    },
    
    getRecentDestinations: function(limit = 10) {
        return this.searchHistory
            .filter(item => item.type === 'destination')
            .slice(0, limit);
    },
    
    validateCoordinatesInCity: function(lat, lng, city) {
        const bounds = this.getCityBounds(city);
        if (!bounds) return true;
        
        const [west, south, east, north] = bounds;
        return lng >= west && lng <= east && lat >= south && lat <= north;
    }
};

// ============================================
// ENHANCED LOCATION MANAGER
// ============================================
EnhancedLocationManager = {
    // Properties
    searchTimeout: null,
    activeSearchInput: null,
    
    // Main Initialization
    init: function() {
        console.log('Enhanced Location Manager initialized');
        this.setupLocationInputs();
        this.setupSearchSuggestions();
        this.setupEditablePickup();
    },
    
    // Setup Functions
    setupEditablePickup: function() {
        // Make all pickup inputs editable by default
        const pickupInputs = document.querySelectorAll('input[id*="pickup"], input[id*="Pickup"]');
        
        pickupInputs.forEach(input => {
            // Remove readonly attribute
            input.removeAttribute('readonly');
            
            // Add clear button functionality
            this.addClearButton(input);
            
            // Add current location button
            this.addCurrentLocationButton(input);
        });
    },
    
    addCurrentLocationButton: function(input) {
        const parent = input.parentNode;
        if (!parent.querySelector('.current-location-btn')) {
            const currentLocationBtn = document.createElement('button');
            currentLocationBtn.type = 'button';
            currentLocationBtn.className = 'current-location-btn';
            currentLocationBtn.innerHTML = '<i class="fas fa-location-arrow"></i>';
            currentLocationBtn.style.cssText = `
                position: absolute;
                right: 40px;
                top: 50%;
                transform: translateY(-50%);
                background: none;
                border: none;
                color: #FF6B35;
                cursor: pointer;
                font-size: 16px;
                z-index: 10;
            `;
            
            currentLocationBtn.addEventListener('click', () => {
                getCurrentLocation();
            });
            
            parent.style.position = 'relative';
            parent.appendChild(currentLocationBtn);
        }
    },
    
    addClearButton: function(input) {
        if (!input.nextElementSibling?.classList.contains('clear-input-btn')) {
            const clearBtn = document.createElement('button');
            clearBtn.type = 'button';
            clearBtn.className = 'clear-input-btn';
            clearBtn.innerHTML = '<i class="fas fa-times"></i>';
            clearBtn.style.cssText = `
                position: absolute;
                right: 10px;
                top: 50%;
                transform: translateY(-50%);
                background: none;
                border: none;
                color: #999;
                cursor: pointer;
                display: none;
                z-index: 10;
            `;
            
            const parent = input.parentNode;
            parent.style.position = 'relative';
            parent.appendChild(clearBtn);
            
            clearBtn.addEventListener('click', () => {
                input.value = '';
                clearBtn.style.display = 'none';
                
                // Clear pickup location in state if this is the main pickup input
                if (input.id === 'pickupLocation') {
                    AppState.pickup = null;
                    if (pickupMarker) {
                        map.removeLayer(pickupMarker);
                        pickupMarker = null;
                    }
                }
            });
            
            input.addEventListener('input', () => {
                clearBtn.style.display = input.value ? 'block' : 'none';
            });
        }
    },
    
    setupLocationInputs: function() {
        // Setup pickup inputs
        const pickupInputs = document.querySelectorAll('input[id*="pickup"], input[id*="Pickup"]');
        pickupInputs.forEach(input => {
            this.setupPickupInput(input);
        });
        
        // Setup destination inputs
        const destinationInputs = document.querySelectorAll('input[id*="destination"], input[id*="Destination"]');
        destinationInputs.forEach(input => {
            this.setupDestinationInput(input);
        });
        
        // Setup shopping categories
        this.setupShoppingCategories();
    },
    
    setupSearchSuggestions: function() {
        // Create global suggestion container if it doesn't exist
        if (!document.getElementById('globalSuggestionsContainer')) {
            const container = document.createElement('div');
            container.id = 'globalSuggestionsContainer';
            container.className = 'suggestions-container';
            container.style.cssText = `
                position: fixed;
                background: white;
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                max-height: 400px;
                overflow-y: auto;
                z-index: 9999;
                display: none;
                width: 300px;
            `;
            document.body.appendChild(container);
        }
    },
    
    // Input Setup Functions
    setupPickupInput: function(inputElement) {
        const inputId = inputElement.id;
        
        inputElement.addEventListener('focus', () => {
            this.handlePickupInputFocus(inputId);
        });
        
        inputElement.addEventListener('input', (e) => {
            this.handlePickupInputChange(inputId, e.target.value);
        });
        
        inputElement.addEventListener('blur', () => {
            setTimeout(() => {
                this.handlePickupInputBlur(inputId);
            }, 200);
        });
        
        // Add clear button
        if (!inputElement.nextElementSibling?.classList.contains('clear-input-btn')) {
            const clearBtn = document.createElement('button');
            clearBtn.type = 'button';
            clearBtn.className = 'clear-input-btn';
            clearBtn.innerHTML = '<i class="fas fa-times"></i>';
            clearBtn.style.cssText = `
                position: absolute;
                right: 10px;
                top: 50%;
                transform: translateY(-50%);
                background: none;
                border: none;
                color: #999;
                cursor: pointer;
                display: none;
                z-index: 10;
            `;
            
            inputElement.parentNode.style.position = 'relative';
            inputElement.parentNode.appendChild(clearBtn);
            
            clearBtn.addEventListener('click', () => {
                inputElement.value = '';
                clearBtn.style.display = 'none';
                this.clearPickupLocation(inputId);
            });
            
            inputElement.addEventListener('input', () => {
                clearBtn.style.display = inputElement.value ? 'block' : 'none';
            });
        }
    },
    
    setupDestinationInput: function(inputElement) {
        const inputId = inputElement.id;
        
        inputElement.addEventListener('focus', () => {
            this.handleDestinationInputFocus(inputId);
        });
        
        inputElement.addEventListener('input', (e) => {
            this.handleDestinationInputChange(inputId, e.target.value);
        });
        
        inputElement.addEventListener('blur', () => {
            setTimeout(() => {
                this.handleDestinationInputBlur(inputId);
            }, 200);
        });
        
        // Add clear button
        if (!inputElement.nextElementSibling?.classList.contains('clear-input-btn')) {
            const clearBtn = document.createElement('button');
            clearBtn.type = 'button';
            clearBtn.className = 'clear-input-btn';
            clearBtn.innerHTML = '<i class="fas fa-times"></i>';
            clearBtn.style.cssText = `
                position: absolute;
                right: 10px;
                top: 50%;
                transform: translateY(-50%);
                background: none;
                border: none;
                color: #999;
                cursor: pointer;
                display: none;
                z-index: 10;
            `;
            
            inputElement.parentNode.style.position = 'relative';
            inputElement.parentNode.appendChild(clearBtn);
            
            clearBtn.addEventListener('click', () => {
                inputElement.value = '';
                clearBtn.style.display = 'none';
                this.clearDestinationLocation(inputId);
            });
            
            inputElement.addEventListener('input', () => {
                clearBtn.style.display = inputElement.value ? 'block' : 'none';
            });
        }
    },
    
    setupShoppingCategories: function() {
        // Create shopping category selector if it doesn't exist
        if (!document.getElementById('shoppingCategorySelector')) {
            const container = document.createElement('div');
            container.id = 'shoppingCategorySelector';
            container.className = 'shopping-category-selector';
            container.style.cssText = `
                display: flex;
                gap: 10px;
                margin-bottom: 15px;
                flex-wrap: wrap;
            `;
            
            Object.entries(AppState.shoppingCategories).forEach(([key, category]) => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'category-btn';
                button.dataset.category = key;
                button.innerHTML = `
                    <i class="fas ${category.icon}"></i>
                    <span>${category.name}</span>
                `;
                button.style.cssText = `
                    flex: 1;
                    min-width: 120px;
                    padding: 10px;
                    background: white;
                    border: 1px solid #e0e0e0;
                    border-radius: 8px;
                    cursor: pointer;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    gap: 5px;
                `;
                
                button.addEventListener('click', () => {
                    this.handleShoppingCategoryClick(key);
                });
                
                container.appendChild(button);
            });
            
            const shopNameInput = document.getElementById('shopName');
            if (shopNameInput && shopNameInput.parentNode) {
                shopNameInput.parentNode.insertBefore(container, shopNameInput);
            }
        }
    },
    
    // Event Handlers - Pickup
    handlePickupInputFocus: function(inputId) {
        const input = document.getElementById(inputId);
        if (input) {
            input.parentElement.classList.add('active');
            this.showRecentLocations(inputId, 'pickup');
        }
    },
    
    handlePickupInputChange: async function(inputId, value) {
        if (!value.trim() || value.length < 2) {
            this.hideSuggestions();
            return;
        }
        
        clearTimeout(this.searchTimeout);
        this.searchTimeout = setTimeout(async () => {
            await this.searchLocations(inputId, value, 'pickup');
        }, 300);
    },
    
    handlePickupInputBlur: function(inputId) {
        const input = document.getElementById(inputId);
        if (input) {
            input.parentElement.classList.remove('active');
        }
        
        setTimeout(() => {
            this.hideSuggestions();
        }, 200);
    },
    
    // Event Handlers - Destination
    handleDestinationInputFocus: function(inputId) {
        const input = document.getElementById(inputId);
        if (input) {
            input.parentElement.classList.add('active');
            this.showRecentLocations(inputId, 'destination');
        }
    },
    
    handleDestinationInputChange: async function(inputId, value) {
        if (!value.trim() || value.length < 2) {
            this.hideSuggestions();
            return;
        }
        
        clearTimeout(this.searchTimeout);
        this.searchTimeout = setTimeout(async () => {
            await this.searchLocations(inputId, value, 'destination');
        }, 300);
    },
    
    handleDestinationInputBlur: function(inputId) {
        const input = document.getElementById(inputId);
        if (input) {
            input.parentElement.classList.remove('active');
        }
        
        setTimeout(() => {
            this.hideSuggestions();
        }, 200);
    },
    
    // Shopping Category Handler
    handleShoppingCategoryClick: async function(category) {
        if (!AppState.currentCity) {
            EnhancedUIUpdater.showToast('Please wait while we detect your city', 'warning');
            return;
        }
        
        EnhancedUIUpdater.showLoading(`Finding ${AppState.shoppingCategories[category].name}...`);
        
        try {
            const results = await EnhancedSearchEngine.searchShoppingLocations(category, AppState.currentCity);
            
            if (results.length > 0) {
                this.showShoppingLocationsPopup(category, results);
            } else {
                EnhancedUIUpdater.showToast(`No ${AppState.shoppingCategories[category].name} found in your city`, 'info');
            }
        } catch (error) {
            console.error('Error searching shopping locations:', error);
            EnhancedUIUpdater.showToast('Error searching locations', 'error');
        } finally {
            EnhancedUIUpdater.hideLoading();
        }
    },
    
    // Search Functions
    async searchLocations(inputId, query, type) {
        if (!AppState.currentCity) {
            EnhancedUIUpdater.showToast('Please wait while we detect your city', 'warning');
            return;
        }
        
        this.activeSearchInput = inputId;
        const input = document.getElementById(inputId);
        
        if (!input) return;
        
        input.parentElement.classList.add('searching');
        
        try {
            const results = await EnhancedSearchEngine.search(
                query,
                type,
                AppState.userLocation,
                AppState.currentCity
            );
            
            this.showSearchSuggestions(input, results, type);
            
        } catch (error) {
            console.error('Search error:', error);
            EnhancedUIUpdater.showToast('Search failed. Please try again.', 'error');
        } finally {
            input.parentElement.classList.remove('searching');
        }
    },
    
    // Suggestion Display Functions
    showSearchSuggestions: function(input, results, type) {
        const container = document.getElementById('globalSuggestionsContainer');
        if (!container) return;
        
        // Position container below input
        const rect = input.getBoundingClientRect();
        container.style.top = `${rect.bottom + window.scrollY + 5}px`;
        container.style.left = `${rect.left + window.scrollX}px`;
        container.style.width = `${rect.width}px`;
        
        let html = '';
        
        if (results.length === 0) {
            html = `
                <div style="padding: 20px; text-align: center; color: #666;">
                    <i class="fas fa-search" style="font-size: 24px; margin-bottom: 10px; color: #ccc;"></i>
                    <div>No results found in ${AppState.currentCity}</div>
                </div>
            `;
        } else {
            results.forEach((result, index) => {
                let icon = 'fa-map-marker-alt';
                let iconColor = '#FF6B35';
                
                if (result.category === 'restaurant') {
                    icon = 'fa-utensils';
                    iconColor = '#FFC107';
                } else if (result.category === 'pharmacy') {
                    icon = 'fa-prescription-bottle-medical';
                    iconColor = '#2196F3';
                } else if (result.category === 'supermarket') {
                    icon = 'fa-shopping-cart';
                    iconColor = '#9C27B0';
                } else if (result.category === 'mall') {
                    icon = 'fa-store';
                    iconColor = '#4CAF50';
                } else if (result.category === 'medical') {
                    icon = 'fa-hospital';
                    iconColor = '#F44336';
                }
                
                html += `
                    <div class="suggestion-item" data-index="${index}" style="
                        padding: 12px 15px;
                        border-bottom: 1px solid #f5f5f5;
                        cursor: pointer;
                        transition: background 0.2s;
                    ">
                        <div style="display: flex; align-items: flex-start; gap: 12px;">
                            <div style="color: ${iconColor}; font-size: 18px; margin-top: 2px;">
                                <i class="fas ${icon}"></i>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 4px;">${result.name}</div>
                                <div style="font-size: 13px; color: #666; margin-bottom: 4px;">${result.address}</div>
                                ${result.distance ? `
                                <div style="font-size: 12px; color: #FF6B35;">
                                    <i class="fas fa-location-arrow"></i> ${result.distance.toFixed(1)} km away
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            // Add recent searches section if there are recent searches
            const recentSearches = EnhancedSearchEngine.getRecentDestinations(5);
            if (recentSearches.length > 0) {
                html += `
                    <div style="padding: 12px 15px; background: #f9f9f9; border-top: 1px solid #e0e0e0;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 8px;">
                            <i class="fas fa-history"></i> Recent searches
                        </div>
                `;
                
                recentSearches.forEach((item, index) => {
                    html += `
                        <div class="recent-item" data-recent-index="${index}" style="
                            padding: 8px 0;
                            border-bottom: 1px solid #eee;
                            cursor: pointer;
                            font-size: 14px;
                        ">
                            <div>${item.location.name}</div>
                            <div style="font-size: 12px; color: #999;">${item.location.address}</div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            }
        }
        
        container.innerHTML = html;
        container.style.display = 'block';
        
        // Add click handlers
        container.querySelectorAll('.suggestion-item').forEach(item => {
            item.addEventListener('click', () => {
                const index = parseInt(item.dataset.index);
                const result = results[index];
                
                if (type === 'pickup') {
                    this.selectPickupLocation(this.activeSearchInput, result);
                } else {
                    this.selectDestinationLocation(this.activeSearchInput, result);
                }
                
                this.hideSuggestions();
            });
        });
        
        container.querySelectorAll('.recent-item').forEach(item => {
            item.addEventListener('click', () => {
                const index = parseInt(item.dataset.recentIndex);
                const recentItem = recentSearches[index];
                
                const result = {
                    lat: recentItem.coordinates.lat,
                    lng: recentItem.coordinates.lng,
                    name: recentItem.location.name,
                    address: recentItem.location.address
                };
                
                if (type === 'pickup') {
                    this.selectPickupLocation(this.activeSearchInput, result);
                } else {
                    this.selectDestinationLocation(this.activeSearchInput, result);
                }
                
                this.hideSuggestions();
            });
        });
        
        // Close suggestions when clicking outside
        document.addEventListener('click', this.handleClickOutsideSuggestions);
    },
    
    showRecentLocations: function(inputId, type) {
        const input = document.getElementById(inputId);
        if (!input) return;
        
        const container = document.getElementById('globalSuggestionsContainer');
        if (!container) return;
        
        const recentSearches = EnhancedSearchEngine.getRecentDestinations(10);
        
        if (recentSearches.length === 0) {
            return;
        }
        
        // Position container below input
        const rect = input.getBoundingClientRect();
        container.style.top = `${rect.bottom + window.scrollY + 5}px`;
        container.style.left = `${rect.left + window.scrollX}px`;
        container.style.width = `${rect.width}px`;
        
        let html = `
            <div style="padding: 15px;">
                <div style="font-size: 14px; color: #666; margin-bottom: 10px;">
                    <i class="fas fa-history"></i> Recent destinations
                </div>
        `;
        
        recentSearches.forEach((item, index) => {
            const timeAgo = EnhancedUIUpdater.formatTimeAgo(item.timestamp);
            
            html += `
                <div class="recent-item" data-recent-index="${index}" style="
                    padding: 10px 0;
                    border-bottom: 1px solid #eee;
                    cursor: pointer;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 4px;">${item.location.name}</div>
                            <div style="font-size: 13px; color: #666;">${item.location.address}</div>
                        </div>
                        <div style="font-size: 12px; color: #999; margin-left: 10px;">
                            ${timeAgo}
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += `</div>`;
        
        container.innerHTML = html;
        container.style.display = 'block';
        
        // Add click handlers
        container.querySelectorAll('.recent-item').forEach(item => {
            item.addEventListener('click', () => {
                const index = parseInt(item.dataset.recentIndex);
                const recentItem = recentSearches[index];
                
                const result = {
                    lat: recentItem.coordinates.lat,
                    lng: recentItem.coordinates.lng,
                    name: recentItem.location.name,
                    address: recentItem.location.address
                };
                
                if (type === 'pickup') {
                    this.selectPickupLocation(inputId, result);
                } else {
                    this.selectDestinationLocation(inputId, result);
                }
                
                this.hideSuggestions();
            });
        });
        
        // Close suggestions when clicking outside
        document.addEventListener('click', this.handleClickOutsideSuggestions);
    },
    
    // Suggestion Selection Functions
    selectPickupLocation: function(inputId, location) {
        const input = document.getElementById(inputId);
        if (!input) return;
        
        input.value = location.address || location.name;
        
        // Store coordinates in data attributes
        input.dataset.lat = location.lat;
        input.dataset.lng = location.lng;
        
        AppState.pickup = {
            lat: location.lat,
            lng: location.lng,
            address: location.address || location.name,
            name: location.name,
            fullAddress: location.fullAddress || location.address
        };
        
        // Add to recent locations
        EnhancedSearchEngine.addToRecentLocations(location);
        
        // Update map
        EnhancedUIUpdater.updatePickupMarker(location);
        
        // Calculate prices if destination exists
        if (AppState.destination) {
            EnhancedUIUpdater.calculateAndUpdatePrices();
            EnhancedUIUpdater.drawRoute(AppState.pickup, AppState.destination);
        }
        
        // Show clear button
        const clearBtn = input.parentNode.querySelector('.clear-input-btn');
        if (clearBtn) {
            clearBtn.style.display = 'block';
        }
        
        EnhancedUIUpdater.showToast('Pickup location set', 'success');
    },
    
    selectDestinationLocation: function(inputId, location) {
        const input = document.getElementById(inputId);
        if (!input) return;
        
        input.value = location.address || location.name;
        
        // Store coordinates in data attributes
        input.dataset.lat = location.lat;
        input.dataset.lng = location.lng;
        
        AppState.destination = {
            lat: location.lat,
            lng: location.lng,
            address: location.address || location.name,
            name: location.name,
            fullAddress: location.fullAddress || location.address
        };
        
        // Add to recent locations
        EnhancedSearchEngine.addToRecentLocations(location);
        
        // Update map
        EnhancedUIUpdater.updateDestinationMarker(location);
        
        // Calculate prices if pickup exists
        if (AppState.pickup) {
            EnhancedUIUpdater.calculateAndUpdatePrices();
            EnhancedUIUpdater.drawRoute(AppState.pickup, AppState.destination);
        }
        
        // Show clear button
        const clearBtn = input.parentNode.querySelector('.clear-input-btn');
        if (clearBtn) {
            clearBtn.style.display = 'block';
        }
        
        EnhancedUIUpdater.showToast('Destination set', 'success');
    },
    
    // Clear Functions
    clearPickupLocation: function(inputId) {
        const input = document.getElementById(inputId);
        if (input) {
            input.value = '';
            delete input.dataset.lat;
            delete input.dataset.lng;
            
            AppState.pickup = null;
            
            if (pickupMarker) {
                map.removeLayer(pickupMarker);
                pickupMarker = null;
            }
            
            // Hide clear button
            const clearBtn = input.parentNode.querySelector('.clear-input-btn');
            if (clearBtn) {
                clearBtn.style.display = 'none';
            }
            
            EnhancedUIUpdater.showToast('Pickup location cleared', 'info');
        }
    },
    
    clearDestinationLocation: function(inputId) {
        const input = document.getElementById(inputId);
        if (input) {
            input.value = '';
            delete input.dataset.lat;
            delete input.dataset.lng;
            
            AppState.destination = null;
            
            if (destinationMarker) {
                map.removeLayer(destinationMarker);
                destinationMarker = null;
            }
            
            if (routeLayer) {
                map.removeLayer(routeLayer);
                routeLayer = null;
            }
            
            // Hide clear button
            const clearBtn = input.parentNode.querySelector('.clear-input-btn');
            if (clearBtn) {
                clearBtn.style.display = 'none';
            }
            
            EnhancedUIUpdater.showToast('Destination cleared', 'info');
        }
    },
    
    // Suggestion UI Management
    handleClickOutsideSuggestions: function(event) {
        const container = document.getElementById('globalSuggestionsContainer');
        if (!container) return;
        
        if (!container.contains(event.target)) {
            const activeInput = document.querySelector('.location-input.active input');
            if (!activeInput || !activeInput.contains(event.target)) {
                container.style.display = 'none';
                document.removeEventListener('click', EnhancedLocationManager.handleClickOutsideSuggestions);
            }
        }
    },
    
    hideSuggestions: function() {
        const container = document.getElementById('globalSuggestionsContainer');
        if (container) {
            container.style.display = 'none';
        }
    },
    
    // Shopping Popup
    showShoppingLocationsPopup: function(category, locations) {
        const modal = document.createElement('div');
        modal.className = 'shopping-locations-modal';
        modal.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 10000;
            padding: 20px;
        `;
        
        let html = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0;">
                    <i class="fas ${AppState.shoppingCategories[category].icon}"></i>
                    ${AppState.shoppingCategories[category].name}
                </h3>
                <button id="closeShoppingModal" style="background: none; border: none; font-size: 20px; cursor: pointer;"></button>
            </div>
            <div style="margin-bottom: 15px; color: #666;">
                Select a location (closest first):
            </div>
            <div class="shopping-locations-list" style="display: flex; flex-direction: column; gap: 10px;">
        `;
        
        locations.forEach((location, index) => {
            html += `
                <div class="shopping-location-item" data-index="${index}" style="
                    padding: 15px;
                    border: 1px solid #e0e0e0;
                    border-radius: 8px;
                    cursor: pointer;
                    transition: all 0.2s;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <div style="font-weight: 600; margin-bottom: 5px;">${location.name}</div>
                            <div style="font-size: 13px; color: #666; margin-bottom: 5px;">${location.address}</div>
                            <div style="font-size: 12px; color: #FF6B35;">
                                <i class="fas fa-location-arrow"></i> ${location.distance.toFixed(1)} km away
                            </div>
                        </div>
                        <div style="color: #4CAF50; font-size: 24px;">
                            <i class="fas ${AppState.shoppingCategories[category].icon}"></i>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += `
            </div>
            <div style="margin-top: 20px; text-align: center;">
                <button id="cancelShoppingSelect" style="
                    padding: 10px 20px;
                    background: #f5f5f5;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                ">Cancel</button>
            </div>
        `;
        
        modal.innerHTML = html;
        document.body.appendChild(modal);
        
        // Add overlay
        const overlay = document.createElement('div');
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
        `;
        document.body.appendChild(overlay);
        
        // Event listeners
        modal.querySelector('#closeShoppingModal').addEventListener('click', () => {
            document.body.removeChild(modal);
            document.body.removeChild(overlay);
        });
        
        overlay.addEventListener('click', () => {
            document.body.removeChild(modal);
            document.body.removeChild(overlay);
        });
        
        modal.querySelector('#cancelShoppingSelect').addEventListener('click', () => {
            document.body.removeChild(modal);
            document.body.removeChild(overlay);
        });
        
        modal.querySelectorAll('.shopping-location-item').forEach(item => {
            item.addEventListener('click', () => {
                const index = parseInt(item.dataset.index);
                const location = locations[index];
                
                // Update shop name input
                const shopNameInput = document.getElementById('shopName');
                if (shopNameInput) {
                    shopNameInput.value = location.name;
                    shopNameInput.dataset.lat = location.lat;
                    shopNameInput.dataset.lng = location.lng;
                }
                
                // Update shop location input
                const shopLocationInput = document.getElementById('shopLocation');
                if (shopLocationInput) {
                    shopLocationInput.value = location.address;
                    shopLocationInput.dataset.lat = location.lat;
                    shopLocationInput.dataset.lng = location.lng;
                }
                
                // Update pickup location
                AppState.pickup = {
                    lat: location.lat,
                    lng: location.lng,
                    address: location.address,
                    name: location.name
                };
                
                // Update pickup input
                const pickupInput = document.getElementById('pickupLocation');
                if (pickupInput) {
                    pickupInput.value = location.address;
                    pickupInput.dataset.lat = location.lat;
                    pickupInput.dataset.lng = location.lng;
                }
                
                // Update map
                EnhancedUIUpdater.updatePickupMarker(location);
                
                document.body.removeChild(modal);
                document.body.removeChild(overlay);
                
                EnhancedUIUpdater.showToast(`${location.name} selected`, 'success');
            });
        });
    },
    
    // Stop Management Functions
    addStop: function() {
        const stopsContainer = document.getElementById('stopsContainer');
        if (!stopsContainer) return;
        
        const stopIndex = AppState.rideStops.length + 1;
        const stopId = `stop-${stopIndex}`;
        
        const stopElement = document.createElement('div');
        stopElement.className = 'ride-stop';
        stopElement.dataset.stopId = stopId;
        stopElement.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                <div style="color: #FF6B35;">
                    <i class="fas fa-map-pin"></i>
                </div>
                <input type="text" class="stop-input" placeholder="Stop ${stopIndex}" 
                       style="flex: 1; padding: 10px; border: 1px solid #e0e0e0; border-radius: 6px;">
                <button type="button" class="remove-stop-btn" style="
                    background: #f44336;
                    color: white;
                    border: none;
                    border-radius: 4px;
                    padding: 5px 10px;
                    cursor: pointer;
                ">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        stopsContainer.appendChild(stopElement);
        
        // Add stop to state
        AppState.rideStops.push({
            id: stopId,
            name: `Stop ${stopIndex}`,
            location: null,
            index: stopIndex
        });
        
        // Setup input event
        const stopInput = stopElement.querySelector('.stop-input');
        stopInput.addEventListener('focus', () => {
            this.handleStopInputFocus(stopId, stopInput);
        });
        
        stopInput.addEventListener('input', (e) => {
            this.handleStopInputChange(stopId, e.target.value);
        });
        
        // Setup remove button
        const removeBtn = stopElement.querySelector('.remove-stop-btn');
        removeBtn.addEventListener('click', () => {
            this.removeStop(stopId);
        });
        
        EnhancedUIUpdater.showToast(`Stop ${stopIndex} added`, 'info');
    },
    
    removeStop: function(stopId) {
        const stopElement = document.querySelector(`[data-stop-id="${stopId}"]`);
        if (stopElement) {
            stopElement.remove();
        }
        
        // Remove from state
        AppState.rideStops = AppState.rideStops.filter(stop => stop.id !== stopId);
        
        // Update stop indices
        AppState.rideStops.forEach((stop, index) => {
            stop.index = index + 1;
            const input = document.querySelector(`[data-stop-id="${stop.id}"] .stop-input`);
            if (input) {
                input.placeholder = `Stop ${stop.index}`;
            }
        });
        
        // Recalculate prices if route exists
        if (AppState.pickup && AppState.destination) {
            EnhancedUIUpdater.calculateAndUpdatePrices();
        }
        
        EnhancedUIUpdater.showToast('Stop removed', 'info');
    },
    
    // Stop Input Handlers
    handleStopInputFocus: function(stopId, input) {
        this.activeSearchInput = stopId;
        this.showRecentLocationsForStop(input);
    },
    
    handleStopInputChange: async function(stopId, value) {
        if (!value.trim() || value.length < 2) {
            return;
        }
        
        clearTimeout(this.searchTimeout);
        this.searchTimeout = setTimeout(async () => {
            await this.searchStopLocation(stopId, value);
        }, 300);
    },
    
    showRecentLocationsForStop: function(input) {
        const container = document.getElementById('globalSuggestionsContainer');
        if (!container) return;
        
        const recentSearches = EnhancedSearchEngine.getRecentDestinations(8);
        
        if (recentSearches.length === 0) {
            return;
        }
        
        // Position container below input
        const rect = input.getBoundingClientRect();
        container.style.top = `${rect.bottom + window.scrollY + 5}px`;
        container.style.left = `${rect.left + window.scrollX}px`;
        container.style.width = `${rect.width}px`;
        
        let html = `
            <div style="padding: 15px;">
                <div style="font-size: 14px; color: #666; margin-bottom: 10px;">
                    <i class="fas fa-history"></i> Select a stop location
                </div>
        `;
        
        recentSearches.forEach((item, index) => {
            html += `
                <div class="recent-item" data-recent-index="${index}" style="
                    padding: 10px 0;
                    border-bottom: 1px solid #eee;
                    cursor: pointer;
                ">
                    <div style="font-weight: 600; margin-bottom: 4px;">${item.location.name}</div>
                    <div style="font-size: 13px; color: #666;">${item.location.address}</div>
                </div>
            `;
        });
        
        html += `</div>`;
        
        container.innerHTML = html;
        container.style.display = 'block';
        
        // Store reference to input for callback
        container.dataset.targetInput = 'stop';
        container.dataset.stopId = this.activeSearchInput;
        
        // Add click handlers
        container.querySelectorAll('.recent-item').forEach((item, index) => {
            item.addEventListener('click', () => {
                const recentItem = recentSearches[index];
                const stop = AppState.rideStops.find(s => s.id === this.activeSearchInput);
                
                if (stop) {
                    stop.location = {
                        lat: recentItem.coordinates.lat,
                        lng: recentItem.coordinates.lng,
                        name: recentItem.location.name,
                        address: recentItem.location.address
                    };
                    
                    const input = document.querySelector(`[data-stop-id="${stop.id}"] .stop-input`);
                    if (input) {
                        input.value = recentItem.location.address;
                    }
                    
                    // Recalculate prices
                    if (AppState.pickup && AppState.destination) {
                        EnhancedUIUpdater.calculateAndUpdatePrices();
                    }
                }
                
                this.hideSuggestions();
            });
        });
        
        // Close suggestions when clicking outside
        document.addEventListener('click', this.handleClickOutsideSuggestions);
    },
    
    async searchStopLocation(stopId, query) {
        if (!AppState.currentCity) {
            EnhancedUIUpdater.showToast('Please wait while we detect your city', 'warning');
            return;
        }
        
        const stop = AppState.rideStops.find(s => s.id === stopId);
        if (!stop) return;
        
        const input = document.querySelector(`[data-stop-id="${stopId}"] .stop-input`);
        if (!input) return;
        
        try {
            const results = await EnhancedSearchEngine.search(
                query,
                'stop',
                AppState.userLocation,
                AppState.currentCity
            );
            
            if (results.length > 0) {
                this.showStopSuggestions(input, results, stopId);
            }
        } catch (error) {
            console.error('Stop search error:', error);
        }
    },
    
    showStopSuggestions: function(input, results, stopId) {
        const container = document.getElementById('globalSuggestionsContainer');
        if (!container) return;
        
        const rect = input.getBoundingClientRect();
        container.style.top = `${rect.bottom + window.scrollY + 5}px`;
        container.style.left = `${rect.left + window.scrollX}px`;
        container.style.width = `${rect.width}px`;
        
        let html = '';
        
        if (results.length === 0) {
            html = '<div style="padding: 20px; text-align: center; color: #666;">No results found</div>';
        } else {
            results.forEach((result, index) => {
                html += `
                    <div class="suggestion-item" data-index="${index}" style="
                        padding: 12px 15px;
                        border-bottom: 1px solid #f5f5f5;
                        cursor: pointer;
                    ">
                        <div style="font-weight: 600; margin-bottom: 4px;">${result.name}</div>
                        <div style="font-size: 13px; color: #666;">${result.address}</div>
                        ${result.distance ? `
                        <div style="font-size: 12px; color: #FF6B35; margin-top: 4px;">
                            <i class="fas fa-location-arrow"></i> ${result.distance.toFixed(1)} km away
                        </div>
                        ` : ''}
                    </div>
                `;
            });
        }
        
        container.innerHTML = html;
        container.style.display = 'block';
        container.dataset.targetInput = 'stop';
        container.dataset.stopId = stopId;
        
        // Add click handlers
        container.querySelectorAll('.suggestion-item').forEach((item, index) => {
            item.addEventListener('click', () => {
                const result = results[index];
                const stop = AppState.rideStops.find(s => s.id === stopId);
                
                if (stop) {
                    stop.location = {
                        lat: result.lat,
                        lng: result.lng,
                        name: result.name,
                        address: result.address
                    };
                    
                    input.value = result.address;
                    
                    // Recalculate prices
                    if (AppState.pickup && AppState.destination) {
                        EnhancedUIUpdater.calculateAndUpdatePrices();
                    }
                }
                
                this.hideSuggestions();
            });
        });
        
        document.addEventListener('click', this.handleClickOutsideSuggestions);
    }
};

// ============================================
// ENHANCED PRICE CALCULATOR
// ============================================
const EnhancedPriceCalculator = {
    calculateRideFare: function(distanceKm, rideType = 'standard', surge = 1.0, timeOfDay = null, stops = []) {
        const config = AppState.rideTypes[rideType] || AppState.rideTypes.standard;
        
        let fare = config.base + (distanceKm * config.perKm);
        
        fare *= config.multiplier;
        
        fare *= surge;
        
        if (!timeOfDay) {
            timeOfDay = new Date().getHours();
        }
        
        if (timeOfDay >= 22 || timeOfDay <= 5) {
            fare *= 1.2;
        } else if (timeOfDay >= 7 && timeOfDay <= 9) {
            fare *= 1.3;
        } else if (timeOfDay >= 16 && timeOfDay <= 19) {
            fare *= 1.4;
        }
        
        // Add additional charge for stops
        if (stops.length > 0) {
            fare += stops.length * 5; // ZMW 5 per additional stop
        }
        
        fare = Math.max(fare, config.min);
        
        return Math.round(fare * 100) / 100;
    },
    
    calculateEmergencyFare: function(distanceKm, serviceType, surge = 1.0) {
        const config = AppState.emergencyServices[serviceType] || AppState.emergencyServices.police;
        
        let fare = config.base + (distanceKm * config.perKm);
        fare *= config.multiplier;
        fare *= surge;
        fare = Math.max(fare, config.min);
        
        return Math.round(fare * 100) / 100;
    },
    
    calculateDeliveryFare: function(distanceKm, deliveryType = 'standard', parcelValue = 0) {
        const config = AppState.deliveryTypes[deliveryType] || AppState.deliveryTypes.standard;
        
        let fare = config.base + (distanceKm * config.perKm);
        fare *= config.multiplier;
        
        if (parcelValue > 500) {
            fare += parcelValue * 0.01;
        }
        
        return Math.round(fare * 100) / 100;
    },
    
    calculateTruckFare: function(distanceKm, truckType = 'light', helpers = false) {
        const config = AppState.truckTypes[truckType] || AppState.truckTypes.light;
        
        let fare = config.base + (distanceKm * config.perKm);
        fare *= config.multiplier;
        
        if (helpers) {
            fare += 50;
        }
        
        return Math.round(fare * 100) / 100;
    },
    
    calculateShoppingFare: function(distanceKm, itemsCount = 1, budget = 0) {
        let fare = 30 + (distanceKm * 2.5) + (itemsCount * 5);
        
        if (budget > 0) {
            fare += budget * 0.05;
        }
        
        return Math.round(fare * 100) / 100;
    },
    
    calculateDistance: function(lat1, lon1, lat2, lon2) {
        return EnhancedSearchEngine.calculateDistance(lat1, lon1, lat2, lon2);
    },
    
    calculateRouteDistance: function(points) {
        if (points.length < 2) return 0;
        
        let totalDistance = 0;
        for (let i = 0; i < points.length - 1; i++) {
            totalDistance += this.calculateDistance(
                points[i].lat, points[i].lng,
                points[i + 1].lat, points[i + 1].lng
            );
        }
        
        return totalDistance;
    },
    
    calculateRideDistanceWithStops: function(pickup, destination, stops = []) {
        const points = [pickup];
        
        // Add stops in order
        stops.forEach(stop => {
            if (stop.location) {
                points.push(stop.location);
            }
        });
        
        points.push(destination);
        
        return this.calculateRouteDistance(points);
    },
    
    estimateTime: function(distanceKm, rideType = 'standard', traffic = null, stops = []) {
        const baseSpeed = rideType === 'premium' ? 45 : 35;
        let baseTime = (distanceKm / baseSpeed) * 60;
        
        if (!traffic) {
            traffic = this.getTrafficFactor();
        }
        
        baseTime *= traffic;
        
        // Add time for stops
        if (stops.length > 0) {
            baseTime += stops.length * 3; // 3 minutes per stop
        }
        
        if (rideType === 'premium') {
            baseTime += 2;
        } else {
            baseTime += 5;
        }
        
        return Math.ceil(baseTime);
    },
    
    getTrafficFactor: function() {
        const hour = new Date().getHours();
        const day = new Date().getDay();
        
        if (day >= 1 && day <= 5) {
            if ((hour >= 7 && hour <= 9) || (hour >= 16 && hour <= 19)) {
                return 1.5;
            }
        }
        
        if (day === 6 || day === 0) {
            if (hour >= 12 && hour <= 16) {
                return 1.3;
            }
        }
        
        return 1.0;
    },
    
    getSurgeMultiplier: function() {
        const hour = new Date().getHours();
        const day = new Date().getDay();
        
        if (day >= 1 && day <= 5) {
            if (hour >= 7 && hour <= 9) return 1.5;
            if (hour >= 16 && hour <= 19) return 1.8;
        }
        
        if (day === 5 || day === 6) {
            if (hour >= 20 && hour <= 23) return 2.0;
        }
        
        if (hour >= 22 || hour <= 5) return 1.8;
        
        return 1.0;
    },
    
    getFareBreakdown: function(distanceKm, rideType = 'standard', surge = 1.0, stops = []) {
        const config = AppState.rideTypes[rideType] || AppState.rideTypes.standard;
        const baseFare = config.base;
        const distanceFare = distanceKm * config.perKm;
        const rideTypeMultiplier = config.multiplier;
        const surgeMultiplier = surge;
        const timeMultiplier = this.getTimeMultiplier();
        const stopsCharge = stops.length * 5;
        
        const subtotal = (baseFare + distanceFare) * rideTypeMultiplier + stopsCharge;
        const surgeAmount = subtotal * (surgeMultiplier - 1);
        const timeAmount = subtotal * (timeMultiplier - 1);
        const total = subtotal * surgeMultiplier * timeMultiplier;
        
        return {
            baseFare: baseFare,
            distanceFare: distanceFare,
            stopsCharge: stopsCharge,
            rideTypeMultiplier: rideTypeMultiplier,
            surgeMultiplier: surgeMultiplier,
            timeMultiplier: timeMultiplier,
            surgeAmount: surgeAmount,
            timeAmount: timeAmount,
            subtotal: subtotal,
            total: Math.max(total, config.min)
        };
    },
    
    getTimeMultiplier: function() {
        const hour = new Date().getHours();
        if (hour >= 22 || hour <= 5) return 1.2;
        return 1.0;
    },
    
    calculateSplitRideFare: function(totalFare, splitType = 'equal', participants = 2) {
        let yourShare = totalFare;
        let othersShare = 0;
        
        switch(splitType) {
            case 'equal':
                yourShare = totalFare / participants;
                othersShare = totalFare / participants;
                break;
            case 'you_pay_more':
                yourShare = totalFare * 0.7;
                othersShare = totalFare * 0.3;
                break;
            case 'you_pay_all':
                yourShare = totalFare;
                othersShare = 0;
                break;
        }
        
        return {
            total: totalFare,
            yourShare: yourShare,
            othersShare: othersShare,
            splitType: splitType,
            participants: participants
        };
    },
    
    validateDistanceWithinCity: function(startLat, startLng, endLat, endLng, city) {
        const distance = this.calculateDistance(startLat, startLng, endLat, endLng);
        
        const maxCityDistance = {
            'Lusaka': 50,
            'Ndola': 30,
            'Kitwe': 25,
            'Livingstone': 20,
            'Kabwe': 20,
            'Chipata': 15,
            'default': 25
        };
        
        const maxDistance = maxCityDistance[city] || maxCityDistance.default;
        
        if (distance > maxDistance) {
            return {
                valid: false,
                distance: distance,
                maxAllowed: maxDistance,
                message: `Distance exceeds maximum allowed for ${city} (${maxDistance}km)`
            };
        }
        
        return {
            valid: true,
            distance: distance
        };
    },

// In the EnhancedPriceCalculator object, add these methods:

calculateShoppingServiceFare: function(distanceKm, itemsCount = 1, budget = 0, vehicleType = 'bike') {
    let fare = 30 + (distanceKm * 2.5) + (itemsCount * 5);
    
    if (budget > 0) {
        fare += budget * 0.05;
    }
    
    // Add vehicle type multiplier
    if (vehicleType === 'car') {
        fare *= 1.5;
    } else if (vehicleType === 'bike') {
        fare *= 1.2;
    }
    
    return Math.round(fare * 100) / 100;
},

calculateDeliveryServiceFare: function(distanceKm, deliveryType = 'standard', parcelValue = 0, vehicleType = 'bike') {
    const config = AppState.deliveryTypes[deliveryType] || AppState.deliveryTypes.standard;
    
    let fare = config.base + (distanceKm * config.perKm);
    fare *= config.multiplier;
    
    if (parcelValue > 500) {
        fare += parcelValue * 0.01;
    }
    
    // Add vehicle type multiplier
    if (vehicleType === 'car') {
        fare *= 1.5;
    } else if (vehicleType === 'bike') {
        fare *= 1.2;
    }
    
    return Math.round(fare * 100) / 100;
},

calculateShortDeliveryFare: function(distanceKm, parcelDescription = '', vehicleType = 'bike') {
    let fare = 20 + (distanceKm * 3.0);
    
    // Add premium for certain items
    if (parcelDescription.toLowerCase().includes('food') || 
        parcelDescription.toLowerCase().includes('medic')) {
        fare += 10;
    }
    
    // Add vehicle type multiplier
    if (vehicleType === 'car') {
        fare *= 1.5;
    } else if (vehicleType === 'bike') {
        fare *= 1.3;
    }
    
    return Math.round(fare * 100) / 100;
},
    
    applyReferralDiscount: function(fare) {
        if (AppState.referralDiscountApplied) {
            const discount = fare * 0.5;
            const discountedFare = fare - discount;
            return {
                originalFare: fare,
                discount: discount,
                finalFare: discountedFare,
                discountApplied: true
            };
        }
        return {
            originalFare: fare,
            discount: 0,
            finalFare: fare,
            discountApplied: false
        };
    },
    
    calculateStopsFare: function(stopsCount) {
        return stopsCount * 5; // ZMW 5 per stop
    }
};

// Add these functions to update service prices when destination is set
function updateShoppingServicePrice() {
    if (!AppState.pickup || !AppState.destination) {
        return;
    }
    
    const distance = EnhancedPriceCalculator.calculateDistance(
        AppState.pickup.lat, AppState.pickup.lng,
        AppState.destination.lat, AppState.destination.lng
    );
    
    // Get shopping details
    const itemsCount = document.querySelectorAll('.item-entry').length || 1;
    const budgetInput = document.getElementById('shoppingBudget');
    const budget = budgetInput ? parseFloat(budgetInput.value) || 0 : 0;
    
    // Calculate fare for both vehicle types
    const bikeFare = EnhancedPriceCalculator.calculateShoppingServiceFare(distance, itemsCount, budget, 'bike');
    const carFare = EnhancedPriceCalculator.calculateShoppingServiceFare(distance, itemsCount, budget, 'car');
    
    // Update display
    const fareDisplay = document.getElementById('shoppingFareDisplay');
    const fareElement = document.getElementById('shoppingFare');
    const distanceElement = document.getElementById('shoppingDistance');
    const timeElement = document.getElementById('shoppingTime');
    
    if (fareDisplay && fareElement && distanceElement && timeElement) {
        fareElement.textContent = `ZMW ${bikeFare.toFixed(2)} - ZMW ${carFare.toFixed(2)}`;
        distanceElement.textContent = `${distance.toFixed(1)} km`;
        
        // Estimate time
        const time = Math.ceil((distance / 25) * 60) + (itemsCount * 5); // 25km/h + 5min per item
        timeElement.textContent = `ETA: ${time} min`;
        
        fareDisplay.style.display = 'block';
        fareDisplay.classList.add('active');
    }
    
    // Store the calculated fares for later use
    AppState.shoppingServiceFares = {
        bike: bikeFare,
        car: carFare,
        distance: distance,
        itemsCount: itemsCount,
        budget: budget
    };
}

function updateDeliveryServicePrice() {
    if (!AppState.pickup || !AppState.destination) {
        return;
    }
    
    const distance = EnhancedPriceCalculator.calculateDistance(
        AppState.pickup.lat, AppState.pickup.lng,
        AppState.destination.lat, AppState.destination.lng
    );
    
    // Get delivery type
    let deliveryType = 'standard';
    if (document.getElementById('expressDelivery')?.classList.contains('active')) {
        deliveryType = 'express';
    } else if (document.getElementById('sameDayDelivery')?.classList.contains('active')) {
        deliveryType = 'sameDay';
    }
    
    // Get parcel value
    const parcelValueInput = document.getElementById('parcelValue');
    const parcelValue = parcelValueInput ? parseFloat(parcelValueInput.value) || 0 : 0;
    
    // Calculate fare for both vehicle types
    const bikeFare = EnhancedPriceCalculator.calculateDeliveryServiceFare(distance, deliveryType, parcelValue, 'bike');
    const carFare = EnhancedPriceCalculator.calculateDeliveryServiceFare(distance, deliveryType, parcelValue, 'car');
    
    // Update display
    const fareDisplay = document.getElementById('deliveryFareDisplay');
    const fareElement = document.getElementById('deliveryFare');
    const distanceElement = document.getElementById('deliveryDistance');
    const timeElement = document.getElementById('deliveryTime');
    
    if (fareDisplay && fareElement && distanceElement && timeElement) {
        fareElement.textContent = `ZMW ${bikeFare.toFixed(2)} - ZMW ${carFare.toFixed(2)}`;
        distanceElement.textContent = `${distance.toFixed(1)} km`;
        
        // Estimate time based on delivery type
        let time;
        if (deliveryType === 'express') {
            time = Math.ceil((distance / 30) * 60);
        } else if (deliveryType === 'sameDay') {
            time = Math.ceil((distance / 35) * 60);
        } else {
            time = Math.ceil((distance / 25) * 60);
        }
        timeElement.textContent = `ETA: ${time} min`;
        
        fareDisplay.style.display = 'block';
        fareDisplay.classList.add('active');
    }
    
    // Store the calculated fares for later use
    AppState.deliveryServiceFares = {
        bike: bikeFare,
        car: carFare,
        distance: distance,
        deliveryType: deliveryType,
        parcelValue: parcelValue
    };
}

function updateShortDeliveryServicePrice() {
    if (!AppState.pickup || !AppState.destination) {
        return;
    }
    
    const distance = EnhancedPriceCalculator.calculateDistance(
        AppState.pickup.lat, AppState.pickup.lng,
        AppState.destination.lat, AppState.destination.lng
    );
    
    // Get parcel description
    const parcelDescInput = document.getElementById('shortParcelDescription');
    const parcelDescription = parcelDescInput ? parcelDescInput.value : '';
    
    // Calculate fare for both vehicle types
    const bikeFare = EnhancedPriceCalculator.calculateShortDeliveryFare(distance, parcelDescription, 'bike');
    const carFare = EnhancedPriceCalculator.calculateShortDeliveryFare(distance, parcelDescription, 'car');
    
    // Update display
    const fareDisplay = document.getElementById('shortDeliveryFareDisplay');
    const fareElement = document.getElementById('shortDeliveryFare');
    const distanceElement = document.getElementById('shortDeliveryDistance');
    const timeElement = document.getElementById('shortDeliveryTime');
    
    if (fareDisplay && fareElement && distanceElement && timeElement) {
        fareElement.textContent = `ZMW ${bikeFare.toFixed(2)} - ZMW ${carFare.toFixed(2)}`;
        distanceElement.textContent = `${distance.toFixed(1)} km`;
        
        // Estimate time (short deliveries are faster)
        const time = Math.ceil((distance / 30) * 60);
        timeElement.textContent = `ETA: ${time} min`;
        
        fareDisplay.style.display = 'block';
        fareDisplay.classList.add('active');
    }
    
    // Store the calculated fares for later use
    AppState.shortDeliveryServiceFares = {
        bike: bikeFare,
        car: carFare,
        distance: distance,
        parcelDescription: parcelDescription
    };
}

function updateTruckServicePrice() {
    if (!AppState.pickup || !AppState.destination) {
        return;
    }
    
    const distance = EnhancedPriceCalculator.calculateDistance(
        AppState.pickup.lat, AppState.pickup.lng,
        AppState.destination.lat, AppState.destination.lng
    );
    
    // Get truck type
    const selectedTruck = document.querySelector('.truck-type.selected');
    const truckType = selectedTruck ? selectedTruck.dataset.type : 'light';
    
    // Get weight and helpers
    const weightInput = document.getElementById('estimatedWeight');
    const estimatedWeight = weightInput ? parseFloat(weightInput.value) || 0 : 0;
    
    const helpersCheckbox = document.getElementById('needHelpers');
    const needHelpers = helpersCheckbox ? helpersCheckbox.checked : false;
    
    // Calculate fare
    const fare = EnhancedPriceCalculator.calculateTruckFare(distance, truckType, needHelpers);
    
    // Update display
    const fareDisplay = document.getElementById('truckFareDisplay');
    const fareElement = document.getElementById('truckFare');
    const distanceElement = document.getElementById('truckDistance');
    const timeElement = document.getElementById('truckTime');
    
    if (fareDisplay && fareElement && distanceElement && timeElement) {
        fareElement.textContent = `ZMW ${fare.toFixed(2)}`;
        distanceElement.textContent = `${distance.toFixed(1)} km`;
        
        // Estimate time (trucks are slower)
        const time = Math.ceil((distance / 20) * 60);
        timeElement.textContent = `ETA: ${time} min`;
        
        fareDisplay.style.display = 'block';
        fareDisplay.classList.add('active');
    }
    
    // Store the calculated fares for later use
    AppState.truckServiceFares = {
        fare: fare,
        distance: distance,
        truckType: truckType,
        estimatedWeight: estimatedWeight,
        needHelpers: needHelpers
    };
}

// ============================================
// ENHANCED UI UPDATER
// ============================================
const EnhancedUIUpdater = {
    updateWalletBalance: function(balance) {
        const formatted = `ZMW ${balance.toFixed(2)}`;
        const walletBalance = document.getElementById('walletBalance');
        const accountBalance = document.getElementById('accountBalance');
        const paymentBalance = document.getElementById('paymentBalance');
        const transferBalance = document.getElementById('transferBalance');
        
        if (walletBalance) walletBalance.textContent = formatted;
        if (accountBalance) accountBalance.textContent = formatted;
        if (paymentBalance) paymentBalance.textContent = formatted;
        if (transferBalance) transferBalance.textContent = formatted;
        
        AppState.walletBalance = balance;
    },
    
    updateUserInfo: function(userData) {
        if (userData.name) {
            const userFullName = document.getElementById('userFullName');
            const accountName = document.getElementById('accountName');
            if (userFullName) userFullName.textContent = userData.name;
            if (accountName) accountName.textContent = userData.name;
        }
        
        if (userData.phone) {
            const accountPhone = document.getElementById('accountPhone');
            if (accountPhone) accountPhone.textContent = userData.phone;
        }
        
        if (userData.email) {
            const updateEmail = document.getElementById('updateEmail');
            if (updateEmail) updateEmail.value = userData.email;
        }
        
        if (userData.referralCode) {
            const referralCode = document.getElementById('referralCode');
            if (referralCode) referralCode.textContent = userData.referralCode;
        }
    },
    
    showToast: function(message, type = 'info', duration = 5000) {
        const toastContainer = document.getElementById('toastContainer');
        if (!toastContainer) {
            // Create toast container if it doesn't exist
            const container = document.createElement('div');
            container.id = 'toastContainer';
            container.className = 'toast-container';
            container.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                z-index: 10000;
                display: flex;
                flex-direction: column;
                gap: 10px;
            `;
            document.body.appendChild(container);
            toastContainer = container;
        }
        
        const toastId = 'toast-' + Date.now();
        
        const icons = {
            success: 'fa-check-circle',
            error: 'fa-exclamation-circle',
            warning: 'fa-exclamation-triangle',
            info: 'fa-info-circle'
        };
        
        const colors = {
            success: '#4CAF50',
            error: '#F44336',
            warning: '#FFC107',
            info: '#2196F3'
        };
        
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.id = toastId;
        toast.style.cssText = `
            background: white;
            border-left: 4px solid ${colors[type] || colors.info};
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 15px 20px;
            min-width: 300px;
            max-width: 400px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            animation: slideIn 0.3s ease;
        `;
        
        toast.innerHTML = `
            <div style="color: ${colors[type] || colors.info}; font-size: 20px;">
                <i class="fas ${icons[type] || icons.info}"></i>
            </div>
            <div style="flex: 1;">
                <div style="font-weight: 600; margin-bottom: 4px; text-transform: capitalize;">${type}</div>
                <div style="font-size: 14px; color: #333;">${message}</div>
            </div>
            <button onclick="EnhancedUIUpdater.removeToast('${toastId}')" style="
                background: none;
                border: none;
                color: #999;
                cursor: pointer;
                font-size: 18px;
                padding: 0;
            "></button>
        `;
        
        toastContainer.appendChild(toast);
        
        setTimeout(() => {
            this.removeToast(toastId);
        }, duration);
        
        return toastId;
    },
    
    removeToast: function(toastId) {
        const toast = document.getElementById(toastId);
        if (toast) {
            toast.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300);
        }
    },
    
    showLoading: function(message = 'Loading...') {
        const overlay = document.getElementById('loadingOverlay');
        if (!overlay) {
            const loadingOverlay = document.createElement('div');
            loadingOverlay.id = 'loadingOverlay';
            loadingOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(255,255,255,0.9);
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                z-index: 99999;
            `;
            
            const spinner = document.createElement('div');
            spinner.className = 'loading-spinner';
            spinner.style.cssText = `
                width: 50px;
                height: 50px;
                border: 4px solid #f3f3f3;
                border-top: 4px solid #FF6B35;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin-bottom: 20px;
            `;
            
            const text = document.createElement('div');
            text.id = 'loadingText';
            text.className = 'loading-text';
            text.textContent = message;
            text.style.cssText = `
                font-size: 16px;
                color: #333;
                font-weight: 500;
            `;
            
            loadingOverlay.appendChild(spinner);
            loadingOverlay.appendChild(text);
            document.body.appendChild(loadingOverlay);
        } else {
            overlay.style.display = 'flex';
            const text = overlay.querySelector('#loadingText');
            if (text) text.textContent = message;
        }
    },
    
    hideLoading: function() {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
            overlay.style.display = 'none';
        }
    },
    
    showMapLoading: function() {
        const mapLoadingOverlay = document.getElementById('mapLoadingOverlay');
        if (mapLoadingOverlay) {
            mapLoadingOverlay.style.display = 'flex';
        }
    },
    
    hideMapLoading: function() {
        const mapLoadingOverlay = document.getElementById('mapLoadingOverlay');
        if (mapLoadingOverlay) {
            mapLoadingOverlay.style.display = 'none';
        }
    },
    
    updateCityDisplay: function(city) {
        const display = document.getElementById('currentCityDisplay');
        if (display && city) {
            display.textContent = `City: ${city}`;
            display.parentElement.style.display = 'flex';
            
            setTimeout(() => {
                if (display.parentElement) {
                    display.parentElement.style.display = 'none';
                }
            }, 5000);
        }
    },
    
    updateRidePrices: function() {
        if (!AppState.pickup || !AppState.destination) {
            return;
        }
        
        const distance = EnhancedPriceCalculator.calculateRideDistanceWithStops(
            AppState.pickup,
            AppState.destination,
            AppState.rideStops.filter(stop => stop.location)
        );
        
        const surge = EnhancedPriceCalculator.getSurgeMultiplier();
        const stopsCount = AppState.rideStops.filter(stop => stop.location).length;
        
        // Update prices for each ride type
        Object.keys(AppState.rideTypes).forEach(type => {
            const price = EnhancedPriceCalculator.calculateRideFare(
                distance, 
                type, 
                surge, 
                null, 
                AppState.rideStops.filter(stop => stop.location)
            );
            
            const element = document.getElementById(`${type}Price`);
            if (element) {
                element.textContent = `ZMW ${price.toFixed(2)}`;
            }
            
            // Update ride type cards
            const card = document.querySelector(`.ride-type-card[data-type="${type}"] .ride-type-price`);
            if (card) {
                card.textContent = `ZMW ${price.toFixed(2)}`;
            }
        });
        
        // Update selected price
        const selectedPrice = EnhancedPriceCalculator.calculateRideFare(
            distance,
            AppState.selectedRideType,
            surge,
            null,
            AppState.rideStops.filter(stop => stop.location)
        );
        
        const estimatedFare = document.getElementById('estimatedFare');
        if (estimatedFare) estimatedFare.textContent = `ZMW ${selectedPrice.toFixed(2)}`;
        
        const time = EnhancedPriceCalculator.estimateTime(
            distance,
            AppState.selectedRideType,
            null,
            AppState.rideStops.filter(stop => stop.location)
        );
        
        const distanceDetail = document.getElementById('distanceDetail');
        const timeDetail = document.getElementById('timeDetail');
        
        if (distanceDetail) distanceDetail.textContent = `${distance.toFixed(1)} km`;
        if (timeDetail) timeDetail.textContent = `ETA: ${time} min`;
        
        AppState.rideFare = selectedPrice;
        
        // Show fare display
        const fareDisplay = document.getElementById('fareDisplay');
        if (fareDisplay) {
            fareDisplay.classList.add('active');
            fareDisplay.style.display = 'block';
        }
        
        // Update price calculator
        this.updatePriceCalculator(distance, AppState.selectedRideType, surge, stopsCount);
    },
    
    updatePriceCalculator: function(distanceKm, rideType = 'standard', surge = 1.0, stopsCount = 0) {
        const calculator = document.getElementById('priceCalculator');
        const fareElement = document.getElementById('calculatedFare');
        const breakdownElement = document.getElementById('priceBreakdown');
        
        if (!calculator || !fareElement || !breakdownElement) return;
        
        calculator.style.display = 'block';
        
        const breakdown = EnhancedPriceCalculator.getFareBreakdown(
            distanceKm, 
            rideType, 
            surge, 
            AppState.rideStops.filter(stop => stop.location)
        );
        
        fareElement.textContent = `ZMW ${breakdown.total.toFixed(2)}`;
        
        let breakdownHTML = `
            <div class="price-breakdown-row">
                <span>Base Fare:</span>
                <span>ZMW ${breakdown.baseFare.toFixed(2)}</span>
            </div>
            <div class="price-breakdown-row">
                <span>Distance (${distanceKm.toFixed(1)}km):</span>
                <span>ZMW ${breakdown.distanceFare.toFixed(2)}</span>
            </div>
        `;
        
        if (stopsCount > 0) {
            breakdownHTML += `
                <div class="price-breakdown-row">
                    <span>Stops (${stopsCount}  ZMW 5):</span>
                    <span>ZMW ${breakdown.stopsCharge.toFixed(2)}</span>
                </div>
            `;
        }
        
        if (breakdown.rideTypeMultiplier !== 1) {
            breakdownHTML += `
                <div class="price-breakdown-row">
                    <span>${rideType.charAt(0).toUpperCase() + rideType.slice(1)} Multiplier:</span>
                    <span>${breakdown.rideTypeMultiplier.toFixed(1)}x</span>
                </div>
            `;
        }
        
        if (breakdown.surgeMultiplier !== 1) {
            breakdownHTML += `
                <div class="price-breakdown-row">
                    <span>Surge Pricing:</span>
                    <span>+ZMW ${breakdown.surgeAmount.toFixed(2)}</span>
                </div>
            `;
        }
        
        if (breakdown.timeMultiplier !== 1) {
            breakdownHTML += `
                <div class="price-breakdown-row">
                    <span>Time of Day:</span>
                    <span>+ZMW ${breakdown.timeAmount.toFixed(2)}</span>
                </div>
            `;
        }
        
        breakdownHTML += `
            <div class="price-breakdown-row total">
                <span>Total:</span>
                <span>ZMW ${breakdown.total.toFixed(2)}</span>
            </div>
        `;
        
        breakdownElement.innerHTML = breakdownHTML;
    },
    
    updatePickupMarker: function(location) {
        if (!map) {
            console.error('Map not initialized');
            return;
        }
        
        if (pickupMarker) {
            pickupMarker.setLatLng([location.lat, location.lng]);
        } else {
            pickupMarker = L.marker([location.lat, location.lng], {
                icon: L.divIcon({
                    className: 'pickup-marker',
                    html: '<i class="fas fa-map-marker-alt" style="color: #FF6B35; font-size: 24px;"></i>',
                    iconSize: [24, 24],
                    iconAnchor: [12, 24]
                })
            }).addTo(map).bindPopup('Pickup Location');
        }
        
        if (AppState.destination) {
            this.drawRouteWithStops();
        }
    },
    
    updateDestinationMarker: function(location) {
        if (!map) {
            console.error('Map not initialized');
            return;
        }
        
        if (destinationMarker) {
            destinationMarker.setLatLng([location.lat, location.lng]);
        } else {
            destinationMarker = L.marker([location.lat, location.lng], {
                icon: L.divIcon({
                    className: 'destination-marker',
                    html: '<i class="fas fa-flag" style="color: #4CAF50; font-size: 24px;"></i>',
                    iconSize: [24, 24],
                    iconAnchor: [12, 24]
                })
            }).addTo(map).bindPopup('Destination');
        }
        
        if (AppState.pickup) {
            this.drawRouteWithStops();
        }
    },
    
    drawRouteWithStops: async function() {
        if (!map || !AppState.pickup || !AppState.destination) {
            return;
        }
        
        // Clear existing route
        if (routeLayer) {
            map.removeLayer(routeLayer);
            routeLayer = null;
        }
        
        // Prepare waypoints
        const waypoints = [];
        
        // Start with pickup
        waypoints.push(L.latLng(AppState.pickup.lat, AppState.pickup.lng));
        
        // Add stops
        AppState.rideStops.forEach(stop => {
            if (stop.location) {
                waypoints.push(L.latLng(stop.location.lat, stop.location.lng));
            }
        });
        
        // End with destination
        waypoints.push(L.latLng(AppState.destination.lat, AppState.destination.lng));
        
        try {
            // Use OSRM routing service
            const waypointString = waypoints.map(wp => `${wp.lng},${wp.lat}`).join(';');
            const url = `https://router.project-osrm.org/route/v1/driving/${waypointString}?overview=full&geometries=geojson`;
            
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.routes && data.routes.length > 0) {
                const route = data.routes[0];
                const routeCoordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                
                routeLayer = L.polyline(routeCoordinates, {
                    color: '#FF6B35',
                    weight: 4,
                    opacity: 0.7,
                    lineJoin: 'round',
                    lineCap: 'round'
                }).addTo(map);
                
                // Fit map to route bounds
                const bounds = L.latLngBounds(routeCoordinates);
                map.fitBounds(bounds, { padding: [50, 50] });
                
                const distance = route.distance / 1000;
                const duration = route.duration / 60;
                
                console.log(`Route distance: ${distance.toFixed(2)} km, Duration: ${duration.toFixed(0)} min`);
                
                AppState.activeRoute = {
                    distance: distance,
                    duration: duration,
                    coordinates: routeCoordinates
                };
                
                // Update prices
                this.updateRidePrices();
                
                return { distance, duration };
            }
        } catch (error) {
            console.error('Routing error:', error);
            
            // Fallback: draw straight lines between points
            routeLayer = L.polyline(waypoints, {
                color: '#FF6B35',
                weight: 3,
                opacity: 0.7,
                dashArray: '10, 10'
            }).addTo(map);
            
            const bounds = L.latLngBounds(waypoints);
            map.fitBounds(bounds, { padding: [50, 50] });
            
            // Calculate approximate distance
            let totalDistance = 0;
            for (let i = 0; i < waypoints.length - 1; i++) {
                totalDistance += EnhancedPriceCalculator.calculateDistance(
                    waypoints[i].lat, waypoints[i].lng,
                    waypoints[i + 1].lat, waypoints[i + 1].lng
                );
            }
            
            // Update prices with approximate distance
            if (AppState.pickup && AppState.destination) {
                this.updateRidePrices();
            }
        }
    },
    
    drawRoute: function(start, end) {
        return this.drawRouteWithStops();
    },
    
    calculateAndUpdatePrices: function() {
        if (AppState.pickup && AppState.destination) {
            const validation = EnhancedPriceCalculator.validateDistanceWithinCity(
                AppState.pickup.lat, AppState.pickup.lng,
                AppState.destination.lat, AppState.destination.lng,
                AppState.currentCity
            );
            
            if (!validation.valid) {
                this.showToast(validation.message, 'warning');
                return;
            }
            
            this.updateRidePrices();
        }
    },
    
    showRideInfo: function(ride) {
        document.querySelectorAll('.ride-request-form, .service-form, #broadcastForm').forEach(form => {
            form.style.display = 'none';
        });
        
        const rideInfoPanel = document.getElementById('rideInfoPanel');
        if (rideInfoPanel) {
            rideInfoPanel.style.display = 'block';
            rideInfoPanel.classList.add('active');
        }
        
        // Update ride details
        this.updateRideDetails(ride);
        this.updateRideStatus(ride.status);
        this.updateTimeline(ride.status);
        
        if (ride.status === 'accepted' && AppState.sosConfig) {
            const sosButton = document.getElementById('sosButton');
            if (sosButton) sosButton.style.display = 'flex';
        }
    },
    
    updateRideDetails: function(ride) {
        const currentPickup = document.getElementById('currentPickup');
        const currentDestination = document.getElementById('currentDestination');
        const rideDistance = document.getElementById('rideDistance');
        const rideTime = document.getElementById('rideTime');
        
        if (currentPickup) currentPickup.textContent = ride.pickupDisplay || ride.pickup || 'Loading...';
        if (currentDestination) currentDestination.textContent = ride.destinationDisplay || ride.destination || 'Loading...';
        if (rideDistance) rideDistance.textContent = ride.distance ? `${ride.distance.toFixed(1)} km` : '0 km';
        if (rideTime) rideTime.textContent = ride.estimatedTime ? `${ride.estimatedTime} min` : '0 min';
        
        // Update fare breakdown
        const baseFareValue = document.getElementById('baseFareValue');
        const distanceFareValue = document.getElementById('distanceFareValue');
        const rideTypeValue = document.getElementById('rideTypeValue');
        const totalFareValue = document.getElementById('totalFareValue');
        
        if (baseFareValue) baseFareValue.textContent = `ZMW ${(ride.fareDetails?.baseFare || 15).toFixed(2)}`;
        if (distanceFareValue) distanceFareValue.textContent = `ZMW ${(ride.fareDetails?.distanceFare || 5).toFixed(2)}`;
        
        if (rideTypeValue) {
            rideTypeValue.textContent = ride.rideType?.charAt(0).toUpperCase() + ride.rideType?.slice(1) || 'Standard';
        }
        
        if (totalFareValue) totalFareValue.textContent = `ZMW ${ride.fare?.toFixed(2) || '0.00'}`;
    },
    
    updateRideStatus: function(status) {
        const statusBar = document.getElementById('rideStatusBar');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const etaText = document.getElementById('etaText');
        
        if (!statusBar || !statusDot || !statusText || !etaText) return;
        
        statusBar.classList.add('active');
        
        switch(status) {
            case 'requested':
                statusDot.className = 'status-dot searching';
                statusText.textContent = 'Searching for driver';
                etaText.textContent = '5-10 min';
                
                this.showPulsingRideIcon();
                break;
            case 'accepted':
                statusDot.className = 'status-dot arriving';
                statusText.textContent = 'Driver on the way';
                etaText.textContent = '5 min';
                break;
            case 'arrived':
                statusDot.className = 'status-dot riding';
                statusText.textContent = 'Driver arrived';
                etaText.textContent = '0 min';
                break;
            case 'started':
                statusDot.className = 'status-dot riding';
                statusText.textContent = 'Trip in progress';
                etaText.textContent = 'En route';
                break;
            case 'completed':
                statusBar.classList.remove('active');
                this.removePulsingRideIcon();
                break;
            case 'cancelled':
                statusBar.classList.remove('active');
                this.removePulsingRideIcon();
                break;
        }
    },
    
    showPulsingRideIcon: function() {
        this.removePulsingRideIcon();
        
        const serviceType = AppState.activeService;
        let iconClass = 'fa-car';
        
        if (serviceType === 'truck' || AppState.currentRide?.serviceType === 'truck') {
            iconClass = 'fa-truck';
        } else if (serviceType === 'delivery' || serviceType === 'short-delivery') {
            iconClass = 'fa-motorcycle';
        } else if (serviceType === 'express') {
            iconClass = 'fa-shopping-bag';
        }
        
        pulsingIcon = L.divIcon({
            className: 'pulsing-ride-icon',
            html: `<i class="fas ${iconClass}" style="color: #FF6B35; font-size: 40px;"></i>`,
            iconSize: [40, 40],
            iconAnchor: [20, 40]
        });
        
        if (AppState.pickup) {
            const marker = L.marker([AppState.pickup.lat, AppState.pickup.lng], {
                icon: pulsingIcon
            }).addTo(map);
            
            // Add pulsing animation
            marker.getElement().style.animation = 'pulse 1.5s infinite';
            
            AppState.rideRequestPulsingIcons[serviceType] = marker;
        }
    },
    
    removePulsingRideIcon: function() {
        Object.values(AppState.rideRequestPulsingIcons).forEach(marker => {
            if (marker && map.hasLayer(marker)) {
                map.removeLayer(marker);
            }
        });
        
        AppState.rideRequestPulsingIcons = {
            car: null,
            bike: null,
            truck: null
        };
    },

    requestScheduledRideNow: async function(rideData) {
    try {
        EnhancedUIUpdater.showLoading('Requesting your scheduled ride...');
        
        // Remove countdown container
        const countdownContainer = document.getElementById('scheduleCountdown');
        if (countdownContainer) {
            countdownContainer.remove();
        }
        
        // Remove from scheduled countdowns
        if (AppState.scheduledCountdowns.has(rideData.id)) {
            clearInterval(AppState.scheduledCountdowns.get(rideData.id));
            AppState.scheduledCountdowns.delete(rideData.id);
        }
        
        // Create regular ride data from scheduled ride
        const rideRequestData = {
            pickup: rideData.pickup,
            destination: rideData.destination,
            rideType: rideData.rideType,
            fare: rideData.fare,
            distance: rideData.distance,
            stops: rideData.stops || [],
            paymentMethod: rideData.paymentMethod || 'wallet',
            serviceType: 'car',
            isScheduledRide: true,
            originalScheduledTime: rideData.scheduledTime
        };
        
        // Request the ride
        const rideId = await EnhancedFirebaseManager.requestRide(rideRequestData);
        
        // Update scheduled ride status in Firebase
        await database.ref(`scheduledRides/${rideData.id}`).update({
            status: 'requested',
            requestedAt: Date.now(),
            rideId: rideId
        });
        
        EnhancedUIUpdater.hideLoading();
        EnhancedUIUpdater.showToast('Scheduled ride requested! Searching for driver...', 'success');
        
    } catch (error) {
        EnhancedUIUpdater.hideLoading();
        console.error('Error requesting scheduled ride:', error);
        EnhancedUIUpdater.showToast('Error requesting scheduled ride', 'error');
    }
},
    updateTimeline: function(status) {
        const steps = ['stepRequested', 'stepAccepted', 'stepArrived', 'stepStarted', 'stepCompleted'];
        const stepLabels = ['Requested', 'Accepted', 'Arrived', 'Started', 'Completed'];
        let currentIndex = stepLabels.indexOf(status);
        
        if (currentIndex === -1) {
            currentIndex = 0;
        }
        
        steps.forEach((stepId, index) => {
            const step = document.getElementById(stepId);
            const label = step?.parentNode.querySelector('.step-label');
            
            if (step && label) {
                if (index < currentIndex) {
                    step.className = 'step-dot completed';
                    label.className = 'step-label completed';
                } else if (index === currentIndex) {
                    step.className = 'step-dot active';
                    label.className = 'step-label active';
                } else {
                    step.className = 'step-dot';
                    label.className = 'step-label';
                }
            }
        });
    },
    
    showPaymentModal: function(amount, rideData) {
        // Store ride data
        AppState.pendingRideData = rideData;
        AppState.rideFare = amount;
        
        // Update modal content
        const paymentAmount = document.getElementById('paymentAmount');
        if (paymentAmount) {
            paymentAmount.textContent = `ZMW ${amount.toFixed(2)}`;
        }
        
        const originalFareAmount = document.getElementById('originalFareAmount');
        if (originalFareAmount) {
            originalFareAmount.textContent = `ZMW ${amount.toFixed(2)}`;
        }
        
        const finalFareAmount = document.getElementById('finalFareAmount');
        if (finalFareAmount) {
            finalFareAmount.textContent = `ZMW ${amount.toFixed(2)}`;
        }
        
        // Show modal
        const modal = document.getElementById('paymentModal');
        if (modal) {
            modal.style.display = 'block';
            modal.style.zIndex = '10001'; // Ensure it's above other modals
        }
        
        // Reset referral discount
        AppState.referralDiscountApplied = false;
        AppState.referralCodeUsed = null;
        AppState.referralOwnerName = null;
        
        const referralInputSection = document.getElementById('referralDiscountSection');
        if (referralInputSection) {
            referralInputSection.style.display = 'block';
        }
        
        const referralCodeInput = document.getElementById('referralCodeInput');
        if (referralCodeInput) {
            referralCodeInput.value = '';
        }
    },
    
    applyReferralDiscount: function() {
        const referralCodeInput = document.getElementById('referralCodeInput');
        if (!referralCodeInput) return;
        
        const referralCode = referralCodeInput.value.trim();
        
        if (!referralCode) {
            this.showToast('Please enter a referral code', 'warning');
            return;
        }
        
        // Check if referral code is the user's own code
        if (referralCode === AppState.userData?.referralCode) {
            this.showToast('Cannot use your own referral code', 'warning');
            return;
        }
        
        EnhancedFirebaseManager.validateReferralCode(referralCode)
            .then(result => {
                if (result.valid) {
                    AppState.referralDiscountApplied = true;
                    AppState.referralCodeUsed = referralCode;
                    AppState.referralOwnerName = result.ownerName;
                    
                    const discountAmount = AppState.rideFare * 0.5;
                    const newFare = AppState.rideFare - discountAmount;
                    
                    // Update UI
                    const discountAmountElement = document.getElementById('discountAmount');
                    const finalFareAmount = document.getElementById('finalFareAmount');
                    const paymentAmount = document.getElementById('paymentAmount');
                    
                    if (discountAmountElement) discountAmountElement.textContent = `-ZMW ${discountAmount.toFixed(2)}`;
                    if (finalFareAmount) finalFareAmount.textContent = `ZMW ${newFare.toFixed(2)}`;
                    if (paymentAmount) paymentAmount.textContent = `ZMW ${newFare.toFixed(2)}`;
                    
                    // Show referral info
                    const referralInputSection = document.getElementById('referralDiscountSection');
                    if (referralInputSection) {
                        referralInputSection.innerHTML = `
                            <div style="background: #E8F5E9; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                <div style="color: #4CAF50; font-weight: 600; margin-bottom: 5px;">
                                    <i class="fas fa-gift"></i> 50% Discount Applied!
                                </div>
                                <div style="font-size: 14px; color: #333;">
                                    Referral from: <strong>${result.ownerName}</strong>
                                </div>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                    The referral owner will receive K25 after you complete this ride
                                </div>
                                <button onclick="EnhancedUIUpdater.removeReferralDiscount()" style="
                                    margin-top: 10px;
                                    background: none;
                                    border: 1px solid #4CAF50;
                                    color: #4CAF50;
                                    padding: 5px 10px;
                                    border-radius: 4px;
                                    cursor: pointer;
                                    font-size: 12px;
                                ">
                                    Remove Discount
                                </button>
                            </div>
                        `;
                    }
                    
                    this.showToast(`50% discount applied! Referral from ${result.ownerName}`, 'success');
                } else {
                    this.showToast('Invalid referral code', 'error');
                }
            })
            .catch(error => {
                console.error('Error validating referral:', error);
                this.showToast('Error validating referral code', 'error');
            });
    },
    
    removeReferralDiscount: function() {
        AppState.referralDiscountApplied = false;
        AppState.referralCodeUsed = null;
        AppState.referralOwnerName = null;
        
        const newFare = AppState.rideFare;
        
        // Update UI
        const finalFareAmount = document.getElementById('finalFareAmount');
        const paymentAmount = document.getElementById('paymentAmount');
        
        if (finalFareAmount) finalFareAmount.textContent = `ZMW ${newFare.toFixed(2)}`;
        if (paymentAmount) paymentAmount.textContent = `ZMW ${newFare.toFixed(2)}`;
        
        // Reset referral section
        const referralInputSection = document.getElementById('referralDiscountSection');
        if (referralInputSection) {
            referralInputSection.innerHTML = `
                <div class="section-header">
                    <i class="fas fa-gift"></i>
                    <span>Referral Discount (50% off)</span>
                </div>
                <div class="referral-input-group">
                    <input type="text" id="referralCodeInput" placeholder="Enter referral code">
                    <button id="applyReferralBtn" class="btn btn-orange">
                        <i class="fas fa-check"></i> Apply
                    </button>
                </div>
                <div class="discount-breakdown" style="margin-top: 10px;">
                    <div class="price-row">
                        <span>Original Fare:</span>
                        <span id="originalFareAmount">ZMW ${newFare.toFixed(2)}</span>
                    </div>
                    <div class="price-row">
                        <span>Discount:</span>
                        <span id="discountAmount" style="color: var(--success-green);">-ZMW 0.00</span>
                    </div>
                    <div class="price-row total">
                        <span>Final Fare:</span>
                        <span id="finalFareAmount" style="font-weight: bold;">ZMW ${newFare.toFixed(2)}</span>
                    </div>
                </div>
            `;
            
            // Re-attach event listener
            const applyBtn = referralInputSection.querySelector('#applyReferralBtn');
            if (applyBtn) {
                applyBtn.addEventListener('click', () => {
                    EnhancedUIUpdater.applyReferralDiscount();
                });
            }
        }
        
        this.showToast('Referral discount removed', 'info');
    },
    
    showScheduleCountdown: function(scheduledTime, rideData) {
    const now = Date.now();
    const timeUntilRide = scheduledTime - now;
    
    if (timeUntilRide <= 0) {
        // If time has already passed, request the ride immediately
        this.requestScheduledRideNow(rideData);
        return;
    }
    
    // Clear any existing countdown for this ride
    if (AppState.scheduledCountdowns.has(rideData.id)) {
        clearInterval(AppState.scheduledCountdowns.get(rideData.id));
        AppState.scheduledCountdowns.delete(rideData.id);
    }
    
    // Create or update countdown container
    let countdownContainer = document.getElementById('scheduleCountdown');
    if (!countdownContainer) {
        countdownContainer = document.createElement('div');
        countdownContainer.id = 'scheduleCountdown';
        countdownContainer.style.cssText = `
            position: fixed;
            bottom: 100px;
            right: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            padding: 20px;
            z-index: 1000;
            min-width: 300px;
            max-width: 350px;
            border: 2px solid #FF6B35;
        `;
        
        document.body.appendChild(countdownContainer);
    }
    
    const formatTime = (milliseconds) => {
        const hours = Math.floor(milliseconds / (1000 * 60 * 60));
        const minutes = Math.floor((milliseconds % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((milliseconds % (1000 * 60)) / 1000);
        
        return {
            hours: hours.toString().padStart(2, '0'),
            minutes: minutes.toString().padStart(2, '0'),
            seconds: seconds.toString().padStart(2, '0')
        };
    };
    
    const updateCountdown = () => {
        const now = Date.now();
        const timeLeft = scheduledTime - now;
        
        if (timeLeft <= 0) {
            // Time's up! Request the ride
            clearInterval(intervalId);
            this.requestScheduledRideNow(rideData);
            return;
        }
        
        const time = formatTime(timeLeft);
        
        countdownContainer.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <div style="font-weight: 700; color: #FF6B35; font-size: 16px;">
                    <i class="fas fa-clock"></i> Scheduled Ride
                </div>
                <button id="cancelScheduleBtn" style="
                    background: #f44336;
                    color: white;
                    border: none;
                    border-radius: 4px;
                    padding: 5px 10px;
                    cursor: pointer;
                    font-size: 12px;
                    font-weight: 600;
                ">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
            
            <div style="text-align: center; margin-bottom: 15px;">
                <div style="font-size: 28px; font-weight: 700; color: #333; margin-bottom: 5px;" id="countdownTimer">
                    ${time.hours}:${time.minutes}:${time.seconds}
                </div>
                <div style="font-size: 12px; color: #666;">
                    Ride will auto-request when timer ends
                </div>
            </div>
            
            <div style="font-size: 13px; color: #333; margin-bottom: 15px;">
                <div style="margin-bottom: 5px;"><strong>From:</strong> ${rideData.pickupDisplay || rideData.pickup}</div>
                <div style="margin-bottom: 5px;"><strong>To:</strong> ${rideData.destinationDisplay || rideData.destination}</div>
                <div><strong>Fare:</strong> ZMW ${rideData.fare?.toFixed(2) || '0.00'}</div>
            </div>
            
            <div style="background: #FFF3E0; padding: 10px; border-radius: 6px; font-size: 12px; color: #E65100;">
                <i class="fas fa-info-circle"></i> 
                Driver search will start automatically when timer reaches zero
            </div>
        `;
        
        // Add cancel button listener
        const cancelBtn = countdownContainer.querySelector('#cancelScheduleBtn');
        if (cancelBtn) {
            cancelBtn.addEventListener('click', () => {
                if (confirm('Are you sure you want to cancel this scheduled ride?')) {
                    EnhancedFirebaseManager.cancelScheduledRide(rideData.id);
                    countdownContainer.remove();
                    
                    if (AppState.scheduledCountdowns.has(rideData.id)) {
                        clearInterval(AppState.scheduledCountdowns.get(rideData.id));
                        AppState.scheduledCountdowns.delete(rideData.id);
                    }
                    
                    this.showToast('Scheduled ride cancelled', 'success');
                }
            });
        }
    };
    
    // Start interval
    const intervalId = setInterval(updateCountdown, 1000);
    AppState.scheduledCountdowns.set(rideData.id, intervalId);
    
    // Initial update
    updateCountdown();
    
    this.showToast('Ride scheduled successfully! Timer started.', 'success');
},
    
    showSplitRidePopup: function() {
        // Create split ride modal
        const modal = document.createElement('div');
        modal.className = 'split-ride-modal';
        modal.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 10000;
            padding: 20px;
        `;
        
        if (!AppState.pickup || !AppState.destination) {
            modal.innerHTML = `
                <div style="text-align: center; padding: 40px 20px;">
                    <div style="font-size: 48px; color: #FFC107; margin-bottom: 20px;">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div style="font-weight: 600; margin-bottom: 10px;">Set Route First</div>
                    <div style="color: #666; margin-bottom: 20px;">
                        Please set pickup and destination locations before splitting the ride
                    </div>
                    <button id="closeSplitModal" style="
                        padding: 10px 20px;
                        background: #FF6B35;
                        color: white;
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                    ">OK</button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 9999;
            `;
            document.body.appendChild(overlay);
            
            modal.querySelector('#closeSplitModal').addEventListener('click', () => {
                document.body.removeChild(modal);
                document.body.removeChild(overlay);
            });
            
            overlay.addEventListener('click', () => {
                document.body.removeChild(modal);
                document.body.removeChild(overlay);
            });
            
            return;
        }
        
        // Calculate total fare
        const distance = EnhancedPriceCalculator.calculateRideDistanceWithStops(
            AppState.pickup,
            AppState.destination,
            AppState.rideStops.filter(stop => stop.location)
        );
        
        const surge = EnhancedPriceCalculator.getSurgeMultiplier();
        const totalFare = EnhancedPriceCalculator.calculateRideFare(
            distance,
            AppState.selectedRideType,
            surge,
            null,
            AppState.rideStops.filter(stop => stop.location)
        );
        
        let html = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: #333;">
                    <i class="fas fa-user-friends"></i> Split Ride
                </h3>
                <button id="closeSplitModal" style="
                    background: none;
                    border: none;
                    font-size: 24px;
                    cursor: pointer;
                    color: #999;
                "></button>
            </div>
            
            <div style="margin-bottom: 20px; background: #f9f9f9; padding: 15px; border-radius: 8px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span style="color: #666;">Total Fare:</span>
                    <span style="font-weight: 700; font-size: 18px; color: #FF6B35;">ZMW ${totalFare.toFixed(2)}</span>
                </div>
                <div style="font-size: 12px; color: #666;">
                    Split equally between all participants
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <div style="font-weight: 600; margin-bottom: 10px; color: #333;">Split Options</div>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button class="split-option-btn" data-participants="2" style="
                        flex: 1;
                        padding: 12px;
                        background: #e3f2fd;
                        border: 2px solid #2196F3;
                        border-radius: 8px;
                        cursor: pointer;
                        font-weight: 600;
                        color: #2196F3;
                    ">
                        Split with 1 Friend
                    </button>
                    <button class="split-option-btn" data-participants="3" style="
                        flex: 1;
                        padding: 12px;
                        background: #f3e5f5;
                        border: 2px solid #9C27B0;
                        border-radius: 8px;
                        cursor: pointer;
                        font-weight: 600;
                        color: #9C27B0;
                    ">
                        Split with 2 Friends
                    </button>
                    <button class="split-option-btn" data-participants="4" style="
                        flex: 1;
                        padding: 12px;
                        background: #e8f5e9;
                        border: 2px solid #4CAF50;
                        border-radius: 8px;
                        cursor: pointer;
                        font-weight: 600;
                        color: #4CAF50;
                    ">
                        Split with 3 Friends
                    </button>
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <div style="font-weight: 600; margin-bottom: 10px; color: #333;">Add Friends by Referral Code</div>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <input type="text" id="splitFriendCode" placeholder="Enter friend's referral code" style="
                        flex: 1;
                        padding: 10px;
                        border: 1px solid #e0e0e0;
                        border-radius: 6px;
                        font-size: 14px;
                    ">
                    <button id="addSplitFriendBtn" style="
                        padding: 10px 20px;
                        background: #FF6B35;
                        color: white;
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                        font-weight: 600;
                    ">
                        <i class="fas fa-plus"></i> Add
                    </button>
                </div>
                
                <div id="splitFriendsList" style="
                    max-height: 200px;
                    overflow-y: auto;
                    border: 1px solid #e0e0e0;
                    border-radius: 6px;
                    padding: 10px;
                ">
                    <div style="text-align: center; padding: 20px; color: #999;">
                        No friends added yet
                    </div>
                </div>
            </div>
            
            <div id="splitCalculations" style="display: none;">
                <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="font-weight: 600; margin-bottom: 10px; color: #333;">Split Calculation</div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>Total Fare:</span>
                        <span>ZMW <span id="splitTotalFare">${totalFare.toFixed(2)}</span></span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>Participants:</span>
                        <span id="splitParticipants">2</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-weight: 600; padding-top: 10px; border-top: 1px solid #ddd;">
                        <span>Your Share:</span>
                        <span style="color: #FF6B35;">ZMW <span id="splitYourShare">${(totalFare / 2).toFixed(2)}</span></span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 13px; color: #666;">
                        <span>Each Friend's Share:</span>
                        <span>ZMW <span id="splitFriendShare">${(totalFare / 2).toFixed(2)}</span></span>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button id="confirmSplitRideBtn" style="
                    flex: 1;
                    padding: 15px;
                    background: #FF6B35;
                    color: white;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                    font-weight: 600;
                    font-size: 16px;
                ">
                    <i class="fas fa-user-friends"></i> Request Split Ride
                </button>
                <button id="cancelSplitBtn" style="
                    padding: 15px 30px;
                    background: #f5f5f5;
                    color: #666;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                    font-weight: 600;
                ">
                    Cancel
                </button>
            </div>
        `;
        
        modal.innerHTML = html;
        document.body.appendChild(modal);
        
        // Add overlay
        const overlay = document.createElement('div');
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
        `;
        document.body.appendChild(overlay);
        
        // Initialize state for this split ride
        const splitRideState = {
            friends: [],
            selectedParticipants: 2,
            totalFare: totalFare
        };
        
        // Event listeners
        modal.querySelector('#closeSplitModal').addEventListener('click', () => {
            document.body.removeChild(modal);
            document.body.removeChild(overlay);
        });
        
        overlay.addEventListener('click', () => {
            document.body.removeChild(modal);
            document.body.removeChild(overlay);
        });
        
        modal.querySelector('#cancelSplitBtn').addEventListener('click', () => {
            document.body.removeChild(modal);
            document.body.removeChild(overlay);
        });
        
        // Split option buttons
        modal.querySelectorAll('.split-option-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // Remove active class from all buttons
                modal.querySelectorAll('.split-option-btn').forEach(b => {
                    b.style.opacity = '0.7';
                });
                
                // Add active class to clicked button
                btn.style.opacity = '1';
                
                const participants = parseInt(btn.dataset.participants);
                splitRideState.selectedParticipants = participants;
                
                // Update calculations
                updateSplitCalculations();
            });
        });
        
        // Set default active button
        modal.querySelector('.split-option-btn[data-participants="2"]').style.opacity = '1';
        
        // Add friend button
        modal.querySelector('#addSplitFriendBtn').addEventListener('click', () => {
            const codeInput = modal.querySelector('#splitFriendCode');
            const code = codeInput.value.trim();
            
            if (!code) {
                this.showToast('Please enter a referral code', 'warning');
                return;
            }
            
            if (splitRideState.friends.length >= splitRideState.selectedParticipants - 1) {
                this.showToast(`Maximum ${splitRideState.selectedParticipants - 1} friends allowed for this split option`, 'warning');
                return;
            }
            
            if (splitRideState.friends.some(f => f.code === code)) {
                this.showToast('Friend already added', 'warning');
                return;
            }
            
            // Check if it's user's own code
            if (code === AppState.userData?.referralCode) {
                this.showToast('Cannot add your own referral code', 'warning');
                return;
            }
            
            // Find friend by referral code
            EnhancedFirebaseManager.findUserByReferralCode(code)
                .then(friendData => {
                    if (friendData) {
                        const friend = {
                            code: code,
                            name: friendData.name,
                            userId: friendData.uid,
                            status: 'pending'
                        };
                        
                        splitRideState.friends.push(friend);
                        updateFriendsList();
                        updateSplitCalculations();
                        
                        codeInput.value = '';
                        this.showToast(`${friend.name} added to split ride`, 'success');
                    } else {
                        this.showToast('Friend not found. Please check the referral code.', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error finding friend:', error);
                    this.showToast('Error adding friend', 'error');
                });
        });
        
        // Confirm split ride button
        modal.querySelector('#confirmSplitRideBtn').addEventListener('click', () => {
            if (splitRideState.friends.length === 0) {
                this.showToast('Please add at least one friend', 'warning');
                return;
            }
            
            if (splitRideState.friends.length !== splitRideState.selectedParticipants - 1) {
                this.showToast(`Please add exactly ${splitRideState.selectedParticipants - 1} friends for this split option`, 'warning');
                return;
            }
            
            // Create split ride data
            const splitRideData = {
                pickup: AppState.pickup,
                destination: AppState.destination,
                rideType: AppState.selectedRideType,
                totalFare: splitRideState.totalFare,
                participants: splitRideState.selectedParticipants,
                friends: splitRideState.friends,
                stops: AppState.rideStops.filter(stop => stop.location),
                distance: distance
            };
            
            // Calculate each person's share
            const eachShare = splitRideState.totalFare / splitRideState.selectedParticipants;
            
            // Close modal
            document.body.removeChild(modal);
            document.body.removeChild(overlay);
            
            // Show payment modal
            this.showPaymentModal(eachShare, {
                ...splitRideData,
                isSplitRide: true,
                yourShare: eachShare,
                splitType: 'equal'
            });
        });
        
        // Update friends list
        function updateFriendsList() {
            const friendsList = modal.querySelector('#splitFriendsList');
            
            if (splitRideState.friends.length === 0) {
                friendsList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #999;">
                        No friends added yet
                    </div>
                `;
                return;
            }
            
            let html = '';
            splitRideState.friends.forEach((friend, index) => {
                html += `
                    <div class="split-friend-item" data-index="${index}" style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 10px;
                        border-bottom: 1px solid #eee;
                    ">
                        <div>
                            <div style="font-weight: 600; margin-bottom: 4px;">${friend.name}</div>
                            <div style="font-size: 12px; color: #666;">Code: ${friend.code}</div>
                        </div>
                        <button class="remove-split-friend" data-index="${index}" style="
                            background: #f44336;
                            color: white;
                            border: none;
                            border-radius: 4px;
                            padding: 5px 10px;
                            cursor: pointer;
                            font-size: 12px;
                        ">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            });
            
            friendsList.innerHTML = html;
            
            // Add remove button listeners
            friendsList.querySelectorAll('.remove-split-friend').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(btn.dataset.index);
                    splitRideState.friends.splice(index, 1);
                    updateFriendsList();
                    updateSplitCalculations();
                });
            });
        }
        
        // Update split calculations
        function updateSplitCalculations() {
            const calculationsDiv = modal.querySelector('#splitCalculations');
            const totalParticipants = splitRideState.selectedParticipants;
            const actualParticipants = 1 + splitRideState.friends.length;
            
            if (actualParticipants > 0) {
                calculationsDiv.style.display = 'block';
                
                const totalFare = splitRideState.totalFare;
                const eachShare = totalFare / totalParticipants;
                
                modal.querySelector('#splitTotalFare').textContent = totalFare.toFixed(2);
                modal.querySelector('#splitParticipants').textContent = totalParticipants;
                modal.querySelector('#splitYourShare').textContent = eachShare.toFixed(2);
                modal.querySelector('#splitFriendShare').textContent = eachShare.toFixed(2);
            } else {
                calculationsDiv.style.display = 'none';
            }
        }
        
        // Initial calculations
        updateSplitCalculations();
    },
    
    showBroadcastRidePopup: function() {
        // Create broadcast ride modal
        const modal = document.createElement('div');
        modal.className = 'broadcast-ride-modal';
        modal.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 10000;
            padding: 20px;
        `;
        
        if (!AppState.pickup || !AppState.destination) {
            modal.innerHTML = `
                <div style="text-align: center; padding: 40px 20px;">
                    <div style="font-size: 48px; color: #FFC107; margin-bottom: 20px;">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div style="font-weight: 600; margin-bottom: 10px;">Set Route First</div>
                    <div style="color: #666; margin-bottom: 20px;">
                        Please set pickup and destination locations before broadcasting the ride
                    </div>
                    <button id="closeBroadcastModal" style="
                        padding: 10px 20px;
                        background: #FF6B35;
                        color: white;
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                    ">OK</button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 9999;
            `;
            document.body.appendChild(overlay);
            
            modal.querySelector('#closeBroadcastModal').addEventListener('click', () => {
                document.body.removeChild(modal);
                document.body.removeChild(overlay);
            });
            
            overlay.addEventListener('click', () => {
                document.body.removeChild(modal);
                document.body.removeChild(overlay);
            });
            
            return;
        }
        
        // Calculate fare
        const distance = EnhancedPriceCalculator.calculateRideDistanceWithStops(
            AppState.pickup,
            AppState.destination,
            AppState.rideStops.filter(stop => stop.location)
        );
        
        const surge = EnhancedPriceCalculator.getSurgeMultiplier();
        const totalFare = EnhancedPriceCalculator.calculateRideFare(
            distance,
            AppState.selectedRideType,
            surge,
            null,
            AppState.rideStops.filter(stop => stop.location)
        );
        
        let html = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: #333;">
                    <i class="fas fa-broadcast-tower"></i> Broadcast Ride
                </h3>
                <button id="closeBroadcastModal" style="
                    background: none;
                    border: none;
                    font-size: 24px;
                    cursor: pointer;
                    color: #999;
                "></button>
            </div>
            
            <div style="margin-bottom: 20px; background: #f9f9f9; padding: 15px; border-radius: 8px;">
                <div style="margin-bottom: 10px;">
                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">From:</div>
                    <div style="font-weight: 600;">${AppState.pickup.address}</div>
                </div>
                <div style="margin-bottom: 10px;">
                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">To:</div>
                    <div style="font-weight: 600;">${AppState.destination.address}</div>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <div>
                        <div style="font-size: 12px; color: #666;">Distance</div>
                        <div style="font-weight: 600;">${distance.toFixed(1)} km</div>
                    </div>
                    <div>
                        <div style="font-size: 12px; color: #666;">Fare</div>
                        <div style="font-weight: 700; color: #FF6B35;">ZMW ${totalFare.toFixed(2)}</div>
                    </div>
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <div style="font-weight: 600; margin-bottom: 10px; color: #333;">Add Referral Codes to Broadcast To</div>
                <div style="font-size: 13px; color: #666; margin-bottom: 15px;">
                    Friends will be able to track your ride in real-time
                </div>
                
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <input type="text" id="broadcastFriendCode" placeholder="Enter referral code" style="
                        flex: 1;
                        padding: 10px;
                        border: 1px solid #e0e0e0;
                        border-radius: 6px;
                        font-size: 14px;
                    ">
                    <button id="addBroadcastFriendBtn" style="
                        padding: 10px 20px;
                        background: #FF6B35;
                        color: white;
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                        font-weight: 600;
                    ">
                        <i class="fas fa-plus"></i> Add
                    </button>
                </div>
                
                <div id="broadcastFriendsList" style="
                    max-height: 200px;
                    overflow-y: auto;
                    border: 1px solid #e0e0e0;
                    border-radius: 6px;
                    padding: 10px;
                ">
                    <div style="text-align: center; padding: 20px; color: #999;">
                        No friends added yet
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button id="confirmBroadcastRideBtn" style="
                    flex: 1;
                    padding: 15px;
                    background: #FF6B35;
                    color: white;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                    font-weight: 600;
                    font-size: 16px;
                ">
                    <i class="fas fa-broadcast-tower"></i> Start Broadcasting
                </button>
                <button id="cancelBroadcastBtn" style="
                    padding: 15px 30px;
                    background: #f5f5f5;
                    color: #666;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                    font-weight: 600;
                ">
                    Cancel
                </button>
            </div>
        `;
        
        modal.innerHTML = html;
        document.body.appendChild(modal);
        
        // Add overlay
        const overlay = document.createElement('div');
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
        `;
        document.body.appendChild(overlay);
        
        // Initialize state for this broadcast
        const broadcastState = {
            friends: []
        };
        
        // Event listeners
        modal.querySelector('#closeBroadcastModal').addEventListener('click', () => {
            document.body.removeChild(modal);
            document.body.removeChild(overlay);
        });
        
        overlay.addEventListener('click', () => {
            document.body.removeChild(modal);
            document.body.removeChild(overlay);
        });
        
        modal.querySelector('#cancelBroadcastBtn').addEventListener('click', () => {
            document.body.removeChild(modal);
            document.body.removeChild(overlay);
        });
        
        // Add friend button
        modal.querySelector('#addBroadcastFriendBtn').addEventListener('click', () => {
            const codeInput = modal.querySelector('#broadcastFriendCode');
            const code = codeInput.value.trim();
            
            if (!code) {
                this.showToast('Please enter a referral code', 'warning');
                return;
            }
            
            // Check if it's user's own code
            if (code === AppState.userData?.referralCode) {
                this.showToast('Cannot add your own referral code', 'warning');
                return;
            }
            
            if (broadcastState.friends.some(f => f.code === code)) {
                this.showToast('Friend already added', 'warning');
                return;
            }
            
            // Find friend by referral code
            EnhancedFirebaseManager.findUserByReferralCode(code)
                .then(friendData => {
                    if (friendData) {
                        const friend = {
                            code: code,
                            name: friendData.name,
                            userId: friendData.uid,
                            status: 'invited'
                        };
                        
                        broadcastState.friends.push(friend);
                        updateFriendsList();
                        
                        codeInput.value = '';
                        this.showToast(`${friend.name} added to broadcast`, 'success');
                    } else {
                        this.showToast('Friend not found. Please check the referral code.', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error finding friend:', error);
                    this.showToast('Error adding friend', 'error');
                });
        });
        
        // Confirm broadcast ride button
        modal.querySelector('#confirmBroadcastRideBtn').addEventListener('click', () => {
            if (broadcastState.friends.length === 0) {
                this.showToast('Please add at least one friend to broadcast to', 'warning');
                return;
            }
            
            // Create broadcast ride data
            const broadcastRideData = {
                pickup: AppState.pickup,
                destination: AppState.destination,
                rideType: AppState.selectedRideType,
                totalFare: totalFare,
                friends: broadcastState.friends,
                stops: AppState.rideStops.filter(stop => stop.location),
                distance: distance,
                isBroadcast: true
            };
            
            // Close modal
            document.body.removeChild(modal);
            document.body.removeChild(overlay);
            
            // Show payment modal
            this.showPaymentModal(totalFare, broadcastRideData);
        });
        
        // Update friends list
        function updateFriendsList() {
            const friendsList = modal.querySelector('#broadcastFriendsList');
            
            if (broadcastState.friends.length === 0) {
                friendsList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #999;">
                        No friends added yet
                    </div>
                `;
                return;
            }
            
            let html = '';
            broadcastState.friends.forEach((friend, index) => {
                html += `
                    <div class="broadcast-friend-item" data-index="${index}" style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 10px;
                        border-bottom: 1px solid #eee;
                    ">
                        <div>
                            <div style="font-weight: 600; margin-bottom: 4px;">${friend.name}</div>
                            <div style="font-size: 12px; color: #666;">Code: ${friend.code}</div>
                        </div>
                        <button class="remove-broadcast-friend" data-index="${index}" style="
                            background: #f44336;
                            color: white;
                            border: none;
                            border-radius: 4px;
                            padding: 5px 10px;
                            cursor: pointer;
                            font-size: 12px;
                        ">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            });
            
            friendsList.innerHTML = html;
            
            // Add remove button listeners
            friendsList.querySelectorAll('.remove-broadcast-friend').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(btn.dataset.index);
                    broadcastState.friends.splice(index, 1);
                    updateFriendsList();
                });
            });
        }
    },
    
    showEmergencyStations: function(type) {
        if (!AppState.currentCity) {
            this.showToast('Please wait while we detect your city', 'warning');
            return;
        }
        
        EnhancedUIUpdater.showLoading(`Finding ${type} stations...`);
        
        EnhancedSearchEngine.searchEmergencyStations(type, AppState.currentCity)
            .then(stations => {
                EnhancedUIUpdater.hideLoading();
                
                if (stations.length === 0) {
                    this.showToast(`No ${type} stations found in your city`, 'info');
                    return;
                }
                
                // Create emergency stations modal
                const modal = document.createElement('div');
                modal.className = 'emergency-stations-modal';
                modal.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: white;
                    border-radius: 12px;
                    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
                    width: 90%;
                    max-width: 500px;
                    max-height: 80vh;
                    overflow-y: auto;
                    z-index: 10000;
                    padding: 20px;
                `;
                
                const emergencyTypeNames = {
                    police: 'Police Stations',
                    fire: 'Fire Stations',
                    medical: 'Medical Stations'
                };
                
                const emergencyIcons = {
                    police: 'fa-shield-alt',
                    fire: 'fa-fire-extinguisher',
                    medical: 'fa-ambulance'
                };
                
                const emergencyColors = {
                    police: '#2196F3',
                    fire: '#F44336',
                    medical: '#4CAF50'
                };
                
                let html = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: ${emergencyColors[type]};">
                            <i class="fas ${emergencyIcons[type]}"></i> ${emergencyTypeNames[type]}
                        </h3>
                        <button id="closeEmergencyModal" style="
                            background: none;
                            border: none;
                            font-size: 24px;
                            cursor: pointer;
                            color: #999;
                        "></button>
                    </div>
                    
                    <div style="font-size: 14px; color: #666; margin-bottom: 20px;">
                        Select a station (closest first):
                    </div>
                    
                    <div id="emergencyStationsList" style="
                        display: flex;
                        flex-direction: column;
                        gap: 10px;
                        margin-bottom: 20px;
                    ">
                `;
                
                stations.forEach((station, index) => {
                    // Calculate fare
                    const fare = EnhancedPriceCalculator.calculateEmergencyFare(
                        station.distance,
                        type
                    );
                    
                    html += `
                        <div class="emergency-station-item" data-index="${index}" style="
                            padding: 15px;
                            border: 2px solid #e0e0e0;
                            border-radius: 8px;
                            cursor: pointer;
                            transition: all 0.2s;
                        ">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                        <div style="color: ${emergencyColors[type]}; font-size: 20px;">
                                            <i class="fas ${emergencyIcons[type]}"></i>
                                        </div>
                                        <div style="font-weight: 600; font-size: 16px;">${station.name}</div>
                                    </div>
                                    <div style="font-size: 13px; color: #666; margin-bottom: 8px;">${station.address}</div>
                                    <div style="display: flex; gap: 15px; font-size: 12px;">
                                        <div style="color: #FF6B35;">
                                            <i class="fas fa-location-arrow"></i> ${station.distance.toFixed(1)} km
                                        </div>
                                        <div style="color: #4CAF50; font-weight: 600;">
                                            <i class="fas fa-money-bill-wave"></i> ZMW ${fare.toFixed(2)}
                                        </div>
                                    </div>
                                </div>
                                <div style="color: #4CAF50; font-size: 24px; display: none;">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                    </div>
                    
                    <div id="emergencyReasonSection" style="display: none; margin-bottom: 20px;">
                        <div style="font-weight: 600; margin-bottom: 10px; color: #333;">Reason for Emergency</div>
                        <div id="emergencyReasons" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px;">
                `;
                
                // Add reasons based on type
                const reasons = {
                    police: ['Accident', 'Crime/Assault', 'Theft', 'Disturbance', 'Suspicious Activity', 'Other'],
                    fire: ['Fire', 'Gas Leak', 'Rescue', 'Hazardous Materials', 'Other'],
                    medical: ['Accident', 'Medical Emergency', 'Injury', 'Illness', 'Other']
                };
                
                reasons[type].forEach(reason => {
                    html += `
                        <button class="emergency-reason-btn" data-reason="${reason}" style="
                            padding: 8px 12px;
                            background: #f5f5f5;
                            border: 1px solid #e0e0e0;
                            border-radius: 20px;
                            cursor: pointer;
                            font-size: 13px;
                        ">${reason}</button>
                    `;
                });
                
                html += `
                        </div>
                        <div id="otherReasonInput" style="display: none;">
                            <textarea id="emergencyOtherReason" placeholder="Please describe the emergency..." style="
                                width: 100%;
                                padding: 10px;
                                border: 1px solid #e0e0e0;
                                border-radius: 6px;
                                font-size: 14px;
                                resize: vertical;
                                min-height: 80px;
                            "></textarea>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button id="confirmEmergencyBtn" style="
                            flex: 1;
                            padding: 15px;
                            background: ${emergencyColors[type]};
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                            font-weight: 600;
                            font-size: 16px;
                            display: none;
                        ">
                            <i class="fas fa-exclamation-triangle"></i> Request Emergency Ride
                        </button>
                        <button id="cancelEmergencyBtn" style="
                            padding: 15px 30px;
                            background: #f5f5f5;
                            color: #666;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                            font-weight: 600;
                        ">
                            Cancel
                        </button>
                    </div>
                `;
                
                modal.innerHTML = html;
                document.body.appendChild(modal);
                
                // Add overlay
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0,0,0,0.5);
                    z-index: 9999;
                `;
                document.body.appendChild(overlay);
                
                // State
                let selectedStation = null;
                let selectedReason = null;
                let otherReasonText = '';
                
                // Event listeners
                modal.querySelector('#closeEmergencyModal').addEventListener('click', () => {
                    document.body.removeChild(modal);
                    document.body.removeChild(overlay);
                });
                
                overlay.addEventListener('click', () => {
                    document.body.removeChild(modal);
                    document.body.removeChild(overlay);
                });
                
                modal.querySelector('#cancelEmergencyBtn').addEventListener('click', () => {
                    document.body.removeChild(modal);
                    document.body.removeChild(overlay);
                });
                
                // Station selection
                modal.querySelectorAll('.emergency-station-item').forEach((item, index) => {
                    item.addEventListener('click', () => {
                        // Remove selection from all stations
                        modal.querySelectorAll('.emergency-station-item').forEach(i => {
                            i.style.borderColor = '#e0e0e0';
                            i.querySelector('.fa-check-circle').parentElement.style.display = 'none';
                        });
                        
                        // Add selection to clicked station
                        item.style.borderColor = emergencyColors[type];
                        item.querySelector('.fa-check-circle').parentElement.style.display = 'block';
                        
                        selectedStation = stations[index];
                        
                        // Show reason section
                        modal.querySelector('#emergencyReasonSection').style.display = 'block';
                        modal.querySelector('#confirmEmergencyBtn').style.display = 'block';
                    });
                });
                
                // Reason selection
                modal.querySelectorAll('.emergency-reason-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        // Remove active class from all reasons
                        modal.querySelectorAll('.emergency-reason-btn').forEach(b => {
                            b.style.background = '#f5f5f5';
                            b.style.borderColor = '#e0e0e0';
                            b.style.color = '#333';
                        });
                        
                        // Add active class to clicked reason
                        btn.style.background = emergencyColors[type];
                        btn.style.borderColor = emergencyColors[type];
                        btn.style.color = 'white';
                        
                        selectedReason = btn.dataset.reason;
                        
                        // Show other reason input if selected
                        const otherInput = modal.querySelector('#otherReasonInput');
                        if (selectedReason === 'Other') {
                            otherInput.style.display = 'block';
                        } else {
                            otherInput.style.display = 'none';
                        }
                    });
                });
                
                // Other reason text change
                const otherReasonInput = modal.querySelector('#emergencyOtherReason');
                if (otherReasonInput) {
                    otherReasonInput.addEventListener('input', (e) => {
                        otherReasonText = e.target.value;
                    });
                }
                
                // Confirm emergency ride
                modal.querySelector('#confirmEmergencyBtn').addEventListener('click', () => {
                    if (!selectedStation) {
                        this.showToast('Please select a station', 'warning');
                        return;
                    }
                    
                    if (!selectedReason) {
                        this.showToast('Please select a reason', 'warning');
                        return;
                    }
                    
                    if (selectedReason === 'Other' && !otherReasonText.trim()) {
                        this.showToast('Please describe the emergency', 'warning');
                        return;
                    }
                    
                    const finalReason = selectedReason === 'Other' ? otherReasonText : selectedReason;
                    
                    // Calculate fare
                    const fare = EnhancedPriceCalculator.calculateEmergencyFare(
                        selectedStation.distance,
                        type
                    );
                    
                    // Create emergency ride data
                    const emergencyRideData = {
                        pickup: AppState.userLocation ? {
                            lat: AppState.userLocation.lat,
                            lng: AppState.userLocation.lng,
                            address: 'Current Location'
                        } : AppState.pickup,
                        destination: {
                            lat: selectedStation.lat,
                            lng: selectedStation.lng,
                            address: selectedStation.address,
                            name: selectedStation.name
                        },
                        emergencyType: type,
                        station: selectedStation,
                        reason: finalReason,
                        fare: fare,
                        distance: selectedStation.distance,
                        isEmergency: true
                    };
                    
                    // Close modal
                    document.body.removeChild(modal);
                    document.body.removeChild(overlay);
                    
                    // Show payment modal
                    this.showPaymentModal(fare, emergencyRideData);
                });
                
            })
            .catch(error => {
                EnhancedUIUpdater.hideLoading();
                console.error('Error loading emergency stations:', error);
                this.showToast('Error loading emergency stations', 'error');
            });
    },
   // Find the showNotificationsPanel method in EnhancedUIUpdater and update it to:
showNotificationsPanel: function() {
    const panel = document.getElementById('notificationsPanel');
    if (panel) {
        panel.classList.add('active');
        AppState.notificationsOpen = true;
        
        // Update notifications in the panel
        this.updateNotifications(AppState.notifications);
        
        // Mark all as read
        EnhancedFirebaseManager.markAllNotificationsAsRead();
        
        // Update notification badge
        AppState.unreadNotifications = 0;
        const badge = document.getElementById('notificationCount');
        if (badge) {
            badge.style.display = 'none';
        }
    }
},

// Find the hideNotificationsPanel method and update it to:
hideNotificationsPanel: function() {
    const panel = document.getElementById('notificationsPanel');
    if (panel) {
        panel.classList.remove('active');
        AppState.notificationsOpen = false;
    }
},

// Find the updateNotifications method and update it to:
updateNotifications: function(notifications) {
    const container = document.getElementById('notificationsList');
    if (!container) return;
    
    // Sort by timestamp (newest first)
    const sortedNotifications = notifications.sort((a, b) => b.timestamp - a.timestamp);
    
    if (sortedNotifications.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px 20px; color: #999;">
                <i class="fas fa-bell-slash" style="font-size: 48px; margin-bottom: 20px;"></i>
                <div style="font-weight: 600; margin-bottom: 10px;">No notifications</div>
                <div>You're all caught up!</div>
            </div>
        `;
        return;
    }
    
    let html = '';
    
    sortedNotifications.forEach(notification => {
        const time = new Date(notification.timestamp);
        const timeString = this.formatTimeAgo(notification.timestamp);
        
        let icon = 'fa-info-circle';
        let iconColor = '#2196F3';
        
        switch(notification.type) {
            case 'success':
                icon = 'fa-check-circle';
                iconColor = '#4CAF50';
                break;
            case 'error':
                icon = 'fa-exclamation-circle';
                iconColor = '#F44336';
                break;
            case 'warning':
                icon = 'fa-exclamation-triangle';
                iconColor = '#FFC107';
                break;
            case 'ride':
                icon = 'fa-car';
                iconColor = '#FF6B35';
                break;
            case 'payment':
                icon = 'fa-money-bill-wave';
                iconColor = '#4CAF50';
                break;
            case 'referral':
                icon = 'fa-gift';
                iconColor = '#FF6B35';
                break;
            case 'split':
                icon = 'fa-user-friends';
                iconColor = '#2196F3';
                break;
            case 'broadcast':
                icon = 'fa-broadcast-tower';
                iconColor = '#FFC107';
                break;
        }
        
        html += `
            <div class="notification-item ${notification.read ? '' : 'unread'}" data-notification-id="${notification.id}">
                <div style="display: flex; gap: 12px;">
                    <div style="color: ${iconColor}; font-size: 20px; margin-top: 2px;">
                        <i class="fas ${icon}"></i>
                    </div>
                    <div style="flex: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px;">
                            <div style="font-weight: 600; color: #333;">${notification.title || 'Notification'}</div>
                            <div style="font-size: 12px; color: #999;">${timeString}</div>
                        </div>
                        <div style="color: #666; font-size: 14px; margin-bottom: 8px;">${notification.message}</div>
                        ${notification.data ? `
                        <div style="font-size: 12px; color: #999;">
                            ${notification.data.rideId ? `Ride ID: ${notification.data.rideId.substring(0, 8)}...` : ''}
                        </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
    
    // Add click handlers for each notification
    container.querySelectorAll('.notification-item').forEach(item => {
        item.addEventListener('click', (e) => {
            e.stopPropagation();
            const notificationId = item.dataset.notificationId;
            const notification = sortedNotifications.find(n => n.id === notificationId);
            
            if (notification) {
                this.handleNotificationClick(notification);
            }
        });
    });
},

// Add this new method to EnhancedUIUpdater (place it after updateNotifications):
handleNotificationClick: function(notification) {
    console.log('Notification clicked:', notification);
    
    // Mark as read if not already read
    if (!notification.read) {
        EnhancedFirebaseManager.markNotificationAsRead(notification.id);
    }
    
    // Handle different notification types
    this.handleNotificationAction(notification);
    
    // Close notifications panel
    this.hideNotificationsPanel();
},

// Update the handleNotificationAction method to:
handleNotificationAction: function(notification) {
    const action = notification.action;
    const data = notification.data;
    
    switch(action) {
        case 'view_ride':
            if (data && data.rideId) {
                // Load and show ride details
                EnhancedFirebaseManager.loadRideDetails(data.rideId);
                // Switch to home screen if needed
                if (AppState.activeScreen !== 'home') {
                    switchScreen('home');
                }
            }
            break;
            
        case 'open_chat':
            if (data && data.rideId && AppState.currentRide && AppState.currentRide.id === data.rideId) {
                // Open chat for current ride
                const chatContainer = document.getElementById('chatContainer');
                if (chatContainer) {
                    chatContainer.classList.add('active');
                    AppState.chatOpen = true;
                }
            }
            break;
            
        case 'accept_split_invite':
            if (data && data.splitRideId) {
                this.showSplitRideAcceptanceModal(data.splitRideId);
            }
            break;
            
        case 'accept_broadcast_invite':
            if (data && data.broadcastId) {
                this.showBroadcastTrackingModal(data.broadcastId);
            }
            break;
            
        default:
            // For notifications without specific actions, just show a toast
            EnhancedUIUpdater.showToast(notification.message, notification.type || 'info');
            break;
    }
},
    
    handleNotificationAction: function(action, data) {
        switch(action) {
            case 'view_ride':
                if (data.rideId) {
                    EnhancedFirebaseManager.loadRideDetails(data.rideId);
                }
                break;
            case 'accept_split_invite':
                if (data.splitRideId) {
                    this.showSplitRideAcceptanceModal(data.splitRideId);
                }
                break;
            case 'accept_broadcast_invite':
                if (data.broadcastId) {
                    this.showBroadcastTrackingModal(data.broadcastId);
                }
                break;
        }
    },
    
    showSplitRideAcceptanceModal: function(splitRideId) {
        // Fetch split ride details
        EnhancedFirebaseManager.getSplitRideDetails(splitRideId)
            .then(splitRide => {
                if (!splitRide) {
                    this.showToast('Split ride not found', 'error');
                    return;
                }
                
                // Create acceptance modal
                const modal = document.createElement('div');
                modal.className = 'split-acceptance-modal';
                modal.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: white;
                    border-radius: 12px;
                    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
                    width: 90%;
                    max-width: 400px;
                    z-index: 10000;
                    padding: 20px;
                `;
                
                const yourShare = splitRide.totalFare / splitRide.participants;
                
                modal.innerHTML = `
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 48px; color: #2196F3; margin-bottom: 15px;">
                            <i class="fas fa-user-friends"></i>
                        </div>
                        <div style="font-weight: 600; font-size: 18px; margin-bottom: 10px; color: #333;">
                            Split Ride Invitation
                        </div>
                        <div style="color: #666; margin-bottom: 5px;">
                            From: <strong>${splitRide.hostName}</strong>
                        </div>
                    </div>
                    
                    <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="margin-bottom: 10px;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">From:</div>
                            <div style="font-weight: 600;">${splitRide.pickup}</div>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">To:</div>
                            <div style="font-weight: 600;">${splitRide.destination}</div>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <div>
                                <div style="font-size: 12px; color: #666;">Your Share</div>
                                <div style="font-weight: 700; color: #FF6B35; font-size: 18px;">ZMW ${yourShare.toFixed(2)}</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #666;">Participants</div>
                                <div style="font-weight: 600; font-size: 16px;">${splitRide.participants}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button id="acceptSplitInviteBtn" style="
                            flex: 1;
                            padding: 15px;
                            background: #4CAF50;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                            font-weight: 600;
                            font-size: 16px;
                        ">
                            <i class="fas fa-check"></i> Accept
                        </button>
                        <button id="rejectSplitInviteBtn" style="
                            flex: 1;
                            padding: 15px;
                            background: #f44336;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                            font-weight: 600;
                            font-size: 16px;
                        ">
                            <i class="fas fa-times"></i> Reject
                        </button>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Add overlay
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0,0,0,0.5);
                    z-index: 9999;
                `;
                document.body.appendChild(overlay);
                
                // Event listeners
                modal.querySelector('#acceptSplitInviteBtn').addEventListener('click', () => {
                    EnhancedFirebaseManager.acceptSplitRideInvitation(splitRideId, AppState.currentUser.uid)
                        .then(() => {
                            document.body.removeChild(modal);
                            document.body.removeChild(overlay);
                            
                            // Show payment modal for user's share
                            this.showPaymentModal(yourShare, {
                                ...splitRide,
                                isSplitRide: true,
                                yourShare: yourShare,
                                splitRideId: splitRideId
                            });
                        })
                        .catch(error => {
                            console.error('Error accepting split ride:', error);
                            this.showToast('Error accepting invitation', 'error');
                        });
                });
                
                modal.querySelector('#rejectSplitInviteBtn').addEventListener('click', () => {
                    EnhancedFirebaseManager.rejectSplitRideInvitation(splitRideId, AppState.currentUser.uid)
                        .then(() => {
                            document.body.removeChild(modal);
                            document.body.removeChild(overlay);
                            this.showToast('Invitation rejected', 'info');
                        })
                        .catch(error => {
                            console.error('Error rejecting split ride:', error);
                            this.showToast('Error rejecting invitation', 'error');
                        });
                });
                
                overlay.addEventListener('click', () => {
                    document.body.removeChild(modal);
                    document.body.removeChild(overlay);
                });
            })
            .catch(error => {
                console.error('Error fetching split ride details:', error);
                this.showToast('Error loading invitation', 'error');
            });
    },
    
    showBroadcastTrackingModal: function(broadcastId) {
        // Fetch broadcast details
        EnhancedFirebaseManager.getBroadcastDetails(broadcastId)
            .then(broadcast => {
                if (!broadcast) {
                    this.showToast('Broadcast not found', 'error');
                    return;
                }
                
                // Create tracking modal
                const modal = document.createElement('div');
                modal.className = 'broadcast-tracking-modal';
                modal.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: white;
                    border-radius: 12px;
                    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
                    width: 90%;
                    max-width: 400px;
                    z-index: 10000;
                    padding: 20px;
                `;
                
                modal.innerHTML = `
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 48px; color: #FFC107; margin-bottom: 15px;">
                            <i class="fas fa-broadcast-tower"></i>
                        </div>
                        <div style="font-weight: 600; font-size: 18px; margin-bottom: 10px; color: #333;">
                            Broadcast Ride
                        </div>
                        <div style="color: #666; margin-bottom: 5px;">
                            From: <strong>${broadcast.hostName}</strong>
                        </div>
                    </div>
                    
                    <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="margin-bottom: 10px;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">From:</div>
                            <div style="font-weight: 600;">${broadcast.pickup}</div>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">To:</div>
                            <div style="font-weight: 600;">${broadcast.destination}</div>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <div>
                                <div style="font-size: 12px; color: #666;">Distance</div>
                                <div style="font-weight: 600;">${broadcast.distance.toFixed(1)} km</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #666;">Fare</div>
                                <div style="font-weight: 700; color: #FF6B35;">ZMW ${broadcast.fare.toFixed(2)}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="font-size: 14px; color: #666; margin-bottom: 20px; text-align: center;">
                        You can track this ride in real-time
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button id="trackBroadcastBtn" style="
                            flex: 1;
                            padding: 15px;
                            background: #FF6B35;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                            font-weight: 600;
                            font-size: 16px;
                        ">
                            <i class="fas fa-map-marker-alt"></i> Track Ride
                        </button>
                        <button id="closeBroadcastTrackingBtn" style="
                            padding: 15px 30px;
                            background: #f5f5f5;
                            color: #666;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                            font-weight: 600;
                        ">
                            Close
                        </button>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Add overlay
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0,0,0,0.5);
                    z-index: 9999;
                `;
                document.body.appendChild(overlay);
                
                // Event listeners
                modal.querySelector('#trackBroadcastBtn').addEventListener('click', () => {
                    // Start tracking the broadcast ride
                    EnhancedFirebaseManager.startTrackingBroadcast(broadcastId);
                    
                    document.body.removeChild(modal);
                    document.body.removeChild(overlay);
                    
                    this.showToast('Now tracking broadcast ride', 'success');
                });
                
                modal.querySelector('#closeBroadcastTrackingBtn').addEventListener('click', () => {
                    document.body.removeChild(modal);
                    document.body.removeChild(overlay);
                });
                
                overlay.addEventListener('click', () => {
                    document.body.removeChild(modal);
                    document.body.removeChild(overlay);
                });
            })
            .catch(error => {
                console.error('Error fetching broadcast details:', error);
                this.showToast('Error loading broadcast', 'error');
            });
    },
    
    formatTimeAgo: function(timestamp) {
        const now = Date.now();
        const diff = now - timestamp;
        
        if (diff < 60000) return 'Just now';
        if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
        if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
        if (diff < 604800000) return `${Math.floor(diff / 86400000)}d ago`;
        return new Date(timestamp).toLocaleDateString();
    },
    
    updateWalletTransactions: function(transactions) {
        const container = document.getElementById('transactionsList');
        if (!container) return;
        
        if (transactions.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px 20px; color: #999;">
                    <i class="fas fa-receipt" style="font-size: 48px; margin-bottom: 20px;"></i>
                    <div style="font-weight: 600; margin-bottom: 10px;">No transactions</div>
                    <div>Your transaction history will appear here</div>
                </div>
            `;
            return;
        }
        
        // Sort by timestamp (newest first)
        const sortedTransactions = transactions.sort((a, b) => b.timestamp - a.timestamp);
        
        let html = '';
        
        sortedTransactions.forEach(transaction => {
            const time = new Date(transaction.timestamp);
            const timeString = time.toLocaleDateString() + ' ' + time.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            const isSent = transaction.type === 'sent' || transaction.type === 'withdrawal' || transaction.type === 'payment';
            const isReceived = transaction.type === 'received' || transaction.type === 'deposit' || transaction.type === 'refund' || transaction.type === 'referral';
            
            let icon = 'fa-exchange-alt';
            let iconColor = '#2196F3';
            let sign = '';
            
            if (isSent) {
                icon = 'fa-arrow-up';
                iconColor = '#F44336';
                sign = '-';
            } else if (isReceived) {
                icon = 'fa-arrow-down';
                iconColor = '#4CAF50';
                sign = '+';
            }
            
            if (transaction.type === 'referral') {
                icon = 'fa-gift';
                iconColor = '#FF6B35';
            }
            
            html += `
                <div class="transaction-item" style="
                    padding: 15px;
                    border-bottom: 1px solid #eee;
                ">
                    <div style="display: flex; gap: 12px;">
                        <div style="color: ${iconColor}; font-size: 20px; margin-top: 2px;">
                            <i class="fas ${icon}"></i>
                        </div>
                        <div style="flex: 1;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px;">
                                <div style="font-weight: 600; color: #333;">
                                    ${transaction.type.charAt(0).toUpperCase() + transaction.type.slice(1)}
                                </div>
                                <div style="font-weight: 700; color: ${isSent ? '#F44336' : '#4CAF50'};">
                                    ${sign}ZMW ${transaction.amount.toFixed(2)}
                                </div>
                            </div>
                            <div style="color: #666; font-size: 14px; margin-bottom: 5px;">
                                ${transaction.description || ''}
                            </div>
                            ${transaction.reference ? `
                            <div style="font-size: 12px; color: #999; margin-bottom: 5px;">
                                Ref: ${transaction.reference}
                            </div>
                            ` : ''}
                            ${transaction.fromName || transaction.toName ? `
                            <div style="font-size: 12px; color: #999;">
                                ${transaction.fromName ? `From: ${transaction.fromName}` : ''}
                                ${transaction.toName ? `To: ${transaction.toName}` : ''}
                            </div>
                            ` : ''}
                            <div style="font-size: 11px; color: #999; margin-top: 5px;">
                                ${timeString}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    },
    
    updateRideHistory: function(rides) {
        const container = document.getElementById('historyList');
        if (!container) return;
        
        if (rides.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px 20px; color: #999;">
                    <i class="fas fa-history" style="font-size: 48px; margin-bottom: 20px;"></i>
                    <div style="font-weight: 600; margin-bottom: 10px;">No ride history</div>
                    <div>Your completed rides will appear here</div>
                </div>
            `;
            return;
        }
        
        // Sort by timestamp (newest first)
        const sortedRides = rides.sort((a, b) => b.timestamp - a.timestamp);
        
        let html = '';
        
        sortedRides.forEach(ride => {
            const time = new Date(ride.timestamp);
            const timeString = time.toLocaleDateString() + ' ' + time.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            let icon = 'fa-car';
            let iconColor = '#FF6B35';
            let typeLabel = 'Ride';
            
            if (ride.serviceType === 'delivery') {
                icon = 'fa-shipping-fast';
                iconColor = '#9C27B0';
                typeLabel = 'Delivery';
            } else if (ride.serviceType === 'truck') {
                icon = 'fa-truck';
                iconColor = '#795548';
                typeLabel = 'Truck';
            } else if (ride.serviceType === 'shopping') {
                icon = 'fa-shopping-bag';
                iconColor = '#4CAF50';
                typeLabel = 'Shopping';
            } else if (ride.emergency) {
                icon = 'fa-ambulance';
                iconColor = '#F44336';
                typeLabel = 'Emergency';
            } else if (ride.splitRide) {
                icon = 'fa-user-friends';
                iconColor = '#2196F3';
                typeLabel = 'Split Ride';
            } else if (ride.broadcast) {
                icon = 'fa-broadcast-tower';
                iconColor = '#FFC107';
                typeLabel = 'Broadcast';
            }
            
            const statusColor = ride.status === 'completed' ? '#4CAF50' : 
                               ride.status === 'cancelled' ? '#F44336' : '#FFC107';
            
            html += `
                <div class="history-item" style="
                    padding: 15px;
                    border-bottom: 1px solid #eee;
                    cursor: pointer;
                ">
                    <div style="display: flex; gap: 12px;">
                        <div style="color: ${iconColor}; font-size: 20px; margin-top: 2px;">
                            <i class="fas ${icon}"></i>
                        </div>
                        <div style="flex: 1;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px;">
                                <div style="font-weight: 600; color: #333;">${typeLabel}</div>
                                <div style="font-weight: 700; color: #FF6B35;">ZMW ${ride.fare?.toFixed(2) || '0.00'}</div>
                            </div>
                            <div style="color: #666; font-size: 14px; margin-bottom: 5px;">
                                ${ride.pickupDisplay || ride.pickup}
                            </div>
                            <div style="color: #666; font-size: 14px; margin-bottom: 8px;">
                                <i class="fas fa-arrow-right" style="font-size: 12px; margin: 0 5px;"></i>
                                ${ride.destinationDisplay || ride.destination}
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="font-size: 12px; color: #999;">
                                    ${timeString}
                                </div>
                                <div style="
                                    padding: 3px 8px;
                                    background: ${statusColor};
                                    color: white;
                                    border-radius: 12px;
                                    font-size: 11px;
                                    font-weight: 600;
                                ">
                                    ${ride.status?.charAt(0).toUpperCase() + ride.status?.slice(1) || 'Unknown'}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        
        // Add click handlers
        container.querySelectorAll('.history-item').forEach((item, index) => {
            item.addEventListener('click', () => {
                const ride = sortedRides[index];
                this.showRideDetailsModal(ride);
            });
        });
    },
    
    showRideDetailsModal: function(ride) {
        const modal = document.createElement('div');
        modal.className = 'ride-details-modal';
        modal.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 10000;
            padding: 20px;
        `;
        
        const time = new Date(ride.timestamp);
        const timeString = time.toLocaleDateString() + ' ' + time.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        let icon = 'fa-car';
        let iconColor = '#FF6B35';
        let typeLabel = 'Ride';
        
        if (ride.serviceType === 'delivery') {
            icon = 'fa-shipping-fast';
            iconColor = '#9C27B0';
            typeLabel = 'Delivery';
        } else if (ride.serviceType === 'truck') {
            icon = 'fa-truck';
            iconColor = '#795548';
            typeLabel = 'Truck';
        } else if (ride.serviceType === 'shopping') {
            icon = 'fa-shopping-bag';
            iconColor = '#4CAF50';
            typeLabel = 'Shopping';
        } else if (ride.emergency) {
            icon = 'fa-ambulance';
            iconColor = '#F44336';
            typeLabel = 'Emergency Ride';
        } else if (ride.splitRide) {
            icon = 'fa-user-friends';
            iconColor = '#2196F3';
            typeLabel = 'Split Ride';
        } else if (ride.broadcast) {
            icon = 'fa-broadcast-tower';
            iconColor = '#FFC107';
            typeLabel = 'Broadcast Ride';
        }
        
        const statusColor = ride.status === 'completed' ? '#4CAF50' : 
                           ride.status === 'cancelled' ? '#F44336' : '#FFC107';
        
        let html = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: ${iconColor};">
                    <i class="fas ${icon}"></i> ${typeLabel} Details
                </h3>
                <button id="closeRideDetailsModal" style="
                    background: none;
                    border: none;
                    font-size: 24px;
                    cursor: pointer;
                    color: #999;
                "></button>
            </div>
            
            <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div>
                        <div style="font-size: 12px; color: #666;">Status</div>
                        <div style="
                            padding: 3px 8px;
                            background: ${statusColor};
                            color: white;
                            border-radius: 12px;
                            font-size: 12px;
                            font-weight: 600;
                            display: inline-block;
                        ">
                            ${ride.status?.charAt(0).toUpperCase() + ride.status?.slice(1) || 'Unknown'}
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 12px; color: #666;">Fare</div>
                        <div style="font-weight: 700; color: #FF6B35; font-size: 24px;">ZMW ${ride.fare?.toFixed(2) || '0.00'}</div>
                    </div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">From</div>
                    <div style="font-weight: 600; font-size: 14px;">${ride.pickupDisplay || ride.pickup}</div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">To</div>
                    <div style="font-weight: 600; font-size: 14px;">${ride.destinationDisplay || ride.destination}</div>
                </div>
                
                <div style="display: flex; justify-content: space-between;">
                    <div>
                        <div style="font-size: 12px; color: #666;">Distance</div>
                        <div style="font-weight: 600;">${ride.distance?.toFixed(1) || '0'} km</div>
                    </div>
                    <div>
                        <div style="font-size: 12px; color: #666;">Time</div>
                        <div style="font-weight: 600;">${ride.estimatedTime || '0'} min</div>
                    </div>
                    <div>
                        <div style="font-size: 12px; color: #666;">Date</div>
                        <div style="font-weight: 600;">${timeString}</div>
                    </div>
                </div>
            </div>
        `;
        
        // Add driver info if available
        if (ride.driverName) {
            html += `
                <div style="background: #f0f7ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="font-weight: 600; margin-bottom: 10px; color: #2196F3;">
                        <i class="fas fa-user"></i> Driver Info
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <div style="
                            width: 40px;
                            height: 40px;
                            background: #2196F3;
                            color: white;
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-weight: 600;
                        ">
                            ${ride.driverName.charAt(0).toUpperCase()}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600;">${ride.driverName}</div>
                            <div style="font-size: 13px; color: #666;">
                                ${ride.vehicleDetails || 'Vehicle info not available'}
                            </div>
                        </div>
                        <div style="color: #FFC107; font-weight: 600;">
                            <i class="fas fa-star"></i> ${ride.driverRating || '4.8'}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Add payment info
        html += `
            <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <div style="font-weight: 600; margin-bottom: 10px; color: #333;">
                    <i class="fas fa-credit-card"></i> Payment Info
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span style="color: #666;">Method:</span>
                    <span style="font-weight: 600;">${ride.paymentMethod?.charAt(0).toUpperCase() + ride.paymentMethod?.slice(1) || 'Wallet'}</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span style="color: #666;">Transaction ID:</span>
                    <span style="font-size: 12px; color: #999;">${ride.id.substring(0, 8)}...</span>
                </div>
            </div>
        `;
        
        // Add split ride info if applicable
        if (ride.splitRide) {
            html += `
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="font-weight: 600; margin-bottom: 10px; color: #2196F3;">
                        <i class="fas fa-user-friends"></i> Split Ride Info
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="color: #666;">Participants:</span>
                        <span style="font-weight: 600;">${ride.participants || 2}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #666;">Your Share:</span>
                        <span style="font-weight: 600; color: #FF6B35;">ZMW ${(ride.fare / (ride.participants || 2)).toFixed(2)}</span>
                    </div>
                </div>
            `;
        }
        
        // Add emergency info if applicable
        if (ride.emergency) {
            html += `
                <div style="background: #ffebee; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="font-weight: 600; margin-bottom: 10px; color: #F44336;">
                        <i class="fas fa-exclamation-triangle"></i> Emergency Info
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="color: #666;">Type:</span>
                        <span style="font-weight: 600;">${ride.emergencyType?.charAt(0).toUpperCase() + ride.emergencyType?.slice(1) || 'Emergency'}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #666;">Reason:</span>
                        <span style="font-weight: 600;">${ride.reason || 'Not specified'}</span>
                    </div>
                </div>
            `;
        }
        
        html += `
            <div style="text-align: center;">
                <button id="closeRideDetailsBtn" style="
                    padding: 10px 30px;
                    background: #FF6B35;
                    color: white;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    font-weight: 600;
                ">
                    Close
                </button>
            </div>
        `;
        
        modal.innerHTML = html;
        document.body.appendChild(modal);
        
        // Add overlay
        const overlay = document.createElement('div');
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
        `;
        document.body.appendChild(overlay);
        
        // Event listeners
        modal.querySelector('#closeRideDetailsModal').addEventListener('click', () => {
            document.body.removeChild(modal);
            document.body.removeChild(overlay);
        });
        
        modal.querySelector('#closeRideDetailsBtn').addEventListener('click', () => {
            document.body.removeChild(modal);
            document.body.removeChild(overlay);
        });
        
        overlay.addEventListener('click', () => {
            document.body.removeChild(modal);
            document.body.removeChild(overlay);
        });
    }
};

// ============================================
// ENHANCED FIREBASE MANAGER
// ============================================
const EnhancedFirebaseManager = {
    async loadUserData(uid) {
        try {
            console.log(`Loading user data for UID: ${uid}`);
            EnhancedUIUpdater.showLoading('Loading your profile...');
            
            const snapshot = await database.ref(`users/${uid}`).once('value');
            AppState.userData = snapshot.val();
            
            if (AppState.userData) {
                console.log('User data loaded successfully:', AppState.userData);
                
                // Initialize user data if needed
                if (!AppState.userData.walletBalance) {
                    AppState.userData.walletBalance = 0;
                    await database.ref(`users/${uid}/walletBalance`).set(0);
                }
                
                if (!AppState.userData.referralCode) {
                    // Generate referral code
                    const referralCode = 'JUBEL-' + Math.random().toString(36).substring(2, 8).toUpperCase();
                    AppState.userData.referralCode = referralCode;
                    await database.ref(`users/${uid}/referralCode`).set(referralCode);
                }
                
                AppState.walletBalance = AppState.userData.walletBalance || 0;
                EnhancedUIUpdater.updateWalletBalance(AppState.walletBalance);
                EnhancedUIUpdater.updateUserInfo(AppState.userData);
                
                // Load additional data
                await this.loadSOSConfig(uid);
                await this.loadScheduledRides(uid);
                await this.checkActiveRide(uid);
                await this.loadRideHistory(uid);
                await this.loadNotifications(uid);
                await this.loadWalletTransactions(uid);
                
                // Initialize search engine
                EnhancedSearchEngine.init();
                
                // Start real-time listeners
                this.startRealtimeSync(uid);
                
                EnhancedUIUpdater.hideLoading();
                EnhancedUIUpdater.showToast('Welcome back to Jubel!', 'success');
                return true;
            } else {
                console.warn('No user data found');
                EnhancedUIUpdater.hideLoading();
                return false;
            }
        } catch (error) {
            console.error('Error loading user data:', error);
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Error loading user data', 'error');
            return false;
        }
    },
    
    startRealtimeSync: function(uid) {
        this.stopRealtimeSync();
        
        console.log('Starting real-time sync for user:', uid);
        
        // User data updates
        const userRef = database.ref(`users/${uid}`);
        AppState.realtimeListeners.push(
            userRef.on('value', (snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    AppState.userData = userData;
                    AppState.walletBalance = userData.walletBalance || 0;
                    EnhancedUIUpdater.updateWalletBalance(AppState.walletBalance);
                    EnhancedUIUpdater.updateUserInfo(userData);
                }
            })
        );
        
        // Active ride updates
        const activeRideRef = database.ref('rides')
            .orderByChild('passengerId')
            .equalTo(uid)
            .orderByChild('status')
            .startAt('requested')
            .endAt('started');
        
        AppState.realtimeListeners.push(
            activeRideRef.on('value', (snapshot) => {
                const rides = snapshot.val();
                if (rides) {
                    const rideId = Object.keys(rides)[0];
                    const ride = { id: rideId, ...rides[rideId] };
                    
                    if (!AppState.currentRide || AppState.currentRide.id !== rideId) {
                        AppState.currentRide = ride;
                        EnhancedUIUpdater.showRideInfo(ride);
                        
                        if (ride.driverId) {
                            this.listenToDriverLocation(ride.driverId);
                            this.loadDriverInfo(ride.driverId);
                        }
                        
                        this.listenToChatMessages(rideId);
                    } else {
                        AppState.currentRide = ride;
                        EnhancedUIUpdater.updateRideStatus(ride.status);
                        EnhancedUIUpdater.updateTimeline(ride.status);
                        
                        if (ride.status === 'completed') {
                            this.handleRideCompletion(ride);
                        }
                    }
                } else if (AppState.currentRide) {
                    this.resetActiveRide();
                }
            })
        );
        
        // Notifications
       const notificationsRef = database.ref(`notifications/${uid}`)
    .orderByChild('timestamp')
    .limitToLast(50);

AppState.realtimeListeners.push(
    notificationsRef.on('value', (snapshot) => {
        const notifications = snapshot.val();
        if (notifications) {
            const notificationsArray = Object.keys(notifications).map(id => ({
                id,
                ...notifications[id]
            }));
            
            // Update state
            AppState.notifications = notificationsArray;
            const unreadCount = notificationsArray.filter(n => !n.read).length;
            AppState.unreadNotifications = unreadCount;
            
            // Update notification badge
            this.updateNotificationBadge(unreadCount);
            
            // Update notifications panel if open
            if (AppState.notificationsOpen) {
                EnhancedUIUpdater.updateNotifications(notificationsArray);
            }
            
            // Show toast for new unread notifications
            notificationsArray.forEach(notification => {
                if (!notification.read && notification.timestamp > Date.now() - 10000) {
                    // Only show toast for very recent notifications (last 10 seconds)
                    setTimeout(() => {
                        EnhancedUIUpdater.showToast(notification.message, notification.type);
                    }, 500);
                }
            });
        }
    })
);
        
       // Wallet transactions
const transactionsRef = database.ref(`walletTransactions/${uid}`)
    .orderByChild('timestamp')
    .limitToLast(100);

AppState.realtimeListeners.push(
    transactionsRef.on('value', (snapshot) => {
        const transactions = snapshot.val();
        if (transactions) {
            const transactionsArray = Object.keys(transactions).map(id => ({
                id,
                ...transactions[id]
            }));
            
            AppState.walletTransactions = transactionsArray;
            
            // Update wallet transactions UI if modal is open
            const transactionsModal = document.getElementById('transactionsModal');
            if (transactionsModal && transactionsModal.style.display === 'block') {
                EnhancedWalletManager.displayTransactions(transactionsArray);
            }
        }
    })
);
        
        // Split ride invitations
        const splitInvitationsRef = database.ref('splitRideInvitations')
            .orderByChild('recipientId')
            .equalTo(uid)
            .orderByChild('status')
            .equalTo('pending');
        
        AppState.realtimeListeners.push(
            splitInvitationsRef.on('value', (snapshot) => {
                const invitations = snapshot.val();
                if (invitations) {
                    Object.entries(invitations).forEach(([invitationId, invitation]) => {
                        if (!AppState.shareRideInvitations.has(invitationId)) {
                            AppState.shareRideInvitations.set(invitationId, invitation);
                            
                            // Send notification
                            this.sendNotification(
                                uid,
                                'Split Ride Invitation',
                                `${invitation.hostName} invited you to split a ride`,
                                'split',
                                { 
                                    splitRideId: invitation.splitRideId,
                                    action: 'accept_split_invite'
                                }
                            );
                        }
                    });
                }
            })
        );
        
        // Broadcast invitations
        const broadcastInvitationsRef = database.ref('broadcastInvitations')
            .orderByChild('recipientId')
            .equalTo(uid)
            .orderByChild('status')
            .equalTo('pending');
        
        AppState.realtimeListeners.push(
            broadcastInvitationsRef.on('value', (snapshot) => {
                const invitations = snapshot.val();
                if (invitations) {
                    Object.entries(invitations).forEach(([invitationId, invitation]) => {
                        if (!AppState.broadcastInvitations.has(invitationId)) {
                            AppState.broadcastInvitations.set(invitationId, invitation);
                            
                            // Send notification
                            this.sendNotification(
                                uid,
                                'Broadcast Ride',
                                `${invitation.hostName} is sharing their ride with you`,
                                'broadcast',
                                { 
                                    broadcastId: invitation.broadcastId,
                                    action: 'accept_broadcast_invite'
                                }
                            );
                        }
                    });
                }
            })
        );
        
        console.log('Real-time sync started successfully');
    },
    
    stopRealtimeSync: function() {
        console.log('Stopping real-time sync');
        AppState.realtimeListeners.forEach(listener => {
            if (listener && typeof listener === 'function') {
                listener();
            }
        });
        AppState.realtimeListeners = [];
    },
    
    async loadSOSConfig(uid) {
        try {
            const snapshot = await database.ref(`sosConfig/${uid}`).once('value');
            AppState.sosConfig = snapshot.val();
            
            if (AppState.sosConfig) {
                console.log('SOS config loaded');
            }
        } catch (error) {
            console.error('Error loading SOS config:', error);
        }
    },
    
   async loadScheduledRides(uid) {
    try {
        const snapshot = await database.ref('scheduledRides')
            .orderByChild('passengerId')
            .equalTo(uid)
            .orderByChild('status')
            .equalTo('scheduled')
            .once('value');
        
        const rides = snapshot.val();
        if (rides) {
            const ridesArray = Object.keys(rides).map(id => ({
                id,
                ...rides[id]
            }));
            
            AppState.scheduledRides = ridesArray;
            
            console.log(`Loaded ${AppState.scheduledRides.length} scheduled rides`);
            
            // Start countdowns for upcoming rides
            AppState.scheduledRides.forEach(ride => {
                if (ride.scheduledTime > Date.now()) {
                    EnhancedUIUpdater.showScheduleCountdown(ride.scheduledTime, ride);
                } else {
                    // If scheduled time has passed, request the ride
                    EnhancedUIUpdater.requestScheduledRideNow(ride);
                }
            });
        }
    } catch (error) {
        console.error('Error loading scheduled rides:', error);
    }
},
    
    async checkActiveRide(uid) {
        try {
            const snapshot = await database.ref('rides')
                .orderByChild('passengerId')
                .equalTo(uid)
                .orderByChild('status')
                .startAt('requested')
                .endAt('started')
                .once('value');
            
            const rides = snapshot.val();
            if (rides) {
                const rideId = Object.keys(rides)[0];
                AppState.currentRide = { id: rideId, ...rides[rideId] };
                console.log('Active ride found:', rideId);
                EnhancedUIUpdater.showRideInfo(AppState.currentRide);
                
                this.listenToRideUpdates(rideId);
                
                if (AppState.currentRide.driverId) {
                    this.listenToDriverLocation(AppState.currentRide.driverId);
                    this.loadDriverInfo(AppState.currentRide.driverId);
                }
                
                this.listenToChatMessages(rideId);
                
                return true;
            }
            console.log('No active ride found');
            return false;
        } catch (error) {
            console.error('Error checking active ride:', error);
            return false;
        }
    },
    
    async loadRideHistory(uid) {
        try {
            const snapshot = await database.ref('rides')
                .orderByChild('passengerId')
                .equalTo(uid)
                .once('value');
            
            const rides = snapshot.val();
            if (rides) {
                const ridesArray = Object.keys(rides).map(id => ({
                    id,
                    ...rides[id]
                })).sort((a, b) => b.timestamp - a.timestamp);
                
                AppState.rideHistory = ridesArray;
                EnhancedUIUpdater.updateRideHistory(ridesArray);
                
                console.log(`Loaded ${ridesArray.length} ride history items`);
            }
        } catch (error) {
            console.error('Error loading ride history:', error);
        }
    },
    
   // Find the loadNotifications method and update it to:
async loadNotifications(uid) {
    try {
        const snapshot = await database.ref(`notifications/${uid}`)
            .orderByChild('timestamp')
            .limitToLast(50)
            .once('value');
        
        const notifications = snapshot.val();
        if (notifications) {
            const notificationsArray = Object.keys(notifications).map(id => ({
                id,
                ...notifications[id]
            }));
            
            AppState.notifications = notificationsArray;
            const unreadCount = notificationsArray.filter(n => !n.read).length;
            AppState.unreadNotifications = unreadCount;
            
            // Update notification badge
            this.updateNotificationBadge(unreadCount);
            
            // Update notifications panel if open
            if (AppState.notificationsOpen) {
                EnhancedUIUpdater.updateNotifications(notificationsArray);
            }
            
            console.log(`Loaded ${notificationsArray.length} notifications (${unreadCount} unread)`);
        }
    } catch (error) {
        console.error('Error loading notifications:', error);
    }
},

// Add this helper method to EnhancedFirebaseManager (place after loadNotifications):
updateNotificationBadge: function(count) {
    const badge = document.getElementById('notificationCount');
    if (badge) {
        badge.textContent = count > 99 ? '99+' : count;
        badge.style.display = count > 0 ? 'flex' : 'none';
    }
},

    
   loadWalletTransactions: async function(uid) {
    try {
        const snapshot = await database.ref(`walletTransactions/${uid}`)
            .orderByChild('timestamp')
            .limitToLast(100)
            .once('value');
        
        const transactions = snapshot.val();
        if (transactions) {
            const transactionsArray = Object.keys(transactions).map(id => ({
                id,
                ...transactions[id]
            })).sort((a, b) => b.timestamp - a.timestamp);
            
            AppState.walletTransactions = transactionsArray;
            console.log(`Loaded ${transactionsArray.length} wallet transactions`);
            
            // Update UI if transactions modal is open
            const transactionsModal = document.getElementById('transactionsModal');
            if (transactionsModal && transactionsModal.style.display === 'block') {
                EnhancedWalletManager.displayTransactions(transactionsArray);
            }
        }
    } catch (error) {
        console.error('Error loading wallet transactions:', error);
    }
},
    listenToRideUpdates: function(rideId) {
        const rideRef = database.ref(`rides/${rideId}`);
        
        AppState.realtimeListeners.push(
            rideRef.on('value', (snapshot) => {
                const ride = snapshot.val();
                if (ride) {
                    AppState.currentRide = { id: rideId, ...ride };
                    EnhancedUIUpdater.updateRideStatus(ride.status);
                    EnhancedUIUpdater.updateTimeline(ride.status);
                    
                    if (ride.status === 'completed') {
                        this.handleRideCompletion(ride);
                    }
                }
            })
        );
    },
    
    listenToDriverLocation: function(driverId) {
        const locationRef = database.ref(`driverLocations/${driverId}`);
        
        AppState.realtimeListeners.push(
            locationRef.on('value', (snapshot) => {
                const location = snapshot.val();
                if (location) {
                    AppState.driverLocation = {
                        lat: location.latitude,
                        lng: location.longitude
                    };
                    
                    // Update driver marker on map
                    if (driverMarker) {
                        driverMarker.setLatLng([AppState.driverLocation.lat, AppState.driverLocation.lng]);
                    } else {
                        driverMarker = L.marker([AppState.driverLocation.lat, AppState.driverLocation.lng], {
                            icon: L.divIcon({
                                className: 'driver-marker',
                                html: '<i class="fas fa-car" style="color: #2196F3; font-size: 24px;"></i>',
                                iconSize: [24, 24],
                                iconAnchor: [12, 24]
                            })
                        }).addTo(map).bindPopup('Your Driver');
                    }
                    
                    // Update tracking info
                    if (AppState.currentRide && AppState.currentRide.pickupLat) {
                        const pickupLocation = {
                            lat: AppState.currentRide.pickupLat,
                            lng: AppState.currentRide.pickupLng
                        };
                        
                        const distance = EnhancedPriceCalculator.calculateDistance(
                            AppState.driverLocation.lat, AppState.driverLocation.lng,
                            pickupLocation.lat, pickupLocation.lng
                        );
                        
                        const eta = Math.ceil((distance / 40) * 60);
                        
                        const driverDistance = document.getElementById('driverDistance');
                        const etaToPickup = document.getElementById('etaToPickup');
                        
                        if (driverDistance) driverDistance.textContent = `${distance.toFixed(1)} km`;
                        if (etaToPickup) etaToPickup.textContent = `ETA: ${eta} min`;
                    }
                }
            })
        );
    },
    
    listenToChatMessages: function(rideId) {
        const chatRef = database.ref(`chats/${rideId}/messages`).orderByChild('timestamp').limitToLast(50);
        
        AppState.realtimeListeners.push(
            chatRef.on('child_added', (snapshot) => {
                const message = snapshot.val();
                if (message) {
                    // Update chat UI if chat is open
                    const chatContainer = document.getElementById('chatContainer');
                    if (chatContainer && chatContainer.classList.contains('active')) {
                        EnhancedUIUpdater.showChatMessage(message, message.senderId === AppState.currentUser.uid);
                    }
                    
                    // Show notification if chat is closed
                    if (!chatContainer || !chatContainer.classList.contains('active')) {
                        if (message.senderId !== AppState.currentUser.uid) {
                            this.sendNotification(
                                AppState.currentUser.uid,
                                'New Message',
                                `Driver: ${message.text.substring(0, 50)}...`,
                                'info',
                                { rideId: rideId, action: 'open_chat' }
                            );
                        }
                    }
                }
            })
        );
    },
    
    async loadDriverInfo(driverId) {
        try {
            const snapshot = await database.ref(`drivers/${driverId}`).once('value');
            const driver = snapshot.val();
            if (driver) {
                AppState.selectedVehicle = driver;
                
                // Update driver info in UI
                const driverName = document.getElementById('driverName');
                const driverRating = document.getElementById('driverRating');
                const vehicleDetails = document.getElementById('vehicleDetails');
                
                if (driverName) driverName.textContent = driver.name || 'Driver';
                if (driverRating) driverRating.textContent = driver.rating?.toFixed(1) || '4.8';
                if (vehicleDetails) vehicleDetails.textContent = 
                    `${driver.vehicleModel || 'Car'} - ${driver.vehiclePlate || 'ABC123'}`;
            }
        } catch (error) {
            console.error('Error loading driver info:', error);
        }
    },
    
    async requestRide(rideData) {
        try {
            EnhancedUIUpdater.showLoading('Requesting ride...');
            
            if (!rideData.pickup || !rideData.destination) {
                throw new Error('Pickup and destination locations are required');
            }
            
            // Generate ride ID
            const rideId = database.ref().child('rides').push().key;
            
            // Calculate distance
            const distance = EnhancedPriceCalculator.calculateRideDistanceWithStops(
                rideData.pickup,
                rideData.destination,
                rideData.stops || []
            );
            
            // Calculate estimated time
            const estimatedTime = EnhancedPriceCalculator.estimateTime(
                distance,
                rideData.rideType || 'standard',
                null,
                rideData.stops || []
            );
            
            // Apply referral discount if applicable
            let finalFare = rideData.fare;
            let referralDiscount = 0;
            
            if (AppState.referralDiscountApplied && AppState.referralCodeUsed) {
                referralDiscount = finalFare * 0.5;
                finalFare = finalFare - referralDiscount;
            }
            
            const ride = {
    id: rideId,
    passengerId: AppState.currentUser.uid,
    passengerName: AppState.userData.name,
    passengerPhone: AppState.userData.phone,
    pickup: rideData.pickup.address,
    pickupDisplay: rideData.pickup.name || rideData.pickup.address,
    pickupLat: rideData.pickup.lat,
    pickupLng: rideData.pickup.lng,
    destination: rideData.destination.address,
    destinationDisplay: rideData.destination.name || rideData.destination.address,
    destLat: rideData.destination.lat,
    destLng: rideData.destination.lng,
    rideType: rideData.rideType || 'standard',
    serviceType: rideData.serviceType || 'car', // Add service type
    fare: finalFare,
    originalFare: rideData.fare,
    referralDiscount: referralDiscount,
    referredBy: AppState.referralCodeUsed,
    distance: distance,
    estimatedTime: estimatedTime,
    status: 'requested',
    timestamp: Date.now(),
    city: AppState.currentCity,
    paymentMethod: rideData.paymentMethod || 'wallet'
};

// Add service-specific data
if (rideData.serviceType === 'shopping') {
    ride.shopName = rideData.shopName;
    ride.shoppingList = rideData.shoppingList;
    ride.shoppingBudget = rideData.budget;
    ride.shoppingInstructions = rideData.instructions;
    ride.vehicleType = rideData.vehicleType;
} else if (rideData.serviceType === 'delivery') {
    ride.deliveryType = rideData.deliveryType;
    ride.parcelDescription = rideData.parcelDescription;
    ride.parcelValue = rideData.parcelValue;
    ride.receiverName = rideData.receiverName;
    ride.receiverPhone = rideData.receiverPhone;
    ride.vehicleType = rideData.vehicleType;
} else if (rideData.serviceType === 'short-delivery') {
    ride.parcelDescription = rideData.parcelDescription;
    ride.receiverPhone = rideData.receiverPhone;
    ride.vehicleType = rideData.vehicleType;
} else if (rideData.serviceType === 'truck') {
    ride.truckType = rideData.truckType;
    ride.itemDescription = rideData.itemDescription;
    ride.estimatedWeight = rideData.estimatedWeight;
    ride.needHelpers = rideData.needHelpers;
}

// Add vehicle info to the ride
if (rideData.vehicleType) {
    ride.vehicleType = rideData.vehicleType;
}
            
            // Add stops if any
            if (rideData.stops && rideData.stops.length > 0) {
                ride.stops = rideData.stops.map(stop => ({
                    name: stop.location.name,
                    address: stop.location.address,
                    lat: stop.location.lat,
                    lng: stop.location.lng
                }));
            }
            
            // Add split ride info if applicable
            if (rideData.isSplitRide) {
                ride.splitRide = true;
                ride.participants = rideData.participants;
                ride.splitRideId = rideData.splitRideId;
                
                // Create split ride invitation if friends are specified
                if (rideData.friends && rideData.friends.length > 0) {
                    const splitRideId = database.ref().child('splitRides').push().key;
                    
                    const splitRide = {
                        id: splitRideId,
                        hostId: AppState.currentUser.uid,
                        hostName: AppState.userData.name,
                        rideId: rideId,
                        participants: rideData.participants,
                        totalFare: rideData.totalFare,
                        eachShare: rideData.yourShare,
                        pickup: rideData.pickup.address,
                        destination: rideData.destination.address,
                        status: 'pending',
                        timestamp: Date.now()
                    };
                    
                    await database.ref(`splitRides/${splitRideId}`).set(splitRide);
                    
                    // Create invitations for each friend
                    for (const friend of rideData.friends) {
                        const invitationId = database.ref().child('splitRideInvitations').push().key;
                        
                        const invitation = {
                            id: invitationId,
                            splitRideId: splitRideId,
                            hostId: AppState.currentUser.uid,
                            hostName: AppState.userData.name,
                            recipientId: friend.userId,
                            recipientName: friend.name,
                            rideId: rideId,
                            pickup: rideData.pickup.address,
                            destination: rideData.destination.address,
                            totalFare: rideData.totalFare,
                            eachShare: rideData.yourShare,
                            status: 'pending',
                            timestamp: Date.now()
                        };
                        
                        await database.ref(`splitRideInvitations/${invitationId}`).set(invitation);
                    }
                    
                    ride.splitRideId = splitRideId;
                }
            }
            
            // Add broadcast info if applicable
            if (rideData.isBroadcast && rideData.friends && rideData.friends.length > 0) {
                ride.broadcast = true;
                
                const broadcastId = database.ref().child('broadcasts').push().key;
                
                const broadcast = {
                    id: broadcastId,
                    hostId: AppState.currentUser.uid,
                    hostName: AppState.userData.name,
                    rideId: rideId,
                    pickup: rideData.pickup.address,
                    destination: rideData.destination.address,
                    fare: rideData.totalFare,
                    distance: distance,
                    status: 'active',
                    timestamp: Date.now()
                };
                
                await database.ref(`broadcasts/${broadcastId}`).set(broadcast);
                
                // Create broadcast invitations
                for (const friend of rideData.friends) {
                    const invitationId = database.ref().child('broadcastInvitations').push().key;
                    
                    const invitation = {
                        id: invitationId,
                        broadcastId: broadcastId,
                        hostId: AppState.currentUser.uid,
                        hostName: AppState.userData.name,
                        recipientId: friend.userId,
                        recipientName: friend.name,
                        rideId: rideId,
                        pickup: rideData.pickup.address,
                        destination: rideData.destination.address,
                        fare: rideData.totalFare,
                        distance: distance,
                        status: 'pending',
                        timestamp: Date.now()
                    };
                    
                    await database.ref(`broadcastInvitations/${invitationId}`).set(invitation);
                }
                
                ride.broadcastId = broadcastId;
            }
            
            // Add emergency info if applicable
            if (rideData.isEmergency) {
                ride.emergency = true;
                ride.emergencyType = rideData.emergencyType;
                ride.emergencyReason = rideData.reason;
                ride.emergencyStation = rideData.station;
            }
            
            // Save ride to database
            await database.ref(`rides/${rideId}`).set(ride);
            
            // Update user's ride count
            const userRef = database.ref(`users/${AppState.currentUser.uid}`);
            const userSnapshot = await userRef.once('value');
            const userData = userSnapshot.val();
            
            const totalRides = (userData.totalRides || 0) + 1;
            await userRef.update({ totalRides });
            
            // Deduct fare from wallet if payment method is wallet
            if (rideData.paymentMethod === 'wallet') {
                await this.withdrawMoney(finalFare, 'Ride payment', rideId);
            }
            
            // Set current ride
            AppState.currentRide = ride;
            
            // Update UI
            EnhancedUIUpdater.showRideInfo(ride);
            EnhancedUIUpdater.updateRideStatus('requested');
            EnhancedUIUpdater.updateTimeline('requested');
            
            // Show pulsing icon
            EnhancedUIUpdater.showPulsingRideIcon();
            
            // Start listening to ride updates
            this.listenToRideUpdates(rideId);
            
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Ride requested successfully!', 'success');
            
            // Send notification
           // Change it to:
this.sendNotification(
    AppState.currentUser.uid,
    'Ride Requested',
    'Your ride has been requested. Searching for a driver...',
    'ride',
    { rideId: rideId },
    'view_ride'
);
            
            return rideId;
        } catch (error) {
            console.error('Error requesting ride:', error);
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast(error.message, 'error');
            throw error;
        }
    },

    // Add this method to EnhancedFirebaseManager (place it after the other methods):
async loadRideDetails(rideId) {
    try {
        const snapshot = await database.ref(`rides/${rideId}`).once('value');
        const ride = snapshot.val();
        
        if (ride) {
            // Show ride details in the UI
            EnhancedUIUpdater.showRideDetailsModal(ride);
            return ride;
        }
        return null;
    } catch (error) {
        console.error('Error loading ride details:', error);
        return null;
    }
},
    async requestScheduledRide(rideData) {
    try {
        EnhancedUIUpdater.showLoading('Scheduling your ride...');
        
        // Generate scheduled ride ID
        const scheduledRideId = database.ref().child('scheduledRides').push().key;
        
        // Calculate estimated time
        const estimatedTime = EnhancedPriceCalculator.estimateTime(
            rideData.distance,
            rideData.rideType || 'standard',
            null,
            rideData.stops || []
        );
        
        // Create scheduled ride object
        const scheduledRide = {
            id: scheduledRideId,
            passengerId: AppState.currentUser.uid,
            passengerName: AppState.userData.name,
            passengerPhone: AppState.userData.phone,
            pickup: rideData.pickup.address,
            pickupDisplay: rideData.pickup.name || rideData.pickup.address,
            pickupLat: rideData.pickup.lat,
            pickupLng: rideData.pickup.lng,
            destination: rideData.destination.address,
            destinationDisplay: rideData.destination.name || rideData.destination.address,
            destLat: rideData.destination.lat,
            destLng: rideData.destination.lng,
            rideType: rideData.rideType || 'standard',
            fare: rideData.fare,
            distance: rideData.distance,
            estimatedTime: estimatedTime,
            status: 'scheduled',
            scheduledTime: rideData.scheduledTime,
            timestamp: Date.now(),
            city: AppState.currentCity,
            paymentMethod: rideData.paymentMethod || 'wallet',
            forSomeone: rideData.forSomeone || false
        };
        
        // Add recipient details if applicable
        if (rideData.forSomeone) {
            scheduledRide.recipientName = rideData.recipientName;
            scheduledRide.recipientPhone = rideData.recipientPhone;
        }
        
        // Add stops if any
        if (rideData.stops && rideData.stops.length > 0) {
            scheduledRide.stops = rideData.stops.map(stop => ({
                name: stop.location.name,
                address: stop.location.address,
                lat: stop.location.lat,
                lng: stop.location.lng
            }));
        }
        
        // Deduct fare from wallet if payment method is wallet
        if (rideData.paymentMethod === 'wallet') {
            await this.withdrawMoney(rideData.fare, 'Scheduled ride payment', scheduledRideId);
        }
        
        // Save scheduled ride to database
        await database.ref(`scheduledRides/${scheduledRideId}`).set(scheduledRide);
        
        // Add to user's scheduled rides
        const userRef = database.ref(`users/${AppState.currentUser.uid}`);
        const userSnapshot = await userRef.once('value');
        const userData = userSnapshot.val();
        
        const scheduledRidesCount = (userData.scheduledRidesCount || 0) + 1;
        await userRef.update({ scheduledRidesCount });
        
        EnhancedUIUpdater.hideLoading();
        EnhancedUIUpdater.showToast('Ride scheduled successfully!', 'success');
        
        // Send notification
        this.sendNotification(
            AppState.currentUser.uid,
            'Ride Scheduled',
            `Your ride is scheduled for ${new Date(rideData.scheduledTime).toLocaleString()}`,
            'info',
            { scheduledRideId: scheduledRideId }
        );
        
        // Add scheduled ride to local state
        if (!AppState.scheduledRides) {
            AppState.scheduledRides = [];
        }
        AppState.scheduledRides.push(scheduledRide);
        
        return scheduledRideId;
        
    } catch (error) {
        EnhancedUIUpdater.hideLoading();
        console.error('Error scheduling ride:', error);
        EnhancedUIUpdater.showToast('Error scheduling ride', 'error');
        throw error;
    }
},
    
   async cancelScheduledRide(scheduledRideId) {
    try {
        // Get scheduled ride data
        const scheduledRideRef = database.ref(`scheduledRides/${scheduledRideId}`);
        const snapshot = await scheduledRideRef.once('value');
        const scheduledRide = snapshot.val();
        
        if (!scheduledRide) {
            throw new Error('Scheduled ride not found');
        }
        
        // Refund payment if paid by wallet
        if (scheduledRide.paymentMethod === 'wallet' && scheduledRide.status === 'scheduled') {
            await this.depositMoney(scheduledRide.fare, 'Scheduled ride cancellation refund', scheduledRideId);
        }
        
        // Update status to cancelled
        await scheduledRideRef.update({
            status: 'cancelled',
            cancelledAt: Date.now()
        });
        
        // Clear countdown if exists
        if (AppState.scheduledCountdowns.has(scheduledRideId)) {
            clearInterval(AppState.scheduledCountdowns.get(scheduledRideId));
            AppState.scheduledCountdowns.delete(scheduledRideId);
        }
        
        // Remove countdown container if exists
        const countdownContainer = document.getElementById('scheduleCountdown');
        if (countdownContainer) {
            countdownContainer.remove();
        }
        
        // Remove from local state
        AppState.scheduledRides = AppState.scheduledRides.filter(ride => ride.id !== scheduledRideId);
        
        EnhancedUIUpdater.showToast('Scheduled ride cancelled. Refund processed if applicable.', 'success');
        
        // Send notification
        this.sendNotification(
            AppState.currentUser.uid,
            'Scheduled Ride Cancelled',
            `Your scheduled ride has been cancelled. ${scheduledRide.paymentMethod === 'wallet' ? 'Refund has been processed.' : ''}`,
            'info',
            { scheduledRideId: scheduledRideId }
        );
        
    } catch (error) {
        console.error('Error cancelling scheduled ride:', error);
        EnhancedUIUpdater.showToast('Error cancelling scheduled ride', 'error');
    }
},
    
    async cancelRide(rideId, reason) {
        try {
            EnhancedUIUpdater.showLoading('Cancelling ride...');
            
            const rideRef = database.ref(`rides/${rideId}`);
            const rideSnapshot = await rideRef.once('value');
            const ride = rideSnapshot.val();
            
            if (!ride) {
                throw new Error('Ride not found');
            }
            
            // Update ride status
            await rideRef.update({
                status: 'cancelled',
                cancellationReason: reason,
                cancelledAt: Date.now()
            });
            
            // Refund payment if paid by wallet
            if (ride.paymentMethod === 'wallet') {
                await this.depositMoney(ride.fare, 'Ride cancellation refund', rideId);
            }
            
            // Reset active ride state
            this.resetActiveRide();
            
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Ride cancelled successfully', 'success');
            
            // Send notification
            this.sendNotification(
                AppState.currentUser.uid,
                'Ride Cancelled',
                'Your ride has been cancelled. Refund processed if applicable.',
                'info',
                { rideId: rideId }
            );
        } catch (error) {
            console.error('Error cancelling ride:', error);
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Error cancelling ride', 'error');
        }
    },
    
    resetActiveRide: function() {
        AppState.currentRide = null;
        
        // Remove pulsing icon
        EnhancedUIUpdater.removePulsingRideIcon();
        
        // Hide ride info panel
        const rideInfoPanel = document.getElementById('rideInfoPanel');
        if (rideInfoPanel) {
            rideInfoPanel.style.display = 'none';
        }
        
        // Hide status bar
        const statusBar = document.getElementById('rideStatusBar');
        if (statusBar) {
            statusBar.classList.remove('active');
        }
        
        // Hide SOS button
        const sosButton = document.getElementById('sosButton');
        if (sosButton) {
            sosButton.style.display = 'none';
        }
    },
    
    handleRideCompletion: function(ride) {
        // Process referral reward if applicable
        if (ride.referredBy) {
            this.processReferralReward(ride.referredBy, ride);
        }
        
        // Send notification
        this.sendNotification(
            AppState.currentUser.uid,
            'Ride Completed',
            `Your ride has been completed. Fare: ZMW ${ride.fare.toFixed(2)}`,
            'success',
            { rideId: ride.id, action: 'view_ride' }
        );
        
        // Reset active ride after delay
        setTimeout(() => {
            this.resetActiveRide();
        }, 5000);
    },
    
    async processReferralReward(referralCode, ride) {
        try {
            // Find user with this referral code
            const usersRef = database.ref('users');
            const snapshot = await usersRef.orderByChild('referralCode').equalTo(referralCode).once('value');
            const users = snapshot.val();
            
            if (users) {
                const userId = Object.keys(users)[0];
                const user = users[userId];
                
                // Add K25 to user's wallet
                const rewardAmount = 25;
                await this.depositMoneyToUser(userId, rewardAmount, 'Referral reward', ride.id);
                
                // Update user's referral earnings
                const totalReferralEarnings = (user.referralEarnings || 0) + rewardAmount;
                await database.ref(`users/${userId}`).update({
                    referralEarnings: totalReferralEarnings
                });
                
                // Send notification to referral owner
                this.sendNotification(
                    userId,
                    'Referral Reward!',
                    `${AppState.userData.name} used your referral code. You earned K${rewardAmount}!`,
                    'referral',
                    { rideId: ride.id }
                );
                
                console.log(`Referral reward processed: K${rewardAmount} to ${user.name}`);
            }
        } catch (error) {
            console.error('Error processing referral reward:', error);
        }
    },
    
    async validateReferralCode(referralCode) {
        try {
            // Check if it's the user's own code
            if (referralCode === AppState.userData?.referralCode) {
                return { valid: false, message: 'Cannot use your own referral code' };
            }
            
            // Find user with this referral code
            const usersRef = database.ref('users');
            const snapshot = await usersRef.orderByChild('referralCode').equalTo(referralCode).once('value');
            const users = snapshot.val();
            
            if (users) {
                const userId = Object.keys(users)[0];
                const user = users[userId];
                return { 
                    valid: true, 
                    ownerName: user.name,
                    userId: userId
                };
            } else {
                return { valid: false, message: 'Invalid referral code' };
            }
        } catch (error) {
            console.error('Error validating referral code:', error);
            return { valid: false, message: 'Error validating code' };
        }
    },
    
    async findUserByReferralCode(referralCode) {
        try {
            const usersRef = database.ref('users');
            const snapshot = await usersRef.orderByChild('referralCode').equalTo(referralCode).once('value');
            const users = snapshot.val();
            
            if (users) {
                const userId = Object.keys(users)[0];
                const user = users[userId];
                return { uid: userId, ...user };
            } else {
                return null;
            }
        } catch (error) {
            console.error('Error finding user by referral code:', error);
            throw error;
        }
    },
    
    depositMoney: async function(amount, description = 'Deposit', reference = null, method = 'unknown') {
    try {
        const transactionId = database.ref().child('walletTransactions').push().key;
        
        const transaction = {
            id: transactionId,
            userId: AppState.currentUser.uid,
            type: 'deposit',
            amount: amount,
            description: description,
            method: method,
            reference: reference,
            timestamp: Date.now(),
            status: 'completed',
            balanceBefore: AppState.walletBalance,
            balanceAfter: AppState.walletBalance + amount
        };
        
        // Update wallet balance
        const newBalance = AppState.walletBalance + amount;
        await database.ref(`users/${AppState.currentUser.uid}/walletBalance`).set(newBalance);
        
        // Save transaction
        await database.ref(`walletTransactions/${AppState.currentUser.uid}/${transactionId}`).set(transaction);
        
        // Update local state
        AppState.walletBalance = newBalance;
        EnhancedUIUpdater.updateWalletBalance(newBalance);
        
        // Send notification
        this.sendNotification(
            AppState.currentUser.uid,
            'Deposit Successful',
            `ZMW ${amount.toFixed(2)} deposited to your wallet`,
            'payment',
            { transactionId: transactionId, amount: amount }
        );
        
        // Update wallet transactions list
        this.loadWalletTransactions(AppState.currentUser.uid);
        
        return transactionId;
    } catch (error) {
        console.error('Error depositing money:', error);
        throw error;
    }
},
    
  // Update existing withdrawMoney method
withdrawMoney: async function(amount, description = 'Withdrawal', reference = null, method = 'unknown') {
    try {
        if (amount > AppState.walletBalance) {
            throw new Error('Insufficient balance');
        }
        
        const transactionId = database.ref().child('walletTransactions').push().key;
        
        const transaction = {
            id: transactionId,
            userId: AppState.currentUser.uid,
            type: 'withdrawal',
            amount: amount,
            description: description,
            method: method,
            reference: reference,
            timestamp: Date.now(),
            status: 'completed',
            balanceBefore: AppState.walletBalance,
            balanceAfter: AppState.walletBalance - amount
        };
        
        // Update wallet balance
        const newBalance = AppState.walletBalance - amount;
        await database.ref(`users/${AppState.currentUser.uid}/walletBalance`).set(newBalance);
        
        // Save transaction
        await database.ref(`walletTransactions/${AppState.currentUser.uid}/${transactionId}`).set(transaction);
        
        // Update local state
        AppState.walletBalance = newBalance;
        EnhancedUIUpdater.updateWalletBalance(newBalance);
        
        // Update wallet transactions list
        this.loadWalletTransactions(AppState.currentUser.uid);
        
        return transactionId;
    } catch (error) {
        console.error('Error withdrawing money:', error);
        throw error;
    }
},
    
   depositMoneyToUser: async function(userId, amount, description = 'Deposit', reference = null) {
    try {
        // Get current balance
        const userRef = database.ref(`users/${userId}`);
        const userSnapshot = await userRef.once('value');
        const user = userSnapshot.val();
        
        const currentBalance = user.walletBalance || 0;
        const newBalance = currentBalance + amount;
        
        // Update balance
        await userRef.update({ walletBalance: newBalance });
        
        // Create transaction
        const transactionId = database.ref().child('walletTransactions').push().key;
        
        const transaction = {
            id: transactionId,
            userId: userId,
            type: 'deposit',
            amount: amount,
            description: description,
            reference: reference,
            timestamp: Date.now(),
            status: 'completed',
            balanceBefore: currentBalance,
            balanceAfter: newBalance,
            fromName: AppState.userData?.name || 'System'
        };
        
        await database.ref(`walletTransactions/${userId}/${transactionId}`).set(transaction);
        
        return transactionId;
    } catch (error) {
        console.error('Error depositing money to user:', error);
        throw error;
    }
},
    
   transferMoney: async function(recipientCode, amount, message = '', method = 'wallet') {
    try {
        if (amount > AppState.walletBalance) {
            throw new Error('Insufficient balance');
        }
        
        if (amount <= 0) {
            throw new Error('Invalid amount');
        }
        
        // Find recipient by referral code
        const recipient = await this.findUserByReferralCode(recipientCode);
        if (!recipient) {
            throw new Error('Recipient not found');
        }
        
        // Check if transferring to self
        if (recipient.uid === AppState.currentUser.uid) {
            throw new Error('Cannot transfer to yourself');
        }
        
        EnhancedUIUpdater.showLoading('Processing transfer...');
        
        // Create sender transaction
        const senderTransactionId = database.ref().child('walletTransactions').push().key;
        
        const senderTransaction = {
            id: senderTransactionId,
            userId: AppState.currentUser.uid,
            type: 'transfer',
            amount: amount,
            description: message || `Transfer to ${recipient.name}`,
            method: method,
            toUserId: recipient.uid,
            toName: recipient.name,
            timestamp: Date.now(),
            status: 'completed',
            balanceBefore: AppState.walletBalance,
            balanceAfter: AppState.walletBalance - amount
        };
        
        // Withdraw from sender
        await this.withdrawMoney(amount, `Transfer to ${recipient.name}`, senderTransactionId, method);
        
        // Create recipient transaction
        const recipientTransactionId = database.ref().child('walletTransactions').push().key;
        
        const recipientTransaction = {
            id: recipientTransactionId,
            userId: recipient.uid,
            type: 'transfer',
            amount: amount,
            description: message || `Transfer from ${AppState.userData.name}`,
            method: method,
            fromUserId: AppState.currentUser.uid,
            fromName: AppState.userData.name,
            timestamp: Date.now(),
            status: 'completed',
            balanceBefore: recipient.walletBalance || 0,
            balanceAfter: (recipient.walletBalance || 0) + amount
        };
        
        // Deposit to recipient
        await this.depositMoneyToUser(
            recipient.uid, 
            amount, 
            `Transfer from ${AppState.userData.name}`,
            recipientTransactionId
        );
        
        // Save recipient transaction
        await database.ref(`walletTransactions/${recipient.uid}/${recipientTransactionId}`).set(recipientTransaction);
        
        // Create transfer record
        const transferId = database.ref().child('transfers').push().key;
        
        const transfer = {
            id: transferId,
            senderId: AppState.currentUser.uid,
            senderName: AppState.userData.name,
            recipientId: recipient.uid,
            recipientName: recipient.name,
            amount: amount,
            message: message,
            timestamp: Date.now()
        };
        
        await database.ref(`transfers/${transferId}`).set(transfer);
        
        // Save sender transaction
        await database.ref(`walletTransactions/${AppState.currentUser.uid}/${senderTransactionId}`).set(senderTransaction);
        
        EnhancedUIUpdater.hideLoading();
        EnhancedUIUpdater.showToast(`ZMW ${amount.toFixed(2)} transferred to ${recipient.name}`, 'success');
        
        // Send notification to recipient
        this.sendNotification(
            recipient.uid,
            'Money Received',
            `${AppState.userData.name} sent you ZMW ${amount.toFixed(2)}`,
            'payment',
            { transferId: transferId }
        );
        
        return transferId;
    } catch (error) {
        EnhancedUIUpdater.hideLoading();
        console.error('Error transferring money:', error);
        EnhancedUIUpdater.showToast(error.message, 'error');
        throw error;
    }
},
    
    // Find the sendNotification method and update it to:
async sendNotification(userId, title, message, type = 'info', data = null, action = null) {
    try {
        const notificationId = database.ref().child('notifications').push().key;
        
        const notification = {
            id: notificationId,
            userId: userId,
            title: title,
            message: message,
            type: type,
            data: data,
            action: action,
            read: false,
            timestamp: Date.now()
        };
        
        await database.ref(`notifications/${userId}/${notificationId}`).set(notification);
        
        // Update local state if this is for current user
        if (userId === AppState.currentUser?.uid) {
            // Add to local notifications array
            AppState.notifications.unshift(notification);
            
            // Update unread count
            AppState.unreadNotifications++;
            
            // Update badge
            this.updateNotificationBadge(AppState.unreadNotifications);
            
            // Update notifications panel if open
            if (AppState.notificationsOpen) {
                EnhancedUIUpdater.updateNotifications(AppState.notifications);
            }
            
            // Show toast for important notifications
            if (type === 'error' || type === 'warning' || type === 'success') {
                setTimeout(() => {
                    EnhancedUIUpdater.showToast(message, type);
                }, 1000);
            }
        }
        
        console.log(`Notification sent: ${title}`);
        return notificationId;
    } catch (error) {
        console.error('Error sending notification:', error);
    }
},
    
   // Find the markNotificationAsRead method and update it to:
async markNotificationAsRead(notificationId) {
    try {
        await database.ref(`notifications/${AppState.currentUser.uid}/${notificationId}/read`).set(true);
        
        // Update local state
        const notification = AppState.notifications.find(n => n.id === notificationId);
        if (notification && !notification.read) {
            notification.read = true;
            AppState.unreadNotifications = Math.max(0, AppState.unreadNotifications - 1);
            
            // Update badge
            this.updateNotificationBadge(AppState.unreadNotifications);
            
            // Update notifications panel if open
            if (AppState.notificationsOpen) {
                EnhancedUIUpdater.updateNotifications(AppState.notifications);
            }
        }
    } catch (error) {
        console.error('Error marking notification as read:', error);
    }
},

// Find the markAllNotificationsAsRead method and update it to:
async markAllNotificationsAsRead() {
    try {
        const notificationsRef = database.ref(`notifications/${AppState.currentUser.uid}`);
        const snapshot = await notificationsRef.once('value');
        const notifications = snapshot.val();
        
        if (notifications) {
            const updates = {};
            Object.keys(notifications).forEach(id => {
                updates[`${id}/read`] = true;
            });
            
            await notificationsRef.update(updates);
            
            // Update local state
            AppState.notifications.forEach(n => n.read = true);
            AppState.unreadNotifications = 0;
            
            // Update badge
            this.updateNotificationBadge(0);
            
            console.log('All notifications marked as read');
        }
    } catch (error) {
        console.error('Error marking all notifications as read:', error);
    }
},
    
    async sendChatMessage(rideId, message, isDriver = false) {
        try {
            const messageId = database.ref().child('messages').push().key;
            
            const chatMessage = {
                id: messageId,
                rideId: rideId,
                senderId: AppState.currentUser.uid,
                senderName: AppState.userData.name,
                text: message,
                timestamp: Date.now(),
                isDriver: isDriver
            };
            
            await database.ref(`chats/${rideId}/messages/${messageId}`).set(chatMessage);
            
            return messageId;
        } catch (error) {
            console.error('Error sending chat message:', error);
            throw error;
        }
    },
    
    async getSplitRideDetails(splitRideId) {
        try {
            const snapshot = await database.ref(`splitRides/${splitRideId}`).once('value');
            return snapshot.val();
        } catch (error) {
            console.error('Error getting split ride details:', error);
            throw error;
        }
    },
    
    async acceptSplitRideInvitation(splitRideId, userId) {
        try {
            // Find the invitation
            const invitationsRef = database.ref('splitRideInvitations');
            const snapshot = await invitationsRef.orderByChild('splitRideId').equalTo(splitRideId).once('value');
            const invitations = snapshot.val();
            
            if (invitations) {
                for (const [invitationId, invitation] of Object.entries(invitations)) {
                    if (invitation.recipientId === userId) {
                        // Update invitation status
                        await database.ref(`splitRideInvitations/${invitationId}`).update({
                            status: 'accepted',
                            acceptedAt: Date.now()
                        });
                        
                        // Update split ride participants count
                        const splitRideRef = database.ref(`splitRides/${splitRideId}`);
                        const splitRideSnapshot = await splitRideRef.once('value');
                        const splitRide = splitRideSnapshot.val();
                        
                        const acceptedCount = (splitRide.acceptedCount || 0) + 1;
                        await splitRideRef.update({ acceptedCount });
                        
                        // Check if all participants have accepted
                        if (acceptedCount === splitRide.participants - 1) {
                            await splitRideRef.update({ status: 'ready' });
                            
                            // Notify host
                            this.sendNotification(
                                splitRide.hostId,
                                'Split Ride Ready',
                                'All participants have accepted. You can now request the ride.',
                                'split',
                                { splitRideId: splitRideId }
                            );
                        }
                        
                        return true;
                    }
                }
            }
            
            return false;
        } catch (error) {
            console.error('Error accepting split ride invitation:', error);
            throw error;
        }
    },
    
    async rejectSplitRideInvitation(splitRideId, userId) {
        try {
            // Find the invitation
            const invitationsRef = database.ref('splitRideInvitations');
            const snapshot = await invitationsRef.orderByChild('splitRideId').equalTo(splitRideId).once('value');
            const invitations = snapshot.val();
            
            if (invitations) {
                for (const [invitationId, invitation] of Object.entries(invitations)) {
                    if (invitation.recipientId === userId) {
                        // Update invitation status
                        await database.ref(`splitRideInvitations/${invitationId}`).update({
                            status: 'rejected',
                            rejectedAt: Date.now()
                        });
                        
                        // Update split ride
                        const splitRideRef = database.ref(`splitRides/${splitRideId}`);
                        await splitRideRef.update({ 
                            status: 'updated',
                            updatedAt: Date.now()
                        });
                        
                        // Recalculate shares and notify host
                        const splitRideSnapshot = await splitRideRef.once('value');
                        const splitRide = splitRideSnapshot.val();
                        
                        const newParticipants = splitRide.participants - 1;
                        const newEachShare = splitRide.totalFare / newParticipants;
                        
                        await splitRideRef.update({
                            participants: newParticipants,
                            eachShare: newEachShare
                        });
                        
                        // Notify host
                        this.sendNotification(
                            splitRide.hostId,
                            'Split Ride Updated',
                            `A participant declined. New share: ZMW ${newEachShare.toFixed(2)} per person`,
                            'split',
                            { splitRideId: splitRideId }
                        );
                        
                        return true;
                    }
                }
            }
            
            return false;
        } catch (error) {
            console.error('Error rejecting split ride invitation:', error);
            throw error;
        }
    },
    
    async getBroadcastDetails(broadcastId) {
        try {
            const snapshot = await database.ref(`broadcasts/${broadcastId}`).once('value');
            return snapshot.val();
        } catch (error) {
            console.error('Error getting broadcast details:', error);
            throw error;
        }
    },
    
    async startTrackingBroadcast(broadcastId) {
        try {
            const broadcastRef = database.ref(`broadcasts/${broadcastId}`);
            
            // Listen to broadcast updates
            AppState.realtimeListeners.push(
                broadcastRef.on('value', (snapshot) => {
                    const broadcast = snapshot.val();
                    if (broadcast) {
                        // Update broadcast tracking UI
                        console.log('Broadcast updated:', broadcast);
                        
                        // You would update the UI to show the broadcast ride tracking here
                    }
                })
            );
            
            // Also listen to the associated ride
            const broadcastSnapshot = await broadcastRef.once('value');
            const broadcast = broadcastSnapshot.val();
            
            if (broadcast && broadcast.rideId) {
                this.listenToRideUpdates(broadcast.rideId);
            }
            
            return true;
        } catch (error) {
            console.error('Error starting broadcast tracking:', error);
            throw error;
        }
    },
    
    async saveSOSConfig(contact1Name, contact1Phone, contact2Name, contact2Phone, message) {
        try {
            const sosConfig = {
                contact1Name: contact1Name,
                contact1Phone: contact1Phone,
                contact2Name: contact2Name,
                contact2Phone: contact2Phone,
                message: message,
                updatedAt: Date.now()
            };
            
            await database.ref(`sosConfig/${AppState.currentUser.uid}`).set(sosConfig);
            
            AppState.sosConfig = sosConfig;
            
            EnhancedUIUpdater.showToast('SOS configuration saved', 'success');
            return true;
        } catch (error) {
            console.error('Error saving SOS config:', error);
            EnhancedUIUpdater.showToast('Error saving SOS config', 'error');
            return false;
        }
    },
    
    async sendSOSAlert(rideId, sosData) {
        try {
            // Create SOS alert
            const alertId = database.ref().child('sosAlerts').push().key;
            
            const alert = {
                id: alertId,
                rideId: rideId,
                userId: AppState.currentUser.uid,
                userName: AppState.userData.name,
                contacts: [
                    { name: sosData.emergencyContact1Name, phone: sosData.emergencyContact1 },
                    { name: sosData.emergencyContact2Name, phone: sosData.emergencyContact2 }
                ],
                message: sosData.message,
                location: sosData.location,
                rideDetails: sosData.rideDetails,
                timestamp: Date.now(),
                status: 'sent'
            };
            
            await database.ref(`sosAlerts/${alertId}`).set(alert);
            
            // TODO: Actually send SMS/notification to contacts
            // This would require a backend service
            
            EnhancedUIUpdater.showToast('SOS alert sent to emergency contacts', 'success');
            return alertId;
        } catch (error) {
            console.error('Error sending SOS alert:', error);
            EnhancedUIUpdater.showToast('Error sending SOS alert', 'error');
            throw error;
        }
    }
};


// ============================================
// ENHANCED WALLET MANAGER
// ============================================
const EnhancedWalletManager = {
    // Initialize wallet manager
    init: function() {
        console.log(' Enhanced Wallet Manager initialized');
        this.setupWalletEventListeners();
    },
    
    // Setup event listeners for wallet
    setupWalletEventListeners: function() {
        // Deposit button
        const depositBtn = document.getElementById('depositBtn');
        if (depositBtn) {
            depositBtn.addEventListener('click', () => {
                this.showDepositModal();
            });
        }
        
        // Withdraw button
        const withdrawBtn = document.getElementById('withdrawBtn');
        if (withdrawBtn) {
            withdrawBtn.addEventListener('click', () => {
                this.showWithdrawModal();
            });
        }
        
        // Transactions button
        const transactionsBtn = document.getElementById('transactionsBtn');
        if (transactionsBtn) {
            transactionsBtn.addEventListener('click', () => {
                this.showTransactionsModal();
            });
        }
        
        // Transfer button (already exists)
        const transferBtn = document.getElementById('transferBtn');
        if (transferBtn) {
            transferBtn.addEventListener('click', () => {
                showModal('transfer');
            });
        }
        
        // Confirm deposit button
        const confirmDepositBtn = document.getElementById('confirmDepositBtn');
        if (confirmDepositBtn) {
            confirmDepositBtn.addEventListener('click', () => {
                this.processDeposit();
            });
        }
        
        // Confirm withdraw button
        const confirmWithdrawBtn = document.getElementById('confirmWithdrawBtn');
        if (confirmWithdrawBtn) {
            confirmWithdrawBtn.addEventListener('click', () => {
                this.processWithdrawal();
            });
        }
        
        // Quick amount buttons
        this.setupQuickAmounts();
        
        // Payment method selection
        this.setupPaymentMethodSelection();
        
        // Export transactions button
        const exportBtn = document.getElementById('exportTransactionsBtn');
        if (exportBtn) {
            exportBtn.addEventListener('click', () => {
                this.exportTransactions();
            });
        }
        
        // Transaction filters
        this.setupTransactionFilters();
    },
    
    // Show deposit modal
    showDepositModal: function() {
        // Update current balance
        const depositCurrentBalance = document.getElementById('depositCurrentBalance');
        if (depositCurrentBalance) {
            depositCurrentBalance.textContent = `ZMW ${AppState.walletBalance.toFixed(2)}`;
        }
        
        // Reset form
        const depositAmount = document.getElementById('depositAmount');
        if (depositAmount) {
            depositAmount.value = '';
        }
        
        // Remove active class from quick amounts
        document.querySelectorAll('.quick-amount').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Remove selected class from payment methods
        document.querySelectorAll('.payment-method-option').forEach(method => {
            method.classList.remove('selected');
        });
        
        // Clear payment details
        const paymentMethodDetails = document.getElementById('paymentMethodDetails');
        if (paymentMethodDetails) {
            paymentMethodDetails.innerHTML = '';
        }
        
        // Show modal
        showModal('deposit');
    },
    
    // Show withdraw modal
    showWithdrawModal: function() {
        // Update current balance
        const withdrawCurrentBalance = document.getElementById('withdrawCurrentBalance');
        if (withdrawCurrentBalance) {
            withdrawCurrentBalance.textContent = `ZMW ${AppState.walletBalance.toFixed(2)}`;
        }
        
        // Reset form
        const withdrawAmount = document.getElementById('withdrawAmount');
        if (withdrawAmount) {
            withdrawAmount.value = '';
        }
        
        // Remove active class from quick amounts
        document.querySelectorAll('.quick-amount').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Remove selected class from withdrawal methods
        document.querySelectorAll('.payment-method-option').forEach(method => {
            method.classList.remove('selected');
        });
        
        // Clear withdrawal details
        const withdrawMethodDetails = document.getElementById('withdrawMethodDetails');
        if (withdrawMethodDetails) {
            withdrawMethodDetails.innerHTML = '';
        }
        
        // Show modal
        showModal('withdraw');
    },
    
    // Show transactions modal
    showTransactionsModal: function() {
        // Update balance and count
        const transactionsBalance = document.getElementById('transactionsBalance');
        const transactionsCount = document.getElementById('transactionsCount');
        
        if (transactionsBalance) {
            transactionsBalance.textContent = `ZMW ${AppState.walletBalance.toFixed(2)}`;
        }
        
        if (transactionsCount && AppState.walletTransactions) {
            transactionsCount.textContent = AppState.walletTransactions.length;
        }
        
        // Load and display transactions
        this.displayTransactions(AppState.walletTransactions || []);
        
        // Show modal
        showModal('transactions');
    },
    
    // Setup quick amount buttons
    setupQuickAmounts: function() {
        // Deposit quick amounts
        const depositModal = document.getElementById('depositModal');
        if (depositModal) {
            depositModal.querySelectorAll('.quick-amount').forEach(btn => {
                btn.addEventListener('click', function() {
                    // Remove active class from all
                    depositModal.querySelectorAll('.quick-amount').forEach(b => {
                        b.classList.remove('active');
                    });
                    
                    // Add active class to clicked
                    this.classList.add('active');
                    
                    // Set amount in input
                    const amount = this.dataset.amount;
                    const depositAmount = document.getElementById('depositAmount');
                    if (depositAmount) {
                        depositAmount.value = amount;
                    }
                });
            });
        }
        
        // Withdraw quick amounts
        const withdrawModal = document.getElementById('withdrawModal');
        if (withdrawModal) {
            withdrawModal.querySelectorAll('.quick-amount').forEach(btn => {
                btn.addEventListener('click', function() {
                    // Remove active class from all
                    withdrawModal.querySelectorAll('.quick-amount').forEach(b => {
                        b.classList.remove('active');
                    });
                    
                    // Add active class to clicked
                    this.classList.add('active');
                    
                    // Set amount in input
                    const amount = this.dataset.amount;
                    const withdrawAmount = document.getElementById('withdrawAmount');
                    if (withdrawAmount) {
                        withdrawAmount.value = amount;
                    }
                });
            });
        }
    },
    
    // Setup payment method selection
    setupPaymentMethodSelection: function() {
        // Deposit payment methods
        const depositModal = document.getElementById('depositModal');
        if (depositModal) {
            depositModal.querySelectorAll('.payment-method-option').forEach(method => {
                method.addEventListener('click', function() {
                    // Remove selected class from all
                    depositModal.querySelectorAll('.payment-method-option').forEach(m => {
                        m.classList.remove('selected');
                    });
                    
                    // Add selected class to clicked
                    this.classList.add('selected');
                    
                    // Show payment details
                    const methodType = this.dataset.method;
                    EnhancedWalletManager.showPaymentMethodDetails(methodType, 'deposit');
                });
            });
        }
        
        // Withdraw payment methods
        const withdrawModal = document.getElementById('withdrawModal');
        if (withdrawModal) {
            withdrawModal.querySelectorAll('.payment-method-option').forEach(method => {
                method.addEventListener('click', function() {
                    // Remove selected class from all
                    withdrawModal.querySelectorAll('.payment-method-option').forEach(m => {
                        m.classList.remove('selected');
                    });
                    
                    // Add selected class to clicked
                    this.classList.add('selected');
                    
                    // Show withdrawal details
                    const methodType = this.dataset.method;
                    EnhancedWalletManager.showWithdrawalMethodDetails(methodType);
                });
            });
        }
    },
    
    // Show payment method details
    showPaymentMethodDetails: function(methodType, type) {
        const container = type === 'deposit' ? 
            document.getElementById('paymentMethodDetails') : 
            document.getElementById('withdrawMethodDetails');
        
        if (!container) return;
        
        let html = '';
        
        switch(methodType) {
            case 'mtn':
                html = `
                    <div style="background: #FFF3E0; padding: 15px; border-radius: 8px;">
                        <div style="font-weight: 600; margin-bottom: 10px; color: #FF6B35;">
                            <i class="fas fa-info-circle"></i> MTN Mobile Money Instructions
                        </div>
                        <div style="font-size: 14px; color: #333; margin-bottom: 10px;">
                            To complete your deposit via MTN:
                        </div>
                        <ol style="font-size: 13px; color: #666; padding-left: 20px; margin: 0;">
                            <li>Dial *111# on your MTN line</li>
                            <li>Select "Send Money"</li>
                            <li>Enter Jubel's MTN number: <strong>0961234567</strong></li>
                            <li>Enter the exact deposit amount</li>
                            <li>Use your Jubel ID as reference</li>
                        </ol>
                        <div style="margin-top: 10px; font-size: 12px; color: #999;">
                            Deposit will reflect within 5-10 minutes after confirmation
                        </div>
                    </div>
                `;
                break;
                
            case 'airtel':
                html = `
                    <div style="background: #FFF3E0; padding: 15px; border-radius: 8px;">
                        <div style="font-weight: 600; margin-bottom: 10px; color: #FF6B35;">
                            <i class="fas fa-info-circle"></i> Airtel Money Instructions
                        </div>
                        <div style="font-size: 14px; color: #333; margin-bottom: 10px;">
                            To complete your deposit via Airtel:
                        </div>
                        <ol style="font-size: 13px; color: #666; padding-left: 20px; margin: 0;">
                            <li>Dial *123# on your Airtel line</li>
                            <li>Select "Send Money"</li>
                            <li>Enter Jubel's Airtel number: <strong>0971234567</strong></li>
                            <li>Enter the exact deposit amount</li>
                            <li>Use your Jubel ID as reference</li>
                        </ol>
                        <div style="margin-top: 10px; font-size: 12px; color: #999;">
                            Deposit will reflect within 5-10 minutes after confirmation
                        </div>
                    </div>
                `;
                break;
                
            case 'zamtel':
                html = `
                    <div style="background: #FFF3E0; padding: 15px; border-radius: 8px;">
                        <div style="font-weight: 600; margin-bottom: 10px; color: #FF6B35;">
                            <i class="fas fa-info-circle"></i> Zamtel Kwacha Instructions
                        </div>
                        <div style="font-size: 14px; color: #333; margin-bottom: 10px;">
                            To complete your deposit via Zamtel:
                        </div>
                        <ol style="font-size: 13px; color: #666; padding-left: 20px; margin: 0;">
                            <li>Dial *115# on your Zamtel line</li>
                            <li>Select "Send Money"</li>
                            <li>Enter Jubel's Zamtel number: <strong>0951234567</strong></li>
                            <li>Enter the exact deposit amount</li>
                            <li>Use your Jubel ID as reference</li>
                        </ol>
                        <div style="margin-top: 10px; font-size: 12px; color: #999;">
                            Deposit will reflect within 5-10 minutes after confirmation
                        </div>
                    </div>
                `;
                break;
                
            case 'bank':
                html = `
                    <div style="background: #FFF3E0; padding: 15px; border-radius: 8px;">
                        <div style="font-weight: 600; margin-bottom: 10px; color: #FF6B35;">
                            <i class="fas fa-info-circle"></i> Bank Transfer Instructions
                        </div>
                        <div style="font-size: 14px; color: #333; margin-bottom: 10px;">
                            Jubel Bank Details:
                        </div>
                        <div style="font-size: 13px; color: #666;">
                            <div><strong>Bank:</strong> Zanaco</div>
                            <div><strong>Account Name:</strong> Jubel Technologies Ltd</div>
                            <div><strong>Account Number:</strong> 1234567890</div>
                            <div><strong>Branch Code:</strong> 0100</div>
                            <div><strong>Reference:</strong> ${AppState.userData?.name || 'Your Name'}</div>
                        </div>
                        <div style="margin-top: 10px; font-size: 12px; color: #999;">
                            Bank transfers take 1-2 business days to reflect
                        </div>
                    </div>
                `;
                break;
        }
        
        container.innerHTML = html;
    },
    
    // Show withdrawal method details
    showWithdrawalMethodDetails: function(methodType) {
        const container = document.getElementById('withdrawMethodDetails');
        if (!container) return;
        
        let html = '';
        
        switch(methodType) {
            case 'mtn':
                html = `
                    <div style="background: #FFF3E0; padding: 15px; border-radius: 8px;">
                        <div style="font-weight: 600; margin-bottom: 10px; color: #FF6B35;">
                            <i class="fas fa-info-circle"></i> MTN Withdrawal
                        </div>
                        <input type="tel" class="form-control" id="mtnPhone" placeholder="Enter your MTN phone number" style="margin-bottom: 10px;">
                        <div style="font-size: 12px; color: #666;">
                            Withdrawals to MTN are processed within 24 hours
                        </div>
                    </div>
                `;
                break;
                
            case 'airtel':
                html = `
                    <div style="background: #FFF3E0; padding: 15px; border-radius: 8px;">
                        <div style="font-weight: 600; margin-bottom: 10px; color: #FF6B35;">
                            <i class="fas fa-info-circle"></i> Airtel Withdrawal
                        </div>
                        <input type="tel" class="form-control" id="airtelPhone" placeholder="Enter your Airtel phone number" style="margin-bottom: 10px;">
                        <div style="font-size: 12px; color: #666;">
                            Withdrawals to Airtel are processed within 24 hours
                        </div>
                    </div>
                `;
                break;
                
            case 'zamtel':
                html = `
                    <div style="background: #FFF3E0; padding: 15px; border-radius: 8px;">
                        <div style="font-weight: 600; margin-bottom: 10px; color: #FF6B35;">
                            <i class="fas fa-info-circle"></i> Zamtel Withdrawal
                        </div>
                        <input type="tel" class="form-control" id="zamtelPhone" placeholder="Enter your Zamtel phone number" style="margin-bottom: 10px;">
                        <div style="font-size: 12px; color: #666;">
                            Withdrawals to Zamtel are processed within 24 hours
                        </div>
                    </div>
                `;
                break;
                
            case 'bank':
                html = `
                    <div style="background: #FFF3E0; padding: 15px; border-radius: 8px;">
                        <div style="font-weight: 600; margin-bottom: 10px; color: #FF6B35;">
                            <i class="fas fa-info-circle"></i> Bank Withdrawal
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <input type="text" class="form-control" id="bankName" placeholder="Bank Name">
                            <input type="text" class="form-control" id="accountNumber" placeholder="Account Number">
                        </div>
                        <input type="text" class="form-control" id="accountHolder" placeholder="Account Holder Name" style="margin-bottom: 10px;">
                        <div style="font-size: 12px; color: #666;">
                            Bank withdrawals are processed within 2-3 business days
                        </div>
                    </div>
                `;
                break;
        }
        
        container.innerHTML = html;
    },
    
    // Process deposit
    processDeposit: function() {
        // Get amount
        const amountInput = document.getElementById('depositAmount');
        const amount = parseFloat(amountInput.value);
        
        if (!amount || amount <= 0) {
            EnhancedUIUpdater.showToast('Please enter a valid amount', 'warning');
            return;
        }
        
        // Get payment method
        const selectedMethod = document.querySelector('#depositModal .payment-method-option.selected');
        if (!selectedMethod) {
            EnhancedUIUpdater.showToast('Please select a payment method', 'warning');
            return;
        }
        
        const method = selectedMethod.dataset.method;
        const methodName = selectedMethod.querySelector('.payment-method-name').textContent;
        
        // Get additional details based on method
        let details = '';
        if (method === 'bank') {
            details = 'Bank transfer';
        } else {
            details = `${methodName.toUpperCase()} deposit`;
        }
        
        EnhancedUIUpdater.showLoading('Processing deposit request...');
        
        // In a real app, you would integrate with a payment gateway here
        // For demo purposes, we'll simulate a successful deposit
        
        setTimeout(() => {
            // Create deposit transaction
            this.createDepositTransaction(amount, method, details)
                .then(() => {
                    EnhancedUIUpdater.hideLoading();
                    hideModal('deposit');
                    
                    EnhancedUIUpdater.showToast(`Deposit request for ZMW ${amount.toFixed(2)} submitted!`, 'success');
                    
                    // Show confirmation message
                    this.showDepositConfirmation(amount, method);
                })
                .catch(error => {
                    EnhancedUIUpdater.hideLoading();
                    console.error('Error creating deposit:', error);
                    EnhancedUIUpdater.showToast('Error processing deposit', 'error');
                });
        }, 2000);
    },
    
    // Process withdrawal
    processWithdrawal: function() {
        // Get amount
        const amountInput = document.getElementById('withdrawAmount');
        const amount = parseFloat(amountInput.value);
        
        if (!amount || amount <= 0) {
            EnhancedUIUpdater.showToast('Please enter a valid amount', 'warning');
            return;
        }
        
        if (amount > AppState.walletBalance) {
            EnhancedUIUpdater.showToast('Insufficient balance', 'error');
            return;
        }
        
        // Get withdrawal method
        const selectedMethod = document.querySelector('#withdrawModal .payment-method-option.selected');
        if (!selectedMethod) {
            EnhancedUIUpdater.showToast('Please select a withdrawal method', 'warning');
            return;
        }
        
        const method = selectedMethod.dataset.method;
        const methodName = selectedMethod.querySelector('.payment-method-name').textContent;
        
        // Validate method-specific details
        let recipientDetails = '';
        switch(method) {
            case 'mtn':
                const mtnPhone = document.getElementById('mtnPhone');
                if (!mtnPhone || !mtnPhone.value.trim()) {
                    EnhancedUIUpdater.showToast('Please enter your MTN phone number', 'warning');
                    return;
                }
                recipientDetails = mtnPhone.value;
                break;
                
            case 'airtel':
                const airtelPhone = document.getElementById('airtelPhone');
                if (!airtelPhone || !airtelPhone.value.trim()) {
                    EnhancedUIUpdater.showToast('Please enter your Airtel phone number', 'warning');
                    return;
                }
                recipientDetails = airtelPhone.value;
                break;
                
            case 'zamtel':
                const zamtelPhone = document.getElementById('zamtelPhone');
                if (!zamtelPhone || !zamtelPhone.value.trim()) {
                    EnhancedUIUpdater.showToast('Please enter your Zamtel phone number', 'warning');
                    return;
                }
                recipientDetails = zamtelPhone.value;
                break;
                
            case 'bank':
                const bankName = document.getElementById('bankName');
                const accountNumber = document.getElementById('accountNumber');
                const accountHolder = document.getElementById('accountHolder');
                
                if (!bankName || !bankName.value.trim()) {
                    EnhancedUIUpdater.showToast('Please enter bank name', 'warning');
                    return;
                }
                if (!accountNumber || !accountNumber.value.trim()) {
                    EnhancedUIUpdater.showToast('Please enter account number', 'warning');
                    return;
                }
                if (!accountHolder || !accountHolder.value.trim()) {
                    EnhancedUIUpdater.showToast('Please enter account holder name', 'warning');
                    return;
                }
                
                recipientDetails = `${bankName.value} - ${accountNumber.value} (${accountHolder.value})`;
                break;
        }
        
        EnhancedUIUpdater.showLoading('Processing withdrawal request...');
        
        // Create withdrawal transaction
        this.createWithdrawalTransaction(amount, method, recipientDetails)
            .then(() => {
                EnhancedUIUpdater.hideLoading();
                hideModal('withdraw');
                
                EnhancedUIUpdater.showToast(`Withdrawal request for ZMW ${amount.toFixed(2)} submitted!`, 'success');
                
                // Show confirmation message
                this.showWithdrawalConfirmation(amount, method, recipientDetails);
            })
            .catch(error => {
                EnhancedUIUpdater.hideLoading();
                console.error('Error creating withdrawal:', error);
                EnhancedUIUpdater.showToast('Error processing withdrawal', 'error');
            });
    },
    
    // Create deposit transaction in Firebase
    createDepositTransaction: async function(amount, method, details) {
        try {
            const transactionId = database.ref().child('walletTransactions').push().key;
            
            const transaction = {
                id: transactionId,
                userId: AppState.currentUser.uid,
                type: 'deposit',
                amount: amount,
                method: method,
                details: details,
                description: `Deposit via ${method}`,
                status: 'pending',
                timestamp: Date.now(),
                balanceBefore: AppState.walletBalance,
                balanceAfter: AppState.walletBalance, // Will be updated when deposit is confirmed
                metadata: {
                    initiatedBy: 'user',
                    userAgent: navigator.userAgent,
                    platform: 'web'
                }
            };
            
            // Save transaction to Firebase
            await database.ref(`walletTransactions/${AppState.currentUser.uid}/${transactionId}`).set(transaction);
            
            // Send notification
            EnhancedFirebaseManager.sendNotification(
                AppState.currentUser.uid,
                'Deposit Requested',
                `Your deposit of ZMW ${amount.toFixed(2)} is being processed`,
                'payment',
                { transactionId: transactionId, amount: amount }
            );
            
            return transactionId;
        } catch (error) {
            console.error('Error creating deposit transaction:', error);
            throw error;
        }
    },
    
    // Create withdrawal transaction in Firebase
    createWithdrawalTransaction: async function(amount, method, recipientDetails) {
        try {
            const transactionId = database.ref().child('walletTransactions').push().key;
            
            const transaction = {
                id: transactionId,
                userId: AppState.currentUser.uid,
                type: 'withdrawal',
                amount: amount,
                method: method,
                recipientDetails: recipientDetails,
                description: `Withdrawal to ${method}`,
                status: 'pending',
                timestamp: Date.now(),
                balanceBefore: AppState.walletBalance,
                balanceAfter: AppState.walletBalance - amount,
                metadata: {
                    initiatedBy: 'user',
                    userAgent: navigator.userAgent,
                    platform: 'web'
                }
            };
            
            // Save transaction to Firebase
            await database.ref(`walletTransactions/${AppState.currentUser.uid}/${transactionId}`).set(transaction);
            
            // Update wallet balance (immediate deduction for withdrawals)
            await EnhancedFirebaseManager.withdrawMoney(amount, `Withdrawal to ${method}`, transactionId);
            
            // Send notification
            EnhancedFirebaseManager.sendNotification(
                AppState.currentUser.uid,
                'Withdrawal Requested',
                `Your withdrawal of ZMW ${amount.toFixed(2)} is being processed`,
                'payment',
                { transactionId: transactionId, amount: amount }
            );
            
            return transactionId;
        } catch (error) {
            console.error('Error creating withdrawal transaction:', error);
            throw error;
        }
    },
    
    // Show deposit confirmation
    showDepositConfirmation: function(amount, method) {
        const modal = document.createElement('div');
        modal.className = 'deposit-confirmation-modal';
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10002;
            padding: 20px;
        `;
        
        let instructions = '';
        switch(method) {
            case 'mtn':
                instructions = `
                    <h4 style="color: #333; margin-bottom: 15px;">Complete Your Deposit:</h4>
                    <ol style="text-align: left; padding-left: 20px; color: #666; margin-bottom: 20px;">
                        <li>Dial <strong>*111#</strong> on your MTN line</li>
                        <li>Select <strong>"Send Money"</strong></li>
                        <li>Enter: <strong>0961234567</strong></li>
                        <li>Amount: <strong>ZMW ${amount.toFixed(2)}</strong></li>
                        <li>Reference: <strong>${AppState.userData?.referralCode || 'JUBEL'}</strong></li>
                    </ol>
                `;
                break;
            case 'bank':
                instructions = `
                    <h4 style="color: #333; margin-bottom: 15px;">Complete Your Deposit:</h4>
                    <div style="text-align: left; color: #666; margin-bottom: 20px;">
                        <p>Transfer <strong>ZMW ${amount.toFixed(2)}</strong> to:</p>
                        <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin-top: 10px;">
                            <div><strong>Bank:</strong> Zanaco</div>
                            <div><strong>Account:</strong> Jubel Technologies Ltd</div>
                            <div><strong>Account No:</strong> 1234567890</div>
                            <div><strong>Reference:</strong> ${AppState.userData?.name || 'Your Name'}</div>
                        </div>
                    </div>
                `;
                break;
            default:
                instructions = `
                    <h4 style="color: #333; margin-bottom: 15px;">Complete Your Deposit:</h4>
                    <p style="color: #666; margin-bottom: 20px;">
                        Follow the instructions for ${method.toUpperCase()} to complete your deposit of ZMW ${amount.toFixed(2)}
                    </p>
                `;
        }
        
        modal.innerHTML = `
            <div style="
                background: white;
                border-radius: 12px;
                width: 100%;
                max-width: 500px;
                overflow: hidden;
            ">
                <div style="
                    padding: 25px;
                    background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%);
                    color: white;
                    text-align: center;
                ">
                    <div style="font-size: 48px; margin-bottom: 15px;">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h3 style="margin: 0; font-size: 20px;">
                        Deposit Request Submitted!
                    </h3>
                    <p style="margin: 10px 0 0 0; font-size: 14px; opacity: 0.9;">
                        ZMW ${amount.toFixed(2)} via ${method.toUpperCase()}
                    </p>
                </div>
                
                <div style="padding: 25px;">
                    ${instructions}
                    
                    <div style="background: #FFF3E0; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 10px; color: #FF9800;">
                            <i class="fas fa-clock"></i>
                            <div style="font-size: 14px;">
                                Deposit will reflect in your wallet within 5-10 minutes after payment confirmation
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button id="closeDepositConfirmation" style="
                            flex: 1;
                            padding: 15px;
                            background: #4CAF50;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                            font-weight: 600;
                        ">
                            <i class="fas fa-check"></i> Got it!
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Close button
        modal.querySelector('#closeDepositConfirmation').addEventListener('click', () => {
            document.body.removeChild(modal);
        });
    },
    
    // Show withdrawal confirmation
    showWithdrawalConfirmation: function(amount, method, recipientDetails) {
        const modal = document.createElement('div');
        modal.className = 'withdrawal-confirmation-modal';
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10002;
            padding: 20px;
        `;
        
        modal.innerHTML = `
            <div style="
                background: white;
                border-radius: 12px;
                width: 100%;
                max-width: 500px;
                overflow: hidden;
            ">
                <div style="
                    padding: 25px;
                    background: linear-gradient(135deg, #2196F3 0%, #42A5F5 100%);
                    color: white;
                    text-align: center;
                ">
                    <div style="font-size: 48px; margin-bottom: 15px;">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h3 style="margin: 0; font-size: 20px;">
                        Withdrawal Request Submitted!
                    </h3>
                    <p style="margin: 10px 0 0 0; font-size: 14px; opacity: 0.9;">
                        ZMW ${amount.toFixed(2)} to ${method.toUpperCase()}
                    </p>
                </div>
                
                <div style="padding: 25px;">
                    <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="color: #333; margin-bottom: 10px;">
                            <strong>Withdrawal Details:</strong>
                        </div>
                        <div style="font-size: 14px; color: #666;">
                            <div><strong>Amount:</strong> ZMW ${amount.toFixed(2)}</div>
                            <div><strong>Method:</strong> ${method.toUpperCase()}</div>
                            <div><strong>Recipient:</strong> ${recipientDetails}</div>
                        </div>
                    </div>
                    
                    <div style="background: #E3F2FD; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 10px; color: #2196F3;">
                            <i class="fas fa-info-circle"></i>
                            <div style="font-size: 14px;">
                                Withdrawal processing time:
                                ${method === 'bank' ? '2-3 business days' : '24 hours'}
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button id="closeWithdrawalConfirmation" style="
                            flex: 1;
                            padding: 15px;
                            background: #2196F3;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                            font-weight: 600;
                        ">
                            <i class="fas fa-check"></i> Got it!
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Close button
        modal.querySelector('#closeWithdrawalConfirmation').addEventListener('click', () => {
            document.body.removeChild(modal);
        });
    },
    
    // Display transactions with filtering
    displayTransactions: function(transactions) {
        const container = document.getElementById('transactionsList');
        if (!container) return;
        
        // Filter transactions based on active filter
        const activeFilter = AppState.transactionFilter || 'all';
        let filteredTransactions = transactions;
        
        if (activeFilter !== 'all') {
            filteredTransactions = transactions.filter(t => t.type === activeFilter);
        }
        
        // Sort by timestamp (newest first)
        filteredTransactions.sort((a, b) => b.timestamp - a.timestamp);
        
        if (filteredTransactions.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px 20px; color: #999;">
                    <i class="fas fa-receipt" style="font-size: 48px; margin-bottom: 20px;"></i>
                    <div style="font-weight: 600; margin-bottom: 10px;">No ${activeFilter !== 'all' ? activeFilter + ' ' : ''}transactions</div>
                    <div>${activeFilter !== 'all' ? 'Try another filter' : 'Your transaction history will appear here'}</div>
                </div>
            `;
            return;
        }
        
        let html = '';
        
        filteredTransactions.forEach(transaction => {
            const time = new Date(transaction.timestamp);
            const timeString = this.formatTransactionTime(time);
            
            // Determine icon and color based on transaction type
            const iconInfo = this.getTransactionIconInfo(transaction);
            
            // Determine amount display
            const amountClass = transaction.type === 'deposit' || transaction.type === 'refund' || transaction.type === 'referral' ? 
                'positive' : 
                transaction.type === 'withdrawal' || transaction.type === 'payment' ? 'negative' : 'neutral';
            
            const amountSign = transaction.type === 'deposit' || transaction.type === 'refund' || transaction.type === 'referral' ? '+' : '-';
            
            html += `
                <div class="transaction-item" data-transaction-id="${transaction.id}">
                    <div class="transaction-icon ${iconInfo.class}">
                        <i class="fas ${iconInfo.icon}"></i>
                    </div>
                    <div class="transaction-details">
                        <div class="transaction-title">${this.getTransactionTitle(transaction)}</div>
                        <div class="transaction-meta">
                            ${timeString}  ${transaction.description || ''}
                            ${transaction.method ? `  ${transaction.method.toUpperCase()}` : ''}
                        </div>
                        ${transaction.status === 'pending' ? `
                        <div class="transaction-status pending">Pending</div>
                        ` : transaction.status === 'failed' ? `
                        <div class="transaction-status failed">Failed</div>
                        ` : ''}
                    </div>
                    <div class="transaction-amount ${amountClass}">
                        ${amountSign}ZMW ${transaction.amount.toFixed(2)}
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        
        // Add click handlers for transaction items
        container.querySelectorAll('.transaction-item').forEach(item => {
            item.addEventListener('click', () => {
                const transactionId = item.dataset.transactionId;
                const transaction = filteredTransactions.find(t => t.id === transactionId);
                if (transaction) {
                    this.showTransactionDetails(transaction);
                }
            });
        });
    },
    
    // Get transaction icon info
    getTransactionIconInfo: function(transaction) {
        switch(transaction.type) {
            case 'deposit':
                return { icon: 'fa-plus-circle', class: 'deposit' };
            case 'withdrawal':
                return { icon: 'fa-minus-circle', class: 'withdrawal' };
            case 'payment':
                return { icon: 'fa-money-bill-wave', class: 'payment' };
            case 'refund':
                return { icon: 'fa-undo', class: 'refund' };
            case 'transfer':
                return { icon: 'fa-exchange-alt', class: 'transfer' };
            case 'referral':
                return { icon: 'fa-gift', class: 'referral' };
            default:
                return { icon: 'fa-receipt', class: 'payment' };
        }
    },
    
    // Get transaction title
    getTransactionTitle: function(transaction) {
        switch(transaction.type) {
            case 'deposit':
                return 'Deposit';
            case 'withdrawal':
                return 'Withdrawal';
            case 'payment':
                return transaction.description || 'Payment';
            case 'refund':
                return 'Refund';
            case 'transfer':
                return transaction.fromName ? `Transfer from ${transaction.fromName}` : 
                       transaction.toName ? `Transfer to ${transaction.toName}` : 'Transfer';
            case 'referral':
                return 'Referral Bonus';
            default:
                return 'Transaction';
        }
    },
    
    // Format transaction time
    formatTransactionTime: function(date) {
        const now = new Date();
        const diff = now - date;
        
        if (diff < 60000) return 'Just now';
        if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
        if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
        if (diff < 604800000) return `${Math.floor(diff / 86400000)}d ago`;
        return date.toLocaleDateString();
    },
    
    // Setup transaction filters
    setupTransactionFilters: function() {
        const filterButtons = document.querySelectorAll('#transactionsModal .filter-btn');
        filterButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                // Remove active class from all
                filterButtons.forEach(b => {
                    b.classList.remove('active');
                });
                
                // Add active class to clicked
                this.classList.add('active');
                
                // Set active filter
                const filter = this.dataset.filter;
                AppState.transactionFilter = filter;
                
                // Display filtered transactions
                EnhancedWalletManager.displayTransactions(AppState.walletTransactions || []);
            });
        });
    },
    
    // Show transaction details
    showTransactionDetails: function(transaction) {
        const modal = document.createElement('div');
        modal.className = 'transaction-details-modal';
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10002;
            padding: 20px;
        `;
        
        const time = new Date(transaction.timestamp);
        const iconInfo = this.getTransactionIconInfo(transaction);
        
        let detailsHtml = '';
        if (transaction.method) {
            detailsHtml += `<div><strong>Method:</strong> ${transaction.method.toUpperCase()}</div>`;
        }
        if (transaction.recipientDetails) {
            detailsHtml += `<div><strong>Recipient:</strong> ${transaction.recipientDetails}</div>`;
        }
        if (transaction.reference) {
            detailsHtml += `<div><strong>Reference:</strong> ${transaction.reference}</div>`;
        }
        if (transaction.fromName) {
            detailsHtml += `<div><strong>From:</strong> ${transaction.fromName}</div>`;
        }
        if (transaction.toName) {
            detailsHtml += `<div><strong>To:</strong> ${transaction.toName}</div>`;
        }
        
        modal.innerHTML = `
            <div style="
                background: white;
                border-radius: 12px;
                width: 100%;
                max-width: 500px;
                overflow: hidden;
            ">
                <div style="
                    padding: 25px;
                    background: linear-gradient(135deg, ${iconInfo.class === 'deposit' ? '#4CAF50' : iconInfo.class === 'withdrawal' ? '#2196F3' : '#FF6B35'} 0%, 
                                                  ${iconInfo.class === 'deposit' ? '#66BB6A' : iconInfo.class === 'withdrawal' ? '#42A5F5' : '#FF8B35'} 100%);
                    color: white;
                    text-align: center;
                ">
                    <div style="font-size: 48px; margin-bottom: 15px;">
                        <i class="fas ${iconInfo.icon}"></i>
                    </div>
                    <h3 style="margin: 0; font-size: 20px;">
                        ${this.getTransactionTitle(transaction)}
                    </h3>
                    <p style="margin: 10px 0 0 0; font-size: 14px; opacity: 0.9;">
                        ${time.toLocaleDateString()}  ${time.toLocaleTimeString()}
                    </p>
                </div>
                
                <div style="padding: 25px;">
                    <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div style="font-size: 14px; color: #666;">Amount</div>
                            <div style="font-size: 28px; font-weight: 700; 
                                  color: ${transaction.type === 'deposit' || transaction.type === 'refund' || transaction.type === 'referral' ? '#4CAF50' : '#F44336'}">
                                ${transaction.type === 'deposit' || transaction.type === 'refund' || transaction.type === 'referral' ? '+' : '-'}ZMW ${transaction.amount.toFixed(2)}
                            </div>
                        </div>
                        
                        <div style="border-top: 1px solid #eee; padding-top: 15px;">
                            <div style="font-size: 14px; color: #666; margin-bottom: 10px;"><strong>Transaction Details</strong></div>
                            <div style="font-size: 13px; color: #333; line-height: 1.6;">
                                <div><strong>Transaction ID:</strong> ${transaction.id.substring(0, 8)}...</div>
                                <div><strong>Status:</strong> 
                                    <span style="
                                        padding: 2px 8px;
                                        border-radius: 10px;
                                        background: ${transaction.status === 'completed' ? '#E8F5E9' : transaction.status === 'pending' ? '#FFF3E0' : '#FFEBEE'};
                                        color: ${transaction.status === 'completed' ? '#2E7D32' : transaction.status === 'pending' ? '#FF9800' : '#C62828'};
                                        font-size: 11px;
                                    ">
                                        ${transaction.status?.charAt(0).toUpperCase() + transaction.status?.slice(1) || 'Completed'}
                                    </span>
                                </div>
                                ${detailsHtml}
                                ${transaction.description ? `<div><strong>Description:</strong> ${transaction.description}</div>` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button id="closeTransactionDetails" style="
                            flex: 1;
                            padding: 15px;
                            background: #FF6B35;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                            font-weight: 600;
                        ">
                            <i class="fas fa-check"></i> Close
                        </button>
                        <button id="shareTransactionBtn" style="
                            padding: 15px 20px;
                            background: #f5f5f5;
                            color: #666;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                            font-weight: 600;
                        ">
                            <i class="fas fa-share"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Close button
        modal.querySelector('#closeTransactionDetails').addEventListener('click', () => {
            document.body.removeChild(modal);
        });
        
        // Share button
        modal.querySelector('#shareTransactionBtn').addEventListener('click', () => {
            this.shareTransaction(transaction);
        });
    },
    
    // Share transaction
    shareTransaction: function(transaction) {
        const shareText = `${this.getTransactionTitle(transaction)}: ZMW ${transaction.amount.toFixed(2)}`;
        
        if (navigator.share) {
            navigator.share({
                title: 'Transaction Details',
                text: shareText,
                url: window.location.href
            }).catch(console.error);
        } else {
            // Fallback to clipboard
            navigator.clipboard.writeText(shareText)
                .then(() => {
                    EnhancedUIUpdater.showToast('Transaction details copied to clipboard', 'success');
                })
                .catch(console.error);
        }
    },
    
    // Export transactions as PDF
    exportTransactions: function() {
        EnhancedUIUpdater.showLoading('Generating PDF...');
        
        // In a real implementation, you would generate a PDF using jsPDF
        // For now, we'll create a simple text export
        
        setTimeout(() => {
            let exportText = `Jubel Wallet Transactions\n`;
            exportText += `Generated: ${new Date().toLocaleString()}\n`;
            exportText += `Total Balance: ZMW ${AppState.walletBalance.toFixed(2)}\n`;
            exportText += `Total Transactions: ${AppState.walletTransactions.length}\n\n`;
            
            exportText += `Transaction History:\n`;
            exportText += `====================\n\n`;
            
            AppState.walletTransactions.forEach((transaction, index) => {
                const date = new Date(transaction.timestamp);
                exportText += `${index + 1}. ${this.getTransactionTitle(transaction)}\n`;
                exportText += `   Date: ${date.toLocaleDateString()} ${date.toLocaleTimeString()}\n`;
                exportText += `   Amount: ZMW ${transaction.amount.toFixed(2)}\n`;
                exportText += `   Type: ${transaction.type}\n`;
                exportText += `   Status: ${transaction.status}\n`;
                exportText += `   -------------------------\n`;
            });
            
            // Create download link
            const blob = new Blob([exportText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `jubel-transactions-${new Date().getTime()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Transactions exported successfully', 'success');
        }, 1000);
    }
};
        
// ============================================
// CITY DETECTOR
// ============================================
// ============================================
// ENHANCED CITY DETECTION WITH FALLBACK
// ============================================
const EnhancedCityDetector = {
    // Enhanced city database with more Zambian cities
    zambianCities: {
        'Lusaka': { 
            lat: -15.4167, 
            lng: 28.2833, 
            bounds: [27.8, -15.8, 28.8, -15.2],
            searchTerms: ['Lusaka']
        },
        'Ndola': { 
            lat: -12.9667, 
            lng: 28.6333, 
            bounds: [28.5, -13.1, 28.8, -12.9],
            searchTerms: ['Ndola']
        },
        'Kitwe': { 
            lat: -12.8167, 
            lng: 28.2000, 
            bounds: [27.9, -13.1, 28.4, -12.7],
            searchTerms: ['Kitwe']
        },
        'Kabwe': { 
            lat: -14.4333, 
            lng: 28.4500, 
            bounds: [28.3, -14.6, 28.6, -14.3],
            searchTerms: ['Kabwe']
        },
        'Livingstone': { 
            lat: -17.8500, 
            lng: 25.8667, 
            bounds: [25.7, -18.0, 26.0, -17.7],
            searchTerms: ['Livingstone']
        },
        'Chipata': { 
            lat: -13.6333, 
            lng: 32.6500, 
            bounds: [32.5, -13.8, 32.8, -13.6],
            searchTerms: ['Chipata']
        },
        'Chingola': { 
            lat: -12.5333, 
            lng: 27.8500, 
            bounds: [27.8, -12.8, 27.9, -12.4],
            searchTerms: ['Chingola']
        },
        'Mufulira': { 
            lat: -12.5500, 
            lng: 28.2333, 
            bounds: [28.1, -12.7, 28.3, -12.5],
            searchTerms: ['Mufulira']
        },
        'Luanshya': { 
            lat: -13.1333, 
            lng: 28.4000, 
            bounds: [28.3, -13.2, 28.5, -13.0],
            searchTerms: ['Luanshya']
        },
        'Kasama': { 
            lat: -10.2000, 
            lng: 31.2000, 
            bounds: [31.1, -10.3, 31.3, -10.1],
            searchTerms: ['Kasama']
        },
        'Solwezi': { 
            lat: -12.1833, 
            lng: 26.4000, 
            bounds: [26.3, -12.3, 26.5, -12.1],
            searchTerms: ['Solwezi']
        },
        'Mazabuka': { 
            lat: -15.8667, 
            lng: 27.7667, 
            bounds: [27.7, -15.9, 27.9, -15.7],
            searchTerms: ['Mazabuka']
        },
        'Choma': { 
            lat: -16.8167, 
            lng: 26.9833, 
            bounds: [26.8, -16.9, 27.1, -16.7],
            searchTerms: ['Choma']
        },
        'Mongu': { 
            lat: -15.2500, 
            lng: 23.1333, 
            bounds: [23.0, -15.3, 23.3, -15.2],
            searchTerms: ['Mongu']
        },
        'Kafue': { 
            lat: -15.7667, 
            lng: 28.1833, 
            bounds: [28.1, -15.8, 28.3, -15.7],
            searchTerms: ['Kafue']
        },
        'Monze': { 
            lat: -16.2833, 
            lng: 27.4833, 
            bounds: [27.4, -16.3, 27.5, -16.2],
            searchTerms: ['Monze']
        },
        'Mumbwa': { 
            lat: -14.9833, 
            lng: 27.0667, 
            bounds: [27.0, -15.0, 27.1, -14.9],
            searchTerms: ['Mumbwa']
        },
        'Kapiri Mposhi': { 
            lat: -13.9667, 
            lng: 28.6833, 
            bounds: [28.6, -14.0, 28.7, -13.9],
            searchTerms: ['Kapiri Mposhi', 'Kapiri']
        },
        'Mpika': { 
            lat: -11.8333, 
            lng: 31.4500, 
            bounds: [31.4, -11.9, 31.5, -11.8],
            searchTerms: ['Mpika']
        },
        'Nchelenge': { 
            lat: -9.3500, 
            lng: 28.7333, 
            bounds: [28.7, -9.4, 28.8, -9.3],
            searchTerms: ['Nchelenge']
        }
    },

    async detectCityFromCoordinates(lat, lng) {
        console.log(` Starting city detection for coordinates: ${lat}, ${lng}`);
        
        try {
            // Step 1: Try high-accuracy reverse geocoding
            const city = await this.reverseGeocodeWithFallback(lat, lng);
            
            if (city) {
                console.log(` City detected via reverse geocoding: ${city}`);
                return city;
            }
            
            // Step 2: Try coordinate-based detection with improved accuracy
            const proximityCity = this.detectCityByProximityWithGPS(lat, lng);
            if (proximityCity) {
                console.log(` City detected via GPS proximity: ${proximityCity}`);
                return proximityCity;
            }
            
            // Step 3: Show manual city selection - NO AUTOMATIC FALLBACK
            console.log(' Could not automatically detect city. Showing manual selection.');
            this.showManualCitySelection(lat, lng);
            return null;
            
        } catch (error) {
            console.error('Error in city detection:', error);
            this.showManualCitySelection(lat, lng);
            return null;
        }
    },

    async reverseGeocodeWithFallback(lat, lng) {
        const endpoints = [
            // Primary: Nominatim OSM
            `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&addressdetails=1&countrycodes=zm&zoom=18`,
            
            // Secondary: LocationIQ (backup)
            `https://us1.locationiq.com/v1/reverse.php?key=pk.YOUR_LOCATIONIQ_KEY&lat=${lat}&lon=${lng}&format=json&addressdetails=1`,
            
            // Tertiary: BigDataCloud (free tier)
            `https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lng}&localityLanguage=en`
        ];

        for (let i = 0; i < endpoints.length; i++) {
            try {
                console.log(`Trying geocoding endpoint ${i + 1}...`);
                const response = await fetch(endpoints[i], {
                    headers: {
                        'User-Agent': 'JubelRideApp/2.0',
                        'Accept': 'application/json'
                    },
                    timeout: 5000
                });

                if (response.ok) {
                    const data = await response.json();
                    const detectedCity = this.extractCityFromGeocodeResponse(data);
                    
                    if (detectedCity && this.isValidZambianCity(detectedCity)) {
                        console.log(` Found city via endpoint ${i + 1}: ${detectedCity}`);
                        return detectedCity;
                    }
                }
            } catch (error) {
                console.warn(`Endpoint ${i + 1} failed:`, error.message);
                continue;
            }
        }
        
        return null;
    },

    extractCityFromGeocodeResponse(data) {
        // Extract city from various API response formats
        const address = data.address || data;
        
        // Try different address fields in order of specificity
        const cityFields = [
            'city',
            'town',
            'village',
            'municipality',
            'county',
            'suburb',
            'region',
            'state',
            'locality'
        ];
        
        for (const field of cityFields) {
            if (address[field]) {
                return this.normalizeCityName(address[field]);
            }
        }
        
        // Try display_name field for OSM
        if (data.display_name) {
            const parts = data.display_name.split(',');
            for (let i = 0; i < Math.min(3, parts.length); i++) {
                const potentialCity = parts[i].trim();
                if (this.isValidZambianCity(potentialCity)) {
                    return this.normalizeCityName(potentialCity);
                }
            }
        }
        
        return null;
    },

    detectCityByProximityWithGPS(lat, lng) {
        let closestCity = null;
        let minDistance = Infinity;
        
        for (const [cityName, cityData] of Object.entries(this.zambianCities)) {
            // Check if within city bounds first
            if (this.isWithinCityBounds(lat, lng, cityData.bounds)) {
                console.log(` Within ${cityName} bounds`);
                return cityName;
            }
            
            // Calculate distance to city center
            const distance = this.calculateDistance(lat, lng, cityData.lat, cityData.lng);
            
            // Dynamic thresholds based on city size
            const threshold = cityName === 'Lusaka' ? 60 : // Larger for capital
                              cityName === 'Ndola' || cityName === 'Kitwe' ? 40 : // Major cities
                              25; // Smaller towns
            
            if (distance < minDistance && distance <= threshold) {
                minDistance = distance;
                closestCity = cityName;
            }
        }
        
        if (closestCity) {
            console.log(` Closest city: ${closestCity} (${minDistance.toFixed(1)} km)`);
            return closestCity;
        }
        
        return null;
    },

    isWithinCityBounds(lat, lng, bounds) {
        if (!bounds) return false;
        const [west, south, east, north] = bounds;
        return lng >= west && lng <= east && lat >= south && lat <= north;
    },

    isValidZambianCity(cityName) {
        if (!cityName) return false;
        
        const normalizedInput = this.normalizeCityName(cityName).toLowerCase();
        
        // Check exact matches
        for (const [knownCity, cityData] of Object.entries(this.zambianCities)) {
            const normalizedKnown = this.normalizeCityName(knownCity).toLowerCase();
            
            // Exact match
            if (normalizedInput === normalizedKnown) {
                return true;
            }
            
            // Partial match
            if (normalizedInput.includes(normalizedKnown) || normalizedKnown.includes(normalizedInput)) {
                return true;
            }
            
            // Check search terms
            if (cityData.searchTerms) {
                for (const term of cityData.searchTerms) {
                    if (normalizedInput.includes(term.toLowerCase())) {
                        return true;
                    }
                }
            }
        }
        
        return false;
    },

    normalizeCityName(cityName) {
        if (!cityName) return '';
        return cityName
            .replace(/ City$/i, '')
            .replace(/ Town$/i, '')
            .replace(/ Municipality$/i, '')
            .replace(/ District$/i, '')
            .trim();
    },

    async getPreciseUserLocation(lat, lng) {
        console.log(` Getting precise location details for: ${lat}, ${lng}`);
        
        try {
            const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&addressdetails=1&zoom=18&extratags=1`;
            
            const response = await fetch(url, {
                headers: {
                    'User-Agent': 'JubelRideApp/2.0',
                    'Accept': 'application/json'
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                const address = data.address || {};
                
                // Build detailed address with all available components
                const addressComponents = [];
                
                // House/Building level
                if (address.house_number || address.housenumber) {
                    addressComponents.push(`#${address.house_number || address.housenumber}`);
                }
                
                if (address.building) {
                    addressComponents.push(address.building);
                } else if (data.extratags?.building) {
                    addressComponents.push(data.extratags.building);
                }
                
                // Road/Street
                if (address.road) {
                    addressComponents.push(address.road);
                }
                
                // Suburb/Neighborhood
                if (address.suburb || address.neighbourhood) {
                    addressComponents.push(address.suburb || address.neighbourhood);
                }
                
                // Area/Quarter
                if (address.quarter) {
                    addressComponents.push(address.quarter);
                }
                
                // City/Town
                if (address.city || address.town) {
                    addressComponents.push(address.city || address.town);
                }
                
                // Province
                if (address.state) {
                    addressComponents.push(address.state);
                }
                
                // Build formatted address strings
                const shortAddress = this.buildShortAddress(address);
                const detailedAddress = addressComponents.join(', ');
                const fullAddress = data.display_name || detailedAddress;
                
                return {
                    address: shortAddress,
                    detailedAddress: detailedAddress,
                    fullAddress: fullAddress,
                    city: address.city || address.town || address.municipality,
                    road: address.road,
                    suburb: address.suburb || address.neighbourhood,
                    houseNumber: address.house_number || address.housenumber,
                    building: address.building,
                    latitude: lat,
                    longitude: lng,
                    rawAddress: address,
                    geocodeData: data
                };
            }
        } catch (error) {
            console.error('Error getting precise location:', error);
        }
        
        // Fallback to coordinates if geocoding fails
        return {
            address: 'Current Location',
            detailedAddress: `Near coordinates: ${lat.toFixed(6)}, ${lng.toFixed(6)}`,
            fullAddress: `Current Location (${lat.toFixed(6)}, ${lng.toFixed(6)})`,
            city: 'Unknown',
            latitude: lat,
            longitude: lng
        };
    },

    buildShortAddress(address) {
        const parts = [];
        
        // Building/House level
        if (address.house_number || address.housenumber) {
            parts.push(`#${address.house_number || address.housenumber}`);
        }
        
        if (address.building) {
            parts.push(address.building);
        }
        
        // Road
        if (address.road) {
            parts.push(address.road);
        }
        
        // Suburb/Area
        if (address.suburb || address.neighbourhood) {
            parts.push(address.suburb || address.neighbourhood);
        }
        
        // Keep it concise (max 3 parts)
        return parts.slice(0, 3).join(', ');
    },

    showManualCitySelection(lat, lng) {
        console.log(' Showing manual city selection');
        
        // Create modal for manual city selection
        const modal = document.createElement('div');
        modal.className = 'manual-city-selection-modal';
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10001;
            padding: 20px;
        `;
        
        // Sort cities by proximity to current coordinates
        const sortedCities = Object.keys(this.zambianCities)
            .map(city => ({
                name: city,
                distance: this.calculateDistance(lat, lng, this.zambianCities[city].lat, this.zambianCities[city].lng)
            }))
            .sort((a, b) => a.distance - b.distance);
        
        let html = `
            <div style="
                background: white;
                border-radius: 12px;
                width: 100%;
                max-width: 400px;
                max-height: 80vh;
                overflow: hidden;
            ">
                <div style="
                    padding: 20px;
                    background: linear-gradient(135deg, #FF6B35 0%, #FF8B35 100%);
                    color: white;
                ">
                    <h3 style="margin: 0; font-size: 18px;">
                        <i class="fas fa-map-marker-alt"></i> Select Your City
                    </h3>
                    <p style="margin: 10px 0 0 0; font-size: 14px; opacity: 0.9;">
                        We need to know your city to provide accurate ride services
                    </p>
                </div>
                
                <div style="padding: 20px;">
                    <div style="margin-bottom: 15px;">
                        <div style="
                            background: #FFF3E0;
                            border-left: 4px solid #FF9800;
                            padding: 12px;
                            border-radius: 4px;
                            font-size: 14px;
                            color: #333;
                        ">
                            <i class="fas fa-info-circle" style="color: #FF9800;"></i>
                            <strong>Your approximate location:</strong><br>
                            Latitude: ${lat.toFixed(6)}, Longitude: ${lng.toFixed(6)}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <input type="text" 
                               id="citySearchInput" 
                               placeholder="Search for your city..."
                               style="
                                   width: 100%;
                                   padding: 12px;
                                   border: 2px solid #e0e0e0;
                                   border-radius: 8px;
                                   font-size: 14px;
                                   box-sizing: border-box;
                               "
                               autocomplete="off">
                    </div>
                    
                    <div id="cityList" style="
                        max-height: 300px;
                        overflow-y: auto;
                        border: 1px solid #e0e0e0;
                        border-radius: 8px;
                    ">
        `;
        
        sortedCities.forEach((city, index) => {
            const distanceText = city.distance < 1 ? 
                `${(city.distance * 1000).toFixed(0)} m away` : 
                `${city.distance.toFixed(1)} km away`;
            
            const isNearby = index < 3;
            
            html += `
                <div class="city-item" 
                     data-city="${city.name}"
                     style="
                         padding: 15px;
                         border-bottom: 1px solid #eee;
                         cursor: pointer;
                         transition: all 0.2s;
                         background: ${isNearby ? '#f9f9f9' : 'white'};
                     "
                     onmouseover="this.style.background='#f0f7ff'"
                     onmouseout="this.style.background='${isNearby ? '#f9f9f9' : 'white'}'">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 600; color: #333; margin-bottom: 4px;">
                                ${city.name}
                                ${isNearby ? '<span style="color: #FF6B35; font-size: 12px; margin-left: 8px;">NEARBY</span>' : ''}
                            </div>
                            <div style="font-size: 12px; color: #666;">
                                ${distanceText}
                            </div>
                        </div>
                        <div style="color: #FF6B35; font-size: 18px;">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += `
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <button id="retryAutoDetectBtn"
                                style="
                                    padding: 12px 20px;
                                    background: #f5f5f5;
                                    color: #666;
                                    border: none;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    font-weight: 600;
                                    width: 100%;
                                    margin-bottom: 10px;
                                ">
                            <i class="fas fa-sync-alt"></i> Retry Auto-Detection
                        </button>
                        <div style="font-size: 12px; color: #999; margin-top: 10px;">
                            Can't find your city? Contact support for assistance.
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        modal.innerHTML = html;
        document.body.appendChild(modal);
        
        // Add event listeners
        const citySearchInput = modal.querySelector('#citySearchInput');
        const cityList = modal.querySelector('#cityList');
        const retryBtn = modal.querySelector('#retryAutoDetectBtn');
        
        // City search functionality
        citySearchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            const cityItems = cityList.querySelectorAll('.city-item');
            
            cityItems.forEach(item => {
                const cityName = item.dataset.city.toLowerCase();
                if (cityName.includes(searchTerm) || !searchTerm) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        });
        
        // City selection
        modal.querySelectorAll('.city-item').forEach(item => {
            item.addEventListener('click', function() {
                const selectedCity = this.dataset.city;
                console.log(` User manually selected city: ${selectedCity}`);
                
                // Store city in AppState
                AppState.currentCity = selectedCity;
                AppState.detectedCity = selectedCity;
                
                // Update UI
                EnhancedUIUpdater.updateCityDisplay(selectedCity);
                
                // Use city center coordinates for map
                const cityData = this.zambianCities[selectedCity];
                if (cityData && map) {
                    map.setView([cityData.lat, cityData.lng], 13);
                    
                    // Update user location to city center if we don't have precise location
                    if (!AppState.userLocation) {
                        AppState.userLocation = { lat: cityData.lat, lng: cityData.lng };
                    }
                }
                
                // Remove modal
                document.body.removeChild(modal);
                
                // Show success message
                EnhancedUIUpdater.showToast(`City set to ${selectedCity}`, 'success');
                
                // Force location update with new city context
                setTimeout(() => {
                    if (AppState.userLocation) {
                        EnhancedCityDetector.updateAllPickupLocations({
                            latitude: AppState.userLocation.lat,
                            longitude: AppState.userLocation.lng,
                            address: 'Current Location',
                            detailedAddress: selectedCity,
                            fullAddress: selectedCity,
                            city: selectedCity
                        });
                    }
                }, 500);
            });
        });
        
        // Retry auto-detection
        retryBtn.addEventListener('click', async function() {
            EnhancedUIUpdater.showLoading('Detecting your location...');
            
            try {
                // Get fresh location
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    });
                });
                
                const { latitude, longitude } = position.coords;
                
                // Try detection again
                const city = await EnhancedCityDetector.detectCityFromCoordinates(latitude, longitude);
                
                if (city) {
                    // Success! Remove modal
                    document.body.removeChild(modal);
                    EnhancedUIUpdater.hideLoading();
                    
                    // Update everything
                    AppState.userLocation = { lat: latitude, lng: longitude };
                    await EnhancedCityDetector.updateCityAndAddress(latitude, longitude);
                    
                } else {
                    EnhancedUIUpdater.hideLoading();
                    EnhancedUIUpdater.showToast('Still unable to detect city. Please select manually.', 'warning');
                }
                
            } catch (error) {
                EnhancedUIUpdater.hideLoading();
                EnhancedUIUpdater.showToast('Error getting location. Please select city manually.', 'error');
            }
        });
        
        // Focus search input
        setTimeout(() => {
            citySearchInput.focus();
        }, 300);
    },

    calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = this.toRad(lat2 - lat1);
        const dLon = this.toRad(lon2 - lon1);
        const a = 
            Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(this.toRad(lat1)) * Math.cos(this.toRad(lat2)) * 
            Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    },

    toRad(value) {
        return value * Math.PI / 180;
    },

    async updateCityAndAddress(lat, lng) {
        try {
            console.log(` Updating city and address for: ${lat}, ${lng}`);
            
            // Step 1: Detect city
            const detectedCity = await this.detectCityFromCoordinates(lat, lng);
            
            if (!detectedCity) {
                // Manual selection was shown, wait for user input
                console.log(' Waiting for manual city selection...');
                return null;
            }
            
            AppState.currentCity = detectedCity;
            AppState.detectedCity = detectedCity;
            
            // Update city display immediately
            EnhancedUIUpdater.updateCityDisplay(detectedCity);
            
            // Step 2: Get precise location details
            const addressDetails = await this.getPreciseUserLocation(lat, lng);
            
            // Step 3: Update all pickup locations with precise address
            this.updateAllPickupLocations(addressDetails);
            
            // Step 4: Center map on user location
            if (map) {
                map.setView([lat, lng], 17); // Zoom to street level
                
                // Add/update user location marker
                if (currentLocationMarker) {
                    map.removeLayer(currentLocationMarker);
                }
                
                currentLocationMarker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        className: 'precise-location-marker',
                        html: `
                            <div class="pulsing-dot"></div>
                            <div class="location-pin">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                        `,
                        iconSize: [40, 40],
                        iconAnchor: [20, 40]
                    })
                }).addTo(map).bindPopup(`
                    <strong>Your Current Location</strong><br>
                    ${addressDetails.address}<br>
                    <small>${detectedCity}</small>
                `);
                
                // Show city boundary if available
                const cityData = this.zambianCities[detectedCity];
                if (cityData && cityData.bounds) {
                    this.showCityBoundaryOnMap(detectedCity);
                }
            }
            
            console.log(` Location update complete: ${detectedCity}, ${addressDetails.address}`);
            EnhancedUIUpdater.showToast(`Location detected: ${addressDetails.address}`, 'success');
            
            return { 
                city: detectedCity, 
                address: addressDetails,
                coordinates: { lat, lng }
            };
            
        } catch (error) {
            console.error('Error updating city and address:', error);
            EnhancedUIUpdater.showToast('Error updating location', 'error');
            return null;
        }
    },

    showCityBoundaryOnMap(cityName) {
        // Remove existing boundary if any
        if (cityBoundaryLayer) {
            map.removeLayer(cityBoundaryLayer);
        }
        
        const cityData = this.zambianCities[cityName];
        if (cityData && cityData.bounds) {
            const [west, south, east, north] = cityData.bounds;
            const bounds = [[south, west], [north, east]];
            
            cityBoundaryLayer = L.rectangle(bounds, {
                color: '#FF6B35',
                weight: 2,
                opacity: 0.5,
                fillOpacity: 0.1,
                fillColor: '#FF6B35'
            }).addTo(map);
            
            cityBoundaryLayer.bindPopup(`<strong>${cityName}</strong><br>Service Area`);
        }
    },

    updateAllPickupLocations(addressDetails) {
        console.log(' Updating all pickup locations with:', addressDetails);
        
        // Update all pickup input fields
        const pickupInputs = [
            'pickupLocation',
            'deliveryPickup',
            'shortDeliveryPickup',
            'truckPickup',
            'emergencyPickup',
            'schedulePickup',
            'someonePickup',
            'sharePickup',
            'broadcastPickup'
        ];
        
        pickupInputs.forEach(inputId => {
            const input = document.getElementById(inputId);
            if (input) {
                // Set the value to detailed address
                input.value = addressDetails.detailedAddress;
                
                // Store coordinates and address details in data attributes
                input.dataset.lat = addressDetails.latitude;
                input.dataset.lng = addressDetails.longitude;
                input.dataset.address = JSON.stringify(addressDetails);
                input.dataset.city = addressDetails.city;
                
                // Make input editable by removing readonly attribute
                input.removeAttribute('readonly');
                
                // Add clear button if not present
                if (!input.nextElementSibling?.classList.contains('clear-input-btn')) {
                    this.addClearButtonToInput(input);
                }
                
                // Add current location button if not present
                if (!input.parentNode.querySelector('.current-location-btn')) {
                    this.addCurrentLocationButton(input);
                }
            }
        });
        
        // Update AppState
        AppState.pickup = {
            lat: addressDetails.latitude,
            lng: addressDetails.longitude,
            address: addressDetails.address,
            detailedAddress: addressDetails.detailedAddress,
            fullAddress: addressDetails.fullAddress,
            city: addressDetails.city,
            road: addressDetails.road,
            suburb: addressDetails.suburb,
            houseNumber: addressDetails.houseNumber,
            building: addressDetails.building,
            rawData: addressDetails
        };
        
        console.log(' AppState.pickup updated:', AppState.pickup);
        
        // Update pickup marker on map
        if (map) {
            EnhancedUIUpdater.updatePickupMarker(AppState.pickup);
        }
        
        // Add to recent locations
        EnhancedSearchEngine.addToRecentLocations({
            lat: addressDetails.latitude,
            lng: addressDetails.longitude,
            name: 'Current Location',
            address: addressDetails.detailedAddress,
            fullAddress: addressDetails.fullAddress,
            city: addressDetails.city,
            category: 'current_location'
        });
    },

    addClearButtonToInput(input) {
        const parent = input.parentNode;
        const clearBtn = document.createElement('button');
        clearBtn.type = 'button';
        clearBtn.className = 'clear-input-btn';
        clearBtn.innerHTML = '<i class="fas fa-times"></i>';
        clearBtn.title = 'Clear location';
        clearBtn.style.cssText = `
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            display: none;
            z-index: 10;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        `;
        
        clearBtn.addEventListener('mouseover', () => {
            clearBtn.style.background = '#f5f5f5';
            clearBtn.style.color = '#333';
        });
        
        clearBtn.addEventListener('mouseout', () => {
            clearBtn.style.background = 'none';
            clearBtn.style.color = '#999';
        });
        
        clearBtn.addEventListener('click', () => {
            input.value = '';
            clearBtn.style.display = 'none';
            
            // Clear pickup location in state if this is the main pickup input
            if (input.id === 'pickupLocation' || input.id.includes('pickup')) {
                AppState.pickup = null;
                if (pickupMarker) {
                    map.removeLayer(pickupMarker);
                    pickupMarker = null;
                }
            }
            
            EnhancedUIUpdater.showToast('Location cleared', 'info');
        });
        
        parent.style.position = 'relative';
        parent.appendChild(clearBtn);
        
        // Show clear button when input has value
        input.addEventListener('input', () => {
            clearBtn.style.display = input.value ? 'flex' : 'none';
        });
        
        // Initial state
        clearBtn.style.display = input.value ? 'flex' : 'none';
    },

    addCurrentLocationButton(input) {
        const parent = input.parentNode;
        const currentLocationBtn = document.createElement('button');
        currentLocationBtn.type = 'button';
        currentLocationBtn.className = 'current-location-btn';
        currentLocationBtn.innerHTML = '<i class="fas fa-location-arrow"></i>';
        currentLocationBtn.title = 'Use current location';
        currentLocationBtn.style.cssText = `
            position: absolute;
            right: 45px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #FF6B35;
            cursor: pointer;
            z-index: 10;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        `;
        
        currentLocationBtn.addEventListener('mouseover', () => {
            currentLocationBtn.style.background = '#FFF3E0';
        });
        
        currentLocationBtn.addEventListener('mouseout', () => {
            currentLocationBtn.style.background = 'none';
        });
        
        currentLocationBtn.addEventListener('click', () => {
            EnhancedUIUpdater.showLoading('Getting your current location...');
            
            getCurrentLocation()
                .then(() => {
                    EnhancedUIUpdater.hideLoading();
                })
                .catch(error => {
                    EnhancedUIUpdater.hideLoading();
                    console.error('Error getting location:', error);
                });
        });
        
        parent.appendChild(currentLocationBtn);
    }
};

// ============================================
// INITIALIZE MAP
// ============================================
function initializeMap() {
    console.log('Initializing map...');
    
    // Default to Lusaka coordinates
    const defaultLat = -15.4167;
    const defaultLng = 28.2833;
    
    // Create map
    map = L.map('map').setView([defaultLat, defaultLng], 13);
    
    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: ' OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(map);
    
    // Add scale control
    L.control.scale().addTo(map);
    
    // Hide loading overlay
    EnhancedUIUpdater.hideMapLoading();
    
    console.log('Map initialized successfully');
    
    AppState.mapInitialized = true;
}

// ============================================
// GET CURRENT LOCATION
// ============================================
async function getCurrentLocation(showLoading = true) {
    if (!navigator.geolocation) {
        console.error('Geolocation is not supported by this browser');
        EnhancedUIUpdater.showToast('Geolocation is not supported by your browser', 'error');
        showManualCitySelection();
        return;
    }
    
    console.log(' Getting current location...');
    
    if (showLoading) {
        EnhancedUIUpdater.showLoading('Detecting your precise location and city...');
    }
    
    try {
        // Get high-accuracy location
        const position = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(
                resolve,
                reject,
                {
                    enableHighAccuracy: true,     // Use GPS if available
                    timeout: 15000,              // 15 second timeout
                    maximumAge: 0                // Don't use cached position
                }
            );
        });
        
        const { latitude, longitude, accuracy } = position.coords;
        console.log(` Location obtained: ${latitude}, ${longitude} (Accuracy: ${accuracy}m)`);
        
        // Update user location in AppState
        AppState.userLocation = { 
            lat: latitude, 
            lng: longitude,
            accuracy: accuracy,
            timestamp: Date.now()
        };
        
        // Use enhanced city detector with precise location
        const result = await EnhancedCityDetector.updateCityAndAddress(latitude, longitude);
        
        if (result) {
            if (showLoading) {
                EnhancedUIUpdater.hideLoading();
            }
            
            // Show notification with precise address
            const message = result.address ? 
                `Location set: ${result.address.address}` : 
                `Location detected in ${result.city}`;
            
            EnhancedUIUpdater.showToast(message, 'success');
            
            // Log success
            console.log(` Location detection successful: ${result.city}, ${result.address?.address}`);
            
            return result;
            
        } else {
            // City detection failed - manual selection was shown
            if (showLoading) {
                EnhancedUIUpdater.hideLoading();
            }
            console.warn(' City detection failed, manual selection shown');
            return null;
        }
        
    } catch (error) {
        console.error(' Error getting location:', error);
        
        if (showLoading) {
            EnhancedUIUpdater.hideLoading();
        }
        
        let errorMessage = 'Unable to get your location';
        
        switch(error.code) {
            case error.PERMISSION_DENIED:
                errorMessage = 'Location access denied. Please enable location services in your browser settings.';
                EnhancedUIUpdater.showToast(errorMessage, 'error');
                
                // Show instructions for enabling location
                showLocationPermissionInstructions();
                break;
                
            case error.POSITION_UNAVAILABLE:
                errorMessage = 'Location information is unavailable.';
                EnhancedUIUpdater.showToast(errorMessage, 'warning');
                showManualCitySelection();
                break;
                
            case error.TIMEOUT:
                errorMessage = 'Location request timed out. Please try again.';
                EnhancedUIUpdater.showToast(errorMessage, 'warning');
                
                // Retry with lower accuracy
                setTimeout(() => {
                    EnhancedUIUpdater.showToast('Retrying with standard accuracy...', 'info');
                    getCurrentLocationWithStandardAccuracy();
                }, 2000);
                break;
                
            default:
                EnhancedUIUpdater.showToast(errorMessage, 'error');
                showManualCitySelection();
                break;
        }
        
        return null;
    }
}

// Helper function for standard accuracy fallback
async function getCurrentLocationWithStandardAccuracy() {
    try {
        const position = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(
                resolve,
                reject,
                {
                    enableHighAccuracy: false,    // Standard accuracy
                    timeout: 10000,              // 10 second timeout
                    maximumAge: 60000            // Accept positions up to 1 minute old
                }
            );
        });
        
        const { latitude, longitude } = position.coords;
        console.log(` Standard accuracy location: ${latitude}, ${longitude}`);
        
        AppState.userLocation = { lat: latitude, lng: longitude };
        return await EnhancedCityDetector.updateCityAndAddress(latitude, longitude);
        
    } catch (error) {
        console.error('Standard accuracy also failed:', error);
        showManualCitySelection();
        return null;
    }
}

function showLocationPermissionInstructions() {
    const modal = document.createElement('div');
    modal.className = 'location-permission-modal';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.9);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10002;
        padding: 20px;
    `;
    
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    
    let instructions = '';
    if (isMobile) {
        instructions = `
            <h4 style="color: #333; margin-bottom: 15px;">Enable Location on Mobile:</h4>
            <ol style="text-align: left; padding-left: 20px; color: #666;">
                <li>Open your device <strong>Settings</strong></li>
                <li>Go to <strong>Privacy/Location Services</strong></li>
                <li>Find <strong>Browser/Chrome/Safari</strong></li>
                <li>Set to <strong>"While Using the App"</strong></li>
                <li>Return here and refresh the page</li>
            </ol>
        `;
    } else {
        instructions = `
            <h4 style="color: #333; margin-bottom: 15px;">Enable Location in Browser:</h4>
            <ol style="text-align: left; padding-left: 20px; color: #666;">
                <li>Look for the location icon in your browser's address bar</li>
                <li>Click it and select <strong>"Allow"</strong></li>
                <li>Refresh this page if needed</li>
                <li>If blocked, clear browser settings for this site</li>
            </ol>
        `;
    }
    
    modal.innerHTML = `
        <div style="
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            overflow: hidden;
        ">
            <div style="
                padding: 25px;
                background: linear-gradient(135deg, #FF6B35 0%, #FF8B35 100%);
                color: white;
                text-align: center;
            ">
                <div style="font-size: 48px; margin-bottom: 15px;">
                    <i class="fas fa-map-marker-alt"></i>
                </div>
                <h3 style="margin: 0; font-size: 20px;">
                    Location Required
                </h3>
                <p style="margin: 10px 0 0 0; font-size: 14px; opacity: 0.9;">
                    Jubel needs your location to provide ride services
                </p>
            </div>
            
            <div style="padding: 25px;">
                ${instructions}
                
                <div style="margin-top: 25px;">
                    <button id="retryLocationBtn"
                            style="
                                padding: 14px 25px;
                                background: #FF6B35;
                                color: white;
                                border: none;
                                border-radius: 8px;
                                cursor: pointer;
                                font-weight: 600;
                                font-size: 16px;
                                width: 100%;
                                margin-bottom: 15px;
                            ">
                        <i class="fas fa-sync-alt"></i> Retry Location Access
                    </button>
                    
                    <button id="useManualCityBtn"
                            style="
                                padding: 14px 25px;
                                background: #f5f5f5;
                                color: #666;
                                border: none;
                                border-radius: 8px;
                                cursor: pointer;
                                font-weight: 600;
                                width: 100%;
                            ">
                        <i class="fas fa-map"></i> Select City Manually
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Retry button
    modal.querySelector('#retryLocationBtn').addEventListener('click', () => {
        document.body.removeChild(modal);
        getCurrentLocation();
    });
    
    // Manual city button
    modal.querySelector('#useManualCityBtn').addEventListener('click', () => {
        document.body.removeChild(modal);
        EnhancedCityDetector.showManualCitySelection();
    });
}

function setupEnhancedLocationInputs() {
    console.log(' Setting up enhanced location inputs...');
    
    // Make all pickup inputs editable and add features
    const pickupInputs = document.querySelectorAll('input[id*="pickup"], input[id*="Pickup"]');
    
    pickupInputs.forEach(input => {
        // Remove readonly attribute
        input.removeAttribute('readonly');
        
        // Add placeholder if empty
        if (!input.placeholder) {
            input.placeholder = 'Enter pickup location or use current location';
        }
        
        // Add event listener for focus to show suggestions
        input.addEventListener('focus', function() {
            this.parentElement.classList.add('active');
            
            // If empty, show recent locations
            if (!this.value.trim()) {
                EnhancedLocationManager.showRecentLocations(this.id, 'pickup');
            }
        });
        
        input.addEventListener('blur', function() {
            setTimeout(() => {
                this.parentElement.classList.remove('active');
                EnhancedLocationManager.hideSuggestions();
            }, 200);
        });
        
        // Add input event for search suggestions
        input.addEventListener('input', function(e) {
            EnhancedLocationManager.handlePickupInputChange(this.id, e.target.value);
        });
        
        // Add clear button
        if (!input.nextElementSibling?.classList.contains('clear-input-btn')) {
            EnhancedCityDetector.addClearButtonToInput(input);
        }
        
        // Add current location button
        if (!input.parentNode.querySelector('.current-location-btn')) {
            EnhancedCityDetector.addCurrentLocationButton(input);
        }
    });
    
    // Setup destination inputs
    const destinationInputs = document.querySelectorAll('input[id*="destination"], input[id*="Destination"]');
    
    destinationInputs.forEach(input => {
        // Add event listeners for destination search
        input.addEventListener('focus', function() {
            this.parentElement.classList.add('active');
            
            // Show recent destinations
            EnhancedLocationManager.showRecentLocations(this.id, 'destination');
        });
        
        input.addEventListener('blur', function() {
            setTimeout(() => {
                this.parentElement.classList.remove('active');
                EnhancedLocationManager.hideSuggestions();
            }, 200);
        });
        
        input.addEventListener('input', function(e) {
            EnhancedLocationManager.handleDestinationInputChange(this.id, e.target.value);
        });
        
        // Add clear button for destination
        if (!input.nextElementSibling?.classList.contains('clear-input-btn')) {
            EnhancedCityDetector.addClearButtonToInput(input);
        }
    });
    
    console.log(` Enhanced ${pickupInputs.length} pickup inputs and ${destinationInputs.length} destination inputs`);
}

// ============================================
// SWITCH SCREEN
// ============================================
function switchScreen(screen) {
    console.log(`Switching to screen: ${screen}`);
    
    // Hide all screens
    document.querySelectorAll('.history-screen, .account-screen, .emergency-screen').forEach(s => {
        s.style.display = 'none';
    });
    
    // Hide home content initially
    const homeContent = document.getElementById('homeContent');
    if (homeContent) {
        homeContent.style.display = 'none';
    }
    
    // Update active tab
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Set active screen
    AppState.activeScreen = screen;
    
    // Show selected screen
    switch(screen) {
        case 'home':
            const homeTab = document.querySelector('.nav-tab[data-screen="home"]');
            if (homeTab) homeTab.classList.add('active');
            
            if (homeContent) {
                homeContent.style.display = 'block';
            }
            break;
            
        case 'history':
            const historyScreen = document.getElementById('historyScreen');
            const historyTab = document.querySelector('.nav-tab[data-screen="history"]');
            
            if (historyScreen && historyTab) {
                historyScreen.style.display = 'block';
                historyTab.classList.add('active');
                
                // Load ride history
                EnhancedFirebaseManager.loadRideHistory(AppState.currentUser.uid);
            }
            break;
            
        case 'account':
            const accountScreen = document.getElementById('accountScreen');
            const accountTab = document.querySelector('.nav-tab[data-screen="account"]');
            
            if (accountScreen && accountTab) {
                accountScreen.style.display = 'block';
                accountTab.classList.add('active');
            }
            break;
            
        case 'emergency':
            const emergencyScreen = document.getElementById('emergencyScreen');
            const emergencyTab = document.querySelector('.nav-tab[data-screen="emergency"]');
            
            if (emergencyScreen && emergencyTab) {
                emergencyScreen.style.display = 'block';
                emergencyTab.classList.add('active');
            }
            break;
    }
}

// Add this function to update prices when switching services
function updateServicePricesOnSwitch(service) {
    setTimeout(() => {
        switch(service) {
            case 'express':
            case 'shopping':
                if (AppState.pickup && AppState.destination) {
                    updateShoppingServicePrice();
                }
                break;
            case 'delivery':
                if (AppState.pickup && AppState.destination) {
                    updateDeliveryServicePrice();
                }
                break;
            case 'short-delivery':
                if (AppState.pickup && AppState.destination) {
                    updateShortDeliveryServicePrice();
                }
                break;
            case 'truck':
                if (AppState.pickup && AppState.destination) {
                    updateTruckServicePrice();
                }
                break;
        }
    }, 100);
}
// ============================================
// SWITCH SERVICE
// ============================================
function switchService(service) {
    console.log(`Switching to service: ${service}`);
    
    // Hide all forms
    document.querySelectorAll('.ride-request-form, .service-form, #broadcastForm').forEach(form => {
        form.style.display = 'none';
    });
    
    // Update active service tab
    document.querySelectorAll('.service-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Set active service
    AppState.activeService = service;
    
    // Show selected service form
    switch(service) {
        case 'car':
            const carTab = document.querySelector('.service-tab.car');
            const carForm = document.getElementById('carForm');
            
            if (carTab) carTab.classList.add('active');
            if (carForm) carForm.style.display = 'block';
            break;
            
        case 'delivery':
            const deliveryTab = document.querySelector('.service-tab.delivery');
            const deliveryForm = document.getElementById('deliveryForm');
            
            if (deliveryTab) deliveryTab.classList.add('active');
            if (deliveryForm) deliveryForm.style.display = 'block';
            
            // Update delivery prices if locations are set
            updateServicePricesOnSwitch('delivery');
            break;
            
        case 'short-delivery':
            const shortDeliveryTab = document.querySelector('.service-tab.short-delivery');
            const shortDeliveryForm = document.getElementById('shortDeliveryForm');
            
            if (shortDeliveryTab) shortDeliveryTab.classList.add('active');
            if (shortDeliveryForm) shortDeliveryForm.style.display = 'block';
            
            // Update short delivery prices if locations are set
            updateServicePricesOnSwitch('short-delivery');
            break;
            
        case 'express':
            const expressTab = document.querySelector('.service-tab[data-service="express"]');
            const expressForm = document.getElementById('expressForm');
            
            if (expressTab) expressTab.classList.add('active');
            if (expressForm) expressForm.style.display = 'block';
            
            // Update shopping prices if locations are set
            updateServicePricesOnSwitch('express');
            break;
            
        case 'truck':
            const truckTab = document.querySelector('.service-tab[data-service="truck"]');
            const truckForm = document.getElementById('truckForm');
            
            if (truckTab) truckTab.classList.add('active');
            if (truckForm) truckForm.style.display = 'block';
            
            // Update truck prices if locations are set
            updateServicePricesOnSwitch('truck');
            break;
            
        case 'broadcast':
            const broadcastForm = document.getElementById('broadcastForm');
            if (broadcastForm) broadcastForm.style.display = 'block';
            break;
    }
}

// ============================================
// INITIALIZE APP
// ============================================
async function initializeApp() {
    console.log(' Initializing Jubel Passenger App...');
    
    try {
        // Show initial loading
        EnhancedUIUpdater.showLoading('Initializing app...');
        
        // Check authentication
        const urlParams = new URLSearchParams(window.location.search);
        const email = urlParams.get('email');
        const uid = urlParams.get('uid');
        
        let authPromise;
        
        if (email && uid) {
            console.log(' Authenticated via URL parameters');
            AppState.currentUser = { uid, email };
            authPromise = EnhancedFirebaseManager.loadUserData(uid);
        } else {
            console.log(' Checking Firebase auth state...');
            authPromise = new Promise((resolve, reject) => {
                auth.onAuthStateChanged(async (user) => {
                    try {
                        if (user) {
                            console.log(' User authenticated:', user.uid);
                            AppState.currentUser = user;
                            await EnhancedFirebaseManager.loadUserData(user.uid);
                            resolve();
                        } else {
                            console.log(' No user logged in');
                            window.location.href = 'signup.html';
                            reject(new Error('No user authenticated'));
                        }
                    } catch (error) {
                        reject(error);
                    }
                });
            });
        }
        
        // Wait for authentication
        await authPromise;
        
        // Initialize map
        initializeMap();
        
        // Setup enhanced location inputs BEFORE getting location
        setupEnhancedLocationInputs();
        
        // Initialize location manager
        EnhancedLocationManager.init();
        
        // Initialize search engine
        EnhancedSearchEngine.init();
        
        // Get current location - THIS IS CRITICAL
        console.log(' Getting initial location...');
        const locationResult = await getCurrentLocation();
        
        if (!locationResult) {
            console.warn(' Initial location detection failed or was deferred');
            // App will continue with manual city selection
        }
        // Set up periodic check for scheduled rides
if (!AppState.scheduledRideCheckInterval) {
    AppState.scheduledRideCheckInterval = setInterval(() => {
        this.checkAndProcessScheduledRides();
    }, 60000); // Check every minute
}
        // Setup event listeners
        setupEventListeners();
        
        // Initialize shopping items
        initializeShoppingItems();

        // Initialize wallet manager
EnhancedWalletManager.init();
        
        // Set up schedule inputs
        const scheduleDateInput = document.getElementById('scheduleDate');
        if (scheduleDateInput) {
            const today = new Date().toISOString().split('T')[0];
            scheduleDateInput.min = today;
            scheduleDateInput.value = today;
        }
        
        const scheduleTimeInput = document.getElementById('scheduleTime');
        if (scheduleTimeInput) {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = (now.getMinutes() + 10).toString().padStart(2, '0');
            scheduleTimeInput.value = `${hours}:${minutes}`;
        }
        
        // Set up periodic location updates (only if we have permission)
        if (AppState.userLocation && !AppState.locationUpdateInterval) {
            AppState.locationUpdateInterval = setInterval(() => {
                if (AppState.activeScreen === 'home' && !AppState.currentRide) {
                    getCurrentLocation(false).catch(error => 
                        console.warn('Periodic location update failed:', error)
                    );
                }
            }, 30000); // Update every 30 seconds
        }
        
        EnhancedUIUpdater.hideLoading();
        EnhancedUIUpdater.showToast('Jubel Passenger App Ready! ', 'success');
        
        console.log(' App initialization completed successfully');
        
    } catch (error) {
        console.error(' Error initializing app:', error);
        EnhancedUIUpdater.hideLoading();
        
        if (!error.message.includes('No user authenticated')) {
            EnhancedUIUpdater.showToast('Error initializing app. Please refresh.', 'error');
        }
    }
}

// ============================================
// INITIALIZE SHOPPING ITEMS
// ============================================
function initializeShoppingItems() {
    console.log('Initializing shopping items...');
    
    const itemsContainer = document.getElementById('shoppingItems');
    const addItemBtn = document.getElementById('addItemBtn');
    
    if (!itemsContainer || !addItemBtn) {
        console.warn('Shopping items elements not found');
        return;
    }
    
    // Add event listener to add item button
    addItemBtn.addEventListener('click', function() {
        const itemCount = itemsContainer.children.length + 1;
        
        const itemEntry = document.createElement('div');
        itemEntry.className = 'item-entry';
        itemEntry.innerHTML = `
            <input type="text" class="item-input" placeholder="Item ${itemCount}">
            <button class="remove-item" type="button">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        itemsContainer.appendChild(itemEntry);
        
        // Add event listener to remove button
        const removeBtn = itemEntry.querySelector('.remove-item');
        removeBtn.addEventListener('click', function() {
            if (itemsContainer.children.length > 1) {
                itemEntry.remove();
            }
        });
    });
    
    console.log('Shopping items initialized');
}

// In the initializeApp function, after setting up event listeners:
console.log('Setting up price calculation listeners...');

// Set up price calculation when destination is set in any service
const setupPriceCalculations = () => {
    // When pickup or destination changes, update all service prices
    const updateAllServicePrices = () => {
        if (AppState.pickup && AppState.destination) {
            updateShoppingServicePrice();
            updateDeliveryServicePrice();
            updateShortDeliveryServicePrice();
            updateTruckServicePrice();
            EnhancedUIUpdater.updateRidePrices(); // For car service
        }
    };
    
    // Listen to location changes
    const locationObserver = {
        updatePickup: (newPickup) => {
            if (newPickup && AppState.destination) {
                updateAllServicePrices();
            }
        },
        updateDestination: (newDestination) => {
            if (AppState.pickup && newDestination) {
                updateAllServicePrices();
            }
        }
    };
    
    // Store observer in AppState
    AppState.locationObserver = locationObserver;
};

setupPriceCalculations();
        
// ============================================
// SETUP EVENT LISTENERS
// ============================================
function setupEventListeners() {
    console.log('Setting up event listeners...');
    
    // Navigation tabs
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const screen = this.dataset.screen;
            switchScreen(screen);
        });
    });
    
    // Back buttons
    document.querySelectorAll('.back-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            switchScreen('home');
        });
    });
    
    // Panel handle
    const panelHandle = document.getElementById('panelHandle');
    if (panelHandle) {
        panelHandle.addEventListener('click', function() {
            const panel = document.getElementById('mainPanel');
            panel.classList.toggle('collapsed');
        });
    }
    
    // Service tabs
    document.querySelectorAll('.service-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const service = this.dataset.service;
            switchService(service);
        });
    });
    
    // Map controls
    const locateMeBtn = document.getElementById('locateMeBtn');
    if (locateMeBtn) {
        locateMeBtn.addEventListener('click', getCurrentLocation);
    }
    
    const zoomInBtn = document.getElementById('zoomInBtn');
    if (zoomInBtn) {
        zoomInBtn.addEventListener('click', function() {
            if (map) map.zoomIn();
        });
    }
    
    const zoomOutBtn = document.getElementById('zoomOutBtn');
    if (zoomOutBtn) {
        zoomOutBtn.addEventListener('click', function() {
            if (map) map.zoomOut();
        });
    }
    
    const clearRouteBtn = document.getElementById('clearRouteBtn');
    if (clearRouteBtn) {
        clearRouteBtn.addEventListener('click', function() {
            // Clear route layer
            if (routeLayer) {
                map.removeLayer(routeLayer);
                routeLayer = null;
            }
            
            // Clear destination marker
            if (destinationMarker) {
                map.removeLayer(destinationMarker);
                destinationMarker = null;
            }
            
            // Clear destination input
            const destinationInput = document.getElementById('destinationLocation');
            if (destinationInput) {
                destinationInput.value = '';
                AppState.destination = null;
            }
            
            EnhancedUIUpdater.showToast('Route cleared', 'info');
        });
    }
    
    // Ride type selection
    document.querySelectorAll('.ride-type-card').forEach(card => {
        card.addEventListener('click', function() {
            // Remove selected class from all cards
            document.querySelectorAll('.ride-type-card').forEach(c => {
                c.classList.remove('selected');
            });
            
            // Add selected class to clicked card
            this.classList.add('selected');
            
            // Update selected ride type
            const rideType = this.dataset.type;
            AppState.selectedRideType = rideType;
            
            // Update prices
            if (AppState.pickup && AppState.destination) {
                EnhancedUIUpdater.updateRidePrices();
            }
            
            EnhancedUIUpdater.showToast(`${rideType.charAt(0).toUpperCase() + rideType.slice(1)} selected`, 'info');
        });
    });
    
    // Add stop button
    const addStopBtn = document.getElementById('addStopBtn');
    if (addStopBtn) {
        addStopBtn.addEventListener('click', function() {
            EnhancedLocationManager.addStop();
        });
    }
    
    // Request ride button
    const requestRideBtn = document.getElementById('requestRideBtn');
    if (requestRideBtn) {
        requestRideBtn.addEventListener('click', function() {
            if (!AppState.pickup || !AppState.destination) {
                EnhancedUIUpdater.showToast('Please set pickup and destination locations', 'warning');
                return;
            }
            
            // Validate distance within city
            const validation = EnhancedPriceCalculator.validateDistanceWithinCity(
                AppState.pickup.lat, AppState.pickup.lng,
                AppState.destination.lat, AppState.destination.lng,
                AppState.currentCity
            );
            
            if (!validation.valid) {
                EnhancedUIUpdater.showToast(validation.message, 'warning');
                return;
            }
            
            // Calculate distance
            const distance = EnhancedPriceCalculator.calculateRideDistanceWithStops(
                AppState.pickup,
                AppState.destination,
                AppState.rideStops.filter(stop => stop.location)
            );
            
            // Calculate fare
            const surge = EnhancedPriceCalculator.getSurgeMultiplier();
            const fare = EnhancedPriceCalculator.calculateRideFare(
                distance,
                AppState.selectedRideType,
                surge,
                null,
                AppState.rideStops.filter(stop => stop.location)
            );
            
            // Create ride data
            const rideData = {
                pickup: AppState.pickup,
                destination: AppState.destination,
                rideType: AppState.selectedRideType,
                fare: fare,
                distance: distance,
                stops: AppState.rideStops.filter(stop => stop.location)
            };
            
            // Show payment modal
            EnhancedUIUpdater.showPaymentModal(fare, rideData);
        });
    }
    
    // More options button
    const moreOptionsBtn = document.getElementById('moreOptionsBtn');
    if (moreOptionsBtn) {
        moreOptionsBtn.addEventListener('click', function() {
            const menu = document.getElementById('moreOptionsMenu');
            if (menu) {
                menu.classList.toggle('active');
            }
        });
    }

// Inside setupEventListeners function, add these event listeners:

// Destination input for shopping service
const shoppingDestination = document.getElementById('shoppingDestination');
if (shoppingDestination) {
    shoppingDestination.addEventListener('change', function() {
        if (AppState.pickup && AppState.destination) {
            updateShoppingServicePrice();
        }
    });
}

// Destination input for delivery service
const deliveryDestination = document.getElementById('deliveryDestination');
if (deliveryDestination) {
    deliveryDestination.addEventListener('change', function() {
        if (AppState.pickup && AppState.destination) {
            updateDeliveryServicePrice();
        }
    });
}

// Destination input for short delivery service
const shortDeliveryDestination = document.getElementById('shortDeliveryDestination');
if (shortDeliveryDestination) {
    shortDeliveryDestination.addEventListener('change', function() {
        if (AppState.pickup && AppState.destination) {
            updateShortDeliveryServicePrice();
        }
    });
}

// Destination input for truck service
const truckDestination = document.getElementById('truckDestination');
if (truckDestination) {
    truckDestination.addEventListener('change', function() {
        if (AppState.pickup && AppState.destination) {
            updateTruckServicePrice();
        }
    });
}

// Delivery type buttons
document.querySelectorAll('#standardDelivery, #expressDelivery, #sameDayDelivery').forEach(btn => {
    btn.addEventListener('click', function() {
        // Remove active class from all
        document.querySelectorAll('#standardDelivery, #expressDelivery, #sameDayDelivery').forEach(b => {
            b.classList.remove('active');
        });
        // Add active to clicked
        this.classList.add('active');
        
        // Update price if destination is set
        if (AppState.pickup && AppState.destination) {
            updateDeliveryServicePrice();
        }
    });
});

// Truck type selection
document.querySelectorAll('.truck-type').forEach(type => {
    type.addEventListener('click', function() {
        // Remove selected class from all
        document.querySelectorAll('.truck-type').forEach(t => {
            t.classList.remove('selected');
        });
        // Add selected to clicked
        this.classList.add('selected');
        
        // Update price if destination is set
        if (AppState.pickup && AppState.destination) {
            updateTruckServicePrice();
        }
    });
});

// Helpers checkbox
const needHelpers = document.getElementById('needHelpers');
if (needHelpers) {
    needHelpers.addEventListener('change', function() {
        if (AppState.pickup && AppState.destination) {
            updateTruckServicePrice();
        }
    });
}

// Shopping budget input
const shoppingBudget = document.getElementById('shoppingBudget');
if (shoppingBudget) {
    shoppingBudget.addEventListener('input', function() {
        if (AppState.pickup && AppState.destination) {
            updateShoppingServicePrice();
        }
    });
}

// Shopping items count changes
const addItemBtn = document.getElementById('addItemBtn');
if (addItemBtn) {
    addItemBtn.addEventListener('click', function() {
        if (AppState.pickup && AppState.destination) {
            updateShoppingServicePrice();
        }
    });
}

// Parcel value input
const parcelValue = document.getElementById('parcelValue');
if (parcelValue) {
    parcelValue.addEventListener('input', function() {
        if (AppState.pickup && AppState.destination) {
            updateDeliveryServicePrice();
        }
    });
}

// Short delivery parcel description
const shortParcelDesc = document.getElementById('shortParcelDescription');
if (shortParcelDesc) {
    shortParcelDesc.addEventListener('input', function() {
        if (AppState.pickup && AppState.destination) {
            updateShortDeliveryServicePrice();
        }
    });
}
    
    // More options menu items
    document.querySelectorAll('#moreOptionsMenu .dropdown-item').forEach(item => {
        item.addEventListener('click', function() {
            const option = this.dataset.option;
            
            // Hide menu
            const menu = document.getElementById('moreOptionsMenu');
            if (menu) {
                menu.classList.remove('active');
            }
            
            switch(option) {
                case 'schedule':
                    showModal('schedule');
                    break;
                case 'orderForSomeone':
                    showModal('orderForSomeone');
                    break;
                case 'shareRide':
                    EnhancedUIUpdater.showSplitRidePopup();
                    break;
                case 'broadcast':
                    EnhancedUIUpdater.showBroadcastRidePopup();
                    break;
            }
        });
    });
    
    // SOS button
    const sosButton = document.getElementById('sosButton');
    if (sosButton) {
        sosButton.addEventListener('click', function() {
            if (!AppState.sosConfig) {
                showModal('sos');
            } else if (AppState.currentRide) {
                if (confirm('Send SOS alert to emergency contacts?')) {
                    EnhancedFirebaseManager.sendSOSAlert(
                        AppState.currentRide.id,
                        {
                            emergencyContact1Name: AppState.sosConfig.contact1Name,
                            emergencyContact1: AppState.sosConfig.contact1Phone,
                            emergencyContact2Name: AppState.sosConfig.contact2Name,
                            emergencyContact2: AppState.sosConfig.contact2Phone,
                            message: AppState.sosConfig.message,
                            location: AppState.userLocation,
                            rideDetails: {
                                pickup: AppState.currentRide.pickupDisplay,
                                destination: AppState.currentRide.destinationDisplay,
                                driver: AppState.currentRide.driverName
                            }
                        }
                    );
                }
            } else {
                EnhancedUIUpdater.showToast('No active ride', 'warning');
            }
        });
    }
    
    // SOS setup button
    const sosSetupBtn = document.getElementById('sosSetupBtn');
    if (sosSetupBtn) {
        sosSetupBtn.addEventListener('click', function() {
            showModal('sos');
        });
    }
    
    // Save SOS button
    const saveSOSBtn = document.getElementById('saveSOSBtn');
    if (saveSOSBtn) {
        saveSOSBtn.addEventListener('click', function() {
            const contact1Name = document.getElementById('sosContact1Name').value;
            const contact1Phone = document.getElementById('sosContact1Phone').value;
            const contact2Name = document.getElementById('sosContact2Name').value;
            const contact2Phone = document.getElementById('sosContact2Phone').value;
            const message = document.getElementById('sosMessage').value;
            
            if (!contact1Name || !contact1Phone) {
                EnhancedUIUpdater.showToast('Please fill in at least primary contact details', 'warning');
                return;
            }
            
            EnhancedFirebaseManager.saveSOSConfig(contact1Name, contact1Phone, contact2Name, contact2Phone, message);
            hideModal('sos');
        });
    }
    
    // Cancel ride button
    const cancelRideBtn = document.getElementById('cancelRideBtn');
    if (cancelRideBtn) {
        cancelRideBtn.addEventListener('click', function() {
            if (AppState.currentRide) {
                showModal('cancel');
            } else {
                EnhancedUIUpdater.showToast('No active ride to cancel', 'warning');
            }
        });
    }
    
    // Confirm cancel button
    const confirmCancelBtn = document.getElementById('confirmCancelBtn');
    if (confirmCancelBtn) {
        confirmCancelBtn.addEventListener('click', function() {
            const selectedReason = document.querySelector('.cancel-reason.selected');
            if (!selectedReason) {
                EnhancedUIUpdater.showToast('Please select a cancellation reason', 'warning');
                return;
            }
            
            let reason = selectedReason.dataset.reason;
            if (reason === 'other') {
                const otherReason = document.getElementById('otherReason').value;
                if (!otherReason.trim()) {
                    EnhancedUIUpdater.showToast('Please specify your reason', 'warning');
                    return;
                }
                reason = `other: ${otherReason}`;
            }
            
            if (AppState.currentRide) {
                EnhancedFirebaseManager.cancelRide(AppState.currentRide.id, reason);
                hideModal('cancel');
            }
        });
    }
    
    // Cancel reasons
    document.querySelectorAll('.cancel-reason').forEach(reason => {
        reason.addEventListener('click', function() {
            // Remove selected class from all reasons
            document.querySelectorAll('.cancel-reason').forEach(r => {
                r.classList.remove('selected');
            });
            
            // Add selected class to clicked reason
            this.classList.add('selected');
            
            // Show/hide other reason input
            const otherReasonGroup = document.getElementById('otherReasonGroup');
            if (otherReasonGroup) {
                if (this.dataset.reason === 'other') {
                    otherReasonGroup.style.display = 'block';
                } else {
                    otherReasonGroup.style.display = 'none';
                }
            }
        });
    });
    
    // Contact driver button
    const contactDriverBtn = document.getElementById('contactDriverBtn');
    if (contactDriverBtn) {
        contactDriverBtn.addEventListener('click', function() {
            if (AppState.currentRide && AppState.currentRide.driverPhone) {
                window.open(`tel:${AppState.currentRide.driverPhone}`, '_blank');
            } else {
                EnhancedUIUpdater.showToast('Driver phone number not available', 'warning');
            }
        });
    }
    
    // Open chat button
    const openChatBtn = document.getElementById('openChatBtn');
    if (openChatBtn) {
        openChatBtn.addEventListener('click', function() {
            const chatContainer = document.getElementById('chatContainer');
            if (chatContainer) {
                chatContainer.classList.add('active');
                AppState.chatOpen = true;
            }
        });
    }
    
    // Close chat button
    const chatClose = document.getElementById('chatClose');
    if (chatClose) {
        chatClose.addEventListener('click', function() {
            const chatContainer = document.getElementById('chatContainer');
            if (chatContainer) {
                chatContainer.classList.remove('active');
                AppState.chatOpen = false;
            }
        });
    }
    
    // Send chat message
    const chatSend = document.getElementById('chatSend');
    const chatInput = document.getElementById('chatInput');
    if (chatSend && chatInput) {
        chatSend.addEventListener('click', function() {
            const message = chatInput.value.trim();
            if (message && AppState.currentRide) {
                EnhancedFirebaseManager.sendChatMessage(AppState.currentRide.id, message, false);
                chatInput.value = '';
            }
        });
        
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                chatSend.click();
            }
        });
    }
    
   // Find the notification bell event listener and update it to:
// Notification bell
const notificationBell = document.getElementById('notificationBell');
if (notificationBell) {
    notificationBell.addEventListener('click', function(e) {
        e.stopPropagation();
        if (AppState.notificationsOpen) {
            EnhancedUIUpdater.hideNotificationsPanel();
        } else {
            EnhancedUIUpdater.showNotificationsPanel();
        }
    });
}

// Find the notifications close button and update it to:
// Close notifications button
const notificationsClose = document.getElementById('notificationsClose');
if (notificationsClose) {
    notificationsClose.addEventListener('click', function(e) {
        e.stopPropagation();
        EnhancedUIUpdater.hideNotificationsPanel();
    });
}

// Add this new event listener to close notifications when clicking outside:
// Close notifications when clicking outside
document.addEventListener('click', function(e) {
    const panel = document.getElementById('notificationsPanel');
    const bell = document.getElementById('notificationBell');
    
    if (panel && panel.classList.contains('active') && 
        !panel.contains(e.target) && 
        !bell.contains(e.target)) {
        EnhancedUIUpdater.hideNotificationsPanel();
    }
});
    
    // Emergency services
    document.querySelectorAll('.emergency-service').forEach(service => {
        service.addEventListener('click', function() {
            const type = this.dataset.type;
            
            if (type === 'sos') {
                showModal('sos');
            } else {
                EnhancedUIUpdater.showEmergencyStations(type);
            }
        });
    });
    
   
    
    // Payment methods
    document.querySelectorAll('.payment-method').forEach(method => {
        method.addEventListener('click', function() {
            // Remove selected class from all methods
            document.querySelectorAll('.payment-method').forEach(m => {
                m.classList.remove('selected');
            });
            
            // Add selected class to clicked method
            this.classList.add('selected');
        });
    });
    
    // Apply referral button
    const applyReferralBtn = document.getElementById('applyReferralBtn');
    if (applyReferralBtn) {
        applyReferralBtn.addEventListener('click', function() {
            EnhancedUIUpdater.applyReferralDiscount();
        });
    }
    
    // Confirm payment button
   // Confirm payment button
const confirmPaymentBtn = document.getElementById('confirmPaymentBtn');
if (confirmPaymentBtn) {
    confirmPaymentBtn.addEventListener('click', function() {
        const selectedMethod = document.querySelector('.payment-method.selected');
        if (!selectedMethod) {
            EnhancedUIUpdater.showToast('Please select a payment method', 'warning');
            return;
        }
        
        const paymentMethod = selectedMethod.dataset.payment;
        
        // Get final fare amount
        const finalFareElement = document.getElementById('finalFareAmount');
        const finalFare = finalFareElement ? 
            parseFloat(finalFareElement.textContent.replace('ZMW ', '')) : 
            AppState.rideFare;
        
        // Check wallet balance if paying with wallet
        if (paymentMethod === 'wallet' && finalFare > AppState.walletBalance) {
            EnhancedUIUpdater.showToast('Insufficient wallet balance', 'error');
            return;
        }

        // Check if this is a scheduled ride (check both pending ride data sources)
        const rideData = AppState.pendingRideData || AppState.pendingScheduledRideData;
        if (!rideData) {
            EnhancedUIUpdater.showToast('No ride data found', 'error');
            return;
        }

        // Check if it's a scheduled ride
        if (rideData.isScheduled || AppState.pendingScheduledRideData) {
            // Store payment method in scheduled ride data
            rideData.paymentMethod = paymentMethod;
            rideData.fare = finalFare;
            
            // Schedule the ride
            EnhancedFirebaseManager.requestScheduledRide(rideData)
                .then((scheduledRideId) => {
                    hideModal('payment');
                    AppState.pendingRideData = null;
                    AppState.pendingScheduledRideData = null;
                    
                    // Show success message with timer
                    EnhancedUIUpdater.showScheduleCountdown(rideData.scheduledTime, {
                        ...rideData,
                        id: scheduledRideId
                    });
                })
                .catch(error => {
                    console.error('Error scheduling ride:', error);
                    EnhancedUIUpdater.showToast('Error scheduling ride', 'error');
                });
            return;
        }
        
        // Regular ride (not scheduled)
        rideData.paymentMethod = paymentMethod;
        rideData.fare = finalFare;
        
        // Request the ride
        EnhancedFirebaseManager.requestRide(rideData)
            .then(() => {
                hideModal('payment');
                AppState.pendingRideData = null;
            })
            .catch(error => {
                console.error('Error requesting ride:', error);
                EnhancedUIUpdater.showToast('Error requesting ride', 'error');
            });
    });
}
    
    // Modal close buttons
    document.querySelectorAll('.modal-close').forEach(btn => {
        btn.addEventListener('click', function() {
            const modal = this.dataset.modal;
            hideModal(modal);
        });
    });
    
    // Modal overlay clicks
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
        overlay.addEventListener('click', function(e) {
            if (e.target === this) {
                const modalId = this.id.replace('Modal', '');
                hideModal(modalId);
            }
        });
    });
    
   // Schedule ride button
// Schedule ride button
const confirmScheduleBtn = document.getElementById('confirmScheduleBtn');
if (confirmScheduleBtn) {
    confirmScheduleBtn.addEventListener('click', async function() {
        if (!AppState.pickup || !AppState.destination) {
            EnhancedUIUpdater.showToast('Please set pickup and destination locations', 'warning');
            return;
        }
        
        const scheduleDate = document.getElementById('scheduleDate').value;
        const scheduleTime = document.getElementById('scheduleTime').value;
        const forSomeone = document.getElementById('scheduleForSomeone').checked;
        
        if (!scheduleDate || !scheduleTime) {
            EnhancedUIUpdater.showToast('Please select date and time', 'warning');
            return;
        }
        
        // Combine date and time
        const scheduledDateTime = new Date(`${scheduleDate}T${scheduleTime}`);
        const scheduledTime = scheduledDateTime.getTime();
        
        if (scheduledTime <= Date.now()) {
            EnhancedUIUpdater.showToast('Please select a future time', 'warning');
            return;
        }
        
        // Calculate distance and fare
        const distance = EnhancedPriceCalculator.calculateRideDistanceWithStops(
            AppState.pickup,
            AppState.destination,
            AppState.rideStops.filter(stop => stop.location)
        );
        
        const surge = EnhancedPriceCalculator.getSurgeMultiplier();
        const fare = EnhancedPriceCalculator.calculateRideFare(
            distance,
            AppState.selectedRideType,
            surge,
            null,
            AppState.rideStops.filter(stop => stop.location)
        );
        
        // Create scheduled ride data
        const scheduledRideData = {
            pickup: AppState.pickup,
            destination: AppState.destination,
            rideType: AppState.selectedRideType,
            fare: fare,
            distance: distance,
            stops: AppState.rideStops.filter(stop => stop.location),
            scheduledTime: scheduledTime,
            forSomeone: forSomeone,
            isScheduled: true,
            serviceType: 'car' // Default service type for scheduled rides
        };
        
        // Add recipient details if applicable
        if (forSomeone) {
            scheduledRideData.recipientName = document.getElementById('recipientName').value;
            scheduledRideData.recipientPhone = document.getElementById('recipientPhone').value;
            
            if (!scheduledRideData.recipientName || !scheduledRideData.recipientPhone) {
                EnhancedUIUpdater.showToast('Please enter recipient details', 'warning');
                return;
            }
        }
        
        // Show payment modal for scheduled ride
        EnhancedUIUpdater.showPaymentModal(fare, scheduledRideData);
        
        // Store scheduled ride data for after payment
        AppState.pendingScheduledRideData = scheduledRideData;
    });
}
    
    // Schedule for someone checkbox
    const scheduleForSomeone = document.getElementById('scheduleForSomeone');
    if (scheduleForSomeone) {
        scheduleForSomeone.addEventListener('change', function() {
            const someoneElseDetails = document.getElementById('someoneElseDetails');
            if (someoneElseDetails) {
                someoneElseDetails.style.display = this.checked ? 'block' : 'none';
            }
        });
    }
    
    // Logout button
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', function() {
            if (confirm('Are you sure you want to logout?')) {
                auth.signOut().then(() => {
                    window.location.href = 'signup.html';
                }).catch(error => {
                    console.error('Error signing out:', error);
                    EnhancedUIUpdater.showToast('Error logging out', 'error');
                });
            }
        });
    }
    
    // Update profile button
    const updateProfileBtn = document.getElementById('updateProfileBtn');
    if (updateProfileBtn) {
        updateProfileBtn.addEventListener('click', function() {
            showModal('updateProfile');
        });
    }
    
    // Save profile button
    const saveProfileBtn = document.getElementById('saveProfileBtn');
    if (saveProfileBtn) {
        saveProfileBtn.addEventListener('click', function() {
            const name = document.getElementById('updateName').value;
            const phone = document.getElementById('updatePhone').value;
            const homeAddress = document.getElementById('updateHomeAddress').value;
            const workAddress = document.getElementById('updateWorkAddress').value;
            
            if (!name || !phone) {
                EnhancedUIUpdater.showToast('Please fill in required fields', 'warning');
                return;
            }
            
            // Update user data in Firebase
            const updates = {
                name: name,
                phone: phone
            };
            
            if (homeAddress) updates.homeAddress = homeAddress;
            if (workAddress) updates.workAddress = workAddress;
            
            database.ref(`users/${AppState.currentUser.uid}`).update(updates)
                .then(() => {
                    hideModal('updateProfile');
                    EnhancedUIUpdater.showToast('Profile updated successfully', 'success');
                })
                .catch(error => {
                    console.error('Error updating profile:', error);
                    EnhancedUIUpdater.showToast('Error updating profile', 'error');
                });
        });
    }
    
    // Share referral button
    const shareReferralBtn = document.getElementById('shareReferralBtn');
    if (shareReferralBtn) {
        shareReferralBtn.addEventListener('click', function() {
            const referralCode = AppState.userData?.referralCode;
            if (referralCode && navigator.share) {
                navigator.share({
                    title: 'Join me on Jubel!',
                    text: `Use my referral code ${referralCode} to get 50% off your first ride on Jubel!`,
                    url: window.location.href
                }).catch(console.error);
            } else if (referralCode) {
                // Fallback for browsers that don't support Web Share API
                navigator.clipboard.writeText(referralCode)
                    .then(() => {
                        EnhancedUIUpdater.showToast('Referral code copied to clipboard!', 'success');
                    })
                    .catch(() => {
                        // Fallback for older browsers
                        const textArea = document.createElement('textarea');
                        textArea.value = referralCode;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        EnhancedUIUpdater.showToast('Referral code copied to clipboard!', 'success');
                    });
            }
        });
    }
    
   
    
    // Transfer button in transfer modal
    // Transfer button in transfer modal
const confirmTransferBtn = document.getElementById('confirmTransferBtn');
if (confirmTransferBtn) {
    confirmTransferBtn.addEventListener('click', function() {
        const recipientCode = document.getElementById('recipientCode').value;
        const amountInput = document.getElementById('transferAmount');
        const amount = parseFloat(amountInput.value);
        const message = document.getElementById('transferMessage').value;
        
        if (!recipientCode) {
            EnhancedUIUpdater.showToast('Please enter recipient referral code', 'warning');
            return;
        }
        
        if (!amount || amount <= 0) {
            EnhancedUIUpdater.showToast('Please enter a valid amount', 'warning');
            return;
        }
        
        if (amount > AppState.walletBalance) {
            EnhancedUIUpdater.showToast('Insufficient balance', 'error');
            return;
        }
        
        EnhancedFirebaseManager.transferMoney(recipientCode, amount, message, 'wallet')
            .then(() => {
                hideModal('transfer');
                document.getElementById('recipientCode').value = '';
                amountInput.value = '';
                document.getElementById('transferMessage').value = '';
            })
            .catch(error => {
                // Error already shown in transferMoney function
            });
    });
}
    
    // History filters
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            // Remove active class from all filters
            document.querySelectorAll('.filter-btn').forEach(b => {
                b.classList.remove('active');
            });
            
            // Add active class to clicked filter
            this.classList.add('active');
            
            // Update active filter
            const filter = this.dataset.filter;
            AppState.activeFilter = filter;
            
            // Filter rides
            if (AppState.rideHistory) {
                let filteredRides;
                
                switch(filter) {
                    case 'all':
                        filteredRides = AppState.rideHistory;
                        break;
                    case 'completed':
                        filteredRides = AppState.rideHistory.filter(ride => ride.status === 'completed');
                        break;
                    case 'cancelled':
                        filteredRides = AppState.rideHistory.filter(ride => ride.status === 'cancelled');
                        break;
                    case 'scheduled':
                        filteredRides = AppState.scheduledRides;
                        break;
                    case 'emergency':
                        filteredRides = AppState.rideHistory.filter(ride => ride.emergency);
                        break;
                    case 'delivery':
                        filteredRides = AppState.rideHistory.filter(ride => ride.serviceType === 'delivery');
                        break;
                    case 'truck':
                        filteredRides = AppState.rideHistory.filter(ride => ride.serviceType === 'truck');
                        break;
                    case 'broadcast':
                        filteredRides = AppState.rideHistory.filter(ride => ride.broadcast);
                        break;
                    default:
                        filteredRides = AppState.rideHistory;
                }
                
                EnhancedUIUpdater.updateRideHistory(filteredRides);
            }
        });
    });
    
    console.log('Event listeners setup completed');
}

// Inside setupEventListeners function, add these:

// Shopping service button
const requestShoppingBtn = document.getElementById('requestShoppingBtn');
if (requestShoppingBtn) {
    requestShoppingBtn.addEventListener('click', requestShoppingService);
}

// Delivery service button
const requestDeliveryBtn = document.getElementById('requestDeliveryBtn');
if (requestDeliveryBtn) {
    requestDeliveryBtn.addEventListener('click', requestDeliveryService);
}

// Short delivery service button
const requestShortDeliveryBtn = document.getElementById('requestShortDeliveryBtn');
if (requestShortDeliveryBtn) {
    requestShortDeliveryBtn.addEventListener('click', requestShortDeliveryService);
}

// Truck service button
const requestTruckBtn = document.getElementById('requestTruckBtn');
if (requestTruckBtn) {
    requestTruckBtn.addEventListener('click', requestTruckService);
}
        
// Vehicle Selection Function
function showVehicleSelectionModal(serviceType, fareData) {
    return new Promise((resolve, reject) => {
        // Create modal
        const modal = document.createElement('div');
        modal.className = 'vehicle-selection-modal';
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 10002;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        `;
        
        // Determine vehicle options based on service type
        let vehicleOptions = [];
        
        switch(serviceType) {
            case 'shopping':
            case 'express':
                vehicleOptions = [
                    { type: 'bike', name: 'Motorcycle', icon: 'fa-motorcycle', price: fareData?.bike || 0 },
                    { type: 'car', name: 'Car', icon: 'fa-car', price: fareData?.car || 0 }
                ];
                break;
            case 'delivery':
            case 'short-delivery':
                vehicleOptions = [
                    { type: 'bike', name: 'Motorcycle', icon: 'fa-motorcycle', price: fareData?.bike || 0 },
                    { type: 'car', name: 'Car', icon: 'fa-car', price: fareData?.car || 0 }
                ];
                break;
            case 'truck':
                // For truck, we don't need vehicle selection since truck type is already selected
                resolve({ vehicleType: 'truck', fare: fareData?.fare || 0 });
                return;
        }
        
        let html = `
            <div class="vehicle-selection-content">
                <div style="
                    padding: 20px;
                    background: linear-gradient(135deg, #FF6B35 0%, #FF8B35 100%);
                    color: white;
                ">
                    <h3 style="margin: 0; font-size: 18px;">
                        <i class="fas fa-${serviceType === 'truck' ? 'truck' : 'shipping-fast'}"></i>
                        Select Vehicle Type
                    </h3>
                    <p style="margin: 10px 0 0 0; font-size: 14px; opacity: 0.9;">
                        Choose your preferred vehicle for this ${serviceType} service
                    </p>
                </div>
                
                <div class="vehicle-options" style="padding: 20px;">
        `;
        
        vehicleOptions.forEach((option, index) => {
            html += `
                <div class="vehicle-option" data-type="${option.type}" style="
                    flex: 1;
                    padding: 20px;
                    border: 2px solid #e0e0e0;
                    border-radius: 8px;
                    text-align: center;
                    cursor: pointer;
                ">
                    <div class="vehicle-icon" style="font-size: 32px; color: #FF6B35; margin-bottom: 10px;">
                        <i class="fas ${option.icon}"></i>
                    </div>
                    <div class="vehicle-name" style="font-weight: 600; margin-bottom: 5px;">
                        ${option.name}
                    </div>
                    <div class="vehicle-price" style="font-size: 14px; color: #666;">
                        ZMW ${option.price.toFixed(2)}
                    </div>
                    <div class="vehicle-estimate" style="font-size: 12px; color: #999; margin-top: 5px;">
                        ${option.type === 'bike' ? 'Faster in traffic' : 'More capacity'}
                    </div>
                </div>
            `;
        });
        
        html += `
                </div>
                
                <div style="padding: 0 20px 20px 20px;">
                    <button id="confirmVehicleBtn" style="
                        width: 100%;
                        padding: 15px;
                        background: #FF6B35;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        cursor: pointer;
                        font-weight: 600;
                        font-size: 16px;
                    ">
                        Confirm Selection
                    </button>
                    <button id="cancelVehicleBtn" style="
                        width: 100%;
                        padding: 15px;
                        background: #f5f5f5;
                        color: #666;
                        border: none;
                        border-radius: 8px;
                        cursor: pointer;
                        font-weight: 600;
                        margin-top: 10px;
                    ">
                        Cancel
                    </button>
                </div>
            </div>
        `;
        
        modal.innerHTML = html;
        document.body.appendChild(modal);
        
        let selectedVehicle = null;
        
        // Add event listeners to vehicle options
        modal.querySelectorAll('.vehicle-option').forEach(option => {
            option.addEventListener('click', function() {
                // Remove selected class from all
                modal.querySelectorAll('.vehicle-option').forEach(o => {
                    o.style.borderColor = '#e0e0e0';
                    o.style.background = 'white';
                });
                
                // Add selected class to clicked
                this.style.borderColor = '#FF6B35';
                this.style.background = '#FFF3E0';
                
                selectedVehicle = this.dataset.type;
            });
        });
        
        // Auto-select first option
        setTimeout(() => {
            const firstOption = modal.querySelector('.vehicle-option');
            if (firstOption) {
                firstOption.style.borderColor = '#FF6B35';
                firstOption.style.background = '#FFF3E0';
                selectedVehicle = firstOption.dataset.type;
            }
        }, 100);
        
        // Confirm button
        modal.querySelector('#confirmVehicleBtn').addEventListener('click', function() {
            if (!selectedVehicle) {
                EnhancedUIUpdater.showToast('Please select a vehicle type', 'warning');
                return;
            }
            
            // Determine fare based on selected vehicle
            let fare;
            if (serviceType === 'truck') {
                fare = fareData?.fare || 0;
            } else {
                fare = selectedVehicle === 'car' ? fareData?.car : fareData?.bike;
            }
            
            document.body.removeChild(modal);
            resolve({ 
                vehicleType: selectedVehicle, 
                fare: fare 
            });
        });
        
        // Cancel button
        modal.querySelector('#cancelVehicleBtn').addEventListener('click', function() {
            document.body.removeChild(modal);
            reject(new Error('Vehicle selection cancelled'));
        });
        
        // Close on overlay click
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                document.body.removeChild(modal);
                reject(new Error('Vehicle selection cancelled'));
            }
        });
    });
}

// Shopping Service Request Function
async function requestShoppingService() {
    try {
        // Validate inputs
        if (!AppState.pickup || !AppState.destination) {
            EnhancedUIUpdater.showToast('Please set pickup and destination locations', 'warning');
            return;
        }
        
        const shopName = document.getElementById('shopName').value;
        if (!shopName.trim()) {
            EnhancedUIUpdater.showToast('Please enter shop/restaurant name', 'warning');
            return;
        }
        
        // Validate within city
        const validation = EnhancedPriceCalculator.validateDistanceWithinCity(
            AppState.pickup.lat, AppState.pickup.lng,
            AppState.destination.lat, AppState.destination.lng,
            AppState.currentCity
        );
        
        if (!validation.valid) {
            EnhancedUIUpdater.showToast(validation.message, 'warning');
            return;
        }
        
        // Get shopping details
        const itemsCount = document.querySelectorAll('.item-entry').length || 1;
        const budgetInput = document.getElementById('shoppingBudget');
        const budget = budgetInput ? parseFloat(budgetInput.value) || 0 : 0;
        const instructions = document.getElementById('shoppingInstructions').value;
        
        // Calculate distance
        const distance = EnhancedPriceCalculator.calculateDistance(
            AppState.pickup.lat, AppState.pickup.lng,
            AppState.destination.lat, AppState.destination.lng
        );
        
        // Calculate fares for both vehicle types
        const bikeFare = EnhancedPriceCalculator.calculateShoppingServiceFare(distance, itemsCount, budget, 'bike');
        const carFare = EnhancedPriceCalculator.calculateShoppingServiceFare(distance, itemsCount, budget, 'car');
        
        // Show vehicle selection modal
        const vehicleSelection = await showVehicleSelectionModal('shopping', {
            bike: bikeFare,
            car: carFare,
            distance: distance
        }).catch(error => {
            console.log('Vehicle selection cancelled');
            return null;
        });
        
        if (!vehicleSelection) return;
        
        // Create service data
        const serviceData = {
            pickup: AppState.pickup,
            destination: AppState.destination,
            serviceType: 'shopping',
            shopName: shopName,
            itemsCount: itemsCount,
            budget: budget,
            instructions: instructions,
            vehicleType: vehicleSelection.vehicleType,
            fare: vehicleSelection.fare,
            distance: distance,
            shoppingList: []
        };
        
        // Collect shopping items
        document.querySelectorAll('.item-entry .item-input').forEach((input, index) => {
            if (input.value.trim()) {
                serviceData.shoppingList.push({
                    id: index + 1,
                    name: input.value.trim()
                });
            }
        });
        
        // Show payment modal
        EnhancedUIUpdater.showPaymentModal(vehicleSelection.fare, serviceData);
        
    } catch (error) {
        console.error('Error requesting shopping service:', error);
        EnhancedUIUpdater.showToast('Error processing shopping request', 'error');
    }
}

// Delivery Service Request Function
async function requestDeliveryService() {
    try {
        // Validate inputs
        if (!AppState.pickup || !AppState.destination) {
            EnhancedUIUpdater.showToast('Please set pickup and destination locations', 'warning');
            return;
        }
        
        const parcelDescription = document.getElementById('parcelDescription').value;
        if (!parcelDescription.trim()) {
            EnhancedUIUpdater.showToast('Please describe the parcel', 'warning');
            return;
        }
        
        const receiverName = document.getElementById('receiverName').value;
        const receiverPhone = document.getElementById('receiverPhone').value;
        if (!receiverName.trim() || !receiverPhone.trim()) {
            EnhancedUIUpdater.showToast('Please enter receiver details', 'warning');
            return;
        }
        
        // Validate within city
        const validation = EnhancedPriceCalculator.validateDistanceWithinCity(
            AppState.pickup.lat, AppState.pickup.lng,
            AppState.destination.lat, AppState.destination.lng,
            AppState.currentCity
        );
        
        if (!validation.valid) {
            EnhancedUIUpdater.showToast(validation.message, 'warning');
            return;
        }
        
        // Get delivery type
        let deliveryType = 'standard';
        if (document.getElementById('expressDelivery')?.classList.contains('active')) {
            deliveryType = 'express';
        } else if (document.getElementById('sameDayDelivery')?.classList.contains('active')) {
            deliveryType = 'sameDay';
        }
        
        // Get parcel value
        const parcelValueInput = document.getElementById('parcelValue');
        const parcelValue = parcelValueInput ? parseFloat(parcelValueInput.value) || 0 : 0;
        
        // Calculate distance
        const distance = EnhancedPriceCalculator.calculateDistance(
            AppState.pickup.lat, AppState.pickup.lng,
            AppState.destination.lat, AppState.destination.lng
        );
        
        // Calculate fares for both vehicle types
        const bikeFare = EnhancedPriceCalculator.calculateDeliveryServiceFare(distance, deliveryType, parcelValue, 'bike');
        const carFare = EnhancedPriceCalculator.calculateDeliveryServiceFare(distance, deliveryType, parcelValue, 'car');
        
        // Show vehicle selection modal
        const vehicleSelection = await showVehicleSelectionModal('delivery', {
            bike: bikeFare,
            car: carFare,
            distance: distance
        }).catch(error => {
            console.log('Vehicle selection cancelled');
            return null;
        });
        
        if (!vehicleSelection) return;
        
        // Create service data
        const serviceData = {
            pickup: AppState.pickup,
            destination: AppState.destination,
            serviceType: 'delivery',
            deliveryType: deliveryType,
            parcelDescription: parcelDescription,
            parcelValue: parcelValue,
            receiverName: receiverName,
            receiverPhone: receiverPhone,
            vehicleType: vehicleSelection.vehicleType,
            fare: vehicleSelection.fare,
            distance: distance
        };
        
        // Show payment modal
        EnhancedUIUpdater.showPaymentModal(vehicleSelection.fare, serviceData);
        
    } catch (error) {
        console.error('Error requesting delivery service:', error);
        EnhancedUIUpdater.showToast('Error processing delivery request', 'error');
    }
}

// Short Delivery Service Request Function
async function requestShortDeliveryService() {
    try {
        // Validate inputs
        if (!AppState.pickup || !AppState.destination) {
            EnhancedUIUpdater.showToast('Please set pickup and destination locations', 'warning');
            return;
        }
        
        const parcelDescription = document.getElementById('shortParcelDescription').value;
        if (!parcelDescription.trim()) {
            EnhancedUIUpdater.showToast('Please describe what you\'re sending', 'warning');
            return;
        }
        
        const receiverPhone = document.getElementById('shortReceiverPhone').value;
        if (!receiverPhone.trim()) {
            EnhancedUIUpdater.showToast('Please enter receiver phone number', 'warning');
            return;
        }
        
        // Validate within city
        const validation = EnhancedPriceCalculator.validateDistanceWithinCity(
            AppState.pickup.lat, AppState.pickup.lng,
            AppState.destination.lat, AppState.destination.lng,
            AppState.currentCity
        );
        
        if (!validation.valid) {
            EnhancedUIUpdater.showToast(validation.message, 'warning');
            return;
        }
        
        // Calculate distance
        const distance = EnhancedPriceCalculator.calculateDistance(
            AppState.pickup.lat, AppState.pickup.lng,
            AppState.destination.lat, AppState.destination.lng
        );
        
        // Calculate fares for both vehicle types
        const bikeFare = EnhancedPriceCalculator.calculateShortDeliveryFare(distance, parcelDescription, 'bike');
        const carFare = EnhancedPriceCalculator.calculateShortDeliveryFare(distance, parcelDescription, 'car');
        
        // Show vehicle selection modal
        const vehicleSelection = await showVehicleSelectionModal('short-delivery', {
            bike: bikeFare,
            car: carFare,
            distance: distance
        }).catch(error => {
            console.log('Vehicle selection cancelled');
            return null;
        });
        
        if (!vehicleSelection) return;
        
        // Create service data
        const serviceData = {
            pickup: AppState.pickup,
            destination: AppState.destination,
            serviceType: 'short-delivery',
            parcelDescription: parcelDescription,
            receiverPhone: receiverPhone,
            vehicleType: vehicleSelection.vehicleType,
            fare: vehicleSelection.fare,
            distance: distance
        };
        
        // Show payment modal
        EnhancedUIUpdater.showPaymentModal(vehicleSelection.fare, serviceData);
        
    } catch (error) {
        console.error('Error requesting short delivery service:', error);
        EnhancedUIUpdater.showToast('Error processing delivery request', 'error');
    }
}

// Truck Service Request Function
async function requestTruckService() {
    try {
        // Validate inputs
        if (!AppState.pickup || !AppState.destination) {
            EnhancedUIUpdater.showToast('Please set pickup and destination locations', 'warning');
            return;
        }
        
        const itemDescription = document.getElementById('truckItemDescription').value;
        if (!itemDescription.trim()) {
            EnhancedUIUpdater.showToast('Please describe what you\'re moving', 'warning');
            return;
        }
        
        const weightInput = document.getElementById('estimatedWeight');
        const estimatedWeight = weightInput ? parseFloat(weightInput.value) || 0 : 0;
        if (!estimatedWeight || estimatedWeight <= 0) {
            EnhancedUIUpdater.showToast('Please enter estimated weight', 'warning');
            return;
        }
        
        // Validate within city
        const validation = EnhancedPriceCalculator.validateDistanceWithinCity(
            AppState.pickup.lat, AppState.pickup.lng,
            AppState.destination.lat, AppState.destination.lng,
            AppState.currentCity
        );
        
        if (!validation.valid) {
            EnhancedUIUpdater.showToast(validation.message, 'warning');
            return;
        }
        
        // Get truck type
        const selectedTruck = document.querySelector('.truck-type.selected');
        const truckType = selectedTruck ? selectedTruck.dataset.type : 'light';
        
        // Get helpers option
        const helpersCheckbox = document.getElementById('needHelpers');
        const needHelpers = helpersCheckbox ? helpersCheckbox.checked : false;
        
        // Calculate distance
        const distance = EnhancedPriceCalculator.calculateDistance(
            AppState.pickup.lat, AppState.pickup.lng,
            AppState.destination.lat, AppState.destination.lng
        );
        
        // Calculate fare
        const fare = EnhancedPriceCalculator.calculateTruckFare(distance, truckType, needHelpers);
        
        // Create service data
        const serviceData = {
            pickup: AppState.pickup,
            destination: AppState.destination,
            serviceType: 'truck',
            truckType: truckType,
            itemDescription: itemDescription,
            estimatedWeight: estimatedWeight,
            needHelpers: needHelpers,
            fare: fare,
            distance: distance
        };
        
        // Show payment modal
        EnhancedUIUpdater.showPaymentModal(fare, serviceData);
        
    } catch (error) {
        console.error('Error requesting truck service:', error);
        EnhancedUIUpdater.showToast('Error processing truck request', 'error');
    }
}

async function checkAndProcessScheduledRides() {
    try {
        if (!AppState.currentUser) return;
        
        // Load scheduled rides from Firebase
        const snapshot = await database.ref('scheduledRides')
            .orderByChild('passengerId')
            .equalTo(AppState.currentUser.uid)
            .orderByChild('status')
            .equalTo('scheduled')
            .once('value');
        
        const scheduledRides = snapshot.val();
        if (!scheduledRides) return;
        
        const now = Date.now();
        
        Object.entries(scheduledRides).forEach(([rideId, ride]) => {
            // Check if ride time has arrived
            if (ride.scheduledTime <= now) {
                // Request the ride
                EnhancedUIUpdater.requestScheduledRideNow({
                    ...ride,
                    id: rideId
                });
            } else {
                // Update or create countdown timer
                if (!AppState.scheduledCountdowns.has(rideId)) {
                    EnhancedUIUpdater.showScheduleCountdown(ride.scheduledTime, {
                        ...ride,
                        id: rideId
                    });
                }
            }
        });
        
    } catch (error) {
        console.error('Error checking scheduled rides:', error);
    }
}
        
// ============================================
// MODAL FUNCTIONS
// ============================================
function showModal(modalId) {
    const modal = document.getElementById(`${modalId}Modal`);
    if (modal) {
        modal.style.display = 'block';
    }
}

function hideModal(modalId) {
    const modal = document.getElementById(`${modalId}Modal`);
    if (modal) {
        modal.style.display = 'none';
    }
}

// ============================================
// START THE APPLICATION
// ============================================
window.addEventListener('load', initializeApp);

// ============================================
// GLOBAL FUNCTIONS
// ============================================
// Make some functions available globally
window.EnhancedUIUpdater = EnhancedUIUpdater;
window.EnhancedLocationManager = EnhancedLocationManager;
window.switchScreen = switchScreen;
window.switchService = switchService;
window.showModal = showModal;
window.hideModal = hideModal;
window.getCurrentLocation = getCurrentLocation;

console.log('Jubel Passenger App JavaScript loaded');
</script>
</body>
</html>
