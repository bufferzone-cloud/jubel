<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jubel - Ride Hailing</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* CSS styles are already provided as per your request */
    </style>
</head>
<body>
    <!-- Map Container -->
    <div id="map">
        <div class="map-loading-overlay" id="mapLoadingOverlay">
            <div class="loading-spinner"></div>
            <div class="map-loading-text">Loading map...</div>
        </div>
    </div>
    
    <!-- Top Navigation Bar -->
    <div class="top-bar">
        <div class="logo-container">
            <div class="logo-icon">
                <img src="jubel.png" alt="Jubel Logo" id="jubelLogo">
            </div>
            <div class="logo-text" id="userFullName">Loading...</div>
        </div>
        
        <div class="user-actions">
            <div class="balance-badge" id="balanceBadge">
                <i class="fas fa-wallet"></i>
                <span>Balance: <span class="balance-amount" id="walletBalance">ZMW 0.00</span></span>
            </div>
            <div class="notification-bell" id="notificationBell">
                <i class="fas fa-bell"></i>
                <span class="notification-badge" id="notificationCount">0</span>
            </div>
        </div>
    </div>
    
    <!-- City Detection Indicator -->
    <div class="city-detection" id="cityDetection">
        <i class="fas fa-map-marker-alt"></i>
        <span id="currentCityDisplay">Detecting your city...</span>
    </div>
    
    <!-- Ride Status Bar -->
    <div class="ride-status-bar" id="rideStatusBar">
        <div class="status-indicator">
            <div class="status-dot searching" id="statusDot"></div>
            <span class="status-text" id="statusText">Searching for driver</span>
        </div>
        <div class="status-eta">
            <i class="fas fa-clock"></i>
            <span id="etaText">5 min</span>
        </div>
    </div>
    
    <!-- Emergency Status -->
    <div class="emergency-status" id="emergencyStatus">
        <i class="fas fa-exclamation-triangle"></i>
        <span>EMERGENCY RIDE IN PROGRESS</span>
    </div>
    
    <!-- SOS Button -->
    <div class="sos-button" id="sosButton">
        <i class="fas fa-exclamation-triangle"></i>
    </div>
    
    <!-- Map Controls -->
    <div class="map-controls">
        <button class="map-control-btn" id="locateMeBtn" title="Locate Me">
            <i class="fas fa-location-arrow"></i>
        </button>
        <button class="map-control-btn" id="zoomInBtn" title="Zoom In">
            <i class="fas fa-plus"></i>
        </button>
        <button class="map-control-btn" id="zoomOutBtn" title="Zoom Out">
            <i class="fas fa-minus"></i>
        </button>
        <button class="map-control-btn" id="clearRouteBtn" title="Clear Route">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <!-- Chat Container -->
    <div class="chat-container" id="chatContainer">
        <div class="chat-header">
            <div class="chat-title">Chat with Driver</div>
            <button class="chat-close" id="chatClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <!-- Messages will be inserted here -->
        </div>
        <div class="chat-typing-indicator" id="typingIndicator">
            Driver is typing...
        </div>
        <div class="chat-input-container">
            <button class="chat-attachment-btn" id="attachmentBtn">
                <i class="fas fa-paperclip"></i>
            </button>
            <input type="text" class="chat-input" id="chatInput" placeholder="Type your message...">
            <button class="chat-send-btn" id="chatSend">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
    
    <!-- Notifications Panel -->
    <div class="notifications-panel" id="notificationsPanel">
        <div class="notifications-header">
            <div class="notifications-title">Notifications</div>
            <button class="notifications-close" id="notificationsClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="notifications-list" id="notificationsList">
            <!-- Notifications will be inserted here -->
        </div>
    </div>
    
    <!-- Dropdown Menu -->
    <div class="dropdown-menu" id="dropdownMenu">
        <div class="dropdown-item" data-action="profile">
            <i class="fas fa-user"></i>
            <span>Profile</span>
        </div>
        <div class="dropdown-item" data-action="settings">
            <i class="fas fa-cog"></i>
            <span>Settings</span>
        </div>
        <div class="dropdown-item" data-action="help">
            <i class="fas fa-question-circle"></i>
            <span>Help & Support</span>
        </div>
        <div class="dropdown-item" data-action="logout">
            <i class="fas fa-sign-out-alt"></i>
            <span>Logout</span>
        </div>
    </div>
    
    <!-- More Options Menu -->
    <div class="more-options-menu" id="moreOptionsMenu">
        <div class="dropdown-item" data-option="schedule">
            <i class="fas fa-calendar-alt"></i>
            <span>Schedule Ride</span>
        </div>
        <div class="dropdown-item" data-option="orderForSomeone">
            <i class="fas fa-user-friends"></i>
            <span>Order for Someone</span>
        </div>
        <div class="dropdown-item" data-option="shareRide">
            <i class="fas fa-share-alt"></i>
            <span>Share Ride</span>
        </div>
        <div class="dropdown-item" data-option="broadcast">
            <i class="fas fa-broadcast-tower"></i>
            <span>Broadcast Ride</span>
        </div>
    </div>
    
    <!-- Main Panel -->
    <div class="main-panel" id="mainPanel">
        <div class="panel-handle" id="panelHandle"></div>
        
        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" data-screen="home">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </button>
            <button class="nav-tab" data-screen="history">
                <i class="fas fa-history"></i>
                <span>History</span>
            </button>
            <button class="nav-tab" data-screen="account">
                <i class="fas fa-user"></i>
                <span>Account</span>
            </button>
            <button class="nav-tab" data-screen="emergency">
                <i class="fas fa-ambulance"></i>
                <span>Emergency</span>
            </button>
        </div>
        
        <!-- Home Screen Content -->
        <div id="homeContent">
            <!-- Service Tabs -->
            <div class="service-tabs" id="serviceTabs">
                <div class="service-tab car active" data-service="car">
                    <div class="service-icon">
                        <i class="fas fa-car"></i>
                    </div>
                    <div class="service-name">Car</div>
                    <div class="service-desc">Ride anywhere</div>
                </div>
                
                <div class="service-tab delivery" data-service="delivery">
                    <div class="service-icon">
                        <i class="fas fa-shipping-fast"></i>
                    </div>
                    <div class="service-name">Delivery</div>
                    <div class="service-desc">Send packages</div>
                </div>
                
                <div class="service-tab short-delivery" data-service="short-delivery">
                    <div class="service-icon">
                        <i class="fas fa-bicycle"></i>
                    </div>
                    <div class="service-name">Short Delivery</div>
                    <div class="service-desc">Quick deliveries</div>
                </div>
                
                <div class="service-tab" data-service="express">
                    <div class="service-icon">
                        <i class="fas fa-shopping-bag"></i>
                    </div>
                    <div class="service-name">Express Shopping</div>
                    <div class="service-desc">Shop for you</div>
                </div>
                
                <div class="service-tab" data-service="truck">
                    <div class="service-icon">
                        <i class="fas fa-truck"></i>
                    </div>
                    <div class="service-name">Truck</div>
                    <div class="service-desc">Move items</div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="quick-actions">
                <button class="quick-action-btn" id="moreOptionsBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-ellipsis-h"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">More Options</div>
                        <div class="quick-action-desc">Schedule, share, broadcast</div>
                    </div>
                </button>
                <button class="quick-action-btn" id="broadcastRideBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-broadcast-tower"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">Broadcast Ride</div>
                        <div class="quick-action-desc">Share with friends</div>
                    </div>
                </button>
                <button class="quick-action-btn" id="sosSetupBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">SOS Setup</div>
                        <div class="quick-action-desc">Emergency contacts</div>
                    </div>
                </button>
                <button class="quick-action-btn" id="recentDestinationsBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-history"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">Recent Destinations</div>
                        <div class="quick-action-desc">Quick access</div>
                    </div>
                </button>
            </div>
            
            <!-- Car Service Form (Default) -->
            <div class="ride-request-form active" id="carForm">
                <div class="form-title">
                    <i class="fas fa-car"></i>
                    Book a Ride
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="pickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="pickupLocation" placeholder="Current location" readonly>
                        <div class="search-loading" id="pickupSearchLoading"></div>
                        <div class="suggestion-list" id="pickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="destinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="destinationLocation" placeholder="Where to?" autocomplete="off">
                        <div class="search-loading" id="destinationSearchLoading"></div>
                        <div class="suggestion-list" id="destinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Stops Container -->
                <div id="stopsContainer" style="margin: 10px 0;"></div>
                <button type="button" class="btn btn-secondary" id="addStopBtn" style="width: 100%; margin-bottom: 15px;">
                    <i class="fas fa-plus"></i> Add Stop
                </button>
                
                <!-- Search History -->
                <div class="search-history" id="searchHistory" style="display: none;"></div>
                
                <!-- Ride Type Selection -->
                <div class="ride-type-selection" id="rideTypeSelection">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                        <span id="rideTypeInfo" style="font-size: 11px; color: var(--text-light); cursor: pointer;">
                            <i class="fas fa-info-circle"></i>
                        </span>
                    </div>
                    
                    <div class="ride-type-cards" id="rideTypeCardsContainer">
                        <div class="ride-type-card economy" data-type="economy">
                            <div class="ride-type-icon">
                                <i class="fas fa-car-side"></i>
                            </div>
                            <div class="ride-type-name">Economy</div>
                            <div class="ride-type-price" id="economyPrice">ZMW 0.00</div>
                        </div>
                        <div class="ride-type-card standard selected" data-type="standard">
                            <div class="ride-type-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="ride-type-name">Standard</div>
                            <div class="ride-type-price" id="standardPrice">ZMW 0.00</div>
                        </div>
                        <div class="ride-type-card premium" data-type="premium">
                            <div class="ride-type-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="ride-type-name">Premium</div>
                            <div class="ride-type-price" id="premiumPrice">ZMW 0.00</div>
                        </div>
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="fareDisplay">
                    <div class="fare-label">Estimated Fare</div>
                    <div class="fare-amount" id="estimatedFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="distanceDetail">0 km</span>
                        <span id="timeDetail">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Price Calculator Display -->
                <div class="price-calculator-display" id="priceCalculator" style="display: none;">
                    <div class="fare-label">Fare Breakdown</div>
                    <div class="fare-amount" id="calculatedFare">ZMW 0.00</div>
                    <div class="price-breakdown" id="priceBreakdown">
                        <!-- Breakdown will be inserted here -->
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestRideBtn">
                        <i class="fas fa-search"></i>
                        Request Ride
                    </button>
                </div>
            </div>
            
            <!-- Delivery Service Form -->
            <div class="service-form delivery-form" id="deliveryForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-shipping-fast"></i>
                    Package Delivery
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="deliveryPickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="deliveryPickup" placeholder="Pickup location" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="deliveryPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="deliveryDestinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="deliveryDestination" placeholder="Delivery address" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="deliveryDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Delivery Details -->
                <div class="form-group">
                    <label class="form-label">Parcel Description</label>
                    <input type="text" class="form-control" id="parcelDescription" placeholder="What are you sending?">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Receiver's Details</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="receiverName" placeholder="Receiver name">
                        <input type="tel" class="form-control" id="receiverPhone" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Parcel Value (ZMW)</label>
                    <input type="number" class="form-control" id="parcelValue" placeholder="Value of parcel" min="0" step="0.01">
                </div>
                
                <!-- Delivery Options -->
                <div class="form-group">
                    <label class="form-label">Delivery Type</label>
                    <div style="display: flex; gap: 10px;">
                        <button class="filter-btn active" id="standardDelivery">Standard</button>
                        <button class="filter-btn" id="expressDelivery">Express</button>
                        <button class="filter-btn" id="sameDayDelivery">Same Day</button>
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="deliveryFareDisplay" style="display: none;">
                    <div class="fare-label">Delivery Fare</div>
                    <div class="fare-amount" id="deliveryFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="deliveryDistance">0 km</span>
                        <span id="deliveryTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestDeliveryBtn">
                        <i class="fas fa-shipping-fast"></i>
                        Request Delivery
                    </button>
                </div>
            </div>
            
            <!-- Short Delivery Form -->
            <div class="service-form delivery-form" id="shortDeliveryForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-bicycle"></i>
                    Short Delivery
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="shortDeliveryPickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="shortDeliveryPickup" placeholder="Pickup location" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shortDeliveryPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="shortDeliveryDestinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="shortDeliveryDestination" placeholder="Delivery address" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shortDeliveryDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Delivery Details -->
                <div class="form-group">
                    <label class="form-label">What are you sending?</label>
                    <input type="text" class="form-control" id="shortParcelDescription" placeholder="Food, documents, small items...">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Receiver's Phone</label>
                    <input type="tel" class="form-control" id="shortReceiverPhone" placeholder="Receiver phone number">
                </div>
                
                <!-- Quick Options -->
                <div class="form-group">
                    <label class="form-label">Quick Options</label>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <span class="filter-btn">Food</span>
                        <span class="filter-btn">Documents</span>
                        <span class="filter-btn">Medication</span>
                        <span class="filter-btn">Small Package</span>
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="shortDeliveryFareDisplay" style="display: none;">
                    <div class="fare-label">Delivery Fare</div>
                    <div class="fare-amount" id="shortDeliveryFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="shortDeliveryDistance">0 km</span>
                        <span id="shortDeliveryTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestShortDeliveryBtn">
                        <i class="fas fa-bolt"></i>
                        Quick Delivery
                    </button>
                </div>
            </div>
            
            <!-- Express Shopping Form -->
            <div class="service-form express-form" id="expressForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-shopping-bag"></i>
                    Express Shopping
                </div>
                
                <!-- Shopping Categories -->
                <div class="shopping-categories" id="shoppingCategories">
                    <div class="category-btn" data-category="restaurants">
                        <i class="fas fa-utensils"></i>
                        <span>Restaurants</span>
                    </div>
                    <div class="category-btn" data-category="pharmacies">
                        <i class="fas fa-prescription-bottle"></i>
                        <span>Pharmacies</span>
                    </div>
                    <div class="category-btn" data-category="supermarkets">
                        <i class="fas fa-shopping-cart"></i>
                        <span>Supermarkets</span>
                    </div>
                    <div class="category-btn" data-category="malls">
                        <i class="fas fa-store"></i>
                        <span>Shopping Malls</span>
                    </div>
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="shopNameInput">
                        <i class="fas fa-store"></i>
                        <input type="text" id="shopName" placeholder="Shop/Restaurant name" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shopSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="shopLocation" placeholder="Shop location" readonly>
                    </div>
                </div>
                
                <!-- Items List -->
                <div class="form-group">
                    <label class="form-label">Shopping List</label>
                    <div class="item-list" id="shoppingItems">
                        <div class="item-entry">
                            <input type="text" class="item-input" placeholder="Item name">
                            <button class="remove-item" type="button">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <button class="add-item" type="button" id="addItemBtn">
                        <i class="fas fa-plus"></i>
                        Add Item
                    </button>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Special Instructions</label>
                    <textarea class="form-control form-textarea" id="shoppingInstructions" placeholder="Any specific requests or instructions..."></textarea>
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="shoppingDestinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="shoppingDestination" placeholder="Delivery address" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shoppingDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Budget -->
                <div class="form-group">
                    <label class="form-label">Estimated Budget (ZMW)</label>
                    <input type="number" class="form-control" id="shoppingBudget" placeholder="Estimated cost of items">
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="shoppingFareDisplay" style="display: none;">
                    <div class="fare-label">Shopping Service Fare</div>
                    <div class="fare-amount" id="shoppingFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="shoppingDistance">0 km</span>
                        <span id="shoppingTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestShoppingBtn">
                        <i class="fas fa-shopping-cart"></i>
                        Request Shopping
                    </button>
                </div>
            </div>
            
            <!-- Truck Delivery Form -->
            <div class="service-form truck-form" id="truckForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-truck"></i>
                    Truck Delivery
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="truckPickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="truckPickup" placeholder="Pickup location (Current location)" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="truckPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="truckDestinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="truckDestination" placeholder="Destination" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="truckDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Truck Type Selection -->
                <div class="form-group">
                    <label class="form-label">Select Truck Type</label>
                    <div class="truck-types">
                        <div class="truck-type" data-type="pickup">
                            <div class="truck-icon">
                                <i class="fas fa-truck-pickup"></i>
                            </div>
                            <div class="truck-name">Pickup Truck</div>
                            <div class="truck-capacity">Up to 1.5 tons</div>
                        </div>
                        
                        <div class="truck-type selected" data-type="light">
                            <div class="truck-icon">
                                <i class="fas fa-truck-moving"></i>
                            </div>
                            <div class="truck-name">Light Truck</div>
                            <div class="truck-capacity">Up to 3 tons</div>
                        </div>
                        
                        <div class="truck-type" data-type="medium">
                            <div class="truck-icon">
                                <i class="fas fa-truck"></i>
                            </div>
                            <div class="truck-name">Medium Truck</div>
                            <div class="truck-capacity">Up to 7 tons</div>
                        </div>
                        
                        <div class="truck-type" data-type="heavy">
                            <div class="truck-icon">
                                <i class="fas fa-truck-loading"></i>
                            </div>
                            <div class="truck-name">Heavy Truck</div>
                            <div class="truck-capacity">Up to 15 tons</div>
                        </div>
                    </div>
                </div>
                
                <!-- Item Details -->
                <div class="form-group">
                    <label class="form-label">What are you moving?</label>
                    <input type="text" class="form-control" id="truckItemDescription" placeholder="Furniture, boxes, equipment...">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Estimated Weight (kg)</label>
                    <input type="number" class="form-control" id="estimatedWeight" placeholder="Approximate weight">
                </div>
                
                <!-- Additional Help -->
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="needHelpers">
                        <span style="margin-left: 8px;">Need loading/unloading helpers (+ZMW 50)</span>
                    </label>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="truckFareDisplay" style="display: none;">
                    <div class="fare-label">Truck Fare</div>
                    <div class="fare-amount" id="truckFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="truckDistance">0 km</span>
                        <span id="truckTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestTruckBtn">
                        <i class="fas fa-truck"></i>
                        Request Truck
                    </button>
                </div>
            </div>
            
            <!-- Ride Info Panel -->
            <div class="ride-info-panel" id="rideInfoPanel" style="display: none;">
                <div class="driver-info">
                    <div class="driver-avatar" id="driverAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="driver-details">
                        <div class="driver-name" id="driverName">Driver Name</div>
                        <div class="driver-rating">
                            <i class="fas fa-star"></i>
                            <span id="driverRating">4.8</span>
                        </div>
                        <div class="driver-vehicle">
                            <i class="fas fa-car"></i>
                            <span id="vehicleDetails">Toyota Corolla - ABC 123</span>
                        </div>
                    </div>
                </div>
                
                <!-- Driver Media Display -->
                <div class="driver-media" id="driverMedia">
                    <div class="media-container">
                        <div class="media-placeholder" id="driverImagePlaceholder">
                            <i class="fas fa-user"></i>
                            <span>Driver Image</span>
                        </div>
                        <img id="driverImage" style="display: none;">
                    </div>
                    <div class="media-container">
                        <div class="media-placeholder" id="vehicleImagePlaceholder">
                            <i class="fas fa-car"></i>
                            <span>Vehicle Image</span>
                        </div>
                        <img id="vehicleImage" style="display: none;">
                    </div>
                </div>
                
                <!-- Tracking Info -->
                <div class="tracking-info" id="trackingInfo">
                    <div class="tracking-header">
                        <div class="tracking-title">Driver Distance</div>
                        <div class="tracking-distance" id="driverDistance">0 km</div>
                    </div>
                    <div class="tracking-progress">
                        <div class="tracking-progress-bar" id="trackingProgress" style="width: 0%"></div>
                    </div>
                    <div class="tracking-details">
                        <span id="pickupDistance">0 km to pickup</span>
                        <span id="etaToPickup">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Timeline -->
                <div class="timeline" id="rideTimeline">
                    <div class="timeline-step">
                        <div class="step-dot active" id="stepRequested">
                            <i class="fas fa-search"></i>
                        </div>
                        <div class="step-label active">Requested</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepAccepted">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <div class="step-label">Accepted</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepArrived">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="step-label">Arrived</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepStarted">
                            <i class="fas fa-play"></i>
                        </div>
                        <div class="step-label">Started</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepCompleted">
                            <i class="fas fa-flag-checkered"></i>
                        </div>
                        <div class="step-label">Completed</div>
                    </div>
                </div>
                
                <!-- Ride Stops -->
                <div class="ride-stops" id="rideStopsContainer" style="display: none; margin-top: 15px;">
                    <div class="section-title" style="font-size: 14px; color: var(--text-gray); margin-bottom: 10px;">
                        <i class="fas fa-map-pin"></i> Stops
                    </div>
                    <div id="rideStopsList"></div>
                </div>
                
                <div class="trip-details">
                    <div class="trip-locations">
                        <div class="location-point">
                            <div class="location-marker pickup">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="location-text">
                                <div class="location-label">Pickup</div>
                                <div class="location-address" id="currentPickup">Loading...</div>
                            </div>
                        </div>
                        
                        <div class="location-point">
                            <div class="location-marker destination">
                                <i class="fas fa-flag"></i>
                            </div>
                            <div class="location-text">
                                <div class="location-label">Destination</div>
                                <div class="location-address" id="currentDestination">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Location Details -->
                <div class="location-details">
                    <div class="location-detail-item">
                        <div class="location-detail-icon">
                            <i class="fas fa-road"></i>
                        </div>
                        <div class="location-detail-content">
                            <div class="location-detail-label">Distance</div>
                            <div class="location-detail-value" id="rideDistance">0 km</div>
                        </div>
                    </div>
                    <div class="location-detail-item">
                        <div class="location-detail-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="location-detail-content">
                            <div class="location-detail-label">Estimated Time</div>
                            <div class="location-detail-value" id="rideTime">0 min</div>
                        </div>
                    </div>
                </div>
                
                <div class="fare-breakdown">
                    <div class="fare-row">
                        <span class="fare-label">Base Fare</span>
                        <span class="fare-value" id="baseFareValue">ZMW 15.00</span>
                    </div>
                    <div class="fare-row">
                        <span class="fare-label">Distance</span>
                        <span class="fare-value" id="distanceFareValue">ZMW 5.00</span>
                    </div>
                    <div class="fare-row">
                        <span class="fare-label">Ride Type</span>
                        <span class="fare-value" id="rideTypeValue">Standard</span>
                    </div>
                    <div class="fare-row total">
                        <span class="fare-label">Total Fare</span>
                        <span class="fare-value" id="totalFareValue">ZMW 20.00</span>
                    </div>
                </div>
                
                <!-- Emergency Contact Display -->
                <div class="emergency-contact-display" id="emergencyContactDisplay" style="display: none;">
                    <div class="emergency-contact-header">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div class="emergency-contact-title">Emergency Contacts</div>
                    </div>
                    <div class="emergency-contact-item">
                        <div class="contact-info">
                            <div class="contact-name" id="emergencyContact1Name">Contact 1</div>
                            <div class="contact-phone" id="emergencyContact1Phone">000-000-0000</div>
                        </div>
                        <button class="contact-action-btn" id="emergencyContact1Btn">
                            <i class="fas fa-phone"></i>
                        </button>
                    </div>
                    <div class="emergency-contact-item">
                        <div class="contact-info">
                            <div class="contact-name" id="emergencyContact2Name">Contact 2</div>
                            <div class="contact-phone" id="emergencyContact2Phone">000-000-0000</div>
                        </div>
                        <button class="contact-action-btn" id="emergencyContact2Btn">
                            <i class="fas fa-phone"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Broadcast Feature -->
                <div class="broadcast-feature" id="broadcastFeature" style="display: none;">
                    <div class="broadcast-feature-header">
                        <div class="broadcast-feature-title">
                            <i class="fas fa-broadcast-tower"></i>
                            <span>Broadcast Ride</span>
                        </div>
                        <div class="broadcast-status-indicator inactive" id="broadcastStatusIndicator"></div>
                    </div>
                    <div class="broadcast-form">
                        <div class="broadcast-input-group">
                            <input type="text" id="broadcastMemberInput" placeholder="Enter friend's referral code">
                            <button class="broadcast-btn" id="addBroadcastMemberBtn">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div class="broadcast-recipients" id="broadcastMembersContainer">
                            <!-- Recipients will be inserted here -->
                        </div>
                        <button class="btn btn-secondary" id="startBroadcastBtn">
                            <i class="fas fa-play"></i>
                            Start Broadcasting
                        </button>
                    </div>
                </div>

                <!-- Share Ride Status -->
                <div class="share-ride-status" id="shareRideStatus" style="display: none;"></div>
                
                <div class="action-buttons">
                    <button class="btn btn-danger" id="cancelRideBtn">
                        <i class="fas fa-times-circle"></i>
                        Cancel Ride
                    </button>
                    <button class="btn btn-secondary" id="contactDriverBtn">
                        <i class="fas fa-phone"></i>
                        Call Driver
                    </button>
                    <button class="btn btn-secondary" id="openChatBtn">
                        <i class="fas fa-comment"></i>
                        Chat
                    </button>
                </div>
            </div>
            
            <!-- Broadcast Ride Form -->
            <div class="service-form" id="broadcastForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-broadcast-tower"></i>
                    Broadcast Ride
                </div>
                
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="broadcastPickup" placeholder="Pickup location" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="broadcastPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="broadcastDestination" placeholder="Destination" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="broadcastDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Add Friends via Referral Codes -->
                <div class="form-group">
                    <label class="form-label">Add Friends by Referral Code</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" class="form-control" id="broadcastFriendInput" placeholder="Enter friend's referral code">
                        <button class="btn btn-secondary" id="addBroadcastFriendBtn">
                            <i class="fas fa-plus"></i> Add
                        </button>
                    </div>
                    <div id="broadcastFriendsList" class="broadcast-friends-list" style="margin-top: 10px;">
                        <!-- Broadcast friends will be inserted here -->
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="broadcastFareDisplay" style="display: none;">
                    <div class="fare-label">Broadcast Fare</div>
                    <div class="fare-amount" id="broadcastFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="broadcastDistance">0 km</span>
                        <span id="broadcastTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="startBroadcastRideBtn">
                        <i class="fas fa-broadcast-tower"></i>
                        Start Broadcast
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- History Screen -->
    <div class="history-screen" id="historyScreen" style="display: none;">
        <div class="screen-header">
            <button class="back-btn" data-screen="home">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="screen-title">Ride History</div>
        </div>
        
        <div class="history-filters">
            <button class="filter-btn active" data-filter="all">All</button>
            <button class="filter-btn" data-filter="completed">Completed</button>
            <button class="filter-btn" data-filter="cancelled">Cancelled</button>
            <button class="filter-btn" data-filter="scheduled">Scheduled</button>
            <button class="filter-btn" data-filter="emergency">Emergency</button>
            <button class="filter-btn" data-filter="delivery">Delivery</button>
            <button class="filter-btn" data-filter="truck">Truck</button>
            <button class="filter-btn" data-filter="broadcast">Broadcast</button>
            <button class="filter-btn" data-filter="share">Share</button>
        </div>
        
        <div class="history-list" id="historyList">
            <!-- History items will be inserted here -->
        </div>
    </div>
    
    <!-- Account Screen -->
    <div class="account-screen" id="accountScreen" style="display: none;">
        <div class="screen-header">
            <button class="back-btn" data-screen="home">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="screen-title">My Account</div>
        </div>
        
        <div class="account-header">
            <div class="account-avatar" id="accountAvatar">
                <i class="fas fa-user"></i>
            </div>
            <div class="account-name" id="accountName">Loading...</div>
            <div class="account-phone" id="accountPhone">Loading...</div>
        </div>
        
        <div class="account-stats">
            <div class="stat-card">
                <div class="stat-value" id="completedRides">0</div>
                <div class="stat-label">Completed Rides</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="cancelledRides">0</div>
                <div class="stat-label">Cancelled Rides</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalSpent">ZMW 0</div>
                <div class="stat-label">Total Spent</div>
            </div>
        </div>
        
        <div class="account-section">
            <div class="section-title">
                <i class="fas fa-wallet"></i>
                Wallet Balance
            </div>
            
            <div class="wallet-balance">
                <div class="balance-label">Available Balance</div>
                <div class="balance-amount-large" id="accountBalance">ZMW 0.00</div>
            </div>
            
            <div class="wallet-actions">
                <button class="btn-wallet" id="depositBtn">
                    <i class="fas fa-plus"></i>
                    Deposit
                </button>
                <button class="btn-wallet" id="withdrawBtn">
                    <i class="fas fa-minus"></i>
                    Withdraw
                </button>
                <button class="btn-wallet" id="transferBtn">
                    <i class="fas fa-exchange-alt"></i>
                    Transfer
                </button>
                <button class="btn-wallet" id="transactionsBtn">
                    <i class="fas fa-history"></i>
                    History
                </button>
            </div>
        </div>
        
        <div class="account-section">
            <div class="section-title">
                <i class="fas fa-gift"></i>
                Referral Program
            </div>
            
            <div class="referral-card">
                <div>Share your referral code and earn ZMW 25 for each friend's first ride</div>
                <div class="referral-code" id="referralCode">JUBEL-XXXX</div>
                <button class="btn btn-primary" id="shareReferralBtn">
                    <i class="fas fa-share"></i>
                    Share Code
                </button>
                <div class="referral-note">Your friend gets 50% off their first ride</div>
            </div>
        </div>
        
        <div class="account-section">
            <div class="section-title">
                <i class="fas fa-cog"></i>
                Settings
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-secondary" id="updateProfileBtn">
                    <i class="fas fa-user-edit"></i>
                    Update Profile
                </button>
                <button class="btn btn-secondary" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </button>
            </div>
        </div>
    </div>
    
    <!-- Emergency Screen -->
    <div class="emergency-screen" id="emergencyScreen" style="display: none;">
        <div class="screen-header">
            <button class="back-btn" data-screen="home">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="screen-title">Emergency Services</div>
        </div>
        
        <div class="emergency-services">
            <div class="emergency-service police" data-type="police">
                <div class="emergency-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <div class="emergency-name">Police Ride</div>
                <div class="emergency-description">Emergency transport with police escort</div>
            </div>
            
            <div class="emergency-service fire" data-type="fire">
                <div class="emergency-icon">
                    <i class="fas fa-fire-extinguisher"></i>
                </div>
                <div class="emergency-name">Fire Brigade</div>
                <div class="emergency-description">Fire emergency response team</div>
            </div>
            
            <div class="emergency-service medical" data-type="medical">
                <div class="emergency-icon">
                    <i class="fas fa-ambulance"></i>
                </div>
                <div class="emergency-name">Hospital Ride</div>
                <div class="emergency-description">Medical emergency transport</div>
            </div>
            
            <div class="emergency-service" data-type="sos">
                <div class="emergency-icon" style="background: var(--error-red);">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="emergency-name">SOS Emergency</div>
                <div class="emergency-description">Immediate emergency assistance</div>
            </div>
        </div>
        
        <div class="emergency-note">
            <p><strong>Important:</strong> Only use emergency services for genuine emergencies. Misuse may result in penalties. In case of immediate danger, call 911 first.</p>
        </div>
    </div>
    
    <!-- Modals -->
    
    <!-- Payment Modal -->
    <div class="modal-overlay" id="paymentModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-credit-card"></i>
                    Select Payment Method
                </div>
                <button class="modal-close" data-modal="payment">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <div class="form-label">Available Balance: <span id="paymentBalance">ZMW 0.00</span></div>
                    <div class="form-label">Total Amount: <span id="paymentAmount">ZMW 0.00</span></div>
                </div>
                
                <!-- Referral Discount Section -->
                <div class="referral-discount-section" id="referralDiscountSection" style="display: none;">
                    <div class="section-header">
                        <i class="fas fa-gift"></i>
                        <span>Referral Discount (50% off)</span>
                    </div>
                    <div id="referralInputSection">
                        <div class="referral-input-group">
                            <input type="text" id="referralCodeInput" placeholder="Enter referral code">
                            <button id="applyReferralBtn" class="btn btn-orange">
                                <i class="fas fa-check"></i> Apply
                            </button>
                        </div>
                    </div>
                    <div id="referralAppliedSection" style="display: none;">
                        <div id="referrerInfo" style="font-size: 12px; color: var(--success-green); margin: 10px 0;">
                            <i class="fas fa-check-circle"></i> Referral from: <span id="referrerName"></span>
                        </div>
                        <div class="discount-breakdown" style="margin-top: 10px;">
                            <div class="price-row">
                                <span>Original Fare:</span>
                                <span id="originalFareAmount">ZMW 0.00</span>
                            </div>
                            <div class="price-row">
                                <span>Discount:</span>
                                <span id="discountAmount" style="color: var(--success-green);">-ZMW 0.00</span>
                            </div>
                            <div class="price-row total">
                                <span>Final Fare:</span>
                                <span id="finalFareAmount" style="font-weight: bold;">ZMW 0.00</span>
                            </div>
                        </div>
                        <button id="removeReferralBtn" class="btn btn-secondary" style="margin-top: 10px;">
                            <i class="fas fa-times"></i> Remove Discount
                        </button>
                    </div>
                </div>
                
                <div class="payment-methods">
                    <div class="payment-method selected" data-payment="wallet">
                        <div class="payment-icon">
                            <i class="fas fa-wallet"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Jubel Wallet</div>
                            <div class="payment-info">Pay with your wallet balance</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-payment="mobile">
                        <div class="payment-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Mobile Money</div>
                            <div class="payment-info">Pay via MTN/Zamtel/Airtel</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-payment="cash">
                        <div class="payment-icon">
                            <i class="fas fa-money-bill"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Cash</div>
                            <div class="payment-info">Pay driver directly</div>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmPaymentBtn">
                        <i class="fas fa-check"></i>
                        Confirm Payment
                    </button>
                    <button class="btn btn-secondary" data-modal="payment">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Cancel Ride Modal -->
    <div class="modal-overlay" id="cancelModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-times-circle"></i>
                    Cancel Ride
                </div>
                <button class="modal-close" data-modal="cancel">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <div class="form-label">Please select a reason for cancellation:</div>
                </div>
                
                <div class="cancel-reasons">
                    <div class="cancel-reason" data-reason="driver_late">
                        <div class="reason-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="reason-text">Driver is taking too long</div>
                    </div>
                    
                    <div class="cancel-reason" data-reason="change_plans">
                        <div class="reason-icon">
                            <i class="fas fa-calendar-times"></i>
                        </div>
                        <div class="reason-text">Change of plans</div>
                    </div>
                    
                    <div class="cancel-reason" data-reason="found_alternative">
                        <div class="reason-icon">
                            <i class="fas fa-car"></i>
                        </div>
                        <div class="reason-text">Found alternative transport</div>
                    </div>
                    
                    <div class="cancel-reason" data-reason="emergency">
                        <div class="reason-icon">
                            <i class="fas fa-exclamation"></i>
                        </div>
                        <div class="reason-text">Emergency situation</div>
                    </div>
                    
                    <div class="cancel-reason" data-reason="other">
                        <div class="reason-icon">
                            <i class="fas fa-ellipsis-h"></i>
                        </div>
                        <div class="reason-text">Other reason</div>
                    </div>
                </div>
                
                <div class="form-group" id="otherReasonGroup" style="display: none;">
                    <label class="form-label">Please specify:</label>
                    <textarea class="form-control form-textarea" id="otherReason" placeholder="Enter your reason here..."></textarea>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-danger" id="confirmCancelBtn">
                        <i class="fas fa-times"></i>
                        Cancel Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="cancel">
                        Go Back
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Emergency Ride Modal -->
    <div class="modal-overlay" id="emergencyModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-ambulance"></i>
                    Emergency Ride Details
                </div>
                <button class="modal-close" data-modal="emergency">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content emergency-modal-content">
                <div class="form-group">
                    <div class="form-label" id="emergencyServiceType" data-type="police">Police Ride</div>
                </div>
                
                <!-- Emergency Reasons -->
                <div class="form-group">
                    <label class="form-label">Select Emergency Reason</label>
                    <div class="emergency-reasons">
                        <div class="emergency-reason" data-reason="accident">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-car-crash"></i>
                            </div>
                            <div class="emergency-reason-text">Accident</div>
                        </div>
                        
                        <div class="emergency-reason" data-reason="medical">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-heartbeat"></i>
                            </div>
                            <div class="emergency-reason-text">Medical Emergency</div>
                        </div>
                        
                        <div class="emergency-reason" data-reason="crime">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="emergency-reason-text">Crime/Assault</div>
                        </div>
                        
                        <div class="emergency-reason" data-reason="fire">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-fire"></i>
                            </div>
                            <div class="emergency-reason-text">Fire Emergency</div>
                        </div>
                        
                        <div class="emergency-reason" data-reason="other">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="emergency-reason-text">Other Emergency</div>
                        </div>
                    </div>
                    
                    <div class="emergency-reason-input" id="emergencyReasonOther" style="display: none;">
                        <label class="form-label">Please describe the emergency:</label>
                        <textarea class="form-control form-textarea" id="emergencyOtherReason" placeholder="Describe the emergency situation..."></textarea>
                    </div>
                </div>
                
                <!-- Location Inputs -->
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="emergencyPickup" placeholder="Pickup location" readonly>
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="emergencyPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="emergencyDestination" placeholder="Destination" autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="emergencyDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Emergency Stations -->
                <div class="form-group">
                    <label class="form-label">Select Nearest Emergency Station</label>
                    <div class="emergency-stations" id="emergencyStations">
                        <!-- Stations will be inserted here -->
                    </div>
                </div>
                
                <!-- User Location Details -->
                <div class="location-details">
                    <div class="location-detail-item">
                        <div class="location-detail-icon">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="location-detail-content">
                            <div class="location-detail-label">Your Location</div>
                            <div class="location-detail-value" id="emergencyUserLocation">Detecting location...</div>
                        </div>
                    </div>
                </div>
                
                <!-- Price Calculation -->
                <div class="price-calculation">
                    <div class="calculation-row">
                        <span>Base Emergency Fare:</span>
                        <span id="emergencyBaseFare">ZMW 100.00</span>
                    </div>
                    <div class="calculation-row">
                        <span>Distance to Service:</span>
                        <span id="emergencyDistance">0 km</span>
                    </div>
                    <div class="calculation-row">
                        <span>Estimated Time:</span>
                        <span id="emergencyTime">5 min</span>
                    </div>
                    <div class="calculation-row total">
                        <span>Total Fare:</span>
                        <span id="emergencyTotalFare">ZMW 100.00</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-danger" id="confirmEmergencyBtn">
                        <i class="fas fa-exclamation-triangle"></i>
                        Request Emergency Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="emergency">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- SOS Setup Modal -->
    <div class="modal-overlay" id="sosModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    SOS Emergency Setup
                </div>
                <button class="modal-close" data-modal="sos">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <label class="form-label">Primary Emergency Contact</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="sosContact1Name" placeholder="Contact name">
                        <input type="tel" class="form-control" id="sosContact1Phone" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Secondary Emergency Contact (Optional)</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="sosContact2Name" placeholder="Contact name">
                        <input type="tel" class="form-control" id="sosContact2Phone" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Emergency Message</label>
                    <textarea class="form-control form-textarea" id="sosMessage">
I need help! My current location and ride details will be shared with you.
                    </textarea>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="saveSOSBtn">
                        <i class="fas fa-save"></i>
                        Save SOS Setup
                    </button>
                    <button class="btn btn-secondary" data-modal="sos">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Transfer Money Modal -->
    <div class="modal-overlay" id="transferModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-exchange-alt"></i>
                    Transfer Money
                </div>
                <button class="modal-close" data-modal="transfer">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <div class="form-label">Available Balance: <span id="transferBalance">ZMW 0.00</span></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Recipient's Referral Code</label>
                    <input type="text" class="form-control" id="recipientCode" placeholder="Enter recipient's Jubel referral code">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Amount (ZMW)</label>
                    <input type="number" class="form-control" id="transferAmount" placeholder="Enter amount" min="1" step="0.01">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Message (Optional)</label>
                    <input type="text" class="form-control" id="transferMessage" placeholder="Add a message">
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmTransferBtn">
                        <i class="fas fa-paper-plane"></i>
                        Send Money
                    </button>
                    <button class="btn btn-secondary" data-modal="transfer">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Wallet Transactions Modal -->
    <div class="modal-overlay" id="transactionsModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-history"></i>
                    Wallet Transactions
                </div>
                <button class="modal-close" data-modal="transactions">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div id="transactionsList">
                    <!-- Transactions will be inserted here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Schedule Ride Modal -->
    <div class="modal-overlay" id="scheduleModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-calendar-alt"></i>
                    Schedule a Ride
                </div>
                <button class="modal-close" data-modal="schedule">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="schedulePickup" placeholder="Pickup location">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="schedulePickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="scheduleDestination" placeholder="Destination">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="scheduleDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- For Someone Else -->
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="scheduleForSomeone">
                        <span style="margin-left: 8px;">Booking for someone else</span>
                    </label>
                </div>
                
                <div class="form-group" id="someoneElseDetails" style="display: none;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="recipientName" placeholder="Recipient name">
                        <input type="tel" class="form-control" id="recipientPhone" placeholder="Recipient phone">
                    </div>
                </div>
                
                <div class="schedule-grid">
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-control" id="scheduleDate" min="">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Time</label>
                        <input type="time" class="form-control" id="scheduleTime">
                    </div>
                </div>
                
                <!-- Ride Type Selection for Schedule -->
                <div class="ride-type-selection" style="margin: 0 0 16px 0;">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                    </div>
                    <div class="ride-type-grid" id="scheduleRideTypeGrid">
                        <div class="ride-type-card economy" data-type="economy">
                            <div class="ride-type-icon">
                                <i class="fas fa-car-side"></i>
                            </div>
                            <div class="ride-type-name">Economy</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card selected" data-type="standard">
                            <div class="ride-type-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="ride-type-name">Standard</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card premium" data-type="premium">
                            <div class="ride-type-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="ride-type-name">Premium</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="scheduleFareDisplay" style="display: none;">
                    <div class="fare-label">Scheduled Ride Fare</div>
                    <div class="fare-amount" id="scheduleFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="scheduleDistance">0 km</span>
                        <span id="scheduleTimeEstimate">ETA: 0 min</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmScheduleBtn">
                        <i class="fas fa-calendar-check"></i>
                        Schedule Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="schedule">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Order for Someone Modal -->
    <div class="modal-overlay" id="orderForSomeoneModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-user-friends"></i>
                    Order for Someone Else
                </div>
                <button class="modal-close" data-modal="orderForSomeone">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="someonePickup" placeholder="Pickup location">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="someonePickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="someoneDestination" placeholder="Destination">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="someoneDestinationSuggestions"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Recipient Details</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="someoneName" placeholder="Full name">
                        <input type="tel" class="form-control" id="someonePhone" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Special Instructions (Optional)</label>
                    <textarea class="form-control form-textarea" id="someoneInstructions" placeholder="Any instructions for the driver..."></textarea>
                </div>
                
                <!-- Ride Type Selection -->
                <div class="ride-type-selection" style="margin: 0 0 16px 0;">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                    </div>
                    <div class="ride-type-grid" id="someoneRideTypeGrid">
                        <div class="ride-type-card economy" data-type="economy">
                            <div class="ride-type-icon">
                                <i class="fas fa-car-side"></i>
                            </div>
                            <div class="ride-type-name">Economy</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card selected" data-type="standard">
                            <div class="ride-type-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="ride-type-name">Standard</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card premium" data-type="premium">
                            <div class="ride-type-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="ride-type-name">Premium</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="someoneFareDisplay" style="display: none;">
                    <div class="fare-label">Estimated Fare</div>
                    <div class="fare-amount" id="someoneFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="someoneDistance">0 km</span>
                        <span id="someoneTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmSomeoneRideBtn">
                        <i class="fas fa-car"></i>
                        Request Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="orderForSomeone">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Share Ride Modal -->
    <div class="modal-overlay" id="shareRideModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-share-alt"></i>
                    Share Ride (Max 3 Friends)
                </div>
                <button class="modal-close" data-modal="shareRide">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="sharePickup" placeholder="Pickup location">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="sharePickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="shareDestination" placeholder="Destination">
                        <div class="search-loading"></div>
                        <div class="suggestion-list" id="shareDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Share Members Input -->
                <div class="form-group">
                    <label class="form-label">Add Friends by Referral Code (Max 3)</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" class="form-control" id="shareMemberInput" placeholder="Enter friend's referral code">
                        <button class="btn btn-secondary" id="addShareMemberBtn">
                            <i class="fas fa-plus"></i> Add
                        </button>
                    </div>
                    <div class="split-options" style="margin-top: 10px;">
                        <label class="form-label">Split Type:</label>
                        <div style="display: flex; gap: 10px; margin-top: 5px;">
                            <button class="filter-btn active" id="splitEqual">Equal Split</button>
                            <button class="filter-btn" id="splitYou70">You Pay 70%</button>
                            <button class="filter-btn" id="splitYouAll">You Pay All</button>
                        </div>
                    </div>
                </div>
                
                <!-- Share Members List -->
                <div class="form-group">
                    <div id="shareFriendsList" class="share-friends-list">
                        <!-- Share members will be inserted here -->
                    </div>
                </div>
                
                <!-- Share Calculations -->
                <div class="form-group" id="shareCalculations" style="display: none;">
                    <div class="calculation-summary">
                        <div class="calculation-row">
                            <span>Total Fare:</span>
                            <span id="shareTotalFare">ZMW 0.00</span>
                        </div>
                        <div class="calculation-row">
                            <span>Your Share:</span>
                            <span id="shareYourShare">ZMW 0.00</span>
                        </div>
                        <div class="calculation-row">
                            <span>Each Friend's Share:</span>
                            <span id="shareFriendShare">ZMW 0.00</span>
                        </div>
                    </div>
                </div>
                
                <!-- Ride Type Selection -->
                <div class="ride-type-selection" style="margin: 0 0 16px 0;">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                    </div>
                    <div class="ride-type-grid" id="shareRideTypeGrid">
                        <div class="ride-type-card economy" data-type="economy">
                            <div class="ride-type-icon">
                                <i class="fas fa-car-side"></i>
                            </div>
                            <div class="ride-type-name">Economy</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card selected" data-type="standard">
                            <div class="ride-type-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="ride-type-name">Standard</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                        
                        <div class="ride-type-card premium" data-type="premium">
                            <div class="ride-type-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="ride-type-name">Premium</div>
                            <div class="ride-type-price">ZMW 0.00</div>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmShareRideBtn">
                        <i class="fas fa-user-friends"></i>
                        Share Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="shareRide">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Share Ride Invitation Modal -->
    <div class="modal-overlay" id="shareRideInvitationModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-users"></i>
                    Share Ride Invitation
                </div>
                <button class="modal-close" data-modal="shareRideInvitation">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="invitation-details" id="invitationDetails">
                    <!-- Invitation details will be inserted here -->
                </div>
                <div class="payment-section" id="shareInvitationPayment" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Select Payment Method for your share:</label>
                        <div class="payment-methods">
                            <div class="payment-method selected" data-payment="wallet">
                                <div class="payment-icon">
                                    <i class="fas fa-wallet"></i>
                                </div>
                                <div class="payment-details">
                                    <div class="payment-name">Wallet</div>
                                    <div class="payment-info">ZMW <span id="shareInvitationAmount">0.00</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" id="acceptShareInvitationBtn">
                        <i class="fas fa-check"></i>
                        Accept & Pay
                    </button>
                    <button class="btn btn-secondary" id="rejectShareInvitationBtn">
                        <i class="fas fa-times"></i>
                        Decline
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Update Profile Modal -->
    <div class="modal-overlay" id="updateProfileModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-user-edit"></i>
                    Update Profile
                </div>
                <button class="modal-close" data-modal="updateProfile">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <input type="text" class="form-control" id="updateName" placeholder="Your full name">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Phone Number</label>
                    <input type="tel" class="form-control" id="updatePhone" placeholder="Your phone number">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" class="form-control" id="updateEmail" placeholder="Your email address" readonly>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Home Address (Optional)</label>
                    <input type="text" class="form-control" id="updateHomeAddress" placeholder="Your home address">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Work Address (Optional)</label>
                    <input type="text" class="form-control" id="updateWorkAddress" placeholder="Your work address">
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="saveProfileBtn">
                        <i class="fas fa-save"></i>
                        Save Changes
                    </button>
                    <button class="btn btn-secondary" data-modal="updateProfile">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Shopping Categories Modal -->
    <div class="modal-overlay" id="shoppingCategoriesModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-store"></i>
                    Select Shop
                </div>
                <button class="modal-close" data-modal="shoppingCategories">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="shops-list" id="shopsList">
                    <!-- Shops will be inserted here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Loading...</div>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Real-time Indicator -->
    <div class="real-time-indicator" id="realTimeIndicator">
        <i class="fas fa-sync-alt"></i>
        <span>Real-time updates active</span>
    </div>
    
    <!-- Sync Indicator -->
    <div class="sync-indicator" id="syncIndicator">
        <i class="fas fa-sync-alt sync-icon"></i>
        <span>Syncing...</span>
    </div>
    
    <!-- External JavaScript Libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>
    <script>
// ============================================
// FIREBASE CONFIGURATION AND INITIALIZATION
// ============================================
const firebaseConfig = {
    apiKey: "AIzaSyDEACX_P4c5q7djJAcA0I7Lk7leO2TlQ74",
    authDomain: "jubel-13e1a.firebaseapp.com",
    databaseURL: "https://jubel-13e1a-default-rtdb.firebaseio.com",
    projectId: "jubel-13e1a",
    storageBucket: "jubel-13e1a.firebasestorage.app",
    messagingSenderId: "882241095445",
    appId: "1:882241095445:web:ee9ca40fddd008ca910b1c",
    measurementId: "G-J5JPKL6B5F"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const auth = firebase.auth();
const storage = firebase.storage();

// ============================================
// GLOBAL STATE MANAGEMENT
// ============================================
const AppState = {
    currentUser: null,
    userData: null,
    currentRide: null,
    activeScreen: 'home',
    activeService: 'car',
    walletBalance: 0,
    userLocation: null,
    currentCity: null,
    selectedRideType: 'standard',
    selectedVehicle: null,
    destination: null,
    pickup: null,
    rideFare: 0,
    driverLocation: null,
    chatMessages: [],
    scheduledRides: [],
    emergencyMode: false,
    sosConfig: null,
    searchCache: new Map(),
    notifications: [],
    unreadNotifications: 0,
    searchHistory: [],
    broadcastRecipients: [],
    emergencyStations: {
        police: [],
        fire: [],
        medical: []
    },
    realtimeListeners: [],
    rideTypes: {
        economy: { base: 15, perKm: 2.5, multiplier: 0.8, min: 10, icon: 'fa-car-side' },
        standard: { base: 20, perKm: 3.0, multiplier: 1.0, min: 15, icon: 'fa-car' },
        premium: { base: 30, perKm: 4.0, multiplier: 1.5, min: 25, icon: 'fa-crown' }
    },
    emergencyServices: {
        police: { base: 150, perKm: 5.0, multiplier: 2.0, min: 100 },
        fire: { base: 200, perKm: 6.0, multiplier: 2.5, min: 150 },
        medical: { base: 180, perKm: 5.5, multiplier: 2.2, min: 120 }
    },
    deliveryTypes: {
        standard: { base: 25, perKm: 2.0, multiplier: 1.0 },
        express: { base: 40, perKm: 3.0, multiplier: 1.5 },
        sameDay: { base: 60, perKm: 4.0, multiplier: 2.0 }
    },
    truckTypes: {
        pickup: { base: 80, perKm: 5.0, multiplier: 1.0, capacity: '1.5 tons' },
        light: { base: 120, perKm: 6.0, multiplier: 1.2, capacity: '3 tons' },
        medium: { base: 200, perKm: 8.0, multiplier: 1.5, capacity: '7 tons' },
        heavy: { base: 350, perKm: 12.0, multiplier: 2.0, capacity: '15 tons' }
    },
    activeBroadcast: null,
    typingTimeout: null,
    driverTyping: false,
    activeScheduledTimer: null,
    rideRequestPulsingIcons: {
        car: null,
        bike: null,
        truck: null
    },
    shareRideFriends: [],
    maxShareFriends: 3,
    routeDirections: null,
    pendingRideData: null,
    referralDiscountApplied: false,
    referralCodeUsed: null,
    referralOwnerName: null,
    shareRideInvitations: new Map(),
    broadcastInvitations: new Map(),
    paymentPendingMembers: new Set(),
    rideSplitDetails: null,
    activeRoute: null,
    activeFilter: 'all',
    lastSearchQuery: null,
    chatOpen: false,
    notificationsOpen: false,
    mapInitialized: false,
    rideStops: [],
    currentStopIndex: 0,
    splitType: 'equal',
    shoppingCategory: null
};

// ============================================
// MAP MANAGEMENT
// ============================================
let map = null;
let currentLocationMarker = null;
let pickupMarker = null;
let destinationMarker = null;
let driverMarker = null;
let routeLayer = null;
let emergencyMarkers = [];
let emergencyStationMarkers = [];
let cityBoundaryLayer = null;
let routePolyline = null;
let pulsingIcon = null;
let stopMarkers = [];

// ============================================
// ENHANCED LOCATION SEARCH ENGINE
// ============================================
const EnhancedSearchEngine = {
    cache: new Map(),
    lastSearch: 0,
    debounceTimer: null,
    searchHistory: [],
    maxHistoryItems: 15,
    activeSearches: new Set(),
    
    init: function() {
        this.loadSearchHistory();
        console.log('Enhanced Search Engine initialized');
    },
    
    loadSearchHistory: function() {
        try {
            const history = localStorage.getItem('jubel_search_history');
            if (history) {
                this.searchHistory = JSON.parse(history);
                console.log(`Loaded ${this.searchHistory.length} search history items`);
            }
        } catch (error) {
            console.error('Error loading search history:', error);
            this.searchHistory = [];
        }
    },
    
    saveSearchHistory: function() {
        try {
            localStorage.setItem('jubel_search_history', JSON.stringify(this.searchHistory));
        } catch (error) {
            console.error('Error saving search history:', error);
        }
    },
    
    addToHistory: function(query, location, type) {
        const historyItem = {
            query: query,
            location: location,
            type: type,
            timestamp: Date.now(),
            city: AppState.currentCity
        };
        
        this.searchHistory = this.searchHistory.filter(item => 
            !(item.query === query && item.type === type && item.city === AppState.currentCity)
        );
        
        this.searchHistory.unshift(historyItem);
        
        if (this.searchHistory.length > this.maxHistoryItems) {
            this.searchHistory = this.searchHistory.slice(0, this.maxHistoryItems);
        }
        
        this.saveSearchHistory();
        return historyItem;
    },
    
    search: async function(query, type = 'destination', location = null, forceCity = null) {
        const searchId = `${Date.now()}-${Math.random()}`;
        this.activeSearches.add(searchId);
        
        try {
            const city = forceCity || AppState.currentCity;
            if (!city) {
                console.warn('No city detected for search');
                return [];
            }
            
            const cacheKey = `${query.toLowerCase()}-${type}-${city}-${location ? `${location.lat.toFixed(4)},${location.lng.toFixed(4)}` : 'none'}`;
            
            if (this.cache.has(cacheKey)) {
                const cached = this.cache.get(cacheKey);
                if (Date.now() - cached.timestamp < 300000) {
                    console.log('Returning cached search results');
                    return cached.results;
                }
            }
            
            console.log(`Searching for "${query}" in ${city}, type: ${type}`);
            
            const searchUrl = this.buildSearchUrl(query, city, location);
            
            const response = await fetch(searchUrl, {
                headers: {
                    'User-Agent': 'JubelRideApp/1.0',
                    'Accept': 'application/json'
                }
            });
            
            if (!response.ok) {
                throw new Error(`Search failed: ${response.status} ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log(`Received ${data.length} results for "${query}"`);
            
            const results = this.processAndFilterResults(data, location, city, type);
            
            this.cache.set(cacheKey, {
                results: results,
                timestamp: Date.now(),
                query: query,
                city: city
            });
            
            if (type === 'destination' && results.length > 0) {
                this.addToHistory(query, results[0], type);
            }
            
            this.lastSearch = Date.now();
            
            return results;
        } catch (error) {
            console.error('Search error:', error);
            return this.localCitySearch(query, city, location);
        } finally {
            this.activeSearches.delete(searchId);
        }
    },
    
    buildSearchUrl: function(query, city, location) {
        const params = new URLSearchParams({
            q: `${query}${city ? `, ${city}, Zambia` : ', Zambia'}`,
            format: 'json',
            limit: 15,
            countrycodes: 'zm',
            'accept-language': 'en',
            addressdetails: 1
        });
        
        return `https://nominatim.openstreetmap.org/search?${params}`;
    },
    
    processAndFilterResults: function(data, location, city, type) {
        if (!data || data.length === 0) return [];
        
        const cityLower = city.toLowerCase();
        const processedResults = [];
        
        data.forEach(place => {
            try {
                const address = place.address || {};
                const placeCity = address.city || address.town || address.village || address.municipality;
                const placeCityLower = placeCity ? placeCity.toLowerCase() : '';
                
                if (city && !this.isInCity(place, cityLower, placeCityLower)) {
                    return;
                }
                
                let distance = 0;
                if (location) {
                    distance = this.calculateDistance(
                        location.lat, location.lng,
                        parseFloat(place.lat), parseFloat(place.lon)
                    );
                }
                
                const displayAddress = this.formatAddress(place, city);
                
                const result = {
                    id: place.place_id || `${place.lat}-${place.lon}`,
                    name: place.display_name.split(',')[0] || 'Unnamed Location',
                    address: displayAddress,
                    fullAddress: place.display_name,
                    lat: parseFloat(place.lat),
                    lng: parseFloat(place.lon),
                    type: place.type || place.class || 'unknown',
                    importance: place.importance || 0,
                    distance: distance,
                    city: placeCity || city,
                    placeType: place.type,
                    category: this.categorizePlace(place),
                    relevance: this.calculateRelevance(place, location, city, type),
                    boundingbox: place.boundingbox,
                    isVerified: this.isVerifiedLocation(place)
                };
                
                processedResults.push(result);
            } catch (error) {
                console.error('Error processing search result:', error, place);
            }
        });
        
        return processedResults
            .sort((a, b) => {
                if (a.isVerified !== b.isVerified) {
                    return b.isVerified - a.isVerified;
                }
                
                if (a.relevance !== b.relevance) {
                    return b.relevance - a.relevance;
                }
                
                if (location && a.distance !== b.distance) {
                    return a.distance - b.distance;
                }
                
                return b.importance - a.importance;
            })
            .slice(0, 10);
    },
    
    isInCity: function(place, targetCity, placeCity) {
        if (!targetCity) return true;
        
        if (placeCity && placeCity.includes(targetCity)) {
            return true;
        }
        
        const address = place.address || {};
        const components = [
            address.city,
            address.town,
            address.village,
            address.municipality,
            address.county,
            address.state_district
        ].filter(Boolean);
        
        return components.some(component => 
            component.toLowerCase().includes(targetCity)
        );
    },
    
    calculateRelevance: function(place, location, city, type) {
        let score = place.importance || 0;
        
        if (city) {
            const address = place.address || {};
            const placeCity = address.city || address.town || address.village;
            if (placeCity && placeCity.toLowerCase().includes(city.toLowerCase())) {
                score += 0.4;
            }
        }
        
        if (location) {
            const distance = this.calculateDistance(
                location.lat, location.lng,
                parseFloat(place.lat), parseFloat(place.lon)
            );
            
            if (distance < 1) score += 0.3;
            else if (distance < 3) score += 0.2;
            else if (distance < 5) score += 0.1;
            else if (distance < 10) score += 0.05;
        }
        
        if (place.display_name.split(',')[0].toLowerCase() === 
            AppState.lastSearchQuery?.toLowerCase()) {
            score += 0.5;
        }
        
        if (type === 'destination') {
            if (place.type === 'restaurant' || place.type === 'hotel' || 
                place.type === 'mall' || place.type === 'supermarket') {
                score += 0.2;
            }
        }
        
        return Math.min(score, 1.0);
    },
    
    formatAddress: function(place, currentCity) {
        const address = place.address || {};
        const parts = [];
        
        if (address.house_number || address.housenumber) {
            parts.push(address.house_number || address.housenumber);
        }
        
        if (address.road) {
            parts.push(address.road);
        }
        
        if (address.suburb || address.neighbourhood) {
            parts.push(address.suburb || address.neighbourhood);
        }
        
        if (address.city || address.town) {
            const cityName = address.city || address.town;
            if (cityName.toLowerCase() !== currentCity.toLowerCase()) {
                parts.push(cityName);
            }
        }
        
        if (parts.length === 0) {
            return place.display_name.split(',').slice(0, 2).join(',').trim();
        }
        
        return parts.join(', ');
    },
    
    categorizePlace: function(place) {
        const type = place.type || place.class || '';
        
        if (type.includes('restaurant') || type.includes('cafe') || type.includes('fast_food')) {
            return 'restaurant';
        } else if (type.includes('hotel') || type.includes('motel') || type.includes('guest_house')) {
            return 'hotel';
        } else if (type.includes('mall') || type.includes('supermarket') || type.includes('shop')) {
            return 'shopping';
        } else if (type.includes('bank') || type.includes('atm')) {
            return 'bank';
        } else if (type.includes('hospital') || type.includes('clinic') || type.includes('pharmacy')) {
            return 'medical';
        } else if (type.includes('school') || type.includes('university') || type.includes('college')) {
            return 'education';
        } else if (type.includes('government') || type.includes('office')) {
            return 'government';
        } else {
            return 'other';
        }
    },
    
    isVerifiedLocation: function(place) {
        const verifiedTypes = [
            'restaurant', 'hotel', 'mall', 'supermarket', 'bank', 'hospital',
            'clinic', 'school', 'university', 'government'
        ];
        
        const type = place.type || place.class || '';
        return verifiedTypes.some(verifiedType => type.includes(verifiedType));
    },
    
    calculateDistance: function(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = this.toRad(lat2 - lat1);
        const dLon = this.toRad(lon2 - lon1);
        const a = 
            Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(this.toRad(lat1)) * Math.cos(this.toRad(lat2)) * 
            Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    },
    
    toRad: function(value) {
        return value * Math.PI / 180;
    },
    
    localCitySearch: async function(query, city, location) {
        console.log(`Performing local search for "${query}" in ${city}`);
        
        try {
            const searchUrl = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}+${encodeURIComponent(city)}+Zambia&format=json&limit=10`;
            
            const response = await fetch(searchUrl);
            const data = await response.json();
            
            return data.map(place => ({
                id: place.place_id,
                name: place.display_name.split(',')[0],
                address: this.formatAddress(place, city),
                lat: parseFloat(place.lat),
                lng: parseFloat(place.lon),
                distance: location ? this.calculateDistance(location.lat, location.lng, parseFloat(place.lat), parseFloat(place.lon)) : 0
            }));
        } catch (error) {
            console.error('Local search error:', error);
            return [];
        }
    },
    
    searchShoppingPlaces: async function(category, city) {
        try {
            let query = '';
            switch(category) {
                case 'restaurants':
                    query = 'Pizza OR Nando\'s OR "Hungry Lion" restaurant';
                    break;
                case 'pharmacies':
                    query = 'pharmacy OR chemist';
                    break;
                case 'supermarkets':
                    query = 'supermarket OR grocery';
                    break;
                case 'malls':
                    query = 'shopping mall OR shopping center';
                    break;
            }
            
            const results = await this.search(query, 'pickup', AppState.userLocation, city);
            
            const filteredResults = results.filter(place => {
                if (category === 'restaurants') {
                    const name = place.name.toLowerCase();
                    return name.includes('pizza') || name.includes('nando') || name.includes('hungry lion');
                }
                return true;
            });
            
            return filteredResults.sort((a, b) => a.distance - b.distance);
        } catch (error) {
            console.error('Shopping search error:', error);
            return [];
        }
    },
    
    searchEmergencyStations: async function(type, city) {
        const cacheKey = `emergency-${type}-${city}`;
        
        if (this.cache.has(cacheKey)) {
            const cached = this.cache.get(cacheKey);
            if (Date.now() - cached.timestamp < 3600000) {
                return cached.results;
            }
        }
        
        try {
            let query = '';
            switch(type) {
                case 'police':
                    query = `police station ${city} Zambia`;
                    break;
                case 'fire':
                    query = `fire station ${city} Zambia`;
                    break;
                case 'medical':
                    query = `hospital ${city} Zambia clinic ${city} Zambia`;
                    break;
            }
            
            const params = new URLSearchParams({
                q: query,
                format: 'json',
                limit: 20,
                countrycodes: 'zm',
                'accept-language': 'en',
                addressdetails: 1
            });
            
            const searchUrl = `https://nominatim.openstreetmap.org/search?${params}`;
            const response = await fetch(searchUrl);
            
            if (!response.ok) throw new Error(`Emergency search failed: ${response.status}`);
            
            const data = await response.json();
            const results = data.map(place => ({
                id: place.place_id,
                name: place.display_name.split(',')[0],
                address: this.formatAddress(place, city),
                fullAddress: place.display_name,
                lat: parseFloat(place.lat),
                lng: parseFloat(place.lon),
                type: type,
                distance: AppState.userLocation ? 
                    this.calculateDistance(
                        AppState.userLocation.lat, AppState.userLocation.lng,
                        parseFloat(place.lat), parseFloat(place.lon)
                    ) : 0,
                verified: true
            })).sort((a, b) => a.distance - b.distance);
            
            this.cache.set(cacheKey, {
                results: results,
                timestamp: Date.now()
            });
            
            AppState.emergencyStations[type] = results;
            return results;
        } catch (error) {
            console.error('Emergency station search error:', error);
            return [];
        }
    },
    
    clearCache: function() {
        this.cache.clear();
        console.log('Search cache cleared');
    },
    
    getSearchHistory: function(type = null, city = null) {
        let history = this.searchHistory;
        
        if (type) {
            history = history.filter(item => item.type === type);
        }
        
        if (city) {
            history = history.filter(item => item.city === city);
        }
        
        return history;
    },
    
    clearSearchHistory: function() {
        this.searchHistory = [];
        this.saveSearchHistory();
        showToast('Search history cleared', 'success');
    }
};

// ============================================
// CITY DETECTOR
// ============================================
const CityDetector = {
    detectCityFromLocation: async function(latitude, longitude) {
        try {
            console.log(`Detecting city for coordinates: ${latitude}, ${longitude}`);
            
            const response = await fetch(
                `https://nominatim.openstreetmap.org/reverse?lat=${latitude}&lon=${longitude}&format=json&addressdetails=1`
            );
            
            if (!response.ok) {
                throw new Error(`Reverse geocoding failed: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('Reverse geocoding data:', data);
            
            const address = data.address;
            const city = address.city || address.town || address.village || address.municipality;
            
            if (city) {
                AppState.currentCity = city;
                document.getElementById('currentCityDisplay').textContent = `City: ${city}`;
                console.log(`City detected: ${city}`);
                return city;
            } else {
                throw new Error('No city found in address');
            }
        } catch (error) {
            console.error('City detection error:', error);
            return null;
        }
    },
    
    getDetailedAddress: async function(latitude, longitude) {
        try {
            const response = await fetch(
                `https://nominatim.openstreetmap.org/reverse?lat=${latitude}&lon=${longitude}&format=json&addressdetails=1`
            );
            
            if (!response.ok) {
                throw new Error(`Address lookup failed: ${response.status}`);
            }
            
            const data = await response.json();
            const address = data.address;
            
            const street = address.road || '';
            const suburb = address.suburb || '';
            const city = address.city || address.town || '';
            
            const displayAddress = [street, suburb].filter(Boolean).join(', ');
            const fullDisplay = [displayAddress, city].filter(Boolean).join(', ');
            
            return {
                address: displayAddress,
                fullDisplay: fullDisplay,
                city: city,
                fullAddress: data.display_name
            };
        } catch (error) {
            console.error('Address lookup error:', error);
            return {
                address: 'Unknown Location',
                fullDisplay: 'Unknown Location',
                city: null,
                fullAddress: 'Unknown Location'
            };
        }
    }
};

// ============================================
// ENHANCED PRICE CALCULATOR
// ============================================
const EnhancedPriceCalculator = {
    calculateRideFare: function(distanceKm, rideType = 'standard', surge = 1.0, timeOfDay = null) {
        const config = AppState.rideTypes[rideType] || AppState.rideTypes.standard;
        
        let fare = config.base + (distanceKm * config.perKm);
        
        fare *= config.multiplier;
        
        fare *= surge;
        
        if (!timeOfDay) {
            timeOfDay = new Date().getHours();
        }
        
        if (timeOfDay >= 22 || timeOfDay <= 5) {
            fare *= 1.2;
        } else if (timeOfDay >= 7 && timeOfDay <= 9) {
            fare *= 1.3;
        } else if (timeOfDay >= 16 && timeOfDay <= 19) {
            fare *= 1.4;
        }
        
        fare = Math.max(fare, config.min);
        
        return Math.round(fare * 100) / 100;
    },
    
    calculateEmergencyFare: function(distanceKm, serviceType, surge = 1.0) {
        const config = AppState.emergencyServices[serviceType] || AppState.emergencyServices.police;
        
        let fare = config.base + (distanceKm * config.perKm);
        fare *= config.multiplier;
        fare *= surge;
        fare = Math.max(fare, config.min);
        
        return Math.round(fare * 100) / 100;
    },
    
    calculateDeliveryFare: function(distanceKm, deliveryType = 'standard', parcelValue = 0) {
        const config = AppState.deliveryTypes[deliveryType] || AppState.deliveryTypes.standard;
        
        let fare = config.base + (distanceKm * config.perKm);
        fare *= config.multiplier;
        
        if (parcelValue > 500) {
            fare += parcelValue * 0.01;
        }
        
        return Math.round(fare * 100) / 100;
    },
    
    calculateTruckFare: function(distanceKm, truckType = 'light', helpers = false) {
        const config = AppState.truckTypes[truckType] || AppState.truckTypes.light;
        
        let fare = config.base + (distanceKm * config.perKm);
        fare *= config.multiplier;
        
        if (helpers) {
            fare += 50;
        }
        
        return Math.round(fare * 100) / 100;
    },
    
    calculateShoppingFare: function(distanceKm, itemsCount = 1, budget = 0) {
        let fare = 30 + (distanceKm * 2.5) + (itemsCount * 5);
        
        if (budget > 0) {
            fare += budget * 0.05;
        }
        
        return Math.round(fare * 100) / 100;
    },
    
    calculateDistance: function(lat1, lon1, lat2, lon2) {
        return EnhancedSearchEngine.calculateDistance(lat1, lon1, lat2, lon2);
    },
    
    estimateTime: function(distanceKm, rideType = 'standard', traffic = null) {
        const baseSpeed = rideType === 'premium' ? 45 : 35;
        let baseTime = (distanceKm / baseSpeed) * 60;
        
        if (!traffic) {
            traffic = this.getTrafficFactor();
        }
        
        baseTime *= traffic;
        
        if (rideType === 'premium') {
            baseTime += 2;
        } else {
            baseTime += 5;
        }
        
        return Math.ceil(baseTime);
    },
    
    getTrafficFactor: function() {
        const hour = new Date().getHours();
        const day = new Date().getDay();
        
        if (day >= 1 && day <= 5) {
            if ((hour >= 7 && hour <= 9) || (hour >= 16 && hour <= 19)) {
                return 1.5;
            }
        }
        
        if (day === 6 || day === 0) {
            if (hour >= 12 && hour <= 16) {
                return 1.3;
            }
        }
        
        return 1.0;
    },
    
    getSurgeMultiplier: function() {
        const hour = new Date().getHours();
        const day = new Date().getDay();
        
        if (day >= 1 && day <= 5) {
            if (hour >= 7 && hour <= 9) return 1.5;
            if (hour >= 16 && hour <= 19) return 1.8;
        }
        
        if (day === 5 || day === 6) {
            if (hour >= 20 && hour <= 23) return 2.0;
        }
        
        if (hour >= 22 || hour <= 5) return 1.8;
        
        return 1.0;
    },
    
    getFareBreakdown: function(distanceKm, rideType = 'standard', surge = 1.0) {
        const config = AppState.rideTypes[rideType] || AppState.rideTypes.standard;
        const baseFare = config.base;
        const distanceFare = distanceKm * config.perKm;
        const rideTypeMultiplier = config.multiplier;
        const surgeMultiplier = surge;
        const timeMultiplier = this.getTimeMultiplier();
        
        const subtotal = (baseFare + distanceFare) * rideTypeMultiplier;
        const surgeAmount = subtotal * (surgeMultiplier - 1);
        const timeAmount = subtotal * (timeMultiplier - 1);
        const total = subtotal * surgeMultiplier * timeMultiplier;
        
        return {
            baseFare: baseFare,
            distanceFare: distanceFare,
            rideTypeMultiplier: rideTypeMultiplier,
            surgeMultiplier: surgeMultiplier,
            timeMultiplier: timeMultiplier,
            surgeAmount: surgeAmount,
            timeAmount: timeAmount,
            subtotal: subtotal,
            total: Math.max(total, config.min)
        };
    },
    
    getTimeMultiplier: function() {
        const hour = new Date().getHours();
        if (hour >= 22 || hour <= 5) return 1.2;
        return 1.0;
    },
    
    calculateSplitRideFare: function(totalFare, splitType = 'equal', passengerCount = 2) {
        let yourShare = totalFare;
        let passengerShare = 0;
        
        switch(splitType) {
            case 'equal':
                yourShare = totalFare / passengerCount;
                passengerShare = totalFare / passengerCount;
                break;
            case 'you_pay_more':
                yourShare = totalFare * 0.7;
                passengerShare = totalFare * 0.3;
                break;
            case 'you_pay_all':
                yourShare = totalFare;
                passengerShare = 0;
                break;
        }
        
        return {
            total: totalFare,
            yourShare: yourShare,
            passengerShare: passengerShare,
            splitType: splitType
        };
    },
    
    calculateRouteWithStops: function(pickup, destination, stops) {
        let totalDistance = 0;
        let totalFare = 0;
        const routePoints = [pickup];
        
        if (stops && stops.length > 0) {
            let previousPoint = pickup;
            
            stops.forEach(stop => {
                const distance = this.calculateDistance(
                    previousPoint.lat, previousPoint.lng,
                    stop.lat, stop.lng
                );
                totalDistance += distance;
                routePoints.push(stop);
                previousPoint = stop;
            });
            
            const lastLegDistance = this.calculateDistance(
                previousPoint.lat, previousPoint.lng,
                destination.lat, destination.lng
            );
            totalDistance += lastLegDistance;
        } else {
            totalDistance = this.calculateDistance(
                pickup.lat, pickup.lng,
                destination.lat, destination.lng
            );
        }
        
        routePoints.push(destination);
        
        const surge = this.getSurgeMultiplier();
        totalFare = this.calculateRideFare(totalDistance, AppState.selectedRideType, surge);
        
        return {
            totalDistance: totalDistance,
            totalFare: totalFare,
            routePoints: routePoints
        };
    },
    
    applyReferralDiscount: function(fare) {
        if (AppState.referralDiscountApplied) {
            const discount = fare * 0.5;
            const discountedFare = fare - discount;
            return {
                originalFare: fare,
                discount: discount,
                finalFare: discountedFare,
                discountApplied: true
            };
        }
        return {
            originalFare: fare,
            discount: 0,
            finalFare: fare,
            discountApplied: false
        };
    }
};

// ============================================
// UI UPDATER
// ============================================
const UIUpdater = {
    updateWalletBalance: function(balance) {
        const formatted = `ZMW ${balance.toFixed(2)}`;
        const walletBalance = document.getElementById('walletBalance');
        const accountBalance = document.getElementById('accountBalance');
        const paymentBalance = document.getElementById('paymentBalance');
        const transferBalance = document.getElementById('transferBalance');
        
        if (walletBalance) walletBalance.textContent = formatted;
        if (accountBalance) accountBalance.textContent = formatted;
        if (paymentBalance) paymentBalance.textContent = formatted;
        if (transferBalance) transferBalance.textContent = formatted;
        
        AppState.walletBalance = balance;
    },
    
    updateUserInfo: function(userData) {
        if (userData.name) {
            const userFullName = document.getElementById('userFullName');
            const accountName = document.getElementById('accountName');
            if (userFullName) userFullName.textContent = userData.name;
            if (accountName) accountName.textContent = userData.name;
        }
        
        if (userData.phone) {
            const accountPhone = document.getElementById('accountPhone');
            if (accountPhone) accountPhone.textContent = userData.phone;
        }
        
        if (userData.email) {
            const updateEmail = document.getElementById('updateEmail');
            if (updateEmail) updateEmail.value = userData.email;
        }
        
        if (userData.referralCode) {
            const referralCode = document.getElementById('referralCode');
            if (referralCode) referralCode.textContent = userData.referralCode;
        }
    },
    
    updateRidePrices: function(distanceKm) {
        const types = ['economy', 'standard', 'premium'];
        const surge = EnhancedPriceCalculator.getSurgeMultiplier();
        
        types.forEach(type => {
            const price = EnhancedPriceCalculator.calculateRideFare(distanceKm, type, surge);
            const element = document.getElementById(`${type}Price`);
            if (element) {
                element.textContent = `ZMW ${price.toFixed(2)}`;
            }
        });
        
        const selectedPrice = EnhancedPriceCalculator.calculateRideFare(distanceKm, AppState.selectedRideType, surge);
        const estimatedFare = document.getElementById('estimatedFare');
        if (estimatedFare) estimatedFare.textContent = `ZMW ${selectedPrice.toFixed(2)}`;
        
        const time = EnhancedPriceCalculator.estimateTime(distanceKm, AppState.selectedRideType);
        const distanceDetail = document.getElementById('distanceDetail');
        const timeDetail = document.getElementById('timeDetail');
        
        if (distanceDetail) distanceDetail.textContent = `${distanceKm.toFixed(1)} km`;
        if (timeDetail) timeDetail.textContent = `ETA: ${time} min`;
        
        AppState.rideFare = selectedPrice;
    },
    
    updatePriceWithStops: function(pickup, destination, stops) {
        if (!pickup || !destination) return;
        
        const calculation = EnhancedPriceCalculator.calculateRouteWithStops(pickup, destination, stops);
        
        const estimatedFare = document.getElementById('estimatedFare');
        const distanceDetail = document.getElementById('distanceDetail');
        const timeDetail = document.getElementById('timeDetail');
        
        if (estimatedFare) estimatedFare.textContent = `ZMW ${calculation.totalFare.toFixed(2)}`;
        if (distanceDetail) distanceDetail.textContent = `${calculation.totalDistance.toFixed(1)} km`;
        if (timeDetail) timeDetail.textContent = `ETA: ${EnhancedPriceCalculator.estimateTime(calculation.totalDistance, AppState.selectedRideType)} min`;
        
        AppState.rideFare = calculation.totalFare;
        
        return calculation;
    },
    
    updateSplitRideCalculations: function(totalFare) {
        const passengerCount = AppState.shareRideFriends.length + 1;
        const calculation = EnhancedPriceCalculator.calculateSplitRideFare(totalFare, AppState.splitType, passengerCount);
        
        const shareTotalFare = document.getElementById('shareTotalFare');
        const shareYourShare = document.getElementById('shareYourShare');
        const shareFriendShare = document.getElementById('shareFriendShare');
        const shareCalculations = document.getElementById('shareCalculations');
        
        if (shareTotalFare) shareTotalFare.textContent = `ZMW ${calculation.total.toFixed(2)}`;
        if (shareYourShare) shareYourShare.textContent = `ZMW ${calculation.yourShare.toFixed(2)}`;
        if (shareFriendShare) shareFriendShare.textContent = `ZMW ${calculation.passengerShare.toFixed(2)}`;
        if (shareCalculations) shareCalculations.style.display = 'block';
        
        return calculation;
    },
    
    showSearchSuggestions: function(inputId, results, type = 'destination') {
        const container = document.getElementById(`${inputId}Suggestions`);
        if (!container) {
            console.error(`Suggestions container not found for ${inputId}`);
            return;
        }
        
        container.innerHTML = '';
        
        if (results.length === 0) {
            container.innerHTML = `
                <div class="no-results">
                    <i class="fas fa-search"></i>
                    <div>No results found in ${AppState.currentCity}</div>
                    <div style="font-size: 11px; color: #666; margin-top: 5px;">
                        Try a different search term
                    </div>
                </div>
            `;
        } else {
            results.forEach(result => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.dataset.lat = result.lat;
                item.dataset.lng = result.lng;
                item.dataset.address = result.address;
                item.dataset.name = result.name;
                
                let icon = 'fa-map-marker-alt';
                let iconColor = '#FF6B35';
                
                if (result.category === 'restaurant') {
                    icon = 'fa-utensils';
                    iconColor = '#FFC107';
                } else if (result.category === 'hotel') {
                    icon = 'fa-hotel';
                    iconColor = '#2196F3';
                } else if (result.category === 'shopping') {
                    icon = 'fa-shopping-cart';
                    iconColor = '#9C27B0';
                } else if (result.category === 'medical') {
                    icon = 'fa-hospital';
                    iconColor = '#F44336';
                } else if (result.category === 'education') {
                    icon = 'fa-graduation-cap';
                    iconColor = '#4CAF50';
                } else if (result.isVerified) {
                    icon = 'fa-check-circle';
                    iconColor = '#4CAF50';
                }
                
                item.innerHTML = `
                    <div class="suggestion-icon" style="color: ${iconColor}">
                        <i class="fas ${icon}"></i>
                    </div>
                    <div class="suggestion-details">
                        <div class="suggestion-name">${result.name}</div>
                        <div class="suggestion-address">${result.address}</div>
                        ${result.distance ? `<div class="suggestion-distance">${result.distance.toFixed(1)} km away</div>` : ''}
                        ${result.isVerified ? `<div class="suggestion-verified"><i class="fas fa-check-circle"></i> Verified</div>` : ''}
                    </div>
                `;
                
                item.addEventListener('click', () => {
                    this.selectLocation(inputId, result, type);
                });
                
                container.appendChild(item);
            });
            
            const cityNote = document.createElement('div');
            cityNote.className = 'city-search-note';
            cityNote.innerHTML = `
                <i class="fas fa-city"></i>
                <span>Searching within ${AppState.currentCity}</span>
            `;
            container.appendChild(cityNote);
        }
        
        container.style.display = 'block';
        
        const input = document.getElementById(inputId);
        if (input) {
            const rect = input.getBoundingClientRect();
            container.style.top = `${rect.bottom + window.scrollY}px`;
            container.style.left = `${rect.left + window.scrollX}px`;
            container.style.width = `${rect.width}px`;
        }
    },
    
    selectLocation: function(inputId, location, type) {
        const input = document.getElementById(inputId);
        
        if (!location || !input) return;
        
        input.value = location.address || location.name;
        
        if (type === 'pickup') {
            AppState.pickup = location;
            this.updatePickupMarker(location);
        } else {
            AppState.destination = location;
            this.updateDestinationMarker(location);
        }
        
        const suggestions = document.getElementById(`${inputId}Suggestions`);
        if (suggestions) {
            suggestions.style.display = 'none';
        }
        
        if (AppState.pickup && AppState.destination) {
            this.drawRoute(AppState.pickup, AppState.destination, AppState.rideStops);
            this.updatePriceWithStops(AppState.pickup, AppState.destination, AppState.rideStops);
        }
    },
    
    updatePickupMarker: function(location) {
        if (!map) return;
        
        if (pickupMarker) {
            pickupMarker.setLatLng([location.lat, location.lng]);
        } else {
            pickupMarker = L.marker([location.lat, location.lng], {
                icon: L.divIcon({
                    className: 'pickup-marker',
                    html: '<i class="fas fa-map-marker-alt"></i>',
                    iconSize: [20, 20],
                    iconAnchor: [10, 20]
                })
            }).addTo(map).bindPopup('Pickup Location');
        }
        
        if (!AppState.destination) {
            map.setView([location.lat, location.lng], 15);
        }
    },
    
    updateDestinationMarker: function(location) {
        if (!map) return;
        
        if (destinationMarker) {
            destinationMarker.setLatLng([location.lat, location.lng]);
        } else {
            destinationMarker = L.marker([location.lat, location.lng], {
                icon: L.divIcon({
                    className: 'destination-marker',
                    html: '<i class="fas fa-flag"></i>',
                    iconSize: [20, 20],
                    iconAnchor: [10, 20]
                })
            }).addTo(map).bindPopup('Destination');
        }
    },
    
    drawRoute: async function(start, end, stops = []) {
        if (!map) return;
        
        if (routeLayer) {
            map.removeLayer(routeLayer);
        }
        
        stopMarkers.forEach(marker => map.removeLayer(marker));
        stopMarkers = [];
        
        try {
            let waypoints = [];
            if (stops && stops.length > 0) {
                waypoints = stops.map(stop => L.latLng(stop.lat, stop.lng));
            }
            
            const routeCoordinates = [L.latLng(start.lat, start.lng)];
            if (waypoints.length > 0) {
                routeCoordinates.push(...waypoints);
            }
            routeCoordinates.push(L.latLng(end.lat, end.lng));
            
            routeLayer = L.polyline(routeCoordinates, {
                color: '#FF6B35',
                weight: 4,
                opacity: 0.7,
                lineJoin: 'round',
                lineCap: 'round'
            }).addTo(map);
            
            stops.forEach((stop, index) => {
                const marker = L.marker([stop.lat, stop.lng], {
                    icon: L.divIcon({
                        className: 'stop-marker',
                        html: `<div>${index + 1}</div>`,
                        iconSize: [24, 24],
                        iconAnchor: [12, 24]
                    })
                }).addTo(map).bindPopup(`Stop ${index + 1}: ${stop.name}`);
                stopMarkers.push(marker);
            });
            
            const bounds = L.latLngBounds(routeCoordinates);
            map.fitBounds(bounds, { padding: [50, 50] });
            
            return true;
        } catch (error) {
            console.error('Route drawing error:', error);
            return false;
        }
    },
    
    showRideInfo: function(ride) {
        document.querySelectorAll('.ride-request-form, .service-form, #broadcastForm').forEach(form => {
            form.style.display = 'none';
        });
        
        const rideInfoPanel = document.getElementById('rideInfoPanel');
        if (rideInfoPanel) {
            rideInfoPanel.style.display = 'block';
        }
        
        const currentPickup = document.getElementById('currentPickup');
        const currentDestination = document.getElementById('currentDestination');
        
        if (currentPickup) currentPickup.textContent = ride.pickupDisplay || ride.pickup || 'Loading...';
        if (currentDestination) currentDestination.textContent = ride.destinationDisplay || ride.destination || 'Loading...';
        
        this.updateRideStatus(ride.status);
        this.updateTimeline(ride.status);
    },
    
    updateRideStatus: function(status) {
        const statusBar = document.getElementById('rideStatusBar');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const etaText = document.getElementById('etaText');
        
        if (!statusBar || !statusDot || !statusText || !etaText) return;
        
        statusBar.style.display = 'flex';
        
        switch(status) {
            case 'requested':
                statusDot.className = 'status-dot searching';
                statusText.textContent = 'Searching for driver';
                etaText.textContent = '5-10 min';
                this.showPulsingRideIcon();
                break;
            case 'accepted':
                statusDot.className = 'status-dot arriving';
                statusText.textContent = 'Driver on the way';
                etaText.textContent = '5 min';
                this.removePulsingRideIcon();
                break;
            case 'arrived':
                statusDot.className = 'status-dot riding';
                statusText.textContent = 'Driver arrived';
                etaText.textContent = '0 min';
                break;
            case 'started':
                statusDot.className = 'status-dot riding';
                statusText.textContent = 'Trip in progress';
                etaText.textContent = 'En route';
                break;
            case 'completed':
            case 'cancelled':
                statusBar.style.display = 'none';
                this.removePulsingRideIcon();
                break;
        }
    },
    
    showPulsingRideIcon: function() {
        this.removePulsingRideIcon();
        
        let iconClass = 'fa-car';
        if (AppState.activeService === 'truck') {
            iconClass = 'fa-truck';
        } else if (AppState.activeService === 'delivery' || AppState.activeService === 'short-delivery') {
            iconClass = 'fa-bicycle';
        }
        
        pulsingIcon = document.createElement('div');
        pulsingIcon.id = 'pulsingRideIcon';
        pulsingIcon.className = 'pulsing-ride-icon';
        pulsingIcon.innerHTML = `<i class="fas ${iconClass}"></i>`;
        pulsingIcon.style.cssText = `
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 60px;
            color: #FF6B35;
            z-index: 1000;
            animation: pulse 1.5s infinite;
            pointer-events: none;
        `;
        
        const mapContainer = document.getElementById('map');
        if (mapContainer) {
            mapContainer.appendChild(pulsingIcon);
        }
    },
    
    removePulsingRideIcon: function() {
        const pulsingIcon = document.getElementById('pulsingRideIcon');
        if (pulsingIcon) {
            pulsingIcon.remove();
        }
    },
    
    updateTimeline: function(status) {
        const steps = ['stepRequested', 'stepAccepted', 'stepArrived', 'stepStarted', 'stepCompleted'];
        const stepLabels = ['Requested', 'Accepted', 'Arrived', 'Started', 'Completed'];
        let currentIndex = stepLabels.indexOf(status);
        
        if (currentIndex === -1) {
            currentIndex = 0;
        }
        
        steps.forEach((stepId, index) => {
            const step = document.getElementById(stepId);
            const label = step?.parentNode.querySelector('.step-label');
            
            if (step && label) {
                if (index < currentIndex) {
                    step.className = 'step-dot completed';
                    label.className = 'step-label';
                } else if (index === currentIndex) {
                    step.className = 'step-dot active';
                    label.className = 'step-label active';
                } else {
                    step.className = 'step-dot';
                    label.className = 'step-label';
                }
            }
        });
    },
    
    showStops: function() {
        const stopsContainer = document.getElementById('stopsContainer');
        const stopsList = document.getElementById('rideStopsList');
        
        if (!stopsContainer || !stopsList) return;
        
        stopsList.innerHTML = '';
        
        if (AppState.rideStops.length === 0) {
            stopsContainer.style.display = 'none';
            return;
        }
        
        stopsContainer.style.display = 'block';
        
        AppState.rideStops.forEach((stop, index) => {
            const stopElement = document.createElement('div');
            stopElement.className = 'stop-item';
            stopElement.innerHTML = `
                <div class="stop-number">${index + 1}</div>
                <div class="stop-details">
                    <div class="stop-name">${stop.name || 'Stop'}</div>
                    <div class="stop-address">${stop.address}</div>
                </div>
                <button class="remove-stop-btn" data-index="${index}">
                    <i class="fas fa-times"></i>
                </button>
            `;
            stopsList.appendChild(stopElement);
            
            stopElement.querySelector('.remove-stop-btn').addEventListener('click', (e) => {
                const index = parseInt(e.target.closest('.remove-stop-btn').dataset.index);
                removeStop(index);
            });
        });
    },
    
    showShoppingPlaces: function(places, category) {
        const shopsList = document.getElementById('shopsList');
        if (!shopsList) return;
        
        shopsList.innerHTML = '';
        
        if (places.length === 0) {
            shopsList.innerHTML = `
                <div class="no-results">
                    <i class="fas fa-store"></i>
                    <div>No ${category} found in ${AppState.currentCity}</div>
                </div>
            `;
            return;
        }
        
        places.forEach(place => {
            const shopElement = document.createElement('div');
            shopElement.className = 'shop-item';
            shopElement.innerHTML = `
                <div class="shop-icon">
                    <i class="fas fa-${category === 'restaurants' ? 'utensils' : category === 'pharmacies' ? 'prescription-bottle' : category === 'supermarkets' ? 'shopping-cart' : 'store'}"></i>
                </div>
                <div class="shop-details">
                    <div class="shop-name">${place.name}</div>
                    <div class="shop-address">${place.address}</div>
                    <div class="shop-distance">${place.distance.toFixed(1)} km away</div>
                </div>
            `;
            
            shopElement.addEventListener('click', () => {
                document.getElementById('shopName').value = place.name;
                document.getElementById('shopLocation').value = place.address;
                AppState.pickup = place;
                hideModal('shoppingCategories');
                updatePickupMarker(place);
            });
            
            shopsList.appendChild(shopElement);
        });
    },
    
    showEmergencyStations: function(stations) {
        const container = document.getElementById('emergencyStations');
        if (!container) return;
        
        container.innerHTML = '';
        
        if (stations.length === 0) {
            container.innerHTML = '<div class="no-results">No emergency stations found in your city</div>';
            return;
        }
        
        stations.forEach(station => {
            const stationElement = document.createElement('div');
            stationElement.className = 'emergency-station';
            stationElement.dataset.lat = station.lat;
            stationElement.dataset.lng = station.lng;
            
            stationElement.innerHTML = `
                <div class="station-header">
                    <div class="station-name">${station.name}</div>
                    <div class="station-distance">${station.distance.toFixed(1)} km</div>
                </div>
                <div class="station-address">${station.address}</div>
            `;
            
            stationElement.addEventListener('click', () => {
                document.querySelectorAll('.emergency-station').forEach(s => {
                    s.classList.remove('selected');
                });
                stationElement.classList.add('selected');
                
                const emergencyType = document.getElementById('emergencyServiceType').dataset.type;
                const distance = station.distance;
                const fare = EnhancedPriceCalculator.calculateEmergencyFare(distance, emergencyType);
                
                document.getElementById('emergencyDistance').textContent = `${distance.toFixed(1)} km`;
                document.getElementById('emergencyTotalFare').textContent = `ZMW ${fare.toFixed(2)}`;
            });
            
            container.appendChild(stationElement);
        });
        
        if (stations.length > 0) {
            container.querySelector('.emergency-station').classList.add('selected');
            const firstStation = stations[0];
            const emergencyType = document.getElementById('emergencyServiceType').dataset.type;
            const fare = EnhancedPriceCalculator.calculateEmergencyFare(firstStation.distance, emergencyType);
            
            document.getElementById('emergencyDistance').textContent = `${firstStation.distance.toFixed(1)} km`;
            document.getElementById('emergencyTotalFare').textContent = `ZMW ${fare.toFixed(2)}`;
        }
    },
    
    updateShareFriendsList: function() {
        const container = document.getElementById('shareFriendsList');
        if (!container) return;
        
        container.innerHTML = '';
        
        if (AppState.shareRideFriends.length === 0) {
            container.innerHTML = '<div class="empty-share">Add friends using referral codes</div>';
            return;
        }
        
        AppState.shareRideFriends.forEach(friend => {
            const friendElement = document.createElement('div');
            friendElement.className = 'share-friend-item';
            friendElement.innerHTML = `
                <div class="friend-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="friend-info">
                    <div class="friend-name">${friend.name}</div>
                    <div class="friend-code">${friend.code}</div>
                </div>
                <button class="remove-friend-btn" data-code="${friend.code}">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.appendChild(friendElement);
            
            friendElement.querySelector('.remove-friend-btn').addEventListener('click', (e) => {
                const code = e.target.closest('.remove-friend-btn').dataset.code;
                removeShareFriend(code);
            });
        });
        
        if (AppState.pickup && AppState.destination) {
            const distance = EnhancedPriceCalculator.calculateDistance(
                AppState.pickup.lat, AppState.pickup.lng,
                AppState.destination.lat, AppState.destination.lng
            );
            const totalFare = EnhancedPriceCalculator.calculateRideFare(distance, AppState.selectedRideType);
            this.updateSplitRideCalculations(totalFare);
        }
    },
    
    updateBroadcastFriendsList: function() {
        const container = document.getElementById('broadcastFriendsList');
        if (!container) return;
        
        container.innerHTML = '';
        
        if (AppState.broadcastRecipients.length === 0) {
            container.innerHTML = '<div class="empty-share">Add friends using referral codes</div>';
            return;
        }
        
        AppState.broadcastRecipients.forEach(friend => {
            const friendElement = document.createElement('div');
            friendElement.className = 'broadcast-friend-item';
            friendElement.innerHTML = `
                <div class="friend-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="friend-info">
                    <div class="friend-name">${friend.name}</div>
                    <div class="friend-code">${friend.code}</div>
                </div>
            `;
            container.appendChild(friendElement);
        });
    }
};

// ============================================
// FIREBASE MANAGER
// ============================================
const FirebaseManager = {
    async loadUserData(uid) {
        try {
            console.log(`Loading user data for UID: ${uid}`);
            showLoading('Loading your profile...');
            
            const snapshot = await database.ref(`users/${uid}`).once('value');
            AppState.userData = snapshot.val();
            
            if (AppState.userData) {
                console.log('User data loaded successfully:', AppState.userData);
                
                AppState.walletBalance = AppState.userData.walletBalance || 0;
                UIUpdater.updateWalletBalance(AppState.walletBalance);
                UIUpdater.updateUserInfo(AppState.userData);
                
                this.startRealtimeListeners(uid);
                
                showToast('Profile loaded successfully', 'success');
                return true;
            } else {
                console.warn('No user data found');
                return false;
            }
        } catch (error) {
            console.error('Error loading user data:', error);
            showToast('Error loading user data', 'error');
            return false;
        } finally {
            hideLoading();
        }
    },
    
    startRealtimeListeners: function(uid) {
        console.log('Starting real-time listeners for user:', uid);
        
        const userRef = database.ref(`users/${uid}`);
        userRef.on('value', (snapshot) => {
            const userData = snapshot.val();
            if (userData) {
                AppState.userData = userData;
                AppState.walletBalance = userData.walletBalance || 0;
                UIUpdater.updateWalletBalance(AppState.walletBalance);
                UIUpdater.updateUserInfo(userData);
            }
        });
        
        const activeRideRef = database.ref('rides')
            .orderByChild('passengerId')
            .equalTo(uid)
            .orderByChild('status')
            .startAt('requested')
            .endAt('started')
            .limitToLast(1);
        
        activeRideRef.on('value', (snapshot) => {
            const rides = snapshot.val();
            if (rides) {
                const rideId = Object.keys(rides)[0];
                const ride = { id: rideId, ...rides[rideId] };
                
                if (!AppState.currentRide || AppState.currentRide.id !== rideId) {
                    console.log('Active ride detected:', rideId);
                    AppState.currentRide = ride;
                    UIUpdater.showRideInfo(ride);
                }
            } else if (AppState.currentRide) {
                console.log('Active ride ended');
                AppState.currentRide = null;
                switchScreen('home');
            }
        });
        
        const notificationsRef = database.ref(`notifications/${uid}`)
            .orderByChild('timestamp')
            .limitToLast(20);
        
        notificationsRef.on('value', (snapshot) => {
            const notifications = snapshot.val();
            if (notifications) {
                AppState.notifications = Object.values(notifications).reverse();
                const unreadCount = AppState.notifications.filter(n => !n.read).length;
                AppState.unreadNotifications = unreadCount;
                updateNotificationBadge(unreadCount);
            }
        });
        
        showToast('Real-time updates active', 'success');
    },
    
    async requestRide(rideData) {
        try {
            showLoading('Requesting ride...');
            
            const rideId = database.ref().child('rides').push().key;
            
            const ride = {
                id: rideId,
                ...rideData,
                status: 'requested',
                timestamp: Date.now(),
                passengerId: AppState.currentUser.uid,
                passengerName: AppState.userData.name,
                city: AppState.currentCity
            };
            
            console.log('Creating ride:', rideId);
            await database.ref(`rides/${rideId}`).set(ride);
            
            AppState.currentRide = ride;
            UIUpdater.showRideInfo(ride);
            
            hideLoading();
            showToast('Ride requested successfully', 'success');
            
            return rideId;
        } catch (error) {
            console.error('Error requesting ride:', error);
            hideLoading();
            showToast('Error requesting ride', 'error');
            throw error;
        }
    },
    
    async cancelRide(rideId, reason) {
        try {
            showLoading('Cancelling ride...');
            
            await database.ref(`rides/${rideId}/status`).set('cancelled');
            await database.ref(`rides/${rideId}/cancellationReason`).set(reason);
            await database.ref(`rides/${rideId}/cancelledAt`).set(Date.now());
            
            if (AppState.currentRide && AppState.currentRide.paymentMethod === 'wallet') {
                await this.refundRidePayment(AppState.currentRide);
            }
            
            AppState.currentRide = null;
            
            hideLoading();
            showToast('Ride cancelled successfully', 'success');
            switchScreen('home');
            
        } catch (error) {
            console.error('Error cancelling ride:', error);
            hideLoading();
            showToast('Error cancelling ride', 'error');
        }
    },
    
    async refundRidePayment(ride) {
        try {
            const refundAmount = ride.fare;
            const transactionId = database.ref().child('transactions').push().key;
            
            const transaction = {
                id: transactionId,
                userId: AppState.currentUser.uid,
                type: 'refund',
                amount: refundAmount,
                timestamp: Date.now(),
                rideId: ride.id,
                description: `Refund for cancelled ride ${ride.id}`
            };
            
            await database.ref(`transactions/${AppState.currentUser.uid}/${transactionId}`).set(transaction);
            
            const newBalance = AppState.walletBalance + refundAmount;
            await database.ref(`users/${AppState.currentUser.uid}/walletBalance`).set(newBalance);
            
            AppState.walletBalance = newBalance;
            UIUpdater.updateWalletBalance(newBalance);
            
            showToast(`ZMW ${refundAmount.toFixed(2)} refunded to your wallet`, 'success');
        } catch (error) {
            console.error('Error processing refund:', error);
        }
    },
    
    async validateReferralCode(referralCode) {
        try {
            const snapshot = await database.ref('users').orderByChild('referralCode').equalTo(referralCode).once('value');
            const users = snapshot.val();
            
            if (users) {
                const userId = Object.keys(users)[0];
                const userData = users[userId];
                return {
                    valid: true,
                    userId: userId,
                    name: userData.name,
                    phone: userData.phone
                };
            }
            
            return { valid: false };
        } catch (error) {
            console.error('Error validating referral code:', error);
            return { valid: false };
        }
    },
    
    async findUserByReferralCode(referralCode) {
        try {
            const snapshot = await database.ref('users').orderByChild('referralCode').equalTo(referralCode).once('value');
            const users = snapshot.val();
            
            if (users) {
                const userId = Object.keys(users)[0];
                return {
                    id: userId,
                    ...users[userId]
                };
            }
            
            return null;
        } catch (error) {
            console.error('Error finding user by referral code:', error);
            return null;
        }
    },
    
    async sendNotification(userId, title, message, type = 'info', data = {}) {
        try {
            const notificationId = database.ref().child('notifications').push().key;
            
            const notification = {
                id: notificationId,
                title: title,
                message: message,
                type: type,
                data: data,
                read: false,
                timestamp: Date.now()
            };
            
            await database.ref(`notifications/${userId}/${notificationId}`).set(notification);
            
            return notificationId;
        } catch (error) {
            console.error('Error sending notification:', error);
        }
    },
    
    async createShareRideInvitation(rideId, hostId, hostName, recipientId, rideDetails, shareAmount) {
        try {
            const invitationId = database.ref().child('shareRideInvitations').push().key;
            
            const invitation = {
                id: invitationId,
                rideId: rideId,
                hostId: hostId,
                hostName: hostName,
                recipientId: recipientId,
                rideDetails: rideDetails,
                shareAmount: shareAmount,
                status: 'pending',
                timestamp: Date.now()
            };
            
            await database.ref(`shareRideInvitations/${invitationId}`).set(invitation);
            
            await this.sendNotification(
                recipientId,
                'Share Ride Invitation',
                `${hostName} has invited you to share a ride`,
                'share',
                { invitationId: invitationId, rideId: rideId }
            );
            
            return invitationId;
        } catch (error) {
            console.error('Error creating share ride invitation:', error);
        }
    },
    
    async createBroadcastInvitation(rideId, hostId, hostName, recipientId, rideDetails) {
        try {
            const invitationId = database.ref().child('broadcastInvitations').push().key;
            
            const invitation = {
                id: invitationId,
                rideId: rideId,
                hostId: hostId,
                hostName: hostName,
                recipientId: recipientId,
                rideDetails: rideDetails,
                status: 'pending',
                timestamp: Date.now()
            };
            
            await database.ref(`broadcastInvitations/${invitationId}`).set(invitation);
            
            await this.sendNotification(
                recipientId,
                'Broadcast Ride Invitation',
                `${hostName} has invited you to track their ride`,
                'broadcast',
                { invitationId: invitationId, rideId: rideId }
            );
            
            return invitationId;
        } catch (error) {
            console.error('Error creating broadcast invitation:', error);
        }
    },
    
    async processPayment(userId, amount, type, description, rideId = null) {
        try {
            const transactionId = database.ref().child('transactions').push().key;
            
            const transaction = {
                id: transactionId,
                userId: userId,
                type: type,
                amount: amount,
                description: description,
                rideId: rideId,
                timestamp: Date.now()
            };
            
            await database.ref(`transactions/${userId}/${transactionId}`).set(transaction);
            
            if (type === 'payment' || type === 'withdrawal') {
                const userRef = database.ref(`users/${userId}`);
                const snapshot = await userRef.once('value');
                const userData = snapshot.val();
                const currentBalance = userData.walletBalance || 0;
                const newBalance = type === 'payment' ? currentBalance - amount : currentBalance + amount;
                
                await userRef.update({ walletBalance: newBalance });
                
                AppState.walletBalance = newBalance;
                UIUpdater.updateWalletBalance(newBalance);
            }
            
            return transactionId;
        } catch (error) {
            console.error('Error processing payment:', error);
            throw error;
        }
    },
    
    async transferMoney(senderId, recipientCode, amount, message = '') {
        try {
            showLoading('Processing transfer...');
            
            const recipientData = await this.findUserByReferralCode(recipientCode);
            if (!recipientData) {
                throw new Error('Recipient not found');
            }
            
            if (AppState.walletBalance < amount) {
                throw new Error('Insufficient balance');
            }
            
            await this.processPayment(senderId, amount, 'transfer_out', `Transfer to ${recipientData.name}: ${message}`);
            await this.processPayment(recipientData.id, amount, 'transfer_in', `Transfer from ${AppState.userData.name}: ${message}`);
            
            await this.sendNotification(
                recipientData.id,
                'Money Received',
                `${AppState.userData.name} sent you ZMW ${amount.toFixed(2)}`,
                'payment',
                { amount: amount, senderName: AppState.userData.name }
            );
            
            hideLoading();
            showToast(`ZMW ${amount.toFixed(2)} transferred successfully`, 'success');
            
            return true;
        } catch (error) {
            console.error('Error transferring money:', error);
            hideLoading();
            showToast(error.message, 'error');
            return false;
        }
    },
    
    async loadRideHistory(uid) {
        try {
            showLoading('Loading ride history...');
            
            const snapshot = await database.ref('rides')
                .orderByChild('passengerId')
                .equalTo(uid)
                .once('value');
            
            const rides = snapshot.val();
            if (rides) {
                const ridesArray = Object.keys(rides).map(id => ({
                    id,
                    ...rides[id]
                })).sort((a, b) => b.timestamp - a.timestamp);
                
                displayRideHistory(ridesArray);
            }
            
            hideLoading();
        } catch (error) {
            console.error('Error loading ride history:', error);
            hideLoading();
        }
    },
    
    async loadWalletTransactions(uid) {
        try {
            showLoading('Loading transactions...');
            
            const snapshot = await database.ref(`transactions/${uid}`)
                .orderByChild('timestamp')
                .limitToLast(50)
                .once('value');
            
            const transactions = snapshot.val();
            if (transactions) {
                const transactionsArray = Object.values(transactions).sort((a, b) => b.timestamp - a.timestamp);
                displayTransactions(transactionsArray);
            }
            
            hideLoading();
        } catch (error) {
            console.error('Error loading transactions:', error);
            hideLoading();
        }
    }
};

// ============================================
// CORE APPLICATION FUNCTIONS
// ============================================
function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) return;
    
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `
        <div class="toast-content">
            <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'}"></i>
            <span>${message}</span>
        </div>
    `;
    
    toastContainer.appendChild(toast);
    
    setTimeout(() => {
        toast.classList.add('fade-out');
        setTimeout(() => {
            toast.remove();
        }, 300);
    }, 3000);
}

function showLoading(message = 'Loading...') {
    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingText = document.getElementById('loadingText');
    
    if (loadingOverlay && loadingText) {
        loadingText.textContent = message;
        loadingOverlay.style.display = 'flex';
    }
}

function hideLoading() {
    const loadingOverlay = document.getElementById('loadingOverlay');
    if (loadingOverlay) {
        loadingOverlay.style.display = 'none';
    }
}

function showModal(modalId) {
    const modal = document.getElementById(`${modalId}Modal`);
    if (modal) {
        modal.style.display = 'block';
        
        if (modalId === 'payment') {
            const paymentAmount = document.getElementById('paymentAmount');
            if (paymentAmount) {
                paymentAmount.textContent = `ZMW ${AppState.rideFare.toFixed(2)}`;
            }
            
            const referralSection = document.getElementById('referralDiscountSection');
            if (referralSection) {
                referralSection.style.display = 'block';
            }
        }
    }
}

function hideModal(modalId) {
    const modal = document.getElementById(`${modalId}Modal`);
    if (modal) {
        modal.style.display = 'none';
    }
}

function switchScreen(screen) {
    document.querySelectorAll('.history-screen, .account-screen, .emergency-screen').forEach(s => {
        s.style.display = 'none';
    });
    
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    if (screen === 'home') {
        document.getElementById('homeContent').style.display = 'block';
        document.querySelector('.nav-tab[data-screen="home"]').classList.add('active');
    } else {
        const screenElement = document.getElementById(`${screen}Screen`);
        if (screenElement) {
            screenElement.style.display = 'block';
            document.querySelector(`.nav-tab[data-screen="${screen}"]`).classList.add('active');
            
            if (screen === 'history') {
                FirebaseManager.loadRideHistory(AppState.currentUser.uid);
            }
        }
    }
    
    AppState.activeScreen = screen;
}

function switchService(service) {
    document.querySelectorAll('.ride-request-form, .service-form, #broadcastForm').forEach(form => {
        form.style.display = 'none';
    });
    
    document.querySelectorAll('.service-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    AppState.activeService = service;
    
    switch(service) {
        case 'car':
            document.querySelector('.service-tab.car').classList.add('active');
            document.getElementById('carForm').style.display = 'block';
            break;
        case 'delivery':
            document.querySelector('.service-tab.delivery').classList.add('active');
            document.getElementById('deliveryForm').style.display = 'block';
            break;
        case 'short-delivery':
            document.querySelector('.service-tab.short-delivery').classList.add('active');
            document.getElementById('shortDeliveryForm').style.display = 'block';
            break;
        case 'express':
            document.querySelector('.service-tab[data-service="express"]').classList.add('active');
            document.getElementById('expressForm').style.display = 'block';
            break;
        case 'truck':
            document.querySelector('.service-tab[data-service="truck"]').classList.add('active');
            document.getElementById('truckForm').style.display = 'block';
            break;
        case 'broadcast':
            document.getElementById('broadcastForm').style.display = 'block';
            break;
    }
}

function addStop() {
    if (!AppState.pickup || !AppState.destination) {
        showToast('Please set pickup and destination first', 'warning');
        return;
    }
    
    if (AppState.rideStops.length >= 3) {
        showToast('Maximum 3 stops allowed', 'warning');
        return;
    }
    
    const stop = {
        id: `stop_${Date.now()}`,
        name: `Stop ${AppState.rideStops.length + 1}`,
        address: '',
        lat: null,
        lng: null
    };
    
    AppState.rideStops.push(stop);
    UIUpdater.showStops();
    
    const stopInput = document.createElement('div');
    stopInput.className = 'location-input stop-input';
    stopInput.innerHTML = `
        <i class="fas fa-map-pin"></i>
        <input type="text" class="stop-location-input" placeholder="Stop location" data-stop-id="${stop.id}">
        <div class="suggestion-list stop-suggestions" id="stopSuggestions_${stop.id}"></div>
    `;
    
    document.getElementById('stopsContainer').appendChild(stopInput);
    
    const input = stopInput.querySelector('input');
    input.addEventListener('input', debounce(async (e) => {
        const query = e.target.value;
        if (query.length < 2) return;
        
        const results = await EnhancedSearchEngine.search(query, 'destination', AppState.userLocation, AppState.currentCity);
        
        const suggestions = document.getElementById(`stopSuggestions_${stop.id}`);
        if (suggestions) {
            suggestions.innerHTML = '';
            
            results.forEach(result => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.innerHTML = `
                    <div class="suggestion-icon">
                        <i class="fas fa-map-marker-alt"></i>
                    </div>
                    <div class="suggestion-details">
                        <div class="suggestion-name">${result.name}</div>
                        <div class="suggestion-address">${result.address}</div>
                    </div>
                `;
                
                item.addEventListener('click', () => {
                    input.value = result.address;
                    suggestions.style.display = 'none';
                    
                    const stopIndex = AppState.rideStops.findIndex(s => s.id === stop.id);
                    if (stopIndex !== -1) {
                        AppState.rideStops[stopIndex] = {
                            ...AppState.rideStops[stopIndex],
                            name: result.name,
                            address: result.address,
                            lat: result.lat,
                            lng: result.lng
                        };
                        
                        UIUpdater.drawRoute(AppState.pickup, AppState.destination, AppState.rideStops);
                        UIUpdater.updatePriceWithStops(AppState.pickup, AppState.destination, AppState.rideStops);
                        UIUpdater.showStops();
                    }
                });
                
                suggestions.appendChild(item);
            });
            
            suggestions.style.display = 'block';
        }
    }, 300));
}

function removeStop(index) {
    AppState.rideStops.splice(index, 1);
    UIUpdater.showStops();
    
    if (AppState.pickup && AppState.destination) {
        UIUpdater.drawRoute(AppState.pickup, AppState.destination, AppState.rideStops);
        UIUpdater.updatePriceWithStops(AppState.pickup, AppState.destination, AppState.rideStops);
    }
}

async function addShareFriend() {
    const input = document.getElementById('shareMemberInput');
    const code = input.value.trim();
    
    if (!code) {
        showToast('Please enter a referral code', 'warning');
        return;
    }
    
    if (AppState.shareRideFriends.length >= AppState.maxShareFriends) {
        showToast(`Maximum ${AppState.maxShareFriends} friends allowed`, 'warning');
        return;
    }
    
    if (AppState.shareRideFriends.some(f => f.code === code)) {
        showToast('Friend already added', 'warning');
        return;
    }
    
    showLoading('Adding friend...');
    
    const friendData = await FirebaseManager.findUserByReferralCode(code);
    
    if (friendData) {
        const friend = {
            code: code,
            name: friendData.name,
            userId: friendData.id
        };
        
        AppState.shareRideFriends.push(friend);
        UIUpdater.updateShareFriendsList();
        input.value = '';
        showToast(`${friend.name} added to ride`, 'success');
    } else {
        showToast('Friend not found. Please check the referral code.', 'error');
    }
    
    hideLoading();
}

function removeShareFriend(code) {
    AppState.shareRideFriends = AppState.shareRideFriends.filter(f => f.code !== code);
    UIUpdater.updateShareFriendsList();
    
    if (AppState.pickup && AppState.destination) {
        const distance = EnhancedPriceCalculator.calculateDistance(
            AppState.pickup.lat, AppState.pickup.lng,
            AppState.destination.lat, AppState.destination.lng
        );
        const totalFare = EnhancedPriceCalculator.calculateRideFare(distance, AppState.selectedRideType);
        UIUpdater.updateSplitRideCalculations(totalFare);
    }
}

async function addBroadcastFriend() {
    const input = document.getElementById('broadcastFriendInput');
    const code = input.value.trim();
    
    if (!code) {
        showToast('Please enter a referral code', 'warning');
        return;
    }
    
    showLoading('Adding friend...');
    
    const friendData = await FirebaseManager.findUserByReferralCode(code);
    
    if (friendData) {
        const friend = {
            code: code,
            name: friendData.name,
            userId: friendData.id
        };
        
        if (!AppState.broadcastRecipients.some(f => f.code === code)) {
            AppState.broadcastRecipients.push(friend);
            UIUpdater.updateBroadcastFriendsList();
            input.value = '';
            showToast(`${friend.name} added to broadcast`, 'success');
        } else {
            showToast('Friend already added', 'warning');
        }
    } else {
        showToast('Friend not found. Please check the referral code.', 'error');
    }
    
    hideLoading();
}

async function applyReferralDiscount() {
    const input = document.getElementById('referralCodeInput');
    const code = input.value.trim();
    
    if (!code) {
        showToast('Please enter a referral code', 'warning');
        return;
    }
    
    showLoading('Applying discount...');
    
    const result = await FirebaseManager.validateReferralCode(code);
    
    if (result.valid) {
        AppState.referralDiscountApplied = true;
        AppState.referralCodeUsed = code;
        AppState.referralOwnerName = result.name;
        
        const discount = AppState.rideFare * 0.5;
        const finalFare = AppState.rideFare - discount;
        
        document.getElementById('referrerName').textContent = result.name;
        document.getElementById('originalFareAmount').textContent = `ZMW ${AppState.rideFare.toFixed(2)}`;
        document.getElementById('discountAmount').textContent = `-ZMW ${discount.toFixed(2)}`;
        document.getElementById('finalFareAmount').textContent = `ZMW ${finalFare.toFixed(2)}`;
        document.getElementById('paymentAmount').textContent = `ZMW ${finalFare.toFixed(2)}`;
        
        document.getElementById('referralInputSection').style.display = 'none';
        document.getElementById('referralAppliedSection').style.display = 'block';
        
        showToast(`50% discount applied! Referral from ${result.name}`, 'success');
    } else {
        showToast('Invalid referral code', 'error');
    }
    
    hideLoading();
}

function removeReferralDiscount() {
    AppState.referralDiscountApplied = false;
    AppState.referralCodeUsed = null;
    AppState.referralOwnerName = null;
    
    document.getElementById('referralInputSection').style.display = 'block';
    document.getElementById('referralAppliedSection').style.display = 'none';
    document.getElementById('referralCodeInput').value = '';
    document.getElementById('paymentAmount').textContent = `ZMW ${AppState.rideFare.toFixed(2)}`;
    
    showToast('Referral discount removed', 'info');
}

async function requestRide() {
    if (!AppState.pickup || !AppState.destination) {
        showToast('Please select pickup and destination locations', 'warning');
        return;
    }
    
    const distance = EnhancedPriceCalculator.calculateDistance(
        AppState.pickup.lat, AppState.pickup.lng,
        AppState.destination.lat, AppState.destination.lng
    );
    
    if (distance < 0.5) {
        showToast('Minimum ride distance is 0.5 km', 'warning');
        return;
    }
    
    const rideData = {
        pickup: AppState.pickup.address,
        pickupDisplay: AppState.pickup.name,
        destination: AppState.destination.address,
        destinationDisplay: AppState.destination.name,
        pickupLat: AppState.pickup.lat,
        pickupLng: AppState.pickup.lng,
        destLat: AppState.destination.lat,
        destLng: AppState.destination.lng,
        rideType: AppState.selectedRideType,
        fare: AppState.rideFare,
        distance: distance,
        stops: AppState.rideStops
    };
    
    window.pendingRideData = rideData;
    showModal('payment');
}

async function confirmPayment() {
    const selectedMethod = document.querySelector('.payment-method.selected');
    if (!selectedMethod) {
        showToast('Please select a payment method', 'warning');
        return;
    }
    
    const paymentMethod = selectedMethod.dataset.payment;
    let amount = parseFloat(document.getElementById('paymentAmount').textContent.replace('ZMW ', ''));
    
    if (paymentMethod === 'wallet' && AppState.walletBalance < amount) {
        showToast('Insufficient wallet balance', 'error');
        return;
    }
    
    const rideData = window.pendingRideData;
    if (!rideData) {
        showToast('No ride data found', 'error');
        return;
    }
    
    rideData.paymentMethod = paymentMethod;
    
    if (AppState.referralDiscountApplied) {
        rideData.referredBy = AppState.referralCodeUsed;
        rideData.referralOwnerName = AppState.referralOwnerName;
        rideData.referralDiscount = AppState.rideFare * 0.5;
    }
    
    try {
        if (paymentMethod === 'wallet') {
            await FirebaseManager.processPayment(
                AppState.currentUser.uid,
                amount,
                'payment',
                `Ride payment: ${rideData.pickupDisplay} to ${rideData.destinationDisplay}`
            );
        }
        
        const rideId = await FirebaseManager.requestRide(rideData);
        
        if (AppState.referralDiscountApplied) {
            await FirebaseManager.sendNotification(
                AppState.referralOwnerName.userId,
                'Referral Used',
                `${AppState.userData.name} used your referral code and got 50% off their ride!`,
                'referral',
                { userId: AppState.currentUser.uid, rideId: rideId, discount: rideData.referralDiscount }
            );
        }
        
        hideModal('payment');
        delete window.pendingRideData;
        AppState.referralDiscountApplied = false;
        AppState.referralCodeUsed = null;
        AppState.referralOwnerName = null;
        
    } catch (error) {
        console.error('Error processing payment:', error);
        showToast('Error processing payment', 'error');
    }
}

async function handleEmergencyService(type) {
    if (!AppState.userLocation) {
        showToast('Please allow location access for emergency services', 'warning');
        return;
    }
    
    if (!AppState.currentCity) {
        showToast('Please wait while we detect your city', 'warning');
        return;
    }
    
    showLoading('Loading emergency stations...');
    
    const stations = await EnhancedSearchEngine.searchEmergencyStations(type, AppState.currentCity);
    UIUpdater.showEmergencyStations(stations);
    
    document.getElementById('emergencyServiceType').textContent = 
        type.charAt(0).toUpperCase() + type.slice(1) + ' Ride';
    document.getElementById('emergencyServiceType').dataset.type = type;
    
    hideLoading();
    showModal('emergency');
}

async function handleShoppingCategory(category) {
    AppState.shoppingCategory = category;
    
    showLoading('Loading shops...');
    
    const places = await EnhancedSearchEngine.searchShoppingPlaces(category, AppState.currentCity);
    UIUpdater.showShoppingPlaces(places, category);
    
    hideLoading();
    showModal('shoppingCategories');
}

function displayRideHistory(rides) {
    const container = document.getElementById('historyList');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (rides.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-history"></i>
                <div>No ride history found</div>
            </div>
        `;
        return;
    }
    
    rides.forEach(ride => {
        const item = document.createElement('div');
        item.className = 'history-item';
        
        const date = new Date(ride.timestamp);
        let icon = 'fa-car';
        let typeText = 'Ride';
        
        if (ride.serviceType === 'delivery') {
            icon = 'fa-shipping-fast';
            typeText = 'Delivery';
        } else if (ride.serviceType === 'truck') {
            icon = 'fa-truck';
            typeText = 'Truck';
        } else if (ride.emergency) {
            icon = 'fa-ambulance';
            typeText = 'Emergency';
        } else if (ride.broadcast) {
            icon = 'fa-broadcast-tower';
            typeText = 'Broadcast';
        } else if (ride.shareRide) {
            icon = 'fa-user-friends';
            typeText = 'Shared Ride';
        }
        
        item.innerHTML = `
            <div class="history-header">
                <div class="history-type">
                    <i class="fas ${icon}"></i>
                    <span>${typeText}</span>
                </div>
                <div class="history-date">
                    ${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                </div>
            </div>
            <div class="history-locations">
                <div class="location">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>${ride.pickupDisplay || ride.pickup}</span>
                </div>
                <div class="location">
                    <i class="fas fa-flag"></i>
                    <span>${ride.destinationDisplay || ride.destination}</span>
                </div>
            </div>
            <div class="history-footer">
                <div class="history-price">ZMW ${ride.fare?.toFixed(2) || '0.00'}</div>
                <div class="history-status ${ride.status}">
                    ${ride.status?.charAt(0).toUpperCase() + ride.status?.slice(1)}
                </div>
            </div>
        `;
        
        container.appendChild(item);
    });
}

function displayTransactions(transactions) {
    const container = document.getElementById('transactionsList');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (transactions.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-receipt"></i>
                <div>No transactions found</div>
            </div>
        `;
        return;
    }
    
    transactions.forEach(transaction => {
        const item = document.createElement('div');
        item.className = 'transaction-item';
        
        const date = new Date(transaction.timestamp);
        let icon = 'fa-exchange-alt';
        let amountClass = '';
        
        if (transaction.type === 'payment') {
            icon = 'fa-arrow-up';
            amountClass = 'negative';
        } else if (transaction.type === 'refund' || transaction.type === 'transfer_in' || transaction.type === 'deposit') {
            icon = 'fa-arrow-down';
            amountClass = 'positive';
        } else if (transaction.type === 'referral') {
            icon = 'fa-gift';
            amountClass = 'positive';
        }
        
        item.innerHTML = `
            <div class="transaction-header">
                <div class="transaction-type">
                    <i class="fas ${icon}"></i>
                    <span>${transaction.type?.charAt(0).toUpperCase() + transaction.type?.slice(1)}</span>
                </div>
                <div class="transaction-date">
                    ${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                </div>
            </div>
            <div class="transaction-details">
                <div class="transaction-description">${transaction.description || ''}</div>
                <div class="transaction-amount ${amountClass}">
                    ${transaction.type === 'payment' || transaction.type === 'transfer_out' ? '-' : '+'}ZMW ${transaction.amount?.toFixed(2) || '0.00'}
                </div>
            </div>
        `;
        
        container.appendChild(item);
    });
}

function updateNotificationBadge(count) {
    const badge = document.getElementById('notificationCount');
    if (badge) {
        badge.textContent = count;
        badge.style.display = count > 0 ? 'flex' : 'none';
    }
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// ============================================
// INITIALIZATION
// ============================================
async function initializeApp() {
    try {
        console.log('Initializing Jubel Passenger App...');
        showLoading('Initializing app...');
        
        EnhancedSearchEngine.init();
        
        const urlParams = new URLSearchParams(window.location.search);
        const email = urlParams.get('email');
        const uid = urlParams.get('uid');
        
        if (email && uid) {
            console.log('Authenticated via URL parameters');
            AppState.currentUser = { uid, email };
            await FirebaseManager.loadUserData(uid);
        } else {
            console.log('Checking Firebase auth state...');
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    console.log('User authenticated:', user.uid);
                    AppState.currentUser = user;
                    await FirebaseManager.loadUserData(user.uid);
                } else {
                    console.log('No user logged in, redirecting to signup');
                    window.location.href = 'signup.html';
                }
            });
        }
        
        initializeMap();
        setupEventListeners();
        getCurrentLocation();
        
        hideLoading();
        showToast('Jubel Passenger App Ready', 'success');
        console.log('App initialization completed successfully');
        
    } catch (error) {
        console.error('Error initializing app:', error);
        hideLoading();
        showToast('Error initializing app', 'error');
    }
}

function initializeMap() {
    console.log('Initializing map...');
    
    map = L.map('map').setView([-15.4167, 28.2833], 13);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: ' OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(map);
    
    L.control.scale().addTo(map);
    
    console.log('Map initialized');
}

async function getCurrentLocation() {
    if (!navigator.geolocation) {
        showToast('Geolocation is not supported by your browser', 'warning');
        return;
    }
    
    showLoading('Getting your location...');
    
    try {
        const position = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            });
        });
        
        const { latitude, longitude } = position.coords;
        console.log(`Location obtained: ${latitude}, ${longitude}`);
        
        AppState.userLocation = { lat: latitude, lng: longitude };
        
        map.setView([latitude, longitude], 15);
        
        currentLocationMarker = L.marker([latitude, longitude], {
            icon: L.divIcon({
                className: 'current-location-marker',
                html: '<i class="fas fa-user"></i>',
                iconSize: [18, 18],
                iconAnchor: [9, 18]
            })
        }).addTo(map).bindPopup('Your Location');
        
        const address = await CityDetector.getDetailedAddress(latitude, longitude);
        AppState.pickup = {
            lat: latitude,
            lng: longitude,
            address: address.address,
            name: 'Current Location'
        };
        
        document.getElementById('pickupLocation').value = address.address;
        document.getElementById('emergencyUserLocation').textContent = address.fullDisplay;
        
        const city = await CityDetector.detectCityFromLocation(latitude, longitude);
        AppState.currentCity = city;
        document.getElementById('currentCityDisplay').textContent = `City: ${city}`;
        
        hideLoading();
        showToast('Location detected successfully', 'success');
        
    } catch (error) {
        console.error('Geolocation error:', error);
        hideLoading();
        showToast('Unable to get your location', 'warning');
    }
}

// ============================================
// EVENT LISTENERS SETUP
// ============================================
function setupEventListeners() {
    console.log('Setting up event listeners...');
    
    // Navigation tabs
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const screen = tab.dataset.screen;
            switchScreen(screen);
        });
    });
    
    // Back buttons
    document.querySelectorAll('.back-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            switchScreen('home');
        });
    });
    
    // Service tabs
    document.querySelectorAll('.service-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const service = tab.dataset.service;
            switchService(service);
        });
    });
    
    // Ride type selection
    document.querySelectorAll('.ride-type-card').forEach(card => {
        card.addEventListener('click', () => {
            document.querySelectorAll('.ride-type-card').forEach(c => {
                c.classList.remove('selected');
            });
            card.classList.add('selected');
            AppState.selectedRideType = card.dataset.type;
            
            if (AppState.pickup && AppState.destination) {
                const distance = EnhancedPriceCalculator.calculateDistance(
                    AppState.pickup.lat, AppState.pickup.lng,
                    AppState.destination.lat, AppState.destination.lng
                );
                UIUpdater.updateRidePrices(distance);
            }
        });
    });
    
    // Location inputs
    const pickupInput = document.getElementById('pickupLocation');
    const destinationInput = document.getElementById('destinationLocation');
    
    if (pickupInput) {
        pickupInput.addEventListener('focus', () => {
            document.getElementById('pickupSuggestions').style.display = 'none';
        });
    }
    
    if (destinationInput) {
        destinationInput.addEventListener('input', debounce(async (e) => {
            const query = e.target.value;
            if (query.length < 2) return;
            
            const results = await EnhancedSearchEngine.search(query, 'destination', AppState.userLocation, AppState.currentCity);
            UIUpdater.showSearchSuggestions('destinationLocation', results, 'destination');
        }, 300));
    }
    
    // Add stop button
    const addStopBtn = document.getElementById('addStopBtn');
    if (addStopBtn) {
        addStopBtn.addEventListener('click', addStop);
    }
    
    // Request ride button
    const requestRideBtn = document.getElementById('requestRideBtn');
    if (requestRideBtn) {
        requestRideBtn.addEventListener('click', requestRide);
    }
    
    // Map controls
    const locateMeBtn = document.getElementById('locateMeBtn');
    if (locateMeBtn) {
        locateMeBtn.addEventListener('click', getCurrentLocation);
    }
    
    const zoomInBtn = document.getElementById('zoomInBtn');
    if (zoomInBtn) {
        zoomInBtn.addEventListener('click', () => map.zoomIn());
    }
    
    const zoomOutBtn = document.getElementById('zoomOutBtn');
    if (zoomOutBtn) {
        zoomOutBtn.addEventListener('click', () => map.zoomOut());
    }
    
    const clearRouteBtn = document.getElementById('clearRouteBtn');
    if (clearRouteBtn) {
        clearRouteBtn.addEventListener('click', () => {
            if (routeLayer) {
                map.removeLayer(routeLayer);
                routeLayer = null;
            }
            
            stopMarkers.forEach(marker => map.removeLayer(marker));
            stopMarkers = [];
            
            if (destinationMarker) {
                map.removeLayer(destinationMarker);
                destinationMarker = null;
            }
            
            document.getElementById('destinationLocation').value = '';
            AppState.destination = null;
            AppState.rideStops = [];
            UIUpdater.showStops();
            
            showToast('Route cleared', 'info');
        });
    }
    
    // Cancel ride button
    const cancelRideBtn = document.getElementById('cancelRideBtn');
    if (cancelRideBtn) {
        cancelRideBtn.addEventListener('click', () => {
            if (AppState.currentRide) {
                showModal('cancel');
            } else {
                showToast('No active ride to cancel', 'warning');
            }
        });
    }
    
    // Confirm cancel button
    const confirmCancelBtn = document.getElementById('confirmCancelBtn');
    if (confirmCancelBtn) {
        confirmCancelBtn.addEventListener('click', () => {
            const selectedReason = document.querySelector('.cancel-reason.selected');
            if (!selectedReason) {
                showToast('Please select a cancellation reason', 'warning');
                return;
            }
            
            const reason = selectedReason.dataset.reason;
            if (AppState.currentRide) {
                FirebaseManager.cancelRide(AppState.currentRide.id, reason);
                hideModal('cancel');
            }
        });
    }
    
    // Cancel reasons
    document.querySelectorAll('.cancel-reason').forEach(reason => {
        reason.addEventListener('click', () => {
            document.querySelectorAll('.cancel-reason').forEach(r => {
                r.classList.remove('selected');
            });
            reason.classList.add('selected');
            
            const otherReasonGroup = document.getElementById('otherReasonGroup');
            if (otherReasonGroup) {
                otherReasonGroup.style.display = 
                    reason.dataset.reason === 'other' ? 'block' : 'none';
            }
        });
    });
    
    // Payment methods
    document.querySelectorAll('.payment-method').forEach(method => {
        method.addEventListener('click', () => {
            document.querySelectorAll('.payment-method').forEach(m => {
                m.classList.remove('selected');
            });
            method.classList.add('selected');
        });
    });
    
    // Confirm payment button
    const confirmPaymentBtn = document.getElementById('confirmPaymentBtn');
    if (confirmPaymentBtn) {
        confirmPaymentBtn.addEventListener('click', confirmPayment);
    }
    
    // Apply referral button
    const applyReferralBtn = document.getElementById('applyReferralBtn');
    if (applyReferralBtn) {
        applyReferralBtn.addEventListener('click', applyReferralDiscount);
    }
    
    // Remove referral button
    const removeReferralBtn = document.getElementById('removeReferralBtn');
    if (removeReferralBtn) {
        removeReferralBtn.addEventListener('click', removeReferralDiscount);
    }
    
    // More options button
    const moreOptionsBtn = document.getElementById('moreOptionsBtn');
    if (moreOptionsBtn) {
        moreOptionsBtn.addEventListener('click', () => {
            const menu = document.getElementById('moreOptionsMenu');
            menu.classList.toggle('active');
        });
    }
    
    // More options menu items
    document.querySelectorAll('#moreOptionsMenu .dropdown-item').forEach(item => {
        item.addEventListener('click', () => {
            const option = item.dataset.option;
            
            switch(option) {
                case 'schedule':
                    showModal('schedule');
                    break;
                case 'orderForSomeone':
                    showModal('orderForSomeone');
                    break;
                case 'shareRide':
                    showModal('shareRide');
                    break;
                case 'broadcast':
                    switchService('broadcast');
                    break;
            }
            
            document.getElementById('moreOptionsMenu').classList.remove('active');
        });
    });
    
    // Emergency services
    document.querySelectorAll('.emergency-service').forEach(service => {
        service.addEventListener('click', () => {
            const type = service.dataset.type;
            
            if (type === 'sos') {
                showModal('sos');
            } else {
                handleEmergencyService(type);
            }
        });
    });
    
    // Emergency reasons
    document.querySelectorAll('.emergency-reason').forEach(reason => {
        reason.addEventListener('click', () => {
            document.querySelectorAll('.emergency-reason').forEach(r => {
                r.classList.remove('selected');
            });
            reason.classList.add('selected');
            
            const otherInput = document.getElementById('emergencyReasonOther');
            if (otherInput) {
                otherInput.style.display = 
                    reason.dataset.reason === 'other' ? 'block' : 'none';
            }
        });
    });
    
    // Confirm emergency button
    const confirmEmergencyBtn = document.getElementById('confirmEmergencyBtn');
    if (confirmEmergencyBtn) {
        confirmEmergencyBtn.addEventListener('click', async () => {
            const selectedReason = document.querySelector('.emergency-reason.selected');
            if (!selectedReason) {
                showToast('Please select an emergency reason', 'warning');
                return;
            }
            
            const selectedStation = document.querySelector('.emergency-station.selected');
            if (!selectedStation) {
                showToast('Please select an emergency station', 'warning');
                return;
            }
            
            const emergencyType = document.getElementById('emergencyServiceType').dataset.type;
            const distance = parseFloat(selectedStation.querySelector('.station-distance').textContent.replace(' km', ''));
            const fare = EnhancedPriceCalculator.calculateEmergencyFare(distance, emergencyType);
            
            const rideData = {
                pickup: AppState.pickup.address,
                pickupDisplay: AppState.pickup.name,
                destination: selectedStation.querySelector('.station-address').textContent,
                destinationDisplay: selectedStation.querySelector('.station-name').textContent,
                pickupLat: AppState.pickup.lat,
                pickupLng: AppState.pickup.lng,
                destLat: parseFloat(selectedStation.dataset.lat),
                destLng: parseFloat(selectedStation.dataset.lng),
                emergency: true,
                emergencyType: emergencyType,
                emergencyReason: selectedReason.dataset.reason,
                fare: fare,
                distance: distance
            };
            
            window.pendingRideData = rideData;
            hideModal('emergency');
            showModal('payment');
        });
    }
    
    // Shopping categories
    document.querySelectorAll('.category-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const category = btn.dataset.category;
            handleShoppingCategory(category);
        });
    });
    
    // Add share friend button
    const addShareMemberBtn = document.getElementById('addShareMemberBtn');
    if (addShareMemberBtn) {
        addShareMemberBtn.addEventListener('click', addShareFriend);
    }
    
    // Split type buttons
    const splitEqualBtn = document.getElementById('splitEqual');
    const splitYou70Btn = document.getElementById('splitYou70');
    const splitYouAllBtn = document.getElementById('splitYouAll');
    
    if (splitEqualBtn) {
        splitEqualBtn.addEventListener('click', () => {
            AppState.splitType = 'equal';
            splitEqualBtn.classList.add('active');
            splitYou70Btn.classList.remove('active');
            splitYouAllBtn.classList.remove('active');
            
            if (AppState.pickup && AppState.destination) {
                const distance = EnhancedPriceCalculator.calculateDistance(
                    AppState.pickup.lat, AppState.pickup.lng,
                    AppState.destination.lat, AppState.destination.lng
                );
                const totalFare = EnhancedPriceCalculator.calculateRideFare(distance, AppState.selectedRideType);
                UIUpdater.updateSplitRideCalculations(totalFare);
            }
        });
    }
    
    if (splitYou70Btn) {
        splitYou70Btn.addEventListener('click', () => {
            AppState.splitType = 'you_pay_more';
            splitEqualBtn.classList.remove('active');
            splitYou70Btn.classList.add('active');
            splitYouAllBtn.classList.remove('active');
            
            if (AppState.pickup && AppState.destination) {
                const distance = EnhancedPriceCalculator.calculateDistance(
                    AppState.pickup.lat, AppState.pickup.lng,
                    AppState.destination.lat, AppState.destination.lng
                );
                const totalFare = EnhancedPriceCalculator.calculateRideFare(distance, AppState.selectedRideType);
                UIUpdater.updateSplitRideCalculations(totalFare);
            }
        });
    }
    
    if (splitYouAllBtn) {
        splitYouAllBtn.addEventListener('click', () => {
            AppState.splitType = 'you_pay_all';
            splitEqualBtn.classList.remove('active');
            splitYou70Btn.classList.remove('active');
            splitYouAllBtn.classList.add('active');
            
            if (AppState.pickup && AppState.destination) {
                const distance = EnhancedPriceCalculator.calculateDistance(
                    AppState.pickup.lat, AppState.pickup.lng,
                    AppState.destination.lat, AppState.destination.lng
                );
                const totalFare = EnhancedPriceCalculator.calculateRideFare(distance, AppState.selectedRideType);
                UIUpdater.updateSplitRideCalculations(totalFare);
            }
        });
    }
    
    // Confirm share ride button
    const confirmShareRideBtn = document.getElementById('confirmShareRideBtn');
    if (confirmShareRideBtn) {
        confirmShareRideBtn.addEventListener('click', async () => {
            if (!AppState.pickup || !AppState.destination) {
                showToast('Please select pickup and destination locations', 'warning');
                return;
            }
            
            if (AppState.shareRideFriends.length === 0) {
                showToast('Please add at least one friend to share the ride', 'warning');
                return;
            }
            
            const distance = EnhancedPriceCalculator.calculateDistance(
                AppState.pickup.lat, AppState.pickup.lng,
                AppState.destination.lat, AppState.destination.lng
            );
            
            const totalFare = EnhancedPriceCalculator.calculateRideFare(distance, AppState.selectedRideType);
            const calculation = EnhancedPriceCalculator.calculateSplitRideFare(
                totalFare, 
                AppState.splitType, 
                AppState.shareRideFriends.length + 1
            );
            
            const rideData = {
                pickup: AppState.pickup.address,
                pickupDisplay: AppState.pickup.name,
                destination: AppState.destination.address,
                destinationDisplay: AppState.destination.name,
                pickupLat: AppState.pickup.lat,
                pickupLng: AppState.pickup.lng,
                destLat: AppState.destination.lat,
                destLng: AppState.destination.lng,
                rideType: AppState.selectedRideType,
                fare: calculation.total,
                distance: distance,
                shareRide: true,
                splitType: AppState.splitType,
                participants: [
                    {
                        userId: AppState.currentUser.uid,
                        name: AppState.userData.name,
                        shareAmount: calculation.yourShare,
                        paid: false
                    },
                    ...AppState.shareRideFriends.map(friend => ({
                        userId: friend.userId,
                        name: friend.name,
                        shareAmount: calculation.passengerShare,
                        paid: false
                    }))
                ]
            };
            
            window.pendingRideData = rideData;
            hideModal('shareRide');
            showModal('payment');
        });
    }
    
    // Add broadcast friend button
    const addBroadcastFriendBtn = document.getElementById('addBroadcastFriendBtn');
    if (addBroadcastFriendBtn) {
        addBroadcastFriendBtn.addEventListener('click', addBroadcastFriend);
    }
    
    // Start broadcast ride button
    const startBroadcastRideBtn = document.getElementById('startBroadcastRideBtn');
    if (startBroadcastRideBtn) {
        startBroadcastRideBtn.addEventListener('click', async () => {
            if (!AppState.pickup || !AppState.destination) {
                showToast('Please select pickup and destination locations', 'warning');
                return;
            }
            
            if (AppState.broadcastRecipients.length === 0) {
                showToast('Please add at least one friend to broadcast to', 'warning');
                return;
            }
            
            const distance = EnhancedPriceCalculator.calculateDistance(
                AppState.pickup.lat, AppState.pickup.lng,
                AppState.destination.lat, AppState.destination.lng
            );
            
            const totalFare = EnhancedPriceCalculator.calculateRideFare(distance, AppState.selectedRideType);
            
            const rideData = {
                pickup: AppState.pickup.address,
                pickupDisplay: AppState.pickup.name,
                destination: AppState.destination.address,
                destinationDisplay: AppState.destination.name,
                pickupLat: AppState.pickup.lat,
                pickupLng: AppState.pickup.lng,
                destLat: AppState.destination.lat,
                destLng: AppState.destination.lng,
                rideType: AppState.selectedRideType,
                fare: totalFare,
                distance: distance,
                broadcast: true,
                broadcastRecipients: AppState.broadcastRecipients
            };
            
            window.pendingRideData = rideData;
            hideModal('broadcast');
            showModal('payment');
        });
    }
    
    // Wallet actions
    const depositBtn = document.getElementById('depositBtn');
    const withdrawBtn = document.getElementById('withdrawBtn');
    const transferBtn = document.getElementById('transferBtn');
    const transactionsBtn = document.getElementById('transactionsBtn');
    
    if (depositBtn) {
        depositBtn.addEventListener('click', () => {
            showToast('Deposit feature coming soon', 'info');
        });
    }
    
    if (withdrawBtn) {
        withdrawBtn.addEventListener('click', () => {
            showToast('Withdrawal feature coming soon', 'info');
        });
    }
    
    if (transferBtn) {
        transferBtn.addEventListener('click', () => {
            showModal('transfer');
        });
    }
    
    if (transactionsBtn) {
        transactionsBtn.addEventListener('click', () => {
            showModal('transactions');
            FirebaseManager.loadWalletTransactions(AppState.currentUser.uid);
        });
    }
    
    // Confirm transfer button
    const confirmTransferBtn = document.getElementById('confirmTransferBtn');
    if (confirmTransferBtn) {
        confirmTransferBtn.addEventListener('click', async () => {
            const recipientCode = document.getElementById('recipientCode').value.trim();
            const amount = parseFloat(document.getElementById('transferAmount').value);
            const message = document.getElementById('transferMessage').value.trim();
            
            if (!recipientCode) {
                showToast('Please enter recipient referral code', 'warning');
                return;
            }
            
            if (!amount || amount <= 0) {
                showToast('Please enter a valid amount', 'warning');
                return;
            }
            
            await FirebaseManager.transferMoney(AppState.currentUser.uid, recipientCode, amount, message);
            hideModal('transfer');
            
            document.getElementById('recipientCode').value = '';
            document.getElementById('transferAmount').value = '';
            document.getElementById('transferMessage').value = '';
        });
    }
    
    // Close modals when clicking outside
    document.querySelectorAll('.modal-overlay').forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });
    });
    
    // Close modals with close buttons
    document.querySelectorAll('.modal-close').forEach(btn => {
        btn.addEventListener('click', () => {
            const modal = btn.dataset.modal;
            hideModal(modal);
        });
    });
    
    console.log('Event listeners setup completed');
}

// ============================================
// START THE APPLICATION
// ============================================
window.addEventListener('load', initializeApp);
</script>
</body>
</html>
