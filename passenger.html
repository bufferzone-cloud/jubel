<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jubel Passenger</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        /* Add any missing CSS styles here */
        .price-update-animation {
            animation: priceUpdate 0.5s ease-in-out;
        }
        
        @keyframes priceUpdate {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .pulsing-ride-icon {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 0.7; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        
        .syncing {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Map Container -->
    <div id="map">
        <div class="map-loading-overlay" id="mapLoadingOverlay">
            <div class="loading-spinner"></div>
            <div class="map-loading-text">Loading map...</div>
        </div>
    </div>
    
    <!-- Top Navigation Bar -->
    <div class="top-bar">
        <div class="logo-container">
            <div class="logo-icon">
                <img src="jubel.png" alt="Jubel Logo" id="jubelLogo">
            </div>
            <div class="logo-text" id="userFullName">Loading...</div>
        </div>
        
        <div class="user-actions">
            <div class="balance-badge" id="balanceBadge">
                <i class="fas fa-wallet"></i>
                <span>Balance: <span class="balance-amount" id="walletBalance">ZMW 0.00</span></span>
            </div>
            <div class="notification-bell" id="notificationBell">
                <i class="fas fa-bell"></i>
                <span class="notification-badge" id="notificationCount">0</span>
            </div>
        </div>
    </div>
    
    <!-- City Detection Indicator -->
    <div class="city-detection" id="cityDetection">
        <i class="fas fa-map-marker-alt"></i>
        <span id="currentCityDisplay">Detecting your city...</span>
    </div>
    
    <!-- Ride Status Bar -->
    <div class="ride-status-bar" id="rideStatusBar">
        <div class="status-indicator">
            <div class="status-dot searching" id="statusDot"></div>
            <span class="status-text" id="statusText">Searching for driver</span>
        </div>
        <div class="status-eta">
            <i class="fas fa-clock"></i>
            <span id="etaText">5 min</span>
        </div>
    </div>
    
    <!-- Emergency Status -->
    <div class="emergency-status" id="emergencyStatus">
        <i class="fas fa-exclamation-triangle"></i>
        <span>EMERGENCY RIDE IN PROGRESS</span>
    </div>
    
    <!-- SOS Button -->
    <div class="sos-button" id="sosButton">
        <i class="fas fa-exclamation-triangle"></i>
    </div>
    
    <!-- Map Controls -->
    <div class="map-controls">
        <button class="map-control-btn" id="locateMeBtn" title="Locate Me">
            <i class="fas fa-location-arrow"></i>
        </button>
        <button class="map-control-btn" id="zoomInBtn" title="Zoom In">
            <i class="fas fa-plus"></i>
        </button>
        <button class="map-control-btn" id="zoomOutBtn" title="Zoom Out">
            <i class="fas fa-minus"></i>
        </button>
        <button class="map-control-btn" id="clearRouteBtn" title="Clear Route">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <!-- Chat Container -->
    <div class="chat-container" id="chatContainer">
        <div class="chat-header">
            <div class="chat-title">Chat with Driver</div>
            <button class="chat-close" id="chatClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <!-- Messages will be inserted here -->
        </div>
        <div class="chat-typing-indicator" id="typingIndicator">
            Driver is typing...
        </div>
        <div class="chat-input-container">
            <button class="chat-attachment-btn" id="attachmentBtn">
                <i class="fas fa-paperclip"></i>
            </button>
            <input type="text" class="chat-input" id="chatInput" placeholder="Type your message...">
            <button class="chat-send-btn" id="chatSend">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
    
    <!-- Notifications Panel -->
    <div class="notifications-panel" id="notificationsPanel">
        <div class="notifications-header">
            <div class="notifications-title">Notifications</div>
            <button class="notifications-close" id="notificationsClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="notifications-list" id="notificationsList">
            <!-- Notifications will be inserted here -->
        </div>
    </div>
    
    <!-- Main Panel -->
    <div class="main-panel" id="mainPanel">
        <div class="panel-handle" id="panelHandle"></div>
        
        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" data-screen="home">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </button>
            <button class="nav-tab" data-screen="history">
                <i class="fas fa-history"></i>
                <span>History</span>
            </button>
            <button class="nav-tab" data-screen="account">
                <i class="fas fa-user"></i>
                <span>Account</span>
            </button>
            <button class="nav-tab" data-screen="emergency">
                <i class="fas fa-ambulance"></i>
                <span>Emergency</span>
            </button>
        </div>
        
        <!-- Home Screen Content -->
        <div id="homeContent">
            <!-- Service Tabs -->
            <div class="service-tabs" id="serviceTabs">
                <div class="service-tab car active" data-service="car">
                    <div class="service-icon">
                        <i class="fas fa-car"></i>
                    </div>
                    <div class="service-name">Car</div>
                    <div class="service-desc">Ride anywhere</div>
                </div>
                
                <div class="service-tab delivery" data-service="delivery">
                    <div class="service-icon">
                        <i class="fas fa-shipping-fast"></i>
                    </div>
                    <div class="service-name">Delivery</div>
                    <div class="service-desc">Send packages</div>
                </div>
                
                <div class="service-tab short-delivery" data-service="short-delivery">
                    <div class="service-icon">
                        <i class="fas fa-bicycle"></i>
                    </div>
                    <div class="service-name">Short Delivery</div>
                    <div class="service-desc">Quick deliveries</div>
                </div>
                
                <div class="service-tab" data-service="express">
                    <div class="service-icon">
                        <i class="fas fa-shopping-bag"></i>
                    </div>
                    <div class="service-name">Express Shopping</div>
                    <div class="service-desc">Shop for you</div>
                </div>
                
                <div class="service-tab" data-service="truck">
                    <div class="service-icon">
                        <i class="fas fa-truck"></i>
                    </div>
                    <div class="service-name">Truck</div>
                    <div class="service-desc">Move items</div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="quick-actions">
                <button class="quick-action-btn" id="moreOptionsBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-ellipsis-h"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">More Options</div>
                        <div class="quick-action-desc">Schedule, split, broadcast</div>
                    </div>
                </button>
                <button class="quick-action-btn" id="broadcastRideBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-broadcast-tower"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">Broadcast Ride</div>
                        <div class="quick-action-desc">Share with friends</div>
                    </div>
                </button>
                <button class="quick-action-btn" id="sosSetupBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">SOS Setup</div>
                        <div class="quick-action-desc">Emergency contacts</div>
                    </div>
                </button>
            </div>
            
            <!-- Car Service Form (Default) -->
            <div class="ride-request-form active" id="carForm">
                <div class="form-title">
                    <i class="fas fa-car"></i>
                    Book a Ride
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="pickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="pickupLocation" placeholder="Current location" readonly>
                        <div class="search-loading" id="pickupSearchLoading"></div>
                        <div class="suggestion-list" id="pickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="destinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="destinationLocation" placeholder="Where to?" autocomplete="off">
                        <div class="search-loading" id="destinationSearchLoading"></div>
                        <div class="suggestion-list" id="destinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Stops Container -->
                <div id="stopsContainer" style="margin: 10px 0;"></div>
                <button type="button" class="btn btn-secondary" id="addStopBtn" style="width: 100%; margin-bottom: 15px;">
                    <i class="fas fa-plus"></i> Add Stop
                </button>
                
                <!-- Ride Type Selection -->
                <div class="ride-type-selection" id="rideTypeSelection">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                    </div>
                    
                    <div class="ride-type-cards" id="rideTypeCardsContainer">
                        <!-- Ride type cards will be inserted here -->
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="fareDisplay">
                    <div class="fare-label">Estimated Fare</div>
                    <div class="fare-amount" id="estimatedFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="distanceDetail">0 km</span>
                        <span id="timeDetail">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestRideBtn">
                        <i class="fas fa-search"></i>
                        Request Ride
                    </button>
                </div>
            </div>
            
            <!-- Delivery Service Form -->
            <div class="service-form delivery-form" id="deliveryForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-shipping-fast"></i>
                    Package Delivery
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="deliveryPickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="deliveryPickup" placeholder="Pickup location" readonly>
                        <div class="search-loading" id="deliveryPickupSearchLoading"></div>
                        <div class="suggestion-list" id="deliveryPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="deliveryDestinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="deliveryDestination" placeholder="Delivery address" autocomplete="off">
                        <div class="search-loading" id="deliveryDestinationSearchLoading"></div>
                        <div class="suggestion-list" id="deliveryDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Delivery Details -->
                <div class="form-group">
                    <label class="form-label">Parcel Description</label>
                    <input type="text" class="form-control" id="parcelDescription" placeholder="What are you sending?">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Receiver's Referral Code</label>
                    <input type="text" class="form-control" id="receiverReferralCode" placeholder="Enter receiver's referral code">
                </div>
                
                <!-- Delivery Options -->
                <div class="form-group">
                    <label class="form-label">Delivery Type</label>
                    <div style="display: flex; gap: 10px;">
                        <button class="filter-btn active" data-delivery-type="standard">Standard</button>
                        <button class="filter-btn" data-delivery-type="express">Express</button>
                        <button class="filter-btn" data-delivery-type="sameDay">Same Day</button>
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="deliveryFareDisplay" style="display: none;">
                    <div class="fare-label">Delivery Fare</div>
                    <div class="fare-amount" id="deliveryFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="deliveryDistance">0 km</span>
                        <span id="deliveryTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestDeliveryBtn">
                        <i class="fas fa-shipping-fast"></i>
                        Request Delivery
                    </button>
                </div>
            </div>
            
            <!-- Short Delivery Form -->
            <div class="service-form delivery-form" id="shortDeliveryForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-bicycle"></i>
                    Short Delivery
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="shortDeliveryPickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="shortDeliveryPickup" placeholder="Pickup location" readonly>
                        <div class="search-loading" id="shortDeliveryPickupSearchLoading"></div>
                        <div class="suggestion-list" id="shortDeliveryPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="shortDeliveryDestinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="shortDeliveryDestination" placeholder="Delivery address" autocomplete="off">
                        <div class="search-loading" id="shortDeliveryDestinationSearchLoading"></div>
                        <div class="suggestion-list" id="shortDeliveryDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Delivery Details -->
                <div class="form-group">
                    <label class="form-label">What are you sending?</label>
                    <input type="text" class="form-control" id="shortParcelDescription" placeholder="Food, documents, small items...">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Receiver's Referral Code</label>
                    <input type="text" class="form-control" id="shortReceiverReferralCode" placeholder="Receiver's referral code">
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="shortDeliveryFareDisplay" style="display: none;">
                    <div class="fare-label">Delivery Fare</div>
                    <div class="fare-amount" id="shortDeliveryFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="shortDeliveryDistance">0 km</span>
                        <span id="shortDeliveryTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestShortDeliveryBtn">
                        <i class="fas fa-bolt"></i>
                        Quick Delivery
                    </button>
                </div>
            </div>
            
            <!-- Express Shopping Form -->
            <div class="service-form express-form" id="expressForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-shopping-bag"></i>
                    Express Shopping
                </div>
                
                <!-- Shopping Categories -->
                <div class="shopping-categories" id="shoppingCategories">
                    <div class="category-tabs">
                        <button class="category-tab active" data-category="restaurant">
                            <i class="fas fa-utensils"></i>
                            <span>Restaurants</span>
                        </button>
                        <button class="category-tab" data-category="pharmacy">
                            <i class="fas fa-prescription-bottle-medical"></i>
                            <span>Pharmacies</span>
                        </button>
                        <button class="category-tab" data-category="supermarket">
                            <i class="fas fa-shopping-cart"></i>
                            <span>Supermarkets</span>
                        </button>
                        <button class="category-tab" data-category="mall">
                            <i class="fas fa-store"></i>
                            <span>Shopping Malls</span>
                        </button>
                    </div>
                    
                    <!-- Shop Suggestions -->
                    <div class="shop-suggestions" id="shopSuggestionsContainer">
                        <!-- Shop suggestions will be inserted here -->
                    </div>
                </div>
                
                <!-- Shop Location -->
                <div class="location-inputs">
                    <div class="location-input" id="shopLocationInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="shopLocation" placeholder="Shop location" readonly>
                    </div>
                </div>
                
                <!-- Items List -->
                <div class="form-group">
                    <label class="form-label">Shopping List</label>
                    <div class="item-list" id="shoppingItems">
                        <div class="item-entry">
                            <input type="text" class="item-input" placeholder="Item name">
                            <button class="remove-item" type="button">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <button class="add-item" type="button" id="addItemBtn">
                        <i class="fas fa-plus"></i>
                        Add Item
                    </button>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Special Instructions</label>
                    <textarea class="form-control form-textarea" id="shoppingInstructions" placeholder="Any specific requests or instructions..."></textarea>
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="shoppingDestinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="shoppingDestination" placeholder="Delivery address" autocomplete="off">
                        <div class="search-loading" id="shoppingDestinationSearchLoading"></div>
                        <div class="suggestion-list" id="shoppingDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="shoppingFareDisplay" style="display: none;">
                    <div class="fare-label">Shopping Service Fare</div>
                    <div class="fare-amount" id="shoppingFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="shoppingDistance">0 km</span>
                        <span id="shoppingTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestShoppingBtn">
                        <i class="fas fa-shopping-cart"></i>
                        Request Shopping
                    </button>
                </div>
            </div>
            
            <!-- Truck Delivery Form -->
            <div class="service-form truck-form" id="truckForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-truck"></i>
                    Truck Delivery
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="truckPickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="truckPickup" placeholder="Pickup location (Current location)" readonly>
                        <div class="search-loading" id="truckPickupSearchLoading"></div>
                        <div class="suggestion-list" id="truckPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input" id="truckDestinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="truckDestination" placeholder="Destination" autocomplete="off">
                        <div class="search-loading" id="truckDestinationSearchLoading"></div>
                        <div class="suggestion-list" id="truckDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Truck Type Selection -->
                <div class="form-group">
                    <label class="form-label">Select Truck Type</label>
                    <div class="truck-types" id="truckTypesContainer">
                        <!-- Truck types will be inserted here -->
                    </div>
                </div>
                
                <!-- Item Details -->
                <div class="form-group">
                    <label class="form-label">What are you moving?</label>
                    <input type="text" class="form-control" id="truckItemDescription" placeholder="Furniture, boxes, equipment...">
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="truckFareDisplay" style="display: none;">
                    <div class="fare-label">Truck Fare</div>
                    <div class="fare-amount" id="truckFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="truckDistance">0 km</span>
                        <span id="truckTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestTruckBtn">
                        <i class="fas fa-truck"></i>
                        Request Truck
                    </button>
                </div>
            </div>
            
            <!-- Ride Info Panel -->
            <div class="ride-info-panel" id="rideInfoPanel" style="display: none;">
                <!-- Ride info content remains the same -->
            </div>
            
            <!-- Split Ride Form -->
            <div class="service-form split-form" id="splitForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-user-friends"></i>
                    Split Ride
                </div>
                
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="splitPickup" placeholder="Pickup location" readonly>
                        <div class="search-loading" id="splitPickupSearchLoading"></div>
                        <div class="suggestion-list" id="splitPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="splitDestination" placeholder="Destination" autocomplete="off">
                        <div class="search-loading" id="splitDestinationSearchLoading"></div>
                        <div class="suggestion-list" id="splitDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Stops for Split Ride -->
                <div id="splitStopsContainer" style="margin: 10px 0;"></div>
                <button type="button" class="btn btn-secondary" id="addSplitStopBtn" style="width: 100%; margin-bottom: 15px;">
                    <i class="fas fa-plus"></i> Add Stop
                </button>
                
                <!-- Split Ride Type Selection -->
                <div class="ride-type-selection" style="margin-bottom: 15px;">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                    </div>
                    <div class="ride-type-cards" id="splitRideTypeCards">
                        <!-- Split ride type cards will be inserted here -->
                    </div>
                </div>
                
                <!-- Add Friends Section -->
                <div class="form-group">
                    <label class="form-label">Add Friends (Max 3)</label>
                    <div class="add-friend-container">
                        <input type="text" id="friendReferralCode" placeholder="Enter friend's referral code" class="form-control">
                        <button class="btn btn-secondary" id="addFriendBtn">
                            <i class="fas fa-plus"></i> Add
                        </button>
                    </div>
                    <div class="friends-list" id="splitFriendsList">
                        <!-- Friends will be added here -->
                    </div>
                </div>
                
                <!-- Fare Breakdown -->
                <div class="fare-breakdown" id="splitFareBreakdown" style="display: none;">
                    <div class="section-title">Fare Breakdown</div>
                    <div class="price-row">
                        <span>Total Fare:</span>
                        <span id="splitTotalFare">ZMW 0.00</span>
                    </div>
                    <div class="price-row">
                        <span>Your Share:</span>
                        <span id="splitYourShare">ZMW 0.00</span>
                    </div>
                    <div class="price-row">
                        <span>Each Friend's Share:</span>
                        <span id="splitFriendShare">ZMW 0.00</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestSplitRideBtn">
                        <i class="fas fa-user-friends"></i>
                        Request Split Ride
                    </button>
                </div>
            </div>
            
            <!-- Broadcast Ride Form -->
            <div class="service-form broadcast-form" id="broadcastForm" style="display: none;">
                <div class="form-title">
                    <i class="fas fa-broadcast-tower"></i>
                    Broadcast Ride
                </div>
                
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="broadcastPickup" placeholder="Pickup location" readonly>
                        <div class="search-loading" id="broadcastPickupSearchLoading"></div>
                        <div class="suggestion-list" id="broadcastPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="broadcastDestination" placeholder="Destination" autocomplete="off">
                        <div class="search-loading" id="broadcastDestinationSearchLoading"></div>
                        <div class="suggestion-list" id="broadcastDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Add Broadcast Recipients -->
                <div class="form-group">
                    <label class="form-label">Add Referral Codes to Broadcast To</label>
                    <div class="add-recipient-container">
                        <input type="text" id="broadcastRecipientCode" placeholder="Enter referral code" class="form-control">
                        <button class="btn btn-secondary" id="addBroadcastRecipientBtn">
                            <i class="fas fa-plus"></i> Add
                        </button>
                    </div>
                    <div class="recipients-list" id="broadcastRecipientsList">
                        <!-- Recipients will be added here -->
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="broadcastFareDisplay" style="display: none;">
                    <div class="fare-label">Broadcast Fare</div>
                    <div class="fare-amount" id="broadcastFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="broadcastDistance">0 km</span>
                        <span id="broadcastTime">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestBroadcastRideBtn">
                        <i class="fas fa-broadcast-tower"></i>
                        Start Broadcast
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- History Screen -->
    <div class="history-screen" id="historyScreen" style="display: none;">
        <!-- History screen content remains the same -->
    </div>
    
    <!-- Account Screen -->
    <div class="account-screen" id="accountScreen" style="display: none;">
        <!-- Account screen content remains the same -->
    </div>
    
    <!-- Emergency Screen -->
    <div class="emergency-screen" id="emergencyScreen" style="display: none;">
        <!-- Emergency screen content remains the same -->
    </div>
    
    <!-- Payment Modal -->
    <div class="modal-overlay" id="paymentModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-credit-card"></i>
                    Select Payment Method
                </div>
                <button class="modal-close" data-modal="payment">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <div class="form-label">Available Balance: <span id="paymentBalance">ZMW 0.00</span></div>
                    <div class="form-label">Total Amount: <span id="paymentAmount">ZMW 0.00</span></div>
                </div>
                
                <!-- Referral Discount Section -->
                <div class="referral-discount-section" id="referralDiscountSection">
                    <div class="section-header">
                        <i class="fas fa-gift"></i>
                        <span>Referral Discount (50% off)</span>
                    </div>
                    <div class="referral-input-group">
                        <input type="text" id="referralCodeInput" placeholder="Enter referral code">
                        <button id="applyReferralBtn" class="btn btn-orange">
                            <i class="fas fa-check"></i> Apply
                        </button>
                    </div>
                    <div id="referrerInfo" style="display: none; font-size: 12px; color: var(--success-green); margin-top: 5px;"></div>
                    <div class="discount-breakdown" id="discountBreakdown" style="display: none; margin-top: 10px;">
                        <div class="price-row">
                            <span>Original Fare:</span>
                            <span id="originalFareAmount">ZMW 0.00</span>
                        </div>
                        <div class="price-row">
                            <span>Discount:</span>
                            <span id="discountAmount" style="color: var(--success-green);">-ZMW 0.00</span>
                        </div>
                        <div class="price-row total">
                            <span>Final Fare:</span>
                            <span id="finalFareAmount" style="font-weight: bold;">ZMW 0.00</span>
                        </div>
                    </div>
                </div>
                
                <div class="payment-methods">
                    <div class="payment-method" data-payment="wallet">
                        <div class="payment-icon">
                            <i class="fas fa-wallet"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Jubel Wallet</div>
                            <div class="payment-info">Pay with your wallet balance</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-payment="mobile">
                        <div class="payment-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Mobile Money</div>
                            <div class="payment-info">Pay via MTN/Zamtel/Airtel</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-payment="cash">
                        <div class="payment-icon">
                            <i class="fas fa-money-bill"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Cash</div>
                            <div class="payment-info">Pay driver directly</div>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmPaymentBtn">
                        <i class="fas fa-check"></i>
                        Confirm Payment
                    </button>
                    <button class="btn btn-secondary" data-modal="payment">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Split Ride Invitation Modal -->
    <div class="modal-overlay" id="splitInvitationModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-user-friends"></i>
                    Split Ride Invitation
                </div>
                <button class="modal-close" data-modal="splitInvitation">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="invitation-details">
                    <div class="invitation-host">
                        <i class="fas fa-user"></i>
                        <span id="splitInvitationHost">Loading...</span>
                    </div>
                    <div class="invitation-route">
                        <div class="route-point">
                            <i class="fas fa-map-marker-alt"></i>
                            <span id="splitInvitationPickup">Loading...</span>
                        </div>
                        <div class="route-point">
                            <i class="fas fa-flag"></i>
                            <span id="splitInvitationDestination">Loading...</span>
                        </div>
                    </div>
                    <div class="invitation-fare">
                        <div class="fare-item">
                            <span>Total Fare:</span>
                            <span id="splitInvitationTotalFare">ZMW 0.00</span>
                        </div>
                        <div class="fare-item">
                            <span>Your Share:</span>
                            <span id="splitInvitationYourShare">ZMW 0.00</span>
                        </div>
                        <div class="fare-item">
                            <span>Participants:</span>
                            <span id="splitInvitationParticipants">1</span>
                        </div>
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" id="acceptSplitInvitationBtn">
                        <i class="fas fa-check"></i>
                        Accept & Pay
                    </button>
                    <button class="btn btn-secondary" id="rejectSplitInvitationBtn">
                        <i class="fas fa-times"></i>
                        Decline
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Schedule Ride Modal -->
    <div class="modal-overlay" id="scheduleModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-calendar-alt"></i>
                    Schedule a Ride
                </div>
                <button class="modal-close" data-modal="schedule">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="schedulePickup" placeholder="Pickup location" readonly>
                        <div class="search-loading" id="schedulePickupSearchLoading"></div>
                        <div class="suggestion-list" id="schedulePickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="scheduleDestination" placeholder="Destination">
                        <div class="search-loading" id="scheduleDestinationSearchLoading"></div>
                        <div class="suggestion-list" id="scheduleDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Schedule Time -->
                <div class="form-group">
                    <label class="form-label">Schedule Time</label>
                    <div class="schedule-time-inputs">
                        <input type="date" id="scheduleDate" class="form-control">
                        <input type="time" id="scheduleTime" class="form-control">
                    </div>
                </div>
                
                <!-- Ride Type Selection -->
                <div class="ride-type-selection" style="margin-bottom: 15px;">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                    </div>
                    <div class="ride-type-cards" id="scheduleRideTypeCards">
                        <!-- Schedule ride type cards will be inserted here -->
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="scheduleFareDisplay" style="display: none;">
                    <div class="fare-label">Scheduled Ride Fare</div>
                    <div class="fare-amount" id="scheduleFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="scheduleDistance">0 km</span>
                        <span id="scheduleTimeEstimate">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Countdown Timer (will be shown when scheduled) -->
                <div id="scheduleCountdownContainer" style="display: none;">
                    <div class="countdown-timer">
                        <div class="countdown-label">Ride starts in:</div>
                        <div class="countdown-display">
                            <span id="countdownHours">00</span>:<span id="countdownMinutes">00</span>:<span id="countdownSeconds">00</span>
                        </div>
                        <button class="btn btn-danger" id="cancelScheduleBtn">
                            <i class="fas fa-times"></i> Cancel Schedule
                        </button>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmScheduleBtn">
                        <i class="fas fa-calendar-check"></i>
                        Schedule Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="schedule">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Emergency Details Modal -->
    <div class="modal-overlay" id="emergencyModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-ambulance"></i>
                    Emergency Ride Details
                </div>
                <button class="modal-close" data-modal="emergency">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content emergency-modal-content">
                <div class="form-group">
                    <div class="form-label" id="emergencyServiceType">Police Ride</div>
                </div>
                
                <!-- Emergency Reasons -->
                <div class="form-group">
                    <label class="form-label">Select Emergency Reason</label>
                    <div class="emergency-reasons" id="emergencyReasonsContainer">
                        <!-- Emergency reasons will be inserted based on service type -->
                    </div>
                    
                    <div class="emergency-reason-input" id="emergencyReasonOther" style="display: none;">
                        <label class="form-label">Please describe the emergency:</label>
                        <textarea class="form-control form-textarea" id="emergencyOtherReason" placeholder="Describe the emergency situation..."></textarea>
                    </div>
                </div>
                
                <!-- Location Inputs -->
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="emergencyPickup" placeholder="Pickup location" readonly>
                        <div class="search-loading" id="emergencyPickupSearchLoading"></div>
                        <div class="suggestion-list" id="emergencyPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="emergencyDestination" placeholder="Destination" autocomplete="off">
                        <div class="search-loading" id="emergencyDestinationSearchLoading"></div>
                        <div class="suggestion-list" id="emergencyDestinationSuggestions"></div>
                    </div>
                </div>
                
                <!-- Emergency Stations -->
                <div class="form-group">
                    <label class="form-label">Select Nearest Emergency Station</label>
                    <div class="emergency-stations" id="emergencyStations">
                        <!-- Stations will be inserted here -->
                    </div>
                </div>
                
                <!-- Price Calculation -->
                <div class="price-calculation">
                    <div class="calculation-row">
                        <span>Base Emergency Fare:</span>
                        <span id="emergencyBaseFare">ZMW 100.00</span>
                    </div>
                    <div class="calculation-row">
                        <span>Distance to Service:</span>
                        <span id="emergencyDistance">0 km</span>
                    </div>
                    <div class="calculation-row total">
                        <span>Total Fare:</span>
                        <span id="emergencyTotalFare">ZMW 100.00</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-danger" id="confirmEmergencyBtn">
                        <i class="fas fa-exclamation-triangle"></i>
                        Request Emergency Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="emergency">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Shopping Categories Modal -->
    <div class="modal-overlay" id="shoppingCategoryModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-shopping-bag"></i>
                    Select Shop
                </div>
                <button class="modal-close" data-modal="shoppingCategory">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="shop-category-details" id="shopCategoryDetails">
                    <!-- Shop list will be inserted here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Loading...</div>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Real-time Indicator -->
    <div class="real-time-indicator" id="realTimeIndicator">
        <i class="fas fa-sync-alt"></i>
        <span>Real-time updates active</span>
    </div>
    
    <!-- External JavaScript Libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
// ============================================
// FIREBASE CONFIGURATION AND INITIALIZATION
// ============================================
const firebaseConfig = {
    apiKey: "AIzaSyDEACX_P4c5q7djJAcA0I7Lk7leO2TlQ74",
    authDomain: "jubel-13e1a.firebaseapp.com",
    databaseURL: "https://jubel-13e1a-default-rtdb.firebaseio.com",
    projectId: "jubel-13e1a",
    storageBucket: "jubel-13e1a.firebasestorage.app",
    messagingSenderId: "882241095445",
    appId: "1:882241095445:web:ee9ca40fddd008ca910b1c",
    measurementId: "G-J5JPKL6B5F"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const auth = firebase.auth();
const storage = firebase.storage();

// ============================================
// GLOBAL STATE MANAGEMENT
// ============================================
const AppState = {
    currentUser: null,
    userData: null,
    currentRide: null,
    activeScreen: 'home',
    activeService: 'car',
    walletBalance: 0,
    userLocation: null,
    currentCity: null,
    selectedRideType: 'standard',
    selectedVehicle: null,
    destination: null,
    pickup: null,
    rideFare: 0,
    driverLocation: null,
    chatMessages: [],
    scheduledRides: [],
    emergencyMode: false,
    sosConfig: null,
    notifications: [],
    unreadNotifications: 0,
    searchHistory: [],
    emergencyStations: {
        police: [],
        fire: [],
        medical: []
    },
    realtimeListeners: [],
    rideTypes: {
        economy: { base: 15, perKm: 2.5, multiplier: 0.8, min: 10, icon: 'fa-car-side' },
        standard: { base: 20, perKm: 3.0, multiplier: 1.0, min: 15, icon: 'fa-car' },
        premium: { base: 30, perKm: 4.0, multiplier: 1.5, min: 25, icon: 'fa-crown' }
    },
    emergencyServices: {
        police: { base: 150, perKm: 5.0, multiplier: 2.0, min: 100 },
        fire: { base: 200, perKm: 6.0, multiplier: 2.5, min: 150 },
        medical: { base: 180, perKm: 5.5, multiplier: 2.2, min: 120 }
    },
    deliveryTypes: {
        standard: { base: 25, perKm: 2.0, multiplier: 1.0 },
        express: { base: 40, perKm: 3.0, multiplier: 1.5 },
        sameDay: { base: 60, perKm: 4.0, multiplier: 2.0 }
    },
    truckTypes: {
        pickup: { base: 80, perKm: 5.0, multiplier: 1.0, capacity: '1.5 tons' },
        light: { base: 120, perKm: 6.0, multiplier: 1.2, capacity: '3 tons' },
        medium: { base: 200, perKm: 8.0, multiplier: 1.5, capacity: '7 tons' },
        heavy: { base: 350, perKm: 12.0, multiplier: 2.0, capacity: '15 tons' }
    },
    shoppingCategories: {
        restaurant: ['Pizza', 'Nando\'s', 'Hungry Lion'],
        pharmacy: [],
        supermarket: [],
        mall: []
    },
    activeStops: [],
    splitRideFriends: [],
    broadcastRecipients: [],
    referralDiscountApplied: false,
    referralCodeUsed: null,
    referralOwnerName: null,
    activeSplitInvitation: null,
    scheduledTimer: null,
    shoppingCategory: null,
    emergencyReason: null,
    selectedEmergencyStation: null,
    activeBroadcast: null,
    typingTimeout: null,
    driverTyping: false,
    routeDirections: null,
    pendingRideData: null,
    paymentPendingMembers: new Set(),
    rideSplitDetails: null,
    activeFilter: 'all',
    chatOpen: false,
    notificationsOpen: false,
    mapInitialized: false,
    searchTimeout: null
};

// ============================================
// MAP MANAGEMENT
// ============================================
let map = null;
let currentLocationMarker = null;
let pickupMarker = null;
let destinationMarker = null;
let driverMarker = null;
let routeLayer = null;
let emergencyMarkers = [];
let emergencyStationMarkers = [];
let pulsingIcon = null;
let stopMarkers = [];

// ============================================
// ENHANCED LOCATION SEARCH ENGINE
// ============================================
const EnhancedSearchEngine = {
    cache: new Map(),
    lastSearch: 0,
    debounceTimer: null,
    searchHistory: [],
    maxHistoryItems: 15,
    activeSearches: new Set(),
    
    init: function() {
        this.loadSearchHistory();
        console.log('Enhanced Search Engine initialized');
    },
    
    loadSearchHistory: function() {
        try {
            const history = localStorage.getItem('jubel_search_history');
            if (history) {
                this.searchHistory = JSON.parse(history);
                console.log(`Loaded ${this.searchHistory.length} search history items`);
            }
        } catch (error) {
            console.error('Error loading search history:', error);
            this.searchHistory = [];
        }
    },
    
    saveSearchHistory: function() {
        try {
            localStorage.setItem('jubel_search_history', JSON.stringify(this.searchHistory));
        } catch (error) {
            console.error('Error saving search history:', error);
        }
    },
    
    addToHistory: function(query, location, type) {
        const historyItem = {
            query: query,
            location: location,
            type: type,
            timestamp: Date.now(),
            city: AppState.currentCity
        };
        
        this.searchHistory = this.searchHistory.filter(item => 
            !(item.query === query && item.type === type && item.city === AppState.currentCity)
        );
        
        this.searchHistory.unshift(historyItem);
        
        if (this.searchHistory.length > this.maxHistoryItems) {
            this.searchHistory = this.searchHistory.slice(0, this.maxHistoryItems);
        }
        
        this.saveSearchHistory();
        return historyItem;
    },
    
    search: async function(query, type = 'destination', location = null, forceCity = null) {
        const searchId = `${Date.now()}-${Math.random()}`;
        this.activeSearches.add(searchId);
        
        try {
            const city = forceCity || AppState.currentCity;
            if (!city) {
                console.warn('No city detected for search');
                return [];
            }
            
            const cacheKey = `${query.toLowerCase()}-${type}-${city}-${location ? `${location.lat.toFixed(4)},${location.lng.toFixed(4)}` : 'none'}`;
            
            if (this.cache.has(cacheKey)) {
                const cached = this.cache.get(cacheKey);
                if (Date.now() - cached.timestamp < 300000) {
                    console.log('Returning cached search results');
                    return cached.results;
                }
            }
            
            console.log(`Searching for "${query}" in ${city}, type: ${type}`);
            
            const searchUrl = this.buildSearchUrl(query, city, location);
            
            this.showSearchLoading(true, type);
            
            const response = await fetch(searchUrl, {
                headers: {
                    'User-Agent': 'JubelRideApp/1.0',
                    'Accept': 'application/json'
                }
            });
            
            if (!response.ok) {
                throw new Error(`Search failed: ${response.status} ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log(`Received ${data.length} results for "${query}"`);
            
            const results = this.processAndFilterResults(data, location, city, type);
            
            this.cache.set(cacheKey, {
                results: results,
                timestamp: Date.now(),
                query: query,
                city: city
            });
            
            if (type === 'destination' && results.length > 0) {
                this.addToHistory(query, results[0], type);
            }
            
            this.lastSearch = Date.now();
            
            return results;
        } catch (error) {
            console.error('Search error:', error);
            
            if (AppState.currentCity) {
                const fallbackResults = await this.localCitySearch(query, AppState.currentCity, location);
                if (fallbackResults.length > 0) {
                    console.log(`Using fallback local search: ${fallbackResults.length} results`);
                    return fallbackResults;
                }
            }
            
            EnhancedUIUpdater.showToast('Search service temporarily unavailable. Please try again.', 'warning');
            return [];
        } finally {
            this.activeSearches.delete(searchId);
            this.showSearchLoading(false, type);
        }
    },
    
    buildSearchUrl: function(query, city, location) {
        const bounds = this.getCityBounds(city);
        const params = new URLSearchParams({
            q: `${query}${city ? `, ${city}, Zambia` : ', Zambia'}`,
            format: 'json',
            limit: 15,
            countrycodes: 'zm',
            'accept-language': 'en',
            addressdetails: 1
        });
        
        if (bounds) {
            params.append('viewbox', bounds.join(','));
            params.append('bounded', 1);
        }
        
        return `https://nominatim.openstreetmap.org/search?${params}`;
    },
    
    getCityBounds: function(cityName) {
        const cityBounds = {
            'Lusaka': [27.8, -15.8, 28.8, -15.2],
            'Ndola': [28.5, -13.1, 28.8, -12.9],
            'Kitwe': [27.9, -13.1, 28.4, -12.7],
            'Kabwe': [28.3, -14.6, 28.6, -14.3],
            'Livingstone': [25.7, -18.0, 26.0, -17.7],
            'Chipata': [32.5, -13.8, 32.8, -13.6],
            'Chingola': [27.8, -12.8, 27.9, -12.4],
            'Mufulira': [28.1, -12.7, 28.3, -12.5],
            'Luanshya': [28.3, -13.2, 28.5, -13.0],
            'Kasama': [31.1, -10.3, 31.3, -10.1],
            'Solwezi': [26.3, -12.3, 26.5, -12.1],
            'Mazabuka': [27.7, -15.9, 27.9, -15.7]
        };
        
        return cityBounds[cityName] || null;
    },
    
    processAndFilterResults: function(data, location, city, type) {
        if (!data || data.length === 0) return [];
        
        const cityLower = city.toLowerCase();
        const processedResults = [];
        
        data.forEach(place => {
            try {
                const address = place.address || {};
                const placeCity = address.city || address.town || address.village || address.municipality;
                const placeCityLower = placeCity ? placeCity.toLowerCase() : '';
                
                if (city && !this.isInCity(place, cityLower, placeCityLower)) {
                    return;
                }
                
                let distance = 0;
                if (location) {
                    distance = this.calculateDistance(
                        location.lat, location.lng,
                        parseFloat(place.lat), parseFloat(place.lon)
                    );
                }
                
                const displayAddress = this.formatAddress(place, city);
                
                const result = {
                    id: place.place_id || `${place.lat}-${place.lon}`,
                    name: place.display_name.split(',')[0] || 'Unnamed Location',
                    address: displayAddress,
                    fullAddress: place.display_name,
                    lat: parseFloat(place.lat),
                    lng: parseFloat(place.lon),
                    type: place.type || place.class || 'unknown',
                    importance: place.importance || 0,
                    distance: distance,
                    city: placeCity || city,
                    placeType: place.type,
                    category: this.categorizePlace(place),
                    relevance: this.calculateRelevance(place, location, city, type),
                    isVerified: this.isVerifiedLocation(place)
                };
                
                processedResults.push(result);
            } catch (error) {
                console.error('Error processing search result:', error, place);
            }
        });
        
        return processedResults
            .sort((a, b) => {
                if (a.isVerified !== b.isVerified) {
                    return b.isVerified - a.isVerified;
                }
                
                if (a.relevance !== b.relevance) {
                    return b.relevance - a.relevance;
                }
                
                if (location && a.distance !== b.distance) {
                    return a.distance - b.distance;
                }
                
                return b.importance - a.importance;
            })
            .slice(0, 10);
    },
    
    isInCity: function(place, targetCity, placeCity) {
        if (!targetCity) return true;
        
        if (placeCity && placeCity.includes(targetCity)) {
            return true;
        }
        
        const address = place.address || {};
        const components = [
            address.city,
            address.town,
            address.village,
            address.municipality,
            address.county,
            address.state_district
        ].filter(Boolean);
        
        return components.some(component => 
            component.toLowerCase().includes(targetCity)
        );
    },
    
    calculateRelevance: function(place, location, city, type) {
        let score = place.importance || 0;
        
        if (city) {
            const address = place.address || {};
            const placeCity = address.city || address.town || address.village;
            if (placeCity && placeCity.toLowerCase().includes(city.toLowerCase())) {
                score += 0.4;
            }
        }
        
        if (location) {
            const distance = this.calculateDistance(
                location.lat, location.lng,
                parseFloat(place.lat), parseFloat(place.lon)
            );
            
            if (distance < 1) score += 0.3;
            else if (distance < 3) score += 0.2;
            else if (distance < 5) score += 0.1;
            else if (distance < 10) score += 0.05;
        }
        
        if (type === 'destination') {
            if (place.type === 'restaurant' || place.type === 'hotel' || 
                place.type === 'mall' || place.type === 'supermarket') {
                score += 0.2;
            }
        }
        
        return Math.min(score, 1.0);
    },
    
    formatAddress: function(place, currentCity) {
        const address = place.address || {};
        const parts = [];
        
        if (address.road) {
            parts.push(address.road);
        }
        
        if (address.suburb || address.neighbourhood) {
            parts.push(address.suburb || address.neighbourhood);
        }
        
        if (address.city || address.town) {
            const cityName = address.city || address.town;
            if (cityName.toLowerCase() !== currentCity.toLowerCase()) {
                parts.push(cityName);
            }
        }
        
        if (parts.length === 0) {
            return place.display_name.split(',').slice(0, 2).join(',').trim();
        }
        
        return parts.join(', ');
    },
    
    categorizePlace: function(place) {
        const type = place.type || place.class || '';
        
        if (type.includes('restaurant') || type.includes('cafe') || type.includes('fast_food')) {
            return 'restaurant';
        } else if (type.includes('hotel') || type.includes('motel') || type.includes('guest_house')) {
            return 'hotel';
        } else if (type.includes('mall') || type.includes('supermarket') || type.includes('shop')) {
            return 'shopping';
        } else if (type.includes('bank') || type.includes('atm')) {
            return 'bank';
        } else if (type.includes('hospital') || type.includes('clinic') || type.includes('pharmacy')) {
            return 'medical';
        } else if (type.includes('school') || type.includes('university') || type.includes('college')) {
            return 'education';
        } else {
            return 'other';
        }
    },
    
    isVerifiedLocation: function(place) {
        const verifiedTypes = [
            'restaurant', 'hotel', 'mall', 'supermarket', 'bank', 'hospital',
            'clinic', 'school', 'university', 'government'
        ];
        
        const type = place.type || place.class || '';
        return verifiedTypes.some(verifiedType => type.includes(verifiedType));
    },
    
    calculateDistance: function(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = this.toRad(lat2 - lat1);
        const dLon = this.toRad(lon2 - lon1);
        const a = 
            Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(this.toRad(lat1)) * Math.cos(this.toRad(lat2)) * 
            Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    },
    
    toRad: function(value) {
        return value * Math.PI / 180;
    },
    
    searchEmergencyStations: async function(type, city) {
        const cacheKey = `emergency-${type}-${city}`;
        
        if (this.cache.has(cacheKey)) {
            const cached = this.cache.get(cacheKey);
            if (Date.now() - cached.timestamp < 3600000) {
                return cached.results;
            }
        }
        
        try {
            let query = '';
            switch(type) {
                case 'police':
                    query = `police station ${city} Zambia`;
                    break;
                case 'fire':
                    query = `fire station ${city} Zambia`;
                    break;
                case 'medical':
                    query = `hospital ${city} Zambia clinic ${city} Zambia`;
                    break;
            }
            
            const results = await this.search(query, 'emergency', AppState.userLocation, city);
            
            this.cache.set(cacheKey, {
                results: results,
                timestamp: Date.now()
            });
            
            AppState.emergencyStations[type] = results;
            return results;
        } catch (error) {
            console.error('Emergency station search error:', error);
            return [];
        }
    },
    
    searchShoppingPlaces: async function(category, city) {
        const cacheKey = `shopping-${category}-${city}`;
        
        if (this.cache.has(cacheKey)) {
            const cached = this.cache.get(cacheKey);
            if (Date.now() - cached.timestamp < 3600000) {
                return cached.results;
            }
        }
        
        try {
            let query = '';
            switch(category) {
                case 'restaurant':
                    query = 'restaurant fast food cafe';
                    break;
                case 'pharmacy':
                    query = 'pharmacy drugstore chemist';
                    break;
                case 'supermarket':
                    query = 'supermarket grocery store';
                    break;
                case 'mall':
                    query = 'mall shopping center';
                    break;
            }
            
            const results = await this.search(query, 'shopping', AppState.userLocation, city);
            
            const filteredResults = results.filter(place => {
                if (category === 'restaurant') {
                    const name = place.name.toLowerCase();
                    return name.includes('pizza') || name.includes('nando') || name.includes('hungry lion');
                }
                return true;
            });
            
            this.cache.set(cacheKey, {
                results: filteredResults,
                timestamp: Date.now()
            });
            
            return filteredResults;
        } catch (error) {
            console.error('Shopping search error:', error);
            return [];
        }
    },
    
    showSearchLoading: function(show, type) {
        const loadingId = `${type}SearchLoading`;
        const loadingElement = document.getElementById(loadingId);
        if (loadingElement) {
            loadingElement.style.display = show ? 'block' : 'none';
        }
    },
    
    getSearchHistory: function(type = null, city = null) {
        let history = this.searchHistory;
        
        if (type) {
            history = history.filter(item => item.type === type);
        }
        
        if (city) {
            history = history.filter(item => item.city === city);
        }
        
        return history;
    }
};

// ============================================
// ENHANCED PRICE CALCULATOR
// ============================================
const EnhancedPriceCalculator = {
    calculateRideFare: function(distanceKm, rideType = 'standard', surge = 1.0) {
        const config = AppState.rideTypes[rideType] || AppState.rideTypes.standard;
        
        let fare = config.base + (distanceKm * config.perKm);
        fare *= config.multiplier;
        fare *= surge;
        fare = Math.max(fare, config.min);
        
        return Math.round(fare * 100) / 100;
    },
    
    calculateEmergencyFare: function(distanceKm, serviceType) {
        const config = AppState.emergencyServices[serviceType] || AppState.emergencyServices.police;
        
        let fare = config.base + (distanceKm * config.perKm);
        fare *= config.multiplier;
        fare = Math.max(fare, config.min);
        
        return Math.round(fare * 100) / 100;
    },
    
    calculateDeliveryFare: function(distanceKm, deliveryType = 'standard') {
        const config = AppState.deliveryTypes[deliveryType] || AppState.deliveryTypes.standard;
        
        let fare = config.base + (distanceKm * config.perKm);
        fare *= config.multiplier;
        
        return Math.round(fare * 100) / 100;
    },
    
    calculateTruckFare: function(distanceKm, truckType = 'light') {
        const config = AppState.truckTypes[truckType] || AppState.truckTypes.light;
        
        let fare = config.base + (distanceKm * config.perKm);
        fare *= config.multiplier;
        
        return Math.round(fare * 100) / 100;
    },
    
    calculateShoppingFare: function(distanceKm, itemsCount = 1) {
        let fare = 30 + (distanceKm * 2.5) + (itemsCount * 5);
        return Math.round(fare * 100) / 100;
    },
    
    calculateSplitFare: function(totalFare, numberOfPeople) {
        const share = totalFare / numberOfPeople;
        return Math.round(share * 100) / 100;
    },
    
    calculateDistance: function(lat1, lon1, lat2, lon2) {
        return EnhancedSearchEngine.calculateDistance(lat1, lon1, lat2, lon2);
    },
    
    estimateTime: function(distanceKm, rideType = 'standard') {
        const baseSpeed = rideType === 'premium' ? 45 : 35;
        let baseTime = (distanceKm / baseSpeed) * 60;
        
        const traffic = this.getTrafficFactor();
        baseTime *= traffic;
        
        if (rideType === 'premium') {
            baseTime += 2;
        } else {
            baseTime += 5;
        }
        
        return Math.ceil(baseTime);
    },
    
    getTrafficFactor: function() {
        const hour = new Date().getHours();
        const day = new Date().getDay();
        
        if (day >= 1 && day <= 5) {
            if ((hour >= 7 && hour <= 9) || (hour >= 16 && hour <= 19)) {
                return 1.5;
            }
        }
        
        if (day === 6 || day === 0) {
            if (hour >= 12 && hour <= 16) {
                return 1.3;
            }
        }
        
        return 1.0;
    },
    
    getSurgeMultiplier: function() {
        const hour = new Date().getHours();
        const day = new Date().getDay();
        
        if (day >= 1 && day <= 5) {
            if (hour >= 7 && hour <= 9) return 1.5;
            if (hour >= 16 && hour <= 19) return 1.8;
        }
        
        if (day === 5 || day === 6) {
            if (hour >= 20 && hour <= 23) return 2.0;
        }
        
        if (hour >= 22 || hour <= 5) return 1.8;
        
        return 1.0;
    },
    
    calculateRouteWithStops: function(start, stops, end) {
        let totalDistance = 0;
        let totalTime = 0;
        
        const points = [start, ...stops, end];
        
        for (let i = 0; i < points.length - 1; i++) {
            const distance = this.calculateDistance(
                points[i].lat, points[i].lng,
                points[i + 1].lat, points[i + 1].lng
            );
            totalDistance += distance;
            totalTime += this.estimateTime(distance, 'standard');
        }
        
        return { totalDistance, totalTime };
    },
    
    validateDistanceWithinCity: function(startLat, startLng, endLat, endLng, city) {
        const distance = this.calculateDistance(startLat, startLng, endLat, endLng);
        
        const maxCityDistance = {
            'Lusaka': 50,
            'Ndola': 30,
            'Kitwe': 25,
            'Livingstone': 20,
            'Kabwe': 20,
            'Chipata': 15,
            'default': 25
        };
        
        const maxDistance = maxCityDistance[city] || maxCityDistance.default;
        
        if (distance > maxDistance) {
            return {
                valid: false,
                distance: distance,
                maxAllowed: maxDistance,
                message: `Distance exceeds maximum allowed for ${city} (${maxDistance}km)`
            };
        }
        
        return {
            valid: true,
            distance: distance
        };
    }
};

// ============================================
// ENHANCED UI UPDATER
// ============================================
const EnhancedUIUpdater = {
    updateWalletBalance: function(balance) {
        const formatted = `ZMW ${balance.toFixed(2)}`;
        const walletBalance = document.getElementById('walletBalance');
        const accountBalance = document.getElementById('accountBalance');
        const paymentBalance = document.getElementById('paymentBalance');
        
        if (walletBalance) walletBalance.textContent = formatted;
        if (accountBalance) accountBalance.textContent = formatted;
        if (paymentBalance) paymentBalance.textContent = formatted;
        
        AppState.walletBalance = balance;
    },
    
    updateUserInfo: function(userData) {
        if (userData.name) {
            const userFullName = document.getElementById('userFullName');
            const accountName = document.getElementById('accountName');
            if (userFullName) userFullName.textContent = userData.name;
            if (accountName) accountName.textContent = userData.name;
        }
        
        if (userData.phone) {
            const accountPhone = document.getElementById('accountPhone');
            if (accountPhone) accountPhone.textContent = userData.phone;
        }
        
        if (userData.referralCode) {
            const referralCode = document.getElementById('referralCode');
            if (referralCode) referralCode.textContent = userData.referralCode;
        }
    },
    
    showToast: function(message, type = 'info', duration = 3000) {
        const toastContainer = document.getElementById('toastContainer');
        if (!toastContainer) return null;
        
        const toastId = 'toast-' + Date.now();
        
        const icons = {
            success: 'fa-check-circle',
            error: 'fa-exclamation-circle',
            warning: 'fa-exclamation-triangle',
            info: 'fa-info-circle'
        };
        
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.id = toastId;
        toast.innerHTML = `
            <div class="toast-icon">
                <i class="fas ${icons[type] || icons.info}"></i>
            </div>
            <div class="toast-content">
                <div class="toast-message">${message}</div>
            </div>
            <button class="toast-close" onclick="this.parentElement.remove()">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        toastContainer.appendChild(toast);
        
        setTimeout(() => {
            const toastElement = document.getElementById(toastId);
            if (toastElement) {
                toastElement.remove();
            }
        }, duration);
        
        return toastId;
    },
    
    showLoading: function(message = 'Loading...') {
        const overlay = document.getElementById('loadingOverlay');
        const text = document.getElementById('loadingText');
        if (overlay && text) {
            text.textContent = message;
            overlay.style.display = 'flex';
        }
    },
    
    hideLoading: function() {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
            overlay.style.display = 'none';
        }
    },
    
    showMapLoading: function() {
        const mapLoadingOverlay = document.getElementById('mapLoadingOverlay');
        if (mapLoadingOverlay) {
            mapLoadingOverlay.style.display = 'flex';
        }
    },
    
    hideMapLoading: function() {
        const mapLoadingOverlay = document.getElementById('mapLoadingOverlay');
        if (mapLoadingOverlay) {
            mapLoadingOverlay.style.display = 'none';
        }
    },
    
    updateCityDisplay: function(city) {
        const display = document.getElementById('currentCityDisplay');
        if (display && city) {
            display.textContent = `City: ${city}`;
            display.parentElement.style.display = 'flex';
            
            setTimeout(() => {
                if (display.parentElement) {
                    display.parentElement.style.display = 'none';
                }
            }, 5000);
        }
    },
    
    updateRidePrices: function(distanceKm) {
        const types = ['economy', 'standard', 'premium'];
        const surge = EnhancedPriceCalculator.getSurgeMultiplier();
        
        // Update ride type cards
        types.forEach(type => {
            const price = EnhancedPriceCalculator.calculateRideFare(distanceKm, type, surge);
            const card = document.querySelector(`.ride-type-card[data-type="${type}"]`);
            if (card) {
                const priceElement = card.querySelector('.ride-type-price');
                if (priceElement) priceElement.textContent = `ZMW ${price.toFixed(2)}`;
            }
        });
        
        // Update main fare display
        const selectedPrice = EnhancedPriceCalculator.calculateRideFare(distanceKm, AppState.selectedRideType, surge);
        const estimatedFare = document.getElementById('estimatedFare');
        if (estimatedFare) estimatedFare.textContent = `ZMW ${selectedPrice.toFixed(2)}`;
        
        const time = EnhancedPriceCalculator.estimateTime(distanceKm, AppState.selectedRideType);
        const distanceDetail = document.getElementById('distanceDetail');
        const timeDetail = document.getElementById('timeDetail');
        
        if (distanceDetail) distanceDetail.textContent = `${distanceKm.toFixed(1)} km`;
        if (timeDetail) timeDetail.textContent = `ETA: ${time} min`;
        
        AppState.rideFare = selectedPrice;
    },
    
    updateDeliveryPrices: function(distanceKm, deliveryType = 'standard') {
        const display = document.getElementById('deliveryFareDisplay');
        const fareElement = document.getElementById('deliveryFare');
        const distanceElement = document.getElementById('deliveryDistance');
        const timeElement = document.getElementById('deliveryTime');
        
        if (!display || !fareElement || !distanceElement || !timeElement) return;
        
        const fare = EnhancedPriceCalculator.calculateDeliveryFare(distanceKm, deliveryType);
        const time = EnhancedPriceCalculator.estimateTime(distanceKm, 'standard');
        
        display.style.display = 'block';
        fareElement.textContent = `ZMW ${fare.toFixed(2)}`;
        distanceElement.textContent = `${distanceKm.toFixed(1)} km`;
        timeElement.textContent = `ETA: ${time} min`;
        
        return { fare, time };
    },
    
    updateTruckPrices: function(distanceKm, truckType = 'light') {
        const display = document.getElementById('truckFareDisplay');
        const fareElement = document.getElementById('truckFare');
        const distanceElement = document.getElementById('truckDistance');
        const timeElement = document.getElementById('truckTime');
        
        if (!display || !fareElement || !distanceElement || !timeElement) return;
        
        const fare = EnhancedPriceCalculator.calculateTruckFare(distanceKm, truckType);
        const time = EnhancedPriceCalculator.estimateTime(distanceKm, 'standard');
        
        display.style.display = 'block';
        fareElement.textContent = `ZMW ${fare.toFixed(2)}`;
        distanceElement.textContent = `${distanceKm.toFixed(1)} km`;
        timeElement.textContent = `ETA: ${time} min`;
        
        return { fare, time };
    },
    
    updateShoppingPrices: function(distanceKm, itemsCount = 1) {
        const display = document.getElementById('shoppingFareDisplay');
        const fareElement = document.getElementById('shoppingFare');
        const distanceElement = document.getElementById('shoppingDistance');
        const timeElement = document.getElementById('shoppingTime');
        
        if (!display || !fareElement || !distanceElement || !timeElement) return;
        
        const fare = EnhancedPriceCalculator.calculateShoppingFare(distanceKm, itemsCount);
        const time = EnhancedPriceCalculator.estimateTime(distanceKm, 'standard') + 30;
        
        display.style.display = 'block';
        fareElement.textContent = `ZMW ${fare.toFixed(2)}`;
        distanceElement.textContent = `${distanceKm.toFixed(1)} km`;
        timeElement.textContent = `ETA: ${time} min`;
        
        return { fare, time };
    },
    
    updateSplitRidePrices: function(distanceKm) {
        const surge = EnhancedPriceCalculator.getSurgeMultiplier();
        const totalFare = EnhancedPriceCalculator.calculateRideFare(distanceKm, AppState.selectedRideType, surge);
        const numberOfPeople = AppState.splitRideFriends.length + 1;
        const share = EnhancedPriceCalculator.calculateSplitFare(totalFare, numberOfPeople);
        
        const breakdown = document.getElementById('splitFareBreakdown');
        const totalFareElement = document.getElementById('splitTotalFare');
        const yourShareElement = document.getElementById('splitYourShare');
        const friendShareElement = document.getElementById('splitFriendShare');
        
        if (breakdown) breakdown.style.display = 'block';
        if (totalFareElement) totalFareElement.textContent = `ZMW ${totalFare.toFixed(2)}`;
        if (yourShareElement) yourShareElement.textContent = `ZMW ${share.toFixed(2)}`;
        if (friendShareElement) friendShareElement.textContent = `ZMW ${share.toFixed(2)}`;
        
        return { totalFare, share, numberOfPeople };
    },
    
    updateBroadcastPrices: function(distanceKm) {
        const surge = EnhancedPriceCalculator.getSurgeMultiplier();
        const fare = EnhancedPriceCalculator.calculateRideFare(distanceKm, 'standard', surge);
        
        const display = document.getElementById('broadcastFareDisplay');
        const fareElement = document.getElementById('broadcastFare');
        const distanceElement = document.getElementById('broadcastDistance');
        const timeElement = document.getElementById('broadcastTime');
        
        if (!display || !fareElement || !distanceElement || !timeElement) return;
        
        display.style.display = 'block';
        fareElement.textContent = `ZMW ${fare.toFixed(2)}`;
        distanceElement.textContent = `${distanceKm.toFixed(1)} km`;
        timeElement.textContent = `ETA: ${EnhancedPriceCalculator.estimateTime(distanceKm, 'standard')} min`;
        
        return fare;
    },
    
    showSearchSuggestions: function(inputId, results, type = 'destination') {
        const container = document.getElementById(`${inputId}Suggestions`);
        if (!container) {
            console.error(`Suggestions container not found for ${inputId}`);
            return;
        }
        
        container.innerHTML = '';
        
        if (results.length === 0) {
            container.innerHTML = `
                <div class="no-results">
                    <i class="fas fa-search"></i>
                    <div>No results found in ${AppState.currentCity}</div>
                </div>
            `;
        } else {
            results.forEach(result => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.dataset.lat = result.lat;
                item.dataset.lng = result.lng;
                item.dataset.address = result.address;
                item.dataset.name = result.name;
                
                let icon = 'fa-map-marker-alt';
                let iconColor = '#FF6B35';
                
                if (result.category === 'restaurant') {
                    icon = 'fa-utensils';
                    iconColor = '#FFC107';
                } else if (result.category === 'hotel') {
                    icon = 'fa-hotel';
                    iconColor = '#2196F3';
                } else if (result.category === 'shopping') {
                    icon = 'fa-shopping-cart';
                    iconColor = '#9C27B0';
                } else if (result.category === 'medical') {
                    icon = 'fa-hospital';
                    iconColor = '#F44336';
                }
                
                item.innerHTML = `
                    <div class="suggestion-icon" style="color: ${iconColor}">
                        <i class="fas ${icon}"></i>
                    </div>
                    <div class="suggestion-details">
                        <div class="suggestion-name">${result.name}</div>
                        <div class="suggestion-address">${result.address}</div>
                        ${result.distance ? `<div class="suggestion-distance">${result.distance.toFixed(1)} km away</div>` : ''}
                    </div>
                `;
                
                item.addEventListener('click', () => {
                    const location = {
                        lat: result.lat,
                        lng: result.lng,
                        address: result.address,
                        name: result.name
                    };
                    
                    if (type === 'pickup') {
                        AppState.pickup = location;
                        const input = document.getElementById(inputId);
                        if (input) input.value = location.address;
                    } else {
                        AppState.destination = location;
                        const input = document.getElementById(inputId);
                        if (input) input.value = location.address;
                        
                        if (AppState.pickup) {
                            this.updatePricesAndRoute();
                        }
                    }
                    
                    container.style.display = 'none';
                });
                
                container.appendChild(item);
            });
        }
        
        container.style.display = 'block';
    },
    
    updatePricesAndRoute: function() {
        if (AppState.pickup && AppState.destination) {
            const distance = EnhancedPriceCalculator.calculateDistance(
                AppState.pickup.lat, AppState.pickup.lng,
                AppState.destination.lat, AppState.destination.lng
            );
            
            // Update prices based on active service
            switch(AppState.activeService) {
                case 'car':
                    this.updateRidePrices(distance);
                    break;
                case 'delivery':
                    this.updateDeliveryPrices(distance);
                    break;
                case 'short-delivery':
                    this.updateDeliveryPrices(distance);
                    break;
                case 'truck':
                    this.updateTruckPrices(distance);
                    break;
                case 'express':
                    this.updateShoppingPrices(distance);
                    break;
                case 'split':
                    this.updateSplitRidePrices(distance);
                    break;
                case 'broadcast':
                    this.updateBroadcastPrices(distance);
                    break;
            }
            
            // Draw route on map
            this.drawRoute(AppState.pickup, AppState.destination);
        }
    },
    
    drawRoute: async function(start, end) {
        if (!map) return;
        
        if (routeLayer) {
            map.removeLayer(routeLayer);
        }
        
        try {
            const response = await fetch(
                `https://router.project-osrm.org/route/v1/driving/${start.lng},${start.lat};${end.lng},${end.lat}?overview=full&geometries=geojson`
            );
            
            if (response.ok) {
                const data = await response.json();
                
                if (data.routes && data.routes.length > 0) {
                    const route = data.routes[0];
                    const routeCoordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                    
                    routeLayer = L.polyline(routeCoordinates, {
                        color: '#FF6B35',
                        weight: 4,
                        opacity: 0.7
                    }).addTo(map);
                    
                    const bounds = L.latLngBounds(routeCoordinates);
                    map.fitBounds(bounds, { padding: [50, 50] });
                    
                    // Update markers
                    if (pickupMarker) {
                        pickupMarker.setLatLng([start.lat, start.lng]);
                    } else {
                        pickupMarker = L.marker([start.lat, start.lng], {
                            icon: L.divIcon({
                                className: 'pickup-marker',
                                html: '<i class="fas fa-map-marker-alt"></i>',
                                iconSize: [20, 20]
                            })
                        }).addTo(map).bindPopup('Pickup Location');
                    }
                    
                    if (destinationMarker) {
                        destinationMarker.setLatLng([end.lat, end.lng]);
                    } else {
                        destinationMarker = L.marker([end.lat, end.lng], {
                            icon: L.divIcon({
                                className: 'destination-marker',
                                html: '<i class="fas fa-flag"></i>',
                                iconSize: [20, 20]
                            })
                        }).addTo(map).bindPopup('Destination');
                    }
                }
            }
        } catch (error) {
            console.error('Routing error:', error);
            // Fallback: draw straight line
            routeLayer = L.polyline([
                [start.lat, start.lng],
                [end.lat, end.lng]
            ], {
                color: '#FF6B35',
                weight: 3,
                opacity: 0.7,
                dashArray: '10, 10'
            }).addTo(map);
        }
    },
    
    showPulsingRideIcon: function(serviceType) {
        this.removePulsingRideIcon();
        
        let iconClass = 'fa-car';
        if (serviceType === 'truck') {
            iconClass = 'fa-truck';
        } else if (serviceType === 'delivery' || serviceType === 'short-delivery') {
            iconClass = 'fa-shipping-fast';
        } else if (serviceType === 'express') {
            iconClass = 'fa-shopping-bag';
        }
        
        pulsingIcon = document.createElement('div');
        pulsingIcon.id = 'pulsingRideIcon';
        pulsingIcon.className = 'pulsing-ride-icon';
        pulsingIcon.innerHTML = `<i class="fas ${iconClass}"></i>`;
        pulsingIcon.style.cssText = `
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 60px;
            color: #FF6B35;
            z-index: 1000;
            animation: pulse 1.5s infinite;
            pointer-events: none;
        `;
        
        const mapContainer = document.getElementById('map');
        if (mapContainer) {
            mapContainer.appendChild(pulsingIcon);
        }
    },
    
    removePulsingRideIcon: function() {
        const pulsingIcon = document.getElementById('pulsingRideIcon');
        if (pulsingIcon) {
            pulsingIcon.remove();
        }
    },
    
    showStops: function() {
        const container = document.getElementById('stopsContainer');
        if (!container) return;
        
        container.innerHTML = '';
        
        AppState.activeStops.forEach((stop, index) => {
            const stopElement = document.createElement('div');
            stopElement.className = 'stop-item';
            stopElement.innerHTML = `
                <div class="stop-number">${index + 1}</div>
                <div class="stop-address">${stop.address}</div>
                <button class="remove-stop" data-index="${index}">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.appendChild(stopElement);
            
            stopElement.querySelector('.remove-stop').addEventListener('click', () => {
                this.removeStop(index);
            });
        });
        
        // Update route with stops
        if (AppState.pickup && AppState.destination && AppState.activeStops.length > 0) {
            this.updateRouteWithStops();
        }
    },
    
    updateRouteWithStops: function() {
        if (!map || !AppState.pickup || !AppState.destination) return;
        
        const allPoints = [AppState.pickup, ...AppState.activeStops, AppState.destination];
        
        if (routeLayer) {
            map.removeLayer(routeLayer);
        }
        
        // Clear existing stop markers
        stopMarkers.forEach(marker => map.removeLayer(marker));
        stopMarkers = [];
        
        // Create route through all points
        const routeCoordinates = allPoints.map(point => [point.lat, point.lng]);
        routeLayer = L.polyline(routeCoordinates, {
            color: '#FF6B35',
            weight: 4,
            opacity: 0.7,
            dashArray: '5, 5'
        }).addTo(map);
        
        // Add markers for stops
        AppState.activeStops.forEach((stop, index) => {
            const marker = L.marker([stop.lat, stop.lng], {
                icon: L.divIcon({
                    className: 'stop-marker',
                    html: `<div>${index + 1}</div>`,
                    iconSize: [24, 24]
                })
            }).addTo(map).bindPopup(`Stop ${index + 1}: ${stop.address}`);
            stopMarkers.push(marker);
        });
        
        // Update prices based on total distance
        let totalDistance = 0;
        for (let i = 0; i < allPoints.length - 1; i++) {
            totalDistance += EnhancedPriceCalculator.calculateDistance(
                allPoints[i].lat, allPoints[i].lng,
                allPoints[i + 1].lat, allPoints[i + 1].lng
            );
        }
        
        this.updatePricesAndRoute();
    },
    
    removeStop: function(index) {
        AppState.activeStops.splice(index, 1);
        this.showStops();
        this.updateRouteWithStops();
    },
    
    showSplitFriends: function() {
        const container = document.getElementById('splitFriendsList');
        if (!container) return;
        
        container.innerHTML = '';
        
        if (AppState.splitRideFriends.length === 0) {
            container.innerHTML = '<div class="empty-friends">No friends added yet</div>';
            return;
        }
        
        AppState.splitRideFriends.forEach((friend, index) => {
            const friendElement = document.createElement('div');
            friendElement.className = 'friend-item';
            friendElement.innerHTML = `
                <div class="friend-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="friend-info">
                    <div class="friend-name">${friend.name}</div>
                    <div class="friend-code">${friend.code}</div>
                </div>
                <button class="remove-friend" data-index="${index}">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.appendChild(friendElement);
            
            friendElement.querySelector('.remove-friend').addEventListener('click', () => {
                this.removeSplitFriend(index);
            });
        });
        
        // Update split ride prices
        if (AppState.pickup && AppState.destination) {
            this.updateSplitRidePrices(
                EnhancedPriceCalculator.calculateDistance(
                    AppState.pickup.lat, AppState.pickup.lng,
                    AppState.destination.lat, AppState.destination.lng
                )
            );
        }
    },
    
    removeSplitFriend: function(index) {
        AppState.splitRideFriends.splice(index, 1);
        this.showSplitFriends();
    },
    
    showBroadcastRecipients: function() {
        const container = document.getElementById('broadcastRecipientsList');
        if (!container) return;
        
        container.innerHTML = '';
        
        if (AppState.broadcastRecipients.length === 0) {
            container.innerHTML = '<div class="empty-recipients">No recipients added yet</div>';
            return;
        }
        
        AppState.broadcastRecipients.forEach((recipient, index) => {
            const recipientElement = document.createElement('div');
            recipientElement.className = 'recipient-item';
            recipientElement.innerHTML = `
                <div class="recipient-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="recipient-info">
                    <div class="recipient-name">${recipient.name}</div>
                    <div class="recipient-code">${recipient.code}</div>
                </div>
                <button class="remove-recipient" data-index="${index}">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.appendChild(recipientElement);
            
            recipientElement.querySelector('.remove-recipient').addEventListener('click', () => {
                this.removeBroadcastRecipient(index);
            });
        });
    },
    
    removeBroadcastRecipient: function(index) {
        AppState.broadcastRecipients.splice(index, 1);
        this.showBroadcastRecipients();
    },
    
    showEmergencyStations: function(stations) {
        const container = document.getElementById('emergencyStations');
        if (!container) return;
        
        container.innerHTML = '';
        
        if (stations.length === 0) {
            container.innerHTML = '<div class="no-stations">No emergency stations found</div>';
            return;
        }
        
        stations.forEach((station, index) => {
            const stationElement = document.createElement('div');
            stationElement.className = 'emergency-station';
            stationElement.dataset.index = index;
            stationElement.innerHTML = `
                <div class="station-header">
                    <div class="station-name">${station.name}</div>
                    <div class="station-distance">${station.distance.toFixed(1)} km</div>
                </div>
                <div class="station-address">${station.address}</div>
            `;
            
            stationElement.addEventListener('click', () => {
                document.querySelectorAll('.emergency-station').forEach(s => {
                    s.classList.remove('selected');
                });
                stationElement.classList.add('selected');
                
                AppState.selectedEmergencyStation = station;
                this.updateEmergencyFare(station.distance);
            });
            
            container.appendChild(stationElement);
        });
        
        // Select first station by default
        if (stations.length > 0) {
            const firstStation = container.querySelector('.emergency-station');
            if (firstStation) {
                firstStation.classList.add('selected');
                AppState.selectedEmergencyStation = stations[0];
                this.updateEmergencyFare(stations[0].distance);
            }
        }
    },
    
    updateEmergencyFare: function(distance) {
        const serviceType = document.getElementById('emergencyServiceType')?.dataset.type || 'police';
        const fare = EnhancedPriceCalculator.calculateEmergencyFare(distance, serviceType);
        
        const totalFareElement = document.getElementById('emergencyTotalFare');
        const distanceElement = document.getElementById('emergencyDistance');
        
        if (totalFareElement) totalFareElement.textContent = `ZMW ${fare.toFixed(2)}`;
        if (distanceElement) distanceElement.textContent = `${distance.toFixed(1)} km`;
    },
    
    showShoppingPlaces: function(places) {
        const container = document.getElementById('shopCategoryDetails');
        if (!container) return;
        
        container.innerHTML = '';
        
        if (places.length === 0) {
            container.innerHTML = '<div class="no-shops">No shops found in this category</div>';
            return;
        }
        
        places.forEach(place => {
            const shopElement = document.createElement('div');
            shopElement.className = 'shop-item';
            shopElement.innerHTML = `
                <div class="shop-icon">
                    <i class="fas fa-store"></i>
                </div>
                <div class="shop-info">
                    <div class="shop-name">${place.name}</div>
                    <div class="shop-address">${place.address}</div>
                    <div class="shop-distance">${place.distance.toFixed(1)} km away</div>
                </div>
            `;
            
            shopElement.addEventListener('click', () => {
                AppState.pickup = {
                    lat: place.lat,
                    lng: place.lng,
                    address: place.address,
                    name: place.name
                };
                
                const shopLocationInput = document.getElementById('shopLocation');
                if (shopLocationInput) {
                    shopLocationInput.value = place.address;
                }
                
                hideModal('shoppingCategory');
                EnhancedUIUpdater.showToast('Shop location set', 'success');
            });
            
            container.appendChild(shopElement);
        });
    },
    
    showReferralDiscount: function() {
        const discountSection = document.getElementById('referralDiscountSection');
        if (discountSection) {
            discountSection.style.display = 'block';
        }
    },
    
    applyReferralDiscount: function(referrerName) {
        const originalFare = AppState.rideFare;
        const discount = originalFare * 0.5;
        const finalFare = originalFare - discount;
        
        AppState.referralDiscountApplied = true;
        
        const originalFareElement = document.getElementById('originalFareAmount');
        const discountElement = document.getElementById('discountAmount');
        const finalFareElement = document.getElementById('finalFareAmount');
        const referrerInfo = document.getElementById('referrerInfo');
        const discountBreakdown = document.getElementById('discountBreakdown');
        
        if (originalFareElement) originalFareElement.textContent = `ZMW ${originalFare.toFixed(2)}`;
        if (discountElement) discountElement.textContent = `-ZMW ${discount.toFixed(2)}`;
        if (finalFareElement) finalFareElement.textContent = `ZMW ${finalFare.toFixed(2)}`;
        if (referrerInfo) {
            referrerInfo.textContent = `Referral from ${referrerName}`;
            referrerInfo.style.display = 'block';
        }
        if (discountBreakdown) discountBreakdown.style.display = 'block';
        
        // Update payment amount
        const paymentAmount = document.getElementById('paymentAmount');
        if (paymentAmount) paymentAmount.textContent = `ZMW ${finalFare.toFixed(2)}`;
        
        EnhancedUIUpdater.showToast(`50% discount applied! Referral from ${referrerName}`, 'success');
    },
    
    showScheduleCountdown: function(scheduledTime) {
        const container = document.getElementById('scheduleCountdownContainer');
        if (!container) return;
        
        container.style.display = 'block';
        
        const updateCountdown = () => {
            const now = Date.now();
            const timeLeft = scheduledTime - now;
            
            if (timeLeft <= 0) {
                clearInterval(AppState.scheduledTimer);
                container.style.display = 'none';
                EnhancedFirebaseManager.requestScheduledRide();
                return;
            }
            
            const hours = Math.floor(timeLeft / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
            
            const hoursElement = document.getElementById('countdownHours');
            const minutesElement = document.getElementById('countdownMinutes');
            const secondsElement = document.getElementById('countdownSeconds');
            
            if (hoursElement) hoursElement.textContent = hours.toString().padStart(2, '0');
            if (minutesElement) minutesElement.textContent = minutes.toString().padStart(2, '0');
            if (secondsElement) secondsElement.textContent = seconds.toString().padStart(2, '0');
        };
        
        updateCountdown();
        
        if (AppState.scheduledTimer) {
            clearInterval(AppState.scheduledTimer);
        }
        
        AppState.scheduledTimer = setInterval(updateCountdown, 1000);
    },
    
    showSplitInvitation: function(invitationData) {
        const modal = document.getElementById('splitInvitationModal');
        if (!modal) return;
        
        const hostElement = document.getElementById('splitInvitationHost');
        const pickupElement = document.getElementById('splitInvitationPickup');
        const destinationElement = document.getElementById('splitInvitationDestination');
        const totalFareElement = document.getElementById('splitInvitationTotalFare');
        const yourShareElement = document.getElementById('splitInvitationYourShare');
        const participantsElement = document.getElementById('splitInvitationParticipants');
        
        if (hostElement) hostElement.textContent = invitationData.hostName;
        if (pickupElement) pickupElement.textContent = invitationData.pickup;
        if (destinationElement) destinationElement.textContent = invitationData.destination;
        if (totalFareElement) totalFareElement.textContent = `ZMW ${invitationData.totalFare.toFixed(2)}`;
        if (yourShareElement) yourShareElement.textContent = `ZMW ${invitationData.yourShare.toFixed(2)}`;
        if (participantsElement) participantsElement.textContent = invitationData.participants;
        
        modal.style.display = 'block';
        
        AppState.activeSplitInvitation = invitationData;
    },
    
    updateNotificationBadge: function(count) {
        const badge = document.getElementById('notificationCount');
        if (badge) {
            badge.textContent = count;
            if (count > 0) {
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }
    }
};

// ============================================
// ENHANCED FIREBASE MANAGER
// ============================================
const EnhancedFirebaseManager = {
    async loadUserData(uid) {
        try {
            EnhancedUIUpdater.showLoading('Loading your profile...');
            
            const snapshot = await database.ref(`users/${uid}`).once('value');
            AppState.userData = snapshot.val();
            
            if (AppState.userData) {
                AppState.walletBalance = AppState.userData.walletBalance || 0;
                EnhancedUIUpdater.updateWalletBalance(AppState.walletBalance);
                EnhancedUIUpdater.updateUserInfo(AppState.userData);
                
                await this.loadSOSConfig(uid);
                await this.loadScheduledRides(uid);
                await this.checkActiveRide(uid);
                await this.loadRideHistory(uid);
                await this.loadNotifications(uid);
                
                EnhancedSearchEngine.init();
                this.startRealtimeSync(uid);
                
                EnhancedUIUpdater.hideLoading();
                return true;
            } else {
                EnhancedUIUpdater.hideLoading();
                return false;
            }
        } catch (error) {
            console.error('Error loading user data:', error);
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Error loading user data', 'error');
            return false;
        }
    },
    
    startRealtimeSync: function(uid) {
        this.stopRealtimeSync();
        
        console.log('Starting real-time sync for user:', uid);
        
        // User data updates
        const userRef = database.ref(`users/${uid}`);
        AppState.realtimeListeners.push(
            userRef.on('value', (snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    AppState.userData = userData;
                    AppState.walletBalance = userData.walletBalance || 0;
                    EnhancedUIUpdater.updateWalletBalance(AppState.walletBalance);
                    EnhancedUIUpdater.updateUserInfo(userData);
                }
            })
        );
        
        // Active ride updates
        const activeRideRef = database.ref('rides')
            .orderByChild('passengerId')
            .equalTo(uid)
            .orderByChild('status')
            .startAt('requested')
            .endAt('started');
        
        AppState.realtimeListeners.push(
            activeRideRef.on('value', (snapshot) => {
                const rides = snapshot.val();
                if (rides) {
                    const rideId = Object.keys(rides)[0];
                    const ride = { id: rideId, ...rides[rideId] };
                    
                    if (!AppState.currentRide || AppState.currentRide.id !== rideId) {
                        AppState.currentRide = ride;
                        EnhancedUIUpdater.showRideInfo(ride);
                        
                        if (ride.driverId) {
                            this.listenToDriverLocation(ride.driverId);
                            this.loadDriverInfo(ride.driverId);
                        }
                        
                        this.listenToChatMessages(rideId);
                    } else {
                        AppState.currentRide = ride;
                        EnhancedUIUpdater.updateRideStatus(ride.status);
                        
                        if (ride.status === 'accepted' && AppState.sosConfig) {
                            const sosButton = document.getElementById('sosButton');
                            if (sosButton) sosButton.style.display = 'flex';
                        }
                        
                        if (ride.status === 'completed') {
                            this.handleRideCompletion(ride);
                        }
                    }
                } else if (AppState.currentRide) {
                    this.resetActiveRide();
                }
            })
        );
        
        // Notifications
        const notificationsRef = database.ref(`notifications/${uid}`)
            .orderByChild('timestamp')
            .limitToLast(20);
        
        AppState.realtimeListeners.push(
            notificationsRef.on('value', (snapshot) => {
                const notifications = snapshot.val();
                if (notifications) {
                    AppState.notifications = Object.values(notifications).reverse();
                    const unreadCount = AppState.notifications.filter(n => !n.read).length;
                    AppState.unreadNotifications = unreadCount;
                    EnhancedUIUpdater.updateNotificationBadge(unreadCount);
                }
            })
        );
        
        // Split ride invitations
        const splitInvitationsRef = database.ref('splitInvitations')
            .orderByChild('recipientId')
            .equalTo(uid)
            .orderByChild('status')
            .equalTo('pending');
        
        AppState.realtimeListeners.push(
            splitInvitationsRef.on('value', (snapshot) => {
                const invitations = snapshot.val();
                if (invitations) {
                    Object.entries(invitations).forEach(([invitationId, invitation]) => {
                        if (!AppState.activeSplitInvitation || AppState.activeSplitInvitation.id !== invitationId) {
                            EnhancedUIUpdater.showSplitInvitation({
                                id: invitationId,
                                hostName: invitation.hostName,
                                pickup: invitation.pickup,
                                destination: invitation.destination,
                                totalFare: invitation.totalFare,
                                yourShare: invitation.yourShare,
                                participants: invitation.participants
                            });
                        }
                    });
                }
            })
        );
        
        EnhancedUIUpdater.showToast('Real-time updates active', 'success');
    },
    
    stopRealtimeSync: function() {
        AppState.realtimeListeners.forEach(listener => {
            if (listener && typeof listener === 'function') {
                listener();
            }
        });
        AppState.realtimeListeners = [];
    },
    
    async loadSOSConfig(uid) {
        try {
            const snapshot = await database.ref(`sosConfig/${uid}`).once('value');
            AppState.sosConfig = snapshot.val();
        } catch (error) {
            console.error('Error loading SOS config:', error);
        }
    },
    
    async loadScheduledRides(uid) {
        try {
            const snapshot = await database.ref('scheduledRides')
                .orderByChild('passengerId')
                .equalTo(uid)
                .once('value');
            
            const rides = snapshot.val();
            if (rides) {
                AppState.scheduledRides = Object.values(rides).filter(ride => 
                    ride.status === 'scheduled'
                );
                
                // Show countdown for upcoming rides
                const now = Date.now();
                AppState.scheduledRides.forEach(ride => {
                    if (ride.scheduledTime > now) {
                        EnhancedUIUpdater.showScheduleCountdown(ride.scheduledTime);
                    }
                });
            }
        } catch (error) {
            console.error('Error loading scheduled rides:', error);
        }
    },
    
    async checkActiveRide(uid) {
        try {
            const snapshot = await database.ref('rides')
                .orderByChild('passengerId')
                .equalTo(uid)
                .orderByChild('status')
                .startAt('requested')
                .endAt('started')
                .once('value');
            
            const rides = snapshot.val();
            if (rides) {
                const rideId = Object.keys(rides)[0];
                AppState.currentRide = { id: rideId, ...rides[rideId] };
                EnhancedUIUpdater.showRideInfo(AppState.currentRide);
                
                this.listenToRideUpdates(rideId);
                
                if (AppState.currentRide.driverId) {
                    this.listenToDriverLocation(AppState.currentRide.driverId);
                    this.loadDriverInfo(AppState.currentRide.driverId);
                }
                
                this.listenToChatMessages(rideId);
                
                return true;
            }
            return false;
        } catch (error) {
            console.error('Error checking active ride:', error);
            return false;
        }
    },
    
    async loadRideHistory(uid) {
        try {
            const snapshot = await database.ref('rides')
                .orderByChild('passengerId')
                .equalTo(uid)
                .once('value');
            
            const rides = snapshot.val();
            if (rides) {
                const ridesArray = Object.keys(rides).map(id => ({
                    id,
                    ...rides[id]
                })).sort((a, b) => b.timestamp - a.timestamp);
                
                this.updateUserStats(ridesArray);
            }
        } catch (error) {
            console.error('Error loading ride history:', error);
        }
    },
    
    async loadNotifications(uid) {
        try {
            const snapshot = await database.ref(`notifications/${uid}`)
                .orderByChild('timestamp')
                .limitToLast(20)
                .once('value');
            
            const notifications = snapshot.val();
            if (notifications) {
                AppState.notifications = Object.values(notifications).reverse();
                const unreadCount = AppState.notifications.filter(n => !n.read).length;
                AppState.unreadNotifications = unreadCount;
                EnhancedUIUpdater.updateNotificationBadge(unreadCount);
            }
        } catch (error) {
            console.error('Error loading notifications:', error);
        }
    },
    
    async validateReferralCode(referralCode) {
        try {
            const snapshot = await database.ref('users')
                .orderByChild('referralCode')
                .equalTo(referralCode)
                .once('value');
            
            const users = snapshot.val();
            if (users) {
                const userId = Object.keys(users)[0];
                return {
                    valid: true,
                    userId: userId,
                    name: users[userId].name
                };
            }
            
            return { valid: false };
        } catch (error) {
            console.error('Error validating referral code:', error);
            return { valid: false };
        }
    },
    
    async requestRide(rideData) {
        try {
            EnhancedUIUpdater.showLoading('Requesting ride...');
            
            if (!rideData.pickup || !rideData.destination) {
                throw new Error('Pickup and destination locations are required');
            }
            
            const rideId = database.ref().child('rides').push().key;
            
            const ride = {
                id: rideId,
                ...rideData,
                status: 'requested',
                timestamp: Date.now(),
                passengerId: AppState.currentUser.uid,
                passengerName: AppState.userData.name,
                city: AppState.currentCity
            };
            
            if (AppState.referralDiscountApplied && AppState.referralCodeUsed) {
                ride.referredBy = AppState.referralCodeUsed;
                ride.referralOwnerName = AppState.referralOwnerName;
                ride.referralDiscount = rideData.fare * 0.5;
                ride.fare = rideData.fare * 0.5;
            }
            
            await database.ref(`rides/${rideId}`).set(ride);
            
            AppState.currentRide = ride;
            EnhancedUIUpdater.showRideInfo(ride);
            
            // Show pulsing icon
            EnhancedUIUpdater.showPulsingRideIcon(rideData.serviceType || 'car');
            
            this.listenToRideUpdates(rideId);
            
            // Notify drivers
            await this.notifyDrivers(ride);
            
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast('Ride requested successfully', 'success');
            
            // Handle split ride invitations
            if (rideData.splitRide && rideData.splitFriends) {
                await this.sendSplitInvitations(rideId, rideData);
            }
            
            // Handle broadcast
            if (rideData.broadcast && rideData.broadcastRecipients) {
                await this.sendBroadcastNotifications(rideId, rideData);
            }
            
            return rideId;
        } catch (error) {
            console.error('Error requesting ride:', error);
            EnhancedUIUpdater.hideLoading();
            EnhancedUIUpdater.showToast(error.message, 'error');
            throw error;
        }
    },
    
    async notifyDrivers(ride) {
        try {
            const driversSnapshot = await database.ref('drivers')
                .orderByChild('city')
                .equalTo(AppState.currentCity)
                .once('value');
            
            const drivers = driversSnapshot.val();
            if (drivers) {
                Object.keys(drivers).forEach(driverId => {
                    this.sendNotification(
                        driverId,
                        'New Ride Request',
                        `New ride request in ${AppState.currentCity}`,
                        'ride',
                        { rideId: ride.id }
                    );
                });
            }
        } catch (error) {
            console.error('Error notifying drivers:', error);
        }
    },
    
    async sendSplitInvitations(rideId, rideData) {
        try {
            const invitations = [];
            
            for (const friend of rideData.splitFriends) {
                const invitationId = database.ref().child('splitInvitations').push().key;
                
                const invitation = {
                    id: invitationId,
                    rideId: rideId,
                    hostId: AppState.currentUser.uid,
                    hostName: AppState.userData.name,
                    recipientId: friend.userId,
                    recipientName: friend.name,
                    pickup: rideData.pickup,
                    destination: rideData.destination,
                    totalFare: rideData.fare,
                    yourShare: rideData.fare / (rideData.splitFriends.length + 1),
                    participants: rideData.splitFriends.length + 1,
                    status: 'pending',
                    timestamp: Date.now()
                };
                
                await database.ref(`splitInvitations/${invitationId}`).set(invitation);
                invitations.push(invitation);
                
                // Send notification to friend
                this.sendNotification(
                    friend.userId,
                    'Split Ride Invitation',
                    `${AppState.userData.name} invited you to share a ride`,
                    'split',
                    { invitationId: invitationId }
                );
            }
            
            return invitations;
        } catch (error) {
            console.error('Error sending split invitations:', error);
            throw error;
        }
    },
    
    async sendBroadcastNotifications(rideId, rideData) {
        try {
            for (const recipient of rideData.broadcastRecipients) {
                this.sendNotification(
                    recipient.userId,
                    'Ride Broadcast',
                    `${AppState.userData.name} is sharing their ride`,
                    'broadcast',
                    { rideId: rideId }
                );
            }
        } catch (error) {
            console.error('Error sending broadcast notifications:', error);
        }
    },
    
    async sendNotification(userId, title, message, type, data = {}) {
        try {
            const notificationId = database.ref().child(`notifications/${userId}`).push().key;
            
            const notification = {
                id: notificationId,
                title: title,
                message: message,
                type: type,
                data: data,
                read: false,
                timestamp: Date.now()
            };
            
            await database.ref(`notifications/${userId}/${notificationId}`).set(notification);
        } catch (error) {
            console.error('Error sending notification:', error);
        }
    },
    
    listenToRideUpdates: function(rideId) {
        const rideRef = database.ref(`rides/${rideId}`);
        
        AppState.realtimeListeners.push(
            rideRef.on('value', (snapshot) => {
                const ride = snapshot.val();
                if (ride) {
                    AppState.currentRide = { id: rideId, ...ride };
                    EnhancedUIUpdater.updateRideStatus(ride.status);
                    
                    if (ride.status === 'completed') {
                        this.handleRideCompletion(ride);
                    }
                    
                    if (ride.status === 'cancelled') {
                        this.resetActiveRide();
                    }
                }
            })
        );
    },
    
    async loadDriverInfo(driverId) {
        try {
            const snapshot = await database.ref(`users/${driverId}`).once('value');
            const driver = snapshot.val();
            if (driver) {
                AppState.selectedVehicle = driver;
            }
        } catch (error) {
            console.error('Error loading driver info:', error);
        }
    },
    
    listenToDriverLocation(driverId) {
        const locationRef = database.ref(`driverLocations/${driverId}`);
        
        AppState.realtimeListeners.push(
            locationRef.on('value', (snapshot) => {
                const location = snapshot.val();
                if (location) {
                    AppState.driverLocation = {
                        lat: location.latitude,
                        lng: location.longitude
                    };
                }
            })
        );
    },
    
    listenToChatMessages(rideId) {
        const chatRef = database.ref(`chats/${rideId}/messages`).orderByChild('timestamp').limitToLast(50);
        
        AppState.realtimeListeners.push(
            chatRef.on('child_added', (snapshot) => {
                const message = snapshot.val();
                if (message) {
                    // Handle chat message
                }
            })
        );
    },
    
    async handleRideCompletion(ride) {
        try {
            // Update user stats
            const userRef = database.ref(`users/${AppState.currentUser.uid}`);
            const userSnapshot = await userRef.once('value');
            const userData = userSnapshot.val();
            
            if (userData) {
                const completedRides = (userData.completedRides || 0) + 1;
                const totalSpent = (userData.totalSpent || 0) + ride.fare;
                
                await userRef.update({
                    completedRides: completedRides,
                    totalSpent: totalSpent
                });
            }
            
            // Handle referral reward
            if (ride.referredBy && ride.referralOwnerName) {
                await this.processReferralReward(ride.referredBy, ride.id, ride.fare);
            }
            
            // Reset active ride
            this.resetActiveRide();
            
            EnhancedUIUpdater.showToast('Ride completed successfully', 'success');
        } catch (error) {
            console.error('Error handling ride completion:', error);
        }
    },
    
    async processReferralReward(referralCode, rideId, fare) {
        try {
            // Find referrer
            const usersSnapshot = await database.ref('users')
                .orderByChild('referralCode')
                .equalTo(referralCode)
                .once('value');
            
            const users = usersSnapshot.val();
            if (users) {
                const referrerId = Object.keys(users)[0];
                const referrer = users[referrerId];
                
                // Add K25 to referrer's wallet
                const newBalance = (referrer.walletBalance || 0) + 25;
                await database.ref(`users/${referrerId}/walletBalance`).set(newBalance);
                
                // Record transaction
                const transactionId = database.ref().child('transactions').push().key;
                const transaction = {
                    id: transactionId,
                    userId: referrerId,
                    type: 'referral',
                    amount: 25,
                    description: `Referral reward from ${AppState.userData.name}`,
                    rideId: rideId,
                    timestamp: Date.now()
                };
                
                await database.ref(`transactions/${transactionId}`).set(transaction);
                
                // Send notification to referrer
                this.sendNotification(
                    referrerId,
                    'Referral Reward',
                    `You earned K25 from ${AppState.userData.name}'s ride`,
                    'referral',
                    { amount: 25, rideId: rideId }
                );
            }
        } catch (error) {
            console.error('Error processing referral reward:', error);
        }
    },
    
    resetActiveRide: function() {
        AppState.currentRide = null;
        EnhancedUIUpdater.removePulsingRideIcon();
        
        const rideInfoPanel = document.getElementById('rideInfoPanel');
        if (rideInfoPanel) rideInfoPanel.style.display = 'none';
        
        const sosButton = document.getElementById('sosButton');
        if (sosButton) sosButton.style.display = 'none';
    },
    
    async requestScheduledRide() {
        try {
            const scheduledRide = AppState.scheduledRides.find(ride => 
                ride.status === 'scheduled' && ride.scheduledTime <= Date.now()
            );
            
            if (scheduledRide) {
                await this.requestRide(scheduledRide);
                
                // Update scheduled ride status
                await database.ref(`scheduledRides/${scheduledRide.id}/status`).set('requested');
                
                EnhancedUIUpdater.showToast('Scheduled ride requested', 'success');
            }
        } catch (error) {
            console.error('Error requesting scheduled ride:', error);
            EnhancedUIUpdater.showToast('Error requesting scheduled ride', 'error');
        }
    },
    
    updateUserStats: function(rides) {
        const completed = rides.filter(ride => ride.status === 'completed').length;
        const cancelled = rides.filter(ride => ride.status === 'cancelled').length;
        const totalSpent = rides
            .filter(ride => ride.status === 'completed')
            .reduce((sum, ride) => sum + (ride.fare || 0), 0);
        
        const completedRides = document.getElementById('completedRides');
        const cancelledRides = document.getElementById('cancelledRides');
        const totalSpentElement = document.getElementById('totalSpent');
        
        if (completedRides) completedRides.textContent = completed;
        if (cancelledRides) cancelledRides.textContent = cancelled;
        if (totalSpentElement) totalSpentElement.textContent = `ZMW ${totalSpent.toFixed(2)}`;
    }
};

// ============================================
// CITY DETECTOR
// ============================================
const CityDetector = {
    async detectCityFromLocation(lat, lng) {
        try {
            const response = await fetch(
                `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&addressdetails=1`
            );
            
            if (response.ok) {
                const data = await response.json();
                const address = data.address;
                
                // Try to get city from address components
                const city = address.city || address.town || address.municipality || address.village;
                
                if (city) {
                    AppState.currentCity = city;
                    EnhancedUIUpdater.updateCityDisplay(city);
                    return city;
                }
            }
        } catch (error) {
            console.error('Error detecting city:', error);
        }
        
        return null;
    }
};

// ============================================
// INITIALIZE APPLICATION
// ============================================
async function initializeApp() {
    try {
        EnhancedUIUpdater.showLoading('Initializing app...');
        
        // Initialize search engine
        EnhancedSearchEngine.init();
        
        // Initialize map
        initializeMap();
        
        // Get current location
        await getCurrentLocation();
        
        // Setup event listeners
        setupEventListeners();
        
        // Initialize ride types
        initializeRideTypes();
        
        // Initialize shopping items
        initializeShoppingItems();
        
        // Check authentication
        const urlParams = new URLSearchParams(window.location.search);
        const email = urlParams.get('email');
        const uid = urlParams.get('uid');
        
        if (email && uid) {
            AppState.currentUser = { uid, email };
            await EnhancedFirebaseManager.loadUserData(uid);
        } else {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    AppState.currentUser = user;
                    await EnhancedFirebaseManager.loadUserData(user.uid);
                } else {
                    window.location.href = 'signup.html';
                }
            });
        }
        
        EnhancedUIUpdater.hideLoading();
        EnhancedUIUpdater.showToast('Jubel Passenger App Ready', 'success');
        
    } catch (error) {
        console.error('Error initializing app:', error);
        EnhancedUIUpdater.hideLoading();
        EnhancedUIUpdater.showToast('Error initializing app', 'error');
    }
}

function initializeMap() {
    const defaultLat = -15.4167;
    const defaultLng = 28.2833;
    
    map = L.map('map').setView([defaultLat, defaultLng], 13);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: ' OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(map);
    
    EnhancedUIUpdater.hideMapLoading();
}

async function getCurrentLocation() {
    return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
            reject(new Error('Geolocation not supported'));
            return;
        }
        
        navigator.geolocation.getCurrentPosition(
            async (position) => {
                const { latitude, longitude } = position.coords;
                AppState.userLocation = { lat: latitude, lng: longitude };
                
                // Set pickup location
                AppState.pickup = {
                    lat: latitude,
                    lng: longitude,
                    address: 'Current Location',
                    name: 'Current Location'
                };
                
                // Update pickup input
                const pickupInputs = [
                    'pickupLocation',
                    'deliveryPickup',
                    'shortDeliveryPickup',
                    'truckPickup',
                    'splitPickup',
                    'broadcastPickup',
                    'emergencyPickup',
                    'schedulePickup'
                ];
                
                pickupInputs.forEach(inputId => {
                    const input = document.getElementById(inputId);
                    if (input) input.value = 'Current Location';
                });
                
                // Detect city
                const city = await CityDetector.detectCityFromLocation(latitude, longitude);
                if (city) {
                    AppState.currentCity = city;
                    EnhancedUIUpdater.updateCityDisplay(city);
                }
                
                // Center map
                if (map) {
                    map.setView([latitude, longitude], 15);
                    
                    currentLocationMarker = L.marker([latitude, longitude], {
                        icon: L.divIcon({
                            className: 'current-location-marker',
                            html: '<i class="fas fa-user"></i>',
                            iconSize: [18, 18]
                        })
                    }).addTo(map).bindPopup('Your Location');
                }
                
                resolve();
            },
            (error) => {
                console.error('Geolocation error:', error);
                reject(error);
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            }
        );
    });
}

function initializeRideTypes() {
    // Initialize car ride types
    const rideTypeCardsContainer = document.getElementById('rideTypeCardsContainer');
    if (rideTypeCardsContainer) {
        rideTypeCardsContainer.innerHTML = '';
        
        Object.keys(AppState.rideTypes).forEach(type => {
            const config = AppState.rideTypes[type];
            const card = document.createElement('div');
            card.className = `ride-type-card ${type === AppState.selectedRideType ? 'selected' : ''}`;
            card.dataset.type = type;
            card.innerHTML = `
                <div class="ride-type-icon">
                    <i class="fas ${config.icon}"></i>
                </div>
                <div class="ride-type-name">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
                <div class="ride-type-price">ZMW 0.00</div>
            `;
            
            card.addEventListener('click', () => {
                document.querySelectorAll('.ride-type-card').forEach(c => {
                    c.classList.remove('selected');
                });
                card.classList.add('selected');
                AppState.selectedRideType = type;
                
                if (AppState.pickup && AppState.destination) {
                    EnhancedUIUpdater.updatePricesAndRoute();
                }
            });
            
            rideTypeCardsContainer.appendChild(card);
        });
    }
    
    // Initialize other ride type containers
    initializeRideTypeContainer('splitRideTypeCards');
    initializeRideTypeContainer('scheduleRideTypeCards');
}

function initializeRideTypeContainer(containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    container.innerHTML = '';
    
    Object.keys(AppState.rideTypes).forEach(type => {
        const config = AppState.rideTypes[type];
        const card = document.createElement('div');
        card.className = `ride-type-card ${type === 'standard' ? 'selected' : ''}`;
        card.dataset.type = type;
        card.innerHTML = `
            <div class="ride-type-icon">
                <i class="fas ${config.icon}"></i>
            </div>
            <div class="ride-type-name">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
            <div class="ride-type-price">ZMW 0.00</div>
        `;
        
        card.addEventListener('click', () => {
            container.querySelectorAll('.ride-type-card').forEach(c => {
                c.classList.remove('selected');
            });
            card.classList.add('selected');
            AppState.selectedRideType = type;
            
            if (AppState.pickup && AppState.destination) {
                EnhancedUIUpdater.updatePricesAndRoute();
            }
        });
        
        container.appendChild(card);
    });
}

function initializeShoppingItems() {
    const addItemBtn = document.getElementById('addItemBtn');
    const shoppingItems = document.getElementById('shoppingItems');
    
    if (addItemBtn && shoppingItems) {
        addItemBtn.addEventListener('click', () => {
            const itemEntry = document.createElement('div');
            itemEntry.className = 'item-entry';
            itemEntry.innerHTML = `
                <input type="text" class="item-input" placeholder="Item name">
                <button class="remove-item" type="button">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            shoppingItems.appendChild(itemEntry);
            
            itemEntry.querySelector('.remove-item').addEventListener('click', function() {
                itemEntry.remove();
            });
        });
    }
}

// ============================================
// EVENT LISTENERS SETUP
// ============================================
function setupEventListeners() {
    // Navigation tabs
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const screen = tab.dataset.screen;
            switchScreen(screen);
        });
    });
    
    // Service tabs
    document.querySelectorAll('.service-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const service = tab.dataset.service;
            switchService(service);
        });
    });
    
    // More options button
    const moreOptionsBtn = document.getElementById('moreOptionsBtn');
    if (moreOptionsBtn) {
        moreOptionsBtn.addEventListener('click', () => {
            showMoreOptions();
        });
    }
    
    // SOS button
    const sosButton = document.getElementById('sosButton');
    if (sosButton) {
        sosButton.addEventListener('click', triggerSOS);
    }
    
    // Request ride buttons
    setupRequestButtons();
    
    // Search inputs
    setupSearchInputs();
    
    // Map controls
    setupMapControls();
    
    // Modals
    setupModalHandlers();
    
    // Split ride
    setupSplitRideHandlers();
    
    // Broadcast ride
    setupBroadcastHandlers();
    
    // Emergency
    setupEmergencyHandlers();
    
    // Shopping
    setupShoppingHandlers();
    
    // Schedule
    setupScheduleHandlers();
    
    // Payment
    setupPaymentHandlers();
}

function setupRequestButtons() {
    const requestRideBtn = document.getElementById('requestRideBtn');
    if (requestRideBtn) {
        requestRideBtn.addEventListener('click', async () => {
            if (!validateRideRequest()) return;
            
            const distance = EnhancedPriceCalculator.calculateDistance(
                AppState.pickup.lat, AppState.pickup.lng,
                AppState.destination.lat, AppState.destination.lng
            );
            
            const surge = EnhancedPriceCalculator.getSurgeMultiplier();
            const fare = EnhancedPriceCalculator.calculateRideFare(distance, AppState.selectedRideType, surge);
            
            const rideData = {
                pickup: AppState.pickup.address,
                pickupLat: AppState.pickup.lat,
                pickupLng: AppState.pickup.lng,
                destination: AppState.destination.address,
                destLat: AppState.destination.lat,
                destLng: AppState.destination.lng,
                rideType: AppState.selectedRideType,
                fare: fare,
                distance: distance,
                stops: AppState.activeStops,
                serviceType: 'car'
            };
            
            showPaymentModal(rideData);
        });
    }
    
    // Similar setup for other request buttons...
}

function setupSearchInputs() {
    // Destination search
    const destinationInput = document.getElementById('destinationLocation');
    if (destinationInput) {
        destinationInput.addEventListener('input', debounce(async (e) => {
            const query = e.target.value.trim();
            if (query.length < 2) return;
            
            const results = await EnhancedSearchEngine.search(query, 'destination', AppState.userLocation);
            EnhancedUIUpdater.showSearchSuggestions('destinationLocation', results, 'destination');
        }, 300));
    }
    
    // Setup other search inputs similarly...
}

function setupMapControls() {
    const locateMeBtn = document.getElementById('locateMeBtn');
    if (locateMeBtn) {
        locateMeBtn.addEventListener('click', () => {
            if (AppState.userLocation) {
                map.setView([AppState.userLocation.lat, AppState.userLocation.lng], 15);
                EnhancedUIUpdater.showToast('Centered on your location', 'info');
            } else {
                getCurrentLocation();
            }
        });
    }
    
    const clearRouteBtn = document.getElementById('clearRouteBtn');
    if (clearRouteBtn) {
        clearRouteBtn.addEventListener('click', () => {
            if (routeLayer) {
                map.removeLayer(routeLayer);
                routeLayer = null;
            }
            
            if (destinationMarker) {
                map.removeLayer(destinationMarker);
                destinationMarker = null;
            }
            
            const destinationInput = document.getElementById('destinationLocation');
            if (destinationInput) destinationInput.value = '';
            AppState.destination = null;
            
            EnhancedUIUpdater.showToast('Route cleared', 'info');
        });
    }
}

function setupModalHandlers() {
    // Close buttons
    document.querySelectorAll('.modal-close').forEach(btn => {
        btn.addEventListener('click', () => {
            const modal = btn.dataset.modal;
            hideModal(modal);
        });
    });
    
    // Close modals on overlay click
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
                overlay.style.display = 'none';
            }
        });
    });
}

function setupSplitRideHandlers() {
    const addFriendBtn = document.getElementById('addFriendBtn');
    if (addFriendBtn) {
        addFriendBtn.addEventListener('click', async () => {
            const codeInput = document.getElementById('friendReferralCode');
            const code = codeInput.value.trim();
            
            if (!code) {
                EnhancedUIUpdater.showToast('Please enter a referral code', 'warning');
                return;
            }
            
            if (AppState.splitRideFriends.length >= 3) {
                EnhancedUIUpdater.showToast('Maximum 3 friends allowed', 'warning');
                return;
            }
            
            const validation = await EnhancedFirebaseManager.validateReferralCode(code);
            if (!validation.valid) {
                EnhancedUIUpdater.showToast('Invalid referral code', 'error');
                return;
            }
            
            // Check if already added
            if (AppState.splitRideFriends.some(friend => friend.code === code)) {
                EnhancedUIUpdater.showToast('Friend already added', 'warning');
                return;
            }
            
            AppState.splitRideFriends.push({
                code: code,
                userId: validation.userId,
                name: validation.name
            });
            
            codeInput.value = '';
            EnhancedUIUpdater.showSplitFriends();
            EnhancedUIUpdater.showToast(`${validation.name} added to ride`, 'success');
        });
    }
    
    const requestSplitRideBtn = document.getElementById('requestSplitRideBtn');
    if (requestSplitRideBtn) {
        requestSplitRideBtn.addEventListener('click', async () => {
            if (!validateRideRequest()) return;
            
            const distance = EnhancedPriceCalculator.calculateDistance(
                AppState.pickup.lat, AppState.pickup.lng,
                AppState.destination.lat, AppState.destination.lng
            );
            
            const surge = EnhancedPriceCalculator.getSurgeMultiplier();
            const totalFare = EnhancedPriceCalculator.calculateRideFare(distance, AppState.selectedRideType, surge);
            const numberOfPeople = AppState.splitRideFriends.length + 1;
            const share = EnhancedPriceCalculator.calculateSplitFare(totalFare, numberOfPeople);
            
            const rideData = {
                pickup: AppState.pickup.address,
                pickupLat: AppState.pickup.lat,
                pickupLng: AppState.pickup.lng,
                destination: AppState.destination.address,
                destLat: AppState.destination.lat,
                destLng: AppState.destination.lng,
                rideType: AppState.selectedRideType,
                fare: totalFare,
                distance: distance,
                splitRide: true,
                splitFriends: AppState.splitRideFriends,
                yourShare: share
            };
            
            showPaymentModal(rideData);
        });
    }
}

function setupBroadcastHandlers() {
    const addBroadcastRecipientBtn = document.getElementById('addBroadcastRecipientBtn');
    if (addBroadcastRecipientBtn) {
        addBroadcastRecipientBtn.addEventListener('click', async () => {
            const codeInput = document.getElementById('broadcastRecipientCode');
            const code = codeInput.value.trim();
            
            if (!code) {
                EnhancedUIUpdater.showToast('Please enter a referral code', 'warning');
                return;
            }
            
            const validation = await EnhancedFirebaseManager.validateReferralCode(code);
            if (!validation.valid) {
                EnhancedUIUpdater.showToast('Invalid referral code', 'error');
                return;
            }
            
            // Check if already added
            if (AppState.broadcastRecipients.some(recipient => recipient.code === code)) {
                EnhancedUIUpdater.showToast('Recipient already added', 'warning');
                return;
            }
            
            AppState.broadcastRecipients.push({
                code: code,
                userId: validation.userId,
                name: validation.name
            });
            
            codeInput.value = '';
            EnhancedUIUpdater.showBroadcastRecipients();
            EnhancedUIUpdater.showToast(`${validation.name} added to broadcast`, 'success');
        });
    }
    
    const requestBroadcastRideBtn = document.getElementById('requestBroadcastRideBtn');
    if (requestBroadcastRideBtn) {
        requestBroadcastRideBtn.addEventListener('click', async () => {
            if (!validateRideRequest()) return;
            
            const distance = EnhancedPriceCalculator.calculateDistance(
                AppState.pickup.lat, AppState.pickup.lng,
                AppState.destination.lat, AppState.destination.lng
            );
            
            const surge = EnhancedPriceCalculator.getSurgeMultiplier();
            const fare = EnhancedPriceCalculator.calculateRideFare(distance, 'standard', surge);
            
            const rideData = {
                pickup: AppState.pickup.address,
                pickupLat: AppState.pickup.lat,
                pickupLng: AppState.pickup.lng,
                destination: AppState.destination.address,
                destLat: AppState.destination.lat,
                destLng: AppState.destination.lng,
                fare: fare,
                distance: distance,
                broadcast: true,
                broadcastRecipients: AppState.broadcastRecipients
            };
            
            showPaymentModal(rideData);
        });
    }
}

function setupEmergencyHandlers() {
    // Emergency service buttons
    document.querySelectorAll('.emergency-service').forEach(service => {
        service.addEventListener('click', () => {
            const type = service.dataset.type;
            
            if (type === 'sos') {
                showModal('sos');
            } else {
                handleEmergencyService(type);
            }
        });
    });
    
    const confirmEmergencyBtn = document.getElementById('confirmEmergencyBtn');
    if (confirmEmergencyBtn) {
        confirmEmergencyBtn.addEventListener('click', async () => {
            if (!validateEmergencyRequest()) return;
            
            const serviceType = document.getElementById('emergencyServiceType').dataset.type;
            const station = AppState.selectedEmergencyStation;
            
            if (!station) {
                EnhancedUIUpdater.showToast('Please select an emergency station', 'warning');
                return;
            }
            
            const distance = station.distance;
            const fare = EnhancedPriceCalculator.calculateEmergencyFare(distance, serviceType);
            
            const rideData = {
                pickup: AppState.pickup.address,
                pickupLat: AppState.pickup.lat,
                pickupLng: AppState.pickup.lng,
                destination: station.address,
                destLat: station.lat,
                destLng: station.lng,
                fare: fare,
                distance: distance,
                emergency: true,
                emergencyType: serviceType,
                emergencyReason: AppState.emergencyReason,
                emergencyStation: station.name
            };
            
            showPaymentModal(rideData);
        });
    }
}

function setupShoppingHandlers() {
    // Shopping category tabs
    document.querySelectorAll('.category-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const category = tab.dataset.category;
            handleShoppingCategory(category);
        });
    });
    
    const requestShoppingBtn = document.getElementById('requestShoppingBtn');
    if (requestShoppingBtn) {
        requestShoppingBtn.addEventListener('click', async () => {
            if (!validateShoppingRequest()) return;
            
            const distance = EnhancedPriceCalculator.calculateDistance(
                AppState.pickup.lat, AppState.pickup.lng,
                AppState.destination.lat, AppState.destination.lng
            );
            
            const itemsCount = document.querySelectorAll('.item-input').length;
            const fare = EnhancedPriceCalculator.calculateShoppingFare(distance, itemsCount);
            
            const rideData = {
                pickup: AppState.pickup.address,
                pickupLat: AppState.pickup.lat,
                pickupLng: AppState.pickup.lng,
                destination: AppState.destination.address,
                destLat: AppState.destination.lat,
                destLng: AppState.destination.lng,
                fare: fare,
                distance: distance,
                serviceType: 'shopping',
                itemsCount: itemsCount,
                instructions: document.getElementById('shoppingInstructions').value
            };
            
            showPaymentModal(rideData);
        });
    }
}

function setupScheduleHandlers() {
    const confirmScheduleBtn = document.getElementById('confirmScheduleBtn');
    if (confirmScheduleBtn) {
        confirmScheduleBtn.addEventListener('click', async () => {
            if (!validateRideRequest()) return;
            
            const date = document.getElementById('scheduleDate').value;
            const time = document.getElementById('scheduleTime').value;
            
            if (!date || !time) {
                EnhancedUIUpdater.showToast('Please select date and time', 'warning');
                return;
            }
            
            const scheduledTime = new Date(`${date}T${time}`).getTime();
            if (scheduledTime <= Date.now()) {
                EnhancedUIUpdater.showToast('Please select a future time', 'warning');
                return;
            }
            
            const distance = EnhancedPriceCalculator.calculateDistance(
                AppState.pickup.lat, AppState.pickup.lng,
                AppState.destination.lat, AppState.destination.lng
            );
            
            const surge = EnhancedPriceCalculator.getSurgeMultiplier();
            const fare = EnhancedPriceCalculator.calculateRideFare(distance, AppState.selectedRideType, surge);
            
            const scheduledRideId = database.ref().child('scheduledRides').push().key;
            
            const scheduledRide = {
                id: scheduledRideId,
                pickup: AppState.pickup.address,
                pickupLat: AppState.pickup.lat,
                pickupLng: AppState.pickup.lng,
                destination: AppState.destination.address,
                destLat: AppState.destination.lat,
                destLng: AppState.destination.lng,
                rideType: AppState.selectedRideType,
                fare: fare,
                distance: distance,
                scheduledTime: scheduledTime,
                passengerId: AppState.currentUser.uid,
                passengerName: AppState.userData.name,
                status: 'scheduled',
                timestamp: Date.now()
            };
            
            await database.ref(`scheduledRides/${scheduledRideId}`).set(scheduledRide);
            
            AppState.scheduledRides.push(scheduledRide);
            EnhancedUIUpdater.showScheduleCountdown(scheduledTime);
            
            hideModal('schedule');
            EnhancedUIUpdater.showToast('Ride scheduled successfully', 'success');
        });
    }
}

function setupPaymentHandlers() {
    // Apply referral button
    const applyReferralBtn = document.getElementById('applyReferralBtn');
    if (applyReferralBtn) {
        applyReferralBtn.addEventListener('click', async () => {
            const codeInput = document.getElementById('referralCodeInput');
            const code = codeInput.value.trim();
            
            if (!code) {
                EnhancedUIUpdater.showToast('Please enter a referral code', 'warning');
                return;
            }
            
            const validation = await EnhancedFirebaseManager.validateReferralCode(code);
            if (!validation.valid) {
                EnhancedUIUpdater.showToast('Invalid referral code', 'error');
                return;
            }
            
            AppState.referralCodeUsed = code;
            AppState.referralOwnerName = validation.name;
            EnhancedUIUpdater.applyReferralDiscount(validation.name);
        });
    }
    
    // Confirm payment button
    const confirmPaymentBtn = document.getElementById('confirmPaymentBtn');
    if (confirmPaymentBtn) {
        confirmPaymentBtn.addEventListener('click', async () => {
            const selectedMethod = document.querySelector('.payment-method.selected');
            if (!selectedMethod) {
                EnhancedUIUpdater.showToast('Please select a payment method', 'warning');
                return;
            }
            
            const paymentMethod = selectedMethod.dataset.payment;
            const rideData = window.pendingRideData;
            
            if (!rideData) {
                EnhancedUIUpdater.showToast('No ride data found', 'error');
                return;
            }
            
            rideData.paymentMethod = paymentMethod;
            
            // Process payment
            if (paymentMethod === 'wallet') {
                if (AppState.walletBalance < rideData.fare) {
                    EnhancedUIUpdater.showToast('Insufficient wallet balance', 'error');
                    return;
                }
                
                // Deduct from wallet
                const newBalance = AppState.walletBalance - rideData.fare;
                await database.ref(`users/${AppState.currentUser.uid}/walletBalance`).set(newBalance);
                AppState.walletBalance = newBalance;
                EnhancedUIUpdater.updateWalletBalance(newBalance);
            }
            
            // Request the ride
            await EnhancedFirebaseManager.requestRide(rideData);
            
            hideModal('payment');
            delete window.pendingRideData;
            
            // Reset referral discount
            AppState.referralDiscountApplied = false;
            AppState.referralCodeUsed = null;
            AppState.referralOwnerName = null;
        });
    }
}

// ============================================
// HELPER FUNCTIONS
// ============================================
function switchScreen(screen) {
    document.querySelectorAll('.history-screen, .account-screen, .emergency-screen').forEach(s => {
        s.style.display = 'none';
    });
    
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    document.querySelector(`.nav-tab[data-screen="${screen}"]`)?.classList.add('active');
    
    if (screen === 'home') {
        document.getElementById('homeContent').style.display = 'block';
    } else {
        const screenElement = document.getElementById(`${screen}Screen`);
        if (screenElement) {
            screenElement.style.display = 'block';
        }
    }
    
    AppState.activeScreen = screen;
}

function switchService(service) {
    document.querySelectorAll('.ride-request-form, .service-form, .split-form, .broadcast-form').forEach(form => {
        form.style.display = 'none';
    });
    
    document.querySelectorAll('.service-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    AppState.activeService = service;
    
    const formId = service === 'car' ? 'carForm' : 
                  service === 'delivery' ? 'deliveryForm' :
                  service === 'short-delivery' ? 'shortDeliveryForm' :
                  service === 'express' ? 'expressForm' :
                  service === 'truck' ? 'truckForm' :
                  service === 'split' ? 'splitForm' :
                  service === 'broadcast' ? 'broadcastForm' : 'carForm';
    
    const form = document.getElementById(formId);
    if (form) form.style.display = 'block';
    
    const tab = document.querySelector(`.service-tab[data-service="${service}"]`);
    if (tab) tab.classList.add('active');
}

function showMoreOptions() {
    // Implement more options menu
    const options = [
        { icon: 'fa-calendar-alt', text: 'Schedule Ride', action: () => showModal('schedule') },
        { icon: 'fa-user-friends', text: 'Split Ride', action: () => switchService('split') },
        { icon: 'fa-broadcast-tower', text: 'Broadcast Ride', action: () => switchService('broadcast') },
        { icon: 'fa-exclamation-triangle', text: 'SOS Setup', action: () => showModal('sos') }
    ];
    
    // Create and show options menu
    const menu = document.createElement('div');
    menu.className = 'more-options-menu';
    menu.style.cssText = `
        position: fixed;
        bottom: 100px;
        right: 20px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        z-index: 1000;
        padding: 10px;
        min-width: 200px;
    `;
    
    options.forEach(option => {
        const item = document.createElement('div');
        item.className = 'option-item';
        item.style.cssText = `
            padding: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            border-radius: 5px;
        `;
        item.innerHTML = `
            <i class="fas ${option.icon}"></i>
            <span>${option.text}</span>
        `;
        
        item.addEventListener('click', () => {
            option.action();
            menu.remove();
        });
        
        item.addEventListener('mouseenter', () => {
            item.style.background = '#f5f5f5';
        });
        
        item.addEventListener('mouseleave', () => {
            item.style.background = 'transparent';
        });
        
        menu.appendChild(item);
    });
    
    document.body.appendChild(menu);
    
    // Close menu when clicking outside
    const closeMenu = (e) => {
        if (!menu.contains(e.target) && e.target.id !== 'moreOptionsBtn') {
            menu.remove();
            document.removeEventListener('click', closeMenu);
        }
    };
    
    setTimeout(() => {
        document.addEventListener('click', closeMenu);
    }, 100);
}

function triggerSOS() {
    if (!AppState.sosConfig) {
        EnhancedUIUpdater.showToast('Please setup SOS contacts first', 'warning');
        showModal('sos');
        return;
    }
    
    if (!AppState.currentRide) {
        EnhancedUIUpdater.showToast('No active ride to report SOS for', 'warning');
        return;
    }
    
    if (confirm('Send SOS alert to your emergency contacts?')) {
        EnhancedUIUpdater.showToast('SOS alert sent', 'success');
        // Implement SOS alert sending
    }
}

function handleEmergencyService(type) {
    if (!AppState.userLocation) {
        EnhancedUIUpdater.showToast('Please allow location access', 'warning');
        return;
    }
    
    if (!AppState.currentCity) {
        EnhancedUIUpdater.showToast('Detecting your city...', 'info');
        return;
    }
    
    const serviceTypeElement = document.getElementById('emergencyServiceType');
    if (serviceTypeElement) {
        serviceTypeElement.textContent = `${type.charAt(0).toUpperCase() + type.slice(1)} Ride`;
        serviceTypeElement.dataset.type = type;
    }
    
    // Load emergency stations
    EnhancedSearchEngine.searchEmergencyStations(type, AppState.currentCity)
        .then(stations => {
            EnhancedUIUpdater.showEmergencyStations(stations);
            showModal('emergency');
        })
        .catch(error => {
            console.error('Error loading emergency stations:', error);
            EnhancedUIUpdater.showToast('Error loading emergency stations', 'error');
        });
}

function handleShoppingCategory(category) {
    AppState.shoppingCategory = category;
    
    EnhancedSearchEngine.searchShoppingPlaces(category, AppState.currentCity)
        .then(places => {
            EnhancedUIUpdater.showShoppingPlaces(places);
            showModal('shoppingCategory');
        })
        .catch(error => {
            console.error('Error loading shopping places:', error);
            EnhancedUIUpdater.showToast('Error loading shops', 'error');
        });
}

function showModal(modalId) {
    const modal = document.getElementById(`${modalId}Modal`);
    if (modal) {
        modal.style.display = 'block';
        
        // Show referral discount section for payment modal
        if (modalId === 'payment') {
            EnhancedUIUpdater.showReferralDiscount();
        }
    }
}

function hideModal(modalId) {
    const modal = document.getElementById(`${modalId}Modal`);
    if (modal) {
        modal.style.display = 'none';
    }
}

function showPaymentModal(rideData) {
    window.pendingRideData = rideData;
    
    const paymentAmount = document.getElementById('paymentAmount');
    if (paymentAmount) {
        paymentAmount.textContent = `ZMW ${rideData.fare.toFixed(2)}`;
    }
    
    showModal('payment');
}

function validateRideRequest() {
    if (!AppState.pickup || !AppState.destination) {
        EnhancedUIUpdater.showToast('Please select pickup and destination', 'warning');
        return false;
    }
    
    if (!AppState.currentCity) {
        EnhancedUIUpdater.showToast('Please wait while we detect your city', 'warning');
        return false;
    }
    
    const validation = EnhancedPriceCalculator.validateDistanceWithinCity(
        AppState.pickup.lat, AppState.pickup.lng,
        AppState.destination.lat, AppState.destination.lng,
        AppState.currentCity
    );
    
    if (!validation.valid) {
        EnhancedUIUpdater.showToast(validation.message, 'warning');
        return false;
    }
    
    return true;
}

function validateEmergencyRequest() {
    if (!AppState.emergencyReason) {
        EnhancedUIUpdater.showToast('Please select an emergency reason', 'warning');
        return false;
    }
    
    return validateRideRequest();
}

function validateShoppingRequest() {
    if (!AppState.shoppingCategory) {
        EnhancedUIUpdater.showToast('Please select a shop category', 'warning');
        return false;
    }
    
    return validateRideRequest();
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// ============================================
// START APPLICATION
// ============================================
window.addEventListener('load', initializeApp);
    </script>
</body>
</html>
